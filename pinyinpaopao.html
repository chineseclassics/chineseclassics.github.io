<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ‹¼éŸ³æ³¡æ³¡æ¨‚</title>
    <!-- å¼•å…¥ Tailwind CSS ç”¨æ–¼å¿«é€Ÿç¾åŒ–ç•Œé¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Tone.js ç”¨æ–¼è£½ä½œé»æ“ŠéŸ³æ•ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* ä½¿ç”¨ 'Inter' å­—é«”ï¼Œæ›´åœ“æ½¤å‹å¥½ */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-user-select: none; /* é˜²æ­¢ iPad é»æ“Šæ™‚é¸ä¸­æ–‡æœ¬ */
            user-select: none;
            cursor: default; /* åœ¨é›»è…¦ä¸Šé¡¯ç¤ºé»˜èªæŒ‡é‡ */
            overflow: hidden; /* éš±è—æ»¾å‹•æ¢ */
            /* æ¼‚äº®çš„å¤©ç©ºæ¼¸è®ŠèƒŒæ™¯ */
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #FFF8DC 100%);
        }

        /* éŠæˆ²å®¹å™¨ï¼Œä½”æ»¿å…¨å± */
        #game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* å½©è™¹æ³¡æ³¡çš„åŸºç¤æ¨£å¼ - ä½¿ç”¨å¤šå½©æ¼¸è®Š */
        .bubble {
            position: absolute;
            bottom: -150px; /* å¾å±å¹•å¤–é–‹å§‹ */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 255, 255, 0.5);
            /* æ‡‰ç”¨ 'float' å‹•ç•« */
            animation: float 10s linear infinite;
            will-change: transform; /* å„ªåŒ–å‹•ç•«æ€§èƒ½ */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ iPad é»æ“Šé«˜äº® */
            cursor: pointer;
            /* æ¼‚äº®çš„ 3D æ•ˆæœ */
            transform-style: preserve-3d;
            transition: transform 0.1s ease;
        }

        /* æ³¡æ³¡å…§å±¤ - å‰µå»ºç»ç’ƒè³ªæ„Ÿ */
        .bubble::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 40%;
            height: 40%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), transparent);
            border-radius: 50%;
            filter: blur(8px);
        }

        /* æ³¡æ³¡å¤–å±¤å…‰æ¾¤ */
        .bubble::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: inherit;
            filter: blur(10px);
            opacity: 0.4;
            z-index: -1;
        }

        /* æ³¡æ³¡ä¸Šæµ®å‹•ç•« - æ·»åŠ è¼•å¾®æ–æ“º */
        @keyframes float {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            25% {
                transform: translateY(-30vh) translateX(10px) rotate(5deg);
            }
            50% {
                transform: translateY(-60vh) translateX(-10px) rotate(-5deg);
            }
            75% {
                transform: translateY(-90vh) translateX(5px) rotate(3deg);
            }
            99% {
                transform: translateY(-120vh) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-120vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
        }

        /* æ³¡æ³¡ç ´è£‚å‹•ç•« - å¸¶ç²’å­æ•ˆæœ */
        .pop {
            animation: pop 0.5s ease-out forwards;
        }
        @keyframes pop {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(2);
                opacity: 0;
                filter: blur(20px);
            }
        }

        /* é»éŒ¯æ™‚çš„æ™ƒå‹•å‹•ç•« - æ›´ç”Ÿå‹• */
        .wiggle {
            animation: wiggle 0.5s ease;
        }
        @keyframes wiggle {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10% { transform: translateX(-15px) rotate(-8deg); }
            30% { transform: translateX(15px) rotate(8deg); }
            50% { transform: translateX(-10px) rotate(-5deg); }
            70% { transform: translateX(10px) rotate(5deg); }
            90% { transform: translateX(-5px) rotate(-2deg); }
        }

        /* ç²’å­æ•ˆæœ */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-burst 0.8s ease-out forwards;
        }

        @keyframes particle-burst {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* æ˜Ÿæ˜Ÿæ•ˆæœ */
        .star {
            position: absolute;
            width: 30px;
            height: 30px;
            pointer-events: none;
            animation: star-pop 0.6s ease-out forwards;
            font-size: 30px;
        }

        @keyframes star-pop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.5) rotate(360deg);
                opacity: 0;
            }
        }

        /* é–‹å§‹ç•«é¢çš„æŒ‰éˆ• */
        #start-button {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #start-button:active {
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* å–‡å­åœ–æ¨™ - ç§»é™¤ï¼ˆå·²åœ¨ HTML ä¸­å…§è¯ï¼‰ */
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <div id="game-wrapper">

        <!-- é–‹å§‹ç•«é¢ -->
        <div id="start-screen" class="absolute inset-0 z-20 flex flex-col justify-center items-center bg-gradient-to-b from-blue-200/90 via-purple-200/90 to-pink-200/90 backdrop-blur-sm">
            <h1 class="text-6xl md:text-8xl font-bold mb-8 animate-bounce" style="background: linear-gradient(45deg, #FF6B9D, #C239B3, #4158D0, #00D4FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 2px 2px 8px rgba(0,0,0,0.2);">
                ğŸˆ æ‹¼éŸ³æ³¡æ³¡æ¨‚ ğŸˆ
            </h1>
            <button id="start-button" class="px-16 py-8 text-4xl font-bold rounded-full shadow-2xl transform hover:scale-105 transition-all" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                ğŸ® é–‹å§‹éŠæˆ²
            </button>
            <p class="mt-8 text-2xl font-bold" style="color: #667eea; text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">
                ğŸ”Š è«‹æ‰“é–‹è²éŸ³ï¼Œè·Ÿè‘—æç¤ºé»æ“Šæ³¡æ³¡ï¼
            </p>
        </div>

        <!-- éŠæˆ²ä¸»ç•«é¢ (é è¨­éš±è—) -->
        <div id="game-screen" class="hidden h-full">
            <!-- é ‚éƒ¨æç¤ºæ¬„ -->
            <div class="absolute top-0 left-0 right-0 z-10 p-6 flex flex-wrap gap-4 justify-center items-center" style="background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%); backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h2 class="text-4xl md:text-6xl font-bold" style="background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    ğŸ‘‚ è«‹è½ï¼š
                </h2>
                <div id="prompt-display" class="w-28 h-28 rounded-3xl flex justify-center items-center animate-pulse" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);">
                    <span id="prompt-text" class="text-7xl">ğŸµ</span>
                </div>
                <!-- é‡è¤‡æ’­æ”¾æŒ‰éˆ• -->
                <button id="repeat-button" class="p-4 rounded-full transform hover:scale-110 active:scale-95 transition-all" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);">
                    <svg class="speaker-icon" style="fill: white; width: 48px; height: 48px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                <!-- æ¨¡å¼åˆ‡æ› -->
                <label class="ml-2 text-xl font-bold" style="color: #667eea;">ğŸ“š æ¨¡å¼ï¼š</label>
                <select id="mode-select" class="px-4 py-3 border-2 border-purple-300 rounded-xl bg-white text-lg font-bold shadow-md" style="color: #667eea;">
                    <option value="shengmu">ğŸ…°ï¸ è²æ¯</option>
                    <option value="yunmu">ğŸ¶ éŸ»æ¯</option>
                    <option value="mix" selected>ğŸŒˆ æ··åˆ</option>
                </select>
            </div>

            <!-- æ³¡æ³¡å‡ºç¾çš„å®¹å™¨ -->
            <div id="bubble-container" class="absolute inset-0 z-0">
                <!-- æ³¡æ³¡æœƒç”± JS å‹•æ…‹åŠ å…¥é€™è£¡ -->
            </div>

            <!-- åˆ†æ•¸ -->
            <div class="absolute bottom-6 right-6 px-8 py-4 rounded-full shadow-2xl transform hover:scale-105 transition-all" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                <span class="text-4xl font-bold" style="background: linear-gradient(45deg, #f093fb, #f5576c); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    â­ åˆ†æ•¸ï¼š<span id="score">0</span>
                </span>
            </div>
        </div>

    </div>

    <script>
        // å¯é¸ï¼šè¼‰å…¥ç«™ç´šé…ç½®ï¼ˆè‹¥æ²’æœ‰ä¹Ÿä¸å½±éŸ¿åŸ·è¡Œï¼‰
        // æ³¨æ„ï¼šç‚ºç¬¦åˆæ¶æ§‹è¦ç¯„ï¼Œä½¿ç”¨çµ•å°è·¯å¾‘
        try {
            const s = document.createElement('script');
            s.src = '/assets/js/taixu-config.js';
            s.defer = false; // éœ€å„ªå…ˆåŸ·è¡Œä»¥æä¾›ç«¯é»
            document.head.appendChild(s);
        } catch (e) { /* å¿½ç•¥é…ç½®æª”ç¼ºå¤± */ }

        // DOM å…ƒç´ 
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const startButton = document.getElementById('start-button');
        const bubbleContainer = document.getElementById('bubble-container');
        const promptText = document.getElementById('prompt-text');
        const repeatButton = document.getElementById('repeat-button');
        const modeSelect = document.getElementById('mode-select');
        const scoreDisplay = document.getElementById('score');

        // æ¨¡å¼åˆ‡æ›ï¼šåˆ‡æ›é¡Œåº«ä¸¦åˆ·æ–°ä¸€å±€
        if (modeSelect) {
            modeSelect.addEventListener('change', () => {
                practiceMode = modeSelect.value;
                if (gameActive) setTimeout(newRound, 100);
            });
        }

        // éŠæˆ²æ•¸æ“šï¼šå®Œæ•´è²æ¯èˆ‡å¸¸è¦‹éŸ»æ¯ï¼ˆåªä½¿ç”¨å·²ä¸‹è¼‰éŸ³é »çš„éŸ»æ¯ï¼‰
        const SHENGMU = ['b','p','m','f','d','t','n','l','g','k','h','j','q','x','zh','ch','sh','r','z','c','s','y','w'];
        const YUNMU = [
            'a','o','e','i','u','Ã¼',
            'ai','ei','ui','ao','ou','iu',
            'ie','Ã¼e','er',
            'an','en','in','un','Ã¼n',
            'ang','eng','ing','ong'
        ];
        let practiceMode = 'mix'; // 'shengmu' | 'yunmu' | 'mix'
        
        // æ‹¼éŸ³ç™¼éŸ³æ˜ å°„è¡¨ï¼Œå¹«åŠ©èªéŸ³å¼•æ“æ­£ç¢ºç™¼éŸ³
        const pinyinPronunciationMap = {
            'b': 'bo',
            'p': 'po',
            'm': 'mo',
            'f': 'fo',
            'd': 'de',
            't': 'te',
            'n': 'ne',
            'l': 'le',
            'g': 'ge',
            'k': 'ke',
            'h': 'he',
            'j': 'ji',
            'q': 'qi',
            'x': 'xi',
            'zh': 'zhi',
            'ch': 'chi',
            'sh': 'shi',
            'r': 'ri',
            'z': 'zi',
            'c': 'ci',
            's': 'si',
            'y': 'yi',
            'w': 'wu'
        };

        // éŸ»æ¯ç™¼éŸ³æ˜ å°„ï¼ˆè®“åœ¨ç·š/æœ¬åœ°èªéŸ³èƒ½è®€æˆå®Œæ•´éŸ³ç¯€ï¼‰
        const finalPronunciationMap = {
            'a':'a','o':'o','e':'e','i':'yi','u':'wu','Ã¼':'yu',
            'ai':'ai','ei':'ei','ui':'wei','ao':'ao','ou':'ou','iu':'you',
            'ie':'ye','Ã¼e':'yue','er':'er',
            'an':'an','en':'en','in':'yin','un':'wen','Ã¼n':'yun',
            'ang':'ang','eng':'eng','ing':'ying','ong':'yong',
            'ia':'ya','ua':'wa','uo':'wo','uai':'wai','iao':'yao',
            'ian':'yan','iang':'yang','iong':'yong','uan':'wan','uang':'wang'
        };

        // è²æ¯ â†’ ä»£è¡¨æ€§æ¼¢å­—ï¼ˆè®€å‡ºå°æ‡‰æ•™å­¸éŸ³ç¯€ï¼Œå¦‚ bo/po/â€¦ã€zhi/chi/â€¦ï¼‰
        const initialToHanzi = {
            'b':'æ³¢','p':'å¡','m':'æ‘¸','f':'ä½›',
            'd':'å¾·','t':'ç‰¹','n':'å‘¢','l':'äº†',
            'g':'å“¥','k':'ç§‘','h':'å–',
            'j':'é›','q':'ä¸ƒ','x':'è¥¿',
            'zh':'çŸ¥','ch':'åƒ','sh':'å¸«','r':'æ—¥',
            'z':'è³‡','c':'æ¬¡','s':'æ€',
            'y':'ä¸€','w':'çƒ'
        };

        // éŸ»æ¯ â†’ ä»£è¡¨æ€§æ¼¢å­—ï¼ˆç”¨ y/w ä½œç‚ºè¼‰é«”ä»¥è®€å‡ºç´”éŸ»æ¯éŸ³ï¼‰
        const finalToHanzi = {
            'a':'å•Š','o':'å–”','e':'å‘ƒ','i':'è¡£','u':'çƒ','Ã¼':'è¿‚',
            'ai':'å“€','ei':'èª’','ui':'å¨','ao':'å‡¹','ou':'æ­','iu':'å„ª',
            'ie':'è€¶','Ã¼e':'ç´„','er':'å…’',
            'an':'å®‰','en':'æ©','in':'å› ','un':'æº«','Ã¼n':'æšˆ',
            'ang':'éª¯','eng':'é¥','ing':'è‹±','ong':'ç¿',
            'ia':'å‘€','ua':'å“‡','uo':'çª©','uai':'æ­ª','iao':'è…°',
            'ian':'ç…™','iang':'å¤®','iong':'é›','uan':'ç£','uang':'æ±ª'
        };

        // æ‹¼éŸ³åˆ°éŸ³é »æ–‡ä»¶åçš„æ˜ å°„ï¼ˆè™•ç† Ã¼ -> v ç­‰ç‰¹æ®Šæƒ…æ³ï¼‰
        function getAudioFileName(pinyin) {
            // éŸ»æ¯ç‰¹æ®Šæ˜ å°„
            if (pinyin === 'Ã¼') return 'v';
            if (pinyin === 'Ã¼e') return 've';
            if (pinyin === 'Ã¼n') return 'vn';
            return pinyin;
        }

        // æ’­æ”¾ä¸‹è¼‰çš„æ‹¼éŸ³éŸ³é »æ–‡ä»¶
        function playPinyinAudio(pinyin) {
            return new Promise((resolve, reject) => {
                if (!gameActive) return resolve();
                
                // åˆ¤æ–·æ˜¯è²æ¯é‚„æ˜¯éŸ»æ¯
                const isShengmu = SHENGMU.includes(pinyin);
                const isYunmu = YUNMU.includes(pinyin);
                
                if (!isShengmu && !isYunmu) {
                    console.warn('æœªçŸ¥çš„æ‹¼éŸ³:', pinyin);
                    return resolve();
                }
                
                // ç²å–æ–‡ä»¶å
                const fileName = getAudioFileName(pinyin);
                const audioPath = isShengmu 
                    ? `/files/audio/pinyin/shengmu/${fileName}.mp3`
                    : `/files/audio/pinyin/yunmu/${fileName}.mp3`;
                
                // åœæ­¢ä¸Šä¸€æ®µæ’­æ”¾
                if (externalAudio && !externalAudio.paused) {
                    try { 
                        externalAudio.pause(); 
                        externalAudio.src = '';
                    } catch(_) {}
                }
                
                // å‰µå»ºæ–°çš„éŸ³é »å°è±¡
                externalAudio = new Audio(audioPath);
                
                externalAudio.addEventListener('ended', () => resolve());
                externalAudio.addEventListener('error', (e) => {
                    console.error('éŸ³é »æ’­æ”¾å¤±æ•—:', audioPath, e);
                    resolve(); // å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒ
                });
                
                externalAudio.play().catch(err => {
                    console.error('ç„¡æ³•æ’­æ”¾éŸ³é »:', err);
                    resolve();
                });
            });
        }

        // æ’­æ”¾ä¸€æ®µç·šä¸Š TTS éŸ³è¨Šï¼›å¤±æ•—å‰‡å›é€€è‡³å…§å»ºèªéŸ³ï¼ˆç”¨æ–¼æ’­æ”¾ã€Œè«‹æ‰¾åˆ°ã€ç­‰æç¤ºèªï¼‰
        function ttsPlay(text) {
            return new Promise(async (resolve) => {
                const endpoint = (window.TAIXU_TTS_ENDPOINT || '').trim();
                const anon = (window.SUPABASE_ANON_KEY || '').trim();
                try {
                    if (endpoint) {
                        // åœæ­¢ä¸Šä¸€æ®µæ’­æ”¾
                        if (externalAudio && !externalAudio.paused) {
                            try { externalAudio.pause(); } catch(_) {}
                            externalAudio.src = '';
                        }
                        const params = new URLSearchParams();
                        params.set('text', text);
                        params.set('voice', 'zh-CN-XiaoxiaoNeural');
                        const headers = {};
                        if (anon) { headers['apikey'] = anon; headers['Authorization'] = `Bearer ${anon}`; }
                        const resp = await fetch(`${endpoint}?${params.toString()}`, { method:'GET', headers });
                        if (!resp.ok) throw new Error(`TTS ${resp.status}`);
                        const blob = await resp.blob();
                        const url = URL.createObjectURL(blob);
                        externalAudio = new Audio(url);
                        externalAudio.addEventListener('ended', () => resolve());
                        await externalAudio.play();
                        return;
                    }
                } catch (_) { /* å¤±æ•—å›é€€ */ }

                // å›é€€ï¼šå…§å»ºèªéŸ³
                const utter = new SpeechSynthesisUtterance(text);
                const v = selectMandarinVoice();
                if (v) utter.voice = v; else utter.lang = 'zh-CN';
                utter.pitch = 1.0; utter.rate = 1.0;
                utter.onend = () => resolve();
                synth.speak(utter);
            });
        }

        // ä¾ç›®æ¨™ï¼ˆè²æ¯/éŸ»æ¯ï¼‰æ’­æ”¾æç¤ºï¼šå…ˆæ’­ã€Œè«‹æ‰¾åˆ°ã€ï¼Œå†æ’­æ‹¼éŸ³éŸ³é »
        async function speakPromptForTarget(target) {
            if (!gameActive) return;
            // å…ˆæ’­æ”¾ã€Œè«‹æ‰¾åˆ°ã€æç¤ºèª
            await ttsPlay('è«‹æ‰¾åˆ°');
            // å†æ’­æ”¾å°æ‡‰çš„æ‹¼éŸ³éŸ³é »
            await playPinyinAudio(target);
        }

        let currentTarget = '';
        let score = 0;
        let gameActive = false;

        // èªéŸ³åˆæˆ API
        const synth = window.speechSynthesis;
        let voices = [];

        // å–å¾—ä¸¦å¿«å–å¯ç”¨èªéŸ³ï¼ˆæ”¾å¯¬èªè¨€ç¢¼åŒ¹é…ï¼Œé¿å…ä¸åŒç€è¦½å™¨æ¨™è¨˜å·®ç•°ï¼‰
        function loadVoices() {
            const all = synth.getVoices();
            // ä¸å…ˆéæ¿¾ï¼›ä¿ç•™å…¨éƒ¨ï¼Œå¾ŒçºŒåš´æ ¼æŒ‘é¸æ™®é€šè©±ï¼Œæ’é™¤ç²µèªï¼ˆzh-HKï¼‰
            voices = all || [];
        }
        // ç€è¦½å™¨åŠ è¼‰èªéŸ³åŒ…éœ€è¦æ™‚é–“ï¼›äº‹ä»¶è§¸ç™¼å¾Œé‡æ–°æŠ“å–
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices(); // ç«‹å³å˜—è©¦åŠ è¼‰

        // æ ¹æ“šå¯ç”¨æ¸…å–®æŒ‘é¸æœ€æ¥è¿‘ã€Œæ™®é€šè©±ï¼ˆä¸­åœ‹å¤§é™¸ï¼‰ã€çš„èªéŸ³
        function selectMandarinVoice() {
            if (!voices || voices.length === 0) return null;

            const isZhCN = v => /^(zh|cmn)[-_]?(CN|Hans)/i.test(v.lang || '') || /Mandarin|æ™®é€šè¯|Putonghua|ç®€ä½“|PRC|Mainland/i.test(v.name || '');
            const isZhTW = v => /^zh[-_]?TW/i.test(v.lang || '') || /Taiwan|å°ç£|è‡ºç£/i.test(v.name || '');
            const isZhHK = v => /^zh[-_]?HK/i.test(v.lang || '') || /Cantonese|ç²µèª|ç²¤è¯­|Hong\s*Kong/i.test(v.name || '');
            const isZhAny = v => /^zh/i.test(v.lang || '');

            // 1) å¼·å„ªå…ˆï¼šä¸­åœ‹å¤§é™¸æ™®é€šè©±ï¼ˆæˆ–åç¨±æ¨™è¨» Mandarin/PRC/Hans ç­‰ï¼‰
            const zhCN = voices.filter(v => isZhCN(v));
            if (zhCN.length) return zhCN[0];

            // 2) æ¬¡å„ªå…ˆï¼šå°ç£æ™®é€šè©±
            const zhTW = voices.filter(v => isZhTW(v));
            if (zhTW.length) return zhTW[0];

            // 3) æ³›ä¸­æ–‡èªéŸ³ä¸­ï¼Œæ’é™¤ç²µèªï¼ˆHKï¼‰
            const zhNotHK = voices.filter(v => isZhAny(v) && !isZhHK(v));
            if (zhNotHK.length) return zhNotHK[0];

            // 4) ä»æ‰¾ä¸åˆ°å°±å›å‚³ nullï¼Œæ”¹ç”¨èªè¨€ç¢¼å›é€€
            return null;
        }

        // æ’­æ”¾ Pinyin èªéŸ³
        let externalAudio = null;
        // æ–°å¢å¯é¸çš„ pinyinHintï¼Œæœƒäº¤çµ¦åœ¨ç·š TTS ä»¥ IPA å¼·åˆ¶æŒ‰æ‹¼éŸ³è®€
        async function speakPinyin(text, pinyinHint) {
            if (!gameActive) return;

            const endpoint = (window.TAIXU_TTS_ENDPOINT || '').trim();
            // å„ªå…ˆä½¿ç”¨åœ¨ç·š TTSï¼ˆè‹¥æœ‰é…ç½®ï¼‰
            if (endpoint) {
                try {
                    // åœæ­¢ä¸Šä¸€æ®µæ’­æ”¾
                    if (externalAudio && !externalAudio.paused) {
                        externalAudio.pause();
                        externalAudio.src = '';
                    }
                    const params = new URLSearchParams();
                    params.set('text', text);
                    params.set('voice', 'zh-CN-XiaoxiaoNeural');
                    if (pinyinHint) params.set('pinyin', pinyinHint);
                    const url = `${endpoint}?${params.toString()}`;
                    const headers = {};
                    const anon = (window.SUPABASE_ANON_KEY || '').trim();
                    if (anon) {
                        headers['apikey'] = anon;
                        headers['Authorization'] = `Bearer ${anon}`;
                    }
                    const resp = await fetch(url, { method: 'GET', headers });
                    if (!resp.ok) throw new Error(`TTS ${resp.status}`);
                    const blob = await resp.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    externalAudio = new Audio(objectUrl);
                    await externalAudio.play();
                    return; // æˆåŠŸæ’­æ”¾å°±ä¸å›é€€
                } catch (e) {
                    // å¤±æ•—å‰‡å›é€€è‡³ç€è¦½å™¨å…§å»ºèªéŸ³
                }
            }

            // å›é€€ï¼šç€è¦½å™¨å…§å»ºèªéŸ³
            if (synth.speaking) return; // é˜²æ­¢èªéŸ³é‡ç–Š
            const utterance = new SpeechSynthesisUtterance(text + (pinyinHint ? ' ' + pinyinHint : ''));
            const selectedVoice = selectMandarinVoice();
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                utterance.lang = 'zh-CN';
            }
            utterance.pitch = 1.3;
            utterance.rate = 0.8;
            synth.speak(utterance);
        }

        // éŸ³æ•ˆ (ä½¿ç”¨ Tone.js)
        // ç­”å°çš„éŸ³æ•ˆ
        const correctSynth = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
        }).toDestination();

        // ç­”éŒ¯çš„éŸ³æ•ˆ
        const incorrectSynth = new Tone.Synth({
            oscillator: { type: 'square' },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }
        }).toDestination();

        function playCorrectSound() {
            correctSynth.triggerAttackRelease('C5', '8n', Tone.now());
            correctSynth.triggerAttackRelease('G5', '8n', Tone.now() + 0.1);
        }

        function playIncorrectSound() {
            incorrectSynth.triggerAttackRelease('C3', '4n', Tone.now());
        }

        // --- éŠæˆ²é‚è¼¯ ---

        // é–‹å§‹éŠæˆ²
        startButton.addEventListener('click', async () => {
            // Tone.js å’Œ èªéŸ³ API éœ€è¦ç”¨æˆ¶æ‰‹å‹¢ä¾†å•Ÿå‹•
            await Tone.start();
            
            // é ç†±èªéŸ³å¼•æ“
            if (synth.state === 'suspended') {
                synth.resume();
            }

            // å…ˆåˆ‡æ›åˆ°éŠæˆ²ç•«é¢ä¸¦æ¨™è¨˜ç‚ºå•Ÿå‹•ï¼Œå†è§¸ç™¼èªéŸ³ï¼ˆé¿å…å›  gameActive=false è€Œè¢«æ””æˆªï¼‰
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameActive = true;
            score = 0;
            scoreDisplay.textContent = score;

            speakPinyin('éŠæˆ²é–‹å§‹'); // æ’­æ”¾ä¸€å€‹ç°¡çŸ­èªéŸ³ä»¥å•Ÿå‹•èªéŸ³å¼•æ“
            
            // å»¶é²ä¸€é»é–‹å§‹ç¬¬ä¸€å±€ï¼Œç¢ºä¿èªéŸ³å¼•æ“æº–å‚™å¥½äº†
            setTimeout(newRound, 500);
        });

        // é‡è¤‡æ’­æ”¾æŒ‰éˆ•ï¼šå…ˆæ’­æç¤ºï¼Œå†æ’­ä»£è¡¨æ¼¢å­—
        repeatButton.addEventListener('click', () => {
            if (currentTarget) {
                speakPromptForTarget(currentTarget);
            }
        });

        // é–‹å§‹æ–°ä¸€å±€
        function newRound() {
            if (!gameActive) return;

            // 1. æ¸…é™¤èˆŠçš„æ³¡æ³¡
            bubbleContainer.innerHTML = '';

            // 2. æ±ºå®šé¡Œåº«ä¸¦éš¨æ©Ÿé¸ä¸€å€‹ç›®æ¨™ï¼ˆè²æ¯/éŸ»æ¯/æ··åˆï¼‰
            const pool = practiceMode === 'shengmu' ? SHENGMU : (practiceMode === 'yunmu' ? YUNMU : SHENGMU.concat(YUNMU));
            currentTarget = pool[Math.floor(Math.random() * pool.length)];
            
            // 3. å‰µå»ºä¸€çµ„é¸é … (åŒ…å«æ­£ç¢ºç­”æ¡ˆ)
            let options = [currentTarget];
            // å‰µå»º 3 å€‹å¹²æ“¾é …
            while (options.length < 4) {
                const distractor = pool[Math.floor(Math.random() * pool.length)];
                if (!options.includes(distractor)) {
                    options.push(distractor);
                }
            }
            
            // 4. æ‰“äº‚é¸é …é †åº
            const shuffledOptions = options.sort(() => Math.random() - 0.5);

            // 5. å‰µå»ºæ³¡æ³¡
            shuffledOptions.forEach((pinyin, index) => {
                // å»¶é²å‰µå»ºæ³¡æ³¡ï¼Œè®“å®ƒå€‘éŒ¯é–‹
                setTimeout(() => createBubble(pinyin), index * 500);
            });

            // 6. æ›´æ–°æç¤ºï¼ˆä¸é¡¯ç¤ºæ‹¼éŸ³ï¼Œåªé¡¯ç¤ºéŸ³æ¨‚ç¬¦è™Ÿï¼‰ä¸¦æ’­æ”¾èªéŸ³
            promptText.textContent = 'ğŸµ'; // ä¸é¡¯ç¤ºæ‹¼éŸ³å­—æ¯ï¼Œåªé¡¯ç¤ºç¬¦è™Ÿ
            setTimeout(() => {
                speakPromptForTarget(currentTarget);
            }, 800); // å»¶é²æ’­æ”¾èªéŸ³ï¼Œç­‰æ³¡æ³¡å‡ºä¾†ä¸€é»
        }

        // å½©è™¹æ³¡æ³¡é¡è‰²é™£åˆ—
        const bubbleColors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',      // ç´«è‰²
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',      // ç²‰ç´…
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',      // è—è‰²
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',      // ç¶ è‰²
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',      // æ©™ç²‰
            'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',      // è—ç´«
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',      // æ·¡å½©è™¹
            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',      // ç²‰è‰²
            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',      // æ©™è‰²
            'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)'       // ç´…è—
        ];

        // å‰µå»ºç²’å­çˆ†ç‚¸æ•ˆæœ
        function createParticles(x, y, color) {
            const particleCount = 12;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.background = color;
                
                // è¨ˆç®—éš¨æ©Ÿæ–¹å‘
                const angle = (Math.PI * 2 * i) / particleCount;
                const velocity = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                bubbleContainer.appendChild(particle);
                
                // å‹•ç•«çµæŸå¾Œç§»é™¤
                setTimeout(() => particle.remove(), 800);
            }
        }

        // å‰µå»ºæ˜Ÿæ˜Ÿæ•ˆæœ
        function createStars(x, y) {
            const stars = ['â­', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«'];
            const starCount = 5;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = stars[Math.floor(Math.random() * stars.length)];
                star.style.left = `${x + (Math.random() - 0.5) * 100}px`;
                star.style.top = `${y + (Math.random() - 0.5) * 100}px`;
                
                bubbleContainer.appendChild(star);
                
                // å‹•ç•«çµæŸå¾Œç§»é™¤
                setTimeout(() => star.remove(), 600);
            }
        }

        // å‰µå»ºå–®å€‹æ³¡æ³¡
        function createBubble(pinyin) {
            if (!gameActive) return; // å¦‚æœéŠæˆ²çµæŸäº†å°±ä¸å†å‰µå»º

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // éš¨æ©Ÿå¤§å° (å° iPad æ›´å‹å¥½ï¼Œç¨å¾®å¤§ä¸€é»)
            const size = Math.floor(Math.random() * 70) + 110; // 110px åˆ° 180px
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            
            // éš¨æ©Ÿå½©è™¹é¡è‰²
            const randomColor = bubbleColors[Math.floor(Math.random() * bubbleColors.length)];
            bubble.style.background = randomColor;
            bubble.dataset.color = randomColor; // ä¿å­˜é¡è‰²ç”¨æ–¼ç²’å­æ•ˆæœ
            
            // éš¨æ©Ÿæ°´å¹³ä½ç½®
            bubble.style.left = `${Math.random() * (window.innerWidth - size - 20) + 10}px`;
            
            // éš¨æ©Ÿä¸Šæµ®é€Ÿåº¦
            bubble.style.animationDuration = `${Math.random() * 5 + 8}s`; // 8åˆ°13ç§’
            
            // è¨­ç½®æ–‡å­— - æ›´å¤§æ›´æ˜é¡¯
            bubble.textContent = pinyin;
            bubble.style.fontSize = `${size / 2.2}px`; // å­—é«”å¤§å°éš¨æ³¡æ³¡å¤§å°è®ŠåŒ–
            
            // å­˜å„² pinyin æ•¸æ“š
            bubble.dataset.pinyin = pinyin;

            // æ·»åŠ è§¸æ‘¸äº‹ä»¶ (ä½¿ç”¨ touchstart åæ‡‰æ›´å¿«)
            bubble.addEventListener('touchstart', handleBubbleTap, { passive: true });
            // åŒæ™‚å…¼å®¹é›»è…¦é¼ æ¨™é»æ“Š
            bubble.addEventListener('click', handleBubbleTap);

            // æ³¡æ³¡é£„å‡ºå±å¹•å¾Œè‡ªå‹•ç§»é™¤
            bubble.addEventListener('animationend', () => {
                bubble.remove();
            });

            bubbleContainer.appendChild(bubble);
        }

        // è™•ç†æ³¡æ³¡é»æ“Š
        function handleBubbleTap(event) {
            if (!gameActive) return;

            // é˜²æ­¢åœ¨å‹•ç•«ä¸­é‡è¤‡é»æ“Š
            const bubble = event.currentTarget;
            if (bubble.classList.contains('pop') || bubble.classList.contains('wiggle')) {
                return;
            }

            const tappedPinyin = bubble.dataset.pinyin;

            if (tappedPinyin === currentTarget) {
                // ç­”å°äº†ï¼å‰µå»ºç¾éº—çš„çˆ†ç‚¸æ•ˆæœ
                playCorrectSound();
                
                // ç²å–æ³¡æ³¡ä½ç½®
                const rect = bubble.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                // å‰µå»ºå½©è™¹ç²’å­çˆ†ç‚¸æ•ˆæœ
                const bubbleColor = bubble.dataset.color || bubbleColors[0];
                createParticles(x, y, bubbleColor);
                
                // å‰µå»ºæ˜Ÿæ˜Ÿæ•ˆæœ
                createStars(x, y);
                
                // æ³¡æ³¡ç ´è£‚å‹•ç•«
                bubble.classList.add('pop');
                score++;
                scoreDisplay.textContent = score;

                // ç§»é™¤äº‹ä»¶ç›£è½å™¨ï¼Œé˜²æ­¢å·²ç ´è£‚çš„æ³¡æ³¡è¢«å†æ¬¡é»æ“Š
                bubble.removeEventListener('touchstart', handleBubbleTap);
                bubble.removeEventListener('click', handleBubbleTap);

                // åœæ­¢æ‰€æœ‰æ³¡æ³¡çš„å‹•ç•«ä¸¦æ¸…é™¤
                document.querySelectorAll('.bubble').forEach(b => {
                    b.style.animationPlayState = 'paused';
                    if (!b.classList.contains('pop')) {
                        b.classList.add('pop'); // è®“å…¶ä»–æ³¡æ³¡ä¹Ÿç ´æ‰
                    }
                });

                // 1.5ç§’å¾Œé–‹å§‹æ–°ä¸€å±€
                setTimeout(newRound, 1500);

            } else {
                // ç­”éŒ¯äº†
                playIncorrectSound();
                bubble.classList.add('wiggle');
                // æ™ƒå‹•å‹•ç•«çµæŸå¾Œç§»é™¤ classï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é»æ“Š
                setTimeout(() => {
                    bubble.classList.remove('wiggle');
                }, 500);
                
                // èªéŸ³æç¤º
                speakPinyin(`ä¸å°å“¦ï¼Œå†è©¦è©¦çœ‹`);
            }
        }
        
        // ç¢ºä¿åœ¨èª¿æ•´çª—å£å¤§å°æ™‚æ³¡æ³¡ä»åœ¨ç¯„åœå…§
        window.addEventListener('resize', () => {
            // ç°¡å–®è™•ç†ï¼šé‡æ–°é–‹å§‹ä¸€å±€
            if(gameActive) {
                newRound();
            }
        });

    </script>

    <!-- æ‡‰ç”¨åˆ‡æ›å™¨ï¼ˆæ¶æ§‹è¦ç¯„ï¼šæ–¼æ¯å€‹æ‡‰ç”¨é å°¾å¼•å…¥ï¼Œä¸”ä½¿ç”¨çµ•å°è·¯å¾‘ï¼‰ -->
    <script src="/assets/js/taixu-app-switcher.js"></script>

</body>
</html>

