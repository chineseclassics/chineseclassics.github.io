---
description: Story-Vocab ç”¨æˆ¶ ID ä½¿ç”¨è¦ç¯„ - å¤šé‡èº«ä»½ç³»çµ±æœ€ä½³å¯¦è¸
alwaysApply: false
manual: true
---

# Story-Vocab ç”¨æˆ¶ ID ä½¿ç”¨è¦ç¯„

> **é—œéµåŸå‰‡**ï¼šè©éŠè¨˜ä½¿ç”¨ UUID ä¸»éµ + å¤šé‡èº«ä»½ç³»çµ±ï¼Œ`auth.uid()` â‰  `users.id`

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Auth      â”‚
â”‚  auth.uid()         â”‚  â† Google ID / åŒ¿å ID
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“ (æ˜ å°„)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user_identities    â”‚
â”‚  provider_id        â”‚  = auth.uid()
â”‚  user_id            â”‚  â†’ æŒ‡å‘ users.id
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  users              â”‚
â”‚  id (UUID)          â”‚  â† é€™æ‰æ˜¯çœŸæ­£çš„ç”¨æˆ¶ ID
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âŒ éŒ¯èª¤åšæ³•ï¼ˆçµ•å°ç¦æ­¢ï¼‰

### å‰ç«¯éŒ¯èª¤ç¤ºä¾‹

```javascript
// âŒ éŒ¯èª¤ï¼šç›´æ¥ä½¿ç”¨ auth.uid()
const { data: { user } } = await supabase.auth.getUser();
await supabase.from('game_rounds').insert({
  user_id: user.id  // é€™æ˜¯ provider_idï¼Œä¸æ˜¯ users.idï¼
});

// âŒ éŒ¯èª¤ï¼šæŸ¥è©¢æ™‚ä½¿ç”¨ auth.uid()
const { data } = await supabase
  .from('user_wordbook')
  .select('*')
  .eq('user_id', user.id);  // æœƒæŸ¥ä¸åˆ°æ•¸æ“šï¼
```

### æ•¸æ“šåº«éŒ¯èª¤ç¤ºä¾‹

```sql
-- âŒ éŒ¯èª¤ï¼šRLS ç­–ç•¥ç›´æ¥æ¯”è¼ƒ auth.uid()
CREATE POLICY "users_select_own" ON game_rounds
  FOR SELECT
  USING (user_id = auth.uid());  -- ä¸æœƒå·¥ä½œï¼
```

## âœ… æ­£ç¢ºåšæ³•

### å‰ç«¯ï¼šä½¿ç”¨ gameState.userId

```javascript
// âœ… æ­£ç¢ºï¼šä½¿ç”¨ gameState ä¸­çš„ userId
import { gameState } from '../core/game-state.js';

// æ’å…¥æ•¸æ“š
await supabase.from('game_rounds').insert({
  user_id: gameState.userId  // é€™æ˜¯æ­£ç¢ºçš„ users.id
});

// æŸ¥è©¢æ•¸æ“š
const { data } = await supabase
  .from('user_wordbook')
  .select('*')
  .eq('user_id', gameState.userId);

// å‰µå»ºæ–°è¨˜éŒ„
const { data: newRecord } = await supabase
  .from('wordlists')
  .insert({
    owner_id: gameState.userId,
    name: 'æˆ‘çš„è©è¡¨'
  });
```

### æ•¸æ“šåº«ï¼šä½¿ç”¨ get_user_id_from_auth()

```sql
-- âœ… æ­£ç¢ºï¼šä½¿ç”¨æ˜ å°„å‡½æ•¸
CREATE POLICY "users_select_own" ON game_rounds
  FOR SELECT
  USING (user_id = get_user_id_from_auth());

CREATE POLICY "users_insert_own" ON game_rounds
  FOR INSERT
  WITH CHECK (user_id = get_user_id_from_auth());
```

### èªè­‰æœå‹™ï¼šæ­£ç¢ºç²å–ç”¨æˆ¶

```javascript
// âœ… æ­£ç¢ºï¼šä½¿ç”¨èªè­‰æœå‹™
import { createAuthService } from './auth/auth-service.js';

const authService = await createAuthService();
const user = await authService.getCurrentUser();
// user.id å°±æ˜¯æ­£ç¢ºçš„ users.id

gameState.userId = user.id;
gameState.user = user;
```

## ğŸ“‹ é–‹ç™¼æª¢æŸ¥æ¸…å–®

### å¯«å‰ç«¯ä»£ç¢¼æ™‚

- [ ] éœ€è¦ç”¨æˆ¶ IDï¼Ÿä½¿ç”¨ `gameState.userId`
- [ ] ä¸è¦èª¿ç”¨ `supabase.auth.getUser()` ç²å– user.id
- [ ] ä¸è¦ä½¿ç”¨ `supabase-client.js` çš„ `getCurrentUser()`ï¼ˆå·²æ£„ç”¨ï¼‰
- [ ] ä½¿ç”¨èªè­‰æœå‹™ï¼š`authService.getCurrentUser()`

### å¯«æ•¸æ“šåº«é·ç§»æ™‚

- [ ] è¡¨ä¸­æœ‰ `user_id` æ¬„ä½ï¼Ÿå•Ÿç”¨ RLS
- [ ] RLS ç­–ç•¥ä½¿ç”¨ `get_user_id_from_auth()`
- [ ] ä¸è¦ä½¿ç”¨ `auth.uid() = user_id`
- [ ] æ¸¬è©¦ç­–ç•¥ï¼šåŒ¿åç”¨æˆ¶å’Œ Google ç”¨æˆ¶éƒ½è¦æ¸¬è©¦

### Code Review æ™‚

- [ ] æœå°‹ `auth.getUser()` - æ‡‰è©²å¾ˆå°‘è¦‹
- [ ] æœå°‹ `user.id` - ç¢ºä¿ä¾†è‡ª `gameState.userId`
- [ ] æœå°‹ `auth.uid()` - åªæ‡‰å‡ºç¾åœ¨ `get_user_id_from_auth()` å‡½æ•¸å…§
- [ ] æª¢æŸ¥æ‰€æœ‰ RLS ç­–ç•¥æ˜¯å¦ä½¿ç”¨æ˜ å°„å‡½æ•¸

## ğŸ”§ æ˜ å°„å‡½æ•¸ï¼ˆæ•¸æ“šåº«ï¼‰

```sql
-- é€™å€‹å‡½æ•¸å·²ç¶“å­˜åœ¨æ–¼æ•¸æ“šåº«ä¸­
CREATE OR REPLACE FUNCTION get_user_id_from_auth()
RETURNS UUID AS $$
BEGIN
  RETURN (
    SELECT user_id 
    FROM user_identities 
    WHERE provider_id = auth.uid()::text
    LIMIT 1
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**ç”¨é€”**ï¼šåœ¨ RLS ç­–ç•¥ä¸­å°‡ `auth.uid()` æ˜ å°„åˆ° `users.id`

## ğŸ› æ•…éšœæ’é™¤

### 403 Forbidden éŒ¯èª¤

**åŸå› **ï¼šRLS ç­–ç•¥ä½¿ç”¨äº†éŒ¯èª¤çš„ user_id æ¯”è¼ƒ

**è§£æ±º**ï¼š
1. æª¢æŸ¥ RLS ç­–ç•¥æ˜¯å¦ä½¿ç”¨ `get_user_id_from_auth()`
2. æŸ¥çœ‹ç­–ç•¥ï¼š`SELECT * FROM pg_policies WHERE tablename = 'your_table';`
3. é‡æ–°å‰µå»ºç­–ç•¥ä½¿ç”¨æ­£ç¢ºçš„æ˜ å°„å‡½æ•¸

### æŸ¥è©¢è¿”å›ç©ºçµæœ

**åŸå› **ï¼šå‰ç«¯ä½¿ç”¨äº† `auth.uid()` è€Œä¸æ˜¯ `gameState.userId`

**è§£æ±º**ï¼š
1. æª¢æŸ¥æŸ¥è©¢æ˜¯å¦ä½¿ç”¨ `gameState.userId`
2. ç¢ºèª `gameState.userId` å·²æ­£ç¢ºè¨­ç½®
3. æ¸¬è©¦ï¼š`console.log('userId:', gameState.userId)`

### æ’å…¥å¤±æ•—

**åŸå› **ï¼šæ’å…¥æ™‚ä½¿ç”¨äº†éŒ¯èª¤çš„ user_id

**è§£æ±º**ï¼š
1. ç¢ºä¿æ’å…¥æ•¸æ“šä½¿ç”¨ `gameState.userId`
2. æª¢æŸ¥ RLS INSERT ç­–ç•¥æ˜¯å¦æ­£ç¢º
3. é©—è­‰ç”¨æˆ¶å·²ç™»å…¥ï¼š`if (!gameState.userId) return;`

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [èªè­‰æ¶æ§‹](.cursor/rules/story-vocab-auth.mdc)
- [å¤šé‡èº«ä»½ç³»çµ±é·ç§»](mdc:story-vocab/supabase/migrations/20251011_multi_identity_system.sql)
- [RLS ä¿®å¾©é·ç§»](mdc:story-vocab/supabase/migrations/009_fix_rls_for_multi_identity.sql)
- [AI ç³»çµ± RLS ä¿®å¾©](mdc:story-vocab/supabase/migrations/010_fix_ai_system_rls.sql)
- [èªè­‰æœå‹™å¯¦ç¾](mdc:story-vocab/js/auth/standalone-auth.js)
- [éŠæˆ²ç‹€æ…‹ç®¡ç†](mdc:story-vocab/js/core/game-state.js)

## ğŸ¯ æ ¸å¿ƒè¨˜æ†¶

1. **auth.uid() æ˜¯ provider_idï¼Œä¸æ˜¯ users.id**
2. **å‰ç«¯ä½¿ç”¨ gameState.userId**
3. **æ•¸æ“šåº«ä½¿ç”¨ get_user_id_from_auth()**
4. **æ–°è¡¨å¿…é ˆé…ç½® RLS ç­–ç•¥**
5. **æ¸¬è©¦å…©ç¨®ç™»å…¥æ–¹å¼ï¼šGoogle å’ŒåŒ¿å**

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-10-12  
**ç¶­è­·è€…**ï¼šæ›¸é™¢ä¸­æ–‡ç¶“å…¸  
**è‡ªå‹•å•Ÿç”¨**ï¼šç•¶ç·¨è¼¯ story-vocab çš„ JS/TS/SQL æ–‡ä»¶æ™‚
