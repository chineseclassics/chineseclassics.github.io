---
description: Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–æœ€ä½³å¯¦è¸ - è·¨å¹³å°å…¼å®¹æ€§èˆ‡èªè­‰ç©©å®šæ€§
globs:
  - "**/*.html"
  - "**/*auth*.js"
  - "**/*supabase*.js"
alwaysApply: false
---

# Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–æœ€ä½³å¯¦è¸

> **ç¶“é©—ä¾†æº**ï¼šè©©è©çµ„å¥é ç¨‹å°æˆ°åœ¨ GitHub Pages ä¸Šå¡åœ¨ã€Œèªè­‰ä¸­ã€å•é¡Œçš„æ’æŸ¥èˆ‡ä¿®å¾©ï¼ˆ2025-10-15ï¼‰

## æ ¸å¿ƒå•é¡Œ

### å•é¡Œç¾è±¡
- **GitHub Pages**ï¼šé ç¨‹å°æˆ°å»ºç«‹æˆ¿é–“æ™‚å¡åœ¨ã€Œèªè­‰ä¸­ã€ï¼Œ`getUser()` / `getSession()` ç„¡é™æ›èµ·
- **Cloudflare Pages**ï¼šåŒæ¨£çš„ä»£ç¢¼æ­£å¸¸é‹è¡Œ
- **éš±èº«æ¨¡å¼**ï¼šåœ¨ GitHub Pages ä¸Šä¹Ÿèƒ½æ­£å¸¸é‹è¡Œ

### æ ¹æœ¬åŸå› 
Supabase å®¢æˆ¶ç«¯åˆå§‹åŒ–æ™‚**æ²’æœ‰æ˜ç¢ºé…ç½® auth é¸é …**ï¼Œå°è‡´ï¼š
1. åœ¨ä¸åŒè¨—ç®¡ç’°å¢ƒä¸‹ä½¿ç”¨ä¸åŒçš„é»˜èªå­˜å„²ç­–ç•¥
2. GitHub Pages å° localStorage è¨ªå•æ›´åš´æ ¼ï¼Œé»˜èªè¡Œç‚ºå¯èƒ½éœé»˜å¤±æ•—
3. èˆŠçš„æˆ–æå£çš„ session æ•¸æ“šå°è‡´èªè­‰ API æ›èµ·
4. ä¸åŒæ‡‰ç”¨å…±äº«åŒä¸€å€‹ storageKeyï¼Œå¯èƒ½ç”¢ç”Ÿè¡çª

---

## âœ… æ­£ç¢ºçš„åˆå§‹åŒ–æ–¹å¼

### åŸºæœ¬é…ç½®ï¼ˆå¿…éœ€ï¼‰

```javascript
// âŒ éŒ¯èª¤ï¼šæ²’æœ‰é…ç½®é¸é …
window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// âœ… æ­£ç¢ºï¼šæ˜ç¢ºé…ç½® auth é¸é …
window.sb = window.supabase.createClient(
    SUPABASE_URL, 
    SUPABASE_ANON_KEY,
    {
        auth: {
            persistSession: true,          // æŒä¹…åŒ– session
            autoRefreshToken: true,        // è‡ªå‹•åˆ·æ–° token
            detectSessionInUrl: true,      // æª¢æ¸¬ URL ä¸­çš„ sessionï¼ˆOAuth å›èª¿ï¼‰
            storage: window.localStorage,  // æ˜ç¢ºæŒ‡å®šä½¿ç”¨ localStorage
            storageKey: 'sb-yourapp'       // ğŸ”‘ æ‡‰ç”¨å°ˆå±¬ keyï¼Œé¿å…è¡çª
        }
    }
);
```

### é—œéµé…ç½®èªªæ˜

#### 1. `persistSession: true`
- **ä½œç”¨**ï¼šå°‡ session ä¿å­˜åˆ° storageï¼Œç”¨æˆ¶åˆ·æ–°é é¢å¾Œä»ä¿æŒç™»å…¥
- **é©ç”¨**ï¼šéœ€è¦æŒä¹…ç™»å…¥çš„æ‡‰ç”¨ï¼ˆå¦‚é ç¨‹å°æˆ°ã€ç”¨æˆ¶è³¬è™Ÿç³»çµ±ï¼‰

#### 2. `autoRefreshToken: true`
- **ä½œç”¨**ï¼šåœ¨ token éæœŸå‰è‡ªå‹•åˆ·æ–°ï¼Œä¿æŒ session æœ‰æ•ˆ
- **é©ç”¨**ï¼šé•·æ™‚é–“é‹è¡Œçš„æ‡‰ç”¨

#### 3. `detectSessionInUrl: true`
- **ä½œç”¨**ï¼šè‡ªå‹•æª¢æ¸¬ OAuth å›èª¿ URL ä¸­çš„ sessionï¼ˆå¦‚ Google ç™»å…¥å¾Œçš„é‡å®šå‘ï¼‰
- **é©ç”¨**ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹ç™»å…¥ï¼ˆGoogleã€GitHub ç­‰ï¼‰çš„æ‡‰ç”¨

#### 4. `storage: window.localStorage`
- **ä½œç”¨**ï¼šæ˜ç¢ºæŒ‡å®šä½¿ç”¨ localStorageï¼ˆè€Œéè®“ Supabase è‡ªå‹•é¸æ“‡ï¼‰
- **é‡è¦æ€§**ï¼šé¿å…ä¸åŒç’°å¢ƒä¸‹é»˜èªè¡Œç‚ºä¸ä¸€è‡´

#### 5. `storageKey: 'sb-yourapp'` â­ **æœ€é—œéµ**
- **ä½œç”¨**ï¼šç‚ºç•¶å‰æ‡‰ç”¨æŒ‡å®šå°ˆå±¬çš„ storage key
- **é¿å…**ï¼šä¸åŒæ‡‰ç”¨å…±äº«åŒä¸€å€‹ keyï¼Œå°è‡´ session è¡çª
- **å‘½å**ï¼š`sb-æ‡‰ç”¨åç¨±`ï¼ˆå¦‚ `sb-shicizuju`ã€`sb-storyvocab`ï¼‰

---

## ğŸ”§ èªè­‰æµç¨‹æœ€ä½³å¯¦è¸

### å•é¡Œï¼šèªè­‰ API å¯èƒ½æ›èµ·

åœ¨æŸäº›ç’°å¢ƒä¸‹ï¼ˆç‰¹åˆ¥æ˜¯ GitHub Pagesï¼‰ï¼Œ`getUser()` / `getSession()` å¯èƒ½ç„¡é™æ›èµ·ã€‚

### è§£æ±ºæ–¹æ¡ˆï¼šè¶…æ™‚ä¿è­· + æ¸…ç† + é‡è©¦

```javascript
// è¶…æ™‚å·¥å…·å‡½æ•¸
function withTimeout(promise, ms, label) {
    let timer;
    const timeout = new Promise((_, reject) => {
        timer = setTimeout(() => reject(new Error((label || 'operation') + ' è¶…æ™‚')), ms);
    });
    return Promise.race([
        promise.finally(() => clearTimeout(timer)),
        timeout
    ]);
}

// Session æ¸…ç†å‡½æ•¸ï¼ˆç§»é™¤æå£çš„ session æ•¸æ“šï¼‰
function sanitizeSupabaseSessionStorage() {
    try {
        const ls = window.localStorage;
        if (!ls) return;
        
        const keys = [];
        for (let i = 0; i < ls.length; i++) {
            const k = ls.key(i);
            if (k && k.startsWith('sb-') && k.endsWith('-auth-token')) {
                keys.push(k);
            }
        }
        
        let removed = 0;
        keys.forEach(k => {
            const raw = ls.getItem(k);
            if (!raw) return;
            try {
                const obj = JSON.parse(raw);
                // æª¢æŸ¥åŸºæœ¬çµæ§‹æ˜¯å¦å®Œæ•´
                const ok = !!(obj && (obj.currentSession || obj.user || obj.access_token || obj.session));
                if (!ok) {
                    ls.removeItem(k);
                    removed++;
                    console.warn('[auth] ç§»é™¤ç„¡æ•ˆ session:', k);
                }
            } catch (e) {
                // JSON è§£æå¤±æ•—ï¼Œè¦–ç‚ºæå£
                ls.removeItem(k);
                removed++;
                console.warn('[auth] ç§»é™¤æå£ session:', k);
            }
        });
        
        if (removed > 0) {
            console.warn('[auth] Session æ¸…ç†å®Œæˆï¼Œç§»é™¤æ•¸é‡:', removed);
        }
    } catch (e) {
        console.warn('[auth] Session æ¸…ç†ç•°å¸¸:', e);
    }
}

// ç©©å¥çš„èªè­‰æµç¨‹
async function ensureAuth() {
    if (!sb || !sb.auth) throw new Error('Supabase æœªå°±ç·’');
    
    try {
        // 0. æ¸…ç†å¯èƒ½çš„å£ session
        sanitizeSupabaseSessionStorage();
        
        // 1. å„ªå…ˆä½¿ç”¨ getUserï¼ˆè¼ƒè¼•é‡ï¼‰ï¼ŒåŠ è¶…æ™‚ä¿è­·
        try {
            const { data: { user } } = await withTimeout(
                sb.auth.getUser(), 
                4000, 
                'getUser'
            );
            if (user) {
                console.log('âœ… æ‰¾åˆ°ç¾æœ‰æœƒè©±ï¼Œç”¨æˆ¶ID:', user.id);
                return user;
            }
        } catch (e) {
            console.warn('âš ï¸ getUser è¶…æ™‚/å¤±æ•—:', e?.message);
            // ç¹¼çºŒå˜—è©¦åŒ¿åç™»å…¥
        }
        
        // 2. åŸ·è¡ŒåŒ¿åç™»å…¥
        console.log('åŸ·è¡ŒåŒ¿åç™»å…¥...');
        let result = await withTimeout(
            sb.auth.signInAnonymously(), 
            8000, 
            'signInAnonymously'
        );
        
        if (!result?.data?.user) {
            // ç™»å…¥è¿”å›ç©ºï¼Œæ¸…ç†å¾Œé‡è©¦
            try { await sb.auth.signOut(); } catch(_){}
            sanitizeSupabaseSessionStorage();
            result = await withTimeout(
                sb.auth.signInAnonymously(), 
                8000, 
                'signInAnonymously#retry'
            );
        }
        
        const user = result?.data?.user;
        if (user) {
            console.log('âœ… åŒ¿åç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶ID:', user.id);
            return user;
        }
        
        // 3. Fallbackï¼šå˜—è©¦ getSession
        const { data: { session } } = await withTimeout(
            sb.auth.getSession(), 
            8000, 
            'getSession#fallback'
        );
        if (session?.user) {
            console.log('âœ… é€é fallback æ‰¾åˆ°æœƒè©±ï¼Œç”¨æˆ¶ID:', session.user.id);
            return session.user;
        }
        
        throw new Error('ç„¡æ³•ç²å–ç”¨æˆ¶ï¼ˆæ‰€æœ‰æ–¹æ³•å‡å¤±æ•—ï¼‰');
    } catch (err) {
        console.error('âŒ èªè­‰å¤±æ•—:', err);
        throw err;
    }
}
```

---

## ğŸ“‹ ä¸åŒæ‡‰ç”¨å ´æ™¯çš„é…ç½®

### 1. å–®é æ‡‰ç”¨ï¼ˆåªéœ€åŒ¿åèªè­‰ï¼‰

**é©ç”¨**ï¼šè©©è©çµ„å¥é ç¨‹å°æˆ°ã€ç°¡å–®çš„å¤šäººéŠæˆ²

```javascript
window.sb = window.supabase.createClient(
    SUPABASE_URL, 
    SUPABASE_ANON_KEY,
    {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: false,     // ä¸éœ€è¦ OAuth
            storage: window.localStorage,
            storageKey: 'sb-yourapp'       // å¿…éœ€ï¼
        }
    }
);
```

### 2. ç”¨æˆ¶è³¬è™Ÿç³»çµ±ï¼ˆGoogle ç™»å…¥ï¼‰

**é©ç”¨**ï¼šè©éŠè¨˜ï¼ˆstory-vocabï¼‰ã€éœ€è¦ç”¨æˆ¶èº«ä»½çš„æ‡‰ç”¨

```javascript
const supabaseClient = createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
        auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: true,      // OAuth å›èª¿éœ€è¦
            storage: window.localStorage,
            storageKey: 'sb-yourapp'       // å¿…éœ€ï¼
        }
    }
);
```

### 3. è‡¨æ™‚æœƒè©±ï¼ˆä¸æŒä¹…åŒ–ï¼‰

**é©ç”¨**ï¼šè‡¨æ™‚è¨ªå®¢ã€é–±è®€æ¨¡å¼

```javascript
window.sb = window.supabase.createClient(
    SUPABASE_URL, 
    SUPABASE_ANON_KEY,
    {
        auth: {
            persistSession: false,         // ä¸æŒä¹…åŒ–
            autoRefreshToken: true,
            detectSessionInUrl: false,
            storage: window.sessionStorage, // ä½¿ç”¨ sessionStorageï¼ˆé—œé–‰åˆ†é å³æ¸…é™¤ï¼‰
            storageKey: 'sb-yourapp'       // ä»éœ€è¦ï¼Œé¿å…è¡çª
        }
    }
);
```

---

## ğŸš¨ å¸¸è¦‹éŒ¯èª¤èˆ‡ä¿®å¾©

### éŒ¯èª¤ 1ï¼šæ²’æœ‰é…ç½®é¸é …

```javascript
// âŒ éŒ¯èª¤
window.sb = window.supabase.createClient(URL, KEY);

// âœ… ä¿®å¾©
window.sb = window.supabase.createClient(URL, KEY, {
    auth: { /* æ˜ç¢ºé…ç½® */ }
});
```

### éŒ¯èª¤ 2ï¼šæ²’æœ‰ storageKey

```javascript
// âŒ éŒ¯èª¤ï¼šå¤šå€‹æ‡‰ç”¨å…±äº«åŒä¸€å€‹ key
auth: {
    storage: window.localStorage
    // æ²’æœ‰ storageKey
}

// âœ… ä¿®å¾©ï¼šæ¯å€‹æ‡‰ç”¨ä½¿ç”¨å°ˆå±¬ key
auth: {
    storage: window.localStorage,
    storageKey: 'sb-shicizuju'  // æ‡‰ç”¨å°ˆå±¬
}
```

### éŒ¯èª¤ 3ï¼šèªè­‰ API æ²’æœ‰è¶…æ™‚ä¿è­·

```javascript
// âŒ éŒ¯èª¤ï¼šå¯èƒ½ç„¡é™æ›èµ·
const { data: { user } } = await sb.auth.getUser();

// âœ… ä¿®å¾©ï¼šåŠ è¶…æ™‚ä¿è­·
const { data: { user } } = await withTimeout(
    sb.auth.getUser(), 
    4000, 
    'getUser'
);
```

### éŒ¯èª¤ 4ï¼šæ²’æœ‰æ¸…ç†æå£çš„ session

```javascript
// âŒ éŒ¯èª¤ï¼šç›´æ¥èª¿ç”¨èªè­‰ API
async function login() {
    const { data } = await sb.auth.signInAnonymously();
    // ...
}

// âœ… ä¿®å¾©ï¼šå…ˆæ¸…ç†ï¼Œå†èªè­‰
async function login() {
    sanitizeSupabaseSessionStorage();  // æ¸…ç†æå£æ•¸æ“š
    const { data } = await sb.auth.signInAnonymously();
    // ...
}
```

---

## ğŸ” è¨ºæ–·èˆ‡èª¿è©¦

### æª¢æŸ¥ localStorage ä¸­çš„ session

åœ¨ç€è¦½å™¨æ§åˆ¶å°åŸ·è¡Œï¼š

```javascript
// æŸ¥çœ‹æ‰€æœ‰ Supabase ç›¸é—œçš„ storage keys
Object.keys(localStorage).filter(k => k.includes('sb-') || k.includes('auth-token'))

// æŸ¥çœ‹ç•¶å‰æ‡‰ç”¨çš„ session æ•¸æ“š
localStorage.getItem('sb-yourapp-auth-token')

// æ¸…é™¤ç•¶å‰æ‡‰ç”¨çš„ session
localStorage.removeItem('sb-yourapp-auth-token')
```

### å¸¸è¦‹å•é¡Œæ’æŸ¥

| ç¾è±¡ | å¯èƒ½åŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|------|----------|----------|
| èªè­‰å¡åœ¨ã€Œèªè­‰ä¸­ã€ | localStorage è¨ªå•å—é™æˆ–æœ‰æå£æ•¸æ“š | 1. æ·»åŠ  auth é…ç½®<br>2. åŠ  storageKey<br>3. åŠ è¶…æ™‚ä¿è­· |
| éš±èº«æ¨¡å¼æ­£å¸¸ï¼Œæ™®é€šæ¨¡å¼å¡ä½ | èˆŠ session æ•¸æ“šæå£ | 1. æ¸…ç† localStorage<br>2. åŠ æ¸…ç†å‡½æ•¸ |
| GitHub Pages å¡ä½ï¼ŒCloudflare æ­£å¸¸ | ç’°å¢ƒé»˜èªè¡Œç‚ºä¸ä¸€è‡´ | æ˜ç¢ºé…ç½®æ‰€æœ‰ auth é¸é … |
| å¤šå€‹æ‡‰ç”¨äº’ç›¸å¹²æ“¾ | å…±äº«åŒä¸€å€‹ storageKey | æ¯å€‹æ‡‰ç”¨ä½¿ç”¨å°ˆå±¬ storageKey |

---

## ğŸ“š åƒè€ƒå¯¦ç¾

### å¤ªè™›å¹»å¢ƒå¹³å°ç´šèªè­‰

**æ–‡ä»¶**ï¼š`/assets/js/cc-auth.js`ï¼ˆå…¨ç«™èªè­‰ï¼Œé ç•™çµ¦æœªä¾† Google ç™»å…¥ï¼‰

```javascript
window.sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
    },
    realtime: { params: { eventsPerSecond: 10 } }
});
```

### è©éŠè¨˜ï¼ˆstory-vocabï¼‰

**æ–‡ä»¶**ï¼š`/story-vocab/js/supabase-client.js`

```javascript
const options = {
    auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true,
        storage: window.localStorage
    }
};

supabaseClient = createClient(
    SUPABASE_CONFIG.url,
    SUPABASE_CONFIG.anonKey,
    options
);
```

### è©©è©çµ„å¥ï¼ˆshicizujuï¼‰

**æ–‡ä»¶**ï¼š`/shicizuju.html`

```javascript
window.sb = window.supabase.createClient(
    window.SUPABASE_URL, 
    window.SUPABASE_ANON_KEY,
    {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storage: window.localStorage,
            storageKey: 'sb-shicizuju'  // æ‡‰ç”¨å°ˆå±¬ key
        }
    }
);
```

---

## ğŸ“ é–‹ç™¼æª¢æŸ¥æ¸…å–®

æ–°æ‡‰ç”¨ä½¿ç”¨ Supabase æ™‚ï¼Œç¢ºä¿ï¼š

- [ ] æ˜ç¢ºé…ç½®æ‰€æœ‰ `auth` é¸é …ï¼ˆä¸ä¾è³´é»˜èªå€¼ï¼‰
- [ ] è¨­ç½®å°ˆå±¬çš„ `storageKey`ï¼ˆæ ¼å¼ï¼š`sb-æ‡‰ç”¨åç¨±`ï¼‰
- [ ] ç‚ºèªè­‰ API æ·»åŠ è¶…æ™‚ä¿è­·ï¼ˆ4-8 ç§’ï¼‰
- [ ] å¯¦ç¾ session æ¸…ç†å‡½æ•¸ï¼ˆç§»é™¤æå£æ•¸æ“šï¼‰
- [ ] åœ¨èªè­‰æµç¨‹ä¸­æ·»åŠ é‡è©¦é‚è¼¯
- [ ] åœ¨ä¸åŒç’°å¢ƒä¸‹æ¸¬è©¦ï¼ˆGitHub Pagesã€Cloudflare Pagesã€éš±èº«æ¨¡å¼ï¼‰
- [ ] æ·»åŠ è©³ç´°çš„æ—¥èªŒè¼¸å‡ºï¼ˆä¾¿æ–¼æ’æŸ¥å•é¡Œï¼‰

---

## ğŸ¯ ç¸½çµ

### æ ¸å¿ƒæ•™è¨“

1. **æ˜ç¢ºé…ç½®å„ªæ–¼é»˜èªè¡Œç‚º**ï¼šä¸åŒè¨—ç®¡ç’°å¢ƒçš„é»˜èªè¡Œç‚ºå¯èƒ½ä¸ä¸€è‡´
2. **storageKey éš”é›¢å¿…é ˆæœ‰**ï¼šé¿å…ä¸åŒæ‡‰ç”¨å…±äº« session æ•¸æ“š
3. **è¶…æ™‚ä¿è­·ä¸å¯å°‘**ï¼šèªè­‰ API åœ¨æŸäº›ç’°å¢ƒä¸‹å¯èƒ½æ›èµ·
4. **æ¸…ç†å‡½æ•¸å¾ˆé‡è¦**ï¼šæå£çš„ session æœƒå°è‡´å¾ŒçºŒèªè­‰å¤±æ•—
5. **å¤šç’°å¢ƒæ¸¬è©¦å¿…éœ€**ï¼šå•é¡Œå¯èƒ½åªåœ¨ç‰¹å®šç’°å¢ƒä¸‹å‡ºç¾

### é©ç”¨ç¯„åœ

æœ¬è¦ç¯„é©ç”¨æ–¼å¤ªè™›å¹»å¢ƒå¹³å°ä¸Šæ‰€æœ‰ä½¿ç”¨ Supabase çš„æ‡‰ç”¨ï¼ŒåŒ…æ‹¬ï¼š
- å–®é æ‡‰ç”¨ï¼ˆHTML + JavaScriptï¼‰
- ES æ¨¡çµ„æ‡‰ç”¨ï¼ˆå¦‚ story-vocabï¼‰
- éœ€è¦åŒ¿åèªè­‰çš„éŠæˆ²ï¼ˆå¦‚è©©è©çµ„å¥é ç¨‹å°æˆ°ï¼‰
- éœ€è¦ç”¨æˆ¶è³¬è™Ÿçš„æ‡‰ç”¨ï¼ˆå¦‚è©éŠè¨˜ï¼‰

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-10-15  
**ç¶“é©—ä¾†æº**ï¼šè©©è©çµ„å¥é ç¨‹å°æˆ°èªè­‰å•é¡Œä¿®å¾©
