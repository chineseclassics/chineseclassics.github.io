---
description: Supabase æ¶æ§‹ç®¡ç† - å­é …ç›®ç¨ç«‹éƒ¨ç½²åŸå‰‡ï¼ˆè‡ªå‹•é™„åŠ ï¼‰
globs:
  - "**/supabase/**"
  - "**/*[Ss]upabase*.md"
  - "**/*[Dd]eploy*.md"
alwaysApply: false
---

# Supabase æ¶æ§‹ç®¡ç†

> ç¶“é©—æ•™è¨“ï¼š
> - è¦å‰‡ç½®æ–¼å­é …ç›®æ™‚ï¼Œglobs æ‡‰ç›¸å°æ–¼å­é …ç›®æ ¹ç›®éŒ„ï¼ˆä¸åŠ å­é …ç›®å‰ç¶´ï¼‰
> - globs å¤§å°å¯«æ•æ„Ÿï¼Œå»ºè­°ä½¿ç”¨ `[Dd]eploy` é€™é¡å­—å…ƒé¡åˆ¥
> - æ‰‹å‹•è¦å‰‡ç„¡éœ€ globsï¼›è‡ªå‹•è¦å‰‡ globs å¿…é ˆèƒ½åŒ¹é…åˆ°å¯¦éš›æª”æ¡ˆ

## æ ¸å¿ƒåŸå‰‡
- âœ… æ¯å€‹å­é …ç›®æ“æœ‰ç¨ç«‹çš„ `supabase/` ç›®éŒ„å’Œ `config.toml`
- âœ… åœ¨å­é …ç›®ç›®éŒ„å…§ç›´æ¥éƒ¨ç½²ï¼Œä½¿ç”¨ç›¸å°è·¯å¾‘
- âœ… æ ¹ç›®éŒ„ `/supabase/` åƒ…ä½œç‚ºå¹³å°ç´šé ç•™ä½ç½®
- âŒ **çµ•ä¸**å°‡å­é …ç›®çš„ Supabase è³‡æºè¤‡è£½åˆ°æ ¹ç›®éŒ„
- âŒ **çµ•ä¸**åœ¨æ ¹ç›®éŒ„éƒ¨ç½²å­é …ç›®çš„ Edge Functions

## æ­£ç¢ºéƒ¨ç½²æµç¨‹

### âœ… æ­£ç¢ºåšæ³•
```bash
cd story-vocab
supabase link --project-ref [project-id]
supabase functions deploy [function-name]
```

### âŒ éŒ¯èª¤åšæ³•
```bash
# çµ•ä¸é€™æ¨£åšï¼
cp -r story-vocab/supabase/functions supabase/
cd /
supabase functions deploy
```

## æ¶æ§‹èªªæ˜
æ¯å€‹å­é …ç›®å®Œå…¨ç¨ç«‹ç®¡ç†è‡ªå·±çš„ Supabase è³‡æºï¼š
- `story-vocab/supabase/` - è©æ¸¸è¨˜å°ˆå±¬
- æœªä¾†å…¶ä»–æ‡‰ç”¨ä¹Ÿåœ¨å„è‡ªç›®éŒ„å…§ç®¡ç†

æ ¹ç›®éŒ„ `/supabase/` æ˜¯å¹³å°ç´šé ç•™ä½ç½®ï¼Œç”¨æ–¼æœªä¾†å¯èƒ½çš„è·¨æ‡‰ç”¨å…±äº«æœå‹™ã€‚

## æ•¸æ“šåº«é·ç§»è¦ç¯„

### æ ¸å¿ƒåŸå‰‡ï¼šæ‰‹å‹•é·ç§»

**ç‚ºä»€éº¼æ‰‹å‹•é·ç§»ï¼Ÿ**
- Supabase CLI çš„ `supabase db push` æœƒå˜—è©¦é‡æ–°æ‡‰ç”¨æ‰€æœ‰é·ç§»
- æˆ‘å€‘çš„æ•¸æ“šåº«å·²åœ¨ç”Ÿç”¢ç’°å¢ƒï¼Œæœ‰äº›é·ç§»å·²æ‰‹å‹•åŸ·è¡Œ
- CLI ç„¡æ³•è¿½è¹¤æ‰‹å‹•åŸ·è¡Œçš„é·ç§»ç‹€æ…‹
- æ‰‹å‹•é·ç§»æ›´å®‰å…¨ã€æ›´å¯æ§ï¼Œé©åˆéå°ˆæ¥­é–‹ç™¼è€…

### âœ… æ¨™æº–é·ç§»æµç¨‹

1. **å‰µå»ºé·ç§»æ–‡ä»¶**ï¼ˆåœ¨å­é …ç›®çš„ `supabase/migrations/` ç›®éŒ„ï¼‰
2. **æœ¬åœ°ä¿å­˜**ï¼ˆä½œç‚ºç‰ˆæœ¬æ­·å²è¨˜éŒ„ï¼‰
3. **æ‰‹å‹•åŸ·è¡Œ**ï¼ˆåœ¨ Supabase Dashboard SQL Editorï¼‰
4. **ä¸ä½¿ç”¨ CLI push**ï¼ˆé¿å…ç‹€æ…‹ä¸åŒæ­¥å•é¡Œï¼‰

### é·ç§»æ–‡ä»¶è¦ç¯„

#### ğŸ“ æ–‡ä»¶å¤¾çµæ§‹
```
story-vocab/
â””â”€â”€ supabase/
    â”œâ”€â”€ config.toml
    â”œâ”€â”€ functions/
    â””â”€â”€ migrations/          âœ… å”¯ä¸€çš„é·ç§»æ–‡ä»¶å¤¾
        â”œâ”€â”€ 001_initial_schema.sql
        â”œâ”€â”€ 002_enable_rls_policies.sql
        â””â”€â”€ 009_fix_rls_for_multi_identity.sql
```

#### âŒ ç¦æ­¢çš„æ–‡ä»¶å¤¾
- `manual-migrations/` - å¤šé¤˜ï¼Œæ‰€æœ‰é·ç§»éƒ½æ‡‰åœ¨ `migrations/`
- `db/` - ä¸ç¬¦åˆ Supabase æ¨™æº–
- `sql/` - ä¸ç¬¦åˆ Supabase æ¨™æº–

**åŸå› **ï¼š
- Supabase CLI åªè­˜åˆ¥ `migrations/` æ–‡ä»¶å¤¾
- çµ±ä¸€çµæ§‹ï¼Œé¿å…æ··æ·†
- ä¾¿æ–¼ç‰ˆæœ¬ç®¡ç†å’Œè¿½è¹¤

#### ğŸ“ æ–‡ä»¶å‘½åè¦ç¯„

**æ ¼å¼**ï¼š`{åºè™Ÿ}_{æè¿°æ€§åç¨±}.sql`

**å¥½çš„å‘½å**ï¼š
```
001_initial_schema.sql           âœ… æ¸…æ™°çš„åˆå§‹åŒ–
002_enable_rls_policies.sql      âœ… æè¿°å…·é«”æ“ä½œ
009_fix_rls_for_multi_identity.sql âœ… èªªæ˜ä¿®å¾©çš„å•é¡Œ
20251011_multi_identity_system.sql âœ… æ—¥æœŸå‰ç¶´ï¼ˆé‡å¤§æ›´æ–°ï¼‰
```

**ä¸å¥½çš„å‘½å**ï¼š
```
migration.sql                    âŒ æ²’æœ‰åºè™Ÿå’Œæè¿°
fix.sql                         âŒ æè¿°ä¸æ¸…æ¥š
update_db.sql                   âŒ å¤ªç± çµ±
manual_fix.sql                  âŒ ä¸æ‡‰æœ‰ "manual" å‰ç¶´
```

**å‘½åè¦å‰‡**ï¼š
1. **åºè™Ÿ**ï¼šä¸‰ä½æ•¸å­—ï¼ˆ001, 002, ...ï¼‰æˆ–æ—¥æœŸï¼ˆ20251011ï¼‰
2. **ä¸‹åŠƒç·šåˆ†éš”**ï¼šä½¿ç”¨ `_` è€Œé `-` æˆ–ç©ºæ ¼
3. **å°å¯«è‹±æ–‡**ï¼šé¿å…ä¸­æ–‡å’Œå¤§å¯«
4. **å‹•è©é–‹é ­**ï¼šdescribe what it doesï¼ˆcreate, add, fix, remove, enableï¼‰
5. **å…·é«”æè¿°**ï¼šè®“äººçœ‹åå­—å°±çŸ¥é“é·ç§»åšä»€éº¼

### ğŸ”„ æ‰‹å‹•é·ç§»æ­¥é©Ÿ

#### æ­¥é©Ÿ 1ï¼šå‰µå»ºé·ç§»æ–‡ä»¶
```bash
# åœ¨å­é …ç›®çš„ migrations/ ç›®éŒ„å‰µå»º
# ä¾‹å¦‚ï¼šstory-vocab/supabase/migrations/010_add_user_preferences.sql
```

#### æ­¥é©Ÿ 2ï¼šç·¨å¯« SQL
```sql
-- =====================================================
-- ç°¡è¦èªªæ˜é·ç§»ç›®çš„
-- å‰µå»ºæ—¥æœŸï¼šYYYY-MM-DD
-- =====================================================

BEGIN;

-- SQL èªå¥...

COMMIT;

-- =====================================================
-- é·ç§»å®Œæˆèªªæ˜
-- =====================================================
```

#### æ­¥é©Ÿ 3ï¼šåœ¨ Supabase Dashboard åŸ·è¡Œ
1. æ‰“é–‹ https://supabase.com/dashboard/project/{project-ref}
2. é€²å…¥ SQL Editor
3. è¤‡è£½ SQL å…§å®¹
4. é»æ“Š "Run" åŸ·è¡Œ
5. ç¢ºèªç„¡éŒ¯èª¤

#### æ­¥é©Ÿ 4ï¼šæäº¤åˆ° Git
```bash
git add story-vocab/supabase/migrations/010_add_user_preferences.sql
git commit -m "feat(db): æ·»åŠ ç”¨æˆ¶åå¥½è¨­ç½®è¡¨"
```

### âš ï¸ é‡è¦æ³¨æ„äº‹é …

1. **å†ªç­‰æ€§**ï¼šé·ç§»æ‡‰è©²å¯ä»¥é‡è¤‡åŸ·è¡Œè€Œä¸å‡ºéŒ¯
   ```sql
   -- âœ… å¥½çš„å¯«æ³•
   ALTER TABLE users ADD COLUMN IF NOT EXISTS email TEXT;
   DROP POLICY IF EXISTS "old_policy" ON users;
   
   -- âŒ å£çš„å¯«æ³•
   ALTER TABLE users ADD COLUMN email TEXT;  -- é‡è¤‡åŸ·è¡Œæœƒå ±éŒ¯
   ```

2. **ä½¿ç”¨äº‹å‹™**ï¼šç”¨ `BEGIN` å’Œ `COMMIT` åŒ…è£¹
   - å¤±æ•—æ™‚è‡ªå‹•å›æ»¾
   - ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§

3. **æ·»åŠ è¨»é‡‹**ï¼šèªªæ˜é·ç§»ç›®çš„ã€æ—¥æœŸã€æ³¨æ„äº‹é …

4. **æ¸¬è©¦é †åº**ï¼š
   - å…ˆåœ¨æœ¬åœ°æ¸¬è©¦ï¼ˆå¦‚æœ‰ local Supabaseï¼‰
   - å†åœ¨ Dashboard åŸ·è¡Œ
   - æœ€å¾Œæäº¤åˆ° Git

### ğŸ“‹ é·ç§»æª¢æŸ¥æ¸…å–®

å‰µå»ºæ–°é·ç§»æ™‚ï¼Œç¢ºä¿ï¼š
- [ ] æ–‡ä»¶åœ¨ `supabase/migrations/` ç›®éŒ„
- [ ] æ–‡ä»¶åç¬¦åˆå‘½åè¦ç¯„ï¼ˆåºè™Ÿ_æè¿°.sqlï¼‰
- [ ] ä½¿ç”¨ `BEGIN` / `COMMIT` äº‹å‹™
- [ ] SQL å…·æœ‰å†ªç­‰æ€§ï¼ˆIF EXISTS / IF NOT EXISTSï¼‰
- [ ] æ·»åŠ äº†è¨»é‡‹èªªæ˜
- [ ] åœ¨ Dashboard æ‰‹å‹•åŸ·è¡ŒæˆåŠŸ
- [ ] æäº¤åˆ° Git ä½œç‚ºç‰ˆæœ¬è¨˜éŒ„

### ğŸš« é¿å…ä½¿ç”¨ CLI Push

**ä¸è¦ä½¿ç”¨**ï¼š
```bash
supabase db push              # âŒ æœƒå˜—è©¦é‡æ–°æ‡‰ç”¨æ‰€æœ‰é·ç§»
supabase migration up         # âŒ åŒæ¨£çš„å•é¡Œ
```

**åŸå› **ï¼š
- æˆ‘å€‘æ²’æœ‰ä½¿ç”¨ CLI åˆå§‹åŒ–æ•¸æ“šåº«
- å·²æœ‰é·ç§»æ˜¯æ‰‹å‹•åŸ·è¡Œçš„
- CLI ä¸çŸ¥é“å“ªäº›é·ç§»å·²ç¶“æ‡‰ç”¨
- æœƒå°è‡´éŒ¯èª¤å’Œç‹€æ…‹ä¸ä¸€è‡´

**ä¾‹å¤–**ï¼šå¦‚æœæœªä¾†å¾é›¶é–‹å§‹æ–°é …ç›®ï¼Œå¯ä»¥è€ƒæ…®å®Œå…¨ä½¿ç”¨ CLI å·¥ä½œæµ
