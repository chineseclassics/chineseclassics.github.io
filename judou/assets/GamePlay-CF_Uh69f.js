import{d as Te,m as l,A as ye,r as T,w as ke,o as be,R as Be,c,a as n,F as P,s as Ae,f as g,n as b,t as p,p as q,k as we,l as o,_ as xe}from"./index-CvCMB_4W.js";import{u as Ce}from"./gameStore-DisV2Kea.js";import{b as Pe}from"./game-C73ZBjL5.js";import{R as Se}from"./RaceTrack-DYuisJs7.js";import"./userStatsStore-DNxnv8la.js";import"./TeamBadge-CIFGEPeN.js";const Me={class:"game-play"},ze={key:0,class:"loading-container"},Ie={class:"play-header"},Re={class:"header-left"},Ve={class:"countdown-time"},Ee={class:"header-right"},Ge={class:"scoreboard"},De={class:"score-chip"},Fe={class:"chip-value"},$e={key:0,class:"score-chip team"},qe={class:"chip-value"},Le={key:1,class:"text-tabs"},Ue=["onClick"],Ne={class:"tab-number"},Oe={class:"tab-title"},Ye={key:0,class:"tab-check"},je={class:"play-main"},He={class:"board-header"},Je={class:"board-header-right"},Ke={class:"practice-board"},Qe={key:0,class:"practice-line"},We={class:"char"},Xe=["onClick","aria-label"],Ze={key:0,class:"bean"},et={class:"progress-hint"},tt={key:0,class:"text-nav"},at=["disabled"],st={class:"nav-info"},nt=["disabled"],rt=80,lt=Te({__name:"GamePlay",setup(ot){const Z=we(),ee=ye(),_=Ce(),S=l(()=>ee.params.roomId),i=l(()=>_.currentRoom),y=l(()=>_.myParticipant),L=l(()=>i.value?.participants||[]),M=l(()=>i.value?.teams||[]),U=l(()=>!M.value.length||!y.value?.team_id?null:M.value.find(a=>a.id===y.value.team_id)||null),te=l(()=>F()),N=l(()=>te.value.totalCorrect),B=l(()=>{const a=new Map;M.value.forEach(t=>{a.set(t.id,{id:t.id,name:t.team_name,team:t,authAvg:typeof t.total_score=="number"?t.total_score/100:0,localAvg:0})});const e=new Map;return L.value.forEach(t=>{if(!t.team_id)return;e.has(t.team_id)||e.set(t.team_id,{total:0,count:0});const s=e.get(t.team_id),r=t.user_id===y.value?.user_id?Math.max(N.value,t.score||0):t.score||0;s.total+=r,s.count+=1}),a.forEach((t,s)=>{const r=e.get(s),u=r&&r.count>0?r.total/r.count:0;t.localAvg=u}),Array.from(a.values()).map(t=>{const s=L.value.filter(u=>u.team_id===t.id),r=s.filter(u=>u.status==="completed");return{...t,displayAvg:t.authAvg||t.localAvg||0,memberCount:s.length,completedCount:r.length}})}),O=l(()=>{const a=U.value;if(!a)return null;const e=B.value.find(t=>t.id===a.id);return e?e.displayAvg:null}),ae=l(()=>[...B.value].sort((a,e)=>e.displayAvg-a.displayAvg)),Y=l(()=>B.value.length?B.value.map(a=>{const e=Pe(a.team),t=ae.value.findIndex(s=>s.id===a.id)+1;return{id:a.id,team:a.team,displayAvg:a.displayAvg,rank:t,productType:e,isMyTeam:a.id===U.value?.id,name:a.team.team_name,memberCount:a.memberCount,completedCount:a.completedCount}}):[]),d=T([]),m=T(new Map),v=T(0),f=l(()=>d.value[v.value]),k=l(()=>f.value&&m.value.get(f.value.id)||null),z=l(()=>k.value?.characters||[]),j=l(()=>k.value?.correctBreaks||new Set),A=l({get:()=>k.value?.userBreaks||new Map,set:a=>{if(f.value&&m.value.has(f.value.id)){const e=m.value.get(f.value.id);e.userBreaks=a}}}),w=T(0);let I=null;const H=l(()=>j.value.size),se=l(()=>A.value.size),J=l(()=>Math.max(0,H.value-se.value)),ne=l(()=>J.value>0),R=T(!1),K=T(null);let h=null,x=!1,V=!1;const Q=T(!0);function re(a){const e=[],t=new Set;let s=0;const r=a.replace(/[\|\s]+$/,"");for(const u of r)u==="|"?s>0&&t.add(s-1):u!==`
`&&u!=="\r"&&(e.push(u),s++);return{chars:e,breaks:t}}function le(){m.value.clear();for(const a of d.value){const e=re(a.content);m.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Map})}}function oe(a){a>=0&&a<d.value.length&&(v.value=a)}function ce(){v.value>0&&v.value--}function ie(){v.value<d.value.length-1&&v.value++}let E=null;function G(a){try{E||(E=new AudioContext);const e=E,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function D(a=10){navigator.vibrate&&navigator.vibrate(a)}function ue(a){if(!f.value)return;const e=m.value.get(f.value.id);if(!e||e.userBreaks.has(a))return;if(e.userBreaks.size>=e.correctBreaks.size){G("error"),R.value=!0,setTimeout(()=>{R.value=!1},300),D(50);return}const t={index:a,isCorrect:e.correctBreaks.has(a),placedAt:Date.now()},s=new Map(e.userBreaks);s.set(a,t),e.userBreaks=s,m.value=new Map(m.value),K.value=t.placedAt,t.isCorrect?(G("add"),D(10)):(G("error"),D(50)),X();const r=F();he(r.totalCorrect),r.usedBeansAll>=r.totalBeansAll&&X(!0)}function de(a){const e=A.value.get(a);return{"has-bean":!!e,correct:e?.isCorrect,extra:e&&!e.isCorrect}}function W(a){let e=0,t=0;return a.userBreaks.forEach(s=>{s.isCorrect?e++:t++}),{correct:e,wrong:t}}function F(){let a=0,e=0,t=0;return m.value.forEach(s=>{const r=W(s);a+=r.correct,e+=s.correctBreaks.size,t+=s.userBreaks.size}),{totalCorrect:a,totalBeansAll:e,usedBeansAll:t}}function ve(a=!1){if(!f.value||!k.value)return null;const{correct:e,wrong:t}=W(k.value),{totalCorrect:s,totalBeansAll:r,usedBeansAll:u}=F(),ge=K.value||Date.now(),_e=a||u>=r;return{roomId:S.value,textId:f.value.id,textIndex:v.value,correctCount:e,wrongCount:t,totalCorrect:s,totalBeans:r,usedBeans:u,lastInteraction:ge,isFinished:_e}}async function $(a=!1){h&&(clearTimeout(h),h=null);const e=ve(a);if(e&&!V){V=!0;try{await _.updateProgress(e)}catch(t){console.error("[GamePlay] 更新進度失敗",t)}finally{V=!1}}}function X(a=!1){a&&(x=!0),h&&clearTimeout(h),h=setTimeout(()=>{$(x),x=!1},rt)}async function me(a=!1){await $(a);try{await _.endGame()}catch(e){console.error("[GamePlay] 結束遊戲失敗",e)}}function C(a){const e=m.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(r=>e.userBreaks.has(r))?"complete":"partial"}function pe(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function fe(){if(!i.value?.started_at||!i.value?.time_limit)return;const a=()=>{const e=new Date(i.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);w.value=Math.max(0,i.value.time_limit-t),w.value===0&&me(!0)};a(),I=setInterval(a,1e3)}ke(()=>i.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),Z.push({name:"arena-result",params:{roomId:S.value}}))}),be(async()=>{_.subscribeToRoom(S.value),i.value?.text_ids&&i.value.text_ids.length>0?d.value=await _.fetchTexts(i.value.text_ids):i.value?.text_id&&(d.value=await _.fetchTexts([i.value.text_id])),Q.value=!1,d.value.length>0&&(le(),fe())}),Be(()=>{I&&clearInterval(I),h&&clearTimeout(h),$(x)});function he(a){if(y.value&&(y.value.score=a),i.value?.participants){const e=i.value.participants.map(t=>t.user_id===y.value?.user_id?{...t,score:a}:t);i.value.participants=e}}return(a,e)=>(o(),c("div",Me,[Q.value?(o(),c("div",ze,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(o(),c(P,{key:1},[Y.value.length>0?(o(),Ae(Se,{key:0,teams:Y.value,height:100,"racer-size":48,"show-rankings":!1,class:"game-race-track"},null,8,["teams"])):g("",!0),n("header",Ie,[n("div",Re,[n("div",{class:b(["countdown",{warning:w.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",Ve,p(pe(w.value)),1)],2)]),n("div",Ee,[n("div",Ge,[n("div",De,[e[2]||(e[2]=n("span",{class:"chip-label"},"個人分數",-1)),n("span",Fe,p(N.value),1)]),O.value!==null?(o(),c("div",$e,[e[3]||(e[3]=n("span",{class:"chip-label"},"團隊平均",-1)),n("span",qe,p(O.value?.toFixed(2)),1)])):g("",!0)])])]),d.value.length>1?(o(),c("div",Le,[(o(!0),c(P,null,q(d.value,(t,s)=>(o(),c("button",{key:t.id,class:b(["text-tab",{active:s===v.value,empty:C(t.id)==="empty",partial:C(t.id)==="partial",complete:C(t.id)==="complete"}]),onClick:r=>oe(s)},[n("span",Ne,p(s+1),1),n("span",Oe,p(t.title),1),C(t.id)==="complete"?(o(),c("span",Ye,"✓")):g("",!0)],10,Ue))),128))])):g("",!0),n("main",je,[n("div",He,[e[4]||(e[4]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",Je,[n("div",{class:b(["bean-inventory",{shake:R.value,empty:!ne.value}])},[(o(!0),c(P,null,q(H.value,t=>(o(),c("span",{key:t,class:b(["inventory-bean",{used:t>J.value}])},null,2))),128))],2)])]),n("div",Ke,[z.value.length?(o(),c("div",Qe,[(o(!0),c(P,null,q(z.value,(t,s)=>(o(),c("span",{key:s,class:"char-unit"},[n("span",We,p(t),1),s<z.value.length-1?(o(),c("button",{key:0,class:b(["bean-slot",de(s)]),onClick:r=>ue(s),"aria-label":`在「${t}」後放置斷句`},[A.value.has(s)?(o(),c("span",Ze)):g("",!0),e[5]||(e[5]=n("span",{class:"bean-hint"},null,-1))],10,Xe)):g("",!0)]))),128))])):g("",!0)]),n("div",et,[n("span",null,"已標記 "+p(A.value.size)+" / "+p(j.value.size)+" 處",1)]),d.value.length>1?(o(),c("div",tt,[n("button",{class:"nav-btn",disabled:v.value===0,onClick:ce}," ← 上一篇 ",8,at),n("span",st,p(v.value+1)+" / "+p(d.value.length),1),n("button",{class:"nav-btn",disabled:v.value===d.value.length-1,onClick:ie}," 下一篇 → ",8,nt)])):g("",!0)]),e[6]||(e[6]=n("footer",{class:"play-footer"},[n("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),pt=xe(lt,[["__scopeId","data-v-a21c9b3e"]]);export{pt as default};
