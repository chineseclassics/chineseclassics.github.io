import{d as K,c,x as O,r as F,w as A,f as Q,R as W,a as i,g as e,h as d,t as o,b as f,e as N,n as X,F as S,j as B,m as M,i as b,l as Y,o as n,_ as Z}from"./index-D5Dj3qah.js";import{u as P}from"./gameStore-BIl8KCwA.js";import{b as u}from"./game-CVoexSXg.js";import{T as x}from"./TeamBadge-CLEA7Jnb.js";import{R as ee}from"./RaceTrack-Cfoq7U2E.js";import{B as te}from"./BeanIcon-DQFz6FsJ.js";import"./userStatsStore-Dilo9XDu.js";const se={class:"board-header"},ae={class:"header-left"},re={class:"text-info"},oe={key:0},ne={class:"header-center"},le={class:"countdown-label"},ie={class:"countdown-time"},ce={class:"header-right"},de={class:"progress-info"},me={class:"progress-value"},ue={key:0,class:"main-content-wrapper"},ve={class:"time-progress-container"},pe={class:"time-progress-header"},_e={class:"time-progress-bar"},he={class:"teams-cards-container"},ge={class:"team-card-header"},fe={class:"team-card-title"},be={class:"team-card-progress"},ye={class:"team-card-score"},ke={class:"score-value"},we={class:"team-card-members"},Ce={class:"member-info"},Te=["src","alt"],Se={key:1,class:"member-avatar-placeholder"},Be={class:"member-name"},Me={key:0,class:"member-status"},xe={class:"score"},De={key:1,class:"finish-overlay"},Ie={class:"finish-content"},ze={class:"final-ranking"},Re={class:"rank"},$e={class:"team-name"},Ge={class:"team-members"},Fe={class:"team-avg-score"},Ae={key:0,class:"winner-reward-section"},Ne={class:"winner-reward-header"},Ve={class:"winner-reward-title"},Ee={class:"winner-reward-amount"},je={class:"winner-reward-note"},Le=K({__name:"GameBoard",setup(Ue){const V=Y(),E=O(),y=P(),j=c(()=>E.params.roomId),l=c(()=>y.currentRoom),D=c(()=>l.value?.teams||[]),v=c(()=>l.value?.participants||[]),p=F(0);let m=null;const _=c(()=>l.value?.status==="finished"),T=c(()=>D.value.map(a=>{const t=v.value.filter(w=>w.team_id===a.id),s=t.filter(w=>w.status==="completed"),r=t.reduce((w,J)=>w+(J.score||0),0),g=t.length>0?r/t.length:0;return{team:a,memberCount:t.length,completedCount:s.length,averageScore:g}})),C=c(()=>[...T.value].sort((a,t)=>t.averageScore-a.averageScore)),h=c(()=>C.value[0]||null),L=c(()=>h.value?v.value.filter(a=>a.team_id===h.value.team.id):[]),U=c(()=>{const a={};for(const t of D.value)a[t.id]=v.value.filter(s=>s.team_id===t.id).sort((s,r)=>r.score-s.score);return a}),q=c(()=>v.value.filter(a=>a.status==="completed").length),I=c(()=>T.value.length?T.value.map(a=>{const t=u(a.team),s=C.value.findIndex(r=>r.team.id===a.team.id)+1;return{id:a.team.id,team:a.team,displayAvg:a.averageScore,rank:s,productType:t,isMyTeam:!1,name:a.team.team_name,memberCount:a.memberCount,completedCount:a.completedCount}}):[]),z=c(()=>{if(!l.value?.started_at||!l.value?.time_limit)return 0;const a=new Date(l.value.started_at).getTime(),t=Math.floor((Date.now()-a)/1e3);return Math.min(t/l.value.time_limit,1)*100}),k=F([]);A(()=>v.value,(a,t)=>{!t||t.length===0||(a.forEach(s=>{const r=t.find(g=>g.id===s.id);r&&(s.status==="completed"&&r.status!=="completed"?k.value.unshift({id:`${s.id}-${Date.now()}`,participant:s,action:"completed",score:s.score,timestamp:Date.now()}):s.score!==r.score&&s.score>r.score&&k.value.unshift({id:`${s.id}-${Date.now()}`,participant:s,action:"scored",score:s.score,timestamp:Date.now()}))}),k.value.length>10&&(k.value=k.value.slice(0,10)))},{deep:!0});function R(a){const t=Math.floor(a/60),s=a%60;return`${t}:${s.toString().padStart(2,"0")}`}function $(){if(!l.value?.started_at||!l.value?.time_limit)return;const a=()=>{const t=new Date(l.value.started_at).getTime(),s=Math.floor((Date.now()-t)/1e3);p.value=Math.max(0,l.value.time_limit-s),p.value===0&&(m&&(clearInterval(m),m=null),_.value||y.endGame())};a(),m=setInterval(a,1e3)}async function H(){confirm("ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ")&&await y.endGame()}function G(){y.reset(),V.push({name:"arena"})}return A(()=>l.value?.status,a=>{a==="playing"&&!m&&$()}),Q(()=>{y.subscribeToRoom(j.value),l.value?.status==="playing"&&$()}),W(()=>{m&&clearInterval(m)}),(a,t)=>(n(),i("div",{class:f(["game-board",{finished:_.value}])},[e("header",se,[e("div",ae,[e("button",{class:"back-btn",onClick:G}," â† é›¢é–‹ "),e("div",re,[e("h1",null,o(l.value?.text?.title),1),l.value?.text?.author?(n(),i("p",oe,o(l.value?.text?.author),1)):d("",!0)])]),e("div",ne,[e("div",{class:f(["countdown",{warning:p.value<30}])},[e("span",le,o(_.value?"æ¯”è³½çµæŸ":"å‰©é¤˜æ™‚é–“"),1),e("span",ie,o(R(p.value)),1)],2)]),e("div",ce,[e("div",de,[t[0]||(t[0]=e("span",{class:"progress-label"},"å®Œæˆé€²åº¦",-1)),e("span",me,o(q.value)+" / "+o(v.value.length),1)]),_.value?d("",!0):(n(),i("button",{key:0,class:"btn-danger",onClick:H}," çµæŸæ¯”è³½ "))])]),!_.value&&I.value.length?(n(),i("div",ue,[N(ee,{teams:I.value,height:150,"racer-size":72,"show-rankings":!1,class:"teacher-race-track"},null,8,["teams"]),e("div",ve,[e("div",pe,[t[1]||(t[1]=e("span",{class:"time-progress-label"},"å‰©é¤˜æ™‚é–“",-1)),e("span",{class:f(["time-progress-text",{warning:p.value<30}])},o(R(p.value)),3)]),e("div",_e,[e("div",{class:f(["time-progress-fill",{warning:z.value>80}]),style:X({width:`${z.value}%`})},null,6)]),t[2]||(t[2]=e("div",{class:"time-progress-footer"},[e("span",{class:"time-progress-start"},"é–‹å§‹"),e("span",{class:"time-progress-end"},"çµæŸ")],-1))]),e("div",he,[(n(!0),i(S,null,B(C.value,s=>(n(),i("div",{key:s.team.id,class:"team-card"},[e("div",ge,[b(u)(s.team)?(n(),M(x,{key:0,"product-type":b(u)(s.team),size:48,class:"team-card-badge"},null,8,["product-type"])):d("",!0),e("div",fe,[e("h3",null,o(s.team.team_name),1),e("span",be,o(s.completedCount)+"/"+o(s.memberCount)+" äºº",1)]),e("div",ye,[e("span",ke,o(s.averageScore.toFixed(1)),1),t[3]||(t[3]=e("span",{class:"score-label"},"å¹³å‡åˆ†",-1))])]),e("div",we,[(n(!0),i(S,null,B(U.value[s.team.id],(r,g)=>(n(),i("div",{key:r.id,class:f(["member-item",{completed:r.status==="completed","top-scorer":g===0&&r.score>0}])},[e("div",Ce,[r.user?.avatar_url?(n(),i("img",{key:0,src:r.user.avatar_url,alt:r.user.display_name,class:"member-avatar"},null,8,Te)):(n(),i("span",Se,o(r.user?.display_name?.charAt(0)||"?"),1)),e("span",Be,o(r.user?.display_name||"æœªçŸ¥"),1)]),g===0&&r.score>0?(n(),i("div",Me,[e("span",xe,o(r.score)+" åˆ†",1)])):d("",!0)],2))),128))])]))),128))])])):d("",!0),_.value?(n(),i("div",De,[e("div",Ie,[t[6]||(t[6]=e("div",{class:"trophy"},"ğŸ†",-1)),t[7]||(t[7]=e("h2",null,"æ¯”è³½çµæŸï¼",-1)),e("div",ze,[(n(!0),i(S,null,B(C.value,(s,r)=>(n(),i("div",{key:s.team.id,class:f(["ranking-item",{winner:r===0}])},[e("span",Re,o(r===0?"ğŸ†":r+1),1),b(u)(s.team)?(n(),M(x,{key:0,"product-type":b(u)(s.team),size:28,class:"team-badge-in-mini-ranking"},null,8,["product-type"])):d("",!0),e("span",$e,o(s.team.team_name),1),e("span",Ge,o(s.completedCount)+"/"+o(s.memberCount)+" äºº",1),e("span",Fe,o(s.averageScore.toFixed(1))+" åˆ†",1)],2))),128))]),h.value?(n(),i("div",Ae,[e("div",Ne,[b(u)(h.value.team)?(n(),M(x,{key:0,"product-type":b(u)(h.value.team),size:40,class:"winner-badge"},null,8,["product-type"])):d("",!0),e("div",Ve,[e("h3",null,o(h.value.team.team_name)+" ç²å‹ï¼",1),t[4]||(t[4]=e("p",{class:"winner-reward-subtitle"},"æ¯ä½æˆå“¡ç²å¾—",-1))])]),e("div",Ee,[t[5]||(t[5]=e("span",{class:"reward-number"},"20",-1)),N(te,{size:48,class:"reward-bean-icon"})]),e("p",je,"å…± "+o(L.value.length)+" ä½æˆå“¡",1)])):d("",!0),t[8]||(t[8]=e("p",{class:"scoring-note"},"* ä»¥éšŠå“¡å¹³å‡åˆ†è¨ˆç®—æ’å",-1)),e("button",{class:"btn-primary btn-large",onClick:G}," è¿”å›é¬¥è±† ")])])):d("",!0)],2))}}),Xe=Z(Le,[["__scopeId","data-v-2c41151b"]]);export{Xe as default};
