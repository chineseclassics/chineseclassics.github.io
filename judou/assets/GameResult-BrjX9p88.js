import{d as ae,u as se,c,x as ne,r as C,w as re,f as le,a as u,g as a,h as v,t as n,b as _,e as E,F as I,j as P,s as T,k as oe,n as U,l as ue,i as A,m as ce,o as l,_ as ie}from"./index-pjl8OMS8.js";import{u as ve}from"./gameStore-CzIlmogn.js";import{u as me}from"./userStatsStore-BnMPE05H.js";import{g as de,c as j,d as J}from"./game-DlkGF0Ko.js";import{B as W}from"./BeanIcon-D1b8CrOp.js";import{T as pe}from"./TeamBadge-DoVgjdeR.js";const _e={class:"result-header"},ge={class:"result-icon"},fe={class:"bean-sign"},he={key:0,class:"bean-note"},ye={key:0,class:"ranking-section"},ke={class:"ranking-list"},be=["src","alt"],we={key:1,class:"avatar-placeholder"},Se={class:"name"},Be={class:"score"},Ce={class:"accuracy"},Te={class:"time"},Ae={key:1,class:"streak-card"},Re={class:"streak-text"},xe={key:2,class:"answers-section"},Me={key:0,class:"result-tabs"},Ie=["onClick"],Pe={class:"tab-number"},ze={class:"tab-title"},Ve={class:"tab-stats"},Fe={key:1,class:"answer-detail"},Ne={class:"answer-header"},De={key:0,class:"answer-author"},$e={class:"answer-stats"},Ge={class:"stat correct"},Le={class:"stat wrong"},Oe={class:"stat missed"},qe={class:"answer-content"},Ee={class:"answer-line"},Ue={class:"answer-char"},je={key:3,class:"ranking-section"},Je={class:"team-ranking-list"},We={class:"rank"},He={class:"team-name-group"},Ke={class:"team-name"},Qe={key:0,class:"team-reward-badge"},Xe={class:"team-score"},Ye={class:"rank-title-section"},Ze={class:"level-text"},et=ae({__name:"GameResult",setup(tt){const z=ue(),H=ne(),h=ve(),R=se(),V=me(),x=c(()=>H.params.roomId),o=c(()=>h.currentRoom),y=c(()=>h.myParticipant),K=c(()=>o.value?.participants||[]),F=c(()=>o.value?.teams||[]),m=C(null),M=C(0),i=c(()=>{if(!m.value)return null;const s=m.value.texts[M.value],e=m.value.results[M.value];return!s||!e?null:{text:s,result:e}});function N(s){const e=[];for(const t of s)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function D(s){if(!i.value?.result)return"none";const e=i.value.result,t=e.userBreaks.includes(s),r=e.correctBreaks.includes(s);return t&&r?"correct":t&&!r?"wrong":!t&&r?"missed":"none"}const p=c(()=>{if(!o.value||!R.user)return!1;if(o.value.game_mode==="team_battle")return y.value?.team_id===o.value.winner_team_id;{if(o.value.winner_user_id)return o.value.winner_user_id===R.user.id;if(!o.value.participants)return!1;const s=y.value?.score??0,e=y.value?.time_spent??999999,t=Math.max(...o.value.participants.map(d=>d.score)),r=o.value.participants.filter(d=>d.score===t),w=Math.min(...r.map(d=>d.time_spent??999999));return s===t&&e===w}}),k=c(()=>!o.value||o.value.game_mode==="team_battle"?!1:!o.value.winner_user_id&&p.value),Q=c(()=>o.value?.participants?[...o.value.participants].sort((s,e)=>e.score-s.score).map((s,e)=>({...s,rank:e+1})):[]),X=c(()=>F.value.length?F.value.map(s=>{const e=K.value.filter(S=>S.team_id===s.id),t=e.reduce((S,B)=>S+(B.score||0),0),r=e.length>0?t/e.length:0,d=(typeof s.total_score=="number"?s.total_score/100:0)||r;return{...s,averageScore:d}}).sort((s,e)=>e.averageScore-s.averageScore):[]),$=c(()=>V.level),G=c(()=>de($.value)),L=c(()=>V.profile?.pvp_win_streak??0),O=C(!1),b=C(0),g=C(!1),f=c(()=>{if(!y.value||!o.value)return{amount:0,type:"neutral"};if(o.value.game_mode==="team_battle")return p.value?{amount:20,type:"win"}:{amount:0,type:"neutral"};const s=y.value.fee_paid||o.value.entry_fee||0,e=o.value.participants?.length||0;return k.value?{amount:0,type:"tie"}:p.value&&s>0?{amount:s*e,type:"win"}:!p.value&&s>0?{amount:-s,type:"lose"}:{amount:0,type:"neutral"}});function Y(){const s=Math.abs(f.value.amount),e=f.value.type;if(s===0&&e!=="tie"){g.value=!0;return}O.value=!0,b.value=0,g.value=!1;const t=2500,r=Date.now(),w=s>0?s:100;function d(){const S=Date.now()-r,B=Math.min(S/t,1);if(B<1){if(B<.8)b.value=Math.floor(Math.random()*w*1.5);else{const q=(B-.8)/.2;b.value=Math.floor(s*q+Math.random()*(s*(1-q)))}requestAnimationFrame(d)}else b.value=s,g.value=!0}setTimeout(()=>{requestAnimationFrame(d)},500)}function Z(s){m.value&&s>=0&&s<m.value.texts.length&&(M.value=s)}function ee(){h.reset(),sessionStorage.removeItem(`game-result-${x.value}`),z.push({name:"arena"})}function te(){h.reset(),sessionStorage.removeItem(`game-result-${x.value}`),R.isTeacher?z.push({name:"arena-teacher-create"}):z.push({name:"arena-create"})}return re(()=>o.value?.status,s=>{}),le(()=>{h.subscribeToRoom(x.value),V.fetchProfile();const s=sessionStorage.getItem(`game-result-${x.value}`);if(s)try{m.value=JSON.parse(s)}catch{}Y()}),(s,e)=>(l(),u("div",{class:_(["game-result",{winner:p.value,tie:k.value}])},[a("header",_e,[a("div",ge,n(k.value?"ğŸ¤":p.value?"ğŸ†":"ğŸ’ª"),1),a("h1",null,n(k.value?"å¹³å±€ï¼":p.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),O.value||f.value.type!=="neutral"?(l(),u("div",{key:0,class:_(["bean-change-display",[f.value.type,{complete:g.value}]])},[a("span",fe,n(f.value.type==="lose"?"-":f.value.type==="win"?"+":""),1),a("span",{class:_(["bean-number",{rolling:!g.value}])},n(b.value),3),E(W,{size:40,class:"bean-icon-img"}),k.value&&g.value?(l(),u("span",he,"å…¥å ´è²»å·²é€€é‚„")):v("",!0)],2)):v("",!0)]),o.value?.game_mode==="pvp"?(l(),u("section",ye,[e[0]||(e[0]=a("h2",null,"æ’è¡Œæ¦œ",-1)),a("div",ke,[(l(!0),u(I,null,P(Q.value,t=>(l(),u("div",{key:t.id,class:_(["ranking-item",{me:t.user_id===A(R).user?.id,top:t.rank<=3}])},[a("span",{class:_(["rank",`rank-${t.rank}`])},n(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(l(),u("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,be)):(l(),u("span",we,n(t.user?.display_name?.charAt(0)||"?"),1)),a("span",Se,n(t.user?.display_name||"æœªçŸ¥"),1),a("span",Be,n(t.score)+" åˆ†",1),a("span",Ce,n(t.accuracy?.toFixed(0)||0)+"%",1),a("span",Te,n(t.time_spent)+"s",1)],2))),128))])])):v("",!0),L.value>0&&p.value?(l(),u("div",Ae,[e[3]||(e[3]=a("span",{class:"streak-icon"},"ğŸ”¥",-1)),a("span",Re,[e[1]||(e[1]=T(" é€£å‹ ",-1)),a("strong",null,n(L.value),1),e[2]||(e[2]=T(" å ´ï¼ ",-1))])])):v("",!0),m.value?(l(),u("section",xe,[e[9]||(e[9]=a("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),m.value.texts.length>1?(l(),u("div",Me,[(l(!0),u(I,null,P(m.value.texts,(t,r)=>(l(),u("button",{key:t.id,class:_(["result-tab",{active:r===M.value}]),onClick:w=>Z(r)},[a("span",Pe,n(r+1),1),a("span",ze,n(t.title),1),a("span",Ve," âœ“"+n(m.value.results[r]?.correctCount||0),1)],10,Ie))),128))])):v("",!0),i.value&&i.value.text&&i.value.result?(l(),u("div",Fe,[a("div",Ne,[a("h3",null,n(i.value.text.title),1),i.value.text.author?(l(),u("span",De,n(i.value.text.author),1)):v("",!0)]),a("div",$e,[a("span",Ge,[e[4]||(e[4]=a("span",{class:"bean-legend correct"},null,-1)),T(" æ­£ç¢º "+n(i.value.result.correctCount),1)]),a("span",Le,[e[5]||(e[5]=a("span",{class:"bean-legend wrong"},null,-1)),T(" éŒ¯èª¤ "+n(i.value.result.wrongCount),1)]),a("span",Oe,[e[6]||(e[6]=a("span",{class:"bean-legend missed"},null,-1)),T(" éºæ¼ "+n(i.value.result.missedCount),1)])]),a("div",qe,[a("div",Ee,[(l(!0),u(I,null,P(N(i.value.text.content),(t,r)=>(l(),u("span",{key:r,class:"char-unit"},[a("span",Ue,n(t),1),r<N(i.value.text.content).length-1&&D(r)!=="none"?(l(),u("span",{key:0,class:_(["bean-slot",D(r)])},[...e[7]||(e[7]=[a("span",{class:"bean"},null,-1)])],2)):v("",!0)]))),128))])]),e[8]||(e[8]=oe('<div class="answer-legend" data-v-eca4c4eb><span class="legend-item" data-v-eca4c4eb><span class="bean-legend correct" data-v-eca4c4eb></span> æ­£ç¢º </span><span class="legend-item" data-v-eca4c4eb><span class="bean-legend wrong" data-v-eca4c4eb></span> éŒ¯èª¤ </span><span class="legend-item" data-v-eca4c4eb><span class="bean-legend missed" data-v-eca4c4eb></span> éºæ¼ </span></div>',1))])):v("",!0)])):v("",!0),o.value?.game_mode==="team_battle"?(l(),u("section",je,[e[11]||(e[11]=a("h2",null,"éšŠä¼æ’è¡Œ",-1)),a("div",Je,[(l(!0),u(I,null,P(X.value,(t,r)=>(l(),u("div",{key:t.id,class:_(["team-ranking-item",{winner:r===0}]),style:U({"--team-primary":A(j)[t.team_color].primary,"--team-secondary":A(j)[t.team_color].secondary})},[a("span",We,n(r===0?"ğŸ†":r+1),1),A(J)(t)?(l(),ce(pe,{key:0,"product-type":A(J)(t),size:36,class:"team-badge-in-ranking"},null,8,["product-type"])):v("",!0),a("div",He,[a("span",Ke,n(t.team_name),1),r===0?(l(),u("div",Qe,[E(W,{size:16}),e[10]||(e[10]=a("span",null,"æ¯ä½æˆå“¡ +20 è±†",-1))])):v("",!0)]),a("span",Xe,n(t.averageScore.toFixed(2))+" åˆ†",1)],6))),128))])])):v("",!0),a("section",Ye,[e[12]||(e[12]=a("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),a("div",{class:"rank-title-display",style:U({color:G.value.color})},n(G.value.title),5),a("p",Ze,"Lv."+n($.value),1)]),a("footer",{class:"result-footer"},[a("button",{class:"btn-secondary",onClick:ee}," è¿”å›é¬¥è±† "),a("button",{class:"btn-primary",onClick:te}," å†ä¾†ä¸€å±€ ")])],2))}}),ut=ie(et,[["__scopeId","data-v-eca4c4eb"]]);export{ut as default};
