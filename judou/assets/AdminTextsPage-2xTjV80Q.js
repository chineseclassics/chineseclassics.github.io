import{d as re,u as ce,c as g,p as ve,r as y,D as Y,o as me,a as n,b as t,k as H,t as o,f as B,g as j,F as w,i as U,e as _,s as q,l as R,T as J,E as K,n as A,G as h,q as a,z as $,A as T,_ as pe}from"./index-BPfsx8-Q.js";import{u as fe,a as be}from"./practiceLibraryStore-Cl3MrciF.js";import"./useSupabase-DUIPnp6W.js";const ye={class:"admin-shell"},_e={class:"admin-header"},he={class:"edamame-text-level-detail"},ge={class:"edamame-heading-gradient"},ke={class:"header-actions"},Ce=["disabled"],xe=["disabled"],we={class:"admin-layout"},$e={class:"category-sidebar edamame-glass"},Te={class:"sidebar-header"},Se={key:0,class:"sidebar-loading"},Me={key:1,class:"sidebar-empty"},Ve={key:2,class:"category-tree"},Le=["onClick"],De=["onClick"],Fe={class:"tree-label"},Be={class:"tree-count"},Ue={class:"tree-actions"},Ae=["onClick"],Ee=["onClick"],Ge=["onClick"],Ie={key:0,class:"tree-children"},Ne=["onClick"],Oe={class:"tree-label"},ze={class:"tree-count"},Pe={class:"tree-actions"},He=["onClick"],je=["onClick"],qe=["onClick"],Re={class:"content-panel edamame-glass"},Je={key:0,class:"content-empty"},Ke={class:"content-breadcrumb"},Qe=["onClick"],We={key:0,class:"breadcrumb-sep"},Xe={class:"category-info"},Ye={key:0,class:"category-desc"},Ze={class:"category-meta"},et={key:0,class:"module-grid"},tt=["onClick"],lt={class:"module-desc"},st={class:"module-count"},at={key:1,class:"text-list"},nt={key:0,class:"text-empty"},ot={key:1},it={class:"text-title"},dt={key:0,class:"text-type-badge system"},ut={key:1,class:"text-type-badge private"},rt={class:"text-summary"},ct={class:"actions"},vt=["onClick"],mt=["onClick"],pt={class:"modal-card edamame-glass"},ft={class:"modal-body"},bt={class:"form-context"},yt={class:"form-row"},_t={class:"preview-panel"},ht=["innerHTML"],gt={key:0,class:"feedback"},kt=["disabled"],Ct={class:"modal-card edamame-glass small-modal"},xt={class:"modal-body"},wt=["placeholder"],$t={key:0,class:"feedback"},Tt=["disabled"],St={class:"modal-card edamame-glass small-modal"},Mt={key:0,class:"feedback"},Vt={class:"confirm-actions"},Lt=["disabled"],Dt=re({__name:"AdminTextsPage",setup(Ft){const Z=ve(),m=fe(),v=be(),Q=ce(),S=g(()=>Z.meta.mode==="admin"),ee=g(()=>S.value?"系統文庫":"自訂練習"),te=g(()=>S.value?"管理系統內建的練習文章":"管理我的自訂練習文章"),f=y(null),k=y(new Set),C=y(!1),x=y(!1),M=y(!1),p=y(!1),V=y(null),L=y(null),b=y(null),r=y(null),i=Y({title:"",author:"",source:"",summary:"",content:""}),d=Y({name:"",description:"",parentId:null,type:"grade"}),E=g(()=>v.state.categories.filter(l=>l.level===1).sort((l,e)=>l.order_index-e.order_index)),c=g(()=>v.state.categories.find(l=>l.id===f.value)??null),G=g(()=>{if(!c.value)return[];const l=[];let e=c.value;for(;e;)l.unshift(e),e=v.state.categories.find(s=>s.id===e?.parent_id);return l}),N=g(()=>{if(!f.value)return[];let l=m.texts.filter(e=>e.category_id===f.value);return S.value?l=l.filter(e=>e.is_system===!0):l=l.filter(e=>e.is_system===!1&&e.created_by===Q.user?.id),l.sort((e,s)=>(s.created_at??"").localeCompare(e.created_at??""))}),le=g(()=>{if(!i.content)return"";let l=i.content.replace(/[「」『』"""'']/g,"");return l=l.replace(/[。！？；，：、]/g,"|"),l=l.replace(/\|{2,}/g,"|"),l=l.replace(/^\|+|\|+$/g,""),l.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function D(l){return v.state.categories.filter(e=>e.level===2&&e.parent_id===l).sort((e,s)=>e.order_index-s.order_index)}function W(l){return S.value?m.texts.filter(e=>e.category_id===l&&e.is_system===!0).length:m.texts.filter(e=>e.category_id===l&&e.is_system===!1&&e.created_by===Q.user?.id).length}function se(l){k.value.has(l)?k.value.delete(l):k.value.add(l)}function I(l){f.value=l;const e=v.state.categories.find(s=>s.id===l);e?.parent_id&&k.value.add(e.parent_id)}function O(){V.value=null,i.title="",i.author="",i.source="",i.summary="",i.content="",r.value=null,C.value=!0}function ae(l){V.value=l.id,i.title=l.title,i.author=l.author??"",i.source=l.source??"",i.summary=l.summary??"",i.content=l.content,r.value=null,C.value=!0}async function ne(){if(!i.title||!i.content){r.value="標題與內容為必填";return}if(!f.value){r.value="請先選擇一個分類";return}const l=c.value;if(!l||l.level!==2){r.value="請選擇一個單元（而非年級）來新增文章";return}try{p.value=!0;const e={title:i.title,author:i.author||null,source:i.source||null,summary:i.summary||null,category_id:f.value,content:i.content};V.value?await m.updateText(V.value,e):await m.addText(e,S.value),await m.fetchTexts(),C.value=!1}catch(e){r.value=e?.message??"儲存失敗"}finally{p.value=!1}}function F(l,e){L.value=null,d.name="",d.description="",d.parentId=l,d.type=e,r.value=null,x.value=!0}function X(l){L.value=l,d.name=l.name,d.description=l.description??"",d.parentId=l.parent_id,d.type=l.level===1?"grade":"module",r.value=null,x.value=!0}async function oe(){if(!d.name.trim()){r.value="名稱不可為空";return}try{p.value=!0,L.value?await v.updateCategory(L.value.id,{name:d.name.trim(),description:d.description.trim()||void 0}):await v.addCategory({name:d.name.trim(),parent_id:d.parentId,type:d.type,description:d.description.trim()||void 0}),x.value=!1}catch(l){r.value=l?.message??"儲存失敗"}finally{p.value=!1}}function z(l,e){b.value={type:l,item:e},r.value=null,M.value=!0}async function ie(){if(b.value)try{p.value=!0,b.value.type==="text"?(await m.deleteText(b.value.item.id),await m.fetchTexts()):(await v.deleteCategory(b.value.item.id),f.value===b.value.item.id&&(f.value=null)),M.value=!1,b.value=null}catch(l){r.value=l?.message??"刪除失敗"}finally{p.value=!1}}function de(l){return l?l===1?"初級":l===2?"中級":"高級":"未標註"}function ue(l){return l?new Date(l).toLocaleDateString():"--"}return me(async()=>{if(v.state.categories.length||await v.fetchLibrary(),m.texts.length||await m.fetchTexts(),E.value.length>0){const l=E.value[0];if(l){k.value.add(l.id);const e=D(l.id)[0];e&&(f.value=e.id)}}}),(l,e)=>(a(),n("div",ye,[t("header",_e,[t("div",null,[t("p",he,o(te.value),1),t("h1",ge,o(ee.value),1)]),t("div",ke,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[0]||(e[0]=s=>{B(v).fetchLibrary(),B(m).fetchTexts()}),disabled:B(v).isLoading||B(m).isLoading}," 重新整理 ",8,Ce),t("button",{class:"edamame-btn edamame-btn-primary",onClick:O,disabled:!c.value||c.value.level!==2}," 新增練習 ",8,xe)])]),t("div",we,[t("aside",$e,[t("div",Te,[e[19]||(e[19]=t("span",{class:"sidebar-title"},"分類導航",-1)),t("button",{class:"icon-btn",onClick:e[1]||(e[1]=s=>F(null,"grade")),title:"新增年級"},[...e[18]||(e[18]=[t("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M12 5v14M5 12h14"})],-1)])])]),B(v).isLoading?(a(),n("div",Se,"載入中⋯")):E.value.length?(a(),n("nav",Ve,[(a(!0),n(w,null,U(E.value,s=>(a(),n("div",{key:s.id,class:"tree-node"},[t("div",{class:A(["tree-item grade-item",{selected:f.value===s.id}]),onClick:u=>I(s.id)},[t("button",{class:"expand-btn",onClick:h(u=>se(s.id),["stop"])},[(a(),n("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",class:A({expanded:k.value.has(s.id)})},[...e[21]||(e[21]=[t("path",{d:"M8 5l8 7-8 7V5z"},null,-1)])],2))],8,De),t("span",Fe,o(s.name),1),t("span",Be,o(D(s.id).length),1),t("div",Ue,[t("button",{class:"action-btn",onClick:h(u=>F(s.id,"module"),["stop"]),title:"新增單元"},"+",8,Ae),t("button",{class:"action-btn",onClick:h(u=>X(s),["stop"]),title:"編輯"},"✎",8,Ee),t("button",{class:"action-btn danger",onClick:h(u=>z("category",s),["stop"]),title:"刪除"},"×",8,Ge)])],10,Le),k.value.has(s.id)?(a(),n("div",Ie,[(a(!0),n(w,null,U(D(s.id),u=>(a(),n("div",{key:u.id,class:A(["tree-item module-item",{selected:f.value===u.id}]),onClick:P=>I(u.id)},[t("span",Oe,o(u.name),1),t("span",ze,o(W(u.id)),1),t("div",Pe,[t("button",{class:"action-btn",onClick:h(P=>X(u),["stop"]),title:"編輯"},"✎",8,He),t("button",{class:"action-btn danger",onClick:h(P=>z("category",u),["stop"]),title:"刪除"},"×",8,je)])],10,Ne))),128)),t("button",{class:"add-module-btn",onClick:u=>F(s.id,"module")}," + 新增單元 ",8,qe)])):_("",!0)]))),128))])):(a(),n("div",Me,[e[20]||(e[20]=j(" 尚無分類 ",-1)),t("button",{class:"link-btn",onClick:e[2]||(e[2]=s=>F(null,"grade"))},"建立第一個年級")]))]),t("main",Re,[c.value?(a(),n(w,{key:1},[t("div",Ke,[(a(!0),n(w,null,U(G.value,(s,u)=>(a(),n("span",{key:s.id,class:A(["breadcrumb-item",{active:u===G.value.length-1}]),onClick:P=>I(s.id)},[j(o(s.name)+" ",1),u<G.value.length-1?(a(),n("span",We,"›")):_("",!0)],10,Qe))),128))]),t("div",Xe,[t("h2",null,o(c.value.name),1),c.value.description?(a(),n("p",Ye,o(c.value.description),1)):_("",!0),t("p",Ze,o(c.value.level===1?"年級":"單元")+" · "+o(c.value.level===1?`${D(c.value.id).length} 個單元`:`${N.value.length} 篇文章`),1)]),c.value.level===1?(a(),n("div",et,[(a(!0),n(w,null,U(D(c.value.id),s=>(a(),n("div",{key:s.id,class:"module-card",onClick:u=>I(s.id)},[t("h3",null,o(s.name),1),t("p",lt,o(s.description||"暫無描述"),1),t("p",st,o(W(s.id))+" 篇文章",1)],8,tt))),128)),t("button",{class:"module-card add-card",onClick:e[3]||(e[3]=s=>F(c.value.id,"module"))},[...e[23]||(e[23]=[t("span",{class:"add-icon"},"+",-1),t("span",null,"新增單元",-1)])])])):(a(),n("div",at,[N.value.length?(a(),n("table",ot,[e[25]||(e[25]=t("thead",null,[t("tr",null,[t("th",null,"標題"),t("th",null,"作者"),t("th",null,"難度"),t("th",null,"建立日期"),t("th",{style:{width:"120px"}},"操作")])],-1)),t("tbody",null,[(a(!0),n(w,null,U(N.value,s=>(a(),n("tr",{key:s.id},[t("td",null,[t("p",it,[j(o(s.title)+" ",1),s.is_system?(a(),n("span",dt,"系統")):(a(),n("span",ut,"私有"))]),t("p",rt,o(s.summary||s.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),t("td",null,o(s.author||"佚名"),1),t("td",null,[t("span",{class:A(["difficulty-badge",`diff-${s.difficulty}`])},o(de(s.difficulty)),3)]),t("td",null,o(ue(s.created_at)),1),t("td",ct,[t("button",{class:"ghost-btn",onClick:u=>ae(s)},"編輯",8,vt),t("button",{class:"ghost-btn danger",onClick:u=>z("text",s)},"刪除",8,mt)])]))),128))])])):(a(),n("div",nt,[e[24]||(e[24]=t("p",null,"此單元尚無文章",-1)),t("button",{class:"edamame-btn edamame-btn-primary",onClick:O},"新增第一篇文章")])),t("button",{class:"add-text-btn",onClick:O}," + 在「"+o(c.value.name)+"」新增文章 ",1)]))],64)):(a(),n("div",Je,[...e[22]||(e[22]=[t("p",null,"請從左側選擇一個分類",-1)])]))])]),(a(),H(K,{to:"body"},[q(J,{name:"fade"},{default:R(()=>[C.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:e[10]||(e[10]=h(s=>C.value=!1,["self"]))},[t("div",pt,[t("header",null,[t("h3",null,o(V.value?"編輯文章":"新增文章"),1),t("button",{class:"close-btn",onClick:e[4]||(e[4]=s=>C.value=!1)},"×")]),t("div",ft,[t("p",bt,"將新增至："+o(G.value.map(s=>s.name).join(" › ")),1),t("label",null,[e[26]||(e[26]=t("span",null,"標題",-1)),$(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>i.title=s),type:"text",placeholder:"請輸入標題"},null,512),[[T,i.title]])]),t("div",yt,[t("label",null,[e[27]||(e[27]=t("span",null,"作者",-1)),$(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>i.author=s),type:"text",placeholder:"例如：孔子"},null,512),[[T,i.author]])]),t("label",null,[e[28]||(e[28]=t("span",null,"來源",-1)),$(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>i.source=s),type:"text",placeholder:"例如：論語"},null,512),[[T,i.source]])])]),t("label",null,[e[29]||(e[29]=t("span",null,"內容（標點將自動轉為斷句符號）",-1)),$(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=s=>i.content=s),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[T,i.content]])]),t("div",_t,[e[30]||(e[30]=t("p",null,"預覽",-1)),t("div",{class:"preview-content",innerHTML:le.value||"尚無內容"},null,8,ht)]),r.value?(a(),n("p",gt,o(r.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[9]||(e[9]=s=>C.value=!1)},"取消"),t("button",{class:"edamame-btn edamame-btn-primary",disabled:p.value,onClick:ne},o(p.value?"儲存中...":"儲存"),9,kt)])])])):_("",!0)]),_:1})])),(a(),H(K,{to:"body"},[q(J,{name:"fade"},{default:R(()=>[x.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:e[15]||(e[15]=h(s=>x.value=!1,["self"]))},[t("div",Ct,[t("header",null,[t("h3",null,o(L.value?"編輯分類":d.type==="grade"?"新增年級":"新增單元"),1),t("button",{class:"close-btn",onClick:e[11]||(e[11]=s=>x.value=!1)},"×")]),t("div",xt,[t("label",null,[e[31]||(e[31]=t("span",null,"名稱",-1)),$(t("input",{"onUpdate:modelValue":e[12]||(e[12]=s=>d.name=s),type:"text",placeholder:d.type==="grade"?"例如：七年級":"例如：論語讀本"},null,8,wt),[[T,d.name]])]),t("label",null,[e[32]||(e[32]=t("span",null,"描述（選填）",-1)),$(t("textarea",{"onUpdate:modelValue":e[13]||(e[13]=s=>d.description=s),rows:"2",placeholder:"簡述此分類的內容範圍"},null,512),[[T,d.description]])]),r.value?(a(),n("p",$t,o(r.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[14]||(e[14]=s=>x.value=!1)},"取消"),t("button",{class:"edamame-btn edamame-btn-primary",disabled:p.value,onClick:oe},o(p.value?"儲存中...":"儲存"),9,Tt)])])])):_("",!0)]),_:1})])),(a(),H(K,{to:"body"},[q(J,{name:"fade"},{default:R(()=>[M.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:e[17]||(e[17]=h(s=>M.value=!1,["self"]))},[t("div",St,[e[33]||(e[33]=t("h3",null,"確定刪除？",-1)),t("p",null,"「"+o(b.value?.item?"title"in b.value.item?b.value.item.title:b.value.item.name:"")+"」刪除後將無法復原。",1),r.value?(a(),n("p",Mt,o(r.value),1)):_("",!0),t("div",Vt,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[16]||(e[16]=s=>M.value=!1)},"取消"),t("button",{class:"edamame-btn edamame-btn-danger",disabled:p.value,onClick:ie},o(p.value?"刪除中...":"刪除"),9,Lt)])])])):_("",!0)]),_:1})]))]))}}),Et=pe(Dt,[["__scopeId","data-v-996a89ad"]]);export{Et as default};
