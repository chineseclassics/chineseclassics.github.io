import{x as G,u as V,r as d,c as L,I as o}from"./index-mRk65oNV.js";const f=[0,30,100,200,350,550,850,1300,2e3,3e3],W=10,b=5,y=10,Z=G("userStats",()=>{const l=V(),t=d(null),S=d(!1),v=d(null),_=d([]),h=d("total"),w=d(!1),g=d(null),k=L(()=>{if(!t.value)return 1;const e=t.value.total_beans;for(let a=f.length-1;a>=0;a--){const r=f[a];if(r!==void 0&&e>=r)return a+1}return 1}),q=L(()=>{if(!t.value)return 0;const e=k.value,a=f[e-1]||0,r=f[e]||a+1e3,n=t.value.total_beans-a,s=r-a;return Math.min(100,Math.round(n/s*100))}),A=L(()=>{if(!t.value)return 30;const e=k.value;if(e>=f.length)return 0;const a=f[e]||3e3;return Math.max(0,a-t.value.total_beans)});function M(e){const{correctCount:a,totalBreaks:r,charCount:n,elapsedSeconds:s}=e,u=a,i=a===r;let c=0;if(i&&a>0){const C=n*3,p=Math.max(0,C-s);c=Math.floor(p/W)}return{score:u+c,breakdown:{baseScore:u,speedBonus:c,isAllCorrect:i,elapsedSeconds:s,baseTime:n*3}}}async function R(){if(!(!o||!l.user)){S.value=!0,v.value=null;try{const{data:e,error:a}=await o.from("profiles").select("*").eq("id",l.user.id).single();if(a){if(a.code==="PGRST116"){console.log("ç”¨æˆ¶ Profile ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º..."),await N();return}throw a}t.value=e,await D()}catch(e){v.value=e.message,console.error("ç²å–ç”¨æˆ¶ Profile å¤±æ•—:",e)}finally{S.value=!1}}}async function N(){if(!(!o||!l.user))try{const{data:e}=await o.from("users").select("display_name, email").eq("id",l.user.id).single(),a=e?.display_name||l.user.email?.split("@")[0]||"è±†å‹",r=a.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),{data:n,error:s}=await o.from("profiles").insert({id:l.user.id,username:r+"_"+Date.now().toString(36),display_name:a,total_beans:0,weekly_beans:0,monthly_beans:0,streak_days:0,max_streak:0,daily_login_claimed:!1,daily_first_claimed:!1}).select().single();if(s){console.error("å‰µå»º Profile å¤±æ•—:",s);return}t.value=n,console.log("âœ… Profile å‰µå»ºæˆåŠŸ"),await D()}catch(e){console.error("å‰µå»ºåˆå§‹ Profile å¤±æ•—:",e)}}async function D(){if(!o||!t.value||!l.user)return!1;const e=new Date().toISOString().split("T")[0],a=t.value.last_login_date;if(a===e&&t.value.daily_login_claimed)return!1;try{const r={last_login_date:e,daily_login_claimed:!0,total_beans:t.value.total_beans+b,weekly_beans:t.value.weekly_beans+b,monthly_beans:t.value.monthly_beans+b,updated_at:new Date().toISOString()};a!==e&&(r.daily_first_claimed=!1);const{error:n}=await o.from("profiles").update(r).eq("id",l.user.id);if(n)throw n;return Object.assign(t.value,r),console.log(`ðŸŽ æ¯æ—¥ç™»å…¥çŽå‹µ +${b} è±†`),!0}catch(r){return console.error("ç™¼æ”¾æ¯æ—¥ç™»å…¥çŽå‹µå¤±æ•—:",r),!1}}async function T(){if(!o||!t.value||!l.user||t.value.daily_first_claimed)return 0;try{const e={daily_first_claimed:!0,total_beans:t.value.total_beans+y,weekly_beans:t.value.weekly_beans+y,monthly_beans:t.value.monthly_beans+y,updated_at:new Date().toISOString()},{error:a}=await o.from("profiles").update(e).eq("id",l.user.id);if(a)throw a;return Object.assign(t.value,e),console.log(`ðŸŽ æ¯æ—¥é¦–ç·´çŽå‹µ +${y} è±†`),y}catch(e){return console.error("ç™¼æ”¾æ¯æ—¥é¦–ç·´çŽå‹µå¤±æ•—:",e),0}}async function E(){if(!o||!t.value||!l.user)return;const e=new Date().toISOString().split("T")[0],a=t.value.last_practice_date;let r=t.value.streak_days;if(!a)r=1;else{const s=new Date(a),u=new Date(e),i=Math.floor((u.getTime()-s.getTime())/(1e3*60*60*24));if(i===0)return;i===1?r=t.value.streak_days+1:r=1}const n=Math.max(t.value.max_streak,r);try{const{error:s}=await o.from("profiles").update({streak_days:r,max_streak:n,last_practice_date:e,updated_at:new Date().toISOString()}).eq("id",l.user.id);if(s)throw s;t.value.streak_days=r,t.value.max_streak=n,t.value.last_practice_date=e}catch(s){console.error("æ›´æ–°é€£çºŒå¤©æ•¸å¤±æ•—:",s)}}async function B(e){if(!o||!l.user)return!1;try{const{data:a}=await o.from("user_text_scores").select("id").eq("user_id",l.user.id).eq("text_id",e).maybeSingle();return!a}catch{return!1}}async function U(e){if(!o||!t.value||!l.user)return{beansEarned:0,isNewRecord:!1};const{textId:a,score:r}=e;try{const{data:n}=await o.from("user_text_scores").select("*").eq("user_id",l.user.id).eq("text_id",a).maybeSingle();let s=0,u=!1;if(!n)await o.from("user_text_scores").insert({user_id:l.user.id,text_id:a,best_score:r,weekly_best:r,monthly_best:r,first_clear_at:new Date().toISOString(),attempt_count:1}),s=r,u=!0;else{const c={attempt_count:n.attempt_count+1,updated_at:new Date().toISOString()};r>n.best_score&&(s=r-n.best_score,c.best_score=r,u=!0),r>n.weekly_best&&(c.weekly_best=r),r>n.monthly_best&&(c.monthly_best=r),await o.from("user_text_scores").update(c).eq("id",n.id)}if(s>0){const{error:c}=await o.from("profiles").update({total_beans:t.value.total_beans+s,weekly_beans:t.value.weekly_beans+s,monthly_beans:t.value.monthly_beans+s,updated_at:new Date().toISOString()}).eq("id",l.user.id);c||(t.value.total_beans+=s,t.value.weekly_beans+=s,t.value.monthly_beans+=s)}await E();const i=await T();return s+=i,P(),{beansEarned:s,isNewRecord:u}}catch(n){return console.error("è¨˜éŒ„ç·´ç¿’åˆ†æ•¸å¤±æ•—:",n),{beansEarned:0,isNewRecord:!1}}}const x=d({}),F=3e4;async function I(e="total",a=!1){if(!o)return;const r=x.value[e];if(!a&&r&&Date.now()-r.timestamp<F){_.value=r.data,h.value=e;return}w.value=!0,h.value=e;try{const n=e==="weekly"?"weekly_beans":e==="monthly"?"monthly_beans":"total_beans",s=l.user?.id,u=t.value?.[n==="weekly_beans"?"weekly_beans":n==="monthly_beans"?"monthly_beans":"total_beans"]||0,[i,c,O]=await Promise.all([o.from("profiles").select("id, display_name, total_beans, weekly_beans, monthly_beans").order(n,{ascending:!1}).limit(10),s?o.from("profiles").select("*",{count:"exact",head:!0}).gt(n,u):Promise.resolve({count:0}),s?o.from("profiles").select("*",{count:"exact",head:!0}):Promise.resolve({count:0})]);if(i.error)throw i.error;const p=(i.data||[]).map((m,j)=>({rank:j+1,userId:m.id,name:m.display_name||"åŒ¿å",beans:e==="weekly"?m.weekly_beans:e==="monthly"?m.monthly_beans:m.total_beans,isCurrentUser:m.id===s}));_.value=p,x.value[e]={data:p,timestamp:Date.now()},s&&(g.value={rank:(c.count||0)+1,totalUsers:O.count||0})}catch(n){console.error("ç²å–æŽ’è¡Œæ¦œå¤±æ•—:",n),_.value=[]}finally{w.value=!1}}function P(){x.value={}}function H(){t.value=null,_.value=[],g.value=null,v.value=null}return{profile:t,stats:t,loading:S,error:v,leaderboard:_,top10:_,leaderboardType:h,leaderboardLoading:w,top10Loading:w,rankInfo:g,level:k,levelProgress:q,beansToNextLevel:A,calculateScore:M,fetchProfile:R,fetchStats:R,fetchLeaderboard:I,fetchTop10:()=>I("total"),fetchRankInfo:()=>I(h.value),checkFirstClear:B,recordPracticeScore:U,checkDailyLoginReward:D,checkDailyFirstPracticeReward:T,updateStreakDays:E,clearLeaderboardCache:P,reset:H,DAILY_LOGIN_REWARD:b,DAILY_FIRST_PRACTICE_REWARD:y,LEVEL_THRESHOLDS:f}});export{Z as u};
