import{d as me,u as ye,c as h,x as pe,r as p,N as fe,f as ge,a as i,g as e,m as W,t as o,i as D,s as F,h as k,F as N,j as E,z as w,L as x,O as $,e as X,p as Y,I as Z,J as ee,b as I,y as O,o as n,_ as _e}from"./index-BMxa7SLO.js";import{u as be}from"./textsStore-C-v-IGGW.js";import{u as he}from"./practiceLibraryStore-Dj3qIVOo.js";import"./useSupabase-CZ70diGn.js";const ke={class:"admin-shell"},Ce={class:"admin-header"},we={class:"edamame-text-level-detail"},xe={class:"edamame-heading-gradient"},Te={class:"header-actions"},$e=["disabled"],Le=["disabled"],Se={class:"admin-layout"},Ve={class:"category-sidebar edamame-glass"},Ae={key:0,class:"sidebar-loading"},Me={key:1,class:"sidebar-empty"},De={key:2,class:"category-tree"},Ne={key:0,class:"tree-item editing"},Ue=["onClick"],Be={class:"tree-label"},Fe={class:"tree-count"},Ee={class:"tree-actions"},Ie=["onClick"],Oe=["onClick"],Ke={key:0,class:"add-category-inline"},Pe={class:"content-panel edamame-glass"},ze={key:0,class:"content-empty"},He={class:"content-breadcrumb"},je=["onClick"],Ge={key:0,class:"breadcrumb-sep"},Je={class:"category-info"},Re={key:0,class:"category-desc"},qe={class:"category-meta"},Qe={class:"text-list"},We={key:0,class:"text-empty"},Xe={key:1},Ye={class:"text-title"},Ze={key:0,class:"text-type-badge system"},et={key:1,class:"text-type-badge private"},tt={class:"text-summary"},at={class:"actions"},st=["onClick"],lt=["onClick"],nt={class:"modal-card edamame-glass"},it={class:"modal-body"},ot={class:"form-row"},rt={class:"category-picker"},ut=["onClick"],dt={key:0,class:"tag-check"},ct={key:0,class:"new-category-inline"},vt={class:"preview-panel"},mt=["innerHTML"],yt={key:0,class:"feedback"},pt=["disabled"],ft={class:"modal-card edamame-glass small-modal"},gt={key:0,class:"feedback"},_t={class:"confirm-actions"},bt=["disabled"],ht=me({__name:"AdminTextsPage",setup(kt){const te=pe(),v=be(),d=he(),L=ye(),g=h(()=>te.meta.mode==="admin"),ae=h(()=>g.value?"系統文庫":"自訂練習"),se=h(()=>g.value?"管理系統內建的練習文章":"管理我的自訂練習文章"),c=p(null),C=p(!1),S=p(!1),_=p(!1),V=p(null),A=p(null),T=p(""),f=p(!1),r=p(""),m=p(null),y=p(null),l=fe({title:"",author:"",source:"",summary:"",content:"",practice_category_ids:[]}),M=h(()=>d.state.categories.filter(a=>a.level!==1?!1:g.value?a.is_system===!0:a.is_system===!1&&a.created_by===L.user?.id).sort((a,t)=>a.order_index-t.order_index)),b=h(()=>d.state.categories.find(a=>a.id===c.value)??null),K=h(()=>{if(!b.value)return[];const a=[];let t=b.value;for(;t;)a.unshift(t),t=d.state.categories.find(s=>s.id===t?.parent_id);return a}),P=h(()=>{if(!c.value)return[];let a=v.texts.filter(t=>t.practice_categories?.some(u=>u.id===c.value)||t.category_id===c.value);return g.value?a=a.filter(t=>t.is_system===!0):a=a.filter(t=>t.is_system===!1&&t.created_by===L.user?.id),a.sort((t,s)=>(s.created_at??"").localeCompare(t.created_at??""))}),le=h(()=>{if(!l.content)return"";let a=l.content.replace(/[「」『』"""'']/g,"");return a=a.replace(/[。！？；，：、]/g,"|"),a=a.replace(/\|{2,}/g,"|"),a=a.replace(/^\|+|\|+$/g,""),a.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function ne(a){const t=s=>g.value?s.is_system===!0:s.is_system===!1&&s.created_by===L.user?.id;return v.texts.filter(s=>(s.practice_categories?.some(Q=>Q.id===a)||s.category_id===a)&&t(s)).length}function H(a){c.value=a}function z(){V.value=null,l.title="",l.author="",l.source="",l.summary="",l.content="",l.practice_category_ids=[],c.value&&(l.practice_category_ids=[c.value]),y.value=null,C.value=!0}function ie(a){V.value=a.id,l.title=a.title,l.author=a.author??"",l.source=a.source??"",l.summary=a.summary??"",l.content=a.content,l.practice_category_ids=a.practice_categories?.map(t=>t.id)||(a.category_id?[a.category_id]:[]),y.value=null,C.value=!0}async function oe(){if(!l.title||!l.content){y.value="標題與內容為必填";return}if(!l.practice_category_ids||l.practice_category_ids.length===0){y.value="請至少選擇一個分類";return}try{_.value=!0;const a={title:l.title,author:l.author||null,source:l.source||null,summary:l.summary||null,category_id:l.practice_category_ids[0]||null,practice_category_ids:l.practice_category_ids,content:l.content};V.value?await v.updateText(V.value,a):await v.addText(a,g.value),await v.fetchTexts(),C.value=!1}catch(a){y.value=a?.message??"儲存失敗"}finally{_.value=!1}}function re(a){A.value=a.id,T.value=a.name}function U(){A.value=null,T.value=""}async function j(){if(!A.value||!T.value.trim()){U();return}try{await d.updateCategory(A.value,{name:T.value.trim()}),U()}catch(a){alert(a?.message??"更新失敗")}}function G(){f.value=!0,r.value=""}function B(){f.value=!1,r.value=""}function ue(a){const t=l.practice_category_ids.indexOf(a);t>-1?l.practice_category_ids.splice(t,1):l.practice_category_ids.push(a)}async function J(){if(r.value.trim())try{const a=await d.addCategory({name:r.value.trim(),parent_id:null,type:"grade",is_system:g.value},L.user?.id);a&&l.practice_category_ids.push(a.id),r.value="",f.value=!1}catch(a){alert(a?.message??"新增分類失敗")}}async function R(){if(!r.value.trim()){B();return}try{await d.addCategory({name:r.value.trim(),parent_id:null,type:"grade",is_system:g.value},L.user?.id),B()}catch(a){alert(a?.message??"新增失敗")}}function q(a,t){m.value={type:a,item:t},y.value=null,S.value=!0}async function de(){if(m.value)try{_.value=!0,m.value.type==="text"?(await v.deleteText(m.value.item.id),await v.fetchTexts()):(await d.deleteCategory(m.value.item.id),c.value===m.value.item.id&&(c.value=null)),S.value=!1,m.value=null}catch(a){y.value=a?.message??"刪除失敗"}finally{_.value=!1}}function ce(a){return a?a===1?"初級":a===2?"中級":"高級":"未標註"}function ve(a){return a?new Date(a).toLocaleDateString():"--"}return ge(async()=>{if(d.state.categories.length||await d.fetchLibrary(),v.texts.length||await v.fetchTexts(),M.value.length>0&&!c.value){const a=M.value[0];a&&(c.value=a.id)}}),(a,t)=>(n(),i("div",ke,[e("header",Ce,[e("div",null,[e("p",we,o(se.value),1),e("h1",xe,o(ae.value),1)]),e("div",Te,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[0]||(t[0]=s=>{D(d).fetchLibrary(),D(v).fetchTexts()}),disabled:D(d).isLoading||D(v).isLoading}," 重新整理 ",8,$e),e("button",{class:"edamame-btn edamame-btn-primary",onClick:z,disabled:!b.value}," 新增練習 ",8,Le)])]),e("div",Se,[e("aside",Ve,[e("div",{class:"sidebar-header"},[t[17]||(t[17]=e("span",{class:"sidebar-title"},"分類導航",-1)),e("button",{class:"icon-btn",onClick:G,title:"新增年級"},[...t[16]||(t[16]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M12 5v14M5 12h14"})],-1)])])]),D(d).isLoading?(n(),i("div",Ae,"載入中⋯")):!M.value.length&&!f.value?(n(),i("div",Me,[t[18]||(t[18]=F(" 尚無分類 ",-1)),e("button",{class:"link-btn",onClick:G},"建立第一個年級")])):(n(),i("nav",De,[(n(!0),i(N,null,E(M.value,s=>(n(),i("div",{key:s.id,class:"tree-node"},[A.value===s.id?(n(),i("div",Ne,[w(e("input",{"onUpdate:modelValue":t[1]||(t[1]=u=>T.value=u),type:"text",class:"edit-input",onKeyup:[$(j,["enter"]),$(U,["escape"])]},null,544),[[x,T.value]]),e("div",{class:"edit-actions"},[e("button",{class:"action-btn",onClick:j,title:"確認"},"✓"),e("button",{class:"action-btn",onClick:U,title:"取消"},"×")])])):(n(),i("div",{key:1,class:I(["tree-item grade-item",{selected:c.value===s.id}]),onClick:u=>H(s.id)},[e("span",Be,o(s.name),1),e("span",Fe,o(ne(s.id)),1),e("div",Ee,[e("button",{class:"action-btn",onClick:O(u=>re(s),["stop"]),title:"編輯"},"✎",8,Ie),e("button",{class:"action-btn danger",onClick:O(u=>q("category",s),["stop"]),title:"刪除"},"×",8,Oe)])],10,Ue))]))),128)),f.value?(n(),i("div",Ke,[w(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>r.value=s),type:"text",placeholder:"輸入年級名稱...",class:"category-input",onKeyup:[$(R,["enter"]),$(B,["escape"])]},null,544),[[x,r.value]]),e("div",{class:"add-category-actions"},[e("button",{class:"action-btn",onClick:R,title:"確認"},"✓"),e("button",{class:"action-btn",onClick:B,title:"取消"},"×")])])):k("",!0)]))]),e("main",Pe,[b.value?(n(),i(N,{key:1},[e("div",He,[(n(!0),i(N,null,E(K.value,(s,u)=>(n(),i("span",{key:s.id,class:I(["breadcrumb-item",{active:u===K.value.length-1}]),onClick:Q=>H(s.id)},[F(o(s.name)+" ",1),u<K.value.length-1?(n(),i("span",Ge,"›")):k("",!0)],10,je))),128))]),e("div",Je,[e("h2",null,o(b.value.name),1),b.value.description?(n(),i("p",Re,o(b.value.description),1)):k("",!0),e("p",qe,o(P.value.length)+" 篇文章 ",1)]),e("div",Qe,[P.value.length?(n(),i("table",Xe,[t[21]||(t[21]=e("thead",null,[e("tr",null,[e("th",{style:{width:"auto","min-width":"200px"}},"標題"),e("th",{style:{width:"80px"}},"作者"),e("th",{style:{width:"60px"}},"難度"),e("th",{style:{width:"100px"}},"建立日期"),e("th",{style:{width:"120px"}},"操作")])],-1)),e("tbody",null,[(n(!0),i(N,null,E(P.value,s=>(n(),i("tr",{key:s.id},[e("td",null,[e("p",Ye,[F(o(s.title)+" ",1),s.is_system?(n(),i("span",Ze,"系統")):(n(),i("span",et,"私有"))]),e("p",tt,o(s.summary||s.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),e("td",null,o(s.author||"佚名"),1),e("td",null,[e("span",{class:I(["difficulty-badge",`diff-${s.difficulty}`])},o(ce(s.difficulty)),3)]),e("td",null,o(ve(s.created_at)),1),e("td",at,[e("button",{class:"ghost-btn",onClick:u=>ie(s)},"編輯",8,st),e("button",{class:"ghost-btn danger",onClick:u=>q("text",s)},"刪除",8,lt)])]))),128))])])):(n(),i("div",We,[t[20]||(t[20]=e("p",null,"此年級尚無文章",-1)),e("button",{class:"edamame-btn edamame-btn-primary",onClick:z},"新增第一篇文章")])),e("button",{class:"add-text-btn",onClick:z}," + 在「"+o(b.value.name)+"」新增文章 ",1)])],64)):(n(),i("div",ze,[...t[19]||(t[19]=[e("p",null,"請從左側選擇一個分類",-1)])]))])]),(n(),W(ee,{to:"body"},[X(Z,{name:"fade"},{default:Y(()=>[C.value?(n(),i("div",{key:0,class:"modal-backdrop",onClick:t[13]||(t[13]=O(s=>C.value=!1,["self"]))},[e("div",nt,[e("header",null,[e("h3",null,o(V.value?"編輯文章":"新增文章"),1),e("button",{class:"close-btn",onClick:t[3]||(t[3]=s=>C.value=!1)},"×")]),e("div",it,[e("label",null,[t[22]||(t[22]=e("span",null,"標題",-1)),w(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l.title=s),type:"text",placeholder:"請輸入標題"},null,512),[[x,l.title]])]),e("div",ot,[e("label",null,[t[23]||(t[23]=e("span",null,"作者",-1)),w(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>l.author=s),type:"text",placeholder:"例如：孔子"},null,512),[[x,l.author]])]),e("label",null,[t[24]||(t[24]=e("span",null,"來源",-1)),w(e("input",{"onUpdate:modelValue":t[6]||(t[6]=s=>l.source=s),type:"text",placeholder:"例如：論語"},null,512),[[x,l.source]])])]),e("label",null,[t[25]||(t[25]=e("span",null,"分類（點擊選擇）*",-1)),e("div",rt,[(n(!0),i(N,null,E(M.value,s=>(n(),i("button",{key:s.id,type:"button",class:I(["category-tag-btn",{selected:l.practice_category_ids.includes(s.id)}]),onClick:u=>ue(s.id)},[l.practice_category_ids.includes(s.id)?(n(),i("span",dt,"✓")):k("",!0),F(" "+o(s.name),1)],10,ut))),128)),f.value?(n(),i("div",ct,[w(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>r.value=s),type:"text",class:"new-category-input-inline",onKeyup:[$(J,["enter"]),t[8]||(t[8]=$(s=>{f.value=!1,r.value=""},["escape"]))]},null,544),[[x,r.value]]),e("button",{type:"button",class:"inline-action confirm",onClick:J},"✓"),e("button",{type:"button",class:"inline-action cancel",onClick:t[9]||(t[9]=s=>{f.value=!1,r.value=""})},"×")])):(n(),i("button",{key:1,type:"button",class:"category-tag-btn add-new",onClick:t[10]||(t[10]=s=>{f.value=!0,r.value=""})}," + 新增分類 "))])]),e("label",null,[t[26]||(t[26]=e("span",null,"內容（標點將自動轉為斷句符號）",-1)),w(e("textarea",{"onUpdate:modelValue":t[11]||(t[11]=s=>l.content=s),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[x,l.content]])]),e("div",vt,[t[27]||(t[27]=e("p",null,"預覽",-1)),e("div",{class:"preview-content",innerHTML:le.value||"尚無內容"},null,8,mt)]),y.value?(n(),i("p",yt,o(y.value),1)):k("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[12]||(t[12]=s=>C.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:_.value,onClick:oe},o(_.value?"儲存中...":"儲存"),9,pt)])])])):k("",!0)]),_:1})])),(n(),W(ee,{to:"body"},[X(Z,{name:"fade"},{default:Y(()=>[S.value?(n(),i("div",{key:0,class:"modal-backdrop",onClick:t[15]||(t[15]=O(s=>S.value=!1,["self"]))},[e("div",ft,[t[28]||(t[28]=e("h3",null,"確定刪除？",-1)),e("p",null,"「"+o(m.value?.item?"title"in m.value.item?m.value.item.title:m.value.item.name:"")+"」刪除後將無法復原。",1),y.value?(n(),i("p",gt,o(y.value),1)):k("",!0),e("div",_t,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[14]||(t[14]=s=>S.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-danger",disabled:_.value,onClick:de},o(_.value?"刪除中...":"刪除"),9,bt)])])])):k("",!0)]),_:1})]))]))}}),$t=_e(ht,[["__scopeId","data-v-f75838a2"]]);export{$t as default};
