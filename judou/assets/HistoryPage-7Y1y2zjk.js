import{y as ie,u as ne,r as v,c as $,d as ce,w as H,f as le,a as l,h as S,g as r,i as R,F as A,j as B,H as W,J as Y,s as k,t as c,b as D,m as M,e as J,o as n,_ as de}from"./index-DUA57efl.js";import{u as ue}from"./useSupabase-G30itgD1.js";import{B as P}from"./BeanIcon-C75gyw2u.js";import{C as _e}from"./clock-Bvy6EleD.js";import"./createLucideIcon-B4qBnT3T.js";const me=[10,20,50,100],pe=ie("history",()=>{const m=ue(),o=ne(),g=v([]),w=v(null),b=v(20),p=v("all"),x=v("all"),L=v(!1),q=v(!1),I=v(null),O=$(()=>g.value.filter(s=>s.type==="practice")),z=$(()=>g.value.filter(s=>s.type==="game")),C=$(()=>g.value.filter(s=>s.type==="bean")),N=$(()=>g.value.filter(s=>s.type==="reading"));function t(){const s=new Date,i=s.toISOString();switch(x.value){case"today":return{start:new Date(s.getFullYear(),s.getMonth(),s.getDate()).toISOString(),end:i};case"week":return{start:new Date(s.getTime()-6048e5).toISOString(),end:i};case"month":return{start:new Date(s.getTime()-2592e6).toISOString(),end:i};default:return null}}async function u(){if(!m||!o.user?.id)return[];let s=m.from("practice_records").select(`
        id, display_name, username, score, accuracy, elapsed_seconds, created_at,
        text:practice_texts!text_id (
          id, title,
          category:practice_categories!category_id (name)
        )
      `).eq("user_id",o.user.id).order("created_at",{ascending:!1}).limit(b.value);const i=t();i&&(s=s.gte("created_at",i.start));const{data:d,error:f}=await s;return f?(console.error("ç²å–ç·´ç¿’è¨˜éŒ„å¤±æ•—:",f),[]):(d||[]).map(a=>{const _=Array.isArray(a.text)?a.text[0]:a.text,h=_?.category,T=Array.isArray(h)?h[0]?.name:h?.name;return{id:a.id,type:"practice",display_name:a.display_name,username:a.username,score:a.score,accuracy:a.accuracy,elapsed_seconds:a.elapsed_seconds,created_at:a.created_at,text:_?{id:_.id,title:_.title,category_name:T||null}:null}})}async function e(){if(!m||!o.user?.id)return[];let s=m.from("game_participants").select(`
        id, room_id, score, accuracy, time_spent, status, prize_won, fee_paid, joined_at,
        room:game_rooms!room_id (
          id, room_code, game_mode, status, winner_user_id,
          text:practice_texts!text_id (id, title)
        )
      `).eq("user_id",o.user.id).order("joined_at",{ascending:!1}).limit(b.value);const i=t();i&&(s=s.gte("joined_at",i.start));const{data:d,error:f}=await s;return f?(console.error("ç²å–å°æˆ°è¨˜éŒ„å¤±æ•—:",f),[]):(d||[]).map(a=>{const _=Array.isArray(a.room)?a.room[0]:a.room,h=_?.text,T=Array.isArray(h)?h[0]:h;return{id:a.id,type:"game",room_id:a.room_id,room_code:_?.room_code||"",game_mode:_?.game_mode||"pvp",score:a.score,accuracy:a.accuracy,time_spent:a.time_spent,status:a.status,is_winner:_?.winner_user_id===o.user?.id,prize_won:a.prize_won||0,fee_paid:a.fee_paid||0,created_at:a.joined_at,text:T?{id:T.id,title:T.title}:null}})}async function j(){if(!m||!o.user?.id)return[];let s=m.from("game_transactions").select(`
        id, type, amount, balance_after, description, created_at, text_id,
        text:practice_texts!text_id (id, title)
      `).eq("user_id",o.user.id).order("created_at",{ascending:!1}).limit(b.value);const i=t();i&&(s=s.gte("created_at",i.start));const{data:d,error:f}=await s;return f?(console.error("ç²å–è±†å­è¨˜éŒ„å¤±æ•—:",f),[]):(d||[]).map(a=>{const _=Array.isArray(a.text)?a.text[0]:a.text;return{id:a.id,type:"bean",transaction_type:a.type,amount:a.amount,balance_after:a.balance_after,description:a.description,created_at:a.created_at,text:_?{id:_.id,title:_.title}:null}})}async function K(){if(!m||!o.user?.id)return[];let s=m.from("reading_records").select(`
        id, progress, is_completed, read_duration, read_count, 
        first_read_at, last_read_at, completed_at,
        text:practice_texts!text_id (id, title, author)
      `).eq("user_id",o.user.id).order("last_read_at",{ascending:!1}).limit(b.value);const i=t();i&&(s=s.gte("last_read_at",i.start));const{data:d,error:f}=await s;return f?f.code==="42P01"?(console.log("é–±è®€è¨˜éŒ„è¡¨å°šæœªå‰µå»º"),[]):(console.error("ç²å–é–±è®€è¨˜éŒ„å¤±æ•—:",f),[]):(d||[]).map(a=>{const _=Array.isArray(a.text)?a.text[0]:a.text;return{id:a.id,type:"reading",progress:a.progress,is_completed:a.is_completed,read_duration:a.read_duration,read_count:a.read_count,last_read_at:a.last_read_at,created_at:a.first_read_at,text:_?{id:_.id,title:_.title,author:_.author}:null}})}async function F(s){if(s&&(b.value=s),!o.isAuthenticated||!o.user?.id){g.value=[];return}L.value=!0,I.value=null;try{let i=[];if(p.value==="all"||p.value==="practice"){const d=await u();i=[...i,...d]}if(p.value==="all"||p.value==="game"){const d=await e();i=[...i,...d]}if(p.value==="all"||p.value==="bean"){const d=await j();i=[...i,...d]}if(p.value==="all"||p.value==="reading"){const d=await K();i=[...i,...d]}i.sort((d,f)=>new Date(f.created_at).getTime()-new Date(d.created_at).getTime()),p.value==="all"&&(i=i.slice(0,b.value)),g.value=i}catch(i){console.error("ç²å–æ­·å²è¨˜éŒ„å¤±æ•—:",i),I.value=i.message??"ç„¡æ³•è¼‰å…¥æ­·å²ç´€éŒ„"}finally{L.value=!1}}async function Q(){if(!m||!o.isAuthenticated||!o.user?.id){w.value=null;return}q.value=!0;try{const s=new Date,i=new Date(s.getTime()-10080*60*1e3).toISOString(),[d,f,a,_,h,T]=await Promise.all([m.from("practice_records").select("id",{count:"exact",head:!0}).eq("user_id",o.user.id),m.from("practice_records").select("id",{count:"exact",head:!0}).eq("user_id",o.user.id).gte("created_at",i),m.from("game_participants").select(`
            id,
            room:game_rooms!room_id (winner_user_id, status)
          `).eq("user_id",o.user.id),m.from("game_participants").select("id",{count:"exact",head:!0}).eq("user_id",o.user.id).gte("joined_at",i),m.from("reading_records").select("id, is_completed",{count:"exact"}).eq("user_id",o.user.id),m.from("game_transactions").select("amount").eq("user_id",o.user.id)]),G=(a.data||[]).filter(y=>(Array.isArray(y.room)?y.room[0]:y.room)?.status==="finished"),ae=G.filter(y=>(Array.isArray(y.room)?y.room[0]:y.room)?.winner_user_id===o.user?.id),se=(h.data||[]).filter(y=>y.is_completed).length,re=T.data||[];let V=0,U=0;for(const y of re)y.amount>0?V+=y.amount:U+=Math.abs(y.amount);w.value={totalPractices:d.count||0,totalGames:G.length,totalWins:ae.length,totalReadings:h.count||0,completedReadings:se,totalBeansEarned:V,totalBeansSpent:U,weeklyPractices:f.count||0,weeklyGames:_.count||0}}catch(s){console.error("ç²å–çµ±è¨ˆå¤±æ•—:",s),w.value=null}finally{q.value=!1}}function X(s){p.value=s,F()}function Z(s){x.value=s,F()}function ee(){return me}function te(){g.value=[],w.value=null,p.value="all",x.value="all",I.value=null}return{entries:g,stats:w,limit:b,recordType:p,timeRange:x,isLoading:L,isLoadingStats:q,error:I,practiceEntries:O,gameEntries:z,beanEntries:C,readingEntries:N,fetchHistory:F,fetchStats:Q,setRecordType:X,setTimeRange:Z,getLimitOptions:ee,reset:te}}),fe={entry_fee:"å…¥å ´è²»",prize:"å°æˆ°çå‹µ",refund:"é€€æ¬¾",win_streak_bonus:"é€£å‹çå‹µ",practice_reward:"ç·´ç¿’çå‹µ",daily_login:"æ¯æ—¥ç™»å…¥",daily_first:"æ¯æ—¥é¦–ç·´",level_up:"å‡ç´šçå‹µ"};function ge(m){return fe[m]||m}const ye={class:"history-shell"},ve={key:0,class:"stats-grid"},he={class:"stat-icon"},be={class:"stat-content"},ke={class:"stat-value"},we={class:"stat-label"},xe={class:"stat-sub"},Se={class:"filter-section edamame-glass"},Re={class:"tabs-row"},Ae=["onClick"],Te={class:"tab-icon"},De={class:"tab-label"},Ie={class:"filter-row"},Ee={class:"time-filter"},Le=["value"],qe={class:"limit-filter"},ze=["value"],Be={class:"history-timeline edamame-glass"},$e={key:0,class:"state-info"},Pe={key:1,class:"state-error"},Oe={key:2,class:"state-info"},Ce={key:3,class:"timeline-list"},Ne={class:"timeline-content"},Fe={class:"timeline-header"},He={class:"entry-title"},Me={class:"entry-time"},je={key:0,class:"entry-details practice-details"},Ge={class:"detail-item score"},Ve={class:"detail-item accuracy"},Ue={class:"detail-item time"},We={class:"detail-icon"},Ye={key:0,class:"detail-item category"},Je={key:1,class:"entry-details game-details"},Ke={class:"detail-item mode"},Qe={class:"detail-item score"},Xe={key:0,class:"detail-item prize"},Ze={key:1,class:"detail-item fee"},et={key:2,class:"entry-details bean-details"},tt={key:0,class:"detail-item balance"},at={key:1,class:"detail-item desc"},st={key:3,class:"entry-details reading-details"},rt={key:0,class:"detail-item author"},ot={class:"detail-item count"},it={class:"detail-item duration"},E="bean",nt=ce({__name:"HistoryPage",setup(m){const o=pe(),g=v(o.limit),w=[{key:"all",label:"å…¨éƒ¨",icon:"ğŸ“‹"},{key:"practice",label:"ç·´ç¿’",icon:E},{key:"game",label:"å°æˆ°",icon:"âš”ï¸"},{key:"bean",label:"æ”¶æ”¯",icon:"ğŸ’°"},{key:"reading",label:"é–±è®€",icon:"ğŸ“–"}],b=[{key:"all",label:"å…¨éƒ¨æ™‚é–“"},{key:"today",label:"ä»Šå¤©"},{key:"week",label:"æœ¬é€±"},{key:"month",label:"æœ¬æœˆ"}],p=v("all"),x=v("all");H(g,t=>{o.fetchHistory(t)}),H(p,t=>{o.setRecordType(t)}),H(x,t=>{o.setTimeRange(t)}),le(()=>{o.fetchHistory(g.value),o.fetchStats()});function L(t){return new Date(t).toLocaleString("zh-Hant",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function q(t){return t===null?"-":`${Math.round(t*100)}%`}function I(t){if(t<60)return`${t} ç§’`;const u=Math.floor(t/60),e=t%60;return e>0?`${u} åˆ† ${e} ç§’`:`${u} åˆ†é˜`}function O(t){return t>0?`+${t}`:t.toString()}function z(t){switch(t.type){case"practice":return{icon:E,color:"primary"};case"game":return t.is_winner?{icon:"ğŸ†",color:"warning"}:{icon:"âš”ï¸",color:"neutral"};case"bean":return t.amount>0?{icon:"ğŸ’°",color:"success"}:{icon:"ğŸ’¸",color:"error"};case"reading":return t.is_completed?{icon:"âœ…",color:"success"}:{icon:"ğŸ“–",color:"primary"};default:return{icon:"ğŸ“‹",color:"neutral"}}}function C(t){switch(t.type){case"practice":return t.text?.title||"ç·´ç¿’";case"game":return t.text?.title||"å°æˆ°";case"bean":return ge(t.transaction_type);case"reading":return t.text?.title||"é–±è®€";default:return"è¨˜éŒ„"}}const N=$(()=>{const t=o.stats;return t?[{label:"ç·´ç¿’æ¬¡æ•¸",value:t.totalPractices,icon:E,subLabel:`æœ¬é€± ${t.weeklyPractices}`,color:"primary"},{label:"å°æˆ°å ´æ•¸",value:t.totalGames,icon:"âš”ï¸",subLabel:`å‹ ${t.totalWins}`,color:"warning"},{label:"ç²å¾—è±†å­",value:t.totalBeansEarned,icon:"ğŸ’°",subLabel:`æ¶ˆè€— ${t.totalBeansSpent}`,color:"success"},{label:"é–±è®€æ–‡ç« ",value:t.totalReadings,icon:"ğŸ“–",subLabel:`å®Œæˆ ${t.completedReadings}`,color:"info"}]:[]});return(t,u)=>(n(),l("div",ye,[R(o).stats?(n(),l("section",ve,[(n(!0),l(A,null,B(N.value,e=>(n(),l("div",{key:e.label,class:D(["stat-card edamame-glass",`stat-${e.color}`])},[r("span",he,[e.icon===E?(n(),M(P,{key:0,size:28})):(n(),l(A,{key:1},[k(c(e.icon),1)],64))]),r("div",be,[r("p",ke,c(e.value),1),r("p",we,c(e.label),1),r("p",xe,c(e.subLabel),1)])],2))),128))])):S("",!0),r("section",Se,[r("div",Re,[(n(),l(A,null,B(w,e=>r("button",{key:e.key,class:D(["tab-btn",{active:p.value===e.key}]),onClick:j=>p.value=e.key},[r("span",Te,[e.icon===E?(n(),M(P,{key:0,size:16})):(n(),l(A,{key:1},[k(c(e.icon),1)],64))]),r("span",De,c(e.label),1)],10,Ae)),64))]),r("div",Ie,[r("div",Ee,[W(r("select",{"onUpdate:modelValue":u[0]||(u[0]=e=>x.value=e)},[(n(),l(A,null,B(b,e=>r("option",{key:e.key,value:e.key},c(e.label),9,Le)),64))],512),[[Y,x.value]])]),r("div",qe,[r("label",null,[u[2]||(u[2]=k(" é¡¯ç¤º ",-1)),W(r("select",{"onUpdate:modelValue":u[1]||(u[1]=e=>g.value=e)},[(n(!0),l(A,null,B(R(o).getLimitOptions(),e=>(n(),l("option",{key:e,value:e},c(e),9,ze))),128))],512),[[Y,g.value,void 0,{number:!0}]]),u[3]||(u[3]=k(" ç­† ",-1))])])])]),r("section",Be,[R(o).isLoading?(n(),l("div",$e,[...u[4]||(u[4]=[r("span",{class:"loading-spinner"},null,-1),k(" è¼‰å…¥æ­·å²ç´€éŒ„ä¸­... ",-1)])])):R(o).error?(n(),l("div",Pe,c(R(o).error),1)):R(o).entries.length?(n(),l("ul",Ce,[(n(!0),l(A,null,B(R(o).entries,e=>(n(),l("li",{key:e.id,class:D(["timeline-item",`type-${e.type}`])},[r("div",{class:D(["timeline-dot",z(e).color])},[z(e).icon===E?(n(),M(P,{key:0,size:14})):(n(),l(A,{key:1},[k(c(z(e).icon),1)],64))],2),r("div",Ne,[r("div",Fe,[r("strong",He,c(C(e)),1),r("span",Me,c(L(e.created_at)),1)]),e.type==="practice"?(n(),l("div",je,[r("span",Ge,[J(P,{size:14,class:"detail-icon"}),k(" "+c(e.score)+" è±† ",1)]),r("span",Ve,[u[7]||(u[7]=r("span",{class:"detail-icon"},"ğŸ¯",-1)),k(" "+c(q(e.accuracy)),1)]),r("span",Ue,[r("span",We,[J(R(_e),{size:14,"stroke-width":1.5})]),k(" "+c(e.elapsed_seconds)+" ç§’ ",1)]),e.text?.category_name?(n(),l("span",Ye,c(e.text.category_name),1)):S("",!0)])):e.type==="game"?(n(),l("div",Je,[r("span",{class:D(["detail-item result",e.is_winner?"win":"lose"])},c(e.is_winner?"ğŸ† ç²å‹":"ğŸ’ª æƒœæ•—"),3),r("span",Ke,c(e.game_mode==="pvp"?"PK ç«¶æŠ€":"èª²å ‚é¬¥è±†"),1),r("span",Qe,c(e.score)+" åˆ† ",1),e.prize_won>0?(n(),l("span",Xe," +"+c(e.prize_won)+" è±† ",1)):S("",!0),e.fee_paid>0?(n(),l("span",Ze," å…¥å ´ "+c(e.fee_paid)+" è±† ",1)):S("",!0)])):e.type==="bean"?(n(),l("div",et,[r("span",{class:D(["detail-item amount",e.amount>0?"positive":"negative"])},c(O(e.amount))+" è±† ",3),e.balance_after!==null?(n(),l("span",tt," é¤˜é¡ "+c(e.balance_after)+" è±† ",1)):S("",!0),e.description?(n(),l("span",at,c(e.description),1)):S("",!0)])):e.type==="reading"?(n(),l("div",st,[r("span",{class:D(["detail-item status",e.is_completed?"completed":""])},c(e.is_completed?"âœ… å·²å®Œæˆ":`ğŸ“– ${e.progress}%`),3),e.text?.author?(n(),l("span",rt,c(e.text.author),1)):S("",!0),r("span",ot," é–±è®€ "+c(e.read_count)+" æ¬¡ ",1),r("span",it,c(I(e.read_duration)),1)])):S("",!0)])],2))),128))])):(n(),l("div",Oe,[u[5]||(u[5]=r("span",{class:"empty-icon"},"ğŸ“­",-1)),r("p",null,"å°šæœªæœ‰ä»»ä½•"+c(p.value==="all"?"":w.find(e=>e.key===p.value)?.label)+"ç´€éŒ„",1),u[6]||(u[6]=r("p",{class:"empty-hint"},"è¶•å¿«é–‹å§‹ç¬¬ä¸€æ¬¡æŒ‘æˆ°å§ï¼",-1))]))])]))}}),ft=de(nt,[["__scopeId","data-v-40ca306b"]]);export{ft as default};
