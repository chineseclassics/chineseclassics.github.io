import{d as ee,u as te,c as i,x as se,r as C,w as ae,f as ne,a as u,g as s,h as v,t as n,b as p,e as re,F as I,j as P,s as T,k as le,n as E,l as oe,i as x,m as ue,o as l,_ as ie}from"./index-58xMK0we.js";import{u as ce}from"./gameStore-CP5rP7Bc.js";import{u as ve}from"./userStatsStore-B8CxTXvd.js";import{g as de,c as U,d as j}from"./game-DlkGF0Ko.js";import{B as me}from"./BeanIcon-P6e1Ec1Z.js";import{T as pe}from"./TeamBadge-Bi2iT5zQ.js";const _e={class:"result-header"},ge={class:"result-icon"},fe={class:"bean-sign"},he={key:0,class:"bean-note"},ke={key:0,class:"ranking-section"},ye={class:"ranking-list"},be=["src","alt"],we={key:1,class:"avatar-placeholder"},Se={class:"name"},Be={class:"score"},Ce={class:"accuracy"},Te={class:"time"},xe={key:1,class:"streak-card"},Ae={class:"streak-text"},Re={key:2,class:"answers-section"},Me={key:0,class:"result-tabs"},Ie=["onClick"],Pe={class:"tab-number"},Ve={class:"tab-title"},ze={class:"tab-stats"},Fe={key:1,class:"answer-detail"},Ne={class:"answer-header"},De={key:0,class:"answer-author"},$e={class:"answer-stats"},Ge={class:"stat correct"},Le={class:"stat wrong"},Oe={class:"stat missed"},qe={class:"answer-content"},Ee={class:"answer-line"},Ue={class:"answer-char"},je={key:3,class:"ranking-section"},Je={class:"team-ranking-list"},We={class:"rank"},He={class:"team-name"},Ke={class:"team-score"},Qe={class:"rank-title-section"},Xe={class:"level-text"},Ye=ee({__name:"GameResult",setup(Ze){const V=oe(),J=se(),h=ce(),A=te(),z=ve(),R=i(()=>J.params.roomId),o=i(()=>h.currentRoom),k=i(()=>h.myParticipant),W=i(()=>o.value?.participants||[]),F=i(()=>o.value?.teams||[]),d=C(null),M=C(0),c=i(()=>{if(!d.value)return null;const a=d.value.texts[M.value],e=d.value.results[M.value];return!a||!e?null:{text:a,result:e}});function N(a){const e=[];for(const t of a)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function D(a){if(!c.value?.result)return"none";const e=c.value.result,t=e.userBreaks.includes(a),r=e.correctBreaks.includes(a);return t&&r?"correct":t&&!r?"wrong":!t&&r?"missed":"none"}const _=i(()=>{if(!o.value||!A.user)return!1;if(o.value.game_mode==="team_battle")return k.value?.team_id===o.value.winner_team_id;{if(o.value.winner_user_id)return o.value.winner_user_id===A.user.id;if(!o.value.participants)return!1;const a=k.value?.score??0,e=k.value?.time_spent??999999,t=Math.max(...o.value.participants.map(m=>m.score)),r=o.value.participants.filter(m=>m.score===t),w=Math.min(...r.map(m=>m.time_spent??999999));return a===t&&e===w}}),y=i(()=>!o.value||o.value.game_mode==="team_battle"?!1:!o.value.winner_user_id&&_.value),H=i(()=>o.value?.participants?[...o.value.participants].sort((a,e)=>e.score-a.score).map((a,e)=>({...a,rank:e+1})):[]),K=i(()=>F.value.length?F.value.map(a=>{const e=W.value.filter(S=>S.team_id===a.id),t=e.reduce((S,B)=>S+(B.score||0),0),r=e.length>0?t/e.length:0,m=(typeof a.total_score=="number"?a.total_score/100:0)||r;return{...a,averageScore:m}}).sort((a,e)=>e.averageScore-a.averageScore):[]),$=i(()=>z.level),G=i(()=>de($.value)),L=i(()=>z.profile?.pvp_win_streak??0),O=C(!1),b=C(0),g=C(!1),f=i(()=>{if(!k.value||!o.value)return{amount:0,type:"neutral"};const a=k.value.fee_paid||o.value.entry_fee||0,e=o.value.participants?.length||0;return y.value?{amount:0,type:"tie"}:_.value&&a>0?{amount:a*e,type:"win"}:!_.value&&a>0?{amount:-a,type:"lose"}:{amount:0,type:"neutral"}});function Q(){const a=Math.abs(f.value.amount),e=f.value.type;if(a===0&&e!=="tie"){g.value=!0;return}O.value=!0,b.value=0,g.value=!1;const t=2500,r=Date.now(),w=a>0?a:100;function m(){const S=Date.now()-r,B=Math.min(S/t,1);if(B<1){if(B<.8)b.value=Math.floor(Math.random()*w*1.5);else{const q=(B-.8)/.2;b.value=Math.floor(a*q+Math.random()*(a*(1-q)))}requestAnimationFrame(m)}else b.value=a,g.value=!0}setTimeout(()=>{requestAnimationFrame(m)},500)}function X(a){d.value&&a>=0&&a<d.value.texts.length&&(M.value=a)}function Y(){h.reset(),sessionStorage.removeItem(`game-result-${R.value}`),V.push({name:"arena"})}function Z(){h.reset(),sessionStorage.removeItem(`game-result-${R.value}`),A.isTeacher?V.push({name:"arena-teacher-create"}):V.push({name:"arena-create"})}return ae(()=>o.value?.status,a=>{}),ne(()=>{h.subscribeToRoom(R.value),z.fetchProfile();const a=sessionStorage.getItem(`game-result-${R.value}`);if(a)try{d.value=JSON.parse(a)}catch{}Q()}),(a,e)=>(l(),u("div",{class:p(["game-result",{winner:_.value,tie:y.value}])},[s("header",_e,[s("div",ge,n(y.value?"ğŸ¤":_.value?"ğŸ†":"ğŸ’ª"),1),s("h1",null,n(y.value?"å¹³å±€ï¼":_.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),O.value||f.value.type!=="neutral"?(l(),u("div",{key:0,class:p(["bean-change-display",[f.value.type,{complete:g.value}]])},[s("span",fe,n(f.value.type==="lose"?"-":f.value.type==="win"?"+":""),1),s("span",{class:p(["bean-number",{rolling:!g.value}])},n(b.value),3),re(me,{size:40,class:"bean-icon-img"}),y.value&&g.value?(l(),u("span",he,"å…¥å ´è²»å·²é€€é‚„")):v("",!0)],2)):v("",!0)]),o.value?.game_mode==="pvp"?(l(),u("section",ke,[e[0]||(e[0]=s("h2",null,"æ’è¡Œæ¦œ",-1)),s("div",ye,[(l(!0),u(I,null,P(H.value,t=>(l(),u("div",{key:t.id,class:p(["ranking-item",{me:t.user_id===x(A).user?.id,top:t.rank<=3}])},[s("span",{class:p(["rank",`rank-${t.rank}`])},n(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(l(),u("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,be)):(l(),u("span",we,n(t.user?.display_name?.charAt(0)||"?"),1)),s("span",Se,n(t.user?.display_name||"æœªçŸ¥"),1),s("span",Be,n(t.score)+" åˆ†",1),s("span",Ce,n(t.accuracy?.toFixed(0)||0)+"%",1),s("span",Te,n(t.time_spent)+"s",1)],2))),128))])])):v("",!0),L.value>0&&_.value?(l(),u("div",xe,[e[3]||(e[3]=s("span",{class:"streak-icon"},"ğŸ”¥",-1)),s("span",Ae,[e[1]||(e[1]=T(" é€£å‹ ",-1)),s("strong",null,n(L.value),1),e[2]||(e[2]=T(" å ´ï¼ ",-1))])])):v("",!0),d.value?(l(),u("section",Re,[e[9]||(e[9]=s("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),d.value.texts.length>1?(l(),u("div",Me,[(l(!0),u(I,null,P(d.value.texts,(t,r)=>(l(),u("button",{key:t.id,class:p(["result-tab",{active:r===M.value}]),onClick:w=>X(r)},[s("span",Pe,n(r+1),1),s("span",Ve,n(t.title),1),s("span",ze," âœ“"+n(d.value.results[r]?.correctCount||0),1)],10,Ie))),128))])):v("",!0),c.value&&c.value.text&&c.value.result?(l(),u("div",Fe,[s("div",Ne,[s("h3",null,n(c.value.text.title),1),c.value.text.author?(l(),u("span",De,n(c.value.text.author),1)):v("",!0)]),s("div",$e,[s("span",Ge,[e[4]||(e[4]=s("span",{class:"bean-legend correct"},null,-1)),T(" æ­£ç¢º "+n(c.value.result.correctCount),1)]),s("span",Le,[e[5]||(e[5]=s("span",{class:"bean-legend wrong"},null,-1)),T(" éŒ¯èª¤ "+n(c.value.result.wrongCount),1)]),s("span",Oe,[e[6]||(e[6]=s("span",{class:"bean-legend missed"},null,-1)),T(" éºæ¼ "+n(c.value.result.missedCount),1)])]),s("div",qe,[s("div",Ee,[(l(!0),u(I,null,P(N(c.value.text.content),(t,r)=>(l(),u("span",{key:r,class:"char-unit"},[s("span",Ue,n(t),1),r<N(c.value.text.content).length-1&&D(r)!=="none"?(l(),u("span",{key:0,class:p(["bean-slot",D(r)])},[...e[7]||(e[7]=[s("span",{class:"bean"},null,-1)])],2)):v("",!0)]))),128))])]),e[8]||(e[8]=le('<div class="answer-legend" data-v-45f48d9b><span class="legend-item" data-v-45f48d9b><span class="bean-legend correct" data-v-45f48d9b></span> æ­£ç¢º </span><span class="legend-item" data-v-45f48d9b><span class="bean-legend wrong" data-v-45f48d9b></span> éŒ¯èª¤ </span><span class="legend-item" data-v-45f48d9b><span class="bean-legend missed" data-v-45f48d9b></span> éºæ¼ </span></div>',1))])):v("",!0)])):v("",!0),o.value?.game_mode==="team_battle"?(l(),u("section",je,[e[10]||(e[10]=s("h2",null,"éšŠä¼æ’è¡Œ",-1)),s("div",Je,[(l(!0),u(I,null,P(K.value,(t,r)=>(l(),u("div",{key:t.id,class:p(["team-ranking-item",{winner:r===0}]),style:E({"--team-primary":x(U)[t.team_color].primary,"--team-secondary":x(U)[t.team_color].secondary})},[s("span",We,n(r===0?"ğŸ†":r+1),1),x(j)(t)?(l(),ue(pe,{key:0,"product-type":x(j)(t),size:36,class:"team-badge-in-ranking"},null,8,["product-type"])):v("",!0),s("span",He,n(t.team_name),1),s("span",Ke,n(t.averageScore.toFixed(2))+" åˆ†",1)],6))),128))])])):v("",!0),s("section",Qe,[e[11]||(e[11]=s("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),s("div",{class:"rank-title-display",style:E({color:G.value.color})},n(G.value.title),5),s("p",Xe,"Lv."+n($.value),1)]),s("footer",{class:"result-footer"},[s("button",{class:"btn-secondary",onClick:Y}," è¿”å›é¬¥è±† "),s("button",{class:"btn-primary",onClick:Z}," å†ä¾†ä¸€å±€ ")])],2))}}),lt=ie(Ye,[["__scopeId","data-v-45f48d9b"]]);export{lt as default};
