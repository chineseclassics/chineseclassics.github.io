import{C as se,u as re,r as b,m as U,P as r}from"./index-0RstLS6o.js";const ce=se("class",()=>{const u=re(),m=b([]),L=b(null),S=b([]),C=b([]),A=b([]),o=b(!1),s=b(null),$=/^[a-zA-Z0-9._-]+@student\.isf\.edu\.hk$/i,O=["gnoluy@gmail.com"],z=U(()=>m.value),G=U(()=>m.value.filter(a=>a.is_active));async function W(a,e){if(!r||!u.user)return s.value="請先登入",null;if(!u.isTeacher)return s.value="只有老師可以創建班級",null;o.value=!0,s.value=null;try{const{data:t,error:n}=await r.from("classes").insert({teacher_id:u.user.id,class_name:a,description:e||null}).select().single();return n?(s.value=n.message,null):(m.value.push(t),t)}catch(t){return s.value=t.message,null}finally{o.value=!1}}async function B(){if(!(!r||!u.user)){o.value=!0,s.value=null;try{const{data:a,error:e}=await r.from("classes").select(`
          *,
          member_count:class_members(count)
        `).eq("teacher_id",u.user.id).order("created_at",{ascending:!1});if(e){s.value=e.message;return}m.value=(a||[]).map(t=>({...t,member_count:t.member_count?.[0]?.count||0}))}catch(a){s.value=a.message}finally{o.value=!1}}}async function N(a){if(r){o.value=!0,s.value=null;try{const{data:e,error:t}=await r.from("class_members").select(`
          *,
          student:users!class_members_student_id_fkey (
            id,
            email,
            display_name,
            avatar_url
          )
        `).eq("class_id",a).order("added_at",{ascending:!1});if(t){s.value=t.message;return}if(!e||e.length===0){S.value=[];return}const n=e.map(_=>_.student_id).filter(_=>_!==null);let f=new Map;if(n.length>0){const{data:_,error:v}=await r.from("profiles").select("id, current_avatar_id").in("id",n);!v&&_&&_.forEach(g=>{f.set(g.id,{current_avatar_id:g.current_avatar_id})})}S.value=e.map(_=>{const v=f.get(_.student_id);return{..._,student:_.student?{..._.student,profiles:v?{current_avatar_id:v.current_avatar_id}:null}:null}})}catch(e){s.value=e.message}finally{o.value=!1}}}async function X(a,e){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{data:t,error:n}=await r.from("users").select("id").eq("email",e).single();if(n||!t)return s.value="找不到該學生，請確認郵箱正確且學生已登入過",!1;const{error:f}=await r.from("class_members").insert({class_id:a,student_id:t.id,added_by:u.user?.id});return f?(f.code==="23505"?s.value="該學生已在班級中":s.value=f.message,!1):(await N(a),!0)}catch(t){return s.value=t.message,!1}finally{o.value=!1}}async function Z(a,e){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{error:t}=await r.from("class_members").delete().eq("class_id",a).eq("student_id",e);return t?(s.value=t.message,!1):(S.value=S.value.filter(n=>!(n.class_id===a&&n.student_id===e)),!0)}catch(t){return s.value=t.message,!1}finally{o.value=!1}}function j(a){return a?a.split(/[\n,;]/).map(e=>e.trim().toLowerCase()).filter(e=>e!==""):[]}function F(a){const e=[],t=[];return a.forEach(n=>{const f=O.includes(n.toLowerCase());$.test(n)||f?e.push(n):t.push(n)}),{validEmails:e,invalidEmails:t}}async function H(a,e){if(!r||!u.isTeacher||!u.user)throw new Error("無權限");const t=j(e),{validEmails:n,invalidEmails:f}=F(t);if(n.length===0)throw new Error("沒有有效的學生郵箱地址。請使用 @student.isf.edu.hk 格式");const{data:_}=await r.from("class_members").select("student:users!class_members_student_id_fkey(email)").eq("class_id",a),{data:v}=await r.from("pending_students").select("email").eq("class_id",a),g=new Set([..._?.map(d=>d.student?.email).filter(Boolean)||[],...v?.map(d=>d.email)||[]]),D=n.filter(d=>g.has(d)),M=n.filter(d=>!g.has(d));let k=0;for(const d of M)try{const{error:y}=await r.from("pending_students").insert({class_id:a,email:d,added_by:u.user.id});if(y){y.code==="23505"?console.log(`郵箱 ${d} 已在待加入列表中`):console.warn(`添加郵箱 ${d} 失敗:`,y);continue}k++}catch(y){console.warn(`處理郵箱 ${d} 時出錯:`,y)}return{validEmails:n.length,invalidEmails:f.length,duplicates:D.length,added:k,invalidList:f}}async function I(a){if(r)try{const{data:e,error:t}=await r.from("pending_students").select("*").eq("class_id",a).order("added_at",{ascending:!1});if(t){console.error("獲取待激活學生失敗:",t);return}C.value=e||[]}catch(e){console.error("獲取待激活學生失敗:",e)}}async function J(a){if(!r||!u.isTeacher)return s.value="無權限",!1;try{const{error:e}=await r.from("pending_students").delete().eq("id",a);return e?(s.value=e.message,!1):(C.value=C.value.filter(t=>t.id!==a),!0)}catch(e){return s.value=e.message,!1}}function K(a){return Math.max(1,Math.floor(a/100)+1)}async function Q(a){if(!(!r||!u.isTeacher)){o.value=!0,s.value=null;try{const{data:e}=await r.from("class_members").select("student_id").eq("class_id",a);if(!e||e.length===0){A.value=[];return}const t=e.map(l=>l.student_id),{data:n}=await r.from("users").select("id, display_name, email, avatar_url").in("id",t);if(!n||n.length===0){A.value=[];return}const{data:f}=await r.from("profiles").select("id, total_beans, streak_days, last_practice_date, current_avatar_id").in("id",t),_=new Date(Date.now()-10080*60*1e3).toISOString(),{data:v,error:g}=await r.from("practice_records").select("user_id, correct_breaks, created_at, accuracy, text_id").in("user_id",t);g&&console.error("獲取練習記錄失敗:",g);const{data:D}=await r.from("game_participants").select("user_id, accuracy").in("user_id",t).eq("status","completed").not("accuracy","is",null),M=new Map;t.forEach(l=>{M.set(l,{total_practices:0,weekly_practices:0,unique_texts_practiced:0,correct_count:0,last_practice_at:null})});const k=(v||[]).filter(l=>l.user_id&&t.includes(l.user_id));if(k.length>0){const l=new Map;k.forEach(i=>{i.user_id&&(l.has(i.user_id)||l.set(i.user_id,[]),l.get(i.user_id).push(i))}),l.forEach((i,c)=>{const x=i.length,T=i.reduce((p,q)=>p+(q.correct_breaks||0),0),h=new Date(_).getTime(),w=i.filter(p=>{if(!p.created_at)return!1;try{return new Date(p.created_at).getTime()>=h}catch{return!1}}).length,E=new Set;i.forEach(p=>{if(p.text_id){const q=String(p.text_id).trim();q&&E.add(q)}});const P=E.size,ae=[...i].sort((p,q)=>new Date(q.created_at).getTime()-new Date(p.created_at).getTime())[0]?.created_at||null;M.set(c,{total_practices:x,weekly_practices:w,unique_texts_practiced:P,correct_count:T,last_practice_at:ae})})}const d=new Map;if(t.forEach(l=>{d.set(l,0)}),v){const l=new Map;v.forEach(c=>{!c.user_id||c.accuracy===null||(l.has(c.user_id)||l.set(c.user_id,[]),l.get(c.user_id).push(Number(c.accuracy)*100))});const i=new Map;D&&D.forEach(c=>{!c.user_id||c.accuracy===null||(i.has(c.user_id)||i.set(c.user_id,[]),i.get(c.user_id).push(Number(c.accuracy)))}),t.forEach(c=>{const x=l.get(c)||[],T=i.get(c)||[],h=[...x,...T];if(h.length>0){const w=h.reduce((E,P)=>E+P,0)/h.length;d.set(c,Math.round(w))}})}const y=n.map(l=>{const i=f?.find(E=>E.id===l.id),c=M.get(l.id)||{total_practices:0,weekly_practices:0,unique_texts_practiced:0,correct_count:0,last_practice_at:null},x=d.get(l.id)||0,T=i?.total_beans||0,h=c.last_practice_at||(i?.last_practice_date?new Date(i.last_practice_date).toISOString():null);let w=null;return h?w=Math.floor((Date.now()-new Date(h).getTime())/864e5):c.total_practices===0&&(w=null),{student_id:l.id,display_name:l.display_name||l.email?.split("@")[0]||"未知",email:l.email||"",avatar_url:l.avatar_url,current_avatar_id:i?.current_avatar_id||null,beans:i?.total_beans||0,total_exp:T,total_practices:c.total_practices,weekly_practices:c.weekly_practices,unique_texts_practiced:c.unique_texts_practiced,correct_count:c.correct_count,streak_days:i?.streak_days||0,last_practice_at:h,level:K(T),average_accuracy:x,last_practice_days_ago:w}});A.value=y.sort((l,i)=>i.beans-l.beans)}catch(e){console.error("獲取學生進度失敗:",e),s.value=e.message}finally{o.value=!1}}}async function V(a,e){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{error:t}=await r.from("classes").update(e).eq("id",a).eq("teacher_id",u.user?.id);if(t)return s.value=t.message,!1;const n=m.value.findIndex(f=>f.id===a);return n!==-1&&(m.value[n]={...m.value[n],...e}),!0}catch(t){return s.value=t.message,!1}finally{o.value=!1}}async function Y(a){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{error:e}=await r.from("classes").delete().eq("id",a).eq("teacher_id",u.user?.id);return e?(s.value=e.message,!1):(m.value=m.value.filter(t=>t.id!==a),!0)}catch(e){return s.value=e.message,!1}finally{o.value=!1}}async function R(){if(!(!r||!u.user)){o.value=!0,s.value=null;try{const{data:a,error:e}=await r.from("class_members").select(`
          class:classes (
            id,
            teacher_id,
            class_name,
            description,
            created_at,
            is_active,
            teacher:users!classes_teacher_id_fkey (
              display_name
            )
          )
        `).eq("student_id",u.user.id);if(e){s.value=e.message;return}m.value=(a||[]).map(t=>t.class).filter(t=>t!==null)}catch(a){s.value=a.message}finally{o.value=!1}}}async function ee(){u.isTeacher?await B():await R()}function te(){m.value=[],L.value=null,S.value=[],s.value=null}return{classes:m,currentClass:L,classMembers:S,pendingStudents:C,studentProgress:A,loading:o,error:s,myClasses:z,activeClasses:G,createClass:W,fetchMyClasses:B,fetchClassMembers:N,addStudentByEmail:X,removeStudent:Z,updateClass:V,deleteClass:Y,batchAddStudents:H,fetchPendingStudents:I,removePendingStudent:J,fetchStudentProgress:Q,fetchStudentClasses:R,fetchClasses:ee,reset:te}});export{ce as u};
