import{v as M,u as O,r as f,c as m,H as s}from"./index-GVSkEnx4.js";const i=[0,100,300,600,1e3,1500,2200,3e3,4e3,5200,6600,8200,1e4,12e3,15e3],B=M("userStats",()=>{const c=O(),a=f(null),g=f(!1),o=f(null),v=f(null),p=f([]),y=f(!1),w=m(()=>{if(!a.value)return 1;const e=a.value.total_exp;for(let t=i.length-1;t>=0;t--){const r=i[t];if(r!==void 0&&e>=r)return t+1}return 1}),x=m(()=>{if(!a.value)return 0;const e=w.value,t=i[e-1]||0,r=i[e]||t+1e3,n=a.value.total_exp-t,l=r-t;return Math.min(100,Math.round(n/l*100))}),S=m(()=>{if(!a.value)return 100;const e=w.value,t=i[i.length-1]??15e3,r=i[e]??t+1e3;return Math.max(0,r-a.value.total_exp)}),b=m(()=>!a.value||a.value.total_practices===0?0:Math.round(a.value.correct_count/a.value.total_practices*100));async function I(){if(!(!s||!c.user)){g.value=!0,o.value=null;try{const{data:e,error:t}=await s.from("user_stats").select("*").eq("user_id",c.user.id).single();if(t){if(t.code==="PGRST116"){await E();return}throw t}a.value=e}catch(e){o.value=e.message,console.error("獲取用戶統計失敗:",e)}finally{g.value=!1}}}async function E(){if(!(!s||!c.user))try{const{data:e,error:t}=await s.from("user_stats").insert({user_id:c.user.id,beans:0,total_exp:0,total_practices:0,correct_count:0,streak_days:0}).select().single();if(t)throw t;a.value=e}catch(e){o.value=e.message,console.error("創建用戶統計失敗:",e)}}async function k(e){if(!s||!a.value)return!1;try{const t=a.value.beans+e,{error:r}=await s.from("user_stats").update({beans:t,updated_at:new Date().toISOString()}).eq("user_id",a.value.user_id);if(r)throw r;return a.value.beans=t,!0}catch(t){return o.value=t.message,!1}}async function D(e){if(!s||!a.value)return!1;try{const t=a.value.total_exp+e,{error:r}=await s.from("user_stats").update({total_exp:t,updated_at:new Date().toISOString()}).eq("user_id",a.value.user_id);if(r)throw r;return a.value.total_exp=t,!0}catch(t){return o.value=t.message,!1}}async function L(e,t,r){if(!s||!a.value)return!1;try{const n={beans:a.value.beans+t,total_exp:a.value.total_exp+r,total_practices:a.value.total_practices+1,correct_count:a.value.correct_count+(e?1:0),last_practice_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:l}=await s.from("user_stats").update(n).eq("user_id",a.value.user_id);if(l)throw l;return a.value.beans=n.beans,a.value.total_exp=n.total_exp,a.value.total_practices=n.total_practices,a.value.correct_count=n.correct_count,a.value.last_practice_at=n.last_practice_at,!0}catch(n){return o.value=n.message,!1}}async function T(){if(s){y.value=!0;try{const{data:e,error:t}=await s.from("user_stats").select("user_id, beans").order("beans",{ascending:!1}).limit(10);if(t)throw t;if(!e||e.length===0){p.value=[];return}const r=e.map(u=>u.user_id),{data:n}=await s.from("users").select("id, display_name").in("id",r),l=new Map((n||[]).map(u=>[u.id,u.display_name||"匿名"])),h=c.user?.id;p.value=e.map((u,d)=>({rank:d+1,userId:u.user_id,name:l.get(u.user_id)||"匿名",beans:u.beans,isCurrentUser:u.user_id===h}))}catch(e){console.error("獲取前 10 名失敗:",e),p.value=[]}finally{y.value=!1}}}async function U(){if(!(!s||!c.user))try{const{data:e,error:t}=await s.from("user_stats").select("user_id, beans").order("beans",{ascending:!1});if(t)throw t;if(!e||e.length===0){v.value=null;return}const r=e.findIndex(_=>_.user_id===c.user.id),n=r===-1?e.length+1:r+1,l=a.value?.beans??0;let h=null;if(e.length>0&&e[0]){const{data:_}=await s.from("users").select("display_name").eq("id",e[0].user_id).single();h={name:_?.display_name||"匿名",beans:e[0].beans}}let u=null;const d=r>0?e[r-1]:null;if(n>1&&d){const{data:_}=await s.from("users").select("display_name").eq("id",d.user_id).single();u={name:_?.display_name||"匿名",beans:d.beans,gap:d.beans-l}}v.value={rank:n,totalUsers:e.length,topUser:h,nextUser:u}}catch(e){console.error("獲取排名信息失敗:",e)}}function q(){a.value=null,v.value=null,o.value=null}return{stats:a,loading:g,error:o,rankInfo:v,top10:p,top10Loading:y,level:w,levelProgress:x,expToNextLevel:S,accuracy:b,fetchStats:I,fetchRankInfo:U,fetchTop10:T,addBeans:k,addExp:D,recordPractice:L,reset:q}});export{B as u};
