import{d as de,u as ce,c as b,x as me,r as v,K as ve,f as pe,a as o,g as e,m as J,t as i,i as S,s as H,h,F as B,j as O,H as x,I as w,L as E,e as Q,p as W,T as X,M as Y,b as P,G as F,o as n,_ as ye}from"./index-D3NuB_Em.js";import{u as fe}from"./textsStore-CYpovrkU.js";import{u as be}from"./practiceLibraryStore-CtAnIcG3.js";import"./useSupabase-DxQBIjgg.js";const _e={class:"admin-shell"},ge={class:"admin-header"},he={class:"edamame-text-level-detail"},ke={class:"edamame-heading-gradient"},Ce={class:"header-actions"},xe=["disabled"],we=["disabled"],Te={class:"admin-layout"},$e={class:"category-sidebar edamame-glass"},Le={key:0,class:"sidebar-loading"},Se={key:1,class:"sidebar-empty"},Ve={key:2,class:"category-tree"},Me={key:0,class:"tree-item editing"},Ae=["onClick"],De={class:"tree-label"},Ne={class:"tree-count"},Ue={class:"tree-actions"},Be=["onClick"],Ee=["onClick"],Fe={key:0,class:"add-category-inline"},Ie={class:"content-panel edamame-glass"},Ke={key:0,class:"content-empty"},He={class:"content-breadcrumb"},Oe=["onClick"],Pe={key:0,class:"breadcrumb-sep"},je={class:"category-info"},Ge={key:0,class:"category-desc"},ze={class:"category-meta"},Re={class:"text-list"},qe={key:0,class:"text-empty"},Je={key:1},Qe={class:"text-title"},We={key:0,class:"text-type-badge system"},Xe={key:1,class:"text-type-badge private"},Ye={class:"text-summary"},Ze={class:"actions"},et=["onClick"],tt=["onClick"],at={class:"modal-card edamame-glass"},st={class:"modal-body"},lt={class:"form-context"},nt={class:"form-row"},ot={class:"preview-panel"},it=["innerHTML"],ut={key:0,class:"feedback"},rt=["disabled"],dt={class:"modal-card edamame-glass small-modal"},ct={key:0,class:"feedback"},mt={class:"confirm-actions"},vt=["disabled"],pt=de({__name:"AdminTextsPage",setup(yt){const Z=me(),u=fe(),d=be(),V=ce(),_=b(()=>Z.meta.mode==="admin"),ee=b(()=>_.value?"系統文庫":"自訂練習"),te=b(()=>_.value?"管理系統內建的練習文章":"管理我的自訂練習文章"),c=v(null),g=v(!1),T=v(!1),f=v(!1),$=v(null),L=v(null),k=v(""),M=v(!1),C=v(""),m=v(null),r=v(null),l=ve({title:"",author:"",source:"",summary:"",content:""}),A=b(()=>d.state.categories.filter(a=>a.level!==1?!1:_.value?a.is_system===!0:a.is_system===!1&&a.created_by===V.user?.id).sort((a,t)=>a.order_index-t.order_index)),p=b(()=>d.state.categories.find(a=>a.id===c.value)??null),D=b(()=>{if(!p.value)return[];const a=[];let t=p.value;for(;t;)a.unshift(t),t=d.state.categories.find(s=>s.id===t?.parent_id);return a}),I=b(()=>{if(!c.value)return[];let a=u.texts.filter(t=>t.category_id===c.value);return _.value?a=a.filter(t=>t.is_system===!0):a=a.filter(t=>t.is_system===!1&&t.created_by===V.user?.id),a.sort((t,s)=>(s.created_at??"").localeCompare(t.created_at??""))}),ae=b(()=>{if(!l.content)return"";let a=l.content.replace(/[「」『』"""'']/g,"");return a=a.replace(/[。！？；，：、]/g,"|"),a=a.replace(/\|{2,}/g,"|"),a=a.replace(/^\|+|\|+$/g,""),a.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function se(a){return _.value?u.texts.filter(t=>t.category_id===a&&t.is_system===!0).length:u.texts.filter(t=>t.category_id===a&&t.is_system===!1&&t.created_by===V.user?.id).length}function j(a){c.value=a}function K(){$.value=null,l.title="",l.author="",l.source="",l.summary="",l.content="",r.value=null,g.value=!0}function le(a){$.value=a.id,l.title=a.title,l.author=a.author??"",l.source=a.source??"",l.summary=a.summary??"",l.content=a.content,r.value=null,g.value=!0}async function ne(){if(!l.title||!l.content){r.value="標題與內容為必填";return}if(!c.value){r.value="請先選擇一個分類";return}const a=p.value;if(!a||a.level!==1){r.value="請選擇一個年級來新增文章";return}try{f.value=!0;const t={title:l.title,author:l.author||null,source:l.source||null,summary:l.summary||null,category_id:c.value,content:l.content};$.value?await u.updateText($.value,t):await u.addText(t,_.value),await u.fetchTexts(),g.value=!1}catch(t){r.value=t?.message??"儲存失敗"}finally{f.value=!1}}function oe(a){L.value=a.id,k.value=a.name}function N(){L.value=null,k.value=""}async function G(){if(!L.value||!k.value.trim()){N();return}try{await d.updateCategory(L.value,{name:k.value.trim()}),N()}catch(a){alert(a?.message??"更新失敗")}}function z(){M.value=!0,C.value=""}function U(){M.value=!1,C.value=""}async function R(){if(!C.value.trim()){U();return}try{await d.addCategory({name:C.value.trim(),parent_id:null,type:"grade",is_system:_.value},V.user?.id),U()}catch(a){alert(a?.message??"新增失敗")}}function q(a,t){m.value={type:a,item:t},r.value=null,T.value=!0}async function ie(){if(m.value)try{f.value=!0,m.value.type==="text"?(await u.deleteText(m.value.item.id),await u.fetchTexts()):(await d.deleteCategory(m.value.item.id),c.value===m.value.item.id&&(c.value=null)),T.value=!1,m.value=null}catch(a){r.value=a?.message??"刪除失敗"}finally{f.value=!1}}function ue(a){return a?a===1?"初級":a===2?"中級":"高級":"未標註"}function re(a){return a?new Date(a).toLocaleDateString():"--"}return pe(async()=>{if(d.state.categories.length||await d.fetchLibrary(),u.texts.length||await u.fetchTexts(),A.value.length>0&&!c.value){const a=A.value[0];a&&(c.value=a.id)}}),(a,t)=>(n(),o("div",_e,[e("header",ge,[e("div",null,[e("p",he,i(te.value),1),e("h1",ke,i(ee.value),1)]),e("div",Ce,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[0]||(t[0]=s=>{S(d).fetchLibrary(),S(u).fetchTexts()}),disabled:S(d).isLoading||S(u).isLoading}," 重新整理 ",8,xe),e("button",{class:"edamame-btn edamame-btn-primary",onClick:K,disabled:!p.value}," 新增練習 ",8,we)])]),e("div",Te,[e("aside",$e,[e("div",{class:"sidebar-header"},[t[13]||(t[13]=e("span",{class:"sidebar-title"},"分類導航",-1)),e("button",{class:"icon-btn",onClick:z,title:"新增年級"},[...t[12]||(t[12]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M12 5v14M5 12h14"})],-1)])])]),S(d).isLoading?(n(),o("div",Le,"載入中⋯")):!A.value.length&&!M.value?(n(),o("div",Se,[t[14]||(t[14]=H(" 尚無分類 ",-1)),e("button",{class:"link-btn",onClick:z},"建立第一個年級")])):(n(),o("nav",Ve,[(n(!0),o(B,null,O(A.value,s=>(n(),o("div",{key:s.id,class:"tree-node"},[L.value===s.id?(n(),o("div",Me,[x(e("input",{"onUpdate:modelValue":t[1]||(t[1]=y=>k.value=y),type:"text",class:"edit-input",onKeyup:[E(G,["enter"]),E(N,["escape"])]},null,544),[[w,k.value]]),e("div",{class:"edit-actions"},[e("button",{class:"action-btn",onClick:G,title:"確認"},"✓"),e("button",{class:"action-btn",onClick:N,title:"取消"},"×")])])):(n(),o("div",{key:1,class:P(["tree-item grade-item",{selected:c.value===s.id}]),onClick:y=>j(s.id)},[e("span",De,i(s.name),1),e("span",Ne,i(se(s.id)),1),e("div",Ue,[e("button",{class:"action-btn",onClick:F(y=>oe(s),["stop"]),title:"編輯"},"✎",8,Be),e("button",{class:"action-btn danger",onClick:F(y=>q("category",s),["stop"]),title:"刪除"},"×",8,Ee)])],10,Ae))]))),128)),M.value?(n(),o("div",Fe,[x(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>C.value=s),type:"text",placeholder:"輸入年級名稱...",class:"category-input",onKeyup:[E(R,["enter"]),E(U,["escape"])]},null,544),[[w,C.value]]),e("div",{class:"add-category-actions"},[e("button",{class:"action-btn",onClick:R,title:"確認"},"✓"),e("button",{class:"action-btn",onClick:U,title:"取消"},"×")])])):h("",!0)]))]),e("main",Ie,[p.value?(n(),o(B,{key:1},[e("div",He,[(n(!0),o(B,null,O(D.value,(s,y)=>(n(),o("span",{key:s.id,class:P(["breadcrumb-item",{active:y===D.value.length-1}]),onClick:ft=>j(s.id)},[H(i(s.name)+" ",1),y<D.value.length-1?(n(),o("span",Pe,"›")):h("",!0)],10,Oe))),128))]),e("div",je,[e("h2",null,i(p.value.name),1),p.value.description?(n(),o("p",Ge,i(p.value.description),1)):h("",!0),e("p",ze,i(I.value.length)+" 篇文章 ",1)]),e("div",Re,[I.value.length?(n(),o("table",Je,[t[17]||(t[17]=e("thead",null,[e("tr",null,[e("th",null,"標題"),e("th",null,"作者"),e("th",null,"難度"),e("th",null,"建立日期"),e("th",{style:{width:"120px"}},"操作")])],-1)),e("tbody",null,[(n(!0),o(B,null,O(I.value,s=>(n(),o("tr",{key:s.id},[e("td",null,[e("p",Qe,[H(i(s.title)+" ",1),s.is_system?(n(),o("span",We,"系統")):(n(),o("span",Xe,"私有"))]),e("p",Ye,i(s.summary||s.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),e("td",null,i(s.author||"佚名"),1),e("td",null,[e("span",{class:P(["difficulty-badge",`diff-${s.difficulty}`])},i(ue(s.difficulty)),3)]),e("td",null,i(re(s.created_at)),1),e("td",Ze,[e("button",{class:"ghost-btn",onClick:y=>le(s)},"編輯",8,et),e("button",{class:"ghost-btn danger",onClick:y=>q("text",s)},"刪除",8,tt)])]))),128))])])):(n(),o("div",qe,[t[16]||(t[16]=e("p",null,"此年級尚無文章",-1)),e("button",{class:"edamame-btn edamame-btn-primary",onClick:K},"新增第一篇文章")])),e("button",{class:"add-text-btn",onClick:K}," + 在「"+i(p.value.name)+"」新增文章 ",1)])],64)):(n(),o("div",Ke,[...t[15]||(t[15]=[e("p",null,"請從左側選擇一個分類",-1)])]))])]),(n(),J(Y,{to:"body"},[Q(X,{name:"fade"},{default:W(()=>[g.value?(n(),o("div",{key:0,class:"modal-backdrop",onClick:t[9]||(t[9]=F(s=>g.value=!1,["self"]))},[e("div",at,[e("header",null,[e("h3",null,i($.value?"編輯文章":"新增文章"),1),e("button",{class:"close-btn",onClick:t[3]||(t[3]=s=>g.value=!1)},"×")]),e("div",st,[e("p",lt,"將新增至："+i(D.value.map(s=>s.name).join(" › ")),1),e("label",null,[t[18]||(t[18]=e("span",null,"標題",-1)),x(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l.title=s),type:"text",placeholder:"請輸入標題"},null,512),[[w,l.title]])]),e("div",nt,[e("label",null,[t[19]||(t[19]=e("span",null,"作者",-1)),x(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>l.author=s),type:"text",placeholder:"例如：孔子"},null,512),[[w,l.author]])]),e("label",null,[t[20]||(t[20]=e("span",null,"來源",-1)),x(e("input",{"onUpdate:modelValue":t[6]||(t[6]=s=>l.source=s),type:"text",placeholder:"例如：論語"},null,512),[[w,l.source]])])]),e("label",null,[t[21]||(t[21]=e("span",null,"內容（標點將自動轉為斷句符號）",-1)),x(e("textarea",{"onUpdate:modelValue":t[7]||(t[7]=s=>l.content=s),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[w,l.content]])]),e("div",ot,[t[22]||(t[22]=e("p",null,"預覽",-1)),e("div",{class:"preview-content",innerHTML:ae.value||"尚無內容"},null,8,it)]),r.value?(n(),o("p",ut,i(r.value),1)):h("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[8]||(t[8]=s=>g.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:f.value,onClick:ne},i(f.value?"儲存中...":"儲存"),9,rt)])])])):h("",!0)]),_:1})])),(n(),J(Y,{to:"body"},[Q(X,{name:"fade"},{default:W(()=>[T.value?(n(),o("div",{key:0,class:"modal-backdrop",onClick:t[11]||(t[11]=F(s=>T.value=!1,["self"]))},[e("div",dt,[t[23]||(t[23]=e("h3",null,"確定刪除？",-1)),e("p",null,"「"+i(m.value?.item?"title"in m.value.item?m.value.item.title:m.value.item.name:"")+"」刪除後將無法復原。",1),r.value?(n(),o("p",ct,i(r.value),1)):h("",!0),e("div",mt,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[10]||(t[10]=s=>T.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-danger",disabled:f.value,onClick:ie},i(f.value?"刪除中...":"刪除"),9,vt)])])])):h("",!0)]),_:1})]))]))}}),kt=ye(pt,[["__scopeId","data-v-c216dde3"]]);export{kt as default};
