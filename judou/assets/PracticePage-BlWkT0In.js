import{d as Oe,u as Ue,r as d,c as g,q as je,o as Ge,z as Xe,a as r,b as a,e as _,t as u,m as b,k as We,A as he,n as k,B as _e,C as Fe,F as p,g as M,D as He,p as Qe,l as Je,j as Ke,s as l,_ as Ye}from"./index-ByymFW75.js";import{u as Ze,a as et}from"./practiceLibraryStore-Ohjn8Hxb.js";import{u as tt}from"./assignmentStore-DRtPF81d.js";import{u as st}from"./userStatsStore-BLQoLuG3.js";import{u as at}from"./classStore-CSpNbUZZ.js";import{c as nt,a as lt,b as rt}from"./useClassicalTTS-CXHixeah.js";import"./useSupabase-FZDz4h20.js";const it={class:"practice-shell"},ot={class:"picker-section edamame-glass"},ut={class:"picker-current"},ct={class:"picker-info"},dt={class:"picker-breadcrumb"},vt={key:0,class:"picker-meta"},mt={key:0},pt={key:0,class:"picker-panel"},ft={class:"picker-search"},ht={key:0,class:"picker-results"},_t={key:0,class:"picker-empty"},yt=["onClick"],kt={class:"item-main"},bt={class:"item-title"},gt={class:"item-author"},Tt={class:"item-preview"},St={key:1,class:"picker-cascade"},wt={class:"cascade-row"},Ct={class:"cascade-select full-width"},xt=["value"],Bt={class:"picker-list"},At={key:0,class:"picker-empty"},$t={key:1,class:"picker-empty"},Rt=["onClick"],It={class:"item-main"},Vt={class:"item-title"},Pt={class:"item-author"},Nt={class:"item-preview"},zt={class:"hero-actions"},Et=["disabled"],Mt={class:"board-card edamame-glass"},qt={key:0,class:"practice-board"},Lt={class:"board-header"},Dt={class:"board-header-right"},Ot={key:1,class:"timer-badge"},Ut={key:0,class:"practice-line"},jt=["onPointerdown","aria-label"],Gt={key:0,class:"bean"},Xt={key:1,class:"state-info"},Wt={class:"board-actions"},Ft=["disabled"],Ht={key:1,class:"board-empty"},Qt={class:"results-grid"},Jt={class:"result-card edamame-glass"},Kt={class:"result-desc"},Yt={class:"result-card edamame-glass"},Zt={class:"result-desc"},es={class:"result-card edamame-glass"},ts={class:"result-desc"},ss={class:"result-card edamame-glass"},as={class:"result-desc"},ns={key:0,class:"new-record"},ls={key:1},rs={key:2},is=Oe({__name:"PracticePage",setup(os){const Y=je(),T=Ze(),O=et(),ye=tt(),h=Ue(),Z=st(),ee=at(),te=d(new Set),U=g(()=>Y.query.assignmentId),se=g(()=>Y.query.textId),c=d(null),y=d([]),S=d(new Set),v=d(new Set),i=d(null),V=d(0),m=d(null),j=d(!1),G=d(0),ae=d(0),ne=d(0),X=d(!1),W=d(!1),le=g(()=>S.value.size),ke=g(()=>v.value.size),re=g(()=>Math.max(0,le.value-ke.value)),ie=g(()=>re.value>0),P=d(!1),w=d(null),B=d(""),be=d(localStorage.getItem("judou_username")||"guest"),ge=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡"),$=d(!1);let N=null;const C=d(null);function oe(){C.value||(C.value=new(window.AudioContext||window.webkitAudioContext))}function F(t){if(C.value||oe(),!C.value)return;const e=C.value,n=e.createOscillator(),s=e.createGain();n.connect(s),s.connect(e.destination),t==="add"?(n.frequency.setValueAtTime(400,e.currentTime),n.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),n.start(e.currentTime),n.stop(e.currentTime+.1)):(n.frequency.setValueAtTime(300,e.currentTime),n.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),n.start(e.currentTime),n.stop(e.currentTime+.08))}function ue(t=10){navigator.vibrate&&navigator.vibrate(t)}const H=g(()=>O.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index));function Q(t){return!!(t.is_system===!0||t.created_by===h.user?.id||h.isStudent&&t.created_by&&te.value.has(t.created_by))}const ce=g(()=>w.value?T.texts.filter(t=>t.category_id!==w.value?!1:Q(t)).sort((t,e)=>t.title.localeCompare(e.title)):[]),de=g(()=>{if(!B.value.trim())return[];const t=B.value.toLowerCase();return T.texts.filter(e=>Q(e)?e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t):!1).slice(0,10)}),Te=g(()=>{if(!c.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];return c.value.category?.name&&t.push(c.value.category.name),t.push(c.value.title),t.join(" â€º ")});async function Se(){if(!h.isStudent||!h.isAuthenticated)return;await ee.fetchStudentClasses();const t=new Set;for(const e of ee.classes)e.teacher_id&&t.add(e.teacher_id);te.value=t}function we(t){const e=[],n=new Set;let s=0;for(const o of t)o==="|"?s>0&&n.add(s-1):o!==`
`&&o!=="\r"&&(e.push(o),s++);return{chars:e,breaks:n}}function Ce(){q(),V.value=0,N=window.setInterval(()=>{V.value+=1},1e3)}function q(){N&&(clearInterval(N),N=null)}function J(t){const{chars:e,breaks:n}=we(t.content);y.value=e,S.value=n,v.value=new Set,i.value=null,m.value=null,q(),V.value=0,G.value=0,ae.value=0,ne.value=0,X.value=!1}function L(t){c.value=t,J(t),P.value=!1,B.value="",t.category_id&&(w.value=t.category_id)}function ve(){const t=T.texts.filter(x=>x.text_type==="practice"&&Q(x));if(!t.length){m.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}const e=c.value?.id,n=t.filter(x=>x.id!==e);if(!n.length){m.value="ç›®å‰åªæœ‰ä¸€ç¯‡æ–‡ç« å¯ç·´ç¿’";return}const s=Math.floor(Math.random()*n.length),o=n[s];o&&L(o)}async function xe(){const t=[];if(T.texts.length||t.push(T.fetchTexts()),O.state.categories.length||t.push(O.fetchLibrary()),h.isStudent&&h.isAuthenticated&&t.push(Se()),await Promise.all(t),se.value&&U.value){const e=T.texts.find(n=>n.id===se.value);if(e){L(e);return}}if(!c.value&&T.texts.length&&ve(),!w.value&&H.value.length){const e=H.value[0];e&&(w.value=e.id)}}function Be(t){if(i.value){m.value="å·²æäº¤ï¼å¦‚è¦å†æ¬¡å˜—è©¦è«‹é»æ“Šã€Œé‡æ–°æŒ‘æˆ°ã€";return}const e=new Set(v.value),n=e.has(t);if(!n&&!ie.value){Ae(),m.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}v.value.size===0&&!N&&!X.value&&Ce(),n?(e.delete(t),F("remove")):(e.add(t),F("add"),ue(10)),v.value=e,m.value=null}function Ae(){W.value=!0,F("remove"),ue(50),setTimeout(()=>{W.value=!1},400)}function $e(t){if(!i.value){const e=t>0&&v.value.has(t-1),n=v.value.has(t);if(e&&n)return"translateX(0)";if(e)return"translateX(4px)";if(n)return"translateX(-4px)"}return"translateX(0)"}function Re(t){const e=[],n=v.value.has(t);if(n&&e.push("has-bean"),i.value&&n){const s=i.value.statuses.find(o=>o.index===t);s&&(s.state==="correct"||s.state==="extra")&&e.push(s.state)}return e}function Ie(t){return`${t} è±†`}function Ve(t){return`${Math.round(t*100)}%`}function me(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function Pe(t,e){return Z.calculateScore({correctCount:t,totalBreaks:S.value.size,charCount:y.value.length,elapsedSeconds:e})}async function Ne(){if(!c.value)return;if(!v.value.size){m.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}G.value++;const t=[];let e=0,n=0,s=0;for(let f=0;f<=y.value.length;f++){const E=v.value.has(f),I=S.value.has(f);E&&I?(t.push({index:f,state:"correct"}),e++):!E&&I?(t.push({index:f,state:"missed"}),n++):E&&!I?(t.push({index:f,state:"extra"}),s++):t.push({index:f,state:"pending"})}const o=S.value.size?e/S.value.size:v.value.size?0:1,x=n===0&&s===0;q(),X.value=!0;const D=V.value;G.value===1&&(ae.value=o,ne.value=D);const{score:R,breakdown:K}=Pe(e,D);if(i.value={statuses:t,accuracy:o,elapsed:D,score:R,isComplete:x,breakdown:K},x){Ee();const f=K.speedBonus>0?` + é€Ÿåº¦çå‹µ ${K.speedBonus}`:"";m.value=`ğŸ‰ å…¨å°ï¼æ­£ç¢º ${e} è±†${f} = ${R} è±†`}else m.value=`æ­£ç¢º ${e} å€‹ï¼Œéºæ¼ ${n} å€‹ï¼Œå¤šé¤˜ ${s} å€‹ â†’ ç²å¾— ${R} è±†`;try{j.value=!0;const f=h.isAuthenticated?h.user?.email?.split("@")[0]||"user":be.value,E=h.isAuthenticated?h.displayName:ge.value,I=await T.recordPracticeResult({text_id:c.value.id,score:R,accuracy:o,elapsed_seconds:D,user_breaks:v.value.size,correct_breaks:S.value.size,username:f,display_name:E,user_id:h.user?.id||null});if(h.isAuthenticated){const A=await Z.recordPracticeScore({textId:c.value.id,score:R});if(i.value&&(i.value.beansEarned=A.beansEarned,i.value.isNewRecord=A.isNewRecord),A.beansEarned>0){const De=A.isNewRecord?" (æ–°ç´€éŒ„!)":"";m.value=`${m.value}${De} å¯¦å¾— +${A.beansEarned} è±†`}else A.beansEarned===0&&!A.isNewRecord&&(m.value=`${m.value}ï¼ˆæœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„ï¼Œä¸åŠ åˆ†ï¼‰`)}U.value&&h.isAuthenticated&&I&&await ye.recordCompletion(U.value,I,R,o*100)}catch(f){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",f)}finally{j.value=!1}}function ze(){c.value&&J(c.value)}function Ee(){if(C.value||oe(),!C.value)return;const t=C.value,e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function Me(){if(!y.value.length)return[];const t=[];let e="",n=-1;for(let s=0;s<y.value.length;s++)if(e+=y.value[s],S.value.has(s)){const o=s-n;n=s,o>=8?(e+="ã€‚",t.push(e),e=""):o>=4?e+="ï¼Œ":e+="ã€"}return e.trim()&&(!e.endsWith("ã€‚")&&!e.endsWith("ï¼Œ")&&!e.endsWith("ã€")&&(e+="ã€‚"),t.push(e)),t.length===0&&y.value.length>0?[y.value.join("")+"ã€‚"]:t}let z=!1;function pe(){z=!0,nt(),$.value=!1}const fe={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function qe(){if(!y.value.length)return;if($.value){pe();return}$.value=!0,z=!1;const t=Me();try{for(let e=0;e<t.length&&!z;e++){const n=t[e+1];n&&lt(n,fe);const s=t[e];s&&await rt(s,fe)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),z||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{$.value=!1,z=!1}}function Le(){c.value&&J(c.value)}return Ge(()=>{xe()}),Xe(()=>{q(),pe()}),(t,e)=>{const n=Qe("router-link");return l(),r("div",it,[a("section",ot,[a("div",{class:"picker-header",onClick:e[1]||(e[1]=s=>P.value=!P.value)},[a("div",ut,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",ct,[a("span",dt,u(Te.value),1),c.value?(l(),r("span",vt,[b(u(c.value.author||"ä½šå")+" ",1),c.value.source?(l(),r("span",mt," Â· "+u(c.value.source),1)):_("",!0),c.value.source_text?.id?(l(),We(n,{key:1,to:{name:"reading-detail",params:{id:c.value.source_text.id}},class:"source-link",onClick:e[0]||(e[0]=he(()=>{},["stop"]))},{default:Je(()=>[b(" Â· ä¾†è‡ªã€Š"+u(c.value.source_text.title)+"ã€‹ ",1)]),_:1},8,["to"])):_("",!0)])):_("",!0)])]),a("button",{class:k(["picker-toggle",{expanded:P.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),P.value?(l(),r("div",pt,[a("div",ft,[_e(a("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>B.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Fe,B.value]])]),B.value.trim()?(l(),r("div",ht,[de.value.length?_("",!0):(l(),r("div",_t," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+u(B.value)+"ã€çš„æ–‡ç«  ",1)),(l(!0),r(p,null,M(de.value,s=>(l(),r("div",{key:s.id,class:"picker-item",onClick:o=>L(s)},[a("div",kt,[a("span",bt,u(s.title),1),a("span",gt,u(s.author||"ä½šå"),1)]),a("span",Tt,u(me(s)),1)],8,yt))),128))])):(l(),r("div",St,[a("div",wt,[a("div",Ct,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),_e(a("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(l(!0),r(p,null,M(H.value,s=>(l(),r("option",{key:s.id,value:s.id},u(s.name),9,xt))),128))],512),[[He,w.value]])])]),a("div",Bt,[w.value?ce.value.length?_("",!0):(l(),r("div",$t," æ­¤å¹´ç´šå°šç„¡æ–‡ç«  ")):(l(),r("div",At," è«‹é¸æ“‡å¹´ç´šä»¥æŸ¥çœ‹æ–‡ç«  ")),(l(!0),r(p,null,M(ce.value,s=>(l(),r("div",{key:s.id,class:k(["picker-item",{active:c.value?.id===s.id}]),onClick:o=>L(s)},[a("div",It,[a("span",Vt,u(s.title),1),a("span",Pt,u(s.author||"ä½šå"),1),a("span",{class:k(["item-difficulty",`diff-${s.difficulty}`])},u(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",Nt,u(me(s)),1)],10,Rt))),128))])]))])):_("",!0)]),a("div",zt,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Le,disabled:!c.value}," é‡æ–°é–‹å§‹ ",8,Et),a("button",{class:"edamame-btn edamame-btn-primary",onClick:ve}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",Mt,[c.value?(l(),r("div",qt,[a("div",Lt,[e[8]||(e[8]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Dt,[i.value?.isComplete?(l(),r("button",{key:0,class:k(["tts-btn-small",{playing:$.value}]),onClick:qe},u($.value?"â¹ åœæ­¢":"ğŸ”Š æœ—è®€"),3)):_("",!0),a("div",{class:k(["bean-inventory",{shake:W.value,empty:!ie.value}])},[(l(!0),r(p,null,M(le.value,s=>(l(),r("span",{key:s,class:k(["inventory-bean",{used:s>re.value}])},null,2))),128))],2),v.value.size>0||i.value?(l(),r("span",Ot,"â± "+u(V.value)+" ç§’",1)):_("",!0)])]),y.value.length?(l(),r("div",Ut,[(l(!0),r(p,null,M(y.value,(s,o)=>(l(),r("span",{key:o,class:"char-unit"},[a("span",{class:"char",style:Ke({transform:$e(o)})},u(s),5),o<y.value.length-1?(l(),r("button",{key:0,class:k(["bean-slot",Re(o)]),onPointerdown:he(x=>Be(o),["prevent"]),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${v.value.has(o)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[v.value.has(o)?(l(),r("span",Gt)):_("",!0),e[9]||(e[9]=a("span",{class:"bean-hint"},null,-1))],42,jt)):_("",!0)]))),128))])):(l(),r("div",Xt,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",Wt,[i.value?(l(),r("button",{key:1,class:"edamame-btn edamame-btn-lg edamame-btn-secondary",onClick:ze}," ğŸ”„ é‡æ–°æŒ‘æˆ° ")):(l(),r("button",{key:0,class:"edamame-btn edamame-btn-lg edamame-btn-primary",disabled:j.value,onClick:Ne}," æäº¤ç­”æ¡ˆ ",8,Ft))]),m.value?(l(),r("p",{key:2,class:k(["toast",{success:i.value?.isComplete}])},u(m.value),3)):_("",!0)])):(l(),r("div",Ht,[...e[10]||(e[10]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",Qt,[a("article",Jt,[e[11]||(e[11]=a("p",{class:"result-label"},"æœ¬æ¬¡å¾—åˆ†",-1)),a("p",{class:k(["result-value",{placeholder:!i.value}])},u(i.value?Ie(i.value.score):"--"),3),a("p",Kt,[i.value?.breakdown?(l(),r(p,{key:0},[b(" æ­£ç¢º "+u(i.value.breakdown.baseScore)+" è±† ",1),i.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[b(" + é€Ÿåº¦ "+u(i.value.breakdown.speedBonus)+" è±† ",1)],64)):_("",!0)],64)):(l(),r(p,{key:1},[b(" å°å¹¾å€‹å¾—å¹¾è±† ")],64))])]),a("article",Yt,[e[12]||(e[12]=a("p",{class:"result-label"},"æ­£ç¢ºç‡",-1)),a("p",{class:k(["result-value",{placeholder:!i.value}])},u(i.value?Ve(i.value.accuracy):"--"),3),a("p",Zt,[i.value?(l(),r(p,{key:0},[b(u(i.value.isComplete?"ğŸ‰ å…¨å°ï¼":"ç¹¼çºŒåŠ æ²¹"),1)],64)):(l(),r(p,{key:1},[b(" æ­£ç¢ºæ•¸ Ã· ç¸½æ–·å¥æ•¸ ")],64))])]),a("article",es,[e[13]||(e[13]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:k(["result-value",{placeholder:!i.value}])},u(i.value?`${i.value.elapsed} ç§’`:"--"),3),a("p",ts,[i.value?.breakdown?(l(),r(p,{key:0},[b(" åŸºæº– "+u(i.value.breakdown.baseTime)+" ç§’ ",1),i.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[b(" Â· ç¯€çœ "+u(i.value.breakdown.baseTime-i.value.elapsed)+" ç§’ ",1)],64)):_("",!0)],64)):(l(),r(p,{key:1},[b(" å…¨å°æ‰æœ‰é€Ÿåº¦çå‹µ ")],64))])]),a("article",ss,[e[14]||(e[14]=a("p",{class:"result-label"},"å¯¦å¾—è±†å­",-1)),a("p",{class:k(["result-value",{placeholder:!i.value||i.value.beansEarned===void 0}])},u(i.value?.beansEarned!==void 0?`+${i.value.beansEarned}`:"--"),3),a("p",as,[i.value?.beansEarned!==void 0?(l(),r(p,{key:0},[i.value.isNewRecord?(l(),r("span",ns,"ğŸ† æ–°ç´€éŒ„ï¼")):i.value.beansEarned===0?(l(),r("span",ls,"æœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„")):(l(),r("span",rs,"å¢é‡åŠ åˆ†"))],64)):(l(),r(p,{key:1},[b(" ç™»å…¥å¾Œè¨˜éŒ„ ")],64))])])])])}}}),hs=Ye(is,[["__scopeId","data-v-267be52f"]]);export{hs as default};
