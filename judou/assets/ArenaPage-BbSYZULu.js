import{d as O,u as Y,r as g,c as k,w as z,K as W,a as n,b as s,e as A,g as r,f as c,t as l,D as R,n as j,F as X,i as D,A as J,B as H,G as Q,j as Z,q as o,I as d,_ as ss}from"./index-OCFRbmLM.js";import{u as es,g as V,E as ts,S as $}from"./gameStore-cYAKBovZ.js";import{u as as}from"./userStatsStore-DuKR170X.js";const ls={class:"arena-page"},ns={class:"arena-header"},os={key:0,class:"stats-card"},is={class:"stat-item"},rs={class:"stat-value"},us={class:"stat-item"},cs={class:"stat-label"},ds={key:0,class:"stat-item streak"},vs={class:"stat-value"},ps={class:"stat-item"},ms={class:"stat-value"},_s={class:"stat-label"},gs={key:0,class:"login-prompt"},fs={key:1,class:"arena-main"},bs={key:0,class:"teacher-section"},ys={key:1,class:"student-section"},ks={class:"tab-nav"},hs={class:"tab-icon"},Cs={class:"tab-content"},ws={key:0,class:"join-tab"},As={class:"class-games-section"},Is={key:0,class:"loading-state small"},Ss={key:1,class:"empty-state small"},Ts={key:2,class:"class-games-list"},xs={class:"game-info"},Ls={class:"game-title-row"},Rs={class:"game-meta"},js={class:"class-name"},Es={class:"game-code"},Gs=["disabled","onClick"],Ms={class:"code-join-section"},Ns={class:"code-input-group"},Bs=["disabled"],Fs={key:0,class:"error-message"},Us={key:1,class:"create-tab"},Xs={key:0,class:"unlock-card"},Ds={class:"progress-bar"},Vs={class:"progress-text"},$s={key:1,class:"create-card"},Ks={class:"fee-info"},Ps={class:"fee-options"},qs={class:"safety-info"},Os={class:"safety-text"},I=5,Ys=O({__name:"ArenaPage",setup(zs){const f=Z(),i=Y(),E=es(),v=as(),b=g("join"),h=g(""),p=g(!1),m=g(""),_=g([]),S=g(!1);let y=null;const u=g([]),K=k(()=>v.profile?.total_beans??0),C=k(()=>v.level),T=k(()=>V(C.value)),G=k(()=>v.profile?.pvp_win_streak??0),x=k(()=>({wins:v.profile?.pvp_total_wins??0,games:v.profile?.pvp_total_games??0,winRate:v.profile?.pvp_total_games?Math.round((v.profile?.pvp_total_wins??0)/v.profile.pvp_total_games*100):0})),L=k(()=>C.value>=I);async function M(){if(!d||!i.user)return console.log("[Arena] fetchMyClassIds: supabase æˆ– user ç‚ºç©º"),[];console.log("[Arena] ç²å–å­¸ç”Ÿç­ç´šï¼Œuser.id:",i.user.id);const{data:t,error:e}=await d.from("class_members").select("class_id").eq("student_id",i.user.id);if(e)return console.error("[Arena] ç²å–ç­ç´šå¤±æ•—:",e),[];const a=t?.map(w=>w.class_id)||[];return console.log("[Arena] å­¸ç”Ÿæ‰€å±¬ç­ç´š:",a),a}async function N(){if(!(!d||!i.user||i.isTeacher)){S.value=!0;try{if(u.value.length===0&&(u.value=await M()),u.value.length===0){_.value=[];return}const{data:t}=await d.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        class:classes!game_rooms_class_id_fkey(id, class_name),
        teams:game_teams(*)
      `).in("class_id",u.value).eq("host_type","teacher").in("status",["waiting","playing"]).order("created_at",{ascending:!1});_.value=t||[],console.log("[Arena] ç­ç´šæ¯”è³½:",_.value.length,"å ´")}catch(t){console.error("ç²å–ç­ç´šæ¯”è³½å¤±æ•—:",t),_.value=[]}finally{S.value=!1}}}async function P(){if(!(!d||!i.user||i.isTeacher)){if(u.value.length===0&&(u.value=await M()),u.value.length===0){console.log("[Arena] å­¸ç”ŸæœªåŠ å…¥ä»»ä½•ç­ç´šï¼Œè·³éŽ Realtime è¨‚é–±");return}y&&d.removeChannel(y),console.log("[Arena] é–‹å§‹è¨‚é–±ç­ç´šæ¯”è³½ Realtimeï¼Œç­ç´šID:",u.value),y=d.channel("class-games-channel").on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},async t=>{console.log("[Arena] Realtime æ”¶åˆ° game_rooms è®Šæ›´:",t.eventType,t);const e=t.new,a=t.old,w=e?.class_id||a?.class_id;if(!w||!u.value.includes(w)){console.log("[Arena] ä¸æ˜¯æˆ‘ç­ç´šçš„æ¯”è³½ï¼Œå¿½ç•¥");return}console.log("[Arena] æ˜¯æˆ‘ç­ç´šçš„æ¯”è³½ï¼Œé‡æ–°ç²å–åˆ—è¡¨"),await N()}).subscribe(t=>{console.log("[Arena] Realtime è¨‚é–±ç‹€æ…‹:",t)})}}function B(){y&&d&&(console.log("[Arena] å–æ¶ˆ Realtime è¨‚é–±"),d.removeChannel(y),y=null)}async function q(t){p.value=!0,m.value="";const e=await E.joinRoom(t.room_code);e.success?t.status==="playing"?f.push({name:"arena-play",params:{roomId:t.id}}):f.push({name:"arena-lobby",params:{roomId:t.id}}):m.value=e.error||"åŠ å…¥å¤±æ•—",p.value=!1}async function F(){if(!h.value.trim()){m.value="è«‹è¼¸å…¥æˆ¿é–“ç¢¼";return}p.value=!0,m.value="";const t=await E.joinRoom(h.value.trim().toUpperCase());t.success?t.room?.status==="playing"?f.push({name:"arena-play",params:{roomId:t.room.id}}):f.push({name:"arena-lobby",params:{roomId:t.room.id}}):m.value=t.error||"åŠ å…¥å¤±æ•—",p.value=!1}function U(){i.isTeacher?f.push({name:"arena-teacher-create"}):f.push({name:"arena-create"})}return z(()=>[i.isAuthenticated,i.isTeacher],async([t,e])=>{console.log("[Arena] èªè­‰ç‹€æ…‹è®ŠåŒ–:",{isAuth:t,isTeacher:e}),t&&!e?(console.log("[Arena] å­¸ç”Ÿç™»å…¥ï¼Œé–‹å§‹ç²å–ç­ç´šæ¯”è³½"),await N(),await P()):(_.value=[],B())},{immediate:!0}),W(()=>{B()}),(t,e)=>(o(),n("div",ls,[s("header",ns,[e[9]||(e[9]=s("div",{class:"header-content"},[s("h1",{class:"page-title"},[s("span",{class:"title-icon"},"âš”ï¸"),r(" é¬¥è±† ")]),s("p",{class:"page-subtitle"},"èˆ‡åŒå­¸ä¸€è¼ƒé«˜ä¸‹ï¼Œåœ¨ç«¶æŠ€ä¸­æˆé•·")],-1)),c(i).isAuthenticated?(o(),n("div",os,[s("div",is,[e[4]||(e[4]=s("span",{class:"stat-icon"},"ðŸ«˜",-1)),s("span",rs,l(K.value),1),e[5]||(e[5]=s("span",{class:"stat-label"},"è±†å­",-1))]),s("div",us,[s("span",{class:"stat-icon",style:R({color:T.value.color})},"ðŸŽ“",4),s("span",{class:"stat-value",style:R({color:T.value.color})},l(T.value.title),5),s("span",cs,"Lv."+l(C.value),1)]),G.value>0?(o(),n("div",ds,[e[6]||(e[6]=s("span",{class:"stat-icon"},"ðŸ”¥",-1)),s("span",vs,l(G.value),1),e[7]||(e[7]=s("span",{class:"stat-label"},"é€£å‹",-1))])):A("",!0),s("div",ps,[e[8]||(e[8]=s("span",{class:"stat-icon"},"ðŸ“Š",-1)),s("span",ms,l(x.value.winRate)+"%",1),s("span",_s,"å‹çŽ‡ ("+l(x.value.wins)+"/"+l(x.value.games)+")",1)])])):A("",!0)]),c(i).isAuthenticated?(o(),n("main",fs,[c(i).isTeacher?(o(),n("section",bs,[e[14]||(e[14]=s("h2",{class:"section-title"},[s("span",{class:"section-icon"},"ðŸ“¢"),r(" èª²å ‚é¬¥è±† ")],-1)),e[15]||(e[15]=s("p",{class:"section-desc"},"å‰µå»ºç­ç´šæ¯”è³½ï¼Œè®“å­¸ç”Ÿåˆ†çµ„ç«¶æŠ€",-1)),s("button",{class:"btn-primary btn-large",onClick:U},[...e[13]||(e[13]=[s("span",{class:"btn-icon"},"âž•",-1),r(" å‰µå»ºèª²å ‚é¬¥è±† ",-1)])])])):(o(),n("div",ys,[s("nav",ks,[s("button",{class:j(["tab-btn",{active:b.value==="join"}]),onClick:e[1]||(e[1]=a=>b.value="join")},[...e[16]||(e[16]=[s("span",{class:"tab-icon"},"ðŸŽ«",-1),r(" åŠ å…¥é¬¥è±†å ´ ",-1)])],2),s("button",{class:j(["tab-btn",{active:b.value==="create",locked:!L.value}]),onClick:e[2]||(e[2]=a=>b.value="create")},[s("span",hs,l(L.value?"âž•":"ðŸ”’"),1),e[17]||(e[17]=r(" å‰µå»ºé¬¥è±†å ´ ",-1))],2)]),s("div",Cs,[b.value==="join"?(o(),n("div",ws,[s("section",As,[e[23]||(e[23]=s("div",{class:"section-header"},[s("h3",null,[s("span",{class:"header-icon"},"ðŸ«"),r(" ç­ç´šæ¯”è³½ ")]),s("span",{class:"realtime-badge"},[s("span",{class:"realtime-dot"}),r(" å¯¦æ™‚æ›´æ–° ")])],-1)),S.value?(o(),n("div",Is,[...e[18]||(e[18]=[s("div",{class:"spinner"},null,-1),s("span",null,"æª¢æŸ¥ç­ç´šæ¯”è³½...",-1)])])):_.value.length===0?(o(),n("div",Ss,[...e[19]||(e[19]=[s("p",null,"ç›®å‰æ²’æœ‰ç­ç´šæ¯”è³½",-1),s("p",{class:"empty-hint"},"è€å¸«ç™¼èµ·æ¯”è³½å¾Œæœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡",-1)])])):(o(),n("div",Ts,[(o(!0),n(X,null,D(_.value,a=>(o(),n("div",{key:a.id,class:"class-game-card"},[s("div",xs,[s("div",Ls,[s("h4",null,l(a.text?.title||"èª²å ‚é¬¥è±†"),1),s("span",{class:j(["game-status",a.status])},l(a.status==="playing"?"ðŸ”´ é€²è¡Œä¸­":"ðŸŸ¡ ç­‰å¾…ä¸­"),3)]),s("p",Rs,[s("span",js,l(a.class?.class_name),1),e[20]||(e[20]=s("span",{class:"divider"},"Â·",-1)),s("span",null,l(a.host?.display_name)+" è€å¸«",1)]),s("p",Es,[e[21]||(e[21]=r(" æˆ¿é–“ç¢¼ï¼š",-1)),s("strong",null,l(a.room_code),1),e[22]||(e[22]=s("span",{class:"code-hint"},"ï¼ˆå¯åˆ†äº«çµ¦å…¶ä»–åŒå­¸ï¼‰",-1))])]),s("button",{class:"btn-primary btn-join",disabled:p.value,onClick:w=>q(a)},l(p.value?"åŠ å…¥ä¸­...":"ç«‹å³åŠ å…¥"),9,Gs)]))),128))]))]),e[26]||(e[26]=s("div",{class:"section-divider"},[s("span",{class:"divider-text"},"æˆ–")],-1)),s("section",Ms,[e[24]||(e[24]=s("div",{class:"section-header"},[s("h3",null,[s("span",{class:"header-icon"},"ðŸŽŸï¸"),r(" è¼¸å…¥æˆ¿é–“ç¢¼ ")])],-1)),e[25]||(e[25]=s("p",{class:"section-hint"},"å‘åŒå­¸è©¢å• 6 ä½æˆ¿é–“ç¢¼ï¼ŒåŠ å…¥ä»–å€‘çš„é¬¥è±†å ´",-1)),s("div",Ns,[J(s("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>h.value=a),type:"text",maxlength:"6",placeholder:"XXXXXX",class:"code-input",onKeyup:Q(F,["enter"])},null,544),[[H,h.value]]),s("button",{class:"btn-primary",disabled:p.value||!h.value.trim(),onClick:F},l(p.value?"åŠ å…¥ä¸­...":"åŠ å…¥"),9,Bs)]),m.value?(o(),n("p",Fs,l(m.value),1)):A("",!0)])])):A("",!0),b.value==="create"?(o(),n("div",Us,[L.value?(o(),n("div",$s,[e[36]||(e[36]=s("h3",null,"å‰µå»ºä½ çš„é¬¥è±†å ´",-1)),e[37]||(e[37]=s("p",{class:"create-hint"}," é‚€è«‹åŒå­¸åŠ å…¥ï¼Œè´å–è±†å­ï¼ ",-1)),s("div",Ks,[e[31]||(e[31]=s("div",{class:"fee-label"},"å…¥å ´è²»é¸é …",-1)),s("div",Ps,[(o(!0),n(X,null,D(c(ts),a=>(o(),n("span",{key:a,class:"fee-tag"},l(a===0?"å…è²»":`${a} è±†`),1))),128))])]),s("div",qs,[e[34]||(e[34]=s("div",{class:"safety-icon"},"ðŸ›¡ï¸",-1)),s("div",Os,[e[33]||(e[33]=s("p",null,"å®‰å…¨æ©Ÿåˆ¶",-1)),s("ul",null,[s("li",null,"æ¯æ—¥å…¥å ´è²»ä¸Šé™ï¼š"+l(c($).DAILY_FEE_LIMIT)+" è±†",1),s("li",null,"è³¬æˆ¶ä¿ç•™é¤˜é¡ï¼š"+l(c($).MIN_BALANCE)+" è±†",1),e[32]||(e[32]=s("li",null,"æˆ¿é–“å–æ¶ˆè‡ªå‹•é€€æ¬¾",-1))])])]),s("button",{class:"btn-primary btn-large",onClick:U},[...e[35]||(e[35]=[s("span",{class:"btn-icon"},"âž•",-1),r(" å‰µå»ºé¬¥è±†å ´ ",-1)])])])):(o(),n("div",Xs,[e[28]||(e[28]=s("div",{class:"unlock-icon"},"ðŸ”’",-1)),e[29]||(e[29]=s("h3",null,"å‰µå»ºé¬¥è±†å ´åŠŸèƒ½æœªè§£éŽ–",-1)),s("p",null,[e[27]||(e[27]=r(" é”åˆ° ",-1)),s("strong",null,"Lv."+l(I)),r("ï¼ˆ"+l(c(V)(I).title)+"ï¼‰ å³å¯å‰µå»ºè‡ªå·±çš„é¬¥è±†å ´ ",1)]),s("div",Ds,[s("div",{class:"progress-fill",style:R({width:`${Math.min(C.value/I*100,100)}%`})},null,4)]),s("p",Vs,"ç•¶å‰ï¼šLv."+l(C.value)+" / Lv."+l(I),1),e[30]||(e[30]=s("p",{class:"unlock-hint"}," ðŸ’¡ ä½ ä»å¯ä»¥é€šéŽæˆ¿é–“ç¢¼åŠ å…¥åŒå­¸çš„é¬¥è±†å ´ï¼Œæˆ–åƒèˆ‡è€å¸«ç™¼èµ·çš„ç­ç´šæ¯”è³½ ",-1))]))])):A("",!0)])]))])):(o(),n("div",gs,[e[10]||(e[10]=s("div",{class:"prompt-icon"},"ðŸ”",-1)),e[11]||(e[11]=s("h2",null,"è«‹å…ˆç™»å…¥",-1)),e[12]||(e[12]=s("p",null,"ç™»å…¥å¾Œå³å¯åƒèˆ‡é¬¥è±†å°æˆ°",-1)),s("button",{class:"btn-primary",onClick:e[0]||(e[0]=(...a)=>c(i).loginWithGoogle&&c(i).loginWithGoogle(...a))}," ä½¿ç”¨ Google ç™»å…¥ ")]))]))}}),Qs=ss(Ys,[["__scopeId","data-v-a992d588"]]);export{Qs as default};
