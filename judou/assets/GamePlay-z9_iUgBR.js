import{d as Y,c as _,p as Z,r as i,w as ee,o as te,K as ae,a as o,b as n,F as S,e as p,t as u,n as k,i as M,j as se,q as r,_ as ne}from"./index-BmjdZCnG.js";import{u as oe}from"./gameStore-DD8UWXU1.js";import"./userStatsStore-CSR9l9fy.js";const re={class:"game-play"},le={key:0,class:"loading-container"},ue={class:"play-header"},ie={class:"header-left"},ce={class:"text-title"},ve={key:0,class:"text-author"},de={key:1,class:"text-progress"},me={class:"countdown-time"},pe={class:"header-right"},fe={class:"score-display"},he={class:"score-value"},_e={key:0,class:"multi-text-progress"},Te={key:0,class:"dot-icon"},ge={key:1},ye={class:"play-main"},be={class:"bean-header"},ke={class:"text-container"},xe={key:0,class:"practice-line"},we={class:"char"},Ce=["onClick","aria-label"],Se={key:0,class:"bean"},Be={class:"progress-hint"},Ae={key:0,class:"divider"},Ie={key:1},Ve={class:"play-footer"},Re=["disabled"],ze=Y({__name:"GamePlay",setup(Me){const q=se(),E=Z(),T=oe(),y=_(()=>E.params.roomId),c=_(()=>T.currentRoom),v=i([]),d=i(0),f=_(()=>v.value[d.value]),x=i(0);let B=null;const w=i([]),l=i(new Set),g=i(new Set),D=_(()=>g.value.size),K=_(()=>l.value.size),$=_(()=>Math.max(0,D.value-K.value)),G=_(()=>$.value>0),A=i(!1),b=i(0),C=i(0),h=i(!1),P=i(!0);let I=0;function F(a){const e=[],t=new Set;let s=0;for(const m of a)m==="|"?s>0&&t.add(s-1):m!==`
`&&m!=="\r"&&(e.push(m),s++);return{chars:e,breaks:t}}function L(){if(!f.value?.content)return;const a=F(f.value.content);w.value=a.chars,g.value=a.breaks,l.value=new Set}let V=null;function R(a){try{V||(V=new AudioContext);const e=V,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function z(a=10){navigator.vibrate&&navigator.vibrate(a)}function O(a){if(h.value)return;const e=new Set(l.value),t=e.has(a);if(!t&&!G.value){R("error"),A.value=!0,setTimeout(()=>{A.value=!1},300),z(50);return}t?(e.delete(a),R("remove"),z(5)):(e.add(a),R("add"),z(10)),l.value=e,H()}function U(a){return{"has-bean":l.value.has(a)}}function H(){const a=g.value,e=l.value;a.size===e.size&&[...a].every(t=>e.has(t))&&J()}async function J(){const a=g.value,e=l.value;let t=0,s=0;for(const m of e)a.has(m)?t++:s++;b.value+=t,C.value++,f.value&&await T.submitTextProgress({roomId:y.value,textId:f.value.id,textIndex:d.value,correctCount:t,wrongCount:s,timeSpent:Math.round((Date.now()-I)/1e3)}),d.value<v.value.length-1?(d.value++,L()):j()}async function N(){if(h.value)return;const a=g.value,e=l.value;let t=0;for(const s of e)a.has(s)&&t++;b.value+=t,j()}async function j(){if(h.value)return;h.value=!0;const a=Math.round((Date.now()-I)/1e3),e=v.value.reduce((s,m)=>{const X=F(m.content);return s+X.breaks.size},0),t=e>0?b.value/e*100:0;await T.submitScore({roomId:y.value,score:b.value,accuracy:t,timeSpent:a,firstAccuracy:t,attemptCount:1}),q.push({name:"arena-result",params:{roomId:y.value}})}function Q(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function W(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const e=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);x.value=Math.max(0,c.value.time_limit-t),x.value===0&&!h.value&&N()};a(),B=setInterval(a,1e3)}return ee(()=>c.value?.status,a=>{a==="finished"&&q.push({name:"arena-result",params:{roomId:y.value}})}),te(async()=>{T.subscribeToRoom(y.value),c.value?.text_ids&&c.value.text_ids.length>0?v.value=await T.fetchTexts(c.value.text_ids):c.value?.text_id&&(v.value=await T.fetchTexts([c.value.text_id])),P.value=!1,v.value.length>0&&(L(),I=Date.now(),W())}),ae(()=>{B&&clearInterval(B)}),(a,e)=>(r(),o("div",re,[P.value?(r(),o("div",le,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"â³",-1),n("span",null,"è¼‰å…¥é¡Œç›®ä¸­...",-1)])])):(r(),o(S,{key:1},[n("header",ue,[n("div",ie,[n("span",ce,u(f.value?.title),1),f.value?.author?(r(),o("span",ve,u(f.value.author),1)):p("",!0),v.value.length>1?(r(),o("span",de," ï¼ˆ"+u(d.value+1)+" / "+u(v.value.length)+"ï¼‰ ",1)):p("",!0)]),n("div",{class:k(["countdown",{warning:x.value<30}])},[n("span",me,u(Q(x.value)),1)],2),n("div",pe,[n("span",fe,[e[1]||(e[1]=n("span",{class:"score-icon"},"ğŸ«˜",-1)),n("span",he,u(b.value),1)])])]),v.value.length>1?(r(),o("div",_e,[(r(!0),o(S,null,M(v.value,(t,s)=>(r(),o("div",{key:t.id,class:k(["progress-dot",{completed:s<d.value,current:s===d.value,pending:s>d.value}])},[s<d.value?(r(),o("span",Te,"âœ“")):(r(),o("span",ge,u(s+1),1))],2))),128))])):p("",!0),n("main",ye,[n("div",be,[e[2]||(e[2]=n("span",{class:"bean-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†",-1)),n("div",{class:k(["bean-inventory",{shake:A.value,empty:!G.value}])},[(r(!0),o(S,null,M(D.value,t=>(r(),o("span",{key:t,class:k(["inventory-bean",{used:t>$.value}])},null,2))),128))],2)]),n("div",ke,[w.value.length?(r(),o("div",xe,[(r(!0),o(S,null,M(w.value,(t,s)=>(r(),o("span",{key:s,class:"char-unit"},[n("span",we,u(t),1),s<w.value.length-1?(r(),o("button",{key:0,class:k(["bean-slot",U(s)]),onClick:m=>O(s),"aria-label":`åœ¨ã€Œ${t}ã€å¾Œ${l.value.has(s)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[l.value.has(s)?(r(),o("span",Se)):p("",!0),e[3]||(e[3]=n("span",{class:"bean-hint-dot"},null,-1))],10,Ce)):p("",!0)]))),128))])):p("",!0)]),n("div",Be,[n("span",null,"å·²æ¨™è¨˜ "+u(l.value.size)+" / "+u(g.value.size)+" è™•",1),C.value>0?(r(),o("span",Ae,"Â·")):p("",!0),C.value>0?(r(),o("span",Ie,"å·²å®Œæˆ "+u(C.value)+" ç¯‡",1)):p("",!0)])]),n("footer",Ve,[n("button",{class:"btn-primary btn-large",disabled:h.value||l.value.size===0,onClick:N},u(h.value?"å·²æäº¤":"æäº¤ç•¶å‰é€²åº¦"),9,Re),e[4]||(e[4]=n("p",{class:"footer-hint"}," åšå®Œè‡ªå‹•é€²å…¥ä¸‹ä¸€ç¯‡ï¼Œæˆ–é»æ“ŠæŒ‰éˆ•æäº¤ç•¶å‰é€²åº¦ ",-1))])],64))]))}}),Ge=ne(ze,[["__scopeId","data-v-805280a2"]]);export{Ge as default};
