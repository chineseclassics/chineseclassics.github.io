import{d as ge,c as r,x as Te,r as T,w as ye,f as ke,R as be,a as o,g as n,F as B,h,b as k,t as u,j as S,l as Be,o as i,_ as Ae}from"./index-lMxeXcG_.js";import{u as xe}from"./gameStore-Tr7kYTq7.js";import"./userStatsStore-Djc8RuoG.js";import"./game-pGsr7gx9.js";const we={class:"game-play"},Ce={key:0,class:"loading-container"},Se={class:"play-header"},Pe={class:"header-left"},ze={class:"countdown-time"},Ie={class:"header-center"},Me={class:"text-title"},Ve={key:0,class:"text-author"},Re={class:"header-right"},Ee={class:"scoreboard"},Ge={class:"score-chip"},De={class:"chip-value"},Fe={key:0,class:"score-chip team"},$e={class:"chip-value"},qe={key:0,class:"text-tabs"},Le=["onClick"],Ue={class:"tab-number"},Ne={class:"tab-title"},je={key:0,class:"tab-check"},Oe={class:"play-main"},Ye={class:"board-header"},He={class:"board-header-right"},Je={class:"practice-board"},Ke={key:0,class:"practice-line"},Qe={class:"char"},We=["onClick","aria-label"],Xe={key:0,class:"bean"},Ze={class:"progress-hint"},et={key:0,class:"team-board"},tt={class:"team-name"},at={class:"team-score"},st={key:1,class:"text-nav"},nt=["disabled"],lt={class:"nav-info"},rt=["disabled"],ot=80,it=ge({__name:"GamePlay",setup(ct){const X=Be(),Z=Te(),g=xe(),P=r(()=>Z.params.roomId),c=r(()=>g.currentRoom),y=r(()=>g.myParticipant),ee=r(()=>c.value?.participants||[]),z=r(()=>c.value?.teams||[]),q=r(()=>!z.value.length||!y.value?.team_id?null:z.value.find(a=>a.id===y.value.team_id)||null),te=r(()=>F()),L=r(()=>te.value.totalCorrect),U=r(()=>{const a=new Map;z.value.forEach(t=>{a.set(t.id,{id:t.id,name:t.team_name,authAvg:typeof t.total_score=="number"?t.total_score/100:0,localAvg:0})});const e=new Map;return ee.value.forEach(t=>{if(!t.team_id)return;e.has(t.team_id)||e.set(t.team_id,{total:0,count:0});const s=e.get(t.team_id),l=t.user_id===y.value?.user_id?Math.max(L.value,t.score||0):t.score||0;s.total+=l,s.count+=1}),a.forEach((t,s)=>{const l=e.get(s),f=l&&l.count>0?l.total/l.count:0;t.localAvg=f}),Array.from(a.values()).map(t=>({...t,displayAvg:t.authAvg||t.localAvg||0}))}),N=r(()=>{const a=q.value;if(!a)return null;const e=U.value.find(t=>t.id===a.id);return e?e.displayAvg:null}),j=r(()=>[...U.value].sort((a,e)=>e.displayAvg-a.displayAvg)),d=T([]),p=T(new Map),m=T(0),v=r(()=>d.value[m.value]),b=r(()=>v.value&&p.value.get(v.value.id)||null),I=r(()=>b.value?.characters||[]),O=r(()=>b.value?.correctBreaks||new Set),A=r({get:()=>b.value?.userBreaks||new Map,set:a=>{if(v.value&&p.value.has(v.value.id)){const e=p.value.get(v.value.id);e.userBreaks=a}}}),x=T(0);let M=null;const Y=r(()=>O.value.size),ae=r(()=>A.value.size),H=r(()=>Math.max(0,Y.value-ae.value)),se=r(()=>H.value>0),V=T(!1),J=T(null);let _=null,w=!1,R=!1;const K=T(!0);function ne(a){const e=[],t=new Set;let s=0;const l=a.replace(/[\|\s]+$/,"");for(const f of l)f==="|"?s>0&&t.add(s-1):f!==`
`&&f!=="\r"&&(e.push(f),s++);return{chars:e,breaks:t}}function le(){p.value.clear();for(const a of d.value){const e=ne(a.content);p.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Map})}}function re(a){a>=0&&a<d.value.length&&(m.value=a)}function oe(){m.value>0&&m.value--}function ie(){m.value<d.value.length-1&&m.value++}let E=null;function G(a){try{E||(E=new AudioContext);const e=E,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function D(a=10){navigator.vibrate&&navigator.vibrate(a)}function ce(a){if(!v.value)return;const e=p.value.get(v.value.id);if(!e||e.userBreaks.has(a))return;if(e.userBreaks.size>=e.correctBreaks.size){G("error"),V.value=!0,setTimeout(()=>{V.value=!1},300),D(50);return}const t={index:a,isCorrect:e.correctBreaks.has(a),placedAt:Date.now()},s=new Map(e.userBreaks);s.set(a,t),e.userBreaks=s,p.value=new Map(p.value),J.value=t.placedAt,t.isCorrect?(G("add"),D(10)):(G("error"),D(50)),W();const l=F();fe(l.totalCorrect),l.usedBeansAll>=l.totalBeansAll&&W(!0)}function ue(a){const e=A.value.get(a);return{"has-bean":!!e,correct:e?.isCorrect,extra:e&&!e.isCorrect}}function Q(a){let e=0,t=0;return a.userBreaks.forEach(s=>{s.isCorrect?e++:t++}),{correct:e,wrong:t}}function F(){let a=0,e=0,t=0;return p.value.forEach(s=>{const l=Q(s);a+=l.correct,e+=s.correctBreaks.size,t+=s.userBreaks.size}),{totalCorrect:a,totalBeansAll:e,usedBeansAll:t}}function de(a=!1){if(!v.value||!b.value)return null;const{correct:e,wrong:t}=Q(b.value),{totalCorrect:s,totalBeansAll:l,usedBeansAll:f}=F(),he=J.value||Date.now(),_e=a||f>=l;return{roomId:P.value,textId:v.value.id,textIndex:m.value,correctCount:e,wrongCount:t,totalCorrect:s,totalBeans:l,usedBeans:f,lastInteraction:he,isFinished:_e}}async function $(a=!1){_&&(clearTimeout(_),_=null);const e=de(a);if(e&&!R){R=!0;try{await g.updateProgress(e)}catch(t){console.error("[GamePlay] 更新進度失敗",t)}finally{R=!1}}}function W(a=!1){a&&(w=!0),_&&clearTimeout(_),_=setTimeout(()=>{$(w),w=!1},ot)}async function ve(a=!1){await $(a);try{await g.endGame()}catch(e){console.error("[GamePlay] 結束遊戲失敗",e)}}function C(a){const e=p.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(l=>e.userBreaks.has(l))?"complete":"partial"}function me(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function pe(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const e=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);x.value=Math.max(0,c.value.time_limit-t),x.value===0&&ve(!0)};a(),M=setInterval(a,1e3)}ye(()=>c.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),X.push({name:"arena-result",params:{roomId:P.value}}))}),ke(async()=>{g.subscribeToRoom(P.value),c.value?.text_ids&&c.value.text_ids.length>0?d.value=await g.fetchTexts(c.value.text_ids):c.value?.text_id&&(d.value=await g.fetchTexts([c.value.text_id])),K.value=!1,d.value.length>0&&(le(),pe())}),be(()=>{M&&clearInterval(M),_&&clearTimeout(_),$(w)});function fe(a){if(y.value&&(y.value.score=a),c.value?.participants){const e=c.value.participants.map(t=>t.user_id===y.value?.user_id?{...t,score:a}:t);c.value.participants=e}}return(a,e)=>(i(),o("div",we,[K.value?(i(),o("div",Ce,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(i(),o(B,{key:1},[n("header",Se,[n("div",Pe,[n("div",{class:k(["countdown",{warning:x.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",ze,u(me(x.value)),1)],2)]),n("div",Ie,[n("span",Me,u(v.value?.title),1),v.value?.author?(i(),o("span",Ve,u(v.value.author),1)):h("",!0)]),n("div",Re,[n("div",Ee,[n("div",Ge,[e[2]||(e[2]=n("span",{class:"chip-label"},"個人分數",-1)),n("span",De,u(L.value),1)]),N.value!==null?(i(),o("div",Fe,[e[3]||(e[3]=n("span",{class:"chip-label"},"團隊平均",-1)),n("span",$e,u(N.value?.toFixed(2)),1)])):h("",!0)]),e[4]||(e[4]=n("div",{class:"live-pill"},[n("span",{class:"live-dot"}),n("span",null,"實時計分")],-1))])]),d.value.length>1?(i(),o("div",qe,[(i(!0),o(B,null,S(d.value,(t,s)=>(i(),o("button",{key:t.id,class:k(["text-tab",{active:s===m.value,empty:C(t.id)==="empty",partial:C(t.id)==="partial",complete:C(t.id)==="complete"}]),onClick:l=>re(s)},[n("span",Ue,u(s+1),1),n("span",Ne,u(t.title),1),C(t.id)==="complete"?(i(),o("span",je,"✓")):h("",!0)],10,Le))),128))])):h("",!0),n("main",Oe,[n("div",Ye,[e[5]||(e[5]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",He,[n("div",{class:k(["bean-inventory",{shake:V.value,empty:!se.value}])},[(i(!0),o(B,null,S(Y.value,t=>(i(),o("span",{key:t,class:k(["inventory-bean",{used:t>H.value}])},null,2))),128))],2)])]),n("div",Je,[I.value.length?(i(),o("div",Ke,[(i(!0),o(B,null,S(I.value,(t,s)=>(i(),o("span",{key:s,class:"char-unit"},[n("span",Qe,u(t),1),s<I.value.length-1?(i(),o("button",{key:0,class:k(["bean-slot",ue(s)]),onClick:l=>ce(s),"aria-label":`在「${t}」後放置斷句`},[A.value.has(s)?(i(),o("span",Xe)):h("",!0),e[6]||(e[6]=n("span",{class:"bean-hint"},null,-1))],10,We)):h("",!0)]))),128))])):h("",!0)]),n("div",Ze,[n("span",null,"已標記 "+u(A.value.size)+" / "+u(O.value.size)+" 處",1)]),j.value.length?(i(),o("div",et,[(i(!0),o(B,null,S(j.value,t=>(i(),o("div",{class:k(["team-row",{me:t.id===q.value?.id}]),key:t.id},[n("span",tt,u(t.name),1),n("span",at,u(t.displayAvg.toFixed(2)),1)],2))),128))])):h("",!0),d.value.length>1?(i(),o("div",st,[n("button",{class:"nav-btn",disabled:m.value===0,onClick:oe}," ← 上一篇 ",8,nt),n("span",lt,u(m.value+1)+" / "+u(d.value.length),1),n("button",{class:"nav-btn",disabled:m.value===d.value.length-1,onClick:ie}," 下一篇 → ",8,rt)])):h("",!0)]),e[7]||(e[7]=n("footer",{class:"play-footer"},[n("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),pt=Ae(it,[["__scopeId","data-v-d3bf3468"]]);export{pt as default};
