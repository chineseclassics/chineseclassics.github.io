import{d as se,r as b,C as R,c as D,p as oe,a as s,b as e,i as A,f as F,x as W,F as x,h as B,e as _,t as o,l as H,w as j,T as q,D as J,n as U,E as k,o as a,y as $,z as w,_ as ie}from"./index-B1PfcdJQ.js";import{u as de,a as re}from"./practiceLibraryStore-Cl3lXquc.js";import"./useSupabase-ChpSMRYh.js";const ue={class:"admin-shell"},ce={class:"admin-header"},ve={class:"header-actions"},me=["disabled"],pe=["disabled"],fe={class:"admin-layout"},be={class:"category-sidebar edamame-glass"},ye={class:"sidebar-header"},_e={key:0,class:"sidebar-loading"},ke={key:1,class:"sidebar-empty"},ge={key:2,class:"category-tree"},he=["onClick"],Ce=["onClick"],xe={class:"tree-label"},$e={class:"tree-count"},we={class:"tree-actions"},Te=["onClick"],Ve=["onClick"],Le=["onClick"],Me={key:0,class:"tree-children"},Se=["onClick"],De={class:"tree-label"},Fe={class:"tree-count"},Be={class:"tree-actions"},Ue=["onClick"],Ee=["onClick"],Ie=["onClick"],Ge={class:"content-panel edamame-glass"},Ne={key:0,class:"content-empty"},Oe={class:"content-breadcrumb"},ze=["onClick"],Pe={key:0,class:"breadcrumb-sep"},Ae={class:"category-info"},He={key:0,class:"category-desc"},je={class:"category-meta"},qe={key:0,class:"module-grid"},Je=["onClick"],Ke={class:"module-desc"},Qe={class:"module-count"},Re={key:1,class:"text-list"},We={key:0,class:"text-empty"},Xe={key:1},Ye={class:"text-title"},Ze={class:"text-summary"},et={class:"actions"},tt=["onClick"],lt=["onClick"],nt={class:"modal-card edamame-glass"},at={class:"modal-body"},st={class:"form-context"},ot={class:"form-row"},it={class:"preview-panel"},dt=["innerHTML"],rt={key:0,class:"feedback"},ut=["disabled"],ct={class:"modal-card edamame-glass small-modal"},vt={class:"modal-body"},mt=["placeholder"],pt={key:0,class:"feedback"},ft=["disabled"],bt={class:"modal-card edamame-glass small-modal"},yt={key:0,class:"feedback"},_t={class:"confirm-actions"},kt=["disabled"],gt=se({__name:"AdminTextsPage",setup(ht){const y=de(),v=re(),p=b(null),g=b(new Set),h=b(!1),C=b(!1),T=b(!1),m=b(!1),V=b(null),L=b(null),f=b(null),u=b(null),i=R({title:"",author:"",source:"",summary:"",content:""}),d=R({name:"",description:"",parentId:null,type:"grade"}),E=D(()=>v.state.categories.filter(l=>l.level===1).sort((l,t)=>l.order_index-t.order_index)),c=D(()=>v.state.categories.find(l=>l.id===p.value)??null),I=D(()=>{if(!c.value)return[];const l=[];let t=c.value;for(;t;)l.unshift(t),t=v.state.categories.find(n=>n.id===t?.parent_id);return l}),N=D(()=>p.value?y.texts.filter(l=>l.category_id===p.value).sort((l,t)=>(t.created_at??"").localeCompare(l.created_at??"")):[]),X=D(()=>{if(!i.content)return"";let l=i.content.replace(/[「」『』"""'']/g,"");return l=l.replace(/[。！？；，：、]/g,"|"),l=l.replace(/\|{2,}/g,"|"),l=l.replace(/^\|+|\|+$/g,""),l.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function M(l){return v.state.categories.filter(t=>t.level===2&&t.parent_id===l).sort((t,n)=>t.order_index-n.order_index)}function K(l){return y.texts.filter(t=>t.category_id===l).length}function Y(l){g.value.has(l)?g.value.delete(l):g.value.add(l)}function G(l){p.value=l;const t=v.state.categories.find(n=>n.id===l);t?.parent_id&&g.value.add(t.parent_id)}function O(){V.value=null,i.title="",i.author="",i.source="",i.summary="",i.content="",u.value=null,h.value=!0}function Z(l){V.value=l.id,i.title=l.title,i.author=l.author??"",i.source=l.source??"",i.summary=l.summary??"",i.content=l.content,u.value=null,h.value=!0}async function ee(){if(!i.title||!i.content){u.value="標題與內容為必填";return}if(!p.value){u.value="請先選擇一個分類";return}const l=c.value;if(!l||l.level!==2){u.value="請選擇一個單元（而非年級）來新增文章";return}try{m.value=!0;const t={title:i.title,author:i.author||null,source:i.source||null,summary:i.summary||null,category_id:p.value,content:i.content};V.value?await y.updateText(V.value,t):await y.addText(t),h.value=!1}catch(t){u.value=t?.message??"儲存失敗"}finally{m.value=!1}}function S(l,t){L.value=null,d.name="",d.description="",d.parentId=l,d.type=t,u.value=null,C.value=!0}function Q(l){L.value=l,d.name=l.name,d.description=l.description??"",d.parentId=l.parent_id,d.type=l.level===1?"grade":"module",u.value=null,C.value=!0}async function te(){if(!d.name.trim()){u.value="名稱不可為空";return}try{m.value=!0,L.value?await v.updateCategory(L.value.id,{name:d.name.trim(),description:d.description.trim()||void 0}):await v.addCategory({name:d.name.trim(),parent_id:d.parentId,type:d.type,description:d.description.trim()||void 0}),C.value=!1}catch(l){u.value=l?.message??"儲存失敗"}finally{m.value=!1}}function z(l,t){f.value={type:l,item:t},u.value=null,T.value=!0}async function le(){if(f.value)try{m.value=!0,f.value.type==="text"?await y.deleteText(f.value.item.id):(await v.deleteCategory(f.value.item.id),p.value===f.value.item.id&&(p.value=null)),T.value=!1,f.value=null}catch(l){u.value=l?.message??"刪除失敗"}finally{m.value=!1}}function ne(l){return l?l===1?"初級":l===2?"中級":"高級":"未標註"}function ae(l){return l?new Date(l).toLocaleDateString():"--"}return oe(async()=>{if(v.state.categories.length||await v.fetchLibrary(),y.texts.length||await y.fetchTexts(),E.value.length>0){const l=E.value[0];if(l){g.value.add(l.id);const t=M(l.id)[0];t&&(p.value=t.id)}}}),(l,t)=>(a(),s("div",ue,[e("header",ce,[t[18]||(t[18]=e("div",null,[e("p",{class:"edamame-text-level-detail"},"管理員 · 文章資料庫"),e("h1",{class:"edamame-heading-gradient"},"句豆練習素材")],-1)),e("div",ve,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[0]||(t[0]=n=>{F(v).fetchLibrary(),F(y).fetchTexts()}),disabled:F(v).isLoading||F(y).isLoading}," 重新整理 ",8,me),e("button",{class:"edamame-btn edamame-btn-primary",onClick:O,disabled:!c.value||c.value.level!==2}," 新增文章 ",8,pe)])]),e("div",fe,[e("aside",be,[e("div",ye,[t[20]||(t[20]=e("span",{class:"sidebar-title"},"分類導航",-1)),e("button",{class:"icon-btn",onClick:t[1]||(t[1]=n=>S(null,"grade")),title:"新增年級"},[...t[19]||(t[19]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M12 5v14M5 12h14"})],-1)])])]),F(v).isLoading?(a(),s("div",_e,"載入中⋯")):E.value.length?(a(),s("nav",ge,[(a(!0),s(x,null,B(E.value,n=>(a(),s("div",{key:n.id,class:"tree-node"},[e("div",{class:U(["tree-item grade-item",{selected:p.value===n.id}]),onClick:r=>G(n.id)},[e("button",{class:"expand-btn",onClick:k(r=>Y(n.id),["stop"])},[(a(),s("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",class:U({expanded:g.value.has(n.id)})},[...t[22]||(t[22]=[e("path",{d:"M8 5l8 7-8 7V5z"},null,-1)])],2))],8,Ce),e("span",xe,o(n.name),1),e("span",$e,o(M(n.id).length),1),e("div",we,[e("button",{class:"action-btn",onClick:k(r=>S(n.id,"module"),["stop"]),title:"新增單元"},"+",8,Te),e("button",{class:"action-btn",onClick:k(r=>Q(n),["stop"]),title:"編輯"},"✎",8,Ve),e("button",{class:"action-btn danger",onClick:k(r=>z("category",n),["stop"]),title:"刪除"},"×",8,Le)])],10,he),g.value.has(n.id)?(a(),s("div",Me,[(a(!0),s(x,null,B(M(n.id),r=>(a(),s("div",{key:r.id,class:U(["tree-item module-item",{selected:p.value===r.id}]),onClick:P=>G(r.id)},[e("span",De,o(r.name),1),e("span",Fe,o(K(r.id)),1),e("div",Be,[e("button",{class:"action-btn",onClick:k(P=>Q(r),["stop"]),title:"編輯"},"✎",8,Ue),e("button",{class:"action-btn danger",onClick:k(P=>z("category",r),["stop"]),title:"刪除"},"×",8,Ee)])],10,Se))),128)),e("button",{class:"add-module-btn",onClick:r=>S(n.id,"module")}," + 新增單元 ",8,Ie)])):_("",!0)]))),128))])):(a(),s("div",ke,[t[21]||(t[21]=W(" 尚無分類 ",-1)),e("button",{class:"link-btn",onClick:t[2]||(t[2]=n=>S(null,"grade"))},"建立第一個年級")]))]),e("main",Ge,[c.value?(a(),s(x,{key:1},[e("div",Oe,[(a(!0),s(x,null,B(I.value,(n,r)=>(a(),s("span",{key:n.id,class:U(["breadcrumb-item",{active:r===I.value.length-1}]),onClick:P=>G(n.id)},[W(o(n.name)+" ",1),r<I.value.length-1?(a(),s("span",Pe,"›")):_("",!0)],10,ze))),128))]),e("div",Ae,[e("h2",null,o(c.value.name),1),c.value.description?(a(),s("p",He,o(c.value.description),1)):_("",!0),e("p",je,o(c.value.level===1?"年級":"單元")+" · "+o(c.value.level===1?`${M(c.value.id).length} 個單元`:`${N.value.length} 篇文章`),1)]),c.value.level===1?(a(),s("div",qe,[(a(!0),s(x,null,B(M(c.value.id),n=>(a(),s("div",{key:n.id,class:"module-card",onClick:r=>G(n.id)},[e("h3",null,o(n.name),1),e("p",Ke,o(n.description||"暫無描述"),1),e("p",Qe,o(K(n.id))+" 篇文章",1)],8,Je))),128)),e("button",{class:"module-card add-card",onClick:t[3]||(t[3]=n=>S(c.value.id,"module"))},[...t[24]||(t[24]=[e("span",{class:"add-icon"},"+",-1),e("span",null,"新增單元",-1)])])])):(a(),s("div",Re,[N.value.length?(a(),s("table",Xe,[t[26]||(t[26]=e("thead",null,[e("tr",null,[e("th",null,"標題"),e("th",null,"作者"),e("th",null,"難度"),e("th",null,"建立日期"),e("th",{style:{width:"120px"}},"操作")])],-1)),e("tbody",null,[(a(!0),s(x,null,B(N.value,n=>(a(),s("tr",{key:n.id},[e("td",null,[e("p",Ye,o(n.title),1),e("p",Ze,o(n.summary||n.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),e("td",null,o(n.author||"佚名"),1),e("td",null,[e("span",{class:U(["difficulty-badge",`diff-${n.difficulty}`])},o(ne(n.difficulty)),3)]),e("td",null,o(ae(n.created_at)),1),e("td",et,[e("button",{class:"ghost-btn",onClick:r=>Z(n)},"編輯",8,tt),e("button",{class:"ghost-btn danger",onClick:r=>z("text",n)},"刪除",8,lt)])]))),128))])])):(a(),s("div",We,[t[25]||(t[25]=e("p",null,"此單元尚無文章",-1)),e("button",{class:"edamame-btn edamame-btn-primary",onClick:O},"新增第一篇文章")])),e("button",{class:"add-text-btn",onClick:O}," + 在「"+o(c.value.name)+"」新增文章 ",1)]))],64)):(a(),s("div",Ne,[...t[23]||(t[23]=[e("p",null,"請從左側選擇一個分類",-1)])]))])]),(a(),A(J,{to:"body"},[H(q,{name:"fade"},{default:j(()=>[h.value?(a(),s("div",{key:0,class:"modal-backdrop",onClick:t[10]||(t[10]=k(n=>h.value=!1,["self"]))},[e("div",nt,[e("header",null,[e("h3",null,o(V.value?"編輯文章":"新增文章"),1),e("button",{class:"close-btn",onClick:t[4]||(t[4]=n=>h.value=!1)},"×")]),e("div",at,[e("p",st,"將新增至："+o(I.value.map(n=>n.name).join(" › ")),1),e("label",null,[t[27]||(t[27]=e("span",null,"標題",-1)),$(e("input",{"onUpdate:modelValue":t[5]||(t[5]=n=>i.title=n),type:"text",placeholder:"請輸入標題"},null,512),[[w,i.title]])]),e("div",ot,[e("label",null,[t[28]||(t[28]=e("span",null,"作者",-1)),$(e("input",{"onUpdate:modelValue":t[6]||(t[6]=n=>i.author=n),type:"text",placeholder:"例如：孔子"},null,512),[[w,i.author]])]),e("label",null,[t[29]||(t[29]=e("span",null,"來源",-1)),$(e("input",{"onUpdate:modelValue":t[7]||(t[7]=n=>i.source=n),type:"text",placeholder:"例如：論語"},null,512),[[w,i.source]])])]),e("label",null,[t[30]||(t[30]=e("span",null,"內容（標點將自動轉為斷句符號）",-1)),$(e("textarea",{"onUpdate:modelValue":t[8]||(t[8]=n=>i.content=n),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[w,i.content]])]),e("div",it,[t[31]||(t[31]=e("p",null,"預覽",-1)),e("div",{class:"preview-content",innerHTML:X.value||"尚無內容"},null,8,dt)]),u.value?(a(),s("p",rt,o(u.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[9]||(t[9]=n=>h.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:m.value,onClick:ee},o(m.value?"儲存中...":"儲存"),9,ut)])])])):_("",!0)]),_:1})])),(a(),A(J,{to:"body"},[H(q,{name:"fade"},{default:j(()=>[C.value?(a(),s("div",{key:0,class:"modal-backdrop",onClick:t[15]||(t[15]=k(n=>C.value=!1,["self"]))},[e("div",ct,[e("header",null,[e("h3",null,o(L.value?"編輯分類":d.type==="grade"?"新增年級":"新增單元"),1),e("button",{class:"close-btn",onClick:t[11]||(t[11]=n=>C.value=!1)},"×")]),e("div",vt,[e("label",null,[t[32]||(t[32]=e("span",null,"名稱",-1)),$(e("input",{"onUpdate:modelValue":t[12]||(t[12]=n=>d.name=n),type:"text",placeholder:d.type==="grade"?"例如：七年級":"例如：論語讀本"},null,8,mt),[[w,d.name]])]),e("label",null,[t[33]||(t[33]=e("span",null,"描述（選填）",-1)),$(e("textarea",{"onUpdate:modelValue":t[13]||(t[13]=n=>d.description=n),rows:"2",placeholder:"簡述此分類的內容範圍"},null,512),[[w,d.description]])]),u.value?(a(),s("p",pt,o(u.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[14]||(t[14]=n=>C.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:m.value,onClick:te},o(m.value?"儲存中...":"儲存"),9,ft)])])])):_("",!0)]),_:1})])),(a(),A(J,{to:"body"},[H(q,{name:"fade"},{default:j(()=>[T.value?(a(),s("div",{key:0,class:"modal-backdrop",onClick:t[17]||(t[17]=k(n=>T.value=!1,["self"]))},[e("div",bt,[t[34]||(t[34]=e("h3",null,"確定刪除？",-1)),e("p",null,"「"+o(f.value?.item?"title"in f.value.item?f.value.item.title:f.value.item.name:"")+"」刪除後將無法復原。",1),u.value?(a(),s("p",yt,o(u.value),1)):_("",!0),e("div",_t,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[16]||(t[16]=n=>T.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-danger",disabled:m.value,onClick:le},o(m.value?"刪除中...":"刪除"),9,kt)])])])):_("",!0)]),_:1})]))]))}}),wt=ie(gt,[["__scopeId","data-v-acf47598"]]);export{wt as default};
