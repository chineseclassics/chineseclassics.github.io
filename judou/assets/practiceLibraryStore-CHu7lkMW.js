import{v as B,u as D,r as p,c as w}from"./index-D9gKiMYl.js";import{u as R}from"./useSupabase-OSEhMWY9.js";const F=/[。！？；，：]/g,K=/[「」『』“”"']/g,P=/\|{2,}/g;function G(r){if(!r)return"";const c=r.replace(K,"").replace(F,"|").replace(P,"|").trim();return c.endsWith("|")?c.slice(0,-1):c}function A(r){const t=r.replace(/\|/g,"").length;return t<=70?1:t<=150?2:3}function M(r){return r.replace(/\|/g,"").length}const Q=B("texts",()=>{const r=R(),t=D(),o=p([]),c=p(!1),h=p(null),E=w(()=>[...o.value].sort((n,a)=>(a.created_at??"").localeCompare(n.created_at??"")));async function x(){if(!r){h.value="Supabase 尚未配置";return}c.value=!0,h.value=null;try{const{data:n,error:a}=await r.from("practice_texts").select(`
          *,
          category:practice_categories (
            id,
            name,
            slug,
            level,
            parent_id
          )
        `).order("created_at",{ascending:!1});if(a)throw a;o.value=n||[]}catch(n){h.value=n.message??"無法載入文章"}finally{c.value=!1}}async function I(n,a=!1){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const l=G(n.content),u=A(l),m=M(l);if(a&&!t.isAdmin)throw new Error("只有管理員可以創建系統文章");if(!a&&!t.isTeacher)throw new Error("只有老師可以創建私有文章");const{data:_,error:v}=await r.from("practice_texts").insert({title:n.title,author:n.author??null,source:n.source??null,summary:n.summary??null,category_id:n.category_id||null,content:l,difficulty:u,word_count:m,is_system:a,created_by:a?null:t.user.id}).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(v)throw v;_&&o.value.unshift(_)}async function T(n,a){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const{data:l}=await r.from("practice_texts").select("is_system, created_by").eq("id",n).single();if(l){if(l.is_system&&!t.isAdmin)throw new Error("只有管理員可以更新系統文章");if(!l.is_system&&l.created_by!==t.user.id)throw new Error("只能更新自己創建的文章")}const u=G(a.content),m=A(u),_=M(u),{data:v,error:y}=await r.from("practice_texts").update({title:a.title,author:a.author??null,source:a.source??null,summary:a.summary??null,category_id:a.category_id||null,content:u,difficulty:m,word_count:_}).eq("id",n).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(y)throw y;v&&(o.value=o.value.map(e=>e.id===n?v:e))}async function b(n){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const{data:a}=await r.from("practice_texts").select("is_system, created_by").eq("id",n).single();if(a){if(a.is_system&&!t.isAdmin)throw new Error("只有管理員可以刪除系統文章");if(!a.is_system&&a.created_by!==t.user.id)throw new Error("只能刪除自己創建的文章")}const{error:l}=await r.from("practice_texts").delete().eq("id",n);if(l)throw l;o.value=o.value.filter(u=>u.id!==n)}async function C(n){if(!r)return null;const a=n.username??"anonymous_user",l=n.display_name??"匿名學員",{data:u,error:m}=await r.from("practice_records").insert({...n,username:a,display_name:l}).select("id").single();return m?(console.error("記錄練習結果失敗:",m),null):u?.id||null}function S(){if(!o.value.length)return null;const n=Math.floor(Math.random()*o.value.length);return o.value[n]}return{texts:o,sortedTexts:E,isLoading:c,error:h,fetchTexts:x,addText:I,updateText:T,deleteText:b,recordPracticeResult:C,getRandomText:S}}),L=[{id:"grade-7",name:"七年級",slug:"grade-7",parent_id:null,level:1,type:"grade",description:"適合初階練習者，聚焦於啟蒙經典與日常應用題材。",order_index:1},{id:"grade-7-module-lunyu",name:"論語讀本",slug:"grade-7-module-lunyu",parent_id:"grade-7",level:2,type:"module",description:"以語錄題材培養句型感與節奏感。",order_index:1},{id:"grade-7-theme-renyi",name:"仁義篇",slug:"grade-7-theme-renyi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"圍繞「仁」與「義」的章句，適合練習短句斷讀。",order_index:1},{id:"grade-7-theme-xuexi",name:"學習篇",slug:"grade-7-theme-xuexi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"關於求學與修身的篇章，句式多變。",order_index:2},{id:"anthology-guwenguan-zhi",name:"古文觀止",slug:"anthology-guwenguan-zhi",parent_id:null,level:1,type:"grade",description:"以主題式選編進行高階訓練。",order_index:2},{id:"anthology-guwenguan-zhi-warring",name:"戰國策",slug:"anthology-guwenguan-zhi-warring",parent_id:"anthology-guwenguan-zhi",level:2,type:"module",description:"戰國時期縱橫家精彩篇章，節奏快速。",order_index:1},{id:"anthology-guwenguan-zhi-warring-theme",name:"遊說名篇",slug:"anthology-guwenguan-zhi-warring-theme",parent_id:"anthology-guwenguan-zhi-warring",level:3,type:"theme",description:"以遊說篇章作為高階斷句挑戰。",order_index:1}],U=[{id:"text-renyi-01",title:"論語・學而篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:1,summary:"子曰：「弟子入則孝...」",word_count:86,content:"子曰|弟子入則孝||出則弟|信而好|犯而不|怨..."},{id:"text-renyi-02",title:"論語・里仁篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:2,summary:"里仁為美，擇其善者而從之。",word_count:120,content:"子曰|里仁為美|擇不處仁|焉得知||仁者安仁|知者利仁"},{id:"text-xuexi-01",title:"論語・為政篇",author:"孔子及弟子",category_id:"grade-7-theme-xuexi",difficulty:2,summary:"溫故而知新，可以為師矣。",word_count:95,content:"子曰|溫故而知新|可以為師矣|學而不思則罔|思而不學則殆"},{id:"text-warring-01",title:"蘇秦說齊王",author:"蘇秦",category_id:"anthology-guwenguan-zhi-warring-theme",difficulty:3,summary:"以合縱策略說服齊王，語勢跌宕。",word_count:260,content:"蘇秦曰|大王處東海之濱|南有江淮之饒|北有燕代之利|..."}];function q(r){return r.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-\u4e00-\u9fa5]/g,"").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||`category-${Date.now()}`}const $=B("practice-library",()=>{const r=R(),t=p({categories:[],texts:[],selectedGradeId:null,selectedModuleId:null,selectedThemeId:null,selectedTextId:null}),o=p(!1),c=p(null);function h(){t.value.categories=[...L],t.value.texts=[...U],t.value.selectedGradeId=t.value.selectedGradeId??L.find(e=>e.level===1)?.id??null}async function E(){o.value=!0,c.value=null;try{if(!r){h();return}const{data:e,error:i}=await r.from("practice_categories").select("*").order("level",{ascending:!0}).order("order_index",{ascending:!0});if(i)throw i;if(!e?.length){h();return}const{data:s,error:d}=await r.from("practice_texts").select("*").order("title",{ascending:!0});if(d)throw d;t.value.categories=e,t.value.texts=s||[],t.value.selectedGradeId=t.value.selectedGradeId??t.value.categories.find(g=>g.level===1)?.id??null}catch(e){console.error("Failed to load practice library",e),c.value=e?.message??"無法載入練習庫",h()}finally{o.value=!1}}function x(e){e==="grade"&&(t.value.selectedModuleId=null,t.value.selectedThemeId=null),e!=="theme"&&(t.value.selectedTextId=null),e==="module"&&(t.value.selectedThemeId=null)}const I=w(()=>[...t.value.categories].sort((e,i)=>e.level===i.level?e.order_index-i.order_index:e.level-i.level)),T=w(()=>I.value.filter(e=>e.level===1)),b=w(()=>t.value.categories.filter(e=>e.parent_id===t.value.selectedGradeId)),C=w(()=>t.value.categories.filter(e=>e.parent_id===t.value.selectedModuleId)),S=w(()=>{const e=t.value.selectedThemeId??t.value.selectedModuleId??t.value.selectedGradeId;return e?t.value.texts.filter(i=>i.category_id===e):[]}),n=w(()=>t.value.texts.find(e=>e.id===t.value.selectedTextId)??null);function a(e){t.value.selectedGradeId!==e&&(t.value.selectedGradeId=e,x("grade"))}function l(e){t.value.selectedModuleId!==e&&(t.value.selectedModuleId=e,x("module"))}function u(e){t.value.selectedThemeId!==e&&(t.value.selectedThemeId=e,x("theme"))}function m(e){t.value.selectedTextId=e}async function _(e){if(!r)throw new Error("Supabase 尚未配置");const i=e.parent_id?t.value.categories.find(z=>z.id===e.parent_id):null;if(e.type!=="grade"&&!i)throw new Error("請選擇上層分類");if(i&&i.level>=3)throw new Error("目前僅支援三級分類");const s=i?i.level+1:1,d=e.type??(i?i.level===1?"module":"theme":"grade"),{data:g,error:f}=await r.from("practice_categories").insert({name:e.name,slug:q(e.name),parent_id:e.parent_id,level:s,type:d,description:e.description??null,order_index:e.order_index??0}).select("*").single();if(f)throw f;return g&&t.value.categories.push(g),g}async function v(e,i){if(!r)throw new Error("Supabase 尚未配置");const s={};i.name!==void 0&&(s.name=i.name,s.slug=q(i.name)),i.description!==void 0&&(s.description=i.description),i.order_index!==void 0&&(s.order_index=i.order_index);const{data:d,error:g}=await r.from("practice_categories").update(s).eq("id",e).select("*").single();if(g)throw g;if(d){const f=t.value.categories.findIndex(z=>z.id===e);f!==-1&&(t.value.categories[f]=d)}return d}async function y(e){if(!r)throw new Error("Supabase 尚未配置");if(t.value.categories.some(f=>f.parent_id===e))throw new Error("此分類下還有子分類，請先刪除子分類");const{count:s,error:d}=await r.from("practice_texts").select("id",{count:"exact",head:!0}).eq("category_id",e);if(d)throw d;if(s&&s>0)throw new Error(`此分類下還有 ${s} 篇文章，請先移除或重新分類`);const{error:g}=await r.from("practice_categories").delete().eq("id",e);if(g)throw g;t.value.categories=t.value.categories.filter(f=>f.id!==e),t.value.selectedGradeId===e&&(t.value.selectedGradeId=null),t.value.selectedModuleId===e&&(t.value.selectedModuleId=null),t.value.selectedThemeId===e&&(t.value.selectedThemeId=null)}return{state:t,isLoading:o,error:c,rootCategories:T,modules:b,themes:C,visibleTexts:S,selectedText:n,fetchLibrary:E,selectGrade:a,selectModule:l,selectTheme:u,selectText:m,addCategory:_,updateCategory:v,deleteCategory:y}});export{$ as a,Q as u};
