import{v as Y,u as $,r as f,c as D,H as o}from"./index-Dt8rUSmR.js";const d=[0,30,100,200,350,550,850,1300,2e3,3e3],z=[{maxTime:1,factor:1.3},{maxTime:2,factor:1.2},{maxTime:3,factor:1.1},{maxTime:5,factor:1},{maxTime:8,factor:.9},{maxTime:1/0,factor:.7}],v=[1.2,1,.95,.9],B=[{minDays:30,factor:1.2},{minDays:14,factor:1.15},{minDays:7,factor:1.1},{minDays:3,factor:1.05},{minDays:0,factor:1}],K=1.2,y=5,_=10,re=Y("userStats",()=>{const l=$(),a=f(null),w=f(!1),h=f(null),m=f([]),g=f("total"),b=f(!1),p=f(null),S=D(()=>{if(!a.value)return 1;const e=a.value.total_beans;for(let t=d.length-1;t>=0;t--){const r=d[t];if(r!==void 0&&e>=r)return t+1}return 1}),q=D(()=>{if(!a.value)return 0;const e=S.value,t=d[e-1]||0,r=d[e]||t+1e3,n=a.value.total_beans-t,s=r-t;return Math.min(100,Math.round(n/s*100))}),M=D(()=>{if(!a.value)return 30;const e=S.value;if(e>=d.length)return 0;const t=d[e]||3e3;return Math.max(0,t-a.value.total_beans)});function x(e){for(const t of z)if(e<t.maxTime)return t.factor;return .7}function I(e){return e<=0?1:e>v.length?v[v.length-1]||.9:v[e-1]||.9}function R(e){for(const t of B)if(e>=t.minDays)return t.factor;return 1}function N(e){const{breakCount:t,charCount:r,elapsedSeconds:n,attemptCount:s,isFirstClear:c}=e,i=t*2,u=r>0?n/r:5,P=x(u),F=I(s),W=a.value?.streak_days||0,O=R(W),A=c?K:1;return{score:Math.round(i*P*F*O*A),breakdown:{baseScore:i,timeFactor:P,attemptFactor:F,streakFactor:O,firstClearFactor:A,avgTimePerChar:Math.round(u*10)/10}}}async function E(){if(!(!o||!l.user)){w.value=!0,h.value=null;try{const{data:e,error:t}=await o.from("profiles").select("*").eq("id",l.user.id).single();if(t){if(t.code==="PGRST116"){console.log("ç”¨æˆ¶ Profile ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º..."),await U();return}throw t}a.value=e,await k()}catch(e){h.value=e.message,console.error("ç²å–ç”¨æˆ¶ Profile å¤±æ•—:",e)}finally{w.value=!1}}}async function U(){if(!(!o||!l.user))try{const{data:e}=await o.from("users").select("display_name, email").eq("id",l.user.id).single(),t=e?.display_name||l.user.email?.split("@")[0]||"è±†å‹",r=t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),{data:n,error:s}=await o.from("profiles").insert({id:l.user.id,username:r+"_"+Date.now().toString(36),display_name:t,total_beans:0,weekly_beans:0,monthly_beans:0,streak_days:0,max_streak:0,daily_login_claimed:!1,daily_first_claimed:!1}).select().single();if(s){console.error("å‰µå»º Profile å¤±æ•—:",s);return}a.value=n,console.log("âœ… Profile å‰µå»ºæˆåŠŸ"),await k()}catch(e){console.error("å‰µå»ºåˆå§‹ Profile å¤±æ•—:",e)}}async function k(){if(!o||!a.value||!l.user)return!1;const e=new Date().toISOString().split("T")[0],t=a.value.last_login_date;if(t===e&&a.value.daily_login_claimed)return!1;try{const r={last_login_date:e,daily_login_claimed:!0,total_beans:a.value.total_beans+y,weekly_beans:a.value.weekly_beans+y,monthly_beans:a.value.monthly_beans+y,updated_at:new Date().toISOString()};t!==e&&(r.daily_first_claimed=!1);const{error:n}=await o.from("profiles").update(r).eq("id",l.user.id);if(n)throw n;return Object.assign(a.value,r),console.log(`ðŸŽ æ¯æ—¥ç™»å…¥çŽå‹µ +${y} è±†`),!0}catch(r){return console.error("ç™¼æ”¾æ¯æ—¥ç™»å…¥çŽå‹µå¤±æ•—:",r),!1}}async function L(){if(!o||!a.value||!l.user||a.value.daily_first_claimed)return 0;try{const e={daily_first_claimed:!0,total_beans:a.value.total_beans+_,weekly_beans:a.value.weekly_beans+_,monthly_beans:a.value.monthly_beans+_,updated_at:new Date().toISOString()},{error:t}=await o.from("profiles").update(e).eq("id",l.user.id);if(t)throw t;return Object.assign(a.value,e),console.log(`ðŸŽ æ¯æ—¥é¦–ç·´çŽå‹µ +${_} è±†`),_}catch(e){return console.error("ç™¼æ”¾æ¯æ—¥é¦–ç·´çŽå‹µå¤±æ•—:",e),0}}async function C(){if(!o||!a.value||!l.user)return;const e=new Date().toISOString().split("T")[0],t=a.value.last_practice_date;let r=a.value.streak_days;if(!t)r=1;else{const s=new Date(t),c=new Date(e),i=Math.floor((c.getTime()-s.getTime())/(1e3*60*60*24));if(i===0)return;i===1?r=a.value.streak_days+1:r=1}const n=Math.max(a.value.max_streak,r);try{const{error:s}=await o.from("profiles").update({streak_days:r,max_streak:n,last_practice_date:e,updated_at:new Date().toISOString()}).eq("id",l.user.id);if(s)throw s;a.value.streak_days=r,a.value.max_streak=n,a.value.last_practice_date=e}catch(s){console.error("æ›´æ–°é€£çºŒå¤©æ•¸å¤±æ•—:",s)}}async function G(e){if(!o||!l.user)return!1;try{const{data:t,error:r}=await o.from("user_text_scores").select("id").eq("user_id",l.user.id).eq("text_id",e).single();return r&&r.code==="PGRST116"?!0:!t}catch{return!1}}async function H(e){if(!o||!a.value||!l.user)return{beansEarned:0,isNewRecord:!1};const{textId:t,score:r}=e;try{const{data:n}=await o.from("user_text_scores").select("*").eq("user_id",l.user.id).eq("text_id",t).single();let s=0,c=!1;if(!n)await o.from("user_text_scores").insert({user_id:l.user.id,text_id:t,best_score:r,weekly_best:r,monthly_best:r,first_clear_at:new Date().toISOString(),attempt_count:1}),s=r,c=!0;else{const u={attempt_count:n.attempt_count+1,updated_at:new Date().toISOString()};r>n.best_score&&(s=r-n.best_score,u.best_score=r,c=!0),r>n.weekly_best&&(u.weekly_best=r),r>n.monthly_best&&(u.monthly_best=r),await o.from("user_text_scores").update(u).eq("id",n.id)}if(s>0){const{error:u}=await o.from("profiles").update({total_beans:a.value.total_beans+s,weekly_beans:a.value.weekly_beans+s,monthly_beans:a.value.monthly_beans+s,updated_at:new Date().toISOString()}).eq("id",l.user.id);u||(a.value.total_beans+=s,a.value.weekly_beans+=s,a.value.monthly_beans+=s)}await C();const i=await L();return s+=i,{beansEarned:s,isNewRecord:c}}catch(n){return console.error("è¨˜éŒ„ç·´ç¿’åˆ†æ•¸å¤±æ•—:",n),{beansEarned:0,isNewRecord:!1}}}async function T(e="total"){if(o){b.value=!0,g.value=e;try{const t=e==="weekly"?"weekly_beans":e==="monthly"?"monthly_beans":"total_beans",{data:r,error:n}=await o.from("profiles").select("id, display_name, total_beans, weekly_beans, monthly_beans").order(t,{ascending:!1}).limit(10);if(n)throw n;const s=l.user?.id;if(m.value=(r||[]).map((c,i)=>({rank:i+1,userId:c.id,name:c.display_name||"åŒ¿å",beans:e==="weekly"?c.weekly_beans:e==="monthly"?c.monthly_beans:c.total_beans,isCurrentUser:c.id===s})),s){const{count:c}=await o.from("profiles").select("*",{count:"exact",head:!0}).gt(t,a.value?.[t==="total_beans"?"total_beans":t==="weekly_beans"?"weekly_beans":"monthly_beans"]||0),{count:i}=await o.from("profiles").select("*",{count:"exact",head:!0});p.value={rank:(c||0)+1,totalUsers:i||0}}}catch(t){console.error("ç²å–æŽ’è¡Œæ¦œå¤±æ•—:",t),m.value=[]}finally{b.value=!1}}}function j(){a.value=null,m.value=[],p.value=null,h.value=null}return{profile:a,stats:a,loading:w,error:h,leaderboard:m,top10:m,leaderboardType:g,leaderboardLoading:b,top10Loading:b,rankInfo:p,level:S,levelProgress:q,beansToNextLevel:M,getTimeFactor:x,getAttemptFactor:I,getStreakFactor:R,calculateScore:N,fetchProfile:E,fetchStats:E,fetchLeaderboard:T,fetchTop10:()=>T("total"),fetchRankInfo:()=>T(g.value),checkFirstClear:G,recordPracticeScore:H,checkDailyLoginReward:k,checkDailyFirstPracticeReward:L,updateStreakDays:C,reset:j,DAILY_LOGIN_REWARD:y,DAILY_FIRST_PRACTICE_REWARD:_,LEVEL_THRESHOLDS:d}});export{re as u};
