import{v as D,u as O,r as f,c as v,H as s}from"./index-CljGePV0.js";const c=[0,100,300,600,1e3,1500,2200,3e3,4e3,5200,6600,8200,1e4,12e3,15e3],M=D("userStats",()=>{const u=O(),r=f(null),p=f(!1),o=f(null),d=f(null),_=f([]),h=f(!1),m=v(()=>{if(!r.value)return 1;const e=r.value.total_exp;for(let t=c.length-1;t>=0;t--){const a=c[t];if(a!==void 0&&e>=a)return t+1}return 1}),g=v(()=>{if(!r.value)return 0;const e=m.value,t=c[e-1]||0,a=c[e]||t+1e3,n=r.value.total_exp-t,l=a-t;return Math.min(100,Math.round(n/l*100))}),w=v(()=>{if(!r.value)return 100;const e=m.value,t=c[c.length-1]??15e3,a=c[e]??t+1e3;return Math.max(0,a-r.value.total_exp)}),S=v(()=>!r.value||r.value.total_practices===0?0:Math.round(r.value.correct_count/r.value.total_practices*100));async function b(){if(!(!s||!u.user)){p.value=!0,o.value=null;try{const{data:e,error:t}=await s.from("user_stats").select("*").eq("user_id",u.user.id).single();if(t){if(t.code==="PGRST116"){await E();return}throw t}r.value=e}catch(e){o.value=e.message,console.error("獲取用戶統計失敗:",e)}finally{p.value=!1}}}async function E(){if(!(!s||!u.user))try{const{data:e,error:t}=await s.from("user_stats").insert({user_id:u.user.id,beans:0,total_exp:0,total_practices:0,correct_count:0,streak_days:0}).select().single();if(t)throw t;r.value=e}catch(e){o.value=e.message,console.error("創建用戶統計失敗:",e)}}async function I(e){if(!s||!r.value)return!1;try{const t=r.value.beans+e,{error:a}=await s.from("user_stats").update({beans:t,updated_at:new Date().toISOString()}).eq("user_id",r.value.user_id);if(a)throw a;return r.value.beans=t,!0}catch(t){return o.value=t.message,!1}}async function k(e){if(!s||!r.value)return!1;try{const t=r.value.total_exp+e,{error:a}=await s.from("user_stats").update({total_exp:t,updated_at:new Date().toISOString()}).eq("user_id",r.value.user_id);if(a)throw a;return r.value.total_exp=t,!0}catch(t){return o.value=t.message,!1}}async function L(e,t,a){if(!s||!r.value)return!1;try{const n={beans:r.value.beans+t,total_exp:r.value.total_exp+a,total_practices:r.value.total_practices+1,correct_count:r.value.correct_count+(e?1:0),last_practice_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:l}=await s.from("user_stats").update(n).eq("user_id",r.value.user_id);if(l)throw l;return r.value.beans=n.beans,r.value.total_exp=n.total_exp,r.value.total_practices=n.total_practices,r.value.correct_count=n.correct_count,r.value.last_practice_at=n.last_practice_at,!0}catch(n){return o.value=n.message,!1}}async function T(){if(s){h.value=!0;try{const{data:e,error:t}=await s.from("profiles").select("id, display_name, final_score").order("final_score",{ascending:!1}).limit(10);if(t)throw t;if(!e||e.length===0){_.value=[];return}const a=u.user?.id;_.value=e.map((n,l)=>({rank:l+1,userId:n.id,name:n.display_name||"匿名",beans:n.final_score||0,isCurrentUser:n.id===a}))}catch(e){console.error("獲取前 10 名失敗:",e),_.value=[]}finally{h.value=!1}}}async function P(){if(!(!s||!u.user))try{const{data:e,error:t}=await s.from("profiles").select("id, display_name, final_score").order("final_score",{ascending:!1});if(t)throw t;if(!e||e.length===0){d.value=null;return}const a=e.findIndex(i=>i.id===u.user.id),n=a===-1?e.length+1:a+1,l=a>=0?e[a]?.final_score??0:0;let x=null;e.length>0&&e[0]&&(x={name:e[0].display_name||"匿名",beans:e[0].final_score||0});let y=null;if(n>1&&a>0){const i=e[a-1];i&&(y={name:i.display_name||"匿名",beans:i.final_score||0,gap:(i.final_score||0)-l})}d.value={rank:n,totalUsers:e.length,topUser:x,nextUser:y}}catch(e){console.error("獲取排名信息失敗:",e)}}function U(){r.value=null,d.value=null,o.value=null}return{stats:r,loading:p,error:o,rankInfo:d,top10:_,top10Loading:h,level:m,levelProgress:g,expToNextLevel:w,accuracy:S,fetchStats:b,fetchRankInfo:P,fetchTop10:T,addBeans:I,addExp:k,recordPractice:L,reset:U}});export{M as u};
