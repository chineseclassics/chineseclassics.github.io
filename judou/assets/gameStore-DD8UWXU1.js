import{v as ae,u as re,r as y,c as w,I as a}from"./index-BmjdZCnG.js";import{u as se}from"./userStatsStore-CSR9l9fy.js";const _e=[0,10,30,50,100],de=[{value:60,label:"閃電戰",description:"1 分鐘"},{value:180,label:"標準",description:"3 分鐘"},{value:300,label:"持久",description:"5 分鐘"}],me=[2,3,4],ie={3:5,5:10,7:20,10:50},x={DAILY_FEE_LIMIT:100,MIN_BALANCE:20,MAX_LOSS_STREAK:5},ne={red:{name:"紅隊",primary:"#ef4444",secondary:"#fecaca",text:"#991b1b"},blue:{name:"藍隊",primary:"#3b82f6",secondary:"#bfdbfe",text:"#1e40af"},green:{name:"綠隊",primary:"#22c55e",secondary:"#bbf7d0",text:"#166534"},yellow:{name:"黃隊",primary:"#eab308",secondary:"#fef08a",text:"#854d0e"}};function oe(u){return["red","blue","green","yellow"].slice(0,u)}function ue(u){return ne[u].name}const C=[{minLevel:1,maxLevel:2,title:"童生",color:"#78716c"},{minLevel:3,maxLevel:5,title:"秀才",color:"#22c55e"},{minLevel:6,maxLevel:9,title:"舉人",color:"#3b82f6"},{minLevel:10,maxLevel:14,title:"進士",color:"#8b5cf6"},{minLevel:15,maxLevel:19,title:"探花",color:"#f59e0b"},{minLevel:20,maxLevel:24,title:"榜眼",color:"#ef4444"},{minLevel:25,maxLevel:999,title:"狀元",color:"#dc2626"}];function fe(u){for(const f of C)if(u>=f.minLevel&&u<=f.maxLevel)return f;return C[0]}const pe=ae("game",()=>{const u=re(),f=se(),i=y(null),T=y([]),l=y(null),p=y(!1),o=y(null);let g=null;const v=w(()=>!i.value||!u.user?!1:i.value.host_id===u.user.id),P=w(()=>i.value?.status==="playing"),A=w(()=>i.value?.status==="waiting"),M=w(()=>i.value?.status==="finished"),N=w(()=>!l.value?.team_id||!i.value?.teams?null:i.value.teams.find(t=>t.id===l.value.team_id));async function O(t){if(!a||!u.user)return o.value="請先登入",null;p.value=!0,o.value=null;try{const{data:e,error:r}=await a.from("game_rooms").insert({host_id:u.user.id,host_type:t.hostType,game_mode:t.gameMode,text_id:t.textIds[0],text_ids:t.textIds,time_limit:t.timeLimit,team_count:t.teamCount||null,max_players:t.maxPlayers||null,entry_fee:t.entryFee||0,class_id:t.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url)
        `).single();if(r)return o.value=r.message,null;if(t.gameMode==="team_battle"&&t.teamCount){const n=oe(t.teamCount).map((d,m)=>({room_id:e.id,team_name:ue(d),team_color:d,order_index:m})),{data:c,error:_}=await a.from("game_teams").insert(n).select();_?console.error("創建團隊失敗:",_):e.teams=c}return t.hostType==="student"&&await E(e.id,t.entryFee||0),i.value=e,e}catch(e){return o.value=e.message,null}finally{p.value=!1}}async function G(t){if(!a||!u.user)return{success:!1,error:"請先登入"};p.value=!0,o.value=null;try{const{data:e,error:r}=await a.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",t.toUpperCase()).single();if(r||!e)return{success:!1,error:"找不到該房間"};if(e.status!=="waiting")return{success:!1,error:"該房間已開始或已結束"};const s=e.participants?.find(_=>_.user_id===u.user.id);if(s)return i.value=e,l.value=s,S(e.id),{success:!0,room:e,participant:s};if(e.max_players&&e.participants&&e.participants.length>=e.max_players)return{success:!1,error:"房間已滿"};if(e.entry_fee>0&&!await D(e.id,e.entry_fee))return{success:!1,error:o.value||"無法支付入場費"};const n=await E(e.id,e.entry_fee);if(!n)return{success:!1,error:o.value||"加入房間失敗"};const c=[...e.participants||[],n];return i.value={...e,participants:c},l.value=n,S(e.id),{success:!0,room:e,participant:n}}catch(e){return o.value=e.message,{success:!1,error:o.value}}finally{p.value=!1}}async function E(t,e){if(!a||!u.user)return null;const{data:r,error:s}=await a.from("game_participants").insert({room_id:t,user_id:u.user.id,fee_paid:e}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return s?(o.value=s.message,null):r}async function D(t,e){if(!a||!u.user)return!1;const r=f.profile?.total_beans??0;if(r-e<x.MIN_BALANCE)return o.value=`賬戶需保留至少 ${x.MIN_BALANCE} 豆`,!1;const s=f.profile,n=new Date().toISOString().split("T")[0],c=s?.daily_fee_reset_at===n&&s?.daily_fee_spent||0;if(c+e>x.DAILY_FEE_LIMIT)return o.value=`今日入場費已達上限 ${x.DAILY_FEE_LIMIT} 豆`,!1;const{error:_}=await a.from("user_stats").update({beans:r-e,daily_fee_spent:c+e,daily_fee_reset_at:n}).eq("user_id",u.user.id);return _?(o.value="扣除入場費失敗",!1):(await a.from("game_transactions").insert({user_id:u.user.id,room_id:t,type:"entry_fee",amount:-e,balance_after:r-e,description:`入場費 ${e} 豆`}),await f.fetchProfile(),!0)}async function I(t,e){if(!a||!v.value)return o.value="無權限",!1;const{error:r}=await a.from("game_participants").update({team_id:e}).eq("id",t);return r?(o.value=r.message,!1):!0}async function F(){if(!a||!v.value||!i.value?.teams)return o.value="無法分組",!1;const t=i.value.participants||[],e=i.value.teams,r=[...t].sort(()=>Math.random()-.5);for(let s=0;s<r.length;s++){const n=s%e.length,c=e[n],_=r[s];c&&_&&await I(_.id,c.id)}return!0}async function z(){if(!a||!v.value||!i.value)return o.value="無權限",!1;if(i.value.game_mode==="team_battle"){const e=i.value.participants?.filter(r=>!r.team_id);if(e&&e.length>0)return o.value="還有玩家未分組",!1}const{error:t}=await a.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",i.value.id);return t?(o.value=t.message,!1):(await a.from("game_participants").update({status:"playing"}).eq("room_id",i.value.id),!0)}async function B(t){if(!a||!u.user||!i.value)return o.value="無法提交分數",!1;const{error:e}=await a.from("game_participants").update({score:t.score,accuracy:t.accuracy,time_spent:t.timeSpent,first_accuracy:t.firstAccuracy,attempt_count:t.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",t.roomId).eq("user_id",u.user.id);return e?(o.value=e.message,!1):(l.value?.team_id&&await L(l.value.team_id),await Y(),!0)}async function $(t){if(!a||!u.user||!l.value)return o.value="無法提交進度",!1;await a.from("game_text_progress").upsert({participant_id:l.value.id,text_id:t.textId,text_index:t.textIndex,correct_count:t.correctCount,wrong_count:t.wrongCount,time_spent:t.timeSpent,completed_at:new Date().toISOString()},{onConflict:"participant_id,text_id"});const e=(l.value.correct_breaks||0)+t.correctCount,r=(l.value.completed_texts||0)+1,s=t.textIndex+1,{error:n}=await a.from("game_participants").update({correct_breaks:e,completed_texts:r,current_text_index:s,score:e}).eq("id",l.value.id);return n?(o.value=n.message,!1):(l.value.correct_breaks=e,l.value.completed_texts=r,l.value.current_text_index=s,l.value.score=e,l.value.team_id&&await L(l.value.team_id),!0)}async function U(t){if(!a||t.length===0)return[];const{data:e}=await a.from("practice_texts").select("id, title, author, content").in("id",t);if(e){const r=new Map(e.map(s=>[s.id,s]));return t.map(s=>r.get(s)).filter(Boolean)}return[]}async function L(t){if(!a||!i.value)return;const{data:e}=await a.from("game_participants").select("score").eq("team_id",t).eq("status","completed"),r=e?.length||0,s=e?.reduce((c,_)=>c+(_.score||0),0)||0,n=r>0?Math.round(s/r*100):0;await a.from("game_teams").update({total_score:n}).eq("id",t)}async function Y(){if(!a||!i.value)return;const{data:t}=await a.from("game_participants").select("status").eq("room_id",i.value.id);if(!t)return;const e=t.every(c=>c.status==="completed"),r=i.value.started_at?new Date(i.value.started_at):null,s=i.value.time_limit*1e3,n=r&&Date.now()-r.getTime()>=s;(e||n)&&await q()}async function q(){if(!a||!i.value)return null;const{data:t}=await a.from("game_rooms").select(`
        *,
        teams:game_teams!game_teams_room_id_fkey(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",i.value.id).single();if(!t)return null;let e=null,r=null,s=[];if(t.game_mode==="team_battle"&&t.teams)e=[...t.teams].sort((d,m)=>m.total_score-d.total_score)[0]?.id,s=t.participants?.filter(d=>d.team_id===e)||[];else{const _=[...t.participants||[]].sort((d,m)=>m.score-d.score)[0];r=_?.user_id,s=_?[_]:[]}await a.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:e,winner_user_id:r}).eq("id",t.id);let n=[];return t.prize_pool>0&&s.length>0&&(n=await j(t,s)),await W(t,s),{room:t,winners:s,winningTeam:t.teams?.find(c=>c.id===e),prizeDistribution:n}}async function j(t,e){if(!a)return[];const r=Math.floor(t.prize_pool/e.length),s=[];for(const n of e){const{data:c}=await a.from("user_stats").select("pvp_win_streak").eq("user_id",n.user_id).single(),_=(c?.pvp_win_streak||0)+1;let d=0;for(const[ee,te]of Object.entries(ie))if(_===Number(ee)){d=te;break}const m=r+d,{data:Z}=await a.from("user_stats").select("beans").eq("user_id",n.user_id).single(),R=(Z?.beans||0)+m;await a.from("user_stats").update({beans:R}).eq("user_id",n.user_id),await a.from("game_participants").update({prize_won:m}).eq("id",n.id),await a.from("game_transactions").insert({user_id:n.user_id,room_id:t.id,type:"prize",amount:m,balance_after:R,description:`收豆 ${r} 豆${d>0?` + 連勝獎勵 ${d} 豆`:""}`}),s.push({userId:n.user_id,displayName:n.user?.display_name||"未知",prize:r,streakBonus:d})}return s}async function W(t,e){if(!a)return;const r=new Set(e.map(s=>s.user_id));for(const s of t.participants||[]){const n=r.has(s.user_id);n?await a.rpc("increment_win_streak",{p_user_id:s.user_id}):await a.from("user_stats").update({pvp_win_streak:0}).eq("user_id",s.user_id),await a.rpc("increment_pvp_games",{p_user_id:s.user_id,p_is_win:n})}}let b=null;function S(t){if(!a){console.log("[Game] subscribeToRoom: supabase 未初始化");return}if(b===t&&g){console.log("[Game] 已經訂閱房間:",t,"，跳過重複訂閱");return}console.log("[Game] 開始訂閱房間:",t),h(),b=t,g=a.channel(`game-room-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},e=>{const r=e.new,s=e.old;(r?.id||s?.id)===t&&(console.log("[Game] 房間更新:",e.eventType,r),r&&(i.value={...i.value,...r,participants:i.value?.participants,teams:i.value?.teams,host:i.value?.host,text:i.value?.text,class:i.value?.class},console.log("[Game] 房間狀態已更新為:",r.status)))}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants"},async e=>{const r=e.new,s=e.old;(r?.room_id||s?.room_id)===t&&(console.log("[Game] 參與者更新:",e.eventType),await K(t))}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams"},async e=>{const r=e.new,s=e.old;(r?.room_id||s?.room_id)===t&&(console.log("[Game] 團隊更新:",e.eventType),await H(t))}).subscribe(e=>{console.log("[Game] 房間訂閱狀態:",e),e==="CHANNEL_ERROR"&&(console.error("[Game] 訂閱錯誤"),b=null)})}async function K(t){if(!a)return;const{data:e}=await a.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",t);e&&i.value&&(i.value.participants=e,u.user&&(l.value=e.find(r=>r.user_id===u.user.id)||null))}async function H(t){if(!a)return;const{data:e}=await a.from("game_teams").select("*").eq("room_id",t).order("order_index");e&&i.value&&(i.value.teams=e)}function h(){g&&(a?.removeChannel(g),g=null),b=null}async function X(){if(!a)return;p.value=!0;const{data:t,error:e}=await a.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);e?o.value=e.message:T.value=(t||[]).map(r=>({...r,participant_count:r.participants?.[0]?.count||0})),p.value=!1}async function J(t){if(!a)return[];const{data:e}=await a.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",t).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return e||[]}async function Q(){if(!(!a||!i.value||!u.user)){if(v.value&&i.value.status==="waiting"){if(await a.from("game_rooms").update({status:"cancelled"}).eq("id",i.value.id),i.value.entry_fee>0)for(const t of i.value.participants||[])await k(t)}else!v.value&&i.value.status==="waiting"&&(await a.from("game_participants").delete().eq("room_id",i.value.id).eq("user_id",u.user.id),l.value?.fee_paid&&await k(l.value));h(),i.value=null,l.value=null}}async function k(t){if(!a||!t.fee_paid)return;const{data:e}=await a.from("user_stats").select("beans").eq("user_id",t.user_id).single(),r=(e?.beans||0)+t.fee_paid;await a.from("user_stats").update({beans:r}).eq("user_id",t.user_id),await a.from("game_transactions").insert({user_id:t.user_id,room_id:t.room_id,type:"refund",amount:t.fee_paid,balance_after:r,description:"房間取消，退還入場費"})}function V(){h(),i.value=null,l.value=null,T.value=[],o.value=null}return{currentRoom:i,rooms:T,myParticipant:l,loading:p,error:o,isHost:v,isPlaying:P,isWaiting:A,isFinished:M,myTeam:N,createRoom:O,joinRoom:G,assignToTeam:I,randomAssignTeams:F,leaveRoom:Q,startGame:z,submitScore:B,submitTextProgress:$,fetchTexts:U,endGame:q,subscribeToRoom:S,unsubscribe:h,fetchPublicRooms:X,fetchClassGames:J,reset:V}});export{_e as E,x as S,me as T,oe as a,de as b,ne as c,fe as g,pe as u};
