import{d as re,u as oe,c as M,x as le,r as m,f as ie,O as ce,P as ue,w as de,a as d,g as a,h as _,m as he,t as f,i as p,b as B,F as N,j as L,s as fe,n as ve,M as pe,l as ge,o as c,_ as ke}from"./index-kveOurqA.js";import{u as me}from"./readingStore-BUsjYn_U.js";import{a as O,c as _e,b as xe}from"./useClassicalTTS-CXHixeah.js";import"./useSupabase-BKUpOif9.js";const be={class:"reading-detail-page"},ye={class:"reading-header edamame-glass"},Te={class:"header-title"},Ce={class:"title-meta"},Se={key:0,class:"author"},we={key:1,class:"source-tag"},Be={class:"header-actions"},Pe={class:"control-bar edamame-glass"},Ae=["aria-pressed"],Re={class:"toggle-switch"},Me={key:0,class:"reading-content edamame-glass"},Ne={class:"reading-line"},ze=["onMouseenter"],Ee=["onClick","disabled"],Ie={key:0,class:"verification-result"},De={class:"result-stats"},Fe={class:"stat correct"},Le={class:"stat missed"},Oe={class:"stat extra"},Ue={class:"stat accuracy"},Ve={class:"content-actions"},Xe=["disabled"],$e={key:1,class:"loading-state edamame-glass"},je=re({__name:"ReadingDetailPage",setup(He){const U=le(),V=ge(),o=me(),z=oe(),P=M(()=>U.params.id),h=m(!0),x=m(new Set),l=m(null),b=m(null),y=m(!1),C=M(()=>{if(!o.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const e=o.currentText.content.split("||"),s=[],u=[],i=new Set;let n=0;for(const v of e){const r=[],g=new Set,k=n;for(const T of v)T==="|"?n>0&&(i.add(n-1),g.add(r.length-1)):T!==`
`&&T!=="\r"&&(u.push(T),r.push(T),n++);r.length>0&&s.push({chars:r,breaks:g,startIdx:k,endIdx:n-1})}return{paragraphs:s,allChars:u,allBreaks:i}}),E=M(()=>C.value.paragraphs),X=m(0);function S(t){return o.currentText?.annotations&&o.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const A=m(null);function $(t){return A.value?S(t)?.id===A.value:!1}function j(t){return S(t)?.start_index===t}function H(t){const e=S(t);return e?e.end_index-1===t:!1}function Y(t,e){const s=S(t);s&&(A.value=s.id,W(s,e))}function q(){A.value=null,Z()}function G(t){if(h.value)return;const e=new Set(x.value);e.has(t)?e.delete(t):e.add(t),x.value=e,l.value=null}function J(){const{allBreaks:t,allChars:e}=C.value;if(!e.length)return;const s=[],u=[],i=[];for(let r=0;r<e.length;r++){const g=t.has(r),k=x.value.has(r);g&&k?s.push(r):g&&!k?u.push(r):!g&&k&&i.push(r)}const n=t.size,v=n>0?s.length/n:1;l.value={correct:s,missed:u,extra:i,accuracy:v}}function K(){h.value=!0,l.value=null}function Q(){x.value=new Set,l.value=null}function W(t,e){b.value={annotation:t,x:e.clientX,y:e.clientY}}function Z(){b.value=null}function I(){const{allChars:t,allBreaks:e,paragraphs:s}=C.value;if(!t.length)return[];const u=[];for(const i of s){let n="",v=i.startIdx-1;for(let r=i.startIdx;r<=i.endIdx;r++){const g=r-i.startIdx;n+=i.chars[g];const k=e.has(r);if(r===i.endIdx)n+="ã€‚";else if(k){const F=r-v;v=r,F>=8?n+="ã€‚":F>=4?n+="ï¼Œ":n+="ã€"}}n.trim()&&u.push(n)}return u}let w=!1;function D(){w=!0,_e(),y.value=!1}const R={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function ee(){if(!C.value.allChars.length)return;if(y.value){D();return}y.value=!0,w=!1;const t=I();try{for(let e=0;e<t.length&&!w;e++){const s=t[e+1];s&&O(s,R);const u=t[e];u&&await xe(u,R)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),w||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{y.value=!1,w=!1}}async function te(){if(!z.isAuthenticated){alert("è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨æ›¸ç±¤åŠŸèƒ½");return}await o.toggleBookmark(P.value)}function se(){V.push({name:"reading-list"})}function ae(t){const e=[],{allBreaks:s}=C.value;return h.value?s.has(t)&&e.push("has-break","correct"):x.value.has(t)?(e.push("has-break","user-marked"),l.value&&(l.value.correct.includes(t)?e.push("verified-correct"):l.value.extra.includes(t)&&e.push("verified-extra"))):l.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}ie(async()=>{await o.fetchTextDetail(P.value),o.startReadingTracking(),o.currentText?.progress&&(X.value=o.currentText.progress.last_paragraph),await ce();const e=I()[0];e&&O(e,R)});function ne(){return l.value?Math.round(l.value.accuracy*100):h.value?50:0}return ue(()=>{if(D(),P.value&&z.isAuthenticated){const t=ne(),e=l.value?.accuracy===1;o.saveReadingRecord(P.value,t,e)}}),de(h,t=>{t&&(l.value=null)}),(t,e)=>(c(),d("div",be,[a("header",ye,[a("button",{class:"back-btn",onClick:se}," â† è¿”å› "),a("div",Te,[a("h1",null,f(p(o).currentText?.title||"è¼‰å…¥ä¸­..."),1),a("div",Ce,[p(o).currentText?.author?(c(),d("span",Se,f(p(o).currentText.author),1)):_("",!0),p(o).currentText?.source_text?.title?(c(),d("span",we," Â· é¸è‡ªã€Š"+f(p(o).currentText.source_text.title)+"ã€‹ ",1)):_("",!0)])]),a("div",Be,[a("button",{class:B(["action-btn bookmark-btn",{active:p(o).currentText?.progress?.bookmarked}]),onClick:te,title:"æ”¶è—"},f(p(o).currentText?.progress?.bookmarked?"â­":"â˜†"),3)])]),a("section",Pe,[a("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=s=>h.value=!h.value),"aria-pressed":h.value,type:"button"},[e[2]||(e[2]=a("span",{class:"toggle-label"},"é¡¯ç¤ºæ–·å¥",-1)),a("span",Re,[a("span",{class:B(["toggle-track",{active:h.value}])},[...e[1]||(e[1]=[a("span",{class:"toggle-thumb"},null,-1)])],2)])],8,Ae),a("button",{class:B(["tts-btn",{playing:y.value}]),onClick:ee},f(y.value?"â¹ åœæ­¢æœ—è®€":"ğŸ”Š æœ—è®€å…¨æ–‡"),3)]),p(o).currentText&&E.value.length>0?(c(),d("section",Me,[(c(!0),d(N,null,L(E.value,(s,u)=>(c(),d("div",{key:u,class:"paragraph-block"},[a("div",Ne,[(c(!0),d(N,null,L(s.chars,(i,n)=>(c(),d("span",{key:n,class:"char-unit"},[a("span",{class:B(["char",{"has-annotation":S(s.startIdx+n),"annotation-hovered":$(s.startIdx+n),"annotation-start":j(s.startIdx+n),"annotation-end":H(s.startIdx+n)}]),onMouseenter:v=>Y(s.startIdx+n,v),onMouseleave:q},f(i),43,ze),n<s.chars.length-1?(c(),d("button",{key:0,class:B(["break-slot",ae(s.startIdx+n)]),onClick:v=>G(s.startIdx+n),disabled:h.value},[...e[3]||(e[3]=[a("span",{class:"break-marker"},null,-1)])],10,Ee)):_("",!0)]))),128))])]))),128)),l.value?(c(),d("div",Ie,[a("div",De,[a("span",Fe,"âœ“ æ­£ç¢ºï¼š"+f(l.value.correct.length),1),a("span",Le,"â—‹ éºæ¼ï¼š"+f(l.value.missed.length),1),a("span",Oe,"âœ— å¤šé¤˜ï¼š"+f(l.value.extra.length),1),a("span",Ue," æ­£ç¢ºç‡ï¼š"+f(Math.round(l.value.accuracy*100))+"% ",1)]),a("button",{class:"show-answer-btn",onClick:K}," æŸ¥çœ‹æ­£ç¢ºç­”æ¡ˆ ")])):_("",!0),a("div",Ve,[h.value?_("",!0):(c(),d(N,{key:0},[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Q}," é‡ç½® "),a("button",{class:"edamame-btn edamame-btn-primary",onClick:J,disabled:x.value.size===0}," âœ“ é©—è­‰æˆ‘çš„æ–·å¥ ",8,Xe)],64))])])):p(o).isLoading?(c(),d("section",$e,[...e[4]||(e[4]=[a("span",{class:"loading-spinner"},null,-1),fe(" è¼‰å…¥ä¸­... ",-1)])])):_("",!0),(c(),he(pe,{to:"body"},[b.value?(c(),d("div",{key:0,class:"annotation-tooltip",style:ve({left:b.value.x+"px",top:b.value.y+16+"px"})},f(b.value.annotation.annotation),5)):_("",!0)]))]))}}),Ke=ke(je,[["__scopeId","data-v-6b70abb1"]]);export{Ke as default};
