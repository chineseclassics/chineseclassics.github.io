import{y as z,u as G,r as x,c as H}from"./index-D3NuB_Em.js";import{u as J}from"./useSupabase-DxQBIjgg.js";const Q=z("reading",()=>{const o=J(),n=G(),u=x([]),c=x(null),_=x([]),p=x(!1),f=x(null),y=H(()=>u.value.filter(e=>e.progress?.bookmarked));async function E(){if(!o){f.value="Supabase å°šæœªé…ç½®";return}p.value=!0,f.value=null;try{const{data:e,error:r}=await o.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("text_type","reading").order("created_at",{ascending:!1});if(r)throw r;let a=new Map;if(n.isAuthenticated&&n.user?.id){const{data:t}=await o.from("reading_progress").select("*").eq("user_id",n.user.id);t&&t.forEach(i=>{a.set(i.text_id,i)})}u.value=(e||[]).map(t=>{const i=t.text_reading_categories?.map(s=>s.category).filter(Boolean)||[];return{...t,reading_categories:i,text_reading_categories:void 0,progress:a.get(t.id)||null}})}catch(e){f.value=e.message??"ç„¡æ³•è¼‰å…¥é–±è®€æ–‡ç« "}finally{p.value=!1}}async function S(e){if(!o)return f.value="Supabase å°šæœªé…ç½®",null;p.value=!0,f.value=null;try{const{data:r,error:a}=await o.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("id",e).single();if(a)throw a;const{data:t}=await o.from("text_annotations").select("*").eq("text_id",e).order("start_index",{ascending:!0});let i=null;if(n.isAuthenticated&&n.user?.id){const{data:d}=await o.from("reading_progress").select("*").eq("text_id",e).eq("user_id",n.user.id).maybeSingle();i=d||null}const s=r.text_reading_categories?.map(d=>d.category).filter(Boolean)||[];return c.value={...r,reading_categories:s,text_reading_categories:void 0,annotations:t||[],progress:i},c.value}catch(r){return f.value=r.message??"ç„¡æ³•è¼‰å…¥æ–‡ç« è©³æƒ…",null}finally{p.value=!1}}async function b(e,r,a){if(!(!o||!n.isAuthenticated||!n.user?.id))try{const{data:t,error:i}=await o.from("reading_progress").upsert({user_id:n.user.id,text_id:e,progress_percent:r,last_paragraph:a,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(i)throw i;c.value?.id===e&&(c.value.progress=t);const s=u.value.findIndex(l=>l.id===e),d=u.value[s];s!==-1&&t&&d&&(d.progress=t)}catch(t){console.error("æ›´æ–°é–±è®€é€²åº¦å¤±æ•—:",t)}}async function q(e){if(!o||!n.isAuthenticated||!n.user?.id)return;const a=(u.value.find(t=>t.id===e)||c.value)?.progress?.bookmarked??!1;try{const{data:t,error:i}=await o.from("reading_progress").upsert({user_id:n.user.id,text_id:e,bookmarked:!a,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(i)throw i;c.value?.id===e&&(c.value.progress=t);const s=u.value.findIndex(l=>l.id===e),d=u.value[s];return s!==-1&&t&&d&&(d.progress=t),t?.bookmarked}catch(t){return console.error("åˆ‡æ›æ›¸ç±¤å¤±æ•—:",t),null}}async function k(e){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");if(!n.isTeacher&&!n.isAdmin)throw new Error("åªæœ‰è€å¸«æˆ–ç®¡ç†å“¡å¯ä»¥æ·»åŠ è¨»é‡‹");const{data:r,error:a}=await o.from("text_annotations").insert({...e,created_by:n.user.id}).select().single();if(a)throw a;return c.value?.id===e.text_id&&r&&(c.value.annotations=[...c.value.annotations||[],r].sort((t,i)=>t.start_index-i.start_index)),r}async function A(e,r){if(!o)throw new Error("Supabase å°šæœªé…ç½®");const{data:a,error:t}=await o.from("text_annotations").update({annotation:r}).eq("id",e).select().single();if(t)throw t;if(c.value?.annotations){const i=c.value.annotations.findIndex(s=>s.id===e);i!==-1&&(c.value.annotations[i]=a)}return a}async function T(e){if(!o)throw new Error("Supabase å°šæœªé…ç½®");const{error:r}=await o.from("text_annotations").delete().eq("id",e);if(r)throw r;c.value?.annotations&&(c.value.annotations=c.value.annotations.filter(a=>a.id!==e))}async function D(e,r=!1){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");const{data:a,error:t}=await o.from("practice_texts").insert({title:e.title,author:e.author??null,source:e.source??null,summary:e.summary??null,category_id:e.category_id||null,content:e.content,text_type:"reading",source_text_id:e.source_text_id||null,source_start_index:e.source_start_index??null,source_end_index:e.source_end_index??null,is_system:r,created_by:r?null:n.user.id}).select("*").single();if(t)throw t;const i=e.reading_category_ids||[];if(a&&i.length>0){const{error:d}=await o.from("text_reading_categories").insert(i.map(l=>({text_id:a.id,category_id:l})));d&&console.error("é—œè¯æ–‡é›†å¤±æ•—:",d)}const s=i.length>0?_.value.filter(d=>i.includes(d.id)):[];return a&&u.value.unshift({...a,reading_categories:s,progress:null,annotations:[]}),a}async function R(e,r,a,t,i){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");const s=u.value.find(g=>g.id===e)||c.value,{data:d,error:l}=await o.from("practice_texts").insert({title:i.title,author:s?.author??null,source:s?.source??null,category_id:i.category_id||null,content:t,difficulty:i.difficulty||2,text_type:"practice",source_text_id:e,source_start_index:r,source_end_index:a,is_system:!0,created_by:null}).select().single();if(l)throw l;return d}function C(){c.value=null}let m=null;function O(){m=Date.now()}async function h(e,r=0,a=!1){if(!o||!n.isAuthenticated||!n.user?.id)return;const t=m?Math.floor((Date.now()-m)/1e3):0;if(m=null,!(t<3))try{const{error:i}=await o.from("reading_records").upsert({user_id:n.user.id,text_id:e,progress:Math.max(r,0),is_completed:a,read_duration:t,read_count:1,last_read_at:new Date().toISOString()},{onConflict:"user_id,text_id",ignoreDuplicates:!1});if(i){if(i.code==="42P01"){console.log("é–±è®€è¨˜éŒ„è¡¨å°šæœªå‰µå»º");return}const{error:s}=await o.rpc("update_reading_record",{p_user_id:n.user.id,p_text_id:e,p_duration:t,p_progress:r,p_completed:a});if(s){const{data:d}=await o.from("reading_records").select("id, read_duration, read_count, progress, is_completed").eq("user_id",n.user.id).eq("text_id",e).maybeSingle();d&&await o.from("reading_records").update({read_duration:d.read_duration+t,read_count:d.read_count+1,progress:Math.max(d.progress,r),is_completed:d.is_completed||a,last_read_at:new Date().toISOString(),completed_at:a&&!d.is_completed?new Date().toISOString():void 0}).eq("id",d.id)}}console.log(`ðŸ“– è¨˜éŒ„é–±è®€ï¼š${t} ç§’ï¼Œé€²åº¦ ${r}%`)}catch(i){console.error("ä¿å­˜é–±è®€è¨˜éŒ„å¤±æ•—:",i)}}async function M(e){await h(e,100,!0)}async function B(e,r){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°é–±è®€æ–‡ç« ");const{data:a}=await o.from("practice_texts").select("is_system, created_by, text_type").eq("id",e).single();if(a){if(a.text_type!=="reading")throw new Error("åªèƒ½æ›´æ–°é–±è®€æ–‡ç« ");if(a.is_system&&!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°ç³»çµ±æ–‡ç« ");if(!a.is_system&&a.created_by!==n.user.id)throw new Error("åªèƒ½æ›´æ–°è‡ªå·±å‰µå»ºçš„æ–‡ç« ")}const{error:t}=await o.from("practice_texts").update({title:r.title,author:r.author??null,source:r.source??null,summary:r.summary??null,content:r.content}).eq("id",e);if(t)throw t;if(r.reading_category_ids!==void 0){const{error:w}=await o.from("text_reading_categories").delete().eq("text_id",e);if(w)throw w;if(r.reading_category_ids.length>0){const{error:v}=await o.from("text_reading_categories").insert(r.reading_category_ids.map(j=>({text_id:e,category_id:j})));if(v)throw v}}const{data:i,error:s}=await o.from("practice_texts").select(`
        *,
        text_reading_categories (
          category:reading_categories (
            id,
            name,
            description,
            order_index
          )
        )
      `).eq("id",e).single();if(s)throw s;const d=i.text_reading_categories?.map(w=>w.category).filter(Boolean)||[],l={...i,reading_categories:d,text_reading_categories:void 0};c.value?.id===e&&(c.value={...c.value,...l,annotations:c.value.annotations,progress:c.value.progress});const g=u.value.findIndex(w=>w.id===e);return g!==-1&&u.value[g]&&(u.value[g]={...u.value[g],...l,progress:u.value[g].progress,annotations:u.value[g].annotations||[]}),l}async function P(e,r){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°æ–‡é›†");const{error:a}=await o.from("text_reading_categories").delete().eq("text_id",e);if(a)throw a;if(r.length>0){const{error:s}=await o.from("text_reading_categories").insert(r.map(d=>({text_id:e,category_id:d})));if(s)throw s}const t=_.value.filter(s=>r.includes(s.id));c.value?.id===e&&(c.value.reading_categories=t);const i=u.value.findIndex(s=>s.id===e);i!==-1&&u.value[i]&&(u.value[i].reading_categories=t)}async function U(){if(o)try{const{data:e,error:r}=await o.from("reading_categories").select("*").order("order_index",{ascending:!0});if(r)throw r;_.value=e||[]}catch(e){console.error("ç²å–é–±è®€åˆ†é¡žå¤±æ•—:",e)}}async function $(e,r){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥å‰µå»ºåˆ†é¡ž");const a=_.value.reduce((s,d)=>Math.max(s,d.order_index),0),{data:t,error:i}=await o.from("reading_categories").insert({name:e,description:r||null,order_index:a+1,created_by:n.user?.id}).select().single();if(i)throw i;return t&&_.value.push(t),t}async function F(e,r){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°åˆ†é¡ž");const{data:a,error:t}=await o.from("reading_categories").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(t)throw t;const i=_.value.findIndex(s=>s.id===e);return i!==-1&&a&&(_.value[i]=a),a}async function L(e){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤åˆ†é¡ž");const{error:r}=await o.from("reading_categories").delete().eq("id",e);if(r)throw r;_.value=_.value.filter(a=>a.id!==e)}return{readingTexts:u,currentText:c,readingCategories:_,bookmarkedTexts:y,isLoading:p,error:f,fetchReadingTexts:E,fetchTextDetail:S,createReadingText:D,updateReadingText:B,extractPracticeFragment:R,clearCurrentText:C,updateProgress:b,toggleBookmark:q,startReadingTracking:O,saveReadingRecord:h,markAsCompleted:M,addAnnotation:k,updateAnnotation:A,deleteAnnotation:T,fetchReadingCategories:U,createReadingCategory:$,updateReadingCategory:F,deleteReadingCategory:L,updateTextCategories:P}});export{Q as u};
