import{C as Te,u as z,r as P,m as $,P as a}from"./index-DS87Lla2.js";import{u as xe}from"./userStatsStore-CoFDQ3wG.js";import{e as Pe,B as Ge,f as ke,S as ae}from"./game-C73ZBjL5.js";const $e=Te("game",()=>{const f=z(),b=xe(),n=P(null),U=P([]),u=P(null),S=P(!1),c=P(null);let G=null,k=null,B=null;const j=5e3,F=600*1e3,I=P(!1),N=new Set,T=$(()=>!n.value||!f.user?!1:n.value.host_id===f.user.id),ne=$(()=>n.value?.status==="playing"),se=$(()=>n.value?.status==="waiting"),re=$(()=>n.value?.status==="finished"),ie=$(()=>!u.value?.team_id||!n.value?.teams?null:n.value.teams.find(e=>e.id===u.value.team_id));async function oe(e){if(!a||!f.user)return c.value="è«‹å…ˆç™»å…¥",null;S.value=!0,c.value=null;try{const{data:t,error:s}=await a.from("game_rooms").insert({host_id:f.user.id,host_type:e.hostType,game_mode:e.gameMode,text_id:e.textIds[0],text_ids:e.textIds,time_limit:e.timeLimit,team_count:e.teamCount||null,max_players:e.maxPlayers||null,entry_fee:e.entryFee||0,class_id:e.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url)
        `).single();if(s)return c.value=s.message,null;if(e.gameMode==="team_battle"&&e.teamCount){const o=Pe(e.teamCount).map((_,g)=>{const d=Ge[_],h=ke(e.teamCount)[g];return{room_id:t.id,team_name:d.name,team_color:h,bean_product:_,order_index:g}}),{data:l,error:i}=await a.from("game_teams").insert(o).select();i?console.error("å‰µå»ºåœ˜éšŠå¤±æ•—:",i):t.teams=l}if(e.hostType==="student"){if(e.entryFee&&e.entryFee>0&&!await X(t.id,e.entryFee))return await a.from("game_rooms").delete().eq("id",t.id),null;const r=await H(t.id,e.entryFee||0);r&&(t.participants=[r],u.value=r)}return n.value=t,C(t.id),t}catch(t){return c.value=t.message,null}finally{S.value=!1}}async function le(e){if(!a||!f.user)return{success:!1,error:"è«‹å…ˆç™»å…¥"};S.value=!0,c.value=null;try{const{data:t,error:s}=await a.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",e.toUpperCase()).single();if(s||!t)return{success:!1,error:"æ‰¾ä¸åˆ°è©²æˆ¿é–“"};if(t.status!=="waiting")return{success:!1,error:"è©²æˆ¿é–“å·²é–‹å§‹æˆ–å·²çµæŸ"};const r=t.participants?.find(i=>i.user_id===f.user.id);if(r)return n.value=t,u.value=r,C(t.id),{success:!0,room:t,participant:r};if(t.max_players&&t.participants&&t.participants.length>=t.max_players)return{success:!1,error:"æˆ¿é–“å·²æ»¿"};if(t.entry_fee>0&&!await X(t.id,t.entry_fee))return{success:!1,error:c.value||"ç„¡æ³•æ”¯ä»˜å…¥å ´è²»"};const o=await H(t.id,t.entry_fee);if(!o)return{success:!1,error:c.value||"åŠ å…¥æˆ¿é–“å¤±æ•—"};const l=[...t.participants||[],o];return n.value={...t,participants:l},u.value=o,C(t.id),{success:!0,room:t,participant:o}}catch(t){return c.value=t.message,{success:!1,error:c.value}}finally{S.value=!1}}async function H(e,t){if(!a||!f.user)return null;const{data:s,error:r}=await a.from("game_participants").insert({room_id:e,user_id:f.user.id,fee_paid:t}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return r?(c.value=r.message,null):s}async function X(e,t){if(!a||!f.user)return!1;b.profile||await b.fetchProfile();const s=b.profile?.total_beans??0;if(s<t)return c.value=`å¥è±†ä¸è¶³ï¼Œéœ€è¦ ${t} å¥è±†ï¼Œç•¶å‰åªæœ‰ ${s} å¥è±†`,!1;if(s-t<ae.MIN_BALANCE)return c.value=`è³¬æˆ¶éœ€ä¿ç•™è‡³å°‘ ${ae.MIN_BALANCE} è±†`,!1;const r=s-t,{error:o}=await a.from("profiles").update({total_beans:r,weekly_beans:Math.max(0,(b.profile?.weekly_beans??0)-t),monthly_beans:Math.max(0,(b.profile?.monthly_beans??0)-t),updated_at:new Date().toISOString()}).eq("id",f.user.id);return o?(console.error("æ‰£é™¤å…¥å ´è²»å¤±æ•—:",o),c.value="æ‰£é™¤å…¥å ´è²»å¤±æ•—",!1):(await a.from("game_transactions").insert({user_id:f.user.id,room_id:e,type:"entry_fee",amount:-t,balance_after:r,description:`å…¥å ´è²» ${t} è±†`}),await b.fetchProfile(),console.log(`ğŸ’° å·²æ‰£é™¤å…¥å ´è²» ${t} è±†ï¼Œé¤˜é¡ ${r} è±†`),!0)}async function K(e,t){if(!a||!T.value)return c.value="ç„¡æ¬Šé™",!1;const{error:s}=await a.from("game_participants").update({team_id:t}).eq("id",e);return s?(c.value=s.message,!1):!0}async function ue(){if(!a||!T.value||!n.value?.teams)return c.value="ç„¡æ³•åˆ†çµ„",!1;const e=n.value.participants||[],t=n.value.teams,s=[...e].sort(()=>Math.random()-.5);for(let r=0;r<s.length;r++){const o=r%t.length,l=t[o],i=s[r];l&&i&&await K(i.id,l.id)}return!0}async function ce(){if(!a||!T.value||!n.value)return c.value="ç„¡æ¬Šé™",!1;if(n.value.game_mode==="team_battle"){const t=n.value.participants?.filter(s=>!s.team_id);if(t&&t.length>0)return c.value="é‚„æœ‰ç©å®¶æœªåˆ†çµ„",!1}const{error:e}=await a.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",n.value.id);return e?(c.value=e.message,!1):(await a.from("game_participants").update({status:"playing"}).eq("room_id",n.value.id),!0)}async function de(e){if(!a||!f.user||!n.value)return c.value="ç„¡æ³•æäº¤åˆ†æ•¸",!1;const{error:t}=await a.from("game_participants").update({score:e.score,accuracy:e.accuracy,time_spent:e.timeSpent,first_accuracy:e.firstAccuracy,attempt_count:e.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",e.roomId).eq("user_id",f.user.id);return t?(c.value=t.message,!1):(u.value?.team_id&&await L(u.value.team_id),await fe(),!0)}async function V(e){if(!a||!f.user||!u.value||!n.value)return c.value="ç„¡æ³•æ›´æ–°é€²åº¦",!1;const t=u.value.id,s=n.value.started_at?new Date(n.value.started_at).getTime():null,r=s?Math.max(0,Math.round((e.lastInteraction-s)/1e3)):0,o=Math.max(0,e.usedBeans-e.totalCorrect),{error:l}=await a.from("game_text_progress").upsert({participant_id:t,text_id:e.textId,text_index:e.textIndex,correct_count:e.correctCount,wrong_count:e.wrongCount,time_spent:r,last_interaction:new Date(e.lastInteraction).toISOString(),completed_at:e.isFinished?new Date(e.lastInteraction).toISOString():null},{onConflict:"participant_id,text_id"});if(l)return c.value=l.message,!1;const i={score:e.totalCorrect,correct_breaks:e.totalCorrect,wrong_breaks:o,current_text_index:e.textIndex,time_spent:r,last_interaction:new Date(e.lastInteraction).toISOString()};e.isFinished&&(i.status="completed",i.completed_at=new Date(e.lastInteraction).toISOString());const{error:_}=await a.from("game_participants").update(i).eq("id",t);return _?(c.value=_.message,!1):(u.value.score=e.totalCorrect,u.value.correct_breaks=e.totalCorrect,u.value.current_text_index=e.textIndex,u.value.time_spent=r,e.isFinished&&(u.value.status="completed",u.value.completed_at=new Date(e.lastInteraction).toISOString()),u.value.team_id&&(await L(u.value.team_id),await ee(n.value.id)),!0)}async function _e(e){return V({roomId:e.roomId,textId:e.textId,textIndex:e.textIndex,correctCount:e.correctCount,wrongCount:e.wrongCount,totalCorrect:e.correctCount,totalBeans:e.correctCount,usedBeans:e.correctCount+e.wrongCount,lastInteraction:Date.now(),isFinished:!0})}async function me(e){if(!a||e.length===0)return[];const{data:t}=await a.from("practice_texts").select("id, title, author, content").in("id",e);if(t){const s=new Map(t.map(r=>[r.id,r]));return e.map(r=>s.get(r)).filter(Boolean)}return[]}async function L(e){if(!a||!n.value)return;const{data:t}=await a.from("game_participants").select("score").eq("team_id",e),s=t?.length||0,r=t?.reduce((l,i)=>l+(i.score||0),0)||0,o=s>0?Math.round(r/s*100):0;await a.from("game_teams").update({total_score:o}).eq("id",e)}async function fe(){if(!a||!n.value)return;const{data:e}=await a.from("game_participants").select("status").eq("room_id",n.value.id);if(!e)return;const t=e.every(l=>l.status==="completed"),s=n.value.started_at?new Date(n.value.started_at):null,r=n.value.time_limit*1e3,o=s&&Date.now()-s.getTime()>=r;(t||o)&&await W()}async function W(){if(!a||!n.value||!f.user)return null;const e=n.value.id,s=`${f.user.id}-${e}`;if(N.has(s)){console.log("[Game] endGame() å·²ç¶“åŸ·è¡Œéï¼ˆç•¶å‰ç”¨æˆ¶ï¼‰ï¼Œè·³éé‡è¤‡åŸ·è¡Œ");const{data:m}=await a.from("game_rooms").select(`
          *,
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
          )
        `).eq("id",e).single();if(!m)return null;let v=null,p=[];if(m.game_mode==="team_battle"&&m.teams)v=[...m.teams].sort((y,R)=>R.total_score-y.total_score)[0]?.id,p=m.participants?.filter(y=>y.team_id===v)||[];else{const w=[...m.participants||[]].sort((y,R)=>R.score!==y.score?R.score-y.score:(y.time_spent||999999)-(R.time_spent||999999)),M=w[0];M&&(p=w.filter(y=>y.score===M.score&&(y.time_spent||999999)===(M.time_spent||999999)))}return{room:m,winners:p,winningTeam:m.teams?.find(w=>w.id===v),prizeDistribution:[]}}N.add(s);const r=n.value.started_at?new Date(n.value.started_at):null,o=n.value.time_limit*1e3;if(r&&Date.now()-r.getTime()>=o){const{data:m}=await a.from("game_participants").select("id, score").eq("room_id",n.value.id).neq("status","completed").gt("score",0);if(m&&m.length>0){const v=Math.round((Date.now()-r.getTime())/1e3);if(await a.from("game_participants").update({status:"completed",completed_at:new Date().toISOString(),time_spent:v}).in("id",m.map(p=>p.id)),n.value.game_mode==="team_battle"&&n.value.teams)for(const p of n.value.teams)await L(p.id)}}const{data:i}=await a.from("game_rooms").select(`
        *,
        teams:game_teams!game_teams_room_id_fkey(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",n.value.id).single();if(!i)return null;let _=null,g=null,d=[];if(i.game_mode==="team_battle"&&i.teams)_=[...i.teams].sort((p,w)=>w.total_score-p.total_score)[0]?.id,d=i.participants?.filter(p=>p.team_id===_)||[];else{const m=[...i.participants||[]].sort((p,w)=>w.score!==p.score?w.score-p.score:(p.time_spent||999999)-(w.time_spent||999999)),v=m[0];v&&(d=m.filter(p=>p.score===v.score&&(p.time_spent||999999)===(v.time_spent||999999)),d.length===1&&(g=v.user_id))}await a.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:_,winner_user_id:g}).eq("id",i.id);const A=!_&&!g&&d.length>1,h=i.participants?.reduce((m,v)=>m+(v.fee_paid||0),0)||0;let O=[];if(i.game_mode==="team_battle"&&_&&d.length>0)O=await pe(i,d);else if(h>0&&d.length>0){const m={...i,prize_pool:h};A?O=await ve(m,d):O=await ge(m,d)}return A||await we(i,d),{room:i,winners:d,winningTeam:i.teams?.find(m=>m.id===_),prizeDistribution:O}}async function pe(e,t){if(!a)return[];const r=z().user?.id,o=20,l=[];for(const i of t){if(i.user_id===r){const{data:_}=await a.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",i.user_id).single(),d=(_?.total_beans||0)+o;await a.from("profiles").update({total_beans:d,weekly_beans:(_?.weekly_beans||0)+o,monthly_beans:(_?.monthly_beans||0)+o,updated_at:new Date().toISOString()}).eq("id",i.user_id),await a.from("game_participants").update({prize_won:o}).eq("id",i.id),u.value&&u.value.id===i.id&&(u.value.prize_won=o),await a.from("game_transactions").insert({user_id:i.user_id,room_id:e.id,type:"prize",amount:o,balance_after:d,description:`èª²å ‚é¬¥è±†ç²å‹çå‹µï¼š+${o} è±†`}),console.log(`ğŸ‰ ${i.user?.display_name} ç²å¾— ${o} è±†ï¼Œé¤˜é¡ ${d} è±†`)}l.push({userId:i.user_id,displayName:i.user?.display_name||"æœªçŸ¥",prize:o,streakBonus:0})}return l}async function ge(e,t){if(!a)return[];const r=z().user?.id,o=Math.floor(e.prize_pool/t.length),l=[];for(const i of t){const g=o+0;if(i.user_id===r){const{data:d}=await a.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",i.user_id).single(),h=(d?.total_beans||0)+g;await a.from("profiles").update({total_beans:h,weekly_beans:(d?.weekly_beans||0)+g,monthly_beans:(d?.monthly_beans||0)+g,updated_at:new Date().toISOString()}).eq("id",i.user_id),await a.from("game_participants").update({prize_won:g}).eq("id",i.id),u.value&&u.value.id===i.id&&(u.value.prize_won=g),await a.from("game_transactions").insert({user_id:i.user_id,room_id:e.id,type:"prize",amount:g,balance_after:h,description:`æ”¶è±† ${o} è±†`}),console.log(`ğŸ‰ ${i.user?.display_name} ç²å¾— ${g} è±†ï¼Œé¤˜é¡ ${h} è±†`)}l.push({userId:i.user_id,displayName:i.user?.display_name||"æœªçŸ¥",prize:o,streakBonus:0})}return l}async function ve(e,t){if(!a)return[];const r=z().user?.id;console.log(`ğŸ¤ å¹³å±€ï¼é€€é‚„å…¥å ´è²»çµ¦ ${t.length} ä½ç©å®¶`);const o=[];for(const l of t){const i=l.fee_paid||e.entry_fee||0;if(i<=0){console.log(`âš ï¸ ${l.user?.display_name} æ²’æœ‰æ”¯ä»˜å…¥å ´è²»ï¼Œè·³é`);continue}if(l.user_id===r){const{data:_}=await a.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",l.user_id).single(),d=(_?.total_beans||0)+i;await a.from("profiles").update({total_beans:d,weekly_beans:(_?.weekly_beans||0)+i,monthly_beans:(_?.monthly_beans||0)+i,updated_at:new Date().toISOString()}).eq("id",l.user_id),await a.from("game_participants").update({prize_won:i}).eq("id",l.id),u.value&&u.value.id===l.id&&(u.value.prize_won=i),await a.from("game_transactions").insert({user_id:l.user_id,room_id:e.id,type:"refund",amount:i,balance_after:d,description:`å¹³å±€ï¼Œè¿”é‚„å…¥å ´è²» ${i} è±†`}),console.log(`ğŸ’° å·²é€€é‚„ ${i} è±†çµ¦ ${l.user?.display_name}ï¼Œé¤˜é¡ ${d} è±†`)}o.push({userId:l.user_id,displayName:l.user?.display_name||"æœªçŸ¥",prize:i,streakBonus:0})}return o}async function we(e,t){if(!a)return;const s=new Set(t.map(r=>r.user_id));for(const r of e.participants||[]){const o=s.has(r.user_id);o?await a.rpc("increment_win_streak",{p_user_id:r.user_id}):await a.from("user_stats").update({pvp_win_streak:0}).eq("user_id",r.user_id),await a.rpc("increment_pvp_games",{p_user_id:r.user_id,p_is_win:o})}}let E=null,x=0;const Y=3;function C(e){if(!a){console.log("[Game] subscribeToRoom: supabase æœªåˆå§‹åŒ–"),J(e);return}if(E===e&&G&&I.value){console.log("[Game] å·²ç¶“è¨‚é–±æˆ¿é–“:",e,"ï¼Œè·³éé‡è¤‡è¨‚é–±");return}console.log("[Game] é–‹å§‹è¨‚é–±æˆ¿é–“:",e),D(),E=e,x=0,G=a.channel(`game-room-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},t=>{const s=t.new,r=t.old;if((s?.id||r?.id)===e&&(console.log("[Game] æˆ¿é–“æ›´æ–°:",t.eventType,s),s)){const l=n.value?.status,i=s.status;n.value={...n.value,...s,participants:n.value?.participants,teams:n.value?.teams,host:n.value?.host,text:n.value?.text,class:n.value?.class},console.log("[Game] æˆ¿é–“ç‹€æ…‹å·²æ›´æ–°ç‚º:",i),i==="finished"&&l!=="finished"&&(console.log("[Game] æª¢æ¸¬åˆ°æˆ¿é–“ç‹€æ…‹è®Šç‚º finishedï¼Œè‡ªå‹•èª¿ç”¨ endGame() è™•ç†çå‹µåˆ†ç™¼"),W().catch(_=>{console.error("[Game] è‡ªå‹•èª¿ç”¨ endGame() å¤±æ•—:",_)}))}}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants"},async t=>{const s=t.new,r=t.old;(s?.room_id||r?.room_id)===e&&(console.log("[Game] åƒèˆ‡è€…æ›´æ–°:",t.eventType),await Z(e))}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams"},async t=>{const s=t.new,r=t.old;(s?.room_id||r?.room_id)===e&&(console.log("[Game] åœ˜éšŠæ›´æ–°:",t.eventType),await ee(e))}).subscribe(t=>{console.log("[Game] æˆ¿é–“è¨‚é–±ç‹€æ…‹:",t),t==="SUBSCRIBED"?(I.value=!0,q(),x=0,console.log("[Game] âœ… Realtime è¨‚é–±æˆåŠŸ")):t==="CHANNEL_ERROR"||t==="TIMED_OUT"?(I.value=!1,console.error("[Game] âŒ Realtime è¨‚é–±å¤±æ•—:",t),E=null,x<Y?(x++,console.log(`[Game] å˜—è©¦é‡æ–°è¨‚é–± (${x}/${Y})...`),setTimeout(()=>{n.value?.id===e&&C(e)},2e3*x)):(console.log("[Game] Realtime è¨‚é–±é‡è©¦æ¬¡æ•¸ç”¨ç›¡ï¼Œå•Ÿç”¨è¼ªè©¢å‚™ç”¨æ–¹æ¡ˆ"),J(e))):t==="CLOSED"&&(I.value=!1,console.log("[Game] Realtime é€£æ¥å·²é—œé–‰"))})}function J(e){k||(console.log("[Game] ğŸ”„ å•Ÿå‹•è¼ªè©¢å‚™ç”¨æ–¹æ¡ˆï¼Œæ¯",j/1e3,"ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šæŒçºŒ",F/6e4,"åˆ†é˜"),B=Date.now(),k=setInterval(async()=>{if(!n.value||n.value.id!==e){console.log("[Game] æˆ¿é–“ä¸å­˜åœ¨ï¼Œåœæ­¢è¼ªè©¢"),q();return}if(B&&Date.now()-B>F){console.log("[Game] è¼ªè©¢è¶…æ™‚ï¼ˆ",F/6e4,"åˆ†é˜ï¼‰ï¼Œåœæ­¢è¼ªè©¢"),q();return}if(n.value.status==="finished"||n.value.status==="cancelled"){console.log("[Game] æˆ¿é–“å·²çµæŸï¼Œåœæ­¢è¼ªè©¢"),q();return}await Q(e)},j),Q(e))}function q(){k&&(clearInterval(k),k=null,B=null,console.log("[Game] è¼ªè©¢å·²åœæ­¢"))}async function Q(e){if(a)try{const{data:t,error:s}=await a.from("game_rooms").select("status, started_at, ended_at").eq("id",e).single();if(s){console.error("[Game] è¼ªè©¢ç²å–æˆ¿é–“ç‹€æ…‹å¤±æ•—:",s);return}if(t&&n.value){const r=n.value.status;t.status!==r&&(console.log("[Game] è¼ªè©¢ç™¼ç¾ç‹€æ…‹è®ŠåŒ–:",r,"->",t.status),n.value={...n.value,status:t.status,started_at:t.started_at,ended_at:t.ended_at})}n.value?.status==="waiting"&&await Z(e),n.value?.status==="playing"&&await ye(e)}catch(t){console.error("[Game] è¼ªè©¢éŒ¯èª¤:",t)}}async function ye(e){if(!a)return;const{data:t}=await a.from("game_participants").select("id, user_id, status, completed_at").eq("room_id",e);if(t&&n.value?.participants)for(const s of t){const r=n.value.participants.find(o=>o.id===s.id);r&&(r.status=s.status,r.completed_at=s.completed_at)}}async function Z(e){if(!a)return;const{data:t}=await a.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",e);t&&n.value&&(n.value.participants=t,f.user&&(u.value=t.find(s=>s.user_id===f.user.id)||null))}async function ee(e){if(!a)return;const{data:t}=await a.from("game_teams").select("*").eq("room_id",e).order("order_index");t&&n.value&&(n.value.teams=t)}function D(){G&&(a?.removeChannel(G),G=null),E=null,I.value=!1,q()}async function he(){if(!a)return;S.value=!0;const{data:e,error:t}=await a.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);t?c.value=t.message:U.value=(e||[]).map(s=>({...s,participant_count:s.participants?.[0]?.count||0})),S.value=!1}async function be(e){if(!a)return[];const{data:t}=await a.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",e).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return t||[]}async function Se(){if(!a||!n.value||!f.user)return;const e=n.value.id,t=n.value.entry_fee||0;if(T.value&&n.value.status==="waiting"){console.log("[Game] æˆ¿ä¸»å–æ¶ˆæˆ¿é–“ï¼Œé€€é‚„æ‰€æœ‰äººå…¥å ´è²»");let s=n.value.participants||[];if(s.length===0||!s[0]?.fee_paid){const{data:r}=await a.from("game_participants").select("*, user:users!game_participants_user_id_fkey(id, display_name)").eq("room_id",e);r&&(s=r)}if(console.log(`[Game] æ‰¾åˆ° ${s.length} ä½åƒèˆ‡è€…éœ€è¦é€€æ¬¾`),t>0)for(const r of s)console.log(`[Game] é€€é‚„å…¥å ´è²»çµ¦ ${r.user_id}ï¼Œfee_paid: ${r.fee_paid}`),await te(r);await a.from("game_rooms").update({status:"cancelled"}).eq("id",e)}else!T.value&&n.value.status==="waiting"&&(console.log("[Game] ç©å®¶é›¢é–‹æˆ¿é–“"),((u.value?.fee_paid||0)>0||t>0)&&u.value&&(console.log(`[Game] é€€é‚„å…¥å ´è²» ${u.value.fee_paid||t} è±†`),await te(u.value)),await a.from("game_participants").delete().eq("room_id",e).eq("user_id",f.user.id));D(),n.value=null,u.value=null}async function te(e){if(!a)return;const t=e.fee_paid||n.value?.entry_fee||0;if(t<=0){console.log(`[Game] ${e.user_id} ç„¡éœ€é€€æ¬¾ï¼ˆé‡‘é¡ç‚º 0ï¼‰`);return}const{data:s}=await a.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",e.user_id).single(),o=(s?.total_beans||0)+t,{error:l}=await a.from("profiles").update({total_beans:o,weekly_beans:(s?.weekly_beans||0)+t,monthly_beans:(s?.monthly_beans||0)+t,updated_at:new Date().toISOString()}).eq("id",e.user_id);if(l){console.error("[Game] é€€æ¬¾å¤±æ•—:",l);return}await a.from("game_transactions").insert({user_id:e.user_id,room_id:e.room_id,type:"refund",amount:t,balance_after:o,description:"æˆ¿é–“å–æ¶ˆï¼Œé€€é‚„å…¥å ´è²»"}),console.log(`ğŸ’° å·²é€€é‚„ ${t} è±†çµ¦ ${e.user_id}ï¼Œæ–°é¤˜é¡: ${o}`),e.user_id===f.user?.id&&await b.fetchProfile()}function Ie(){D(),n.value=null,u.value=null,U.value=[],c.value=null,N.clear()}return{currentRoom:n,rooms:U,myParticipant:u,loading:S,error:c,isRealtimeConnected:I,isHost:T,isPlaying:ne,isWaiting:se,isFinished:re,myTeam:ie,createRoom:oe,joinRoom:le,assignToTeam:K,randomAssignTeams:ue,leaveRoom:Se,startGame:ce,submitScore:de,updateProgress:V,submitTextProgress:_e,fetchTexts:me,endGame:W,subscribeToRoom:C,unsubscribe:D,fetchPublicRooms:he,fetchClassGames:be,reset:Ie}});export{$e as u};
