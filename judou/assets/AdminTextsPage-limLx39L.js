import{d as oe,u as ie,r as y,D as X,c as F,o as de,a,b as e,j,t as o,f as x,l as H,F as $,h as B,e as _,s as q,k as J,T as K,E as Q,n as U,G as h,q as n,z as T,A as S,_ as re}from"./index-Bakowwg8.js";import{u as ue}from"./textsStore-ByfLE4oa.js";import{u as ce}from"./practiceLibraryStore-BscSqemr.js";import"./useSupabase-DAGhbXvW.js";const ve={class:"admin-shell"},me={class:"admin-header"},pe={class:"edamame-text-level-detail"},fe={class:"edamame-heading-gradient"},be={class:"header-actions"},ye=["disabled"],_e=["disabled"],he={class:"admin-layout"},ke={class:"category-sidebar edamame-glass"},ge={class:"sidebar-header"},Ce={key:0,class:"sidebar-loading"},xe={key:1,class:"sidebar-empty"},we={key:2,class:"category-tree"},$e=["onClick"],Te=["onClick"],Se={class:"tree-label"},Ve={class:"tree-count"},Le={class:"tree-actions"},Me=["onClick"],Ae=["onClick"],De=["onClick"],Fe={key:0,class:"tree-children"},Be=["onClick"],Ue={class:"tree-label"},Ee={class:"tree-count"},Ge={class:"tree-actions"},Ie=["onClick"],Ne=["onClick"],Oe=["onClick"],ze={class:"content-panel edamame-glass"},Pe={key:0,class:"content-empty"},je={class:"content-breadcrumb"},He=["onClick"],qe={key:0,class:"breadcrumb-sep"},Je={class:"category-info"},Ke={key:0,class:"category-desc"},Qe={class:"category-meta"},Re={key:0,class:"module-grid"},We=["onClick"],Xe={class:"module-desc"},Ye={class:"module-count"},Ze={key:1,class:"text-list"},et={key:0,class:"text-empty"},tt={key:1},lt={class:"text-title"},st={key:0,class:"text-type-badge system"},nt={key:1,class:"text-type-badge private"},at={class:"text-summary"},ot={class:"actions"},it=["onClick"],dt=["onClick"],rt={class:"modal-card edamame-glass"},ut={class:"modal-body"},ct={class:"form-context"},vt={class:"form-row"},mt={class:"preview-panel"},pt=["innerHTML"],ft={key:0,class:"feedback"},bt=["disabled"],yt={class:"modal-card edamame-glass small-modal"},_t={class:"modal-body"},ht=["placeholder"],kt={key:0,class:"feedback"},gt=["disabled"],Ct={class:"modal-card edamame-glass small-modal"},xt={key:0,class:"feedback"},wt={class:"confirm-actions"},$t=["disabled"],Tt=oe({__name:"AdminTextsPage",setup(St){const p=ue(),v=ce(),w=ie(),f=y(null),k=y(new Set),g=y(!1),C=y(!1),V=y(!1),m=y(!1),L=y(null),M=y(null),b=y(null),u=y(null),i=X({title:"",author:"",source:"",summary:"",content:""}),d=X({name:"",description:"",parentId:null,type:"grade"}),E=F(()=>v.state.categories.filter(s=>s.level===1).sort((s,t)=>s.order_index-t.order_index)),c=F(()=>v.state.categories.find(s=>s.id===f.value)??null),G=F(()=>{if(!c.value)return[];const s=[];let t=c.value;for(;t;)s.unshift(t),t=v.state.categories.find(l=>l.id===t?.parent_id);return s}),N=F(()=>{if(!f.value)return[];let s=p.texts.filter(t=>t.category_id===f.value);return w.isAdmin?s=s.filter(t=>t.is_system===!0):w.isTeacher?s=s.filter(t=>t.is_system===!1&&t.created_by===w.user?.id):s=[],s.sort((t,l)=>(l.created_at??"").localeCompare(t.created_at??""))}),Y=F(()=>{if(!i.content)return"";let s=i.content.replace(/[「」『』"""'']/g,"");return s=s.replace(/[。！？；，：、]/g,"|"),s=s.replace(/\|{2,}/g,"|"),s=s.replace(/^\|+|\|+$/g,""),s.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function A(s){return v.state.categories.filter(t=>t.level===2&&t.parent_id===s).sort((t,l)=>t.order_index-l.order_index)}function R(s){return p.texts.filter(t=>t.category_id===s).length}function Z(s){k.value.has(s)?k.value.delete(s):k.value.add(s)}function I(s){f.value=s;const t=v.state.categories.find(l=>l.id===s);t?.parent_id&&k.value.add(t.parent_id)}function O(){L.value=null,i.title="",i.author="",i.source="",i.summary="",i.content="",u.value=null,g.value=!0}function ee(s){L.value=s.id,i.title=s.title,i.author=s.author??"",i.source=s.source??"",i.summary=s.summary??"",i.content=s.content,u.value=null,g.value=!0}async function te(){if(!i.title||!i.content){u.value="標題與內容為必填";return}if(!f.value){u.value="請先選擇一個分類";return}const s=c.value;if(!s||s.level!==2){u.value="請選擇一個單元（而非年級）來新增文章";return}try{m.value=!0;const t={title:i.title,author:i.author||null,source:i.source||null,summary:i.summary||null,category_id:f.value,content:i.content};if(L.value)await p.updateText(L.value,t);else{const l=w.isAdmin;await p.addText(t,l)}await p.fetchTexts(),g.value=!1}catch(t){u.value=t?.message??"儲存失敗"}finally{m.value=!1}}function D(s,t){M.value=null,d.name="",d.description="",d.parentId=s,d.type=t,u.value=null,C.value=!0}function W(s){M.value=s,d.name=s.name,d.description=s.description??"",d.parentId=s.parent_id,d.type=s.level===1?"grade":"module",u.value=null,C.value=!0}async function le(){if(!d.name.trim()){u.value="名稱不可為空";return}try{m.value=!0,M.value?await v.updateCategory(M.value.id,{name:d.name.trim(),description:d.description.trim()||void 0}):await v.addCategory({name:d.name.trim(),parent_id:d.parentId,type:d.type,description:d.description.trim()||void 0}),C.value=!1}catch(s){u.value=s?.message??"儲存失敗"}finally{m.value=!1}}function z(s,t){b.value={type:s,item:t},u.value=null,V.value=!0}async function se(){if(b.value)try{m.value=!0,b.value.type==="text"?(await p.deleteText(b.value.item.id),await p.fetchTexts()):(await v.deleteCategory(b.value.item.id),f.value===b.value.item.id&&(f.value=null)),V.value=!1,b.value=null}catch(s){u.value=s?.message??"刪除失敗"}finally{m.value=!1}}function ne(s){return s?s===1?"初級":s===2?"中級":"高級":"未標註"}function ae(s){return s?new Date(s).toLocaleDateString():"--"}return de(async()=>{if(v.state.categories.length||await v.fetchLibrary(),p.texts.length||await p.fetchTexts(),E.value.length>0){const s=E.value[0];if(s){k.value.add(s.id);const t=A(s.id)[0];t&&(f.value=t.id)}}}),(s,t)=>(n(),a("div",ve,[e("header",me,[e("div",null,[e("p",pe,o(x(w).isAdmin?"超級管理員":"老師")+" · 文章資料庫 ",1),e("h1",fe,o(x(w).isAdmin?"系統內建文章":"我的私有文章"),1)]),e("div",be,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[0]||(t[0]=l=>{x(v).fetchLibrary(),x(p).fetchTexts()}),disabled:x(v).isLoading||x(p).isLoading}," 重新整理 ",8,ye),e("button",{class:"edamame-btn edamame-btn-primary",onClick:O,disabled:!c.value||c.value.level!==2}," 新增文章 ",8,_e)])]),e("div",he,[e("aside",ke,[e("div",ge,[t[19]||(t[19]=e("span",{class:"sidebar-title"},"分類導航",-1)),e("button",{class:"icon-btn",onClick:t[1]||(t[1]=l=>D(null,"grade")),title:"新增年級"},[...t[18]||(t[18]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M12 5v14M5 12h14"})],-1)])])]),x(v).isLoading?(n(),a("div",Ce,"載入中⋯")):E.value.length?(n(),a("nav",we,[(n(!0),a($,null,B(E.value,l=>(n(),a("div",{key:l.id,class:"tree-node"},[e("div",{class:U(["tree-item grade-item",{selected:f.value===l.id}]),onClick:r=>I(l.id)},[e("button",{class:"expand-btn",onClick:h(r=>Z(l.id),["stop"])},[(n(),a("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",class:U({expanded:k.value.has(l.id)})},[...t[21]||(t[21]=[e("path",{d:"M8 5l8 7-8 7V5z"},null,-1)])],2))],8,Te),e("span",Se,o(l.name),1),e("span",Ve,o(A(l.id).length),1),e("div",Le,[e("button",{class:"action-btn",onClick:h(r=>D(l.id,"module"),["stop"]),title:"新增單元"},"+",8,Me),e("button",{class:"action-btn",onClick:h(r=>W(l),["stop"]),title:"編輯"},"✎",8,Ae),e("button",{class:"action-btn danger",onClick:h(r=>z("category",l),["stop"]),title:"刪除"},"×",8,De)])],10,$e),k.value.has(l.id)?(n(),a("div",Fe,[(n(!0),a($,null,B(A(l.id),r=>(n(),a("div",{key:r.id,class:U(["tree-item module-item",{selected:f.value===r.id}]),onClick:P=>I(r.id)},[e("span",Ue,o(r.name),1),e("span",Ee,o(R(r.id)),1),e("div",Ge,[e("button",{class:"action-btn",onClick:h(P=>W(r),["stop"]),title:"編輯"},"✎",8,Ie),e("button",{class:"action-btn danger",onClick:h(P=>z("category",r),["stop"]),title:"刪除"},"×",8,Ne)])],10,Be))),128)),e("button",{class:"add-module-btn",onClick:r=>D(l.id,"module")}," + 新增單元 ",8,Oe)])):_("",!0)]))),128))])):(n(),a("div",xe,[t[20]||(t[20]=H(" 尚無分類 ",-1)),e("button",{class:"link-btn",onClick:t[2]||(t[2]=l=>D(null,"grade"))},"建立第一個年級")]))]),e("main",ze,[c.value?(n(),a($,{key:1},[e("div",je,[(n(!0),a($,null,B(G.value,(l,r)=>(n(),a("span",{key:l.id,class:U(["breadcrumb-item",{active:r===G.value.length-1}]),onClick:P=>I(l.id)},[H(o(l.name)+" ",1),r<G.value.length-1?(n(),a("span",qe,"›")):_("",!0)],10,He))),128))]),e("div",Je,[e("h2",null,o(c.value.name),1),c.value.description?(n(),a("p",Ke,o(c.value.description),1)):_("",!0),e("p",Qe,o(c.value.level===1?"年級":"單元")+" · "+o(c.value.level===1?`${A(c.value.id).length} 個單元`:`${N.value.length} 篇文章`),1)]),c.value.level===1?(n(),a("div",Re,[(n(!0),a($,null,B(A(c.value.id),l=>(n(),a("div",{key:l.id,class:"module-card",onClick:r=>I(l.id)},[e("h3",null,o(l.name),1),e("p",Xe,o(l.description||"暫無描述"),1),e("p",Ye,o(R(l.id))+" 篇文章",1)],8,We))),128)),e("button",{class:"module-card add-card",onClick:t[3]||(t[3]=l=>D(c.value.id,"module"))},[...t[23]||(t[23]=[e("span",{class:"add-icon"},"+",-1),e("span",null,"新增單元",-1)])])])):(n(),a("div",Ze,[N.value.length?(n(),a("table",tt,[t[25]||(t[25]=e("thead",null,[e("tr",null,[e("th",null,"標題"),e("th",null,"作者"),e("th",null,"難度"),e("th",null,"建立日期"),e("th",{style:{width:"120px"}},"操作")])],-1)),e("tbody",null,[(n(!0),a($,null,B(N.value,l=>(n(),a("tr",{key:l.id},[e("td",null,[e("p",lt,[H(o(l.title)+" ",1),l.is_system?(n(),a("span",st,"系統")):(n(),a("span",nt,"私有"))]),e("p",at,o(l.summary||l.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),e("td",null,o(l.author||"佚名"),1),e("td",null,[e("span",{class:U(["difficulty-badge",`diff-${l.difficulty}`])},o(ne(l.difficulty)),3)]),e("td",null,o(ae(l.created_at)),1),e("td",ot,[e("button",{class:"ghost-btn",onClick:r=>ee(l)},"編輯",8,it),e("button",{class:"ghost-btn danger",onClick:r=>z("text",l)},"刪除",8,dt)])]))),128))])])):(n(),a("div",et,[t[24]||(t[24]=e("p",null,"此單元尚無文章",-1)),e("button",{class:"edamame-btn edamame-btn-primary",onClick:O},"新增第一篇文章")])),e("button",{class:"add-text-btn",onClick:O}," + 在「"+o(c.value.name)+"」新增文章 ",1)]))],64)):(n(),a("div",Pe,[...t[22]||(t[22]=[e("p",null,"請從左側選擇一個分類",-1)])]))])]),(n(),j(Q,{to:"body"},[q(K,{name:"fade"},{default:J(()=>[g.value?(n(),a("div",{key:0,class:"modal-backdrop",onClick:t[10]||(t[10]=h(l=>g.value=!1,["self"]))},[e("div",rt,[e("header",null,[e("h3",null,o(L.value?"編輯文章":"新增文章"),1),e("button",{class:"close-btn",onClick:t[4]||(t[4]=l=>g.value=!1)},"×")]),e("div",ut,[e("p",ct,"將新增至："+o(G.value.map(l=>l.name).join(" › ")),1),e("label",null,[t[26]||(t[26]=e("span",null,"標題",-1)),T(e("input",{"onUpdate:modelValue":t[5]||(t[5]=l=>i.title=l),type:"text",placeholder:"請輸入標題"},null,512),[[S,i.title]])]),e("div",vt,[e("label",null,[t[27]||(t[27]=e("span",null,"作者",-1)),T(e("input",{"onUpdate:modelValue":t[6]||(t[6]=l=>i.author=l),type:"text",placeholder:"例如：孔子"},null,512),[[S,i.author]])]),e("label",null,[t[28]||(t[28]=e("span",null,"來源",-1)),T(e("input",{"onUpdate:modelValue":t[7]||(t[7]=l=>i.source=l),type:"text",placeholder:"例如：論語"},null,512),[[S,i.source]])])]),e("label",null,[t[29]||(t[29]=e("span",null,"內容（標點將自動轉為斷句符號）",-1)),T(e("textarea",{"onUpdate:modelValue":t[8]||(t[8]=l=>i.content=l),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[S,i.content]])]),e("div",mt,[t[30]||(t[30]=e("p",null,"預覽",-1)),e("div",{class:"preview-content",innerHTML:Y.value||"尚無內容"},null,8,pt)]),u.value?(n(),a("p",ft,o(u.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[9]||(t[9]=l=>g.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:m.value,onClick:te},o(m.value?"儲存中...":"儲存"),9,bt)])])])):_("",!0)]),_:1})])),(n(),j(Q,{to:"body"},[q(K,{name:"fade"},{default:J(()=>[C.value?(n(),a("div",{key:0,class:"modal-backdrop",onClick:t[15]||(t[15]=h(l=>C.value=!1,["self"]))},[e("div",yt,[e("header",null,[e("h3",null,o(M.value?"編輯分類":d.type==="grade"?"新增年級":"新增單元"),1),e("button",{class:"close-btn",onClick:t[11]||(t[11]=l=>C.value=!1)},"×")]),e("div",_t,[e("label",null,[t[31]||(t[31]=e("span",null,"名稱",-1)),T(e("input",{"onUpdate:modelValue":t[12]||(t[12]=l=>d.name=l),type:"text",placeholder:d.type==="grade"?"例如：七年級":"例如：論語讀本"},null,8,ht),[[S,d.name]])]),e("label",null,[t[32]||(t[32]=e("span",null,"描述（選填）",-1)),T(e("textarea",{"onUpdate:modelValue":t[13]||(t[13]=l=>d.description=l),rows:"2",placeholder:"簡述此分類的內容範圍"},null,512),[[S,d.description]])]),u.value?(n(),a("p",kt,o(u.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[14]||(t[14]=l=>C.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:m.value,onClick:le},o(m.value?"儲存中...":"儲存"),9,gt)])])])):_("",!0)]),_:1})])),(n(),j(Q,{to:"body"},[q(K,{name:"fade"},{default:J(()=>[V.value?(n(),a("div",{key:0,class:"modal-backdrop",onClick:t[17]||(t[17]=h(l=>V.value=!1,["self"]))},[e("div",Ct,[t[33]||(t[33]=e("h3",null,"確定刪除？",-1)),e("p",null,"「"+o(b.value?.item?"title"in b.value.item?b.value.item.title:b.value.item.name:"")+"」刪除後將無法復原。",1),u.value?(n(),a("p",xt,o(u.value),1)):_("",!0),e("div",wt,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[16]||(t[16]=l=>V.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-danger",disabled:m.value,onClick:se},o(m.value?"刪除中...":"刪除"),9,$t)])])])):_("",!0)]),_:1})]))]))}}),Dt=re(Tt,[["__scopeId","data-v-fe1e6fa7"]]);export{Dt as default};
