import{d as De,u as Fe,r as d,c as T,p as Oe,o as Ue,y as Ge,a as i,b as a,e as b,t as o,g as p,k as Xe,z as je,n as y,A as _e,B as We,F as m,i as E,C as He,m as Qe,l as Je,D as Ke,q as n,_ as Ye}from"./index-D0i31nFW.js";import{u as Ze,a as et}from"./practiceLibraryStore-DuDxfgM8.js";import{u as tt}from"./assignmentStore-BAEiHONP.js";import{u as st}from"./userStatsStore-BdI2cOF1.js";import{u as at}from"./classStore-BYiUoPUk.js";import{c as lt,a as nt,b as it}from"./useClassicalTTS-CXHixeah.js";import"./useSupabase-GxUO7o8v.js";const rt={class:"practice-shell"},ot={class:"picker-section edamame-glass"},ut={class:"picker-current"},ct={class:"picker-info"},dt={class:"picker-breadcrumb"},vt={key:0,class:"picker-meta"},mt={key:0},pt={key:0,class:"picker-panel"},ft={class:"picker-search"},ht={key:0,class:"picker-results"},_t={key:0,class:"picker-empty"},yt=["onClick"],kt={class:"item-main"},gt={class:"item-title"},bt={class:"item-author"},Tt={class:"item-preview"},Ct={key:1,class:"picker-cascade"},St={class:"cascade-row"},wt={class:"cascade-select full-width"},xt=["value"],At={class:"picker-list"},Bt={key:0,class:"picker-empty"},Rt={key:1,class:"picker-empty"},Vt=["onClick"],It={class:"item-main"},$t={class:"item-title"},zt={class:"item-author"},Nt={class:"item-preview"},Pt={class:"hero-actions"},Mt=["disabled"],qt={class:"board-card edamame-glass"},Lt={key:0,class:"practice-board"},Et={class:"board-header"},Dt={class:"board-header-right"},Ft={key:1,class:"timer-badge"},Ot={key:0,class:"practice-line"},Ut=["onClick","aria-label"],Gt={key:0,class:"bean"},Xt={key:1,class:"state-info"},jt={class:"board-actions"},Wt=["disabled"],Ht={key:1,class:"board-empty"},Qt={class:"results-grid"},Jt={class:"result-card edamame-glass"},Kt={class:"result-desc"},Yt={key:0,class:"new-record"},Zt={key:1},es={class:"result-card edamame-glass"},ts={class:"result-desc"},ss={class:"result-card edamame-glass"},as={class:"result-desc"},ls={class:"result-card edamame-glass"},ns={class:"result-desc"},is=De({__name:"PracticePage",setup(rs){const ee=Oe(),C=Ze(),G=et(),ye=tt(),_=Fe(),X=st(),te=at(),se=d(new Set),j=T(()=>ee.query.assignmentId),ae=T(()=>ee.query.textId),u=d(null),k=d([]),S=d(new Set),f=d(new Set),r=d(null),B=d(0),g=d(null),W=d(!1),v=d(0),$=d(0),D=d(0),H=d(!1),Q=d(!1),le=T(()=>S.value.size),ke=T(()=>f.value.size),ne=T(()=>Math.max(0,le.value-ke.value)),ie=T(()=>ne.value>0),z=d(!1),w=d(null),A=d(""),ge=d(localStorage.getItem("judou_username")||"guest"),be=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡"),R=d(!1);let N=null;const x=d(null);function re(){x.value||(x.value=new(window.AudioContext||window.webkitAudioContext))}function J(t){if(x.value||re(),!x.value)return;const e=x.value,l=e.createOscillator(),s=e.createGain();l.connect(s),s.connect(e.destination),t==="add"?(l.frequency.setValueAtTime(400,e.currentTime),l.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),l.start(e.currentTime),l.stop(e.currentTime+.1)):(l.frequency.setValueAtTime(300,e.currentTime),l.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),l.start(e.currentTime),l.stop(e.currentTime+.08))}function oe(t=10){navigator.vibrate&&navigator.vibrate(t)}const K=T(()=>G.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index));function Y(t){return!!(t.is_system===!0||t.created_by===_.user?.id||_.isStudent&&t.created_by&&se.value.has(t.created_by))}const ue=T(()=>w.value?C.texts.filter(t=>t.category_id!==w.value?!1:Y(t)).sort((t,e)=>t.title.localeCompare(e.title)):[]),ce=T(()=>{if(!A.value.trim())return[];const t=A.value.toLowerCase();return C.texts.filter(e=>Y(e)?e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t):!1).slice(0,10)}),Te=T(()=>{if(!u.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];return u.value.category?.name&&t.push(u.value.category.name),t.push(u.value.title),t.join(" â€º ")});async function Ce(){if(!_.isStudent||!_.isAuthenticated)return;await te.fetchStudentClasses();const t=new Set;for(const e of te.classes)e.teacher_id&&t.add(e.teacher_id);se.value=t}function Se(t){const e=[],l=new Set;let s=0;for(const c of t)c==="|"?s>0&&l.add(s-1):c!==`
`&&c!=="\r"&&(e.push(c),s++);return{chars:e,breaks:l}}function we(){F(),B.value=0,N=window.setInterval(()=>{B.value+=1},1e3)}function F(){N&&(clearInterval(N),N=null)}function de(t){const{chars:e,breaks:l}=Se(t.content);k.value=e,S.value=l,f.value=new Set,r.value=null,g.value=null,F(),B.value=0,v.value=0,$.value=0,D.value=0,H.value=!1}function O(t){u.value=t,de(t),z.value=!1,A.value="",t.category_id&&(w.value=t.category_id)}function ve(){const t=C.texts.filter(s=>s.text_type==="practice"&&Y(s));if(!t.length){g.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}const e=Math.floor(Math.random()*t.length),l=t[e];l&&O(l)}async function xe(){const t=[];if(C.texts.length||t.push(C.fetchTexts()),G.state.categories.length||t.push(G.fetchLibrary()),_.isStudent&&_.isAuthenticated&&t.push(Ce()),await Promise.all(t),ae.value&&j.value){const e=C.texts.find(l=>l.id===ae.value);if(e){O(e);return}}if(!u.value&&C.texts.length&&ve(),!w.value&&K.value.length){const e=K.value[0];e&&(w.value=e.id)}}function Ae(t){if(r.value?.isComplete){g.value="å·²å®Œæˆï¼å¦‚è¦é‡æ–°ç·´ç¿’è«‹é»æ“Šé‡æ–°é–‹å§‹ã€‚";return}r.value&&!r.value.isComplete&&(r.value=null);const e=new Set(f.value),l=e.has(t);if(!l&&!ie.value){Be(),g.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}f.value.size===0&&!N&&!H.value&&we(),l?(e.delete(t),J("remove")):(e.add(t),J("add"),oe(10)),f.value=e,g.value=null}function Be(){Q.value=!0,J("remove"),oe(50),setTimeout(()=>{Q.value=!1},400)}function Re(t){if(!r.value){const e=t>0&&f.value.has(t-1),l=f.value.has(t);if(e&&l)return"translateX(0)";if(e)return"translateX(4px)";if(l)return"translateX(-4px)"}return"translateX(0)"}function Ve(t){const e=[],l=f.value.has(t);if(l&&e.push("has-bean"),r.value&&l){const s=r.value.statuses.find(c=>c.index===t);s&&(s.state==="correct"||s.state==="extra")&&e.push(s.state)}return e}function Ie(t){return`${t} è±†`}function me(t){return`${Math.round(t*100)}%`}function pe(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function $e(t,e,l){return X.calculateScore({breakCount:S.value.size,charCount:k.value.length,elapsedSeconds:t,attemptCount:e,isFirstClear:l})}async function ze(){if(!u.value)return;if(!f.value.size){g.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}v.value++;const t=[];let e=0,l=0,s=0;for(let h=0;h<=k.value.length;h++){const q=f.value.has(h),I=S.value.has(h);q&&I?(t.push({index:h,state:"correct"}),e++):!q&&I?(t.push({index:h,state:"missed"}),l++):q&&!I?(t.push({index:h,state:"extra"}),s++):t.push({index:h,state:"pending"})}const c=S.value.size?e/S.value.size:f.value.size?0:1,V=l===0&&s===0;v.value===1&&($.value=c,D.value=B.value,F(),H.value=!0);const Z=D.value||B.value;let M=!1;V&&_.isAuthenticated&&(M=await X.checkFirstClear(u.value.id));const{score:U,breakdown:Le}=V?$e(Z,v.value,M):{score:0,breakdown:void 0};if(r.value={statuses:t,accuracy:c,elapsed:Z,score:U,isComplete:V,breakdown:Le,isFirstClear:M},V){Ne();let h=v.value===1?"ğŸ‰ ä¸€æ¬¡éé—œï¼å¤ªå²å®³äº†ï¼":`âœ… å®Œæˆï¼å…±å˜—è©¦ ${v.value} æ¬¡`;M&&(h+=" ğŸŒŸ é¦–æ¬¡å®Œæˆçå‹µï¼"),g.value=h}else g.value=`é‚„æœ‰ ${l} å€‹éºæ¼ã€${s} å€‹å¤šé¤˜ï¼Œè«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤`;if(V)try{W.value=!0;const h=_.isAuthenticated?_.user?.email?.split("@")[0]||"user":ge.value,q=_.isAuthenticated?_.displayName:be.value,I=await C.recordPracticeResult({text_id:u.value.id,score:U,accuracy:$.value,elapsed_seconds:Z,user_breaks:f.value.size,correct_breaks:S.value.size,username:h,display_name:q,user_id:_.user?.id||null});if(_.isAuthenticated){const L=await X.recordPracticeScore({textId:u.value.id,score:U,isFirstClear:M});if(r.value&&(r.value.beansEarned=L.beansEarned,r.value.isNewRecord=L.isNewRecord),L.beansEarned>0){const Ee=L.isNewRecord?" (æ–°ç´€éŒ„!)":"";g.value=`${g.value} ç²å¾— ${L.beansEarned} è±†${Ee}`}}j.value&&_.isAuthenticated&&I&&await ye.recordCompletion(j.value,I,U,$.value*100)}catch(h){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",h)}finally{W.value=!1}}function Ne(){if(x.value||re(),!x.value)return;const t=x.value,e=t.createOscillator(),l=t.createGain();e.connect(l),l.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),l.gain.setValueAtTime(.3,t.currentTime),l.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function Pe(){if(!k.value.length)return[];const t=[];let e="",l=-1;for(let s=0;s<k.value.length;s++)if(e+=k.value[s],S.value.has(s)){const c=s-l;l=s,c>=8?(e+="ã€‚",t.push(e),e=""):c>=4?e+="ï¼Œ":e+="ã€"}return e.trim()&&(!e.endsWith("ã€‚")&&!e.endsWith("ï¼Œ")&&!e.endsWith("ã€")&&(e+="ã€‚"),t.push(e)),t.length===0&&k.value.length>0?[k.value.join("")+"ã€‚"]:t}let P=!1;function fe(){P=!0,lt(),R.value=!1}const he={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function Me(){if(!k.value.length)return;if(R.value){fe();return}R.value=!0,P=!1;const t=Pe();try{for(let e=0;e<t.length&&!P;e++){const l=t[e+1];l&&nt(l,he);const s=t[e];s&&await it(s,he)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),P||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{R.value=!1,P=!1}}function qe(){u.value&&de(u.value)}return Ue(()=>{xe()}),Ge(()=>{F(),fe()}),(t,e)=>{const l=Qe("router-link");return n(),i("div",rt,[a("section",ot,[a("div",{class:"picker-header",onClick:e[1]||(e[1]=s=>z.value=!z.value)},[a("div",ut,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",ct,[a("span",dt,o(Te.value),1),u.value?(n(),i("span",vt,[p(o(u.value.author||"ä½šå")+" ",1),u.value.source?(n(),i("span",mt," Â· "+o(u.value.source),1)):b("",!0),u.value.source_text?.id?(n(),Xe(l,{key:1,to:{name:"reading-detail",params:{id:u.value.source_text.id}},class:"source-link",onClick:e[0]||(e[0]=je(()=>{},["stop"]))},{default:Je(()=>[p(" Â· ä¾†è‡ªã€Š"+o(u.value.source_text.title)+"ã€‹ ",1)]),_:1},8,["to"])):b("",!0)])):b("",!0)])]),a("button",{class:y(["picker-toggle",{expanded:z.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),z.value?(n(),i("div",pt,[a("div",ft,[_e(a("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>A.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[We,A.value]])]),A.value.trim()?(n(),i("div",ht,[ce.value.length?b("",!0):(n(),i("div",_t," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+o(A.value)+"ã€çš„æ–‡ç«  ",1)),(n(!0),i(m,null,E(ce.value,s=>(n(),i("div",{key:s.id,class:"picker-item",onClick:c=>O(s)},[a("div",kt,[a("span",gt,o(s.title),1),a("span",bt,o(s.author||"ä½šå"),1)]),a("span",Tt,o(pe(s)),1)],8,yt))),128))])):(n(),i("div",Ct,[a("div",St,[a("div",wt,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),_e(a("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(n(!0),i(m,null,E(K.value,s=>(n(),i("option",{key:s.id,value:s.id},o(s.name),9,xt))),128))],512),[[He,w.value]])])]),a("div",At,[w.value?ue.value.length?b("",!0):(n(),i("div",Rt," æ­¤å¹´ç´šå°šç„¡æ–‡ç«  ")):(n(),i("div",Bt," è«‹é¸æ“‡å¹´ç´šä»¥æŸ¥çœ‹æ–‡ç«  ")),(n(!0),i(m,null,E(ue.value,s=>(n(),i("div",{key:s.id,class:y(["picker-item",{active:u.value?.id===s.id}]),onClick:c=>O(s)},[a("div",It,[a("span",$t,o(s.title),1),a("span",zt,o(s.author||"ä½šå"),1),a("span",{class:y(["item-difficulty",`diff-${s.difficulty}`])},o(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",Nt,o(pe(s)),1)],10,Vt))),128))])]))])):b("",!0)]),a("div",Pt,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:qe,disabled:!u.value}," é‡æ–°é–‹å§‹ ",8,Mt),a("button",{class:"edamame-btn edamame-btn-primary",onClick:ve}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",qt,[u.value?(n(),i("div",Lt,[a("div",Et,[e[8]||(e[8]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Dt,[r.value?.isComplete?(n(),i("button",{key:0,class:y(["tts-btn-small",{playing:R.value}]),onClick:Me},o(R.value?"â¹ åœæ­¢":"ğŸ”Š æœ—è®€"),3)):b("",!0),a("div",{class:y(["bean-inventory",{shake:Q.value,empty:!ie.value}])},[(n(!0),i(m,null,E(le.value,s=>(n(),i("span",{key:s,class:y(["inventory-bean",{used:s>ne.value}])},null,2))),128))],2),f.value.size>0||r.value?(n(),i("span",Ft,"â± "+o(B.value)+" ç§’",1)):b("",!0)])]),k.value.length?(n(),i("div",Ot,[(n(!0),i(m,null,E(k.value,(s,c)=>(n(),i("span",{key:c,class:"char-unit"},[a("span",{class:"char",style:Ke({transform:Re(c)})},o(s),5),c<k.value.length-1?(n(),i("button",{key:0,class:y(["bean-slot",Ve(c)]),onClick:V=>Ae(c),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${f.value.has(c)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[f.value.has(c)?(n(),i("span",Gt)):b("",!0),e[9]||(e[9]=a("span",{class:"bean-hint"},null,-1))],10,Ut)):b("",!0)]))),128))])):(n(),i("div",Xt,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",jt,[a("button",{class:y(["edamame-btn edamame-btn-lg",r.value?.isComplete?"edamame-btn-success":"edamame-btn-primary"]),disabled:W.value||r.value?.isComplete,onClick:ze},[r.value?.isComplete?(n(),i(m,{key:0},[p(" âœ“ å®Œæˆï¼ ")],64)):v.value>0?(n(),i(m,{key:1},[p(" å†æ¬¡æäº¤ ("+o(v.value+1)+") ",1)],64)):(n(),i(m,{key:2},[p(" æäº¤ç­”æ¡ˆ ")],64))],10,Wt)]),g.value?(n(),i("p",{key:2,class:y(["toast",{success:r.value?.isComplete}])},o(g.value),3)):b("",!0)])):(n(),i("div",Ht,[...e[10]||(e[10]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",Qt,[a("article",Jt,[e[11]||(e[11]=a("p",{class:"result-label"},"å¾—åˆ†",-1)),a("p",{class:y(["result-value",{placeholder:!r.value?.isComplete}])},o(r.value?.isComplete?Ie(r.value.score):"--"),3),a("p",Kt,[r.value?.isComplete&&r.value?.beansEarned!==void 0?(n(),i(m,{key:0},[r.value.isNewRecord?(n(),i("span",Yt,"ğŸ† æ–°ç´€éŒ„ï¼")):(n(),i("span",Zt,"å·²æ˜¯æœ€é«˜åˆ†")),p(" +"+o(r.value.beansEarned)+" è±† ",1)],64)):r.value?.isComplete&&v.value>1?(n(),i(m,{key:1},[p(" å˜—è©¦ "+o(v.value)+" æ¬¡å¾Œå®Œæˆ ",1)],64)):(n(),i(m,{key:2},[p(" å…¨å°å¾Œé¡¯ç¤ºæœ€çµ‚å¾—åˆ† ")],64))])]),a("article",es,[e[12]||(e[12]=a("p",{class:"result-label"},"é¦–æ¬¡æ­£ç¢ºç‡",-1)),a("p",{class:y(["result-value",{placeholder:v.value===0}])},o(v.value>0?me($.value):"--"),3),a("p",ts,[v.value>0&&!r.value?.isComplete?(n(),i(m,{key:0},[p(" ç•¶å‰ï¼š"+o(me(r.value?.accuracy||0)),1)],64)):(n(),i(m,{key:1},[p(" åæ˜ çœŸå¯¦æ°´å¹³ ")],64))])]),a("article",ss,[e[13]||(e[13]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:y(["result-value",{placeholder:v.value===0}])},o(v.value>0?`${D.value} ç§’`:"--"),3),a("p",as,[r.value?.isComplete&&r.value?.breakdown?(n(),i(m,{key:0},[p(" æ™‚é–“ä¿‚æ•¸ï¼šÃ—"+o(r.value.breakdown.timeFactor),1)],64)):v.value>0?(n(),i(m,{key:1},[p(" é¦–æ¬¡æäº¤æ™‚è¨˜éŒ„ ")],64)):(n(),i(m,{key:2},[p(" è¨ˆæ™‚è‡³é¦–æ¬¡æäº¤ ")],64))])]),a("article",ls,[e[14]||(e[14]=a("p",{class:"result-label"},"å˜—è©¦æ¬¡æ•¸",-1)),a("p",{class:y(["result-value",{placeholder:v.value===0}])},o(v.value>0?v.value:"--"),3),a("p",ns,[r.value?.isComplete&&r.value?.breakdown?(n(),i(m,{key:0},[p(" å˜—è©¦ä¿‚æ•¸ï¼šÃ—"+o(r.value.breakdown.attemptFactor),1)],64)):r.value?.isComplete?(n(),i(m,{key:1},[p(o(v.value===1?"ä¸€æ¬¡éé—œï¼":"å …æŒå°±æ˜¯å‹åˆ©"),1)],64)):(n(),i(m,{key:2},[p(" å¯å¤šæ¬¡å˜—è©¦ç›´åˆ°å…¨å° ")],64))])])])])}}}),fs=Ye(is,[["__scopeId","data-v-ea139c44"]]);export{fs as default};
