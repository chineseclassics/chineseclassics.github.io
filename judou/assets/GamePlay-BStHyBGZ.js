import{d as le,c as u,p as ie,r as h,w as ue,o as ce,K as ve,a as o,b as n,F as g,e as _,n as k,t as p,g as J,i as q,j as de,q as r,_ as me}from"./index-Bclh99Me.js";import{u as pe}from"./gameStore-Ci6RC3-_.js";import"./userStatsStore-CnuZn9Xu.js";const fe={class:"game-play"},he={key:0,class:"loading-container"},_e={class:"play-header"},ge={class:"header-left"},ke={class:"countdown-time"},Te={class:"header-center"},be={class:"text-title"},ye={key:0,class:"text-author"},xe={class:"header-right"},Be=["disabled"],we={key:0,class:"text-tabs"},Se=["onClick"],Ce={class:"tab-number"},Ae={class:"tab-title"},Ve={key:0,class:"tab-check"},ze={class:"play-main"},Ie={class:"board-header"},Re={class:"board-header-right"},Me={class:"practice-board"},$e={key:0,class:"practice-line"},qe={class:"char"},De=["onClick","aria-label"],Ge={key:0,class:"bean"},Ne={class:"progress-hint"},Le={key:0,class:"text-nav"},Fe=["disabled"],Oe={class:"nav-info"},Pe=["disabled"],je={class:"play-footer"},Ee={key:0,class:"footer-hint submitted"},Je={key:1,class:"footer-hint"},Ke=le({__name:"GamePlay",setup(Ue){const K=de(),U=ie(),T=pe(),y=u(()=>U.params.roomId),c=u(()=>T.currentRoom),l=h([]),v=h(new Map),d=h(0),m=u(()=>l.value[d.value]),C=u(()=>m.value&&v.value.get(m.value.id)||null),A=u(()=>C.value?.characters||[]),D=u(()=>C.value?.correctBreaks||new Set),b=u({get:()=>C.value?.userBreaks||new Set,set:a=>{if(m.value&&v.value.has(m.value.id)){const e=v.value.get(m.value.id);e.userBreaks=a}}}),x=h(0);let V=null;const G=u(()=>D.value.size),H=u(()=>b.value.size),N=u(()=>Math.max(0,G.value-H.value)),Q=u(()=>N.value>0),z=h(!1),f=h(!1),L=h(!0);let F=0;function W(a){const e=[],t=new Set;let s=0;for(const i of a)i==="|"?s>0&&t.add(s-1):i!==`
`&&i!=="\r"&&(e.push(i),s++);return{chars:e,breaks:t}}function X(){v.value.clear();for(const a of l.value){const e=W(a.content);v.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Set})}}function Y(a){a>=0&&a<l.value.length&&(d.value=a)}function Z(){d.value>0&&d.value--}function ee(){d.value<l.value.length-1&&d.value++}let I=null;function R(a){try{I||(I=new AudioContext);const e=I,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function M(a=10){navigator.vibrate&&navigator.vibrate(a)}function te(a){if(f.value||!m.value)return;const e=v.value.get(m.value.id);if(!e)return;const t=new Set(e.userBreaks),s=t.has(a);if(!s&&t.size>=e.correctBreaks.size){R("error"),z.value=!0,setTimeout(()=>{z.value=!1},300),M(50);return}s?(t.delete(a),R("remove"),M(5)):(t.add(a),R("add"),M(10)),e.userBreaks=t,v.value=new Map(v.value)}function ae(a){return{"has-bean":b.value.has(a)}}function B(a){const e=v.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(i=>e.userBreaks.has(i))?"complete":"partial"}async function O(){if(f.value)return;f.value=!0;const a=Math.round((Date.now()-F)/1e3);let e=0,t=0;const s=[];for(const P of l.value){const $=v.value.get(P.id);if(!$)continue;const w=$.correctBreaks,j=$.userBreaks;let S=0,E=0;for(const re of j)w.has(re)?S++:E++;const oe=w.size-S;e+=S,t+=w.size,s.push({textId:P.id,userBreaks:[...j],correctBreaks:[...w],correctCount:S,wrongCount:E,missedCount:oe})}const i=t>0?e/t*100:0;sessionStorage.setItem(`game-result-${y.value}`,JSON.stringify({texts:l.value,results:s,totalCorrect:e,totalBreaks:t,accuracy:i,timeSpent:a})),await T.submitScore({roomId:y.value,score:e,accuracy:i,timeSpent:a,firstAccuracy:i,attemptCount:1})}function se(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function ne(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const e=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);x.value=Math.max(0,c.value.time_limit-t),x.value===0&&!f.value&&O()};a(),V=setInterval(a,1e3)}return ue(()=>c.value?.status,a=>{a==="finished"&&K.push({name:"arena-result",params:{roomId:y.value}})}),ce(async()=>{T.subscribeToRoom(y.value),c.value?.text_ids&&c.value.text_ids.length>0?l.value=await T.fetchTexts(c.value.text_ids):c.value?.text_id&&(l.value=await T.fetchTexts([c.value.text_id])),L.value=!1,l.value.length>0&&(X(),F=Date.now(),ne())}),ve(()=>{V&&clearInterval(V)}),(a,e)=>(r(),o("div",fe,[L.value?(r(),o("div",he,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(r(),o(g,{key:1},[n("header",_e,[n("div",ge,[n("div",{class:k(["countdown",{warning:x.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",ke,p(se(x.value)),1)],2)]),n("div",Te,[n("span",be,p(m.value?.title),1),m.value?.author?(r(),o("span",ye,p(m.value.author),1)):_("",!0)]),n("div",xe,[n("button",{class:k(["submit-btn",{waiting:f.value}]),disabled:f.value,onClick:O},[f.value?(r(),o(g,{key:0},[e[2]||(e[2]=n("span",{class:"waiting-spinner"},"⏳",-1)),e[3]||(e[3]=J(" 等待其他玩家... ",-1))],64)):(r(),o(g,{key:1},[J(" 提交答案 ")],64))],10,Be)])]),l.value.length>1?(r(),o("div",we,[(r(!0),o(g,null,q(l.value,(t,s)=>(r(),o("button",{key:t.id,class:k(["text-tab",{active:s===d.value,empty:B(t.id)==="empty",partial:B(t.id)==="partial",complete:B(t.id)==="complete"}]),onClick:i=>Y(s)},[n("span",Ce,p(s+1),1),n("span",Ae,p(t.title),1),B(t.id)==="complete"?(r(),o("span",Ve,"✓")):_("",!0)],10,Se))),128))])):_("",!0),n("main",ze,[n("div",Ie,[e[4]||(e[4]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",Re,[n("div",{class:k(["bean-inventory",{shake:z.value,empty:!Q.value}])},[(r(!0),o(g,null,q(G.value,t=>(r(),o("span",{key:t,class:k(["inventory-bean",{used:t>N.value}])},null,2))),128))],2)])]),n("div",Me,[A.value.length?(r(),o("div",$e,[(r(!0),o(g,null,q(A.value,(t,s)=>(r(),o("span",{key:s,class:"char-unit"},[n("span",qe,p(t),1),s<A.value.length-1?(r(),o("button",{key:0,class:k(["bean-slot",ae(s)]),onClick:i=>te(s),"aria-label":`在「${t}」後${b.value.has(s)?"移除":"添加"}斷句`},[b.value.has(s)?(r(),o("span",Ge)):_("",!0),e[5]||(e[5]=n("span",{class:"bean-hint"},null,-1))],10,De)):_("",!0)]))),128))])):_("",!0)]),n("div",Ne,[n("span",null,"已標記 "+p(b.value.size)+" / "+p(D.value.size)+" 處",1)]),l.value.length>1?(r(),o("div",Le,[n("button",{class:"nav-btn",disabled:d.value===0,onClick:Z}," ← 上一篇 ",8,Fe),n("span",Oe,p(d.value+1)+" / "+p(l.value.length),1),n("button",{class:"nav-btn",disabled:d.value===l.value.length-1,onClick:ee}," 下一篇 → ",8,Pe)])):_("",!0)]),n("footer",je,[f.value?(r(),o("p",Ee," ✅ 已提交答案，等待其他玩家完成或時間結束... ")):(r(),o("p",Je," 完成所有文章後點擊「提交答案」，或等待時間結束自動提交 "))])],64))]))}}),Xe=me(Ke,[["__scopeId","data-v-90b3783f"]]);export{Xe as default};
