import{d as he,c as o,x as _e,r as T,w as ge,f as Te,R as ye,a as r,g as s,F as b,h as f,b as y,t as i,j as C,l as ke,o as l,_ as be}from"./index-Rx0OxSLa.js";import{u as Be}from"./gameStore-Dh-kr5mQ.js";import"./userStatsStore-C5Z_cHLE.js";import"./game-pGsr7gx9.js";const xe={class:"game-play"},we={key:0,class:"loading-container"},Ae={class:"play-header"},Ce={class:"header-left"},Se={class:"countdown-time"},Pe={class:"header-center"},ze={class:"text-title"},Ie={key:0,class:"text-author"},Ve={class:"header-right"},Me={class:"scoreboard"},Re={class:"score-chip"},Ge={class:"chip-value"},De={key:0,class:"score-chip team"},Ee={class:"chip-value"},Fe={key:0,class:"text-tabs"},$e=["onClick"],qe={class:"tab-number"},Le={class:"tab-title"},Ue={key:0,class:"tab-check"},Ne={class:"play-main"},je={class:"board-header"},Oe={class:"board-header-right"},Ye={class:"practice-board"},He={key:0,class:"practice-line"},Je={class:"char"},Ke=["onClick","aria-label"],Qe={key:0,class:"bean"},We={class:"progress-hint"},Xe={key:0,class:"team-board"},Ze={class:"team-name"},et={class:"team-score"},tt={key:1,class:"text-nav"},at=["disabled"],st={class:"nav-info"},nt=["disabled"],rt=250,lt=he({__name:"GamePlay",setup(ot){const W=ke(),X=_e(),_=Be(),S=o(()=>X.params.roomId),u=o(()=>_.currentRoom),P=o(()=>_.myParticipant),Z=o(()=>u.value?.participants||[]),z=o(()=>u.value?.teams||[]),ee=o(()=>P.value?.score||0),$=o(()=>!z.value.length||!P.value?.team_id?null:z.value.find(a=>a.id===P.value.team_id)||null),q=o(()=>{const a=new Map;return z.value.forEach(e=>{a.set(e.id,{id:e.id,name:e.team_name,total:0,count:0})}),Z.value.forEach(e=>{if(e.team_id&&a.has(e.team_id)){const t=a.get(e.team_id);t.total+=e.score||0,t.count+=1}}),Array.from(a.values()).map(e=>({...e,average:e.count>0?e.total/e.count:0}))}),L=o(()=>{const a=$.value;if(!a)return null;const e=q.value.find(t=>t.id===a.id);return e?e.average:null}),U=o(()=>[...q.value].sort((a,e)=>e.average-a.average)),d=T([]),p=T(new Map),m=T(0),v=o(()=>d.value[m.value]),k=o(()=>v.value&&p.value.get(v.value.id)||null),I=o(()=>k.value?.characters||[]),N=o(()=>k.value?.correctBreaks||new Set),B=o({get:()=>k.value?.userBreaks||new Map,set:a=>{if(v.value&&p.value.has(v.value.id)){const e=p.value.get(v.value.id);e.userBreaks=a}}}),x=T(0);let V=null;const j=o(()=>N.value.size),te=o(()=>B.value.size),O=o(()=>Math.max(0,j.value-te.value)),ae=o(()=>O.value>0),M=T(!1),Y=T(null);let h=null,w=!1,R=!1;const H=T(!0);function se(a){const e=[],t=new Set;let n=0;const c=a.replace(/[\|\s]+$/,"");for(const g of c)g==="|"?n>0&&t.add(n-1):g!==`
`&&g!=="\r"&&(e.push(g),n++);return{chars:e,breaks:t}}function ne(){p.value.clear();for(const a of d.value){const e=se(a.content);p.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Map})}}function re(a){a>=0&&a<d.value.length&&(m.value=a)}function le(){m.value>0&&m.value--}function oe(){m.value<d.value.length-1&&m.value++}let G=null;function D(a){try{G||(G=new AudioContext);const e=G,t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function E(a=10){navigator.vibrate&&navigator.vibrate(a)}function ie(a){if(!v.value)return;const e=p.value.get(v.value.id);if(!e||e.userBreaks.has(a))return;if(e.userBreaks.size>=e.correctBreaks.size){D("error"),M.value=!0,setTimeout(()=>{M.value=!1},300),E(50);return}const t={index:a,isCorrect:e.correctBreaks.has(a),placedAt:Date.now()},n=new Map(e.userBreaks);n.set(a,t),e.userBreaks=n,p.value=new Map(p.value),Y.value=t.placedAt,t.isCorrect?(D("add"),E(10)):(D("error"),E(50)),Q();const c=K();c.usedBeansAll>=c.totalBeansAll&&Q(!0)}function ce(a){const e=B.value.get(a);return{"has-bean":!!e,correct:e?.isCorrect,extra:e&&!e.isCorrect}}function J(a){let e=0,t=0;return a.userBreaks.forEach(n=>{n.isCorrect?e++:t++}),{correct:e,wrong:t}}function K(){let a=0,e=0,t=0;return p.value.forEach(n=>{const c=J(n);a+=c.correct,e+=n.correctBreaks.size,t+=n.userBreaks.size}),{totalCorrect:a,totalBeansAll:e,usedBeansAll:t}}function ue(a=!1){if(!v.value||!k.value)return null;const{correct:e,wrong:t}=J(k.value),{totalCorrect:n,totalBeansAll:c,usedBeansAll:g}=K(),pe=Y.value||Date.now(),fe=a||g>=c;return{roomId:S.value,textId:v.value.id,textIndex:m.value,correctCount:e,wrongCount:t,totalCorrect:n,totalBeans:c,usedBeans:g,lastInteraction:pe,isFinished:fe}}async function F(a=!1){h&&(clearTimeout(h),h=null);const e=ue(a);if(e&&!R){R=!0;try{await _.updateProgress(e)}catch(t){console.error("[GamePlay] 更新進度失敗",t)}finally{R=!1}}}function Q(a=!1){a&&(w=!0),h&&clearTimeout(h),h=setTimeout(()=>{F(w),w=!1},rt)}async function de(a=!1){await F(a);try{await _.endGame()}catch(e){console.error("[GamePlay] 結束遊戲失敗",e)}}function A(a){const e=p.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,n=e.correctBreaks.size;return t===0?"empty":t===n&&[...e.correctBreaks].every(c=>e.userBreaks.has(c))?"complete":"partial"}function ve(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function me(){if(!u.value?.started_at||!u.value?.time_limit)return;const a=()=>{const e=new Date(u.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);x.value=Math.max(0,u.value.time_limit-t),x.value===0&&de(!0)};a(),V=setInterval(a,1e3)}return ge(()=>u.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),W.push({name:"arena-result",params:{roomId:S.value}}))}),Te(async()=>{_.subscribeToRoom(S.value),u.value?.text_ids&&u.value.text_ids.length>0?d.value=await _.fetchTexts(u.value.text_ids):u.value?.text_id&&(d.value=await _.fetchTexts([u.value.text_id])),H.value=!1,d.value.length>0&&(ne(),me())}),ye(()=>{V&&clearInterval(V),h&&clearTimeout(h),F(w)}),(a,e)=>(l(),r("div",xe,[H.value?(l(),r("div",we,[...e[0]||(e[0]=[s("span",{class:"loading-spinner"},"⏳",-1),s("span",null,"載入題目中...",-1)])])):(l(),r(b,{key:1},[s("header",Ae,[s("div",Ce,[s("div",{class:y(["countdown",{warning:x.value<30}])},[e[1]||(e[1]=s("span",{class:"countdown-label"},"剩餘時間",-1)),s("span",Se,i(ve(x.value)),1)],2)]),s("div",Pe,[s("span",ze,i(v.value?.title),1),v.value?.author?(l(),r("span",Ie,i(v.value.author),1)):f("",!0)]),s("div",Ve,[s("div",Me,[s("div",Re,[e[2]||(e[2]=s("span",{class:"chip-label"},"個人分數",-1)),s("span",Ge,i(ee.value),1)]),L.value!==null?(l(),r("div",De,[e[3]||(e[3]=s("span",{class:"chip-label"},"團隊平均",-1)),s("span",Ee,i(L.value?.toFixed(2)),1)])):f("",!0)]),e[4]||(e[4]=s("div",{class:"live-pill"},[s("span",{class:"live-dot"}),s("span",null,"實時計分")],-1))])]),d.value.length>1?(l(),r("div",Fe,[(l(!0),r(b,null,C(d.value,(t,n)=>(l(),r("button",{key:t.id,class:y(["text-tab",{active:n===m.value,empty:A(t.id)==="empty",partial:A(t.id)==="partial",complete:A(t.id)==="complete"}]),onClick:c=>re(n)},[s("span",qe,i(n+1),1),s("span",Le,i(t.title),1),A(t.id)==="complete"?(l(),r("span",Ue,"✓")):f("",!0)],10,$e))),128))])):f("",!0),s("main",Ne,[s("div",je,[e[5]||(e[5]=s("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),s("div",Oe,[s("div",{class:y(["bean-inventory",{shake:M.value,empty:!ae.value}])},[(l(!0),r(b,null,C(j.value,t=>(l(),r("span",{key:t,class:y(["inventory-bean",{used:t>O.value}])},null,2))),128))],2)])]),s("div",Ye,[I.value.length?(l(),r("div",He,[(l(!0),r(b,null,C(I.value,(t,n)=>(l(),r("span",{key:n,class:"char-unit"},[s("span",Je,i(t),1),n<I.value.length-1?(l(),r("button",{key:0,class:y(["bean-slot",ce(n)]),onClick:c=>ie(n),"aria-label":`在「${t}」後放置斷句`},[B.value.has(n)?(l(),r("span",Qe)):f("",!0),e[6]||(e[6]=s("span",{class:"bean-hint"},null,-1))],10,Ke)):f("",!0)]))),128))])):f("",!0)]),s("div",We,[s("span",null,"已標記 "+i(B.value.size)+" / "+i(N.value.size)+" 處",1)]),U.value.length?(l(),r("div",Xe,[(l(!0),r(b,null,C(U.value,t=>(l(),r("div",{class:y(["team-row",{me:t.id===$.value?.id}]),key:t.id},[s("span",Ze,i(t.name),1),s("span",et,i(t.average.toFixed(2)),1)],2))),128))])):f("",!0),d.value.length>1?(l(),r("div",tt,[s("button",{class:"nav-btn",disabled:m.value===0,onClick:le}," ← 上一篇 ",8,at),s("span",st,i(m.value+1)+" / "+i(d.value.length),1),s("button",{class:"nav-btn",disabled:m.value===d.value.length-1,onClick:oe}," 下一篇 → ",8,nt)])):f("",!0)]),e[7]||(e[7]=s("footer",{class:"play-footer"},[s("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),vt=be(lt,[["__scopeId","data-v-47d14601"]]);export{vt as default};
