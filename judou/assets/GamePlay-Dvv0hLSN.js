import{d as ge,c as r,x as Te,r as T,w as ke,f as ye,R as be,a as l,g as s,F as B,h as f,b as y,t as u,j as S,l as Be,o,_ as xe}from"./index-CvyLsLFv.js";import{u as we}from"./gameStore-DTkMMxgr.js";import"./userStatsStore-BXNpLtVc.js";import"./game-pGsr7gx9.js";const Ae={class:"game-play"},Ce={key:0,class:"loading-container"},Se={class:"play-header"},Pe={class:"header-left"},ze={class:"countdown-time"},Ie={class:"header-center"},Ve={class:"text-title"},Me={key:0,class:"text-author"},Re={class:"header-right"},Ge={class:"scoreboard"},De={class:"score-chip"},Ee={class:"chip-value"},Fe={key:0,class:"score-chip team"},$e={class:"chip-value"},qe={key:0,class:"text-tabs"},Le=["onClick"],Ue={class:"tab-number"},Ne={class:"tab-title"},je={key:0,class:"tab-check"},Oe={class:"play-main"},Ye={class:"board-header"},He={class:"board-header-right"},Je={class:"practice-board"},Ke={key:0,class:"practice-line"},Qe={class:"char"},We=["onClick","aria-label"],Xe={key:0,class:"bean"},Ze={class:"progress-hint"},et={key:0,class:"team-board"},tt={class:"team-name"},at={class:"team-score"},st={key:1,class:"text-nav"},nt=["disabled"],rt={class:"nav-info"},lt=["disabled"],ot=80,it=ge({__name:"GamePlay",setup(ct){const X=Be(),Z=Te(),_=we(),P=r(()=>Z.params.roomId),i=r(()=>_.currentRoom),k=r(()=>_.myParticipant),ee=r(()=>i.value?.participants||[]),z=r(()=>i.value?.teams||[]),q=r(()=>!z.value.length||!k.value?.team_id?null:z.value.find(a=>a.id===k.value.team_id)||null),te=r(()=>F()),L=r(()=>te.value.totalCorrect),U=r(()=>{const a=new Map;return z.value.forEach(e=>{a.set(e.id,{id:e.id,name:e.team_name,total:0,count:0})}),ee.value.forEach(e=>{if(e.team_id&&a.has(e.team_id)){const t=a.get(e.team_id),n=e.user_id===k.value?.user_id?Math.max(L.value,e.score||0):e.score||0;t.total+=n,t.count+=1}}),Array.from(a.values()).map(e=>({...e,average:e.count>0?e.total/e.count:0}))}),N=r(()=>{const a=q.value;if(!a)return null;const e=U.value.find(t=>t.id===a.id);return e?e.average:null}),j=r(()=>[...U.value].sort((a,e)=>e.average-a.average)),d=T([]),p=T(new Map),m=T(0),v=r(()=>d.value[m.value]),b=r(()=>v.value&&p.value.get(v.value.id)||null),I=r(()=>b.value?.characters||[]),O=r(()=>b.value?.correctBreaks||new Set),x=r({get:()=>b.value?.userBreaks||new Map,set:a=>{if(v.value&&p.value.has(v.value.id)){const e=p.value.get(v.value.id);e.userBreaks=a}}}),w=T(0);let V=null;const Y=r(()=>O.value.size),ae=r(()=>x.value.size),H=r(()=>Math.max(0,Y.value-ae.value)),se=r(()=>H.value>0),M=T(!1),J=T(null);let h=null,A=!1,R=!1;const K=T(!0);function ne(a){const e=[],t=new Set;let n=0;const c=a.replace(/[\|\s]+$/,"");for(const g of c)g==="|"?n>0&&t.add(n-1):g!==`
`&&g!=="\r"&&(e.push(g),n++);return{chars:e,breaks:t}}function re(){p.value.clear();for(const a of d.value){const e=ne(a.content);p.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Map})}}function le(a){a>=0&&a<d.value.length&&(m.value=a)}function oe(){m.value>0&&m.value--}function ie(){m.value<d.value.length-1&&m.value++}let G=null;function D(a){try{G||(G=new AudioContext);const e=G,t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function E(a=10){navigator.vibrate&&navigator.vibrate(a)}function ce(a){if(!v.value)return;const e=p.value.get(v.value.id);if(!e||e.userBreaks.has(a))return;if(e.userBreaks.size>=e.correctBreaks.size){D("error"),M.value=!0,setTimeout(()=>{M.value=!1},300),E(50);return}const t={index:a,isCorrect:e.correctBreaks.has(a),placedAt:Date.now()},n=new Map(e.userBreaks);n.set(a,t),e.userBreaks=n,p.value=new Map(p.value),J.value=t.placedAt,t.isCorrect?(D("add"),E(10)):(D("error"),E(50)),W();const c=F();fe(c.totalCorrect),c.usedBeansAll>=c.totalBeansAll&&W(!0)}function ue(a){const e=x.value.get(a);return{"has-bean":!!e,correct:e?.isCorrect,extra:e&&!e.isCorrect}}function Q(a){let e=0,t=0;return a.userBreaks.forEach(n=>{n.isCorrect?e++:t++}),{correct:e,wrong:t}}function F(){let a=0,e=0,t=0;return p.value.forEach(n=>{const c=Q(n);a+=c.correct,e+=n.correctBreaks.size,t+=n.userBreaks.size}),{totalCorrect:a,totalBeansAll:e,usedBeansAll:t}}function de(a=!1){if(!v.value||!b.value)return null;const{correct:e,wrong:t}=Q(b.value),{totalCorrect:n,totalBeansAll:c,usedBeansAll:g}=F(),he=J.value||Date.now(),_e=a||g>=c;return{roomId:P.value,textId:v.value.id,textIndex:m.value,correctCount:e,wrongCount:t,totalCorrect:n,totalBeans:c,usedBeans:g,lastInteraction:he,isFinished:_e}}async function $(a=!1){h&&(clearTimeout(h),h=null);const e=de(a);if(e&&!R){R=!0;try{await _.updateProgress(e)}catch(t){console.error("[GamePlay] 更新進度失敗",t)}finally{R=!1}}}function W(a=!1){a&&(A=!0),h&&clearTimeout(h),h=setTimeout(()=>{$(A),A=!1},ot)}async function ve(a=!1){await $(a);try{await _.endGame()}catch(e){console.error("[GamePlay] 結束遊戲失敗",e)}}function C(a){const e=p.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,n=e.correctBreaks.size;return t===0?"empty":t===n&&[...e.correctBreaks].every(c=>e.userBreaks.has(c))?"complete":"partial"}function me(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function pe(){if(!i.value?.started_at||!i.value?.time_limit)return;const a=()=>{const e=new Date(i.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);w.value=Math.max(0,i.value.time_limit-t),w.value===0&&ve(!0)};a(),V=setInterval(a,1e3)}ke(()=>i.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),X.push({name:"arena-result",params:{roomId:P.value}}))}),ye(async()=>{_.subscribeToRoom(P.value),i.value?.text_ids&&i.value.text_ids.length>0?d.value=await _.fetchTexts(i.value.text_ids):i.value?.text_id&&(d.value=await _.fetchTexts([i.value.text_id])),K.value=!1,d.value.length>0&&(re(),pe())}),be(()=>{V&&clearInterval(V),h&&clearTimeout(h),$(A)});function fe(a){if(k.value&&(k.value.score=a),i.value?.participants){const e=i.value.participants.map(t=>t.user_id===k.value?.user_id?{...t,score:a}:t);i.value.participants=e}}return(a,e)=>(o(),l("div",Ae,[K.value?(o(),l("div",Ce,[...e[0]||(e[0]=[s("span",{class:"loading-spinner"},"⏳",-1),s("span",null,"載入題目中...",-1)])])):(o(),l(B,{key:1},[s("header",Se,[s("div",Pe,[s("div",{class:y(["countdown",{warning:w.value<30}])},[e[1]||(e[1]=s("span",{class:"countdown-label"},"剩餘時間",-1)),s("span",ze,u(me(w.value)),1)],2)]),s("div",Ie,[s("span",Ve,u(v.value?.title),1),v.value?.author?(o(),l("span",Me,u(v.value.author),1)):f("",!0)]),s("div",Re,[s("div",Ge,[s("div",De,[e[2]||(e[2]=s("span",{class:"chip-label"},"個人分數",-1)),s("span",Ee,u(L.value),1)]),N.value!==null?(o(),l("div",Fe,[e[3]||(e[3]=s("span",{class:"chip-label"},"團隊平均",-1)),s("span",$e,u(N.value?.toFixed(2)),1)])):f("",!0)]),e[4]||(e[4]=s("div",{class:"live-pill"},[s("span",{class:"live-dot"}),s("span",null,"實時計分")],-1))])]),d.value.length>1?(o(),l("div",qe,[(o(!0),l(B,null,S(d.value,(t,n)=>(o(),l("button",{key:t.id,class:y(["text-tab",{active:n===m.value,empty:C(t.id)==="empty",partial:C(t.id)==="partial",complete:C(t.id)==="complete"}]),onClick:c=>le(n)},[s("span",Ue,u(n+1),1),s("span",Ne,u(t.title),1),C(t.id)==="complete"?(o(),l("span",je,"✓")):f("",!0)],10,Le))),128))])):f("",!0),s("main",Oe,[s("div",Ye,[e[5]||(e[5]=s("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),s("div",He,[s("div",{class:y(["bean-inventory",{shake:M.value,empty:!se.value}])},[(o(!0),l(B,null,S(Y.value,t=>(o(),l("span",{key:t,class:y(["inventory-bean",{used:t>H.value}])},null,2))),128))],2)])]),s("div",Je,[I.value.length?(o(),l("div",Ke,[(o(!0),l(B,null,S(I.value,(t,n)=>(o(),l("span",{key:n,class:"char-unit"},[s("span",Qe,u(t),1),n<I.value.length-1?(o(),l("button",{key:0,class:y(["bean-slot",ue(n)]),onClick:c=>ce(n),"aria-label":`在「${t}」後放置斷句`},[x.value.has(n)?(o(),l("span",Xe)):f("",!0),e[6]||(e[6]=s("span",{class:"bean-hint"},null,-1))],10,We)):f("",!0)]))),128))])):f("",!0)]),s("div",Ze,[s("span",null,"已標記 "+u(x.value.size)+" / "+u(O.value.size)+" 處",1)]),j.value.length?(o(),l("div",et,[(o(!0),l(B,null,S(j.value,t=>(o(),l("div",{class:y(["team-row",{me:t.id===q.value?.id}]),key:t.id},[s("span",tt,u(t.name),1),s("span",at,u(t.average.toFixed(2)),1)],2))),128))])):f("",!0),d.value.length>1?(o(),l("div",st,[s("button",{class:"nav-btn",disabled:m.value===0,onClick:oe}," ← 上一篇 ",8,nt),s("span",rt,u(m.value+1)+" / "+u(d.value.length),1),s("button",{class:"nav-btn",disabled:m.value===d.value.length-1,onClick:ie}," 下一篇 → ",8,lt)])):f("",!0)]),e[7]||(e[7]=s("footer",{class:"play-footer"},[s("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),pt=xe(it,[["__scopeId","data-v-ea65ed85"]]);export{pt as default};
