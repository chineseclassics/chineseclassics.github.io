import{d as ae,u as ne,c as v,x as re,r as B,w as oe,f as le,a as r,g as a,h as i,t as u,b as _,e as J,F as M,j as I,s as C,k as ue,l as ie,i as V,m as ce,o as n,_ as ve}from"./index-BMxa7SLO.js";import{u as de}from"./gameStore-C4ubWLpy.js";import{u as me}from"./userStatsStore-C4kFD-tk.js";import{b as L}from"./game-C73ZBjL5.js";import{B as O}from"./BeanIcon-ByaWvMaQ.js";import{T as pe}from"./TeamBadge-pjCEiC6h.js";const _e={class:"result-header"},ge={key:0,class:"result-icon"},fe={key:1},he={key:2},ke={class:"bean-sign"},ye={key:0,class:"bean-note"},be={key:0,class:"ranking-section"},we={class:"ranking-list"},Se=["src","alt"],Be={key:1,class:"avatar-placeholder"},Ce={class:"name"},Te={class:"score"},Ae={class:"accuracy"},xe={class:"time"},Re={key:1,class:"streak-card"},Me={class:"streak-text"},Ie={key:2,class:"answers-section"},Pe={key:0,class:"result-tabs"},De=["onClick"],Ve={class:"tab-number"},ze={class:"tab-title"},Fe={class:"tab-stats"},Ne={key:1,class:"answer-detail"},$e={class:"answer-header"},Ue={key:0,class:"answer-author"},Ge={class:"answer-stats"},qe={class:"stat correct"},je={class:"stat wrong"},Ee={class:"stat missed"},Je={class:"answer-content"},Le={class:"answer-line"},Oe={class:"answer-char"},We={key:3,class:"ranking-section"},He={class:"team-ranking-list"},Ke={class:"rank"},Qe={class:"team-name-group"},Xe={class:"team-name"},Ye={key:0,class:"team-reward-badge"},Ze={class:"team-score"},et=ae({__name:"GameResult",setup(tt){const P=ie(),W=re(),k=de(),T=ne(),z=me(),A=v(()=>W.params.roomId),l=v(()=>k.currentRoom),y=v(()=>k.myParticipant),H=v(()=>l.value?.participants||[]),F=v(()=>l.value?.teams||[]),d=B(null),x=B(0),c=v(()=>{if(!d.value)return null;const s=d.value.texts[x.value],e=d.value.results[x.value];return!s||!e?null:{text:s,result:e}});function N(s){const e=[];for(const t of s)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function $(s){if(!c.value?.result)return"none";const e=c.value.result,t=e.userBreaks.includes(s),o=e.correctBreaks.includes(s);return t&&o?"correct":t&&!o?"wrong":!t&&o?"missed":"none"}const p=v(()=>{if(!l.value||!T.user)return!1;if(l.value.game_mode==="team_battle")return y.value?.team_id===l.value.winner_team_id;{if(l.value.winner_user_id)return l.value.winner_user_id===T.user.id;if(!l.value.participants)return!1;const s=y.value?.score??0,e=y.value?.time_spent??999999,t=Math.max(...l.value.participants.map(m=>m.score)),o=l.value.participants.filter(m=>m.score===t),w=Math.min(...o.map(m=>m.time_spent??999999));return s===t&&e===w}}),g=v(()=>!l.value||l.value.game_mode==="team_battle"?!1:!l.value.winner_user_id&&p.value),K=v(()=>l.value?.participants?[...l.value.participants].sort((s,e)=>e.score-s.score).map((s,e)=>({...s,rank:e+1})):[]),Q=v(()=>F.value.length?F.value.map(s=>{const e=H.value.filter(S=>S.team_id===s.id),t=e.reduce((S,R)=>S+(R.score||0),0),o=e.length>0?t/e.length:0,m=(typeof s.total_score=="number"?s.total_score/100:0)||o;return{...s,averageScore:m}}).sort((s,e)=>e.averageScore-s.averageScore):[]),U=v(()=>z.profile?.pvp_win_streak??0),G=B(!1),b=B(0),f=B(!1),h=v(()=>{if(!y.value||!l.value)return{amount:0,type:"neutral"};if(l.value.game_mode==="team_battle")return p.value?{amount:20,type:"win"}:{amount:0,type:"neutral"};const s=y.value.fee_paid||l.value.entry_fee||0,e=l.value.participants?.length||0;return g.value?{amount:0,type:"tie"}:p.value&&s>0?{amount:s*e,type:"win"}:!p.value&&s>0?{amount:-s,type:"lose"}:{amount:0,type:"neutral"}});function X(){const s=Math.abs(h.value.amount),e=h.value.type;if(s===0&&e!=="tie"){f.value=!0;return}G.value=!0,b.value=0,f.value=!1;const t=1800,o=Date.now(),w=s>0?s:100;let m=0;const S=3;let R=0;const te=50;function q(){const se=Date.now()-o,D=Math.min(se/t,1),j=Date.now();if(D<1){if(m++,m%S===0&&j-R>=te){if(D<.8)b.value=Math.floor(Math.random()*w*1.5);else{const E=(D-.8)/.2;b.value=Math.floor(s*E+Math.random()*(s*(1-E)))}R=j}requestAnimationFrame(q)}else b.value=s,f.value=!0}setTimeout(()=>{requestAnimationFrame(q)},300)}function Y(s){d.value&&s>=0&&s<d.value.texts.length&&(x.value=s)}function Z(){k.reset(),sessionStorage.removeItem(`game-result-${A.value}`),P.push({name:"arena"})}function ee(){k.reset(),sessionStorage.removeItem(`game-result-${A.value}`),T.isTeacher?P.push({name:"arena-teacher-create"}):P.push({name:"arena-create"})}return oe(()=>l.value?.status,s=>{}),le(()=>{k.subscribeToRoom(A.value),z.fetchProfile();const s=sessionStorage.getItem(`game-result-${A.value}`);if(s)try{d.value=JSON.parse(s)}catch{}X()}),(s,e)=>(n(),r("div",{class:_(["game-result",{winner:p.value,tie:g.value}])},[a("header",_e,[g.value||p.value?(n(),r("div",ge,u(g.value?"ğŸ¤":"ğŸ†"),1)):i("",!0),!g.value&&p.value?(n(),r("h1",fe,"æ­å–œç²å‹ï¼")):g.value?(n(),r("h1",he,"å¹³å±€ï¼")):i("",!0),G.value||h.value.type!=="neutral"?(n(),r("div",{key:3,class:_(["bean-change-display",[h.value.type,{complete:f.value}]])},[a("span",ke,u(h.value.type==="lose"?"-":h.value.type==="win"?"+":""),1),a("span",{class:_(["bean-number",{rolling:!f.value}])},u(b.value),3),J(O,{size:40,class:"bean-icon-img"}),g.value&&f.value?(n(),r("span",ye,"å…¥å ´è²»å·²é€€é‚„")):i("",!0)],2)):i("",!0)]),l.value?.game_mode==="pvp"?(n(),r("section",be,[e[0]||(e[0]=a("h2",null,"æ’è¡Œæ¦œ",-1)),a("div",we,[(n(!0),r(M,null,I(K.value,t=>(n(),r("div",{key:t.id,class:_(["ranking-item",{me:t.user_id===V(T).user?.id,top:t.rank<=3}])},[a("span",{class:_(["rank",`rank-${t.rank}`])},u(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(n(),r("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,Se)):(n(),r("span",Be,u(t.user?.display_name?.charAt(0)||"?"),1)),a("span",Ce,u(t.user?.display_name||"æœªçŸ¥"),1),a("span",Te,u(t.score)+" åˆ†",1),a("span",Ae,u(t.accuracy?.toFixed(0)||0)+"%",1),a("span",xe,u(t.time_spent)+"s",1)],2))),128))])])):i("",!0),U.value>0&&p.value?(n(),r("div",Re,[e[3]||(e[3]=a("span",{class:"streak-icon"},"ğŸ”¥",-1)),a("span",Me,[e[1]||(e[1]=C(" é€£å‹ ",-1)),a("strong",null,u(U.value),1),e[2]||(e[2]=C(" å ´ï¼ ",-1))])])):i("",!0),d.value?(n(),r("section",Ie,[e[9]||(e[9]=a("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),d.value.texts.length>1?(n(),r("div",Pe,[(n(!0),r(M,null,I(d.value.texts,(t,o)=>(n(),r("button",{key:t.id,class:_(["result-tab",{active:o===x.value}]),onClick:w=>Y(o)},[a("span",Ve,u(o+1),1),a("span",ze,u(t.title),1),a("span",Fe," âœ“"+u(d.value.results[o]?.correctCount||0),1)],10,De))),128))])):i("",!0),c.value&&c.value.text&&c.value.result?(n(),r("div",Ne,[a("div",$e,[a("h3",null,u(c.value.text.title),1),c.value.text.author?(n(),r("span",Ue,u(c.value.text.author),1)):i("",!0)]),a("div",Ge,[a("span",qe,[e[4]||(e[4]=a("span",{class:"bean-legend correct"},null,-1)),C(" æ­£ç¢º "+u(c.value.result.correctCount),1)]),a("span",je,[e[5]||(e[5]=a("span",{class:"bean-legend wrong"},null,-1)),C(" éŒ¯èª¤ "+u(c.value.result.wrongCount),1)]),a("span",Ee,[e[6]||(e[6]=a("span",{class:"bean-legend missed"},null,-1)),C(" éºæ¼ "+u(c.value.result.missedCount),1)])]),a("div",Je,[a("div",Le,[(n(!0),r(M,null,I(N(c.value.text.content),(t,o)=>(n(),r("span",{key:o,class:"char-unit"},[a("span",Oe,u(t),1),o<N(c.value.text.content).length-1&&$(o)!=="none"?(n(),r("span",{key:0,class:_(["bean-slot",$(o)])},[...e[7]||(e[7]=[a("span",{class:"bean"},null,-1)])],2)):i("",!0)]))),128))])]),e[8]||(e[8]=ue('<div class="answer-legend" data-v-163cd176><span class="legend-item" data-v-163cd176><span class="bean-legend correct" data-v-163cd176></span> æ­£ç¢º </span><span class="legend-item" data-v-163cd176><span class="bean-legend wrong" data-v-163cd176></span> éŒ¯èª¤ </span><span class="legend-item" data-v-163cd176><span class="bean-legend missed" data-v-163cd176></span> éºæ¼ </span></div>',1))])):i("",!0)])):i("",!0),l.value?.game_mode==="team_battle"?(n(),r("section",We,[e[11]||(e[11]=a("h2",null,"éšŠä¼æ’è¡Œ",-1)),a("div",He,[(n(!0),r(M,null,I(Q.value,(t,o)=>(n(),r("div",{key:t.id,class:_(["team-ranking-item",{winner:o===0}])},[a("span",Ke,u(o===0?"ğŸ†":o+1),1),V(L)(t)?(n(),ce(pe,{key:0,"product-type":V(L)(t),size:54,class:"team-badge-in-ranking"},null,8,["product-type"])):i("",!0),a("div",Qe,[a("span",Xe,u(t.team_name),1),o===0?(n(),r("div",Ye,[J(O,{size:16}),e[10]||(e[10]=a("span",null,"æ¯ä½æˆå“¡ +20 è±†",-1))])):i("",!0)]),a("span",Ze,u(t.averageScore.toFixed(2))+" åˆ†",1)],2))),128))])])):i("",!0),a("footer",{class:"result-footer"},[a("button",{class:"btn-secondary",onClick:Z}," è¿”å›é¬¥è±† "),a("button",{class:"btn-primary",onClick:ee}," å†ä¾†ä¸€å±€ ")])],2))}}),ut=ve(et,[["__scopeId","data-v-163cd176"]]);export{ut as default};
