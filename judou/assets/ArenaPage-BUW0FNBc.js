import{d as K,u as O,r as _,c as h,w as q,P as W,a as n,g as e,h as w,i as p,e as Y,t as o,n as j,s as r,b as G,F as X,j as F,H,I as J,L as Q,l as Z,o as i,N as u,_ as ss}from"./index-kveOurqA.js";import{u as es}from"./gameStore-DtLVJ2tz.js";import{u as as}from"./userStatsStore-CXm0EKCj.js";import{g as P,E as ts,S as os}from"./game-pGsr7gx9.js";import{B as ls}from"./BeanIcon-CJyBiJCq.js";const ns={class:"arena-page"},is={class:"arena-header"},rs={key:0,class:"stats-card"},us={class:"stat-item"},cs={class:"stat-value"},ds={class:"stat-item"},ms={class:"stat-label"},ps={key:0,class:"stat-item streak"},vs={class:"stat-value"},_s={class:"stat-item"},gs={class:"stat-value"},fs={class:"stat-label"},bs={key:0,class:"login-prompt"},ys={key:1,class:"arena-main"},hs={key:0,class:"teacher-section"},ks={key:1,class:"student-section"},Cs={class:"tab-nav"},As={class:"tab-icon"},ws={class:"tab-content"},Ts={key:0,class:"join-tab"},Is={class:"class-games-section"},Ss={key:0,class:"loading-state small"},xs={key:1,class:"empty-state small"},Rs={key:2,class:"class-games-list"},js={class:"game-info"},Gs={class:"game-title-row"},Ls={class:"game-meta"},Es={class:"class-name"},Ns={class:"game-code"},Bs=["disabled","onClick"],Ms={class:"code-join-section"},Us={class:"code-input-group"},Vs=["disabled"],Xs={key:0,class:"error-message"},Fs={key:1,class:"create-tab"},Ps={key:0,class:"unlock-card"},$s={class:"progress-bar"},Ds={class:"progress-text"},zs={key:1,class:"create-card"},Ks={class:"fee-info"},Os={class:"fee-options"},qs={class:"safety-info"},Ws={class:"safety-text"},T=3,Ys=K({__name:"ArenaPage",setup(Hs){const g=Z(),l=O(),L=es(),c=as(),f=_("join"),k=_(""),d=_(!1),v=_(""),m=_([]),I=_(!1);let b=null;const y=_([]),$=h(()=>c.profile?.total_beans??0),C=h(()=>c.level),S=h(()=>P(C.value)),E=h(()=>c.profile?.pvp_win_streak??0),x=h(()=>({wins:c.profile?.pvp_total_wins??0,games:c.profile?.pvp_total_games??0,winRate:c.profile?.pvp_total_games?Math.round((c.profile?.pvp_total_wins??0)/c.profile.pvp_total_games*100):0})),R=h(()=>C.value>=T);async function N(){if(!u||!l.user)return console.log("[Arena] fetchMyClassIds: supabase æˆ– user ç‚ºç©º"),[];console.log("[Arena] ç²å–å­¸ç”Ÿç­ç´šï¼Œuser.id:",l.user.id);const{data:a,error:s}=await u.from("class_members").select("class_id").eq("student_id",l.user.id);if(s)return console.error("[Arena] ç²å–ç­ç´šå¤±æ•—:",s),[];const t=a?.map(A=>A.class_id)||[];return console.log("[Arena] å­¸ç”Ÿæ‰€å±¬ç­ç´š:",t),t}async function B(){if(console.log("[Arena] fetchClassGames é–‹å§‹ï¼Œuser:",l.user?.id,"isTeacher:",l.isTeacher),!u||!l.user||l.isTeacher){console.log("[Arena] fetchClassGames è·³éŽï¼šsupabase=",!!u,"user=",!!l.user,"isTeacher=",l.isTeacher);return}I.value=!0;try{const a=await N();if(y.value=a,a.length===0){console.log("[Arena] å­¸ç”ŸæœªåŠ å…¥ä»»ä½•ç­ç´š"),m.value=[];return}console.log("[Arena] é–‹å§‹æŸ¥è©¢ç­ç´šæ¯”è³½ï¼Œç­ç´šID:",a);const{data:s,error:t}=await u.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        class:classes!game_rooms_class_id_fkey(id, class_name),
        teams:game_teams!game_teams_room_id_fkey(*)
      `).in("class_id",a).eq("host_type","teacher").in("status",["waiting","playing"]).order("created_at",{ascending:!1});if(t){console.error("[Arena] æŸ¥è©¢ç­ç´šæ¯”è³½å¤±æ•—:",t),m.value=[];return}m.value=s||[],console.log("[Arena] ç­ç´šæ¯”è³½:",m.value.length,"å ´",s)}catch(a){console.error("ç²å–ç­ç´šæ¯”è³½å¤±æ•—:",a),m.value=[]}finally{I.value=!1}}async function D(){if(!(!u||!l.user||l.isTeacher)){if(y.value.length===0&&(y.value=await N()),y.value.length===0){console.log("[Arena] å­¸ç”ŸæœªåŠ å…¥ä»»ä½•ç­ç´šï¼Œè·³éŽ Realtime è¨‚é–±");return}b&&u.removeChannel(b),console.log("[Arena] é–‹å§‹è¨‚é–±ç­ç´šæ¯”è³½ Realtimeï¼Œç­ç´šID:",y.value),b=u.channel("class-games-channel").on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},async a=>{console.log("[Arena] Realtime æ”¶åˆ° game_rooms è®Šæ›´:",a.eventType,a);const s=a.new,t=a.old,A=s?.class_id||t?.class_id;if(!A||!y.value.includes(A)){console.log("[Arena] ä¸æ˜¯æˆ‘ç­ç´šçš„æ¯”è³½ï¼Œå¿½ç•¥");return}console.log("[Arena] æ˜¯æˆ‘ç­ç´šçš„æ¯”è³½ï¼Œé‡æ–°ç²å–åˆ—è¡¨"),await B()}).subscribe(a=>{console.log("[Arena] Realtime è¨‚é–±ç‹€æ…‹:",a)})}}function M(){b&&u&&(console.log("[Arena] å–æ¶ˆ Realtime è¨‚é–±"),u.removeChannel(b),b=null)}async function z(a){d.value=!0,v.value="";const s=await L.joinRoom(a.room_code);s.success?a.status==="playing"?g.push({name:"arena-play",params:{roomId:a.id}}):g.push({name:"arena-lobby",params:{roomId:a.id}}):v.value=s.error||"åŠ å…¥å¤±æ•—",d.value=!1}async function U(){if(!k.value.trim()){v.value="è«‹è¼¸å…¥æˆ¿é–“ç¢¼";return}d.value=!0,v.value="";const a=await L.joinRoom(k.value.trim().toUpperCase());a.success?a.room?.status==="playing"?g.push({name:"arena-play",params:{roomId:a.room.id}}):g.push({name:"arena-lobby",params:{roomId:a.room.id}}):v.value=a.error||"åŠ å…¥å¤±æ•—",d.value=!1}function V(){l.isTeacher?g.push({name:"arena-teacher-create"}):g.push({name:"arena-create"})}return q(()=>[l.isAuthenticated,l.isTeacher],async([a,s])=>{console.log("[Arena] èªè­‰ç‹€æ…‹è®ŠåŒ–:",{isAuth:a,isTeacher:s}),a&&!s?(console.log("[Arena] å­¸ç”Ÿç™»å…¥ï¼Œé–‹å§‹ç²å–ç­ç´šæ¯”è³½"),await B(),await D()):(m.value=[],M())},{immediate:!0}),W(()=>{M()}),(a,s)=>(i(),n("div",ns,[e("header",is,[p(l).isAuthenticated?(i(),n("div",rs,[e("div",us,[Y(ls,{size:24,class:"stat-icon-img"}),e("span",cs,o($.value),1),s[4]||(s[4]=e("span",{class:"stat-label"},"è±†å­",-1))]),e("div",ds,[e("span",{class:"stat-icon",style:j({color:S.value.color})},"ðŸŽ“",4),e("span",{class:"stat-value",style:j({color:S.value.color})},o(S.value.title),5),e("span",ms,"Lv."+o(C.value),1)]),E.value>0?(i(),n("div",ps,[s[5]||(s[5]=e("span",{class:"stat-icon"},"ðŸ”¥",-1)),e("span",vs,o(E.value),1),s[6]||(s[6]=e("span",{class:"stat-label"},"é€£å‹",-1))])):w("",!0),e("div",_s,[s[7]||(s[7]=e("span",{class:"stat-icon"},"ðŸ“Š",-1)),e("span",gs,o(x.value.winRate)+"%",1),e("span",fs,"å‹çŽ‡ ("+o(x.value.wins)+"/"+o(x.value.games)+")",1)])])):w("",!0)]),p(l).isAuthenticated?(i(),n("main",ys,[p(l).isTeacher?(i(),n("section",hs,[s[12]||(s[12]=e("h2",{class:"section-title"},[e("span",{class:"section-icon"},"ðŸ“¢"),r(" èª²å ‚é¬¥è±† ")],-1)),s[13]||(s[13]=e("p",{class:"section-desc"},"å‰µå»ºç­ç´šæ¯”è³½ï¼Œè®“å­¸ç”Ÿåˆ†çµ„ç«¶æŠ€",-1)),e("button",{class:"btn-primary btn-large",onClick:V},[...s[11]||(s[11]=[e("span",{class:"btn-icon"},"âž•",-1),r(" å‰µå»ºèª²å ‚é¬¥è±† ",-1)])])])):(i(),n("div",ks,[e("nav",Cs,[e("button",{class:G(["tab-btn",{active:f.value==="join"}]),onClick:s[1]||(s[1]=t=>f.value="join")},[...s[14]||(s[14]=[e("span",{class:"tab-icon"},"ðŸŽ«",-1),r(" åŠ å…¥é¬¥è±†å ´ ",-1)])],2),e("button",{class:G(["tab-btn",{active:f.value==="create",locked:!R.value}]),onClick:s[2]||(s[2]=t=>f.value="create")},[e("span",As,o(R.value?"âž•":"ðŸ”’"),1),s[15]||(s[15]=r(" å‰µå»ºé¬¥è±†å ´ ",-1))],2)]),e("div",ws,[f.value==="join"?(i(),n("div",Ts,[e("section",Is,[s[21]||(s[21]=e("div",{class:"section-header"},[e("h3",null,[e("span",{class:"header-icon"},"ðŸ«"),r(" ç­ç´šæ¯”è³½ ")]),e("span",{class:"realtime-badge"},[e("span",{class:"realtime-dot"}),r(" å¯¦æ™‚æ›´æ–° ")])],-1)),I.value?(i(),n("div",Ss,[...s[16]||(s[16]=[e("div",{class:"spinner"},null,-1),e("span",null,"æª¢æŸ¥ç­ç´šæ¯”è³½...",-1)])])):m.value.length===0?(i(),n("div",xs,[...s[17]||(s[17]=[e("p",null,"ç›®å‰æ²’æœ‰ç­ç´šæ¯”è³½",-1),e("p",{class:"empty-hint"},"è€å¸«ç™¼èµ·æ¯”è³½å¾Œæœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡",-1)])])):(i(),n("div",Rs,[(i(!0),n(X,null,F(m.value,t=>(i(),n("div",{key:t.id,class:"class-game-card"},[e("div",js,[e("div",Gs,[e("h4",null,o(t.text?.title||"èª²å ‚é¬¥è±†"),1),e("span",{class:G(["game-status",t.status])},o(t.status==="playing"?"ðŸ”´ é€²è¡Œä¸­":"ðŸŸ¡ ç­‰å¾…ä¸­"),3)]),e("p",Ls,[e("span",Es,o(t.class?.class_name),1),s[18]||(s[18]=e("span",{class:"divider"},"Â·",-1)),e("span",null,o(t.host?.display_name)+" è€å¸«",1)]),e("p",Ns,[s[19]||(s[19]=r(" æˆ¿é–“ç¢¼ï¼š",-1)),e("strong",null,o(t.room_code),1),s[20]||(s[20]=e("span",{class:"code-hint"},"ï¼ˆå¯åˆ†äº«çµ¦å…¶ä»–åŒå­¸ï¼‰",-1))])]),e("button",{class:"btn-primary btn-join",disabled:d.value,onClick:A=>z(t)},o(d.value?"åŠ å…¥ä¸­...":"ç«‹å³åŠ å…¥"),9,Bs)]))),128))]))]),s[24]||(s[24]=e("div",{class:"section-divider"},[e("span",{class:"divider-text"},"æˆ–")],-1)),e("section",Ms,[s[22]||(s[22]=e("div",{class:"section-header"},[e("h3",null,[e("span",{class:"header-icon"},"ðŸŽŸï¸"),r(" è¼¸å…¥æˆ¿é–“ç¢¼ ")])],-1)),s[23]||(s[23]=e("p",{class:"section-hint"},"å‘åŒå­¸è©¢å• 6 ä½æˆ¿é–“ç¢¼ï¼ŒåŠ å…¥ä»–å€‘çš„é¬¥è±†å ´",-1)),e("div",Us,[H(e("input",{"onUpdate:modelValue":s[3]||(s[3]=t=>k.value=t),type:"text",maxlength:"6",placeholder:"XXXXXX",class:"code-input",onKeyup:Q(U,["enter"])},null,544),[[J,k.value]]),e("button",{class:"btn-primary",disabled:d.value||!k.value.trim(),onClick:U},o(d.value?"åŠ å…¥ä¸­...":"åŠ å…¥"),9,Vs)]),v.value?(i(),n("p",Xs,o(v.value),1)):w("",!0)])])):w("",!0),f.value==="create"?(i(),n("div",Fs,[R.value?(i(),n("div",zs,[s[34]||(s[34]=e("h3",null,"å‰µå»ºä½ çš„é¬¥è±†å ´",-1)),s[35]||(s[35]=e("p",{class:"create-hint"}," é‚€è«‹åŒå­¸åŠ å…¥ï¼Œè´å–è±†å­ï¼ ",-1)),e("div",Ks,[s[29]||(s[29]=e("div",{class:"fee-label"},"å…¥å ´è²»é¸é …",-1)),e("div",Os,[(i(!0),n(X,null,F(p(ts),t=>(i(),n("span",{key:t,class:"fee-tag"},o(t===0?"å…è²»":`${t} è±†`),1))),128))])]),e("div",qs,[s[32]||(s[32]=e("div",{class:"safety-icon"},"ðŸ›¡ï¸",-1)),e("div",Ws,[s[31]||(s[31]=e("p",null,"å®‰å…¨æ©Ÿåˆ¶",-1)),e("ul",null,[e("li",null,"è³¬æˆ¶ä¿ç•™é¤˜é¡ï¼š"+o(p(os).MIN_BALANCE)+" è±†",1),s[30]||(s[30]=e("li",null,"æˆ¿é–“å–æ¶ˆè‡ªå‹•é€€æ¬¾",-1))])])]),e("button",{class:"btn-primary btn-large",onClick:V},[...s[33]||(s[33]=[e("span",{class:"btn-icon"},"âž•",-1),r(" å‰µå»ºé¬¥è±†å ´ ",-1)])])])):(i(),n("div",Ps,[s[26]||(s[26]=e("div",{class:"unlock-icon"},"ðŸ”’",-1)),s[27]||(s[27]=e("h3",null,"å‰µå»ºé¬¥è±†å ´åŠŸèƒ½æœªè§£éŽ–",-1)),e("p",null,[s[25]||(s[25]=r(" é”åˆ° ",-1)),e("strong",null,"Lv."+o(T)),r("ï¼ˆ"+o(p(P)(T).title)+"ï¼‰ å³å¯å‰µå»ºè‡ªå·±çš„é¬¥è±†å ´ ",1)]),e("div",$s,[e("div",{class:"progress-fill",style:j({width:`${Math.min(C.value/T*100,100)}%`})},null,4)]),e("p",Ds,"ç•¶å‰ï¼šLv."+o(C.value)+" / Lv."+o(T),1),s[28]||(s[28]=e("p",{class:"unlock-hint"}," ðŸ’¡ ä½ ä»å¯ä»¥é€šéŽæˆ¿é–“ç¢¼åŠ å…¥åŒå­¸çš„é¬¥è±†å ´ï¼Œæˆ–åƒèˆ‡è€å¸«ç™¼èµ·çš„ç­ç´šæ¯”è³½ ",-1))]))])):w("",!0)])]))])):(i(),n("div",bs,[s[8]||(s[8]=e("div",{class:"prompt-icon"},"ðŸ”",-1)),s[9]||(s[9]=e("h2",null,"è«‹å…ˆç™»å…¥",-1)),s[10]||(s[10]=e("p",null,"ç™»å…¥å¾Œå³å¯åƒèˆ‡é¬¥è±†å°æˆ°",-1)),e("button",{class:"btn-primary",onClick:s[0]||(s[0]=(...t)=>p(l).loginWithGoogle&&p(l).loginWithGoogle(...t))}," ä½¿ç”¨ Google ç™»å…¥ ")]))]))}}),ae=ss(Ys,[["__scopeId","data-v-1e309158"]]);export{ae as default};
