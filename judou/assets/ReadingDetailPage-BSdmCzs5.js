import{d as ne,u as re,c as M,p as oe,r as m,o as le,J as ie,K as ce,w as ue,a as d,b as a,e as _,k as de,t as h,f as p,n as B,F as R,i as F,g as he,D as fe,H as ve,j as pe,q as c,_ as ge}from"./index-CgXx50P6.js";import{u as ke}from"./readingStore-CJGjfZ6f.js";import{a as L,c as me,b as _e}from"./useClassicalTTS-CXHixeah.js";import"./useSupabase-BrN5Ovm3.js";const xe={class:"reading-detail-page"},be={class:"reading-header edamame-glass"},ye={class:"header-title"},Te={class:"title-meta"},Ce={key:0,class:"author"},Se={key:1,class:"source-tag"},we={class:"header-actions"},Be={class:"control-bar edamame-glass"},Pe=["aria-pressed"],Ae={class:"toggle-switch"},Me={key:0,class:"reading-content edamame-glass"},Re={class:"reading-line"},Ne=["onMouseenter"],ze=["onClick","disabled"],De={key:0,class:"verification-result"},Ee={class:"result-stats"},Ie={class:"stat correct"},Fe={class:"stat missed"},Le={class:"stat extra"},Ue={class:"stat accuracy"},Ve={class:"content-actions"},He=["disabled"],Oe={key:1,class:"loading-state edamame-glass"},Xe=ne({__name:"ReadingDetailPage",setup($e){const U=oe(),V=pe(),o=ke(),H=re(),N=M(()=>U.params.id),f=m(!0),x=m(new Set),l=m(null),b=m(null),y=m(!1),C=M(()=>{if(!o.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const e=o.currentText.content.split("||"),s=[],u=[],i=new Set;let n=0;for(const v of e){const r=[],g=new Set,k=n;for(const T of v)T==="|"?n>0&&(i.add(n-1),g.add(r.length-1)):T!==`
`&&T!=="\r"&&(u.push(T),r.push(T),n++);r.length>0&&s.push({chars:r,breaks:g,startIdx:k,endIdx:n-1})}return{paragraphs:s,allChars:u,allBreaks:i}}),z=M(()=>C.value.paragraphs),O=m(0);function S(t){return o.currentText?.annotations&&o.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const P=m(null);function X(t){return P.value?S(t)?.id===P.value:!1}function $(t){return S(t)?.start_index===t}function j(t){const e=S(t);return e?e.end_index-1===t:!1}function q(t,e){const s=S(t);s&&(P.value=s.id,W(s,e))}function J(){P.value=null,Z()}function K(t){if(f.value)return;const e=new Set(x.value);e.has(t)?e.delete(t):e.add(t),x.value=e,l.value=null}function Y(){const{allBreaks:t,allChars:e}=C.value;if(!e.length)return;const s=[],u=[],i=[];for(let r=0;r<e.length;r++){const g=t.has(r),k=x.value.has(r);g&&k?s.push(r):g&&!k?u.push(r):!g&&k&&i.push(r)}const n=t.size,v=n>0?s.length/n:1;l.value={correct:s,missed:u,extra:i,accuracy:v}}function G(){f.value=!0,l.value=null}function Q(){x.value=new Set,l.value=null}function W(t,e){b.value={annotation:t,x:e.clientX,y:e.clientY}}function Z(){b.value=null}function D(){const{allChars:t,allBreaks:e,paragraphs:s}=C.value;if(!t.length)return[];const u=[];for(const i of s){let n="",v=i.startIdx-1;for(let r=i.startIdx;r<=i.endIdx;r++){const g=r-i.startIdx;n+=i.chars[g];const k=e.has(r);if(r===i.endIdx)n+="ã€‚";else if(k){const I=r-v;v=r,I>=8?n+="ã€‚":I>=4?n+="ï¼Œ":n+="ã€"}}n.trim()&&u.push(n)}return u}let w=!1;function E(){w=!0,me(),y.value=!1}const A={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function ee(){if(!C.value.allChars.length)return;if(y.value){E();return}y.value=!0,w=!1;const t=D();try{for(let e=0;e<t.length&&!w;e++){const s=t[e+1];s&&L(s,A);const u=t[e];u&&await _e(u,A)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),w||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{y.value=!1,w=!1}}async function te(){if(!H.isAuthenticated){alert("è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨æ›¸ç±¤åŠŸèƒ½");return}await o.toggleBookmark(N.value)}function se(){V.push({name:"reading-list"})}function ae(t){const e=[],{allBreaks:s}=C.value;return f.value?s.has(t)&&e.push("has-break","correct"):x.value.has(t)?(e.push("has-break","user-marked"),l.value&&(l.value.correct.includes(t)?e.push("verified-correct"):l.value.extra.includes(t)&&e.push("verified-extra"))):l.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}return le(async()=>{await o.fetchTextDetail(N.value),o.currentText?.progress&&(O.value=o.currentText.progress.last_paragraph),await ie();const e=D()[0];e&&L(e,A)}),ce(()=>{E()}),ue(f,t=>{t&&(l.value=null)}),(t,e)=>(c(),d("div",xe,[a("header",be,[a("button",{class:"back-btn",onClick:se}," â† è¿”å› "),a("div",ye,[a("h1",null,h(p(o).currentText?.title||"è¼‰å…¥ä¸­..."),1),a("div",Te,[p(o).currentText?.author?(c(),d("span",Ce,h(p(o).currentText.author),1)):_("",!0),p(o).currentText?.source_text?.title?(c(),d("span",Se," Â· é¸è‡ªã€Š"+h(p(o).currentText.source_text.title)+"ã€‹ ",1)):_("",!0)])]),a("div",we,[a("button",{class:B(["action-btn bookmark-btn",{active:p(o).currentText?.progress?.bookmarked}]),onClick:te,title:"æ”¶è—"},h(p(o).currentText?.progress?.bookmarked?"â­":"â˜†"),3)])]),a("section",Be,[a("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=s=>f.value=!f.value),"aria-pressed":f.value,type:"button"},[e[2]||(e[2]=a("span",{class:"toggle-label"},"é¡¯ç¤ºæ–·å¥",-1)),a("span",Ae,[a("span",{class:B(["toggle-track",{active:f.value}])},[...e[1]||(e[1]=[a("span",{class:"toggle-thumb"},null,-1)])],2)])],8,Pe),a("button",{class:B(["tts-btn",{playing:y.value}]),onClick:ee},h(y.value?"â¹ åœæ­¢æœ—è®€":"ğŸ”Š æœ—è®€å…¨æ–‡"),3)]),p(o).currentText&&z.value.length>0?(c(),d("section",Me,[(c(!0),d(R,null,F(z.value,(s,u)=>(c(),d("div",{key:u,class:"paragraph-block"},[a("div",Re,[(c(!0),d(R,null,F(s.chars,(i,n)=>(c(),d("span",{key:n,class:"char-unit"},[a("span",{class:B(["char",{"has-annotation":S(s.startIdx+n),"annotation-hovered":X(s.startIdx+n),"annotation-start":$(s.startIdx+n),"annotation-end":j(s.startIdx+n)}]),onMouseenter:v=>q(s.startIdx+n,v),onMouseleave:J},h(i),43,Ne),n<s.chars.length-1?(c(),d("button",{key:0,class:B(["break-slot",ae(s.startIdx+n)]),onClick:v=>K(s.startIdx+n),disabled:f.value},[...e[3]||(e[3]=[a("span",{class:"break-marker"},null,-1)])],10,ze)):_("",!0)]))),128))])]))),128)),l.value?(c(),d("div",De,[a("div",Ee,[a("span",Ie,"âœ“ æ­£ç¢ºï¼š"+h(l.value.correct.length),1),a("span",Fe,"â—‹ éºæ¼ï¼š"+h(l.value.missed.length),1),a("span",Le,"âœ— å¤šé¤˜ï¼š"+h(l.value.extra.length),1),a("span",Ue," æ­£ç¢ºç‡ï¼š"+h(Math.round(l.value.accuracy*100))+"% ",1)]),a("button",{class:"show-answer-btn",onClick:G}," æŸ¥çœ‹æ­£ç¢ºç­”æ¡ˆ ")])):_("",!0),a("div",Ve,[f.value?_("",!0):(c(),d(R,{key:0},[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Q}," é‡ç½® "),a("button",{class:"edamame-btn edamame-btn-primary",onClick:Y,disabled:x.value.size===0}," âœ“ é©—è­‰æˆ‘çš„æ–·å¥ ",8,He)],64))])])):p(o).isLoading?(c(),d("section",Oe,[...e[4]||(e[4]=[a("span",{class:"loading-spinner"},null,-1),he(" è¼‰å…¥ä¸­... ",-1)])])):_("",!0),(c(),de(ve,{to:"body"},[b.value?(c(),d("div",{key:0,class:"annotation-tooltip",style:fe({left:b.value.x+"px",top:b.value.y+16+"px"})},h(b.value.annotation.annotation),5)):_("",!0)]))]))}}),Ye=ge(Xe,[["__scopeId","data-v-6dccaddd"]]);export{Ye as default};
