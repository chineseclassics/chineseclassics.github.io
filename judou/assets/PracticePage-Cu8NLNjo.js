import{d as Ce,r as c,c as g,w as we,v as xe,x as Se,a as l,b as a,e as T,t as o,y as _,n as h,z as H,A as Be,F as v,h as $,B as ne,C as Ae,o as n,_ as Ve}from"./index-7cvoT6CZ.js";import{u as ze,a as Re}from"./practiceLibraryStore-C8OS6wDb.js";import"./useSupabase-Vij_Sru7.js";const $e={class:"practice-shell"},Me={class:"picker-section edamame-glass"},Pe={class:"picker-current"},Le={class:"picker-info"},Ie={class:"picker-breadcrumb"},qe={key:0,class:"picker-meta"},Ne={key:0},Oe={key:0,class:"picker-panel"},Ue={class:"picker-search"},De={key:0,class:"picker-results"},Fe={key:0,class:"picker-empty"},Ge=["onClick"],Xe={class:"item-main"},je={class:"item-title"},Ee={class:"item-author"},He={class:"item-preview"},Qe={key:1,class:"picker-cascade"},Je={class:"cascade-row"},Ke={class:"cascade-select"},We=["value"],Ye={class:"cascade-select"},Ze=["disabled"],et={value:null,disabled:""},tt=["value"],st={class:"picker-list"},at={key:0,class:"picker-empty"},lt={key:1,class:"picker-empty"},nt=["onClick"],it={class:"item-main"},ot={class:"item-title"},ut={class:"item-author"},rt={class:"item-preview"},ct={class:"hero-actions"},dt=["disabled"],vt={class:"board-card edamame-glass"},mt={key:0,class:"practice-board"},pt={class:"board-header"},ft={class:"board-header-right"},_t={key:0,class:"timer-badge"},ht={key:0,class:"practice-line"},yt=["onClick","aria-label"],kt={key:0,class:"bean"},gt={key:1,class:"state-info"},bt={class:"board-actions"},Tt=["disabled"],Ct={key:1,class:"board-empty"},wt={class:"results-grid"},xt={class:"result-card edamame-glass"},St={class:"result-desc"},Bt={class:"result-card edamame-glass"},At={class:"result-desc"},Vt={class:"result-card edamame-glass"},zt={class:"result-desc"},Rt={class:"result-card edamame-glass"},$t={class:"result-desc"},Mt=Ce({__name:"PracticePage",setup(Pt){const C=ze(),w=Re(),d=c(null),M=c([]),x=c(new Set),m=c(new Set),u=c(null),A=c(0),y=c(null),O=c(!1),r=c(0),P=c(0),q=c(0),U=c(!1),D=c(!1),Q=g(()=>x.value.size),ie=g(()=>m.value.size),J=g(()=>Math.max(0,Q.value-ie.value)),K=g(()=>J.value>0),L=c(!1),k=c(null),S=c(null),B=c(""),oe=c(localStorage.getItem("judou_username")||"guest"),ue=c(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡");let I=null;const b=c(null);function W(){b.value||(b.value=new(window.AudioContext||window.webkitAudioContext))}function F(t){if(b.value||W(),!b.value)return;const e=b.value,s=e.createOscillator(),i=e.createGain();s.connect(i),i.connect(e.destination),t==="add"?(s.frequency.setValueAtTime(400,e.currentTime),s.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),i.gain.setValueAtTime(.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),s.start(e.currentTime),s.stop(e.currentTime+.1)):(s.frequency.setValueAtTime(300,e.currentTime),s.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),i.gain.setValueAtTime(.2,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),s.start(e.currentTime),s.stop(e.currentTime+.08))}function Y(t=10){navigator.vibrate&&navigator.vibrate(t)}const G=g(()=>w.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index)),re=g(()=>k.value?w.state.categories.filter(t=>t.level===2&&t.parent_id===k.value).sort((t,e)=>t.order_index-e.order_index):[]),Z=g(()=>S.value?C.texts.filter(t=>t.category_id===S.value).sort((t,e)=>t.title.localeCompare(e.title)):[]),ee=g(()=>{if(!B.value.trim())return[];const t=B.value.toLowerCase();return C.texts.filter(e=>e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t)).slice(0,10)}),ce=g(()=>{if(!d.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];if(d.value.category?.name){const e=w.state.categories.find(s=>s.id===d.value?.category_id);if(e?.parent_id){const s=w.state.categories.find(i=>i.id===e.parent_id);s&&t.push(s.name)}t.push(d.value.category.name)}return t.push(d.value.title),t.join(" â€º ")});we(k,()=>{S.value=null});function de(t){const e=[],s=new Set;let i=0;for(const p of t)p==="|"?i>0&&s.add(i-1):p!==`
`&&p!=="\r"&&(e.push(p),i++);return{chars:e,breaks:s}}function ve(){N(),A.value=0,I=window.setInterval(()=>{A.value+=1},1e3)}function N(){I&&(clearInterval(I),I=null)}function te(t){const{chars:e,breaks:s}=de(t.content);M.value=e,x.value=s,m.value=new Set,u.value=null,y.value=null,N(),A.value=0,r.value=0,P.value=0,q.value=0,U.value=!1}function X(t){if(d.value=t,te(t),L.value=!1,B.value="",t.category_id){const e=w.state.categories.find(s=>s.id===t.category_id);e&&(S.value=e.id,k.value=e.parent_id??null)}}function se(){const t=C.getRandomText();if(!t){y.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}X(t)}function me(){const t=[];C.texts.length||t.push(C.fetchTexts()),w.state.categories.length||t.push(w.fetchLibrary()),Promise.all(t).then(()=>{if(!d.value&&C.texts.length&&se(),!k.value&&G.value.length){const e=G.value[0];e&&(k.value=e.id)}})}function pe(t){if(u.value?.isComplete){y.value="å·²å®Œæˆï¼å¦‚è¦é‡æ–°ç·´ç¿’è«‹é»æ“Šé‡æ–°é–‹å§‹ã€‚";return}u.value&&!u.value.isComplete&&(u.value=null);const e=new Set(m.value),s=e.has(t);if(!s&&!K.value){fe(),y.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}m.value.size===0&&!I&&!U.value&&ve(),s?(e.delete(t),F("remove")):(e.add(t),F("add"),Y(10)),m.value=e,y.value=null}function fe(){D.value=!0,F("remove"),Y(50),setTimeout(()=>{D.value=!1},400)}function _e(t){if(!u.value){const e=t>0&&m.value.has(t-1),s=m.value.has(t);if(e&&s)return"translateX(0)";if(e)return"translateX(4px)";if(s)return"translateX(-4px)"}return"translateX(0)"}function he(t){const e=[],s=m.value.has(t);if(s&&e.push("has-bean"),u.value&&s){const i=u.value.statuses.find(p=>p.index===t);i&&(i.state==="correct"||i.state==="extra")&&e.push(i.state)}return e}function ye(t){return`${t} è±†`}function ae(t){return`${Math.round(t*100)}%`}function le(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function ke(t,e,s){const p=x.value.size*10,V=1/(1+.25*(s-1)),z=e/Math.max(1,M.value.length);let R=1;z<2?R=1.2:z>4&&(R=.8);const f=Math.round(p*t*V*R);return Math.max(0,f)}async function ge(){if(!d.value)return;if(!m.value.size){y.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}r.value++;const t=[];let e=0,s=0,i=0;for(let f=0;f<=M.value.length;f++){const j=m.value.has(f),E=x.value.has(f);j&&E?(t.push({index:f,state:"correct"}),e++):!j&&E?(t.push({index:f,state:"missed"}),s++):j&&!E?(t.push({index:f,state:"extra"}),i++):t.push({index:f,state:"pending"})}const p=x.value.size?e/x.value.size:m.value.size?0:1,V=s===0&&i===0;r.value===1&&(P.value=p,q.value=A.value,N(),U.value=!0);const z=q.value||A.value,R=V?ke(P.value,z,r.value):0;if(u.value={statuses:t,accuracy:p,elapsed:z,score:R,isComplete:V},V?(be(),y.value=r.value===1?"ğŸ‰ ä¸€æ¬¡éé—œï¼å¤ªå²å®³äº†ï¼":`âœ… å®Œæˆï¼å…±å˜—è©¦ ${r.value} æ¬¡`):y.value=`é‚„æœ‰ ${s} å€‹éºæ¼ã€${i} å€‹å¤šé¤˜ï¼Œè«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤`,V)try{O.value=!0,await C.recordPracticeResult({text_id:d.value.id,score:R,accuracy:P.value,elapsed_seconds:z,user_breaks:m.value.size,correct_breaks:x.value.size,username:oe.value,display_name:ue.value})}catch(f){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",f)}finally{O.value=!1}}function be(){if(b.value||W(),!b.value)return;const t=b.value,e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),s.gain.setValueAtTime(.3,t.currentTime),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function Te(){d.value&&te(d.value)}return xe(()=>{me()}),Se(()=>{N()}),(t,e)=>(n(),l("div",$e,[a("section",Me,[a("div",{class:"picker-header",onClick:e[0]||(e[0]=s=>L.value=!L.value)},[a("div",Pe,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",Le,[a("span",Ie,o(ce.value),1),d.value?(n(),l("span",qe,[_(o(d.value.author||"ä½šå")+" ",1),d.value.source?(n(),l("span",Ne," Â· "+o(d.value.source),1)):T("",!0)])):T("",!0)])]),a("button",{class:h(["picker-toggle",{expanded:L.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),L.value?(n(),l("div",Oe,[a("div",Ue,[H(a("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>B.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Be,B.value]])]),B.value.trim()?(n(),l("div",De,[ee.value.length?T("",!0):(n(),l("div",Fe," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+o(B.value)+"ã€çš„æ–‡ç«  ",1)),(n(!0),l(v,null,$(ee.value,s=>(n(),l("div",{key:s.id,class:"picker-item",onClick:i=>X(s)},[a("div",Xe,[a("span",je,o(s.title),1),a("span",Ee,o(s.author||"ä½šå"),1)]),a("span",He,o(le(s)),1)],8,Ge))),128))])):(n(),l("div",Qe,[a("div",Je,[a("div",Ke,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),H(a("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>k.value=s)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(n(!0),l(v,null,$(G.value,s=>(n(),l("option",{key:s.id,value:s.id},o(s.name),9,We))),128))],512),[[ne,k.value]])]),a("div",Ye,[e[8]||(e[8]=a("label",null,"å–®å…ƒ",-1)),H(a("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>S.value=s),disabled:!k.value},[a("option",et,o(k.value?"é¸æ“‡å–®å…ƒ":"è«‹å…ˆé¸å¹´ç´š"),1),(n(!0),l(v,null,$(re.value,s=>(n(),l("option",{key:s.id,value:s.id},o(s.name),9,tt))),128))],8,Ze),[[ne,S.value]])])]),a("div",st,[S.value?Z.value.length?T("",!0):(n(),l("div",lt," æ­¤å–®å…ƒå°šç„¡æ–‡ç«  ")):(n(),l("div",at," è«‹é¸æ“‡å¹´ç´šå’Œå–®å…ƒä»¥æŸ¥çœ‹æ–‡ç«  ")),(n(!0),l(v,null,$(Z.value,s=>(n(),l("div",{key:s.id,class:h(["picker-item",{active:d.value?.id===s.id}]),onClick:i=>X(s)},[a("div",it,[a("span",ot,o(s.title),1),a("span",ut,o(s.author||"ä½šå"),1),a("span",{class:h(["item-difficulty",`diff-${s.difficulty}`])},o(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",rt,o(le(s)),1)],10,nt))),128))])]))])):T("",!0)]),a("div",ct,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Te,disabled:!d.value}," é‡æ–°é–‹å§‹ ",8,dt),a("button",{class:"edamame-btn edamame-btn-primary",onClick:se}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",vt,[d.value?(n(),l("div",mt,[a("div",pt,[e[9]||(e[9]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",ft,[a("div",{class:h(["bean-inventory",{shake:D.value,empty:!K.value}])},[(n(!0),l(v,null,$(Q.value,s=>(n(),l("span",{key:s,class:h(["inventory-bean",{used:s>J.value}])},null,2))),128))],2),m.value.size>0||u.value?(n(),l("span",_t,"â± "+o(A.value)+" ç§’",1)):T("",!0)])]),M.value.length?(n(),l("div",ht,[(n(!0),l(v,null,$(M.value,(s,i)=>(n(),l("span",{key:i,class:"char-unit"},[a("span",{class:"char",style:Ae({transform:_e(i)})},o(s),5),a("button",{class:h(["bean-slot",he(i)]),onClick:p=>pe(i),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${m.value.has(i)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[m.value.has(i)?(n(),l("span",kt)):T("",!0),e[10]||(e[10]=a("span",{class:"bean-hint"},null,-1))],10,yt)]))),128))])):(n(),l("div",gt,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",bt,[a("button",{class:h(["edamame-btn edamame-btn-lg",u.value?.isComplete?"edamame-btn-success":"edamame-btn-primary"]),disabled:O.value||u.value?.isComplete,onClick:ge},[u.value?.isComplete?(n(),l(v,{key:0},[_(" âœ“ å®Œæˆï¼ ")],64)):r.value>0?(n(),l(v,{key:1},[_(" å†æ¬¡æäº¤ ("+o(r.value+1)+") ",1)],64)):(n(),l(v,{key:2},[_(" æäº¤ç­”æ¡ˆ ")],64))],10,Tt)]),y.value?(n(),l("p",{key:2,class:h(["toast",{success:u.value?.isComplete}])},o(y.value),3)):T("",!0)])):(n(),l("div",Ct,[...e[11]||(e[11]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",wt,[a("article",xt,[e[12]||(e[12]=a("p",{class:"result-label"},"å¾—åˆ†",-1)),a("p",{class:h(["result-value",{placeholder:!u.value?.isComplete}])},o(u.value?.isComplete?ye(u.value.score):"--"),3),a("p",St,[u.value?.isComplete&&r.value>1?(n(),l(v,{key:0},[_(" å˜—è©¦ "+o(r.value)+" æ¬¡å¾Œå®Œæˆ ",1)],64)):(n(),l(v,{key:1},[_(" å…¨å°å¾Œé¡¯ç¤ºæœ€çµ‚å¾—åˆ† ")],64))])]),a("article",Bt,[e[13]||(e[13]=a("p",{class:"result-label"},"é¦–æ¬¡æ­£ç¢ºç‡",-1)),a("p",{class:h(["result-value",{placeholder:r.value===0}])},o(r.value>0?ae(P.value):"--"),3),a("p",At,[r.value>0&&!u.value?.isComplete?(n(),l(v,{key:0},[_(" ç•¶å‰ï¼š"+o(ae(u.value?.accuracy||0)),1)],64)):(n(),l(v,{key:1},[_(" åæ˜ çœŸå¯¦æ°´å¹³ ")],64))])]),a("article",Vt,[e[14]||(e[14]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:h(["result-value",{placeholder:r.value===0}])},o(r.value>0?`${q.value} ç§’`:"--"),3),a("p",zt,[r.value>0?(n(),l(v,{key:0},[_(" é¦–æ¬¡æäº¤æ™‚è¨˜éŒ„ ")],64)):(n(),l(v,{key:1},[_(" è¨ˆæ™‚è‡³é¦–æ¬¡æäº¤ ")],64))])]),a("article",Rt,[e[15]||(e[15]=a("p",{class:"result-label"},"å˜—è©¦æ¬¡æ•¸",-1)),a("p",{class:h(["result-value",{placeholder:r.value===0}])},o(r.value>0?r.value:"--"),3),a("p",$t,[u.value?.isComplete?(n(),l(v,{key:0},[_(o(r.value===1?"ä¸€æ¬¡éé—œï¼":"å …æŒå°±æ˜¯å‹åˆ©"),1)],64)):(n(),l(v,{key:1},[_(" å¯å¤šæ¬¡å˜—è©¦ç›´åˆ°å…¨å° ")],64))])])])]))}}),Nt=Ve(Mt,[["__scopeId","data-v-2e1e8144"]]);export{Nt as default};
