const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CIX_kLsE.js","assets/index-C-iCoOw5.css"])))=>i.map(i=>d[i]);
import{d as ve,c as i,x as me,r as g,w as he,f as fe,P as pe,a as o,g as n,F as b,h as k,b as w,t as m,s as W,j as q,l as _e,Q as Te,o as r,_ as ge}from"./index-CIX_kLsE.js";import{u as ke}from"./gameStore-CTnREIPO.js";import"./userStatsStore-CdMzW9js.js";import"./game-pGsr7gx9.js";const ye={class:"game-play"},be={key:0,class:"loading-container"},we={class:"play-header"},xe={class:"header-left"},Be={class:"countdown-time"},Se={class:"header-center"},Ce={class:"text-title"},Ae={key:0,class:"text-author"},Ie={class:"header-right"},Re=["disabled"],Ve={key:0,class:"text-tabs"},ze=["onClick"],Ge={class:"tab-number"},Pe={class:"tab-title"},Me={key:0,class:"tab-check"},$e={class:"play-main"},De={class:"board-header"},Ee={class:"board-header-right"},Ne={class:"practice-board"},qe={key:0,class:"practice-line"},Le={class:"char"},Oe=["onClick","aria-label"],Ue={key:0,class:"bean"},Fe={class:"progress-hint"},He={key:0,class:"text-nav"},Ke=["disabled"],je={class:"nav-info"},Je=["disabled"],Qe={class:"play-footer"},We={key:0,class:"footer-hint submitted"},Xe={key:1,class:"footer-hint"},Ye=3e3,Ze=6e4,et=ve({__name:"GamePlay",setup(tt){const B=_e(),X=me(),_=ke(),f=i(()=>X.params.roomId),u=i(()=>_.currentRoom),l=g([]),c=g(new Map),d=g(0),v=i(()=>l.value[d.value]),z=i(()=>v.value&&c.value.get(v.value.id)||null),G=i(()=>z.value?.characters||[]),L=i(()=>z.value?.correctBreaks||new Set),x=i({get:()=>z.value?.userBreaks||new Set,set:a=>{if(v.value&&c.value.has(v.value.id)){const e=c.value.get(v.value.id);e.userBreaks=a}}}),S=g(0);let P=null;const O=i(()=>L.value.size),Y=i(()=>x.value.size),U=i(()=>Math.max(0,O.value-Y.value)),Z=i(()=>U.value>0),M=g(!1),p=g(!1),F=g(!0);let H=0,C=null,A=null;function ee(a){const e=[],t=new Set;let s=0;const h=a.replace(/[\|\s]+$/,"");for(const T of h)T==="|"?s>0&&t.add(s-1):T!==`
`&&T!=="\r"&&(e.push(T),s++);return{chars:e,breaks:t}}function te(){c.value.clear();for(const a of l.value){const e=ee(a.content);c.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Set})}}function ae(a){a>=0&&a<l.value.length&&(d.value=a)}function se(){d.value>0&&d.value--}function ne(){d.value<l.value.length-1&&d.value++}let $=null;function D(a){try{$||($=new AudioContext);const e=$,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function E(a=10){navigator.vibrate&&navigator.vibrate(a)}function oe(a){if(p.value||!v.value)return;const e=c.value.get(v.value.id);if(!e)return;const t=new Set(e.userBreaks),s=t.has(a);if(!s&&t.size>=e.correctBreaks.size){D("error"),M.value=!0,setTimeout(()=>{M.value=!1},300),E(50);return}s?(t.delete(a),D("remove"),E(5)):(t.add(a),D("add"),E(10)),e.userBreaks=t,c.value=new Map(c.value)}function re(a){return{"has-bean":x.value.has(a)}}function I(a){const e=c.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(h=>e.userBreaks.has(h))?"complete":"partial"}async function K(){if(p.value)return;p.value=!0;const a=Math.round((Date.now()-H)/1e3);let e=0,t=0;const s=[];for(const T of l.value){const N=c.value.get(T.id);if(!N)continue;const R=N.correctBreaks,J=N.userBreaks;let V=0,Q=0;for(const de of J)R.has(de)?V++:Q++;const ce=R.size-V;e+=V,t+=R.size,s.push({textId:T.id,userBreaks:[...J],correctBreaks:[...R],correctCount:V,wrongCount:Q,missedCount:ce})}const h=t>0?e/t*100:0;sessionStorage.setItem(`game-result-${f.value}`,JSON.stringify({texts:l.value,results:s,totalCorrect:e,totalBreaks:t,accuracy:h,timeSpent:a})),await _.submitScore({roomId:f.value,score:e,accuracy:h,timeSpent:a,firstAccuracy:h,attemptCount:1}),le()}function le(){console.log("[GamePlay] 啟動備用狀態檢查機制"),y(),C=setInterval(async()=>{await j()},Ye),A=setTimeout(()=>{console.log("[GamePlay] 狀態檢查超時，強制跳轉到結果頁"),y(),B.push({name:"arena-result",params:{roomId:f.value}})},Ze),j()}function y(){C&&(clearInterval(C),C=null),A&&(clearTimeout(A),A=null)}async function j(){if(_.currentRoom){if(_.currentRoom.status==="finished"){console.log("[GamePlay] 本地狀態為 finished，跳轉到結果頁"),y(),B.push({name:"arena-result",params:{roomId:f.value}});return}try{const{supabase:a}=await Te(async()=>{const{supabase:t}=await import("./index-CIX_kLsE.js").then(s=>s.R);return{supabase:t}},__vite__mapDeps([0,1]));if(!a)return;const{data:e}=await a.from("game_rooms").select("status").eq("id",f.value).single();e?.status==="finished"?(console.log("[GamePlay] 數據庫狀態為 finished，跳轉到結果頁"),y(),B.push({name:"arena-result",params:{roomId:f.value}})):console.log("[GamePlay] 狀態檢查: 當前狀態為",e?.status)}catch(a){console.error("[GamePlay] 狀態檢查錯誤:",a)}}}function ie(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function ue(){if(!u.value?.started_at||!u.value?.time_limit)return;const a=()=>{const e=new Date(u.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);S.value=Math.max(0,u.value.time_limit-t),S.value===0&&!p.value&&K()};a(),P=setInterval(a,1e3)}return he(()=>u.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),y(),B.push({name:"arena-result",params:{roomId:f.value}}))}),fe(async()=>{_.subscribeToRoom(f.value),u.value?.text_ids&&u.value.text_ids.length>0?l.value=await _.fetchTexts(u.value.text_ids):u.value?.text_id&&(l.value=await _.fetchTexts([u.value.text_id])),F.value=!1,l.value.length>0&&(te(),H=Date.now(),ue())}),pe(()=>{P&&clearInterval(P),y()}),(a,e)=>(r(),o("div",ye,[F.value?(r(),o("div",be,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(r(),o(b,{key:1},[n("header",we,[n("div",xe,[n("div",{class:w(["countdown",{warning:S.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",Be,m(ie(S.value)),1)],2)]),n("div",Se,[n("span",Ce,m(v.value?.title),1),v.value?.author?(r(),o("span",Ae,m(v.value.author),1)):k("",!0)]),n("div",Ie,[n("button",{class:w(["submit-btn",{waiting:p.value}]),disabled:p.value,onClick:K},[p.value?(r(),o(b,{key:0},[e[2]||(e[2]=n("span",{class:"waiting-spinner"},"⏳",-1)),e[3]||(e[3]=W(" 等待其他玩家... ",-1))],64)):(r(),o(b,{key:1},[W(" 提交答案 ")],64))],10,Re)])]),l.value.length>1?(r(),o("div",Ve,[(r(!0),o(b,null,q(l.value,(t,s)=>(r(),o("button",{key:t.id,class:w(["text-tab",{active:s===d.value,empty:I(t.id)==="empty",partial:I(t.id)==="partial",complete:I(t.id)==="complete"}]),onClick:h=>ae(s)},[n("span",Ge,m(s+1),1),n("span",Pe,m(t.title),1),I(t.id)==="complete"?(r(),o("span",Me,"✓")):k("",!0)],10,ze))),128))])):k("",!0),n("main",$e,[n("div",De,[e[4]||(e[4]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",Ee,[n("div",{class:w(["bean-inventory",{shake:M.value,empty:!Z.value}])},[(r(!0),o(b,null,q(O.value,t=>(r(),o("span",{key:t,class:w(["inventory-bean",{used:t>U.value}])},null,2))),128))],2)])]),n("div",Ne,[G.value.length?(r(),o("div",qe,[(r(!0),o(b,null,q(G.value,(t,s)=>(r(),o("span",{key:s,class:"char-unit"},[n("span",Le,m(t),1),s<G.value.length-1?(r(),o("button",{key:0,class:w(["bean-slot",re(s)]),onClick:h=>oe(s),"aria-label":`在「${t}」後${x.value.has(s)?"移除":"添加"}斷句`},[x.value.has(s)?(r(),o("span",Ue)):k("",!0),e[5]||(e[5]=n("span",{class:"bean-hint"},null,-1))],10,Oe)):k("",!0)]))),128))])):k("",!0)]),n("div",Fe,[n("span",null,"已標記 "+m(x.value.size)+" / "+m(L.value.size)+" 處",1)]),l.value.length>1?(r(),o("div",He,[n("button",{class:"nav-btn",disabled:d.value===0,onClick:se}," ← 上一篇 ",8,Ke),n("span",je,m(d.value+1)+" / "+m(l.value.length),1),n("button",{class:"nav-btn",disabled:d.value===l.value.length-1,onClick:ne}," 下一篇 → ",8,Je)])):k("",!0)]),n("footer",Qe,[p.value?(r(),o("p",We," ✅ 已提交答案，等待其他玩家完成或時間結束... ")):(r(),o("p",Xe," 完成所有文章後點擊「提交答案」，或等待時間結束自動提交 "))])],64))]))}}),rt=ge(et,[["__scopeId","data-v-8764d9ac"]]);export{rt as default};
