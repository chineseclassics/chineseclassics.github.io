import{d as Be,u as Ve,c as y,p as Re,r as c,w as ze,o as Ie,y as $e,a as l,b as a,e as C,t as o,l as h,n as _,z as Q,A as qe,F as v,h as $,B as ue,C as Me,q as n,_ as Pe}from"./index-wDlN-ORn.js";import{u as Le}from"./textsStore-qqR-RypY.js";import{u as Ne}from"./practiceLibraryStore-jvIh4l7-.js";import{u as Oe}from"./assignmentStore-CkdRn5EB.js";import"./useSupabase-CLCLn3iy.js";const Ue={class:"practice-shell"},De={class:"picker-section edamame-glass"},Fe={class:"picker-current"},Ge={class:"picker-info"},Xe={class:"picker-breadcrumb"},je={key:0,class:"picker-meta"},Ee={key:0},He={key:0,class:"picker-panel"},Qe={class:"picker-search"},Je={key:0,class:"picker-results"},Ke={key:0,class:"picker-empty"},We=["onClick"],Ye={class:"item-main"},Ze={class:"item-title"},et={class:"item-author"},tt={class:"item-preview"},st={key:1,class:"picker-cascade"},at={class:"cascade-row"},lt={class:"cascade-select"},nt=["value"],it={class:"cascade-select"},ot=["disabled"],ut={value:null,disabled:""},rt=["value"],ct={class:"picker-list"},dt={key:0,class:"picker-empty"},vt={key:1,class:"picker-empty"},mt=["onClick"],pt={class:"item-main"},ft={class:"item-title"},ht={class:"item-author"},_t={class:"item-preview"},yt={class:"hero-actions"},kt=["disabled"],gt={class:"board-card edamame-glass"},bt={key:0,class:"practice-board"},Tt={class:"board-header"},Ct={class:"board-header-right"},wt={key:0,class:"timer-badge"},xt={key:0,class:"practice-line"},St=["onClick","aria-label"],At={key:0,class:"bean"},Bt={key:1,class:"state-info"},Vt={class:"board-actions"},Rt=["disabled"],zt={key:1,class:"board-empty"},It={class:"results-grid"},$t={class:"result-card edamame-glass"},qt={class:"result-desc"},Mt={class:"result-card edamame-glass"},Pt={class:"result-desc"},Lt={class:"result-card edamame-glass"},Nt={class:"result-desc"},Ot={class:"result-card edamame-glass"},Ut={class:"result-desc"},Dt=Be({__name:"PracticePage",setup(Ft){const J=Re(),b=Le(),w=Ne(),re=Oe(),ce=Ve(),U=y(()=>J.query.assignmentId),K=y(()=>J.query.textId),d=c(null),q=c([]),x=c(new Set),m=c(new Set),u=c(null),V=c(0),k=c(null),D=c(!1),r=c(0),R=c(0),L=c(0),F=c(!1),G=c(!1),W=y(()=>x.value.size),de=y(()=>m.value.size),Y=y(()=>Math.max(0,W.value-de.value)),Z=y(()=>Y.value>0),M=c(!1),g=c(null),S=c(null),A=c(""),ve=c(localStorage.getItem("judou_username")||"guest"),me=c(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡");let P=null;const T=c(null);function ee(){T.value||(T.value=new(window.AudioContext||window.webkitAudioContext))}function X(s){if(T.value||ee(),!T.value)return;const e=T.value,t=e.createOscillator(),i=e.createGain();t.connect(i),i.connect(e.destination),s==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),i.gain.setValueAtTime(.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),i.gain.setValueAtTime(.2,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08))}function te(s=10){navigator.vibrate&&navigator.vibrate(s)}const j=y(()=>w.state.categories.filter(s=>s.level===1).sort((s,e)=>s.order_index-e.order_index)),pe=y(()=>g.value?w.state.categories.filter(s=>s.level===2&&s.parent_id===g.value).sort((s,e)=>s.order_index-e.order_index):[]),se=y(()=>S.value?b.texts.filter(s=>s.category_id===S.value).sort((s,e)=>s.title.localeCompare(e.title)):[]),ae=y(()=>{if(!A.value.trim())return[];const s=A.value.toLowerCase();return b.texts.filter(e=>e.title.toLowerCase().includes(s)||e.author&&e.author.toLowerCase().includes(s)||e.source&&e.source.toLowerCase().includes(s)).slice(0,10)}),fe=y(()=>{if(!d.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const s=[];if(d.value.category?.name){const e=w.state.categories.find(t=>t.id===d.value?.category_id);if(e?.parent_id){const t=w.state.categories.find(i=>i.id===e.parent_id);t&&s.push(t.name)}s.push(d.value.category.name)}return s.push(d.value.title),s.join(" â€º ")});ze(g,()=>{S.value=null});function he(s){const e=[],t=new Set;let i=0;for(const f of s)f==="|"?i>0&&t.add(i-1):f!==`
`&&f!=="\r"&&(e.push(f),i++);return{chars:e,breaks:t}}function _e(){N(),V.value=0,P=window.setInterval(()=>{V.value+=1},1e3)}function N(){P&&(clearInterval(P),P=null)}function le(s){const{chars:e,breaks:t}=he(s.content);q.value=e,x.value=t,m.value=new Set,u.value=null,k.value=null,N(),V.value=0,r.value=0,R.value=0,L.value=0,F.value=!1}function O(s){if(d.value=s,le(s),M.value=!1,A.value="",s.category_id){const e=w.state.categories.find(t=>t.id===s.category_id);e&&(S.value=e.id,g.value=e.parent_id??null)}}function ne(){const s=b.getRandomText();if(!s){k.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}O(s)}async function ye(){const s=[];if(b.texts.length||s.push(b.fetchTexts()),w.state.categories.length||s.push(w.fetchLibrary()),await Promise.all(s),K.value&&U.value){const e=b.texts.find(t=>t.id===K.value);if(e){O(e);return}}if(!d.value&&b.texts.length&&ne(),!g.value&&j.value.length){const e=j.value[0];e&&(g.value=e.id)}}function ke(s){if(u.value?.isComplete){k.value="å·²å®Œæˆï¼å¦‚è¦é‡æ–°ç·´ç¿’è«‹é»æ“Šé‡æ–°é–‹å§‹ã€‚";return}u.value&&!u.value.isComplete&&(u.value=null);const e=new Set(m.value),t=e.has(s);if(!t&&!Z.value){ge(),k.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}m.value.size===0&&!P&&!F.value&&_e(),t?(e.delete(s),X("remove")):(e.add(s),X("add"),te(10)),m.value=e,k.value=null}function ge(){G.value=!0,X("remove"),te(50),setTimeout(()=>{G.value=!1},400)}function be(s){if(!u.value){const e=s>0&&m.value.has(s-1),t=m.value.has(s);if(e&&t)return"translateX(0)";if(e)return"translateX(4px)";if(t)return"translateX(-4px)"}return"translateX(0)"}function Te(s){const e=[],t=m.value.has(s);if(t&&e.push("has-bean"),u.value&&t){const i=u.value.statuses.find(f=>f.index===s);i&&(i.state==="correct"||i.state==="extra")&&e.push(i.state)}return e}function Ce(s){return`${s} è±†`}function ie(s){return`${Math.round(s*100)}%`}function oe(s){return s.content.replace(/\|/g,"").slice(0,30)+"..."}function we(s,e,t){const f=x.value.size*10,z=1/(1+.25*(t-1)),I=e/Math.max(1,q.value.length);let B=1;I<2?B=1.2:I>4&&(B=.8);const p=Math.round(f*s*z*B);return Math.max(0,p)}async function xe(){if(!d.value)return;if(!m.value.size){k.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}r.value++;const s=[];let e=0,t=0,i=0;for(let p=0;p<=q.value.length;p++){const E=m.value.has(p),H=x.value.has(p);E&&H?(s.push({index:p,state:"correct"}),e++):!E&&H?(s.push({index:p,state:"missed"}),t++):E&&!H?(s.push({index:p,state:"extra"}),i++):s.push({index:p,state:"pending"})}const f=x.value.size?e/x.value.size:m.value.size?0:1,z=t===0&&i===0;r.value===1&&(R.value=f,L.value=V.value,N(),F.value=!0);const I=L.value||V.value,B=z?we(R.value,I,r.value):0;if(u.value={statuses:s,accuracy:f,elapsed:I,score:B,isComplete:z},z?(Se(),k.value=r.value===1?"ğŸ‰ ä¸€æ¬¡éé—œï¼å¤ªå²å®³äº†ï¼":`âœ… å®Œæˆï¼å…±å˜—è©¦ ${r.value} æ¬¡`):k.value=`é‚„æœ‰ ${t} å€‹éºæ¼ã€${i} å€‹å¤šé¤˜ï¼Œè«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤`,z)try{D.value=!0;const p=await b.recordPracticeResult({text_id:d.value.id,score:B,accuracy:R.value,elapsed_seconds:I,user_breaks:m.value.size,correct_breaks:x.value.size,username:ve.value,display_name:me.value});U.value&&ce.isAuthenticated&&p&&await re.recordCompletion(U.value,p,B,R.value*100)}catch(p){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",p)}finally{D.value=!1}}function Se(){if(T.value||ee(),!T.value)return;const s=T.value,e=s.createOscillator(),t=s.createGain();e.connect(t),t.connect(s.destination),e.frequency.setValueAtTime(400,s.currentTime),e.frequency.exponentialRampToValueAtTime(600,s.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,s.currentTime+.2),t.gain.setValueAtTime(.3,s.currentTime),t.gain.exponentialRampToValueAtTime(.01,s.currentTime+.3),e.start(s.currentTime),e.stop(s.currentTime+.3)}function Ae(){d.value&&le(d.value)}return Ie(()=>{ye()}),$e(()=>{N()}),(s,e)=>(n(),l("div",Ue,[a("section",De,[a("div",{class:"picker-header",onClick:e[0]||(e[0]=t=>M.value=!M.value)},[a("div",Fe,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",Ge,[a("span",Xe,o(fe.value),1),d.value?(n(),l("span",je,[h(o(d.value.author||"ä½šå")+" ",1),d.value.source?(n(),l("span",Ee," Â· "+o(d.value.source),1)):C("",!0)])):C("",!0)])]),a("button",{class:_(["picker-toggle",{expanded:M.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),M.value?(n(),l("div",He,[a("div",Qe,[Q(a("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>A.value=t),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[qe,A.value]])]),A.value.trim()?(n(),l("div",Je,[ae.value.length?C("",!0):(n(),l("div",Ke," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+o(A.value)+"ã€çš„æ–‡ç«  ",1)),(n(!0),l(v,null,$(ae.value,t=>(n(),l("div",{key:t.id,class:"picker-item",onClick:i=>O(t)},[a("div",Ye,[a("span",Ze,o(t.title),1),a("span",et,o(t.author||"ä½šå"),1)]),a("span",tt,o(oe(t)),1)],8,We))),128))])):(n(),l("div",st,[a("div",at,[a("div",lt,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),Q(a("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>g.value=t)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(n(!0),l(v,null,$(j.value,t=>(n(),l("option",{key:t.id,value:t.id},o(t.name),9,nt))),128))],512),[[ue,g.value]])]),a("div",it,[e[8]||(e[8]=a("label",null,"å–®å…ƒ",-1)),Q(a("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>S.value=t),disabled:!g.value},[a("option",ut,o(g.value?"é¸æ“‡å–®å…ƒ":"è«‹å…ˆé¸å¹´ç´š"),1),(n(!0),l(v,null,$(pe.value,t=>(n(),l("option",{key:t.id,value:t.id},o(t.name),9,rt))),128))],8,ot),[[ue,S.value]])])]),a("div",ct,[S.value?se.value.length?C("",!0):(n(),l("div",vt," æ­¤å–®å…ƒå°šç„¡æ–‡ç«  ")):(n(),l("div",dt," è«‹é¸æ“‡å¹´ç´šå’Œå–®å…ƒä»¥æŸ¥çœ‹æ–‡ç«  ")),(n(!0),l(v,null,$(se.value,t=>(n(),l("div",{key:t.id,class:_(["picker-item",{active:d.value?.id===t.id}]),onClick:i=>O(t)},[a("div",pt,[a("span",ft,o(t.title),1),a("span",ht,o(t.author||"ä½šå"),1),a("span",{class:_(["item-difficulty",`diff-${t.difficulty}`])},o(t.difficulty===1?"åˆç´š":t.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",_t,o(oe(t)),1)],10,mt))),128))])]))])):C("",!0)]),a("div",yt,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Ae,disabled:!d.value}," é‡æ–°é–‹å§‹ ",8,kt),a("button",{class:"edamame-btn edamame-btn-primary",onClick:ne}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",gt,[d.value?(n(),l("div",bt,[a("div",Tt,[e[9]||(e[9]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Ct,[a("div",{class:_(["bean-inventory",{shake:G.value,empty:!Z.value}])},[(n(!0),l(v,null,$(W.value,t=>(n(),l("span",{key:t,class:_(["inventory-bean",{used:t>Y.value}])},null,2))),128))],2),m.value.size>0||u.value?(n(),l("span",wt,"â± "+o(V.value)+" ç§’",1)):C("",!0)])]),q.value.length?(n(),l("div",xt,[(n(!0),l(v,null,$(q.value,(t,i)=>(n(),l("span",{key:i,class:"char-unit"},[a("span",{class:"char",style:Me({transform:be(i)})},o(t),5),a("button",{class:_(["bean-slot",Te(i)]),onClick:f=>ke(i),"aria-label":`åœ¨ã€Œ${t}ã€å¾Œ${m.value.has(i)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[m.value.has(i)?(n(),l("span",At)):C("",!0),e[10]||(e[10]=a("span",{class:"bean-hint"},null,-1))],10,St)]))),128))])):(n(),l("div",Bt,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",Vt,[a("button",{class:_(["edamame-btn edamame-btn-lg",u.value?.isComplete?"edamame-btn-success":"edamame-btn-primary"]),disabled:D.value||u.value?.isComplete,onClick:xe},[u.value?.isComplete?(n(),l(v,{key:0},[h(" âœ“ å®Œæˆï¼ ")],64)):r.value>0?(n(),l(v,{key:1},[h(" å†æ¬¡æäº¤ ("+o(r.value+1)+") ",1)],64)):(n(),l(v,{key:2},[h(" æäº¤ç­”æ¡ˆ ")],64))],10,Rt)]),k.value?(n(),l("p",{key:2,class:_(["toast",{success:u.value?.isComplete}])},o(k.value),3)):C("",!0)])):(n(),l("div",zt,[...e[11]||(e[11]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",It,[a("article",$t,[e[12]||(e[12]=a("p",{class:"result-label"},"å¾—åˆ†",-1)),a("p",{class:_(["result-value",{placeholder:!u.value?.isComplete}])},o(u.value?.isComplete?Ce(u.value.score):"--"),3),a("p",qt,[u.value?.isComplete&&r.value>1?(n(),l(v,{key:0},[h(" å˜—è©¦ "+o(r.value)+" æ¬¡å¾Œå®Œæˆ ",1)],64)):(n(),l(v,{key:1},[h(" å…¨å°å¾Œé¡¯ç¤ºæœ€çµ‚å¾—åˆ† ")],64))])]),a("article",Mt,[e[13]||(e[13]=a("p",{class:"result-label"},"é¦–æ¬¡æ­£ç¢ºç‡",-1)),a("p",{class:_(["result-value",{placeholder:r.value===0}])},o(r.value>0?ie(R.value):"--"),3),a("p",Pt,[r.value>0&&!u.value?.isComplete?(n(),l(v,{key:0},[h(" ç•¶å‰ï¼š"+o(ie(u.value?.accuracy||0)),1)],64)):(n(),l(v,{key:1},[h(" åæ˜ çœŸå¯¦æ°´å¹³ ")],64))])]),a("article",Lt,[e[14]||(e[14]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:_(["result-value",{placeholder:r.value===0}])},o(r.value>0?`${L.value} ç§’`:"--"),3),a("p",Nt,[r.value>0?(n(),l(v,{key:0},[h(" é¦–æ¬¡æäº¤æ™‚è¨˜éŒ„ ")],64)):(n(),l(v,{key:1},[h(" è¨ˆæ™‚è‡³é¦–æ¬¡æäº¤ ")],64))])]),a("article",Ot,[e[15]||(e[15]=a("p",{class:"result-label"},"å˜—è©¦æ¬¡æ•¸",-1)),a("p",{class:_(["result-value",{placeholder:r.value===0}])},o(r.value>0?r.value:"--"),3),a("p",Ut,[u.value?.isComplete?(n(),l(v,{key:0},[h(o(r.value===1?"ä¸€æ¬¡éé—œï¼":"å …æŒå°±æ˜¯å‹åˆ©"),1)],64)):(n(),l(v,{key:1},[h(" å¯å¤šæ¬¡å˜—è©¦ç›´åˆ°å…¨å° ")],64))])])])]))}}),Qt=Pe(Dt,[["__scopeId","data-v-c668a079"]]);export{Qt as default};
