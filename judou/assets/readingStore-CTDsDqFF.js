import{y as G,u as H,r as x,c as J}from"./index-B9hnaWYt.js";import{u as K}from"./useSupabase-BojV4aAp.js";const V=G("reading",()=>{const i=K(),n=H(),u=x([]),c=x(null),_=x([]),p=x(!1),g=x(null),v=J(()=>u.value.filter(e=>e.progress?.bookmarked));async function E(){if(!i){g.value="Supabase å°šæœªé…ç½®";return}p.value=!0,g.value=null;try{const{data:e,error:r}=await i.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("text_type","reading").order("created_at",{ascending:!1});if(r)throw r;let a=new Map;if(n.isAuthenticated&&n.user?.id){const{data:t}=await i.from("reading_progress").select("*").eq("user_id",n.user.id);t&&t.forEach(o=>{a.set(o.text_id,o)})}u.value=(e||[]).map(t=>{const o=t.text_reading_categories?.map(s=>s.category).filter(Boolean)||[];return{...t,reading_categories:o,text_reading_categories:void 0,progress:a.get(t.id)||null}})}catch(e){g.value=e.message??"ç„¡æ³•è¼‰å…¥é–±è®€æ–‡ç« "}finally{p.value=!1}}async function S(e){if(!i)return g.value="Supabase å°šæœªé…ç½®",null;p.value=!0,g.value=null;try{const{data:r,error:a}=await i.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("id",e).single();if(a)throw a;const{data:t}=await i.from("text_annotations").select("*").eq("text_id",e).order("start_index",{ascending:!0});let o=null;if(n.isAuthenticated&&n.user?.id){const{data:d}=await i.from("reading_progress").select("*").eq("text_id",e).eq("user_id",n.user.id).maybeSingle();o=d||null}const s=r.text_reading_categories?.map(d=>d.category).filter(Boolean)||[];return c.value={...r,reading_categories:s,text_reading_categories:void 0,annotations:t||[],progress:o},c.value}catch(r){return g.value=r.message??"ç„¡æ³•è¼‰å…¥æ–‡ç« è©³æƒ…",null}finally{p.value=!1}}async function b(e,r,a){if(!(!i||!n.isAuthenticated||!n.user?.id))try{const{data:t,error:o}=await i.from("reading_progress").upsert({user_id:n.user.id,text_id:e,progress_percent:r,last_paragraph:a,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(o)throw o;c.value?.id===e&&(c.value.progress=t);const s=u.value.findIndex(l=>l.id===e),d=u.value[s];s!==-1&&t&&d&&(d.progress=t)}catch(t){console.error("æ›´æ–°é–±è®€é€²åº¦å¤±æ•—:",t)}}async function q(e){if(!i||!n.isAuthenticated||!n.user?.id)return;const a=(u.value.find(t=>t.id===e)||c.value)?.progress?.bookmarked??!1;try{const{data:t,error:o}=await i.from("reading_progress").upsert({user_id:n.user.id,text_id:e,bookmarked:!a,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(o)throw o;c.value?.id===e&&(c.value.progress=t);const s=u.value.findIndex(l=>l.id===e),d=u.value[s];return s!==-1&&t&&d&&(d.progress=t),t?.bookmarked}catch(t){return console.error("åˆ‡æ›æ›¸ç±¤å¤±æ•—:",t),null}}async function A(e){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");if(!n.isTeacher&&!n.isAdmin)throw new Error("åªæœ‰è€å¸«æˆ–ç®¡ç†å“¡å¯ä»¥æ·»åŠ è¨»é‡‹");const{data:r,error:a}=await i.from("text_annotations").insert({...e,created_by:n.user.id}).select().single();if(a)throw a;return c.value?.id===e.text_id&&r&&(c.value.annotations=[...c.value.annotations||[],r].sort((t,o)=>t.start_index-o.start_index)),r}async function T(e,r,a){if(!i)throw new Error("Supabase å°šæœªé…ç½®");const t={annotation:r};a!==void 0&&(t.pinyin=a||null);const{data:o,error:s}=await i.from("text_annotations").update(t).eq("id",e).select().single();if(s)throw s;if(c.value?.annotations){const d=c.value.annotations.findIndex(l=>l.id===e);d!==-1&&(c.value.annotations[d]=o)}return o}async function k(e){if(!i)throw new Error("Supabase å°šæœªé…ç½®");const{error:r}=await i.from("text_annotations").delete().eq("id",e);if(r)throw r;c.value?.annotations&&(c.value.annotations=c.value.annotations.filter(a=>a.id!==e))}async function D(e,r=!1){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");const{data:a,error:t}=await i.from("practice_texts").insert({title:e.title,author:e.author??null,source:e.source??null,summary:e.summary??null,category_id:e.category_id||null,content:e.content,text_type:"reading",source_text_id:e.source_text_id||null,source_start_index:e.source_start_index??null,source_end_index:e.source_end_index??null,is_system:r,created_by:r?null:n.user.id}).select("*").single();if(t)throw t;const o=e.reading_category_ids||[];if(a&&o.length>0){const{error:d}=await i.from("text_reading_categories").insert(o.map(l=>({text_id:a.id,category_id:l})));d&&console.error("é—œè¯æ–‡é›†å¤±æ•—:",d)}const s=o.length>0?_.value.filter(d=>o.includes(d.id)):[];return a&&u.value.unshift({...a,reading_categories:s,progress:null,annotations:[]}),a}async function R(e,r,a,t,o){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");const s=u.value.find(f=>f.id===e)||c.value,{data:d,error:l}=await i.from("practice_texts").insert({title:o.title,author:s?.author??null,source:s?.source??null,category_id:o.category_id||null,content:t,difficulty:o.difficulty||2,text_type:"practice",source_text_id:e,source_start_index:r,source_end_index:a,is_system:!0,created_by:null}).select().single();if(l)throw l;return d}function C(){c.value=null}let m=null;function O(){m=Date.now()}async function h(e,r=0,a=!1){if(!i||!n.isAuthenticated||!n.user?.id)return;const t=m?Math.floor((Date.now()-m)/1e3):0;if(m=null,!(t<3))try{const{error:o}=await i.from("reading_records").upsert({user_id:n.user.id,text_id:e,progress:Math.max(r,0),is_completed:a,read_duration:t,read_count:1,last_read_at:new Date().toISOString()},{onConflict:"user_id,text_id",ignoreDuplicates:!1});if(o){if(o.code==="42P01"){console.log("é–±è®€è¨˜éŒ„è¡¨å°šæœªå‰µå»º");return}const{error:s}=await i.rpc("update_reading_record",{p_user_id:n.user.id,p_text_id:e,p_duration:t,p_progress:r,p_completed:a});if(s){const{data:d}=await i.from("reading_records").select("id, read_duration, read_count, progress, is_completed").eq("user_id",n.user.id).eq("text_id",e).maybeSingle();d&&await i.from("reading_records").update({read_duration:d.read_duration+t,read_count:d.read_count+1,progress:Math.max(d.progress,r),is_completed:d.is_completed||a,last_read_at:new Date().toISOString(),completed_at:a&&!d.is_completed?new Date().toISOString():void 0}).eq("id",d.id)}}console.log(`ðŸ“– è¨˜éŒ„é–±è®€ï¼š${t} ç§’ï¼Œé€²åº¦ ${r}%`)}catch(o){console.error("ä¿å­˜é–±è®€è¨˜éŒ„å¤±æ•—:",o)}}async function M(e){await h(e,100,!0)}async function B(e){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤é–±è®€æ–‡ç« ");const{data:r}=await i.from("practice_texts").select("is_system, created_by, text_type").eq("id",e).single();if(r){if(r.text_type!=="reading")throw new Error("åªèƒ½åˆªé™¤é–±è®€æ–‡ç« ");if(r.is_system&&!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤ç³»çµ±æ–‡ç« ");if(!r.is_system&&r.created_by!==n.user.id)throw new Error("åªèƒ½åˆªé™¤è‡ªå·±å‰µå»ºçš„æ–‡ç« ")}const{error:a}=await i.from("practice_texts").delete().eq("id",e);if(a)throw a;u.value=u.value.filter(t=>t.id!==e),c.value?.id===e&&(c.value=null)}async function P(e,r){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°é–±è®€æ–‡ç« ");const{data:a}=await i.from("practice_texts").select("is_system, created_by, text_type").eq("id",e).single();if(a){if(a.text_type!=="reading")throw new Error("åªèƒ½æ›´æ–°é–±è®€æ–‡ç« ");if(a.is_system&&!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°ç³»çµ±æ–‡ç« ");if(!a.is_system&&a.created_by!==n.user.id)throw new Error("åªèƒ½æ›´æ–°è‡ªå·±å‰µå»ºçš„æ–‡ç« ")}const{error:t}=await i.from("practice_texts").update({title:r.title,author:r.author??null,source:r.source??null,summary:r.summary??null,content:r.content}).eq("id",e);if(t)throw t;if(r.reading_category_ids!==void 0){const{error:w}=await i.from("text_reading_categories").delete().eq("text_id",e);if(w)throw w;if(r.reading_category_ids.length>0){const{error:y}=await i.from("text_reading_categories").insert(r.reading_category_ids.map(z=>({text_id:e,category_id:z})));if(y)throw y}}const{data:o,error:s}=await i.from("practice_texts").select(`
        *,
        text_reading_categories (
          category:reading_categories (
            id,
            name,
            description,
            order_index
          )
        )
      `).eq("id",e).single();if(s)throw s;const d=o.text_reading_categories?.map(w=>w.category).filter(Boolean)||[],l={...o,reading_categories:d,text_reading_categories:void 0};c.value?.id===e&&(c.value={...c.value,...l,annotations:c.value.annotations,progress:c.value.progress});const f=u.value.findIndex(w=>w.id===e);return f!==-1&&u.value[f]&&(u.value[f]={...u.value[f],...l,progress:u.value[f].progress,annotations:u.value[f].annotations||[]}),l}async function U(e,r){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°æ–‡é›†");const{error:a}=await i.from("text_reading_categories").delete().eq("text_id",e);if(a)throw a;if(r.length>0){const{error:s}=await i.from("text_reading_categories").insert(r.map(d=>({text_id:e,category_id:d})));if(s)throw s}const t=_.value.filter(s=>r.includes(s.id));c.value?.id===e&&(c.value.reading_categories=t);const o=u.value.findIndex(s=>s.id===e);o!==-1&&u.value[o]&&(u.value[o].reading_categories=t)}async function $(){if(i)try{const{data:e,error:r}=await i.from("reading_categories").select("*").order("order_index",{ascending:!0});if(r)throw r;_.value=e||[]}catch(e){console.error("ç²å–é–±è®€åˆ†é¡žå¤±æ•—:",e)}}async function F(e,r){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥å‰µå»ºåˆ†é¡ž");const a=_.value.reduce((s,d)=>Math.max(s,d.order_index),0),{data:t,error:o}=await i.from("reading_categories").insert({name:e,description:r||null,order_index:a+1,created_by:n.user?.id}).select().single();if(o)throw o;return t&&_.value.push(t),t}async function L(e,r){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°åˆ†é¡ž");const{data:a,error:t}=await i.from("reading_categories").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(t)throw t;const o=_.value.findIndex(s=>s.id===e);return o!==-1&&a&&(_.value[o]=a),a}async function j(e){if(!i)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤åˆ†é¡ž");const{error:r}=await i.from("reading_categories").delete().eq("id",e);if(r)throw r;_.value=_.value.filter(a=>a.id!==e)}return{readingTexts:u,currentText:c,readingCategories:_,bookmarkedTexts:v,isLoading:p,error:g,fetchReadingTexts:E,fetchTextDetail:S,createReadingText:D,updateReadingText:P,deleteReadingText:B,extractPracticeFragment:R,clearCurrentText:C,updateProgress:b,toggleBookmark:q,startReadingTracking:O,saveReadingRecord:h,markAsCompleted:M,addAnnotation:A,updateAnnotation:T,deleteAnnotation:k,fetchReadingCategories:$,createReadingCategory:F,updateReadingCategory:L,deleteReadingCategory:j,updateTextCategories:U}});export{V as u};
