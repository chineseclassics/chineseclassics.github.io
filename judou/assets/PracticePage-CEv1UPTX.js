import{d as Ge,u as Xe,r as d,c as b,v as We,f as Fe,z as He,a as r,g as a,h as _,t as u,q as g,m as Qe,A as _e,b as y,B as ke,C as Je,F as p,j as M,D as Ke,s as Ye,p as Ze,n as et,o as l,_ as tt}from"./index-Jcla3pSS.js";import{u as st,a as at}from"./practiceLibraryStore-VQSKapMo.js";import{u as nt}from"./assignmentStore-B_uOAbPh.js";import{u as lt}from"./userStatsStore-CzR-l0I_.js";import{u as rt}from"./classStore-CEyEWPTg.js";import{u as ot}from"./avatarStore-CtgGydcO.js";import{c as it,a as ut,b as ct}from"./useClassicalTTS-CXHixeah.js";import"./useSupabase-Dzb3yNyS.js";const dt={class:"practice-shell"},vt={class:"picker-section edamame-glass"},mt={class:"picker-current"},pt={class:"picker-info"},ft={class:"picker-breadcrumb"},ht={key:0,class:"picker-meta"},_t={key:0},kt={key:0,class:"picker-panel"},yt={class:"picker-search"},gt={key:0,class:"picker-results"},bt={key:0,class:"picker-empty"},Tt=["onClick"],St={class:"item-main"},wt={class:"item-title"},Ct={class:"item-author"},xt={class:"item-preview"},At={key:1,class:"picker-cascade"},Bt={class:"cascade-row"},$t={class:"cascade-select full-width"},Rt=["value"],It={class:"picker-list"},Vt={key:0,class:"picker-empty"},Pt={key:1,class:"picker-empty"},Nt=["onClick"],zt={class:"item-main"},Et={class:"item-title"},Mt={class:"item-author"},qt={class:"item-preview"},Lt={class:"hero-actions"},Ut=["disabled"],jt={class:"board-card edamame-glass"},Dt={key:0,class:"practice-board"},Ot={class:"board-header"},Gt={class:"board-header-right"},Xt={key:1,class:"timer-badge"},Wt={key:0,class:"practice-line"},Ft=["onPointerdown","aria-label"],Ht={key:0,class:"bean"},Qt={key:1,class:"state-info"},Jt={class:"board-actions"},Kt=["disabled"],Yt={key:1,class:"board-empty"},Zt={class:"results-grid"},es={class:"result-card edamame-glass"},ts={class:"result-desc"},ss={class:"result-card edamame-glass"},as={class:"result-desc"},ns={class:"result-card edamame-glass"},ls={class:"result-desc"},rs={class:"result-card edamame-glass"},os={class:"result-desc"},is={key:0,class:"new-record"},us={key:1},cs={key:2},ds=Ge({__name:"PracticePage",setup(vs){const Z=We(),T=st(),j=at(),ye=nt(),h=Xe(),D=lt(),ee=rt(),ge=ot(),te=d(new Set),O=b(()=>Z.query.assignmentId),se=b(()=>Z.query.textId),c=d(null),k=d([]),S=d(new Set),m=d(new Set),o=d(null),V=d(0),v=d(null),G=d(!1),X=d(0),ae=d(0),ne=d(0),W=d(!1),F=d(!1),le=b(()=>S.value.size),be=b(()=>m.value.size),re=b(()=>Math.max(0,le.value-be.value)),oe=b(()=>re.value>0),P=d(!1),w=d(null),A=d(""),Te=d(localStorage.getItem("judou_username")||"guest"),Se=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡"),$=d(!1);let N=null;const C=d(null);function ie(){C.value||(C.value=new(window.AudioContext||window.webkitAudioContext))}function H(t){if(C.value||ie(),!C.value)return;const e=C.value,n=e.createOscillator(),s=e.createGain();n.connect(s),s.connect(e.destination),t==="add"?(n.frequency.setValueAtTime(400,e.currentTime),n.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),n.start(e.currentTime),n.stop(e.currentTime+.1)):(n.frequency.setValueAtTime(300,e.currentTime),n.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),n.start(e.currentTime),n.stop(e.currentTime+.08))}function ue(t=10){navigator.vibrate&&navigator.vibrate(t)}const Q=b(()=>j.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index));function J(t){return!!(t.is_system===!0||t.created_by===h.user?.id||h.isStudent&&t.created_by&&te.value.has(t.created_by))}const ce=b(()=>w.value?T.texts.filter(t=>t.category_id!==w.value?!1:J(t)).sort((t,e)=>t.title.localeCompare(e.title)):[]),de=b(()=>{if(!A.value.trim())return[];const t=A.value.toLowerCase();return T.texts.filter(e=>J(e)?e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t):!1).slice(0,10)}),we=b(()=>{if(!c.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];return c.value.category?.name&&t.push(c.value.category.name),t.push(c.value.title),t.join(" â€º ")});async function Ce(){if(!h.isStudent||!h.isAuthenticated)return;await ee.fetchStudentClasses();const t=new Set;for(const e of ee.classes)e.teacher_id&&t.add(e.teacher_id);te.value=t}function xe(t){const e=[],n=new Set;let s=0;for(const i of t)i==="|"?s>0&&n.add(s-1):i!==`
`&&i!=="\r"&&(e.push(i),s++);return{chars:e,breaks:n}}function Ae(){q(),V.value=0,N=window.setInterval(()=>{V.value+=1},1e3)}function q(){N&&(clearInterval(N),N=null)}function K(t){const{chars:e,breaks:n}=xe(t.content);k.value=e,S.value=n,m.value=new Set,o.value=null,v.value=null,q(),V.value=0,X.value=0,ae.value=0,ne.value=0,W.value=!1}function L(t){c.value=t,K(t),P.value=!1,A.value="",t.category_id&&(w.value=t.category_id)}function ve(){const t=T.texts.filter(x=>x.text_type==="practice"&&J(x));if(!t.length){v.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}const e=c.value?.id,n=t.filter(x=>x.id!==e);if(!n.length){v.value="ç›®å‰åªæœ‰ä¸€ç¯‡æ–‡ç« å¯ç·´ç¿’";return}const s=Math.floor(Math.random()*n.length),i=n[s];i&&L(i)}async function Be(){const t=[];if(T.texts.length||t.push(T.fetchTexts()),j.state.categories.length||t.push(j.fetchLibrary()),h.isStudent&&h.isAuthenticated&&t.push(Ce()),await Promise.all(t),se.value&&O.value){const e=T.texts.find(n=>n.id===se.value);if(e){L(e);return}}if(!c.value&&T.texts.length&&ve(),!w.value&&Q.value.length){const e=Q.value[0];e&&(w.value=e.id)}}function $e(t){if(o.value){v.value="å·²æäº¤ï¼å¦‚è¦å†æ¬¡å˜—è©¦è«‹é»æ“Šã€Œé‡æ–°æŒ‘æˆ°ã€";return}const e=new Set(m.value),n=e.has(t);if(!n&&!oe.value){Re(),v.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}m.value.size===0&&!N&&!W.value&&Ae(),n?(e.delete(t),H("remove")):(e.add(t),H("add"),ue(10)),m.value=e,v.value=null}function Re(){F.value=!0,H("remove"),ue(50),setTimeout(()=>{F.value=!1},400)}function Ie(t){if(!o.value){const e=t>0&&m.value.has(t-1),n=m.value.has(t);if(e&&n)return"translateX(0)";if(e)return"translateX(4px)";if(n)return"translateX(-4px)"}return"translateX(0)"}function Ve(t){const e=[],n=m.value.has(t);if(n&&e.push("has-bean"),o.value&&n){const s=o.value.statuses.find(i=>i.index===t);s&&(s.state==="correct"||s.state==="extra")&&e.push(s.state)}return e}function Pe(t){return`${t} è±†`}function Ne(t){return`${Math.round(t*100)}%`}function me(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function ze(t,e){return D.calculateScore({correctCount:t,totalBreaks:S.value.size,charCount:k.value.length,elapsedSeconds:e})}async function Ee(){if(!c.value)return;if(!m.value.size){v.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}X.value++;const t=[];let e=0,n=0,s=0;for(let f=0;f<=k.value.length;f++){const E=m.value.has(f),I=S.value.has(f);E&&I?(t.push({index:f,state:"correct"}),e++):!E&&I?(t.push({index:f,state:"missed"}),n++):E&&!I?(t.push({index:f,state:"extra"}),s++):t.push({index:f,state:"pending"})}const i=S.value.size?e/S.value.size:m.value.size?0:1,x=n===0&&s===0;q(),W.value=!0;const U=V.value;X.value===1&&(ae.value=i,ne.value=U);const{score:R,breakdown:Y}=ze(e,U);if(o.value={statuses:t,accuracy:i,elapsed:U,score:R,isComplete:x,breakdown:Y},x){qe();const f=Y.speedBonus>0?` + é€Ÿåº¦çå‹µ ${Y.speedBonus}`:"";v.value=`ğŸ‰ å…¨å°ï¼æ­£ç¢º ${e} è±†${f} = ${R} è±†`}else v.value=`æ­£ç¢º ${e} å€‹ï¼Œéºæ¼ ${n} å€‹ï¼Œå¤šé¤˜ ${s} å€‹ â†’ ç²å¾— ${R} è±†`;try{G.value=!0;const f=h.isAuthenticated?h.user?.email?.split("@")[0]||"user":Te.value,E=h.isAuthenticated?h.displayName:Se.value,I=await T.recordPracticeResult({text_id:c.value.id,score:R,accuracy:i,elapsed_seconds:U,user_breaks:m.value.size,correct_breaks:S.value.size,username:f,display_name:E,user_id:h.user?.id||null});if(h.isAuthenticated){const B=await D.recordPracticeScore({textId:c.value.id,score:R,textTitle:c.value.title});if(o.value&&(o.value.beansEarned=B.beansEarned,o.value.isNewRecord=B.isNewRecord),B.beansEarned>0){const De=B.isNewRecord?" (æ–°ç´€éŒ„!)":"";v.value=`${v.value}${De} å¯¦å¾— +${B.beansEarned} è±†`;const he=await ge.checkAndUnlockAvatars(D.level);he.length>0&&setTimeout(()=>{v.value=`ğŸ‰ è§£é–æ–°é ­åƒï¼š${he.map(Oe=>Oe.name).join("ã€")}`},2e3)}else B.beansEarned===0&&!B.isNewRecord&&(v.value=`${v.value}ï¼ˆæœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„ï¼Œä¸åŠ åˆ†ï¼‰`)}O.value&&h.isAuthenticated&&I&&await ye.recordCompletion(O.value,I,R,i*100)}catch(f){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",f)}finally{G.value=!1}}function Me(){c.value&&K(c.value)}function qe(){if(C.value||ie(),!C.value)return;const t=C.value,e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function Le(){if(!k.value.length)return[];const t=[];let e="",n=-1;for(let s=0;s<k.value.length;s++)if(e+=k.value[s],S.value.has(s)){const i=s-n;n=s,i>=8?(e+="ã€‚",t.push(e),e=""):i>=4?e+="ï¼Œ":e+="ã€"}return e.trim()&&(!e.endsWith("ã€‚")&&!e.endsWith("ï¼Œ")&&!e.endsWith("ã€")&&(e+="ã€‚"),t.push(e)),t.length===0&&k.value.length>0?[k.value.join("")+"ã€‚"]:t}let z=!1;function pe(){z=!0,it(),$.value=!1}const fe={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function Ue(){if(!k.value.length)return;if($.value){pe();return}$.value=!0,z=!1;const t=Le();try{for(let e=0;e<t.length&&!z;e++){const n=t[e+1];n&&ut(n,fe);const s=t[e];s&&await ct(s,fe)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),z||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{$.value=!1,z=!1}}function je(){c.value&&K(c.value)}return Fe(()=>{Be()}),He(()=>{q(),pe()}),(t,e)=>{const n=Ye("router-link");return l(),r("div",dt,[a("section",vt,[a("div",{class:"picker-header",onClick:e[1]||(e[1]=s=>P.value=!P.value)},[a("div",mt,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",pt,[a("span",ft,u(we.value),1),c.value?(l(),r("span",ht,[g(u(c.value.author||"ä½šå")+" ",1),c.value.source?(l(),r("span",_t," Â· "+u(c.value.source),1)):_("",!0),c.value.source_text?.id?(l(),Qe(n,{key:1,to:{name:"reading-detail",params:{id:c.value.source_text.id}},class:"source-link",onClick:e[0]||(e[0]=_e(()=>{},["stop"]))},{default:Ze(()=>[g(" Â· ä¾†è‡ªã€Š"+u(c.value.source_text.title)+"ã€‹ ",1)]),_:1},8,["to"])):_("",!0)])):_("",!0)])]),a("button",{class:y(["picker-toggle",{expanded:P.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),P.value?(l(),r("div",kt,[a("div",yt,[ke(a("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>A.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Je,A.value]])]),A.value.trim()?(l(),r("div",gt,[de.value.length?_("",!0):(l(),r("div",bt," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+u(A.value)+"ã€çš„æ–‡ç«  ",1)),(l(!0),r(p,null,M(de.value,s=>(l(),r("div",{key:s.id,class:"picker-item",onClick:i=>L(s)},[a("div",St,[a("span",wt,u(s.title),1),a("span",Ct,u(s.author||"ä½šå"),1)]),a("span",xt,u(me(s)),1)],8,Tt))),128))])):(l(),r("div",At,[a("div",Bt,[a("div",$t,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),ke(a("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>w.value=s)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(l(!0),r(p,null,M(Q.value,s=>(l(),r("option",{key:s.id,value:s.id},u(s.name),9,Rt))),128))],512),[[Ke,w.value]])])]),a("div",It,[w.value?ce.value.length?_("",!0):(l(),r("div",Pt," æ­¤å¹´ç´šå°šç„¡æ–‡ç«  ")):(l(),r("div",Vt," è«‹é¸æ“‡å¹´ç´šä»¥æŸ¥çœ‹æ–‡ç«  ")),(l(!0),r(p,null,M(ce.value,s=>(l(),r("div",{key:s.id,class:y(["picker-item",{active:c.value?.id===s.id}]),onClick:i=>L(s)},[a("div",zt,[a("span",Et,u(s.title),1),a("span",Mt,u(s.author||"ä½šå"),1),a("span",{class:y(["item-difficulty",`diff-${s.difficulty}`])},u(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",qt,u(me(s)),1)],10,Nt))),128))])]))])):_("",!0)]),a("div",Lt,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:je,disabled:!c.value}," é‡æ–°é–‹å§‹ ",8,Ut),a("button",{class:"edamame-btn edamame-btn-primary",onClick:ve}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",jt,[c.value?(l(),r("div",Dt,[a("div",Ot,[e[8]||(e[8]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Gt,[o.value?.isComplete?(l(),r("button",{key:0,class:y(["tts-btn-small",{playing:$.value}]),onClick:Ue},u($.value?"â¹ åœæ­¢":"ğŸ”Š æœ—è®€"),3)):_("",!0),a("div",{class:y(["bean-inventory",{shake:F.value,empty:!oe.value}])},[(l(!0),r(p,null,M(le.value,s=>(l(),r("span",{key:s,class:y(["inventory-bean",{used:s>re.value}])},null,2))),128))],2),m.value.size>0||o.value?(l(),r("span",Xt,"â± "+u(V.value)+" ç§’",1)):_("",!0)])]),k.value.length?(l(),r("div",Wt,[(l(!0),r(p,null,M(k.value,(s,i)=>(l(),r("span",{key:i,class:"char-unit"},[a("span",{class:"char",style:et({transform:Ie(i)})},u(s),5),i<k.value.length-1?(l(),r("button",{key:0,class:y(["bean-slot",Ve(i)]),onPointerdown:_e(x=>$e(i),["prevent"]),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${m.value.has(i)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[m.value.has(i)?(l(),r("span",Ht)):_("",!0),e[9]||(e[9]=a("span",{class:"bean-hint"},null,-1))],42,Ft)):_("",!0)]))),128))])):(l(),r("div",Qt,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",Jt,[o.value?(l(),r("button",{key:1,class:"edamame-btn edamame-btn-lg edamame-btn-secondary",onClick:Me}," ğŸ”„ é‡æ–°æŒ‘æˆ° ")):(l(),r("button",{key:0,class:"edamame-btn edamame-btn-lg edamame-btn-primary",disabled:G.value,onClick:Ee}," æäº¤ç­”æ¡ˆ ",8,Kt))]),v.value?(l(),r("p",{key:2,class:y(["toast",{success:o.value?.isComplete}])},u(v.value),3)):_("",!0)])):(l(),r("div",Yt,[...e[10]||(e[10]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",Zt,[a("article",es,[e[11]||(e[11]=a("p",{class:"result-label"},"æœ¬æ¬¡å¾—åˆ†",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},u(o.value?Pe(o.value.score):"--"),3),a("p",ts,[o.value?.breakdown?(l(),r(p,{key:0},[g(" æ­£ç¢º "+u(o.value.breakdown.baseScore)+" è±† ",1),o.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[g(" + é€Ÿåº¦ "+u(o.value.breakdown.speedBonus)+" è±† ",1)],64)):_("",!0)],64)):(l(),r(p,{key:1},[g(" å°å¹¾å€‹å¾—å¹¾è±† ")],64))])]),a("article",ss,[e[12]||(e[12]=a("p",{class:"result-label"},"æ­£ç¢ºç‡",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},u(o.value?Ne(o.value.accuracy):"--"),3),a("p",as,[o.value?(l(),r(p,{key:0},[g(u(o.value.isComplete?"ğŸ‰ å…¨å°ï¼":"ç¹¼çºŒåŠ æ²¹"),1)],64)):(l(),r(p,{key:1},[g(" æ­£ç¢ºæ•¸ Ã· ç¸½æ–·å¥æ•¸ ")],64))])]),a("article",ns,[e[13]||(e[13]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},u(o.value?`${o.value.elapsed} ç§’`:"--"),3),a("p",ls,[o.value?.breakdown?(l(),r(p,{key:0},[g(" åŸºæº– "+u(o.value.breakdown.baseTime)+" ç§’ ",1),o.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[g(" Â· ç¯€çœ "+u(o.value.breakdown.baseTime-o.value.elapsed)+" ç§’ ",1)],64)):_("",!0)],64)):(l(),r(p,{key:1},[g(" å…¨å°æ‰æœ‰é€Ÿåº¦çå‹µ ")],64))])]),a("article",rs,[e[14]||(e[14]=a("p",{class:"result-label"},"å¯¦å¾—è±†å­",-1)),a("p",{class:y(["result-value",{placeholder:!o.value||o.value.beansEarned===void 0}])},u(o.value?.beansEarned!==void 0?`+${o.value.beansEarned}`:"--"),3),a("p",os,[o.value?.beansEarned!==void 0?(l(),r(p,{key:0},[o.value.isNewRecord?(l(),r("span",is,"ğŸ† æ–°ç´€éŒ„ï¼")):o.value.beansEarned===0?(l(),r("span",us,"æœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„")):(l(),r("span",cs,"å¢é‡åŠ åˆ†"))],64)):(l(),r(p,{key:1},[g(" ç™»å…¥å¾Œè¨˜éŒ„ ")],64))])])])])}}}),bs=tt(ds,[["__scopeId","data-v-d3a80753"]]);export{bs as default};
