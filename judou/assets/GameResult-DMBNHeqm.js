import{d as Q,u as X,c,q as Y,r as S,w as Z,o as ee,a as l,b as s,e as d,t as n,n as m,F as x,g as M,m as C,h as se,j as L,i as te,f as D,s as o,_ as ae}from"./index-Dh9UML9p.js";import{u as ne,g as re,c as O}from"./gameStore-BzEqBOLT.js";import{u as le}from"./userStatsStore-CEzXN2zD.js";const oe={class:"result-header"},ue={class:"result-icon"},ie={class:"bean-sign"},ce={key:0,class:"bean-note"},ve={key:0,class:"ranking-section"},de={class:"ranking-list"},me=["src","alt"],pe={key:1,class:"avatar-placeholder"},_e={class:"name"},fe={class:"score"},ge={class:"accuracy"},he={class:"time"},ke={key:1,class:"streak-card"},ye={class:"streak-text"},be={key:2,class:"answers-section"},we={key:0,class:"result-tabs"},Se=["onClick"],Ce={class:"tab-number"},Be={class:"tab-title"},Re={class:"tab-stats"},Te={key:1,class:"answer-detail"},xe={class:"answer-header"},Me={key:0,class:"answer-author"},Ae={class:"answer-stats"},Ie={class:"stat correct"},Ve={class:"stat wrong"},De={class:"stat missed"},Fe={class:"answer-content"},Ne={class:"answer-line"},Pe={class:"answer-char"},$e={key:3,class:"ranking-section"},ze={class:"team-ranking-list"},qe={class:"rank"},Ge={class:"team-name"},Le={class:"team-score"},Oe={class:"rank-title-section"},Ee={class:"level-text"},Ue=Q({__name:"GameResult",setup(We){const A=te(),E=Y(),h=ne(),B=X(),I=le(),R=c(()=>E.params.roomId),u=c(()=>h.currentRoom),_=c(()=>h.myParticipant),v=S(null),T=S(0),i=c(()=>{if(!v.value)return null;const a=v.value.texts[T.value],e=v.value.results[T.value];return!a||!e?null:{text:a,result:e}});function F(a){const e=[];for(const t of a)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function N(a){if(!i.value?.result)return"none";const e=i.value.result,t=e.userBreaks.includes(a),r=e.correctBreaks.includes(a);return t&&r?"correct":t&&!r?"wrong":!t&&r?"missed":"none"}const f=c(()=>{if(!u.value||!B.user)return!1;if(u.value.game_mode==="team_battle")return _.value?.team_id===u.value.winner_team_id;{if(u.value.winner_user_id)return u.value.winner_user_id===B.user.id;if(!u.value.participants)return!1;const a=_.value?.score??0,e=_.value?.time_spent??999999,t=Math.max(...u.value.participants.map(p=>p.score)),r=u.value.participants.filter(p=>p.score===t),w=Math.min(...r.map(p=>p.time_spent??999999));return a===t&&e===w}}),k=c(()=>!u.value||u.value.game_mode==="team_battle"?!1:!u.value.winner_user_id&&f.value),U=c(()=>u.value?.participants?[...u.value.participants].sort((a,e)=>e.score-a.score).map((a,e)=>({...a,rank:e+1})):[]),W=c(()=>u.value?.teams?[...u.value.teams].sort((a,e)=>e.total_score-a.total_score):[]),P=c(()=>I.level),$=c(()=>re(P.value)),z=c(()=>I.profile?.pvp_win_streak??0),q=S(!1),y=S(0),b=S(!1),g=c(()=>{if(!_.value)return{amount:0,type:"neutral"};const a=_.value.prize_won||0,e=_.value.fee_paid||0;return a>0?{amount:a,type:"win"}:e>0&&!f.value?{amount:-e,type:"lose"}:k.value&&e>0?{amount:0,type:"tie"}:{amount:0,type:"neutral"}});function j(){const a=Math.abs(g.value.amount);if(a===0&&g.value.type!=="tie"){b.value=!0;return}q.value=!0,y.value=0;const e=2500,t=Date.now(),r=a>0?a:100;function w(){const p=Date.now()-t,V=Math.min(p/e,1);if(V<1){if(V<.8)y.value=Math.floor(Math.random()*r*1.5);else{const G=(V-.8)/.2;y.value=Math.floor(a*G+Math.random()*(a*(1-G)))}requestAnimationFrame(w)}else y.value=a,b.value=!0}setTimeout(()=>{requestAnimationFrame(w)},500)}function J(a){v.value&&a>=0&&a<v.value.texts.length&&(T.value=a)}function H(){h.reset(),sessionStorage.removeItem(`game-result-${R.value}`),A.push({name:"arena"})}function K(){h.reset(),sessionStorage.removeItem(`game-result-${R.value}`),B.isTeacher?A.push({name:"arena-teacher-create"}):A.push({name:"arena-create"})}return Z(()=>u.value?.status,a=>{}),ee(()=>{h.subscribeToRoom(R.value),I.fetchProfile();const a=sessionStorage.getItem(`game-result-${R.value}`);if(a)try{v.value=JSON.parse(a)}catch{}j()}),(a,e)=>(o(),l("div",{class:m(["game-result",{winner:f.value,tie:k.value}])},[s("header",oe,[s("div",ue,n(k.value?"ğŸ¤":f.value?"ğŸ†":"ğŸ’ª"),1),s("h1",null,n(k.value?"å¹³å±€ï¼":f.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),q.value||g.value.type!=="neutral"?(o(),l("div",{key:0,class:m(["bean-change-display",[g.value.type,{complete:b.value}]])},[s("span",ie,n(g.value.type==="lose"?"-":g.value.type==="win"?"+":""),1),s("span",{class:m(["bean-number",{rolling:!b.value}])},n(y.value),3),e[0]||(e[0]=s("span",{class:"bean-icon"},"ğŸ«˜",-1)),k.value&&b.value?(o(),l("span",ce,"å…¥å ´è²»å·²é€€é‚„")):d("",!0)],2)):d("",!0)]),u.value?.game_mode==="pvp"?(o(),l("section",ve,[e[1]||(e[1]=s("h2",null,"æ’è¡Œæ¦œ",-1)),s("div",de,[(o(!0),l(x,null,M(U.value,t=>(o(),l("div",{key:t.id,class:m(["ranking-item",{me:t.user_id===D(B).user?.id,top:t.rank<=3}])},[s("span",{class:m(["rank",`rank-${t.rank}`])},n(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(o(),l("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,me)):(o(),l("span",pe,n(t.user?.display_name?.charAt(0)||"?"),1)),s("span",_e,n(t.user?.display_name||"æœªçŸ¥"),1),s("span",fe,n(t.score)+" åˆ†",1),s("span",ge,n(t.accuracy?.toFixed(0)||0)+"%",1),s("span",he,n(t.time_spent)+"s",1)],2))),128))])])):d("",!0),z.value>0&&f.value?(o(),l("div",ke,[e[4]||(e[4]=s("span",{class:"streak-icon"},"ğŸ”¥",-1)),s("span",ye,[e[2]||(e[2]=C(" é€£å‹ ",-1)),s("strong",null,n(z.value),1),e[3]||(e[3]=C(" å ´ï¼ ",-1))])])):d("",!0),v.value?(o(),l("section",be,[e[10]||(e[10]=s("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),v.value.texts.length>1?(o(),l("div",we,[(o(!0),l(x,null,M(v.value.texts,(t,r)=>(o(),l("button",{key:t.id,class:m(["result-tab",{active:r===T.value}]),onClick:w=>J(r)},[s("span",Ce,n(r+1),1),s("span",Be,n(t.title),1),s("span",Re," âœ“"+n(v.value.results[r]?.correctCount||0),1)],10,Se))),128))])):d("",!0),i.value&&i.value.text&&i.value.result?(o(),l("div",Te,[s("div",xe,[s("h3",null,n(i.value.text.title),1),i.value.text.author?(o(),l("span",Me,n(i.value.text.author),1)):d("",!0)]),s("div",Ae,[s("span",Ie,[e[5]||(e[5]=s("span",{class:"bean-legend correct"},null,-1)),C(" æ­£ç¢º "+n(i.value.result.correctCount),1)]),s("span",Ve,[e[6]||(e[6]=s("span",{class:"bean-legend wrong"},null,-1)),C(" éŒ¯èª¤ "+n(i.value.result.wrongCount),1)]),s("span",De,[e[7]||(e[7]=s("span",{class:"bean-legend missed"},null,-1)),C(" éºæ¼ "+n(i.value.result.missedCount),1)])]),s("div",Fe,[s("div",Ne,[(o(!0),l(x,null,M(F(i.value.text.content),(t,r)=>(o(),l("span",{key:r,class:"char-unit"},[s("span",Pe,n(t),1),r<F(i.value.text.content).length-1&&N(r)!=="none"?(o(),l("span",{key:0,class:m(["bean-slot",N(r)])},[...e[8]||(e[8]=[s("span",{class:"bean"},null,-1)])],2)):d("",!0)]))),128))])]),e[9]||(e[9]=se('<div class="answer-legend" data-v-02a67dc0><span class="legend-item" data-v-02a67dc0><span class="bean-legend correct" data-v-02a67dc0></span> æ­£ç¢º </span><span class="legend-item" data-v-02a67dc0><span class="bean-legend wrong" data-v-02a67dc0></span> éŒ¯èª¤ </span><span class="legend-item" data-v-02a67dc0><span class="bean-legend missed" data-v-02a67dc0></span> éºæ¼ </span></div>',1))])):d("",!0)])):d("",!0),u.value?.game_mode==="team_battle"?(o(),l("section",$e,[e[11]||(e[11]=s("h2",null,"éšŠä¼æ’è¡Œ",-1)),s("div",ze,[(o(!0),l(x,null,M(W.value,(t,r)=>(o(),l("div",{key:t.id,class:m(["team-ranking-item",{winner:r===0}]),style:L({"--team-primary":D(O)[t.team_color].primary,"--team-secondary":D(O)[t.team_color].secondary})},[s("span",qe,n(r===0?"ğŸ†":r+1),1),s("span",Ge,n(t.team_name),1),s("span",Le,n(t.total_score)+" åˆ†",1)],6))),128))])])):d("",!0),s("section",Oe,[e[12]||(e[12]=s("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),s("div",{class:"rank-title-display",style:L({color:$.value.color})},n($.value.title),5),s("p",Ee,"Lv."+n(P.value),1)]),s("footer",{class:"result-footer"},[s("button",{class:"btn-secondary",onClick:H}," è¿”å›é¬¥è±† "),s("button",{class:"btn-primary",onClick:K}," å†ä¾†ä¸€å±€ ")])],2))}}),Ke=ae(Ue,[["__scopeId","data-v-02a67dc0"]]);export{Ke as default};
