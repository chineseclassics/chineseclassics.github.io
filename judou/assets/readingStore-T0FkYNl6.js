import{x as O,u as M,r as w,c as P}from"./index-CD8n1t7s.js";import{u as U}from"./useSupabase-CSmFnD0E.js";const j=O("reading",()=>{const o=U(),s=M(),u=w([]),c=w(null),l=w([]),_=w(!1),g=w(null),x=P(()=>u.value.filter(e=>e.progress?.bookmarked));async function p(){if(!o){g.value="Supabase 尚未配置";return}_.value=!0,g.value=null;try{const{data:e,error:t}=await o.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("text_type","reading").order("created_at",{ascending:!1});if(t)throw t;let i=new Map;if(s.isAuthenticated&&s.user?.id){const{data:r}=await o.from("reading_progress").select("*").eq("user_id",s.user.id);r&&r.forEach(a=>{i.set(a.text_id,a)})}u.value=(e||[]).map(r=>{const a=r.text_reading_categories?.map(n=>n.category).filter(Boolean)||[];return{...r,reading_categories:a,text_reading_categories:void 0,progress:i.get(r.id)||null}})}catch(e){g.value=e.message??"無法載入閱讀文章"}finally{_.value=!1}}async function h(e){if(!o)return g.value="Supabase 尚未配置",null;_.value=!0,g.value=null;try{const{data:t,error:i}=await o.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("id",e).single();if(i)throw i;const{data:r}=await o.from("text_annotations").select("*").eq("text_id",e).order("start_index",{ascending:!0});let a=null;if(s.isAuthenticated&&s.user?.id){const{data:d}=await o.from("reading_progress").select("*").eq("text_id",e).eq("user_id",s.user.id).maybeSingle();a=d||null}const n=t.text_reading_categories?.map(d=>d.category).filter(Boolean)||[];return c.value={...t,reading_categories:n,text_reading_categories:void 0,annotations:r||[],progress:a},c.value}catch(t){return g.value=t.message??"無法載入文章詳情",null}finally{_.value=!1}}async function v(e,t,i){if(!(!o||!s.isAuthenticated||!s.user?.id))try{const{data:r,error:a}=await o.from("reading_progress").upsert({user_id:s.user.id,text_id:e,progress_percent:t,last_paragraph:i,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(a)throw a;c.value?.id===e&&(c.value.progress=r);const n=u.value.findIndex(f=>f.id===e),d=u.value[n];n!==-1&&r&&d&&(d.progress=r)}catch(r){console.error("更新閱讀進度失敗:",r)}}async function m(e){if(!o||!s.isAuthenticated||!s.user?.id)return;const i=(u.value.find(r=>r.id===e)||c.value)?.progress?.bookmarked??!1;try{const{data:r,error:a}=await o.from("reading_progress").upsert({user_id:s.user.id,text_id:e,bookmarked:!i,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(a)throw a;c.value?.id===e&&(c.value.progress=r);const n=u.value.findIndex(f=>f.id===e),d=u.value[n];return n!==-1&&r&&d&&(d.progress=r),r?.bookmarked}catch(r){return console.error("切換書籤失敗:",r),null}}async function y(e){if(!o)throw new Error("Supabase 尚未配置");if(!s.user)throw new Error("請先登入");if(!s.isTeacher&&!s.isAdmin)throw new Error("只有老師或管理員可以添加註釋");const{data:t,error:i}=await o.from("text_annotations").insert({...e,created_by:s.user.id}).select().single();if(i)throw i;return c.value?.id===e.text_id&&t&&(c.value.annotations=[...c.value.annotations||[],t].sort((r,a)=>r.start_index-a.start_index)),t}async function E(e,t){if(!o)throw new Error("Supabase 尚未配置");const{data:i,error:r}=await o.from("text_annotations").update({annotation:t}).eq("id",e).select().single();if(r)throw r;if(c.value?.annotations){const a=c.value.annotations.findIndex(n=>n.id===e);a!==-1&&(c.value.annotations[a]=i)}return i}async function b(e){if(!o)throw new Error("Supabase 尚未配置");const{error:t}=await o.from("text_annotations").delete().eq("id",e);if(t)throw t;c.value?.annotations&&(c.value.annotations=c.value.annotations.filter(i=>i.id!==e))}async function S(e,t=!1){if(!o)throw new Error("Supabase 尚未配置");if(!s.user)throw new Error("請先登入");const{data:i,error:r}=await o.from("practice_texts").insert({title:e.title,author:e.author??null,source:e.source??null,summary:e.summary??null,category_id:e.category_id||null,content:e.content,text_type:"reading",source_text_id:e.source_text_id||null,source_start_index:e.source_start_index??null,source_end_index:e.source_end_index??null,is_system:t,created_by:t?null:s.user.id}).select("*").single();if(r)throw r;const a=e.reading_category_ids||[];if(i&&a.length>0){const{error:d}=await o.from("text_reading_categories").insert(a.map(f=>({text_id:i.id,category_id:f})));d&&console.error("關聯文集失敗:",d)}const n=a.length>0?l.value.filter(d=>a.includes(d.id)):[];return i&&u.value.unshift({...i,reading_categories:n,progress:null,annotations:[]}),i}async function k(e,t,i,r,a){if(!o)throw new Error("Supabase 尚未配置");if(!s.user)throw new Error("請先登入");const n=u.value.find(B=>B.id===e)||c.value,{data:d,error:f}=await o.from("practice_texts").insert({title:a.title,author:n?.author??null,source:n?.source??null,category_id:a.category_id||null,content:r,difficulty:a.difficulty||2,text_type:"practice",source_text_id:e,source_start_index:t,source_end_index:i,is_system:!1,created_by:s.user.id}).select().single();if(f)throw f;return d}function A(){c.value=null}async function q(e,t){if(!o)throw new Error("Supabase 尚未配置");if(!s.isAdmin)throw new Error("只有管理員可以更新文集");const{error:i}=await o.from("text_reading_categories").delete().eq("text_id",e);if(i)throw i;if(t.length>0){const{error:n}=await o.from("text_reading_categories").insert(t.map(d=>({text_id:e,category_id:d})));if(n)throw n}const r=l.value.filter(n=>t.includes(n.id));c.value?.id===e&&(c.value.reading_categories=r);const a=u.value.findIndex(n=>n.id===e);a!==-1&&u.value[a]&&(u.value[a].reading_categories=r)}async function T(){if(o)try{const{data:e,error:t}=await o.from("reading_categories").select("*").order("order_index",{ascending:!0});if(t)throw t;l.value=e||[]}catch(e){console.error("獲取閱讀分類失敗:",e)}}async function C(e,t){if(!o)throw new Error("Supabase 尚未配置");if(!s.isAdmin)throw new Error("只有管理員可以創建分類");const i=l.value.reduce((n,d)=>Math.max(n,d.order_index),0),{data:r,error:a}=await o.from("reading_categories").insert({name:e,description:t||null,order_index:i+1,created_by:s.user?.id}).select().single();if(a)throw a;return r&&l.value.push(r),r}async function D(e,t){if(!o)throw new Error("Supabase 尚未配置");if(!s.isAdmin)throw new Error("只有管理員可以更新分類");const{data:i,error:r}=await o.from("reading_categories").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;const a=l.value.findIndex(n=>n.id===e);return a!==-1&&i&&(l.value[a]=i),i}async function R(e){if(!o)throw new Error("Supabase 尚未配置");if(!s.isAdmin)throw new Error("只有管理員可以刪除分類");const{error:t}=await o.from("reading_categories").delete().eq("id",e);if(t)throw t;l.value=l.value.filter(i=>i.id!==e)}return{readingTexts:u,currentText:c,readingCategories:l,bookmarkedTexts:x,isLoading:_,error:g,fetchReadingTexts:p,fetchTextDetail:h,createReadingText:S,extractPracticeFragment:k,clearCurrentText:A,updateProgress:v,toggleBookmark:m,addAnnotation:y,updateAnnotation:E,deleteAnnotation:b,fetchReadingCategories:T,createReadingCategory:C,updateReadingCategory:D,deleteReadingCategory:R,updateTextCategories:q}});export{j as u};
