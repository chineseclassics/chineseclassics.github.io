import{v as re,u as se,r as w,c as b,I as a}from"./index-DFJvHeuU.js";import{u as ie}from"./userStatsStore-BgzXd_E3.js";const de=[0,10,30,50,100],me=[{value:60,label:"閃電戰",description:"1 分鐘"},{value:180,label:"標準",description:"3 分鐘"},{value:300,label:"持久",description:"5 分鐘"}],fe=[2,3,4],ne={3:5,5:10,7:20,10:50},T={DAILY_FEE_LIMIT:100,MIN_BALANCE:20,MAX_LOSS_STREAK:5},oe={red:{name:"紅隊",primary:"#ef4444",secondary:"#fecaca",text:"#991b1b"},blue:{name:"藍隊",primary:"#3b82f6",secondary:"#bfdbfe",text:"#1e40af"},green:{name:"綠隊",primary:"#22c55e",secondary:"#bbf7d0",text:"#166534"},yellow:{name:"黃隊",primary:"#eab308",secondary:"#fef08a",text:"#854d0e"}};function ue(u){return["red","blue","green","yellow"].slice(0,u)}function ce(u){return oe[u].name}const P=[{minLevel:1,maxLevel:2,title:"童生",color:"#78716c"},{minLevel:3,maxLevel:5,title:"秀才",color:"#22c55e"},{minLevel:6,maxLevel:9,title:"舉人",color:"#3b82f6"},{minLevel:10,maxLevel:14,title:"進士",color:"#8b5cf6"},{minLevel:15,maxLevel:19,title:"探花",color:"#f59e0b"},{minLevel:20,maxLevel:24,title:"榜眼",color:"#ef4444"},{minLevel:25,maxLevel:999,title:"狀元",color:"#dc2626"}];function pe(u){for(const f of P)if(u>=f.minLevel&&u<=f.maxLevel)return f;return P[0]}const ve=re("game",()=>{const u=se(),f=ie(),i=w(null),S=w([]),c=w(null),p=w(!1),o=w(null);let y=null;const g=b(()=>!i.value||!u.user?!1:i.value.host_id===u.user.id),A=b(()=>i.value?.status==="playing"),N=b(()=>i.value?.status==="waiting"),M=b(()=>i.value?.status==="finished"),O=b(()=>!c.value?.team_id||!i.value?.teams?null:i.value.teams.find(e=>e.id===c.value.team_id));async function G(e){if(!a||!u.user)return o.value="請先登入",null;p.value=!0,o.value=null;try{const{data:t,error:r}=await a.from("game_rooms").insert({host_id:u.user.id,host_type:e.hostType,game_mode:e.gameMode,text_id:e.textIds[0],text_ids:e.textIds,time_limit:e.timeLimit,team_count:e.teamCount||null,max_players:e.maxPlayers||null,entry_fee:e.entryFee||0,class_id:e.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url)
        `).single();if(r)return o.value=r.message,null;if(e.gameMode==="team_battle"&&e.teamCount){const n=ue(e.teamCount).map((m,d)=>({room_id:t.id,team_name:ce(m),team_color:m,order_index:d})),{data:_,error:l}=await a.from("game_teams").insert(n).select();l?console.error("創建團隊失敗:",l):t.teams=_}return e.hostType==="student"&&await I(t.id,e.entryFee||0),i.value=t,t}catch(t){return o.value=t.message,null}finally{p.value=!1}}async function D(e){if(!a||!u.user)return{success:!1,error:"請先登入"};p.value=!0,o.value=null;try{const{data:t,error:r}=await a.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",e.toUpperCase()).single();if(r||!t)return{success:!1,error:"找不到該房間"};if(t.status!=="waiting")return{success:!1,error:"該房間已開始或已結束"};const s=t.participants?.find(l=>l.user_id===u.user.id);if(s)return i.value=t,c.value=s,E(t.id),{success:!0,room:t,participant:s};if(t.max_players&&t.participants&&t.participants.length>=t.max_players)return{success:!1,error:"房間已滿"};if(t.entry_fee>0&&!await F(t.id,t.entry_fee))return{success:!1,error:o.value||"無法支付入場費"};const n=await I(t.id,t.entry_fee);if(!n)return{success:!1,error:o.value||"加入房間失敗"};const _=[...t.participants||[],n];return i.value={...t,participants:_},c.value=n,E(t.id),{success:!0,room:t,participant:n}}catch(t){return o.value=t.message,{success:!1,error:o.value}}finally{p.value=!1}}async function I(e,t){if(!a||!u.user)return null;const{data:r,error:s}=await a.from("game_participants").insert({room_id:e,user_id:u.user.id,fee_paid:t}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return s?(o.value=s.message,null):r}async function F(e,t){if(!a||!u.user)return!1;const r=f.profile?.total_beans??0;if(r-t<T.MIN_BALANCE)return o.value=`賬戶需保留至少 ${T.MIN_BALANCE} 豆`,!1;const s=f.profile,n=new Date().toISOString().split("T")[0],_=s?.daily_fee_reset_at===n&&s?.daily_fee_spent||0;if(_+t>T.DAILY_FEE_LIMIT)return o.value=`今日入場費已達上限 ${T.DAILY_FEE_LIMIT} 豆`,!1;const{error:l}=await a.from("user_stats").update({beans:r-t,daily_fee_spent:_+t,daily_fee_reset_at:n}).eq("user_id",u.user.id);return l?(o.value="扣除入場費失敗",!1):(await a.from("game_transactions").insert({user_id:u.user.id,room_id:e,type:"entry_fee",amount:-t,balance_after:r-t,description:`入場費 ${t} 豆`}),await f.fetchProfile(),!0)}async function q(e,t){if(!a||!g.value)return o.value="無權限",!1;const{error:r}=await a.from("game_participants").update({team_id:t}).eq("id",e);return r?(o.value=r.message,!1):!0}async function z(){if(!a||!g.value||!i.value?.teams)return o.value="無法分組",!1;const e=i.value.participants||[],t=i.value.teams,r=[...e].sort(()=>Math.random()-.5);for(let s=0;s<r.length;s++){const n=s%t.length,_=t[n],l=r[s];_&&l&&await q(l.id,_.id)}return!0}async function B(){if(!a||!g.value||!i.value)return o.value="無權限",!1;if(i.value.game_mode==="team_battle"){const t=i.value.participants?.filter(r=>!r.team_id);if(t&&t.length>0)return o.value="還有玩家未分組",!1}const{error:e}=await a.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",i.value.id);return e?(o.value=e.message,!1):(await a.from("game_participants").update({status:"playing"}).eq("room_id",i.value.id),!0)}async function $(e){if(!a||!u.user||!i.value)return o.value="無法提交分數",!1;const{error:t}=await a.from("game_participants").update({score:e.score,accuracy:e.accuracy,time_spent:e.timeSpent,first_accuracy:e.firstAccuracy,attempt_count:e.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",e.roomId).eq("user_id",u.user.id);return t?(o.value=t.message,!1):(c.value?.team_id&&await L(c.value.team_id),await j(),!0)}async function U(e){if(!a||!u.user||!c.value)return o.value="無法提交進度",!1;await a.from("game_text_progress").upsert({participant_id:c.value.id,text_id:e.textId,text_index:e.textIndex,correct_count:e.correctCount,wrong_count:e.wrongCount,time_spent:e.timeSpent,completed_at:new Date().toISOString()},{onConflict:"participant_id,text_id"});const t=(c.value.correct_breaks||0)+e.correctCount,r=(c.value.completed_texts||0)+1,s=e.textIndex+1,{error:n}=await a.from("game_participants").update({correct_breaks:t,completed_texts:r,current_text_index:s,score:t}).eq("id",c.value.id);return n?(o.value=n.message,!1):(c.value.correct_breaks=t,c.value.completed_texts=r,c.value.current_text_index=s,c.value.score=t,c.value.team_id&&await L(c.value.team_id),!0)}async function Y(e){if(!a||e.length===0)return[];const{data:t}=await a.from("practice_texts").select("id, title, author, content").in("id",e);if(t){const r=new Map(t.map(s=>[s.id,s]));return e.map(s=>r.get(s)).filter(Boolean)}return[]}async function L(e){if(!a||!i.value)return;const{data:t}=await a.from("game_participants").select("score").eq("team_id",e).eq("status","completed"),r=t?.length||0,s=t?.reduce((_,l)=>_+(l.score||0),0)||0,n=r>0?Math.round(s/r*100):0;await a.from("game_teams").update({total_score:n}).eq("id",e)}async function j(){if(!a||!i.value)return;const{data:e}=await a.from("game_participants").select("status").eq("room_id",i.value.id);if(!e)return;const t=e.every(_=>_.status==="completed"),r=i.value.started_at?new Date(i.value.started_at):null,s=i.value.time_limit*1e3,n=r&&Date.now()-r.getTime()>=s;(t||n)&&await k()}async function k(){if(!a||!i.value)return null;const{data:e}=await a.from("game_rooms").select(`
        *,
        teams:game_teams!game_teams_room_id_fkey(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",i.value.id).single();if(!e)return null;let t=null,r=null,s=[];if(e.game_mode==="team_battle"&&e.teams)t=[...e.teams].sort((d,v)=>v.total_score-d.total_score)[0]?.id,s=e.participants?.filter(d=>d.team_id===t)||[];else{const l=[...e.participants||[]].sort((d,v)=>v.score!==d.score?v.score-d.score:(d.time_spent||999999)-(v.time_spent||999999)),m=l[0];m&&(s=l.filter(d=>d.score===m.score&&(d.time_spent||999999)===(m.time_spent||999999)),s.length===1&&(r=m.user_id))}await a.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:t,winner_user_id:r}).eq("id",e.id);const n=!t&&!r&&s.length>1;let _=[];return e.prize_pool>0&&s.length>0&&(n?_=await K(e,s):_=await W(e,s)),n||await H(e,s),{room:e,winners:s,winningTeam:e.teams?.find(l=>l.id===t),prizeDistribution:_}}async function W(e,t){if(!a)return[];const r=Math.floor(e.prize_pool/t.length),s=[];for(const n of t){const{data:_}=await a.from("user_stats").select("pvp_win_streak").eq("user_id",n.user_id).single(),l=(_?.pvp_win_streak||0)+1;let m=0;for(const[te,ae]of Object.entries(ne))if(l===Number(te)){m=ae;break}const d=r+m,{data:v}=await a.from("user_stats").select("beans").eq("user_id",n.user_id).single(),C=(v?.beans||0)+d;await a.from("user_stats").update({beans:C}).eq("user_id",n.user_id),await a.from("game_participants").update({prize_won:d}).eq("id",n.id),await a.from("game_transactions").insert({user_id:n.user_id,room_id:e.id,type:"prize",amount:d,balance_after:C,description:`收豆 ${r} 豆${m>0?` + 連勝獎勵 ${m} 豆`:""}`}),s.push({userId:n.user_id,displayName:n.user?.display_name||"未知",prize:r,streakBonus:m})}return s}async function K(e,t){if(!a)return[];const r=e.entry_fee||0,s=[];for(const n of t){const{data:_}=await a.from("user_stats").select("beans").eq("user_id",n.user_id).single(),l=(_?.beans||0)+r;await a.from("user_stats").update({beans:l}).eq("user_id",n.user_id),await a.from("game_participants").update({prize_won:r}).eq("id",n.id),await a.from("game_transactions").insert({user_id:n.user_id,room_id:e.id,type:"refund",amount:r,balance_after:l,description:`平局，返還入場費 ${r} 豆`}),s.push({userId:n.user_id,displayName:n.user?.display_name||"未知",prize:r,streakBonus:0})}return s}async function H(e,t){if(!a)return;const r=new Set(t.map(s=>s.user_id));for(const s of e.participants||[]){const n=r.has(s.user_id);n?await a.rpc("increment_win_streak",{p_user_id:s.user_id}):await a.from("user_stats").update({pvp_win_streak:0}).eq("user_id",s.user_id),await a.rpc("increment_pvp_games",{p_user_id:s.user_id,p_is_win:n})}}let h=null;function E(e){if(!a){console.log("[Game] subscribeToRoom: supabase 未初始化");return}if(h===e&&y){console.log("[Game] 已經訂閱房間:",e,"，跳過重複訂閱");return}console.log("[Game] 開始訂閱房間:",e),x(),h=e,y=a.channel(`game-room-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},t=>{const r=t.new,s=t.old;(r?.id||s?.id)===e&&(console.log("[Game] 房間更新:",t.eventType,r),r&&(i.value={...i.value,...r,participants:i.value?.participants,teams:i.value?.teams,host:i.value?.host,text:i.value?.text,class:i.value?.class},console.log("[Game] 房間狀態已更新為:",r.status)))}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants"},async t=>{const r=t.new,s=t.old;(r?.room_id||s?.room_id)===e&&(console.log("[Game] 參與者更新:",t.eventType),await X(e))}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams"},async t=>{const r=t.new,s=t.old;(r?.room_id||s?.room_id)===e&&(console.log("[Game] 團隊更新:",t.eventType),await J(e))}).subscribe(t=>{console.log("[Game] 房間訂閱狀態:",t),t==="CHANNEL_ERROR"&&(console.error("[Game] 訂閱錯誤"),h=null)})}async function X(e){if(!a)return;const{data:t}=await a.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",e);t&&i.value&&(i.value.participants=t,u.user&&(c.value=t.find(r=>r.user_id===u.user.id)||null))}async function J(e){if(!a)return;const{data:t}=await a.from("game_teams").select("*").eq("room_id",e).order("order_index");t&&i.value&&(i.value.teams=t)}function x(){y&&(a?.removeChannel(y),y=null),h=null}async function Q(){if(!a)return;p.value=!0;const{data:e,error:t}=await a.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);t?o.value=t.message:S.value=(e||[]).map(r=>({...r,participant_count:r.participants?.[0]?.count||0})),p.value=!1}async function V(e){if(!a)return[];const{data:t}=await a.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",e).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return t||[]}async function Z(){if(!(!a||!i.value||!u.user)){if(g.value&&i.value.status==="waiting"){if(await a.from("game_rooms").update({status:"cancelled"}).eq("id",i.value.id),i.value.entry_fee>0)for(const e of i.value.participants||[])await R(e)}else!g.value&&i.value.status==="waiting"&&(await a.from("game_participants").delete().eq("room_id",i.value.id).eq("user_id",u.user.id),c.value?.fee_paid&&await R(c.value));x(),i.value=null,c.value=null}}async function R(e){if(!a||!e.fee_paid)return;const{data:t}=await a.from("user_stats").select("beans").eq("user_id",e.user_id).single(),r=(t?.beans||0)+e.fee_paid;await a.from("user_stats").update({beans:r}).eq("user_id",e.user_id),await a.from("game_transactions").insert({user_id:e.user_id,room_id:e.room_id,type:"refund",amount:e.fee_paid,balance_after:r,description:"房間取消，退還入場費"})}function ee(){x(),i.value=null,c.value=null,S.value=[],o.value=null}return{currentRoom:i,rooms:S,myParticipant:c,loading:p,error:o,isHost:g,isPlaying:A,isWaiting:N,isFinished:M,myTeam:O,createRoom:G,joinRoom:D,assignToTeam:q,randomAssignTeams:z,leaveRoom:Z,startGame:B,submitScore:$,submitTextProgress:U,fetchTexts:Y,endGame:k,subscribeToRoom:E,unsubscribe:x,fetchPublicRooms:Q,fetchClassGames:V,reset:ee}});export{de as E,T as S,fe as T,ue as a,me as b,oe as c,pe as g,ve as u};
