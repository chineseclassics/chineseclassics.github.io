import{d as V,u as D,r as b,c as f,o as q,K as O,a,b as s,e as d,g as c,f as i,t as o,D as A,F as E,i as R,n as T,A as Y,B as z,G as W,I as G,j as J,q as l,_ as H}from"./index-CjNkA9TI.js";import{u as Q,g as X,E as Z,S as B}from"./gameStore-g7b0nSv7.js";import{u as ss}from"./userStatsStore-Bbq3g_Qo.js";const ts={class:"arena-page"},es={class:"arena-header"},as={key:0,class:"stats-card"},os={class:"stat-item"},ls={class:"stat-value"},ns={class:"stat-item"},is={class:"stat-label"},rs={key:0,class:"stat-item streak"},ds={class:"stat-value"},us={class:"stat-item"},cs={class:"stat-value"},ps={class:"stat-label"},vs={key:0,class:"login-prompt"},ms={key:1,class:"arena-main"},_s={key:0,class:"class-game-section"},ys={key:0,class:"loading-card"},fs={key:1,class:"class-game-card"},bs={class:"game-info"},gs={class:"game-title-row"},ks={class:"game-meta"},hs={class:"class-name"},Cs={class:"host-name"},Is={class:"game-code"},Ts=["disabled","onClick"],ws={key:0,class:"error-message"},xs={key:1,class:"teacher-section"},Ss={key:2,class:"student-section"},Ls={key:0,class:"section-divider"},js={class:"tab-nav"},As={class:"tab-icon"},Es={class:"tab-content"},Rs={key:0,class:"rooms-panel"},Gs={class:"panel-header"},Ns=["disabled"],Ps={key:0,class:"loading-state"},$s={key:1,class:"empty-state"},Ms={key:2,class:"room-list"},Xs=["onClick"],Bs={class:"room-info"},Fs={class:"room-title"},Ks={class:"room-host"},Us={class:"room-meta"},Vs={class:"room-players"},Ds={key:0,class:"room-fee"},qs={key:1,class:"room-fee free"},Os={key:1,class:"join-panel"},Ys={class:"join-card"},zs={class:"code-input-group"},Ws=["disabled"],Js={key:0,class:"error-message"},Hs={key:2,class:"create-panel"},Qs={key:0,class:"unlock-card"},Zs={class:"progress-bar"},st={class:"progress-text"},tt={key:1,class:"create-card"},et={class:"fee-info"},at={class:"fee-options"},ot={class:"safety-info"},lt={class:"safety-text"},C=5,nt=V({__name:"ArenaPage",setup(it){const y=J(),r=D(),p=Q(),m=ss(),u=b("rooms"),g=b(""),_=b(!1),v=b(""),k=b([]),I=b(!1),F=f(()=>m.profile?.total_beans??0),h=f(()=>m.level),w=f(()=>X(h.value)),N=f(()=>m.profile?.pvp_win_streak??0),x=f(()=>({wins:m.profile?.pvp_total_wins??0,games:m.profile?.pvp_total_games??0,winRate:m.profile?.pvp_total_games?Math.round((m.profile?.pvp_total_wins??0)/m.profile.pvp_total_games*100):0})),S=f(()=>h.value>=C),L=f(()=>k.value.length>0);async function P(){if(!(!G||!r.user||r.isTeacher)){I.value=!0;try{const{data:n}=await G.from("class_members").select("class_id").eq("student_id",r.user.id);if(!n||n.length===0){k.value=[];return}const t=n.map(j=>j.class_id),{data:e}=await G.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        class:classes!game_rooms_class_id_fkey(id, class_name),
        teams:game_teams(*)
      `).in("class_id",t).eq("host_type","teacher").in("status",["waiting","playing"]).order("created_at",{ascending:!1});k.value=e||[]}catch(n){console.error("ç²å–ç­ç´šæ¯”è³½å¤±æ•—:",n),k.value=[]}finally{I.value=!1}}}async function K(n){_.value=!0,v.value="";const t=await p.joinRoom(n.room_code);t.success?n.status==="playing"?y.push({name:"arena-play",params:{roomId:n.id}}):y.push({name:"arena-lobby",params:{roomId:n.id}}):v.value=t.error||"åŠ å…¥å¤±æ•—",_.value=!1}async function $(){if(!g.value.trim()){v.value="è«‹è¼¸å…¥æˆ¿é–“ç¢¼";return}_.value=!0,v.value="";const n=await p.joinRoom(g.value.trim());n.success?n.room?.status==="playing"?y.push({name:"arena-play",params:{roomId:n.room.id}}):y.push({name:"arena-lobby",params:{roomId:n.room.id}}):v.value=n.error||"åŠ å…¥å¤±æ•—",_.value=!1}function M(){r.isTeacher?y.push({name:"arena-teacher-create"}):y.push({name:"arena-create"})}q(()=>{r.isAuthenticated&&(p.fetchPublicRooms(),r.isTeacher||P())});const U=setInterval(()=>{r.isAuthenticated&&(u.value==="rooms"&&p.fetchPublicRooms(),r.isTeacher||P())},1e4);return O(()=>{clearInterval(U)}),(n,t)=>(l(),a("div",ts,[s("header",es,[t[11]||(t[11]=s("div",{class:"header-content"},[s("h1",{class:"page-title"},[s("span",{class:"title-icon"},"âš”ï¸"),c(" é¬¥è±† ")]),s("p",{class:"page-subtitle"},"èˆ‡åŒå­¸ä¸€è¼ƒé«˜ä¸‹ï¼Œåœ¨ç«¶æŠ€ä¸­æˆé•·")],-1)),i(r).isAuthenticated?(l(),a("div",as,[s("div",os,[t[6]||(t[6]=s("span",{class:"stat-icon"},"ðŸ«˜",-1)),s("span",ls,o(F.value),1),t[7]||(t[7]=s("span",{class:"stat-label"},"è±†å­",-1))]),s("div",ns,[s("span",{class:"stat-icon",style:A({color:w.value.color})},"ðŸŽ“",4),s("span",{class:"stat-value",style:A({color:w.value.color})},o(w.value.title),5),s("span",is,"Lv."+o(h.value),1)]),N.value>0?(l(),a("div",rs,[t[8]||(t[8]=s("span",{class:"stat-icon"},"ðŸ”¥",-1)),s("span",ds,o(N.value),1),t[9]||(t[9]=s("span",{class:"stat-label"},"é€£å‹",-1))])):d("",!0),s("div",us,[t[10]||(t[10]=s("span",{class:"stat-icon"},"ðŸ“Š",-1)),s("span",cs,o(x.value.winRate)+"%",1),s("span",ps,"å‹çŽ‡ ("+o(x.value.wins)+"/"+o(x.value.games)+")",1)])])):d("",!0)]),i(r).isAuthenticated?(l(),a("main",ms,[!i(r).isTeacher&&(L.value||I.value)?(l(),a("section",_s,[I.value?(l(),a("div",ys,[...t[15]||(t[15]=[s("div",{class:"spinner"},null,-1),s("p",null,"æª¢æŸ¥ç­ç´šæ¯”è³½...",-1)])])):L.value?(l(),a("div",fs,[t[19]||(t[19]=s("div",{class:"card-header"},[s("span",{class:"card-icon"},"ðŸ«"),s("h2",null,"ç­ç´šé€²è¡Œä¸­çš„æ¯”è³½")],-1)),(l(!0),a(E,null,R(k.value,e=>(l(),a("div",{key:e.id,class:"game-item"},[s("div",bs,[s("div",gs,[s("h3",null,o(e.text?.title||"æœªçŸ¥æ–‡æœ¬"),1),s("span",{class:T(["game-status",e.status])},o(e.status==="playing"?"ðŸ”´ é€²è¡Œä¸­":"ðŸŸ¡ ç­‰å¾…ä¸­"),3)]),s("p",ks,[s("span",hs,o(e.class?.class_name),1),t[16]||(t[16]=s("span",{class:"divider"},"Â·",-1)),s("span",Cs,o(e.host?.display_name)+" è€å¸«ç™¼èµ·",1)]),s("p",Is,[t[17]||(t[17]=c(" æˆ¿é–“ç¢¼ï¼š",-1)),s("strong",null,o(e.room_code),1),t[18]||(t[18]=s("span",{class:"code-hint"},"ï¼ˆå¯åˆ†äº«çµ¦å…¶ä»–åŒå­¸ï¼‰",-1))])]),s("button",{class:"btn-primary btn-join",disabled:_.value,onClick:j=>K(e)},o(_.value?"åŠ å…¥ä¸­...":"ç«‹å³åŠ å…¥"),9,Ts)]))),128)),v.value?(l(),a("p",ws,o(v.value),1)):d("",!0)])):d("",!0)])):d("",!0),i(r).isTeacher?(l(),a("section",xs,[t[21]||(t[21]=s("h2",{class:"section-title"},[s("span",{class:"section-icon"},"ðŸ“¢"),c(" èª²å ‚é¬¥è±† ")],-1)),t[22]||(t[22]=s("p",{class:"section-desc"},"å‰µå»ºç­ç´šæ¯”è³½ï¼Œè®“å­¸ç”Ÿåˆ†çµ„ç«¶æŠ€",-1)),s("button",{class:"btn-primary btn-large",onClick:M},[...t[20]||(t[20]=[s("span",{class:"btn-icon"},"âž•",-1),c(" å‰µå»ºèª²å ‚é¬¥è±† ",-1)])])])):d("",!0),i(r).isTeacher?d("",!0):(l(),a("div",Ss,[L.value?(l(),a("div",Ls,[...t[23]||(t[23]=[s("span",{class:"divider-text"},"å…¶ä»–åŠŸèƒ½",-1)])])):d("",!0),s("nav",js,[s("button",{class:T(["tab-btn",{active:u.value==="join"}]),onClick:t[1]||(t[1]=e=>u.value="join")},[...t[24]||(t[24]=[s("span",{class:"tab-icon"},"ðŸŽ«",-1),c(" è¼¸å…¥æˆ¿é–“ç¢¼ ",-1)])],2),s("button",{class:T(["tab-btn",{active:u.value==="rooms"}]),onClick:t[2]||(t[2]=e=>u.value="rooms")},[...t[25]||(t[25]=[s("span",{class:"tab-icon"},"ðŸŸï¸",-1),c(" å…¬é–‹é¬¥è±†å ´ ",-1)])],2),s("button",{class:T(["tab-btn",{active:u.value==="create",locked:!S.value}]),onClick:t[3]||(t[3]=e=>u.value="create")},[s("span",As,o(S.value?"âž•":"ðŸ”’"),1),t[26]||(t[26]=c(" å‰µå»ºé¬¥è±†å ´ ",-1))],2)]),s("div",Es,[u.value==="rooms"?(l(),a("div",Rs,[s("div",Gs,[t[27]||(t[27]=s("h3",null,"å¯åŠ å…¥çš„é¬¥è±†å ´",-1)),s("button",{class:"btn-text",onClick:t[4]||(t[4]=e=>i(p).fetchPublicRooms()),disabled:i(p).loading}," ðŸ”„ åˆ·æ–° ",8,Ns)]),i(p).loading?(l(),a("div",Ps,[...t[28]||(t[28]=[s("div",{class:"spinner"},null,-1),s("p",null,"è¼‰å…¥ä¸­...",-1)])])):i(p).rooms.length===0?(l(),a("div",$s,[...t[29]||(t[29]=[s("div",{class:"empty-icon"},"ðŸœï¸",-1),s("p",null,"æš«ç„¡é–‹æ”¾çš„é¬¥è±†å ´",-1),s("p",{class:"empty-hint"},"ä½ å¯ä»¥å‰µå»ºä¸€å€‹é¬¥è±†å ´é‚€è«‹åŒå­¸",-1)])])):(l(),a("ul",Ms,[(l(!0),a(E,null,R(i(p).rooms,e=>(l(),a("li",{key:e.id,class:"room-card",onClick:j=>i(y).push({name:"arena-lobby",params:{roomId:e.id}})},[s("div",Bs,[s("h4",Fs,o(e.text?.title||"æœªçŸ¥æ–‡æœ¬"),1),s("p",Ks," å±€ä¸»ï¼š"+o(e.host?.display_name||"æœªçŸ¥"),1)]),s("div",Us,[s("span",Vs," ðŸ‘¥ "+o(e.participant_count||0)+"/"+o(e.max_players),1),e.entry_fee>0?(l(),a("span",Ds," ðŸ«˜ "+o(e.entry_fee),1)):(l(),a("span",qs," å…è²» "))])],8,Xs))),128))]))])):d("",!0),u.value==="join"?(l(),a("div",Os,[s("div",Ys,[t[30]||(t[30]=s("h3",null,"è¼¸å…¥æˆ¿é–“ç¢¼",-1)),t[31]||(t[31]=s("p",{class:"join-hint"},"å‘å¥½å‹è©¢å• 6 ä½æˆ¿é–“ç¢¼",-1)),s("div",zs,[Y(s("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>g.value=e),type:"text",maxlength:"6",placeholder:"XXXXXX",class:"code-input",onKeyup:W($,["enter"])},null,544),[[z,g.value]]),s("button",{class:"btn-primary",disabled:_.value||!g.value.trim(),onClick:$},o(_.value?"åŠ å…¥ä¸­...":"åŠ å…¥é¬¥è±†å ´"),9,Ws)]),v.value?(l(),a("p",Js,o(v.value),1)):d("",!0)])])):d("",!0),u.value==="create"?(l(),a("div",Hs,[S.value?(l(),a("div",tt,[t[41]||(t[41]=s("h3",null,"å‰µå»ºä½ çš„é¬¥è±†å ´",-1)),t[42]||(t[42]=s("p",{class:"create-hint"}," é‚€è«‹åŒå­¸åŠ å…¥ï¼Œè´å–è±†å­ï¼ ",-1)),s("div",et,[t[36]||(t[36]=s("div",{class:"fee-label"},"å…¥å ´è²»é¸é …",-1)),s("div",at,[(l(!0),a(E,null,R(i(Z),e=>(l(),a("span",{key:e,class:"fee-tag"},o(e===0?"å…è²»":`${e} è±†`),1))),128))])]),s("div",ot,[t[39]||(t[39]=s("div",{class:"safety-icon"},"ðŸ›¡ï¸",-1)),s("div",lt,[t[38]||(t[38]=s("p",null,"å®‰å…¨æ©Ÿåˆ¶",-1)),s("ul",null,[s("li",null,"æ¯æ—¥å…¥å ´è²»ä¸Šé™ï¼š"+o(i(B).DAILY_FEE_LIMIT)+" è±†",1),s("li",null,"è³¬æˆ¶ä¿ç•™é¤˜é¡ï¼š"+o(i(B).MIN_BALANCE)+" è±†",1),t[37]||(t[37]=s("li",null,"æˆ¿é–“å–æ¶ˆè‡ªå‹•é€€æ¬¾",-1))])])]),s("button",{class:"btn-primary btn-large",onClick:M},[...t[40]||(t[40]=[s("span",{class:"btn-icon"},"âž•",-1),c(" å‰µå»ºé¬¥è±†å ´ ",-1)])])])):(l(),a("div",Qs,[t[33]||(t[33]=s("div",{class:"unlock-icon"},"ðŸ”’",-1)),t[34]||(t[34]=s("h3",null,"PK ç«¶æŠ€åŠŸèƒ½æœªè§£éŽ–",-1)),s("p",null,[t[32]||(t[32]=c(" é”åˆ° ",-1)),s("strong",null,"Lv."+o(C)),c("ï¼ˆ"+o(i(X)(C).title)+"ï¼‰ å³å¯å‰µå»ºè‡ªå·±çš„é¬¥è±†å ´ ",1)]),s("div",Zs,[s("div",{class:"progress-fill",style:A({width:`${Math.min(h.value/C*100,100)}%`})},null,4)]),s("p",st,"ç•¶å‰ï¼šLv."+o(h.value)+" / Lv."+o(C),1),t[35]||(t[35]=s("p",{class:"unlock-hint"}," ðŸ’¡ ä½ ä»å¯ä»¥é€šéŽæˆ¿é–“ç¢¼åŠ å…¥åŒå­¸çš„é¬¥è±†å ´ï¼Œæˆ–åƒèˆ‡è€å¸«ç™¼èµ·çš„ç­ç´šæ¯”è³½ ",-1))]))])):d("",!0)])]))])):(l(),a("div",vs,[t[12]||(t[12]=s("div",{class:"prompt-icon"},"ðŸ”",-1)),t[13]||(t[13]=s("h2",null,"è«‹å…ˆç™»å…¥",-1)),t[14]||(t[14]=s("p",null,"ç™»å…¥å¾Œå³å¯åƒèˆ‡é¬¥è±†å°æˆ°",-1)),s("button",{class:"btn-primary",onClick:t[0]||(t[0]=(...e)=>i(r).loginWithGoogle&&i(r).loginWithGoogle(...e))}," ä½¿ç”¨ Google ç™»å…¥ ")]))]))}}),ct=H(nt,[["__scopeId","data-v-0c9c2ad7"]]);export{ct as default};
