import{d as Z,u as ee,c as d,x as te,r as C,w as se,f as ae,a as r,g as a,h as i,t as u,b as _,e as q,F as I,j as P,s as A,k as ne,l as re,i as T,n as oe,m as le,o as n,_ as ue}from"./index-SMzO0Qz9.js";import{u as ie}from"./gameStore-Cm5WhxO7.js";import{u as ce}from"./userStatsStore-COhb7vFW.js";import{c as E,d as L}from"./game-DlkGF0Ko.js";import{B as U}from"./BeanIcon-Dx-YFz1d.js";import{T as de}from"./TeamBadge-Dgu0cHNC.js";const ve={class:"result-header"},me={key:0,class:"result-icon"},pe={key:1},_e={key:2},ge={class:"bean-sign"},he={key:0,class:"bean-note"},fe={key:0,class:"ranking-section"},ye={class:"ranking-list"},ke=["src","alt"],be={key:1,class:"avatar-placeholder"},we={class:"name"},Se={class:"score"},Be={class:"accuracy"},Ce={class:"time"},Ae={key:1,class:"streak-card"},Te={class:"streak-text"},Re={key:2,class:"answers-section"},xe={key:0,class:"result-tabs"},Me=["onClick"],Ie={class:"tab-number"},Pe={class:"tab-title"},ze={class:"tab-stats"},Ve={key:1,class:"answer-detail"},Fe={class:"answer-header"},Ne={key:0,class:"answer-author"},De={class:"answer-stats"},$e={class:"stat correct"},Ge={class:"stat wrong"},Oe={class:"stat missed"},qe={class:"answer-content"},Ee={class:"answer-line"},Le={class:"answer-char"},Ue={key:3,class:"ranking-section"},je={class:"team-ranking-list"},Je={class:"rank"},We={class:"team-name-group"},He={class:"team-name"},Ke={key:0,class:"team-reward-badge"},Qe={class:"team-score"},Xe=Z({__name:"GameResult",setup(Ye){const z=re(),j=te(),y=ie(),R=ee(),V=ce(),x=d(()=>j.params.roomId),l=d(()=>y.currentRoom),k=d(()=>y.myParticipant),J=d(()=>l.value?.participants||[]),F=d(()=>l.value?.teams||[]),v=C(null),M=C(0),c=d(()=>{if(!v.value)return null;const s=v.value.texts[M.value],e=v.value.results[M.value];return!s||!e?null:{text:s,result:e}});function N(s){const e=[];for(const t of s)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function D(s){if(!c.value?.result)return"none";const e=c.value.result,t=e.userBreaks.includes(s),o=e.correctBreaks.includes(s);return t&&o?"correct":t&&!o?"wrong":!t&&o?"missed":"none"}const p=d(()=>{if(!l.value||!R.user)return!1;if(l.value.game_mode==="team_battle")return k.value?.team_id===l.value.winner_team_id;{if(l.value.winner_user_id)return l.value.winner_user_id===R.user.id;if(!l.value.participants)return!1;const s=k.value?.score??0,e=k.value?.time_spent??999999,t=Math.max(...l.value.participants.map(m=>m.score)),o=l.value.participants.filter(m=>m.score===t),w=Math.min(...o.map(m=>m.time_spent??999999));return s===t&&e===w}}),g=d(()=>!l.value||l.value.game_mode==="team_battle"?!1:!l.value.winner_user_id&&p.value),W=d(()=>l.value?.participants?[...l.value.participants].sort((s,e)=>e.score-s.score).map((s,e)=>({...s,rank:e+1})):[]),H=d(()=>F.value.length?F.value.map(s=>{const e=J.value.filter(S=>S.team_id===s.id),t=e.reduce((S,B)=>S+(B.score||0),0),o=e.length>0?t/e.length:0,m=(typeof s.total_score=="number"?s.total_score/100:0)||o;return{...s,averageScore:m}}).sort((s,e)=>e.averageScore-s.averageScore):[]),$=d(()=>V.profile?.pvp_win_streak??0),G=C(!1),b=C(0),h=C(!1),f=d(()=>{if(!k.value||!l.value)return{amount:0,type:"neutral"};if(l.value.game_mode==="team_battle")return p.value?{amount:20,type:"win"}:{amount:0,type:"neutral"};const s=k.value.fee_paid||l.value.entry_fee||0,e=l.value.participants?.length||0;return g.value?{amount:0,type:"tie"}:p.value&&s>0?{amount:s*e,type:"win"}:!p.value&&s>0?{amount:-s,type:"lose"}:{amount:0,type:"neutral"}});function K(){const s=Math.abs(f.value.amount),e=f.value.type;if(s===0&&e!=="tie"){h.value=!0;return}G.value=!0,b.value=0,h.value=!1;const t=2500,o=Date.now(),w=s>0?s:100;function m(){const S=Date.now()-o,B=Math.min(S/t,1);if(B<1){if(B<.8)b.value=Math.floor(Math.random()*w*1.5);else{const O=(B-.8)/.2;b.value=Math.floor(s*O+Math.random()*(s*(1-O)))}requestAnimationFrame(m)}else b.value=s,h.value=!0}setTimeout(()=>{requestAnimationFrame(m)},500)}function Q(s){v.value&&s>=0&&s<v.value.texts.length&&(M.value=s)}function X(){y.reset(),sessionStorage.removeItem(`game-result-${x.value}`),z.push({name:"arena"})}function Y(){y.reset(),sessionStorage.removeItem(`game-result-${x.value}`),R.isTeacher?z.push({name:"arena-teacher-create"}):z.push({name:"arena-create"})}return se(()=>l.value?.status,s=>{}),ae(()=>{y.subscribeToRoom(x.value),V.fetchProfile();const s=sessionStorage.getItem(`game-result-${x.value}`);if(s)try{v.value=JSON.parse(s)}catch{}K()}),(s,e)=>(n(),r("div",{class:_(["game-result",{winner:p.value,tie:g.value}])},[a("header",ve,[g.value||p.value?(n(),r("div",me,u(g.value?"ğŸ¤":"ğŸ†"),1)):i("",!0),!g.value&&p.value?(n(),r("h1",pe,"æ­å–œç²å‹ï¼")):g.value?(n(),r("h1",_e,"å¹³å±€ï¼")):i("",!0),G.value||f.value.type!=="neutral"?(n(),r("div",{key:3,class:_(["bean-change-display",[f.value.type,{complete:h.value}]])},[a("span",ge,u(f.value.type==="lose"?"-":f.value.type==="win"?"+":""),1),a("span",{class:_(["bean-number",{rolling:!h.value}])},u(b.value),3),q(U,{size:40,class:"bean-icon-img"}),g.value&&h.value?(n(),r("span",he,"å…¥å ´è²»å·²é€€é‚„")):i("",!0)],2)):i("",!0)]),l.value?.game_mode==="pvp"?(n(),r("section",fe,[e[0]||(e[0]=a("h2",null,"æ’è¡Œæ¦œ",-1)),a("div",ye,[(n(!0),r(I,null,P(W.value,t=>(n(),r("div",{key:t.id,class:_(["ranking-item",{me:t.user_id===T(R).user?.id,top:t.rank<=3}])},[a("span",{class:_(["rank",`rank-${t.rank}`])},u(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(n(),r("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,ke)):(n(),r("span",be,u(t.user?.display_name?.charAt(0)||"?"),1)),a("span",we,u(t.user?.display_name||"æœªçŸ¥"),1),a("span",Se,u(t.score)+" åˆ†",1),a("span",Be,u(t.accuracy?.toFixed(0)||0)+"%",1),a("span",Ce,u(t.time_spent)+"s",1)],2))),128))])])):i("",!0),$.value>0&&p.value?(n(),r("div",Ae,[e[3]||(e[3]=a("span",{class:"streak-icon"},"ğŸ”¥",-1)),a("span",Te,[e[1]||(e[1]=A(" é€£å‹ ",-1)),a("strong",null,u($.value),1),e[2]||(e[2]=A(" å ´ï¼ ",-1))])])):i("",!0),v.value?(n(),r("section",Re,[e[9]||(e[9]=a("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),v.value.texts.length>1?(n(),r("div",xe,[(n(!0),r(I,null,P(v.value.texts,(t,o)=>(n(),r("button",{key:t.id,class:_(["result-tab",{active:o===M.value}]),onClick:w=>Q(o)},[a("span",Ie,u(o+1),1),a("span",Pe,u(t.title),1),a("span",ze," âœ“"+u(v.value.results[o]?.correctCount||0),1)],10,Me))),128))])):i("",!0),c.value&&c.value.text&&c.value.result?(n(),r("div",Ve,[a("div",Fe,[a("h3",null,u(c.value.text.title),1),c.value.text.author?(n(),r("span",Ne,u(c.value.text.author),1)):i("",!0)]),a("div",De,[a("span",$e,[e[4]||(e[4]=a("span",{class:"bean-legend correct"},null,-1)),A(" æ­£ç¢º "+u(c.value.result.correctCount),1)]),a("span",Ge,[e[5]||(e[5]=a("span",{class:"bean-legend wrong"},null,-1)),A(" éŒ¯èª¤ "+u(c.value.result.wrongCount),1)]),a("span",Oe,[e[6]||(e[6]=a("span",{class:"bean-legend missed"},null,-1)),A(" éºæ¼ "+u(c.value.result.missedCount),1)])]),a("div",qe,[a("div",Ee,[(n(!0),r(I,null,P(N(c.value.text.content),(t,o)=>(n(),r("span",{key:o,class:"char-unit"},[a("span",Le,u(t),1),o<N(c.value.text.content).length-1&&D(o)!=="none"?(n(),r("span",{key:0,class:_(["bean-slot",D(o)])},[...e[7]||(e[7]=[a("span",{class:"bean"},null,-1)])],2)):i("",!0)]))),128))])]),e[8]||(e[8]=ne('<div class="answer-legend" data-v-1d94b846><span class="legend-item" data-v-1d94b846><span class="bean-legend correct" data-v-1d94b846></span> æ­£ç¢º </span><span class="legend-item" data-v-1d94b846><span class="bean-legend wrong" data-v-1d94b846></span> éŒ¯èª¤ </span><span class="legend-item" data-v-1d94b846><span class="bean-legend missed" data-v-1d94b846></span> éºæ¼ </span></div>',1))])):i("",!0)])):i("",!0),l.value?.game_mode==="team_battle"?(n(),r("section",Ue,[e[11]||(e[11]=a("h2",null,"éšŠä¼æ’è¡Œ",-1)),a("div",je,[(n(!0),r(I,null,P(H.value,(t,o)=>(n(),r("div",{key:t.id,class:_(["team-ranking-item",{winner:o===0}]),style:oe({"--team-primary":T(E)[t.team_color].primary,"--team-secondary":T(E)[t.team_color].secondary})},[a("span",Je,u(o===0?"ğŸ†":o+1),1),T(L)(t)?(n(),le(de,{key:0,"product-type":T(L)(t),size:36,class:"team-badge-in-ranking"},null,8,["product-type"])):i("",!0),a("div",We,[a("span",He,u(t.team_name),1),o===0?(n(),r("div",Ke,[q(U,{size:16}),e[10]||(e[10]=a("span",null,"æ¯ä½æˆå“¡ +20 è±†",-1))])):i("",!0)]),a("span",Qe,u(t.averageScore.toFixed(2))+" åˆ†",1)],6))),128))])])):i("",!0),a("footer",{class:"result-footer"},[a("button",{class:"btn-secondary",onClick:X}," è¿”å›é¬¥è±† "),a("button",{class:"btn-primary",onClick:Y}," å†ä¾†ä¸€å±€ ")])],2))}}),rt=ue(Xe,[["__scopeId","data-v-1d94b846"]]);export{rt as default};
