import{y as j,u as G,r as d,c as R,N as n}from"./index-DUA57efl.js";const f=[0,30,100,200,350,550,850,1300,2e3,3e3],V=10,w=5,m=10,Z=j("userStats",()=>{const l=G(),t=d(null),k=d(!1),h=d(null),y=d([]),p=d("total"),g=d(!1),D=d(null),x=R(()=>{if(!t.value)return 1;const e=t.value.total_beans;for(let a=f.length-1;a>=0;a--){const r=f[a];if(r!==void 0&&e>=r)return a+1}return 1}),q=R(()=>{if(!t.value)return 0;const e=x.value,a=f[e-1]||0,r=f[e]||a+1e3,o=t.value.total_beans-a,s=r-a;return Math.min(100,Math.round(o/s*100))}),N=R(()=>{if(!t.value)return 30;const e=x.value;if(e>=f.length)return 0;const a=f[e]||3e3;return Math.max(0,a-t.value.total_beans)});function A(e){const{correctCount:a,totalBreaks:r,charCount:o,elapsedSeconds:s}=e,i=a,c=a===r;let _=0;if(c&&a>0){const S=o*3,b=Math.max(0,S-s);_=Math.floor(b/V)}return{score:i+_,breakdown:{baseScore:i,speedBonus:_,isAllCorrect:c,elapsedSeconds:s,baseTime:o*3}}}async function E(){if(!(!n||!l.user)){k.value=!0,h.value=null;try{const{data:e,error:a}=await n.from("profiles").select("*").eq("id",l.user.id).single();if(a){if(a.code==="PGRST116"){console.log("ç”¨æˆ¶ Profile ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º..."),await B();return}throw a}t.value=e,await I()}catch(e){h.value=e.message,console.error("ç²å–ç”¨æˆ¶ Profile å¤±æ•—:",e)}finally{k.value=!1}}}async function B(){if(!(!n||!l.user))try{const{data:e}=await n.from("users").select("display_name, email").eq("id",l.user.id).single(),a=e?.display_name||l.user.email?.split("@")[0]||"è±†å‹",r=a.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),{data:o,error:s}=await n.from("profiles").insert({id:l.user.id,username:r+"_"+Date.now().toString(36),display_name:a,total_beans:0,weekly_beans:0,monthly_beans:0,streak_days:0,max_streak:0,daily_login_claimed:!1,daily_first_claimed:!1}).select().single();if(s){console.error("å‰µå»º Profile å¤±æ•—:",s);return}t.value=o,console.log("âœ… Profile å‰µå»ºæˆåŠŸ"),await I()}catch(e){console.error("å‰µå»ºåˆå§‹ Profile å¤±æ•—:",e)}}async function I(){if(!n||!t.value||!l.user)return!1;const e=new Date().toISOString().split("T")[0],a=t.value.last_login_date;if(a===e&&t.value.daily_login_claimed)return!1;try{const r=t.value.total_beans+w,o={last_login_date:e,daily_login_claimed:!0,total_beans:r,weekly_beans:t.value.weekly_beans+w,monthly_beans:t.value.monthly_beans+w,updated_at:new Date().toISOString()};a!==e&&(o.daily_first_claimed=!1);const{error:s}=await n.from("profiles").update(o).eq("id",l.user.id);if(s)throw s;return await n.from("game_transactions").insert({user_id:l.user.id,type:"daily_login",amount:w,balance_after:r,description:"æ¯æ—¥ç™»å…¥çå‹µ"}),Object.assign(t.value,o),console.log(`ğŸ æ¯æ—¥ç™»å…¥çå‹µ +${w} è±†`),!0}catch(r){return console.error("ç™¼æ”¾æ¯æ—¥ç™»å…¥çå‹µå¤±æ•—:",r),!1}}async function P(){if(!n||!t.value||!l.user||t.value.daily_first_claimed)return 0;try{const e=t.value.total_beans+m,a={daily_first_claimed:!0,total_beans:e,weekly_beans:t.value.weekly_beans+m,monthly_beans:t.value.monthly_beans+m,updated_at:new Date().toISOString()},{error:r}=await n.from("profiles").update(a).eq("id",l.user.id);if(r)throw r;return await n.from("game_transactions").insert({user_id:l.user.id,type:"daily_first",amount:m,balance_after:e,description:"æ¯æ—¥é¦–ç·´çå‹µ"}),Object.assign(t.value,a),console.log(`ğŸ æ¯æ—¥é¦–ç·´çå‹µ +${m} è±†`),m}catch(e){return console.error("ç™¼æ”¾æ¯æ—¥é¦–ç·´çå‹µå¤±æ•—:",e),0}}async function O(){if(!n||!t.value||!l.user)return;const e=new Date().toISOString().split("T")[0],a=t.value.last_practice_date;let r=t.value.streak_days;if(!a)r=1;else{const s=new Date(a),i=new Date(e),c=Math.floor((i.getTime()-s.getTime())/(1e3*60*60*24));if(c===0)return;c===1?r=t.value.streak_days+1:r=1}const o=Math.max(t.value.max_streak,r);try{const{error:s}=await n.from("profiles").update({streak_days:r,max_streak:o,last_practice_date:e,updated_at:new Date().toISOString()}).eq("id",l.user.id);if(s)throw s;t.value.streak_days=r,t.value.max_streak=o,t.value.last_practice_date=e}catch(s){console.error("æ›´æ–°é€£çºŒå¤©æ•¸å¤±æ•—:",s)}}async function M(e){if(!n||!l.user)return!1;try{const{data:a}=await n.from("user_text_scores").select("id").eq("user_id",l.user.id).eq("text_id",e).maybeSingle();return!a}catch{return!1}}async function $(e){if(!n||!t.value||!l.user)return{beansEarned:0,isNewRecord:!1};const{textId:a,score:r,textTitle:o}=e;try{const{data:s}=await n.from("user_text_scores").select("*").eq("user_id",l.user.id).eq("text_id",a).maybeSingle();let i=0,c=!1;if(!s)await n.from("user_text_scores").insert({user_id:l.user.id,text_id:a,best_score:r,weekly_best:r,monthly_best:r,first_clear_at:new Date().toISOString(),attempt_count:1}),i=r,c=!0;else{const u={attempt_count:s.attempt_count+1,updated_at:new Date().toISOString()};r>s.best_score&&(i=r-s.best_score,u.best_score=r,c=!0),r>s.weekly_best&&(u.weekly_best=r),r>s.monthly_best&&(u.monthly_best=r),await n.from("user_text_scores").update(u).eq("id",s.id)}if(i>0){const u=t.value.total_beans+i,{error:S}=await n.from("profiles").update({total_beans:u,weekly_beans:t.value.weekly_beans+i,monthly_beans:t.value.monthly_beans+i,updated_at:new Date().toISOString()}).eq("id",l.user.id);if(!S){t.value.total_beans+=i,t.value.weekly_beans+=i,t.value.monthly_beans+=i;const b=o?`ç·´ç¿’ã€Š${o}ã€‹${c?"ï¼ˆæ–°ç´€éŒ„ï¼‰":""}ç²å¾— ${i} è±†`:`ç·´ç¿’ç²å¾— ${i} è±†`;await n.from("game_transactions").insert({user_id:l.user.id,type:"practice_reward",amount:i,balance_after:u,description:b,text_id:a})}}await O();const _=await P();return i+=_,C(),{beansEarned:i,isNewRecord:c}}catch(s){return console.error("è¨˜éŒ„ç·´ç¿’åˆ†æ•¸å¤±æ•—:",s),{beansEarned:0,isNewRecord:!1}}}const T=d({}),U=3e4;async function L(e="total",a=!1){if(!n)return;const r=T.value[e];if(!a&&r&&Date.now()-r.timestamp<U){y.value=r.data,p.value=e;return}g.value=!0,p.value=e;try{const o=e==="weekly"?"weekly_beans":e==="monthly"?"monthly_beans":"total_beans",s=l.user?.id,i=t.value?.[o==="weekly_beans"?"weekly_beans":o==="monthly_beans"?"monthly_beans":"total_beans"]||0,[c,_,u]=await Promise.all([n.from("profiles").select("id, display_name, total_beans, weekly_beans, monthly_beans").order(o,{ascending:!1}).limit(10),s?n.from("profiles").select("*",{count:"exact",head:!0}).gt(o,i):Promise.resolve({count:0}),s?n.from("profiles").select("*",{count:"exact",head:!0}):Promise.resolve({count:0})]);if(c.error)throw c.error;const b=(c.data||[]).map((v,H)=>({rank:H+1,userId:v.id,name:v.display_name||"åŒ¿å",beans:e==="weekly"?v.weekly_beans:e==="monthly"?v.monthly_beans:v.total_beans,isCurrentUser:v.id===s}));y.value=b,T.value[e]={data:b,timestamp:Date.now()},s&&(D.value={rank:(_.count||0)+1,totalUsers:u.count||0})}catch(o){console.error("ç²å–æ’è¡Œæ¦œå¤±æ•—:",o),y.value=[]}finally{g.value=!1}}function C(){T.value={}}function F(){t.value=null,y.value=[],D.value=null,h.value=null}return{profile:t,stats:t,loading:k,error:h,leaderboard:y,top10:y,leaderboardType:p,leaderboardLoading:g,top10Loading:g,rankInfo:D,level:x,levelProgress:q,beansToNextLevel:N,calculateScore:A,fetchProfile:E,fetchStats:E,fetchLeaderboard:L,fetchTop10:()=>L("total"),fetchRankInfo:()=>L(p.value),checkFirstClear:M,recordPracticeScore:$,checkDailyLoginReward:I,checkDailyFirstPracticeReward:P,updateStreakDays:O,clearLeaderboardCache:C,reset:F,DAILY_LOGIN_REWARD:w,DAILY_FIRST_PRACTICE_REWARD:m,LEVEL_THRESHOLDS:f}});export{Z as u};
