import{v as D,u as P,r as y,c as _}from"./index-DXmsBeDZ.js";import{u as F}from"./useSupabase-DIWmAywR.js";const U=/[。！？；，：]/g,k=/[「」『』“”"']/g,O=/\|{2,}/g;function L(r){if(!r)return"";const c=r.replace(k,"").replace(U,"|").replace(O,"|").trim();return c.endsWith("|")?c.slice(0,-1):c}function q(r){const t=r.replace(/\|/g,"").length;return t<=70?1:t<=150?2:3}function B(r){return r.replace(/\|/g,"").length}const X=D("texts",()=>{const r=F(),t=P(),l=y([]),c=y(!1),m=y(null),E=_(()=>[...l.value].sort((n,i)=>(i.created_at??"").localeCompare(n.created_at??"")));async function p(){if(!r){m.value="Supabase 尚未配置";return}c.value=!0,m.value=null;try{const{data:n,error:i}=await r.from("practice_texts").select(`
          *,
          category:practice_categories (
            id,
            name,
            slug,
            level,
            parent_id
          )
        `).order("created_at",{ascending:!1});if(i)throw i;l.value=n||[]}catch(n){m.value=n.message??"無法載入文章"}finally{c.value=!1}}async function I(n,i=!1){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const s=L(n.content),u=q(s),h=B(s);if(i&&!t.isAdmin)throw new Error("只有管理員可以創建系統文章");if(!i&&!t.isTeacher)throw new Error("只有老師可以創建私有文章");const{data:w,error:v}=await r.from("practice_texts").insert({title:n.title,author:n.author??null,source:n.source??null,summary:n.summary??null,category_id:n.category_id||null,content:s,difficulty:u,word_count:h,is_system:i,created_by:i?null:t.user.id}).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(v)throw v;w&&l.value.unshift(w)}async function T(n,i){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const{data:s}=await r.from("practice_texts").select("is_system, created_by").eq("id",n).single();if(s){if(s.is_system&&!t.isAdmin)throw new Error("只有管理員可以更新系統文章");if(!s.is_system&&s.created_by!==t.user.id)throw new Error("只能更新自己創建的文章")}const u=L(i.content),h=q(u),w=B(u),{data:v,error:x}=await r.from("practice_texts").update({title:i.title,author:i.author??null,source:i.source??null,summary:i.summary??null,category_id:i.category_id||null,content:u,difficulty:h,word_count:w}).eq("id",n).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(x)throw x;v&&(l.value=l.value.map(e=>e.id===n?v:e))}async function b(n){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const{data:i}=await r.from("practice_texts").select("is_system, created_by").eq("id",n).single();if(i){if(i.is_system&&!t.isAdmin)throw new Error("只有管理員可以刪除系統文章");if(!i.is_system&&i.created_by!==t.user.id)throw new Error("只能刪除自己創建的文章")}const{error:s}=await r.from("practice_texts").delete().eq("id",n);if(s)throw s;l.value=l.value.filter(u=>u.id!==n)}async function S(n){if(!r)return null;const i=n.username??"anonymous_user",s=n.display_name??"匿名學員",{data:u,error:h}=await r.from("practice_records").insert({...n,username:i,display_name:s}).select("id").single();return h?(console.error("記錄練習結果失敗:",h),null):u?.id||null}function C(){if(!l.value.length)return null;const n=Math.floor(Math.random()*l.value.length);return l.value[n]}return{texts:l,sortedTexts:E,isLoading:c,error:m,fetchTexts:p,addText:I,updateText:T,deleteText:b,recordPracticeResult:S,getRandomText:C}}),R=[{id:"grade-7",name:"七年級",slug:"grade-7",parent_id:null,level:1,type:"grade",description:"適合初階練習者，聚焦於啟蒙經典與日常應用題材。",order_index:1},{id:"grade-7-module-lunyu",name:"論語讀本",slug:"grade-7-module-lunyu",parent_id:"grade-7",level:2,type:"module",description:"以語錄題材培養句型感與節奏感。",order_index:1},{id:"grade-7-theme-renyi",name:"仁義篇",slug:"grade-7-theme-renyi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"圍繞「仁」與「義」的章句，適合練習短句斷讀。",order_index:1},{id:"grade-7-theme-xuexi",name:"學習篇",slug:"grade-7-theme-xuexi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"關於求學與修身的篇章，句式多變。",order_index:2},{id:"anthology-guwenguan-zhi",name:"古文觀止",slug:"anthology-guwenguan-zhi",parent_id:null,level:1,type:"grade",description:"以主題式選編進行高階訓練。",order_index:2},{id:"anthology-guwenguan-zhi-warring",name:"戰國策",slug:"anthology-guwenguan-zhi-warring",parent_id:"anthology-guwenguan-zhi",level:2,type:"module",description:"戰國時期縱橫家精彩篇章，節奏快速。",order_index:1},{id:"anthology-guwenguan-zhi-warring-theme",name:"遊說名篇",slug:"anthology-guwenguan-zhi-warring-theme",parent_id:"anthology-guwenguan-zhi-warring",level:3,type:"theme",description:"以遊說篇章作為高階斷句挑戰。",order_index:1}],Q=[{id:"text-renyi-01",title:"論語・學而篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:1,summary:"子曰：「弟子入則孝...」",word_count:86,content:"子曰|弟子入則孝||出則弟|信而好|犯而不|怨..."},{id:"text-renyi-02",title:"論語・里仁篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:2,summary:"里仁為美，擇其善者而從之。",word_count:120,content:"子曰|里仁為美|擇不處仁|焉得知||仁者安仁|知者利仁"},{id:"text-xuexi-01",title:"論語・為政篇",author:"孔子及弟子",category_id:"grade-7-theme-xuexi",difficulty:2,summary:"溫故而知新，可以為師矣。",word_count:95,content:"子曰|溫故而知新|可以為師矣|學而不思則罔|思而不學則殆"},{id:"text-warring-01",title:"蘇秦說齊王",author:"蘇秦",category_id:"anthology-guwenguan-zhi-warring-theme",difficulty:3,summary:"以合縱策略說服齊王，語勢跌宕。",word_count:260,content:"蘇秦曰|大王處東海之濱|南有江淮之饒|北有燕代之利|..."}];function $(r){return r.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-\u4e00-\u9fa5]/g,"").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||`category-${Date.now()}`}const j=D("practice-library",()=>{const r=F(),t=y({categories:[],texts:[],selectedGradeId:null,selectedModuleId:null,selectedThemeId:null,selectedTextId:null}),l=y(!1),c=y(null);function m(){t.value.categories=[...R],t.value.texts=[...Q],t.value.selectedGradeId=t.value.selectedGradeId??R.find(e=>e.level===1)?.id??null}async function E(){l.value=!0,c.value=null;try{if(!r){m();return}const{data:e,error:a}=await r.from("practice_categories").select("*").order("level",{ascending:!0}).order("order_index",{ascending:!0});if(a)throw a;if(!e?.length){m();return}const{data:o,error:d}=await r.from("practice_texts").select("*").order("title",{ascending:!0});if(d)throw d;t.value.categories=e,t.value.texts=o||[],t.value.selectedGradeId=t.value.selectedGradeId??t.value.categories.find(f=>f.level===1)?.id??null}catch(e){console.error("Failed to load practice library",e),c.value=e?.message??"無法載入練習庫",m()}finally{l.value=!1}}function p(e){e==="grade"&&(t.value.selectedModuleId=null,t.value.selectedThemeId=null),e!=="theme"&&(t.value.selectedTextId=null),e==="module"&&(t.value.selectedThemeId=null)}const I=_(()=>[...t.value.categories].sort((e,a)=>e.level===a.level?e.order_index-a.order_index:e.level-a.level)),T=_(()=>I.value.filter(e=>e.level===1)),b=_(()=>t.value.categories.filter(e=>e.parent_id===t.value.selectedGradeId)),S=_(()=>t.value.categories.filter(e=>e.parent_id===t.value.selectedModuleId)),C=_(()=>{const e=t.value.selectedThemeId??t.value.selectedModuleId??t.value.selectedGradeId;return e?t.value.texts.filter(a=>a.category_id===e):[]}),n=_(()=>t.value.texts.find(e=>e.id===t.value.selectedTextId)??null);function i(e){t.value.selectedGradeId!==e&&(t.value.selectedGradeId=e,p("grade"))}function s(e){t.value.selectedModuleId!==e&&(t.value.selectedModuleId=e,p("module"))}function u(e){t.value.selectedThemeId!==e&&(t.value.selectedThemeId=e,p("theme"))}function h(e){t.value.selectedTextId=e}async function w(e,a){if(!r)throw new Error("Supabase 尚未配置");const o=e.parent_id?t.value.categories.find(K=>K.id===e.parent_id):null;if(e.type!=="grade"&&!o)throw new Error("請選擇上層分類");if(o&&o.level>=3)throw new Error("目前僅支援三級分類");const d=o?o.level+1:1,f=e.type??(o?o.level===1?"module":"theme":"grade"),g=e.is_system??!0,z=g?null:a;let G=$(e.name);!g&&a&&(G=`${G}-${a.slice(0,8)}`);const{data:A,error:M}=await r.from("practice_categories").insert({name:e.name,slug:G,parent_id:e.parent_id,level:d,type:f,description:e.description??null,order_index:e.order_index??0,is_system:g,created_by:z}).select("*").single();if(M)throw M;return A&&t.value.categories.push(A),A}async function v(e,a){if(!r)throw new Error("Supabase 尚未配置");const o={};a.name!==void 0&&(o.name=a.name,o.slug=$(a.name)),a.description!==void 0&&(o.description=a.description),a.order_index!==void 0&&(o.order_index=a.order_index);const{data:d,error:f}=await r.from("practice_categories").update(o).eq("id",e).select("*").single();if(f)throw f;if(d){const g=t.value.categories.findIndex(z=>z.id===e);g!==-1&&(t.value.categories[g]=d)}return d}async function x(e){if(!r)throw new Error("Supabase 尚未配置");if(t.value.categories.some(g=>g.parent_id===e))throw new Error("此分類下還有子分類，請先刪除子分類");const{count:o,error:d}=await r.from("practice_texts").select("id",{count:"exact",head:!0}).eq("category_id",e);if(d)throw d;if(o&&o>0)throw new Error(`此分類下還有 ${o} 篇文章，請先移除或重新分類`);const{error:f}=await r.from("practice_categories").delete().eq("id",e);if(f)throw f;t.value.categories=t.value.categories.filter(g=>g.id!==e),t.value.selectedGradeId===e&&(t.value.selectedGradeId=null),t.value.selectedModuleId===e&&(t.value.selectedModuleId=null),t.value.selectedThemeId===e&&(t.value.selectedThemeId=null)}return{state:t,isLoading:l,error:c,rootCategories:T,modules:b,themes:S,visibleTexts:C,selectedText:n,fetchLibrary:E,selectGrade:i,selectModule:s,selectTheme:u,selectText:h,addCategory:w,updateCategory:v,deleteCategory:x}});export{j as a,X as u};
