import{d as X,u as Y,c,q as Z,r as w,w as ee,o as te,a as o,b as t,e as d,t as n,n as p,F as x,g as M,m as S,h as se,j as L,i as ae,f as V,s as u,_ as ne}from"./index-CTD8rdEU.js";import{u as re,g as le,c as O}from"./gameStore-ez44c0cs.js";import{u as oe}from"./userStatsStore-DZBifqLI.js";const ue={class:"result-header"},ie={class:"result-icon"},ce={class:"bean-sign"},ve={key:0,class:"bean-note"},de={key:0,class:"ranking-section"},me={class:"ranking-list"},pe=["src","alt"],_e={key:1,class:"avatar-placeholder"},fe={class:"name"},ge={class:"score"},he={class:"accuracy"},ke={class:"time"},ye={key:1,class:"streak-card"},be={class:"streak-text"},we={key:2,class:"answers-section"},Se={key:0,class:"result-tabs"},Ce=["onClick"],Be={class:"tab-number"},Re={class:"tab-title"},Te={class:"tab-stats"},xe={key:1,class:"answer-detail"},Me={class:"answer-header"},Ae={key:0,class:"answer-author"},Ie={class:"answer-stats"},Pe={class:"stat correct"},Ve={class:"stat wrong"},De={class:"stat missed"},Fe={class:"answer-content"},Ne={class:"answer-line"},$e={class:"answer-char"},ze={key:3,class:"ranking-section"},qe={class:"team-ranking-list"},Ge={class:"rank"},Le={class:"team-name"},Oe={class:"team-score"},Ee={class:"rank-title-section"},Ue={class:"level-text"},je=X({__name:"GameResult",setup(Je){const A=ae(),E=Z(),h=re(),C=Y(),I=oe(),B=c(()=>E.params.roomId),r=c(()=>h.currentRoom),k=c(()=>h.myParticipant),v=w(null),R=w(0),i=c(()=>{if(!v.value)return null;const a=v.value.texts[R.value],e=v.value.results[R.value];return!a||!e?null:{text:a,result:e}});function D(a){const e=[];for(const s of a)s!=="|"&&s!==`
`&&s!=="\r"&&e.push(s);return e}function F(a){if(!i.value?.result)return"none";const e=i.value.result,s=e.userBreaks.includes(a),l=e.correctBreaks.includes(a);return s&&l?"correct":s&&!l?"wrong":!s&&l?"missed":"none"}const _=c(()=>{if(!r.value||!C.user)return!1;if(r.value.game_mode==="team_battle")return k.value?.team_id===r.value.winner_team_id;{if(r.value.winner_user_id)return r.value.winner_user_id===C.user.id;if(!r.value.participants)return!1;const a=k.value?.score??0,e=k.value?.time_spent??999999,s=Math.max(...r.value.participants.map(m=>m.score)),l=r.value.participants.filter(m=>m.score===s),T=Math.min(...l.map(m=>m.time_spent??999999));return a===s&&e===T}}),y=c(()=>!r.value||r.value.game_mode==="team_battle"?!1:!r.value.winner_user_id&&_.value),U=c(()=>r.value?.participants?[...r.value.participants].sort((a,e)=>e.score-a.score).map((a,e)=>({...a,rank:e+1})):[]),j=c(()=>r.value?.teams?[...r.value.teams].sort((a,e)=>e.total_score-a.total_score):[]),N=c(()=>I.level),$=c(()=>le(N.value)),z=c(()=>I.profile?.pvp_win_streak??0),q=w(!1),b=w(0),f=w(!1),g=c(()=>{if(!k.value||!r.value)return{amount:0,type:"neutral"};const a=k.value.fee_paid||r.value.entry_fee||0,e=r.value.participants?.length||0;return y.value?{amount:0,type:"tie"}:_.value&&a>0?{amount:a*e,type:"win"}:!_.value&&a>0?{amount:-a,type:"lose"}:{amount:0,type:"neutral"}});function J(){const a=Math.abs(g.value.amount),e=g.value.type;if(a===0&&e!=="tie"){f.value=!0;return}q.value=!0,b.value=0,f.value=!1;const s=2500,l=Date.now(),T=a>0?a:100;function m(){const Q=Date.now()-l,P=Math.min(Q/s,1);if(P<1){if(P<.8)b.value=Math.floor(Math.random()*T*1.5);else{const G=(P-.8)/.2;b.value=Math.floor(a*G+Math.random()*(a*(1-G)))}requestAnimationFrame(m)}else b.value=a,f.value=!0}setTimeout(()=>{requestAnimationFrame(m)},500)}function W(a){v.value&&a>=0&&a<v.value.texts.length&&(R.value=a)}function H(){h.reset(),sessionStorage.removeItem(`game-result-${B.value}`),A.push({name:"arena"})}function K(){h.reset(),sessionStorage.removeItem(`game-result-${B.value}`),C.isTeacher?A.push({name:"arena-teacher-create"}):A.push({name:"arena-create"})}return ee(()=>r.value?.status,a=>{}),te(()=>{h.subscribeToRoom(B.value),I.fetchProfile();const a=sessionStorage.getItem(`game-result-${B.value}`);if(a)try{v.value=JSON.parse(a)}catch{}J()}),(a,e)=>(u(),o("div",{class:p(["game-result",{winner:_.value,tie:y.value}])},[t("header",ue,[t("div",ie,n(y.value?"ğŸ¤":_.value?"ğŸ†":"ğŸ’ª"),1),t("h1",null,n(y.value?"å¹³å±€ï¼":_.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),q.value||g.value.type!=="neutral"?(u(),o("div",{key:0,class:p(["bean-change-display",[g.value.type,{complete:f.value}]])},[t("span",ce,n(g.value.type==="lose"?"-":g.value.type==="win"?"+":""),1),t("span",{class:p(["bean-number",{rolling:!f.value}])},n(b.value),3),e[0]||(e[0]=t("span",{class:"bean-icon"},"ğŸ«˜",-1)),y.value&&f.value?(u(),o("span",ve,"å…¥å ´è²»å·²é€€é‚„")):d("",!0)],2)):d("",!0)]),r.value?.game_mode==="pvp"?(u(),o("section",de,[e[1]||(e[1]=t("h2",null,"æ’è¡Œæ¦œ",-1)),t("div",me,[(u(!0),o(x,null,M(U.value,s=>(u(),o("div",{key:s.id,class:p(["ranking-item",{me:s.user_id===V(C).user?.id,top:s.rank<=3}])},[t("span",{class:p(["rank",`rank-${s.rank}`])},n(s.rank===1?"ğŸ¥‡":s.rank===2?"ğŸ¥ˆ":s.rank===3?"ğŸ¥‰":s.rank),3),s.user?.avatar_url?(u(),o("img",{key:0,src:s.user.avatar_url,alt:s.user.display_name,class:"avatar"},null,8,pe)):(u(),o("span",_e,n(s.user?.display_name?.charAt(0)||"?"),1)),t("span",fe,n(s.user?.display_name||"æœªçŸ¥"),1),t("span",ge,n(s.score)+" åˆ†",1),t("span",he,n(s.accuracy?.toFixed(0)||0)+"%",1),t("span",ke,n(s.time_spent)+"s",1)],2))),128))])])):d("",!0),z.value>0&&_.value?(u(),o("div",ye,[e[4]||(e[4]=t("span",{class:"streak-icon"},"ğŸ”¥",-1)),t("span",be,[e[2]||(e[2]=S(" é€£å‹ ",-1)),t("strong",null,n(z.value),1),e[3]||(e[3]=S(" å ´ï¼ ",-1))])])):d("",!0),v.value?(u(),o("section",we,[e[10]||(e[10]=t("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),v.value.texts.length>1?(u(),o("div",Se,[(u(!0),o(x,null,M(v.value.texts,(s,l)=>(u(),o("button",{key:s.id,class:p(["result-tab",{active:l===R.value}]),onClick:T=>W(l)},[t("span",Be,n(l+1),1),t("span",Re,n(s.title),1),t("span",Te," âœ“"+n(v.value.results[l]?.correctCount||0),1)],10,Ce))),128))])):d("",!0),i.value&&i.value.text&&i.value.result?(u(),o("div",xe,[t("div",Me,[t("h3",null,n(i.value.text.title),1),i.value.text.author?(u(),o("span",Ae,n(i.value.text.author),1)):d("",!0)]),t("div",Ie,[t("span",Pe,[e[5]||(e[5]=t("span",{class:"bean-legend correct"},null,-1)),S(" æ­£ç¢º "+n(i.value.result.correctCount),1)]),t("span",Ve,[e[6]||(e[6]=t("span",{class:"bean-legend wrong"},null,-1)),S(" éŒ¯èª¤ "+n(i.value.result.wrongCount),1)]),t("span",De,[e[7]||(e[7]=t("span",{class:"bean-legend missed"},null,-1)),S(" éºæ¼ "+n(i.value.result.missedCount),1)])]),t("div",Fe,[t("div",Ne,[(u(!0),o(x,null,M(D(i.value.text.content),(s,l)=>(u(),o("span",{key:l,class:"char-unit"},[t("span",$e,n(s),1),l<D(i.value.text.content).length-1&&F(l)!=="none"?(u(),o("span",{key:0,class:p(["bean-slot",F(l)])},[...e[8]||(e[8]=[t("span",{class:"bean"},null,-1)])],2)):d("",!0)]))),128))])]),e[9]||(e[9]=se('<div class="answer-legend" data-v-f386ecd1><span class="legend-item" data-v-f386ecd1><span class="bean-legend correct" data-v-f386ecd1></span> æ­£ç¢º </span><span class="legend-item" data-v-f386ecd1><span class="bean-legend wrong" data-v-f386ecd1></span> éŒ¯èª¤ </span><span class="legend-item" data-v-f386ecd1><span class="bean-legend missed" data-v-f386ecd1></span> éºæ¼ </span></div>',1))])):d("",!0)])):d("",!0),r.value?.game_mode==="team_battle"?(u(),o("section",ze,[e[11]||(e[11]=t("h2",null,"éšŠä¼æ’è¡Œ",-1)),t("div",qe,[(u(!0),o(x,null,M(j.value,(s,l)=>(u(),o("div",{key:s.id,class:p(["team-ranking-item",{winner:l===0}]),style:L({"--team-primary":V(O)[s.team_color].primary,"--team-secondary":V(O)[s.team_color].secondary})},[t("span",Ge,n(l===0?"ğŸ†":l+1),1),t("span",Le,n(s.team_name),1),t("span",Oe,n(s.total_score)+" åˆ†",1)],6))),128))])])):d("",!0),t("section",Ee,[e[12]||(e[12]=t("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),t("div",{class:"rank-title-display",style:L({color:$.value.color})},n($.value.title),5),t("p",Ue,"Lv."+n(N.value),1)]),t("footer",{class:"result-footer"},[t("button",{class:"btn-secondary",onClick:H}," è¿”å›é¬¥è±† "),t("button",{class:"btn-primary",onClick:K}," å†ä¾†ä¸€å±€ ")])],2))}}),Qe=ne(je,[["__scopeId","data-v-f386ecd1"]]);export{Qe as default};
