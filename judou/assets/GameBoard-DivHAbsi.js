import{d as Z,c as i,x as P,r as j,w as U,f as ee,R as te,a as l,g as e,h as d,t as n,b as g,e as se,n as $,m as z,s as ae,i as m,F as y,j as k,l as oe,o,_ as ne}from"./index-58xMK0we.js";import{u as le}from"./gameStore-CP5rP7Bc.js";import{d as f,c as w}from"./game-DlkGF0Ko.js";import{T as F}from"./TeamBadge-Bi2iT5zQ.js";import{R as re}from"./RaceTrack-UAGyafOU.js";import"./userStatsStore-B8CxTXvd.js";const ie={class:"board-header"},ce={class:"header-left"},de={class:"text-info"},ue={key:0},me={class:"header-center"},ve={class:"countdown-label"},_e={class:"countdown-time"},pe={class:"header-right"},he={class:"progress-info"},ge={class:"progress-value"},ye={key:0,class:"team-progress-section"},fe={class:"time-progress-container"},ke={class:"time-progress-header"},be={class:"time-progress-text"},Te={class:"time-progress-bar"},Ce={class:"stats-panel"},Se={class:"stat-card"},we={class:"stat-content"},xe={class:"stat-value"},Me={class:"stat-detail"},Be={key:0,class:"stat-card"},De={class:"stat-content"},Ae={class:"stat-value"},Re={class:"stat-card"},Ie={class:"stat-content"},$e={class:"stat-value"},ze={key:1,class:"stat-card"},Fe={class:"stat-content"},Ge={class:"stat-value"},Ne={class:"stat-detail"},Ve={key:1,class:"board-sidebar"},Ee={class:"top-scores-panel"},Le={class:"top-scores-list"},Oe={class:"rank-badge"},je=["src","alt"],Ue={key:1,class:"top-score-avatar-placeholder"},qe={class:"top-score-info"},He={class:"top-score-name"},Je={class:"top-score-value"},Ke={key:0,class:"no-scores"},Qe={class:"activity-stream-panel"},We={class:"activity-stream-list"},Xe=["src","alt"],Ye={key:1,class:"activity-avatar-placeholder"},Ze={class:"activity-content"},Pe={class:"activity-text"},et={key:0},tt={key:1},st={key:0,class:"no-activity"},at={key:2,class:"finish-overlay"},ot={class:"finish-content"},nt={class:"final-ranking"},lt={class:"rank"},rt={class:"team-name"},it={class:"team-members"},ct={class:"team-avg-score"},dt={key:3,class:"board-main"},ut={class:"board-main-content"},mt={key:0,class:"recent-completions"},vt={class:"completions-list"},_t=["src","alt"],pt={key:1,class:"completion-avatar-placeholder"},ht={class:"completion-info"},gt={class:"completion-name"},yt={class:"completion-score"},ft={class:"teams-battle"},kt={class:"team-title"},bt={class:"team-name-row"},Tt={class:"team-progress"},Ct={class:"team-score"},St={class:"score-value"},wt={class:"members-list"},xt={class:"member-info"},Mt=["src","alt"],Bt={key:1,class:"avatar-placeholder"},Dt={class:"member-name"},At={class:"member-status"},Rt={class:"score"},It={class:"accuracy"},$t={key:1,class:"status-badge playing"},zt={key:2,class:"status-badge waiting"},Ft=Z({__name:"GameBoard",setup(Gt){const q=oe(),H=P(),b=le(),J=i(()=>H.params.roomId),c=i(()=>b.currentRoom),G=i(()=>c.value?.teams||[]),u=i(()=>c.value?.participants||[]),x=j(0);let _=null;const p=i(()=>c.value?.status==="finished"),T=i(()=>G.value.map(a=>{const s=u.value.filter(v=>v.team_id===a.id),t=s.filter(v=>v.status==="completed"),r=s.reduce((v,I)=>v+(I.score||0),0),S=s.length>0?r/s.length:0;return{team:a,memberCount:s.length,completedCount:t.length,averageScore:S}})),M=i(()=>[...T.value].sort((a,s)=>s.averageScore-a.averageScore)),K=i(()=>{const a={};for(const s of G.value)a[s.id]=u.value.filter(t=>t.team_id===s.id).sort((t,r)=>r.score-t.score);return a}),B=i(()=>u.value.filter(a=>a.status==="completed").length),D=i(()=>u.value.length),Q=i(()=>D.value===0?0:Math.round(B.value/D.value*100)),N=i(()=>T.value.length?T.value.map(a=>{const s=f(a.team),t=M.value.findIndex(r=>r.team.id===a.team.id)+1;return{id:a.team.id,team:a.team,displayAvg:a.averageScore,rank:t,productType:s,isMyTeam:!1,name:a.team.team_name,memberCount:a.memberCount,completedCount:a.completedCount}}):[]),A=i(()=>{const a=u.value.filter(v=>v.status==="completed"&&v.time_spent);if(a.length===0)return null;const t=a.reduce((v,I)=>v+(I.time_spent||0),0)/a.length,r=Math.floor(t/60),S=Math.floor(t%60);return{minutes:r,seconds:S}}),W=i(()=>u.value.length===0?0:Math.max(...u.value.map(a=>a.score||0),0)),V=i(()=>u.value.filter(a=>a.status==="completed"&&a.completed_at).sort((a,s)=>{const t=new Date(a.completed_at).getTime();return new Date(s.completed_at).getTime()-t}).slice(0,5)),C=i(()=>T.value.length===0?null:T.value.reduce((a,s)=>s.completedCount>a.completedCount?s:a)),R=i(()=>{if(!c.value?.started_at||!c.value?.time_limit)return 0;const a=new Date(c.value.started_at).getTime(),s=Math.floor((Date.now()-a)/1e3);return Math.min(s/c.value.time_limit,1)*100}),E=i(()=>[...u.value].filter(a=>a.score>0).sort((a,s)=>(s.score||0)-(a.score||0)).slice(0,3).map((a,s)=>({...a,rank:s+1}))),h=j([]);U(()=>u.value,(a,s)=>{!s||s.length===0||(a.forEach(t=>{const r=s.find(S=>S.id===t.id);r&&(t.status==="completed"&&r.status!=="completed"?h.value.unshift({id:`${t.id}-${Date.now()}`,participant:t,action:"completed",score:t.score,timestamp:Date.now()}):t.score!==r.score&&t.score>r.score&&h.value.unshift({id:`${t.id}-${Date.now()}`,participant:t,action:"scored",score:t.score,timestamp:Date.now()}))}),h.value.length>10&&(h.value=h.value.slice(0,10)))},{deep:!0});function X(a){const s=Math.floor(a/60),t=a%60;return`${s}:${t.toString().padStart(2,"0")}`}function L(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const s=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-s)/1e3);x.value=Math.max(0,c.value.time_limit-t),x.value===0&&(_&&(clearInterval(_),_=null),p.value||b.endGame())};a(),_=setInterval(a,1e3)}async function Y(){confirm("ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ")&&await b.endGame()}function O(){b.reset(),q.push({name:"arena"})}return U(()=>c.value?.status,a=>{a==="playing"&&!_&&L()}),ee(()=>{b.subscribeToRoom(J.value),c.value?.status==="playing"&&L()}),te(()=>{_&&clearInterval(_)}),(a,s)=>(o(),l("div",{class:g(["game-board",{finished:p.value}])},[e("header",ie,[e("div",ce,[e("button",{class:"back-btn",onClick:O}," â† é›¢é–‹ "),e("div",de,[e("h1",null,n(c.value?.text?.title),1),c.value?.text?.author?(o(),l("p",ue,n(c.value?.text?.author),1)):d("",!0)])]),e("div",me,[e("div",{class:g(["countdown",{warning:x.value<30}])},[e("span",ve,n(p.value?"æ¯”è³½çµæŸ":"å‰©é¤˜æ™‚é–“"),1),e("span",_e,n(X(x.value)),1)],2)]),e("div",pe,[e("div",he,[s[0]||(s[0]=e("span",{class:"progress-label"},"å®Œæˆé€²åº¦",-1)),e("span",ge,n(B.value)+" / "+n(u.value.length),1)]),p.value?d("",!0):(o(),l("button",{key:0,class:"btn-danger",onClick:Y}," çµæŸæ¯”è³½ "))])]),!p.value&&N.value.length?(o(),l("div",ye,[se(re,{teams:N.value,height:150,"racer-size":72,"show-rankings":!0,class:"teacher-race-track"},null,8,["teams"]),e("div",fe,[e("div",ke,[s[1]||(s[1]=e("span",{class:"time-progress-label"},"æ¯”è³½é€²åº¦",-1)),e("span",be,n(Math.round(R.value))+"%",1)]),e("div",Te,[e("div",{class:g(["time-progress-fill",{warning:R.value>80}]),style:$({width:`${R.value}%`})},null,6)])]),e("div",Ce,[e("div",Se,[s[3]||(s[3]=e("div",{class:"stat-icon"},"ğŸ“Š",-1)),e("div",we,[e("div",xe,n(Q.value)+"%",1),s[2]||(s[2]=e("div",{class:"stat-label"},"å®Œæˆç‡",-1)),e("div",Me,n(B.value)+" / "+n(D.value)+" äºº",1)])]),A.value?(o(),l("div",Be,[s[6]||(s[6]=e("div",{class:"stat-icon"},"âš¡",-1)),e("div",De,[e("div",Ae,n(A.value.minutes)+":"+n(A.value.seconds.toString().padStart(2,"0")),1),s[4]||(s[4]=e("div",{class:"stat-label"},"å¹³å‡é€Ÿåº¦",-1)),s[5]||(s[5]=e("div",{class:"stat-detail"},"å·²å®Œæˆå­¸ç”Ÿ",-1))])])):d("",!0),e("div",Re,[s[9]||(s[9]=e("div",{class:"stat-icon"},"ğŸ†",-1)),e("div",Ie,[e("div",$e,n(W.value),1),s[7]||(s[7]=e("div",{class:"stat-label"},"æœ€é«˜åˆ†",-1)),s[8]||(s[8]=e("div",{class:"stat-detail"},"å€‹äººè¨˜éŒ„",-1))])]),C.value?(o(),l("div",ze,[s[11]||(s[11]=e("div",{class:"stat-icon"},"ğŸ”¥",-1)),e("div",Fe,[e("div",Ge,n(C.value.completedCount),1),s[10]||(s[10]=e("div",{class:"stat-label"},"æœ€æ´»èº",-1)),e("div",Ne,[m(f)(C.value.team)?(o(),z(F,{key:0,"product-type":m(f)(C.value.team),size:20,class:"team-badge-in-stat"},null,8,["product-type"])):d("",!0),ae(" "+n(C.value.team.team_name),1)])])])):d("",!0)])])):d("",!0),p.value?d("",!0):(o(),l("aside",Ve,[e("div",Ee,[s[12]||(s[12]=e("h3",{class:"panel-title"},"ğŸ† å¾—åˆ†å‰ä¸‰",-1)),e("div",Le,[(o(!0),l(y,null,k(E.value,t=>(o(),l("div",{key:t.id,class:g(["top-score-item",{"rank-1":t.rank===1,"rank-2":t.rank===2,"rank-3":t.rank===3}])},[e("span",Oe,n(t.rank),1),t.user?.avatar_url?(o(),l("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"top-score-avatar"},null,8,je)):(o(),l("span",Ue,n(t.user?.display_name?.charAt(0)||"?"),1)),e("div",qe,[e("span",He,n(t.user?.display_name||"æœªçŸ¥"),1),e("span",Je,n(t.score)+" åˆ†",1)])],2))),128)),E.value.length===0?(o(),l("div",Ke," æš«ç„¡åˆ†æ•¸ ")):d("",!0)])]),e("div",Qe,[s[13]||(s[13]=e("h3",{class:"panel-title"},"âš¡ å¯¦æ™‚å‹•æ…‹",-1)),e("div",We,[(o(!0),l(y,null,k(h.value,t=>(o(),l("div",{key:t.id,class:g(["activity-item",t.action])},[t.participant.user?.avatar_url?(o(),l("img",{key:0,src:t.participant.user.avatar_url,alt:t.participant.user.display_name,class:"activity-avatar"},null,8,Xe)):(o(),l("span",Ye,n(t.participant.user?.display_name?.charAt(0)||"?"),1)),e("div",Ze,[e("span",Pe,[e("strong",null,n(t.participant.user?.display_name||"æœªçŸ¥"),1),t.action==="completed"?(o(),l("span",et," å®Œæˆäº†ç­”é¡Œï¼")):t.action==="scored"?(o(),l("span",tt," å¾—åˆ† "+n(t.score),1)):d("",!0)])])],2))),128)),h.value.length===0?(o(),l("div",st," ç­‰å¾…æ´»å‹•... ")):d("",!0)])])])),p.value?(o(),l("div",at,[e("div",ot,[s[14]||(s[14]=e("div",{class:"trophy"},"ğŸ†",-1)),s[15]||(s[15]=e("h2",null,"æ¯”è³½çµæŸï¼",-1)),e("div",nt,[(o(!0),l(y,null,k(M.value,(t,r)=>(o(),l("div",{key:t.team.id,class:g(["ranking-item",{winner:r===0}]),style:$({"--team-primary":m(w)[t.team.team_color].primary,"--team-secondary":m(w)[t.team.team_color].secondary})},[e("span",lt,n(r+1),1),m(f)(t.team)?(o(),z(F,{key:0,"product-type":m(f)(t.team),size:28,class:"team-badge-in-mini-ranking"},null,8,["product-type"])):d("",!0),e("span",rt,n(t.team.team_name),1),e("span",it,n(t.completedCount)+"/"+n(t.memberCount)+" äºº",1),e("span",ct,n(t.averageScore.toFixed(1))+" åˆ†",1)],6))),128))]),s[16]||(s[16]=e("p",{class:"scoring-note"},"* ä»¥éšŠå“¡å¹³å‡åˆ†è¨ˆç®—æ’å",-1)),e("button",{class:"btn-primary btn-large",onClick:O}," è¿”å›é¬¥è±† ")])])):(o(),l("main",dt,[e("div",ut,[V.value.length>0?(o(),l("div",mt,[s[17]||(s[17]=e("h3",{class:"section-title"},"ğŸ‰ æœ€è¿‘å®Œæˆ",-1)),e("div",vt,[(o(!0),l(y,null,k(V.value,t=>(o(),l("div",{key:t.id,class:"completion-item"},[t.user?.avatar_url?(o(),l("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"completion-avatar"},null,8,_t)):(o(),l("span",pt,n(t.user?.display_name?.charAt(0)||"?"),1)),e("div",ht,[e("span",gt,n(t.user?.display_name||"æœªçŸ¥"),1),e("span",yt,n(t.score)+" åˆ†",1)])]))),128))])])):d("",!0),e("div",ft,[(o(!0),l(y,null,k(M.value,t=>(o(),l("div",{key:t.team.id,class:"team-column",style:$({"--team-primary":m(w)[t.team.team_color].primary,"--team-secondary":m(w)[t.team.team_color].secondary,"--team-text":m(w)[t.team.team_color].text})},[e("div",kt,[e("div",bt,[m(f)(t.team)?(o(),z(F,{key:0,"product-type":m(f)(t.team),size:40,class:"team-badge-in-title"},null,8,["product-type"])):d("",!0),e("h2",null,n(t.team.team_name),1),e("span",Tt,n(t.completedCount)+"/"+n(t.memberCount),1)]),e("div",Ct,[e("span",St,n(t.averageScore.toFixed(1)),1),s[18]||(s[18]=e("span",{class:"score-label"},"å¹³å‡åˆ†",-1))])]),e("div",wt,[(o(!0),l(y,null,k(K.value[t.team.id],r=>(o(),l("div",{key:r.id,class:g(["member-row",{completed:r.status==="completed"}])},[e("div",xt,[r.user?.avatar_url?(o(),l("img",{key:0,src:r.user.avatar_url,alt:r.user.display_name,class:"avatar"},null,8,Mt)):(o(),l("span",Bt,n(r.user?.display_name?.charAt(0)||"?"),1)),e("span",Dt,n(r.user?.display_name||"æœªçŸ¥"),1)]),e("div",At,[r.status==="completed"?(o(),l(y,{key:0},[e("span",Rt,n(r.score)+" åˆ†",1),e("span",It,n(r.accuracy?.toFixed(0))+"%",1)],64)):r.status==="playing"?(o(),l("span",$t,"ä½œç­”ä¸­...")):(o(),l("span",zt,"ç­‰å¾…ä¸­"))])],2))),128))])],4))),128))])])]))],2))}}),Ut=ne(Ft,[["__scopeId","data-v-1b5245bd"]]);export{Ut as default};
