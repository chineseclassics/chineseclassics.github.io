import{C as se,u as re,r as p,m as U,P as r}from"./index-DjYLpOob.js";const ne=se("class",()=>{const u=re(),f=p([]),L=p(null),b=p([]),M=p([]),C=p([]),o=p(!1),s=p(null),$=/^[a-zA-Z0-9._-]+@student\.isf\.edu\.hk$/i,O=["gnoluy@gmail.com"],z=U(()=>f.value),G=U(()=>f.value.filter(t=>t.is_active));async function W(t,a){if(!r||!u.user)return s.value="請先登入",null;if(!u.isTeacher)return s.value="只有老師可以創建班級",null;o.value=!0,s.value=null;try{const{data:e,error:n}=await r.from("classes").insert({teacher_id:u.user.id,class_name:t,description:a||null}).select().single();return n?(s.value=n.message,null):(f.value.push(e),e)}catch(e){return s.value=e.message,null}finally{o.value=!1}}async function B(){if(!(!r||!u.user)){o.value=!0,s.value=null;try{const{data:t,error:a}=await r.from("classes").select(`
          *,
          member_count:class_members(count)
        `).eq("teacher_id",u.user.id).order("created_at",{ascending:!1});if(a){s.value=a.message;return}f.value=(t||[]).map(e=>({...e,member_count:e.member_count?.[0]?.count||0}))}catch(t){s.value=t.message}finally{o.value=!1}}}async function N(t){if(r){o.value=!0,s.value=null;try{const{data:a,error:e}=await r.from("class_members").select(`
          *,
          student:users!class_members_student_id_fkey (
            id,
            email,
            display_name,
            avatar_url
          )
        `).eq("class_id",t).order("added_at",{ascending:!1});if(e){s.value=e.message;return}b.value=a||[]}catch(a){s.value=a.message}finally{o.value=!1}}}async function X(t,a){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{data:e,error:n}=await r.from("users").select("id").eq("email",a).single();if(n||!e)return s.value="找不到該學生，請確認郵箱正確且學生已登入過",!1;const{error:_}=await r.from("class_members").insert({class_id:t,student_id:e.id,added_by:u.user?.id});return _?(_.code==="23505"?s.value="該學生已在班級中":s.value=_.message,!1):(await N(t),!0)}catch(e){return s.value=e.message,!1}finally{o.value=!1}}async function Z(t,a){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{error:e}=await r.from("class_members").delete().eq("class_id",t).eq("student_id",a);return e?(s.value=e.message,!1):(b.value=b.value.filter(n=>!(n.class_id===t&&n.student_id===a)),!0)}catch(e){return s.value=e.message,!1}finally{o.value=!1}}function j(t){return t?t.split(/[\n,;]/).map(a=>a.trim().toLowerCase()).filter(a=>a!==""):[]}function F(t){const a=[],e=[];return t.forEach(n=>{const _=O.includes(n.toLowerCase());$.test(n)||_?a.push(n):e.push(n)}),{validEmails:a,invalidEmails:e}}async function H(t,a){if(!r||!u.isTeacher||!u.user)throw new Error("無權限");const e=j(a),{validEmails:n,invalidEmails:_}=F(e);if(n.length===0)throw new Error("沒有有效的學生郵箱地址。請使用 @student.isf.edu.hk 格式");const{data:D}=await r.from("class_members").select("student:users!class_members_student_id_fkey(email)").eq("class_id",t),{data:S}=await r.from("pending_students").select("email").eq("class_id",t),T=new Set([...D?.map(d=>d.student?.email).filter(Boolean)||[],...S?.map(d=>d.email)||[]]),A=n.filter(d=>T.has(d)),q=n.filter(d=>!T.has(d));let k=0;for(const d of q)try{const{error:h}=await r.from("pending_students").insert({class_id:t,email:d,added_by:u.user.id});if(h){h.code==="23505"?console.log(`郵箱 ${d} 已在待加入列表中`):console.warn(`添加郵箱 ${d} 失敗:`,h);continue}k++}catch(h){console.warn(`處理郵箱 ${d} 時出錯:`,h)}return{validEmails:n.length,invalidEmails:_.length,duplicates:A.length,added:k,invalidList:_}}async function J(t){if(r)try{const{data:a,error:e}=await r.from("pending_students").select("*").eq("class_id",t).order("added_at",{ascending:!1});if(e){console.error("獲取待激活學生失敗:",e);return}M.value=a||[]}catch(a){console.error("獲取待激活學生失敗:",a)}}async function K(t){if(!r||!u.isTeacher)return s.value="無權限",!1;try{const{error:a}=await r.from("pending_students").delete().eq("id",t);return a?(s.value=a.message,!1):(M.value=M.value.filter(e=>e.id!==t),!0)}catch(a){return s.value=a.message,!1}}function Q(t){return Math.max(1,Math.floor(t/100)+1)}async function V(t){if(!(!r||!u.isTeacher)){o.value=!0,s.value=null;try{const{data:a}=await r.from("class_members").select("student_id").eq("class_id",t);if(!a||a.length===0){C.value=[];return}const e=a.map(l=>l.student_id),{data:n}=await r.from("users").select("id, display_name, email, avatar_url").in("id",e);if(!n||n.length===0){C.value=[];return}const{data:_}=await r.from("profiles").select("id, total_beans, streak_days, last_practice_date, current_avatar_id").in("id",e),D=new Date(Date.now()-10080*60*1e3).toISOString(),{data:S,error:T}=await r.from("practice_records").select("user_id, correct_breaks, created_at, accuracy, text_id").in("user_id",e);T&&console.error("獲取練習記錄失敗:",T);const{data:A}=await r.from("game_participants").select("user_id, accuracy").in("user_id",e).eq("status","completed").not("accuracy","is",null),q=new Map;e.forEach(l=>{q.set(l,{total_practices:0,weekly_practices:0,unique_texts_practiced:0,correct_count:0,last_practice_at:null})});const k=(S||[]).filter(l=>l.user_id&&e.includes(l.user_id));if(k.length>0){const l=new Map;k.forEach(i=>{i.user_id&&(l.has(i.user_id)||l.set(i.user_id,[]),l.get(i.user_id).push(i))}),l.forEach((i,c)=>{const x=i.length,w=i.reduce((v,E)=>v+(E.correct_breaks||0),0),m=new Date(D).getTime(),g=i.filter(v=>{if(!v.created_at)return!1;try{return new Date(v.created_at).getTime()>=m}catch{return!1}}).length,y=new Set;i.forEach(v=>{if(v.text_id){const E=String(v.text_id).trim();E&&y.add(E)}});const P=y.size,te=[...i].sort((v,E)=>new Date(E.created_at).getTime()-new Date(v.created_at).getTime())[0]?.created_at||null;q.set(c,{total_practices:x,weekly_practices:g,unique_texts_practiced:P,correct_count:w,last_practice_at:te})})}const d=new Map;if(e.forEach(l=>{d.set(l,0)}),S){const l=new Map;S.forEach(c=>{!c.user_id||c.accuracy===null||(l.has(c.user_id)||l.set(c.user_id,[]),l.get(c.user_id).push(Number(c.accuracy)*100))});const i=new Map;A&&A.forEach(c=>{!c.user_id||c.accuracy===null||(i.has(c.user_id)||i.set(c.user_id,[]),i.get(c.user_id).push(Number(c.accuracy)))}),e.forEach(c=>{const x=l.get(c)||[],w=i.get(c)||[],m=[...x,...w];if(m.length>0){const g=m.reduce((y,P)=>y+P,0)/m.length;d.set(c,Math.round(g))}})}const h=n.map(l=>{const i=_?.find(y=>y.id===l.id),c=q.get(l.id)||{total_practices:0,weekly_practices:0,unique_texts_practiced:0,correct_count:0,last_practice_at:null},x=d.get(l.id)||0,w=i?.total_beans||0,m=c.last_practice_at||(i?.last_practice_date?new Date(i.last_practice_date).toISOString():null);let g=null;return m?g=Math.floor((Date.now()-new Date(m).getTime())/864e5):c.total_practices===0&&(g=null),{student_id:l.id,display_name:l.display_name||l.email?.split("@")[0]||"未知",email:l.email||"",avatar_url:l.avatar_url,current_avatar_id:i?.current_avatar_id||null,beans:i?.total_beans||0,total_exp:w,total_practices:c.total_practices,weekly_practices:c.weekly_practices,unique_texts_practiced:c.unique_texts_practiced,correct_count:c.correct_count,streak_days:i?.streak_days||0,last_practice_at:m,level:Q(w),average_accuracy:x,last_practice_days_ago:g}});C.value=h.sort((l,i)=>i.beans-l.beans)}catch(a){console.error("獲取學生進度失敗:",a),s.value=a.message}finally{o.value=!1}}}async function Y(t,a){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{error:e}=await r.from("classes").update(a).eq("id",t).eq("teacher_id",u.user?.id);if(e)return s.value=e.message,!1;const n=f.value.findIndex(_=>_.id===t);return n!==-1&&(f.value[n]={...f.value[n],...a}),!0}catch(e){return s.value=e.message,!1}finally{o.value=!1}}async function I(t){if(!r||!u.isTeacher)return s.value="無權限",!1;o.value=!0,s.value=null;try{const{error:a}=await r.from("classes").delete().eq("id",t).eq("teacher_id",u.user?.id);return a?(s.value=a.message,!1):(f.value=f.value.filter(e=>e.id!==t),!0)}catch(a){return s.value=a.message,!1}finally{o.value=!1}}async function R(){if(!(!r||!u.user)){o.value=!0,s.value=null;try{const{data:t,error:a}=await r.from("class_members").select(`
          class:classes (
            id,
            teacher_id,
            class_name,
            description,
            created_at,
            is_active,
            teacher:users!classes_teacher_id_fkey (
              display_name
            )
          )
        `).eq("student_id",u.user.id);if(a){s.value=a.message;return}f.value=(t||[]).map(e=>e.class).filter(e=>e!==null)}catch(t){s.value=t.message}finally{o.value=!1}}}async function ee(){u.isTeacher?await B():await R()}function ae(){f.value=[],L.value=null,b.value=[],s.value=null}return{classes:f,currentClass:L,classMembers:b,pendingStudents:M,studentProgress:C,loading:o,error:s,myClasses:z,activeClasses:G,createClass:W,fetchMyClasses:B,fetchClassMembers:N,addStudentByEmail:X,removeStudent:Z,updateClass:Y,deleteClass:I,batchAddStudents:H,fetchPendingStudents:J,removePendingStudent:K,fetchStudentProgress:V,fetchStudentClasses:R,fetchClasses:ee,reset:ae}});export{ne as u};
