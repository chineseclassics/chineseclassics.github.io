import{d as Te,c as o,x as ke,r as y,w as be,f as Be,R as Ae,a as i,g as n,F as A,h,j as P,b as k,t as u,n as X,m as xe,l as we,o as l,_ as Ce}from"./index-v08fXWr_.js";import{u as Se}from"./gameStore-HkWA7QEA.js";import{d as Pe,B as Me}from"./game-TYh7-2x0.js";import{T as ze}from"./TeamBadge-sXPgLcPb.js";import"./userStatsStore-0hGvBIX1.js";const Ie={class:"game-play"},Ve={key:0,class:"loading-container"},Re={key:0,class:"team-progress-bar"},Ge={class:"team-progress-content"},Ee={class:"team-info"},Fe={class:"team-name-row"},$e={class:"team-name"},qe={class:"team-rank"},Le={class:"team-score"},Ue={class:"play-header"},Ne={class:"header-left"},Oe={class:"countdown-time"},je={class:"header-right"},De={class:"scoreboard"},We={class:"score-chip"},Ye={class:"chip-value"},Ze={key:0,class:"score-chip team"},He={class:"chip-value"},Je={key:1,class:"text-tabs"},Ke=["onClick"],Qe={class:"tab-number"},Xe={class:"tab-title"},et={key:0,class:"tab-check"},tt={class:"play-main"},at={class:"board-header"},st={class:"board-header-right"},nt={class:"practice-board"},rt={key:0,class:"practice-line"},ot={class:"char"},lt=["onClick","aria-label"],it={key:0,class:"bean"},ct={class:"progress-hint"},ut={key:0,class:"text-nav"},dt=["disabled"],vt={class:"nav-info"},mt=["disabled"],pt=80,ft=Te({__name:"GamePlay",setup(ht){const ee=we(),te=ke(),_=Se(),M=o(()=>te.params.roomId),c=o(()=>_.currentRoom),T=o(()=>_.myParticipant),ae=o(()=>c.value?.participants||[]),z=o(()=>c.value?.teams||[]),N=o(()=>!z.value.length||!T.value?.team_id?null:z.value.find(a=>a.id===T.value.team_id)||null),se=o(()=>q()),O=o(()=>se.value.totalCorrect),b=o(()=>{const a=new Map;z.value.forEach(e=>{a.set(e.id,{id:e.id,name:e.team_name,team:e,authAvg:typeof e.total_score=="number"?e.total_score/100:0,localAvg:0})});const t=new Map;return ae.value.forEach(e=>{if(!e.team_id)return;t.has(e.team_id)||t.set(e.team_id,{total:0,count:0});const s=t.get(e.team_id),r=e.user_id===T.value?.user_id?Math.max(O.value,e.score||0):e.score||0;s.total+=r,s.count+=1}),a.forEach((e,s)=>{const r=t.get(s),m=r&&r.count>0?r.total/r.count:0;e.localAvg=m}),Array.from(a.values()).map(e=>({...e,displayAvg:e.authAvg||e.localAvg||0}))}),j=o(()=>{const a=N.value;if(!a)return null;const t=b.value.find(e=>e.id===a.id);return t?t.displayAvg:null}),ne=o(()=>[...b.value].sort((a,t)=>t.displayAvg-a.displayAvg)),D=o(()=>{if(!b.value.length)return[];const a=Math.max(...b.value.map(e=>e.displayAvg),1),t=a===0||a<.01;return b.value.map(e=>{const s=Pe(e.team),r=s?Me[s]:null,m=t?1:Math.max(e.displayAvg/a,.1);return{...e,productType:s,product:r,flexGrow:m,rank:ne.value.findIndex(U=>U.id===e.id)+1,isMyTeam:e.id===N.value?.id}}).sort((e,s)=>s.displayAvg-e.displayAvg)}),d=y([]),p=y(new Map),v=y(0),f=o(()=>d.value[v.value]),B=o(()=>f.value&&p.value.get(f.value.id)||null),I=o(()=>B.value?.characters||[]),W=o(()=>B.value?.correctBreaks||new Set),x=o({get:()=>B.value?.userBreaks||new Map,set:a=>{if(f.value&&p.value.has(f.value.id)){const t=p.value.get(f.value.id);t.userBreaks=a}}}),w=y(0);let V=null;const Y=o(()=>W.value.size),re=o(()=>x.value.size),Z=o(()=>Math.max(0,Y.value-re.value)),oe=o(()=>Z.value>0),R=y(!1),H=y(null);let g=null,C=!1,G=!1;const J=y(!0);function le(a){const t=[],e=new Set;let s=0;const r=a.replace(/[\|\s]+$/,"");for(const m of r)m==="|"?s>0&&e.add(s-1):m!==`
`&&m!=="\r"&&(t.push(m),s++);return{chars:t,breaks:e}}function ie(){p.value.clear();for(const a of d.value){const t=le(a.content);p.value.set(a.id,{characters:t.chars,correctBreaks:t.breaks,userBreaks:new Map})}}function ce(a){a>=0&&a<d.value.length&&(v.value=a)}function ue(){v.value>0&&v.value--}function de(){v.value<d.value.length-1&&v.value++}let E=null;function F(a){try{E||(E=new AudioContext);const t=E,e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.type="sine",a==="add"?(e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(200,t.currentTime+.1),s.gain.setValueAtTime(.3,t.currentTime),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1),e.start(t.currentTime),e.stop(t.currentTime+.1)):a==="remove"?(e.frequency.setValueAtTime(300,t.currentTime),e.frequency.exponentialRampToValueAtTime(150,t.currentTime+.08),s.gain.setValueAtTime(.2,t.currentTime),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.08),e.start(t.currentTime),e.stop(t.currentTime+.08)):(e.frequency.setValueAtTime(200,t.currentTime),s.gain.setValueAtTime(.2,t.currentTime),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.15),e.start(t.currentTime),e.stop(t.currentTime+.15))}catch{}}function $(a=10){navigator.vibrate&&navigator.vibrate(a)}function ve(a){if(!f.value)return;const t=p.value.get(f.value.id);if(!t||t.userBreaks.has(a))return;if(t.userBreaks.size>=t.correctBreaks.size){F("error"),R.value=!0,setTimeout(()=>{R.value=!1},300),$(50);return}const e={index:a,isCorrect:t.correctBreaks.has(a),placedAt:Date.now()},s=new Map(t.userBreaks);s.set(a,e),t.userBreaks=s,p.value=new Map(p.value),H.value=e.placedAt,e.isCorrect?(F("add"),$(10)):(F("error"),$(50)),Q();const r=q();_e(r.totalCorrect),r.usedBeansAll>=r.totalBeansAll&&Q(!0)}function me(a){const t=x.value.get(a);return{"has-bean":!!t,correct:t?.isCorrect,extra:t&&!t.isCorrect}}function K(a){let t=0,e=0;return a.userBreaks.forEach(s=>{s.isCorrect?t++:e++}),{correct:t,wrong:e}}function q(){let a=0,t=0,e=0;return p.value.forEach(s=>{const r=K(s);a+=r.correct,t+=s.correctBreaks.size,e+=s.userBreaks.size}),{totalCorrect:a,totalBeansAll:t,usedBeansAll:e}}function pe(a=!1){if(!f.value||!B.value)return null;const{correct:t,wrong:e}=K(B.value),{totalCorrect:s,totalBeansAll:r,usedBeansAll:m}=q(),U=H.value||Date.now(),ye=a||m>=r;return{roomId:M.value,textId:f.value.id,textIndex:v.value,correctCount:t,wrongCount:e,totalCorrect:s,totalBeans:r,usedBeans:m,lastInteraction:U,isFinished:ye}}async function L(a=!1){g&&(clearTimeout(g),g=null);const t=pe(a);if(t&&!G){G=!0;try{await _.updateProgress(t)}catch(e){console.error("[GamePlay] 更新進度失敗",e)}finally{G=!1}}}function Q(a=!1){a&&(C=!0),g&&clearTimeout(g),g=setTimeout(()=>{L(C),C=!1},pt)}async function fe(a=!1){await L(a);try{await _.endGame()}catch(t){console.error("[GamePlay] 結束遊戲失敗",t)}}function S(a){const t=p.value.get(a);if(!t)return"empty";const e=t.userBreaks.size,s=t.correctBreaks.size;return e===0?"empty":e===s&&[...t.correctBreaks].every(r=>t.userBreaks.has(r))?"complete":"partial"}function he(a){const t=Math.floor(a/60),e=a%60;return`${t}:${e.toString().padStart(2,"0")}`}function ge(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const t=new Date(c.value.started_at).getTime(),e=Math.floor((Date.now()-t)/1e3);w.value=Math.max(0,c.value.time_limit-e),w.value===0&&fe(!0)};a(),V=setInterval(a,1e3)}be(()=>c.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),ee.push({name:"arena-result",params:{roomId:M.value}}))}),Be(async()=>{_.subscribeToRoom(M.value),c.value?.text_ids&&c.value.text_ids.length>0?d.value=await _.fetchTexts(c.value.text_ids):c.value?.text_id&&(d.value=await _.fetchTexts([c.value.text_id])),J.value=!1,d.value.length>0&&(ie(),ge())}),Ae(()=>{V&&clearInterval(V),g&&clearTimeout(g),L(C)});function _e(a){if(T.value&&(T.value.score=a),c.value?.participants){const t=c.value.participants.map(e=>e.user_id===T.value?.user_id?{...e,score:a}:e);c.value.participants=t}}return(a,t)=>(l(),i("div",Ie,[J.value?(l(),i("div",Ve,[...t[0]||(t[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(l(),i(A,{key:1},[D.value.length?(l(),i("div",Re,[(l(!0),i(A,null,P(D.value,e=>(l(),i("div",{key:e.id,class:k(["team-progress-item",{"my-team":e.isMyTeam}]),style:X({flex:`${e.flexGrow} 1 auto`,minWidth:"120px"})},[n("div",{class:"team-progress-segment",style:X({background:e.product?.color||"#e5e7eb"})},[n("div",Ge,[e.productType?(l(),xe(ze,{key:0,"product-type":e.productType,size:32,class:"team-badge-icon"},null,8,["product-type"])):h("",!0),n("div",Ee,[n("div",Fe,[n("span",$e,u(e.name),1),n("span",qe,"#"+u(e.rank),1)]),n("span",Le,u(e.displayAvg.toFixed(2)),1)])])],4)],6))),128))])):h("",!0),n("header",Ue,[n("div",Ne,[n("div",{class:k(["countdown",{warning:w.value<30}])},[t[1]||(t[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",Oe,u(he(w.value)),1)],2)]),n("div",je,[n("div",De,[n("div",We,[t[2]||(t[2]=n("span",{class:"chip-label"},"個人分數",-1)),n("span",Ye,u(O.value),1)]),j.value!==null?(l(),i("div",Ze,[t[3]||(t[3]=n("span",{class:"chip-label"},"團隊平均",-1)),n("span",He,u(j.value?.toFixed(2)),1)])):h("",!0)]),t[4]||(t[4]=n("div",{class:"live-pill"},[n("span",{class:"live-dot"}),n("span",null,"實時計分")],-1))])]),d.value.length>1?(l(),i("div",Je,[(l(!0),i(A,null,P(d.value,(e,s)=>(l(),i("button",{key:e.id,class:k(["text-tab",{active:s===v.value,empty:S(e.id)==="empty",partial:S(e.id)==="partial",complete:S(e.id)==="complete"}]),onClick:r=>ce(s)},[n("span",Qe,u(s+1),1),n("span",Xe,u(e.title),1),S(e.id)==="complete"?(l(),i("span",et,"✓")):h("",!0)],10,Ke))),128))])):h("",!0),n("main",tt,[n("div",at,[t[5]||(t[5]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",st,[n("div",{class:k(["bean-inventory",{shake:R.value,empty:!oe.value}])},[(l(!0),i(A,null,P(Y.value,e=>(l(),i("span",{key:e,class:k(["inventory-bean",{used:e>Z.value}])},null,2))),128))],2)])]),n("div",nt,[I.value.length?(l(),i("div",rt,[(l(!0),i(A,null,P(I.value,(e,s)=>(l(),i("span",{key:s,class:"char-unit"},[n("span",ot,u(e),1),s<I.value.length-1?(l(),i("button",{key:0,class:k(["bean-slot",me(s)]),onClick:r=>ve(s),"aria-label":`在「${e}」後放置斷句`},[x.value.has(s)?(l(),i("span",it)):h("",!0),t[6]||(t[6]=n("span",{class:"bean-hint"},null,-1))],10,lt)):h("",!0)]))),128))])):h("",!0)]),n("div",ct,[n("span",null,"已標記 "+u(x.value.size)+" / "+u(W.value.size)+" 處",1)]),d.value.length>1?(l(),i("div",ut,[n("button",{class:"nav-btn",disabled:v.value===0,onClick:ue}," ← 上一篇 ",8,dt),n("span",vt,u(v.value+1)+" / "+u(d.value.length),1),n("button",{class:"nav-btn",disabled:v.value===d.value.length-1,onClick:de}," 下一篇 → ",8,mt)])):h("",!0)]),t[7]||(t[7]=n("footer",{class:"play-footer"},[n("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),bt=Ce(ft,[["__scopeId","data-v-9796182c"]]);export{bt as default};
