import{y as q,u as z,r as l,c as f}from"./index-CIX_kLsE.js";import{u as B}from"./useSupabase-Ct-9xBeC.js";const P=q("avatar",()=>{const t=B(),n=z(),o=l([]),u=l(new Set),i=l(null),v=l(!1),c=l(null),w=f(()=>{const r={common:[],rare:[],epic:[],legendary:[]};for(const e of o.value)r[e.rarity].push(e);for(const e of Object.keys(r))r[e].sort((a,s)=>a.order_index-s.order_index);return r}),d=f(()=>i.value&&o.value.find(r=>r.id===i.value)||null),A=f(()=>d.value?`/judou/images/avatars/${d.value.filename}`:null),k=f(()=>u.value.size),g=f(()=>o.value.length);function S(r){return`/judou/images/avatars/${r.filename}`}function E(r){return u.value.has(r)}async function h(){if(t){v.value=!0,c.value=null;try{const{data:r,error:e}=await t.from("avatars").select("*").eq("is_active",!0).order("order_index",{ascending:!0});if(e)throw e;o.value=r||[]}catch(r){console.error("獲取頭像列表失敗:",r),c.value=r.message}finally{v.value=!1}}}async function _(){if(!(!t||!n.user?.id))try{const{data:r,error:e}=await t.from("user_avatars").select("avatar_id").eq("user_id",n.user.id);if(e)throw e;u.value=new Set((r||[]).map(a=>a.avatar_id))}catch(r){console.error("獲取用戶頭像失敗:",r)}}async function y(){if(!(!t||!n.user?.id))try{const{data:r,error:e}=await t.from("profiles").select("current_avatar_id").eq("id",n.user.id).single();if(e)throw e;i.value=r?.current_avatar_id||null}catch(r){console.error("獲取當前頭像失敗:",r)}}async function U(){await h(),n.isAuthenticated&&await Promise.all([_(),y()])}async function x(r){if(!t||!n.user?.id)return[];try{const{data:e,error:a}=await t.rpc("check_and_unlock_avatars",{p_user_id:n.user.id,p_level:r});if(a)throw a;const s=[];for(const m of e||[]){u.value.add(m.avatar_id);const p=o.value.find(j=>j.id===m.avatar_id);p&&s.push(p)}return s}catch(e){return console.error("檢查解鎖頭像失敗:",e),[]}}async function C(r){if(!t||!n.user?.id)return null;try{const e=o.value.find(s=>s.unlock_type==="achievement"&&s.unlock_value===r);if(!e||u.value.has(e.id))return null;const{error:a}=await t.from("user_avatars").insert({user_id:n.user.id,avatar_id:e.id});if(a){if(a.code==="23505")return null;throw a}return u.value.add(e.id),e}catch(e){return console.error("解鎖成就頭像失敗:",e),null}}async function $(r){if(!t||!n.user?.id)return!1;if(!u.value.has(r))return c.value="尚未解鎖此頭像",!1;try{const{data:e,error:a}=await t.rpc("update_user_avatar",{p_user_id:n.user.id,p_avatar_id:r});if(a)throw a;return e?(i.value=r,!0):!1}catch(e){return console.error("更換頭像失敗:",e),c.value=e.message,!1}}function b(){u.value=new Set,i.value=null,c.value=null}return{allAvatars:o,unlockedAvatarIds:u,currentAvatarId:i,isLoading:v,error:c,avatarsByRarity:w,currentAvatar:d,currentAvatarUrl:A,unlockedCount:k,totalCount:g,getAvatarUrl:S,isUnlocked:E,fetchAvatars:h,fetchUserAvatars:_,fetchCurrentAvatar:y,initialize:U,checkAndUnlockAvatars:x,unlockAchievementAvatar:C,setCurrentAvatar:$,reset:b}});export{P as u};
