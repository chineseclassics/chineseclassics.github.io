import{B as pe,u as A,r as x,c as R,P as s}from"./index-CkKu9nI9.js";import{u as ge}from"./userStatsStore-DUeV3wqy.js";import{a as ve,d as we,S as X}from"./game-pGsr7gx9.js";const Se=pe("game",()=>{const d=A(),w=ge(),n=x(null),E=x([]),l=x(null),y=x(!1),c=x(null);let T=null,P=null,I=null;const M=5e3,B=600*1e3,h=x(!1),b=R(()=>!n.value||!d.user?!1:n.value.host_id===d.user.id),V=R(()=>n.value?.status==="playing"),Y=R(()=>n.value?.status==="waiting"),J=R(()=>n.value?.status==="finished"),K=R(()=>!l.value?.team_id||!n.value?.teams?null:n.value.teams.find(t=>t.id===l.value.team_id));async function Q(t){if(!s||!d.user)return c.value="è«‹å…ˆç™»å…¥",null;y.value=!0,c.value=null;try{const{data:e,error:r}=await s.from("game_rooms").insert({host_id:d.user.id,host_type:t.hostType,game_mode:t.gameMode,text_id:t.textIds[0],text_ids:t.textIds,time_limit:t.timeLimit,team_count:t.teamCount||null,max_players:t.maxPlayers||null,entry_fee:t.entryFee||0,class_id:t.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url)
        `).single();if(r)return c.value=r.message,null;if(t.gameMode==="team_battle"&&t.teamCount){const i=ve(t.teamCount).map((v,f)=>({room_id:e.id,team_name:we(v),team_color:v,order_index:f})),{data:u,error:o}=await s.from("game_teams").insert(i).select();o?console.error("å‰µå»ºåœ˜éšŠå¤±æ•—:",o):e.teams=u}if(t.hostType==="student"){if(t.entryFee&&t.entryFee>0&&!await z(e.id,t.entryFee))return await s.from("game_rooms").delete().eq("id",e.id),null;const a=await O(e.id,t.entryFee||0);a&&(e.participants=[a],l.value=a)}return n.value=e,q(e.id),e}catch(e){return c.value=e.message,null}finally{y.value=!1}}async function Z(t){if(!s||!d.user)return{success:!1,error:"è«‹å…ˆç™»å…¥"};y.value=!0,c.value=null;try{const{data:e,error:r}=await s.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",t.toUpperCase()).single();if(r||!e)return{success:!1,error:"æ‰¾ä¸åˆ°è©²æˆ¿é–“"};if(e.status!=="waiting")return{success:!1,error:"è©²æˆ¿é–“å·²é–‹å§‹æˆ–å·²çµæŸ"};const a=e.participants?.find(o=>o.user_id===d.user.id);if(a)return n.value=e,l.value=a,q(e.id),{success:!0,room:e,participant:a};if(e.max_players&&e.participants&&e.participants.length>=e.max_players)return{success:!1,error:"æˆ¿é–“å·²æ»¿"};if(e.entry_fee>0&&!await z(e.id,e.entry_fee))return{success:!1,error:c.value||"ç„¡æ³•æ”¯ä»˜å…¥å ´è²»"};const i=await O(e.id,e.entry_fee);if(!i)return{success:!1,error:c.value||"åŠ å…¥æˆ¿é–“å¤±æ•—"};const u=[...e.participants||[],i];return n.value={...e,participants:u},l.value=i,q(e.id),{success:!0,room:e,participant:i}}catch(e){return c.value=e.message,{success:!1,error:c.value}}finally{y.value=!1}}async function O(t,e){if(!s||!d.user)return null;const{data:r,error:a}=await s.from("game_participants").insert({room_id:t,user_id:d.user.id,fee_paid:e}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return a?(c.value=a.message,null):r}async function z(t,e){if(!s||!d.user)return!1;w.profile||await w.fetchProfile();const r=w.profile?.total_beans??0;if(r<e)return c.value=`å¥è±†ä¸è¶³ï¼Œéœ€è¦ ${e} å¥è±†ï¼Œç•¶å‰åªæœ‰ ${r} å¥è±†`,!1;if(r-e<X.MIN_BALANCE)return c.value=`è³¬æˆ¶éœ€ä¿ç•™è‡³å°‘ ${X.MIN_BALANCE} è±†`,!1;const a=r-e,{error:i}=await s.from("profiles").update({total_beans:a,weekly_beans:Math.max(0,(w.profile?.weekly_beans??0)-e),monthly_beans:Math.max(0,(w.profile?.monthly_beans??0)-e),updated_at:new Date().toISOString()}).eq("id",d.user.id);return i?(console.error("æ‰£é™¤å…¥å ´è²»å¤±æ•—:",i),c.value="æ‰£é™¤å…¥å ´è²»å¤±æ•—",!1):(await s.from("game_transactions").insert({user_id:d.user.id,room_id:t,type:"entry_fee",amount:-e,balance_after:a,description:`å…¥å ´è²» ${e} è±†`}),await w.fetchProfile(),console.log(`ğŸ’° å·²æ‰£é™¤å…¥å ´è²» ${e} è±†ï¼Œé¤˜é¡ ${a} è±†`),!0)}async function N(t,e){if(!s||!b.value)return c.value="ç„¡æ¬Šé™",!1;const{error:r}=await s.from("game_participants").update({team_id:e}).eq("id",t);return r?(c.value=r.message,!1):!0}async function ee(){if(!s||!b.value||!n.value?.teams)return c.value="ç„¡æ³•åˆ†çµ„",!1;const t=n.value.participants||[],e=n.value.teams,r=[...t].sort(()=>Math.random()-.5);for(let a=0;a<r.length;a++){const i=a%e.length,u=e[i],o=r[a];u&&o&&await N(o.id,u.id)}return!0}async function te(){if(!s||!b.value||!n.value)return c.value="ç„¡æ¬Šé™",!1;if(n.value.game_mode==="team_battle"){const e=n.value.participants?.filter(r=>!r.team_id);if(e&&e.length>0)return c.value="é‚„æœ‰ç©å®¶æœªåˆ†çµ„",!1}const{error:t}=await s.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",n.value.id);return t?(c.value=t.message,!1):(await s.from("game_participants").update({status:"playing"}).eq("room_id",n.value.id),!0)}async function ae(t){if(!s||!d.user||!n.value)return c.value="ç„¡æ³•æäº¤åˆ†æ•¸",!1;const{error:e}=await s.from("game_participants").update({score:t.score,accuracy:t.accuracy,time_spent:t.timeSpent,first_accuracy:t.firstAccuracy,attempt_count:t.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",t.roomId).eq("user_id",d.user.id);return e?(c.value=e.message,!1):(l.value?.team_id&&await D(l.value.team_id),await re(),!0)}async function se(t){if(!s||!d.user||!l.value)return c.value="ç„¡æ³•æäº¤é€²åº¦",!1;await s.from("game_text_progress").upsert({participant_id:l.value.id,text_id:t.textId,text_index:t.textIndex,correct_count:t.correctCount,wrong_count:t.wrongCount,time_spent:t.timeSpent,completed_at:new Date().toISOString()},{onConflict:"participant_id,text_id"});const e=(l.value.correct_breaks||0)+t.correctCount,r=(l.value.completed_texts||0)+1,a=t.textIndex+1,{error:i}=await s.from("game_participants").update({correct_breaks:e,completed_texts:r,current_text_index:a,score:e}).eq("id",l.value.id);return i?(c.value=i.message,!1):(l.value.correct_breaks=e,l.value.completed_texts=r,l.value.current_text_index=a,l.value.score=e,l.value.team_id&&await D(l.value.team_id),!0)}async function ne(t){if(!s||t.length===0)return[];const{data:e}=await s.from("practice_texts").select("id, title, author, content").in("id",t);if(e){const r=new Map(e.map(a=>[a.id,a]));return t.map(a=>r.get(a)).filter(Boolean)}return[]}async function D(t){if(!s||!n.value)return;const{data:e}=await s.from("game_participants").select("score").eq("team_id",t).eq("status","completed"),r=e?.length||0,a=e?.reduce((u,o)=>u+(o.score||0),0)||0,i=r>0?Math.round(a/r*100):0;await s.from("game_teams").update({total_score:i}).eq("id",t)}async function re(){if(!s||!n.value)return;const{data:t}=await s.from("game_participants").select("status").eq("room_id",n.value.id);if(!t)return;const e=t.every(u=>u.status==="completed"),r=n.value.started_at?new Date(n.value.started_at):null,a=n.value.time_limit*1e3,i=r&&Date.now()-r.getTime()>=a;(e||i)&&await L()}async function L(){if(!s||!n.value)return null;const t=n.value.started_at?new Date(n.value.started_at):null,e=n.value.time_limit*1e3;if(t&&Date.now()-t.getTime()>=e){const{data:m}=await s.from("game_participants").select("id, score").eq("room_id",n.value.id).neq("status","completed").gt("score",0);if(m&&m.length>0){const p=Math.round((Date.now()-t.getTime())/1e3);if(await s.from("game_participants").update({status:"completed",completed_at:new Date().toISOString(),time_spent:p}).in("id",m.map(_=>_.id)),n.value.game_mode==="team_battle"&&n.value.teams)for(const _ of n.value.teams)await D(_.id)}}const{data:a}=await s.from("game_rooms").select(`
        *,
        teams:game_teams!game_teams_room_id_fkey(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",n.value.id).single();if(!a)return null;let i=null,u=null,o=[];if(a.game_mode==="team_battle"&&a.teams)i=[...a.teams].sort((_,G)=>G.total_score-_.total_score)[0]?.id,o=a.participants?.filter(_=>_.team_id===i)||[];else{const m=[...a.participants||[]].sort((_,G)=>G.score!==_.score?G.score-_.score:(_.time_spent||999999)-(G.time_spent||999999)),p=m[0];p&&(o=m.filter(_=>_.score===p.score&&(_.time_spent||999999)===(p.time_spent||999999)),o.length===1&&(u=p.user_id))}await s.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:i,winner_user_id:u}).eq("id",a.id);const v=!i&&!u&&o.length>1,f=a.participants?.reduce((m,p)=>m+(p.fee_paid||0),0)||0;let g=[];if(f>0&&o.length>0){const m={...a,prize_pool:f};v?g=await oe(m,o):g=await ie(m,o)}return v||await le(a,o),{room:a,winners:o,winningTeam:a.teams?.find(m=>m.id===i),prizeDistribution:g}}async function ie(t,e){if(!s)return[];const a=A().user?.id,i=Math.floor(t.prize_pool/e.length),u=[];for(const o of e){const f=i+0;if(o.user_id===a){const{data:g}=await s.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",o.user_id).single(),p=(g?.total_beans||0)+f;await s.from("profiles").update({total_beans:p,weekly_beans:(g?.weekly_beans||0)+f,monthly_beans:(g?.monthly_beans||0)+f,updated_at:new Date().toISOString()}).eq("id",o.user_id),await s.from("game_participants").update({prize_won:f}).eq("id",o.id),l.value&&l.value.id===o.id&&(l.value.prize_won=f),await s.from("game_transactions").insert({user_id:o.user_id,room_id:t.id,type:"prize",amount:f,balance_after:p,description:`æ”¶è±† ${i} è±†`}),console.log(`ğŸ‰ ${o.user?.display_name} ç²å¾— ${f} è±†ï¼Œé¤˜é¡ ${p} è±†`)}u.push({userId:o.user_id,displayName:o.user?.display_name||"æœªçŸ¥",prize:i,streakBonus:0})}return u}async function oe(t,e){if(!s)return[];const a=A().user?.id;console.log(`ğŸ¤ å¹³å±€ï¼é€€é‚„å…¥å ´è²»çµ¦ ${e.length} ä½ç©å®¶`);const i=[];for(const u of e){const o=u.fee_paid||t.entry_fee||0;if(o<=0){console.log(`âš ï¸ ${u.user?.display_name} æ²’æœ‰æ”¯ä»˜å…¥å ´è²»ï¼Œè·³é`);continue}if(u.user_id===a){const{data:v}=await s.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",u.user_id).single(),g=(v?.total_beans||0)+o;await s.from("profiles").update({total_beans:g,weekly_beans:(v?.weekly_beans||0)+o,monthly_beans:(v?.monthly_beans||0)+o,updated_at:new Date().toISOString()}).eq("id",u.user_id),await s.from("game_participants").update({prize_won:o}).eq("id",u.id),l.value&&l.value.id===u.id&&(l.value.prize_won=o),await s.from("game_transactions").insert({user_id:u.user_id,room_id:t.id,type:"refund",amount:o,balance_after:g,description:`å¹³å±€ï¼Œè¿”é‚„å…¥å ´è²» ${o} è±†`}),console.log(`ğŸ’° å·²é€€é‚„ ${o} è±†çµ¦ ${u.user?.display_name}ï¼Œé¤˜é¡ ${g} è±†`)}i.push({userId:u.user_id,displayName:u.user?.display_name||"æœªçŸ¥",prize:o,streakBonus:0})}return i}async function le(t,e){if(!s)return;const r=new Set(e.map(a=>a.user_id));for(const a of t.participants||[]){const i=r.has(a.user_id);i?await s.rpc("increment_win_streak",{p_user_id:a.user_id}):await s.from("user_stats").update({pvp_win_streak:0}).eq("user_id",a.user_id),await s.rpc("increment_pvp_games",{p_user_id:a.user_id,p_is_win:i})}}let $=null,S=0;const U=3;function q(t){if(!s){console.log("[Game] subscribeToRoom: supabase æœªåˆå§‹åŒ–"),F(t);return}if($===t&&T&&h.value){console.log("[Game] å·²ç¶“è¨‚é–±æˆ¿é–“:",t,"ï¼Œè·³éé‡è¤‡è¨‚é–±");return}console.log("[Game] é–‹å§‹è¨‚é–±æˆ¿é–“:",t),C(),$=t,S=0,T=s.channel(`game-room-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},e=>{const r=e.new,a=e.old;(r?.id||a?.id)===t&&(console.log("[Game] æˆ¿é–“æ›´æ–°:",e.eventType,r),r&&(n.value={...n.value,...r,participants:n.value?.participants,teams:n.value?.teams,host:n.value?.host,text:n.value?.text,class:n.value?.class},console.log("[Game] æˆ¿é–“ç‹€æ…‹å·²æ›´æ–°ç‚º:",r.status)))}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants"},async e=>{const r=e.new,a=e.old;(r?.room_id||a?.room_id)===t&&(console.log("[Game] åƒèˆ‡è€…æ›´æ–°:",e.eventType),await j(t))}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams"},async e=>{const r=e.new,a=e.old;(r?.room_id||a?.room_id)===t&&(console.log("[Game] åœ˜éšŠæ›´æ–°:",e.eventType),await ce(t))}).subscribe(e=>{console.log("[Game] æˆ¿é–“è¨‚é–±ç‹€æ…‹:",e),e==="SUBSCRIBED"?(h.value=!0,k(),S=0,console.log("[Game] âœ… Realtime è¨‚é–±æˆåŠŸ")):e==="CHANNEL_ERROR"||e==="TIMED_OUT"?(h.value=!1,console.error("[Game] âŒ Realtime è¨‚é–±å¤±æ•—:",e),$=null,S<U?(S++,console.log(`[Game] å˜—è©¦é‡æ–°è¨‚é–± (${S}/${U})...`),setTimeout(()=>{n.value?.id===t&&q(t)},2e3*S)):(console.log("[Game] Realtime è¨‚é–±é‡è©¦æ¬¡æ•¸ç”¨ç›¡ï¼Œå•Ÿç”¨è¼ªè©¢å‚™ç”¨æ–¹æ¡ˆ"),F(t))):e==="CLOSED"&&(h.value=!1,console.log("[Game] Realtime é€£æ¥å·²é—œé–‰"))})}function F(t){P||(console.log("[Game] ğŸ”„ å•Ÿå‹•è¼ªè©¢å‚™ç”¨æ–¹æ¡ˆï¼Œæ¯",M/1e3,"ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šæŒçºŒ",B/6e4,"åˆ†é˜"),I=Date.now(),P=setInterval(async()=>{if(!n.value||n.value.id!==t){console.log("[Game] æˆ¿é–“ä¸å­˜åœ¨ï¼Œåœæ­¢è¼ªè©¢"),k();return}if(I&&Date.now()-I>B){console.log("[Game] è¼ªè©¢è¶…æ™‚ï¼ˆ",B/6e4,"åˆ†é˜ï¼‰ï¼Œåœæ­¢è¼ªè©¢"),k();return}if(n.value.status==="finished"||n.value.status==="cancelled"){console.log("[Game] æˆ¿é–“å·²çµæŸï¼Œåœæ­¢è¼ªè©¢"),k();return}await W(t)},M),W(t))}function k(){P&&(clearInterval(P),P=null,I=null,console.log("[Game] è¼ªè©¢å·²åœæ­¢"))}async function W(t){if(s)try{const{data:e,error:r}=await s.from("game_rooms").select("status, started_at, ended_at").eq("id",t).single();if(r){console.error("[Game] è¼ªè©¢ç²å–æˆ¿é–“ç‹€æ…‹å¤±æ•—:",r);return}if(e&&n.value){const a=n.value.status;e.status!==a&&(console.log("[Game] è¼ªè©¢ç™¼ç¾ç‹€æ…‹è®ŠåŒ–:",a,"->",e.status),n.value={...n.value,status:e.status,started_at:e.started_at,ended_at:e.ended_at})}n.value?.status==="waiting"&&await j(t),n.value?.status==="playing"&&await ue(t)}catch(e){console.error("[Game] è¼ªè©¢éŒ¯èª¤:",e)}}async function ue(t){if(!s)return;const{data:e}=await s.from("game_participants").select("id, user_id, status, completed_at").eq("room_id",t);if(e&&n.value?.participants)for(const r of e){const a=n.value.participants.find(i=>i.id===r.id);a&&(a.status=r.status,a.completed_at=r.completed_at)}}async function j(t){if(!s)return;const{data:e}=await s.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",t);e&&n.value&&(n.value.participants=e,d.user&&(l.value=e.find(r=>r.user_id===d.user.id)||null))}async function ce(t){if(!s)return;const{data:e}=await s.from("game_teams").select("*").eq("room_id",t).order("order_index");e&&n.value&&(n.value.teams=e)}function C(){T&&(s?.removeChannel(T),T=null),$=null,h.value=!1,k()}async function de(){if(!s)return;y.value=!0;const{data:t,error:e}=await s.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);e?c.value=e.message:E.value=(t||[]).map(r=>({...r,participant_count:r.participants?.[0]?.count||0})),y.value=!1}async function me(t){if(!s)return[];const{data:e}=await s.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",t).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return e||[]}async function _e(){if(!s||!n.value||!d.user)return;const t=n.value.id,e=n.value.entry_fee||0;if(b.value&&n.value.status==="waiting"){console.log("[Game] æˆ¿ä¸»å–æ¶ˆæˆ¿é–“ï¼Œé€€é‚„æ‰€æœ‰äººå…¥å ´è²»");let r=n.value.participants||[];if(r.length===0||!r[0]?.fee_paid){const{data:a}=await s.from("game_participants").select("*, user:users!game_participants_user_id_fkey(id, display_name)").eq("room_id",t);a&&(r=a)}if(console.log(`[Game] æ‰¾åˆ° ${r.length} ä½åƒèˆ‡è€…éœ€è¦é€€æ¬¾`),e>0)for(const a of r)console.log(`[Game] é€€é‚„å…¥å ´è²»çµ¦ ${a.user_id}ï¼Œfee_paid: ${a.fee_paid}`),await H(a);await s.from("game_rooms").update({status:"cancelled"}).eq("id",t)}else!b.value&&n.value.status==="waiting"&&(console.log("[Game] ç©å®¶é›¢é–‹æˆ¿é–“"),((l.value?.fee_paid||0)>0||e>0)&&l.value&&(console.log(`[Game] é€€é‚„å…¥å ´è²» ${l.value.fee_paid||e} è±†`),await H(l.value)),await s.from("game_participants").delete().eq("room_id",t).eq("user_id",d.user.id));C(),n.value=null,l.value=null}async function H(t){if(!s)return;const e=t.fee_paid||n.value?.entry_fee||0;if(e<=0){console.log(`[Game] ${t.user_id} ç„¡éœ€é€€æ¬¾ï¼ˆé‡‘é¡ç‚º 0ï¼‰`);return}const{data:r}=await s.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",t.user_id).single(),i=(r?.total_beans||0)+e,{error:u}=await s.from("profiles").update({total_beans:i,weekly_beans:(r?.weekly_beans||0)+e,monthly_beans:(r?.monthly_beans||0)+e,updated_at:new Date().toISOString()}).eq("id",t.user_id);if(u){console.error("[Game] é€€æ¬¾å¤±æ•—:",u);return}await s.from("game_transactions").insert({user_id:t.user_id,room_id:t.room_id,type:"refund",amount:e,balance_after:i,description:"æˆ¿é–“å–æ¶ˆï¼Œé€€é‚„å…¥å ´è²»"}),console.log(`ğŸ’° å·²é€€é‚„ ${e} è±†çµ¦ ${t.user_id}ï¼Œæ–°é¤˜é¡: ${i}`),t.user_id===d.user?.id&&await w.fetchProfile()}function fe(){C(),n.value=null,l.value=null,E.value=[],c.value=null}return{currentRoom:n,rooms:E,myParticipant:l,loading:y,error:c,isRealtimeConnected:h,isHost:b,isPlaying:V,isWaiting:Y,isFinished:J,myTeam:K,createRoom:Q,joinRoom:Z,assignToTeam:N,randomAssignTeams:ee,leaveRoom:_e,startGame:te,submitScore:ae,submitTextProgress:se,fetchTexts:ne,endGame:L,subscribeToRoom:q,unsubscribe:C,fetchPublicRooms:de,fetchClassGames:me,reset:fe}});export{Se as u};
