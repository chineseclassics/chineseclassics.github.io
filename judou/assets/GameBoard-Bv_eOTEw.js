import{d as J,c,x as K,r as B,w as F,f as O,R as Q,a as i,g as e,h as m,t as n,e as A,b as y,n as W,F as x,j as M,m as I,i as _,l as X,o,_ as Y}from"./index-YghVDSQt.js";import{u as Z}from"./gameStore-CZnsM4Qf.js";import{b as u}from"./game-C73ZBjL5.js";import{T as z}from"./TeamBadge-Dsck63In.js";import{R as P}from"./RaceTrack-DLEfdqNb.js";import{B as ee}from"./BeanIcon-DYy2sFQJ.js";import"./userStatsStore-dh9svFY1.js";const te={class:"board-header"},ae={class:"header-left"},se={class:"text-info"},re={key:0},oe={class:"header-right"},ne={key:0,class:"main-content-wrapper"},ie={class:"time-progress-container"},le={class:"time-progress-header"},ce={class:"time-progress-bar"},me={class:"teams-cards-container"},de={class:"team-card-header"},ue={class:"team-card-title"},ve={class:"team-card-progress"},pe={class:"team-card-score"},_e={class:"score-value"},he={class:"team-card-members"},fe={class:"member-info"},ge=["src","alt"],be={key:1,class:"member-avatar-placeholder"},ye={class:"member-name"},ke={key:0,class:"member-status"},we={class:"score"},Ce={key:1,class:"finish-overlay"},Te={class:"finish-content"},Se={class:"final-ranking"},Be={class:"rank"},xe={class:"team-name"},Me={class:"team-members"},Ie={class:"team-avg-score"},ze={key:0,class:"winner-reward-section"},De={class:"winner-reward-header"},Re={class:"winner-reward-title"},$e={class:"winner-reward-amount"},Ge={class:"winner-reward-note"},Fe=J({__name:"GameBoard",setup(Ae){const N=X(),V=K(),h=Z(),E=c(()=>V.params.roomId),l=c(()=>h.currentRoom),D=c(()=>l.value?.teams||[]),k=c(()=>l.value?.participants||[]),w=B(0);let d=null;const f=c(()=>l.value?.status==="finished"),T=c(()=>D.value.map(s=>{const a=k.value.filter(b=>b.team_id===s.id),t=a.filter(b=>b.status==="completed"),r=a.reduce((b,H)=>b+(H.score||0),0),p=a.length>0?r/a.length:0;return{team:s,memberCount:a.length,completedCount:t.length,averageScore:p}})),C=c(()=>[...T.value].sort((s,a)=>a.averageScore-s.averageScore)),v=c(()=>C.value[0]||null),j=c(()=>v.value?k.value.filter(s=>s.team_id===v.value.team.id):[]),L=c(()=>{const s={};for(const a of D.value)s[a.id]=k.value.filter(t=>t.team_id===a.id).sort((t,r)=>r.score-t.score);return s}),R=c(()=>T.value.length?T.value.map(s=>{const a=u(s.team),t=C.value.findIndex(r=>r.team.id===s.team.id)+1;return{id:s.team.id,team:s.team,displayAvg:s.averageScore,rank:t,productType:a,isMyTeam:!1,name:s.team.team_name,memberCount:s.memberCount,completedCount:s.completedCount}}):[]),S=B(0),g=B([]);F(()=>k.value,(s,a)=>{!a||a.length===0||(s.forEach(t=>{const r=a.find(p=>p.id===t.id);r&&(t.status==="completed"&&r.status!=="completed"?g.value.unshift({id:`${t.id}-${Date.now()}`,participant:t,action:"completed",score:t.score,timestamp:Date.now()}):t.score!==r.score&&t.score>r.score&&g.value.unshift({id:`${t.id}-${Date.now()}`,participant:t,action:"scored",score:t.score,timestamp:Date.now()}))}),g.value.length>10&&(g.value=g.value.slice(0,10)))},{deep:!0});function U(s){const a=Math.floor(s/60),t=s%60;return`${a}:${t.toString().padStart(2,"0")}`}function $(){if(!l.value?.started_at||!l.value?.time_limit)return;const s=()=>{const a=new Date(l.value.started_at).getTime(),t=Math.floor((Date.now()-a)/1e3);w.value=Math.max(0,l.value.time_limit-t);const r=Math.min(t/l.value.time_limit,1);S.value=r*100,w.value===0&&(d&&(clearInterval(d),d=null),f.value||h.endGame())};s(),d=setInterval(s,1e3)}async function q(){confirm("ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ")&&await h.endGame()}function G(){h.reset(),N.push({name:"arena"})}return F(()=>l.value?.status,s=>{s==="playing"&&!d&&$()}),O(()=>{h.subscribeToRoom(E.value),l.value?.status==="playing"&&$()}),Q(()=>{d&&clearInterval(d)}),(s,a)=>(o(),i("div",{class:y(["game-board",{finished:f.value}])},[e("header",te,[e("div",ae,[e("button",{class:"back-btn",onClick:G}," â† é›¢é–‹ "),e("div",se,[e("h1",null,n(l.value?.text?.title),1),l.value?.text?.author?(o(),i("p",re,n(l.value?.text?.author),1)):m("",!0)])]),e("div",oe,[f.value?m("",!0):(o(),i("button",{key:0,class:"btn-danger",onClick:q}," çµæŸæ¯”è³½ "))])]),!f.value&&R.value.length?(o(),i("div",ne,[A(P,{teams:R.value,height:150,"racer-size":72,"show-rankings":!1,class:"teacher-race-track"},null,8,["teams"]),e("div",ie,[e("div",le,[a[0]||(a[0]=e("span",{class:"time-progress-label"},"å‰©é¤˜æ™‚é–“",-1)),e("span",{class:y(["time-progress-text",{warning:w.value<30}])},n(U(w.value)),3)]),e("div",ce,[e("div",{class:y(["time-progress-fill",{warning:S.value>80}]),style:W({width:`${S.value}%`})},null,6)]),a[1]||(a[1]=e("div",{class:"time-progress-footer"},[e("span",{class:"time-progress-start"},"é–‹å§‹"),e("span",{class:"time-progress-end"},"çµæŸ")],-1))]),e("div",me,[(o(!0),i(x,null,M(C.value,t=>(o(),i("div",{key:t.team.id,class:"team-card"},[e("div",de,[_(u)(t.team)?(o(),I(z,{key:0,"product-type":_(u)(t.team),size:54,class:"team-card-badge"},null,8,["product-type"])):m("",!0),e("div",ue,[e("h3",null,n(t.team.team_name),1),e("span",ve,n(t.completedCount)+"/"+n(t.memberCount)+" äºº",1)]),e("div",pe,[e("span",_e,n(t.averageScore.toFixed(1)),1),a[2]||(a[2]=e("span",{class:"score-label"},"å¹³å‡åˆ†",-1))])]),e("div",he,[(o(!0),i(x,null,M(L.value[t.team.id],(r,p)=>(o(),i("div",{key:r.id,class:y(["member-item",{completed:r.status==="completed","top-scorer":p===0&&r.score>0}])},[e("div",fe,[r.user?.avatar_url?(o(),i("img",{key:0,src:r.user.avatar_url,alt:r.user.display_name,class:"member-avatar"},null,8,ge)):(o(),i("span",be,n(r.user?.display_name?.charAt(0)||"?"),1)),e("span",ye,n(r.user?.display_name||"æœªçŸ¥"),1)]),p===0&&r.score>0?(o(),i("div",ke,[e("span",we,n(r.score)+" åˆ†",1)])):m("",!0)],2))),128))])]))),128))])])):m("",!0),f.value?(o(),i("div",Ce,[e("div",Te,[a[5]||(a[5]=e("h2",null,"æ¯”è³½çµæŸï¼",-1)),e("div",Se,[(o(!0),i(x,null,M(C.value,(t,r)=>(o(),i("div",{key:t.team.id,class:y(["ranking-item",{winner:r===0}])},[e("span",Be,n(r===0?"ğŸ†":r+1),1),_(u)(t.team)?(o(),I(z,{key:0,"product-type":_(u)(t.team),size:54,class:"team-badge-in-mini-ranking"},null,8,["product-type"])):m("",!0),e("span",xe,n(t.team.team_name),1),e("span",Me,n(t.completedCount)+"/"+n(t.memberCount)+" äºº",1),e("span",Ie,n(t.averageScore.toFixed(1))+" åˆ†",1)],2))),128))]),v.value?(o(),i("div",ze,[e("div",De,[_(u)(v.value.team)?(o(),I(z,{key:0,"product-type":_(u)(v.value.team),size:54,class:"winner-badge"},null,8,["product-type"])):m("",!0),e("div",Re,[e("h3",null,n(v.value.team.team_name)+" ç²å‹ï¼",1),a[3]||(a[3]=e("p",{class:"winner-reward-subtitle"},"æ¯ä½æˆå“¡ç²å¾—",-1))])]),e("div",$e,[a[4]||(a[4]=e("span",{class:"reward-number"},"20",-1)),A(ee,{size:48,class:"reward-bean-icon"})]),e("p",Ge,"å…± "+n(j.value.length)+" ä½æˆå“¡",1)])):m("",!0),a[6]||(a[6]=e("p",{class:"scoring-note"},"* ä»¥éšŠå“¡å¹³å‡åˆ†è¨ˆç®—æ’å",-1)),e("button",{class:"btn-primary btn-large",onClick:G}," è¿”å›é¬¥è±† ")])])):m("",!0)],2))}}),He=Y(Fe,[["__scopeId","data-v-ed3aae13"]]);export{He as default};
