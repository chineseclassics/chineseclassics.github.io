import{v as W,u as Y,r as f,c as T,H as o}from"./index-ByTECD9N.js";const d=[0,30,100,200,350,550,850,1300,2e3,3e3],$=[{maxTime:1,factor:1.3},{maxTime:2,factor:1.2},{maxTime:3,factor:1.1},{maxTime:5,factor:1},{maxTime:8,factor:.9},{maxTime:1/0,factor:.7}],v=[1.2,1,.95,.9],B=[{minDays:30,factor:1.2},{minDays:14,factor:1.15},{minDays:7,factor:1.1},{minDays:3,factor:1.05},{minDays:0,factor:1}],K=1.2,y=5,_=10,ae=W("userStats",()=>{const c=Y(),a=f(null),w=f(!1),h=f(null),m=f([]),S=f("total"),b=f(!1),g=f(null),p=T(()=>{if(!a.value)return 1;const e=a.value.total_beans;for(let t=d.length-1;t>=0;t--){const r=d[t];if(r!==void 0&&e>=r)return t+1}return 1}),q=T(()=>{if(!a.value)return 0;const e=p.value,t=d[e-1]||0,r=d[e]||t+1e3,s=a.value.total_beans-t,n=r-t;return Math.min(100,Math.round(s/n*100))}),M=T(()=>{if(!a.value)return 30;const e=p.value;if(e>=d.length)return 0;const t=d[e]||3e3;return Math.max(0,t-a.value.total_beans)});function D(e){for(const t of $)if(e<t.maxTime)return t.factor;return .7}function x(e){return e<=0?1:e>v.length?v[v.length-1]||.9:v[e-1]||.9}function I(e){for(const t of B)if(e>=t.minDays)return t.factor;return 1}function N(e){const{breakCount:t,charCount:r,elapsedSeconds:s,attemptCount:n,isFirstClear:l}=e,i=t*2,u=r>0?s/r:5,F=D(u),O=x(n),j=a.value?.streak_days||0,A=I(j),P=l?K:1;return{score:Math.round(i*F*O*A*P),breakdown:{baseScore:i,timeFactor:F,attemptFactor:O,streakFactor:A,firstClearFactor:P,avgTimePerChar:Math.round(u*10)/10}}}async function R(){if(!(!o||!c.user)){w.value=!0,h.value=null;try{const{data:e,error:t}=await o.from("profiles").select("*").eq("id",c.user.id).single();if(t){if(t.code==="PGRST116"){console.warn("ç”¨æˆ¶ Profile ä¸å­˜åœ¨");return}throw t}a.value=e,await E()}catch(e){h.value=e.message,console.error("ç²å–ç”¨æˆ¶ Profile å¤±æ•—:",e)}finally{w.value=!1}}}async function E(){if(!o||!a.value||!c.user)return!1;const e=new Date().toISOString().split("T")[0],t=a.value.last_login_date;if(t===e&&a.value.daily_login_claimed)return!1;try{const r={last_login_date:e,daily_login_claimed:!0,total_beans:a.value.total_beans+y,weekly_beans:a.value.weekly_beans+y,monthly_beans:a.value.monthly_beans+y,updated_at:new Date().toISOString()};t!==e&&(r.daily_first_claimed=!1);const{error:s}=await o.from("profiles").update(r).eq("id",c.user.id);if(s)throw s;return Object.assign(a.value,r),console.log(`ðŸŽ æ¯æ—¥ç™»å…¥çŽå‹µ +${y} è±†`),!0}catch(r){return console.error("ç™¼æ”¾æ¯æ—¥ç™»å…¥çŽå‹µå¤±æ•—:",r),!1}}async function L(){if(!o||!a.value||!c.user||a.value.daily_first_claimed)return 0;try{const e={daily_first_claimed:!0,total_beans:a.value.total_beans+_,weekly_beans:a.value.weekly_beans+_,monthly_beans:a.value.monthly_beans+_,updated_at:new Date().toISOString()},{error:t}=await o.from("profiles").update(e).eq("id",c.user.id);if(t)throw t;return Object.assign(a.value,e),console.log(`ðŸŽ æ¯æ—¥é¦–ç·´çŽå‹µ +${_} è±†`),_}catch(e){return console.error("ç™¼æ”¾æ¯æ—¥é¦–ç·´çŽå‹µå¤±æ•—:",e),0}}async function C(){if(!o||!a.value||!c.user)return;const e=new Date().toISOString().split("T")[0],t=a.value.last_practice_date;let r=a.value.streak_days;if(!t)r=1;else{const n=new Date(t),l=new Date(e),i=Math.floor((l.getTime()-n.getTime())/(1e3*60*60*24));if(i===0)return;i===1?r=a.value.streak_days+1:r=1}const s=Math.max(a.value.max_streak,r);try{const{error:n}=await o.from("profiles").update({streak_days:r,max_streak:s,last_practice_date:e,updated_at:new Date().toISOString()}).eq("id",c.user.id);if(n)throw n;a.value.streak_days=r,a.value.max_streak=s,a.value.last_practice_date=e}catch(n){console.error("æ›´æ–°é€£çºŒå¤©æ•¸å¤±æ•—:",n)}}async function U(e){if(!o||!c.user)return!1;try{const{data:t,error:r}=await o.from("user_text_scores").select("id").eq("user_id",c.user.id).eq("text_id",e).single();return r&&r.code==="PGRST116"?!0:!t}catch{return!1}}async function G(e){if(!o||!a.value||!c.user)return{beansEarned:0,isNewRecord:!1};const{textId:t,score:r}=e;try{const{data:s}=await o.from("user_text_scores").select("*").eq("user_id",c.user.id).eq("text_id",t).single();let n=0,l=!1;if(!s)await o.from("user_text_scores").insert({user_id:c.user.id,text_id:t,best_score:r,weekly_best:r,monthly_best:r,first_clear_at:new Date().toISOString(),attempt_count:1}),n=r,l=!0;else{const u={attempt_count:s.attempt_count+1,updated_at:new Date().toISOString()};r>s.best_score&&(n=r-s.best_score,u.best_score=r,l=!0),r>s.weekly_best&&(u.weekly_best=r),r>s.monthly_best&&(u.monthly_best=r),await o.from("user_text_scores").update(u).eq("id",s.id)}if(n>0){const{error:u}=await o.from("profiles").update({total_beans:a.value.total_beans+n,weekly_beans:a.value.weekly_beans+n,monthly_beans:a.value.monthly_beans+n,updated_at:new Date().toISOString()}).eq("id",c.user.id);u||(a.value.total_beans+=n,a.value.weekly_beans+=n,a.value.monthly_beans+=n)}await C();const i=await L();return n+=i,{beansEarned:n,isNewRecord:l}}catch(s){return console.error("è¨˜éŒ„ç·´ç¿’åˆ†æ•¸å¤±æ•—:",s),{beansEarned:0,isNewRecord:!1}}}async function k(e="total"){if(o){b.value=!0,S.value=e;try{const t=e==="weekly"?"weekly_beans":e==="monthly"?"monthly_beans":"total_beans",{data:r,error:s}=await o.from("profiles").select("id, display_name, total_beans, weekly_beans, monthly_beans").order(t,{ascending:!1}).limit(10);if(s)throw s;const n=c.user?.id;if(m.value=(r||[]).map((l,i)=>({rank:i+1,userId:l.id,name:l.display_name||"åŒ¿å",beans:e==="weekly"?l.weekly_beans:e==="monthly"?l.monthly_beans:l.total_beans,isCurrentUser:l.id===n})),n){const{count:l}=await o.from("profiles").select("*",{count:"exact",head:!0}).gt(t,a.value?.[t==="total_beans"?"total_beans":t==="weekly_beans"?"weekly_beans":"monthly_beans"]||0),{count:i}=await o.from("profiles").select("*",{count:"exact",head:!0});g.value={rank:(l||0)+1,totalUsers:i||0}}}catch(t){console.error("ç²å–æŽ’è¡Œæ¦œå¤±æ•—:",t),m.value=[]}finally{b.value=!1}}}function H(){a.value=null,m.value=[],g.value=null,h.value=null}return{profile:a,stats:a,loading:w,error:h,leaderboard:m,top10:m,leaderboardType:S,leaderboardLoading:b,top10Loading:b,rankInfo:g,level:p,levelProgress:q,beansToNextLevel:M,getTimeFactor:D,getAttemptFactor:x,getStreakFactor:I,calculateScore:N,fetchProfile:R,fetchStats:R,fetchLeaderboard:k,fetchTop10:()=>k("total"),fetchRankInfo:()=>k(S.value),checkFirstClear:U,recordPracticeScore:G,checkDailyLoginReward:E,checkDailyFirstPracticeReward:L,updateStreakDays:C,reset:H,DAILY_LOGIN_REWARD:y,DAILY_FIRST_PRACTICE_REWARD:_,LEVEL_THRESHOLDS:d}});export{ae as u};
