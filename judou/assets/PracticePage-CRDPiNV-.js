import{d as We,u as Fe,r as d,c as b,x as Je,f as Qe,E as Ke,a as r,g as a,h as _,t as u,s as g,m as ke,G as ye,b as y,H as ge,I as Ye,F as p,j as L,J as Ze,q as et,i as j,e as be,v as tt,p as st,n as at,o as l,_ as nt}from"./index-1aPAotcY.js";import{u as lt}from"./textsStore-B-6KlFlt.js";import{u as rt}from"./practiceLibraryStore-CowXIo9Z.js";import{u as ot}from"./assignmentStore-DCd5-rWo.js";import{u as it}from"./userStatsStore-DVJNDrDr.js";import{u as ut}from"./classStore-CWydK4Pf.js";import{u as ct}from"./avatarStore-DLDJHH7t.js";import{S as dt,V as vt,c as mt,a as pt,b as ft}from"./useClassicalTTS-Dl0kA-qb.js";import{C as ht}from"./clock-B4rdvzuv.js";import{c as _t}from"./createLucideIcon-CV9J0hgt.js";import"./useSupabase-C72HxeaJ.js";const kt=_t("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),yt={class:"practice-shell"},gt={class:"picker-section edamame-glass"},bt={class:"picker-current"},Tt={class:"picker-info"},wt={class:"picker-breadcrumb"},St={key:0,class:"picker-meta"},Ct={key:0},xt={key:0,class:"picker-panel"},At={class:"picker-search"},Bt={key:0,class:"picker-results"},$t={key:0,class:"picker-empty"},Rt=["onClick"],Vt={class:"item-main"},It={class:"item-title"},zt={class:"item-author"},Nt={class:"item-preview"},Pt={key:1,class:"picker-cascade"},Mt={class:"cascade-row"},Lt={class:"cascade-select full-width"},qt=["value"],Et={class:"picker-list"},Ut={key:0,class:"picker-empty"},jt={key:1,class:"picker-empty"},Dt=["onClick"],Gt={class:"item-main"},Ot={class:"item-title"},Xt={class:"item-author"},Ht={class:"item-preview"},Wt={class:"hero-actions"},Ft=["disabled"],Jt={class:"board-card edamame-glass"},Qt={key:0,class:"practice-board"},Kt={class:"board-header"},Yt={class:"board-header-right"},Zt={key:1,class:"timer-badge"},es={key:0,class:"practice-line"},ts=["onPointerdown","aria-label"],ss={key:0,class:"bean"},as={key:1,class:"state-info"},ns={class:"board-actions"},ls=["disabled"],rs={key:1,class:"board-empty"},os={class:"results-grid"},is={class:"result-card edamame-glass"},us={class:"result-desc"},cs={class:"result-card edamame-glass"},ds={class:"result-desc"},vs={class:"result-card edamame-glass"},ms={class:"result-desc"},ps={class:"result-card edamame-glass"},fs={class:"result-desc"},hs={key:0,class:"new-record"},_s={key:1},ks={key:2},ys=We({__name:"PracticePage",setup(gs){const Z=Je(),T=lt(),D=rt(),Te=ot(),h=Fe(),G=it(),ee=ut(),we=ct(),te=d(new Set),se=b(()=>Z.query.assignmentId),ae=b(()=>Z.query.textId),c=d(null),k=d([]),w=d(new Set),m=d(new Set),o=d(null),I=d(0),v=d(null),O=d(!1),X=d(0),ne=d(0),le=d(0),H=d(!1),W=d(!1),re=b(()=>w.value.size),Se=b(()=>m.value.size),oe=b(()=>Math.max(0,re.value-Se.value)),ie=b(()=>oe.value>0),z=d(!1),S=d(null),A=d(""),Ce=d(localStorage.getItem("judou_username")||"guest"),xe=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡"),B=d(!1);let N=null;const C=d(null);function ue(){C.value||(C.value=new(window.AudioContext||window.webkitAudioContext))}function F(t){if(C.value||ue(),!C.value)return;const e=C.value,n=e.createOscillator(),s=e.createGain();n.connect(s),s.connect(e.destination),t==="add"?(n.frequency.setValueAtTime(400,e.currentTime),n.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),n.start(e.currentTime),n.stop(e.currentTime+.1)):(n.frequency.setValueAtTime(300,e.currentTime),n.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),n.start(e.currentTime),n.stop(e.currentTime+.08))}function ce(t=10){navigator.vibrate&&navigator.vibrate(t)}const J=b(()=>D.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index));function Q(t){return!!(t.is_system===!0||t.created_by===h.user?.id||h.isStudent&&t.created_by&&te.value.has(t.created_by))}const de=b(()=>S.value?T.texts.filter(t=>t.category_id!==S.value?!1:Q(t)).sort((t,e)=>t.title.localeCompare(e.title)):[]),ve=b(()=>{if(!A.value.trim())return[];const t=A.value.toLowerCase();return T.texts.filter(e=>Q(e)?e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t):!1).slice(0,10)}),Ae=b(()=>{if(!c.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];return c.value.category?.name&&t.push(c.value.category.name),t.push(c.value.title),t.join(" â€º ")});async function Be(){if(!h.isStudent||!h.isAuthenticated)return;await ee.fetchStudentClasses();const t=new Set;for(const e of ee.classes)e.teacher_id&&t.add(e.teacher_id);te.value=t}function $e(t){const e=[],n=new Set;let s=0;for(const i of t)i==="|"?s>0&&n.add(s-1):i!==`
`&&i!=="\r"&&(e.push(i),s++);return{chars:e,breaks:n}}function Re(){q(),I.value=0,N=window.setInterval(()=>{I.value+=1},1e3)}function q(){N&&(clearInterval(N),N=null)}function K(t){const{chars:e,breaks:n}=$e(t.content);k.value=e,w.value=n,m.value=new Set,o.value=null,v.value=null,q(),I.value=0,X.value=0,ne.value=0,le.value=0,H.value=!1}function E(t){c.value=t,K(t),z.value=!1,A.value="",t.category_id&&(S.value=t.category_id)}function me(){const t=T.texts.filter(x=>x.text_type==="practice"&&Q(x));if(!t.length){v.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}const e=c.value?.id,n=t.filter(x=>x.id!==e);if(!n.length){v.value="ç›®å‰åªæœ‰ä¸€ç¯‡æ–‡ç« å¯ç·´ç¿’";return}const s=Math.floor(Math.random()*n.length),i=n[s];i&&E(i)}async function Ve(){const t=[];if(T.texts.length||t.push(T.fetchTexts()),D.state.categories.length||t.push(D.fetchLibrary()),h.isStudent&&h.isAuthenticated&&t.push(Be()),await Promise.all(t),ae.value){const e=T.texts.find(n=>n.id===ae.value);if(e){E(e);return}}if(!c.value&&T.texts.length&&me(),!S.value&&J.value.length){const e=J.value[0];e&&(S.value=e.id)}}function Ie(t){if(o.value){v.value="å·²æäº¤ï¼å¦‚è¦å†æ¬¡å˜—è©¦è«‹é»æ“Šã€Œé‡æ–°æŒ‘æˆ°ã€";return}const e=new Set(m.value),n=e.has(t);if(!n&&!ie.value){ze(),v.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}m.value.size===0&&!N&&!H.value&&Re(),n?(e.delete(t),F("remove")):(e.add(t),F("add"),ce(10)),m.value=e,v.value=null}function ze(){W.value=!0,F("remove"),ce(50),setTimeout(()=>{W.value=!1},400)}function Ne(t){if(!o.value){const e=t>0&&m.value.has(t-1),n=m.value.has(t);if(e&&n)return"translateX(0)";if(e)return"translateX(4px)";if(n)return"translateX(-4px)"}return"translateX(0)"}function Pe(t){const e=[],n=m.value.has(t);if(n&&e.push("has-bean"),o.value&&n){const s=o.value.statuses.find(i=>i.index===t);s&&(s.state==="correct"||s.state==="extra")&&e.push(s.state)}return e}function Me(t){return`${t} è±†`}function Le(t){return`${Math.round(t*100)}%`}function pe(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function qe(t,e){return G.calculateScore({correctCount:t,totalBreaks:w.value.size,charCount:k.value.length,elapsedSeconds:e})}async function Ee(){if(!c.value)return;if(!m.value.size){v.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}X.value++;const t=[];let e=0,n=0,s=0;for(let f=0;f<=k.value.length;f++){const M=m.value.has(f),V=w.value.has(f);M&&V?(t.push({index:f,state:"correct"}),e++):!M&&V?(t.push({index:f,state:"missed"}),n++):M&&!V?(t.push({index:f,state:"extra"}),s++):t.push({index:f,state:"pending"})}const i=w.value.size?e/w.value.size:m.value.size?0:1,x=n===0&&s===0;q(),H.value=!0;const U=I.value;X.value===1&&(ne.value=i,le.value=U);const{score:R,breakdown:Y}=qe(e,U);if(o.value={statuses:t,accuracy:i,elapsed:U,score:R,isComplete:x,breakdown:Y},x){je();const f=Y.speedBonus>0?` + é€Ÿåº¦çå‹µ ${Y.speedBonus}`:"";v.value=`ğŸ‰ å…¨å°ï¼æ­£ç¢º ${e} è±†${f} = ${R} è±†`}else v.value=`æ­£ç¢º ${e} å€‹ï¼Œéºæ¼ ${n} å€‹ï¼Œå¤šé¤˜ ${s} å€‹ â†’ ç²å¾— ${R} è±†`;try{O.value=!0;const f=h.isAuthenticated?h.user?.email?.split("@")[0]||"user":Ce.value,M=h.isAuthenticated?h.displayName:xe.value,V=await T.recordPracticeResult({text_id:c.value.id,score:R,accuracy:i,elapsed_seconds:U,user_breaks:m.value.size,correct_breaks:w.value.size,username:f,display_name:M,user_id:h.user?.id||null});if(h.isAuthenticated){const $=await G.recordPracticeScore({textId:c.value.id,score:R,textTitle:c.value.title});if(o.value&&(o.value.beansEarned=$.beansEarned,o.value.isNewRecord=$.isNewRecord),$.beansEarned>0){const Xe=$.isNewRecord?" (æ–°ç´€éŒ„!)":"";v.value=`${v.value}${Xe} å¯¦å¾— +${$.beansEarned} è±†`;const _e=await we.checkAndUnlockAvatars(G.level);_e.length>0&&setTimeout(()=>{v.value=`ğŸ‰ è§£é–æ–°é ­åƒï¼š${_e.map(He=>He.name).join("ã€")}`},2e3)}else $.beansEarned===0&&!$.isNewRecord&&(v.value=`${v.value}ï¼ˆæœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„ï¼Œä¸åŠ åˆ†ï¼‰`)}se.value&&h.isAuthenticated&&V&&await Te.recordCompletion(se.value,V,R,i*100)}catch(f){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",f)}finally{O.value=!1}}function Ue(){c.value&&K(c.value)}function je(){if(C.value||ue(),!C.value)return;const t=C.value,e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function De(){if(!k.value.length)return[];const t=[];let e="",n=-1;for(let s=0;s<k.value.length;s++)if(e+=k.value[s],w.value.has(s)){const i=s-n;n=s,i>=8?(e+="ã€‚",t.push(e),e=""):i>=4?e+="ï¼Œ":e+="ã€"}return e.trim()&&(!e.endsWith("ã€‚")&&!e.endsWith("ï¼Œ")&&!e.endsWith("ã€")&&(e+="ã€‚"),t.push(e)),t.length===0&&k.value.length>0?[k.value.join("")+"ã€‚"]:t}let P=!1;function fe(){P=!0,mt(),B.value=!1}const he={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function Ge(){if(!k.value.length)return;if(B.value){fe();return}B.value=!0,P=!1;const t=De();try{for(let e=0;e<t.length&&!P;e++){const n=t[e+1];n&&pt(n,he);const s=t[e];s&&await ft(s,he)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),P||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{B.value=!1,P=!1}}function Oe(){c.value&&K(c.value)}return Qe(()=>{Ve()}),Ke(()=>{q(),fe()}),(t,e)=>{const n=tt("router-link");return l(),r("div",yt,[a("section",gt,[a("div",{class:"picker-header",onClick:e[1]||(e[1]=s=>z.value=!z.value)},[a("div",bt,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",Tt,[a("span",wt,u(Ae.value),1),c.value?(l(),r("span",St,[g(u(c.value.author||"ä½šå")+" ",1),c.value.source?(l(),r("span",Ct," Â· "+u(c.value.source),1)):_("",!0),c.value.source_text?.id?(l(),ke(n,{key:1,to:{name:"reading-detail",params:{id:c.value.source_text.id}},class:"source-link",onClick:e[0]||(e[0]=ye(()=>{},["stop"]))},{default:st(()=>[g(" Â· ä¾†è‡ªã€Š"+u(c.value.source_text.title)+"ã€‹ ",1)]),_:1},8,["to"])):_("",!0)])):_("",!0)])]),a("button",{class:y(["picker-toggle",{expanded:z.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),z.value?(l(),r("div",xt,[a("div",At,[ge(a("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>A.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Ye,A.value]])]),A.value.trim()?(l(),r("div",Bt,[ve.value.length?_("",!0):(l(),r("div",$t," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+u(A.value)+"ã€çš„æ–‡ç«  ",1)),(l(!0),r(p,null,L(ve.value,s=>(l(),r("div",{key:s.id,class:"picker-item",onClick:i=>E(s)},[a("div",Vt,[a("span",It,u(s.title),1),a("span",zt,u(s.author||"ä½šå"),1)]),a("span",Nt,u(pe(s)),1)],8,Rt))),128))])):(l(),r("div",Pt,[a("div",Mt,[a("div",Lt,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),ge(a("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>S.value=s)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(l(!0),r(p,null,L(J.value,s=>(l(),r("option",{key:s.id,value:s.id},u(s.name),9,qt))),128))],512),[[Ze,S.value]])])]),a("div",Et,[S.value?de.value.length?_("",!0):(l(),r("div",jt," æ­¤å¹´ç´šå°šç„¡æ–‡ç«  ")):(l(),r("div",Ut," è«‹é¸æ“‡å¹´ç´šä»¥æŸ¥çœ‹æ–‡ç«  ")),(l(!0),r(p,null,L(de.value,s=>(l(),r("div",{key:s.id,class:y(["picker-item",{active:c.value?.id===s.id}]),onClick:i=>E(s)},[a("div",Gt,[a("span",Ot,u(s.title),1),a("span",Xt,u(s.author||"ä½šå"),1),a("span",{class:y(["item-difficulty",`diff-${s.difficulty}`])},u(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",Ht,u(pe(s)),1)],10,Dt))),128))])]))])):_("",!0)]),a("div",Wt,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Oe,disabled:!c.value}," é‡æ–°é–‹å§‹ ",8,Ft),a("button",{class:"edamame-btn edamame-btn-primary",onClick:me}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",Jt,[c.value?(l(),r("div",Qt,[a("div",Kt,[e[8]||(e[8]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Yt,[o.value?.isComplete?(l(),r("button",{key:0,class:y(["tts-btn-small",{playing:B.value}]),onClick:Ge},[(l(),ke(et(B.value?j(dt):j(vt)),{size:16,"stroke-width":1.5})),a("span",null,u(B.value?" åœæ­¢":" æœ—è®€"),1)],2)):_("",!0),a("div",{class:y(["bean-inventory",{shake:W.value,empty:!ie.value}])},[(l(!0),r(p,null,L(re.value,s=>(l(),r("span",{key:s,class:y(["inventory-bean",{used:s>oe.value}])},null,2))),128))],2),m.value.size>0||o.value?(l(),r("span",Zt,[be(j(ht),{size:14,"stroke-width":1.5}),a("span",null,u(I.value)+" ç§’",1)])):_("",!0)])]),k.value.length?(l(),r("div",es,[(l(!0),r(p,null,L(k.value,(s,i)=>(l(),r("span",{key:i,class:"char-unit"},[a("span",{class:"char",style:at({transform:Ne(i)})},u(s),5),i<k.value.length-1?(l(),r("button",{key:0,class:y(["bean-slot",Pe(i)]),onPointerdown:ye(x=>Ie(i),["prevent"]),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${m.value.has(i)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[m.value.has(i)?(l(),r("span",ss)):_("",!0),e[9]||(e[9]=a("span",{class:"bean-hint"},null,-1))],42,ts)):_("",!0)]))),128))])):(l(),r("div",as,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",ns,[o.value?(l(),r("button",{key:1,class:"edamame-btn edamame-btn-lg edamame-btn-secondary",onClick:Ue},[be(j(kt),{size:18,"stroke-width":1.5}),e[10]||(e[10]=a("span",null," é‡æ–°æŒ‘æˆ°",-1))])):(l(),r("button",{key:0,class:"edamame-btn edamame-btn-lg edamame-btn-primary",disabled:O.value,onClick:Ee}," æäº¤ç­”æ¡ˆ ",8,ls))]),v.value?(l(),r("p",{key:2,class:y(["toast",{success:o.value?.isComplete}])},u(v.value),3)):_("",!0)])):(l(),r("div",rs,[...e[11]||(e[11]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",os,[a("article",is,[e[12]||(e[12]=a("p",{class:"result-label"},"æœ¬æ¬¡å¾—åˆ†",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},u(o.value?Me(o.value.score):"--"),3),a("p",us,[o.value?.breakdown?(l(),r(p,{key:0},[g(" æ­£ç¢º "+u(o.value.breakdown.baseScore)+" è±† ",1),o.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[g(" + é€Ÿåº¦ "+u(o.value.breakdown.speedBonus)+" è±† ",1)],64)):_("",!0)],64)):(l(),r(p,{key:1},[g(" å°å¹¾å€‹å¾—å¹¾è±† ")],64))])]),a("article",cs,[e[13]||(e[13]=a("p",{class:"result-label"},"æ­£ç¢ºç‡",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},u(o.value?Le(o.value.accuracy):"--"),3),a("p",ds,[o.value?(l(),r(p,{key:0},[g(u(o.value.isComplete?"ğŸ‰ å…¨å°ï¼":"ç¹¼çºŒåŠ æ²¹"),1)],64)):(l(),r(p,{key:1},[g(" æ­£ç¢ºæ•¸ Ã· ç¸½æ–·å¥æ•¸ ")],64))])]),a("article",vs,[e[14]||(e[14]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},u(o.value?`${o.value.elapsed} ç§’`:"--"),3),a("p",ms,[o.value?.breakdown?(l(),r(p,{key:0},[g(" åŸºæº– "+u(o.value.breakdown.baseTime)+" ç§’ ",1),o.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[g(" Â· ç¯€çœ "+u(o.value.breakdown.baseTime-o.value.elapsed)+" ç§’ ",1)],64)):_("",!0)],64)):(l(),r(p,{key:1},[g(" å…¨å°æ‰æœ‰é€Ÿåº¦çå‹µ ")],64))])]),a("article",ps,[e[15]||(e[15]=a("p",{class:"result-label"},"å¯¦å¾—è±†å­",-1)),a("p",{class:y(["result-value",{placeholder:!o.value||o.value.beansEarned===void 0}])},u(o.value?.beansEarned!==void 0?`+${o.value.beansEarned}`:"--"),3),a("p",fs,[o.value?.beansEarned!==void 0?(l(),r(p,{key:0},[o.value.isNewRecord?(l(),r("span",hs,"ğŸ† æ–°ç´€éŒ„ï¼")):o.value.beansEarned===0?(l(),r("span",_s,"æœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„")):(l(),r("span",ks,"å¢é‡åŠ åˆ†"))],64)):(l(),r(p,{key:1},[g(" ç™»å…¥å¾Œè¨˜éŒ„ ")],64))])])])])}}}),Is=nt(ys,[["__scopeId","data-v-5f37d3de"]]);export{Is as default};
