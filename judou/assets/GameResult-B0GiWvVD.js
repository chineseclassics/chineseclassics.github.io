import{d as Y,u as Z,c as v,x as ee,r as C,w as te,f as se,a as r,g as a,h as i,t as u,b as _,e as U,F as M,j as I,s as A,k as ae,l as ne,i as V,m as re,o as n,_ as oe}from"./index-Bdbq4IX4.js";import{u as le}from"./gameStore-jY5P2ot_.js";import{u as ue}from"./userStatsStore-BIB2ZEcU.js";import{b as j}from"./game-C73ZBjL5.js";import{B as E}from"./BeanIcon-2ZEXLQo-.js";import{T as ie}from"./TeamBadge-Da30DxmI.js";const ce={class:"result-header"},ve={key:0,class:"result-icon"},de={key:1},me={key:2},pe={class:"bean-sign"},_e={key:0,class:"bean-note"},fe={key:0,class:"ranking-section"},ge={class:"ranking-list"},he=["src","alt"],ke={key:1,class:"avatar-placeholder"},ye={class:"name"},be={class:"score"},we={class:"accuracy"},Se={class:"time"},Be={key:1,class:"streak-card"},Ce={class:"streak-text"},Ae={key:2,class:"answers-section"},Te={key:0,class:"result-tabs"},xe=["onClick"],Re={class:"tab-number"},Me={class:"tab-title"},Ie={class:"tab-stats"},Pe={key:1,class:"answer-detail"},Ve={class:"answer-header"},ze={key:0,class:"answer-author"},Fe={class:"answer-stats"},Ne={class:"stat correct"},De={class:"stat wrong"},$e={class:"stat missed"},Ge={class:"answer-content"},qe={class:"answer-line"},Ue={class:"answer-char"},je={key:3,class:"ranking-section"},Ee={class:"team-ranking-list"},Je={class:"rank"},Le={class:"team-name-group"},Oe={class:"team-name"},We={key:0,class:"team-reward-badge"},He={class:"team-score"},Ke=Y({__name:"GameResult",setup(Qe){const P=ne(),J=ee(),k=le(),T=Z(),z=ue(),x=v(()=>J.params.roomId),l=v(()=>k.currentRoom),y=v(()=>k.myParticipant),L=v(()=>l.value?.participants||[]),F=v(()=>l.value?.teams||[]),d=C(null),R=C(0),c=v(()=>{if(!d.value)return null;const s=d.value.texts[R.value],e=d.value.results[R.value];return!s||!e?null:{text:s,result:e}});function N(s){const e=[];for(const t of s)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function D(s){if(!c.value?.result)return"none";const e=c.value.result,t=e.userBreaks.includes(s),o=e.correctBreaks.includes(s);return t&&o?"correct":t&&!o?"wrong":!t&&o?"missed":"none"}const p=v(()=>{if(!l.value||!T.user)return!1;if(l.value.game_mode==="team_battle")return y.value?.team_id===l.value.winner_team_id;{if(l.value.winner_user_id)return l.value.winner_user_id===T.user.id;if(!l.value.participants)return!1;const s=y.value?.score??0,e=y.value?.time_spent??999999,t=Math.max(...l.value.participants.map(m=>m.score)),o=l.value.participants.filter(m=>m.score===t),w=Math.min(...o.map(m=>m.time_spent??999999));return s===t&&e===w}}),f=v(()=>!l.value||l.value.game_mode==="team_battle"?!1:!l.value.winner_user_id&&p.value),O=v(()=>l.value?.participants?[...l.value.participants].sort((s,e)=>e.score-s.score).map((s,e)=>({...s,rank:e+1})):[]),W=v(()=>F.value.length?F.value.map(s=>{const e=L.value.filter(S=>S.team_id===s.id),t=e.reduce((S,B)=>S+(B.score||0),0),o=e.length>0?t/e.length:0,m=(typeof s.total_score=="number"?s.total_score/100:0)||o;return{...s,averageScore:m}}).sort((s,e)=>e.averageScore-s.averageScore):[]),$=v(()=>z.profile?.pvp_win_streak??0),G=C(!1),b=C(0),g=C(!1),h=v(()=>{if(!y.value||!l.value)return{amount:0,type:"neutral"};if(l.value.game_mode==="team_battle")return p.value?{amount:20,type:"win"}:{amount:0,type:"neutral"};const s=y.value.fee_paid||l.value.entry_fee||0,e=l.value.participants?.length||0;return f.value?{amount:0,type:"tie"}:p.value&&s>0?{amount:s*e,type:"win"}:!p.value&&s>0?{amount:-s,type:"lose"}:{amount:0,type:"neutral"}});function H(){const s=Math.abs(h.value.amount),e=h.value.type;if(s===0&&e!=="tie"){g.value=!0;return}G.value=!0,b.value=0,g.value=!1;const t=2500,o=Date.now(),w=s>0?s:100;function m(){const S=Date.now()-o,B=Math.min(S/t,1);if(B<1){if(B<.8)b.value=Math.floor(Math.random()*w*1.5);else{const q=(B-.8)/.2;b.value=Math.floor(s*q+Math.random()*(s*(1-q)))}requestAnimationFrame(m)}else b.value=s,g.value=!0}setTimeout(()=>{requestAnimationFrame(m)},500)}function K(s){d.value&&s>=0&&s<d.value.texts.length&&(R.value=s)}function Q(){k.reset(),sessionStorage.removeItem(`game-result-${x.value}`),P.push({name:"arena"})}function X(){k.reset(),sessionStorage.removeItem(`game-result-${x.value}`),T.isTeacher?P.push({name:"arena-teacher-create"}):P.push({name:"arena-create"})}return te(()=>l.value?.status,s=>{}),se(()=>{k.subscribeToRoom(x.value),z.fetchProfile();const s=sessionStorage.getItem(`game-result-${x.value}`);if(s)try{d.value=JSON.parse(s)}catch{}H()}),(s,e)=>(n(),r("div",{class:_(["game-result",{winner:p.value,tie:f.value}])},[a("header",ce,[f.value||p.value?(n(),r("div",ve,u(f.value?"ğŸ¤":"ğŸ†"),1)):i("",!0),!f.value&&p.value?(n(),r("h1",de,"æ­å–œç²å‹ï¼")):f.value?(n(),r("h1",me,"å¹³å±€ï¼")):i("",!0),G.value||h.value.type!=="neutral"?(n(),r("div",{key:3,class:_(["bean-change-display",[h.value.type,{complete:g.value}]])},[a("span",pe,u(h.value.type==="lose"?"-":h.value.type==="win"?"+":""),1),a("span",{class:_(["bean-number",{rolling:!g.value}])},u(b.value),3),U(E,{size:40,class:"bean-icon-img"}),f.value&&g.value?(n(),r("span",_e,"å…¥å ´è²»å·²é€€é‚„")):i("",!0)],2)):i("",!0)]),l.value?.game_mode==="pvp"?(n(),r("section",fe,[e[0]||(e[0]=a("h2",null,"æ’è¡Œæ¦œ",-1)),a("div",ge,[(n(!0),r(M,null,I(O.value,t=>(n(),r("div",{key:t.id,class:_(["ranking-item",{me:t.user_id===V(T).user?.id,top:t.rank<=3}])},[a("span",{class:_(["rank",`rank-${t.rank}`])},u(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(n(),r("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,he)):(n(),r("span",ke,u(t.user?.display_name?.charAt(0)||"?"),1)),a("span",ye,u(t.user?.display_name||"æœªçŸ¥"),1),a("span",be,u(t.score)+" åˆ†",1),a("span",we,u(t.accuracy?.toFixed(0)||0)+"%",1),a("span",Se,u(t.time_spent)+"s",1)],2))),128))])])):i("",!0),$.value>0&&p.value?(n(),r("div",Be,[e[3]||(e[3]=a("span",{class:"streak-icon"},"ğŸ”¥",-1)),a("span",Ce,[e[1]||(e[1]=A(" é€£å‹ ",-1)),a("strong",null,u($.value),1),e[2]||(e[2]=A(" å ´ï¼ ",-1))])])):i("",!0),d.value?(n(),r("section",Ae,[e[9]||(e[9]=a("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),d.value.texts.length>1?(n(),r("div",Te,[(n(!0),r(M,null,I(d.value.texts,(t,o)=>(n(),r("button",{key:t.id,class:_(["result-tab",{active:o===R.value}]),onClick:w=>K(o)},[a("span",Re,u(o+1),1),a("span",Me,u(t.title),1),a("span",Ie," âœ“"+u(d.value.results[o]?.correctCount||0),1)],10,xe))),128))])):i("",!0),c.value&&c.value.text&&c.value.result?(n(),r("div",Pe,[a("div",Ve,[a("h3",null,u(c.value.text.title),1),c.value.text.author?(n(),r("span",ze,u(c.value.text.author),1)):i("",!0)]),a("div",Fe,[a("span",Ne,[e[4]||(e[4]=a("span",{class:"bean-legend correct"},null,-1)),A(" æ­£ç¢º "+u(c.value.result.correctCount),1)]),a("span",De,[e[5]||(e[5]=a("span",{class:"bean-legend wrong"},null,-1)),A(" éŒ¯èª¤ "+u(c.value.result.wrongCount),1)]),a("span",$e,[e[6]||(e[6]=a("span",{class:"bean-legend missed"},null,-1)),A(" éºæ¼ "+u(c.value.result.missedCount),1)])]),a("div",Ge,[a("div",qe,[(n(!0),r(M,null,I(N(c.value.text.content),(t,o)=>(n(),r("span",{key:o,class:"char-unit"},[a("span",Ue,u(t),1),o<N(c.value.text.content).length-1&&D(o)!=="none"?(n(),r("span",{key:0,class:_(["bean-slot",D(o)])},[...e[7]||(e[7]=[a("span",{class:"bean"},null,-1)])],2)):i("",!0)]))),128))])]),e[8]||(e[8]=ae('<div class="answer-legend" data-v-d2221f85><span class="legend-item" data-v-d2221f85><span class="bean-legend correct" data-v-d2221f85></span> æ­£ç¢º </span><span class="legend-item" data-v-d2221f85><span class="bean-legend wrong" data-v-d2221f85></span> éŒ¯èª¤ </span><span class="legend-item" data-v-d2221f85><span class="bean-legend missed" data-v-d2221f85></span> éºæ¼ </span></div>',1))])):i("",!0)])):i("",!0),l.value?.game_mode==="team_battle"?(n(),r("section",je,[e[11]||(e[11]=a("h2",null,"éšŠä¼æ’è¡Œ",-1)),a("div",Ee,[(n(!0),r(M,null,I(W.value,(t,o)=>(n(),r("div",{key:t.id,class:_(["team-ranking-item",{winner:o===0}])},[a("span",Je,u(o===0?"ğŸ†":o+1),1),V(j)(t)?(n(),re(ie,{key:0,"product-type":V(j)(t),size:40,class:"team-badge-in-ranking"},null,8,["product-type"])):i("",!0),a("div",Le,[a("span",Oe,u(t.team_name),1),o===0?(n(),r("div",We,[U(E,{size:16}),e[10]||(e[10]=a("span",null,"æ¯ä½æˆå“¡ +20 è±†",-1))])):i("",!0)]),a("span",He,u(t.averageScore.toFixed(2))+" åˆ†",1)],2))),128))])])):i("",!0),a("footer",{class:"result-footer"},[a("button",{class:"btn-secondary",onClick:Q}," è¿”å›é¬¥è±† "),a("button",{class:"btn-primary",onClick:X}," å†ä¾†ä¸€å±€ ")])],2))}}),at=oe(Ke,[["__scopeId","data-v-d2221f85"]]);export{at as default};
