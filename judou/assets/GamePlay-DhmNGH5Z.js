import{d as E,c as p,p as K,r as v,w as L,o as U,K as H,a as _,b as s,t as l,n as I,F as J,i as O,j as Q,e as B,q as f,_ as W}from"./index-DaPuvOjm.js";import{u as X}from"./gameStore-B4T_v9Ra.js";import"./userStatsStore-Czk_Ds0w.js";const Y={class:"game-play"},Z={class:"play-header"},ee={class:"header-left"},te={class:"text-title"},ae={class:"countdown-time"},se={class:"header-right"},oe={class:"attempt-count"},ne={class:"play-main"},re={class:"text-container"},ce={class:"text-content"},le=["onClick"],ue={class:"char"},ie={key:0,class:"break-mark"},ve={class:"progress-hint"},me={class:"play-footer"},de=["disabled"],he=E({__name:"GamePlay",setup(pe){const S=Q(),T=K(),w=X(),g=p(()=>T.params.roomId),u=p(()=>w.currentRoom),C=p(()=>u.value?.text),m=v(0);let b=null;const k=p(()=>C.value?.content??""),n=v(new Set),c=v(new Set),d=v(0),M=v(0),r=v(!1);function D(e){const o=new Set;let a="",t=0;for(let i=0;i<e.length;i++){const h=e[i]??"";"，。！？；：、".includes(h)?o.add(t):(a+=h,t++)}return{text:a,breaks:o}}function x(){if(!k.value)return;const e=D(k.value);c.value=e.breaks,n.value=new Set,d.value=0,M.value=Date.now(),r.value=!1}function G(e){r.value||(d.value++,n.value.has(e)?n.value.delete(e):n.value.add(e),n.value=new Set(n.value),R())}function R(){const e=c.value,o=n.value;e.size===o.size&&[...e].every(a=>o.has(a))&&y()}function A(){const e=c.value,o=n.value;let a=0,t=0;for(const q of o)e.has(q)?a++:t++;const i=e.size-a,h=e.size>0?a/e.size*100:0,N=Math.max(0,d.value-e.size)*2,P=Math.max(0,h-N),V=Math.round(a*10-t*5-i*5),j=Math.max(0,Math.round(m.value/10));return{score:Math.max(0,V+j),accuracy:h,firstAccuracy:P}}async function y(){if(r.value)return;r.value=!0;const{score:e,accuracy:o,firstAccuracy:a}=A(),t=Math.round((Date.now()-M.value)/1e3);await w.submitScore({roomId:g.value,score:e,accuracy:o,timeSpent:t,firstAccuracy:a,attemptCount:d.value}),S.push({name:"arena-result",params:{roomId:g.value}})}function $(e){const o=Math.floor(e/60),a=e%60;return`${o}:${a.toString().padStart(2,"0")}`}function F(){if(!u.value?.started_at||!u.value?.time_limit)return;const e=()=>{const o=new Date(u.value.started_at).getTime(),a=Math.floor((Date.now()-o)/1e3);m.value=Math.max(0,u.value.time_limit-a),m.value===0&&!r.value&&y()};e(),b=setInterval(e,1e3)}const z=p(()=>k.value.replace(/[，。！？；：、]/g,""));return L(()=>u.value?.status,e=>{e==="finished"&&S.push({name:"arena-result",params:{roomId:g.value}})}),U(()=>{w.subscribeToRoom(g.value),x(),F()}),H(()=>{b&&clearInterval(b)}),(e,o)=>(f(),_("div",Y,[s("header",Z,[s("div",ee,[s("span",te,l(C.value?.title),1)]),s("div",{class:I(["countdown",{warning:m.value<30}])},[s("span",ae,l($(m.value)),1)],2),s("div",se,[s("span",oe,"嘗試 "+l(d.value)+" 次",1)])]),s("main",ne,[s("div",re,[s("div",ce,[(f(!0),_(J,null,O(z.value,(a,t)=>(f(),_("span",{key:t,class:"char-wrapper",onClick:i=>G(t)},[s("span",ue,l(a),1),t<z.value.length-1?(f(),_("span",{key:0,class:I(["gap",{marked:n.value.has(t),correct:r.value&&c.value.has(t)&&n.value.has(t),wrong:r.value&&!c.value.has(t)&&n.value.has(t),missed:r.value&&c.value.has(t)&&!n.value.has(t)}])},[n.value.has(t)?(f(),_("span",ie,"|")):B("",!0)],2)):B("",!0)],8,le))),128))])]),s("div",ve,[s("span",null,"已標記 "+l(n.value.size)+" 處斷點",1),o[0]||(o[0]=s("span",{class:"divider"},"·",-1)),s("span",null,"需要 "+l(c.value.size)+" 處",1)])]),s("footer",me,[s("button",{class:"btn-primary btn-large",disabled:r.value||n.value.size===0,onClick:y},l(r.value?"已提交":"提交答案"),9,de)])]))}}),be=W(he,[["__scopeId","data-v-e2ab24db"]]);export{be as default};
