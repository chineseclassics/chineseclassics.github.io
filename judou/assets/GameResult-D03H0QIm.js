import{d as Z,u as ee,c,q as te,r as w,w as W,o as se,a as r,b as t,e as v,t as n,n as p,F as x,g as M,m as S,h as ae,j as E,i as ne,f as D,s as o,_ as le}from"./index-CF00Prb0.js";import{u as re,g as oe,c as U}from"./gameStore-BZCzO-WM.js";import{u as ue}from"./userStatsStore-W9KIMKUO.js";const ie={class:"result-header"},ce={class:"result-icon"},me={class:"bean-sign"},ve={key:0,class:"bean-note"},de={key:0,class:"ranking-section"},pe={class:"ranking-list"},_e=["src","alt"],fe={key:1,class:"avatar-placeholder"},ge={class:"name"},he={class:"score"},ke={class:"accuracy"},ye={class:"time"},be={key:1,class:"streak-card"},we={class:"streak-text"},Se={key:2,class:"answers-section"},Re={key:0,class:"result-tabs"},Ce=["onClick"],Be={class:"tab-number"},Te={class:"tab-title"},xe={class:"tab-stats"},Me={key:1,class:"answer-detail"},Ae={class:"answer-header"},Ge={key:0,class:"answer-author"},Ie={class:"answer-stats"},Pe={class:"stat correct"},De={class:"stat wrong"},Fe={class:"stat missed"},Ne={class:"answer-content"},$e={class:"answer-line"},ze={class:"answer-char"},Ve={key:3,class:"ranking-section"},qe={class:"team-ranking-list"},Le={class:"rank"},Oe={class:"team-name"},We={class:"team-score"},Ee={class:"rank-title-section"},Ue={class:"level-text"},je=Z({__name:"GameResult",setup(Je){const A=ne(),j=te(),k=re(),R=ee(),G=ue(),C=c(()=>j.params.roomId),u=c(()=>k.currentRoom),_=c(()=>k.myParticipant),m=w(null),B=w(0),i=c(()=>{if(!m.value)return null;const s=m.value.texts[B.value],e=m.value.results[B.value];return!s||!e?null:{text:s,result:e}});function F(s){const e=[];for(const a of s)a!=="|"&&a!==`
`&&a!=="\r"&&e.push(a);return e}function N(s){if(!i.value?.result)return"none";const e=i.value.result,a=e.userBreaks.includes(s),l=e.correctBreaks.includes(s);return a&&l?"correct":a&&!l?"wrong":!a&&l?"missed":"none"}const f=c(()=>{if(!u.value||!R.user)return!1;if(u.value.game_mode==="team_battle")return _.value?.team_id===u.value.winner_team_id;{if(u.value.winner_user_id)return u.value.winner_user_id===R.user.id;if(!u.value.participants)return!1;const s=_.value?.score??0,e=_.value?.time_spent??999999,a=Math.max(...u.value.participants.map(d=>d.score)),l=u.value.participants.filter(d=>d.score===a),T=Math.min(...l.map(d=>d.time_spent??999999));return s===a&&e===T}}),h=c(()=>!u.value||u.value.game_mode==="team_battle"?!1:!u.value.winner_user_id&&f.value),J=c(()=>u.value?.participants?[...u.value.participants].sort((s,e)=>e.score-s.score).map((s,e)=>({...s,rank:e+1})):[]),H=c(()=>u.value?.teams?[...u.value.teams].sort((s,e)=>e.total_score-s.total_score):[]),$=c(()=>G.level),z=c(()=>oe($.value)),V=c(()=>G.profile?.pvp_win_streak??0),q=w(!1),y=w(0),b=w(!1),g=c(()=>{if(!_.value)return console.log("[GameResult] myParticipant ç‚ºç©º"),{amount:0,type:"neutral"};const s=_.value.prize_won||0,e=_.value.fee_paid||0;return console.log("[GameResult] è¨ˆç®—å¾—è±†è®ŠåŒ–:",{prizeWon:s,feePaid:e,isWinner:f.value,isTie:h.value,participant:_.value}),s>0?{amount:s,type:"win"}:e>0&&!f.value?{amount:-e,type:"lose"}:h.value&&e>0?{amount:0,type:"tie"}:{amount:0,type:"neutral"}});let I=!1;function L(){const s=Math.abs(g.value.amount),e=g.value.type;if(console.log("[GameResult] startBeanAnimation:",{target:s,type:e,animationStarted:I}),e==="neutral"||s===0&&e!=="tie"){console.log("[GameResult] ç­‰å¾…æ•¸æ“šæ›´æ–°...");return}if(I){console.log("[GameResult] å‹•ç•«å·²å•Ÿå‹•ï¼Œè·³é");return}I=!0,q.value=!0,y.value=0,b.value=!1;const a=2500,l=Date.now(),T=s>0?s:100;function d(){const Y=Date.now()-l,P=Math.min(Y/a,1);if(P<1){if(P<.8)y.value=Math.floor(Math.random()*T*1.5);else{const O=(P-.8)/.2;y.value=Math.floor(s*O+Math.random()*(s*(1-O)))}requestAnimationFrame(d)}else y.value=s,b.value=!0,console.log("[GameResult] å‹•ç•«å®Œæˆï¼Œæœ€çµ‚å€¼:",s)}setTimeout(()=>{requestAnimationFrame(d)},500)}W(g,(s,e)=>{console.log("[GameResult] myBeanChange è®ŠåŒ–:",{old:e,new:s}),s.type!=="neutral"&&Math.abs(s.amount)>0&&L()},{immediate:!1});function K(s){m.value&&s>=0&&s<m.value.texts.length&&(B.value=s)}function Q(){k.reset(),sessionStorage.removeItem(`game-result-${C.value}`),A.push({name:"arena"})}function X(){k.reset(),sessionStorage.removeItem(`game-result-${C.value}`),R.isTeacher?A.push({name:"arena-teacher-create"}):A.push({name:"arena-create"})}return W(()=>u.value?.status,s=>{}),se(()=>{k.subscribeToRoom(C.value),G.fetchProfile();const s=sessionStorage.getItem(`game-result-${C.value}`);if(s)try{m.value=JSON.parse(s)}catch{}setTimeout(()=>{L()},100)}),(s,e)=>(o(),r("div",{class:p(["game-result",{winner:f.value,tie:h.value}])},[t("header",ie,[t("div",ce,n(h.value?"ğŸ¤":f.value?"ğŸ†":"ğŸ’ª"),1),t("h1",null,n(h.value?"å¹³å±€ï¼":f.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),q.value||g.value.type!=="neutral"?(o(),r("div",{key:0,class:p(["bean-change-display",[g.value.type,{complete:b.value}]])},[t("span",me,n(g.value.type==="lose"?"-":g.value.type==="win"?"+":""),1),t("span",{class:p(["bean-number",{rolling:!b.value}])},n(y.value),3),e[0]||(e[0]=t("span",{class:"bean-icon"},"ğŸ«˜",-1)),h.value&&b.value?(o(),r("span",ve,"å…¥å ´è²»å·²é€€é‚„")):v("",!0)],2)):v("",!0)]),u.value?.game_mode==="pvp"?(o(),r("section",de,[e[1]||(e[1]=t("h2",null,"æ’è¡Œæ¦œ",-1)),t("div",pe,[(o(!0),r(x,null,M(J.value,a=>(o(),r("div",{key:a.id,class:p(["ranking-item",{me:a.user_id===D(R).user?.id,top:a.rank<=3}])},[t("span",{class:p(["rank",`rank-${a.rank}`])},n(a.rank===1?"ğŸ¥‡":a.rank===2?"ğŸ¥ˆ":a.rank===3?"ğŸ¥‰":a.rank),3),a.user?.avatar_url?(o(),r("img",{key:0,src:a.user.avatar_url,alt:a.user.display_name,class:"avatar"},null,8,_e)):(o(),r("span",fe,n(a.user?.display_name?.charAt(0)||"?"),1)),t("span",ge,n(a.user?.display_name||"æœªçŸ¥"),1),t("span",he,n(a.score)+" åˆ†",1),t("span",ke,n(a.accuracy?.toFixed(0)||0)+"%",1),t("span",ye,n(a.time_spent)+"s",1)],2))),128))])])):v("",!0),V.value>0&&f.value?(o(),r("div",be,[e[4]||(e[4]=t("span",{class:"streak-icon"},"ğŸ”¥",-1)),t("span",we,[e[2]||(e[2]=S(" é€£å‹ ",-1)),t("strong",null,n(V.value),1),e[3]||(e[3]=S(" å ´ï¼ ",-1))])])):v("",!0),m.value?(o(),r("section",Se,[e[10]||(e[10]=t("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),m.value.texts.length>1?(o(),r("div",Re,[(o(!0),r(x,null,M(m.value.texts,(a,l)=>(o(),r("button",{key:a.id,class:p(["result-tab",{active:l===B.value}]),onClick:T=>K(l)},[t("span",Be,n(l+1),1),t("span",Te,n(a.title),1),t("span",xe," âœ“"+n(m.value.results[l]?.correctCount||0),1)],10,Ce))),128))])):v("",!0),i.value&&i.value.text&&i.value.result?(o(),r("div",Me,[t("div",Ae,[t("h3",null,n(i.value.text.title),1),i.value.text.author?(o(),r("span",Ge,n(i.value.text.author),1)):v("",!0)]),t("div",Ie,[t("span",Pe,[e[5]||(e[5]=t("span",{class:"bean-legend correct"},null,-1)),S(" æ­£ç¢º "+n(i.value.result.correctCount),1)]),t("span",De,[e[6]||(e[6]=t("span",{class:"bean-legend wrong"},null,-1)),S(" éŒ¯èª¤ "+n(i.value.result.wrongCount),1)]),t("span",Fe,[e[7]||(e[7]=t("span",{class:"bean-legend missed"},null,-1)),S(" éºæ¼ "+n(i.value.result.missedCount),1)])]),t("div",Ne,[t("div",$e,[(o(!0),r(x,null,M(F(i.value.text.content),(a,l)=>(o(),r("span",{key:l,class:"char-unit"},[t("span",ze,n(a),1),l<F(i.value.text.content).length-1&&N(l)!=="none"?(o(),r("span",{key:0,class:p(["bean-slot",N(l)])},[...e[8]||(e[8]=[t("span",{class:"bean"},null,-1)])],2)):v("",!0)]))),128))])]),e[9]||(e[9]=ae('<div class="answer-legend" data-v-381f0af5><span class="legend-item" data-v-381f0af5><span class="bean-legend correct" data-v-381f0af5></span> æ­£ç¢º </span><span class="legend-item" data-v-381f0af5><span class="bean-legend wrong" data-v-381f0af5></span> éŒ¯èª¤ </span><span class="legend-item" data-v-381f0af5><span class="bean-legend missed" data-v-381f0af5></span> éºæ¼ </span></div>',1))])):v("",!0)])):v("",!0),u.value?.game_mode==="team_battle"?(o(),r("section",Ve,[e[11]||(e[11]=t("h2",null,"éšŠä¼æ’è¡Œ",-1)),t("div",qe,[(o(!0),r(x,null,M(H.value,(a,l)=>(o(),r("div",{key:a.id,class:p(["team-ranking-item",{winner:l===0}]),style:E({"--team-primary":D(U)[a.team_color].primary,"--team-secondary":D(U)[a.team_color].secondary})},[t("span",Le,n(l===0?"ğŸ†":l+1),1),t("span",Oe,n(a.team_name),1),t("span",We,n(a.total_score)+" åˆ†",1)],6))),128))])])):v("",!0),t("section",Ee,[e[12]||(e[12]=t("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),t("div",{class:"rank-title-display",style:E({color:z.value.color})},n(z.value.title),5),t("p",Ue,"Lv."+n($.value),1)]),t("footer",{class:"result-footer"},[t("button",{class:"btn-secondary",onClick:Q}," è¿”å›é¬¥è±† "),t("button",{class:"btn-primary",onClick:X}," å†ä¾†ä¸€å±€ ")])],2))}}),Xe=le(je,[["__scopeId","data-v-381f0af5"]]);export{Xe as default};
