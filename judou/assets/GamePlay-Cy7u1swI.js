import{d as U,c as T,p as H,r as u,w as J,o as O,K as Q,a as l,b as o,F as I,e as g,t as c,n as B,i as L,j as W,q as r,_ as X}from"./index-C--FWHEW.js";import{u as Y}from"./gameStore-s9-y2MFt.js";import"./userStatsStore-CZ70SJFH.js";const Z={class:"game-play"},ee={key:0,class:"loading-container"},te={class:"play-header"},ae={class:"header-left"},se={class:"text-title"},oe={key:0,class:"text-progress"},ne={class:"countdown-time"},le={class:"header-right"},re={class:"score-display"},ue={class:"score-value"},ce={key:0,class:"multi-text-progress"},ie={key:0,class:"dot-icon"},ve={key:1},de={class:"play-main"},me={class:"text-container"},pe={class:"text-content"},_e=["onClick"],he={class:"char"},fe={key:0,class:"break-mark"},ge={class:"progress-hint"},ke={key:0,class:"divider"},ye={key:1},we={class:"play-footer"},be=["disabled"],Ce=U({__name:"GamePlay",setup(Te){const z=W(),N=H(),f=Y(),k=T(()=>N.params.roomId),i=T(()=>f.currentRoom),v=u([]),m=u(0),h=T(()=>v.value[m.value]),w=u(0);let x=null;const n=u(new Set),p=u(new Set),D=u(0),y=u(0),b=u(0),M=u(0),d=u(!1),P=u(!0);function R(t){const a=new Set;let s="",e=0;for(let _=0;_<t.length;_++){const C=t[_]??"";"ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€".includes(C)?e>0&&a.add(e-1):(s+=C,e++)}return{text:s,breaks:a}}const A=T(()=>h.value?.content?h.value.content.replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€]/g,""):"");function F(){if(!h.value?.content)return;const t=R(h.value.content);p.value=t.breaks,n.value=new Set,D.value=0}function V(t){d.value||(D.value++,M.value++,n.value.has(t)?n.value.delete(t):n.value.add(t),n.value=new Set(n.value),j())}function j(){const t=p.value,a=n.value;t.size===a.size&&[...t].every(s=>a.has(s))&&q()}async function q(){const t=p.value,a=n.value;let s=0,e=0;for(const _ of a)t.has(_)?s++:e++;y.value+=s,b.value++,h.value&&await f.submitTextProgress({roomId:k.value,textId:h.value.id,textIndex:m.value,correctCount:s,wrongCount:e,timeSpent:Math.round((Date.now()-S)/1e3)}),m.value<v.value.length-1?(m.value++,F()):$()}async function G(){if(d.value)return;const t=p.value,a=n.value;let s=0;for(const e of a)t.has(e)&&s++;y.value+=s,$()}let S=0;async function $(){if(d.value)return;d.value=!0;const t=Math.round((Date.now()-S)/1e3),a=v.value.reduce((e,_)=>{const C=R(_.content);return e+C.breaks.size},0),s=a>0?y.value/a*100:0;await f.submitScore({roomId:k.value,score:y.value,accuracy:s,timeSpent:t,firstAccuracy:s,attemptCount:M.value}),z.push({name:"arena-result",params:{roomId:k.value}})}function E(t){const a=Math.floor(t/60),s=t%60;return`${a}:${s.toString().padStart(2,"0")}`}function K(){if(!i.value?.started_at||!i.value?.time_limit)return;const t=()=>{const a=new Date(i.value.started_at).getTime(),s=Math.floor((Date.now()-a)/1e3);w.value=Math.max(0,i.value.time_limit-s),w.value===0&&!d.value&&G()};t(),x=setInterval(t,1e3)}return J(()=>i.value?.status,t=>{t==="finished"&&z.push({name:"arena-result",params:{roomId:k.value}})}),O(async()=>{f.subscribeToRoom(k.value),i.value?.text_ids&&i.value.text_ids.length>0?v.value=await f.fetchTexts(i.value.text_ids):i.value?.text_id&&(v.value=await f.fetchTexts([i.value.text_id])),P.value=!1,v.value.length>0&&(F(),S=Date.now(),K())}),Q(()=>{x&&clearInterval(x)}),(t,a)=>(r(),l("div",Z,[P.value?(r(),l("div",ee,[...a[0]||(a[0]=[o("span",{class:"loading-spinner"},"â³",-1),o("span",null,"è¼‰å…¥é¡Œç›®ä¸­...",-1)])])):(r(),l(I,{key:1},[o("header",te,[o("div",ae,[o("span",se,c(h.value?.title),1),v.value.length>1?(r(),l("span",oe," ï¼ˆ"+c(m.value+1)+" / "+c(v.value.length)+"ï¼‰ ",1)):g("",!0)]),o("div",{class:B(["countdown",{warning:w.value<30}])},[o("span",ne,c(E(w.value)),1)],2),o("div",le,[o("span",re,[a[1]||(a[1]=o("span",{class:"score-icon"},"ğŸ«˜",-1)),o("span",ue,c(y.value),1)])])]),v.value.length>1?(r(),l("div",ce,[(r(!0),l(I,null,L(v.value,(s,e)=>(r(),l("div",{key:s.id,class:B(["progress-dot",{completed:e<m.value,current:e===m.value,pending:e>m.value}])},[e<m.value?(r(),l("span",ie,"âœ“")):(r(),l("span",ve,c(e+1),1))],2))),128))])):g("",!0),o("main",de,[o("div",me,[o("div",pe,[(r(!0),l(I,null,L(A.value,(s,e)=>(r(),l("span",{key:e,class:"char-wrapper",onClick:_=>V(e)},[o("span",he,c(s),1),e<A.value.length-1?(r(),l("span",{key:0,class:B(["gap",{marked:n.value.has(e),correct:d.value&&p.value.has(e)&&n.value.has(e),wrong:d.value&&!p.value.has(e)&&n.value.has(e),missed:d.value&&p.value.has(e)&&!n.value.has(e)}])},[n.value.has(e)?(r(),l("span",fe,"|")):g("",!0)],2)):g("",!0)],8,_e))),128))])]),o("div",ge,[o("span",null,"å·²æ¨™è¨˜ "+c(n.value.size)+" / "+c(p.value.size)+" è™•",1),b.value>0?(r(),l("span",ke,"Â·")):g("",!0),b.value>0?(r(),l("span",ye,"å·²å®Œæˆ "+c(b.value)+" ç¯‡",1)):g("",!0)])]),o("footer",we,[o("button",{class:"btn-primary btn-large",disabled:d.value||n.value.size===0,onClick:G},c(d.value?"å·²æäº¤":"æäº¤ç•¶å‰é€²åº¦"),9,be),a[2]||(a[2]=o("p",{class:"footer-hint"}," åšå®Œè‡ªå‹•é€²å…¥ä¸‹ä¸€ç¯‡ï¼Œæˆ–é»æ“ŠæŒ‰éˆ•æäº¤ç•¶å‰é€²åº¦ ",-1))])],64))]))}}),Be=X(Ce,[["__scopeId","data-v-e938bed3"]]);export{Be as default};
