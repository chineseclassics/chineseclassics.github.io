import{d as mt,u as ft,r as x,L as ve,c as z,f as pt,R as gt,a as s,h as _,m as ne,F as R,g as t,i as me,s as P,j as L,z as S,J as O,M as Q,t as r,e as fe,p as pe,N as ge,O as ae,y as W,n as yt,b as ye,K as De,Q as ht,o,_ as bt}from"./index-YghVDSQt.js";import{u as _t}from"./readingStore-7MraTB6N.js";import{u as xt}from"./practiceLibraryStore-UilNAgt7.js";import{u as kt}from"./useSupabase-WUKx7dou.js";const Ct={class:"admin-reading-page"},wt={class:"admin-header"},Tt={class:"header-actions"},$t=["disabled"],At=["disabled"],It={class:"admin-layout"},Rt={class:"category-sidebar edamame-glass"},St={class:"sidebar-header"},Mt={key:0,class:"sidebar-loading"},Et={key:1,class:"sidebar-empty"},Pt={key:2,class:"category-tree"},Ot={key:0,class:"tree-item editing"},Dt=["onClick"],Ft={class:"tree-label"},Lt={class:"tree-count"},Vt={class:"tree-actions"},Bt=["onClick"],Ut=["onClick"],Nt={key:3,class:"add-category-inline"},jt={class:"add-category-actions"},zt={class:"content-panel edamame-glass"},Wt={key:0,class:"content-empty"},Gt={class:"category-info"},Kt={class:"category-meta"},qt={class:"text-list-section"},Jt={key:0,class:"text-empty"},Ht={key:1},Xt=["onClick"],Yt={class:"text-title"},Qt={class:"text-preview"},Zt=["onClick"],en=["onClick"],tn=["onClick"],nn=["onClick"],an=["onClick"],on={class:"detail-header"},ln={class:"detail-actions"},sn=["disabled"],rn={class:"text-meta edamame-glass"},dn={class:"detail-title"},un={class:"meta-row"},cn={key:0,class:"meta-item"},vn={key:1,class:"meta-item"},mn={class:"meta-item"},fn={key:2,class:"meta-item"},pn={class:"category-tags inline"},gn={key:0,class:"selection-toolbar"},yn={class:"selected-text"},hn={class:"reading-line"},bn=["data-global-index","onMouseenter","onClick","onTouchend"],_n={key:1,class:"annotations-section edamame-glass"},xn={class:"section-title"},kn={class:"annotation-list"},Cn={class:"annotation-term"},wn={key:0,class:"annotation-pinyin"},Tn={class:"annotation-content"},$n={class:"annotation-actions"},An=["onClick"],In=["onClick"],Rn={class:"modal-card edamame-glass large-modal"},Sn={class:"modal-body"},Mn={class:"form-row"},En={class:"flex-2"},Pn={class:"form-row"},On={class:"category-picker"},Dn=["onClick"],Fn={key:0,class:"tag-check"},Ln={key:0,class:"new-category-inline"},Vn={key:0,class:"feedback"},Bn=["disabled"],Un={class:"modal-card edamame-glass"},Nn={class:"modal-body"},jn={class:"selected-preview"},zn={class:"preview-content"},Wn={class:"preview-info"},Gn={class:"form-row"},Kn=["value"],qn={class:"extract-note"},Jn={key:0,class:"feedback"},Hn=["disabled"],Xn={class:"modal-card edamame-glass",style:{"max-width":"800px","max-height":"80vh","overflow-y":"auto"}},Yn={class:"modal-body"},Qn={class:"generated-annotations-list"},Zn={class:"annotation-header"},ea={class:"annotation-term"},ta={key:0,class:"annotation-pinyin"},na={class:"annotation-position"},aa={class:"annotation-content"},oa={key:0,class:"feedback"},la=["disabled"],ia={class:"modal-card edamame-glass"},sa={class:"modal-body"},ra={class:"selected-preview"},da={class:"preview-content annotation-term-preview"},ua=["disabled"],ca={key:0,class:"loading-hint"},va={key:1,class:"feedback"},ma=["disabled"],fa={class:"tooltip-term"},pa={key:0,class:"tooltip-pinyin"},ga={class:"tooltip-content"},ya=mt({__name:"AdminReadingPage",setup(ha){const m=_t(),ke=xt(),Fe=ft(),oe=x("list"),u=x(null),M=x(null),V=x(!1),q=x(!1),B=x(!1),k=x(!1),f=x(null),U=x(null),v=ve({title:"",author:"",source:"",summary:"",content:"",reading_category_ids:[]}),E=x(!1),T=x(""),Z=x(null),J=x(""),h=ve({selectedText:"",startIndex:0,endIndex:0,title:"",category_id:null,difficulty:2}),y=ve({selectedText:"",startIndex:0,endIndex:0,annotation:"",pinyin:""}),$=x(null),ee=x(!1),le=x(!1),G=x([]),te=x(!1);function Le(a,e){const n=[];let l=0;for(const i of a){const c=e.indexOf(i.term,l);if(c===-1){console.warn(`âš ï¸ ç„¡æ³•æ‰¾åˆ°è¨»é‡‹ "${i.term}" åœ¨åŸæ–‡ä¸­çš„ä½ç½®ï¼Œè·³é`);continue}if(n.length>0){const d=n[n.length-1];if(d&&c<d.end_index){console.warn(`âš ï¸ è¨»é‡‹ "${i.term}" èˆ‡å‰ä¸€å€‹è¨»é‡‹ "${d.term}" é‡ç–Šï¼Œè·³é`);continue}}l=c+i.term.length,n.push({term:i.term,start_index:c,end_index:c+i.term.length,annotation:i.annotation,pinyin:i.pinyin||null})}return n}const H=z(()=>m.readingCategories),Ve=z(()=>ke.state.categories.filter(a=>a.level===1).sort((a,e)=>a.order_index-e.order_index)),he=z(()=>M.value&&m.readingCategories.find(a=>a.id===M.value)||null),be=z(()=>M.value?m.readingTexts.filter(a=>a.reading_categories?.some(e=>e.id===M.value)):[]);function Ce(a){return m.readingTexts.filter(e=>e.reading_categories?.some(n=>n.id===a)).length}function Be(a){M.value=a}function Ue(a){Z.value=a.id,J.value=a.name}function ie(){Z.value=null,J.value=""}async function we(){if(!Z.value||!J.value.trim()){ie();return}try{await m.updateReadingCategory(Z.value,{name:J.value.trim()}),ie()}catch(a){alert(a?.message||"æ›´æ–°æ–‡é›†å¤±æ•—")}}async function Ne(a){const e=Ce(a.id);if(e>0){alert(`ç„¡æ³•åˆªé™¤ã€Œ${a.name}ã€ï¼šæ­¤æ–‡é›†ä¸‹é‚„æœ‰ ${e} ç¯‡æ–‡ç« ã€‚è«‹å…ˆç§»é™¤æ–‡ç« å¾Œå†åˆªé™¤æ–‡é›†ã€‚`);return}if(confirm(`ç¢ºå®šè¦åˆªé™¤æ–‡é›†ã€Œ${a.name}ã€å—ï¼Ÿ`))try{await m.deleteReadingCategory(a.id),M.value===a.id&&(M.value=null)}catch(n){alert(n?.message||"åˆªé™¤æ–‡é›†å¤±æ•—")}}const Te=z(()=>{const a=m.currentText||u.value;if(!a)return{paragraphs:[],allChars:[]};const e=a.content,n=e.includes("||")?"||":/\n\n+/,l=e.split(n),i=[],c=[];let d=0;for(const g of l){const p=[],w=d,I=g.replace(/[\|\s]+$/,"");for(const b of I)b==="|"||b!==`
`&&b!=="\r"&&(c.push(b),p.push(b),d++);p.length>0&&i.push({chars:p,startIdx:w,endIdx:d-1})}return{paragraphs:i,allChars:c}}),je=z(()=>Te.value.allChars.join("")),ze=z(()=>Te.value.paragraphs),_e=z(()=>m.currentText?.annotations||[]),A=x(null),X=x(null),N=x(!1);function Y(a){return m.currentText?.annotations&&m.currentText.annotations.find(e=>a>=e.start_index&&a<e.end_index)||null}function We(a){return Y(a)?.start_index===a}function Ge(a){const e=Y(a);return e?e.end_index-1===a:!1}function Ke(a){return X.value?Y(a)?.id===X.value:!1}function qe(a,e){if(N.value)return;const n=Y(a);n&&(X.value=n.id,Ae(n,e))}function Je(){N.value||(X.value=null,se())}function $e(a,e){const n=Y(a);if(n){if(e.stopPropagation(),A.value&&A.value.annotation.id===n.id){se();return}X.value=n.id,ht(()=>{const l=document.querySelector(`.char[data-global-index="${n.start_index}"]`),i=document.querySelector(`.char[data-global-index="${n.end_index-1}"]`);let c=0,d=0;if(l&&i){const g=l.getBoundingClientRect(),p=i.getBoundingClientRect();c=(g.left+p.right)/2,d=g.top}else if(l){const g=l.getBoundingClientRect();c=g.left+g.width/2,d=g.top}else{const g=e.target;if(g){const p=g.getBoundingClientRect();c=p.left+p.width/2,d=p.top}}Ae(n,{clientX:c,clientY:d})})}}function Ae(a,e){A.value={annotation:a,x:e.clientX,y:e.clientY}}function se(){X.value=null,A.value=null}function re(a){if(!N.value||!A.value)return;const e=a.target;!e.closest(".char.has-annotation")&&!e.closest(".annotation-tooltip")&&se()}async function de(a){u.value=a,oe.value="detail",await m.fetchTextDetail(a.id)}function Ie(){oe.value="list",u.value=null,m.clearCurrentText()}function Re(){U.value=null,v.title="",v.author="",v.source="",v.summary="",v.content="",v.reading_category_ids=[],f.value=null,V.value=!0}function He(){const a=m.currentText||u.value;a&&Se(a)}function Se(a){U.value=a,v.title=a.title,v.author=a.author||"",v.source=a.source||"",v.summary=a.summary||"";let e=a.content;e.includes("||")&&(e=e.replace(/\|\|/g,`

`)),v.content=e,v.reading_category_ids=a.reading_categories?.map(n=>n.id)||[],f.value=null,V.value=!0}async function Xe(a){if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${a.title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`))try{await m.deleteReadingText(a.id),u.value?.id===a.id&&Ie()}catch(e){alert(e?.message||"åˆªé™¤å¤±æ•—")}}async function Ye(){if(!v.title.trim()||!v.content.trim()){f.value="æ¨™é¡Œå’Œå…§å®¹ç‚ºå¿…å¡«";return}if(!v.reading_category_ids||v.reading_category_ids.length===0){f.value="è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ–‡é›†";return}try{k.value=!0;const a=ut(v.content);if(!a){f.value="å…§å®¹è™•ç†å¾Œç‚ºç©ºï¼Œè«‹æª¢æŸ¥è¼¸å…¥";return}if(U.value){if(await m.updateReadingText(U.value.id,{title:v.title.trim(),author:v.author.trim()||null,source:v.source.trim()||null,summary:v.summary.trim()||null,category_id:null,content:a,reading_category_ids:v.reading_category_ids}),U.value&&u.value?.id===U.value.id){const e=m.readingTexts.find(n=>n.id===U.value.id);e&&(u.value=e)}V.value=!1}else await m.createReadingText({title:v.title.trim(),author:v.author.trim()||null,source:v.source.trim()||null,summary:v.summary.trim()||null,content:a,category_id:null,reading_category_ids:v.reading_category_ids},Fe.isAdmin),V.value=!1}catch(a){f.value=a?.message||"å„²å­˜å¤±æ•—"}finally{k.value=!1}}function Qe(a){setTimeout(()=>{const e=window.getSelection();if(!e||e.isCollapsed){K();return}const n=e.toString().trim();if(!n||n.length===0){K();return}const i=a.target.closest(".text-content");if(!i){K();return}const c=e.getRangeAt(0),d=i.querySelectorAll(".char");let g=-1,p=-1,w=0;for(let I=0;I<d.length;I++){const b=d[I],j=b.textContent||"";if(j){try{const D=document.createRange();D.selectNodeContents(b),(c.intersectsNode(b)||c.compareBoundaryPoints(Range.START_TO_START,D)<=0&&c.compareBoundaryPoints(Range.END_TO_END,D)>=0)&&(g===-1&&(g=w),p=w+j.length)}catch{(c.commonAncestorContainer.contains(b)||b.contains(c.commonAncestorContainer))&&(g===-1&&(g=w),p=w+j.length)}w+=j.length}}if(g===-1||p<=g){const b=je.value.indexOf(n);b>=0&&(g=b,p=b+n.length)}g>=0&&p>g?Ze(n,g,p):K()},10)}const C=ve({show:!1,text:"",startIndex:0,endIndex:0});function Ze(a,e,n){C.text=a,C.startIndex=e,C.endIndex=n,C.show=!0}function K(){C.show=!1}function et(){u.value&&(h.selectedText=C.text,h.startIndex=C.startIndex,h.endIndex=C.endIndex,h.title=`${u.value.title}ï¼ˆç¯€é¸ï¼‰`,h.category_id=u.value.category_id||null,h.difficulty=2,f.value=null,K(),q.value=!0)}function Me(a){return a.replace(/[\[\]{}ï¼ˆï¼‰]/g,"").replace(/[ï½œ]/g,"").trim()}const ue={get(a){try{const e=localStorage.getItem(`moedict:${a}`);if(e){const n=JSON.parse(e);if(n.timestamp&&Date.now()-n.timestamp<10080*60*1e3)return n.data}}catch(e){console.error("è®€å– moedict ç·©å­˜å¤±æ•—:",e)}return null},set(a,e){try{localStorage.setItem(`moedict:${a}`,JSON.stringify({data:e,timestamp:Date.now()}))}catch(n){console.error("ä¿å­˜ moedict ç·©å­˜å¤±æ•—:",n)}}};async function Ee(a){const e=ue.get(a);if(e)return e;try{const n=await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(a)}`);if(!n.ok)return ue.set(a,{pinyin:null,definition:null}),null;const l=await n.json(),i=a.length>1;let c=null,d=null;i?l.h&&l.h[0]&&(c=l.h[0].p||null,l.h[0].d&&l.h[0].d[0]&&(d=Me(l.h[0].d[0].f||""))):l.heteronyms&&l.heteronyms[0]&&(c=l.heteronyms[0].pinyin||l.heteronyms[0].bopomofo2||l.heteronyms[0].bopomofo||null,l.heteronyms[0].definitions&&l.heteronyms[0].definitions[0]&&(d=Me(l.heteronyms[0].definitions[0].def||"")));const g={pinyin:c,definition:d};return ue.set(a,g),g}catch(n){return console.error("æŸ¥è©¢ moedict å¤±æ•—:",n),ue.set(a,{pinyin:null,definition:null}),null}}async function tt(a){if(a.length>1){const i=await Ee(a);if(i&&(i.pinyin||i.definition))return i}const e=await Promise.all(a.split("").map(i=>Ee(i))),n=e.map(i=>i?.pinyin).filter(i=>i!=null),l=e.map(i=>i?.definition).filter(i=>i!=null);return{pinyin:n.length>0?n.join(" "):null,definition:l.length>0?l.join("ï¼›"):null}}async function nt(){$.value=null,y.selectedText=C.text,y.startIndex=C.startIndex,y.endIndex=C.endIndex,y.annotation="",y.pinyin="",f.value=null,K(),B.value=!0;const a=C.text.trim();if(a){ee.value=!0,f.value="æ­£åœ¨æŸ¥è©¢æ‹¼éŸ³å’Œé‡‹ç¾©...";try{const e=await tt(a);e.pinyin&&(y.pinyin=e.pinyin),e.definition&&(y.annotation=e.definition),e.pinyin||e.definition?f.value="å·²è‡ªå‹•å¡«å……æ‹¼éŸ³å’Œé‡‹ç¾©ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯ä¿®æ”¹":f.value="æœªæ‰¾åˆ°æ‹¼éŸ³å’Œé‡‹ç¾©ï¼Œè«‹æ‰‹å‹•è¼¸å…¥"}catch(e){console.error("è‡ªå‹•å¡«å……æ‹¼éŸ³å’Œé‡‹ç¾©å¤±æ•—:",e),f.value="æŸ¥è©¢æ‹¼éŸ³å’Œé‡‹ç¾©å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥"}finally{ee.value=!1}}}function at(a){$.value=a.id,y.selectedText=a.term,y.startIndex=a.start_index,y.endIndex=a.end_index,y.annotation=a.annotation,y.pinyin=a.pinyin||"",f.value=null,B.value=!0}async function ot(){if(!u.value||!h.selectedText){f.value="è«‹é¸å–è¦æå–çš„æ–‡å­—";return}if(!h.title.trim()){f.value="è«‹è¼¸å…¥æ¨™é¡Œ";return}try{k.value=!0;const a=u.value.content;let e="",n=0;for(let l=0;l<a.length;l++){const i=a[l];i==="|"?n>h.startIndex&&n<=h.endIndex&&(e+=i):(n>=h.startIndex&&n<h.endIndex&&(e+=i),n++)}await m.extractPracticeFragment(u.value.id,h.startIndex,h.endIndex,e,{title:h.title.trim(),category_id:h.category_id,difficulty:h.difficulty}),q.value=!1,alert("ç·´ç¿’ç´ ææå–æˆåŠŸï¼")}catch(a){f.value=a?.message||"æå–å¤±æ•—"}finally{k.value=!1}}async function lt(){if(!u.value||!y.selectedText){f.value="è«‹é¸å–è¦è¨»é‡‹çš„æ–‡å­—";return}if(!y.annotation.trim()){f.value="è«‹è¼¸å…¥è¨»é‡‹å…§å®¹";return}try{k.value=!0,$.value?(await m.updateAnnotation($.value,y.annotation.trim(),y.pinyin.trim()||null),B.value=!1,alert("è¨»é‡‹æ›´æ–°æˆåŠŸï¼")):(await m.addAnnotation({text_id:u.value.id,start_index:y.startIndex,end_index:y.endIndex,term:y.selectedText,annotation:y.annotation.trim(),pinyin:y.pinyin.trim()||null}),B.value=!1,alert("è¨»é‡‹æ·»åŠ æˆåŠŸï¼")),await m.fetchTextDetail(u.value.id)}catch(a){f.value=a?.message||($.value?"æ›´æ–°è¨»é‡‹å¤±æ•—":"æ·»åŠ è¨»é‡‹å¤±æ•—")}finally{k.value=!1,$.value=null}}async function it(){if(!u.value){f.value="è«‹å…ˆé¸æ“‡ä¸€ç¯‡æ–‡ç« ";return}try{le.value=!0,f.value=null;const a=u.value.content,e=a.includes("||")?"||":/\n\n+/,n=a.split(e);let l="",i="";for(const p of n){const w=p.replace(/[\|\s]+$/,""),I=w.replace(/[\n\r]/g,"");I&&(l+=(l?`

`:"")+I);for(const b of w)b!=="|"&&b!==`
`&&b!=="\r"&&(i+=b)}const c=kt(),{data:d,error:g}=await c.functions.invoke("generate-annotations",{body:{content:l,title:u.value.title,author:u.value.author}});if(g){let p=g.message||"ç”Ÿæˆè¨»é‡‹æ™‚ç™¼ç”ŸéŒ¯èª¤";throw d&&d.error&&(p=d.error,d.details&&(p+=`
è©³æƒ…ï¼š${d.details}`)),new Error(p)}if(!d||!d.success){const p=d?.error||"ç”Ÿæˆè¨»é‡‹å¤±æ•—";throw new Error(p)}if(d.success&&d.data){const p=d.data,w=Le(p,i);if(w.length>0){await m.deleteAIGeneratedAnnotations(u.value.id);let I=0,b=0,j=0;for(const F of w)try{if(await m.checkAnnotationOverlap(u.value.id,F.start_index,F.end_index)){b++;continue}await m.addAnnotation({text_id:u.value.id,start_index:F.start_index,end_index:F.end_index,term:F.term,annotation:F.annotation,pinyin:F.pinyin||null,source:"ai"}),I++}catch(Oe){console.error("ä¿å­˜è¨»é‡‹å¤±æ•—:",F.term,Oe),j++}await m.fetchTextDetail(u.value.id);let D=`æˆåŠŸç”Ÿæˆä¸¦ä¿å­˜ ${I} å€‹è¨»é‡‹`;p.length-w.length>0&&(D+=`ï¼ˆ${p.length-w.length} å€‹ç„¡æ³•åŒ¹é…å·²è·³éï¼‰`),b>0&&(D+=`ï¼Œè·³é ${b} å€‹ï¼ˆèˆ‡ç”¨æˆ¶è¨»é‡‹é‡ç–Šï¼‰`),j>0&&(D+=`ï¼Œ${j} å€‹å¤±æ•—`),f.value=D}else f.value=`æœªç”Ÿæˆæœ‰æ•ˆè¨»é‡‹ï¼ˆ${p.length} å€‹ç„¡æ³•åŒ¹é…ï¼‰`}}catch(a){console.error("ç”Ÿæˆè¨»é‡‹å¤±æ•—:",a);let e="ç”Ÿæˆè¨»é‡‹æ™‚ç™¼ç”ŸéŒ¯èª¤";a?.message?e=a.message:a?.error?e=a.error:typeof a=="string"&&(e=a),console.error("å®Œæ•´éŒ¯èª¤å°è±¡:",a),f.value=e,alert(`ç”Ÿæˆè¨»é‡‹å¤±æ•—ï¼š${e}`)}finally{le.value=!1}}async function st(){if(!(!u.value||G.value.length===0))try{k.value=!0,f.value=null,await m.deleteAIGeneratedAnnotations(u.value.id);let a=0,e=0,n=0;for(const i of G.value)try{if(await m.checkAnnotationOverlap(u.value.id,i.start_index,i.end_index)){e++;continue}await m.addAnnotation({text_id:u.value.id,start_index:i.start_index,end_index:i.end_index,term:i.term,annotation:i.annotation,pinyin:i.pinyin||null,source:"ai"}),a++}catch(c){console.error("ä¿å­˜è¨»é‡‹å¤±æ•—:",i.term,c),n++}await m.fetchTextDetail(u.value.id),te.value=!1,G.value=[];let l=`æˆåŠŸä¿å­˜ ${a} å€‹è¨»é‡‹`;e>0&&(l+=`ï¼Œè·³é ${e} å€‹ï¼ˆèˆ‡ç”¨æˆ¶è¨»é‡‹é‡ç–Šï¼‰`),n>0&&(l+=`ï¼Œ${n} å€‹å¤±æ•—`),alert(l)}catch(a){f.value=a?.message||"ä¿å­˜è¨»é‡‹å¤±æ•—"}finally{k.value=!1}}async function rt(a){if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${a.term}ã€çš„è¨»é‡‹å—ï¼Ÿ`))try{await m.deleteAnnotation(a.id),u.value&&await m.fetchTextDetail(u.value.id)}catch(e){alert(e?.message||"åˆªé™¤å¤±æ•—")}}function dt(a){return a.content.replace(/\|/g,"").slice(0,40)+"..."}function ut(a){const e=/[ã€‚ï¼Œã€ï¼›ï¼šï¼ï¼Ÿ,.;:!?]/g,n=/[ã€Œã€ã€ã€""''ï¼ˆï¼‰()ã€ã€‘\[\]ã€Šã€‹<>Â·â€”â€¦ï½\-]/g;return a.split(/\n+/).map(c=>{let d=c.trim();return d?(d=d.replace(n,""),d=d.replace(e,"|"),d=d.replace(/\|+/g,"|").replace(/^\|/,"").replace(/\|$/,""),d):""}).filter(c=>c.length>0).join(`

`)}function ct(a){return a?new Date(a).toLocaleDateString():"--"}function Pe(a){return a.content.replace(/\|/g,"").length}function vt(a){const e=v.reading_category_ids.indexOf(a);e>-1?v.reading_category_ids.splice(e,1):v.reading_category_ids.push(a)}async function ce(){if(T.value.trim())try{const a=await m.createReadingCategory(T.value.trim());a&&v.reading_category_ids.push(a.id),T.value="",E.value=!1}catch(a){alert(a?.message||"æ–°å¢åˆ†é¡å¤±æ•—")}}function xe(){N.value=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window||navigator.maxTouchPoints>0}return pt(async()=>{xe(),window.addEventListener("resize",xe),N.value&&(document.addEventListener("click",re),document.addEventListener("touchend",re)),await Promise.all([m.fetchReadingCategories(),m.fetchReadingTexts(),ke.fetchLibrary()]),H.value.length>0&&!M.value&&H.value[0]&&(M.value=H.value[0].id)}),gt(()=>{window.removeEventListener("resize",xe),N.value&&(document.removeEventListener("click",re),document.removeEventListener("touchend",re))}),(a,e)=>(o(),s("div",Ct,[oe.value==="list"?(o(),s(R,{key:0},[t("header",wt,[e[34]||(e[34]=t("div",null,[t("p",{class:"edamame-text-level-detail"},"ç®¡ç†é–±è®€æ–‡ç« å’Œæå–ç·´ç¿’ç‰‡æ®µ"),t("h1",{class:"edamame-heading-gradient"},"é–±è®€æ–‡åº«")],-1)),t("div",Tt,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[0]||(e[0]=n=>{me(m).fetchReadingTexts(),me(m).fetchReadingCategories()}),disabled:me(m).isLoading}," é‡æ–°æ•´ç† ",8,$t),t("button",{class:"edamame-btn edamame-btn-primary",onClick:Re,disabled:!he.value}," æ–°å¢é–±è®€æ–‡ç«  ",8,At)])]),t("div",It,[t("aside",Rt,[t("div",St,[e[36]||(e[36]=t("span",{class:"sidebar-title"},"æ–‡é›†å°èˆª",-1)),t("button",{class:"icon-btn",onClick:e[1]||(e[1]=n=>{E.value=!0,T.value=""}),title:"æ–°å¢æ–‡é›†"},[...e[35]||(e[35]=[t("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M12 5v14M5 12h14"})],-1)])])]),me(m).isLoading?(o(),s("div",Mt,"è¼‰å…¥ä¸­â‹¯")):H.value.length?(o(),s("nav",Pt,[(o(!0),s(R,null,L(H.value,n=>(o(),s("div",{key:n.id,class:"tree-node"},[Z.value===n.id?(o(),s("div",Ot,[S(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>J.value=l),type:"text",class:"edit-input",onKeyup:[Q(we,["enter"]),Q(ie,["escape"])],ref_for:!0,ref:"editInput"},null,544),[[O,J.value]]),t("div",{class:"edit-actions"},[t("button",{class:"action-btn",onClick:we,title:"ç¢ºèª"},"âœ“"),t("button",{class:"action-btn",onClick:ie,title:"å–æ¶ˆ"},"Ã—")])])):(o(),s("div",{key:1,class:ye(["tree-item",{selected:M.value===n.id}]),onClick:l=>Be(n.id)},[t("span",Ft,r(n.name),1),t("span",Lt,r(Ce(n.id)),1),t("div",Vt,[t("button",{class:"action-btn",onClick:W(l=>Ue(n),["stop"]),title:"ç·¨è¼¯"},"âœ",8,Bt),t("button",{class:"action-btn danger",onClick:W(l=>Ne(n),["stop"]),title:"åˆªé™¤"},"Ã—",8,Ut)])],10,Dt))]))),128))])):(o(),s("div",Et,[e[37]||(e[37]=P(" å°šç„¡æ–‡é›† ",-1)),t("button",{class:"link-btn",onClick:e[2]||(e[2]=n=>{E.value=!0,T.value=""})},"å»ºç«‹ç¬¬ä¸€å€‹æ–‡é›†")])),E.value?(o(),s("div",Nt,[S(t("input",{"onUpdate:modelValue":e[4]||(e[4]=n=>T.value=n),type:"text",placeholder:"è¼¸å…¥æ–‡é›†åç¨±...",class:"category-input",onKeyup:[Q(ce,["enter"]),e[5]||(e[5]=Q(n=>E.value=!1,["escape"]))]},null,544),[[O,T.value]]),t("div",jt,[t("button",{class:"action-btn",onClick:ce,title:"ç¢ºèª"},"âœ“"),t("button",{class:"action-btn",onClick:e[6]||(e[6]=n=>E.value=!1),title:"å–æ¶ˆ"},"Ã—")])])):_("",!0)]),t("main",zt,[he.value?(o(),s(R,{key:1},[t("div",Gt,[t("h2",null,r(he.value.name),1),t("p",Kt,r(be.value.length)+" ç¯‡æ–‡ç« ",1)]),t("div",qt,[be.value.length?(o(),s("table",Ht,[e[40]||(e[40]=t("thead",null,[t("tr",null,[t("th",{style:{width:"auto","min-width":"200px"}},"æ¨™é¡Œ"),t("th",{style:{width:"80px"}},"ä½œè€…"),t("th",{style:{width:"70px"}},"å­—æ•¸"),t("th",{style:{width:"100px"}},"å»ºç«‹æ—¥æœŸ"),t("th",{style:{width:"120px"}},"æ“ä½œ")])],-1)),t("tbody",null,[(o(!0),s(R,null,L(be.value,n=>(o(),s("tr",{key:n.id,class:"text-row"},[t("td",{onClick:l=>de(n)},[t("p",Yt,r(n.title),1),t("p",Qt,r(dt(n)),1)],8,Xt),t("td",{onClick:l=>de(n)},r(n.author||"ä½šå"),9,Zt),t("td",{onClick:l=>de(n)},r(Pe(n)),9,en),t("td",{onClick:l=>de(n)},r(ct(n.created_at)),9,tn),t("td",{class:"actions",onClick:e[7]||(e[7]=W(()=>{},["stop"]))},[t("button",{class:"ghost-btn",onClick:l=>Se(n)},"ç·¨è¼¯",8,nn),t("button",{class:"ghost-btn danger",onClick:l=>Xe(n)},"åˆªé™¤",8,an)])]))),128))])])):(o(),s("div",Jt,[e[39]||(e[39]=t("p",null,"æ­¤æ–‡é›†å°šç„¡æ–‡ç« ",-1)),t("button",{class:"edamame-btn edamame-btn-primary",onClick:Re},"æ–°å¢ç¬¬ä¸€ç¯‡æ–‡ç« ")]))])],64)):(o(),s("div",Wt,[...e[38]||(e[38]=[t("p",null,"è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹æ–‡é›†",-1)])]))])])],64)):oe.value==="detail"&&u.value?(o(),s(R,{key:1},[t("header",on,[t("button",{class:"back-btn",onClick:Ie},[...e[41]||(e[41]=[t("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M19 12H5M12 19l-7-7 7-7"})],-1),P(" è¿”å›åˆ—è¡¨ ",-1)])]),t("div",ln,[t("button",{class:"edamame-btn edamame-btn-primary",onClick:it,disabled:le.value||!u.value,title:"ä½¿ç”¨ AI è‡ªå‹•ç”Ÿæˆè¨»é‡‹ï¼ˆå«æ‹¼éŸ³ï¼‰"},r(le.value?"ğŸ¤– AI ç”Ÿæˆä¸­...":"ğŸ¤– AI ç”Ÿæˆè¨»é‡‹"),9,sn),t("button",{class:"edamame-btn edamame-btn-secondary",onClick:He}," ç·¨è¼¯æ–‡ç«  ")])]),t("div",rn,[t("h1",dn,r(u.value.title),1),t("div",un,[u.value.author?(o(),s("span",cn,[e[42]||(e[42]=t("strong",null,"ä½œè€…ï¼š",-1)),P(r(u.value.author),1)])):_("",!0),u.value.source?(o(),s("span",vn,[e[43]||(e[43]=t("strong",null,"ä¾†æºï¼š",-1)),P(r(u.value.source),1)])):_("",!0),t("span",mn,[e[44]||(e[44]=t("strong",null,"å­—æ•¸ï¼š",-1)),P(r(Pe(u.value)),1)]),u.value.reading_categories?.length?(o(),s("span",fn,[e[45]||(e[45]=t("strong",null,"æ–‡é›†ï¼š",-1)),t("span",pn,[(o(!0),s(R,null,L(u.value.reading_categories,n=>(o(),s("span",{key:n.id,class:"category-tag"},r(n.name),1))),128))])])):_("",!0)])]),e[46]||(e[46]=t("div",{class:"action-hint"}," ğŸ’¡ é¸å–æ–‡å­—å¾Œå¯ä»¥ã€Œæå–ç‚ºç·´ç¿’ã€æˆ–ã€Œæ·»åŠ è¨»é‡‹ã€ ",-1)),C.show?(o(),s("div",gn,[t("span",yn,"ã€Œ"+r(C.text.slice(0,20))+r(C.text.length>20?"...":"")+"ã€",1),C.text.length>=10?(o(),s("button",{key:0,class:"toolbar-btn extract",onClick:et}," ğŸ“¤ æå–ç‚ºæ–·å¥ç·´ç¿’ ")):(o(),s("button",{key:1,class:"toolbar-btn annotate",onClick:nt}," ğŸ“ æ·»åŠ è¨»é‡‹ ")),t("button",{class:"toolbar-btn cancel",onClick:K}," âœ• ")])):_("",!0),t("div",{class:"text-content edamame-glass",onMouseup:Qe},[(o(!0),s(R,null,L(ze.value,(n,l)=>(o(),s("div",{key:l,class:"paragraph-block"},[t("div",hn,[(o(!0),s(R,null,L(n.chars,(i,c)=>(o(),s("span",{key:c,class:"char-unit"},[t("span",{class:ye(["char",{"has-annotation":Y(n.startIdx+c),"annotation-hovered":Ke(n.startIdx+c),"annotation-start":We(n.startIdx+c),"annotation-end":Ge(n.startIdx+c)}]),"data-global-index":n.startIdx+c,onMouseenter:d=>qe(n.startIdx+c,d),onMouseleave:Je,onClick:d=>$e(n.startIdx+c,d),onTouchend:d=>$e(n.startIdx+c,d)},r(i),43,bn)]))),128))])]))),128))],32),_e.value.length>0?(o(),s("div",_n,[t("h3",xn,"ğŸ“ å·²æ·»åŠ çš„è¨»é‡‹ ("+r(_e.value.length)+")",1),t("div",kn,[(o(!0),s(R,null,L(_e.value,n=>(o(),s("div",{key:n.id,class:"annotation-item"},[t("div",Cn,[P(r(n.term)+" ",1),n.pinyin?(o(),s("span",wn,"ï¼ˆ"+r(n.pinyin)+"ï¼‰",1)):_("",!0)]),t("div",Tn,r(n.annotation),1),t("div",$n,[t("button",{class:"edit-btn",onClick:l=>at(n),title:"ç·¨è¼¯"}," âœï¸ ",8,An),t("button",{class:"delete-btn",onClick:l=>rt(n),title:"åˆªé™¤"}," âœ• ",8,In)])]))),128))])])):_("",!0)],64)):_("",!0),(o(),ne(ae,{to:"body"},[fe(ge,{name:"fade"},{default:pe(()=>[V.value?(o(),s("div",{key:0,class:"modal-backdrop",onClick:e[18]||(e[18]=W(n=>V.value=!1,["self"]))},[t("div",Rn,[t("header",null,[t("h3",null,r(U.value?"ç·¨è¼¯é–±è®€æ–‡ç« ":"æ–°å¢é–±è®€æ–‡ç« "),1),t("button",{class:"close-btn",onClick:e[8]||(e[8]=n=>V.value=!1)},"Ã—")]),t("div",Sn,[t("div",Mn,[t("label",En,[e[47]||(e[47]=t("span",null,"æ¨™é¡Œ *",-1)),S(t("input",{"onUpdate:modelValue":e[9]||(e[9]=n=>v.title=n),type:"text",placeholder:"æ–‡ç« æ¨™é¡Œ"},null,512),[[O,v.title]])])]),t("div",Pn,[t("label",null,[e[48]||(e[48]=t("span",null,"ä½œè€…",-1)),S(t("input",{"onUpdate:modelValue":e[10]||(e[10]=n=>v.author=n),type:"text",placeholder:"ä¾‹å¦‚ï¼šé™¶æ·µæ˜"},null,512),[[O,v.author]])]),t("label",null,[e[49]||(e[49]=t("span",null,"ä¾†æº",-1)),S(t("input",{"onUpdate:modelValue":e[11]||(e[11]=n=>v.source=n),type:"text",placeholder:"ä¾‹å¦‚ï¼šå¤æ–‡è§€æ­¢"},null,512),[[O,v.source]])])]),t("label",null,[e[50]||(e[50]=t("span",null,"æ–‡é›†ï¼ˆé»æ“Šé¸æ“‡ï¼‰*",-1)),t("div",On,[(o(!0),s(R,null,L(H.value,n=>(o(),s("button",{key:n.id,type:"button",class:ye(["category-tag-btn",{selected:v.reading_category_ids.includes(n.id)}]),onClick:l=>vt(n.id)},[v.reading_category_ids.includes(n.id)?(o(),s("span",Fn,"âœ“")):_("",!0),P(" "+r(n.name),1)],10,Dn))),128)),E.value?(o(),s("div",Ln,[S(t("input",{"onUpdate:modelValue":e[12]||(e[12]=n=>T.value=n),type:"text",class:"new-category-input-inline",onKeyup:[Q(ce,["enter"]),e[13]||(e[13]=Q(n=>{E.value=!1,T.value=""},["escape"]))]},null,544),[[O,T.value]]),t("button",{type:"button",class:"inline-action confirm",onClick:ce},"âœ“"),t("button",{type:"button",class:"inline-action cancel",onClick:e[14]||(e[14]=n=>{E.value=!1,T.value=""})},"Ã—")])):(o(),s("button",{key:1,type:"button",class:"category-tag-btn add-new",onClick:e[15]||(e[15]=n=>{E.value=!0,T.value=""})}," + æ–°å¢æ–‡é›† "))])]),t("label",null,[e[51]||(e[51]=t("span",null,"å…§å®¹ï¼ˆå¯ç›´æ¥ç²˜è²¼å¸¶æ¨™é»çš„åŸæ–‡ï¼‰",-1)),S(t("textarea",{"onUpdate:modelValue":e[16]||(e[16]=n=>v.content=n),rows:"10",placeholder:`ç›´æ¥ç²˜è²¼å¤æ–‡åŸæ–‡å³å¯ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†æ¨™é»ç¬¦è™Ÿã€‚

ä¾‹å¦‚ï¼š
æ™‰å¤ªåŸä¸­ï¼Œæ­¦é™µäººæ•é­šç‚ºæ¥­ã€‚ç·£æºªè¡Œï¼Œå¿˜è·¯ä¹‹é è¿‘ã€‚

æ®µè½ä¹‹é–“ç”¨ç©ºè¡Œåˆ†éš”ã€‚`},null,512),[[O,v.content]])]),f.value?(o(),s("p",Vn,r(f.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[17]||(e[17]=n=>V.value=!1)}," å–æ¶ˆ "),t("button",{class:"edamame-btn edamame-btn-primary",disabled:k.value,onClick:Ye},r(k.value?"å„²å­˜ä¸­...":"å„²å­˜"),9,Bn)])])])):_("",!0)]),_:1})])),(o(),ne(ae,{to:"body"},[fe(ge,{name:"fade"},{default:pe(()=>[q.value?(o(),s("div",{key:0,class:"modal-backdrop",onClick:e[24]||(e[24]=W(n=>q.value=!1,["self"]))},[t("div",Un,[t("header",null,[e[52]||(e[52]=t("h3",null,"ğŸ“¤ æå–ç‚ºç·´ç¿’ç´ æ",-1)),t("button",{class:"close-btn",onClick:e[19]||(e[19]=n=>q.value=!1)},"Ã—")]),t("div",Nn,[t("div",jn,[e[53]||(e[53]=t("p",{class:"preview-label"},"é¸å–çš„ç‰‡æ®µï¼š",-1)),t("p",zn,r(h.selectedText),1),t("p",Wn," å…± "+r(h.selectedText.length)+" å­— ",1)]),t("label",null,[e[54]||(e[54]=t("span",null,"ç·´ç¿’æ¨™é¡Œ *",-1)),S(t("input",{"onUpdate:modelValue":e[20]||(e[20]=n=>h.title=n),type:"text",placeholder:"ä¾‹å¦‚ï¼šæ¡ƒèŠ±æºè¨˜ï¼ˆç¯€é¸ä¸€ï¼‰"},null,512),[[O,h.title]])]),t("div",Gn,[t("label",null,[e[56]||(e[56]=t("span",null,"åˆ†é¡",-1)),S(t("select",{"onUpdate:modelValue":e[21]||(e[21]=n=>h.category_id=n)},[e[55]||(e[55]=t("option",{value:null},"ä¸åˆ†é¡",-1)),(o(!0),s(R,null,L(Ve.value,n=>(o(),s("option",{key:n.id,value:n.id},r(n.name),9,Kn))),128))],512),[[De,h.category_id]])]),t("label",null,[e[58]||(e[58]=t("span",null,"é›£åº¦",-1)),S(t("select",{"onUpdate:modelValue":e[22]||(e[22]=n=>h.difficulty=n)},[...e[57]||(e[57]=[t("option",{value:1},"åˆç´š",-1),t("option",{value:2},"ä¸­ç´š",-1),t("option",{value:3},"é«˜ç´š",-1)])],512),[[De,h.difficulty]])])]),t("p",qn," æå–å¾Œçš„ç·´ç¿’ç´ æå°‡é—œè¯åˆ°åŸæ–‡ç« ï¼Œå­¸ç”Ÿç·´ç¿’æ™‚å¯ä»¥çœ‹åˆ°ã€Œä¾†è‡ªã€Š"+r(u.value?.title)+"ã€‹ã€ ",1),f.value?(o(),s("p",Jn,r(f.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[23]||(e[23]=n=>q.value=!1)}," å–æ¶ˆ "),t("button",{class:"edamame-btn edamame-btn-primary",disabled:k.value,onClick:ot},r(k.value?"æå–ä¸­...":"ç¢ºèªæå–"),9,Hn)])])])):_("",!0)]),_:1})])),(o(),ne(ae,{to:"body"},[fe(ge,{name:"fade"},{default:pe(()=>[te.value?(o(),s("div",{key:0,class:"modal-backdrop",onClick:e[27]||(e[27]=W(n=>te.value=!1,["self"]))},[t("div",Xn,[t("header",null,[t("h3",null,"ğŸ¤– AI ç”Ÿæˆçš„è¨»é‡‹é è¦½ ("+r(G.value.length)+" å€‹)",1),t("button",{class:"close-btn",onClick:e[25]||(e[25]=n=>te.value=!1)},"Ã—")]),t("div",Yn,[e[59]||(e[59]=t("p",{class:"preview-hint"},"è«‹æª¢æŸ¥ä»¥ä¸‹è¨»é‡‹ï¼Œç¢ºèªç„¡èª¤å¾Œé»æ“Šã€Œå…¨éƒ¨ä¿å­˜ã€",-1)),t("div",Qn,[(o(!0),s(R,null,L(G.value,(n,l)=>(o(),s("div",{key:l,class:"generated-annotation-item"},[t("div",Zn,[t("span",ea,[P(r(n.term)+" ",1),n.pinyin?(o(),s("span",ta,"ï¼ˆ"+r(n.pinyin)+"ï¼‰",1)):_("",!0)]),t("span",na,"ä½ç½®ï¼š"+r(n.start_index)+"-"+r(n.end_index),1)]),t("div",aa,r(n.annotation),1)]))),128))]),f.value?(o(),s("p",oa,r(f.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[26]||(e[26]=n=>te.value=!1)}," å–æ¶ˆ "),t("button",{class:"edamame-btn edamame-btn-primary",disabled:k.value||G.value.length===0,onClick:st},r(k.value?"ä¿å­˜ä¸­...":`å…¨éƒ¨ä¿å­˜ (${G.value.length})`),9,la)])])])):_("",!0)]),_:1})])),(o(),ne(ae,{to:"body"},[fe(ge,{name:"fade"},{default:pe(()=>[B.value?(o(),s("div",{key:0,class:"modal-backdrop",onClick:e[32]||(e[32]=W(n=>{B.value=!1,$.value=null},["self"]))},[t("div",ia,[t("header",null,[t("h3",null,r($.value?"âœï¸ ç·¨è¼¯è¨»é‡‹":"ğŸ“ æ·»åŠ è¨»é‡‹"),1),t("button",{class:"close-btn",onClick:e[28]||(e[28]=n=>{B.value=!1,$.value=null})},"Ã—")]),t("div",sa,[t("div",ra,[e[60]||(e[60]=t("p",{class:"preview-label"},"é¸å–çš„å­—è©ï¼š",-1)),t("p",da,r(y.selectedText),1)]),t("label",null,[e[61]||(e[61]=t("span",null,"è¨»é‡‹å…§å®¹ *",-1)),S(t("textarea",{"onUpdate:modelValue":e[29]||(e[29]=n=>y.annotation=n),rows:"4",placeholder:"è¼¸å…¥å°é€™å€‹å­—è©çš„è§£é‡‹..."},null,512),[[O,y.annotation]])]),t("label",null,[e[62]||(e[62]=t("span",null,"æ‹¼éŸ³ï¼ˆå¯é¸ï¼Œç”¨æ–¼é›£è®€å­—ï¼‰",-1)),S(t("input",{"onUpdate:modelValue":e[30]||(e[30]=n=>y.pinyin=n),type:"text",placeholder:"ä¾‹å¦‚ï¼šzhÃ¬",disabled:ee.value},null,8,ua),[[O,y.pinyin]])]),ee.value?(o(),s("div",ca,[...e[63]||(e[63]=[t("span",{class:"loading-spinner"},"â³",-1),P(" æ­£åœ¨æŸ¥è©¢æ‹¼éŸ³å’Œé‡‹ç¾©... ",-1)])])):_("",!0),f.value&&!ee.value?(o(),s("p",va,r(f.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[31]||(e[31]=n=>{B.value=!1,$.value=null})}," å–æ¶ˆ "),t("button",{class:"edamame-btn edamame-btn-primary",disabled:k.value,onClick:lt},r(k.value?$.value?"æ›´æ–°ä¸­...":"æ·»åŠ ä¸­...":$.value?"ç¢ºèªæ›´æ–°":"ç¢ºèªæ·»åŠ "),9,ma)])])])):_("",!0)]),_:1})])),(o(),ne(ae,{to:"body"},[A.value?(o(),s("div",{key:0,class:ye(["annotation-tooltip",{"mobile-tooltip":N.value}]),style:yt({left:A.value.x+"px",top:A.value.y+16+"px"}),onClick:e[33]||(e[33]=W(()=>{},["stop"]))},[N.value?(o(),s("button",{key:0,class:"tooltip-close-btn",onClick:se,"aria-label":"é—œé–‰è¨»é‡‹"}," âœ• ")):_("",!0),t("div",fa,[P(r(A.value.annotation.term)+" ",1),A.value.annotation.pinyin?(o(),s("span",pa,"ï¼ˆ"+r(A.value.annotation.pinyin)+"ï¼‰",1)):_("",!0)]),t("div",ga,r(A.value.annotation.annotation),1)],6)):_("",!0)]))]))}}),Ca=bt(ya,[["__scopeId","data-v-12d03131"]]);export{Ca as default};
