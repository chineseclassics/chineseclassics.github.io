import{d as W,c as i,x as X,r as E,w as N,f as Y,R as Z,a as l,g as s,h as m,t as r,b as g,e as V,n as D,F as b,j as S,m as I,i as d,l as P,o as n,_ as ee}from"./index-SMzO0Qz9.js";import{u as se}from"./gameStore-Cm5WhxO7.js";import{d as v,c as w}from"./game-DlkGF0Ko.js";import{T as R}from"./TeamBadge-Dgu0cHNC.js";import{R as te}from"./RaceTrack-fYZQNsnd.js";import{B as ae}from"./BeanIcon-Dx-YFz1d.js";import"./userStatsStore-COhb7vFW.js";const oe={class:"board-header"},re={class:"header-left"},ne={class:"text-info"},le={key:0},ce={class:"header-center"},ie={class:"countdown-label"},de={class:"countdown-time"},me={class:"header-right"},ue={class:"progress-info"},_e={class:"progress-value"},ve={key:0,class:"main-content-wrapper"},pe={class:"time-progress-container"},he={class:"time-progress-header"},ge={class:"time-progress-text"},fe={class:"time-progress-bar"},ye={class:"teams-cards-container"},ke={class:"team-card-header"},be={class:"team-card-title"},we={class:"team-card-progress"},Ce={class:"team-card-score"},Te={class:"score-value"},Se={class:"team-card-members"},xe={class:"member-info"},Me=["src","alt"],Be={key:1,class:"member-avatar-placeholder"},De={class:"member-name"},Ie={class:"member-status"},Re={class:"score"},ze={class:"accuracy"},Fe={key:1,class:"status-badge playing"},$e={key:2,class:"status-badge waiting"},Ae={class:"top-scores-panel-full"},Ge={class:"top-scores-list"},Ee={class:"rank-badge"},Ne=["src","alt"],Ve={key:1,class:"top-score-avatar-placeholder"},Le={class:"top-score-info"},Oe={class:"top-score-name"},je={class:"top-score-value"},Ue={key:0,class:"no-scores"},qe={key:1,class:"finish-overlay"},He={class:"finish-content"},Je={class:"final-ranking"},Ke={class:"rank"},Qe={class:"team-name"},We={class:"team-members"},Xe={class:"team-avg-score"},Ye={key:0,class:"winner-reward-section"},Ze={class:"winner-reward-header"},Pe={class:"winner-reward-title"},es={class:"winner-reward-amount"},ss={class:"winner-reward-note"},ts=W({__name:"GameBoard",setup(as){const L=P(),O=X(),f=se(),j=i(()=>O.params.roomId),c=i(()=>f.currentRoom),z=i(()=>c.value?.teams||[]),u=i(()=>c.value?.participants||[]),C=E(0);let _=null;const p=i(()=>c.value?.status==="finished"),x=i(()=>z.value.map(a=>{const t=u.value.filter(k=>k.team_id===a.id),e=t.filter(k=>k.status==="completed"),o=t.reduce((k,Q)=>k+(Q.score||0),0),B=t.length>0?o/t.length:0;return{team:a,memberCount:t.length,completedCount:e.length,averageScore:B}})),T=i(()=>[...x.value].sort((a,t)=>t.averageScore-a.averageScore)),h=i(()=>T.value[0]||null),U=i(()=>h.value?u.value.filter(a=>a.team_id===h.value.team.id):[]),q=i(()=>{const a={};for(const t of z.value)a[t.id]=u.value.filter(e=>e.team_id===t.id).sort((e,o)=>o.score-e.score);return a}),H=i(()=>u.value.filter(a=>a.status==="completed").length),F=i(()=>x.value.length?x.value.map(a=>{const t=v(a.team),e=T.value.findIndex(o=>o.team.id===a.team.id)+1;return{id:a.team.id,team:a.team,displayAvg:a.averageScore,rank:e,productType:t,isMyTeam:!1,name:a.team.team_name,memberCount:a.memberCount,completedCount:a.completedCount}}):[]),M=i(()=>{if(!c.value?.started_at||!c.value?.time_limit)return 0;const a=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-a)/1e3);return Math.min(t/c.value.time_limit,1)*100}),$=i(()=>[...u.value].filter(a=>a.score>0).sort((a,t)=>(t.score||0)-(a.score||0)).slice(0,5).map((a,t)=>({...a,rank:t+1}))),y=E([]);N(()=>u.value,(a,t)=>{!t||t.length===0||(a.forEach(e=>{const o=t.find(B=>B.id===e.id);o&&(e.status==="completed"&&o.status!=="completed"?y.value.unshift({id:`${e.id}-${Date.now()}`,participant:e,action:"completed",score:e.score,timestamp:Date.now()}):e.score!==o.score&&e.score>o.score&&y.value.unshift({id:`${e.id}-${Date.now()}`,participant:e,action:"scored",score:e.score,timestamp:Date.now()}))}),y.value.length>10&&(y.value=y.value.slice(0,10)))},{deep:!0});function J(a){const t=Math.floor(a/60),e=a%60;return`${t}:${e.toString().padStart(2,"0")}`}function A(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const t=new Date(c.value.started_at).getTime(),e=Math.floor((Date.now()-t)/1e3);C.value=Math.max(0,c.value.time_limit-e),C.value===0&&(_&&(clearInterval(_),_=null),p.value||f.endGame())};a(),_=setInterval(a,1e3)}async function K(){confirm("ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ")&&await f.endGame()}function G(){f.reset(),L.push({name:"arena"})}return N(()=>c.value?.status,a=>{a==="playing"&&!_&&A()}),Y(()=>{f.subscribeToRoom(j.value),c.value?.status==="playing"&&A()}),Z(()=>{_&&clearInterval(_)}),(a,t)=>(n(),l("div",{class:g(["game-board",{finished:p.value}])},[s("header",oe,[s("div",re,[s("button",{class:"back-btn",onClick:G}," â† é›¢é–‹ "),s("div",ne,[s("h1",null,r(c.value?.text?.title),1),c.value?.text?.author?(n(),l("p",le,r(c.value?.text?.author),1)):m("",!0)])]),s("div",ce,[s("div",{class:g(["countdown",{warning:C.value<30}])},[s("span",ie,r(p.value?"æ¯”è³½çµæŸ":"å‰©é¤˜æ™‚é–“"),1),s("span",de,r(J(C.value)),1)],2)]),s("div",me,[s("div",ue,[t[0]||(t[0]=s("span",{class:"progress-label"},"å®Œæˆé€²åº¦",-1)),s("span",_e,r(H.value)+" / "+r(u.value.length),1)]),p.value?m("",!0):(n(),l("button",{key:0,class:"btn-danger",onClick:K}," çµæŸæ¯”è³½ "))])]),!p.value&&F.value.length?(n(),l("div",ve,[V(te,{teams:F.value,height:150,"racer-size":72,"show-rankings":!1,class:"teacher-race-track"},null,8,["teams"]),s("div",pe,[s("div",he,[t[1]||(t[1]=s("span",{class:"time-progress-label"},"æ¯”è³½é€²åº¦",-1)),s("span",ge,r(Math.round(M.value))+"%",1)]),s("div",fe,[s("div",{class:g(["time-progress-fill",{warning:M.value>80}]),style:D({width:`${M.value}%`})},null,6)])]),s("div",ye,[(n(!0),l(b,null,S(T.value,e=>(n(),l("div",{key:e.team.id,class:"team-card",style:D({"--team-primary":d(w)[e.team.team_color].primary,"--team-secondary":d(w)[e.team.team_color].secondary,"--team-text":d(w)[e.team.team_color].text})},[s("div",ke,[d(v)(e.team)?(n(),I(R,{key:0,"product-type":d(v)(e.team),size:48,class:"team-card-badge"},null,8,["product-type"])):m("",!0),s("div",be,[s("h3",null,r(e.team.team_name),1),s("span",we,r(e.completedCount)+"/"+r(e.memberCount)+" äºº",1)]),s("div",Ce,[s("span",Te,r(e.averageScore.toFixed(1)),1),t[2]||(t[2]=s("span",{class:"score-label"},"å¹³å‡åˆ†",-1))])]),s("div",Se,[(n(!0),l(b,null,S(q.value[e.team.id],o=>(n(),l("div",{key:o.id,class:g(["member-item",{completed:o.status==="completed"}])},[s("div",xe,[o.user?.avatar_url?(n(),l("img",{key:0,src:o.user.avatar_url,alt:o.user.display_name,class:"member-avatar"},null,8,Me)):(n(),l("span",Be,r(o.user?.display_name?.charAt(0)||"?"),1)),s("span",De,r(o.user?.display_name||"æœªçŸ¥"),1)]),s("div",Ie,[o.status==="completed"?(n(),l(b,{key:0},[s("span",Re,r(o.score)+" åˆ†",1),s("span",ze,r(o.accuracy?.toFixed(0))+"%",1)],64)):o.status==="playing"?(n(),l("span",Fe,"ä½œç­”ä¸­...")):(n(),l("span",$e,"ç­‰å¾…ä¸­"))])],2))),128))])],4))),128))]),s("div",Ae,[t[3]||(t[3]=s("h3",{class:"panel-title"},"ğŸ† å¾—åˆ†å‰äº”",-1)),s("div",Ge,[(n(!0),l(b,null,S($.value,e=>(n(),l("div",{key:e.id,class:g(["top-score-item",{"rank-1":e.rank===1,"rank-2":e.rank===2,"rank-3":e.rank===3}])},[s("span",Ee,r(e.rank),1),e.user?.avatar_url?(n(),l("img",{key:0,src:e.user.avatar_url,alt:e.user.display_name,class:"top-score-avatar"},null,8,Ne)):(n(),l("span",Ve,r(e.user?.display_name?.charAt(0)||"?"),1)),s("div",Le,[s("span",Oe,r(e.user?.display_name||"æœªçŸ¥"),1),s("span",je,r(e.score)+" åˆ†",1)])],2))),128)),$.value.length===0?(n(),l("div",Ue," æš«ç„¡åˆ†æ•¸ ")):m("",!0)])])])):m("",!0),p.value?(n(),l("div",qe,[s("div",He,[t[6]||(t[6]=s("div",{class:"trophy"},"ğŸ†",-1)),t[7]||(t[7]=s("h2",null,"æ¯”è³½çµæŸï¼",-1)),s("div",Je,[(n(!0),l(b,null,S(T.value,(e,o)=>(n(),l("div",{key:e.team.id,class:g(["ranking-item",{winner:o===0}]),style:D({"--team-primary":d(w)[e.team.team_color].primary,"--team-secondary":d(w)[e.team.team_color].secondary})},[s("span",Ke,r(o===0?"ğŸ†":o+1),1),d(v)(e.team)?(n(),I(R,{key:0,"product-type":d(v)(e.team),size:28,class:"team-badge-in-mini-ranking"},null,8,["product-type"])):m("",!0),s("span",Qe,r(e.team.team_name),1),s("span",We,r(e.completedCount)+"/"+r(e.memberCount)+" äºº",1),s("span",Xe,r(e.averageScore.toFixed(1))+" åˆ†",1)],6))),128))]),h.value?(n(),l("div",Ye,[s("div",Ze,[d(v)(h.value.team)?(n(),I(R,{key:0,"product-type":d(v)(h.value.team),size:40,class:"winner-badge"},null,8,["product-type"])):m("",!0),s("div",Pe,[s("h3",null,r(h.value.team.team_name)+" ç²å‹ï¼",1),t[4]||(t[4]=s("p",{class:"winner-reward-subtitle"},"æ¯ä½æˆå“¡ç²å¾—",-1))])]),s("div",es,[t[5]||(t[5]=s("span",{class:"reward-number"},"20",-1)),V(ae,{size:48,class:"reward-bean-icon"})]),s("p",ss,"å…± "+r(U.value.length)+" ä½æˆå“¡",1)])):m("",!0),t[8]||(t[8]=s("p",{class:"scoring-note"},"* ä»¥éšŠå“¡å¹³å‡åˆ†è¨ˆç®—æ’å",-1)),s("button",{class:"btn-primary btn-large",onClick:G}," è¿”å›é¬¥è±† ")])])):m("",!0)],2))}}),ms=ee(ts,[["__scopeId","data-v-47fc5a34"]]);export{ms as default};
