import{d as Q,u as X,c,q as Y,r as S,w as Z,o as ee,a as l,b as s,e as m,t as n,n as d,F as x,g as M,m as C,h as se,j as L,i as te,f as V,s as o,_ as ae}from"./index-ByymFW75.js";import{u as ne,g as re,c as O}from"./gameStore-BfzZgG7Y.js";import{u as le}from"./userStatsStore-BLQoLuG3.js";const oe={class:"result-header"},ue={class:"result-icon"},ie={class:"bean-sign"},ce={key:0,class:"bean-note"},ve={key:0,class:"ranking-section"},me={class:"ranking-list"},de=["src","alt"],pe={key:1,class:"avatar-placeholder"},_e={class:"name"},ge={class:"score"},fe={class:"accuracy"},he={class:"time"},ke={key:1,class:"streak-card"},ye={class:"streak-text"},be={key:2,class:"answers-section"},we={key:0,class:"result-tabs"},Se=["onClick"],Ce={class:"tab-number"},Re={class:"tab-title"},Be={class:"tab-stats"},Te={key:1,class:"answer-detail"},xe={class:"answer-header"},Me={key:0,class:"answer-author"},Ae={class:"answer-stats"},Ie={class:"stat correct"},Pe={class:"stat wrong"},Ve={class:"stat missed"},De={class:"answer-content"},Fe={class:"answer-line"},Ge={class:"answer-char"},Ne={key:3,class:"ranking-section"},$e={class:"team-ranking-list"},ze={class:"rank"},qe={class:"team-name"},Le={class:"team-score"},Oe={class:"rank-title-section"},We={class:"level-text"},Ee=Q({__name:"GameResult",setup(Ue){const A=te(),W=Y(),k=ne(),R=X(),I=le(),B=c(()=>W.params.roomId),u=c(()=>k.currentRoom),p=c(()=>k.myParticipant),v=S(null),T=S(0),i=c(()=>{if(!v.value)return null;const a=v.value.texts[T.value],e=v.value.results[T.value];return!a||!e?null:{text:a,result:e}});function D(a){const e=[];for(const t of a)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function F(a){if(!i.value?.result)return"none";const e=i.value.result,t=e.userBreaks.includes(a),r=e.correctBreaks.includes(a);return t&&r?"correct":t&&!r?"wrong":!t&&r?"missed":"none"}const _=c(()=>{if(!u.value||!R.user)return!1;if(u.value.game_mode==="team_battle")return p.value?.team_id===u.value.winner_team_id;{if(u.value.winner_user_id)return u.value.winner_user_id===R.user.id;if(!u.value.participants)return!1;const a=p.value?.score??0,e=p.value?.time_spent??999999,t=Math.max(...u.value.participants.map(g=>g.score)),r=u.value.participants.filter(g=>g.score===t),w=Math.min(...r.map(g=>g.time_spent??999999));return a===t&&e===w}}),f=c(()=>!u.value||u.value.game_mode==="team_battle"?!1:!u.value.winner_user_id&&_.value),E=c(()=>u.value?.participants?[...u.value.participants].sort((a,e)=>e.score-a.score).map((a,e)=>({...a,rank:e+1})):[]),U=c(()=>u.value?.teams?[...u.value.teams].sort((a,e)=>e.total_score-a.total_score):[]),G=c(()=>I.level),N=c(()=>re(G.value)),$=c(()=>I.profile?.pvp_win_streak??0),z=S(!1),y=S(0),b=S(!1),h=c(()=>{if(!p.value)return console.log("[GameResult] myParticipant ç‚ºç©º"),{amount:0,type:"neutral"};const a=p.value.prize_won||0,e=p.value.fee_paid||0;return console.log("[GameResult] è¨ˆç®—å¾—è±†è®ŠåŒ–:",{prizeWon:a,feePaid:e,isWinner:_.value,isTie:f.value,participant:p.value}),a>0?{amount:a,type:"win"}:e>0&&!_.value?{amount:-e,type:"lose"}:f.value&&e>0?{amount:0,type:"tie"}:{amount:0,type:"neutral"}});function j(){const a=Math.abs(h.value.amount);if(a===0&&h.value.type!=="tie"){b.value=!0;return}z.value=!0,y.value=0;const e=2500,t=Date.now(),r=a>0?a:100;function w(){const g=Date.now()-t,P=Math.min(g/e,1);if(P<1){if(P<.8)y.value=Math.floor(Math.random()*r*1.5);else{const q=(P-.8)/.2;y.value=Math.floor(a*q+Math.random()*(a*(1-q)))}requestAnimationFrame(w)}else y.value=a,b.value=!0}setTimeout(()=>{requestAnimationFrame(w)},500)}function J(a){v.value&&a>=0&&a<v.value.texts.length&&(T.value=a)}function H(){k.reset(),sessionStorage.removeItem(`game-result-${B.value}`),A.push({name:"arena"})}function K(){k.reset(),sessionStorage.removeItem(`game-result-${B.value}`),R.isTeacher?A.push({name:"arena-teacher-create"}):A.push({name:"arena-create"})}return Z(()=>u.value?.status,a=>{}),ee(()=>{k.subscribeToRoom(B.value),I.fetchProfile();const a=sessionStorage.getItem(`game-result-${B.value}`);if(a)try{v.value=JSON.parse(a)}catch{}j()}),(a,e)=>(o(),l("div",{class:d(["game-result",{winner:_.value,tie:f.value}])},[s("header",oe,[s("div",ue,n(f.value?"ğŸ¤":_.value?"ğŸ†":"ğŸ’ª"),1),s("h1",null,n(f.value?"å¹³å±€ï¼":_.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),z.value||h.value.type!=="neutral"?(o(),l("div",{key:0,class:d(["bean-change-display",[h.value.type,{complete:b.value}]])},[s("span",ie,n(h.value.type==="lose"?"-":h.value.type==="win"?"+":""),1),s("span",{class:d(["bean-number",{rolling:!b.value}])},n(y.value),3),e[0]||(e[0]=s("span",{class:"bean-icon"},"ğŸ«˜",-1)),f.value&&b.value?(o(),l("span",ce,"å…¥å ´è²»å·²é€€é‚„")):m("",!0)],2)):m("",!0)]),u.value?.game_mode==="pvp"?(o(),l("section",ve,[e[1]||(e[1]=s("h2",null,"æ’è¡Œæ¦œ",-1)),s("div",me,[(o(!0),l(x,null,M(E.value,t=>(o(),l("div",{key:t.id,class:d(["ranking-item",{me:t.user_id===V(R).user?.id,top:t.rank<=3}])},[s("span",{class:d(["rank",`rank-${t.rank}`])},n(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(o(),l("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,de)):(o(),l("span",pe,n(t.user?.display_name?.charAt(0)||"?"),1)),s("span",_e,n(t.user?.display_name||"æœªçŸ¥"),1),s("span",ge,n(t.score)+" åˆ†",1),s("span",fe,n(t.accuracy?.toFixed(0)||0)+"%",1),s("span",he,n(t.time_spent)+"s",1)],2))),128))])])):m("",!0),$.value>0&&_.value?(o(),l("div",ke,[e[4]||(e[4]=s("span",{class:"streak-icon"},"ğŸ”¥",-1)),s("span",ye,[e[2]||(e[2]=C(" é€£å‹ ",-1)),s("strong",null,n($.value),1),e[3]||(e[3]=C(" å ´ï¼ ",-1))])])):m("",!0),v.value?(o(),l("section",be,[e[10]||(e[10]=s("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),v.value.texts.length>1?(o(),l("div",we,[(o(!0),l(x,null,M(v.value.texts,(t,r)=>(o(),l("button",{key:t.id,class:d(["result-tab",{active:r===T.value}]),onClick:w=>J(r)},[s("span",Ce,n(r+1),1),s("span",Re,n(t.title),1),s("span",Be," âœ“"+n(v.value.results[r]?.correctCount||0),1)],10,Se))),128))])):m("",!0),i.value&&i.value.text&&i.value.result?(o(),l("div",Te,[s("div",xe,[s("h3",null,n(i.value.text.title),1),i.value.text.author?(o(),l("span",Me,n(i.value.text.author),1)):m("",!0)]),s("div",Ae,[s("span",Ie,[e[5]||(e[5]=s("span",{class:"bean-legend correct"},null,-1)),C(" æ­£ç¢º "+n(i.value.result.correctCount),1)]),s("span",Pe,[e[6]||(e[6]=s("span",{class:"bean-legend wrong"},null,-1)),C(" éŒ¯èª¤ "+n(i.value.result.wrongCount),1)]),s("span",Ve,[e[7]||(e[7]=s("span",{class:"bean-legend missed"},null,-1)),C(" éºæ¼ "+n(i.value.result.missedCount),1)])]),s("div",De,[s("div",Fe,[(o(!0),l(x,null,M(D(i.value.text.content),(t,r)=>(o(),l("span",{key:r,class:"char-unit"},[s("span",Ge,n(t),1),r<D(i.value.text.content).length-1&&F(r)!=="none"?(o(),l("span",{key:0,class:d(["bean-slot",F(r)])},[...e[8]||(e[8]=[s("span",{class:"bean"},null,-1)])],2)):m("",!0)]))),128))])]),e[9]||(e[9]=se('<div class="answer-legend" data-v-7b273b94><span class="legend-item" data-v-7b273b94><span class="bean-legend correct" data-v-7b273b94></span> æ­£ç¢º </span><span class="legend-item" data-v-7b273b94><span class="bean-legend wrong" data-v-7b273b94></span> éŒ¯èª¤ </span><span class="legend-item" data-v-7b273b94><span class="bean-legend missed" data-v-7b273b94></span> éºæ¼ </span></div>',1))])):m("",!0)])):m("",!0),u.value?.game_mode==="team_battle"?(o(),l("section",Ne,[e[11]||(e[11]=s("h2",null,"éšŠä¼æ’è¡Œ",-1)),s("div",$e,[(o(!0),l(x,null,M(U.value,(t,r)=>(o(),l("div",{key:t.id,class:d(["team-ranking-item",{winner:r===0}]),style:L({"--team-primary":V(O)[t.team_color].primary,"--team-secondary":V(O)[t.team_color].secondary})},[s("span",ze,n(r===0?"ğŸ†":r+1),1),s("span",qe,n(t.team_name),1),s("span",Le,n(t.total_score)+" åˆ†",1)],6))),128))])])):m("",!0),s("section",Oe,[e[12]||(e[12]=s("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),s("div",{class:"rank-title-display",style:L({color:N.value.color})},n(N.value.title),5),s("p",We,"Lv."+n(G.value),1)]),s("footer",{class:"result-footer"},[s("button",{class:"btn-secondary",onClick:H}," è¿”å›é¬¥è±† "),s("button",{class:"btn-primary",onClick:K}," å†ä¾†ä¸€å±€ ")])],2))}}),Ke=ae(Ee,[["__scopeId","data-v-7b273b94"]]);export{Ke as default};
