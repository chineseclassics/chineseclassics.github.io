import{v as B,u as $,r as m,c as w}from"./index-BzwI5WAb.js";import{u as R}from"./useSupabase-Btt4fF0Q.js";const z=/[。！？；，：]/g,D=/[「」『』“”"']/g,F=/\|{2,}/g;function C(r){if(!r)return"";const d=r.replace(D,"").replace(z,"|").replace(F,"|").trim();return d.endsWith("|")?d.slice(0,-1):d}function G(r){const t=r.replace(/\|/g,"").length;return t<=70?1:t<=150?2:3}function A(r){return r.replace(/\|/g,"").length}const k=B("texts",()=>{const r=R(),t=$(),o=m([]),d=m(!1),g=m(null),h=w(()=>[...o.value].sort((n,i)=>(i.created_at??"").localeCompare(n.created_at??"")));async function x(){if(!r){g.value="Supabase 尚未配置";return}d.value=!0,g.value=null;try{const{data:n,error:i}=await r.from("practice_texts").select(`
          *,
          category:practice_categories (
            id,
            name,
            slug,
            level,
            parent_id
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).order("created_at",{ascending:!1});if(i)throw i;o.value=n||[]}catch(n){g.value=n.message??"無法載入文章"}finally{d.value=!1}}async function p(n,i=!1){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const c=C(n.content),f=G(c),e=A(c);if(i&&!t.isAdmin)throw new Error("只有管理員可以創建系統文章");if(!i&&!t.isTeacher)throw new Error("只有老師可以創建私有文章");const{data:a,error:s}=await r.from("practice_texts").insert({title:n.title,author:n.author??null,source:n.source??null,summary:n.summary??null,category_id:n.category_id||null,content:c,difficulty:f,word_count:e,is_system:i,created_by:i?null:t.user.id}).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(s)throw s;a&&o.value.unshift(a)}async function y(n,i){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const{data:c}=await r.from("practice_texts").select("is_system, created_by").eq("id",n).single();if(c){if(c.is_system&&!t.isAdmin)throw new Error("只有管理員可以更新系統文章");if(!c.is_system&&c.created_by!==t.user.id)throw new Error("只能更新自己創建的文章")}const f=C(i.content),e=G(f),a=A(f),{data:s,error:l}=await r.from("practice_texts").update({title:i.title,author:i.author??null,source:i.source??null,summary:i.summary??null,category_id:i.category_id||null,content:f,difficulty:e,word_count:a}).eq("id",n).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(l)throw l;s&&(o.value=o.value.map(u=>u.id===n?s:u))}async function E(n){if(!r)throw new Error("Supabase 尚未配置");if(!t.user)throw new Error("請先登入");const{data:i}=await r.from("practice_texts").select("is_system, created_by").eq("id",n).single();if(i){if(i.is_system&&!t.isAdmin)throw new Error("只有管理員可以刪除系統文章");if(!i.is_system&&i.created_by!==t.user.id)throw new Error("只能刪除自己創建的文章")}const{error:c}=await r.from("practice_texts").delete().eq("id",n);if(c)throw c;o.value=o.value.filter(f=>f.id!==n)}async function T(n){if(!r)return null;const i=n.username??"anonymous_user",c=n.display_name??"匿名學員",{data:f,error:e}=await r.from("practice_records").insert({...n,username:i,display_name:c}).select("id").single();return e?(console.error("記錄練習結果失敗:",e),null):f?.id||null}function b(){if(!o.value.length)return null;const n=Math.floor(Math.random()*o.value.length);return o.value[n]}return{texts:o,sortedTexts:h,isLoading:d,error:g,fetchTexts:x,addText:p,updateText:y,deleteText:E,recordPracticeResult:T,getRandomText:b}}),L=[{id:"grade-7",name:"七年級",slug:"grade-7",parent_id:null,level:1,type:"grade",description:"適合初階練習者，聚焦於啟蒙經典與日常應用題材。",order_index:1},{id:"grade-8",name:"八年級",slug:"grade-8",parent_id:null,level:1,type:"grade",description:"中階練習，接觸更多古文體裁。",order_index:2}],K=[{id:"text-lunyu-01",title:"論語・學而篇",author:"孔子及弟子",category_id:"grade-7",difficulty:1,summary:"子曰：「弟子入則孝...」",word_count:86,content:"子曰|弟子入則孝|出則弟|謹而信|汎愛眾|而親仁"},{id:"text-lunyu-02",title:"論語・為政篇",author:"孔子及弟子",category_id:"grade-7",difficulty:2,summary:"溫故而知新，可以為師矣。",word_count:95,content:"子曰|溫故而知新|可以為師矣|學而不思則罔|思而不學則殆"}];function q(r){return r.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-\u4e00-\u9fa5]/g,"").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||`category-${Date.now()}`}const M=B("practice-library",()=>{const r=R(),t=m({categories:[],texts:[],selectedGradeId:null,selectedTextId:null}),o=m(!1),d=m(null);function g(){t.value.categories=[...L],t.value.texts=[...K],t.value.selectedGradeId=t.value.selectedGradeId??L.find(e=>e.level===1)?.id??null}async function h(){o.value=!0,d.value=null;try{if(!r){g();return}const{data:e,error:a}=await r.from("practice_categories").select("*").order("level",{ascending:!0}).order("order_index",{ascending:!0});if(a)throw a;if(!e?.length){g();return}const{data:s,error:l}=await r.from("practice_texts").select("*").order("title",{ascending:!0});if(l)throw l;t.value.categories=e,t.value.texts=s||[],t.value.selectedGradeId=t.value.selectedGradeId??t.value.categories.find(u=>u.level===1)?.id??null}catch(e){console.error("Failed to load practice library",e),d.value=e?.message??"無法載入練習庫",g()}finally{o.value=!1}}function x(){t.value.selectedTextId=null}const p=w(()=>[...t.value.categories].sort((e,a)=>e.level===a.level?e.order_index-a.order_index:e.level-a.level)),y=w(()=>p.value.filter(e=>e.level===1)),E=w(()=>t.value.selectedGradeId?t.value.texts.filter(e=>e.category_id===t.value.selectedGradeId):[]),T=w(()=>t.value.texts.find(e=>e.id===t.value.selectedTextId)??null);function b(e){t.value.selectedGradeId!==e&&(t.value.selectedGradeId=e,x())}function n(e){t.value.selectedTextId=e}async function i(e,a){if(!r)throw new Error("Supabase 尚未配置");const s=1,l=e.type??"grade",u=e.is_system??!0,_=u?null:a;let v=q(e.name);!u&&a&&(v=`${v}-${a.slice(0,8)}`);const{data:I,error:S}=await r.from("practice_categories").insert({name:e.name,slug:v,parent_id:e.parent_id,level:s,type:l,description:e.description??null,order_index:e.order_index??0,is_system:u,created_by:_}).select("*").single();if(S)throw S;return I&&t.value.categories.push(I),I}async function c(e,a){if(!r)throw new Error("Supabase 尚未配置");const s={};a.name!==void 0&&(s.name=a.name,s.slug=q(a.name)),a.description!==void 0&&(s.description=a.description),a.order_index!==void 0&&(s.order_index=a.order_index);const{data:l,error:u}=await r.from("practice_categories").update(s).eq("id",e).select("*").single();if(u)throw u;if(l){const _=t.value.categories.findIndex(v=>v.id===e);_!==-1&&(t.value.categories[_]=l)}return l}async function f(e){if(!r)throw new Error("Supabase 尚未配置");if(t.value.categories.some(_=>_.parent_id===e))throw new Error("此分類下還有子分類，請先刪除子分類");const{count:s,error:l}=await r.from("practice_texts").select("id",{count:"exact",head:!0}).eq("category_id",e);if(l)throw l;if(s&&s>0)throw new Error(`此分類下還有 ${s} 篇文章，請先移除或重新分類`);const{error:u}=await r.from("practice_categories").delete().eq("id",e);if(u)throw u;t.value.categories=t.value.categories.filter(_=>_.id!==e),t.value.selectedGradeId===e&&(t.value.selectedGradeId=null)}return{state:t,isLoading:o,error:d,rootCategories:y,visibleTexts:E,selectedText:T,fetchLibrary:h,selectGrade:b,selectText:n,addCategory:i,updateCategory:c,deleteCategory:f}});export{M as a,k as u};
