import{d as $e,u as ze,c as h,p as Ie,r as d,w as Pe,o as qe,y as Fe,a as l,b as s,e as g,t as i,l as f,n as k,z as K,A as Le,F as v,h as V,B as de,f as Me,C as Ne,q as n,_ as Ee}from"./index-BIK0XW_c.js";import{u as Ue}from"./textsStore-iQ6Ca8kH.js";import{u as Oe}from"./practiceLibraryStore-31NHUl0D.js";import{u as De}from"./assignmentStore-S-ktbcS8.js";import{u as Ge}from"./userStatsStore-D7SRTXDD.js";import"./useSupabase-6qGv7slg.js";const Xe={class:"practice-shell"},je={class:"picker-section edamame-glass"},He={class:"picker-current"},Qe={class:"picker-info"},We={class:"picker-breadcrumb"},Je={key:0,class:"picker-meta"},Ke={key:0},Ye={key:0,class:"picker-panel"},Ze={class:"picker-search"},es={key:0,class:"picker-results"},ss={key:0,class:"picker-empty"},ts=["onClick"],as={class:"item-main"},ls={class:"item-title"},ns={class:"item-author"},os={class:"item-preview"},is={key:1,class:"picker-cascade"},rs={class:"cascade-row"},us={class:"cascade-select"},cs=["value"],ds={class:"cascade-select"},vs=["disabled"],ms={value:null,disabled:""},ps=["value"],fs={class:"picker-list"},_s={key:0,class:"picker-empty"},ks={key:1,class:"picker-empty"},hs=["onClick"],bs={class:"item-main"},ys={class:"item-title"},gs={class:"item-author"},ws={class:"item-preview"},Cs={class:"hero-actions"},Ts=["disabled"],Ss={class:"board-card edamame-glass"},xs={key:0,class:"practice-board"},As={class:"board-header"},Bs={class:"board-header-right"},Rs={key:0,class:"timer-badge"},Vs={key:0,class:"practice-line"},$s=["onClick","aria-label"],zs={key:0,class:"bean"},Is={key:1,class:"state-info"},Ps={class:"board-actions"},qs=["disabled"],Fs={key:1,class:"board-empty"},Ls={class:"results-grid"},Ms={class:"result-card edamame-glass"},Ns={class:"result-desc"},Es={key:0,class:"new-record"},Us={key:1},Os={class:"result-card edamame-glass"},Ds={class:"result-desc"},Gs={class:"result-card edamame-glass"},Xs={class:"result-desc"},js={class:"result-card edamame-glass"},Hs={class:"result-desc"},Qs={key:0,class:"score-breakdown edamame-glass"},Ws={class:"breakdown-grid"},Js={class:"breakdown-item"},Ks={class:"breakdown-value"},Ys={class:"breakdown-formula"},Zs={class:"breakdown-item"},et={class:"breakdown-value"},st={class:"breakdown-formula"},tt={class:"breakdown-item"},at={class:"breakdown-value"},lt={class:"breakdown-formula"},nt={class:"breakdown-item"},ot={class:"breakdown-value"},it={class:"breakdown-formula"},rt={key:0,class:"breakdown-item highlight"},ut={class:"breakdown-value"},ct=$e({__name:"PracticePage",setup(dt){const Y=Ie(),C=Ue(),x=Oe(),ve=De(),D=ze(),M=Ge(),G=h(()=>Y.query.assignmentId),Z=h(()=>Y.query.textId),c=d(null),$=d([]),T=d(new Set),p=d(new Set),o=d(null),R=d(0),_=d(null),X=d(!1),u=d(0),z=d(0),N=d(0),j=d(!1),H=d(!1),ee=h(()=>T.value.size),me=h(()=>p.value.size),se=h(()=>Math.max(0,ee.value-me.value)),te=h(()=>se.value>0),I=d(!1),b=d(null),A=d(null),B=d(""),pe=d(localStorage.getItem("judou_username")||"guest"),fe=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡");let P=null;const S=d(null);function ae(){S.value||(S.value=new(window.AudioContext||window.webkitAudioContext))}function Q(a){if(S.value||ae(),!S.value)return;const e=S.value,t=e.createOscillator(),r=e.createGain();t.connect(r),r.connect(e.destination),a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),r.gain.setValueAtTime(.3,e.currentTime),r.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),r.gain.setValueAtTime(.2,e.currentTime),r.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08))}function le(a=10){navigator.vibrate&&navigator.vibrate(a)}const W=h(()=>x.state.categories.filter(a=>a.level===1).sort((a,e)=>a.order_index-e.order_index)),_e=h(()=>b.value?x.state.categories.filter(a=>a.level===2&&a.parent_id===b.value).sort((a,e)=>a.order_index-e.order_index):[]),ne=h(()=>A.value?C.texts.filter(a=>a.category_id===A.value).sort((a,e)=>a.title.localeCompare(e.title)):[]),oe=h(()=>{if(!B.value.trim())return[];const a=B.value.toLowerCase();return C.texts.filter(e=>e.title.toLowerCase().includes(a)||e.author&&e.author.toLowerCase().includes(a)||e.source&&e.source.toLowerCase().includes(a)).slice(0,10)}),ke=h(()=>{if(!c.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const a=[];if(c.value.category?.name){const e=x.state.categories.find(t=>t.id===c.value?.category_id);if(e?.parent_id){const t=x.state.categories.find(r=>r.id===e.parent_id);t&&a.push(t.name)}a.push(c.value.category.name)}return a.push(c.value.title),a.join(" â€º ")});Pe(b,()=>{A.value=null});function he(a){const e=[],t=new Set;let r=0;for(const y of a)y==="|"?r>0&&t.add(r-1):y!==`
`&&y!=="\r"&&(e.push(y),r++);return{chars:e,breaks:t}}function be(){E(),R.value=0,P=window.setInterval(()=>{R.value+=1},1e3)}function E(){P&&(clearInterval(P),P=null)}function ie(a){const{chars:e,breaks:t}=he(a.content);$.value=e,T.value=t,p.value=new Set,o.value=null,_.value=null,E(),R.value=0,u.value=0,z.value=0,N.value=0,j.value=!1}function U(a){if(c.value=a,ie(a),I.value=!1,B.value="",a.category_id){const e=x.state.categories.find(t=>t.id===a.category_id);e&&(A.value=e.id,b.value=e.parent_id??null)}}function re(){const a=C.getRandomText();if(!a){_.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}U(a)}async function ye(){const a=[];if(C.texts.length||a.push(C.fetchTexts()),x.state.categories.length||a.push(x.fetchLibrary()),await Promise.all(a),Z.value&&G.value){const e=C.texts.find(t=>t.id===Z.value);if(e){U(e);return}}if(!c.value&&C.texts.length&&re(),!b.value&&W.value.length){const e=W.value[0];e&&(b.value=e.id)}}function ge(a){if(o.value?.isComplete){_.value="å·²å®Œæˆï¼å¦‚è¦é‡æ–°ç·´ç¿’è«‹é»æ“Šé‡æ–°é–‹å§‹ã€‚";return}o.value&&!o.value.isComplete&&(o.value=null);const e=new Set(p.value),t=e.has(a);if(!t&&!te.value){we(),_.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}p.value.size===0&&!P&&!j.value&&be(),t?(e.delete(a),Q("remove")):(e.add(a),Q("add"),le(10)),p.value=e,_.value=null}function we(){H.value=!0,Q("remove"),le(50),setTimeout(()=>{H.value=!1},400)}function Ce(a){if(!o.value){const e=a>0&&p.value.has(a-1),t=p.value.has(a);if(e&&t)return"translateX(0)";if(e)return"translateX(4px)";if(t)return"translateX(-4px)"}return"translateX(0)"}function Te(a){const e=[],t=p.value.has(a);if(t&&e.push("has-bean"),o.value&&t){const r=o.value.statuses.find(y=>y.index===a);r&&(r.state==="correct"||r.state==="extra")&&e.push(r.state)}return e}function Se(a){return`${a} è±†`}function ue(a){return`${Math.round(a*100)}%`}function ce(a){return a.content.replace(/\|/g,"").slice(0,30)+"..."}function xe(a,e,t){return M.calculateScore({breakCount:T.value.size,charCount:$.value.length,elapsedSeconds:a,attemptCount:e,isFirstClear:t})}async function Ae(){if(!c.value)return;if(!p.value.size){_.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}u.value++;const a=[];let e=0,t=0,r=0;for(let m=0;m<=$.value.length;m++){const w=p.value.has(m),L=T.value.has(m);w&&L?(a.push({index:m,state:"correct"}),e++):!w&&L?(a.push({index:m,state:"missed"}),t++):w&&!L?(a.push({index:m,state:"extra"}),r++):a.push({index:m,state:"pending"})}const y=T.value.size?e/T.value.size:p.value.size?0:1,q=t===0&&r===0;u.value===1&&(z.value=y,N.value=R.value,E(),j.value=!0);const J=N.value||R.value;let F=!1;q&&D.isAuthenticated&&(F=await M.checkFirstClear(c.value.id));const{score:O,breakdown:Ve}=q?xe(J,u.value,F):{score:0,breakdown:void 0};if(o.value={statuses:a,accuracy:y,elapsed:J,score:O,isComplete:q,breakdown:Ve,isFirstClear:F},q){Be();let m=u.value===1?"ğŸ‰ ä¸€æ¬¡éé—œï¼å¤ªå²å®³äº†ï¼":`âœ… å®Œæˆï¼å…±å˜—è©¦ ${u.value} æ¬¡`;F&&(m+=" ğŸŒŸ é¦–æ¬¡å®Œæˆçå‹µï¼"),_.value=m}else _.value=`é‚„æœ‰ ${t} å€‹éºæ¼ã€${r} å€‹å¤šé¤˜ï¼Œè«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤`;if(q)try{X.value=!0;const m=await C.recordPracticeResult({text_id:c.value.id,score:O,accuracy:z.value,elapsed_seconds:J,user_breaks:p.value.size,correct_breaks:T.value.size,username:pe.value,display_name:fe.value});if(D.isAuthenticated){const w=await M.recordPracticeScore({textId:c.value.id,score:O,isFirstClear:F});if(o.value&&(o.value.beansEarned=w.beansEarned,o.value.isNewRecord=w.isNewRecord),w.beansEarned>0){const L=w.isNewRecord?" (æ–°ç´€éŒ„!)":"";_.value=`${_.value} ç²å¾— ${w.beansEarned} è±†${L}`}}G.value&&D.isAuthenticated&&m&&await ve.recordCompletion(G.value,m,O,z.value*100)}catch(m){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",m)}finally{X.value=!1}}function Be(){if(S.value||ae(),!S.value)return;const a=S.value,e=a.createOscillator(),t=a.createGain();e.connect(t),t.connect(a.destination),e.frequency.setValueAtTime(400,a.currentTime),e.frequency.exponentialRampToValueAtTime(600,a.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,a.currentTime+.2),t.gain.setValueAtTime(.3,a.currentTime),t.gain.exponentialRampToValueAtTime(.01,a.currentTime+.3),e.start(a.currentTime),e.stop(a.currentTime+.3)}function Re(){c.value&&ie(c.value)}return qe(()=>{ye()}),Fe(()=>{E()}),(a,e)=>(n(),l("div",Xe,[s("section",je,[s("div",{class:"picker-header",onClick:e[0]||(e[0]=t=>I.value=!I.value)},[s("div",He,[e[4]||(e[4]=s("span",{class:"picker-icon"},"ğŸ“–",-1)),s("div",Qe,[s("span",We,i(ke.value),1),c.value?(n(),l("span",Je,[f(i(c.value.author||"ä½šå")+" ",1),c.value.source?(n(),l("span",Ke," Â· "+i(c.value.source),1)):g("",!0)])):g("",!0)])]),s("button",{class:k(["picker-toggle",{expanded:I.value}])},[...e[5]||(e[5]=[s("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),I.value?(n(),l("div",Ye,[s("div",Ze,[K(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>B.value=t),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Le,B.value]])]),B.value.trim()?(n(),l("div",es,[oe.value.length?g("",!0):(n(),l("div",ss," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+i(B.value)+"ã€çš„æ–‡ç«  ",1)),(n(!0),l(v,null,V(oe.value,t=>(n(),l("div",{key:t.id,class:"picker-item",onClick:r=>U(t)},[s("div",as,[s("span",ls,i(t.title),1),s("span",ns,i(t.author||"ä½šå"),1)]),s("span",os,i(ce(t)),1)],8,ts))),128))])):(n(),l("div",is,[s("div",rs,[s("div",us,[e[7]||(e[7]=s("label",null,"å¹´ç´š",-1)),K(s("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>b.value=t)},[e[6]||(e[6]=s("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(n(!0),l(v,null,V(W.value,t=>(n(),l("option",{key:t.id,value:t.id},i(t.name),9,cs))),128))],512),[[de,b.value]])]),s("div",ds,[e[8]||(e[8]=s("label",null,"å–®å…ƒ",-1)),K(s("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>A.value=t),disabled:!b.value},[s("option",ms,i(b.value?"é¸æ“‡å–®å…ƒ":"è«‹å…ˆé¸å¹´ç´š"),1),(n(!0),l(v,null,V(_e.value,t=>(n(),l("option",{key:t.id,value:t.id},i(t.name),9,ps))),128))],8,vs),[[de,A.value]])])]),s("div",fs,[A.value?ne.value.length?g("",!0):(n(),l("div",ks," æ­¤å–®å…ƒå°šç„¡æ–‡ç«  ")):(n(),l("div",_s," è«‹é¸æ“‡å¹´ç´šå’Œå–®å…ƒä»¥æŸ¥çœ‹æ–‡ç«  ")),(n(!0),l(v,null,V(ne.value,t=>(n(),l("div",{key:t.id,class:k(["picker-item",{active:c.value?.id===t.id}]),onClick:r=>U(t)},[s("div",bs,[s("span",ys,i(t.title),1),s("span",gs,i(t.author||"ä½šå"),1),s("span",{class:k(["item-difficulty",`diff-${t.difficulty}`])},i(t.difficulty===1?"åˆç´š":t.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),s("span",ws,i(ce(t)),1)],10,hs))),128))])]))])):g("",!0)]),s("div",Cs,[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:Re,disabled:!c.value}," é‡æ–°é–‹å§‹ ",8,Ts),s("button",{class:"edamame-btn edamame-btn-primary",onClick:re}," éš¨æ©Ÿä¸€ç¯‡ ")]),s("section",Ss,[c.value?(n(),l("div",xs,[s("div",As,[e[9]||(e[9]=s("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),s("div",Bs,[s("div",{class:k(["bean-inventory",{shake:H.value,empty:!te.value}])},[(n(!0),l(v,null,V(ee.value,t=>(n(),l("span",{key:t,class:k(["inventory-bean",{used:t>se.value}])},null,2))),128))],2),p.value.size>0||o.value?(n(),l("span",Rs,"â± "+i(R.value)+" ç§’",1)):g("",!0)])]),$.value.length?(n(),l("div",Vs,[(n(!0),l(v,null,V($.value,(t,r)=>(n(),l("span",{key:r,class:"char-unit"},[s("span",{class:"char",style:Ne({transform:Ce(r)})},i(t),5),s("button",{class:k(["bean-slot",Te(r)]),onClick:y=>ge(r),"aria-label":`åœ¨ã€Œ${t}ã€å¾Œ${p.value.has(r)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[p.value.has(r)?(n(),l("span",zs)):g("",!0),e[10]||(e[10]=s("span",{class:"bean-hint"},null,-1))],10,$s)]))),128))])):(n(),l("div",Is,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),s("div",Ps,[s("button",{class:k(["edamame-btn edamame-btn-lg",o.value?.isComplete?"edamame-btn-success":"edamame-btn-primary"]),disabled:X.value||o.value?.isComplete,onClick:Ae},[o.value?.isComplete?(n(),l(v,{key:0},[f(" âœ“ å®Œæˆï¼ ")],64)):u.value>0?(n(),l(v,{key:1},[f(" å†æ¬¡æäº¤ ("+i(u.value+1)+") ",1)],64)):(n(),l(v,{key:2},[f(" æäº¤ç­”æ¡ˆ ")],64))],10,qs)]),_.value?(n(),l("p",{key:2,class:k(["toast",{success:o.value?.isComplete}])},i(_.value),3)):g("",!0)])):(n(),l("div",Fs,[...e[11]||(e[11]=[s("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),s("section",Ls,[s("article",Ms,[e[12]||(e[12]=s("p",{class:"result-label"},"å¾—åˆ†",-1)),s("p",{class:k(["result-value",{placeholder:!o.value?.isComplete}])},i(o.value?.isComplete?Se(o.value.score):"--"),3),s("p",Ns,[o.value?.isComplete&&o.value?.beansEarned!==void 0?(n(),l(v,{key:0},[o.value.isNewRecord?(n(),l("span",Es,"ğŸ† æ–°ç´€éŒ„ï¼")):(n(),l("span",Us,"å·²æ˜¯æœ€é«˜åˆ†")),f(" +"+i(o.value.beansEarned)+" è±† ",1)],64)):o.value?.isComplete&&u.value>1?(n(),l(v,{key:1},[f(" å˜—è©¦ "+i(u.value)+" æ¬¡å¾Œå®Œæˆ ",1)],64)):(n(),l(v,{key:2},[f(" å…¨å°å¾Œé¡¯ç¤ºæœ€çµ‚å¾—åˆ† ")],64))])]),s("article",Os,[e[13]||(e[13]=s("p",{class:"result-label"},"é¦–æ¬¡æ­£ç¢ºç‡",-1)),s("p",{class:k(["result-value",{placeholder:u.value===0}])},i(u.value>0?ue(z.value):"--"),3),s("p",Ds,[u.value>0&&!o.value?.isComplete?(n(),l(v,{key:0},[f(" ç•¶å‰ï¼š"+i(ue(o.value?.accuracy||0)),1)],64)):(n(),l(v,{key:1},[f(" åæ˜ çœŸå¯¦æ°´å¹³ ")],64))])]),s("article",Gs,[e[14]||(e[14]=s("p",{class:"result-label"},"ç”¨æ™‚",-1)),s("p",{class:k(["result-value",{placeholder:u.value===0}])},i(u.value>0?`${N.value} ç§’`:"--"),3),s("p",Xs,[o.value?.isComplete&&o.value?.breakdown?(n(),l(v,{key:0},[f(" æ™‚é–“ä¿‚æ•¸ï¼šÃ—"+i(o.value.breakdown.timeFactor),1)],64)):u.value>0?(n(),l(v,{key:1},[f(" é¦–æ¬¡æäº¤æ™‚è¨˜éŒ„ ")],64)):(n(),l(v,{key:2},[f(" è¨ˆæ™‚è‡³é¦–æ¬¡æäº¤ ")],64))])]),s("article",js,[e[15]||(e[15]=s("p",{class:"result-label"},"å˜—è©¦æ¬¡æ•¸",-1)),s("p",{class:k(["result-value",{placeholder:u.value===0}])},i(u.value>0?u.value:"--"),3),s("p",Hs,[o.value?.isComplete&&o.value?.breakdown?(n(),l(v,{key:0},[f(" å˜—è©¦ä¿‚æ•¸ï¼šÃ—"+i(o.value.breakdown.attemptFactor),1)],64)):o.value?.isComplete?(n(),l(v,{key:1},[f(i(u.value===1?"ä¸€æ¬¡éé—œï¼":"å …æŒå°±æ˜¯å‹åˆ©"),1)],64)):(n(),l(v,{key:2},[f(" å¯å¤šæ¬¡å˜—è©¦ç›´åˆ°å…¨å° ")],64))])])]),o.value?.isComplete&&o.value?.breakdown?(n(),l("section",Qs,[e[22]||(e[22]=s("h3",{class:"breakdown-title"},"ğŸ“Š å¾—åˆ†æ˜ç´°",-1)),s("div",Ws,[s("div",Js,[e[16]||(e[16]=s("span",{class:"breakdown-label"},"åŸºç¤åˆ†",-1)),s("span",Ks,i(o.value.breakdown.baseScore),1),s("span",Ys,i(T.value.size)+" æ–·å¥ Ã— 2",1)]),s("div",Zs,[e[17]||(e[17]=s("span",{class:"breakdown-label"},"æ™‚é–“ä¿‚æ•¸",-1)),s("span",et,"Ã—"+i(o.value.breakdown.timeFactor),1),s("span",st,i(o.value.breakdown.avgTimePerChar)+" ç§’/å­—",1)]),s("div",tt,[e[18]||(e[18]=s("span",{class:"breakdown-label"},"å˜—è©¦ä¿‚æ•¸",-1)),s("span",at,"Ã—"+i(o.value.breakdown.attemptFactor),1),s("span",lt,"ç¬¬ "+i(u.value)+" æ¬¡",1)]),s("div",nt,[e[19]||(e[19]=s("span",{class:"breakdown-label"},"é€£çºŒå¤©æ•¸",-1)),s("span",ot,"Ã—"+i(o.value.breakdown.streakFactor),1),s("span",it,i(Me(M).profile?.streak_days||0)+" å¤©",1)]),o.value.isFirstClear?(n(),l("div",rt,[e[20]||(e[20]=s("span",{class:"breakdown-label"},"é¦–æ¬¡å®Œæˆ",-1)),s("span",ut,"Ã—"+i(o.value.breakdown.firstClearFactor),1),e[21]||(e[21]=s("span",{class:"breakdown-formula"},"ğŸŒŸ é¦–é€šçå‹µ",-1))])):g("",!0)])])):g("",!0)]))}}),ht=Ee(ct,[["__scopeId","data-v-c5d62971"]]);export{ht as default};
