import{d as Ie,u as Ne,c as h,p as Pe,r as d,w as qe,o as Fe,y as Le,a as l,b as s,e as b,t as i,g as f,n as k,z as Y,A as Me,F as v,i as z,B as ve,f as Ee,C as Ue,q as n,_ as De}from"./index-CoJWaGha.js";import{u as Oe,a as Ge}from"./practiceLibraryStore-CP3YBhGG.js";import{u as Xe}from"./assignmentStore-CGRIGm9t.js";import{u as je}from"./userStatsStore-CK1HMECE.js";import"./useSupabase-COtkS3xA.js";const He={class:"practice-shell"},Qe={class:"picker-section edamame-glass"},We={class:"picker-current"},Je={class:"picker-info"},Ke={class:"picker-breadcrumb"},Ye={key:0,class:"picker-meta"},Ze={key:0},es={key:0,class:"picker-panel"},ss={class:"picker-search"},ts={key:0,class:"picker-results"},as={key:0,class:"picker-empty"},ls=["onClick"],ns={class:"item-main"},os={class:"item-title"},is={class:"item-author"},rs={class:"item-preview"},us={key:1,class:"picker-cascade"},cs={class:"cascade-row"},ds={class:"cascade-select"},vs=["value"],ms={class:"cascade-select"},ps=["disabled"],fs={value:null,disabled:""},_s=["value"],ks={class:"picker-list"},hs={key:0,class:"picker-empty"},bs={key:1,class:"picker-empty"},ys=["onClick"],gs={class:"item-main"},ws={class:"item-title"},Cs={class:"item-author"},Ts={class:"item-preview"},Ss={class:"hero-actions"},xs=["disabled"],As={class:"board-card edamame-glass"},Bs={key:0,class:"practice-board"},Rs={class:"board-header"},Vs={class:"board-header-right"},$s={key:0,class:"timer-badge"},zs={key:0,class:"practice-line"},Is=["onClick","aria-label"],Ns={key:0,class:"bean"},Ps={key:1,class:"state-info"},qs={class:"board-actions"},Fs=["disabled"],Ls={key:1,class:"board-empty"},Ms={class:"results-grid"},Es={class:"result-card edamame-glass"},Us={class:"result-desc"},Ds={key:0,class:"new-record"},Os={key:1},Gs={class:"result-card edamame-glass"},Xs={class:"result-desc"},js={class:"result-card edamame-glass"},Hs={class:"result-desc"},Qs={class:"result-card edamame-glass"},Ws={class:"result-desc"},Js={key:0,class:"score-breakdown edamame-glass"},Ks={class:"breakdown-grid"},Ys={class:"breakdown-item"},Zs={class:"breakdown-value"},et={class:"breakdown-formula"},st={class:"breakdown-item"},tt={class:"breakdown-value"},at={class:"breakdown-formula"},lt={class:"breakdown-item"},nt={class:"breakdown-value"},ot={class:"breakdown-formula"},it={class:"breakdown-item"},rt={class:"breakdown-value"},ut={class:"breakdown-formula"},ct={key:0,class:"breakdown-item highlight"},dt={class:"breakdown-value"},vt=Ie({__name:"PracticePage",setup(mt){const Z=Pe(),w=Oe(),S=Ge(),me=Xe(),x=Ne(),E=je(),X=h(()=>Z.query.assignmentId),ee=h(()=>Z.query.textId),c=d(null),R=d([]),C=d(new Set),m=d(new Set),o=d(null),V=d(0),_=d(null),j=d(!1),u=d(0),I=d(0),U=d(0),H=d(!1),Q=d(!1),se=h(()=>C.value.size),pe=h(()=>m.value.size),te=h(()=>Math.max(0,se.value-pe.value)),ae=h(()=>te.value>0),N=d(!1),y=d(null),A=d(null),B=d(""),fe=d(localStorage.getItem("judou_username")||"guest"),_e=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡");let P=null;const T=d(null);function le(){T.value||(T.value=new(window.AudioContext||window.webkitAudioContext))}function W(a){if(T.value||le(),!T.value)return;const e=T.value,t=e.createOscillator(),r=e.createGain();t.connect(r),r.connect(e.destination),a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),r.gain.setValueAtTime(.3,e.currentTime),r.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),r.gain.setValueAtTime(.2,e.currentTime),r.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08))}function ne(a=10){navigator.vibrate&&navigator.vibrate(a)}const J=h(()=>S.state.categories.filter(a=>a.level===1).sort((a,e)=>a.order_index-e.order_index)),ke=h(()=>y.value?S.state.categories.filter(a=>a.level===2&&a.parent_id===y.value).sort((a,e)=>a.order_index-e.order_index):[]),oe=h(()=>A.value?w.texts.filter(a=>a.category_id===A.value).sort((a,e)=>a.title.localeCompare(e.title)):[]),ie=h(()=>{if(!B.value.trim())return[];const a=B.value.toLowerCase();return w.texts.filter(e=>e.title.toLowerCase().includes(a)||e.author&&e.author.toLowerCase().includes(a)||e.source&&e.source.toLowerCase().includes(a)).slice(0,10)}),he=h(()=>{if(!c.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const a=[];if(c.value.category?.name){const e=S.state.categories.find(t=>t.id===c.value?.category_id);if(e?.parent_id){const t=S.state.categories.find(r=>r.id===e.parent_id);t&&a.push(t.name)}a.push(c.value.category.name)}return a.push(c.value.title),a.join(" â€º ")});qe(y,()=>{A.value=null});function be(a){const e=[],t=new Set;let r=0;for(const g of a)g==="|"?r>0&&t.add(r-1):g!==`
`&&g!=="\r"&&(e.push(g),r++);return{chars:e,breaks:t}}function ye(){D(),V.value=0,P=window.setInterval(()=>{V.value+=1},1e3)}function D(){P&&(clearInterval(P),P=null)}function re(a){const{chars:e,breaks:t}=be(a.content);R.value=e,C.value=t,m.value=new Set,o.value=null,_.value=null,D(),V.value=0,u.value=0,I.value=0,U.value=0,H.value=!1}function O(a){if(c.value=a,re(a),N.value=!1,B.value="",a.category_id){const e=S.state.categories.find(t=>t.id===a.category_id);e&&(A.value=e.id,y.value=e.parent_id??null)}}function ue(){const a=w.getRandomText();if(!a){_.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}O(a)}async function ge(){const a=[];if(w.texts.length||a.push(w.fetchTexts()),S.state.categories.length||a.push(S.fetchLibrary()),await Promise.all(a),ee.value&&X.value){const e=w.texts.find(t=>t.id===ee.value);if(e){O(e);return}}if(!c.value&&w.texts.length&&ue(),!y.value&&J.value.length){const e=J.value[0];e&&(y.value=e.id)}}function we(a){if(o.value?.isComplete){_.value="å·²å®Œæˆï¼å¦‚è¦é‡æ–°ç·´ç¿’è«‹é»æ“Šé‡æ–°é–‹å§‹ã€‚";return}o.value&&!o.value.isComplete&&(o.value=null);const e=new Set(m.value),t=e.has(a);if(!t&&!ae.value){Ce(),_.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}m.value.size===0&&!P&&!H.value&&ye(),t?(e.delete(a),W("remove")):(e.add(a),W("add"),ne(10)),m.value=e,_.value=null}function Ce(){Q.value=!0,W("remove"),ne(50),setTimeout(()=>{Q.value=!1},400)}function Te(a){if(!o.value){const e=a>0&&m.value.has(a-1),t=m.value.has(a);if(e&&t)return"translateX(0)";if(e)return"translateX(4px)";if(t)return"translateX(-4px)"}return"translateX(0)"}function Se(a){const e=[],t=m.value.has(a);if(t&&e.push("has-bean"),o.value&&t){const r=o.value.statuses.find(g=>g.index===a);r&&(r.state==="correct"||r.state==="extra")&&e.push(r.state)}return e}function xe(a){return`${a} è±†`}function ce(a){return`${Math.round(a*100)}%`}function de(a){return a.content.replace(/\|/g,"").slice(0,30)+"..."}function Ae(a,e,t){return E.calculateScore({breakCount:C.value.size,charCount:R.value.length,elapsedSeconds:a,attemptCount:e,isFirstClear:t})}async function Be(){if(!c.value)return;if(!m.value.size){_.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}u.value++;const a=[];let e=0,t=0,r=0;for(let p=0;p<=R.value.length;p++){const L=m.value.has(p),$=C.value.has(p);L&&$?(a.push({index:p,state:"correct"}),e++):!L&&$?(a.push({index:p,state:"missed"}),t++):L&&!$?(a.push({index:p,state:"extra"}),r++):a.push({index:p,state:"pending"})}const g=C.value.size?e/C.value.size:m.value.size?0:1,q=t===0&&r===0;u.value===1&&(I.value=g,U.value=V.value,D(),H.value=!0);const K=U.value||V.value;let F=!1;q&&x.isAuthenticated&&(F=await E.checkFirstClear(c.value.id));const{score:G,breakdown:$e}=q?Ae(K,u.value,F):{score:0,breakdown:void 0};if(o.value={statuses:a,accuracy:g,elapsed:K,score:G,isComplete:q,breakdown:$e,isFirstClear:F},q){Re();let p=u.value===1?"ğŸ‰ ä¸€æ¬¡éé—œï¼å¤ªå²å®³äº†ï¼":`âœ… å®Œæˆï¼å…±å˜—è©¦ ${u.value} æ¬¡`;F&&(p+=" ğŸŒŸ é¦–æ¬¡å®Œæˆçå‹µï¼"),_.value=p}else _.value=`é‚„æœ‰ ${t} å€‹éºæ¼ã€${r} å€‹å¤šé¤˜ï¼Œè«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤`;if(q)try{j.value=!0;const p=x.isAuthenticated?x.user?.email?.split("@")[0]||"user":fe.value,L=x.isAuthenticated?x.displayName:_e.value,$=await w.recordPracticeResult({text_id:c.value.id,score:G,accuracy:I.value,elapsed_seconds:K,user_breaks:m.value.size,correct_breaks:C.value.size,username:p,display_name:L});if(x.isAuthenticated){const M=await E.recordPracticeScore({textId:c.value.id,score:G,isFirstClear:F});if(o.value&&(o.value.beansEarned=M.beansEarned,o.value.isNewRecord=M.isNewRecord),M.beansEarned>0){const ze=M.isNewRecord?" (æ–°ç´€éŒ„!)":"";_.value=`${_.value} ç²å¾— ${M.beansEarned} è±†${ze}`}}X.value&&x.isAuthenticated&&$&&await me.recordCompletion(X.value,$,G,I.value*100)}catch(p){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",p)}finally{j.value=!1}}function Re(){if(T.value||le(),!T.value)return;const a=T.value,e=a.createOscillator(),t=a.createGain();e.connect(t),t.connect(a.destination),e.frequency.setValueAtTime(400,a.currentTime),e.frequency.exponentialRampToValueAtTime(600,a.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,a.currentTime+.2),t.gain.setValueAtTime(.3,a.currentTime),t.gain.exponentialRampToValueAtTime(.01,a.currentTime+.3),e.start(a.currentTime),e.stop(a.currentTime+.3)}function Ve(){c.value&&re(c.value)}return Fe(()=>{ge()}),Le(()=>{D()}),(a,e)=>(n(),l("div",He,[s("section",Qe,[s("div",{class:"picker-header",onClick:e[0]||(e[0]=t=>N.value=!N.value)},[s("div",We,[e[4]||(e[4]=s("span",{class:"picker-icon"},"ğŸ“–",-1)),s("div",Je,[s("span",Ke,i(he.value),1),c.value?(n(),l("span",Ye,[f(i(c.value.author||"ä½šå")+" ",1),c.value.source?(n(),l("span",Ze," Â· "+i(c.value.source),1)):b("",!0)])):b("",!0)])]),s("button",{class:k(["picker-toggle",{expanded:N.value}])},[...e[5]||(e[5]=[s("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),N.value?(n(),l("div",es,[s("div",ss,[Y(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>B.value=t),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Me,B.value]])]),B.value.trim()?(n(),l("div",ts,[ie.value.length?b("",!0):(n(),l("div",as," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+i(B.value)+"ã€çš„æ–‡ç«  ",1)),(n(!0),l(v,null,z(ie.value,t=>(n(),l("div",{key:t.id,class:"picker-item",onClick:r=>O(t)},[s("div",ns,[s("span",os,i(t.title),1),s("span",is,i(t.author||"ä½šå"),1)]),s("span",rs,i(de(t)),1)],8,ls))),128))])):(n(),l("div",us,[s("div",cs,[s("div",ds,[e[7]||(e[7]=s("label",null,"å¹´ç´š",-1)),Y(s("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>y.value=t)},[e[6]||(e[6]=s("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(n(!0),l(v,null,z(J.value,t=>(n(),l("option",{key:t.id,value:t.id},i(t.name),9,vs))),128))],512),[[ve,y.value]])]),s("div",ms,[e[8]||(e[8]=s("label",null,"å–®å…ƒ",-1)),Y(s("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>A.value=t),disabled:!y.value},[s("option",fs,i(y.value?"é¸æ“‡å–®å…ƒ":"è«‹å…ˆé¸å¹´ç´š"),1),(n(!0),l(v,null,z(ke.value,t=>(n(),l("option",{key:t.id,value:t.id},i(t.name),9,_s))),128))],8,ps),[[ve,A.value]])])]),s("div",ks,[A.value?oe.value.length?b("",!0):(n(),l("div",bs," æ­¤å–®å…ƒå°šç„¡æ–‡ç«  ")):(n(),l("div",hs," è«‹é¸æ“‡å¹´ç´šå’Œå–®å…ƒä»¥æŸ¥çœ‹æ–‡ç«  ")),(n(!0),l(v,null,z(oe.value,t=>(n(),l("div",{key:t.id,class:k(["picker-item",{active:c.value?.id===t.id}]),onClick:r=>O(t)},[s("div",gs,[s("span",ws,i(t.title),1),s("span",Cs,i(t.author||"ä½šå"),1),s("span",{class:k(["item-difficulty",`diff-${t.difficulty}`])},i(t.difficulty===1?"åˆç´š":t.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),s("span",Ts,i(de(t)),1)],10,ys))),128))])]))])):b("",!0)]),s("div",Ss,[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:Ve,disabled:!c.value}," é‡æ–°é–‹å§‹ ",8,xs),s("button",{class:"edamame-btn edamame-btn-primary",onClick:ue}," éš¨æ©Ÿä¸€ç¯‡ ")]),s("section",As,[c.value?(n(),l("div",Bs,[s("div",Rs,[e[9]||(e[9]=s("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),s("div",Vs,[s("div",{class:k(["bean-inventory",{shake:Q.value,empty:!ae.value}])},[(n(!0),l(v,null,z(se.value,t=>(n(),l("span",{key:t,class:k(["inventory-bean",{used:t>te.value}])},null,2))),128))],2),m.value.size>0||o.value?(n(),l("span",$s,"â± "+i(V.value)+" ç§’",1)):b("",!0)])]),R.value.length?(n(),l("div",zs,[(n(!0),l(v,null,z(R.value,(t,r)=>(n(),l("span",{key:r,class:"char-unit"},[s("span",{class:"char",style:Ue({transform:Te(r)})},i(t),5),r<R.value.length-1?(n(),l("button",{key:0,class:k(["bean-slot",Se(r)]),onClick:g=>we(r),"aria-label":`åœ¨ã€Œ${t}ã€å¾Œ${m.value.has(r)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[m.value.has(r)?(n(),l("span",Ns)):b("",!0),e[10]||(e[10]=s("span",{class:"bean-hint"},null,-1))],10,Is)):b("",!0)]))),128))])):(n(),l("div",Ps,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),s("div",qs,[s("button",{class:k(["edamame-btn edamame-btn-lg",o.value?.isComplete?"edamame-btn-success":"edamame-btn-primary"]),disabled:j.value||o.value?.isComplete,onClick:Be},[o.value?.isComplete?(n(),l(v,{key:0},[f(" âœ“ å®Œæˆï¼ ")],64)):u.value>0?(n(),l(v,{key:1},[f(" å†æ¬¡æäº¤ ("+i(u.value+1)+") ",1)],64)):(n(),l(v,{key:2},[f(" æäº¤ç­”æ¡ˆ ")],64))],10,Fs)]),_.value?(n(),l("p",{key:2,class:k(["toast",{success:o.value?.isComplete}])},i(_.value),3)):b("",!0)])):(n(),l("div",Ls,[...e[11]||(e[11]=[s("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),s("section",Ms,[s("article",Es,[e[12]||(e[12]=s("p",{class:"result-label"},"å¾—åˆ†",-1)),s("p",{class:k(["result-value",{placeholder:!o.value?.isComplete}])},i(o.value?.isComplete?xe(o.value.score):"--"),3),s("p",Us,[o.value?.isComplete&&o.value?.beansEarned!==void 0?(n(),l(v,{key:0},[o.value.isNewRecord?(n(),l("span",Ds,"ğŸ† æ–°ç´€éŒ„ï¼")):(n(),l("span",Os,"å·²æ˜¯æœ€é«˜åˆ†")),f(" +"+i(o.value.beansEarned)+" è±† ",1)],64)):o.value?.isComplete&&u.value>1?(n(),l(v,{key:1},[f(" å˜—è©¦ "+i(u.value)+" æ¬¡å¾Œå®Œæˆ ",1)],64)):(n(),l(v,{key:2},[f(" å…¨å°å¾Œé¡¯ç¤ºæœ€çµ‚å¾—åˆ† ")],64))])]),s("article",Gs,[e[13]||(e[13]=s("p",{class:"result-label"},"é¦–æ¬¡æ­£ç¢ºç‡",-1)),s("p",{class:k(["result-value",{placeholder:u.value===0}])},i(u.value>0?ce(I.value):"--"),3),s("p",Xs,[u.value>0&&!o.value?.isComplete?(n(),l(v,{key:0},[f(" ç•¶å‰ï¼š"+i(ce(o.value?.accuracy||0)),1)],64)):(n(),l(v,{key:1},[f(" åæ˜ çœŸå¯¦æ°´å¹³ ")],64))])]),s("article",js,[e[14]||(e[14]=s("p",{class:"result-label"},"ç”¨æ™‚",-1)),s("p",{class:k(["result-value",{placeholder:u.value===0}])},i(u.value>0?`${U.value} ç§’`:"--"),3),s("p",Hs,[o.value?.isComplete&&o.value?.breakdown?(n(),l(v,{key:0},[f(" æ™‚é–“ä¿‚æ•¸ï¼šÃ—"+i(o.value.breakdown.timeFactor),1)],64)):u.value>0?(n(),l(v,{key:1},[f(" é¦–æ¬¡æäº¤æ™‚è¨˜éŒ„ ")],64)):(n(),l(v,{key:2},[f(" è¨ˆæ™‚è‡³é¦–æ¬¡æäº¤ ")],64))])]),s("article",Qs,[e[15]||(e[15]=s("p",{class:"result-label"},"å˜—è©¦æ¬¡æ•¸",-1)),s("p",{class:k(["result-value",{placeholder:u.value===0}])},i(u.value>0?u.value:"--"),3),s("p",Ws,[o.value?.isComplete&&o.value?.breakdown?(n(),l(v,{key:0},[f(" å˜—è©¦ä¿‚æ•¸ï¼šÃ—"+i(o.value.breakdown.attemptFactor),1)],64)):o.value?.isComplete?(n(),l(v,{key:1},[f(i(u.value===1?"ä¸€æ¬¡éé—œï¼":"å …æŒå°±æ˜¯å‹åˆ©"),1)],64)):(n(),l(v,{key:2},[f(" å¯å¤šæ¬¡å˜—è©¦ç›´åˆ°å…¨å° ")],64))])])]),o.value?.isComplete&&o.value?.breakdown?(n(),l("section",Js,[e[22]||(e[22]=s("h3",{class:"breakdown-title"},"ğŸ“Š å¾—åˆ†æ˜ç´°",-1)),s("div",Ks,[s("div",Ys,[e[16]||(e[16]=s("span",{class:"breakdown-label"},"åŸºç¤åˆ†",-1)),s("span",Zs,i(o.value.breakdown.baseScore),1),s("span",et,i(C.value.size)+" æ–·å¥ Ã— 2",1)]),s("div",st,[e[17]||(e[17]=s("span",{class:"breakdown-label"},"æ™‚é–“ä¿‚æ•¸",-1)),s("span",tt,"Ã—"+i(o.value.breakdown.timeFactor),1),s("span",at,i(o.value.breakdown.avgTimePerChar)+" ç§’/å­—",1)]),s("div",lt,[e[18]||(e[18]=s("span",{class:"breakdown-label"},"å˜—è©¦ä¿‚æ•¸",-1)),s("span",nt,"Ã—"+i(o.value.breakdown.attemptFactor),1),s("span",ot,"ç¬¬ "+i(u.value)+" æ¬¡",1)]),s("div",it,[e[19]||(e[19]=s("span",{class:"breakdown-label"},"é€£çºŒå¤©æ•¸",-1)),s("span",rt,"Ã—"+i(o.value.breakdown.streakFactor),1),s("span",ut,i(Ee(E).profile?.streak_days||0)+" å¤©",1)]),o.value.isFirstClear?(n(),l("div",ct,[e[20]||(e[20]=s("span",{class:"breakdown-label"},"é¦–æ¬¡å®Œæˆ",-1)),s("span",dt,"Ã—"+i(o.value.breakdown.firstClearFactor),1),e[21]||(e[21]=s("span",{class:"breakdown-formula"},"ğŸŒŸ é¦–é€šçå‹µ",-1))])):b("",!0)])])):b("",!0)]))}}),bt=De(vt,[["__scopeId","data-v-2301a0da"]]);export{bt as default};
