import{B as L,r as v,c as l}from"./index-YghVDSQt.js";import{u as A}from"./useSupabase-WUKx7dou.js";const x=[{id:"grade-7",name:"七年級",slug:"grade-7",parent_id:null,level:1,type:"grade",description:"適合初階練習者，聚焦於啟蒙經典與日常應用題材。",order_index:1},{id:"grade-8",name:"八年級",slug:"grade-8",parent_id:null,level:1,type:"grade",description:"中階練習，接觸更多古文體裁。",order_index:2}],$=[{id:"text-lunyu-01",title:"論語・學而篇",author:"孔子及弟子",category_id:"grade-7",difficulty:1,summary:"子曰：「弟子入則孝...」",word_count:86,content:"子曰|弟子入則孝|出則弟|謹而信|汎愛眾|而親仁"},{id:"text-lunyu-02",title:"論語・為政篇",author:"孔子及弟子",category_id:"grade-7",difficulty:2,summary:"溫故而知新，可以為師矣。",word_count:95,content:"子曰|溫故而知新|可以為師矣|學而不思則罔|思而不學則殆"}];function _(i){return i.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-\u4e00-\u9fa5]/g,"").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||`category-${Date.now()}`}const q=L("practice-library",()=>{const i=A(),r=v({categories:[],texts:[],selectedGradeId:null,selectedTextId:null}),d=v(!1),u=v(null);function f(){r.value.categories=[...x],r.value.texts=[...$],r.value.selectedGradeId=r.value.selectedGradeId??x.find(e=>e.level===1)?.id??null}async function m(){d.value=!0,u.value=null;try{if(!i){f();return}const{data:e,error:t}=await i.from("practice_categories").select("*").order("level",{ascending:!0}).order("order_index",{ascending:!0});if(t)throw t;if(!e?.length){f();return}const{data:a,error:n}=await i.from("practice_texts").select("*").order("title",{ascending:!0});if(n)throw n;r.value.categories=e,r.value.texts=a||[],r.value.selectedGradeId=r.value.selectedGradeId??r.value.categories.find(o=>o.level===1)?.id??null}catch(e){console.error("Failed to load practice library",e),u.value=e?.message??"無法載入練習庫",f()}finally{d.value=!1}}function w(){r.value.selectedTextId=null}const y=l(()=>[...r.value.categories].sort((e,t)=>e.level===t.level?e.order_index-t.order_index:e.level-t.level)),h=l(()=>y.value.filter(e=>e.level===1)),I=l(()=>r.value.selectedGradeId?r.value.texts.filter(e=>e.category_id===r.value.selectedGradeId):[]),E=l(()=>r.value.texts.find(e=>e.id===r.value.selectedTextId)??null);function G(e){r.value.selectedGradeId!==e&&(r.value.selectedGradeId=e,w())}function C(e){r.value.selectedTextId=e}async function b(e,t){if(!i)throw new Error("Supabase 尚未配置");const a=1,n=e.type??"grade",o=e.is_system??!0,s=o?null:t;let c=_(e.name);!o&&t&&(c=`${c}-${t.slice(0,8)}`);const{data:g,error:p}=await i.from("practice_categories").insert({name:e.name,slug:c,parent_id:e.parent_id,level:a,type:n,description:e.description??null,order_index:e.order_index??0,is_system:o,created_by:s}).select("*").single();if(p)throw p;return g&&r.value.categories.push(g),g}async function S(e,t){if(!i)throw new Error("Supabase 尚未配置");const a={};t.name!==void 0&&(a.name=t.name,a.slug=_(t.name)),t.description!==void 0&&(a.description=t.description),t.order_index!==void 0&&(a.order_index=t.order_index);const{data:n,error:o}=await i.from("practice_categories").update(a).eq("id",e).select("*").single();if(o)throw o;if(n){const s=r.value.categories.findIndex(c=>c.id===e);s!==-1&&(r.value.categories[s]=n)}return n}async function T(e){if(!i)throw new Error("Supabase 尚未配置");if(r.value.categories.some(s=>s.parent_id===e))throw new Error("此分類下還有子分類，請先刪除子分類");const{count:a,error:n}=await i.from("practice_texts").select("id",{count:"exact",head:!0}).eq("category_id",e);if(n)throw n;if(a&&a>0)throw new Error(`此分類下還有 ${a} 篇文章，請先移除或重新分類`);const{error:o}=await i.from("practice_categories").delete().eq("id",e);if(o)throw o;r.value.categories=r.value.categories.filter(s=>s.id!==e),r.value.selectedGradeId===e&&(r.value.selectedGradeId=null)}return{state:r,isLoading:d,error:u,rootCategories:h,visibleTexts:I,selectedText:E,fetchLibrary:m,selectGrade:G,selectText:C,addCategory:b,updateCategory:S,deleteCategory:T}});export{q as u};
