import{d as re,u as ce,c as k,p as ve,r as y,D as X,o as me,a as n,b as e,k as H,t as o,f as F,g as j,F as w,i as B,e as _,s as q,l as R,T as J,E as K,n as U,G as h,q as a,z as $,A as T,_ as pe}from"./index-C9sOeXv-.js";import{u as fe}from"./textsStore-CuUtf_z9.js";import{u as be}from"./practiceLibraryStore-DrqknHZf.js";import"./useSupabase-CD3gvouO.js";const ye={class:"admin-shell"},_e={class:"admin-header"},he={class:"edamame-text-level-detail"},ke={class:"edamame-heading-gradient"},ge={class:"header-actions"},Ce=["disabled"],xe=["disabled"],we={class:"admin-layout"},$e={class:"category-sidebar edamame-glass"},Te={class:"sidebar-header"},Se={key:0,class:"sidebar-loading"},Me={key:1,class:"sidebar-empty"},Ve={key:2,class:"category-tree"},Le=["onClick"],De=["onClick"],Fe={class:"tree-label"},Be={class:"tree-count"},Ue={class:"tree-actions"},Ae=["onClick"],Ee=["onClick"],Ge=["onClick"],Ie={key:0,class:"tree-children"},Ne=["onClick"],Oe={class:"tree-label"},ze={class:"tree-count"},Pe={class:"tree-actions"},He=["onClick"],je=["onClick"],qe=["onClick"],Re={class:"content-panel edamame-glass"},Je={key:0,class:"content-empty"},Ke={class:"content-breadcrumb"},Qe=["onClick"],We={key:0,class:"breadcrumb-sep"},Xe={class:"category-info"},Ye={key:0,class:"category-desc"},Ze={class:"category-meta"},et={key:0,class:"module-grid"},tt=["onClick"],lt={class:"module-desc"},st={class:"module-count"},at={key:1,class:"text-list"},nt={key:0,class:"text-empty"},ot={key:1},it={class:"text-title"},dt={key:0,class:"text-type-badge system"},ut={key:1,class:"text-type-badge private"},rt={class:"text-summary"},ct={class:"actions"},vt=["onClick"],mt=["onClick"],pt={class:"modal-card edamame-glass"},ft={class:"modal-body"},bt={class:"form-context"},yt={class:"form-row"},_t={class:"preview-panel"},ht=["innerHTML"],kt={key:0,class:"feedback"},gt=["disabled"],Ct={class:"modal-card edamame-glass small-modal"},xt={class:"modal-body"},wt=["placeholder"],$t={key:0,class:"feedback"},Tt=["disabled"],St={class:"modal-card edamame-glass small-modal"},Mt={key:0,class:"feedback"},Vt={class:"confirm-actions"},Lt=["disabled"],Dt=re({__name:"AdminTextsPage",setup(Ft){const Y=ve(),p=fe(),v=be(),Z=ce(),A=k(()=>Y.meta.mode==="admin"),ee=k(()=>A.value?"系統文庫":"自訂練習"),te=k(()=>A.value?"管理系統內建的練習文章":"管理我的自訂練習文章"),f=y(null),g=y(new Set),C=y(!1),x=y(!1),S=y(!1),m=y(!1),M=y(null),V=y(null),b=y(null),r=y(null),i=X({title:"",author:"",source:"",summary:"",content:""}),d=X({name:"",description:"",parentId:null,type:"grade"}),E=k(()=>v.state.categories.filter(l=>l.level===1).sort((l,t)=>l.order_index-t.order_index)),c=k(()=>v.state.categories.find(l=>l.id===f.value)??null),G=k(()=>{if(!c.value)return[];const l=[];let t=c.value;for(;t;)l.unshift(t),t=v.state.categories.find(s=>s.id===t?.parent_id);return l}),N=k(()=>{if(!f.value)return[];let l=p.texts.filter(t=>t.category_id===f.value);return A.value?l=l.filter(t=>t.is_system===!0):l=l.filter(t=>t.is_system===!1&&t.created_by===Z.user?.id),l.sort((t,s)=>(s.created_at??"").localeCompare(t.created_at??""))}),le=k(()=>{if(!i.content)return"";let l=i.content.replace(/[「」『』"""'']/g,"");return l=l.replace(/[。！？；，：、]/g,"|"),l=l.replace(/\|{2,}/g,"|"),l=l.replace(/^\|+|\|+$/g,""),l.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function L(l){return v.state.categories.filter(t=>t.level===2&&t.parent_id===l).sort((t,s)=>t.order_index-s.order_index)}function Q(l){return p.texts.filter(t=>t.category_id===l).length}function se(l){g.value.has(l)?g.value.delete(l):g.value.add(l)}function I(l){f.value=l;const t=v.state.categories.find(s=>s.id===l);t?.parent_id&&g.value.add(t.parent_id)}function O(){M.value=null,i.title="",i.author="",i.source="",i.summary="",i.content="",r.value=null,C.value=!0}function ae(l){M.value=l.id,i.title=l.title,i.author=l.author??"",i.source=l.source??"",i.summary=l.summary??"",i.content=l.content,r.value=null,C.value=!0}async function ne(){if(!i.title||!i.content){r.value="標題與內容為必填";return}if(!f.value){r.value="請先選擇一個分類";return}const l=c.value;if(!l||l.level!==2){r.value="請選擇一個單元（而非年級）來新增文章";return}try{m.value=!0;const t={title:i.title,author:i.author||null,source:i.source||null,summary:i.summary||null,category_id:f.value,content:i.content};M.value?await p.updateText(M.value,t):await p.addText(t,A.value),await p.fetchTexts(),C.value=!1}catch(t){r.value=t?.message??"儲存失敗"}finally{m.value=!1}}function D(l,t){V.value=null,d.name="",d.description="",d.parentId=l,d.type=t,r.value=null,x.value=!0}function W(l){V.value=l,d.name=l.name,d.description=l.description??"",d.parentId=l.parent_id,d.type=l.level===1?"grade":"module",r.value=null,x.value=!0}async function oe(){if(!d.name.trim()){r.value="名稱不可為空";return}try{m.value=!0,V.value?await v.updateCategory(V.value.id,{name:d.name.trim(),description:d.description.trim()||void 0}):await v.addCategory({name:d.name.trim(),parent_id:d.parentId,type:d.type,description:d.description.trim()||void 0}),x.value=!1}catch(l){r.value=l?.message??"儲存失敗"}finally{m.value=!1}}function z(l,t){b.value={type:l,item:t},r.value=null,S.value=!0}async function ie(){if(b.value)try{m.value=!0,b.value.type==="text"?(await p.deleteText(b.value.item.id),await p.fetchTexts()):(await v.deleteCategory(b.value.item.id),f.value===b.value.item.id&&(f.value=null)),S.value=!1,b.value=null}catch(l){r.value=l?.message??"刪除失敗"}finally{m.value=!1}}function de(l){return l?l===1?"初級":l===2?"中級":"高級":"未標註"}function ue(l){return l?new Date(l).toLocaleDateString():"--"}return me(async()=>{if(v.state.categories.length||await v.fetchLibrary(),p.texts.length||await p.fetchTexts(),E.value.length>0){const l=E.value[0];if(l){g.value.add(l.id);const t=L(l.id)[0];t&&(f.value=t.id)}}}),(l,t)=>(a(),n("div",ye,[e("header",_e,[e("div",null,[e("p",he,o(te.value),1),e("h1",ke,o(ee.value),1)]),e("div",ge,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[0]||(t[0]=s=>{F(v).fetchLibrary(),F(p).fetchTexts()}),disabled:F(v).isLoading||F(p).isLoading}," 重新整理 ",8,Ce),e("button",{class:"edamame-btn edamame-btn-primary",onClick:O,disabled:!c.value||c.value.level!==2}," 新增練習 ",8,xe)])]),e("div",we,[e("aside",$e,[e("div",Te,[t[19]||(t[19]=e("span",{class:"sidebar-title"},"分類導航",-1)),e("button",{class:"icon-btn",onClick:t[1]||(t[1]=s=>D(null,"grade")),title:"新增年級"},[...t[18]||(t[18]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M12 5v14M5 12h14"})],-1)])])]),F(v).isLoading?(a(),n("div",Se,"載入中⋯")):E.value.length?(a(),n("nav",Ve,[(a(!0),n(w,null,B(E.value,s=>(a(),n("div",{key:s.id,class:"tree-node"},[e("div",{class:U(["tree-item grade-item",{selected:f.value===s.id}]),onClick:u=>I(s.id)},[e("button",{class:"expand-btn",onClick:h(u=>se(s.id),["stop"])},[(a(),n("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",class:U({expanded:g.value.has(s.id)})},[...t[21]||(t[21]=[e("path",{d:"M8 5l8 7-8 7V5z"},null,-1)])],2))],8,De),e("span",Fe,o(s.name),1),e("span",Be,o(L(s.id).length),1),e("div",Ue,[e("button",{class:"action-btn",onClick:h(u=>D(s.id,"module"),["stop"]),title:"新增單元"},"+",8,Ae),e("button",{class:"action-btn",onClick:h(u=>W(s),["stop"]),title:"編輯"},"✎",8,Ee),e("button",{class:"action-btn danger",onClick:h(u=>z("category",s),["stop"]),title:"刪除"},"×",8,Ge)])],10,Le),g.value.has(s.id)?(a(),n("div",Ie,[(a(!0),n(w,null,B(L(s.id),u=>(a(),n("div",{key:u.id,class:U(["tree-item module-item",{selected:f.value===u.id}]),onClick:P=>I(u.id)},[e("span",Oe,o(u.name),1),e("span",ze,o(Q(u.id)),1),e("div",Pe,[e("button",{class:"action-btn",onClick:h(P=>W(u),["stop"]),title:"編輯"},"✎",8,He),e("button",{class:"action-btn danger",onClick:h(P=>z("category",u),["stop"]),title:"刪除"},"×",8,je)])],10,Ne))),128)),e("button",{class:"add-module-btn",onClick:u=>D(s.id,"module")}," + 新增單元 ",8,qe)])):_("",!0)]))),128))])):(a(),n("div",Me,[t[20]||(t[20]=j(" 尚無分類 ",-1)),e("button",{class:"link-btn",onClick:t[2]||(t[2]=s=>D(null,"grade"))},"建立第一個年級")]))]),e("main",Re,[c.value?(a(),n(w,{key:1},[e("div",Ke,[(a(!0),n(w,null,B(G.value,(s,u)=>(a(),n("span",{key:s.id,class:U(["breadcrumb-item",{active:u===G.value.length-1}]),onClick:P=>I(s.id)},[j(o(s.name)+" ",1),u<G.value.length-1?(a(),n("span",We,"›")):_("",!0)],10,Qe))),128))]),e("div",Xe,[e("h2",null,o(c.value.name),1),c.value.description?(a(),n("p",Ye,o(c.value.description),1)):_("",!0),e("p",Ze,o(c.value.level===1?"年級":"單元")+" · "+o(c.value.level===1?`${L(c.value.id).length} 個單元`:`${N.value.length} 篇文章`),1)]),c.value.level===1?(a(),n("div",et,[(a(!0),n(w,null,B(L(c.value.id),s=>(a(),n("div",{key:s.id,class:"module-card",onClick:u=>I(s.id)},[e("h3",null,o(s.name),1),e("p",lt,o(s.description||"暫無描述"),1),e("p",st,o(Q(s.id))+" 篇文章",1)],8,tt))),128)),e("button",{class:"module-card add-card",onClick:t[3]||(t[3]=s=>D(c.value.id,"module"))},[...t[23]||(t[23]=[e("span",{class:"add-icon"},"+",-1),e("span",null,"新增單元",-1)])])])):(a(),n("div",at,[N.value.length?(a(),n("table",ot,[t[25]||(t[25]=e("thead",null,[e("tr",null,[e("th",null,"標題"),e("th",null,"作者"),e("th",null,"難度"),e("th",null,"建立日期"),e("th",{style:{width:"120px"}},"操作")])],-1)),e("tbody",null,[(a(!0),n(w,null,B(N.value,s=>(a(),n("tr",{key:s.id},[e("td",null,[e("p",it,[j(o(s.title)+" ",1),s.is_system?(a(),n("span",dt,"系統")):(a(),n("span",ut,"私有"))]),e("p",rt,o(s.summary||s.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),e("td",null,o(s.author||"佚名"),1),e("td",null,[e("span",{class:U(["difficulty-badge",`diff-${s.difficulty}`])},o(de(s.difficulty)),3)]),e("td",null,o(ue(s.created_at)),1),e("td",ct,[e("button",{class:"ghost-btn",onClick:u=>ae(s)},"編輯",8,vt),e("button",{class:"ghost-btn danger",onClick:u=>z("text",s)},"刪除",8,mt)])]))),128))])])):(a(),n("div",nt,[t[24]||(t[24]=e("p",null,"此單元尚無文章",-1)),e("button",{class:"edamame-btn edamame-btn-primary",onClick:O},"新增第一篇文章")])),e("button",{class:"add-text-btn",onClick:O}," + 在「"+o(c.value.name)+"」新增文章 ",1)]))],64)):(a(),n("div",Je,[...t[22]||(t[22]=[e("p",null,"請從左側選擇一個分類",-1)])]))])]),(a(),H(K,{to:"body"},[q(J,{name:"fade"},{default:R(()=>[C.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:t[10]||(t[10]=h(s=>C.value=!1,["self"]))},[e("div",pt,[e("header",null,[e("h3",null,o(M.value?"編輯文章":"新增文章"),1),e("button",{class:"close-btn",onClick:t[4]||(t[4]=s=>C.value=!1)},"×")]),e("div",ft,[e("p",bt,"將新增至："+o(G.value.map(s=>s.name).join(" › ")),1),e("label",null,[t[26]||(t[26]=e("span",null,"標題",-1)),$(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>i.title=s),type:"text",placeholder:"請輸入標題"},null,512),[[T,i.title]])]),e("div",yt,[e("label",null,[t[27]||(t[27]=e("span",null,"作者",-1)),$(e("input",{"onUpdate:modelValue":t[6]||(t[6]=s=>i.author=s),type:"text",placeholder:"例如：孔子"},null,512),[[T,i.author]])]),e("label",null,[t[28]||(t[28]=e("span",null,"來源",-1)),$(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>i.source=s),type:"text",placeholder:"例如：論語"},null,512),[[T,i.source]])])]),e("label",null,[t[29]||(t[29]=e("span",null,"內容（標點將自動轉為斷句符號）",-1)),$(e("textarea",{"onUpdate:modelValue":t[8]||(t[8]=s=>i.content=s),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[T,i.content]])]),e("div",_t,[t[30]||(t[30]=e("p",null,"預覽",-1)),e("div",{class:"preview-content",innerHTML:le.value||"尚無內容"},null,8,ht)]),r.value?(a(),n("p",kt,o(r.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[9]||(t[9]=s=>C.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:m.value,onClick:ne},o(m.value?"儲存中...":"儲存"),9,gt)])])])):_("",!0)]),_:1})])),(a(),H(K,{to:"body"},[q(J,{name:"fade"},{default:R(()=>[x.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:t[15]||(t[15]=h(s=>x.value=!1,["self"]))},[e("div",Ct,[e("header",null,[e("h3",null,o(V.value?"編輯分類":d.type==="grade"?"新增年級":"新增單元"),1),e("button",{class:"close-btn",onClick:t[11]||(t[11]=s=>x.value=!1)},"×")]),e("div",xt,[e("label",null,[t[31]||(t[31]=e("span",null,"名稱",-1)),$(e("input",{"onUpdate:modelValue":t[12]||(t[12]=s=>d.name=s),type:"text",placeholder:d.type==="grade"?"例如：七年級":"例如：論語讀本"},null,8,wt),[[T,d.name]])]),e("label",null,[t[32]||(t[32]=e("span",null,"描述（選填）",-1)),$(e("textarea",{"onUpdate:modelValue":t[13]||(t[13]=s=>d.description=s),rows:"2",placeholder:"簡述此分類的內容範圍"},null,512),[[T,d.description]])]),r.value?(a(),n("p",$t,o(r.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[14]||(t[14]=s=>x.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:m.value,onClick:oe},o(m.value?"儲存中...":"儲存"),9,Tt)])])])):_("",!0)]),_:1})])),(a(),H(K,{to:"body"},[q(J,{name:"fade"},{default:R(()=>[S.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:t[17]||(t[17]=h(s=>S.value=!1,["self"]))},[e("div",St,[t[33]||(t[33]=e("h3",null,"確定刪除？",-1)),e("p",null,"「"+o(b.value?.item?"title"in b.value.item?b.value.item.title:b.value.item.name:"")+"」刪除後將無法復原。",1),r.value?(a(),n("p",Mt,o(r.value),1)):_("",!0),e("div",Vt,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[16]||(t[16]=s=>S.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-danger",disabled:m.value,onClick:ie},o(m.value?"刪除中...":"刪除"),9,Lt)])])])):_("",!0)]),_:1})]))]))}}),Gt=pe(Dt,[["__scopeId","data-v-298d03fe"]]);export{Gt as default};
