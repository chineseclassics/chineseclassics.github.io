import{v as L,r as m,c as o}from"./index-DtAOyvaz.js";import{u as A}from"./useSupabase-BKFfI1gC.js";const v=[{id:"grade-7",name:"七年級",slug:"grade-7",parent_id:null,level:1,type:"grade",description:"適合初階練習者，聚焦於啟蒙經典與日常應用題材。",order_index:1},{id:"grade-7-module-lunyu",name:"論語讀本",slug:"grade-7-module-lunyu",parent_id:"grade-7",level:2,type:"module",description:"以語錄題材培養句型感與節奏感。",order_index:1},{id:"grade-7-theme-renyi",name:"仁義篇",slug:"grade-7-theme-renyi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"圍繞「仁」與「義」的章句，適合練習短句斷讀。",order_index:1},{id:"grade-7-theme-xuexi",name:"學習篇",slug:"grade-7-theme-xuexi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"關於求學與修身的篇章，句式多變。",order_index:2},{id:"anthology-guwenguan-zhi",name:"古文觀止",slug:"anthology-guwenguan-zhi",parent_id:null,level:1,type:"grade",description:"以主題式選編進行高階訓練。",order_index:2},{id:"anthology-guwenguan-zhi-warring",name:"戰國策",slug:"anthology-guwenguan-zhi-warring",parent_id:"anthology-guwenguan-zhi",level:2,type:"module",description:"戰國時期縱橫家精彩篇章，節奏快速。",order_index:1},{id:"anthology-guwenguan-zhi-warring-theme",name:"遊說名篇",slug:"anthology-guwenguan-zhi-warring-theme",parent_id:"anthology-guwenguan-zhi-warring",level:3,type:"theme",description:"以遊說篇章作為高階斷句挑戰。",order_index:1}],F=[{id:"text-renyi-01",title:"論語・學而篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:1,summary:"子曰：「弟子入則孝...」",word_count:86,content:"子曰|弟子入則孝||出則弟|信而好|犯而不|怨..."},{id:"text-renyi-02",title:"論語・里仁篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:2,summary:"里仁為美，擇其善者而從之。",word_count:120,content:"子曰|里仁為美|擇不處仁|焉得知||仁者安仁|知者利仁"},{id:"text-xuexi-01",title:"論語・為政篇",author:"孔子及弟子",category_id:"grade-7-theme-xuexi",difficulty:2,summary:"溫故而知新，可以為師矣。",word_count:95,content:"子曰|溫故而知新|可以為師矣|學而不思則罔|思而不學則殆"},{id:"text-warring-01",title:"蘇秦說齊王",author:"蘇秦",category_id:"anthology-guwenguan-zhi-warring-theme",difficulty:3,summary:"以合縱策略說服齊王，語勢跌宕。",word_count:260,content:"蘇秦曰|大王處東海之濱|南有江淮之饒|北有燕代之利|..."}];function h(l){return l.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-\u4e00-\u9fa5]/g,"").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||`category-${Date.now()}`}const $=L("practice-library",()=>{const l=A(),t=m({categories:[],texts:[],selectedGradeId:null,selectedModuleId:null,selectedThemeId:null,selectedTextId:null}),u=m(!1),c=m(null);function s(){t.value.categories=[...v],t.value.texts=[...F],t.value.selectedGradeId=t.value.selectedGradeId??v.find(e=>e.level===1)?.id??null}async function p(){u.value=!0,c.value=null;try{if(!l){s();return}const{data:e,error:r}=await l.from("practice_categories").select("*").order("level",{ascending:!0}).order("order_index",{ascending:!0});if(r)throw r;if(!e?.length){s();return}const{data:a,error:i}=await l.from("practice_texts").select("*").order("title",{ascending:!0});if(i)throw i;t.value.categories=e,t.value.texts=a||[],t.value.selectedGradeId=t.value.selectedGradeId??t.value.categories.find(n=>n.level===1)?.id??null}catch(e){console.error("Failed to load practice library",e),c.value=e?.message??"無法載入練習庫",s()}finally{u.value=!1}}function g(e){e==="grade"&&(t.value.selectedModuleId=null,t.value.selectedThemeId=null),e!=="theme"&&(t.value.selectedTextId=null),e==="module"&&(t.value.selectedThemeId=null)}const w=o(()=>[...t.value.categories].sort((e,r)=>e.level===r.level?e.order_index-r.order_index:e.level-r.level)),x=o(()=>w.value.filter(e=>e.level===1)),_=o(()=>t.value.categories.filter(e=>e.parent_id===t.value.selectedGradeId)),y=o(()=>t.value.categories.filter(e=>e.parent_id===t.value.selectedModuleId)),I=o(()=>{const e=t.value.selectedThemeId??t.value.selectedModuleId??t.value.selectedGradeId;return e?t.value.texts.filter(r=>r.category_id===e):[]}),T=o(()=>t.value.texts.find(e=>e.id===t.value.selectedTextId)??null);function E(e){t.value.selectedGradeId!==e&&(t.value.selectedGradeId=e,g("grade"))}function G(e){t.value.selectedModuleId!==e&&(t.value.selectedModuleId=e,g("module"))}function C(e){t.value.selectedThemeId!==e&&(t.value.selectedThemeId=e,g("theme"))}function z(e){t.value.selectedTextId=e}async function b(e){if(!l)throw new Error("Supabase 尚未配置");const r=e.parent_id?t.value.categories.find(f=>f.id===e.parent_id):null;if(e.type!=="grade"&&!r)throw new Error("請選擇上層分類");if(r&&r.level>=3)throw new Error("目前僅支援三級分類");const a=r?r.level+1:1,i=e.type??(r?r.level===1?"module":"theme":"grade"),{data:n,error:d}=await l.from("practice_categories").insert({name:e.name,slug:h(e.name),parent_id:e.parent_id,level:a,type:i,description:e.description??null,order_index:e.order_index??0}).select("*").single();if(d)throw d;return n&&t.value.categories.push(n),n}async function M(e,r){if(!l)throw new Error("Supabase 尚未配置");const a={};r.name!==void 0&&(a.name=r.name,a.slug=h(r.name)),r.description!==void 0&&(a.description=r.description),r.order_index!==void 0&&(a.order_index=r.order_index);const{data:i,error:n}=await l.from("practice_categories").update(a).eq("id",e).select("*").single();if(n)throw n;if(i){const d=t.value.categories.findIndex(f=>f.id===e);d!==-1&&(t.value.categories[d]=i)}return i}async function S(e){if(!l)throw new Error("Supabase 尚未配置");if(t.value.categories.some(d=>d.parent_id===e))throw new Error("此分類下還有子分類，請先刪除子分類");const{count:a,error:i}=await l.from("practice_texts").select("id",{count:"exact",head:!0}).eq("category_id",e);if(i)throw i;if(a&&a>0)throw new Error(`此分類下還有 ${a} 篇文章，請先移除或重新分類`);const{error:n}=await l.from("practice_categories").delete().eq("id",e);if(n)throw n;t.value.categories=t.value.categories.filter(d=>d.id!==e),t.value.selectedGradeId===e&&(t.value.selectedGradeId=null),t.value.selectedModuleId===e&&(t.value.selectedModuleId=null),t.value.selectedThemeId===e&&(t.value.selectedThemeId=null)}return{state:t,isLoading:u,error:c,rootCategories:x,modules:_,themes:y,visibleTexts:I,selectedText:T,fetchLibrary:p,selectGrade:E,selectModule:G,selectTheme:C,selectText:z,addCategory:b,updateCategory:M,deleteCategory:S}});export{$ as u};
