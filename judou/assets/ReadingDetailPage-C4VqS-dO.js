import{d as oe,u as le,c as M,x as ie,r as _,f as ce,O as ue,P as de,w as he,a as d,g as a,h as x,m as F,t as f,i as v,b as B,q as fe,F as z,j as L,s as ve,n as pe,M as ge,l as me,o as i,_ as ke}from"./index-BJX985Xd.js";import{u as _e}from"./readingStore-kBpWUqn4.js";import{a as O,S as xe,V as ye,c as be,b as Te}from"./useClassicalTTS-BnI8pqaL.js";import"./useSupabase-DveYaXqn.js";import"./createLucideIcon-Cgpw1nVQ.js";const Ce={class:"reading-detail-page"},Se={class:"reading-header edamame-glass"},we={class:"header-title"},Be={class:"title-meta"},Pe={key:0,class:"author"},Ae={key:1,class:"source-tag"},Re={class:"header-actions"},Me={class:"control-bar edamame-glass"},ze=["aria-pressed"],Ne={class:"toggle-switch"},De={key:0,class:"reading-content edamame-glass"},Ee={class:"reading-line"},Ie=["onMouseenter"],Ve=["onClick","disabled"],Fe={key:0,class:"verification-result"},Le={class:"result-stats"},Oe={class:"stat correct"},Ue={class:"stat missed"},qe={class:"stat extra"},Xe={class:"stat accuracy"},$e={class:"content-actions"},je=["disabled"],He={key:1,class:"loading-state edamame-glass"},Ye=oe({__name:"ReadingDetailPage",setup(Ge){const U=ie(),q=me(),o=_e(),N=le(),P=M(()=>U.params.id),h=_(!0),y=_(new Set),l=_(null),b=_(null),m=_(!1),C=M(()=>{if(!o.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const e=o.currentText.content.split("||"),s=[],u=[],c=new Set;let n=0;for(const p of e){const r=[],g=new Set,k=n;for(const T of p)T==="|"?n>0&&(c.add(n-1),g.add(r.length-1)):T!==`
`&&T!=="\r"&&(u.push(T),r.push(T),n++);r.length>0&&s.push({chars:r,breaks:g,startIdx:k,endIdx:n-1})}return{paragraphs:s,allChars:u,allBreaks:c}}),D=M(()=>C.value.paragraphs),X=_(0);function S(t){return o.currentText?.annotations&&o.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const A=_(null);function $(t){return A.value?S(t)?.id===A.value:!1}function j(t){return S(t)?.start_index===t}function H(t){const e=S(t);return e?e.end_index-1===t:!1}function Y(t,e){const s=S(t);s&&(A.value=s.id,Z(s,e))}function G(){A.value=null,ee()}function J(t){if(h.value)return;const e=new Set(y.value);e.has(t)?e.delete(t):e.add(t),y.value=e,l.value=null}function K(){const{allBreaks:t,allChars:e}=C.value;if(!e.length)return;const s=[],u=[],c=[];for(let r=0;r<e.length;r++){const g=t.has(r),k=y.value.has(r);g&&k?s.push(r):g&&!k?u.push(r):!g&&k&&c.push(r)}const n=t.size,p=n>0?s.length/n:1;l.value={correct:s,missed:u,extra:c,accuracy:p}}function Q(){h.value=!0,l.value=null}function W(){y.value=new Set,l.value=null}function Z(t,e){b.value={annotation:t,x:e.clientX,y:e.clientY}}function ee(){b.value=null}function E(){const{allChars:t,allBreaks:e,paragraphs:s}=C.value;if(!t.length)return[];const u=[];for(const c of s){let n="",p=c.startIdx-1;for(let r=c.startIdx;r<=c.endIdx;r++){const g=r-c.startIdx;n+=c.chars[g];const k=e.has(r);if(r===c.endIdx)n+="。";else if(k){const V=r-p;p=r,V>=8?n+="。":V>=4?n+="，":n+="、"}}n.trim()&&u.push(n)}return u}let w=!1;function I(){w=!0,be(),m.value=!1}const R={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function te(){if(!C.value.allChars.length)return;if(m.value){I();return}m.value=!0,w=!1;const t=E();try{for(let e=0;e<t.length&&!w;e++){const s=t[e+1];s&&O(s,R);const u=t[e];u&&await Te(u,R)}}catch(e){console.error("TTS 播放失敗:",e),w||alert("語音朗讀失敗，請稍後再試")}finally{m.value=!1,w=!1}}async function se(){if(!N.isAuthenticated){alert("請先登入以使用書籤功能");return}await o.toggleBookmark(P.value)}function ae(){q.push({name:"reading-list"})}function ne(t){const e=[],{allBreaks:s}=C.value;return h.value?s.has(t)&&e.push("has-break","correct"):y.value.has(t)?(e.push("has-break","user-marked"),l.value&&(l.value.correct.includes(t)?e.push("verified-correct"):l.value.extra.includes(t)&&e.push("verified-extra"))):l.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}ce(async()=>{await o.fetchTextDetail(P.value),o.startReadingTracking(),o.currentText?.progress&&(X.value=o.currentText.progress.last_paragraph),await ue();const e=E()[0];e&&O(e,R)});function re(){return l.value?Math.round(l.value.accuracy*100):h.value?50:0}return de(()=>{if(I(),P.value&&N.isAuthenticated){const t=re(),e=l.value?.accuracy===1;o.saveReadingRecord(P.value,t,e)}}),he(h,t=>{t&&(l.value=null)}),(t,e)=>(i(),d("div",Ce,[a("header",Se,[a("button",{class:"back-btn",onClick:ae}," ← 返回 "),a("div",we,[a("h1",null,f(v(o).currentText?.title||"載入中..."),1),a("div",Be,[v(o).currentText?.author?(i(),d("span",Pe,f(v(o).currentText.author),1)):x("",!0),v(o).currentText?.source_text?.title?(i(),d("span",Ae," · 選自《"+f(v(o).currentText.source_text.title)+"》 ",1)):x("",!0)])]),a("div",Re,[a("button",{class:B(["action-btn bookmark-btn",{active:v(o).currentText?.progress?.bookmarked}]),onClick:se,title:"收藏"},f(v(o).currentText?.progress?.bookmarked?"⭐":"☆"),3)])]),a("section",Me,[a("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=s=>h.value=!h.value),"aria-pressed":h.value,type:"button"},[e[2]||(e[2]=a("span",{class:"toggle-label"},"顯示斷句",-1)),a("span",Ne,[a("span",{class:B(["toggle-track",{active:h.value}])},[...e[1]||(e[1]=[a("span",{class:"toggle-thumb"},null,-1)])],2)])],8,ze),a("button",{class:B(["tts-btn",{playing:m.value}]),onClick:te},[(i(),F(fe(m.value?v(xe):v(ye)),{size:18,"stroke-width":1.5})),a("span",null,f(m.value?" 停止朗讀":" 朗讀全文"),1)],2)]),v(o).currentText&&D.value.length>0?(i(),d("section",De,[(i(!0),d(z,null,L(D.value,(s,u)=>(i(),d("div",{key:u,class:"paragraph-block"},[a("div",Ee,[(i(!0),d(z,null,L(s.chars,(c,n)=>(i(),d("span",{key:n,class:"char-unit"},[a("span",{class:B(["char",{"has-annotation":S(s.startIdx+n),"annotation-hovered":$(s.startIdx+n),"annotation-start":j(s.startIdx+n),"annotation-end":H(s.startIdx+n)}]),onMouseenter:p=>Y(s.startIdx+n,p),onMouseleave:G},f(c),43,Ie),n<s.chars.length-1?(i(),d("button",{key:0,class:B(["break-slot",ne(s.startIdx+n)]),onClick:p=>J(s.startIdx+n),disabled:h.value},[...e[3]||(e[3]=[a("span",{class:"break-marker"},null,-1)])],10,Ve)):x("",!0)]))),128))])]))),128)),l.value?(i(),d("div",Fe,[a("div",Le,[a("span",Oe,"✓ 正確："+f(l.value.correct.length),1),a("span",Ue,"○ 遺漏："+f(l.value.missed.length),1),a("span",qe,"✗ 多餘："+f(l.value.extra.length),1),a("span",Xe," 正確率："+f(Math.round(l.value.accuracy*100))+"% ",1)]),a("button",{class:"show-answer-btn",onClick:Q}," 查看正確答案 ")])):x("",!0),a("div",$e,[h.value?x("",!0):(i(),d(z,{key:0},[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:W}," 重置 "),a("button",{class:"edamame-btn edamame-btn-primary",onClick:K,disabled:y.value.size===0}," ✓ 驗證我的斷句 ",8,je)],64))])])):v(o).isLoading?(i(),d("section",He,[...e[4]||(e[4]=[a("span",{class:"loading-spinner"},null,-1),ve(" 載入中... ",-1)])])):x("",!0),(i(),F(ge,{to:"body"},[b.value?(i(),d("div",{key:0,class:"annotation-tooltip",style:pe({left:b.value.x+"px",top:b.value.y+16+"px"})},f(b.value.annotation.annotation),5)):x("",!0)]))]))}}),et=ke(Ye,[["__scopeId","data-v-dc1db29e"]]);export{et as default};
