import{v as z,u as K,r as d,c as L,H as o}from"./index-C9sOeXv-.js";const _=[0,30,100,200,350,550,850,1300,2e3,3e3],V=[{maxTime:1,factor:1.3},{maxTime:2,factor:1.2},{maxTime:3,factor:1.1},{maxTime:5,factor:1},{maxTime:8,factor:.9},{maxTime:1/0,factor:.7}],S=[1.2,1,.95,.9],J=[{minDays:30,factor:1.2},{minDays:14,factor:1.15},{minDays:7,factor:1.1},{minDays:3,factor:1.05},{minDays:0,factor:1}],Q=1.2,b=5,y=10,oe=z("userStats",()=>{const l=K(),a=d(null),T=d(!1),h=d(null),m=d([]),v=d("total"),w=d(!1),D=d(null),x=L(()=>{if(!a.value)return 1;const e=a.value.total_beans;for(let t=_.length-1;t>=0;t--){const r=_[t];if(r!==void 0&&e>=r)return t+1}return 1}),H=L(()=>{if(!a.value)return 0;const e=x.value,t=_[e-1]||0,r=_[e]||t+1e3,n=a.value.total_beans-t,s=r-t;return Math.min(100,Math.round(n/s*100))}),U=L(()=>{if(!a.value)return 30;const e=x.value;if(e>=_.length)return 0;const t=_[e]||3e3;return Math.max(0,t-a.value.total_beans)});function P(e){for(const t of V)if(e<t.maxTime)return t.factor;return .7}function F(e){return e<=0?1:e>S.length?S[S.length-1]||.9:S[e-1]||.9}function O(e){for(const t of J)if(e>=t.minDays)return t.factor;return 1}function G(e){const{breakCount:t,charCount:r,elapsedSeconds:n,attemptCount:s,isFirstClear:u}=e,c=t*2,i=r>0?n/r:5,g=P(i),C=F(s),p=a.value?.streak_days||0,f=O(p),k=u?Q:1;return{score:Math.round(c*g*C*f*k),breakdown:{baseScore:c,timeFactor:g,attemptFactor:C,streakFactor:f,firstClearFactor:k,avgTimePerChar:Math.round(i*10)/10}}}async function A(){if(!(!o||!l.user)){T.value=!0,h.value=null;try{const{data:e,error:t}=await o.from("profiles").select("*").eq("id",l.user.id).single();if(t){if(t.code==="PGRST116"){console.log("ç”¨æˆ¶ Profile ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º..."),await j();return}throw t}a.value=e,await R()}catch(e){h.value=e.message,console.error("ç²å–ç”¨æˆ¶ Profile å¤±æ•—:",e)}finally{T.value=!1}}}async function j(){if(!(!o||!l.user))try{const{data:e}=await o.from("users").select("display_name, email").eq("id",l.user.id).single(),t=e?.display_name||l.user.email?.split("@")[0]||"è±†å‹",r=t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""),{data:n,error:s}=await o.from("profiles").insert({id:l.user.id,username:r+"_"+Date.now().toString(36),display_name:t,total_beans:0,weekly_beans:0,monthly_beans:0,streak_days:0,max_streak:0,daily_login_claimed:!1,daily_first_claimed:!1}).select().single();if(s){console.error("å‰µå»º Profile å¤±æ•—:",s);return}a.value=n,console.log("âœ… Profile å‰µå»ºæˆåŠŸ"),await R()}catch(e){console.error("å‰µå»ºåˆå§‹ Profile å¤±æ•—:",e)}}async function R(){if(!o||!a.value||!l.user)return!1;const e=new Date().toISOString().split("T")[0],t=a.value.last_login_date;if(t===e&&a.value.daily_login_claimed)return!1;try{const r={last_login_date:e,daily_login_claimed:!0,total_beans:a.value.total_beans+b,weekly_beans:a.value.weekly_beans+b,monthly_beans:a.value.monthly_beans+b,updated_at:new Date().toISOString()};t!==e&&(r.daily_first_claimed=!1);const{error:n}=await o.from("profiles").update(r).eq("id",l.user.id);if(n)throw n;return Object.assign(a.value,r),console.log(`ðŸŽ æ¯æ—¥ç™»å…¥çŽå‹µ +${b} è±†`),!0}catch(r){return console.error("ç™¼æ”¾æ¯æ—¥ç™»å…¥çŽå‹µå¤±æ•—:",r),!1}}async function q(){if(!o||!a.value||!l.user||a.value.daily_first_claimed)return 0;try{const e={daily_first_claimed:!0,total_beans:a.value.total_beans+y,weekly_beans:a.value.weekly_beans+y,monthly_beans:a.value.monthly_beans+y,updated_at:new Date().toISOString()},{error:t}=await o.from("profiles").update(e).eq("id",l.user.id);if(t)throw t;return Object.assign(a.value,e),console.log(`ðŸŽ æ¯æ—¥é¦–ç·´çŽå‹µ +${y} è±†`),y}catch(e){return console.error("ç™¼æ”¾æ¯æ—¥é¦–ç·´çŽå‹µå¤±æ•—:",e),0}}async function M(){if(!o||!a.value||!l.user)return;const e=new Date().toISOString().split("T")[0],t=a.value.last_practice_date;let r=a.value.streak_days;if(!t)r=1;else{const s=new Date(t),u=new Date(e),c=Math.floor((u.getTime()-s.getTime())/(1e3*60*60*24));if(c===0)return;c===1?r=a.value.streak_days+1:r=1}const n=Math.max(a.value.max_streak,r);try{const{error:s}=await o.from("profiles").update({streak_days:r,max_streak:n,last_practice_date:e,updated_at:new Date().toISOString()}).eq("id",l.user.id);if(s)throw s;a.value.streak_days=r,a.value.max_streak=n,a.value.last_practice_date=e}catch(s){console.error("æ›´æ–°é€£çºŒå¤©æ•¸å¤±æ•—:",s)}}async function B(e){if(!o||!l.user)return!1;try{const{data:t,error:r}=await o.from("user_text_scores").select("id").eq("user_id",l.user.id).eq("text_id",e).single();return r&&r.code==="PGRST116"?!0:!t}catch{return!1}}async function W(e){if(!o||!a.value||!l.user)return{beansEarned:0,isNewRecord:!1};const{textId:t,score:r}=e;try{const{data:n}=await o.from("user_text_scores").select("*").eq("user_id",l.user.id).eq("text_id",t).single();let s=0,u=!1;if(!n)await o.from("user_text_scores").insert({user_id:l.user.id,text_id:t,best_score:r,weekly_best:r,monthly_best:r,first_clear_at:new Date().toISOString(),attempt_count:1}),s=r,u=!0;else{const i={attempt_count:n.attempt_count+1,updated_at:new Date().toISOString()};r>n.best_score&&(s=r-n.best_score,i.best_score=r,u=!0),r>n.weekly_best&&(i.weekly_best=r),r>n.monthly_best&&(i.monthly_best=r),await o.from("user_text_scores").update(i).eq("id",n.id)}if(s>0){const{error:i}=await o.from("profiles").update({total_beans:a.value.total_beans+s,weekly_beans:a.value.weekly_beans+s,monthly_beans:a.value.monthly_beans+s,updated_at:new Date().toISOString()}).eq("id",l.user.id);i||(a.value.total_beans+=s,a.value.weekly_beans+=s,a.value.monthly_beans+=s)}await M();const c=await q();return s+=c,N(),{beansEarned:s,isNewRecord:u}}catch(n){return console.error("è¨˜éŒ„ç·´ç¿’åˆ†æ•¸å¤±æ•—:",n),{beansEarned:0,isNewRecord:!1}}}const I=d({}),Y=3e4;async function E(e="total",t=!1){if(!o)return;const r=I.value[e];if(!t&&r&&Date.now()-r.timestamp<Y){m.value=r.data,v.value=e;return}w.value=!0,v.value=e;try{const n=e==="weekly"?"weekly_beans":e==="monthly"?"monthly_beans":"total_beans",s=l.user?.id,u=a.value?.[n==="weekly_beans"?"weekly_beans":n==="monthly_beans"?"monthly_beans":"total_beans"]||0,[c,i,g]=await Promise.all([o.from("profiles").select("id, display_name, total_beans, weekly_beans, monthly_beans").order(n,{ascending:!1}).limit(10),s?o.from("profiles").select("*",{count:"exact",head:!0}).gt(n,u):Promise.resolve({count:0}),s?o.from("profiles").select("*",{count:"exact",head:!0}):Promise.resolve({count:0})]);if(c.error)throw c.error;const p=(c.data||[]).map((f,k)=>({rank:k+1,userId:f.id,name:f.display_name||"åŒ¿å",beans:e==="weekly"?f.weekly_beans:e==="monthly"?f.monthly_beans:f.total_beans,isCurrentUser:f.id===s}));m.value=p,I.value[e]={data:p,timestamp:Date.now()},s&&(D.value={rank:(i.count||0)+1,totalUsers:g.count||0})}catch(n){console.error("ç²å–æŽ’è¡Œæ¦œå¤±æ•—:",n),m.value=[]}finally{w.value=!1}}function N(){I.value={}}function $(){a.value=null,m.value=[],D.value=null,h.value=null}return{profile:a,stats:a,loading:T,error:h,leaderboard:m,top10:m,leaderboardType:v,leaderboardLoading:w,top10Loading:w,rankInfo:D,level:x,levelProgress:H,beansToNextLevel:U,getTimeFactor:P,getAttemptFactor:F,getStreakFactor:O,calculateScore:G,fetchProfile:A,fetchStats:A,fetchLeaderboard:E,fetchTop10:()=>E("total"),fetchRankInfo:()=>E(v.value),checkFirstClear:B,recordPracticeScore:W,checkDailyLoginReward:R,checkDailyFirstPracticeReward:q,updateStreakDays:M,clearLeaderboardCache:N,reset:$,DAILY_LOGIN_REWARD:b,DAILY_FIRST_PRACTICE_REWARD:y,LEVEL_THRESHOLDS:_}});export{oe as u};
