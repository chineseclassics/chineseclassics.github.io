import{d as me,c as o,x as pe,r as T,w as fe,f as he,R as _e,a as r,g as s,F as b,h as f,b as k,t as c,j as C,l as ge,o as l,_ as Te}from"./index-De8qPoW3.js";import{u as ke}from"./gameStore-BNDXIgNO.js";import"./userStatsStore-B6oJ2tAu.js";import"./game-pGsr7gx9.js";const ye={class:"game-play"},be={key:0,class:"loading-container"},Be={class:"play-header"},xe={class:"header-left"},we={class:"countdown-time"},Ae={class:"header-center"},Ce={class:"text-title"},Pe={key:0,class:"text-author"},Se={class:"header-right"},ze={class:"scoreboard"},Ie={class:"score-chip"},Ve={class:"chip-value"},Re={key:0,class:"score-chip team"},Me={class:"chip-value"},Ge={key:0,class:"text-tabs"},De=["onClick"],Fe={class:"tab-number"},$e={class:"tab-title"},qe={key:0,class:"tab-check"},Ee={class:"play-main"},Le={class:"board-header"},Ue={class:"board-header-right"},Ne={class:"practice-board"},je={key:0,class:"practice-line"},Oe={class:"char"},Ye=["onClick","aria-label"],He={key:0,class:"bean"},Je={class:"progress-hint"},Ke={key:0,class:"team-board"},Qe={class:"team-name"},We={class:"team-score"},Xe={key:1,class:"text-nav"},Ze=["disabled"],et={class:"nav-info"},tt=["disabled"],at=250,st=me({__name:"GamePlay",setup(nt){const K=ge(),Q=pe(),_=ke(),P=o(()=>Q.params.roomId),i=o(()=>_.currentRoom),S=o(()=>_.myParticipant),W=o(()=>S.value?.score||0),z=o(()=>!i.value?.teams||!S.value?.team_id?null:i.value.teams.find(a=>a.id===S.value.team_id)||null),q=o(()=>z.value?(z.value.total_score||0)/100:null),E=o(()=>i.value?.teams?[...i.value.teams].map(a=>({id:a.id,name:a.team_name,score:(a.total_score||0)/100})).sort((a,e)=>e.score-a.score):[]),d=T([]),p=T(new Map),m=T(0),v=o(()=>d.value[m.value]),y=o(()=>v.value&&p.value.get(v.value.id)||null),I=o(()=>y.value?.characters||[]),L=o(()=>y.value?.correctBreaks||new Set),B=o({get:()=>y.value?.userBreaks||new Map,set:a=>{if(v.value&&p.value.has(v.value.id)){const e=p.value.get(v.value.id);e.userBreaks=a}}}),x=T(0);let V=null;const U=o(()=>L.value.size),X=o(()=>B.value.size),N=o(()=>Math.max(0,U.value-X.value)),Z=o(()=>N.value>0),R=T(!1),j=T(null);let h=null,w=!1,M=!1;const O=T(!0);function ee(a){const e=[],t=new Set;let n=0;const u=a.replace(/[\|\s]+$/,"");for(const g of u)g==="|"?n>0&&t.add(n-1):g!==`
`&&g!=="\r"&&(e.push(g),n++);return{chars:e,breaks:t}}function te(){p.value.clear();for(const a of d.value){const e=ee(a.content);p.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Map})}}function ae(a){a>=0&&a<d.value.length&&(m.value=a)}function se(){m.value>0&&m.value--}function ne(){m.value<d.value.length-1&&m.value++}let G=null;function D(a){try{G||(G=new AudioContext);const e=G,t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),n.gain.setValueAtTime(.2,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function F(a=10){navigator.vibrate&&navigator.vibrate(a)}function re(a){if(!v.value)return;const e=p.value.get(v.value.id);if(!e||e.userBreaks.has(a))return;if(e.userBreaks.size>=e.correctBreaks.size){D("error"),R.value=!0,setTimeout(()=>{R.value=!1},300),F(50);return}const t={index:a,isCorrect:e.correctBreaks.has(a),placedAt:Date.now()},n=new Map(e.userBreaks);n.set(a,t),e.userBreaks=n,p.value=new Map(p.value),j.value=t.placedAt,t.isCorrect?(D("add"),F(10)):(D("error"),F(50)),J();const u=H();u.usedBeansAll>=u.totalBeansAll&&J(!0)}function le(a){const e=B.value.get(a);return{"has-bean":!!e,correct:e?.isCorrect,extra:e&&!e.isCorrect}}function Y(a){let e=0,t=0;return a.userBreaks.forEach(n=>{n.isCorrect?e++:t++}),{correct:e,wrong:t}}function H(){let a=0,e=0,t=0;return p.value.forEach(n=>{const u=Y(n);a+=u.correct,e+=n.correctBreaks.size,t+=n.userBreaks.size}),{totalCorrect:a,totalBeansAll:e,usedBeansAll:t}}function oe(a=!1){if(!v.value||!y.value)return null;const{correct:e,wrong:t}=Y(y.value),{totalCorrect:n,totalBeansAll:u,usedBeansAll:g}=H(),de=j.value||Date.now(),ve=a||g>=u;return{roomId:P.value,textId:v.value.id,textIndex:m.value,correctCount:e,wrongCount:t,totalCorrect:n,totalBeans:u,usedBeans:g,lastInteraction:de,isFinished:ve}}async function $(a=!1){h&&(clearTimeout(h),h=null);const e=oe(a);if(e&&!M){M=!0;try{await _.updateProgress(e)}catch(t){console.error("[GamePlay] 更新進度失敗",t)}finally{M=!1}}}function J(a=!1){a&&(w=!0),h&&clearTimeout(h),h=setTimeout(()=>{$(w),w=!1},at)}async function ie(a=!1){await $(a);try{await _.endGame()}catch(e){console.error("[GamePlay] 結束遊戲失敗",e)}}function A(a){const e=p.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,n=e.correctBreaks.size;return t===0?"empty":t===n&&[...e.correctBreaks].every(u=>e.userBreaks.has(u))?"complete":"partial"}function ce(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function ue(){if(!i.value?.started_at||!i.value?.time_limit)return;const a=()=>{const e=new Date(i.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);x.value=Math.max(0,i.value.time_limit-t),x.value===0&&ie(!0)};a(),V=setInterval(a,1e3)}return fe(()=>i.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),K.push({name:"arena-result",params:{roomId:P.value}}))}),he(async()=>{_.subscribeToRoom(P.value),i.value?.text_ids&&i.value.text_ids.length>0?d.value=await _.fetchTexts(i.value.text_ids):i.value?.text_id&&(d.value=await _.fetchTexts([i.value.text_id])),O.value=!1,d.value.length>0&&(te(),ue())}),_e(()=>{V&&clearInterval(V),h&&clearTimeout(h),$(w)}),(a,e)=>(l(),r("div",ye,[O.value?(l(),r("div",be,[...e[0]||(e[0]=[s("span",{class:"loading-spinner"},"⏳",-1),s("span",null,"載入題目中...",-1)])])):(l(),r(b,{key:1},[s("header",Be,[s("div",xe,[s("div",{class:k(["countdown",{warning:x.value<30}])},[e[1]||(e[1]=s("span",{class:"countdown-label"},"剩餘時間",-1)),s("span",we,c(ce(x.value)),1)],2)]),s("div",Ae,[s("span",Ce,c(v.value?.title),1),v.value?.author?(l(),r("span",Pe,c(v.value.author),1)):f("",!0)]),s("div",Se,[s("div",ze,[s("div",Ie,[e[2]||(e[2]=s("span",{class:"chip-label"},"個人分數",-1)),s("span",Ve,c(W.value),1)]),q.value!==null?(l(),r("div",Re,[e[3]||(e[3]=s("span",{class:"chip-label"},"團隊平均",-1)),s("span",Me,c(q.value?.toFixed(2)),1)])):f("",!0)]),e[4]||(e[4]=s("div",{class:"live-pill"},[s("span",{class:"live-dot"}),s("span",null,"實時計分")],-1))])]),d.value.length>1?(l(),r("div",Ge,[(l(!0),r(b,null,C(d.value,(t,n)=>(l(),r("button",{key:t.id,class:k(["text-tab",{active:n===m.value,empty:A(t.id)==="empty",partial:A(t.id)==="partial",complete:A(t.id)==="complete"}]),onClick:u=>ae(n)},[s("span",Fe,c(n+1),1),s("span",$e,c(t.title),1),A(t.id)==="complete"?(l(),r("span",qe,"✓")):f("",!0)],10,De))),128))])):f("",!0),s("main",Ee,[s("div",Le,[e[5]||(e[5]=s("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),s("div",Ue,[s("div",{class:k(["bean-inventory",{shake:R.value,empty:!Z.value}])},[(l(!0),r(b,null,C(U.value,t=>(l(),r("span",{key:t,class:k(["inventory-bean",{used:t>N.value}])},null,2))),128))],2)])]),s("div",Ne,[I.value.length?(l(),r("div",je,[(l(!0),r(b,null,C(I.value,(t,n)=>(l(),r("span",{key:n,class:"char-unit"},[s("span",Oe,c(t),1),n<I.value.length-1?(l(),r("button",{key:0,class:k(["bean-slot",le(n)]),onClick:u=>re(n),"aria-label":`在「${t}」後放置斷句`},[B.value.has(n)?(l(),r("span",He)):f("",!0),e[6]||(e[6]=s("span",{class:"bean-hint"},null,-1))],10,Ye)):f("",!0)]))),128))])):f("",!0)]),s("div",Je,[s("span",null,"已標記 "+c(B.value.size)+" / "+c(L.value.size)+" 處",1)]),E.value.length?(l(),r("div",Ke,[(l(!0),r(b,null,C(E.value,t=>(l(),r("div",{class:k(["team-row",{me:t.id===z.value?.id}]),key:t.id},[s("span",Qe,c(t.name),1),s("span",We,c(t.score.toFixed(2)),1)],2))),128))])):f("",!0),d.value.length>1?(l(),r("div",Xe,[s("button",{class:"nav-btn",disabled:m.value===0,onClick:se}," ← 上一篇 ",8,Ze),s("span",et,c(m.value+1)+" / "+c(d.value.length),1),s("button",{class:"nav-btn",disabled:m.value===d.value.length-1,onClick:ne}," 下一篇 → ",8,tt)])):f("",!0)]),e[7]||(e[7]=s("footer",{class:"play-footer"},[s("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),ct=Te(st,[["__scopeId","data-v-8cdee233"]]);export{ct as default};
