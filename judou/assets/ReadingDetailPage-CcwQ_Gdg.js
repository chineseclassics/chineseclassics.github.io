import{d as le,u as ie,c as z,x as ce,r as _,f as ue,O as de,P as he,w as fe,a as h,g as s,h as x,m as L,t as v,i as p,b as B,q as ve,F as N,j as O,s as pe,n as ge,M as me,l as ke,o as i,_ as _e}from"./index-I6AaPpnM.js";import{u as xe}from"./readingStore-CdnHoYqQ.js";import{a as U,S as be,V as ye,c as Te,b as Ce}from"./useClassicalTTS-CwfC4D8c.js";import"./useSupabase-1Q3ft7Nx.js";import"./createLucideIcon-B-MqeTwW.js";const Se={class:"reading-detail-page"},we={class:"reading-header edamame-glass"},Be={class:"header-title"},Pe={class:"title-meta"},Ae={key:0,class:"author"},Re={key:1,class:"source-tag"},Me={class:"header-actions"},ze={class:"control-bar edamame-glass"},Ne=["aria-pressed"],De={class:"toggle-switch"},Ee={key:0,class:"reading-content edamame-glass"},Ie={class:"reading-line"},Ve=["onMouseenter"],Fe=["onClick","disabled"],Le={key:0,class:"verification-result"},Oe={class:"result-stats"},Ue={class:"stat correct"},$e={class:"stat missed"},qe={class:"stat extra"},Xe={class:"stat accuracy"},je={class:"content-actions"},He=["disabled"],Ye={key:1,class:"loading-state edamame-glass"},Ge=le({__name:"ReadingDetailPage",setup(Je){const $=ce(),q=ke(),r=xe(),D=ie(),P=z(()=>$.params.id),f=_(!0),b=_(new Set),o=_(null),y=_(null),k=_(!1),T=z(()=>{if(!r.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const t=r.currentText.content,e=t.includes("||")?"||":/\n\n+/,a=t.split(e),u=[],c=[],n=new Set;let d=0;for(const l of a){const g=[],m=new Set,F=d,R=l.replace(/[\|\s]+$/,"");for(const w of R)w==="|"?d>0&&(n.add(d-1),m.add(g.length-1)):w!==`
`&&w!=="\r"&&(c.push(w),g.push(w),d++);g.length>0&&u.push({chars:g,breaks:m,startIdx:F,endIdx:d-1})}return{paragraphs:u,allChars:c,allBreaks:n}}),E=z(()=>T.value.paragraphs),X=_(0);function C(t){return r.currentText?.annotations&&r.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const A=_(null);function j(t){return A.value?C(t)?.id===A.value:!1}function H(t){return C(t)?.start_index===t}function Y(t){const e=C(t);return e?e.end_index-1===t:!1}function G(t,e){const a=C(t);a&&(A.value=a.id,ee(a,e))}function J(){A.value=null,te()}function K(t){if(f.value)return;const e=new Set(b.value);e.has(t)?e.delete(t):e.add(t),b.value=e,o.value=null}function Q(){const{allBreaks:t,allChars:e}=T.value;if(!e.length)return;const a=[],u=[],c=[];for(let l=0;l<e.length;l++){const g=t.has(l),m=b.value.has(l);g&&m?a.push(l):g&&!m?u.push(l):!g&&m&&c.push(l)}const n=t.size,d=n>0?a.length/n:1;o.value={correct:a,missed:u,extra:c,accuracy:d}}function W(){f.value=!0,o.value=null}function Z(){b.value=new Set,o.value=null}function ee(t,e){y.value={annotation:t,x:e.clientX,y:e.clientY}}function te(){y.value=null}function I(){const{allChars:t,allBreaks:e,paragraphs:a}=T.value;if(!t.length)return[];const u=[];for(const c of a){let n="",d=c.startIdx-1;for(let l=c.startIdx;l<=c.endIdx;l++){const g=l-c.startIdx;n+=c.chars[g];const m=e.has(l);if(l===c.endIdx)n+="。";else if(m){const R=l-d;d=l,R>=8?n+="。":R>=4?n+="，":n+="、"}}n.trim()&&u.push(n)}return u}let S=!1;function V(){S=!0,Te(),k.value=!1}const M={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function se(){if(!T.value.allChars.length)return;if(k.value){V();return}k.value=!0,S=!1;const t=I();try{for(let e=0;e<t.length&&!S;e++){const a=t[e+1];a&&U(a,M);const u=t[e];u&&await Ce(u,M)}}catch(e){console.error("TTS 播放失敗:",e),S||alert("語音朗讀失敗，請稍後再試")}finally{k.value=!1,S=!1}}async function ae(){if(!D.isAuthenticated){alert("請先登入以使用書籤功能");return}await r.toggleBookmark(P.value)}function ne(){q.push({name:"reading-list"})}function re(t){const e=[],{allBreaks:a}=T.value;return f.value?a.has(t)&&e.push("has-break","correct"):b.value.has(t)?(e.push("has-break","user-marked"),o.value&&(o.value.correct.includes(t)?e.push("verified-correct"):o.value.extra.includes(t)&&e.push("verified-extra"))):o.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}ue(async()=>{await r.fetchTextDetail(P.value),r.startReadingTracking(),r.currentText?.progress&&(X.value=r.currentText.progress.last_paragraph),await de();const e=I()[0];e&&U(e,M)});function oe(){return o.value?Math.round(o.value.accuracy*100):f.value?50:0}return he(()=>{if(V(),P.value&&D.isAuthenticated){const t=oe(),e=o.value?.accuracy===1;r.saveReadingRecord(P.value,t,e)}}),fe(f,t=>{t&&(o.value=null)}),(t,e)=>(i(),h("div",Se,[s("header",we,[s("button",{class:"back-btn",onClick:ne}," ← 返回 "),s("div",Be,[s("h1",null,v(p(r).currentText?.title||"載入中..."),1),s("div",Pe,[p(r).currentText?.author?(i(),h("span",Ae,v(p(r).currentText.author),1)):x("",!0),p(r).currentText?.source_text?.title?(i(),h("span",Re," · 選自《"+v(p(r).currentText.source_text.title)+"》 ",1)):x("",!0)])]),s("div",Me,[s("button",{class:B(["action-btn bookmark-btn",{active:p(r).currentText?.progress?.bookmarked}]),onClick:ae,title:"收藏"},v(p(r).currentText?.progress?.bookmarked?"⭐":"☆"),3)])]),s("section",ze,[s("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=a=>f.value=!f.value),"aria-pressed":f.value,type:"button"},[e[2]||(e[2]=s("span",{class:"toggle-label"},"顯示斷句",-1)),s("span",De,[s("span",{class:B(["toggle-track",{active:f.value}])},[...e[1]||(e[1]=[s("span",{class:"toggle-thumb"},null,-1)])],2)])],8,Ne),s("button",{class:B(["tts-btn",{playing:k.value}]),onClick:se},[(i(),L(ve(k.value?p(be):p(ye)),{size:18,"stroke-width":1.5})),s("span",null,v(k.value?" 停止朗讀":" 朗讀全文"),1)],2)]),p(r).currentText&&E.value.length>0?(i(),h("section",Ee,[(i(!0),h(N,null,O(E.value,(a,u)=>(i(),h("div",{key:u,class:"paragraph-block"},[s("div",Ie,[(i(!0),h(N,null,O(a.chars,(c,n)=>(i(),h("span",{key:n,class:"char-unit"},[s("span",{class:B(["char",{"has-annotation":C(a.startIdx+n),"annotation-hovered":j(a.startIdx+n),"annotation-start":H(a.startIdx+n),"annotation-end":Y(a.startIdx+n)}]),onMouseenter:d=>G(a.startIdx+n,d),onMouseleave:J},v(c),43,Ve),n<a.chars.length-1?(i(),h("button",{key:0,class:B(["break-slot",re(a.startIdx+n)]),onClick:d=>K(a.startIdx+n),disabled:f.value},[...e[3]||(e[3]=[s("span",{class:"break-marker"},null,-1)])],10,Fe)):x("",!0)]))),128))])]))),128)),o.value?(i(),h("div",Le,[s("div",Oe,[s("span",Ue,"✓ 正確："+v(o.value.correct.length),1),s("span",$e,"○ 遺漏："+v(o.value.missed.length),1),s("span",qe,"✗ 多餘："+v(o.value.extra.length),1),s("span",Xe," 正確率："+v(Math.round(o.value.accuracy*100))+"% ",1)]),s("button",{class:"show-answer-btn",onClick:W}," 查看正確答案 ")])):x("",!0),s("div",je,[f.value?x("",!0):(i(),h(N,{key:0},[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:Z}," 重置 "),s("button",{class:"edamame-btn edamame-btn-primary",onClick:Q,disabled:b.value.size===0}," ✓ 驗證我的斷句 ",8,He)],64))])])):p(r).isLoading?(i(),h("section",Ye,[...e[4]||(e[4]=[s("span",{class:"loading-spinner"},null,-1),pe(" 載入中... ",-1)])])):x("",!0),(i(),L(me,{to:"body"},[y.value?(i(),h("div",{key:0,class:"annotation-tooltip",style:ge({left:y.value.x+"px",top:y.value.y+16+"px"})},v(y.value.annotation.annotation),5)):x("",!0)]))]))}}),tt=_e(Ge,[["__scopeId","data-v-bff8760b"]]);export{tt as default};
