import{d as Z,u as ee,c as i,x as te,r as B,w as se,f as ae,a as o,g as s,h as m,t as n,b as p,e as ne,F as M,j as I,s as x,k as re,n as E,l as le,i as F,o as u,_ as oe}from"./index-lMxeXcG_.js";import{u as ue}from"./gameStore-Tr7kYTq7.js";import{u as ie}from"./userStatsStore-Djc8RuoG.js";import{g as ce,c as U}from"./game-pGsr7gx9.js";import{B as ve}from"./BeanIcon-Bq6-GekL.js";const de={class:"result-header"},me={class:"result-icon"},pe={class:"bean-sign"},_e={key:0,class:"bean-note"},fe={key:0,class:"ranking-section"},ge={class:"ranking-list"},he=["src","alt"],ke={key:1,class:"avatar-placeholder"},ye={class:"name"},be={class:"score"},we={class:"accuracy"},Se={class:"time"},Ce={key:1,class:"streak-card"},Be={class:"streak-text"},xe={key:2,class:"answers-section"},Ae={key:0,class:"result-tabs"},Re=["onClick"],Te={class:"tab-number"},Me={class:"tab-title"},Ie={class:"tab-stats"},Pe={key:1,class:"answer-detail"},Ve={class:"answer-header"},Fe={key:0,class:"answer-author"},Ne={class:"answer-stats"},ze={class:"stat correct"},De={class:"stat wrong"},$e={class:"stat missed"},Ge={class:"answer-content"},Le={class:"answer-line"},Oe={class:"answer-char"},qe={key:3,class:"ranking-section"},Ee={class:"team-ranking-list"},Ue={class:"rank"},je={class:"team-name"},Je={class:"team-score"},We={class:"rank-title-section"},He={class:"level-text"},Ke=Z({__name:"GameResult",setup(Qe){const P=le(),j=te(),h=ue(),A=ee(),V=ie(),R=i(()=>j.params.roomId),l=i(()=>h.currentRoom),k=i(()=>h.myParticipant),J=i(()=>l.value?.participants||[]),N=i(()=>l.value?.teams||[]),v=B(null),T=B(0),c=i(()=>{if(!v.value)return null;const a=v.value.texts[T.value],e=v.value.results[T.value];return!a||!e?null:{text:a,result:e}});function z(a){const e=[];for(const t of a)t!=="|"&&t!==`
`&&t!=="\r"&&e.push(t);return e}function D(a){if(!c.value?.result)return"none";const e=c.value.result,t=e.userBreaks.includes(a),r=e.correctBreaks.includes(a);return t&&r?"correct":t&&!r?"wrong":!t&&r?"missed":"none"}const _=i(()=>{if(!l.value||!A.user)return!1;if(l.value.game_mode==="team_battle")return k.value?.team_id===l.value.winner_team_id;{if(l.value.winner_user_id)return l.value.winner_user_id===A.user.id;if(!l.value.participants)return!1;const a=k.value?.score??0,e=k.value?.time_spent??999999,t=Math.max(...l.value.participants.map(d=>d.score)),r=l.value.participants.filter(d=>d.score===t),w=Math.min(...r.map(d=>d.time_spent??999999));return a===t&&e===w}}),y=i(()=>!l.value||l.value.game_mode==="team_battle"?!1:!l.value.winner_user_id&&_.value),W=i(()=>l.value?.participants?[...l.value.participants].sort((a,e)=>e.score-a.score).map((a,e)=>({...a,rank:e+1})):[]),H=i(()=>N.value.length?N.value.map(a=>{const e=J.value.filter(S=>S.team_id===a.id),t=e.reduce((S,C)=>S+(C.score||0),0),r=e.length>0?t/e.length:0,d=(typeof a.total_score=="number"?a.total_score/100:0)||r;return{...a,averageScore:d}}).sort((a,e)=>e.averageScore-a.averageScore):[]),$=i(()=>V.level),G=i(()=>ce($.value)),L=i(()=>V.profile?.pvp_win_streak??0),O=B(!1),b=B(0),f=B(!1),g=i(()=>{if(!k.value||!l.value)return{amount:0,type:"neutral"};const a=k.value.fee_paid||l.value.entry_fee||0,e=l.value.participants?.length||0;return y.value?{amount:0,type:"tie"}:_.value&&a>0?{amount:a*e,type:"win"}:!_.value&&a>0?{amount:-a,type:"lose"}:{amount:0,type:"neutral"}});function K(){const a=Math.abs(g.value.amount),e=g.value.type;if(a===0&&e!=="tie"){f.value=!0;return}O.value=!0,b.value=0,f.value=!1;const t=2500,r=Date.now(),w=a>0?a:100;function d(){const S=Date.now()-r,C=Math.min(S/t,1);if(C<1){if(C<.8)b.value=Math.floor(Math.random()*w*1.5);else{const q=(C-.8)/.2;b.value=Math.floor(a*q+Math.random()*(a*(1-q)))}requestAnimationFrame(d)}else b.value=a,f.value=!0}setTimeout(()=>{requestAnimationFrame(d)},500)}function Q(a){v.value&&a>=0&&a<v.value.texts.length&&(T.value=a)}function X(){h.reset(),sessionStorage.removeItem(`game-result-${R.value}`),P.push({name:"arena"})}function Y(){h.reset(),sessionStorage.removeItem(`game-result-${R.value}`),A.isTeacher?P.push({name:"arena-teacher-create"}):P.push({name:"arena-create"})}return se(()=>l.value?.status,a=>{}),ae(()=>{h.subscribeToRoom(R.value),V.fetchProfile();const a=sessionStorage.getItem(`game-result-${R.value}`);if(a)try{v.value=JSON.parse(a)}catch{}K()}),(a,e)=>(u(),o("div",{class:p(["game-result",{winner:_.value,tie:y.value}])},[s("header",de,[s("div",me,n(y.value?"ğŸ¤":_.value?"ğŸ†":"ğŸ’ª"),1),s("h1",null,n(y.value?"å¹³å±€ï¼":_.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),O.value||g.value.type!=="neutral"?(u(),o("div",{key:0,class:p(["bean-change-display",[g.value.type,{complete:f.value}]])},[s("span",pe,n(g.value.type==="lose"?"-":g.value.type==="win"?"+":""),1),s("span",{class:p(["bean-number",{rolling:!f.value}])},n(b.value),3),ne(ve,{size:40,class:"bean-icon-img"}),y.value&&f.value?(u(),o("span",_e,"å…¥å ´è²»å·²é€€é‚„")):m("",!0)],2)):m("",!0)]),l.value?.game_mode==="pvp"?(u(),o("section",fe,[e[0]||(e[0]=s("h2",null,"æ’è¡Œæ¦œ",-1)),s("div",ge,[(u(!0),o(M,null,I(W.value,t=>(u(),o("div",{key:t.id,class:p(["ranking-item",{me:t.user_id===F(A).user?.id,top:t.rank<=3}])},[s("span",{class:p(["rank",`rank-${t.rank}`])},n(t.rank===1?"ğŸ¥‡":t.rank===2?"ğŸ¥ˆ":t.rank===3?"ğŸ¥‰":t.rank),3),t.user?.avatar_url?(u(),o("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"avatar"},null,8,he)):(u(),o("span",ke,n(t.user?.display_name?.charAt(0)||"?"),1)),s("span",ye,n(t.user?.display_name||"æœªçŸ¥"),1),s("span",be,n(t.score)+" åˆ†",1),s("span",we,n(t.accuracy?.toFixed(0)||0)+"%",1),s("span",Se,n(t.time_spent)+"s",1)],2))),128))])])):m("",!0),L.value>0&&_.value?(u(),o("div",Ce,[e[3]||(e[3]=s("span",{class:"streak-icon"},"ğŸ”¥",-1)),s("span",Be,[e[1]||(e[1]=x(" é€£å‹ ",-1)),s("strong",null,n(L.value),1),e[2]||(e[2]=x(" å ´ï¼ ",-1))])])):m("",!0),v.value?(u(),o("section",xe,[e[9]||(e[9]=s("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),v.value.texts.length>1?(u(),o("div",Ae,[(u(!0),o(M,null,I(v.value.texts,(t,r)=>(u(),o("button",{key:t.id,class:p(["result-tab",{active:r===T.value}]),onClick:w=>Q(r)},[s("span",Te,n(r+1),1),s("span",Me,n(t.title),1),s("span",Ie," âœ“"+n(v.value.results[r]?.correctCount||0),1)],10,Re))),128))])):m("",!0),c.value&&c.value.text&&c.value.result?(u(),o("div",Pe,[s("div",Ve,[s("h3",null,n(c.value.text.title),1),c.value.text.author?(u(),o("span",Fe,n(c.value.text.author),1)):m("",!0)]),s("div",Ne,[s("span",ze,[e[4]||(e[4]=s("span",{class:"bean-legend correct"},null,-1)),x(" æ­£ç¢º "+n(c.value.result.correctCount),1)]),s("span",De,[e[5]||(e[5]=s("span",{class:"bean-legend wrong"},null,-1)),x(" éŒ¯èª¤ "+n(c.value.result.wrongCount),1)]),s("span",$e,[e[6]||(e[6]=s("span",{class:"bean-legend missed"},null,-1)),x(" éºæ¼ "+n(c.value.result.missedCount),1)])]),s("div",Ge,[s("div",Le,[(u(!0),o(M,null,I(z(c.value.text.content),(t,r)=>(u(),o("span",{key:r,class:"char-unit"},[s("span",Oe,n(t),1),r<z(c.value.text.content).length-1&&D(r)!=="none"?(u(),o("span",{key:0,class:p(["bean-slot",D(r)])},[...e[7]||(e[7]=[s("span",{class:"bean"},null,-1)])],2)):m("",!0)]))),128))])]),e[8]||(e[8]=re('<div class="answer-legend" data-v-f6919dfa><span class="legend-item" data-v-f6919dfa><span class="bean-legend correct" data-v-f6919dfa></span> æ­£ç¢º </span><span class="legend-item" data-v-f6919dfa><span class="bean-legend wrong" data-v-f6919dfa></span> éŒ¯èª¤ </span><span class="legend-item" data-v-f6919dfa><span class="bean-legend missed" data-v-f6919dfa></span> éºæ¼ </span></div>',1))])):m("",!0)])):m("",!0),l.value?.game_mode==="team_battle"?(u(),o("section",qe,[e[10]||(e[10]=s("h2",null,"éšŠä¼æ’è¡Œ",-1)),s("div",Ee,[(u(!0),o(M,null,I(H.value,(t,r)=>(u(),o("div",{key:t.id,class:p(["team-ranking-item",{winner:r===0}]),style:E({"--team-primary":F(U)[t.team_color].primary,"--team-secondary":F(U)[t.team_color].secondary})},[s("span",Ue,n(r===0?"ğŸ†":r+1),1),s("span",je,n(t.team_name),1),s("span",Je,n(t.averageScore.toFixed(2))+" åˆ†",1)],6))),128))])])):m("",!0),s("section",We,[e[11]||(e[11]=s("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),s("div",{class:"rank-title-display",style:E({color:G.value.color})},n(G.value.title),5),s("p",He,"Lv."+n($.value),1)]),s("footer",{class:"result-footer"},[s("button",{class:"btn-secondary",onClick:X}," è¿”å›é¬¥è±† "),s("button",{class:"btn-primary",onClick:Y}," å†ä¾†ä¸€å±€ ")])],2))}}),st=oe(Ke,[["__scopeId","data-v-f6919dfa"]]);export{st as default};
