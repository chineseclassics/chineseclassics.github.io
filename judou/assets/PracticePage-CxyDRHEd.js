import{d as Ee,u as De,r as d,c as T,p as Fe,o as Ue,y as Ge,a as i,b as a,e as b,t as r,g as p,k as Xe,z as je,n as y,A as he,B as Oe,F as m,i as E,C as We,m as He,l as Qe,D as Je,q as l,_ as Ke}from"./index-NMamGxrH.js";import{u as Ye,a as Ze}from"./practiceLibraryStore-CWWaGshF.js";import{u as et}from"./assignmentStore-CWZXy1HZ.js";import{u as tt}from"./userStatsStore-rsPwzsHF.js";import{u as st}from"./classStore-Bpp5aAMq.js";import"./useSupabase-BbhfJ4PA.js";const at={class:"practice-shell"},lt={class:"picker-section edamame-glass"},nt={class:"picker-current"},it={class:"picker-info"},ot={class:"picker-breadcrumb"},rt={key:0,class:"picker-meta"},ut={key:0},ct={key:0,class:"picker-panel"},dt={class:"picker-search"},vt={key:0,class:"picker-results"},mt={key:0,class:"picker-empty"},pt=["onClick"],ft={class:"item-main"},ht={class:"item-title"},_t={class:"item-author"},yt={class:"item-preview"},kt={key:1,class:"picker-cascade"},gt={class:"cascade-row"},bt={class:"cascade-select full-width"},Tt=["value"],wt={class:"picker-list"},Ct={key:0,class:"picker-empty"},St={key:1,class:"picker-empty"},xt=["onClick"],At={class:"item-main"},Bt={class:"item-title"},Rt={class:"item-author"},Vt={class:"item-preview"},It={class:"hero-actions"},$t=["disabled"],zt={class:"board-card edamame-glass"},Nt={key:0,class:"practice-board"},Pt={class:"board-header"},Mt={class:"board-header-right"},qt={key:1,class:"timer-badge"},Lt={key:0,class:"practice-line"},Et=["onClick","aria-label"],Dt={key:0,class:"bean"},Ft={key:1,class:"state-info"},Ut={class:"board-actions"},Gt=["disabled"],Xt={key:1,class:"board-empty"},jt={class:"results-grid"},Ot={class:"result-card edamame-glass"},Wt={class:"result-desc"},Ht={key:0,class:"new-record"},Qt={key:1},Jt={class:"result-card edamame-glass"},Kt={class:"result-desc"},Yt={class:"result-card edamame-glass"},Zt={class:"result-desc"},es={class:"result-card edamame-glass"},ts={class:"result-desc"},ss=Ee({__name:"PracticePage",setup(as){const ee=Fe(),w=Ye(),X=Ze(),_e=et(),_=De(),j=tt(),te=st(),se=d(new Set),O=T(()=>ee.query.assignmentId),ae=T(()=>ee.query.textId),u=d(null),k=d([]),C=d(new Set),f=d(new Set),o=d(null),B=d(0),g=d(null),W=d(!1),v=d(0),$=d(0),D=d(0),H=d(!1),Q=d(!1),le=T(()=>C.value.size),ye=T(()=>f.value.size),ne=T(()=>Math.max(0,le.value-ye.value)),ie=T(()=>ne.value>0),z=d(!1),S=d(null),A=d(""),ke=d(localStorage.getItem("judou_username")||"guest"),ge=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡"),R=d(!1);let N=null;const x=d(null);function oe(){x.value||(x.value=new(window.AudioContext||window.webkitAudioContext))}function J(t){if(x.value||oe(),!x.value)return;const e=x.value,n=e.createOscillator(),s=e.createGain();n.connect(s),s.connect(e.destination),t==="add"?(n.frequency.setValueAtTime(400,e.currentTime),n.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),n.start(e.currentTime),n.stop(e.currentTime+.1)):(n.frequency.setValueAtTime(300,e.currentTime),n.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),n.start(e.currentTime),n.stop(e.currentTime+.08))}function re(t=10){navigator.vibrate&&navigator.vibrate(t)}const K=T(()=>X.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index));function Y(t){return!!(t.is_system===!0||t.created_by===_.user?.id||_.isStudent&&t.created_by&&se.value.has(t.created_by))}const ue=T(()=>S.value?w.texts.filter(t=>t.category_id!==S.value?!1:Y(t)).sort((t,e)=>t.title.localeCompare(e.title)):[]),ce=T(()=>{if(!A.value.trim())return[];const t=A.value.toLowerCase();return w.texts.filter(e=>Y(e)?e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t):!1).slice(0,10)}),be=T(()=>{if(!u.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];return u.value.category?.name&&t.push(u.value.category.name),t.push(u.value.title),t.join(" â€º ")});async function Te(){if(!_.isStudent||!_.isAuthenticated)return;await te.fetchStudentClasses();const t=new Set;for(const e of te.classes)e.teacher_id&&t.add(e.teacher_id);se.value=t}function we(t){const e=[],n=new Set;let s=0;for(const c of t)c==="|"?s>0&&n.add(s-1):c!==`
`&&c!=="\r"&&(e.push(c),s++);return{chars:e,breaks:n}}function Ce(){F(),B.value=0,N=window.setInterval(()=>{B.value+=1},1e3)}function F(){N&&(clearInterval(N),N=null)}function de(t){const{chars:e,breaks:n}=we(t.content);k.value=e,C.value=n,f.value=new Set,o.value=null,g.value=null,F(),B.value=0,v.value=0,$.value=0,D.value=0,H.value=!1}function U(t){u.value=t,de(t),z.value=!1,A.value="",t.category_id&&(S.value=t.category_id)}function ve(){const t=w.texts.filter(s=>s.text_type==="practice"&&Y(s));if(!t.length){g.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}const e=Math.floor(Math.random()*t.length),n=t[e];n&&U(n)}async function Se(){const t=[];if(w.texts.length||t.push(w.fetchTexts()),X.state.categories.length||t.push(X.fetchLibrary()),_.isStudent&&_.isAuthenticated&&t.push(Te()),await Promise.all(t),ae.value&&O.value){const e=w.texts.find(n=>n.id===ae.value);if(e){U(e);return}}if(!u.value&&w.texts.length&&ve(),!S.value&&K.value.length){const e=K.value[0];e&&(S.value=e.id)}}function xe(t){if(o.value?.isComplete){g.value="å·²å®Œæˆï¼å¦‚è¦é‡æ–°ç·´ç¿’è«‹é»æ“Šé‡æ–°é–‹å§‹ã€‚";return}o.value&&!o.value.isComplete&&(o.value=null);const e=new Set(f.value),n=e.has(t);if(!n&&!ie.value){Ae(),g.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}f.value.size===0&&!N&&!H.value&&Ce(),n?(e.delete(t),J("remove")):(e.add(t),J("add"),re(10)),f.value=e,g.value=null}function Ae(){Q.value=!0,J("remove"),re(50),setTimeout(()=>{Q.value=!1},400)}function Be(t){if(!o.value){const e=t>0&&f.value.has(t-1),n=f.value.has(t);if(e&&n)return"translateX(0)";if(e)return"translateX(4px)";if(n)return"translateX(-4px)"}return"translateX(0)"}function Re(t){const e=[],n=f.value.has(t);if(n&&e.push("has-bean"),o.value&&n){const s=o.value.statuses.find(c=>c.index===t);s&&(s.state==="correct"||s.state==="extra")&&e.push(s.state)}return e}function Ve(t){return`${t} è±†`}function me(t){return`${Math.round(t*100)}%`}function pe(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function Ie(t,e,n){return j.calculateScore({breakCount:C.value.size,charCount:k.value.length,elapsedSeconds:t,attemptCount:e,isFirstClear:n})}async function $e(){if(!u.value)return;if(!f.value.size){g.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}v.value++;const t=[];let e=0,n=0,s=0;for(let h=0;h<=k.value.length;h++){const q=f.value.has(h),I=C.value.has(h);q&&I?(t.push({index:h,state:"correct"}),e++):!q&&I?(t.push({index:h,state:"missed"}),n++):q&&!I?(t.push({index:h,state:"extra"}),s++):t.push({index:h,state:"pending"})}const c=C.value.size?e/C.value.size:f.value.size?0:1,V=n===0&&s===0;v.value===1&&($.value=c,D.value=B.value,F(),H.value=!0);const Z=D.value||B.value;let M=!1;V&&_.isAuthenticated&&(M=await j.checkFirstClear(u.value.id));const{score:G,breakdown:qe}=V?Ie(Z,v.value,M):{score:0,breakdown:void 0};if(o.value={statuses:t,accuracy:c,elapsed:Z,score:G,isComplete:V,breakdown:qe,isFirstClear:M},V){ze();let h=v.value===1?"ğŸ‰ ä¸€æ¬¡éé—œï¼å¤ªå²å®³äº†ï¼":`âœ… å®Œæˆï¼å…±å˜—è©¦ ${v.value} æ¬¡`;M&&(h+=" ğŸŒŸ é¦–æ¬¡å®Œæˆçå‹µï¼"),g.value=h}else g.value=`é‚„æœ‰ ${n} å€‹éºæ¼ã€${s} å€‹å¤šé¤˜ï¼Œè«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤`;if(V)try{W.value=!0;const h=_.isAuthenticated?_.user?.email?.split("@")[0]||"user":ke.value,q=_.isAuthenticated?_.displayName:ge.value,I=await w.recordPracticeResult({text_id:u.value.id,score:G,accuracy:$.value,elapsed_seconds:Z,user_breaks:f.value.size,correct_breaks:C.value.size,username:h,display_name:q,user_id:_.user?.id||null});if(_.isAuthenticated){const L=await j.recordPracticeScore({textId:u.value.id,score:G,isFirstClear:M});if(o.value&&(o.value.beansEarned=L.beansEarned,o.value.isNewRecord=L.isNewRecord),L.beansEarned>0){const Le=L.isNewRecord?" (æ–°ç´€éŒ„!)":"";g.value=`${g.value} ç²å¾— ${L.beansEarned} è±†${Le}`}}O.value&&_.isAuthenticated&&I&&await _e.recordCompletion(O.value,I,G,$.value*100)}catch(h){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",h)}finally{W.value=!1}}function ze(){if(x.value||oe(),!x.value)return;const t=x.value,e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function Ne(){if(!k.value.length)return[];const t=[];let e="",n=-1;for(let s=0;s<k.value.length;s++)if(e+=k.value[s],C.value.has(s)){const c=s-n;n=s,c>=8?(e+="ã€‚",t.push(e),e=""):c>=4?e+="ï¼Œ":e+="ã€"}return e.trim()&&(!e.endsWith("ã€‚")&&!e.endsWith("ï¼Œ")&&!e.endsWith("ã€")&&(e+="ã€‚"),t.push(e)),t.length===0&&k.value.length>0?[k.value.join("")+"ã€‚"]:t}let P=!1;function fe(){P=!0,typeof window<"u"&&window.taixuStopSpeak&&window.taixuStopSpeak(),R.value=!1}async function Pe(){if(!k.value.length)return;if(R.value){fe();return}if(typeof window>"u"||!window.taixuSpeak){alert("èªéŸ³æœ—è®€åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦");return}R.value=!0,P=!1;const t=Ne();try{for(let e=0;e<t.length&&!P;e++)await window.taixuSpeak(t[e],{voice:"zh-CN-XiaoxiaoNeural",rate:.8})}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),P||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{R.value=!1,P=!1}}function Me(){u.value&&de(u.value)}return Ue(()=>{Se()}),Ge(()=>{F(),fe()}),(t,e)=>{const n=He("router-link");return l(),i("div",at,[a("section",lt,[a("div",{class:"picker-header",onClick:e[1]||(e[1]=s=>z.value=!z.value)},[a("div",nt,[e[4]||(e[4]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",it,[a("span",ot,r(be.value),1),u.value?(l(),i("span",rt,[p(r(u.value.author||"ä½šå")+" ",1),u.value.source?(l(),i("span",ut," Â· "+r(u.value.source),1)):b("",!0),u.value.source_text?.id?(l(),Xe(n,{key:1,to:{name:"reading-detail",params:{id:u.value.source_text.id}},class:"source-link",onClick:e[0]||(e[0]=je(()=>{},["stop"]))},{default:Qe(()=>[p(" Â· ä¾†è‡ªã€Š"+r(u.value.source_text.title)+"ã€‹ ",1)]),_:1},8,["to"])):b("",!0)])):b("",!0)])]),a("button",{class:y(["picker-toggle",{expanded:z.value}])},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),z.value?(l(),i("div",ct,[a("div",dt,[he(a("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>A.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Oe,A.value]])]),A.value.trim()?(l(),i("div",vt,[ce.value.length?b("",!0):(l(),i("div",mt," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+r(A.value)+"ã€çš„æ–‡ç«  ",1)),(l(!0),i(m,null,E(ce.value,s=>(l(),i("div",{key:s.id,class:"picker-item",onClick:c=>U(s)},[a("div",ft,[a("span",ht,r(s.title),1),a("span",_t,r(s.author||"ä½šå"),1)]),a("span",yt,r(pe(s)),1)],8,pt))),128))])):(l(),i("div",kt,[a("div",gt,[a("div",bt,[e[7]||(e[7]=a("label",null,"å¹´ç´š",-1)),he(a("select",{"onUpdate:modelValue":e[3]||(e[3]=s=>S.value=s)},[e[6]||(e[6]=a("option",{value:null,disabled:""},"é¸æ“‡å¹´ç´š",-1)),(l(!0),i(m,null,E(K.value,s=>(l(),i("option",{key:s.id,value:s.id},r(s.name),9,Tt))),128))],512),[[We,S.value]])])]),a("div",wt,[S.value?ue.value.length?b("",!0):(l(),i("div",St," æ­¤å¹´ç´šå°šç„¡æ–‡ç«  ")):(l(),i("div",Ct," è«‹é¸æ“‡å¹´ç´šä»¥æŸ¥çœ‹æ–‡ç«  ")),(l(!0),i(m,null,E(ue.value,s=>(l(),i("div",{key:s.id,class:y(["picker-item",{active:u.value?.id===s.id}]),onClick:c=>U(s)},[a("div",At,[a("span",Bt,r(s.title),1),a("span",Rt,r(s.author||"ä½šå"),1),a("span",{class:y(["item-difficulty",`diff-${s.difficulty}`])},r(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",Vt,r(pe(s)),1)],10,xt))),128))])]))])):b("",!0)]),a("div",It,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Me,disabled:!u.value}," é‡æ–°é–‹å§‹ ",8,$t),a("button",{class:"edamame-btn edamame-btn-primary",onClick:ve}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",zt,[u.value?(l(),i("div",Nt,[a("div",Pt,[e[8]||(e[8]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Mt,[o.value?.isComplete?(l(),i("button",{key:0,class:y(["tts-btn-small",{playing:R.value}]),onClick:Pe},r(R.value?"â¹ åœæ­¢":"ğŸ”Š æœ—è®€"),3)):b("",!0),a("div",{class:y(["bean-inventory",{shake:Q.value,empty:!ie.value}])},[(l(!0),i(m,null,E(le.value,s=>(l(),i("span",{key:s,class:y(["inventory-bean",{used:s>ne.value}])},null,2))),128))],2),f.value.size>0||o.value?(l(),i("span",qt,"â± "+r(B.value)+" ç§’",1)):b("",!0)])]),k.value.length?(l(),i("div",Lt,[(l(!0),i(m,null,E(k.value,(s,c)=>(l(),i("span",{key:c,class:"char-unit"},[a("span",{class:"char",style:Je({transform:Be(c)})},r(s),5),c<k.value.length-1?(l(),i("button",{key:0,class:y(["bean-slot",Re(c)]),onClick:V=>xe(c),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${f.value.has(c)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[f.value.has(c)?(l(),i("span",Dt)):b("",!0),e[9]||(e[9]=a("span",{class:"bean-hint"},null,-1))],10,Et)):b("",!0)]))),128))])):(l(),i("div",Ft,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",Ut,[a("button",{class:y(["edamame-btn edamame-btn-lg",o.value?.isComplete?"edamame-btn-success":"edamame-btn-primary"]),disabled:W.value||o.value?.isComplete,onClick:$e},[o.value?.isComplete?(l(),i(m,{key:0},[p(" âœ“ å®Œæˆï¼ ")],64)):v.value>0?(l(),i(m,{key:1},[p(" å†æ¬¡æäº¤ ("+r(v.value+1)+") ",1)],64)):(l(),i(m,{key:2},[p(" æäº¤ç­”æ¡ˆ ")],64))],10,Gt)]),g.value?(l(),i("p",{key:2,class:y(["toast",{success:o.value?.isComplete}])},r(g.value),3)):b("",!0)])):(l(),i("div",Xt,[...e[10]||(e[10]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",jt,[a("article",Ot,[e[11]||(e[11]=a("p",{class:"result-label"},"å¾—åˆ†",-1)),a("p",{class:y(["result-value",{placeholder:!o.value?.isComplete}])},r(o.value?.isComplete?Ve(o.value.score):"--"),3),a("p",Wt,[o.value?.isComplete&&o.value?.beansEarned!==void 0?(l(),i(m,{key:0},[o.value.isNewRecord?(l(),i("span",Ht,"ğŸ† æ–°ç´€éŒ„ï¼")):(l(),i("span",Qt,"å·²æ˜¯æœ€é«˜åˆ†")),p(" +"+r(o.value.beansEarned)+" è±† ",1)],64)):o.value?.isComplete&&v.value>1?(l(),i(m,{key:1},[p(" å˜—è©¦ "+r(v.value)+" æ¬¡å¾Œå®Œæˆ ",1)],64)):(l(),i(m,{key:2},[p(" å…¨å°å¾Œé¡¯ç¤ºæœ€çµ‚å¾—åˆ† ")],64))])]),a("article",Jt,[e[12]||(e[12]=a("p",{class:"result-label"},"é¦–æ¬¡æ­£ç¢ºç‡",-1)),a("p",{class:y(["result-value",{placeholder:v.value===0}])},r(v.value>0?me($.value):"--"),3),a("p",Kt,[v.value>0&&!o.value?.isComplete?(l(),i(m,{key:0},[p(" ç•¶å‰ï¼š"+r(me(o.value?.accuracy||0)),1)],64)):(l(),i(m,{key:1},[p(" åæ˜ çœŸå¯¦æ°´å¹³ ")],64))])]),a("article",Yt,[e[13]||(e[13]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:y(["result-value",{placeholder:v.value===0}])},r(v.value>0?`${D.value} ç§’`:"--"),3),a("p",Zt,[o.value?.isComplete&&o.value?.breakdown?(l(),i(m,{key:0},[p(" æ™‚é–“ä¿‚æ•¸ï¼šÃ—"+r(o.value.breakdown.timeFactor),1)],64)):v.value>0?(l(),i(m,{key:1},[p(" é¦–æ¬¡æäº¤æ™‚è¨˜éŒ„ ")],64)):(l(),i(m,{key:2},[p(" è¨ˆæ™‚è‡³é¦–æ¬¡æäº¤ ")],64))])]),a("article",es,[e[14]||(e[14]=a("p",{class:"result-label"},"å˜—è©¦æ¬¡æ•¸",-1)),a("p",{class:y(["result-value",{placeholder:v.value===0}])},r(v.value>0?v.value:"--"),3),a("p",ts,[o.value?.isComplete&&o.value?.breakdown?(l(),i(m,{key:0},[p(" å˜—è©¦ä¿‚æ•¸ï¼šÃ—"+r(o.value.breakdown.attemptFactor),1)],64)):o.value?.isComplete?(l(),i(m,{key:1},[p(r(v.value===1?"ä¸€æ¬¡éé—œï¼":"å …æŒå°±æ˜¯å‹åˆ©"),1)],64)):(l(),i(m,{key:2},[p(" å¯å¤šæ¬¡å˜—è©¦ç›´åˆ°å…¨å° ")],64))])])])])}}}),cs=Ke(ss,[["__scopeId","data-v-d8e9a4f3"]]);export{cs as default};
