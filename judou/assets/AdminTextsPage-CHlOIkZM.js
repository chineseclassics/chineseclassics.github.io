import{d as ue,u as ce,c as k,p as ve,r as b,D as Y,o as me,a as n,b as t,k as j,t as o,f as U,g as q,F as $,i as A,e as _,s as R,l as J,T as K,E as Q,n as E,G as h,q as a,z as T,A as S,_ as pe}from"./index-B8YqwLIR.js";import{u as fe,a as ye}from"./practiceLibraryStore-xNdAIPDT.js";import"./useSupabase-Cgbg2zc5.js";const be={class:"admin-shell"},_e={class:"admin-header"},he={class:"edamame-text-level-detail"},ge={class:"edamame-heading-gradient"},ke={class:"header-actions"},Ce=["disabled"],xe=["disabled"],we={class:"admin-layout"},$e={class:"category-sidebar edamame-glass"},Te={class:"sidebar-header"},Se={key:0,class:"sidebar-loading"},Me={key:1,class:"sidebar-empty"},Ve={key:2,class:"category-tree"},Le=["onClick"],De=["onClick"],Fe={class:"tree-label"},Be={class:"tree-count"},Ue={class:"tree-actions"},Ae=["onClick"],Ee=["onClick"],Ge=["onClick"],Ie={key:0,class:"tree-children"},Ne=["onClick"],Oe={class:"tree-label"},ze={class:"tree-count"},Pe={class:"tree-actions"},He=["onClick"],je=["onClick"],qe=["onClick"],Re={class:"content-panel edamame-glass"},Je={key:0,class:"content-empty"},Ke={class:"content-breadcrumb"},Qe=["onClick"],We={key:0,class:"breadcrumb-sep"},Xe={class:"category-info"},Ye={key:0,class:"category-desc"},Ze={class:"category-meta"},et={key:0,class:"module-grid"},tt=["onClick"],lt={class:"module-desc"},st={class:"module-count"},at={key:1,class:"text-list"},nt={key:0,class:"text-empty"},ot={key:1},it={class:"text-title"},dt={key:0,class:"text-type-badge system"},rt={key:1,class:"text-type-badge private"},ut={class:"text-summary"},ct={class:"actions"},vt=["onClick"],mt=["onClick"],pt={class:"modal-card edamame-glass"},ft={class:"modal-body"},yt={class:"form-context"},bt={class:"form-row"},_t={class:"preview-panel"},ht=["innerHTML"],gt={key:0,class:"feedback"},kt=["disabled"],Ct={class:"modal-card edamame-glass small-modal"},xt={class:"modal-body"},wt=["placeholder"],$t={key:0,class:"feedback"},Tt=["disabled"],St={class:"modal-card edamame-glass small-modal"},Mt={key:0,class:"feedback"},Vt={class:"confirm-actions"},Lt=["disabled"],Dt=ue({__name:"AdminTextsPage",setup(Ft){const Z=ve(),m=fe(),v=ye(),M=ce(),g=k(()=>Z.meta.mode==="admin"),ee=k(()=>g.value?"系統文庫":"自訂練習"),te=k(()=>g.value?"管理系統內建的練習文章":"管理我的自訂練習文章"),f=b(null),C=b(new Set),x=b(!1),w=b(!1),V=b(!1),p=b(!1),L=b(null),D=b(null),y=b(null),u=b(null),i=Y({title:"",author:"",source:"",summary:"",content:""}),d=Y({name:"",description:"",parentId:null,type:"grade"}),G=k(()=>v.state.categories.filter(l=>l.level!==1?!1:g.value?l.is_system===!0:l.is_system===!1&&l.created_by===M.user?.id).sort((l,e)=>l.order_index-e.order_index)),c=k(()=>v.state.categories.find(l=>l.id===f.value)??null),I=k(()=>{if(!c.value)return[];const l=[];let e=c.value;for(;e;)l.unshift(e),e=v.state.categories.find(s=>s.id===e?.parent_id);return l}),O=k(()=>{if(!f.value)return[];let l=m.texts.filter(e=>e.category_id===f.value);return g.value?l=l.filter(e=>e.is_system===!0):l=l.filter(e=>e.is_system===!1&&e.created_by===M.user?.id),l.sort((e,s)=>(s.created_at??"").localeCompare(e.created_at??""))}),le=k(()=>{if(!i.content)return"";let l=i.content.replace(/[「」『』"""'']/g,"");return l=l.replace(/[。！？；，：、]/g,"|"),l=l.replace(/\|{2,}/g,"|"),l=l.replace(/^\|+|\|+$/g,""),l.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function F(l){return v.state.categories.filter(e=>e.level!==2||e.parent_id!==l?!1:g.value?e.is_system===!0:e.is_system===!1&&e.created_by===M.user?.id).sort((e,s)=>e.order_index-s.order_index)}function W(l){return g.value?m.texts.filter(e=>e.category_id===l&&e.is_system===!0).length:m.texts.filter(e=>e.category_id===l&&e.is_system===!1&&e.created_by===M.user?.id).length}function se(l){C.value.has(l)?C.value.delete(l):C.value.add(l)}function N(l){f.value=l;const e=v.state.categories.find(s=>s.id===l);e?.parent_id&&C.value.add(e.parent_id)}function z(){L.value=null,i.title="",i.author="",i.source="",i.summary="",i.content="",u.value=null,x.value=!0}function ae(l){L.value=l.id,i.title=l.title,i.author=l.author??"",i.source=l.source??"",i.summary=l.summary??"",i.content=l.content,u.value=null,x.value=!0}async function ne(){if(!i.title||!i.content){u.value="標題與內容為必填";return}if(!f.value){u.value="請先選擇一個分類";return}const l=c.value;if(!l||l.level!==2){u.value="請選擇一個單元（而非年級）來新增文章";return}try{p.value=!0;const e={title:i.title,author:i.author||null,source:i.source||null,summary:i.summary||null,category_id:f.value,content:i.content};L.value?await m.updateText(L.value,e):await m.addText(e,g.value),await m.fetchTexts(),x.value=!1}catch(e){u.value=e?.message??"儲存失敗"}finally{p.value=!1}}function B(l,e){D.value=null,d.name="",d.description="",d.parentId=l,d.type=e,u.value=null,w.value=!0}function X(l){D.value=l,d.name=l.name,d.description=l.description??"",d.parentId=l.parent_id,d.type=l.level===1?"grade":"module",u.value=null,w.value=!0}async function oe(){if(!d.name.trim()){u.value="名稱不可為空";return}try{p.value=!0,D.value?await v.updateCategory(D.value.id,{name:d.name.trim(),description:d.description.trim()||void 0}):await v.addCategory({name:d.name.trim(),parent_id:d.parentId,type:d.type,description:d.description.trim()||void 0,is_system:g.value},M.user?.id),w.value=!1}catch(l){u.value=l?.message??"儲存失敗"}finally{p.value=!1}}function P(l,e){y.value={type:l,item:e},u.value=null,V.value=!0}async function ie(){if(y.value)try{p.value=!0,y.value.type==="text"?(await m.deleteText(y.value.item.id),await m.fetchTexts()):(await v.deleteCategory(y.value.item.id),f.value===y.value.item.id&&(f.value=null)),V.value=!1,y.value=null}catch(l){u.value=l?.message??"刪除失敗"}finally{p.value=!1}}function de(l){return l?l===1?"初級":l===2?"中級":"高級":"未標註"}function re(l){return l?new Date(l).toLocaleDateString():"--"}return me(async()=>{if(v.state.categories.length||await v.fetchLibrary(),m.texts.length||await m.fetchTexts(),G.value.length>0){const l=G.value[0];if(l){C.value.add(l.id);const e=F(l.id)[0];e&&(f.value=e.id)}}}),(l,e)=>(a(),n("div",be,[t("header",_e,[t("div",null,[t("p",he,o(te.value),1),t("h1",ge,o(ee.value),1)]),t("div",ke,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[0]||(e[0]=s=>{U(v).fetchLibrary(),U(m).fetchTexts()}),disabled:U(v).isLoading||U(m).isLoading}," 重新整理 ",8,Ce),t("button",{class:"edamame-btn edamame-btn-primary",onClick:z,disabled:!c.value||c.value.level!==2}," 新增練習 ",8,xe)])]),t("div",we,[t("aside",$e,[t("div",Te,[e[19]||(e[19]=t("span",{class:"sidebar-title"},"分類導航",-1)),t("button",{class:"icon-btn",onClick:e[1]||(e[1]=s=>B(null,"grade")),title:"新增年級"},[...e[18]||(e[18]=[t("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M12 5v14M5 12h14"})],-1)])])]),U(v).isLoading?(a(),n("div",Se,"載入中⋯")):G.value.length?(a(),n("nav",Ve,[(a(!0),n($,null,A(G.value,s=>(a(),n("div",{key:s.id,class:"tree-node"},[t("div",{class:E(["tree-item grade-item",{selected:f.value===s.id}]),onClick:r=>N(s.id)},[t("button",{class:"expand-btn",onClick:h(r=>se(s.id),["stop"])},[(a(),n("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",class:E({expanded:C.value.has(s.id)})},[...e[21]||(e[21]=[t("path",{d:"M8 5l8 7-8 7V5z"},null,-1)])],2))],8,De),t("span",Fe,o(s.name),1),t("span",Be,o(F(s.id).length),1),t("div",Ue,[t("button",{class:"action-btn",onClick:h(r=>B(s.id,"module"),["stop"]),title:"新增單元"},"+",8,Ae),t("button",{class:"action-btn",onClick:h(r=>X(s),["stop"]),title:"編輯"},"✎",8,Ee),t("button",{class:"action-btn danger",onClick:h(r=>P("category",s),["stop"]),title:"刪除"},"×",8,Ge)])],10,Le),C.value.has(s.id)?(a(),n("div",Ie,[(a(!0),n($,null,A(F(s.id),r=>(a(),n("div",{key:r.id,class:E(["tree-item module-item",{selected:f.value===r.id}]),onClick:H=>N(r.id)},[t("span",Oe,o(r.name),1),t("span",ze,o(W(r.id)),1),t("div",Pe,[t("button",{class:"action-btn",onClick:h(H=>X(r),["stop"]),title:"編輯"},"✎",8,He),t("button",{class:"action-btn danger",onClick:h(H=>P("category",r),["stop"]),title:"刪除"},"×",8,je)])],10,Ne))),128)),t("button",{class:"add-module-btn",onClick:r=>B(s.id,"module")}," + 新增單元 ",8,qe)])):_("",!0)]))),128))])):(a(),n("div",Me,[e[20]||(e[20]=q(" 尚無分類 ",-1)),t("button",{class:"link-btn",onClick:e[2]||(e[2]=s=>B(null,"grade"))},"建立第一個年級")]))]),t("main",Re,[c.value?(a(),n($,{key:1},[t("div",Ke,[(a(!0),n($,null,A(I.value,(s,r)=>(a(),n("span",{key:s.id,class:E(["breadcrumb-item",{active:r===I.value.length-1}]),onClick:H=>N(s.id)},[q(o(s.name)+" ",1),r<I.value.length-1?(a(),n("span",We,"›")):_("",!0)],10,Qe))),128))]),t("div",Xe,[t("h2",null,o(c.value.name),1),c.value.description?(a(),n("p",Ye,o(c.value.description),1)):_("",!0),t("p",Ze,o(c.value.level===1?"年級":"單元")+" · "+o(c.value.level===1?`${F(c.value.id).length} 個單元`:`${O.value.length} 篇文章`),1)]),c.value.level===1?(a(),n("div",et,[(a(!0),n($,null,A(F(c.value.id),s=>(a(),n("div",{key:s.id,class:"module-card",onClick:r=>N(s.id)},[t("h3",null,o(s.name),1),t("p",lt,o(s.description||"暫無描述"),1),t("p",st,o(W(s.id))+" 篇文章",1)],8,tt))),128)),t("button",{class:"module-card add-card",onClick:e[3]||(e[3]=s=>B(c.value.id,"module"))},[...e[23]||(e[23]=[t("span",{class:"add-icon"},"+",-1),t("span",null,"新增單元",-1)])])])):(a(),n("div",at,[O.value.length?(a(),n("table",ot,[e[25]||(e[25]=t("thead",null,[t("tr",null,[t("th",null,"標題"),t("th",null,"作者"),t("th",null,"難度"),t("th",null,"建立日期"),t("th",{style:{width:"120px"}},"操作")])],-1)),t("tbody",null,[(a(!0),n($,null,A(O.value,s=>(a(),n("tr",{key:s.id},[t("td",null,[t("p",it,[q(o(s.title)+" ",1),s.is_system?(a(),n("span",dt,"系統")):(a(),n("span",rt,"私有"))]),t("p",ut,o(s.summary||s.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),t("td",null,o(s.author||"佚名"),1),t("td",null,[t("span",{class:E(["difficulty-badge",`diff-${s.difficulty}`])},o(de(s.difficulty)),3)]),t("td",null,o(re(s.created_at)),1),t("td",ct,[t("button",{class:"ghost-btn",onClick:r=>ae(s)},"編輯",8,vt),t("button",{class:"ghost-btn danger",onClick:r=>P("text",s)},"刪除",8,mt)])]))),128))])])):(a(),n("div",nt,[e[24]||(e[24]=t("p",null,"此單元尚無文章",-1)),t("button",{class:"edamame-btn edamame-btn-primary",onClick:z},"新增第一篇文章")])),t("button",{class:"add-text-btn",onClick:z}," + 在「"+o(c.value.name)+"」新增文章 ",1)]))],64)):(a(),n("div",Je,[...e[22]||(e[22]=[t("p",null,"請從左側選擇一個分類",-1)])]))])]),(a(),j(Q,{to:"body"},[R(K,{name:"fade"},{default:J(()=>[x.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:e[10]||(e[10]=h(s=>x.value=!1,["self"]))},[t("div",pt,[t("header",null,[t("h3",null,o(L.value?"編輯文章":"新增文章"),1),t("button",{class:"close-btn",onClick:e[4]||(e[4]=s=>x.value=!1)},"×")]),t("div",ft,[t("p",yt,"將新增至："+o(I.value.map(s=>s.name).join(" › ")),1),t("label",null,[e[26]||(e[26]=t("span",null,"標題",-1)),T(t("input",{"onUpdate:modelValue":e[5]||(e[5]=s=>i.title=s),type:"text",placeholder:"請輸入標題"},null,512),[[S,i.title]])]),t("div",bt,[t("label",null,[e[27]||(e[27]=t("span",null,"作者",-1)),T(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>i.author=s),type:"text",placeholder:"例如：孔子"},null,512),[[S,i.author]])]),t("label",null,[e[28]||(e[28]=t("span",null,"來源",-1)),T(t("input",{"onUpdate:modelValue":e[7]||(e[7]=s=>i.source=s),type:"text",placeholder:"例如：論語"},null,512),[[S,i.source]])])]),t("label",null,[e[29]||(e[29]=t("span",null,"內容（標點將自動轉為斷句符號）",-1)),T(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=s=>i.content=s),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[S,i.content]])]),t("div",_t,[e[30]||(e[30]=t("p",null,"預覽",-1)),t("div",{class:"preview-content",innerHTML:le.value||"尚無內容"},null,8,ht)]),u.value?(a(),n("p",gt,o(u.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[9]||(e[9]=s=>x.value=!1)},"取消"),t("button",{class:"edamame-btn edamame-btn-primary",disabled:p.value,onClick:ne},o(p.value?"儲存中...":"儲存"),9,kt)])])])):_("",!0)]),_:1})])),(a(),j(Q,{to:"body"},[R(K,{name:"fade"},{default:J(()=>[w.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:e[15]||(e[15]=h(s=>w.value=!1,["self"]))},[t("div",Ct,[t("header",null,[t("h3",null,o(D.value?"編輯分類":d.type==="grade"?"新增年級":"新增單元"),1),t("button",{class:"close-btn",onClick:e[11]||(e[11]=s=>w.value=!1)},"×")]),t("div",xt,[t("label",null,[e[31]||(e[31]=t("span",null,"名稱",-1)),T(t("input",{"onUpdate:modelValue":e[12]||(e[12]=s=>d.name=s),type:"text",placeholder:d.type==="grade"?"例如：七年級":"例如：論語讀本"},null,8,wt),[[S,d.name]])]),t("label",null,[e[32]||(e[32]=t("span",null,"描述（選填）",-1)),T(t("textarea",{"onUpdate:modelValue":e[13]||(e[13]=s=>d.description=s),rows:"2",placeholder:"簡述此分類的內容範圍"},null,512),[[S,d.description]])]),u.value?(a(),n("p",$t,o(u.value),1)):_("",!0)]),t("footer",null,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[14]||(e[14]=s=>w.value=!1)},"取消"),t("button",{class:"edamame-btn edamame-btn-primary",disabled:p.value,onClick:oe},o(p.value?"儲存中...":"儲存"),9,Tt)])])])):_("",!0)]),_:1})])),(a(),j(Q,{to:"body"},[R(K,{name:"fade"},{default:J(()=>[V.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:e[17]||(e[17]=h(s=>V.value=!1,["self"]))},[t("div",St,[e[33]||(e[33]=t("h3",null,"確定刪除？",-1)),t("p",null,"「"+o(y.value?.item?"title"in y.value.item?y.value.item.title:y.value.item.name:"")+"」刪除後將無法復原。",1),u.value?(a(),n("p",Mt,o(u.value),1)):_("",!0),t("div",Vt,[t("button",{class:"edamame-btn edamame-btn-secondary",onClick:e[16]||(e[16]=s=>V.value=!1)},"取消"),t("button",{class:"edamame-btn edamame-btn-danger",disabled:p.value,onClick:ie},o(p.value?"刪除中...":"刪除"),9,Lt)])])])):_("",!0)]),_:1})]))]))}}),Et=pe(Dt,[["__scopeId","data-v-11e5bc6d"]]);export{Et as default};
