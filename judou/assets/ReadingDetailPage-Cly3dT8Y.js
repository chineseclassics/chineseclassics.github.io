import{d as fe,u as ve,c as N,x as pe,r as b,f as ge,Q as Y,R as me,w as ke,a as f,g as a,h as k,m as j,t as v,i as m,b as S,q as _e,F as O,j as H,s as Q,y as xe,n as be,O as ye,l as Ce,o as d,_ as we}from"./index-jG-HO5Up.js";import{u as Te}from"./readingStore-DJkIbsI0.js";import{a as W,S as Se,V as Be,c as Pe,b as Re}from"./useClassicalTTS-BSUnPAlP.js";import"./useSupabase-BcZdoFID.js";import"./createLucideIcon-nwbY4kNg.js";const Ee={class:"reading-detail-page"},Me={class:"reading-header edamame-glass"},Ae={class:"header-title"},Le={class:"title-meta"},ze={key:0,class:"author"},Ie={key:1,class:"source-tag"},Ne={class:"header-actions"},Oe={class:"control-bar edamame-glass"},De=["aria-pressed"],Ve={class:"toggle-switch"},$e={key:0,class:"reading-content edamame-glass"},qe={class:"reading-line"},Fe=["data-global-index","onMouseenter","onClick","onTouchend"],Ue=["onClick","disabled"],Xe={key:0,class:"verification-result"},Ye={class:"result-stats"},je={class:"stat correct"},He={class:"stat missed"},Qe={class:"stat extra"},We={class:"stat accuracy"},Ge={class:"content-actions"},Je=["disabled"],Ke={key:1,class:"loading-state edamame-glass"},Ze={class:"tooltip-term"},et={key:0,class:"tooltip-pinyin"},tt={class:"tooltip-content"},nt=fe({__name:"ReadingDetailPage",setup(st){const G=pe(),J=Ce(),i=Te(),D=ve(),E=N(()=>G.params.id),g=b(!0),C=b(new Set),c=b(null),p=b(null),y=b(!1),B=N(()=>{if(!i.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const t=i.currentText.content,e=t.includes("||")?"||":/\n\n+/,n=t.split(e),l=[],u=[],s=new Set;let r=0;for(const o of n){const h=[],x=new Set,X=r,L=o.replace(/[\|\s]+$/,"");for(const R of L)R==="|"?r>0&&(s.add(r-1),x.add(h.length-1)):R!==`
`&&R!=="\r"&&(u.push(R),h.push(R),r++);h.length>0&&l.push({chars:h,breaks:x,startIdx:X,endIdx:r-1})}return{paragraphs:l,allChars:u,allBreaks:s}}),V=N(()=>B.value.paragraphs),K=b(0);function w(t){return i.currentText?.annotations&&i.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const T=b(null),_=b(!1);function Z(t){return T.value?w(t)?.id===T.value:!1}function ee(t){return w(t)?.start_index===t}function te(t){const e=w(t);return e?e.end_index-1===t:!1}function ne(t,e){if(_.value)return;const n=w(t);n&&(T.value=n.id,q(n,e))}function se(){_.value||(T.value=null,M())}function $(t,e){const n=w(t);if(n){if(e.stopPropagation(),p.value&&p.value.annotation.id===n.id){M();return}T.value=n.id,Y(()=>{const l=document.querySelector(`.char[data-global-index="${n.start_index}"]`),u=document.querySelector(`.char[data-global-index="${n.end_index-1}"]`);let s=0,r=0;if(l&&u){const o=l.getBoundingClientRect(),h=u.getBoundingClientRect();s=(o.left+h.right)/2,r=o.top}else if(l){const o=l.getBoundingClientRect();s=o.left+o.width/2,r=o.top}else{const o=e.target;if(o){const h=o.getBoundingClientRect();s=h.left+h.width/2,r=h.top}}q(n,{clientX:s,clientY:r})})}}function ae(t){if(g.value)return;const e=new Set(C.value);e.has(t)?e.delete(t):e.add(t),C.value=e,c.value=null}function oe(){const{allBreaks:t,allChars:e}=B.value;if(!e.length)return;const n=[],l=[],u=[];for(let o=0;o<e.length;o++){const h=t.has(o),x=C.value.has(o);h&&x?n.push(o):h&&!x?l.push(o):!h&&x&&u.push(o)}const s=t.size,r=s>0?n.length/s:1;c.value={correct:n,missed:l,extra:u,accuracy:r}}function re(){g.value=!0,c.value=null}function ie(){C.value=new Set,c.value=null}function q(t,e){p.value={annotation:t,x:e.clientX,y:e.clientY}}function M(){T.value=null,p.value=null}function A(t){if(!_.value||!p.value)return;const e=t.target;!e.closest(".char.has-annotation")&&!e.closest(".annotation-tooltip")&&M()}function F(){const{allChars:t,allBreaks:e,paragraphs:n}=B.value;if(!t.length)return[];const l=[];for(const u of n){let s="",r=u.startIdx-1;for(let o=u.startIdx;o<=u.endIdx;o++){const h=o-u.startIdx;s+=u.chars[h];const x=e.has(o);if(o===u.endIdx)s+="。";else if(x){const L=o-r;r=o,L>=8?s+="。":L>=4?s+="，":s+="、"}}s.trim()&&l.push(s)}return l}let P=!1;function U(){P=!0,Pe(),y.value=!1}const z={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function le(){if(!B.value.allChars.length)return;if(y.value){U();return}y.value=!0,P=!1;const t=F();try{for(let e=0;e<t.length&&!P;e++){const n=t[e+1];n&&W(n,z);const l=t[e];l&&await Re(l,z)}}catch(e){console.error("TTS 播放失敗:",e),P||alert("語音朗讀失敗，請稍後再試")}finally{y.value=!1,P=!1}}async function ce(){if(!D.isAuthenticated){alert("請先登入以使用書籤功能");return}await i.toggleBookmark(E.value)}function ue(){J.push({name:"reading-list"})}function de(t){const e=[],{allBreaks:n}=B.value;return g.value?n.has(t)&&e.push("has-break","correct"):C.value.has(t)?(e.push("has-break","user-marked"),c.value&&(c.value.correct.includes(t)?e.push("verified-correct"):c.value.extra.includes(t)&&e.push("verified-extra"))):c.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}function I(){_.value=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window||navigator.maxTouchPoints>0}ge(async()=>{I(),window.addEventListener("resize",I),_.value&&(document.addEventListener("click",A),document.addEventListener("touchend",A)),await i.fetchTextDetail(E.value),i.startReadingTracking(),i.currentText?.progress&&(K.value=i.currentText.progress.last_paragraph),await Y();const e=F()[0];e&&W(e,z)});function he(){return c.value?Math.round(c.value.accuracy*100):g.value?50:0}return me(()=>{if(U(),window.removeEventListener("resize",I),_.value&&(document.removeEventListener("click",A),document.removeEventListener("touchend",A)),E.value&&D.isAuthenticated){const t=he(),e=c.value?.accuracy===1;i.saveReadingRecord(E.value,t,e)}}),ke(g,t=>{t&&(c.value=null)}),(t,e)=>(d(),f("div",Ee,[a("header",Me,[a("button",{class:"back-btn",onClick:ue}," ← 返回 "),a("div",Ae,[a("h1",null,v(m(i).currentText?.title||"載入中..."),1),a("div",Le,[m(i).currentText?.author?(d(),f("span",ze,v(m(i).currentText.author),1)):k("",!0),m(i).currentText?.source_text?.title?(d(),f("span",Ie," · 選自《"+v(m(i).currentText.source_text.title)+"》 ",1)):k("",!0)])]),a("div",Ne,[a("button",{class:S(["action-btn bookmark-btn",{active:m(i).currentText?.progress?.bookmarked}]),onClick:ce,title:"收藏"},v(m(i).currentText?.progress?.bookmarked?"⭐":"☆"),3)])]),a("section",Oe,[a("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=n=>g.value=!g.value),"aria-pressed":g.value,type:"button"},[e[3]||(e[3]=a("span",{class:"toggle-label"},"顯示斷句",-1)),a("span",Ve,[a("span",{class:S(["toggle-track",{active:g.value}])},[...e[2]||(e[2]=[a("span",{class:"toggle-thumb"},null,-1)])],2)])],8,De),a("button",{class:S(["tts-btn",{playing:y.value}]),onClick:le},[(d(),j(_e(y.value?m(Se):m(Be)),{size:18,"stroke-width":1.5})),a("span",null,v(y.value?" 停止朗讀":" 朗讀全文"),1)],2)]),m(i).currentText&&V.value.length>0?(d(),f("section",$e,[(d(!0),f(O,null,H(V.value,(n,l)=>(d(),f("div",{key:l,class:"paragraph-block"},[a("div",qe,[(d(!0),f(O,null,H(n.chars,(u,s)=>(d(),f("span",{key:s,class:"char-unit"},[a("span",{class:S(["char",{"has-annotation":w(n.startIdx+s),"annotation-hovered":Z(n.startIdx+s),"annotation-start":ee(n.startIdx+s),"annotation-end":te(n.startIdx+s)}]),"data-global-index":n.startIdx+s,onMouseenter:r=>ne(n.startIdx+s,r),onMouseleave:se,onClick:r=>$(n.startIdx+s,r),onTouchend:r=>$(n.startIdx+s,r)},v(u),43,Fe),s<n.chars.length-1?(d(),f("button",{key:0,class:S(["break-slot",de(n.startIdx+s)]),onClick:r=>ae(n.startIdx+s),disabled:g.value},[...e[4]||(e[4]=[a("span",{class:"break-marker"},null,-1)])],10,Ue)):k("",!0)]))),128))])]))),128)),c.value?(d(),f("div",Xe,[a("div",Ye,[a("span",je,"✓ 正確："+v(c.value.correct.length),1),a("span",He,"○ 遺漏："+v(c.value.missed.length),1),a("span",Qe,"✗ 多餘："+v(c.value.extra.length),1),a("span",We," 正確率："+v(Math.round(c.value.accuracy*100))+"% ",1)]),a("button",{class:"show-answer-btn",onClick:re}," 查看正確答案 ")])):k("",!0),a("div",Ge,[g.value?k("",!0):(d(),f(O,{key:0},[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:ie}," 重置 "),a("button",{class:"edamame-btn edamame-btn-primary",onClick:oe,disabled:C.value.size===0}," ✓ 驗證我的斷句 ",8,Je)],64))])])):m(i).isLoading?(d(),f("section",Ke,[...e[5]||(e[5]=[a("span",{class:"loading-spinner"},null,-1),Q(" 載入中... ",-1)])])):k("",!0),(d(),j(ye,{to:"body"},[p.value?(d(),f("div",{key:0,class:S(["annotation-tooltip",{"mobile-tooltip":_.value}]),style:be({left:p.value.x+"px",top:p.value.y+16+"px"}),onClick:e[1]||(e[1]=xe(()=>{},["stop"]))},[_.value?(d(),f("button",{key:0,class:"tooltip-close-btn",onClick:M,"aria-label":"關閉註釋"}," ✕ ")):k("",!0),a("div",Ze,[Q(v(p.value.annotation.term)+" ",1),p.value.annotation.pinyin?(d(),f("span",et,"（"+v(p.value.annotation.pinyin)+"）",1)):k("",!0)]),a("div",tt,v(p.value.annotation.annotation),1)],6)):k("",!0)]))]))}}),ct=we(nt,[["__scopeId","data-v-1f76b506"]]);export{ct as default};
