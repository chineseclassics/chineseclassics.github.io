import{v as Z,u as ee,r as g,c as y,I as a}from"./index-D0i31nFW.js";import{u as te}from"./userStatsStore-BdI2cOF1.js";const ue=[0,10,30,50,100],le=[{value:60,label:"閃電戰",description:"1 分鐘"},{value:180,label:"標準",description:"3 分鐘"},{value:300,label:"持久",description:"5 分鐘"}],ce=[2,3,4],ae={3:5,5:10,7:20,10:50},h={DAILY_FEE_LIMIT:100,MIN_BALANCE:20,MAX_LOSS_STREAK:5},re={red:{name:"紅隊",primary:"#ef4444",secondary:"#fecaca",text:"#991b1b"},blue:{name:"藍隊",primary:"#3b82f6",secondary:"#bfdbfe",text:"#1e40af"},green:{name:"綠隊",primary:"#22c55e",secondary:"#bbf7d0",text:"#166534"},yellow:{name:"黃隊",primary:"#eab308",secondary:"#fef08a",text:"#854d0e"}};function se(o){return["red","blue","green","yellow"].slice(0,o)}function ie(o){return re[o].name}const k=[{minLevel:1,maxLevel:2,title:"童生",color:"#78716c"},{minLevel:3,maxLevel:5,title:"秀才",color:"#22c55e"},{minLevel:6,maxLevel:9,title:"舉人",color:"#3b82f6"},{minLevel:10,maxLevel:14,title:"進士",color:"#8b5cf6"},{minLevel:15,maxLevel:19,title:"探花",color:"#f59e0b"},{minLevel:20,maxLevel:24,title:"榜眼",color:"#ef4444"},{minLevel:25,maxLevel:999,title:"狀元",color:"#dc2626"}];function _e(o){for(const f of k)if(o>=f.minLevel&&o<=f.maxLevel)return f;return k[0]}const me=Z("game",()=>{const o=ee(),f=te(),r=g(null),S=g([]),m=g(null),p=g(!1),u=g(null);let w=null;const v=y(()=>!r.value||!o.user?!1:r.value.host_id===o.user.id),A=y(()=>r.value?.status==="playing"),P=y(()=>r.value?.status==="waiting"),C=y(()=>r.value?.status==="finished"),M=y(()=>!m.value?.team_id||!r.value?.teams?null:r.value.teams.find(t=>t.id===m.value.team_id));async function N(t){if(!a||!o.user)return u.value="請先登入",null;p.value=!0,u.value=null;try{const{data:e,error:s}=await a.from("game_rooms").insert({host_id:o.user.id,host_type:t.hostType,game_mode:t.gameMode,text_id:t.textId,time_limit:t.timeLimit,team_count:t.teamCount||null,max_players:t.maxPlayers||null,entry_fee:t.entryFee||0,class_id:t.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content)
        `).single();if(s)return u.value=s.message,null;if(t.gameMode==="team_battle"&&t.teamCount){const n=se(t.teamCount).map((_,d)=>({room_id:e.id,team_name:ie(_),team_color:_,order_index:d})),{data:l,error:c}=await a.from("game_teams").insert(n).select();c?console.error("創建團隊失敗:",c):e.teams=l}return t.hostType==="student"&&await x(e.id,t.entryFee||0),r.value=e,e}catch(e){return u.value=e.message,null}finally{p.value=!1}}async function O(t){if(!a||!o.user)return{success:!1,error:"請先登入"};p.value=!0,u.value=null;try{const{data:e,error:s}=await a.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",t.toUpperCase()).single();if(s||!e)return{success:!1,error:"找不到該房間"};if(e.status!=="waiting")return{success:!1,error:"該房間已開始或已結束"};const i=e.participants?.find(l=>l.user_id===o.user.id);if(i)return r.value=e,m.value=i,T(e.id),{success:!0,room:e,participant:i};if(e.max_players&&e.participants&&e.participants.length>=e.max_players)return{success:!1,error:"房間已滿"};if(e.entry_fee>0&&!await R(e.id,e.entry_fee))return{success:!1,error:u.value||"無法支付入場費"};const n=await x(e.id,e.entry_fee);return n?(r.value=e,m.value=n,T(e.id),{success:!0,room:e,participant:n}):{success:!1,error:u.value||"加入房間失敗"}}catch(e){return u.value=e.message,{success:!1,error:u.value}}finally{p.value=!1}}async function x(t,e){if(!a||!o.user)return null;const{data:s,error:i}=await a.from("game_participants").insert({room_id:t,user_id:o.user.id,fee_paid:e}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return i?(u.value=i.message,null):(e>0&&await a.from("game_rooms").update({prize_pool:a.rpc("increment_prize_pool",{room_id:t,amount:e})}).eq("id",t),s)}async function R(t,e){if(!a||!o.user)return!1;const s=f.profile?.total_beans??0;if(s-e<h.MIN_BALANCE)return u.value=`賬戶需保留至少 ${h.MIN_BALANCE} 豆`,!1;const i=f.profile,n=new Date().toISOString().split("T")[0],l=i?.daily_fee_reset_at===n&&i?.daily_fee_spent||0;if(l+e>h.DAILY_FEE_LIMIT)return u.value=`今日入場費已達上限 ${h.DAILY_FEE_LIMIT} 豆`,!1;const{error:c}=await a.from("user_stats").update({beans:s-e,daily_fee_spent:l+e,daily_fee_reset_at:n}).eq("user_id",o.user.id);return c?(u.value="扣除入場費失敗",!1):(await a.from("game_transactions").insert({user_id:o.user.id,room_id:t,type:"entry_fee",amount:-e,balance_after:s-e,description:`入場費 ${e} 豆`}),await f.fetchProfile(),!0)}async function q(t,e){if(!a||!v.value)return u.value="無權限",!1;const{error:s}=await a.from("game_participants").update({team_id:e}).eq("id",t);return s?(u.value=s.message,!1):!0}async function D(){if(!a||!v.value||!r.value?.teams)return u.value="無法分組",!1;const t=r.value.participants||[],e=r.value.teams,s=[...t].sort(()=>Math.random()-.5);for(let i=0;i<s.length;i++){const n=i%e.length,l=e[n],c=s[i];l&&c&&await q(c.id,l.id)}return!0}async function z(){if(!a||!v.value||!r.value)return u.value="無權限",!1;if(r.value.game_mode==="team_battle"){const e=r.value.participants?.filter(s=>!s.team_id);if(e&&e.length>0)return u.value="還有玩家未分組",!1}const{error:t}=await a.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",r.value.id);return t?(u.value=t.message,!1):(await a.from("game_participants").update({status:"playing"}).eq("room_id",r.value.id),!0)}async function $(t){if(!a||!o.user||!r.value)return u.value="無法提交分數",!1;const{error:e}=await a.from("game_participants").update({score:t.score,accuracy:t.accuracy,time_spent:t.timeSpent,first_accuracy:t.firstAccuracy,attempt_count:t.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",t.roomId).eq("user_id",o.user.id);return e?(u.value=e.message,!1):(m.value?.team_id&&await F(m.value.team_id),await G(),!0)}async function F(t){if(!a||!r.value)return;const{data:e}=await a.from("game_participants").select("score").eq("team_id",t).eq("status","completed"),s=e?.length||0,i=e?.reduce((l,c)=>l+(c.score||0),0)||0,n=s>0?Math.round(i/s*100):0;await a.from("game_teams").update({total_score:n}).eq("id",t)}async function G(){if(!a||!r.value)return;const{data:t}=await a.from("game_participants").select("status").eq("room_id",r.value.id);if(!t)return;const e=t.every(l=>l.status==="completed"),s=r.value.started_at?new Date(r.value.started_at):null,i=r.value.time_limit*1e3,n=s&&Date.now()-s.getTime()>=i;(e||n)&&await E()}async function E(){if(!a||!r.value)return null;const{data:t}=await a.from("game_rooms").select(`
        *,
        teams:game_teams(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",r.value.id).single();if(!t)return null;let e=null,s=null,i=[];if(t.game_mode==="team_battle"&&t.teams)e=[...t.teams].sort((_,d)=>d.total_score-_.total_score)[0]?.id,i=t.participants?.filter(_=>_.team_id===e)||[];else{const c=[...t.participants||[]].sort((_,d)=>d.score-_.score)[0];s=c?.user_id,i=c?[c]:[]}await a.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:e,winner_user_id:s}).eq("id",t.id);let n=[];return t.prize_pool>0&&i.length>0&&(n=await B(t,i)),await U(t,i),{room:t,winners:i,winningTeam:t.teams?.find(l=>l.id===e),prizeDistribution:n}}async function B(t,e){if(!a)return[];const s=Math.floor(t.prize_pool/e.length),i=[];for(const n of e){const{data:l}=await a.from("user_stats").select("pvp_win_streak").eq("user_id",n.user_id).single(),c=(l?.pvp_win_streak||0)+1;let _=0;for(const[Q,V]of Object.entries(ae))if(c===Number(Q)){_=V;break}const d=s+_,{data:J}=await a.from("user_stats").select("beans").eq("user_id",n.user_id).single(),I=(J?.beans||0)+d;await a.from("user_stats").update({beans:I}).eq("user_id",n.user_id),await a.from("game_participants").update({prize_won:d}).eq("id",n.id),await a.from("game_transactions").insert({user_id:n.user_id,room_id:t.id,type:"prize",amount:d,balance_after:I,description:`收豆 ${s} 豆${_>0?` + 連勝獎勵 ${_} 豆`:""}`}),i.push({userId:n.user_id,displayName:n.user?.display_name||"未知",prize:s,streakBonus:_})}return i}async function U(t,e){if(!a)return;const s=new Set(e.map(i=>i.user_id));for(const i of t.participants||[]){const n=s.has(i.user_id);n?await a.rpc("increment_win_streak",{p_user_id:i.user_id}):await a.from("user_stats").update({pvp_win_streak:0}).eq("user_id",i.user_id),await a.rpc("increment_pvp_games",{p_user_id:i.user_id,p_is_win:n})}}function T(t){a&&(b(),w=a.channel(`room:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},e=>{console.log("[Game] 房間更新:",e),e.new&&(r.value={...r.value,...e.new})}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants",filter:`room_id=eq.${t}`},async e=>{console.log("[Game] 參與者更新:",e),await Y(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams",filter:`room_id=eq.${t}`},async e=>{console.log("[Game] 團隊更新:",e),await j(t)}).subscribe())}async function Y(t){if(!a)return;const{data:e}=await a.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",t);e&&r.value&&(r.value.participants=e,o.user&&(m.value=e.find(s=>s.user_id===o.user.id)||null))}async function j(t){if(!a)return;const{data:e}=await a.from("game_teams").select("*").eq("room_id",t).order("order_index");e&&r.value&&(r.value.teams=e)}function b(){w&&(a?.removeChannel(w),w=null)}async function W(){if(!a)return;p.value=!0;const{data:t,error:e}=await a.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);e?u.value=e.message:S.value=(t||[]).map(s=>({...s,participant_count:s.participants?.[0]?.count||0})),p.value=!1}async function K(t){if(!a)return[];const{data:e}=await a.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",t).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return e||[]}async function H(){if(!(!a||!r.value||!o.user)){if(v.value&&r.value.status==="waiting"){if(await a.from("game_rooms").update({status:"cancelled"}).eq("id",r.value.id),r.value.entry_fee>0)for(const t of r.value.participants||[])await L(t)}else!v.value&&r.value.status==="waiting"&&(await a.from("game_participants").delete().eq("room_id",r.value.id).eq("user_id",o.user.id),m.value?.fee_paid&&await L(m.value));b(),r.value=null,m.value=null}}async function L(t){if(!a||!t.fee_paid)return;const{data:e}=await a.from("user_stats").select("beans").eq("user_id",t.user_id).single(),s=(e?.beans||0)+t.fee_paid;await a.from("user_stats").update({beans:s}).eq("user_id",t.user_id),await a.from("game_transactions").insert({user_id:t.user_id,room_id:t.room_id,type:"refund",amount:t.fee_paid,balance_after:s,description:"房間取消，退還入場費"})}function X(){b(),r.value=null,m.value=null,S.value=[],u.value=null}return{currentRoom:r,rooms:S,myParticipant:m,loading:p,error:u,isHost:v,isPlaying:A,isWaiting:P,isFinished:C,myTeam:M,createRoom:N,joinRoom:O,assignToTeam:q,randomAssignTeams:D,leaveRoom:H,startGame:z,submitScore:$,endGame:E,subscribeToRoom:T,unsubscribe:b,fetchPublicRooms:W,fetchClassGames:K,reset:X}});export{ue as E,h as S,ce as T,se as a,le as b,re as c,_e as g,me as u};
