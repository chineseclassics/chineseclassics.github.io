import{d as oe,u as ie,r as b,D as X,c as B,o as de,a as n,b as e,k as H,t as i,f as x,g as j,F as $,i as E,e as _,s as q,l as J,T as K,E as Q,n as I,G as h,q as a,z as T,A as S,_ as re}from"./index-B01WPos_.js";import{u as ue}from"./textsStore-D2snBXkY.js";import{u as ce}from"./practiceLibraryStore-BldJ41id.js";import"./useSupabase-CdQhbDsI.js";const ve={class:"admin-shell"},me={class:"admin-header"},pe={class:"edamame-text-level-detail"},fe={class:"edamame-heading-gradient"},ye={class:"header-actions"},be=["disabled"],_e=["disabled"],he={class:"admin-layout"},ge={class:"category-sidebar edamame-glass"},ke={class:"sidebar-header"},Ce={key:0,class:"sidebar-loading"},xe={key:1,class:"sidebar-empty"},we={key:2,class:"category-tree"},$e=["onClick"],Te=["onClick"],Se={class:"tree-label"},Ve={class:"tree-count"},Le={class:"tree-actions"},Me=["onClick"],Ae=["onClick"],De=["onClick"],Fe={key:0,class:"tree-children"},Be=["onClick"],Ee={class:"tree-label"},Ie={class:"tree-count"},Ue={class:"tree-actions"},Ge=["onClick"],Ne=["onClick"],Oe=["onClick"],ze={class:"content-panel edamame-glass"},Pe={key:0,class:"content-empty"},He={class:"content-breadcrumb"},je=["onClick"],qe={key:0,class:"breadcrumb-sep"},Je={class:"category-info"},Ke={key:0,class:"category-desc"},Qe={class:"category-meta"},Re={key:0,class:"module-grid"},We=["onClick"],Xe={class:"module-desc"},Ye={class:"module-count"},Ze={key:1,class:"text-list"},et={key:0,class:"text-empty"},tt={key:1},lt={class:"text-title"},st={key:0,class:"text-type-badge system"},at={key:1,class:"text-type-badge private"},nt={class:"text-summary"},ot={class:"actions"},it=["onClick"],dt=["onClick"],rt={class:"modal-card edamame-glass"},ut={class:"modal-body"},ct={class:"form-context"},vt={class:"form-row"},mt={class:"preview-panel"},pt=["innerHTML"],ft={key:0,class:"feedback"},yt=["disabled"],bt={class:"modal-card edamame-glass small-modal"},_t={class:"modal-body"},ht=["placeholder"],gt={key:0,class:"feedback"},kt=["disabled"],Ct={class:"modal-card edamame-glass small-modal"},xt={key:0,class:"feedback"},wt={class:"confirm-actions"},$t=["disabled"],Tt=oe({__name:"AdminTextsPage",setup(St){const f=ue(),v=ce(),w=ie(),m=b(null),g=b(new Set),k=b(!1),C=b(!1),V=b(!1),p=b(!1),L=b(null),M=b(null),y=b(null),u=b(null),d=X({title:"",author:"",source:"",summary:"",content:""}),r=X({name:"",description:"",parentId:null,type:"grade"}),U=B(()=>v.state.categories.filter(s=>s.level===1).sort((s,t)=>s.order_index-t.order_index)),c=B(()=>v.state.categories.find(s=>s.id===m.value)??null),G=B(()=>{if(!c.value)return[];const s=[];let t=c.value;for(;t;)s.unshift(t),t=v.state.categories.find(l=>l.id===t?.parent_id);return s}),O=B(()=>{if(!m.value)return[];const s=new Set([m.value]);c.value?.level===2&&v.state.categories.filter(o=>o.parent_id===m.value).forEach(o=>s.add(o.id));let l=f.texts.filter(o=>o.category_id&&s.has(o.category_id));return w.isAdmin||(w.isTeacher?l=l.filter(o=>o.is_system===!1&&o.created_by===w.user?.id):l=[]),l.sort((o,F)=>(F.created_at??"").localeCompare(o.created_at??""))}),Y=B(()=>{if(!d.content)return"";let s=d.content.replace(/[「」『』"""'']/g,"");return s=s.replace(/[。！？；，：、]/g,"|"),s=s.replace(/\|{2,}/g,"|"),s=s.replace(/^\|+|\|+$/g,""),s.replace(/\|/g,'<span class="preview-break">｜</span>').replace(/\n/g,"<br />")});function A(s){return v.state.categories.filter(t=>t.level===2&&t.parent_id===s).sort((t,l)=>t.order_index-l.order_index)}function R(s){return f.texts.filter(t=>t.category_id===s).length}function Z(s){g.value.has(s)?g.value.delete(s):g.value.add(s)}function N(s){m.value=s;const t=v.state.categories.find(l=>l.id===s);t?.parent_id&&g.value.add(t.parent_id)}function z(){L.value=null,d.title="",d.author="",d.source="",d.summary="",d.content="",u.value=null,k.value=!0}function ee(s){L.value=s.id,d.title=s.title,d.author=s.author??"",d.source=s.source??"",d.summary=s.summary??"",d.content=s.content,u.value=null,k.value=!0}async function te(){if(!d.title||!d.content){u.value="標題與內容為必填";return}if(!m.value){u.value="請先選擇一個分類";return}const s=c.value;if(!s||s.level!==2){u.value="請選擇一個單元（而非年級）來新增文章";return}try{p.value=!0;const t={title:d.title,author:d.author||null,source:d.source||null,summary:d.summary||null,category_id:m.value,content:d.content};if(L.value)await f.updateText(L.value,t);else{const l=w.isAdmin;await f.addText(t,l)}await f.fetchTexts(),k.value=!1}catch(t){u.value=t?.message??"儲存失敗"}finally{p.value=!1}}function D(s,t){M.value=null,r.name="",r.description="",r.parentId=s,r.type=t,u.value=null,C.value=!0}function W(s){M.value=s,r.name=s.name,r.description=s.description??"",r.parentId=s.parent_id,r.type=s.level===1?"grade":"module",u.value=null,C.value=!0}async function le(){if(!r.name.trim()){u.value="名稱不可為空";return}try{p.value=!0,M.value?await v.updateCategory(M.value.id,{name:r.name.trim(),description:r.description.trim()||void 0}):await v.addCategory({name:r.name.trim(),parent_id:r.parentId,type:r.type,description:r.description.trim()||void 0}),C.value=!1}catch(s){u.value=s?.message??"儲存失敗"}finally{p.value=!1}}function P(s,t){y.value={type:s,item:t},u.value=null,V.value=!0}async function se(){if(y.value)try{p.value=!0,y.value.type==="text"?(await f.deleteText(y.value.item.id),await f.fetchTexts()):(await v.deleteCategory(y.value.item.id),m.value===y.value.item.id&&(m.value=null)),V.value=!1,y.value=null}catch(s){u.value=s?.message??"刪除失敗"}finally{p.value=!1}}function ae(s){return s?s===1?"初級":s===2?"中級":"高級":"未標註"}function ne(s){return s?new Date(s).toLocaleDateString():"--"}return de(async()=>{if(v.state.categories.length||await v.fetchLibrary(),f.texts.length||await f.fetchTexts(),U.value.length>0){const s=U.value[0];if(s){g.value.add(s.id);const t=A(s.id)[0];t&&(m.value=t.id)}}}),(s,t)=>(a(),n("div",ve,[e("header",me,[e("div",null,[e("p",pe,i(x(w).isAdmin?"超級管理員":"老師")+" · 文章資料庫 ",1),e("h1",fe,i(x(w).isAdmin?"系統內建文章":"我的私有文章"),1)]),e("div",ye,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[0]||(t[0]=l=>{x(v).fetchLibrary(),x(f).fetchTexts()}),disabled:x(v).isLoading||x(f).isLoading}," 重新整理 ",8,be),e("button",{class:"edamame-btn edamame-btn-primary",onClick:z,disabled:!c.value||c.value.level!==2}," 新增文章 ",8,_e)])]),e("div",he,[e("aside",ge,[e("div",ke,[t[19]||(t[19]=e("span",{class:"sidebar-title"},"分類導航",-1)),e("button",{class:"icon-btn",onClick:t[1]||(t[1]=l=>D(null,"grade")),title:"新增年級"},[...t[18]||(t[18]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M12 5v14M5 12h14"})],-1)])])]),x(v).isLoading?(a(),n("div",Ce,"載入中⋯")):U.value.length?(a(),n("nav",we,[(a(!0),n($,null,E(U.value,l=>(a(),n("div",{key:l.id,class:"tree-node"},[e("div",{class:I(["tree-item grade-item",{selected:m.value===l.id}]),onClick:o=>N(l.id)},[e("button",{class:"expand-btn",onClick:h(o=>Z(l.id),["stop"])},[(a(),n("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",class:I({expanded:g.value.has(l.id)})},[...t[21]||(t[21]=[e("path",{d:"M8 5l8 7-8 7V5z"},null,-1)])],2))],8,Te),e("span",Se,i(l.name),1),e("span",Ve,i(A(l.id).length),1),e("div",Le,[e("button",{class:"action-btn",onClick:h(o=>D(l.id,"module"),["stop"]),title:"新增單元"},"+",8,Me),e("button",{class:"action-btn",onClick:h(o=>W(l),["stop"]),title:"編輯"},"✎",8,Ae),e("button",{class:"action-btn danger",onClick:h(o=>P("category",l),["stop"]),title:"刪除"},"×",8,De)])],10,$e),g.value.has(l.id)?(a(),n("div",Fe,[(a(!0),n($,null,E(A(l.id),o=>(a(),n("div",{key:o.id,class:I(["tree-item module-item",{selected:m.value===o.id}]),onClick:F=>N(o.id)},[e("span",Ee,i(o.name),1),e("span",Ie,i(R(o.id)),1),e("div",Ue,[e("button",{class:"action-btn",onClick:h(F=>W(o),["stop"]),title:"編輯"},"✎",8,Ge),e("button",{class:"action-btn danger",onClick:h(F=>P("category",o),["stop"]),title:"刪除"},"×",8,Ne)])],10,Be))),128)),e("button",{class:"add-module-btn",onClick:o=>D(l.id,"module")}," + 新增單元 ",8,Oe)])):_("",!0)]))),128))])):(a(),n("div",xe,[t[20]||(t[20]=j(" 尚無分類 ",-1)),e("button",{class:"link-btn",onClick:t[2]||(t[2]=l=>D(null,"grade"))},"建立第一個年級")]))]),e("main",ze,[c.value?(a(),n($,{key:1},[e("div",He,[(a(!0),n($,null,E(G.value,(l,o)=>(a(),n("span",{key:l.id,class:I(["breadcrumb-item",{active:o===G.value.length-1}]),onClick:F=>N(l.id)},[j(i(l.name)+" ",1),o<G.value.length-1?(a(),n("span",qe,"›")):_("",!0)],10,je))),128))]),e("div",Je,[e("h2",null,i(c.value.name),1),c.value.description?(a(),n("p",Ke,i(c.value.description),1)):_("",!0),e("p",Qe,i(c.value.level===1?"年級":"單元")+" · "+i(c.value.level===1?`${A(c.value.id).length} 個單元`:`${O.value.length} 篇文章`),1)]),c.value.level===1?(a(),n("div",Re,[(a(!0),n($,null,E(A(c.value.id),l=>(a(),n("div",{key:l.id,class:"module-card",onClick:o=>N(l.id)},[e("h3",null,i(l.name),1),e("p",Xe,i(l.description||"暫無描述"),1),e("p",Ye,i(R(l.id))+" 篇文章",1)],8,We))),128)),e("button",{class:"module-card add-card",onClick:t[3]||(t[3]=l=>D(c.value.id,"module"))},[...t[23]||(t[23]=[e("span",{class:"add-icon"},"+",-1),e("span",null,"新增單元",-1)])])])):(a(),n("div",Ze,[O.value.length?(a(),n("table",tt,[t[25]||(t[25]=e("thead",null,[e("tr",null,[e("th",null,"標題"),e("th",null,"作者"),e("th",null,"難度"),e("th",null,"建立日期"),e("th",{style:{width:"120px"}},"操作")])],-1)),e("tbody",null,[(a(!0),n($,null,E(O.value,l=>(a(),n("tr",{key:l.id},[e("td",null,[e("p",lt,[j(i(l.title)+" ",1),l.is_system?(a(),n("span",st,"系統")):(a(),n("span",at,"私有"))]),e("p",nt,i(l.summary||l.content.replace(/\|/g,"").slice(0,40)+"..."),1)]),e("td",null,i(l.author||"佚名"),1),e("td",null,[e("span",{class:I(["difficulty-badge",`diff-${l.difficulty}`])},i(ae(l.difficulty)),3)]),e("td",null,i(ne(l.created_at)),1),e("td",ot,[e("button",{class:"ghost-btn",onClick:o=>ee(l)},"編輯",8,it),e("button",{class:"ghost-btn danger",onClick:o=>P("text",l)},"刪除",8,dt)])]))),128))])])):(a(),n("div",et,[t[24]||(t[24]=e("p",null,"此單元尚無文章",-1)),e("button",{class:"edamame-btn edamame-btn-primary",onClick:z},"新增第一篇文章")])),e("button",{class:"add-text-btn",onClick:z}," + 在「"+i(c.value.name)+"」新增文章 ",1)]))],64)):(a(),n("div",Pe,[...t[22]||(t[22]=[e("p",null,"請從左側選擇一個分類",-1)])]))])]),(a(),H(Q,{to:"body"},[q(K,{name:"fade"},{default:J(()=>[k.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:t[10]||(t[10]=h(l=>k.value=!1,["self"]))},[e("div",rt,[e("header",null,[e("h3",null,i(L.value?"編輯文章":"新增文章"),1),e("button",{class:"close-btn",onClick:t[4]||(t[4]=l=>k.value=!1)},"×")]),e("div",ut,[e("p",ct,"將新增至："+i(G.value.map(l=>l.name).join(" › ")),1),e("label",null,[t[26]||(t[26]=e("span",null,"標題",-1)),T(e("input",{"onUpdate:modelValue":t[5]||(t[5]=l=>d.title=l),type:"text",placeholder:"請輸入標題"},null,512),[[S,d.title]])]),e("div",vt,[e("label",null,[t[27]||(t[27]=e("span",null,"作者",-1)),T(e("input",{"onUpdate:modelValue":t[6]||(t[6]=l=>d.author=l),type:"text",placeholder:"例如：孔子"},null,512),[[S,d.author]])]),e("label",null,[t[28]||(t[28]=e("span",null,"來源",-1)),T(e("input",{"onUpdate:modelValue":t[7]||(t[7]=l=>d.source=l),type:"text",placeholder:"例如：論語"},null,512),[[S,d.source]])])]),e("label",null,[t[29]||(t[29]=e("span",null,"內容（標點將自動轉為斷句符號）",-1)),T(e("textarea",{"onUpdate:modelValue":t[8]||(t[8]=l=>d.content=l),rows:"6",placeholder:"貼上原文或手動輸入"},null,512),[[S,d.content]])]),e("div",mt,[t[30]||(t[30]=e("p",null,"預覽",-1)),e("div",{class:"preview-content",innerHTML:Y.value||"尚無內容"},null,8,pt)]),u.value?(a(),n("p",ft,i(u.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[9]||(t[9]=l=>k.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:p.value,onClick:te},i(p.value?"儲存中...":"儲存"),9,yt)])])])):_("",!0)]),_:1})])),(a(),H(Q,{to:"body"},[q(K,{name:"fade"},{default:J(()=>[C.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:t[15]||(t[15]=h(l=>C.value=!1,["self"]))},[e("div",bt,[e("header",null,[e("h3",null,i(M.value?"編輯分類":r.type==="grade"?"新增年級":"新增單元"),1),e("button",{class:"close-btn",onClick:t[11]||(t[11]=l=>C.value=!1)},"×")]),e("div",_t,[e("label",null,[t[31]||(t[31]=e("span",null,"名稱",-1)),T(e("input",{"onUpdate:modelValue":t[12]||(t[12]=l=>r.name=l),type:"text",placeholder:r.type==="grade"?"例如：七年級":"例如：論語讀本"},null,8,ht),[[S,r.name]])]),e("label",null,[t[32]||(t[32]=e("span",null,"描述（選填）",-1)),T(e("textarea",{"onUpdate:modelValue":t[13]||(t[13]=l=>r.description=l),rows:"2",placeholder:"簡述此分類的內容範圍"},null,512),[[S,r.description]])]),u.value?(a(),n("p",gt,i(u.value),1)):_("",!0)]),e("footer",null,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[14]||(t[14]=l=>C.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-primary",disabled:p.value,onClick:le},i(p.value?"儲存中...":"儲存"),9,kt)])])])):_("",!0)]),_:1})])),(a(),H(Q,{to:"body"},[q(K,{name:"fade"},{default:J(()=>[V.value?(a(),n("div",{key:0,class:"modal-backdrop",onClick:t[17]||(t[17]=h(l=>V.value=!1,["self"]))},[e("div",Ct,[t[33]||(t[33]=e("h3",null,"確定刪除？",-1)),e("p",null,"「"+i(y.value?.item?"title"in y.value.item?y.value.item.title:y.value.item.name:"")+"」刪除後將無法復原。",1),u.value?(a(),n("p",xt,i(u.value),1)):_("",!0),e("div",wt,[e("button",{class:"edamame-btn edamame-btn-secondary",onClick:t[16]||(t[16]=l=>V.value=!1)},"取消"),e("button",{class:"edamame-btn edamame-btn-danger",disabled:p.value,onClick:se},i(p.value?"刪除中...":"刪除"),9,$t)])])])):_("",!0)]),_:1})]))]))}}),Dt=re(Tt,[["__scopeId","data-v-d895c473"]]);export{Dt as default};
