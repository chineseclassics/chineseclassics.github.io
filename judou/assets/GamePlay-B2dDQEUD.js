import{d as oe,c as i,p as le,r as f,w as ue,o as ie,K as ce,a as r,b as n,F as S,e as h,n as b,t as c,i as q,j as ve,q as o,_ as de}from"./index-Dqh4cMIB.js";import{u as me}from"./gameStore-QyWOImQh.js";import"./userStatsStore-DnrRLcX3.js";const pe={class:"game-play"},fe={key:0,class:"loading-container"},he={class:"play-header"},_e={class:"header-left"},Te={class:"countdown-time"},ge={class:"header-center"},ke={class:"text-title"},be={key:0,class:"text-author"},ye={class:"header-right"},Be=["disabled"],xe={key:0,class:"text-tabs"},we=["onClick"],Se={class:"tab-number"},Ce={class:"tab-title"},Ae={key:0,class:"tab-check"},ze={class:"play-main"},Ve={class:"board-header"},Ie={class:"board-header-right"},Re={class:"practice-board"},Me={key:0,class:"practice-line"},$e={class:"char"},qe=["onClick","aria-label"],De={key:0,class:"bean"},Ge={class:"progress-hint"},Ne={key:0,class:"text-nav"},Le=["disabled"],Fe={class:"nav-info"},Oe=["disabled"],Pe=oe({__name:"GamePlay",setup(je){const D=ve(),K=le(),T=me(),g=i(()=>K.params.roomId),v=i(()=>T.currentRoom),l=f([]),d=f(new Map),m=f(0),p=i(()=>l.value[m.value]),C=i(()=>p.value&&d.value.get(p.value.id)||null),A=i(()=>C.value?.characters||[]),G=i(()=>C.value?.correctBreaks||new Set),k=i({get:()=>C.value?.userBreaks||new Set,set:a=>{if(p.value&&d.value.has(p.value.id)){const e=d.value.get(p.value.id);e.userBreaks=a}}}),y=f(0);let z=null;const N=i(()=>G.value.size),U=i(()=>k.value.size),L=i(()=>Math.max(0,N.value-U.value)),H=i(()=>L.value>0),V=f(!1),_=f(!1),F=f(!0);let O=0;function Q(a){const e=[],t=new Set;let s=0;for(const u of a)u==="|"?s>0&&t.add(s-1):u!==`
`&&u!=="\r"&&(e.push(u),s++);return{chars:e,breaks:t}}function W(){d.value.clear();for(const a of l.value){const e=Q(a.content);d.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Set})}}function X(a){a>=0&&a<l.value.length&&(m.value=a)}function Y(){m.value>0&&m.value--}function Z(){m.value<l.value.length-1&&m.value++}let I=null;function R(a){try{I||(I=new AudioContext);const e=I,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function M(a=10){navigator.vibrate&&navigator.vibrate(a)}function ee(a){if(_.value||!p.value)return;const e=d.value.get(p.value.id);if(!e)return;const t=new Set(e.userBreaks),s=t.has(a);if(!s&&t.size>=e.correctBreaks.size){R("error"),V.value=!0,setTimeout(()=>{V.value=!1},300),M(50);return}s?(t.delete(a),R("remove"),M(5)):(t.add(a),R("add"),M(10)),e.userBreaks=t,d.value=new Map(d.value)}function te(a){return{"has-bean":k.value.has(a)}}function B(a){const e=d.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(u=>e.userBreaks.has(u))?"complete":"partial"}async function P(){if(_.value)return;_.value=!0;const a=Math.round((Date.now()-O)/1e3);let e=0,t=0;const s=[];for(const j of l.value){const $=d.value.get(j.id);if(!$)continue;const x=$.correctBreaks,E=$.userBreaks;let w=0,J=0;for(const re of E)x.has(re)?w++:J++;const ne=x.size-w;e+=w,t+=x.size,s.push({textId:j.id,userBreaks:[...E],correctBreaks:[...x],correctCount:w,wrongCount:J,missedCount:ne})}const u=t>0?e/t*100:0;await T.submitScore({roomId:g.value,score:e,accuracy:u,timeSpent:a,firstAccuracy:u,attemptCount:1}),sessionStorage.setItem(`game-result-${g.value}`,JSON.stringify({texts:l.value,results:s,totalCorrect:e,totalBreaks:t,accuracy:u,timeSpent:a})),D.push({name:"arena-result",params:{roomId:g.value}})}function ae(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function se(){if(!v.value?.started_at||!v.value?.time_limit)return;const a=()=>{const e=new Date(v.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);y.value=Math.max(0,v.value.time_limit-t),y.value===0&&!_.value&&P()};a(),z=setInterval(a,1e3)}return ue(()=>v.value?.status,a=>{a==="finished"&&D.push({name:"arena-result",params:{roomId:g.value}})}),ie(async()=>{T.subscribeToRoom(g.value),v.value?.text_ids&&v.value.text_ids.length>0?l.value=await T.fetchTexts(v.value.text_ids):v.value?.text_id&&(l.value=await T.fetchTexts([v.value.text_id])),F.value=!1,l.value.length>0&&(W(),O=Date.now(),se())}),ce(()=>{z&&clearInterval(z)}),(a,e)=>(o(),r("div",pe,[F.value?(o(),r("div",fe,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(o(),r(S,{key:1},[n("header",he,[n("div",_e,[n("div",{class:b(["countdown",{warning:y.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",Te,c(ae(y.value)),1)],2)]),n("div",ge,[n("span",ke,c(p.value?.title),1),p.value?.author?(o(),r("span",be,c(p.value.author),1)):h("",!0)]),n("div",ye,[n("button",{class:"submit-btn",disabled:_.value,onClick:P},c(_.value?"已提交":"提交答案"),9,Be)])]),l.value.length>1?(o(),r("div",xe,[(o(!0),r(S,null,q(l.value,(t,s)=>(o(),r("button",{key:t.id,class:b(["text-tab",{active:s===m.value,empty:B(t.id)==="empty",partial:B(t.id)==="partial",complete:B(t.id)==="complete"}]),onClick:u=>X(s)},[n("span",Se,c(s+1),1),n("span",Ce,c(t.title),1),B(t.id)==="complete"?(o(),r("span",Ae,"✓")):h("",!0)],10,we))),128))])):h("",!0),n("main",ze,[n("div",Ve,[e[2]||(e[2]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",Ie,[n("div",{class:b(["bean-inventory",{shake:V.value,empty:!H.value}])},[(o(!0),r(S,null,q(N.value,t=>(o(),r("span",{key:t,class:b(["inventory-bean",{used:t>L.value}])},null,2))),128))],2)])]),n("div",Re,[A.value.length?(o(),r("div",Me,[(o(!0),r(S,null,q(A.value,(t,s)=>(o(),r("span",{key:s,class:"char-unit"},[n("span",$e,c(t),1),s<A.value.length-1?(o(),r("button",{key:0,class:b(["bean-slot",te(s)]),onClick:u=>ee(s),"aria-label":`在「${t}」後${k.value.has(s)?"移除":"添加"}斷句`},[k.value.has(s)?(o(),r("span",De)):h("",!0),e[3]||(e[3]=n("span",{class:"bean-hint"},null,-1))],10,qe)):h("",!0)]))),128))])):h("",!0)]),n("div",Ge,[n("span",null,"已標記 "+c(k.value.size)+" / "+c(G.value.size)+" 處",1)]),l.value.length>1?(o(),r("div",Ne,[n("button",{class:"nav-btn",disabled:m.value===0,onClick:Y}," ← 上一篇 ",8,Le),n("span",Fe,c(m.value+1)+" / "+c(l.value.length),1),n("button",{class:"nav-btn",disabled:m.value===l.value.length-1,onClick:Z}," 下一篇 → ",8,Oe)])):h("",!0)]),e[4]||(e[4]=n("footer",{class:"play-footer"},[n("p",{class:"footer-hint"}," 完成所有文章後點擊「提交答案」，或等待時間結束自動提交 ")],-1))],64))]))}}),Ue=de(Pe,[["__scopeId","data-v-50285eca"]]);export{Ue as default};
