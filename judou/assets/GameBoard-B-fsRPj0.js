import{d as te,c as i,x as se,r as U,w as q,f as ae,R as oe,a as l,g as e,h as d,t as n,b as y,e as H,n as G,m as D,s as ne,i as u,F as f,j as b,l as le,o,_ as re}from"./index-pjl8OMS8.js";import{u as ie}from"./gameStore-CzIlmogn.js";import{d as _,c as M}from"./game-DlkGF0Ko.js";import{T as A}from"./TeamBadge-DoVgjdeR.js";import{R as ce}from"./RaceTrack-3bxBkWC_.js";import{B as de}from"./BeanIcon-D1b8CrOp.js";import"./userStatsStore-BnMPE05H.js";const ue={class:"board-header"},me={class:"header-left"},ve={class:"text-info"},_e={key:0},pe={class:"header-center"},he={class:"countdown-label"},ge={class:"countdown-time"},ye={class:"header-right"},fe={class:"progress-info"},ke={class:"progress-value"},be={key:0,class:"team-progress-section"},we={class:"time-progress-container"},Te={class:"time-progress-header"},Ce={class:"time-progress-text"},Se={class:"time-progress-bar"},Me={class:"stats-panel"},xe={class:"stat-card"},Be={class:"stat-content"},De={class:"stat-value"},Ae={class:"stat-detail"},Ie={key:0,class:"stat-card"},Re={class:"stat-content"},ze={class:"stat-value"},$e={class:"stat-card"},Fe={class:"stat-content"},Ge={class:"stat-value"},Ne={key:1,class:"stat-card"},Ve={class:"stat-content"},Ee={class:"stat-value"},Le={class:"stat-detail"},Oe={key:1,class:"board-sidebar"},je={class:"top-scores-panel"},Ue={class:"top-scores-list"},qe={class:"rank-badge"},He=["src","alt"],Je={key:1,class:"top-score-avatar-placeholder"},Ke={class:"top-score-info"},Qe={class:"top-score-name"},We={class:"top-score-value"},Xe={key:0,class:"no-scores"},Ye={class:"activity-stream-panel"},Ze={class:"activity-stream-list"},Pe=["src","alt"],et={key:1,class:"activity-avatar-placeholder"},tt={class:"activity-content"},st={class:"activity-text"},at={key:0},ot={key:1},nt={key:0,class:"no-activity"},lt={key:2,class:"finish-overlay"},rt={class:"finish-content"},it={class:"final-ranking"},ct={class:"rank"},dt={class:"team-name"},ut={class:"team-members"},mt={class:"team-avg-score"},vt={key:0,class:"winner-reward-section"},_t={class:"winner-reward-header"},pt={class:"winner-reward-title"},ht={class:"winner-reward-amount"},gt={class:"winner-reward-note"},yt={key:3,class:"board-main"},ft={class:"board-main-content"},kt={key:0,class:"recent-completions"},bt={class:"completions-list"},wt=["src","alt"],Tt={key:1,class:"completion-avatar-placeholder"},Ct={class:"completion-info"},St={class:"completion-name"},Mt={class:"completion-score"},xt={class:"teams-battle"},Bt={class:"team-title"},Dt={class:"team-name-row"},At={class:"team-progress"},It={class:"team-score"},Rt={class:"score-value"},zt={class:"members-list"},$t={class:"member-info"},Ft=["src","alt"],Gt={key:1,class:"avatar-placeholder"},Nt={class:"member-name"},Vt={class:"member-status"},Et={class:"score"},Lt={class:"accuracy"},Ot={key:1,class:"status-badge playing"},jt={key:2,class:"status-badge waiting"},Ut=te({__name:"GameBoard",setup(qt){const J=le(),K=se(),w=ie(),Q=i(()=>K.params.roomId),c=i(()=>w.currentRoom),N=i(()=>c.value?.teams||[]),m=i(()=>c.value?.participants||[]),x=U(0);let p=null;const h=i(()=>c.value?.status==="finished"),T=i(()=>N.value.map(a=>{const s=m.value.filter(v=>v.team_id===a.id),t=s.filter(v=>v.status==="completed"),r=s.reduce((v,F)=>v+(F.score||0),0),S=s.length>0?r/s.length:0;return{team:a,memberCount:s.length,completedCount:t.length,averageScore:S}})),B=i(()=>[...T.value].sort((a,s)=>s.averageScore-a.averageScore)),k=i(()=>B.value[0]||null),W=i(()=>k.value?m.value.filter(a=>a.team_id===k.value.team.id):[]),X=i(()=>{const a={};for(const s of N.value)a[s.id]=m.value.filter(t=>t.team_id===s.id).sort((t,r)=>r.score-t.score);return a}),I=i(()=>m.value.filter(a=>a.status==="completed").length),R=i(()=>m.value.length),Y=i(()=>R.value===0?0:Math.round(I.value/R.value*100)),V=i(()=>T.value.length?T.value.map(a=>{const s=_(a.team),t=B.value.findIndex(r=>r.team.id===a.team.id)+1;return{id:a.team.id,team:a.team,displayAvg:a.averageScore,rank:t,productType:s,isMyTeam:!1,name:a.team.team_name,memberCount:a.memberCount,completedCount:a.completedCount}}):[]),z=i(()=>{const a=m.value.filter(v=>v.status==="completed"&&v.time_spent);if(a.length===0)return null;const t=a.reduce((v,F)=>v+(F.time_spent||0),0)/a.length,r=Math.floor(t/60),S=Math.floor(t%60);return{minutes:r,seconds:S}}),Z=i(()=>m.value.length===0?0:Math.max(...m.value.map(a=>a.score||0),0)),E=i(()=>m.value.filter(a=>a.status==="completed"&&a.completed_at).sort((a,s)=>{const t=new Date(a.completed_at).getTime();return new Date(s.completed_at).getTime()-t}).slice(0,5)),C=i(()=>T.value.length===0?null:T.value.reduce((a,s)=>s.completedCount>a.completedCount?s:a)),$=i(()=>{if(!c.value?.started_at||!c.value?.time_limit)return 0;const a=new Date(c.value.started_at).getTime(),s=Math.floor((Date.now()-a)/1e3);return Math.min(s/c.value.time_limit,1)*100}),L=i(()=>[...m.value].filter(a=>a.score>0).sort((a,s)=>(s.score||0)-(a.score||0)).slice(0,3).map((a,s)=>({...a,rank:s+1}))),g=U([]);q(()=>m.value,(a,s)=>{!s||s.length===0||(a.forEach(t=>{const r=s.find(S=>S.id===t.id);r&&(t.status==="completed"&&r.status!=="completed"?g.value.unshift({id:`${t.id}-${Date.now()}`,participant:t,action:"completed",score:t.score,timestamp:Date.now()}):t.score!==r.score&&t.score>r.score&&g.value.unshift({id:`${t.id}-${Date.now()}`,participant:t,action:"scored",score:t.score,timestamp:Date.now()}))}),g.value.length>10&&(g.value=g.value.slice(0,10)))},{deep:!0});function P(a){const s=Math.floor(a/60),t=a%60;return`${s}:${t.toString().padStart(2,"0")}`}function O(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const s=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-s)/1e3);x.value=Math.max(0,c.value.time_limit-t),x.value===0&&(p&&(clearInterval(p),p=null),h.value||w.endGame())};a(),p=setInterval(a,1e3)}async function ee(){confirm("ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ")&&await w.endGame()}function j(){w.reset(),J.push({name:"arena"})}return q(()=>c.value?.status,a=>{a==="playing"&&!p&&O()}),ae(()=>{w.subscribeToRoom(Q.value),c.value?.status==="playing"&&O()}),oe(()=>{p&&clearInterval(p)}),(a,s)=>(o(),l("div",{class:y(["game-board",{finished:h.value}])},[e("header",ue,[e("div",me,[e("button",{class:"back-btn",onClick:j}," â† é›¢é–‹ "),e("div",ve,[e("h1",null,n(c.value?.text?.title),1),c.value?.text?.author?(o(),l("p",_e,n(c.value?.text?.author),1)):d("",!0)])]),e("div",pe,[e("div",{class:y(["countdown",{warning:x.value<30}])},[e("span",he,n(h.value?"æ¯”è³½çµæŸ":"å‰©é¤˜æ™‚é–“"),1),e("span",ge,n(P(x.value)),1)],2)]),e("div",ye,[e("div",fe,[s[0]||(s[0]=e("span",{class:"progress-label"},"å®Œæˆé€²åº¦",-1)),e("span",ke,n(I.value)+" / "+n(m.value.length),1)]),h.value?d("",!0):(o(),l("button",{key:0,class:"btn-danger",onClick:ee}," çµæŸæ¯”è³½ "))])]),!h.value&&V.value.length?(o(),l("div",be,[H(ce,{teams:V.value,height:150,"racer-size":72,"show-rankings":!0,class:"teacher-race-track"},null,8,["teams"]),e("div",we,[e("div",Te,[s[1]||(s[1]=e("span",{class:"time-progress-label"},"æ¯”è³½é€²åº¦",-1)),e("span",Ce,n(Math.round($.value))+"%",1)]),e("div",Se,[e("div",{class:y(["time-progress-fill",{warning:$.value>80}]),style:G({width:`${$.value}%`})},null,6)])]),e("div",Me,[e("div",xe,[s[3]||(s[3]=e("div",{class:"stat-icon"},"ğŸ“Š",-1)),e("div",Be,[e("div",De,n(Y.value)+"%",1),s[2]||(s[2]=e("div",{class:"stat-label"},"å®Œæˆç‡",-1)),e("div",Ae,n(I.value)+" / "+n(R.value)+" äºº",1)])]),z.value?(o(),l("div",Ie,[s[6]||(s[6]=e("div",{class:"stat-icon"},"âš¡",-1)),e("div",Re,[e("div",ze,n(z.value.minutes)+":"+n(z.value.seconds.toString().padStart(2,"0")),1),s[4]||(s[4]=e("div",{class:"stat-label"},"å¹³å‡é€Ÿåº¦",-1)),s[5]||(s[5]=e("div",{class:"stat-detail"},"å·²å®Œæˆå­¸ç”Ÿ",-1))])])):d("",!0),e("div",$e,[s[9]||(s[9]=e("div",{class:"stat-icon"},"ğŸ†",-1)),e("div",Fe,[e("div",Ge,n(Z.value),1),s[7]||(s[7]=e("div",{class:"stat-label"},"æœ€é«˜åˆ†",-1)),s[8]||(s[8]=e("div",{class:"stat-detail"},"å€‹äººè¨˜éŒ„",-1))])]),C.value?(o(),l("div",Ne,[s[11]||(s[11]=e("div",{class:"stat-icon"},"ğŸ”¥",-1)),e("div",Ve,[e("div",Ee,n(C.value.completedCount),1),s[10]||(s[10]=e("div",{class:"stat-label"},"æœ€æ´»èº",-1)),e("div",Le,[u(_)(C.value.team)?(o(),D(A,{key:0,"product-type":u(_)(C.value.team),size:20,class:"team-badge-in-stat"},null,8,["product-type"])):d("",!0),ne(" "+n(C.value.team.team_name),1)])])])):d("",!0)])])):d("",!0),h.value?d("",!0):(o(),l("aside",Oe,[e("div",je,[s[12]||(s[12]=e("h3",{class:"panel-title"},"ğŸ† å¾—åˆ†å‰ä¸‰",-1)),e("div",Ue,[(o(!0),l(f,null,b(L.value,t=>(o(),l("div",{key:t.id,class:y(["top-score-item",{"rank-1":t.rank===1,"rank-2":t.rank===2,"rank-3":t.rank===3}])},[e("span",qe,n(t.rank),1),t.user?.avatar_url?(o(),l("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"top-score-avatar"},null,8,He)):(o(),l("span",Je,n(t.user?.display_name?.charAt(0)||"?"),1)),e("div",Ke,[e("span",Qe,n(t.user?.display_name||"æœªçŸ¥"),1),e("span",We,n(t.score)+" åˆ†",1)])],2))),128)),L.value.length===0?(o(),l("div",Xe," æš«ç„¡åˆ†æ•¸ ")):d("",!0)])]),e("div",Ye,[s[13]||(s[13]=e("h3",{class:"panel-title"},"âš¡ å¯¦æ™‚å‹•æ…‹",-1)),e("div",Ze,[(o(!0),l(f,null,b(g.value,t=>(o(),l("div",{key:t.id,class:y(["activity-item",t.action])},[t.participant.user?.avatar_url?(o(),l("img",{key:0,src:t.participant.user.avatar_url,alt:t.participant.user.display_name,class:"activity-avatar"},null,8,Pe)):(o(),l("span",et,n(t.participant.user?.display_name?.charAt(0)||"?"),1)),e("div",tt,[e("span",st,[e("strong",null,n(t.participant.user?.display_name||"æœªçŸ¥"),1),t.action==="completed"?(o(),l("span",at," å®Œæˆäº†ç­”é¡Œï¼")):t.action==="scored"?(o(),l("span",ot," å¾—åˆ† "+n(t.score),1)):d("",!0)])])],2))),128)),g.value.length===0?(o(),l("div",nt," ç­‰å¾…æ´»å‹•... ")):d("",!0)])])])),h.value?(o(),l("div",lt,[e("div",rt,[s[16]||(s[16]=e("div",{class:"trophy"},"ğŸ†",-1)),s[17]||(s[17]=e("h2",null,"æ¯”è³½çµæŸï¼",-1)),e("div",it,[(o(!0),l(f,null,b(B.value,(t,r)=>(o(),l("div",{key:t.team.id,class:y(["ranking-item",{winner:r===0}]),style:G({"--team-primary":u(M)[t.team.team_color].primary,"--team-secondary":u(M)[t.team.team_color].secondary})},[e("span",ct,n(r===0?"ğŸ†":r+1),1),u(_)(t.team)?(o(),D(A,{key:0,"product-type":u(_)(t.team),size:28,class:"team-badge-in-mini-ranking"},null,8,["product-type"])):d("",!0),e("span",dt,n(t.team.team_name),1),e("span",ut,n(t.completedCount)+"/"+n(t.memberCount)+" äºº",1),e("span",mt,n(t.averageScore.toFixed(1))+" åˆ†",1)],6))),128))]),k.value?(o(),l("div",vt,[e("div",_t,[u(_)(k.value.team)?(o(),D(A,{key:0,"product-type":u(_)(k.value.team),size:40,class:"winner-badge"},null,8,["product-type"])):d("",!0),e("div",pt,[e("h3",null,n(k.value.team.team_name)+" ç²å‹ï¼",1),s[14]||(s[14]=e("p",{class:"winner-reward-subtitle"},"æ¯ä½æˆå“¡ç²å¾—",-1))])]),e("div",ht,[s[15]||(s[15]=e("span",{class:"reward-number"},"20",-1)),H(de,{size:48,class:"reward-bean-icon"})]),e("p",gt,"å…± "+n(W.value.length)+" ä½æˆå“¡",1)])):d("",!0),s[18]||(s[18]=e("p",{class:"scoring-note"},"* ä»¥éšŠå“¡å¹³å‡åˆ†è¨ˆç®—æ’å",-1)),e("button",{class:"btn-primary btn-large",onClick:j}," è¿”å›é¬¥è±† ")])])):(o(),l("main",yt,[e("div",ft,[E.value.length>0?(o(),l("div",kt,[s[19]||(s[19]=e("h3",{class:"section-title"},"ğŸ‰ æœ€è¿‘å®Œæˆ",-1)),e("div",bt,[(o(!0),l(f,null,b(E.value,t=>(o(),l("div",{key:t.id,class:"completion-item"},[t.user?.avatar_url?(o(),l("img",{key:0,src:t.user.avatar_url,alt:t.user.display_name,class:"completion-avatar"},null,8,wt)):(o(),l("span",Tt,n(t.user?.display_name?.charAt(0)||"?"),1)),e("div",Ct,[e("span",St,n(t.user?.display_name||"æœªçŸ¥"),1),e("span",Mt,n(t.score)+" åˆ†",1)])]))),128))])])):d("",!0),e("div",xt,[(o(!0),l(f,null,b(B.value,t=>(o(),l("div",{key:t.team.id,class:"team-column",style:G({"--team-primary":u(M)[t.team.team_color].primary,"--team-secondary":u(M)[t.team.team_color].secondary,"--team-text":u(M)[t.team.team_color].text})},[e("div",Bt,[e("div",Dt,[u(_)(t.team)?(o(),D(A,{key:0,"product-type":u(_)(t.team),size:40,class:"team-badge-in-title"},null,8,["product-type"])):d("",!0),e("h2",null,n(t.team.team_name),1),e("span",At,n(t.completedCount)+"/"+n(t.memberCount),1)]),e("div",It,[e("span",Rt,n(t.averageScore.toFixed(1)),1),s[20]||(s[20]=e("span",{class:"score-label"},"å¹³å‡åˆ†",-1))])]),e("div",zt,[(o(!0),l(f,null,b(X.value[t.team.id],r=>(o(),l("div",{key:r.id,class:y(["member-row",{completed:r.status==="completed"}])},[e("div",$t,[r.user?.avatar_url?(o(),l("img",{key:0,src:r.user.avatar_url,alt:r.user.display_name,class:"avatar"},null,8,Ft)):(o(),l("span",Gt,n(r.user?.display_name?.charAt(0)||"?"),1)),e("span",Nt,n(r.user?.display_name||"æœªçŸ¥"),1)]),e("div",Vt,[r.status==="completed"?(o(),l(f,{key:0},[e("span",Et,n(r.score)+" åˆ†",1),e("span",Lt,n(r.accuracy?.toFixed(0))+"%",1)],64)):r.status==="playing"?(o(),l("span",Ot,"ä½œç­”ä¸­...")):(o(),l("span",jt,"ç­‰å¾…ä¸­"))])],2))),128))])],4))),128))])])]))],2))}}),Zt=re(Ut,[["__scopeId","data-v-8652874b"]]);export{Zt as default};
