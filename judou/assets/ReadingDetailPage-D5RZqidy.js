import{d as ie,u as ce,c as N,x as ue,r as y,f as de,P as he,Q as fe,w as ve,a as u,g as s,h as _,m as L,t as f,i as p,b as B,q as pe,F as z,j as U,s as $,n as ge,N as me,l as ke,o as i,_ as _e}from"./index-Bbub5OHM.js";import{u as xe}from"./readingStore-D6hobKV0.js";import{a as q,S as ye,V as be,c as Te,b as Ce}from"./useClassicalTTS-DvoHXk4O.js";import"./useSupabase-BcwyO-uO.js";import"./createLucideIcon-CsWIVTcU.js";const Se={class:"reading-detail-page"},we={class:"reading-header edamame-glass"},Be={class:"header-title"},Pe={class:"title-meta"},Ae={key:0,class:"author"},Re={key:1,class:"source-tag"},Me={class:"header-actions"},Ne={class:"control-bar edamame-glass"},ze=["aria-pressed"],De={class:"toggle-switch"},Ee={key:0,class:"reading-content edamame-glass"},Ie={class:"reading-line"},Ve=["onMouseenter"],Fe=["onClick","disabled"],Le={key:0,class:"verification-result"},Ue={class:"result-stats"},$e={class:"stat correct"},qe={class:"stat missed"},Oe={class:"stat extra"},Xe={class:"stat accuracy"},je={class:"content-actions"},He=["disabled"],Qe={key:1,class:"loading-state edamame-glass"},Ye={class:"tooltip-term"},Ge={key:0,class:"tooltip-pinyin"},Je={class:"tooltip-content"},Ke=ie({__name:"ReadingDetailPage",setup(We){const O=ue(),X=ke(),o=xe(),D=ce(),P=N(()=>O.params.id),v=y(!0),b=y(new Set),r=y(null),m=y(null),x=y(!1),T=N(()=>{if(!o.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const t=o.currentText.content,e=t.includes("||")?"||":/\n\n+/,a=t.split(e),d=[],c=[],n=new Set;let h=0;for(const l of a){const g=[],k=new Set,F=h,R=l.replace(/[\|\s]+$/,"");for(const w of R)w==="|"?h>0&&(n.add(h-1),k.add(g.length-1)):w!==`
`&&w!=="\r"&&(c.push(w),g.push(w),h++);g.length>0&&d.push({chars:g,breaks:k,startIdx:F,endIdx:h-1})}return{paragraphs:d,allChars:c,allBreaks:n}}),E=N(()=>T.value.paragraphs),j=y(0);function C(t){return o.currentText?.annotations&&o.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const A=y(null);function H(t){return A.value?C(t)?.id===A.value:!1}function Q(t){return C(t)?.start_index===t}function Y(t){const e=C(t);return e?e.end_index-1===t:!1}function G(t,e){const a=C(t);a&&(A.value=a.id,te(a,e))}function J(){A.value=null,se()}function K(t){if(v.value)return;const e=new Set(b.value);e.has(t)?e.delete(t):e.add(t),b.value=e,r.value=null}function W(){const{allBreaks:t,allChars:e}=T.value;if(!e.length)return;const a=[],d=[],c=[];for(let l=0;l<e.length;l++){const g=t.has(l),k=b.value.has(l);g&&k?a.push(l):g&&!k?d.push(l):!g&&k&&c.push(l)}const n=t.size,h=n>0?a.length/n:1;r.value={correct:a,missed:d,extra:c,accuracy:h}}function Z(){v.value=!0,r.value=null}function ee(){b.value=new Set,r.value=null}function te(t,e){m.value={annotation:t,x:e.clientX,y:e.clientY}}function se(){m.value=null}function I(){const{allChars:t,allBreaks:e,paragraphs:a}=T.value;if(!t.length)return[];const d=[];for(const c of a){let n="",h=c.startIdx-1;for(let l=c.startIdx;l<=c.endIdx;l++){const g=l-c.startIdx;n+=c.chars[g];const k=e.has(l);if(l===c.endIdx)n+="。";else if(k){const R=l-h;h=l,R>=8?n+="。":R>=4?n+="，":n+="、"}}n.trim()&&d.push(n)}return d}let S=!1;function V(){S=!0,Te(),x.value=!1}const M={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function ae(){if(!T.value.allChars.length)return;if(x.value){V();return}x.value=!0,S=!1;const t=I();try{for(let e=0;e<t.length&&!S;e++){const a=t[e+1];a&&q(a,M);const d=t[e];d&&await Ce(d,M)}}catch(e){console.error("TTS 播放失敗:",e),S||alert("語音朗讀失敗，請稍後再試")}finally{x.value=!1,S=!1}}async function ne(){if(!D.isAuthenticated){alert("請先登入以使用書籤功能");return}await o.toggleBookmark(P.value)}function oe(){X.push({name:"reading-list"})}function re(t){const e=[],{allBreaks:a}=T.value;return v.value?a.has(t)&&e.push("has-break","correct"):b.value.has(t)?(e.push("has-break","user-marked"),r.value&&(r.value.correct.includes(t)?e.push("verified-correct"):r.value.extra.includes(t)&&e.push("verified-extra"))):r.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}de(async()=>{await o.fetchTextDetail(P.value),o.startReadingTracking(),o.currentText?.progress&&(j.value=o.currentText.progress.last_paragraph),await he();const e=I()[0];e&&q(e,M)});function le(){return r.value?Math.round(r.value.accuracy*100):v.value?50:0}return fe(()=>{if(V(),P.value&&D.isAuthenticated){const t=le(),e=r.value?.accuracy===1;o.saveReadingRecord(P.value,t,e)}}),ve(v,t=>{t&&(r.value=null)}),(t,e)=>(i(),u("div",Se,[s("header",we,[s("button",{class:"back-btn",onClick:oe}," ← 返回 "),s("div",Be,[s("h1",null,f(p(o).currentText?.title||"載入中..."),1),s("div",Pe,[p(o).currentText?.author?(i(),u("span",Ae,f(p(o).currentText.author),1)):_("",!0),p(o).currentText?.source_text?.title?(i(),u("span",Re," · 選自《"+f(p(o).currentText.source_text.title)+"》 ",1)):_("",!0)])]),s("div",Me,[s("button",{class:B(["action-btn bookmark-btn",{active:p(o).currentText?.progress?.bookmarked}]),onClick:ne,title:"收藏"},f(p(o).currentText?.progress?.bookmarked?"⭐":"☆"),3)])]),s("section",Ne,[s("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=a=>v.value=!v.value),"aria-pressed":v.value,type:"button"},[e[2]||(e[2]=s("span",{class:"toggle-label"},"顯示斷句",-1)),s("span",De,[s("span",{class:B(["toggle-track",{active:v.value}])},[...e[1]||(e[1]=[s("span",{class:"toggle-thumb"},null,-1)])],2)])],8,ze),s("button",{class:B(["tts-btn",{playing:x.value}]),onClick:ae},[(i(),L(pe(x.value?p(ye):p(be)),{size:18,"stroke-width":1.5})),s("span",null,f(x.value?" 停止朗讀":" 朗讀全文"),1)],2)]),p(o).currentText&&E.value.length>0?(i(),u("section",Ee,[(i(!0),u(z,null,U(E.value,(a,d)=>(i(),u("div",{key:d,class:"paragraph-block"},[s("div",Ie,[(i(!0),u(z,null,U(a.chars,(c,n)=>(i(),u("span",{key:n,class:"char-unit"},[s("span",{class:B(["char",{"has-annotation":C(a.startIdx+n),"annotation-hovered":H(a.startIdx+n),"annotation-start":Q(a.startIdx+n),"annotation-end":Y(a.startIdx+n)}]),onMouseenter:h=>G(a.startIdx+n,h),onMouseleave:J},f(c),43,Ve),n<a.chars.length-1?(i(),u("button",{key:0,class:B(["break-slot",re(a.startIdx+n)]),onClick:h=>K(a.startIdx+n),disabled:v.value},[...e[3]||(e[3]=[s("span",{class:"break-marker"},null,-1)])],10,Fe)):_("",!0)]))),128))])]))),128)),r.value?(i(),u("div",Le,[s("div",Ue,[s("span",$e,"✓ 正確："+f(r.value.correct.length),1),s("span",qe,"○ 遺漏："+f(r.value.missed.length),1),s("span",Oe,"✗ 多餘："+f(r.value.extra.length),1),s("span",Xe," 正確率："+f(Math.round(r.value.accuracy*100))+"% ",1)]),s("button",{class:"show-answer-btn",onClick:Z}," 查看正確答案 ")])):_("",!0),s("div",je,[v.value?_("",!0):(i(),u(z,{key:0},[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:ee}," 重置 "),s("button",{class:"edamame-btn edamame-btn-primary",onClick:W,disabled:b.value.size===0}," ✓ 驗證我的斷句 ",8,He)],64))])])):p(o).isLoading?(i(),u("section",Qe,[...e[4]||(e[4]=[s("span",{class:"loading-spinner"},null,-1),$(" 載入中... ",-1)])])):_("",!0),(i(),L(me,{to:"body"},[m.value?(i(),u("div",{key:0,class:"annotation-tooltip",style:ge({left:m.value.x+"px",top:m.value.y+16+"px"})},[s("div",Ye,[$(f(m.value.annotation.term)+" ",1),m.value.annotation.pinyin?(i(),u("span",Ge,"（"+f(m.value.annotation.pinyin)+"）",1)):_("",!0)]),s("div",Je,f(m.value.annotation.annotation),1)],4)):_("",!0)]))]))}}),nt=_e(Ke,[["__scopeId","data-v-a2b7435b"]]);export{nt as default};
