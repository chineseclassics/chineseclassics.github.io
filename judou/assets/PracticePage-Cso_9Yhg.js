import{d as He,u as We,r as d,c as T,x as Fe,f as Qe,E as Je,a as r,g as a,h as k,t as i,s as b,m as ke,G as ye,b as y,H as Ke,I as Ye,F as p,j as L,q as Ze,i as j,e as ge,v as et,p as tt,n as st,o as l,_ as at}from"./index-B_C-lTFC.js";import{u as nt}from"./textsStore-DclARax2.js";import{u as lt}from"./practiceLibraryStore-ChNTxT0v.js";import{u as rt}from"./assignmentStore-CbgE4fN3.js";import{u as ot}from"./userStatsStore--mYQquiM.js";import{u as it}from"./classStore-Dx1AeZHb.js";import{u as ut}from"./avatarStore-C-HkXCge.js";import{S as ct,V as dt,c as vt,a as mt,b as pt}from"./useClassicalTTS-B7zpFlZl.js";import{C as ft}from"./clock-Cdzlt2ZT.js";import{c as ht}from"./createLucideIcon-BgbcqfpR.js";import"./useSupabase-BRrhj7CO.js";const _t=ht("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),kt={class:"practice-shell"},yt={class:"picker-section edamame-glass"},gt={class:"picker-current"},bt={class:"picker-info"},Tt={class:"picker-breadcrumb"},wt={key:0,class:"picker-meta"},St={key:0},Ct={key:0,class:"picker-panel"},xt={class:"picker-search"},At={key:0,class:"picker-results"},Bt={key:0,class:"picker-empty"},$t=["onClick"],Rt={class:"item-main"},It={class:"item-title"},Vt={class:"item-author"},zt={class:"item-preview"},Nt={key:1,class:"picker-cascade"},Pt={class:"grade-filter-section"},Mt={class:"grade-tags"},Lt=["onClick"],qt={class:"picker-list"},Et={key:0,class:"picker-empty"},Ut={key:1,class:"picker-empty"},jt=["onClick"],Dt={class:"item-main"},Gt={class:"item-title"},Ot={class:"item-author"},Xt={class:"item-preview"},Ht={class:"hero-actions"},Wt=["disabled"],Ft={class:"board-card edamame-glass"},Qt={key:0,class:"practice-board"},Jt={class:"board-header"},Kt={class:"board-header-right"},Yt={key:1,class:"timer-badge"},Zt={key:0,class:"practice-line"},es=["onPointerdown","aria-label"],ts={key:0,class:"bean"},ss={key:1,class:"state-info"},as={class:"board-actions"},ns=["disabled"],ls={key:1,class:"board-empty"},rs={class:"results-grid"},os={class:"result-card edamame-glass"},is={class:"result-desc"},us={class:"result-card edamame-glass"},cs={class:"result-desc"},ds={class:"result-card edamame-glass"},vs={class:"result-desc"},ms={class:"result-card edamame-glass"},ps={class:"result-desc"},fs={key:0,class:"new-record"},hs={key:1},_s={key:2},ks=He({__name:"PracticePage",setup(ys){const Z=Fe(),w=nt(),D=lt(),be=rt(),h=We(),G=ot(),ee=it(),Te=ut(),te=d(new Set),se=T(()=>Z.query.assignmentId),ae=T(()=>Z.query.textId),u=d(null),g=d([]),S=d(new Set),m=d(new Set),o=d(null),V=d(0),v=d(null),O=d(!1),X=d(0),ne=d(0),le=d(0),H=d(!1),W=d(!1),re=T(()=>S.value.size),we=T(()=>m.value.size),oe=T(()=>Math.max(0,re.value-we.value)),ie=T(()=>oe.value>0),z=d(!1),C=d(null),A=d(""),Se=d(localStorage.getItem("judou_username")||"guest"),Ce=d(localStorage.getItem("judou_display_name")||"è¨ªå®¢å­¸å“¡"),B=d(!1);let N=null;const x=d(null);function ue(){x.value||(x.value=new(window.AudioContext||window.webkitAudioContext))}function F(t){if(x.value||ue(),!x.value)return;const e=x.value,n=e.createOscillator(),s=e.createGain();n.connect(s),s.connect(e.destination),t==="add"?(n.frequency.setValueAtTime(400,e.currentTime),n.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),n.start(e.currentTime),n.stop(e.currentTime+.1)):(n.frequency.setValueAtTime(300,e.currentTime),n.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),n.start(e.currentTime),n.stop(e.currentTime+.08))}function ce(t=10){navigator.vibrate&&navigator.vibrate(t)}const Q=T(()=>D.state.categories.filter(t=>t.level===1).sort((t,e)=>t.order_index-e.order_index));function J(t){return!!(t.is_system===!0||t.created_by===h.user?.id||h.isStudent&&t.created_by&&te.value.has(t.created_by))}const de=T(()=>C.value?w.texts.filter(t=>t.category_id!==C.value?!1:J(t)).sort((t,e)=>t.title.localeCompare(e.title)):[]),ve=T(()=>{if(!A.value.trim())return[];const t=A.value.toLowerCase();return w.texts.filter(e=>J(e)?e.title.toLowerCase().includes(t)||e.author&&e.author.toLowerCase().includes(t)||e.source&&e.source.toLowerCase().includes(t):!1).slice(0,10)}),xe=T(()=>{if(!u.value)return"å°šæœªé¸æ“‡ç·´ç¿’ç´ æ";const t=[];return u.value.category?.name&&t.push(u.value.category.name),t.push(u.value.title),t.join(" â€º ")});async function Ae(){if(!h.isStudent||!h.isAuthenticated)return;await ee.fetchStudentClasses();const t=new Set;for(const e of ee.classes)e.teacher_id&&t.add(e.teacher_id);te.value=t}function Be(t){const e=[],n=new Set;let s=0;const c=t.replace(/[\|\s]+$/,"");for(const _ of c)_==="|"?s>0&&n.add(s-1):_!==`
`&&_!=="\r"&&(e.push(_),s++);return{chars:e,breaks:n}}function $e(){q(),V.value=0,N=window.setInterval(()=>{V.value+=1},1e3)}function q(){N&&(clearInterval(N),N=null)}function K(t){const{chars:e,breaks:n}=Be(t.content);g.value=e,S.value=n,m.value=new Set,o.value=null,v.value=null,q(),V.value=0,X.value=0,ne.value=0,le.value=0,H.value=!1}function E(t){u.value=t,K(t),z.value=!1,A.value="",t.category_id&&(C.value=t.category_id)}function me(){const t=w.texts.filter(_=>_.text_type==="practice"&&J(_));if(!t.length){v.value="å°šæœªæœ‰å¯ç·´ç¿’çš„æ–‡ç« ï¼Œè«‹å…ˆåˆ°ç®¡ç†å“¡é é¢æ–°å¢ã€‚";return}const e=u.value?.id,n=t.filter(_=>_.id!==e);if(!n.length){v.value="ç›®å‰åªæœ‰ä¸€ç¯‡æ–‡ç« å¯ç·´ç¿’";return}const s=Math.floor(Math.random()*n.length),c=n[s];c&&E(c)}async function Re(){const t=[];if(w.texts.length||t.push(w.fetchTexts()),D.state.categories.length||t.push(D.fetchLibrary()),h.isStudent&&h.isAuthenticated&&t.push(Ae()),await Promise.all(t),ae.value){const e=w.texts.find(n=>n.id===ae.value);if(e){E(e);return}}if(!u.value&&w.texts.length&&me(),!C.value&&Q.value.length){const e=Q.value[0];e&&(C.value=e.id)}}function Ie(t){if(o.value){v.value="å·²æäº¤ï¼å¦‚è¦å†æ¬¡å˜—è©¦è«‹é»æ“Šã€Œé‡æ–°æŒ‘æˆ°ã€";return}const e=new Set(m.value),n=e.has(t);if(!n&&!ie.value){Ve(),v.value="è±†å­ç”¨å®Œäº†ï¼è«‹å…ˆç§»é™¤å¤šé¤˜çš„æ–·å¥ã€‚";return}m.value.size===0&&!N&&!H.value&&$e(),n?(e.delete(t),F("remove")):(e.add(t),F("add"),ce(10)),m.value=e,v.value=null}function Ve(){W.value=!0,F("remove"),ce(50),setTimeout(()=>{W.value=!1},400)}function ze(t){if(!o.value){const e=t>0&&m.value.has(t-1),n=m.value.has(t);if(e&&n)return"translateX(0)";if(e)return"translateX(4px)";if(n)return"translateX(-4px)"}return"translateX(0)"}function Ne(t){const e=[],n=m.value.has(t);if(n&&e.push("has-bean"),o.value&&n){const s=o.value.statuses.find(c=>c.index===t);s&&(s.state==="correct"||s.state==="extra")&&e.push(s.state)}return e}function Pe(t){return`${t} è±†`}function Me(t){return`${Math.round(t*100)}%`}function pe(t){return t.content.replace(/\|/g,"").slice(0,30)+"..."}function Le(t,e){return G.calculateScore({correctCount:t,totalBreaks:S.value.size,charCount:g.value.length,elapsedSeconds:e})}async function qe(){if(!u.value)return;if(!m.value.size){v.value="è‡³å°‘è¨­å®šä¸€å€‹æ–·å¥ä½ç½®å†æäº¤å”·ï¼";return}X.value++;const t=[];let e=0,n=0,s=0;for(let f=0;f<=g.value.length;f++){const M=m.value.has(f),I=S.value.has(f);M&&I?(t.push({index:f,state:"correct"}),e++):!M&&I?(t.push({index:f,state:"missed"}),n++):M&&!I?(t.push({index:f,state:"extra"}),s++):t.push({index:f,state:"pending"})}const c=S.value.size?e/S.value.size:m.value.size?0:1,_=n===0&&s===0;q(),H.value=!0;const U=V.value;X.value===1&&(ne.value=c,le.value=U);const{score:R,breakdown:Y}=Le(e,U);if(o.value={statuses:t,accuracy:c,elapsed:U,score:R,isComplete:_,breakdown:Y},_){Ue();const f=Y.speedBonus>0?` + é€Ÿåº¦çå‹µ ${Y.speedBonus}`:"";v.value=`ğŸ‰ å…¨å°ï¼æ­£ç¢º ${e} è±†${f} = ${R} è±†`}else v.value=`æ­£ç¢º ${e} å€‹ï¼Œéºæ¼ ${n} å€‹ï¼Œå¤šé¤˜ ${s} å€‹ â†’ ç²å¾— ${R} è±†`;try{O.value=!0;const f=h.isAuthenticated?h.user?.email?.split("@")[0]||"user":Se.value,M=h.isAuthenticated?h.displayName:Ce.value,I=await w.recordPracticeResult({text_id:u.value.id,score:R,accuracy:c,elapsed_seconds:U,user_breaks:m.value.size,correct_breaks:S.value.size,username:f,display_name:M,user_id:h.user?.id||null});if(h.isAuthenticated){const $=await G.recordPracticeScore({textId:u.value.id,score:R,textTitle:u.value.title});if(o.value&&(o.value.beansEarned=$.beansEarned,o.value.isNewRecord=$.isNewRecord),$.beansEarned>0){const Oe=$.isNewRecord?" (æ–°ç´€éŒ„!)":"";v.value=`${v.value}${Oe} å¯¦å¾— +${$.beansEarned} è±†`;const _e=await Te.checkAndUnlockAvatars(G.level);_e.length>0&&setTimeout(()=>{v.value=`ğŸ‰ è§£é–æ–°é ­åƒï¼š${_e.map(Xe=>Xe.name).join("ã€")}`},2e3)}else $.beansEarned===0&&!$.isNewRecord&&(v.value=`${v.value}ï¼ˆæœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„ï¼Œä¸åŠ åˆ†ï¼‰`)}se.value&&h.isAuthenticated&&I&&await be.recordCompletion(se.value,I,R,c*100)}catch(f){console.warn("è¨˜éŒ„ç·´ç¿’çµæœå¤±æ•—",f)}finally{O.value=!1}}function Ee(){u.value&&K(u.value)}function Ue(){if(x.value||ue(),!x.value)return;const t=x.value,e=t.createOscillator(),n=t.createGain();e.connect(n),n.connect(t.destination),e.frequency.setValueAtTime(400,t.currentTime),e.frequency.exponentialRampToValueAtTime(600,t.currentTime+.1),e.frequency.exponentialRampToValueAtTime(800,t.currentTime+.2),n.gain.setValueAtTime(.3,t.currentTime),n.gain.exponentialRampToValueAtTime(.01,t.currentTime+.3),e.start(t.currentTime),e.stop(t.currentTime+.3)}function je(){if(!g.value.length)return[];const t=[];let e="",n=-1;for(let s=0;s<g.value.length;s++)if(e+=g.value[s],S.value.has(s)){const c=s-n;n=s,c>=8?(e+="ã€‚",t.push(e),e=""):c>=4?e+="ï¼Œ":e+="ã€"}return e.trim()&&(!e.endsWith("ã€‚")&&!e.endsWith("ï¼Œ")&&!e.endsWith("ã€")&&(e+="ã€‚"),t.push(e)),t.length===0&&g.value.length>0?[g.value.join("")+"ã€‚"]:t}let P=!1;function fe(){P=!0,vt(),B.value=!1}const he={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function De(){if(!g.value.length)return;if(B.value){fe();return}B.value=!0,P=!1;const t=je();try{for(let e=0;e<t.length&&!P;e++){const n=t[e+1];n&&mt(n,he);const s=t[e];s&&await pt(s,he)}}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),P||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{B.value=!1,P=!1}}function Ge(){u.value&&K(u.value)}return Qe(()=>{Re()}),Je(()=>{q(),fe()}),(t,e)=>{const n=et("router-link");return l(),r("div",kt,[a("section",yt,[a("div",{class:"picker-header",onClick:e[1]||(e[1]=s=>z.value=!z.value)},[a("div",gt,[e[3]||(e[3]=a("span",{class:"picker-icon"},"ğŸ“–",-1)),a("div",bt,[a("span",Tt,i(xe.value),1),u.value?(l(),r("span",wt,[b(i(u.value.author||"ä½šå")+" ",1),u.value.source?(l(),r("span",St," Â· "+i(u.value.source),1)):k("",!0),u.value.source_text?.id?(l(),ke(n,{key:1,to:{name:"reading-detail",params:{id:u.value.source_text.id}},class:"source-link",onClick:e[0]||(e[0]=ye(()=>{},["stop"]))},{default:tt(()=>[b(" Â· ä¾†è‡ªã€Š"+i(u.value.source_text.title)+"ã€‹ ",1)]),_:1},8,["to"])):k("",!0)])):k("",!0)])]),a("button",{class:y(["picker-toggle",{expanded:z.value}])},[...e[4]||(e[4]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[a("path",{d:"M6 9l6 6 6-6"})],-1)])],2)]),z.value?(l(),r("div",Ct,[a("div",xt,[Ke(a("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>A.value=s),type:"text",placeholder:"æœç´¢æ–‡ç« æ¨™é¡Œã€ä½œè€…...",class:"search-input"},null,512),[[Ye,A.value]])]),A.value.trim()?(l(),r("div",At,[ve.value.length?k("",!0):(l(),r("div",Bt," æ‰¾ä¸åˆ°ç¬¦åˆã€Œ"+i(A.value)+"ã€çš„æ–‡ç«  ",1)),(l(!0),r(p,null,L(ve.value,s=>(l(),r("div",{key:s.id,class:"picker-item",onClick:c=>E(s)},[a("div",Rt,[a("span",It,i(s.title),1),a("span",Vt,i(s.author||"ä½šå"),1)]),a("span",zt,i(pe(s)),1)],8,$t))),128))])):(l(),r("div",Nt,[a("div",Pt,[e[5]||(e[5]=a("label",{class:"grade-filter-label"},"å¹´ç´š",-1)),a("div",Mt,[(l(!0),r(p,null,L(Q.value,s=>(l(),r("button",{key:s.id,class:y(["grade-tag",{active:C.value===s.id}]),onClick:c=>C.value=s.id},i(s.name),11,Lt))),128))])]),a("div",qt,[C.value?de.value.length?k("",!0):(l(),r("div",Ut," æ­¤å¹´ç´šå°šç„¡æ–‡ç«  ")):(l(),r("div",Et," è«‹é¸æ“‡å¹´ç´šä»¥æŸ¥çœ‹æ–‡ç«  ")),(l(!0),r(p,null,L(de.value,s=>(l(),r("div",{key:s.id,class:y(["picker-item",{active:u.value?.id===s.id}]),onClick:c=>E(s)},[a("div",Dt,[a("span",Gt,i(s.title),1),a("span",Ot,i(s.author||"ä½šå"),1),a("span",{class:y(["item-difficulty",`diff-${s.difficulty}`])},i(s.difficulty===1?"åˆç´š":s.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),3)]),a("span",Xt,i(pe(s)),1)],10,jt))),128))])]))])):k("",!0)]),a("div",Ht,[a("button",{class:"edamame-btn edamame-btn-secondary",onClick:Ge,disabled:!u.value}," é‡æ–°é–‹å§‹ ",8,Wt),a("button",{class:"edamame-btn edamame-btn-primary",onClick:me}," éš¨æ©Ÿä¸€ç¯‡ ")]),a("section",Ft,[u.value?(l(),r("div",Qt,[a("div",Jt,[e[6]||(e[6]=a("p",{class:"board-hint"},"é»æ“Šå­—é–“ç©ºéš™ç¨®ä¸‹å¥è±†ä¾†æ–·å¥",-1)),a("div",Kt,[o.value?.isComplete?(l(),r("button",{key:0,class:y(["tts-btn-small",{playing:B.value}]),onClick:De},[(l(),ke(Ze(B.value?j(ct):j(dt)),{size:16,"stroke-width":1.5})),a("span",null,i(B.value?" åœæ­¢":" æœ—è®€"),1)],2)):k("",!0),a("div",{class:y(["bean-inventory",{shake:W.value,empty:!ie.value}])},[(l(!0),r(p,null,L(re.value,s=>(l(),r("span",{key:s,class:y(["inventory-bean",{used:s>oe.value}])},null,2))),128))],2),m.value.size>0||o.value?(l(),r("span",Yt,[ge(j(ft),{size:14,"stroke-width":1.5}),a("span",null,i(V.value)+" ç§’",1)])):k("",!0)])]),g.value.length?(l(),r("div",Zt,[(l(!0),r(p,null,L(g.value,(s,c)=>(l(),r("span",{key:c,class:"char-unit"},[a("span",{class:"char",style:st({transform:ze(c)})},i(s),5),c<g.value.length-1?(l(),r("button",{key:0,class:y(["bean-slot",Ne(c)]),onPointerdown:ye(_=>Ie(c),["prevent"]),"aria-label":`åœ¨ã€Œ${s}ã€å¾Œ${m.value.has(c)?"ç§»é™¤":"æ·»åŠ "}æ–·å¥`},[m.value.has(c)?(l(),r("span",ts)):k("",!0),e[7]||(e[7]=a("span",{class:"bean-hint"},null,-1))],42,es)):k("",!0)]))),128))])):(l(),r("div",ss,"å°šç„¡å¯é¡¯ç¤ºçš„æ–‡å­—å…§å®¹ã€‚")),a("div",as,[o.value?(l(),r("button",{key:1,class:"edamame-btn edamame-btn-lg edamame-btn-secondary",onClick:Ee},[ge(j(_t),{size:18,"stroke-width":1.5}),e[8]||(e[8]=a("span",null," é‡æ–°æŒ‘æˆ°",-1))])):(l(),r("button",{key:0,class:"edamame-btn edamame-btn-lg edamame-btn-primary",disabled:O.value,onClick:qe}," æäº¤ç­”æ¡ˆ ",8,ns))]),v.value?(l(),r("p",{key:2,class:y(["toast",{success:o.value?.isComplete}])},i(v.value),3)):k("",!0)])):(l(),r("div",ls,[...e[9]||(e[9]=[a("p",null,"è«‹å¾ä¸Šæ–¹é¸æ“‡ç·´ç¿’ç´ æï¼Œæˆ–é»æ“Šã€Œéš¨æ©Ÿä¸€ç¯‡ã€é–‹å§‹ç·´ç¿’",-1)])]))]),a("section",rs,[a("article",os,[e[10]||(e[10]=a("p",{class:"result-label"},"æœ¬æ¬¡å¾—åˆ†",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},i(o.value?Pe(o.value.score):"--"),3),a("p",is,[o.value?.breakdown?(l(),r(p,{key:0},[b(" æ­£ç¢º "+i(o.value.breakdown.baseScore)+" è±† ",1),o.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[b(" + é€Ÿåº¦ "+i(o.value.breakdown.speedBonus)+" è±† ",1)],64)):k("",!0)],64)):(l(),r(p,{key:1},[b(" å°å¹¾å€‹å¾—å¹¾è±† ")],64))])]),a("article",us,[e[11]||(e[11]=a("p",{class:"result-label"},"æ­£ç¢ºç‡",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},i(o.value?Me(o.value.accuracy):"--"),3),a("p",cs,[o.value?(l(),r(p,{key:0},[b(i(o.value.isComplete?"ğŸ‰ å…¨å°ï¼":"ç¹¼çºŒåŠ æ²¹"),1)],64)):(l(),r(p,{key:1},[b(" æ­£ç¢ºæ•¸ Ã· ç¸½æ–·å¥æ•¸ ")],64))])]),a("article",ds,[e[12]||(e[12]=a("p",{class:"result-label"},"ç”¨æ™‚",-1)),a("p",{class:y(["result-value",{placeholder:!o.value}])},i(o.value?`${o.value.elapsed} ç§’`:"--"),3),a("p",vs,[o.value?.breakdown?(l(),r(p,{key:0},[b(" åŸºæº– "+i(o.value.breakdown.baseTime)+" ç§’ ",1),o.value.breakdown.speedBonus>0?(l(),r(p,{key:0},[b(" Â· ç¯€çœ "+i(o.value.breakdown.baseTime-o.value.elapsed)+" ç§’ ",1)],64)):k("",!0)],64)):(l(),r(p,{key:1},[b(" å…¨å°æ‰æœ‰é€Ÿåº¦çå‹µ ")],64))])]),a("article",ms,[e[13]||(e[13]=a("p",{class:"result-label"},"å¯¦å¾—è±†å­",-1)),a("p",{class:y(["result-value",{placeholder:!o.value||o.value.beansEarned===void 0}])},i(o.value?.beansEarned!==void 0?`+${o.value.beansEarned}`:"--"),3),a("p",ps,[o.value?.beansEarned!==void 0?(l(),r(p,{key:0},[o.value.isNewRecord?(l(),r("span",fs,"ğŸ† æ–°ç´€éŒ„ï¼")):o.value.beansEarned===0?(l(),r("span",hs,"æœªè¶…éå€‹äººæœ€é«˜è¨˜éŒ„")):(l(),r("span",_s,"å¢é‡åŠ åˆ†"))],64)):(l(),r(p,{key:1},[b(" ç™»å…¥å¾Œè¨˜éŒ„ ")],64))])])])])}}}),Is=at(ks,[["__scopeId","data-v-fcf0bc73"]]);export{Is as default};
