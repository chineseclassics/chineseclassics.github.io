import{x as te,u as ae,r as h,c as b,I as n}from"./index-CD8n1t7s.js";import{u as re}from"./userStatsStore-CaUXbCL7.js";const ue=[0,10,30,50,100],ce=[{value:60,label:"é–ƒé›»æˆ°",description:"1 åˆ†é˜"},{value:180,label:"æ¨™æº–",description:"3 åˆ†é˜"},{value:300,label:"æŒä¹…",description:"5 åˆ†é˜"}],de=[2,3,4],$={DAILY_FEE_LIMIT:100,MIN_BALANCE:20,MAX_LOSS_STREAK:5},ne={red:{name:"ç´…éšŠ",primary:"#ef4444",secondary:"#fecaca",text:"#991b1b"},blue:{name:"è—éšŠ",primary:"#3b82f6",secondary:"#bfdbfe",text:"#1e40af"},green:{name:"ç¶ éšŠ",primary:"#22c55e",secondary:"#bbf7d0",text:"#166534"},yellow:{name:"é»ƒéšŠ",primary:"#eab308",secondary:"#fef08a",text:"#854d0e"}};function se(o){return["red","blue","green","yellow"].slice(0,o)}function ie(o){return ne[o].name}const C=[{minLevel:1,maxLevel:2,title:"ç«¥ç”Ÿ",color:"#78716c"},{minLevel:3,maxLevel:5,title:"ç§€æ‰",color:"#22c55e"},{minLevel:6,maxLevel:9,title:"èˆ‰äºº",color:"#3b82f6"},{minLevel:10,maxLevel:14,title:"é€²å£«",color:"#8b5cf6"},{minLevel:15,maxLevel:19,title:"æ¢èŠ±",color:"#f59e0b"},{minLevel:20,maxLevel:24,title:"æ¦œçœ¼",color:"#ef4444"},{minLevel:25,maxLevel:999,title:"ç‹€å…ƒ",color:"#dc2626"}];function _e(o){for(const f of C)if(o>=f.minLevel&&o<=f.maxLevel)return f;return C[0]}const me=te("game",()=>{const o=ae(),f=re(),i=h(null),k=h([]),l=h(null),g=h(!1),u=h(null);let y=null;const v=b(()=>!i.value||!o.user?!1:i.value.host_id===o.user.id),A=b(()=>i.value?.status==="playing"),G=b(()=>i.value?.status==="waiting"),O=b(()=>i.value?.status==="finished"),B=b(()=>!l.value?.team_id||!i.value?.teams?null:i.value.teams.find(t=>t.id===l.value.team_id));async function M(t){if(!n||!o.user)return u.value="è«‹å…ˆç™»å…¥",null;g.value=!0,u.value=null;try{const{data:e,error:r}=await n.from("game_rooms").insert({host_id:o.user.id,host_type:t.hostType,game_mode:t.gameMode,text_id:t.textIds[0],text_ids:t.textIds,time_limit:t.timeLimit,team_count:t.teamCount||null,max_players:t.maxPlayers||null,entry_fee:t.entryFee||0,class_id:t.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url)
        `).single();if(r)return u.value=r.message,null;if(t.gameMode==="team_battle"&&t.teamCount){const s=se(t.teamCount).map((_,p)=>({room_id:e.id,team_name:ie(_),team_color:_,order_index:p})),{data:d,error:c}=await n.from("game_teams").insert(s).select();c?console.error("å‰µå»ºåœ˜éšŠå¤±æ•—:",c):e.teams=d}if(t.hostType==="student"){if(t.entryFee&&t.entryFee>0&&!await I(e.id,t.entryFee))return await n.from("game_rooms").delete().eq("id",e.id),null;const a=await q(e.id,t.entryFee||0);a&&(e.participants=[a],l.value=a)}return i.value=e,T(e.id),e}catch(e){return u.value=e.message,null}finally{g.value=!1}}async function N(t){if(!n||!o.user)return{success:!1,error:"è«‹å…ˆç™»å…¥"};g.value=!0,u.value=null;try{const{data:e,error:r}=await n.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",t.toUpperCase()).single();if(r||!e)return{success:!1,error:"æ‰¾ä¸åˆ°è©²æˆ¿é–“"};if(e.status!=="waiting")return{success:!1,error:"è©²æˆ¿é–“å·²é–‹å§‹æˆ–å·²çµæŸ"};const a=e.participants?.find(c=>c.user_id===o.user.id);if(a)return i.value=e,l.value=a,T(e.id),{success:!0,room:e,participant:a};if(e.max_players&&e.participants&&e.participants.length>=e.max_players)return{success:!1,error:"æˆ¿é–“å·²æ»¿"};if(e.entry_fee>0&&!await I(e.id,e.entry_fee))return{success:!1,error:u.value||"ç„¡æ³•æ”¯ä»˜å…¥å ´è²»"};const s=await q(e.id,e.entry_fee);if(!s)return{success:!1,error:u.value||"åŠ å…¥æˆ¿é–“å¤±æ•—"};const d=[...e.participants||[],s];return i.value={...e,participants:d},l.value=s,T(e.id),{success:!0,room:e,participant:s}}catch(e){return u.value=e.message,{success:!1,error:u.value}}finally{g.value=!1}}async function q(t,e){if(!n||!o.user)return null;const{data:r,error:a}=await n.from("game_participants").insert({room_id:t,user_id:o.user.id,fee_paid:e}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return a?(u.value=a.message,null):r}async function I(t,e){if(!n||!o.user)return!1;f.profile||await f.fetchProfile();const r=f.profile?.total_beans??0;if(r<e)return u.value=`è±†å­ä¸è¶³ï¼Œéœ€è¦ ${e} è±†ï¼Œç•¶å‰åªæœ‰ ${r} è±†`,!1;if(r-e<$.MIN_BALANCE)return u.value=`è³¬æˆ¶éœ€ä¿ç•™è‡³å°‘ ${$.MIN_BALANCE} è±†`,!1;const a=r-e,{error:s}=await n.from("profiles").update({total_beans:a,weekly_beans:Math.max(0,(f.profile?.weekly_beans??0)-e),monthly_beans:Math.max(0,(f.profile?.monthly_beans??0)-e),updated_at:new Date().toISOString()}).eq("id",o.user.id);return s?(console.error("æ‰£é™¤å…¥å ´è²»å¤±æ•—:",s),u.value="æ‰£é™¤å…¥å ´è²»å¤±æ•—",!1):(await n.from("game_transactions").insert({user_id:o.user.id,room_id:t,type:"entry_fee",amount:-e,balance_after:a,description:`å…¥å ´è²» ${e} è±†`}),await f.fetchProfile(),console.log(`ğŸ’° å·²æ‰£é™¤å…¥å ´è²» ${e} è±†ï¼Œé¤˜é¡ ${a} è±†`),!0)}async function P(t,e){if(!n||!v.value)return u.value="ç„¡æ¬Šé™",!1;const{error:r}=await n.from("game_participants").update({team_id:e}).eq("id",t);return r?(u.value=r.message,!1):!0}async function D(){if(!n||!v.value||!i.value?.teams)return u.value="ç„¡æ³•åˆ†çµ„",!1;const t=i.value.participants||[],e=i.value.teams,r=[...t].sort(()=>Math.random()-.5);for(let a=0;a<r.length;a++){const s=a%e.length,d=e[s],c=r[a];d&&c&&await P(c.id,d.id)}return!0}async function z(){if(!n||!v.value||!i.value)return u.value="ç„¡æ¬Šé™",!1;if(i.value.game_mode==="team_battle"){const e=i.value.participants?.filter(r=>!r.team_id);if(e&&e.length>0)return u.value="é‚„æœ‰ç©å®¶æœªåˆ†çµ„",!1}const{error:t}=await n.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",i.value.id);return t?(u.value=t.message,!1):(await n.from("game_participants").update({status:"playing"}).eq("room_id",i.value.id),!0)}async function F(t){if(!n||!o.user||!i.value)return u.value="ç„¡æ³•æäº¤åˆ†æ•¸",!1;const{error:e}=await n.from("game_participants").update({score:t.score,accuracy:t.accuracy,time_spent:t.timeSpent,first_accuracy:t.firstAccuracy,attempt_count:t.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",t.roomId).eq("user_id",o.user.id);return e?(u.value=e.message,!1):(l.value?.team_id&&await E(l.value.team_id),await j(),!0)}async function U(t){if(!n||!o.user||!l.value)return u.value="ç„¡æ³•æäº¤é€²åº¦",!1;await n.from("game_text_progress").upsert({participant_id:l.value.id,text_id:t.textId,text_index:t.textIndex,correct_count:t.correctCount,wrong_count:t.wrongCount,time_spent:t.timeSpent,completed_at:new Date().toISOString()},{onConflict:"participant_id,text_id"});const e=(l.value.correct_breaks||0)+t.correctCount,r=(l.value.completed_texts||0)+1,a=t.textIndex+1,{error:s}=await n.from("game_participants").update({correct_breaks:e,completed_texts:r,current_text_index:a,score:e}).eq("id",l.value.id);return s?(u.value=s.message,!1):(l.value.correct_breaks=e,l.value.completed_texts=r,l.value.current_text_index=a,l.value.score=e,l.value.team_id&&await E(l.value.team_id),!0)}async function W(t){if(!n||t.length===0)return[];const{data:e}=await n.from("practice_texts").select("id, title, author, content").in("id",t);if(e){const r=new Map(e.map(a=>[a.id,a]));return t.map(a=>r.get(a)).filter(Boolean)}return[]}async function E(t){if(!n||!i.value)return;const{data:e}=await n.from("game_participants").select("score").eq("team_id",t).eq("status","completed"),r=e?.length||0,a=e?.reduce((d,c)=>d+(c.score||0),0)||0,s=r>0?Math.round(a/r*100):0;await n.from("game_teams").update({total_score:s}).eq("id",t)}async function j(){if(!n||!i.value)return;const{data:t}=await n.from("game_participants").select("status").eq("room_id",i.value.id);if(!t)return;const e=t.every(d=>d.status==="completed"),r=i.value.started_at?new Date(i.value.started_at):null,a=i.value.time_limit*1e3,s=r&&Date.now()-r.getTime()>=a;(e||s)&&await L()}async function L(){if(!n||!i.value)return null;const{data:t}=await n.from("game_rooms").select(`
        *,
        teams:game_teams!game_teams_room_id_fkey(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",i.value.id).single();if(!t)return null;let e=null,r=null,a=[];if(t.game_mode==="team_battle"&&t.teams)e=[...t.teams].sort((m,w)=>w.total_score-m.total_score)[0]?.id,a=t.participants?.filter(m=>m.team_id===e)||[];else{const _=[...t.participants||[]].sort((m,w)=>w.score!==m.score?w.score-m.score:(m.time_spent||999999)-(w.time_spent||999999)),p=_[0];p&&(a=_.filter(m=>m.score===p.score&&(m.time_spent||999999)===(p.time_spent||999999)),a.length===1&&(r=p.user_id))}await n.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:e,winner_user_id:r}).eq("id",t.id);const s=!e&&!r&&a.length>1,d=t.participants?.reduce((_,p)=>_+(p.fee_paid||0),0)||0;let c=[];if(d>0&&a.length>0){const _={...t,prize_pool:d};s?c=await H(_,a):c=await Y(_,a)}return s||await K(t,a),{room:t,winners:a,winningTeam:t.teams?.find(_=>_.id===e),prizeDistribution:c}}async function Y(t,e){if(!n)return[];const r=Math.floor(t.prize_pool/e.length),a=[];for(const s of e){const c=r+0,{data:_}=await n.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",s.user_id).single(),m=(_?.total_beans||0)+c;await n.from("profiles").update({total_beans:m,weekly_beans:(_?.weekly_beans||0)+c,monthly_beans:(_?.monthly_beans||0)+c,updated_at:new Date().toISOString()}).eq("id",s.user_id),await n.from("game_participants").update({prize_won:c}).eq("id",s.id),await n.from("game_transactions").insert({user_id:s.user_id,room_id:t.id,type:"prize",amount:c,balance_after:m,description:`æ”¶è±† ${r} è±†`}),a.push({userId:s.user_id,displayName:s.user?.display_name||"æœªçŸ¥",prize:r,streakBonus:0}),console.log(`ğŸ‰ ${s.user?.display_name} ç²å¾— ${c} è±†ï¼Œé¤˜é¡ ${m} è±†`)}return a}async function H(t,e){if(!n)return[];console.log(`ğŸ¤ å¹³å±€ï¼é€€é‚„å…¥å ´è²»çµ¦ ${e.length} ä½ç©å®¶`);const r=[];for(const a of e){const s=a.fee_paid||t.entry_fee||0;if(s<=0){console.log(`âš ï¸ ${a.user?.display_name} æ²’æœ‰æ”¯ä»˜å…¥å ´è²»ï¼Œè·³é`);continue}const{data:d}=await n.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",a.user_id).single(),_=(d?.total_beans||0)+s;await n.from("profiles").update({total_beans:_,weekly_beans:(d?.weekly_beans||0)+s,monthly_beans:(d?.monthly_beans||0)+s,updated_at:new Date().toISOString()}).eq("id",a.user_id),await n.from("game_participants").update({prize_won:s}).eq("id",a.id),await n.from("game_transactions").insert({user_id:a.user_id,room_id:t.id,type:"refund",amount:s,balance_after:_,description:`å¹³å±€ï¼Œè¿”é‚„å…¥å ´è²» ${s} è±†`}),r.push({userId:a.user_id,displayName:a.user?.display_name||"æœªçŸ¥",prize:s,streakBonus:0}),console.log(`ğŸ’° å·²é€€é‚„ ${s} è±†çµ¦ ${a.user?.display_name}ï¼Œé¤˜é¡ ${_} è±†`)}return r}async function K(t,e){if(!n)return;const r=new Set(e.map(a=>a.user_id));for(const a of t.participants||[]){const s=r.has(a.user_id);s?await n.rpc("increment_win_streak",{p_user_id:a.user_id}):await n.from("user_stats").update({pvp_win_streak:0}).eq("user_id",a.user_id),await n.rpc("increment_pvp_games",{p_user_id:a.user_id,p_is_win:s})}}let x=null;function T(t){if(!n){console.log("[Game] subscribeToRoom: supabase æœªåˆå§‹åŒ–");return}if(x===t&&y){console.log("[Game] å·²ç¶“è¨‚é–±æˆ¿é–“:",t,"ï¼Œè·³éé‡è¤‡è¨‚é–±");return}console.log("[Game] é–‹å§‹è¨‚é–±æˆ¿é–“:",t),S(),x=t,y=n.channel(`game-room-${t}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},e=>{const r=e.new,a=e.old;(r?.id||a?.id)===t&&(console.log("[Game] æˆ¿é–“æ›´æ–°:",e.eventType,r),r&&(i.value={...i.value,...r,participants:i.value?.participants,teams:i.value?.teams,host:i.value?.host,text:i.value?.text,class:i.value?.class},console.log("[Game] æˆ¿é–“ç‹€æ…‹å·²æ›´æ–°ç‚º:",r.status)))}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants"},async e=>{const r=e.new,a=e.old;(r?.room_id||a?.room_id)===t&&(console.log("[Game] åƒèˆ‡è€…æ›´æ–°:",e.eventType),await X(t))}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams"},async e=>{const r=e.new,a=e.old;(r?.room_id||a?.room_id)===t&&(console.log("[Game] åœ˜éšŠæ›´æ–°:",e.eventType),await J(t))}).subscribe(e=>{console.log("[Game] æˆ¿é–“è¨‚é–±ç‹€æ…‹:",e),e==="CHANNEL_ERROR"&&(console.error("[Game] è¨‚é–±éŒ¯èª¤"),x=null)})}async function X(t){if(!n)return;const{data:e}=await n.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",t);e&&i.value&&(i.value.participants=e,o.user&&(l.value=e.find(r=>r.user_id===o.user.id)||null))}async function J(t){if(!n)return;const{data:e}=await n.from("game_teams").select("*").eq("room_id",t).order("order_index");e&&i.value&&(i.value.teams=e)}function S(){y&&(n?.removeChannel(y),y=null),x=null}async function Q(){if(!n)return;g.value=!0;const{data:t,error:e}=await n.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);e?u.value=e.message:k.value=(t||[]).map(r=>({...r,participant_count:r.participants?.[0]?.count||0})),g.value=!1}async function V(t){if(!n)return[];const{data:e}=await n.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",t).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return e||[]}async function Z(){if(!n||!i.value||!o.user)return;const t=i.value.id,e=i.value.entry_fee||0;if(v.value&&i.value.status==="waiting"){console.log("[Game] æˆ¿ä¸»å–æ¶ˆæˆ¿é–“ï¼Œé€€é‚„æ‰€æœ‰äººå…¥å ´è²»");let r=i.value.participants||[];if(r.length===0||!r[0]?.fee_paid){const{data:a}=await n.from("game_participants").select("*, user:users!game_participants_user_id_fkey(id, display_name)").eq("room_id",t);a&&(r=a)}if(console.log(`[Game] æ‰¾åˆ° ${r.length} ä½åƒèˆ‡è€…éœ€è¦é€€æ¬¾`),e>0)for(const a of r)console.log(`[Game] é€€é‚„å…¥å ´è²»çµ¦ ${a.user_id}ï¼Œfee_paid: ${a.fee_paid}`),await R(a);await n.from("game_rooms").update({status:"cancelled"}).eq("id",t)}else!v.value&&i.value.status==="waiting"&&(console.log("[Game] ç©å®¶é›¢é–‹æˆ¿é–“"),((l.value?.fee_paid||0)>0||e>0)&&l.value&&(console.log(`[Game] é€€é‚„å…¥å ´è²» ${l.value.fee_paid||e} è±†`),await R(l.value)),await n.from("game_participants").delete().eq("room_id",t).eq("user_id",o.user.id));S(),i.value=null,l.value=null}async function R(t){if(!n)return;const e=t.fee_paid||i.value?.entry_fee||0;if(e<=0){console.log(`[Game] ${t.user_id} ç„¡éœ€é€€æ¬¾ï¼ˆé‡‘é¡ç‚º 0ï¼‰`);return}const{data:r}=await n.from("profiles").select("total_beans, weekly_beans, monthly_beans").eq("id",t.user_id).single(),s=(r?.total_beans||0)+e,{error:d}=await n.from("profiles").update({total_beans:s,weekly_beans:(r?.weekly_beans||0)+e,monthly_beans:(r?.monthly_beans||0)+e,updated_at:new Date().toISOString()}).eq("id",t.user_id);if(d){console.error("[Game] é€€æ¬¾å¤±æ•—:",d);return}await n.from("game_transactions").insert({user_id:t.user_id,room_id:t.room_id,type:"refund",amount:e,balance_after:s,description:"æˆ¿é–“å–æ¶ˆï¼Œé€€é‚„å…¥å ´è²»"}),console.log(`ğŸ’° å·²é€€é‚„ ${e} è±†çµ¦ ${t.user_id}ï¼Œæ–°é¤˜é¡: ${s}`),t.user_id===o.user?.id&&await f.fetchProfile()}function ee(){S(),i.value=null,l.value=null,k.value=[],u.value=null}return{currentRoom:i,rooms:k,myParticipant:l,loading:g,error:u,isHost:v,isPlaying:A,isWaiting:G,isFinished:O,myTeam:B,createRoom:M,joinRoom:N,assignToTeam:P,randomAssignTeams:D,leaveRoom:Z,startGame:z,submitScore:F,submitTextProgress:U,fetchTexts:W,endGame:L,subscribeToRoom:T,unsubscribe:S,fetchPublicRooms:Q,fetchClassGames:V,reset:ee}});export{ue as E,$ as S,de as T,se as a,ce as b,ne as c,_e as g,me as u};
