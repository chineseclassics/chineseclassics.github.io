import{y as oe,u as ie,r as v,c as z,d as ne,w as H,f as le,a as c,g as s,h as S,i as T,F as R,j as $,H as W,J as Y,s as k,t as l,b as D,m as M,e as ce,o as n,_ as de}from"./index-Bqv_SSN6.js";import{u as ue}from"./useSupabase-C_lbUqkx.js";import{B as P}from"./BeanIcon-BojuSVWb.js";const _e=[10,20,50,100],me=oe("history",()=>{const m=ue(),o=ie(),g=v([]),w=v(null),b=v(20),p=v("all"),x=v("all"),L=v(!1),q=v(!1),I=v(null),O=z(()=>g.value.filter(r=>r.type==="practice")),B=z(()=>g.value.filter(r=>r.type==="game")),N=z(()=>g.value.filter(r=>r.type==="bean")),C=z(()=>g.value.filter(r=>r.type==="reading"));function t(){const r=new Date,i=r.toISOString();switch(x.value){case"today":return{start:new Date(r.getFullYear(),r.getMonth(),r.getDate()).toISOString(),end:i};case"week":return{start:new Date(r.getTime()-6048e5).toISOString(),end:i};case"month":return{start:new Date(r.getTime()-2592e6).toISOString(),end:i};default:return null}}async function d(){if(!m||!o.user?.id)return[];let r=m.from("practice_records").select(`
        id, display_name, username, score, accuracy, elapsed_seconds, created_at,
        text:practice_texts!text_id (
          id, title,
          category:practice_categories!category_id (name)
        )
      `).eq("user_id",o.user.id).order("created_at",{ascending:!1}).limit(b.value);const i=t();i&&(r=r.gte("created_at",i.start));const{data:u,error:f}=await r;return f?(console.error("ç²å–ç·´ç¿’è¨˜éŒ„å¤±æ•—:",f),[]):(u||[]).map(a=>{const _=Array.isArray(a.text)?a.text[0]:a.text,h=_?.category,A=Array.isArray(h)?h[0]?.name:h?.name;return{id:a.id,type:"practice",display_name:a.display_name,username:a.username,score:a.score,accuracy:a.accuracy,elapsed_seconds:a.elapsed_seconds,created_at:a.created_at,text:_?{id:_.id,title:_.title,category_name:A||null}:null}})}async function e(){if(!m||!o.user?.id)return[];let r=m.from("game_participants").select(`
        id, room_id, score, accuracy, time_spent, status, prize_won, fee_paid, joined_at,
        room:game_rooms!room_id (
          id, room_code, game_mode, status, winner_user_id,
          text:practice_texts!text_id (id, title)
        )
      `).eq("user_id",o.user.id).order("joined_at",{ascending:!1}).limit(b.value);const i=t();i&&(r=r.gte("joined_at",i.start));const{data:u,error:f}=await r;return f?(console.error("ç²å–å°æˆ°è¨˜éŒ„å¤±æ•—:",f),[]):(u||[]).map(a=>{const _=Array.isArray(a.room)?a.room[0]:a.room,h=_?.text,A=Array.isArray(h)?h[0]:h;return{id:a.id,type:"game",room_id:a.room_id,room_code:_?.room_code||"",game_mode:_?.game_mode||"pvp",score:a.score,accuracy:a.accuracy,time_spent:a.time_spent,status:a.status,is_winner:_?.winner_user_id===o.user?.id,prize_won:a.prize_won||0,fee_paid:a.fee_paid||0,created_at:a.joined_at,text:A?{id:A.id,title:A.title}:null}})}async function j(){if(!m||!o.user?.id)return[];let r=m.from("game_transactions").select(`
        id, type, amount, balance_after, description, created_at, text_id,
        text:practice_texts!text_id (id, title)
      `).eq("user_id",o.user.id).order("created_at",{ascending:!1}).limit(b.value);const i=t();i&&(r=r.gte("created_at",i.start));const{data:u,error:f}=await r;return f?(console.error("ç²å–è±†å­è¨˜éŒ„å¤±æ•—:",f),[]):(u||[]).map(a=>{const _=Array.isArray(a.text)?a.text[0]:a.text;return{id:a.id,type:"bean",transaction_type:a.type,amount:a.amount,balance_after:a.balance_after,description:a.description,created_at:a.created_at,text:_?{id:_.id,title:_.title}:null}})}async function J(){if(!m||!o.user?.id)return[];let r=m.from("reading_records").select(`
        id, progress, is_completed, read_duration, read_count, 
        first_read_at, last_read_at, completed_at,
        text:practice_texts!text_id (id, title, author)
      `).eq("user_id",o.user.id).order("last_read_at",{ascending:!1}).limit(b.value);const i=t();i&&(r=r.gte("last_read_at",i.start));const{data:u,error:f}=await r;return f?f.code==="42P01"?(console.log("é–±è®€è¨˜éŒ„è¡¨å°šæœªå‰µå»º"),[]):(console.error("ç²å–é–±è®€è¨˜éŒ„å¤±æ•—:",f),[]):(u||[]).map(a=>{const _=Array.isArray(a.text)?a.text[0]:a.text;return{id:a.id,type:"reading",progress:a.progress,is_completed:a.is_completed,read_duration:a.read_duration,read_count:a.read_count,last_read_at:a.last_read_at,created_at:a.first_read_at,text:_?{id:_.id,title:_.title,author:_.author}:null}})}async function F(r){if(r&&(b.value=r),!o.isAuthenticated||!o.user?.id){g.value=[];return}L.value=!0,I.value=null;try{let i=[];if(p.value==="all"||p.value==="practice"){const u=await d();i=[...i,...u]}if(p.value==="all"||p.value==="game"){const u=await e();i=[...i,...u]}if(p.value==="all"||p.value==="bean"){const u=await j();i=[...i,...u]}if(p.value==="all"||p.value==="reading"){const u=await J();i=[...i,...u]}i.sort((u,f)=>new Date(f.created_at).getTime()-new Date(u.created_at).getTime()),p.value==="all"&&(i=i.slice(0,b.value)),g.value=i}catch(i){console.error("ç²å–æ­·å²è¨˜éŒ„å¤±æ•—:",i),I.value=i.message??"ç„¡æ³•è¼‰å…¥æ­·å²ç´€éŒ„"}finally{L.value=!1}}async function K(){if(!m||!o.isAuthenticated||!o.user?.id){w.value=null;return}q.value=!0;try{const r=new Date,i=new Date(r.getTime()-10080*60*1e3).toISOString(),[u,f,a,_,h,A]=await Promise.all([m.from("practice_records").select("id",{count:"exact",head:!0}).eq("user_id",o.user.id),m.from("practice_records").select("id",{count:"exact",head:!0}).eq("user_id",o.user.id).gte("created_at",i),m.from("game_participants").select(`
            id,
            room:game_rooms!room_id (winner_user_id, status)
          `).eq("user_id",o.user.id),m.from("game_participants").select("id",{count:"exact",head:!0}).eq("user_id",o.user.id).gte("joined_at",i),m.from("reading_records").select("id, is_completed",{count:"exact"}).eq("user_id",o.user.id),m.from("game_transactions").select("amount").eq("user_id",o.user.id)]),G=(a.data||[]).filter(y=>(Array.isArray(y.room)?y.room[0]:y.room)?.status==="finished"),te=G.filter(y=>(Array.isArray(y.room)?y.room[0]:y.room)?.winner_user_id===o.user?.id),ae=(h.data||[]).filter(y=>y.is_completed).length,se=A.data||[];let V=0,U=0;for(const y of se)y.amount>0?V+=y.amount:U+=Math.abs(y.amount);w.value={totalPractices:u.count||0,totalGames:G.length,totalWins:te.length,totalReadings:h.count||0,completedReadings:ae,totalBeansEarned:V,totalBeansSpent:U,weeklyPractices:f.count||0,weeklyGames:_.count||0}}catch(r){console.error("ç²å–çµ±è¨ˆå¤±æ•—:",r),w.value=null}finally{q.value=!1}}function Q(r){p.value=r,F()}function X(r){x.value=r,F()}function Z(){return _e}function ee(){g.value=[],w.value=null,p.value="all",x.value="all",I.value=null}return{entries:g,stats:w,limit:b,recordType:p,timeRange:x,isLoading:L,isLoadingStats:q,error:I,practiceEntries:O,gameEntries:B,beanEntries:N,readingEntries:C,fetchHistory:F,fetchStats:K,setRecordType:Q,setTimeRange:X,getLimitOptions:Z,reset:ee}}),pe={entry_fee:"å…¥å ´è²»",prize:"å°æˆ°çå‹µ",refund:"é€€æ¬¾",win_streak_bonus:"é€£å‹çå‹µ",practice_reward:"ç·´ç¿’çå‹µ",daily_login:"æ¯æ—¥ç™»å…¥",daily_first:"æ¯æ—¥é¦–ç·´",level_up:"å‡ç´šçå‹µ"};function fe(m){return pe[m]||m}const ge={class:"history-shell"},ye={key:0,class:"stats-grid"},ve={class:"stat-icon"},he={class:"stat-content"},be={class:"stat-value"},ke={class:"stat-label"},we={class:"stat-sub"},xe={class:"filter-section edamame-glass"},Se={class:"tabs-row"},Re=["onClick"],Ae={class:"tab-icon"},Te={class:"tab-label"},De={class:"filter-row"},Ie={class:"time-filter"},Ee=["value"],Le={class:"limit-filter"},qe=["value"],Be={class:"history-timeline edamame-glass"},$e={key:0,class:"state-info"},ze={key:1,class:"state-error"},Pe={key:2,class:"state-info"},Oe={key:3,class:"timeline-list"},Ne={class:"timeline-content"},Ce={class:"timeline-header"},Fe={class:"entry-title"},He={class:"entry-time"},Me={key:0,class:"entry-details practice-details"},je={class:"detail-item score"},Ge={class:"detail-item accuracy"},Ve={class:"detail-item time"},Ue={key:0,class:"detail-item category"},We={key:1,class:"entry-details game-details"},Ye={class:"detail-item mode"},Je={class:"detail-item score"},Ke={key:0,class:"detail-item prize"},Qe={key:1,class:"detail-item fee"},Xe={key:2,class:"entry-details bean-details"},Ze={key:0,class:"detail-item balance"},et={key:1,class:"detail-item desc"},tt={key:3,class:"entry-details reading-details"},at={key:0,class:"detail-item author"},st={class:"detail-item count"},rt={class:"detail-item duration"},E="bean",ot=ne({__name:"HistoryPage",setup(m){const o=me(),g=v(o.limit),w=[{key:"all",label:"å…¨éƒ¨",icon:"ğŸ“‹"},{key:"practice",label:"ç·´ç¿’",icon:E},{key:"game",label:"å°æˆ°",icon:"âš”ï¸"},{key:"bean",label:"æ”¶æ”¯",icon:"ğŸ’°"},{key:"reading",label:"é–±è®€",icon:"ğŸ“–"}],b=[{key:"all",label:"å…¨éƒ¨æ™‚é–“"},{key:"today",label:"ä»Šå¤©"},{key:"week",label:"æœ¬é€±"},{key:"month",label:"æœ¬æœˆ"}],p=v("all"),x=v("all");H(g,t=>{o.fetchHistory(t)}),H(p,t=>{o.setRecordType(t)}),H(x,t=>{o.setTimeRange(t)}),le(()=>{o.fetchHistory(g.value),o.fetchStats()});function L(t){return new Date(t).toLocaleString("zh-Hant",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function q(t){return t===null?"-":`${Math.round(t*100)}%`}function I(t){if(t<60)return`${t} ç§’`;const d=Math.floor(t/60),e=t%60;return e>0?`${d} åˆ† ${e} ç§’`:`${d} åˆ†é˜`}function O(t){return t>0?`+${t}`:t.toString()}function B(t){switch(t.type){case"practice":return{icon:E,color:"primary"};case"game":return t.is_winner?{icon:"ğŸ†",color:"warning"}:{icon:"âš”ï¸",color:"neutral"};case"bean":return t.amount>0?{icon:"ğŸ’°",color:"success"}:{icon:"ğŸ’¸",color:"error"};case"reading":return t.is_completed?{icon:"âœ…",color:"success"}:{icon:"ğŸ“–",color:"primary"};default:return{icon:"ğŸ“‹",color:"neutral"}}}function N(t){switch(t.type){case"practice":return t.text?.title||"ç·´ç¿’";case"game":return t.text?.title||"å°æˆ°";case"bean":return fe(t.transaction_type);case"reading":return t.text?.title||"é–±è®€";default:return"è¨˜éŒ„"}}const C=z(()=>{const t=o.stats;return t?[{label:"ç·´ç¿’æ¬¡æ•¸",value:t.totalPractices,icon:E,subLabel:`æœ¬é€± ${t.weeklyPractices}`,color:"primary"},{label:"å°æˆ°å ´æ•¸",value:t.totalGames,icon:"âš”ï¸",subLabel:`å‹ ${t.totalWins}`,color:"warning"},{label:"ç²å¾—è±†å­",value:t.totalBeansEarned,icon:"ğŸ’°",subLabel:`æ¶ˆè€— ${t.totalBeansSpent}`,color:"success"},{label:"é–±è®€æ–‡ç« ",value:t.totalReadings,icon:"ğŸ“–",subLabel:`å®Œæˆ ${t.completedReadings}`,color:"info"}]:[]});return(t,d)=>(n(),c("div",ge,[d[9]||(d[9]=s("section",{class:"history-hero edamame-glass fade-in"},[s("div",null,[s("p",{class:"edamame-text-level-detail"},"ç·´ç¿’è¶³è·¡ Â· æˆé•·æ—…ç¨‹"),s("h1",{class:"edamame-heading-gradient"},"è±†è·¡"),s("p",{class:"hero-desc"}," æ¯ä¸€æ¬¡ç·´ç¿’ã€å°æˆ°ã€é–±è®€éƒ½æœƒè¢«è¨˜éŒ„ä¸‹ä¾†ï¼Œè¦‹è­‰ä½ çš„å­¸ç¿’æˆé•·ã€‚ ")])],-1)),T(o).stats?(n(),c("section",ye,[(n(!0),c(R,null,$(C.value,e=>(n(),c("div",{key:e.label,class:D(["stat-card edamame-glass",`stat-${e.color}`])},[s("span",ve,[e.icon===E?(n(),M(P,{key:0,size:28})):(n(),c(R,{key:1},[k(l(e.icon),1)],64))]),s("div",he,[s("p",be,l(e.value),1),s("p",ke,l(e.label),1),s("p",we,l(e.subLabel),1)])],2))),128))])):S("",!0),s("section",xe,[s("div",Se,[(n(),c(R,null,$(w,e=>s("button",{key:e.key,class:D(["tab-btn",{active:p.value===e.key}]),onClick:j=>p.value=e.key},[s("span",Ae,[e.icon===E?(n(),M(P,{key:0,size:16})):(n(),c(R,{key:1},[k(l(e.icon),1)],64))]),s("span",Te,l(e.label),1)],10,Re)),64))]),s("div",De,[s("div",Ie,[W(s("select",{"onUpdate:modelValue":d[0]||(d[0]=e=>x.value=e)},[(n(),c(R,null,$(b,e=>s("option",{key:e.key,value:e.key},l(e.label),9,Ee)),64))],512),[[Y,x.value]])]),s("div",Le,[s("label",null,[d[2]||(d[2]=k(" é¡¯ç¤º ",-1)),W(s("select",{"onUpdate:modelValue":d[1]||(d[1]=e=>g.value=e)},[(n(!0),c(R,null,$(T(o).getLimitOptions(),e=>(n(),c("option",{key:e,value:e},l(e),9,qe))),128))],512),[[Y,g.value,void 0,{number:!0}]]),d[3]||(d[3]=k(" ç­† ",-1))])])])]),s("section",Be,[T(o).isLoading?(n(),c("div",$e,[...d[4]||(d[4]=[s("span",{class:"loading-spinner"},null,-1),k(" è¼‰å…¥æ­·å²ç´€éŒ„ä¸­... ",-1)])])):T(o).error?(n(),c("div",ze,l(T(o).error),1)):T(o).entries.length?(n(),c("ul",Oe,[(n(!0),c(R,null,$(T(o).entries,e=>(n(),c("li",{key:e.id,class:D(["timeline-item",`type-${e.type}`])},[s("div",{class:D(["timeline-dot",B(e).color])},[B(e).icon===E?(n(),M(P,{key:0,size:14})):(n(),c(R,{key:1},[k(l(B(e).icon),1)],64))],2),s("div",Ne,[s("div",Ce,[s("strong",Fe,l(N(e)),1),s("span",He,l(L(e.created_at)),1)]),e.type==="practice"?(n(),c("div",Me,[s("span",je,[ce(P,{size:14,class:"detail-icon"}),k(" "+l(e.score)+" è±† ",1)]),s("span",Ge,[d[7]||(d[7]=s("span",{class:"detail-icon"},"ğŸ¯",-1)),k(" "+l(q(e.accuracy)),1)]),s("span",Ve,[d[8]||(d[8]=s("span",{class:"detail-icon"},"â±ï¸",-1)),k(" "+l(e.elapsed_seconds)+" ç§’ ",1)]),e.text?.category_name?(n(),c("span",Ue,l(e.text.category_name),1)):S("",!0)])):e.type==="game"?(n(),c("div",We,[s("span",{class:D(["detail-item result",e.is_winner?"win":"lose"])},l(e.is_winner?"ğŸ† ç²å‹":"ğŸ’ª æƒœæ•—"),3),s("span",Ye,l(e.game_mode==="pvp"?"PK ç«¶æŠ€":"èª²å ‚é¬¥è±†"),1),s("span",Je,l(e.score)+" åˆ† ",1),e.prize_won>0?(n(),c("span",Ke," +"+l(e.prize_won)+" è±† ",1)):S("",!0),e.fee_paid>0?(n(),c("span",Qe," å…¥å ´ "+l(e.fee_paid)+" è±† ",1)):S("",!0)])):e.type==="bean"?(n(),c("div",Xe,[s("span",{class:D(["detail-item amount",e.amount>0?"positive":"negative"])},l(O(e.amount))+" è±† ",3),e.balance_after!==null?(n(),c("span",Ze," é¤˜é¡ "+l(e.balance_after)+" è±† ",1)):S("",!0),e.description?(n(),c("span",et,l(e.description),1)):S("",!0)])):e.type==="reading"?(n(),c("div",tt,[s("span",{class:D(["detail-item status",e.is_completed?"completed":""])},l(e.is_completed?"âœ… å·²å®Œæˆ":`ğŸ“– ${e.progress}%`),3),e.text?.author?(n(),c("span",at,l(e.text.author),1)):S("",!0),s("span",st," é–±è®€ "+l(e.read_count)+" æ¬¡ ",1),s("span",rt,l(I(e.read_duration)),1)])):S("",!0)])],2))),128))])):(n(),c("div",Pe,[d[5]||(d[5]=s("span",{class:"empty-icon"},"ğŸ“­",-1)),s("p",null,"å°šæœªæœ‰ä»»ä½•"+l(p.value==="all"?"":w.find(e=>e.key===p.value)?.label)+"ç´€éŒ„",1),d[6]||(d[6]=s("p",{class:"empty-hint"},"è¶•å¿«é–‹å§‹ç¬¬ä¸€æ¬¡æŒ‘æˆ°å§ï¼",-1))]))])]))}}),ut=de(ot,[["__scopeId","data-v-45f2f24b"]]);export{ut as default};
