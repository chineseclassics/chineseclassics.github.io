import{d as X,u as Y,c,x as Z,r as w,w as ee,f as te,a as o,g as t,h as m,t as n,b as p,e as se,F as T,j as M,s as S,k as ae,n as O,l as ne,i as V,o as u,_ as re}from"./index-DU0uXHec.js";import{u as le}from"./gameStore-BaKwAH3D.js";import{u as oe}from"./userStatsStore-BvJkvU8h.js";import{g as ue,c as q}from"./game-pGsr7gx9.js";import{B as ie}from"./BeanIcon-BQrg4Z1F.js";const ce={class:"result-header"},ve={class:"result-icon"},me={class:"bean-sign"},de={key:0,class:"bean-note"},pe={key:0,class:"ranking-section"},_e={class:"ranking-list"},fe=["src","alt"],he={key:1,class:"avatar-placeholder"},ge={class:"name"},ke={class:"score"},ye={class:"accuracy"},be={class:"time"},we={key:1,class:"streak-card"},Se={class:"streak-text"},Ce={key:2,class:"answers-section"},Be={key:0,class:"result-tabs"},Re=["onClick"],xe={class:"tab-number"},Te={class:"tab-title"},Me={class:"tab-stats"},Ae={key:1,class:"answer-detail"},Ie={class:"answer-header"},Pe={key:0,class:"answer-author"},Ve={class:"answer-stats"},Ne={class:"stat correct"},ze={class:"stat wrong"},De={class:"stat missed"},Fe={class:"answer-content"},$e={class:"answer-line"},Ge={class:"answer-char"},Le={key:3,class:"ranking-section"},Oe={class:"team-ranking-list"},qe={class:"rank"},Ee={class:"team-name"},Ue={class:"team-score"},je={class:"rank-title-section"},Je={class:"level-text"},We=X({__name:"GameResult",setup(He){const A=ne(),E=Z(),g=le(),C=Y(),I=oe(),B=c(()=>E.params.roomId),r=c(()=>g.currentRoom),k=c(()=>g.myParticipant),v=w(null),R=w(0),i=c(()=>{if(!v.value)return null;const a=v.value.texts[R.value],e=v.value.results[R.value];return!a||!e?null:{text:a,result:e}});function N(a){const e=[];for(const s of a)s!=="|"&&s!==`
`&&s!=="\r"&&e.push(s);return e}function z(a){if(!i.value?.result)return"none";const e=i.value.result,s=e.userBreaks.includes(a),l=e.correctBreaks.includes(a);return s&&l?"correct":s&&!l?"wrong":!s&&l?"missed":"none"}const _=c(()=>{if(!r.value||!C.user)return!1;if(r.value.game_mode==="team_battle")return k.value?.team_id===r.value.winner_team_id;{if(r.value.winner_user_id)return r.value.winner_user_id===C.user.id;if(!r.value.participants)return!1;const a=k.value?.score??0,e=k.value?.time_spent??999999,s=Math.max(...r.value.participants.map(d=>d.score)),l=r.value.participants.filter(d=>d.score===s),x=Math.min(...l.map(d=>d.time_spent??999999));return a===s&&e===x}}),y=c(()=>!r.value||r.value.game_mode==="team_battle"?!1:!r.value.winner_user_id&&_.value),U=c(()=>r.value?.participants?[...r.value.participants].sort((a,e)=>e.score-a.score).map((a,e)=>({...a,rank:e+1})):[]),j=c(()=>r.value?.teams?[...r.value.teams].sort((a,e)=>e.total_score-a.total_score):[]),D=c(()=>I.level),F=c(()=>ue(D.value)),$=c(()=>I.profile?.pvp_win_streak??0),G=w(!1),b=w(0),f=w(!1),h=c(()=>{if(!k.value||!r.value)return{amount:0,type:"neutral"};const a=k.value.fee_paid||r.value.entry_fee||0,e=r.value.participants?.length||0;return y.value?{amount:0,type:"tie"}:_.value&&a>0?{amount:a*e,type:"win"}:!_.value&&a>0?{amount:-a,type:"lose"}:{amount:0,type:"neutral"}});function J(){const a=Math.abs(h.value.amount),e=h.value.type;if(a===0&&e!=="tie"){f.value=!0;return}G.value=!0,b.value=0,f.value=!1;const s=2500,l=Date.now(),x=a>0?a:100;function d(){const Q=Date.now()-l,P=Math.min(Q/s,1);if(P<1){if(P<.8)b.value=Math.floor(Math.random()*x*1.5);else{const L=(P-.8)/.2;b.value=Math.floor(a*L+Math.random()*(a*(1-L)))}requestAnimationFrame(d)}else b.value=a,f.value=!0}setTimeout(()=>{requestAnimationFrame(d)},500)}function W(a){v.value&&a>=0&&a<v.value.texts.length&&(R.value=a)}function H(){g.reset(),sessionStorage.removeItem(`game-result-${B.value}`),A.push({name:"arena"})}function K(){g.reset(),sessionStorage.removeItem(`game-result-${B.value}`),C.isTeacher?A.push({name:"arena-teacher-create"}):A.push({name:"arena-create"})}return ee(()=>r.value?.status,a=>{}),te(()=>{g.subscribeToRoom(B.value),I.fetchProfile();const a=sessionStorage.getItem(`game-result-${B.value}`);if(a)try{v.value=JSON.parse(a)}catch{}J()}),(a,e)=>(u(),o("div",{class:p(["game-result",{winner:_.value,tie:y.value}])},[t("header",ce,[t("div",ve,n(y.value?"ğŸ¤":_.value?"ğŸ†":"ğŸ’ª"),1),t("h1",null,n(y.value?"å¹³å±€ï¼":_.value?"æ­å–œç²å‹ï¼":"æƒœæ•—"),1),G.value||h.value.type!=="neutral"?(u(),o("div",{key:0,class:p(["bean-change-display",[h.value.type,{complete:f.value}]])},[t("span",me,n(h.value.type==="lose"?"-":h.value.type==="win"?"+":""),1),t("span",{class:p(["bean-number",{rolling:!f.value}])},n(b.value),3),se(ie,{size:40,class:"bean-icon-img"}),y.value&&f.value?(u(),o("span",de,"å…¥å ´è²»å·²é€€é‚„")):m("",!0)],2)):m("",!0)]),r.value?.game_mode==="pvp"?(u(),o("section",pe,[e[0]||(e[0]=t("h2",null,"æ’è¡Œæ¦œ",-1)),t("div",_e,[(u(!0),o(T,null,M(U.value,s=>(u(),o("div",{key:s.id,class:p(["ranking-item",{me:s.user_id===V(C).user?.id,top:s.rank<=3}])},[t("span",{class:p(["rank",`rank-${s.rank}`])},n(s.rank===1?"ğŸ¥‡":s.rank===2?"ğŸ¥ˆ":s.rank===3?"ğŸ¥‰":s.rank),3),s.user?.avatar_url?(u(),o("img",{key:0,src:s.user.avatar_url,alt:s.user.display_name,class:"avatar"},null,8,fe)):(u(),o("span",he,n(s.user?.display_name?.charAt(0)||"?"),1)),t("span",ge,n(s.user?.display_name||"æœªçŸ¥"),1),t("span",ke,n(s.score)+" åˆ†",1),t("span",ye,n(s.accuracy?.toFixed(0)||0)+"%",1),t("span",be,n(s.time_spent)+"s",1)],2))),128))])])):m("",!0),$.value>0&&_.value?(u(),o("div",we,[e[3]||(e[3]=t("span",{class:"streak-icon"},"ğŸ”¥",-1)),t("span",Se,[e[1]||(e[1]=S(" é€£å‹ ",-1)),t("strong",null,n($.value),1),e[2]||(e[2]=S(" å ´ï¼ ",-1))])])):m("",!0),v.value?(u(),o("section",Ce,[e[9]||(e[9]=t("h2",null,"ç­”æ¡ˆè©³æƒ…",-1)),v.value.texts.length>1?(u(),o("div",Be,[(u(!0),o(T,null,M(v.value.texts,(s,l)=>(u(),o("button",{key:s.id,class:p(["result-tab",{active:l===R.value}]),onClick:x=>W(l)},[t("span",xe,n(l+1),1),t("span",Te,n(s.title),1),t("span",Me," âœ“"+n(v.value.results[l]?.correctCount||0),1)],10,Re))),128))])):m("",!0),i.value&&i.value.text&&i.value.result?(u(),o("div",Ae,[t("div",Ie,[t("h3",null,n(i.value.text.title),1),i.value.text.author?(u(),o("span",Pe,n(i.value.text.author),1)):m("",!0)]),t("div",Ve,[t("span",Ne,[e[4]||(e[4]=t("span",{class:"bean-legend correct"},null,-1)),S(" æ­£ç¢º "+n(i.value.result.correctCount),1)]),t("span",ze,[e[5]||(e[5]=t("span",{class:"bean-legend wrong"},null,-1)),S(" éŒ¯èª¤ "+n(i.value.result.wrongCount),1)]),t("span",De,[e[6]||(e[6]=t("span",{class:"bean-legend missed"},null,-1)),S(" éºæ¼ "+n(i.value.result.missedCount),1)])]),t("div",Fe,[t("div",$e,[(u(!0),o(T,null,M(N(i.value.text.content),(s,l)=>(u(),o("span",{key:l,class:"char-unit"},[t("span",Ge,n(s),1),l<N(i.value.text.content).length-1&&z(l)!=="none"?(u(),o("span",{key:0,class:p(["bean-slot",z(l)])},[...e[7]||(e[7]=[t("span",{class:"bean"},null,-1)])],2)):m("",!0)]))),128))])]),e[8]||(e[8]=ae('<div class="answer-legend" data-v-a5050366><span class="legend-item" data-v-a5050366><span class="bean-legend correct" data-v-a5050366></span> æ­£ç¢º </span><span class="legend-item" data-v-a5050366><span class="bean-legend wrong" data-v-a5050366></span> éŒ¯èª¤ </span><span class="legend-item" data-v-a5050366><span class="bean-legend missed" data-v-a5050366></span> éºæ¼ </span></div>',1))])):m("",!0)])):m("",!0),r.value?.game_mode==="team_battle"?(u(),o("section",Le,[e[10]||(e[10]=t("h2",null,"éšŠä¼æ’è¡Œ",-1)),t("div",Oe,[(u(!0),o(T,null,M(j.value,(s,l)=>(u(),o("div",{key:s.id,class:p(["team-ranking-item",{winner:l===0}]),style:O({"--team-primary":V(q)[s.team_color].primary,"--team-secondary":V(q)[s.team_color].secondary})},[t("span",qe,n(l===0?"ğŸ†":l+1),1),t("span",Ee,n(s.team_name),1),t("span",Ue,n(s.total_score)+" åˆ†",1)],6))),128))])])):m("",!0),t("section",je,[e[11]||(e[11]=t("p",null,"ç•¶å‰ç¨±è™Ÿ",-1)),t("div",{class:"rank-title-display",style:O({color:F.value.color})},n(F.value.title),5),t("p",Je,"Lv."+n(D.value),1)]),t("footer",{class:"result-footer"},[t("button",{class:"btn-secondary",onClick:H}," è¿”å›é¬¥è±† "),t("button",{class:"btn-primary",onClick:K}," å†ä¾†ä¸€å±€ ")])],2))}}),et=re(We,[["__scopeId","data-v-a5050366"]]);export{et as default};
