import{d as se,u as ae,c as A,p as ne,r as _,o as re,J as oe,w as le,a as u,b as s,e as m,k as ie,t as d,f as v,n as B,F as M,i as N,g as ce,D as ue,H as de,j as he,q as c,_ as fe}from"./index-NMamGxrH.js";import{u as pe}from"./readingStore-Bmx75o7F.js";import"./useSupabase-BbhfJ4PA.js";const ve={class:"reading-detail-page"},ge={class:"reading-header edamame-glass"},ke={class:"header-title"},_e={class:"title-meta"},me={key:0,class:"author"},xe={key:1,class:"source-tag"},we={class:"header-actions"},ye={class:"control-bar edamame-glass"},be=["aria-pressed"],Ce={class:"toggle-switch"},Te={key:0,class:"reading-content edamame-glass"},Se={class:"reading-line"},Be=["onMouseenter"],Pe=["onClick","disabled"],Ae={key:0,class:"verification-result"},Me={class:"result-stats"},Re={class:"stat correct"},ze={class:"stat missed"},De={class:"stat extra"},Ee={class:"stat accuracy"},Ne={class:"content-actions"},Fe=["disabled"],Ie={key:1,class:"loading-state edamame-glass"},Le=se({__name:"ReadingDetailPage",setup(Ue){const F=ne(),I=he(),o=pe(),L=ae(),R=A(()=>F.params.id),h=_(!0),x=_(new Set),l=_(null),w=_(null),y=_(!1),C=A(()=>{if(!o.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const e=o.currentText.content.split("||"),n=[],f=[],i=new Set;let a=0;for(const p of e){const r=[],g=new Set,k=a;for(const b of p)b==="|"?a>0&&(i.add(a-1),g.add(r.length-1)):b!==`
`&&b!=="\r"&&(f.push(b),r.push(b),a++);r.length>0&&n.push({chars:r,breaks:g,startIdx:k,endIdx:a-1})}return{paragraphs:n,allChars:f,allBreaks:i}}),z=A(()=>C.value.paragraphs),U=_(0);function T(t){return o.currentText?.annotations&&o.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const P=_(null);function V(t){return P.value?T(t)?.id===P.value:!1}function H(t){return T(t)?.start_index===t}function X(t){const e=T(t);return e?e.end_index-1===t:!1}function $(t,e){const n=T(t);n&&(P.value=n.id,K(n,e))}function j(){P.value=null,O()}function q(t){if(h.value)return;const e=new Set(x.value);e.has(t)?e.delete(t):e.add(t),x.value=e,l.value=null}function J(){const{allBreaks:t,allChars:e}=C.value;if(!e.length)return;const n=[],f=[],i=[];for(let r=0;r<e.length;r++){const g=t.has(r),k=x.value.has(r);g&&k?n.push(r):g&&!k?f.push(r):!g&&k&&i.push(r)}const a=t.size,p=a>0?n.length/a:1;l.value={correct:n,missed:f,extra:i,accuracy:p}}function Y(){h.value=!0,l.value=null}function G(){x.value=new Set,l.value=null}function K(t,e){w.value={annotation:t,x:e.clientX,y:e.clientY}}function O(){w.value=null}function Q(){const{allChars:t,allBreaks:e,paragraphs:n}=C.value;if(!t.length)return[];const f=[];for(const i of n){let a="",p=i.startIdx-1;for(let r=i.startIdx;r<=i.endIdx;r++){const g=r-i.startIdx;a+=i.chars[g];const k=e.has(r);if(r===i.endIdx)a+="ã€‚";else if(k){const E=r-p;p=r,E>=8?a+="ã€‚":E>=4?a+="ï¼Œ":a+="ã€"}}a.trim()&&f.push(a)}return f}let S=!1;function D(){S=!0,typeof window<"u"&&window.taixuStopSpeak&&window.taixuStopSpeak(),y.value=!1}async function W(){if(!C.value.allChars.length)return;if(y.value){D();return}if(typeof window>"u"||!window.taixuSpeak){alert("èªéŸ³æœ—è®€åŠŸèƒ½æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦");return}y.value=!0,S=!1;const t=Q();try{for(let e=0;e<t.length&&!S;e++)await window.taixuSpeak(t[e],{voice:"zh-CN-XiaoxiaoNeural",rate:.8})}catch(e){console.error("TTS æ’­æ”¾å¤±æ•—:",e),S||alert("èªéŸ³æœ—è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{y.value=!1,S=!1}}async function Z(){if(!L.isAuthenticated){alert("è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨æ›¸ç±¤åŠŸèƒ½");return}await o.toggleBookmark(R.value)}function ee(){I.push({name:"reading-list"})}function te(t){const e=[],{allBreaks:n}=C.value;return h.value?n.has(t)&&e.push("has-break","correct"):x.value.has(t)?(e.push("has-break","user-marked"),l.value&&(l.value.correct.includes(t)?e.push("verified-correct"):l.value.extra.includes(t)&&e.push("verified-extra"))):l.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}return re(async()=>{await o.fetchTextDetail(R.value),o.currentText?.progress&&(U.value=o.currentText.progress.last_paragraph)}),oe(()=>{D()}),le(h,t=>{t&&(l.value=null)}),(t,e)=>(c(),u("div",ve,[s("header",ge,[s("button",{class:"back-btn",onClick:ee}," â† è¿”å› "),s("div",ke,[s("h1",null,d(v(o).currentText?.title||"è¼‰å…¥ä¸­..."),1),s("div",_e,[v(o).currentText?.author?(c(),u("span",me,d(v(o).currentText.author),1)):m("",!0),v(o).currentText?.source_text?.title?(c(),u("span",xe," Â· é¸è‡ªã€Š"+d(v(o).currentText.source_text.title)+"ã€‹ ",1)):m("",!0)])]),s("div",we,[s("button",{class:B(["action-btn bookmark-btn",{active:v(o).currentText?.progress?.bookmarked}]),onClick:Z,title:"æ”¶è—"},d(v(o).currentText?.progress?.bookmarked?"â­":"â˜†"),3)])]),s("section",ye,[s("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=n=>h.value=!h.value),"aria-pressed":h.value,type:"button"},[e[2]||(e[2]=s("span",{class:"toggle-label"},"é¡¯ç¤ºæ–·å¥",-1)),s("span",Ce,[s("span",{class:B(["toggle-track",{active:h.value}])},[...e[1]||(e[1]=[s("span",{class:"toggle-thumb"},null,-1)])],2)])],8,be),s("button",{class:B(["tts-btn",{playing:y.value}]),onClick:W},d(y.value?"â¹ åœæ­¢æœ—è®€":"ğŸ”Š æœ—è®€å…¨æ–‡"),3)]),v(o).currentText&&z.value.length>0?(c(),u("section",Te,[(c(!0),u(M,null,N(z.value,(n,f)=>(c(),u("div",{key:f,class:"paragraph-block"},[s("div",Se,[(c(!0),u(M,null,N(n.chars,(i,a)=>(c(),u("span",{key:a,class:"char-unit"},[s("span",{class:B(["char",{"has-annotation":T(n.startIdx+a),"annotation-hovered":V(n.startIdx+a),"annotation-start":H(n.startIdx+a),"annotation-end":X(n.startIdx+a)}]),onMouseenter:p=>$(n.startIdx+a,p),onMouseleave:j},d(i),43,Be),a<n.chars.length-1?(c(),u("button",{key:0,class:B(["break-slot",te(n.startIdx+a)]),onClick:p=>q(n.startIdx+a),disabled:h.value},[...e[3]||(e[3]=[s("span",{class:"break-marker"},null,-1)])],10,Pe)):m("",!0)]))),128))])]))),128)),l.value?(c(),u("div",Ae,[s("div",Me,[s("span",Re,"âœ“ æ­£ç¢ºï¼š"+d(l.value.correct.length),1),s("span",ze,"â—‹ éºæ¼ï¼š"+d(l.value.missed.length),1),s("span",De,"âœ— å¤šé¤˜ï¼š"+d(l.value.extra.length),1),s("span",Ee," æ­£ç¢ºç‡ï¼š"+d(Math.round(l.value.accuracy*100))+"% ",1)]),s("button",{class:"show-answer-btn",onClick:Y}," æŸ¥çœ‹æ­£ç¢ºç­”æ¡ˆ ")])):m("",!0),s("div",Ne,[h.value?m("",!0):(c(),u(M,{key:0},[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:G}," é‡ç½® "),s("button",{class:"edamame-btn edamame-btn-primary",onClick:J,disabled:x.value.size===0}," âœ“ é©—è­‰æˆ‘çš„æ–·å¥ ",8,Fe)],64))])])):v(o).isLoading?(c(),u("section",Ie,[...e[4]||(e[4]=[s("span",{class:"loading-spinner"},null,-1),ce(" è¼‰å…¥ä¸­... ",-1)])])):m("",!0),(c(),ie(de,{to:"body"},[w.value?(c(),u("div",{key:0,class:"annotation-tooltip",style:ue({left:w.value.x+"px",top:w.value.y+16+"px"})},d(w.value.annotation.annotation),5)):m("",!0)]))]))}}),$e=fe(Le,[["__scopeId","data-v-8cc71c24"]]);export{$e as default};
