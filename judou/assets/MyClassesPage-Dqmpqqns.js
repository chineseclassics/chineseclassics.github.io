import{v as te,u as se,r as _,c as Y,H as d,d as ae,x as I,o as le,a as r,e as y,F as B,b as s,t as m,f as c,z,A as R,h as W,n as X,G as ee,B as ne,i as ie,q as o,_ as re}from"./index-DtHEPrxc.js";import{u as oe}from"./assignmentStore-C67cB5i9.js";import{u as ue}from"./textsStore-KiiisMzq.js";import"./useSupabase-CPfnTOZ7.js";const de=te("class",()=>{const h=se(),u=_([]),C=_(null),b=_([]),$=_([]),g=_(!1),i=_(null),G=/^[a-zA-Z0-9._-]+@student\.isf\.edu\.hk$/i,H=Y(()=>u.value),U=Y(()=>u.value.filter(n=>n.is_active));async function Z(n,l){if(!d||!h.user)return i.value="è«‹å…ˆç™»å…¥",null;if(!h.isTeacher)return i.value="åªæœ‰è€å¸«å¯ä»¥å‰µå»ºç­ç´š",null;g.value=!0,i.value=null;try{const{data:a,error:f}=await d.from("classes").insert({teacher_id:h.user.id,class_name:n,description:l||null}).select().single();return f?(i.value=f.message,null):(u.value.push(a),a)}catch(a){return i.value=a.message,null}finally{g.value=!1}}async function M(){if(!(!d||!h.user)){g.value=!0,i.value=null;try{const{data:n,error:l}=await d.from("classes").select(`
          *,
          member_count:class_members(count)
        `).eq("teacher_id",h.user.id).order("created_at",{ascending:!1});if(l){i.value=l.message;return}u.value=(n||[]).map(a=>({...a,member_count:a.member_count?.[0]?.count||0}))}catch(n){i.value=n.message}finally{g.value=!1}}}async function p(n){if(d){g.value=!0,i.value=null;try{const{data:l,error:a}=await d.from("class_members").select(`
          *,
          student:users!class_members_student_id_fkey (
            id,
            email,
            display_name,
            avatar_url
          )
        `).eq("class_id",n).order("added_at",{ascending:!1});if(a){i.value=a.message;return}b.value=l||[]}catch(l){i.value=l.message}finally{g.value=!1}}}async function k(n,l){if(!d||!h.isTeacher)return i.value="ç„¡æ¬Šé™",!1;g.value=!0,i.value=null;try{const{data:a,error:f}=await d.from("users").select("id").eq("email",l).single();if(f||!a)return i.value="æ‰¾ä¸åˆ°è©²å­¸ç”Ÿï¼Œè«‹ç¢ºèªéƒµç®±æ­£ç¢ºä¸”å­¸ç”Ÿå·²ç™»å…¥é",!1;const{error:w}=await d.from("class_members").insert({class_id:n,student_id:a.id,added_by:h.user?.id});return w?(w.code==="23505"?i.value="è©²å­¸ç”Ÿå·²åœ¨ç­ç´šä¸­":i.value=w.message,!1):(await p(n),!0)}catch(a){return i.value=a.message,!1}finally{g.value=!1}}async function q(n,l){if(!d||!h.isTeacher)return i.value="ç„¡æ¬Šé™",!1;g.value=!0,i.value=null;try{const{error:a}=await d.from("class_members").delete().eq("class_id",n).eq("student_id",l);return a?(i.value=a.message,!1):(b.value=b.value.filter(f=>!(f.class_id===n&&f.student_id===l)),!0)}catch(a){return i.value=a.message,!1}finally{g.value=!1}}function S(n){return n?n.split(/[\n,;]/).map(l=>l.trim().toLowerCase()).filter(l=>l!==""):[]}function D(n){const l=[],a=[];return n.forEach(f=>{G.test(f)?l.push(f):a.push(f)}),{validEmails:l,invalidEmails:a}}async function L(n,l){if(!d||!h.isTeacher||!h.user)throw new Error("ç„¡æ¬Šé™");const a=S(l),{validEmails:f,invalidEmails:w}=D(a);if(f.length===0)throw new Error("æ²’æœ‰æœ‰æ•ˆçš„å­¸ç”Ÿéƒµç®±åœ°å€ã€‚è«‹ä½¿ç”¨ @student.isf.edu.hk æ ¼å¼");const{data:j}=await d.from("class_members").select("student:users!class_members_student_id_fkey(email)").eq("class_id",n),{data:J}=await d.from("pending_students").select("email").eq("class_id",n),F=new Set([...j?.map(e=>e.student?.email).filter(Boolean)||[],...J?.map(e=>e.email)||[]]),K=f.filter(e=>F.has(e)),O=f.filter(e=>!F.has(e));let v=0;for(const e of O)try{const{error:t}=await d.from("pending_students").insert({class_id:n,email:e,added_by:h.user.id});if(t){t.code==="23505"?console.log(`éƒµç®± ${e} å·²åœ¨å¾…åŠ å…¥åˆ—è¡¨ä¸­`):console.warn(`æ·»åŠ éƒµç®± ${e} å¤±æ•—:`,t);continue}v++}catch(t){console.warn(`è™•ç†éƒµç®± ${e} æ™‚å‡ºéŒ¯:`,t)}return{validEmails:f.length,invalidEmails:w.length,duplicates:K.length,added:v,invalidList:w}}async function E(n){if(d)try{const{data:l,error:a}=await d.from("pending_students").select("*").eq("class_id",n).order("added_at",{ascending:!1});if(a){console.error("ç²å–å¾…æ¿€æ´»å­¸ç”Ÿå¤±æ•—:",a);return}$.value=l||[]}catch(l){console.error("ç²å–å¾…æ¿€æ´»å­¸ç”Ÿå¤±æ•—:",l)}}async function A(n){if(!d||!h.isTeacher)return i.value="ç„¡æ¬Šé™",!1;try{const{error:l}=await d.from("pending_students").delete().eq("id",n);return l?(i.value=l.message,!1):($.value=$.value.filter(a=>a.id!==n),!0)}catch(l){return i.value=l.message,!1}}async function P(n,l){if(!d||!h.isTeacher)return i.value="ç„¡æ¬Šé™",!1;g.value=!0,i.value=null;try{const{error:a}=await d.from("classes").update(l).eq("id",n).eq("teacher_id",h.user?.id);if(a)return i.value=a.message,!1;const f=u.value.findIndex(w=>w.id===n);return f!==-1&&(u.value[f]={...u.value[f],...l}),!0}catch(a){return i.value=a.message,!1}finally{g.value=!1}}async function x(n){if(!d||!h.isTeacher)return i.value="ç„¡æ¬Šé™",!1;g.value=!0,i.value=null;try{const{error:l}=await d.from("classes").delete().eq("id",n).eq("teacher_id",h.user?.id);return l?(i.value=l.message,!1):(u.value=u.value.filter(a=>a.id!==n),!0)}catch(l){return i.value=l.message,!1}finally{g.value=!1}}async function T(){if(!(!d||!h.user)){g.value=!0,i.value=null;try{const{data:n,error:l}=await d.from("class_members").select(`
          class:classes (
            id,
            class_name,
            description,
            created_at,
            is_active,
            teacher:users!classes_teacher_id_fkey (
              display_name
            )
          )
        `).eq("student_id",h.user.id);if(l){i.value=l.message;return}u.value=(n||[]).map(a=>a.class).filter(a=>a!==null)}catch(n){i.value=n.message}finally{g.value=!1}}}async function N(){h.isTeacher?await M():await T()}function V(){u.value=[],C.value=null,b.value=[],i.value=null}return{classes:u,currentClass:C,classMembers:b,pendingStudents:$,loading:g,error:i,myClasses:H,activeClasses:U,createClass:Z,fetchMyClasses:M,fetchClassMembers:p,addStudentByEmail:k,removeStudent:q,updateClass:P,deleteClass:x,batchAddStudents:L,fetchPendingStudents:E,removePendingStudent:A,fetchStudentClasses:T,fetchClasses:N,reset:V}}),ce={class:"my-classes-container"},ve={class:"page-header"},me={class:"page-subtitle"},fe={key:0,class:"create-form edamame-glass"},_e={class:"form-group"},he={class:"form-group"},ge={class:"form-actions"},pe=["disabled"],ye={key:1,class:"loading"},be={key:2,class:"classes-grid"},ke=["onClick"],Ce={class:"class-header"},we={class:"class-name"},Te={class:"member-count"},Se={key:0,class:"class-desc"},Ee={class:"class-footer"},Ae={class:"class-date"},xe={key:3,class:"empty-state edamame-glass"},$e={key:0},Me={key:1},qe={class:"page-header"},De={class:"header-with-back"},Le={class:"page-title"},Pe={class:"page-subtitle"},Ne={key:0,class:"tabs"},Ve={key:1,class:"tab-content"},Be={class:"section-header"},Ue={key:0,class:"empty-members edamame-glass"},ze={key:1,class:"members-list"},Fe={class:"member-info"},Re={class:"member-avatar"},We={class:"member-details"},Ge={class:"member-name"},He={class:"member-email"},Ze=["onClick"],je={key:2,class:"tab-content"},Je={key:0,class:"loading"},Ke={key:1,class:"empty-assignments edamame-glass"},Oe={key:2,class:"assignments-list"},Qe={class:"assignment-info"},Xe={class:"assignment-title"},Ye={class:"assignment-meta"},Ie={class:"assignment-date"},es={class:"assignment-actions"},ss={key:0,class:"completed-badge"},ts=["onClick"],as=["onClick"],ls={key:3,class:"tab-content"},ns={class:"modal-content edamame-glass"},is={class:"modal-actions"},rs=["disabled"],os={class:"modal-content edamame-glass"},us={class:"form-group"},ds=["value"],cs={class:"form-group"},vs={class:"modal-actions"},ms=["disabled"],fs=ae({__name:"MyClassesPage",setup(h){const u=se(),C=de(),b=oe(),$=ue(),g=ie(),{classes:i,classMembers:G,loading:H}=I(C),{assignments:U,loading:Z}=I(b),M=_("list"),p=_(null),k=_("members"),q=_(!1),S=_(""),D=_(""),L=_(!1),E=_(!1),A=_(""),P=_(!1),x=_(!1),T=_(null),N=_(""),V=_(!1),n=Y(()=>G.value.map(e=>({id:e.id,email:e.student?.email||"æœªçŸ¥",displayName:e.student?.display_name||"æœªçŸ¥",status:"active",addedAt:e.added_at})).sort((e,t)=>new Date(t.addedAt).getTime()-new Date(e.addedAt).getTime()));async function l(){if(S.value.trim()){L.value=!0;try{await C.createClass(S.value.trim(),D.value.trim()),S.value="",D.value="",q.value=!1}catch(v){console.error("å‰µå»ºç­ç´šå¤±æ•—:",v)}finally{L.value=!1}}}const a=_(new Map);async function f(v){if(p.value=v,M.value="detail",k.value=u.isTeacher?"members":"assignments",u.isTeacher)await Promise.all([C.fetchClassMembers(v.id),b.fetchClassAssignments(v.id)]);else if(await b.fetchClassAssignments(v.id),u.isStudent)for(const e of U.value){const t=await b.checkAssignmentCompletion(e.id);a.value.set(e.id,t)}}function w(){M.value="list",p.value=null}async function j(){if(!(!p.value||!A.value.trim())){P.value=!0;try{await C.batchAddStudents(p.value.id,A.value),A.value="",E.value=!1}catch(v){console.error("æ‰¹é‡æ·»åŠ å¤±æ•—:",v)}finally{P.value=!1}}}async function J(v){p.value&&confirm("ç¢ºå®šè¦å°‡æ­¤å­¸ç”Ÿå¾ç­ç´šä¸­ç§»é™¤å—ï¼Ÿ")&&v.student_id&&await C.removeStudent(p.value.id,v.student_id)}async function F(){if(!(!p.value||!T.value)){V.value=!0;try{await b.createAssignment(p.value.id,T.value,N.value||void 0),T.value=null,N.value="",x.value=!1,await b.fetchClassAssignments(p.value.id)}catch(v){console.error("å¸ƒç½®ä½œæ¥­å¤±æ•—:",v)}finally{V.value=!1}}}async function K(v){confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ä½œæ¥­å—ï¼Ÿ")&&(await b.deleteAssignment(v),p.value&&await b.fetchClassAssignments(p.value.id))}function O(v){g.push({name:"practice",query:{textId:v.text_id,assignmentId:v.id}})}return le(async()=>{u.isAuthenticated&&(u.isTeacher?await Promise.all([C.fetchMyClasses(),$.fetchTexts()]):await Promise.all([C.fetchStudentClasses(),b.fetchStudentAssignments()]))}),(v,e)=>(o(),r("main",ce,[M.value==="list"?(o(),r(B,{key:0},[s("header",ve,[s("div",null,[e[19]||(e[19]=s("h1",{class:"page-title"},"æˆ‘çš„ç­ç´š",-1)),s("p",me,m(c(u).isTeacher?"å‰µå»ºå’Œç®¡ç†ä½ çš„ç­ç´š":"æŸ¥çœ‹ç­ç´šå’Œä½œæ¥­"),1)]),c(u).isTeacher?(o(),r("button",{key:0,class:"create-btn",onClick:e[0]||(e[0]=t=>q.value=!0)}," + æ–°å»ºç­ç´š ")):y("",!0)]),q.value&&c(u).isTeacher?(o(),r("section",fe,[e[22]||(e[22]=s("h2",null,"æ–°å»ºç­ç´š",-1)),s("div",_e,[e[20]||(e[20]=s("label",null,"ç­ç´šåç¨± *",-1)),z(s("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>S.value=t),type:"text",placeholder:"ä¾‹å¦‚ï¼šä¸ƒå¹´ç´šAç­",class:"form-input"},null,512),[[R,S.value]])]),s("div",he,[e[21]||(e[21]=s("label",null,"ç­ç´šæè¿°",-1)),z(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=t=>D.value=t),placeholder:"é¸å¡«ï¼Œç°¡å–®æè¿°é€™å€‹ç­ç´š",class:"form-textarea",rows:"2"},null,512),[[R,D.value]])]),s("div",ge,[s("button",{class:"cancel-btn",onClick:e[3]||(e[3]=t=>q.value=!1)},"å–æ¶ˆ"),s("button",{class:"submit-btn",onClick:l,disabled:!S.value.trim()||L.value},m(L.value?"å‰µå»ºä¸­...":"å‰µå»ºç­ç´š"),9,pe)])])):y("",!0),c(H)?(o(),r("div",ye,"è¼‰å…¥ä¸­...")):c(i).length>0?(o(),r("section",be,[(o(!0),r(B,null,W(c(i),t=>(o(),r("article",{key:t.id,class:"class-card edamame-glass",onClick:Q=>f(t)},[s("div",Ce,[s("h3",we,m(t.class_name),1),s("span",Te,m(c(u).isTeacher?`${t.member_count||0} åå­¸ç”Ÿ`:"æŸ¥çœ‹ä½œæ¥­"),1)]),t.description?(o(),r("p",Se,m(t.description),1)):y("",!0),s("div",Ee,[s("span",Ae,m(c(u).isTeacher?"å‰µå»ºæ–¼":"åŠ å…¥æ–¼")+" "+m(new Date(t.created_at).toLocaleDateString("zh-TW")),1)])],8,ke))),128))])):(o(),r("section",xe,[e[23]||(e[23]=s("div",{class:"empty-icon"},"ğŸ“š",-1)),s("h2",null,m(c(u).isTeacher?"é‚„æ²’æœ‰ç­ç´š":"é‚„æ²’æœ‰åŠ å…¥ä»»ä½•ç­ç´š"),1),c(u).isTeacher?(o(),r("p",$e," é»æ“Šã€Œæ–°å»ºç­ç´šã€é–‹å§‹å‰µå»ºä½ çš„ç¬¬ä¸€å€‹ç­ç´š ")):(o(),r("p",Me," ç­‰å¾…è€å¸«å°‡ä½ æ·»åŠ åˆ°ç­ç´šä¸­ ")),c(u).isTeacher?(o(),r("button",{key:2,class:"create-btn",onClick:e[4]||(e[4]=t=>q.value=!0)}," + æ–°å»ºç­ç´š ")):y("",!0)]))],64)):M.value==="detail"&&p.value?(o(),r(B,{key:1},[s("header",qe,[s("div",De,[s("button",{class:"back-btn",onClick:w},"â† è¿”å›"),s("div",null,[s("h1",Le,m(p.value.class_name),1),s("p",Pe,m(p.value.description||""),1)])]),c(u).isTeacher&&k.value==="assignments"?(o(),r("button",{key:0,class:"create-btn",onClick:e[5]||(e[5]=t=>x.value=!0)}," + å¸ƒç½®ä½œæ¥­ ")):y("",!0),c(u).isTeacher&&k.value==="members"?(o(),r("button",{key:1,class:"create-btn",onClick:e[6]||(e[6]=t=>E.value=!0)}," + æ·»åŠ å­¸ç”Ÿ ")):y("",!0)]),c(u).isTeacher?(o(),r("div",Ne,[s("button",{class:X(["tab-btn",{active:k.value==="members"}]),onClick:e[7]||(e[7]=t=>k.value="members")}," æˆå“¡ ",2),s("button",{class:X(["tab-btn",{active:k.value==="assignments"}]),onClick:e[8]||(e[8]=t=>k.value="assignments")}," ä½œæ¥­ ",2),s("button",{class:X(["tab-btn",{active:k.value==="progress"}]),onClick:e[9]||(e[9]=t=>k.value="progress")}," é€²åº¦ ",2)])):y("",!0),c(u).isTeacher&&k.value==="members"?(o(),r("section",Ve,[s("div",Be,[s("h2",null,"ç­ç´šæˆå“¡ ("+m(n.value.length)+")",1)]),n.value.length===0?(o(),r("div",Ue,[e[24]||(e[24]=s("p",null,"ç­ç´šä¸­é‚„æ²’æœ‰å­¸ç”Ÿ",-1)),s("button",{class:"create-btn",onClick:e[10]||(e[10]=t=>E.value=!0)}," + æ·»åŠ å­¸ç”Ÿ ")])):(o(),r("div",ze,[(o(!0),r(B,null,W(n.value,t=>(o(),r("div",{key:t.id,class:"member-card edamame-glass"},[s("div",Fe,[s("div",Re,m(t.displayName.charAt(0).toUpperCase()),1),s("div",We,[s("p",Ge,m(t.displayName),1),s("p",He,m(t.email),1)])]),s("button",{class:"remove-btn",onClick:Q=>J(t),title:"ç§»é™¤"}," âœ• ",8,Ze)]))),128))]))])):y("",!0),k.value==="assignments"?(o(),r("section",je,[c(Z)?(o(),r("div",Je,"è¼‰å…¥ä¸­...")):c(U).length===0?(o(),r("div",Ke,[s("p",null,m(c(u).isTeacher?"é‚„æ²’æœ‰å¸ƒç½®ä½œæ¥­":"é‚„æ²’æœ‰ä½œæ¥­"),1),c(u).isTeacher?(o(),r("button",{key:0,class:"create-btn",onClick:e[11]||(e[11]=t=>x.value=!0)}," + å¸ƒç½®ä½œæ¥­ ")):y("",!0)])):(o(),r("div",Oe,[(o(!0),r(B,null,W(c(U),t=>(o(),r("div",{key:t.id,class:"assignment-card edamame-glass"},[s("div",Qe,[s("h3",Xe,m(t.title||t.text?.title||"æœªå‘½åä½œæ¥­"),1),s("p",Ye,m(t.text?.author||"ä½šå")+" Â· é›£åº¦ï¼š"+m(t.text?.difficulty===1?"åˆç´š":t.text?.difficulty===2?"ä¸­ç´š":"é«˜ç´š"),1),s("p",Ie," å¸ƒç½®æ–¼ "+m(new Date(t.assigned_at).toLocaleDateString("zh-TW")),1)]),s("div",es,[c(u).isStudent&&a.value.get(t.id)?(o(),r("span",ss," å·²å®Œæˆ ")):y("",!0),c(u).isStudent&&!a.value.get(t.id)?(o(),r("button",{key:1,class:"start-btn",onClick:Q=>O(t)}," é–‹å§‹ä½œæ¥­ ",8,ts)):y("",!0),c(u).isTeacher?(o(),r("button",{key:2,class:"delete-btn",onClick:Q=>K(t.id)}," åˆªé™¤ ",8,as)):y("",!0)])]))),128))]))])):y("",!0),c(u).isTeacher&&k.value==="progress"?(o(),r("section",ls,[...e[25]||(e[25]=[s("div",{class:"progress-placeholder edamame-glass"},[s("p",null,"é€²åº¦çµ±è¨ˆåŠŸèƒ½é–‹ç™¼ä¸­...")],-1)])])):y("",!0)],64)):y("",!0),E.value?(o(),r("div",{key:2,class:"modal-overlay",onClick:e[14]||(e[14]=ee(t=>E.value=!1,["self"]))},[s("div",ns,[e[26]||(e[26]=s("h2",null,"æ‰¹é‡æ·»åŠ å­¸ç”Ÿ",-1)),e[27]||(e[27]=s("p",{class:"modal-hint"}," è«‹è¼¸å…¥å­¸ç”Ÿéƒµç®±åœ°å€ï¼Œæ¯è¡Œä¸€å€‹æˆ–ç”¨é€—è™Ÿ/åˆ†è™Ÿåˆ†éš”ã€‚åƒ…æ”¯æŒ `xxxx@student.isf.edu.hk` æ ¼å¼ã€‚ ",-1)),z(s("textarea",{"onUpdate:modelValue":e[12]||(e[12]=t=>A.value=t),placeholder:`ä¾‹å¦‚ï¼š
student1@student.isf.edu.hk
student2@student.isf.edu.hk`,class:"form-textarea",rows:"10"},null,512),[[R,A.value]]),s("div",is,[s("button",{class:"cancel-btn",onClick:e[13]||(e[13]=t=>E.value=!1)},"å–æ¶ˆ"),s("button",{class:"submit-btn",onClick:j,disabled:!A.value.trim()||P.value},m(P.value?"æ·»åŠ ä¸­...":"æ·»åŠ å­¸ç”Ÿ"),9,rs)])])])):y("",!0),x.value?(o(),r("div",{key:3,class:"modal-overlay",onClick:e[18]||(e[18]=ee(t=>x.value=!1,["self"]))},[s("div",os,[e[31]||(e[31]=s("h2",null,"å¸ƒç½®ä½œæ¥­",-1)),s("div",us,[e[29]||(e[29]=s("label",null,"é¸æ“‡æ–‡ç« ",-1)),z(s("select",{"onUpdate:modelValue":e[15]||(e[15]=t=>T.value=t),class:"form-input"},[e[28]||(e[28]=s("option",{value:""},"è«‹é¸æ“‡æ–‡ç« ",-1)),(o(!0),r(B,null,W(c($).texts,t=>(o(),r("option",{key:t.id,value:t.id},m(t.title)+" ("+m(t.author||"ä½šå")+") ",9,ds))),128))],512),[[ne,T.value]])]),s("div",cs,[e[30]||(e[30]=s("label",null,"ä½œæ¥­æ¨™é¡Œï¼ˆå¯é¸ï¼‰",-1)),z(s("input",{"onUpdate:modelValue":e[16]||(e[16]=t=>N.value=t),type:"text",placeholder:"ä¾‹å¦‚ï¼šé€±æœ«ç·´ç¿’",class:"form-input"},null,512),[[R,N.value]])]),s("div",vs,[s("button",{class:"cancel-btn",onClick:e[17]||(e[17]=t=>x.value=!1)},"å–æ¶ˆ"),s("button",{class:"submit-btn",onClick:F,disabled:!T.value||V.value},m(V.value?"å¸ƒç½®ä¸­...":"å¸ƒç½®ä½œæ¥­"),9,ms)])])])):y("",!0)]))}}),ys=re(fs,[["__scopeId","data-v-c72dafcb"]]);export{ys as default};
