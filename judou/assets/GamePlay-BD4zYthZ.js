import{d as ie,c as d,x as ue,r as _,w as ce,f as de,R as ve,a as r,g as n,F as A,h as g,b as y,t as f,j as D,l as me,o as l,_ as fe}from"./index-BX9PSpLQ.js";import{u as pe}from"./gameStore-BeqSlaPE.js";import"./userStatsStore-X9pocjnI.js";import"./game-pGsr7gx9.js";const he={class:"game-play"},_e={key:0,class:"loading-container"},ge={class:"play-header"},Te={class:"header-left"},ke={class:"countdown-time"},ye={class:"header-center"},Be={class:"text-title"},be={key:0,class:"text-author"},xe={key:0,class:"text-tabs"},we=["onClick"],Ae={class:"tab-number"},Ce={class:"tab-title"},ze={key:0,class:"tab-check"},Se={class:"play-main"},Ie={class:"board-header"},Pe={class:"board-header-right"},Ve={class:"practice-board"},Me={key:0,class:"practice-line"},Re={class:"char"},Ge=["onClick","aria-label"],De={key:0,class:"bean"},$e={class:"progress-hint"},qe={key:0,class:"text-nav"},Ee=["disabled"],Fe={class:"nav-info"},Le=["disabled"],Ue=250,Ne=ie({__name:"GamePlay",setup(je){const O=me(),Y=ue(),T=pe(),C=d(()=>Y.params.roomId),v=d(()=>T.currentRoom),i=_([]),m=_(new Map),c=_(0),u=d(()=>i.value[c.value]),k=d(()=>u.value&&m.value.get(u.value.id)||null),z=d(()=>k.value?.characters||[]),$=d(()=>k.value?.correctBreaks||new Set),B=d({get:()=>k.value?.userBreaks||new Map,set:a=>{if(u.value&&m.value.has(u.value.id)){const e=m.value.get(u.value.id);e.userBreaks=a}}}),b=_(0);let S=null;const q=d(()=>$.value.size),H=d(()=>B.value.size),E=d(()=>Math.max(0,q.value-H.value)),J=d(()=>E.value>0),I=_(!1),F=_(null);let p=null,x=!1,P=!1;const L=_(!0);function K(a){const e=[],t=new Set;let s=0;const o=a.replace(/[\|\s]+$/,"");for(const h of o)h==="|"?s>0&&t.add(s-1):h!==`
`&&h!=="\r"&&(e.push(h),s++);return{chars:e,breaks:t}}function Q(){m.value.clear();for(const a of i.value){const e=K(a.content);m.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Map})}}function W(a){a>=0&&a<i.value.length&&(c.value=a)}function X(){c.value>0&&c.value--}function Z(){c.value<i.value.length-1&&c.value++}let V=null;function M(a){try{V||(V=new AudioContext);const e=V,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function R(a=10){navigator.vibrate&&navigator.vibrate(a)}function ee(a){if(!u.value)return;const e=m.value.get(u.value.id);if(!e||e.userBreaks.has(a))return;if(e.userBreaks.size>=e.correctBreaks.size){M("error"),I.value=!0,setTimeout(()=>{I.value=!1},300),R(50);return}const t={index:a,isCorrect:e.correctBreaks.has(a),placedAt:Date.now()},s=new Map(e.userBreaks);s.set(a,t),e.userBreaks=s,m.value=new Map(m.value),F.value=t.placedAt,t.isCorrect?(M("add"),R(10)):(M("error"),R(50)),j();const o=N();o.usedBeansAll>=o.totalBeansAll&&j(!0)}function te(a){const e=B.value.get(a);return{"has-bean":!!e,correct:e?.isCorrect,extra:e&&!e.isCorrect}}function U(a){let e=0,t=0;return a.userBreaks.forEach(s=>{s.isCorrect?e++:t++}),{correct:e,wrong:t}}function N(){let a=0,e=0,t=0;return m.value.forEach(s=>{const o=U(s);a+=o.correct,e+=s.correctBreaks.size,t+=s.userBreaks.size}),{totalCorrect:a,totalBeansAll:e,usedBeansAll:t}}function ae(a=!1){if(!u.value||!k.value)return null;const{correct:e,wrong:t}=U(k.value),{totalCorrect:s,totalBeansAll:o,usedBeansAll:h}=N(),le=F.value||Date.now(),oe=a||h>=o;return{roomId:C.value,textId:u.value.id,textIndex:c.value,correctCount:e,wrongCount:t,totalCorrect:s,totalBeans:o,usedBeans:h,lastInteraction:le,isFinished:oe}}async function G(a=!1){p&&(clearTimeout(p),p=null);const e=ae(a);if(e&&!P){P=!0;try{await T.updateProgress(e)}catch(t){console.error("[GamePlay] 更新進度失敗",t)}finally{P=!1}}}function j(a=!1){a&&(x=!0),p&&clearTimeout(p),p=setTimeout(()=>{G(x),x=!1},Ue)}async function se(a=!1){await G(a);try{await T.endGame()}catch(e){console.error("[GamePlay] 結束遊戲失敗",e)}}function w(a){const e=m.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(o=>e.userBreaks.has(o))?"complete":"partial"}function ne(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function re(){if(!v.value?.started_at||!v.value?.time_limit)return;const a=()=>{const e=new Date(v.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);b.value=Math.max(0,v.value.time_limit-t),b.value===0&&se(!0)};a(),S=setInterval(a,1e3)}return ce(()=>v.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),O.push({name:"arena-result",params:{roomId:C.value}}))}),de(async()=>{T.subscribeToRoom(C.value),v.value?.text_ids&&v.value.text_ids.length>0?i.value=await T.fetchTexts(v.value.text_ids):v.value?.text_id&&(i.value=await T.fetchTexts([v.value.text_id])),L.value=!1,i.value.length>0&&(Q(),re())}),ve(()=>{S&&clearInterval(S),p&&clearTimeout(p),G(x)}),(a,e)=>(l(),r("div",he,[L.value?(l(),r("div",_e,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(l(),r(A,{key:1},[n("header",ge,[n("div",Te,[n("div",{class:y(["countdown",{warning:b.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",ke,f(ne(b.value)),1)],2)]),n("div",ye,[n("span",Be,f(u.value?.title),1),u.value?.author?(l(),r("span",be,f(u.value.author),1)):g("",!0)]),e[2]||(e[2]=n("div",{class:"header-right"},[n("div",{class:"live-pill"},[n("span",{class:"live-dot"}),n("span",null,"實時計分")])],-1))]),i.value.length>1?(l(),r("div",xe,[(l(!0),r(A,null,D(i.value,(t,s)=>(l(),r("button",{key:t.id,class:y(["text-tab",{active:s===c.value,empty:w(t.id)==="empty",partial:w(t.id)==="partial",complete:w(t.id)==="complete"}]),onClick:o=>W(s)},[n("span",Ae,f(s+1),1),n("span",Ce,f(t.title),1),w(t.id)==="complete"?(l(),r("span",ze,"✓")):g("",!0)],10,we))),128))])):g("",!0),n("main",Se,[n("div",Ie,[e[3]||(e[3]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",Pe,[n("div",{class:y(["bean-inventory",{shake:I.value,empty:!J.value}])},[(l(!0),r(A,null,D(q.value,t=>(l(),r("span",{key:t,class:y(["inventory-bean",{used:t>E.value}])},null,2))),128))],2)])]),n("div",Ve,[z.value.length?(l(),r("div",Me,[(l(!0),r(A,null,D(z.value,(t,s)=>(l(),r("span",{key:s,class:"char-unit"},[n("span",Re,f(t),1),s<z.value.length-1?(l(),r("button",{key:0,class:y(["bean-slot",te(s)]),onClick:o=>ee(s),"aria-label":`在「${t}」後放置斷句`},[B.value.has(s)?(l(),r("span",De)):g("",!0),e[4]||(e[4]=n("span",{class:"bean-hint"},null,-1))],10,Ge)):g("",!0)]))),128))])):g("",!0)]),n("div",$e,[n("span",null,"已標記 "+f(B.value.size)+" / "+f($.value.size)+" 處",1)]),i.value.length>1?(l(),r("div",qe,[n("button",{class:"nav-btn",disabled:c.value===0,onClick:X}," ← 上一篇 ",8,Ee),n("span",Fe,f(c.value+1)+" / "+f(i.value.length),1),n("button",{class:"nav-btn",disabled:c.value===i.value.length-1,onClick:Z}," 下一篇 → ",8,Le)])):g("",!0)]),e[5]||(e[5]=n("footer",{class:"play-footer"},[n("p",{class:"footer-hint"}," 每次放豆即時計分；豆子用完即完成，時間到會自動結束 ")],-1))],64))]))}}),Ke=fe(Ne,[["__scopeId","data-v-609ae52d"]]);export{Ke as default};
