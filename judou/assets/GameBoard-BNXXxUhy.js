import{d as K,c as i,x as Q,r as O,w as L,f as X,R as Y,a as n,g as e,h as m,t as o,b as y,F as v,j as f,n as x,l as P,m as ee,i as C,o as l,_ as se}from"./index-v08fXWr_.js";import{u as te}from"./gameStore-HkWA7QEA.js";import{d as ae,B as oe,c as T}from"./game-TYh7-2x0.js";import{T as le}from"./TeamBadge-sXPgLcPb.js";import"./userStatsStore-0hGvBIX1.js";const ne={class:"board-header"},re={class:"header-left"},ie={class:"text-info"},ce={key:0},de={class:"header-center"},ue={class:"countdown-label"},me={class:"countdown-time"},ve={class:"header-right"},_e={class:"progress-info"},pe={class:"progress-value"},he={key:0,class:"team-progress-section"},ge={class:"team-progress-bar-large"},ye={class:"team-progress-content-large"},fe={class:"team-info-large"},ke={class:"team-name-row-large"},be={class:"team-name-large"},Se={class:"team-rank-large"},xe={class:"team-stats-large"},Ce={class:"team-score-large"},Te={class:"team-completion"},we={class:"time-progress-container"},Me={class:"time-progress-header"},Be={class:"time-progress-text"},Ae={class:"time-progress-bar"},Ge={class:"stats-panel"},Ie={class:"stat-card"},Re={class:"stat-content"},$e={class:"stat-value"},Fe={class:"stat-detail"},De={key:0,class:"stat-card"},Ee={class:"stat-content"},ze={class:"stat-value"},Ne={class:"stat-card"},Oe={class:"stat-content"},Le={class:"stat-value"},Ue={key:1,class:"stat-card"},Ve={class:"stat-content"},je={class:"stat-value"},We={class:"stat-detail"},Ze={key:1,class:"board-sidebar"},qe={class:"top-scores-panel"},He={class:"top-scores-list"},Je={class:"rank-badge"},Ke=["src","alt"],Qe={key:1,class:"top-score-avatar-placeholder"},Xe={class:"top-score-info"},Ye={class:"top-score-name"},Pe={class:"top-score-value"},es={key:0,class:"no-scores"},ss={class:"activity-stream-panel"},ts={class:"activity-stream-list"},as=["src","alt"],os={key:1,class:"activity-avatar-placeholder"},ls={class:"activity-content"},ns={class:"activity-text"},rs={key:0},is={key:1},cs={key:0,class:"no-activity"},ds={key:2,class:"finish-overlay"},us={class:"finish-content"},ms={class:"final-ranking"},vs={class:"rank"},_s={class:"team-name"},ps={class:"team-members"},hs={class:"team-avg-score"},gs={key:3,class:"board-main"},ys={class:"board-main-content"},fs={key:0,class:"recent-completions"},ks={class:"completions-list"},bs=["src","alt"],Ss={key:1,class:"completion-avatar-placeholder"},xs={class:"completion-info"},Cs={class:"completion-name"},Ts={class:"completion-score"},ws={class:"teams-battle"},Ms={class:"team-title"},Bs={class:"team-name-row"},As={class:"team-progress"},Gs={class:"team-score"},Is={class:"score-value"},Rs={class:"members-list"},$s={class:"member-info"},Fs=["src","alt"],Ds={key:1,class:"avatar-placeholder"},Es={class:"member-name"},zs={class:"member-status"},Ns={class:"score"},Os={class:"accuracy"},Ls={key:1,class:"status-badge playing"},Us={key:2,class:"status-badge waiting"},Vs=K({__name:"GameBoard",setup(js){const U=P(),V=Q(),b=te(),j=i(()=>V.params.roomId),c=i(()=>b.currentRoom),$=i(()=>c.value?.teams||[]),u=i(()=>c.value?.participants||[]),w=O(0);let _=null;const p=i(()=>c.value?.status==="finished"),k=i(()=>$.value.map(a=>{const t=u.value.filter(d=>d.team_id===a.id),s=t.filter(d=>d.status==="completed"),r=t.reduce((d,S)=>d+(S.score||0),0),g=t.length>0?r/t.length:0;return{team:a,memberCount:t.length,completedCount:s.length,averageScore:g}})),M=i(()=>[...k.value].sort((a,t)=>t.averageScore-a.averageScore)),W=i(()=>{const a={};for(const t of $.value)a[t.id]=u.value.filter(s=>s.team_id===t.id).sort((s,r)=>r.score-s.score);return a}),B=i(()=>u.value.filter(a=>a.status==="completed").length),A=i(()=>u.value.length),Z=i(()=>A.value===0?0:Math.round(B.value/A.value*100)),F=i(()=>{if(!k.value.length)return[];const a=Math.max(...k.value.map(s=>s.averageScore),1),t=a===0||a<.01;return k.value.map(s=>{const r=ae(s.team),g=r?oe[r]:null,d=t?1:Math.max(s.averageScore/a,.1);return{...s,productType:r,product:g,flexGrow:d,rank:M.value.findIndex(S=>S.team.id===s.team.id)+1}}).sort((s,r)=>r.averageScore-s.averageScore)}),G=i(()=>{const a=u.value.filter(d=>d.status==="completed"&&d.time_spent);if(a.length===0)return null;const s=a.reduce((d,S)=>d+(S.time_spent||0),0)/a.length,r=Math.floor(s/60),g=Math.floor(s%60);return{minutes:r,seconds:g}}),q=i(()=>u.value.length===0?0:Math.max(...u.value.map(a=>a.score||0),0)),D=i(()=>u.value.filter(a=>a.status==="completed"&&a.completed_at).sort((a,t)=>{const s=new Date(a.completed_at).getTime();return new Date(t.completed_at).getTime()-s}).slice(0,5)),I=i(()=>k.value.length===0?null:k.value.reduce((a,t)=>t.completedCount>a.completedCount?t:a)),R=i(()=>{if(!c.value?.started_at||!c.value?.time_limit)return 0;const a=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-a)/1e3);return Math.min(t/c.value.time_limit,1)*100}),E=i(()=>[...u.value].filter(a=>a.score>0).sort((a,t)=>(t.score||0)-(a.score||0)).slice(0,3).map((a,t)=>({...a,rank:t+1}))),h=O([]);L(()=>u.value,(a,t)=>{!t||t.length===0||(a.forEach(s=>{const r=t.find(g=>g.id===s.id);r&&(s.status==="completed"&&r.status!=="completed"?h.value.unshift({id:`${s.id}-${Date.now()}`,participant:s,action:"completed",score:s.score,timestamp:Date.now()}):s.score!==r.score&&s.score>r.score&&h.value.unshift({id:`${s.id}-${Date.now()}`,participant:s,action:"scored",score:s.score,timestamp:Date.now()}))}),h.value.length>10&&(h.value=h.value.slice(0,10)))},{deep:!0});function H(a){const t=Math.floor(a/60),s=a%60;return`${t}:${s.toString().padStart(2,"0")}`}function z(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const t=new Date(c.value.started_at).getTime(),s=Math.floor((Date.now()-t)/1e3);w.value=Math.max(0,c.value.time_limit-s),w.value===0&&(_&&(clearInterval(_),_=null),p.value||b.endGame())};a(),_=setInterval(a,1e3)}async function J(){confirm("ç¢ºå®šè¦çµæŸæ¯”è³½å—ï¼Ÿ")&&await b.endGame()}function N(){b.reset(),U.push({name:"arena"})}return L(()=>c.value?.status,a=>{a==="playing"&&!_&&z()}),X(()=>{b.subscribeToRoom(j.value),c.value?.status==="playing"&&z()}),Y(()=>{_&&clearInterval(_)}),(a,t)=>(l(),n("div",{class:y(["game-board",{finished:p.value}])},[e("header",ne,[e("div",re,[e("button",{class:"back-btn",onClick:N}," â† é›¢é–‹ "),e("div",ie,[e("h1",null,o(c.value?.text?.title),1),c.value?.text?.author?(l(),n("p",ce,o(c.value?.text?.author),1)):m("",!0)])]),e("div",de,[e("div",{class:y(["countdown",{warning:w.value<30}])},[e("span",ue,o(p.value?"æ¯”è³½çµæŸ":"å‰©é¤˜æ™‚é–“"),1),e("span",me,o(H(w.value)),1)],2)]),e("div",ve,[e("div",_e,[t[0]||(t[0]=e("span",{class:"progress-label"},"å®Œæˆé€²åº¦",-1)),e("span",pe,o(B.value)+" / "+o(u.value.length),1)]),p.value?m("",!0):(l(),n("button",{key:0,class:"btn-danger",onClick:J}," çµæŸæ¯”è³½ "))])]),!p.value&&F.value.length?(l(),n("div",he,[e("div",ge,[(l(!0),n(v,null,f(F.value,s=>(l(),n("div",{key:s.team.id,class:"team-progress-item-large",style:x({flex:`${s.flexGrow} 1 auto`,minWidth:"200px"})},[e("div",{class:"team-progress-segment-large",style:x({background:s.product?.color||"#e5e7eb"})},[e("div",ye,[s.productType?(l(),ee(le,{key:0,"product-type":s.productType,size:56,class:"team-badge-large"},null,8,["product-type"])):m("",!0),e("div",fe,[e("div",ke,[e("span",be,o(s.team.team_name),1),e("span",Se,"#"+o(s.rank),1)]),e("div",xe,[e("span",Ce,o(s.averageScore.toFixed(1)),1),t[1]||(t[1]=e("span",{class:"team-score-label"},"å¹³å‡åˆ†",-1)),t[2]||(t[2]=e("span",{class:"team-divider"},"â€¢",-1)),e("span",Te,o(s.completedCount)+"/"+o(s.memberCount),1),t[3]||(t[3]=e("span",{class:"team-completion-label"},"å®Œæˆ",-1))])])])],4)],4))),128))]),e("div",we,[e("div",Me,[t[4]||(t[4]=e("span",{class:"time-progress-label"},"æ¯”è³½é€²åº¦",-1)),e("span",Be,o(Math.round(R.value))+"%",1)]),e("div",Ae,[e("div",{class:y(["time-progress-fill",{warning:R.value>80}]),style:x({width:`${R.value}%`})},null,6)])]),e("div",Ge,[e("div",Ie,[t[6]||(t[6]=e("div",{class:"stat-icon"},"ğŸ“Š",-1)),e("div",Re,[e("div",$e,o(Z.value)+"%",1),t[5]||(t[5]=e("div",{class:"stat-label"},"å®Œæˆç‡",-1)),e("div",Fe,o(B.value)+" / "+o(A.value)+" äºº",1)])]),G.value?(l(),n("div",De,[t[9]||(t[9]=e("div",{class:"stat-icon"},"âš¡",-1)),e("div",Ee,[e("div",ze,o(G.value.minutes)+":"+o(G.value.seconds.toString().padStart(2,"0")),1),t[7]||(t[7]=e("div",{class:"stat-label"},"å¹³å‡é€Ÿåº¦",-1)),t[8]||(t[8]=e("div",{class:"stat-detail"},"å·²å®Œæˆå­¸ç”Ÿ",-1))])])):m("",!0),e("div",Ne,[t[12]||(t[12]=e("div",{class:"stat-icon"},"ğŸ†",-1)),e("div",Oe,[e("div",Le,o(q.value),1),t[10]||(t[10]=e("div",{class:"stat-label"},"æœ€é«˜åˆ†",-1)),t[11]||(t[11]=e("div",{class:"stat-detail"},"å€‹äººè¨˜éŒ„",-1))])]),I.value?(l(),n("div",Ue,[t[14]||(t[14]=e("div",{class:"stat-icon"},"ğŸ”¥",-1)),e("div",Ve,[e("div",je,o(I.value.completedCount),1),t[13]||(t[13]=e("div",{class:"stat-label"},"æœ€æ´»èº",-1)),e("div",We,o(I.value.team.team_name),1)])])):m("",!0)])])):m("",!0),p.value?m("",!0):(l(),n("aside",Ze,[e("div",qe,[t[15]||(t[15]=e("h3",{class:"panel-title"},"ğŸ† å¾—åˆ†å‰ä¸‰",-1)),e("div",He,[(l(!0),n(v,null,f(E.value,s=>(l(),n("div",{key:s.id,class:y(["top-score-item",{"rank-1":s.rank===1,"rank-2":s.rank===2,"rank-3":s.rank===3}])},[e("span",Je,o(s.rank),1),s.user?.avatar_url?(l(),n("img",{key:0,src:s.user.avatar_url,alt:s.user.display_name,class:"top-score-avatar"},null,8,Ke)):(l(),n("span",Qe,o(s.user?.display_name?.charAt(0)||"?"),1)),e("div",Xe,[e("span",Ye,o(s.user?.display_name||"æœªçŸ¥"),1),e("span",Pe,o(s.score)+" åˆ†",1)])],2))),128)),E.value.length===0?(l(),n("div",es," æš«ç„¡åˆ†æ•¸ ")):m("",!0)])]),e("div",ss,[t[16]||(t[16]=e("h3",{class:"panel-title"},"âš¡ å¯¦æ™‚å‹•æ…‹",-1)),e("div",ts,[(l(!0),n(v,null,f(h.value,s=>(l(),n("div",{key:s.id,class:y(["activity-item",s.action])},[s.participant.user?.avatar_url?(l(),n("img",{key:0,src:s.participant.user.avatar_url,alt:s.participant.user.display_name,class:"activity-avatar"},null,8,as)):(l(),n("span",os,o(s.participant.user?.display_name?.charAt(0)||"?"),1)),e("div",ls,[e("span",ns,[e("strong",null,o(s.participant.user?.display_name||"æœªçŸ¥"),1),s.action==="completed"?(l(),n("span",rs," å®Œæˆäº†ç­”é¡Œï¼")):s.action==="scored"?(l(),n("span",is," å¾—åˆ† "+o(s.score),1)):m("",!0)])])],2))),128)),h.value.length===0?(l(),n("div",cs," ç­‰å¾…æ´»å‹•... ")):m("",!0)])])])),p.value?(l(),n("div",ds,[e("div",us,[t[17]||(t[17]=e("div",{class:"trophy"},"ğŸ†",-1)),t[18]||(t[18]=e("h2",null,"æ¯”è³½çµæŸï¼",-1)),e("div",ms,[(l(!0),n(v,null,f(M.value,(s,r)=>(l(),n("div",{key:s.team.id,class:y(["ranking-item",{winner:r===0}]),style:x({"--team-primary":C(T)[s.team.team_color].primary,"--team-secondary":C(T)[s.team.team_color].secondary})},[e("span",vs,o(r+1),1),e("span",_s,o(s.team.team_name),1),e("span",ps,o(s.completedCount)+"/"+o(s.memberCount)+" äºº",1),e("span",hs,o(s.averageScore.toFixed(1))+" åˆ†",1)],6))),128))]),t[19]||(t[19]=e("p",{class:"scoring-note"},"* ä»¥éšŠå“¡å¹³å‡åˆ†è¨ˆç®—æ’å",-1)),e("button",{class:"btn-primary btn-large",onClick:N}," è¿”å›é¬¥è±† ")])])):(l(),n("main",gs,[e("div",ys,[D.value.length>0?(l(),n("div",fs,[t[20]||(t[20]=e("h3",{class:"section-title"},"ğŸ‰ æœ€è¿‘å®Œæˆ",-1)),e("div",ks,[(l(!0),n(v,null,f(D.value,s=>(l(),n("div",{key:s.id,class:"completion-item"},[s.user?.avatar_url?(l(),n("img",{key:0,src:s.user.avatar_url,alt:s.user.display_name,class:"completion-avatar"},null,8,bs)):(l(),n("span",Ss,o(s.user?.display_name?.charAt(0)||"?"),1)),e("div",xs,[e("span",Cs,o(s.user?.display_name||"æœªçŸ¥"),1),e("span",Ts,o(s.score)+" åˆ†",1)])]))),128))])])):m("",!0),e("div",ws,[(l(!0),n(v,null,f(M.value,s=>(l(),n("div",{key:s.team.id,class:"team-column",style:x({"--team-primary":C(T)[s.team.team_color].primary,"--team-secondary":C(T)[s.team.team_color].secondary,"--team-text":C(T)[s.team.team_color].text})},[e("div",Ms,[e("div",Bs,[e("h2",null,o(s.team.team_name),1),e("span",As,o(s.completedCount)+"/"+o(s.memberCount),1)]),e("div",Gs,[e("span",Is,o(s.averageScore.toFixed(1)),1),t[21]||(t[21]=e("span",{class:"score-label"},"å¹³å‡åˆ†",-1))])]),e("div",Rs,[(l(!0),n(v,null,f(W.value[s.team.id],r=>(l(),n("div",{key:r.id,class:y(["member-row",{completed:r.status==="completed"}])},[e("div",$s,[r.user?.avatar_url?(l(),n("img",{key:0,src:r.user.avatar_url,alt:r.user.display_name,class:"avatar"},null,8,Fs)):(l(),n("span",Ds,o(r.user?.display_name?.charAt(0)||"?"),1)),e("span",Es,o(r.user?.display_name||"æœªçŸ¥"),1)]),e("div",zs,[r.status==="completed"?(l(),n(v,{key:0},[e("span",Ns,o(r.score)+" åˆ†",1),e("span",Os,o(r.accuracy?.toFixed(0))+"%",1)],64)):r.status==="playing"?(l(),n("span",Ls,"ä½œç­”ä¸­...")):(l(),n("span",Us,"ç­‰å¾…ä¸­"))])],2))),128))])],4))),128))])])]))],2))}}),Ks=se(Vs,[["__scopeId","data-v-320b2739"]]);export{Ks as default};
