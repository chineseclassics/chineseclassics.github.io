import{v as k,u as q,r as _,c as f,H as s}from"./index-Cc6Y11VN.js";const l=[0,100,300,600,1e3,1500,2200,3e3,4e3,5200,6600,8200,1e4,12e3,15e3],O=k("userStats",()=>{const o=q(),t=_(null),p=_(!1),u=_(null),d=_(null),h=f(()=>{if(!t.value)return 1;const e=t.value.total_exp;for(let a=l.length-1;a>=0;a--){const r=l[a];if(r!==void 0&&e>=r)return a+1}return 1}),g=f(()=>{if(!t.value)return 0;const e=h.value,a=l[e-1]||0,r=l[e]||a+1e3,n=t.value.total_exp-a,c=r-a;return Math.min(100,Math.round(n/c*100))}),w=f(()=>{if(!t.value)return 100;const e=h.value,a=l[l.length-1]??15e3,r=l[e]??a+1e3;return Math.max(0,r-t.value.total_exp)}),y=f(()=>!t.value||t.value.total_practices===0?0:Math.round(t.value.correct_count/t.value.total_practices*100));async function S(){if(!(!s||!o.user)){p.value=!0,u.value=null;try{const{data:e,error:a}=await s.from("user_stats").select("*").eq("user_id",o.user.id).single();if(a){if(a.code==="PGRST116"){await b();return}throw a}t.value=e}catch(e){u.value=e.message,console.error("獲取用戶統計失敗:",e)}finally{p.value=!1}}}async function b(){if(!(!s||!o.user))try{const{data:e,error:a}=await s.from("user_stats").insert({user_id:o.user.id,beans:0,total_exp:0,total_practices:0,correct_count:0,streak_days:0}).select().single();if(a)throw a;t.value=e}catch(e){u.value=e.message,console.error("創建用戶統計失敗:",e)}}async function E(e){if(!s||!t.value)return!1;try{const a=t.value.beans+e,{error:r}=await s.from("user_stats").update({beans:a,updated_at:new Date().toISOString()}).eq("user_id",t.value.user_id);if(r)throw r;return t.value.beans=a,!0}catch(a){return u.value=a.message,!1}}async function I(e){if(!s||!t.value)return!1;try{const a=t.value.total_exp+e,{error:r}=await s.from("user_stats").update({total_exp:a,updated_at:new Date().toISOString()}).eq("user_id",t.value.user_id);if(r)throw r;return t.value.total_exp=a,!0}catch(a){return u.value=a.message,!1}}async function D(e,a,r){if(!s||!t.value)return!1;try{const n={beans:t.value.beans+a,total_exp:t.value.total_exp+r,total_practices:t.value.total_practices+1,correct_count:t.value.correct_count+(e?1:0),last_practice_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:c}=await s.from("user_stats").update(n).eq("user_id",t.value.user_id);if(c)throw c;return t.value.beans=n.beans,t.value.total_exp=n.total_exp,t.value.total_practices=n.total_practices,t.value.correct_count=n.correct_count,t.value.last_practice_at=n.last_practice_at,!0}catch(n){return u.value=n.message,!1}}async function L(){if(!(!s||!o.user))try{const{data:e,error:a}=await s.from("user_stats").select("user_id, beans").order("beans",{ascending:!1});if(a)throw a;if(!e||e.length===0){d.value=null;return}const r=e.findIndex(i=>i.user_id===o.user.id),n=r===-1?e.length+1:r+1,c=t.value?.beans??0;let m=null;if(e.length>0&&e[0]){const{data:i}=await s.from("users").select("display_name").eq("id",e[0].user_id).single();m={name:i?.display_name||"匿名",beans:e[0].beans}}let x=null;const v=r>0?e[r-1]:null;if(n>1&&v){const{data:i}=await s.from("users").select("display_name").eq("id",v.user_id).single();x={name:i?.display_name||"匿名",beans:v.beans,gap:v.beans-c}}d.value={rank:n,totalUsers:e.length,topUser:m,nextUser:x}}catch(e){console.error("獲取排名信息失敗:",e)}}function T(){t.value=null,d.value=null,u.value=null}return{stats:t,loading:p,error:u,rankInfo:d,level:h,levelProgress:g,expToNextLevel:w,accuracy:y,fetchStats:S,fetchRankInfo:L,addBeans:E,addExp:I,recordPractice:D,reset:T}});export{O as u};
