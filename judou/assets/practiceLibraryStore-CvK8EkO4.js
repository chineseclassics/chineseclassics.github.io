import{m as B,r as v,c as m}from"./index-DyOt8lR1.js";import{u as q}from"./useSupabase-Chv3mLlr.js";const D=/[。！？；，：]/g,F=/[「」『』“”"']/g,K=/\|{2,}/g;function z(r){if(!r)return"";const o=r.replace(F,"").replace(D,"|").replace(K,"|").trim();return o.endsWith("|")?o.slice(0,-1):o}function G(r){const e=r.replace(/\|/g,"").length;return e<=70?1:e<=150?2:3}function M(r){return r.replace(/\|/g,"").length}const O=B("texts",()=>{const r=q(),e=v([]),g=v(!1),o=v(null),_=m(()=>[...e.value].sort((n,i)=>(i.created_at??"").localeCompare(n.created_at??"")));async function I(){if(!r){o.value="Supabase 尚未配置";return}g.value=!0,o.value=null;try{const{data:n,error:i}=await r.from("practice_texts").select(`
          *,
          category:practice_categories (
            id,
            name,
            slug,
            level,
            parent_id
          )
        `).order("created_at",{ascending:!1});if(i)throw i;e.value=n||[]}catch(n){o.value=n.message??"無法載入文章"}finally{g.value=!1}}async function p(n){if(!r)throw new Error("Supabase 尚未配置");const i=z(n.content),u=G(i),w=M(i),{data:h,error:f}=await r.from("practice_texts").insert({title:n.title,author:n.author??null,source:n.source??null,summary:n.summary??null,category_id:n.category_id||null,content:i,difficulty:u,word_count:w}).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(f)throw f;h&&e.value.unshift(h)}async function T(n,i){if(!r)throw new Error("Supabase 尚未配置");const u=z(i.content),w=G(u),h=M(u),{data:f,error:x}=await r.from("practice_texts").update({title:i.title,author:i.author??null,source:i.source??null,summary:i.summary??null,category_id:i.category_id||null,content:u,difficulty:w,word_count:h}).eq("id",n).select(`
        *,
        category:practice_categories (
          id,
          name,
          slug,
          level,
          parent_id
        )
      `).single();if(x)throw x;f&&(e.value=e.value.map(y=>y.id===n?f:y))}async function E(n){if(!r)throw new Error("Supabase 尚未配置");const{error:i}=await r.from("practice_texts").delete().eq("id",n);if(i)throw i;e.value=e.value.filter(u=>u.id!==n)}async function S(n){if(!r)return;const i=n.username??"anonymous_user",u=n.display_name??"匿名學員";await r.from("practice_records").insert({...n,username:i,display_name:u})}function C(){if(!e.value.length)return null;const n=Math.floor(Math.random()*e.value.length);return e.value[n]}return{texts:e,sortedTexts:_,isLoading:g,error:o,fetchTexts:I,addText:p,updateText:T,deleteText:E,recordPracticeResult:S,getRandomText:C}}),L=[{id:"grade-7",name:"七年級",slug:"grade-7",parent_id:null,level:1,type:"grade",description:"適合初階練習者，聚焦於啟蒙經典與日常應用題材。",order_index:1},{id:"grade-7-module-lunyu",name:"論語讀本",slug:"grade-7-module-lunyu",parent_id:"grade-7",level:2,type:"module",description:"以語錄題材培養句型感與節奏感。",order_index:1},{id:"grade-7-theme-renyi",name:"仁義篇",slug:"grade-7-theme-renyi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"圍繞「仁」與「義」的章句，適合練習短句斷讀。",order_index:1},{id:"grade-7-theme-xuexi",name:"學習篇",slug:"grade-7-theme-xuexi",parent_id:"grade-7-module-lunyu",level:3,type:"theme",description:"關於求學與修身的篇章，句式多變。",order_index:2},{id:"anthology-guwenguan-zhi",name:"古文觀止",slug:"anthology-guwenguan-zhi",parent_id:null,level:1,type:"grade",description:"以主題式選編進行高階訓練。",order_index:2},{id:"anthology-guwenguan-zhi-warring",name:"戰國策",slug:"anthology-guwenguan-zhi-warring",parent_id:"anthology-guwenguan-zhi",level:2,type:"module",description:"戰國時期縱橫家精彩篇章，節奏快速。",order_index:1},{id:"anthology-guwenguan-zhi-warring-theme",name:"遊說名篇",slug:"anthology-guwenguan-zhi-warring-theme",parent_id:"anthology-guwenguan-zhi-warring",level:3,type:"theme",description:"以遊說篇章作為高階斷句挑戰。",order_index:1}],P=[{id:"text-renyi-01",title:"論語・學而篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:1,summary:"子曰：「弟子入則孝...」",word_count:86,content:"子曰|弟子入則孝||出則弟|信而好|犯而不|怨..."},{id:"text-renyi-02",title:"論語・里仁篇",author:"孔子及弟子",category_id:"grade-7-theme-renyi",difficulty:2,summary:"里仁為美，擇其善者而從之。",word_count:120,content:"子曰|里仁為美|擇不處仁|焉得知||仁者安仁|知者利仁"},{id:"text-xuexi-01",title:"論語・為政篇",author:"孔子及弟子",category_id:"grade-7-theme-xuexi",difficulty:2,summary:"溫故而知新，可以為師矣。",word_count:95,content:"子曰|溫故而知新|可以為師矣|學而不思則罔|思而不學則殆"},{id:"text-warring-01",title:"蘇秦說齊王",author:"蘇秦",category_id:"anthology-guwenguan-zhi-warring-theme",difficulty:3,summary:"以合縱策略說服齊王，語勢跌宕。",word_count:260,content:"蘇秦曰|大王處東海之濱|南有江淮之饒|北有燕代之利|..."}];function A(r){return r.trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9\-\u4e00-\u9fa5]/g,"").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"").slice(0,64)||`category-${Date.now()}`}const Q=B("practice-library",()=>{const r=q(),e=v({categories:[],texts:[],selectedGradeId:null,selectedModuleId:null,selectedThemeId:null,selectedTextId:null}),g=v(!1),o=v(null);function _(){e.value.categories=[...L],e.value.texts=[...P],e.value.selectedGradeId=e.value.selectedGradeId??L.find(t=>t.level===1)?.id??null}async function I(){g.value=!0,o.value=null;try{if(!r){_();return}const{data:t,error:a}=await r.from("practice_categories").select("*").order("level",{ascending:!0}).order("order_index",{ascending:!0});if(a)throw a;if(!t?.length){_();return}const{data:l,error:c}=await r.from("practice_texts").select("*").order("title",{ascending:!0});if(c)throw c;e.value.categories=t,e.value.texts=l||[],e.value.selectedGradeId=e.value.selectedGradeId??e.value.categories.find(s=>s.level===1)?.id??null}catch(t){console.error("Failed to load practice library",t),o.value=t?.message??"無法載入練習庫",_()}finally{g.value=!1}}function p(t){t==="grade"&&(e.value.selectedModuleId=null,e.value.selectedThemeId=null),t!=="theme"&&(e.value.selectedTextId=null),t==="module"&&(e.value.selectedThemeId=null)}const T=m(()=>[...e.value.categories].sort((t,a)=>t.level===a.level?t.order_index-a.order_index:t.level-a.level)),E=m(()=>T.value.filter(t=>t.level===1)),S=m(()=>e.value.categories.filter(t=>t.parent_id===e.value.selectedGradeId)),C=m(()=>e.value.categories.filter(t=>t.parent_id===e.value.selectedModuleId)),n=m(()=>{const t=e.value.selectedThemeId??e.value.selectedModuleId??e.value.selectedGradeId;return t?e.value.texts.filter(a=>a.category_id===t):[]}),i=m(()=>e.value.texts.find(t=>t.id===e.value.selectedTextId)??null);function u(t){e.value.selectedGradeId!==t&&(e.value.selectedGradeId=t,p("grade"))}function w(t){e.value.selectedModuleId!==t&&(e.value.selectedModuleId=t,p("module"))}function h(t){e.value.selectedThemeId!==t&&(e.value.selectedThemeId=t,p("theme"))}function f(t){e.value.selectedTextId=t}async function x(t){if(!r)throw new Error("Supabase 尚未配置");const a=t.parent_id?e.value.categories.find(b=>b.id===t.parent_id):null;if(t.type!=="grade"&&!a)throw new Error("請選擇上層分類");if(a&&a.level>=3)throw new Error("目前僅支援三級分類");const l=a?a.level+1:1,c=t.type??(a?a.level===1?"module":"theme":"grade"),{data:s,error:d}=await r.from("practice_categories").insert({name:t.name,slug:A(t.name),parent_id:t.parent_id,level:l,type:c,description:t.description??null,order_index:t.order_index??0}).select("*").single();if(d)throw d;return s&&e.value.categories.push(s),s}async function y(t,a){if(!r)throw new Error("Supabase 尚未配置");const l={};a.name!==void 0&&(l.name=a.name,l.slug=A(a.name)),a.description!==void 0&&(l.description=a.description),a.order_index!==void 0&&(l.order_index=a.order_index);const{data:c,error:s}=await r.from("practice_categories").update(l).eq("id",t).select("*").single();if(s)throw s;if(c){const d=e.value.categories.findIndex(b=>b.id===t);d!==-1&&(e.value.categories[d]=c)}return c}async function R(t){if(!r)throw new Error("Supabase 尚未配置");if(e.value.categories.some(d=>d.parent_id===t))throw new Error("此分類下還有子分類，請先刪除子分類");const{count:l,error:c}=await r.from("practice_texts").select("id",{count:"exact",head:!0}).eq("category_id",t);if(c)throw c;if(l&&l>0)throw new Error(`此分類下還有 ${l} 篇文章，請先移除或重新分類`);const{error:s}=await r.from("practice_categories").delete().eq("id",t);if(s)throw s;e.value.categories=e.value.categories.filter(d=>d.id!==t),e.value.selectedGradeId===t&&(e.value.selectedGradeId=null),e.value.selectedModuleId===t&&(e.value.selectedModuleId=null),e.value.selectedThemeId===t&&(e.value.selectedThemeId=null)}return{state:e,isLoading:g,error:o,rootCategories:E,modules:S,themes:C,visibleTexts:n,selectedText:i,fetchLibrary:I,selectGrade:u,selectModule:w,selectTheme:h,selectText:f,addCategory:x,updateCategory:y,deleteCategory:R}});export{Q as a,O as u};
