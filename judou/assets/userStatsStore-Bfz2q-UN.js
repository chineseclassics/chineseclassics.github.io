import{q as E,u as b,r as d,c as i,H as u}from"./index-CK8f08u7.js";const o=[0,100,300,600,1e3,1500,2200,3e3,4e3,5200,6600,8200,1e4,12e3,15e3],T=E("userStats",()=>{const l=b(),e=d(null),v=d(!1),n=d(null),_=i(()=>{if(!e.value)return 1;const r=e.value.total_exp;for(let t=o.length-1;t>=0;t--){const a=o[t];if(a!==void 0&&r>=a)return t+1}return 1}),f=i(()=>{if(!e.value)return 0;const r=_.value,t=o[r-1]||0,a=o[r]||t+1e3,s=e.value.total_exp-t,c=a-t;return Math.min(100,Math.round(s/c*100))}),p=i(()=>{if(!e.value)return 100;const r=_.value,t=o[o.length-1]??15e3,a=o[r]??t+1e3;return Math.max(0,a-e.value.total_exp)}),h=i(()=>!e.value||e.value.total_practices===0?0:Math.round(e.value.correct_count/e.value.total_practices*100));async function x(){if(!(!u||!l.user)){v.value=!0,n.value=null;try{const{data:r,error:t}=await u.from("user_stats").select("*").eq("user_id",l.user.id).single();if(t){if(t.code==="PGRST116"){await S();return}throw t}e.value=r}catch(r){n.value=r.message,console.error("獲取用戶統計失敗:",r)}finally{v.value=!1}}}async function S(){if(!(!u||!l.user))try{const{data:r,error:t}=await u.from("user_stats").insert({user_id:l.user.id,beans:0,total_exp:0,total_practices:0,correct_count:0,streak_days:0}).select().single();if(t)throw t;e.value=r}catch(r){n.value=r.message,console.error("創建用戶統計失敗:",r)}}async function w(r){if(!u||!e.value)return!1;try{const t=e.value.beans+r,{error:a}=await u.from("user_stats").update({beans:t,updated_at:new Date().toISOString()}).eq("user_id",e.value.user_id);if(a)throw a;return e.value.beans=t,!0}catch(t){return n.value=t.message,!1}}async function g(r){if(!u||!e.value)return!1;try{const t=e.value.total_exp+r,{error:a}=await u.from("user_stats").update({total_exp:t,updated_at:new Date().toISOString()}).eq("user_id",e.value.user_id);if(a)throw a;return e.value.total_exp=t,!0}catch(t){return n.value=t.message,!1}}async function m(r,t,a){if(!u||!e.value)return!1;try{const s={beans:e.value.beans+t,total_exp:e.value.total_exp+a,total_practices:e.value.total_practices+1,correct_count:e.value.correct_count+(r?1:0),last_practice_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:c}=await u.from("user_stats").update(s).eq("user_id",e.value.user_id);if(c)throw c;return e.value.beans=s.beans,e.value.total_exp=s.total_exp,e.value.total_practices=s.total_practices,e.value.correct_count=s.correct_count,e.value.last_practice_at=s.last_practice_at,!0}catch(s){return n.value=s.message,!1}}function y(){e.value=null,n.value=null}return{stats:e,loading:v,error:n,level:_,levelProgress:f,expToNextLevel:p,accuracy:h,fetchStats:x,addBeans:w,addExp:g,recordPractice:m,reset:y}});export{T as u};
