const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-mRk65oNV.js","assets/index-BxfFoeQc.css"])))=>i.map(i=>d[i]);
import{d as ve,c as i,q as me,r as T,w as fe,o as he,K as pe,a as o,b as n,F as y,e as g,n as b,t as f,m as W,g as N,i as _e,L as Te,s as r,_ as ge}from"./index-mRk65oNV.js";import{u as ke}from"./gameStore-DTfiaZnL.js";import"./userStatsStore-18iv_D_Y.js";const ye={class:"game-play"},be={key:0,class:"loading-container"},we={class:"play-header"},xe={class:"header-left"},Be={class:"countdown-time"},Se={class:"header-center"},Ce={class:"text-title"},Ae={key:0,class:"text-author"},Ie={class:"header-right"},Re=["disabled"],Ve={key:0,class:"text-tabs"},ze=["onClick"],Ge={class:"tab-number"},Pe={class:"tab-title"},Me={key:0,class:"tab-check"},qe={class:"play-main"},De={class:"board-header"},Ee={class:"board-header-right"},Ne={class:"practice-board"},$e={key:0,class:"practice-line"},Le={class:"char"},Oe=["onClick","aria-label"],Ue={key:0,class:"bean"},Ke={class:"progress-hint"},Fe={key:0,class:"text-nav"},He=["disabled"],Je={class:"nav-info"},je=["disabled"],Qe={class:"play-footer"},We={key:0,class:"footer-hint submitted"},Xe={key:1,class:"footer-hint"},Ye=3e3,Ze=6e4,et=ve({__name:"GamePlay",setup(tt){const x=_e(),X=me(),_=ke(),h=i(()=>X.params.roomId),c=i(()=>_.currentRoom),l=T([]),d=T(new Map),v=T(0),m=i(()=>l.value[v.value]),V=i(()=>m.value&&d.value.get(m.value.id)||null),z=i(()=>V.value?.characters||[]),$=i(()=>V.value?.correctBreaks||new Set),w=i({get:()=>V.value?.userBreaks||new Set,set:a=>{if(m.value&&d.value.has(m.value.id)){const e=d.value.get(m.value.id);e.userBreaks=a}}}),B=T(0);let G=null;const L=i(()=>$.value.size),Y=i(()=>w.value.size),O=i(()=>Math.max(0,L.value-Y.value)),Z=i(()=>O.value>0),P=T(!1),p=T(!1),U=T(!0);let K=0,S=null,C=null;function ee(a){const e=[],t=new Set;let s=0;for(const u of a)u==="|"?s>0&&t.add(s-1):u!==`
`&&u!=="\r"&&(e.push(u),s++);return{chars:e,breaks:t}}function te(){d.value.clear();for(const a of l.value){const e=ee(a.content);d.value.set(a.id,{characters:e.chars,correctBreaks:e.breaks,userBreaks:new Set})}}function ae(a){a>=0&&a<l.value.length&&(v.value=a)}function se(){v.value>0&&v.value--}function ne(){v.value<l.value.length-1&&v.value++}let M=null;function q(a){try{M||(M=new AudioContext);const e=M,t=e.createOscillator(),s=e.createGain();t.connect(s),s.connect(e.destination),t.type="sine",a==="add"?(t.frequency.setValueAtTime(400,e.currentTime),t.frequency.exponentialRampToValueAtTime(200,e.currentTime+.1),s.gain.setValueAtTime(.3,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)):a==="remove"?(t.frequency.setValueAtTime(300,e.currentTime),t.frequency.exponentialRampToValueAtTime(150,e.currentTime+.08),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.08),t.start(e.currentTime),t.stop(e.currentTime+.08)):(t.frequency.setValueAtTime(200,e.currentTime),s.gain.setValueAtTime(.2,e.currentTime),s.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15))}catch{}}function D(a=10){navigator.vibrate&&navigator.vibrate(a)}function oe(a){if(p.value||!m.value)return;const e=d.value.get(m.value.id);if(!e)return;const t=new Set(e.userBreaks),s=t.has(a);if(!s&&t.size>=e.correctBreaks.size){q("error"),P.value=!0,setTimeout(()=>{P.value=!1},300),D(50);return}s?(t.delete(a),q("remove"),D(5)):(t.add(a),q("add"),D(10)),e.userBreaks=t,d.value=new Map(d.value)}function re(a){return{"has-bean":w.value.has(a)}}function A(a){const e=d.value.get(a);if(!e)return"empty";const t=e.userBreaks.size,s=e.correctBreaks.size;return t===0?"empty":t===s&&[...e.correctBreaks].every(u=>e.userBreaks.has(u))?"complete":"partial"}async function F(){if(p.value)return;p.value=!0;const a=Math.round((Date.now()-K)/1e3);let e=0,t=0;const s=[];for(const J of l.value){const E=d.value.get(J.id);if(!E)continue;const I=E.correctBreaks,j=E.userBreaks;let R=0,Q=0;for(const de of j)I.has(de)?R++:Q++;const ce=I.size-R;e+=R,t+=I.size,s.push({textId:J.id,userBreaks:[...j],correctBreaks:[...I],correctCount:R,wrongCount:Q,missedCount:ce})}const u=t>0?e/t*100:0;sessionStorage.setItem(`game-result-${h.value}`,JSON.stringify({texts:l.value,results:s,totalCorrect:e,totalBreaks:t,accuracy:u,timeSpent:a})),await _.submitScore({roomId:h.value,score:e,accuracy:u,timeSpent:a,firstAccuracy:u,attemptCount:1}),le()}function le(){console.log("[GamePlay] 啟動備用狀態檢查機制"),k(),S=setInterval(async()=>{await H()},Ye),C=setTimeout(()=>{console.log("[GamePlay] 狀態檢查超時，強制跳轉到結果頁"),k(),x.push({name:"arena-result",params:{roomId:h.value}})},Ze),H()}function k(){S&&(clearInterval(S),S=null),C&&(clearTimeout(C),C=null)}async function H(){if(_.currentRoom){if(_.currentRoom.status==="finished"){console.log("[GamePlay] 本地狀態為 finished，跳轉到結果頁"),k(),x.push({name:"arena-result",params:{roomId:h.value}});return}try{const{supabase:a}=await Te(async()=>{const{supabase:t}=await import("./index-mRk65oNV.js").then(s=>s.M);return{supabase:t}},__vite__mapDeps([0,1]));if(!a)return;const{data:e}=await a.from("game_rooms").select("status").eq("id",h.value).single();e?.status==="finished"?(console.log("[GamePlay] 數據庫狀態為 finished，跳轉到結果頁"),k(),x.push({name:"arena-result",params:{roomId:h.value}})):console.log("[GamePlay] 狀態檢查: 當前狀態為",e?.status)}catch(a){console.error("[GamePlay] 狀態檢查錯誤:",a)}}}function ue(a){const e=Math.floor(a/60),t=a%60;return`${e}:${t.toString().padStart(2,"0")}`}function ie(){if(!c.value?.started_at||!c.value?.time_limit)return;const a=()=>{const e=new Date(c.value.started_at).getTime(),t=Math.floor((Date.now()-e)/1e3);B.value=Math.max(0,c.value.time_limit-t),B.value===0&&!p.value&&F()};a(),G=setInterval(a,1e3)}return fe(()=>c.value?.status,a=>{a==="finished"&&(console.log("[GamePlay] watch 檢測到 finished 狀態，跳轉到結果頁"),k(),x.push({name:"arena-result",params:{roomId:h.value}}))}),he(async()=>{_.subscribeToRoom(h.value),c.value?.text_ids&&c.value.text_ids.length>0?l.value=await _.fetchTexts(c.value.text_ids):c.value?.text_id&&(l.value=await _.fetchTexts([c.value.text_id])),U.value=!1,l.value.length>0&&(te(),K=Date.now(),ie())}),pe(()=>{G&&clearInterval(G),k()}),(a,e)=>(r(),o("div",ye,[U.value?(r(),o("div",be,[...e[0]||(e[0]=[n("span",{class:"loading-spinner"},"⏳",-1),n("span",null,"載入題目中...",-1)])])):(r(),o(y,{key:1},[n("header",we,[n("div",xe,[n("div",{class:b(["countdown",{warning:B.value<30}])},[e[1]||(e[1]=n("span",{class:"countdown-label"},"剩餘時間",-1)),n("span",Be,f(ue(B.value)),1)],2)]),n("div",Se,[n("span",Ce,f(m.value?.title),1),m.value?.author?(r(),o("span",Ae,f(m.value.author),1)):g("",!0)]),n("div",Ie,[n("button",{class:b(["submit-btn",{waiting:p.value}]),disabled:p.value,onClick:F},[p.value?(r(),o(y,{key:0},[e[2]||(e[2]=n("span",{class:"waiting-spinner"},"⏳",-1)),e[3]||(e[3]=W(" 等待其他玩家... ",-1))],64)):(r(),o(y,{key:1},[W(" 提交答案 ")],64))],10,Re)])]),l.value.length>1?(r(),o("div",Ve,[(r(!0),o(y,null,N(l.value,(t,s)=>(r(),o("button",{key:t.id,class:b(["text-tab",{active:s===v.value,empty:A(t.id)==="empty",partial:A(t.id)==="partial",complete:A(t.id)==="complete"}]),onClick:u=>ae(s)},[n("span",Ge,f(s+1),1),n("span",Pe,f(t.title),1),A(t.id)==="complete"?(r(),o("span",Me,"✓")):g("",!0)],10,ze))),128))])):g("",!0),n("main",qe,[n("div",De,[e[4]||(e[4]=n("p",{class:"board-hint"},"點擊字間空隙種下句豆來斷句",-1)),n("div",Ee,[n("div",{class:b(["bean-inventory",{shake:P.value,empty:!Z.value}])},[(r(!0),o(y,null,N(L.value,t=>(r(),o("span",{key:t,class:b(["inventory-bean",{used:t>O.value}])},null,2))),128))],2)])]),n("div",Ne,[z.value.length?(r(),o("div",$e,[(r(!0),o(y,null,N(z.value,(t,s)=>(r(),o("span",{key:s,class:"char-unit"},[n("span",Le,f(t),1),s<z.value.length-1?(r(),o("button",{key:0,class:b(["bean-slot",re(s)]),onClick:u=>oe(s),"aria-label":`在「${t}」後${w.value.has(s)?"移除":"添加"}斷句`},[w.value.has(s)?(r(),o("span",Ue)):g("",!0),e[5]||(e[5]=n("span",{class:"bean-hint"},null,-1))],10,Oe)):g("",!0)]))),128))])):g("",!0)]),n("div",Ke,[n("span",null,"已標記 "+f(w.value.size)+" / "+f($.value.size)+" 處",1)]),l.value.length>1?(r(),o("div",Fe,[n("button",{class:"nav-btn",disabled:v.value===0,onClick:se}," ← 上一篇 ",8,He),n("span",Je,f(v.value+1)+" / "+f(l.value.length),1),n("button",{class:"nav-btn",disabled:v.value===l.value.length-1,onClick:ne}," 下一篇 → ",8,je)])):g("",!0)]),n("footer",Qe,[p.value?(r(),o("p",We," ✅ 已提交答案，等待其他玩家完成或時間結束... ")):(r(),o("p",Xe," 完成所有文章後點擊「提交答案」，或等待時間結束自動提交 "))])],64))]))}}),ot=ge(et,[["__scopeId","data-v-16fb32fd"]]);export{ot as default};
