import{v as ae,u as re,r as y,c as w,I as a}from"./index-DWbhl1Ks.js";import{u as se}from"./userStatsStore-DV7BQQ3u.js";const _e=[0,10,30,50,100],me=[{value:60,label:"閃電戰",description:"1 分鐘"},{value:180,label:"標準",description:"3 分鐘"},{value:300,label:"持久",description:"5 分鐘"}],de=[2,3,4],ie={3:5,5:10,7:20,10:50},h={DAILY_FEE_LIMIT:100,MIN_BALANCE:20,MAX_LOSS_STREAK:5},ne={red:{name:"紅隊",primary:"#ef4444",secondary:"#fecaca",text:"#991b1b"},blue:{name:"藍隊",primary:"#3b82f6",secondary:"#bfdbfe",text:"#1e40af"},green:{name:"綠隊",primary:"#22c55e",secondary:"#bbf7d0",text:"#166534"},yellow:{name:"黃隊",primary:"#eab308",secondary:"#fef08a",text:"#854d0e"}};function oe(u){return["red","blue","green","yellow"].slice(0,u)}function ue(u){return ne[u].name}const A=[{minLevel:1,maxLevel:2,title:"童生",color:"#78716c"},{minLevel:3,maxLevel:5,title:"秀才",color:"#22c55e"},{minLevel:6,maxLevel:9,title:"舉人",color:"#3b82f6"},{minLevel:10,maxLevel:14,title:"進士",color:"#8b5cf6"},{minLevel:15,maxLevel:19,title:"探花",color:"#f59e0b"},{minLevel:20,maxLevel:24,title:"榜眼",color:"#ef4444"},{minLevel:25,maxLevel:999,title:"狀元",color:"#dc2626"}];function fe(u){for(const f of A)if(u>=f.minLevel&&u<=f.maxLevel)return f;return A[0]}const pe=ae("game",()=>{const u=re(),f=se(),s=y(null),T=y([]),l=y(null),p=y(!1),o=y(null);let g=null;const v=w(()=>!s.value||!u.user?!1:s.value.host_id===u.user.id),P=w(()=>s.value?.status==="playing"),M=w(()=>s.value?.status==="waiting"),N=w(()=>s.value?.status==="finished"),O=w(()=>!l.value?.team_id||!s.value?.teams?null:s.value.teams.find(e=>e.id===l.value.team_id));async function R(e){if(!a||!u.user)return o.value="請先登入",null;p.value=!0,o.value=null;try{const{data:t,error:r}=await a.from("game_rooms").insert({host_id:u.user.id,host_type:e.hostType,game_mode:e.gameMode,text_id:e.textIds[0],text_ids:e.textIds,time_limit:e.timeLimit,team_count:e.teamCount||null,max_players:e.maxPlayers||null,entry_fee:e.entryFee||0,class_id:e.classId||null}).select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url)
        `).single();if(r)return o.value=r.message,null;if(e.gameMode==="team_battle"&&e.teamCount){const n=oe(e.teamCount).map((m,d)=>({room_id:t.id,team_name:ue(m),team_color:m,order_index:d})),{data:c,error:_}=await a.from("game_teams").insert(n).select();_?console.error("創建團隊失敗:",_):t.teams=c}return e.hostType==="student"&&await E(t.id,e.entryFee||0),s.value=t,t}catch(t){return o.value=t.message,null}finally{p.value=!1}}async function G(e){if(!a||!u.user)return{success:!1,error:"請先登入"};p.value=!0,o.value=null;try{const{data:t,error:r}=await a.from("game_rooms").select(`
          *,
          host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
          text:practice_texts!game_rooms_text_id_fkey(id, title, author, content),
          teams:game_teams!game_teams_room_id_fkey(*),
          participants:game_participants(
            *,
            user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
          )
        `).eq("room_code",e.toUpperCase()).single();if(r||!t)return{success:!1,error:"找不到該房間"};if(t.status!=="waiting")return{success:!1,error:"該房間已開始或已結束"};const i=t.participants?.find(_=>_.user_id===u.user.id);if(i)return s.value=t,l.value=i,S(t.id),{success:!0,room:t,participant:i};if(t.max_players&&t.participants&&t.participants.length>=t.max_players)return{success:!1,error:"房間已滿"};if(t.entry_fee>0&&!await D(t.id,t.entry_fee))return{success:!1,error:o.value||"無法支付入場費"};const n=await E(t.id,t.entry_fee);if(!n)return{success:!1,error:o.value||"加入房間失敗"};const c=[...t.participants||[],n];return s.value={...t,participants:c},l.value=n,S(t.id),{success:!0,room:t,participant:n}}catch(t){return o.value=t.message,{success:!1,error:o.value}}finally{p.value=!1}}async function E(e,t){if(!a||!u.user)return null;const{data:r,error:i}=await a.from("game_participants").insert({room_id:e,user_id:u.user.id,fee_paid:t}).select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).single();return i?(o.value=i.message,null):(t>0&&await a.from("game_rooms").update({prize_pool:a.rpc("increment_prize_pool",{room_id:e,amount:t})}).eq("id",e),r)}async function D(e,t){if(!a||!u.user)return!1;const r=f.profile?.total_beans??0;if(r-t<h.MIN_BALANCE)return o.value=`賬戶需保留至少 ${h.MIN_BALANCE} 豆`,!1;const i=f.profile,n=new Date().toISOString().split("T")[0],c=i?.daily_fee_reset_at===n&&i?.daily_fee_spent||0;if(c+t>h.DAILY_FEE_LIMIT)return o.value=`今日入場費已達上限 ${h.DAILY_FEE_LIMIT} 豆`,!1;const{error:_}=await a.from("user_stats").update({beans:r-t,daily_fee_spent:c+t,daily_fee_reset_at:n}).eq("user_id",u.user.id);return _?(o.value="扣除入場費失敗",!1):(await a.from("game_transactions").insert({user_id:u.user.id,room_id:e,type:"entry_fee",amount:-t,balance_after:r-t,description:`入場費 ${t} 豆`}),await f.fetchProfile(),!0)}async function q(e,t){if(!a||!v.value)return o.value="無權限",!1;const{error:r}=await a.from("game_participants").update({team_id:t}).eq("id",e);return r?(o.value=r.message,!1):!0}async function z(){if(!a||!v.value||!s.value?.teams)return o.value="無法分組",!1;const e=s.value.participants||[],t=s.value.teams,r=[...e].sort(()=>Math.random()-.5);for(let i=0;i<r.length;i++){const n=i%t.length,c=t[n],_=r[i];c&&_&&await q(_.id,c.id)}return!0}async function $(){if(!a||!v.value||!s.value)return o.value="無權限",!1;if(s.value.game_mode==="team_battle"){const t=s.value.participants?.filter(r=>!r.team_id);if(t&&t.length>0)return o.value="還有玩家未分組",!1}const{error:e}=await a.from("game_rooms").update({status:"playing",started_at:new Date().toISOString()}).eq("id",s.value.id);return e?(o.value=e.message,!1):(await a.from("game_participants").update({status:"playing"}).eq("room_id",s.value.id),!0)}async function B(e){if(!a||!u.user||!s.value)return o.value="無法提交分數",!1;const{error:t}=await a.from("game_participants").update({score:e.score,accuracy:e.accuracy,time_spent:e.timeSpent,first_accuracy:e.firstAccuracy,attempt_count:e.attemptCount,status:"completed",completed_at:new Date().toISOString()}).eq("room_id",e.roomId).eq("user_id",u.user.id);return t?(o.value=t.message,!1):(l.value?.team_id&&await L(l.value.team_id),await Y(),!0)}async function F(e){if(!a||!u.user||!l.value)return o.value="無法提交進度",!1;await a.from("game_text_progress").upsert({participant_id:l.value.id,text_id:e.textId,text_index:e.textIndex,correct_count:e.correctCount,wrong_count:e.wrongCount,time_spent:e.timeSpent,completed_at:new Date().toISOString()},{onConflict:"participant_id,text_id"});const t=(l.value.correct_breaks||0)+e.correctCount,r=(l.value.completed_texts||0)+1,i=e.textIndex+1,{error:n}=await a.from("game_participants").update({correct_breaks:t,completed_texts:r,current_text_index:i,score:t}).eq("id",l.value.id);return n?(o.value=n.message,!1):(l.value.correct_breaks=t,l.value.completed_texts=r,l.value.current_text_index=i,l.value.score=t,l.value.team_id&&await L(l.value.team_id),!0)}async function U(e){if(!a||e.length===0)return[];const{data:t}=await a.from("practice_texts").select("id, title, author, content").in("id",e);if(t){const r=new Map(t.map(i=>[i.id,i]));return e.map(i=>r.get(i)).filter(Boolean)}return[]}async function L(e){if(!a||!s.value)return;const{data:t}=await a.from("game_participants").select("score").eq("team_id",e).eq("status","completed"),r=t?.length||0,i=t?.reduce((c,_)=>c+(_.score||0),0)||0,n=r>0?Math.round(i/r*100):0;await a.from("game_teams").update({total_score:n}).eq("id",e)}async function Y(){if(!a||!s.value)return;const{data:e}=await a.from("game_participants").select("status").eq("room_id",s.value.id);if(!e)return;const t=e.every(c=>c.status==="completed"),r=s.value.started_at?new Date(s.value.started_at):null,i=s.value.time_limit*1e3,n=r&&Date.now()-r.getTime()>=i;(t||n)&&await k()}async function k(){if(!a||!s.value)return null;const{data:e}=await a.from("game_rooms").select(`
        *,
        teams:game_teams!game_teams_room_id_fkey(*),
        participants:game_participants(
          *,
          user:users!game_participants_user_id_fkey(id, display_name, avatar_url)
        )
      `).eq("id",s.value.id).single();if(!e)return null;let t=null,r=null,i=[];if(e.game_mode==="team_battle"&&e.teams)t=[...e.teams].sort((m,d)=>d.total_score-m.total_score)[0]?.id,i=e.participants?.filter(m=>m.team_id===t)||[];else{const _=[...e.participants||[]].sort((m,d)=>d.score-m.score)[0];r=_?.user_id,i=_?[_]:[]}await a.from("game_rooms").update({status:"finished",ended_at:new Date().toISOString(),winner_team_id:t,winner_user_id:r}).eq("id",e.id);let n=[];return e.prize_pool>0&&i.length>0&&(n=await j(e,i)),await W(e,i),{room:e,winners:i,winningTeam:e.teams?.find(c=>c.id===t),prizeDistribution:n}}async function j(e,t){if(!a)return[];const r=Math.floor(e.prize_pool/t.length),i=[];for(const n of t){const{data:c}=await a.from("user_stats").select("pvp_win_streak").eq("user_id",n.user_id).single(),_=(c?.pvp_win_streak||0)+1;let m=0;for(const[ee,te]of Object.entries(ie))if(_===Number(ee)){m=te;break}const d=r+m,{data:Z}=await a.from("user_stats").select("beans").eq("user_id",n.user_id).single(),C=(Z?.beans||0)+d;await a.from("user_stats").update({beans:C}).eq("user_id",n.user_id),await a.from("game_participants").update({prize_won:d}).eq("id",n.id),await a.from("game_transactions").insert({user_id:n.user_id,room_id:e.id,type:"prize",amount:d,balance_after:C,description:`收豆 ${r} 豆${m>0?` + 連勝獎勵 ${m} 豆`:""}`}),i.push({userId:n.user_id,displayName:n.user?.display_name||"未知",prize:r,streakBonus:m})}return i}async function W(e,t){if(!a)return;const r=new Set(t.map(i=>i.user_id));for(const i of e.participants||[]){const n=r.has(i.user_id);n?await a.rpc("increment_win_streak",{p_user_id:i.user_id}):await a.from("user_stats").update({pvp_win_streak:0}).eq("user_id",i.user_id),await a.rpc("increment_pvp_games",{p_user_id:i.user_id,p_is_win:n})}}let b=null;function S(e){if(!a){console.log("[Game] subscribeToRoom: supabase 未初始化");return}if(b===e&&g){console.log("[Game] 已經訂閱房間:",e,"，跳過重複訂閱");return}console.log("[Game] 開始訂閱房間:",e),x(),b=e,g=a.channel(`game-room-${e}`).on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${e}`},t=>{if(console.log("[Game] 房間更新:",t.eventType,t.new),t.new){const r=t.new;s.value={...s.value,...r,participants:s.value?.participants,teams:s.value?.teams,host:s.value?.host,text:s.value?.text,class:s.value?.class},console.log("[Game] 房間狀態已更新為:",r.status)}}).on("postgres_changes",{event:"*",schema:"public",table:"game_participants",filter:`room_id=eq.${e}`},async t=>{console.log("[Game] 參與者更新:",t.eventType),await K(e)}).on("postgres_changes",{event:"*",schema:"public",table:"game_teams",filter:`room_id=eq.${e}`},async t=>{console.log("[Game] 團隊更新:",t.eventType),await H(e)}).subscribe(t=>{console.log("[Game] 房間訂閱狀態:",t),t==="CHANNEL_ERROR"&&(console.error("[Game] 訂閱錯誤，將嘗試重新連接..."),b=null)})}async function K(e){if(!a)return;const{data:t}=await a.from("game_participants").select(`
        *,
        user:users!game_participants_user_id_fkey(id, display_name, avatar_url, email)
      `).eq("room_id",e);t&&s.value&&(s.value.participants=t,u.user&&(l.value=t.find(r=>r.user_id===u.user.id)||null))}async function H(e){if(!a)return;const{data:t}=await a.from("game_teams").select("*").eq("room_id",e).order("order_index");t&&s.value&&(s.value.teams=t)}function x(){g&&(a?.removeChannel(g),g=null),b=null}async function X(){if(!a)return;p.value=!0;const{data:e,error:t}=await a.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        participants:game_participants(count)
      `).eq("status","waiting").eq("host_type","student").order("created_at",{ascending:!1}).limit(20);t?o.value=t.message:T.value=(e||[]).map(r=>({...r,participant_count:r.participants?.[0]?.count||0})),p.value=!1}async function J(e){if(!a)return[];const{data:t}=await a.from("game_rooms").select(`
        *,
        text:practice_texts!game_rooms_text_id_fkey(id, title, author)
      `).eq("class_id",e).in("status",["waiting","playing"]).order("created_at",{ascending:!1});return t||[]}async function Q(){if(!(!a||!s.value||!u.user)){if(v.value&&s.value.status==="waiting"){if(await a.from("game_rooms").update({status:"cancelled"}).eq("id",s.value.id),s.value.entry_fee>0)for(const e of s.value.participants||[])await I(e)}else!v.value&&s.value.status==="waiting"&&(await a.from("game_participants").delete().eq("room_id",s.value.id).eq("user_id",u.user.id),l.value?.fee_paid&&await I(l.value));x(),s.value=null,l.value=null}}async function I(e){if(!a||!e.fee_paid)return;const{data:t}=await a.from("user_stats").select("beans").eq("user_id",e.user_id).single(),r=(t?.beans||0)+e.fee_paid;await a.from("user_stats").update({beans:r}).eq("user_id",e.user_id),await a.from("game_transactions").insert({user_id:e.user_id,room_id:e.room_id,type:"refund",amount:e.fee_paid,balance_after:r,description:"房間取消，退還入場費"})}function V(){x(),s.value=null,l.value=null,T.value=[],o.value=null}return{currentRoom:s,rooms:T,myParticipant:l,loading:p,error:o,isHost:v,isPlaying:P,isWaiting:M,isFinished:N,myTeam:O,createRoom:R,joinRoom:G,assignToTeam:q,randomAssignTeams:z,leaveRoom:Q,startGame:$,submitScore:B,submitTextProgress:F,fetchTexts:U,endGame:k,subscribeToRoom:S,unsubscribe:x,fetchPublicRooms:X,fetchClassGames:J,reset:V}});export{_e as E,h as S,de as T,oe as a,me as b,ne as c,fe as g,pe as u};
