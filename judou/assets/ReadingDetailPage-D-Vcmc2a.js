import{d as he,u as ve,c as I,x as fe,r as y,f as pe,P as ge,Q as me,w as ke,a as h,g as s,h as k,m as q,t as v,i as g,b as S,q as _e,F as D,j,s as H,y as xe,n as ye,N as be,l as Ce,o as c,_ as we}from"./index-2hsWxGz3.js";import{u as Te}from"./readingStore-CdQDk4sS.js";import{a as Q,S as Se,V as Be,c as Pe,b as Me}from"./useClassicalTTS-Bk3_kkWt.js";import"./useSupabase-C8DFqRyX.js";import"./createLucideIcon-DSDnHeQE.js";const Ae={class:"reading-detail-page"},Ee={class:"reading-header edamame-glass"},Re={class:"header-title"},Le={class:"title-meta"},ze={key:0,class:"author"},Ne={key:1,class:"source-tag"},Ie={class:"header-actions"},De={class:"control-bar edamame-glass"},Oe=["aria-pressed"],Ve={class:"toggle-switch"},Xe={key:0,class:"reading-content edamame-glass"},Fe={class:"reading-line"},Ye=["onMouseenter","onClick","onTouchend"],Ue=["onClick","disabled"],$e={key:0,class:"verification-result"},qe={class:"result-stats"},je={class:"stat correct"},He={class:"stat missed"},Qe={class:"stat extra"},We={class:"stat accuracy"},Ge={class:"content-actions"},Je=["disabled"],Ke={key:1,class:"loading-state edamame-glass"},Ze={class:"tooltip-term"},et={key:0,class:"tooltip-pinyin"},tt={class:"tooltip-content"},nt=he({__name:"ReadingDetailPage",setup(st){const W=fe(),G=Ce(),o=Te(),O=ve(),A=I(()=>W.params.id),p=y(!0),C=y(new Set),r=y(null),f=y(null),b=y(!1),B=I(()=>{if(!o.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const t=o.currentText.content,e=t.includes("||")?"||":/\n\n+/,n=t.split(e),d=[],u=[],a=new Set;let i=0;for(const l of n){const m=[],x=new Set,$=i,L=l.replace(/[\|\s]+$/,"");for(const M of L)M==="|"?i>0&&(a.add(i-1),x.add(m.length-1)):M!==`
`&&M!=="\r"&&(u.push(M),m.push(M),i++);m.length>0&&d.push({chars:m,breaks:x,startIdx:$,endIdx:i-1})}return{paragraphs:d,allChars:u,allBreaks:a}}),V=I(()=>B.value.paragraphs),J=y(0);function w(t){return o.currentText?.annotations&&o.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const T=y(null),_=y(!1);function K(t){return T.value?w(t)?.id===T.value:!1}function Z(t){return w(t)?.start_index===t}function ee(t){const e=w(t);return e?e.end_index-1===t:!1}function te(t,e){if(_.value)return;const n=w(t);n&&(T.value=n.id,F(n,e))}function ne(){_.value||(T.value=null,E())}function X(t,e){const n=w(t);if(!n)return;if(e.stopPropagation(),f.value&&f.value.annotation.id===n.id){E();return}T.value=n.id;const d="touches"in e?e.touches[0]?.clientX??0:e.clientX,u="touches"in e?e.touches[0]?.clientY??0:e.clientY;F(n,{clientX:d,clientY:u})}function se(t){if(p.value)return;const e=new Set(C.value);e.has(t)?e.delete(t):e.add(t),C.value=e,r.value=null}function ae(){const{allBreaks:t,allChars:e}=B.value;if(!e.length)return;const n=[],d=[],u=[];for(let l=0;l<e.length;l++){const m=t.has(l),x=C.value.has(l);m&&x?n.push(l):m&&!x?d.push(l):!m&&x&&u.push(l)}const a=t.size,i=a>0?n.length/a:1;r.value={correct:n,missed:d,extra:u,accuracy:i}}function oe(){p.value=!0,r.value=null}function re(){C.value=new Set,r.value=null}function F(t,e){f.value={annotation:t,x:e.clientX,y:e.clientY}}function E(){T.value=null,f.value=null}function R(t){if(!_.value||!f.value)return;const e=t.target;!e.closest(".char.has-annotation")&&!e.closest(".annotation-tooltip")&&E()}function Y(){const{allChars:t,allBreaks:e,paragraphs:n}=B.value;if(!t.length)return[];const d=[];for(const u of n){let a="",i=u.startIdx-1;for(let l=u.startIdx;l<=u.endIdx;l++){const m=l-u.startIdx;a+=u.chars[m];const x=e.has(l);if(l===u.endIdx)a+="。";else if(x){const L=l-i;i=l,L>=8?a+="。":L>=4?a+="，":a+="、"}}a.trim()&&d.push(a)}return d}let P=!1;function U(){P=!0,Pe(),b.value=!1}const z={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function ie(){if(!B.value.allChars.length)return;if(b.value){U();return}b.value=!0,P=!1;const t=Y();try{for(let e=0;e<t.length&&!P;e++){const n=t[e+1];n&&Q(n,z);const d=t[e];d&&await Me(d,z)}}catch(e){console.error("TTS 播放失敗:",e),P||alert("語音朗讀失敗，請稍後再試")}finally{b.value=!1,P=!1}}async function le(){if(!O.isAuthenticated){alert("請先登入以使用書籤功能");return}await o.toggleBookmark(A.value)}function ce(){G.push({name:"reading-list"})}function ue(t){const e=[],{allBreaks:n}=B.value;return p.value?n.has(t)&&e.push("has-break","correct"):C.value.has(t)?(e.push("has-break","user-marked"),r.value&&(r.value.correct.includes(t)?e.push("verified-correct"):r.value.extra.includes(t)&&e.push("verified-extra"))):r.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}function N(){_.value=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window||navigator.maxTouchPoints>0}pe(async()=>{N(),window.addEventListener("resize",N),_.value&&(document.addEventListener("click",R),document.addEventListener("touchend",R)),await o.fetchTextDetail(A.value),o.startReadingTracking(),o.currentText?.progress&&(J.value=o.currentText.progress.last_paragraph),await ge();const e=Y()[0];e&&Q(e,z)});function de(){return r.value?Math.round(r.value.accuracy*100):p.value?50:0}return me(()=>{if(U(),window.removeEventListener("resize",N),_.value&&(document.removeEventListener("click",R),document.removeEventListener("touchend",R)),A.value&&O.isAuthenticated){const t=de(),e=r.value?.accuracy===1;o.saveReadingRecord(A.value,t,e)}}),ke(p,t=>{t&&(r.value=null)}),(t,e)=>(c(),h("div",Ae,[s("header",Ee,[s("button",{class:"back-btn",onClick:ce}," ← 返回 "),s("div",Re,[s("h1",null,v(g(o).currentText?.title||"載入中..."),1),s("div",Le,[g(o).currentText?.author?(c(),h("span",ze,v(g(o).currentText.author),1)):k("",!0),g(o).currentText?.source_text?.title?(c(),h("span",Ne," · 選自《"+v(g(o).currentText.source_text.title)+"》 ",1)):k("",!0)])]),s("div",Ie,[s("button",{class:S(["action-btn bookmark-btn",{active:g(o).currentText?.progress?.bookmarked}]),onClick:le,title:"收藏"},v(g(o).currentText?.progress?.bookmarked?"⭐":"☆"),3)])]),s("section",De,[s("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=n=>p.value=!p.value),"aria-pressed":p.value,type:"button"},[e[3]||(e[3]=s("span",{class:"toggle-label"},"顯示斷句",-1)),s("span",Ve,[s("span",{class:S(["toggle-track",{active:p.value}])},[...e[2]||(e[2]=[s("span",{class:"toggle-thumb"},null,-1)])],2)])],8,Oe),s("button",{class:S(["tts-btn",{playing:b.value}]),onClick:ie},[(c(),q(_e(b.value?g(Se):g(Be)),{size:18,"stroke-width":1.5})),s("span",null,v(b.value?" 停止朗讀":" 朗讀全文"),1)],2)]),g(o).currentText&&V.value.length>0?(c(),h("section",Xe,[(c(!0),h(D,null,j(V.value,(n,d)=>(c(),h("div",{key:d,class:"paragraph-block"},[s("div",Fe,[(c(!0),h(D,null,j(n.chars,(u,a)=>(c(),h("span",{key:a,class:"char-unit"},[s("span",{class:S(["char",{"has-annotation":w(n.startIdx+a),"annotation-hovered":K(n.startIdx+a),"annotation-start":Z(n.startIdx+a),"annotation-end":ee(n.startIdx+a)}]),onMouseenter:i=>te(n.startIdx+a,i),onMouseleave:ne,onClick:i=>X(n.startIdx+a,i),onTouchend:i=>X(n.startIdx+a,i)},v(u),43,Ye),a<n.chars.length-1?(c(),h("button",{key:0,class:S(["break-slot",ue(n.startIdx+a)]),onClick:i=>se(n.startIdx+a),disabled:p.value},[...e[4]||(e[4]=[s("span",{class:"break-marker"},null,-1)])],10,Ue)):k("",!0)]))),128))])]))),128)),r.value?(c(),h("div",$e,[s("div",qe,[s("span",je,"✓ 正確："+v(r.value.correct.length),1),s("span",He,"○ 遺漏："+v(r.value.missed.length),1),s("span",Qe,"✗ 多餘："+v(r.value.extra.length),1),s("span",We," 正確率："+v(Math.round(r.value.accuracy*100))+"% ",1)]),s("button",{class:"show-answer-btn",onClick:oe}," 查看正確答案 ")])):k("",!0),s("div",Ge,[p.value?k("",!0):(c(),h(D,{key:0},[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:re}," 重置 "),s("button",{class:"edamame-btn edamame-btn-primary",onClick:ae,disabled:C.value.size===0}," ✓ 驗證我的斷句 ",8,Je)],64))])])):g(o).isLoading?(c(),h("section",Ke,[...e[5]||(e[5]=[s("span",{class:"loading-spinner"},null,-1),H(" 載入中... ",-1)])])):k("",!0),(c(),q(be,{to:"body"},[f.value?(c(),h("div",{key:0,class:S(["annotation-tooltip",{"mobile-tooltip":_.value}]),style:ye({left:f.value.x+"px",top:f.value.y+16+"px"}),onClick:e[1]||(e[1]=xe(()=>{},["stop"]))},[_.value?(c(),h("button",{key:0,class:"tooltip-close-btn",onClick:E,"aria-label":"關閉註釋"}," ✕ ")):k("",!0),s("div",Ze,[H(v(f.value.annotation.term)+" ",1),f.value.annotation.pinyin?(c(),h("span",et,"（"+v(f.value.annotation.pinyin)+"）",1)):k("",!0)]),s("div",tt,v(f.value.annotation.annotation),1)],6)):k("",!0)]))]))}}),ct=we(nt,[["__scopeId","data-v-dee16708"]]);export{ct as default};
