import{d as z,u as W,r as g,c as h,o as J,K as H,a,b as s,e as u,g as c,f as r,t as l,D as E,F as R,i as M,n as S,A as Q,B as Z,G as ss,I as m,j as ts,q as o,_ as es}from"./index-WxQqpgYr.js";import{u as as,g as B,E as ls,S as K}from"./gameStore-Ba_FC4tl.js";import{u as os}from"./userStatsStore-DPG0Ja2t.js";const ns={class:"arena-page"},is={class:"arena-header"},rs={key:0,class:"stats-card"},us={class:"stat-item"},ds={class:"stat-value"},cs={class:"stat-item"},vs={class:"stat-label"},ps={key:0,class:"stat-item streak"},ms={class:"stat-value"},_s={class:"stat-item"},fs={class:"stat-value"},ys={class:"stat-label"},bs={key:0,class:"login-prompt"},gs={key:1,class:"arena-main"},hs={key:0,class:"class-game-section"},ks={key:0,class:"loading-card"},Cs={key:1,class:"class-game-card"},ws={class:"game-info"},Is={class:"game-title-row"},Ts={class:"game-meta"},xs={class:"class-name"},Ss={class:"host-name"},As={class:"game-code"},Ls=["disabled","onClick"],js={key:0,class:"error-message"},Gs={key:1,class:"teacher-section"},Es={key:2,class:"student-section"},Rs={key:0,class:"section-divider"},Ms={class:"tab-nav"},Ns={class:"tab-icon"},Ps={class:"tab-content"},$s={key:0,class:"rooms-panel"},Fs={class:"panel-header"},Xs=["disabled"],Bs={key:0,class:"loading-state"},Ks={key:1,class:"empty-state"},Us={key:2,class:"room-list"},Vs=["onClick"],Ds={class:"room-info"},qs={class:"room-title"},Os={class:"room-host"},Ys={class:"room-meta"},zs={class:"room-players"},Ws={key:0,class:"room-fee"},Js={key:1,class:"room-fee free"},Hs={key:1,class:"join-panel"},Qs={class:"join-card"},Zs={class:"code-input-group"},st=["disabled"],tt={key:0,class:"error-message"},et={key:2,class:"create-panel"},at={key:0,class:"unlock-card"},lt={class:"progress-bar"},ot={class:"progress-text"},nt={key:1,class:"create-card"},it={class:"fee-info"},rt={class:"fee-options"},ut={class:"safety-info"},dt={class:"safety-text"},T=5,ct=z({__name:"ArenaPage",setup(vt){const b=ts(),i=W(),v=as(),_=os(),d=g("rooms"),C=g(""),f=g(!1),p=g(""),w=g([]),x=g(!1);let k=null;const y=g([]),U=h(()=>_.profile?.total_beans??0),I=h(()=>_.level),A=h(()=>B(I.value)),N=h(()=>_.profile?.pvp_win_streak??0),L=h(()=>({wins:_.profile?.pvp_total_wins??0,games:_.profile?.pvp_total_games??0,winRate:_.profile?.pvp_total_games?Math.round((_.profile?.pvp_total_wins??0)/_.profile.pvp_total_games*100):0})),j=h(()=>I.value>=T),G=h(()=>w.value.length>0);async function P(){if(!m||!i.user)return[];const{data:n}=await m.from("class_members").select("class_id").eq("student_id",i.user.id);return n?.map(t=>t.class_id)||[]}async function $(){if(!(!m||!i.user||i.isTeacher)){x.value=!0;try{if(y.value.length===0&&(y.value=await P()),y.value.length===0){w.value=[];return}const{data:n}=await m.from("game_rooms").select(`
        *,
        host:users!game_rooms_host_id_fkey(id, display_name, avatar_url),
        text:practice_texts!game_rooms_text_id_fkey(id, title, author),
        class:classes!game_rooms_class_id_fkey(id, class_name),
        teams:game_teams(*)
      `).in("class_id",y.value).eq("host_type","teacher").in("status",["waiting","playing"]).order("created_at",{ascending:!1});w.value=n||[]}catch(n){console.error("ç²å–ç­ç´šæ¯”è³½å¤±æ•—:",n),w.value=[]}finally{x.value=!1}}}async function V(){!m||!i.user||i.isTeacher||(y.value.length===0&&(y.value=await P()),y.value.length!==0&&(k&&m.removeChannel(k),k=m.channel("class-games").on("postgres_changes",{event:"*",schema:"public",table:"game_rooms"},async n=>{console.log("[Arena] game_rooms è®Šæ›´:",n.eventType);const t=n.new?.class_id||n.old?.class_id;!t||!y.value.includes(t)||await $()}).subscribe(n=>{console.log("[Arena] Realtime è¨‚é–±ç‹€æ…‹:",n)})))}function D(){k&&m&&(m.removeChannel(k),k=null)}async function q(n){f.value=!0,p.value="";const t=await v.joinRoom(n.room_code);t.success?n.status==="playing"?b.push({name:"arena-play",params:{roomId:n.id}}):b.push({name:"arena-lobby",params:{roomId:n.id}}):p.value=t.error||"åŠ å…¥å¤±æ•—",f.value=!1}async function F(){if(!C.value.trim()){p.value="è«‹è¼¸å…¥æˆ¿é–“ç¢¼";return}f.value=!0,p.value="";const n=await v.joinRoom(C.value.trim());n.success?n.room?.status==="playing"?b.push({name:"arena-play",params:{roomId:n.room.id}}):b.push({name:"arena-lobby",params:{roomId:n.room.id}}):p.value=n.error||"åŠ å…¥å¤±æ•—",f.value=!1}function X(){i.isTeacher?b.push({name:"arena-teacher-create"}):b.push({name:"arena-create"})}J(async()=>{i.isAuthenticated&&(v.fetchPublicRooms(),i.isTeacher||(await $(),V()))});const O=setInterval(()=>{i.isAuthenticated&&d.value==="rooms"&&v.fetchPublicRooms()},15e3);return H(()=>{clearInterval(O),D()}),(n,t)=>(o(),a("div",ns,[s("header",is,[t[11]||(t[11]=s("div",{class:"header-content"},[s("h1",{class:"page-title"},[s("span",{class:"title-icon"},"âš”ï¸"),c(" é¬¥è±† ")]),s("p",{class:"page-subtitle"},"èˆ‡åŒå­¸ä¸€è¼ƒé«˜ä¸‹ï¼Œåœ¨ç«¶æŠ€ä¸­æˆé•·")],-1)),r(i).isAuthenticated?(o(),a("div",rs,[s("div",us,[t[6]||(t[6]=s("span",{class:"stat-icon"},"ðŸ«˜",-1)),s("span",ds,l(U.value),1),t[7]||(t[7]=s("span",{class:"stat-label"},"è±†å­",-1))]),s("div",cs,[s("span",{class:"stat-icon",style:E({color:A.value.color})},"ðŸŽ“",4),s("span",{class:"stat-value",style:E({color:A.value.color})},l(A.value.title),5),s("span",vs,"Lv."+l(I.value),1)]),N.value>0?(o(),a("div",ps,[t[8]||(t[8]=s("span",{class:"stat-icon"},"ðŸ”¥",-1)),s("span",ms,l(N.value),1),t[9]||(t[9]=s("span",{class:"stat-label"},"é€£å‹",-1))])):u("",!0),s("div",_s,[t[10]||(t[10]=s("span",{class:"stat-icon"},"ðŸ“Š",-1)),s("span",fs,l(L.value.winRate)+"%",1),s("span",ys,"å‹çŽ‡ ("+l(L.value.wins)+"/"+l(L.value.games)+")",1)])])):u("",!0)]),r(i).isAuthenticated?(o(),a("main",gs,[!r(i).isTeacher&&(G.value||x.value)?(o(),a("section",hs,[x.value?(o(),a("div",ks,[...t[15]||(t[15]=[s("div",{class:"spinner"},null,-1),s("p",null,"æª¢æŸ¥ç­ç´šæ¯”è³½...",-1)])])):G.value?(o(),a("div",Cs,[t[19]||(t[19]=s("div",{class:"card-header"},[s("span",{class:"card-icon"},"ðŸ«"),s("h2",null,"ç­ç´šé€²è¡Œä¸­çš„æ¯”è³½")],-1)),(o(!0),a(R,null,M(w.value,e=>(o(),a("div",{key:e.id,class:"game-item"},[s("div",ws,[s("div",Is,[s("h3",null,l(e.text?.title||"æœªçŸ¥æ–‡æœ¬"),1),s("span",{class:S(["game-status",e.status])},l(e.status==="playing"?"ðŸ”´ é€²è¡Œä¸­":"ðŸŸ¡ ç­‰å¾…ä¸­"),3)]),s("p",Ts,[s("span",xs,l(e.class?.class_name),1),t[16]||(t[16]=s("span",{class:"divider"},"Â·",-1)),s("span",Ss,l(e.host?.display_name)+" è€å¸«ç™¼èµ·",1)]),s("p",As,[t[17]||(t[17]=c(" æˆ¿é–“ç¢¼ï¼š",-1)),s("strong",null,l(e.room_code),1),t[18]||(t[18]=s("span",{class:"code-hint"},"ï¼ˆå¯åˆ†äº«çµ¦å…¶ä»–åŒå­¸ï¼‰",-1))])]),s("button",{class:"btn-primary btn-join",disabled:f.value,onClick:Y=>q(e)},l(f.value?"åŠ å…¥ä¸­...":"ç«‹å³åŠ å…¥"),9,Ls)]))),128)),p.value?(o(),a("p",js,l(p.value),1)):u("",!0)])):u("",!0)])):u("",!0),r(i).isTeacher?(o(),a("section",Gs,[t[21]||(t[21]=s("h2",{class:"section-title"},[s("span",{class:"section-icon"},"ðŸ“¢"),c(" èª²å ‚é¬¥è±† ")],-1)),t[22]||(t[22]=s("p",{class:"section-desc"},"å‰µå»ºç­ç´šæ¯”è³½ï¼Œè®“å­¸ç”Ÿåˆ†çµ„ç«¶æŠ€",-1)),s("button",{class:"btn-primary btn-large",onClick:X},[...t[20]||(t[20]=[s("span",{class:"btn-icon"},"âž•",-1),c(" å‰µå»ºèª²å ‚é¬¥è±† ",-1)])])])):u("",!0),r(i).isTeacher?u("",!0):(o(),a("div",Es,[G.value?(o(),a("div",Rs,[...t[23]||(t[23]=[s("span",{class:"divider-text"},"å…¶ä»–åŠŸèƒ½",-1)])])):u("",!0),s("nav",Ms,[s("button",{class:S(["tab-btn",{active:d.value==="join"}]),onClick:t[1]||(t[1]=e=>d.value="join")},[...t[24]||(t[24]=[s("span",{class:"tab-icon"},"ðŸŽ«",-1),c(" è¼¸å…¥æˆ¿é–“ç¢¼ ",-1)])],2),s("button",{class:S(["tab-btn",{active:d.value==="rooms"}]),onClick:t[2]||(t[2]=e=>d.value="rooms")},[...t[25]||(t[25]=[s("span",{class:"tab-icon"},"ðŸŸï¸",-1),c(" å…¬é–‹é¬¥è±†å ´ ",-1)])],2),s("button",{class:S(["tab-btn",{active:d.value==="create",locked:!j.value}]),onClick:t[3]||(t[3]=e=>d.value="create")},[s("span",Ns,l(j.value?"âž•":"ðŸ”’"),1),t[26]||(t[26]=c(" å‰µå»ºé¬¥è±†å ´ ",-1))],2)]),s("div",Ps,[d.value==="rooms"?(o(),a("div",$s,[s("div",Fs,[t[27]||(t[27]=s("h3",null,"å¯åŠ å…¥çš„é¬¥è±†å ´",-1)),s("button",{class:"btn-text",onClick:t[4]||(t[4]=e=>r(v).fetchPublicRooms()),disabled:r(v).loading}," ðŸ”„ åˆ·æ–° ",8,Xs)]),r(v).loading?(o(),a("div",Bs,[...t[28]||(t[28]=[s("div",{class:"spinner"},null,-1),s("p",null,"è¼‰å…¥ä¸­...",-1)])])):r(v).rooms.length===0?(o(),a("div",Ks,[...t[29]||(t[29]=[s("div",{class:"empty-icon"},"ðŸœï¸",-1),s("p",null,"æš«ç„¡é–‹æ”¾çš„é¬¥è±†å ´",-1),s("p",{class:"empty-hint"},"ä½ å¯ä»¥å‰µå»ºä¸€å€‹é¬¥è±†å ´é‚€è«‹åŒå­¸",-1)])])):(o(),a("ul",Us,[(o(!0),a(R,null,M(r(v).rooms,e=>(o(),a("li",{key:e.id,class:"room-card",onClick:Y=>r(b).push({name:"arena-lobby",params:{roomId:e.id}})},[s("div",Ds,[s("h4",qs,l(e.text?.title||"æœªçŸ¥æ–‡æœ¬"),1),s("p",Os," å±€ä¸»ï¼š"+l(e.host?.display_name||"æœªçŸ¥"),1)]),s("div",Ys,[s("span",zs," ðŸ‘¥ "+l(e.participant_count||0)+"/"+l(e.max_players),1),e.entry_fee>0?(o(),a("span",Ws," ðŸ«˜ "+l(e.entry_fee),1)):(o(),a("span",Js," å…è²» "))])],8,Vs))),128))]))])):u("",!0),d.value==="join"?(o(),a("div",Hs,[s("div",Qs,[t[30]||(t[30]=s("h3",null,"è¼¸å…¥æˆ¿é–“ç¢¼",-1)),t[31]||(t[31]=s("p",{class:"join-hint"},"å‘å¥½å‹è©¢å• 6 ä½æˆ¿é–“ç¢¼",-1)),s("div",Zs,[Q(s("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>C.value=e),type:"text",maxlength:"6",placeholder:"XXXXXX",class:"code-input",onKeyup:ss(F,["enter"])},null,544),[[Z,C.value]]),s("button",{class:"btn-primary",disabled:f.value||!C.value.trim(),onClick:F},l(f.value?"åŠ å…¥ä¸­...":"åŠ å…¥é¬¥è±†å ´"),9,st)]),p.value?(o(),a("p",tt,l(p.value),1)):u("",!0)])])):u("",!0),d.value==="create"?(o(),a("div",et,[j.value?(o(),a("div",nt,[t[41]||(t[41]=s("h3",null,"å‰µå»ºä½ çš„é¬¥è±†å ´",-1)),t[42]||(t[42]=s("p",{class:"create-hint"}," é‚€è«‹åŒå­¸åŠ å…¥ï¼Œè´å–è±†å­ï¼ ",-1)),s("div",it,[t[36]||(t[36]=s("div",{class:"fee-label"},"å…¥å ´è²»é¸é …",-1)),s("div",rt,[(o(!0),a(R,null,M(r(ls),e=>(o(),a("span",{key:e,class:"fee-tag"},l(e===0?"å…è²»":`${e} è±†`),1))),128))])]),s("div",ut,[t[39]||(t[39]=s("div",{class:"safety-icon"},"ðŸ›¡ï¸",-1)),s("div",dt,[t[38]||(t[38]=s("p",null,"å®‰å…¨æ©Ÿåˆ¶",-1)),s("ul",null,[s("li",null,"æ¯æ—¥å…¥å ´è²»ä¸Šé™ï¼š"+l(r(K).DAILY_FEE_LIMIT)+" è±†",1),s("li",null,"è³¬æˆ¶ä¿ç•™é¤˜é¡ï¼š"+l(r(K).MIN_BALANCE)+" è±†",1),t[37]||(t[37]=s("li",null,"æˆ¿é–“å–æ¶ˆè‡ªå‹•é€€æ¬¾",-1))])])]),s("button",{class:"btn-primary btn-large",onClick:X},[...t[40]||(t[40]=[s("span",{class:"btn-icon"},"âž•",-1),c(" å‰µå»ºé¬¥è±†å ´ ",-1)])])])):(o(),a("div",at,[t[33]||(t[33]=s("div",{class:"unlock-icon"},"ðŸ”’",-1)),t[34]||(t[34]=s("h3",null,"PK ç«¶æŠ€åŠŸèƒ½æœªè§£éŽ–",-1)),s("p",null,[t[32]||(t[32]=c(" é”åˆ° ",-1)),s("strong",null,"Lv."+l(T)),c("ï¼ˆ"+l(r(B)(T).title)+"ï¼‰ å³å¯å‰µå»ºè‡ªå·±çš„é¬¥è±†å ´ ",1)]),s("div",lt,[s("div",{class:"progress-fill",style:E({width:`${Math.min(I.value/T*100,100)}%`})},null,4)]),s("p",ot,"ç•¶å‰ï¼šLv."+l(I.value)+" / Lv."+l(T),1),t[35]||(t[35]=s("p",{class:"unlock-hint"}," ðŸ’¡ ä½ ä»å¯ä»¥é€šéŽæˆ¿é–“ç¢¼åŠ å…¥åŒå­¸çš„é¬¥è±†å ´ï¼Œæˆ–åƒèˆ‡è€å¸«ç™¼èµ·çš„ç­ç´šæ¯”è³½ ",-1))]))])):u("",!0)])]))])):(o(),a("div",bs,[t[12]||(t[12]=s("div",{class:"prompt-icon"},"ðŸ”",-1)),t[13]||(t[13]=s("h2",null,"è«‹å…ˆç™»å…¥",-1)),t[14]||(t[14]=s("p",null,"ç™»å…¥å¾Œå³å¯åƒèˆ‡é¬¥è±†å°æˆ°",-1)),s("button",{class:"btn-primary",onClick:t[0]||(t[0]=(...e)=>r(i).loginWithGoogle&&r(i).loginWithGoogle(...e))}," ä½¿ç”¨ Google ç™»å…¥ ")]))]))}}),ft=es(ct,[["__scopeId","data-v-cdcc45d4"]]);export{ft as default};
