import{B as G,u as H,r as m,c as q,P as r}from"./index-58xMK0we.js";const K=G("class",()=>{const n=H(),i=m([]),E=m(null),v=m([]),h=m([]),y=m([]),u=m(!1),t=m(null),C=/^[a-zA-Z0-9._-]+@student\.isf\.edu\.hk$/i,x=["gnoluy@gmail.com"],k=q(()=>i.value),L=q(()=>i.value.filter(s=>s.is_active));async function M(s,e){if(!r||!n.user)return t.value="請先登入",null;if(!n.isTeacher)return t.value="只有老師可以創建班級",null;u.value=!0,t.value=null;try{const{data:a,error:l}=await r.from("classes").insert({teacher_id:n.user.id,class_name:s,description:e||null}).select().single();return l?(t.value=l.message,null):(i.value.push(a),a)}catch(a){return t.value=a.message,null}finally{u.value=!1}}async function w(){if(!(!r||!n.user)){u.value=!0,t.value=null;try{const{data:s,error:e}=await r.from("classes").select(`
          *,
          member_count:class_members(count)
        `).eq("teacher_id",n.user.id).order("created_at",{ascending:!1});if(e){t.value=e.message;return}i.value=(s||[]).map(a=>({...a,member_count:a.member_count?.[0]?.count||0}))}catch(s){t.value=s.message}finally{u.value=!1}}}async function b(s){if(r){u.value=!0,t.value=null;try{const{data:e,error:a}=await r.from("class_members").select(`
          *,
          student:users!class_members_student_id_fkey (
            id,
            email,
            display_name,
            avatar_url
          )
        `).eq("class_id",s).order("added_at",{ascending:!1});if(a){t.value=a.message;return}v.value=e||[]}catch(e){t.value=e.message}finally{u.value=!1}}}async function P(s,e){if(!r||!n.isTeacher)return t.value="無權限",!1;u.value=!0,t.value=null;try{const{data:a,error:l}=await r.from("users").select("id").eq("email",e).single();if(l||!a)return t.value="找不到該學生，請確認郵箱正確且學生已登入過",!1;const{error:c}=await r.from("class_members").insert({class_id:s,student_id:a.id,added_by:n.user?.id});return c?(c.code==="23505"?t.value="該學生已在班級中":t.value=c.message,!1):(await b(s),!0)}catch(a){return t.value=a.message,!1}finally{u.value=!1}}async function A(s,e){if(!r||!n.isTeacher)return t.value="無權限",!1;u.value=!0,t.value=null;try{const{error:a}=await r.from("class_members").delete().eq("class_id",s).eq("student_id",e);return a?(t.value=a.message,!1):(v.value=v.value.filter(l=>!(l.class_id===s&&l.student_id===e)),!0)}catch(a){return t.value=a.message,!1}finally{u.value=!1}}function $(s){return s?s.split(/[\n,;]/).map(e=>e.trim().toLowerCase()).filter(e=>e!==""):[]}function B(s){const e=[],a=[];return s.forEach(l=>{const c=x.includes(l.toLowerCase());C.test(l)||c?e.push(l):a.push(l)}),{validEmails:e,invalidEmails:a}}async function N(s,e){if(!r||!n.isTeacher||!n.user)throw new Error("無權限");const a=$(e),{validEmails:l,invalidEmails:c}=B(a);if(l.length===0)throw new Error("沒有有效的學生郵箱地址。請使用 @student.isf.edu.hk 格式");const{data:g}=await r.from("class_members").select("student:users!class_members_student_id_fkey(email)").eq("class_id",s),{data:o}=await r.from("pending_students").select("email").eq("class_id",s),d=new Set([...g?.map(f=>f.student?.email).filter(Boolean)||[],...o?.map(f=>f.email)||[]]),p=l.filter(f=>d.has(f)),F=l.filter(f=>!d.has(f));let T=0;for(const f of F)try{const{error:_}=await r.from("pending_students").insert({class_id:s,email:f,added_by:n.user.id});if(_){_.code==="23505"?console.log(`郵箱 ${f} 已在待加入列表中`):console.warn(`添加郵箱 ${f} 失敗:`,_);continue}T++}catch(_){console.warn(`處理郵箱 ${f} 時出錯:`,_)}return{validEmails:l.length,invalidEmails:c.length,duplicates:p.length,added:T,invalidList:c}}async function z(s){if(r)try{const{data:e,error:a}=await r.from("pending_students").select("*").eq("class_id",s).order("added_at",{ascending:!1});if(a){console.error("獲取待激活學生失敗:",a);return}h.value=e||[]}catch(e){console.error("獲取待激活學生失敗:",e)}}async function D(s){if(!r||!n.isTeacher)return t.value="無權限",!1;try{const{error:e}=await r.from("pending_students").delete().eq("id",s);return e?(t.value=e.message,!1):(h.value=h.value.filter(a=>a.id!==s),!0)}catch(e){return t.value=e.message,!1}}function O(s){return Math.max(1,Math.floor(s/100)+1)}async function R(s){if(!(!r||!n.isTeacher)){u.value=!0,t.value=null;try{const{data:e}=await r.from("class_members").select("student_id").eq("class_id",s);if(!e||e.length===0){y.value=[];return}const a=e.map(o=>o.student_id),{data:l}=await r.from("users").select("id, display_name, email, avatar_url").in("id",a),{data:c}=await r.from("user_stats").select("user_id, beans, total_exp, total_practices, correct_count, streak_days, last_practice_at").in("user_id",a),g=(l||[]).map(o=>{const d=c?.find(p=>p.user_id===o.id);return{student_id:o.id,display_name:o.display_name||o.email?.split("@")[0]||"未知",email:o.email||"",avatar_url:o.avatar_url,beans:d?.beans||0,total_exp:d?.total_exp||0,total_practices:d?.total_practices||0,correct_count:d?.correct_count||0,streak_days:d?.streak_days||0,last_practice_at:d?.last_practice_at||null,level:O(d?.total_exp||0)}});y.value=g.sort((o,d)=>d.beans-o.beans)}catch(e){console.error("獲取學生進度失敗:",e),t.value=e.message}finally{u.value=!1}}}async function U(s,e){if(!r||!n.isTeacher)return t.value="無權限",!1;u.value=!0,t.value=null;try{const{error:a}=await r.from("classes").update(e).eq("id",s).eq("teacher_id",n.user?.id);if(a)return t.value=a.message,!1;const l=i.value.findIndex(c=>c.id===s);return l!==-1&&(i.value[l]={...i.value[l],...e}),!0}catch(a){return t.value=a.message,!1}finally{u.value=!1}}async function X(s){if(!r||!n.isTeacher)return t.value="無權限",!1;u.value=!0,t.value=null;try{const{error:e}=await r.from("classes").delete().eq("id",s).eq("teacher_id",n.user?.id);return e?(t.value=e.message,!1):(i.value=i.value.filter(a=>a.id!==s),!0)}catch(e){return t.value=e.message,!1}finally{u.value=!1}}async function S(){if(!(!r||!n.user)){u.value=!0,t.value=null;try{const{data:s,error:e}=await r.from("class_members").select(`
          class:classes (
            id,
            teacher_id,
            class_name,
            description,
            created_at,
            is_active,
            teacher:users!classes_teacher_id_fkey (
              display_name
            )
          )
        `).eq("student_id",n.user.id);if(e){t.value=e.message;return}i.value=(s||[]).map(a=>a.class).filter(a=>a!==null)}catch(s){t.value=s.message}finally{u.value=!1}}}async function Z(){n.isTeacher?await w():await S()}function j(){i.value=[],E.value=null,v.value=[],t.value=null}return{classes:i,currentClass:E,classMembers:v,pendingStudents:h,studentProgress:y,loading:u,error:t,myClasses:k,activeClasses:L,createClass:M,fetchMyClasses:w,fetchClassMembers:b,addStudentByEmail:P,removeStudent:A,updateClass:U,deleteClass:X,batchAddStudents:N,fetchPendingStudents:z,removePendingStudent:D,fetchStudentProgress:R,fetchStudentClasses:S,fetchClasses:Z,reset:j}});export{K as u};
