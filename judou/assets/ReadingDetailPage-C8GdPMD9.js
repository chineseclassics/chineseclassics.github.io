import{d as ke,u as me,m as D,A as _e,r as C,o as xe,Q,R as we,w as ye,c as f,a as s,f as _,s as W,t as v,j as k,n as R,y as be,F,q as G,i as J,g as Ce,p as Se,K as Te,k as Be,l,_ as Pe}from"./index-D7toxtgx.js";import{u as Re}from"./readingStore-DDFYsQak.js";import{c as ee}from"./createLucideIcon-Bj0aCaIA.js";const Ae=ee("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);const Me=ee("volume-2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]),Ee={為業:"維業",為人:"維人",以為:"以維",成為:"成維",作為:"作維",為官:"維官",為師:"維師",為學:"維學",得:"德",地:"帝"};function te(x){let m=x;for(const[w,N]of Object.entries(Ee))m.includes(w)&&(m=m.split(w).join(N));return m}async function Le(x,m={}){const w=te(x);return typeof window<"u"&&window.taixuSpeak?await window.taixuSpeak(w,m):(console.warn("taixuSpeak 不可用"),!1)}async function Z(x,m={}){const w=te(x);return typeof window<"u"&&window.taixuPreload?await window.taixuPreload(w,m):!1}function Ie(){typeof window<"u"&&window.taixuStopSpeak&&window.taixuStopSpeak()}const ze={class:"reading-detail-page"},Oe={class:"reading-header edamame-glass"},Ne={key:1,class:"back-btn-placeholder"},je={class:"header-title"},qe={class:"title-meta"},De={key:0,class:"author"},Fe={key:1,class:"source-tag"},$e={class:"header-actions"},Ve={class:"control-bar edamame-glass"},Ue=["aria-pressed"],Xe={class:"toggle-switch"},He={key:0,class:"reading-content edamame-glass"},Ye={class:"reading-line"},Ke=["data-global-index","onMouseenter","onClick","onTouchend"],Qe=["onClick","disabled"],We={key:0,class:"verification-result"},Ge={class:"result-stats"},Je={class:"stat correct"},Ze={class:"stat missed"},et={class:"stat extra"},tt={class:"stat accuracy"},nt={class:"content-actions"},at=["disabled"],st={key:1,class:"loading-state edamame-glass"},ot={class:"tooltip-term"},rt={key:0,class:"tooltip-pinyin"},it={class:"tooltip-content"},lt=ke({__name:"ReadingDetailPage",props:{hideBackButton:{type:Boolean,default:!1},textIdProp:{default:void 0}},setup(x){const m=x,w=_e(),N=Be(),i=Re(),$=me(),L=D(()=>m.textIdProp||w.params.id),g=C(!0),T=C(new Set),u=C(null),p=C(null),S=C(!1),A=D(()=>{if(!i.currentText)return{paragraphs:[],allChars:[],allBreaks:new Set};const t=i.currentText.content,e=t.includes("||")?"||":/\n\n+/,n=t.split(e),c=[],d=[],a=new Set;let r=0;for(const o of n){const h=[],b=new Set,K=r,O=o.replace(/[\|\s]+$/,"");for(const E of O)E==="|"?r>0&&(a.add(r-1),b.add(h.length-1)):E!==`
`&&E!=="\r"&&(d.push(E),h.push(E),r++);h.length>0&&c.push({chars:h,breaks:b,startIdx:K,endIdx:r-1})}return{paragraphs:c,allChars:d,allBreaks:a}}),V=D(()=>A.value.paragraphs),ne=C(0);function B(t){return i.currentText?.annotations&&i.currentText.annotations.find(e=>t>=e.start_index&&t<e.end_index)||null}const P=C(null),y=C(!1);function ae(t){return P.value?B(t)?.id===P.value:!1}function se(t){return B(t)?.start_index===t}function oe(t){const e=B(t);return e?e.end_index-1===t:!1}function re(t,e){if(y.value)return;const n=B(t);n&&(P.value=n.id,X(n,e))}function ie(){y.value||(P.value=null,I())}function U(t,e){const n=B(t);if(n){if(e.stopPropagation(),p.value&&p.value.annotation.id===n.id){I();return}P.value=n.id,Q(()=>{const c=document.querySelector(`.char[data-global-index="${n.start_index}"]`),d=document.querySelector(`.char[data-global-index="${n.end_index-1}"]`);let a=0,r=0;if(c&&d){const o=c.getBoundingClientRect(),h=d.getBoundingClientRect();a=(o.left+h.right)/2,r=o.top}else if(c){const o=c.getBoundingClientRect();a=o.left+o.width/2,r=o.top}else{const o=e.target;if(o){const h=o.getBoundingClientRect();a=h.left+h.width/2,r=h.top}}X(n,{clientX:a,clientY:r})})}}function le(t){if(g.value)return;const e=new Set(T.value);e.has(t)?e.delete(t):e.add(t),T.value=e,u.value=null}function ce(){const{allBreaks:t,allChars:e}=A.value;if(!e.length)return;const n=[],c=[],d=[];for(let o=0;o<e.length;o++){const h=t.has(o),b=T.value.has(o);h&&b?n.push(o):h&&!b?c.push(o):!h&&b&&d.push(o)}const a=t.size,r=a>0?n.length/a:1;u.value={correct:n,missed:c,extra:d,accuracy:r}}function ue(){g.value=!0,u.value=null}function de(){T.value=new Set,u.value=null}function X(t,e){p.value={annotation:t,x:e.clientX,y:e.clientY}}function I(){P.value=null,p.value=null}function z(t){if(!y.value||!p.value)return;const e=t.target;!e.closest(".char.has-annotation")&&!e.closest(".annotation-tooltip")&&I()}function H(){const{allChars:t,allBreaks:e,paragraphs:n}=A.value;if(!t.length)return[];const c=[];for(const d of n){let a="",r=d.startIdx-1;for(let o=d.startIdx;o<=d.endIdx;o++){const h=o-d.startIdx;a+=d.chars[h];const b=e.has(o);if(o===d.endIdx)a+="。";else if(b){const O=o-r;r=o,O>=8?a+="。":O>=4?a+="，":a+="、"}}a.trim()&&c.push(a)}return c}let M=!1;function Y(){M=!0,Ie(),S.value=!1}const j={voice:"zh-CN-XiaoxiaoNeural",rate:.75};async function fe(){if(!A.value.allChars.length)return;if(S.value){Y();return}S.value=!0,M=!1;const t=H();try{for(let e=0;e<t.length&&!M;e++){const n=t[e+1];n&&Z(n,j);const c=t[e];c&&await Le(c,j)}}catch(e){console.error("TTS 播放失敗:",e),M||alert("語音朗讀失敗，請稍後再試")}finally{S.value=!1,M=!1}}async function he(){if(!$.isAuthenticated){alert("請先登入以使用書籤功能");return}await i.toggleBookmark(L.value)}function ve(){N.push({name:"reading-list"})}function pe(t){const e=[],{allBreaks:n}=A.value;return g.value?n.has(t)&&e.push("has-break","correct"):T.value.has(t)?(e.push("has-break","user-marked"),u.value&&(u.value.correct.includes(t)?e.push("verified-correct"):u.value.extra.includes(t)&&e.push("verified-extra"))):u.value?.missed.includes(t)&&e.push("has-break","verified-missed"),e}function q(){y.value=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window||navigator.maxTouchPoints>0}xe(async()=>{q(),window.addEventListener("resize",q),y.value&&(document.addEventListener("click",z),document.addEventListener("touchend",z)),await i.fetchTextDetail(L.value),i.startReadingTracking(),i.currentText?.progress&&(ne.value=i.currentText.progress.last_paragraph),await Q();const e=H()[0];e&&Z(e,j)});function ge(){return u.value?Math.round(u.value.accuracy*100):g.value?50:0}return we(()=>{if(Y(),window.removeEventListener("resize",q),y.value&&(document.removeEventListener("click",z),document.removeEventListener("touchend",z)),L.value&&$.isAuthenticated){const t=ge(),e=u.value?.accuracy===1;i.saveReadingRecord(L.value,t,e)}}),ye(g,t=>{t&&(u.value=null)}),(t,e)=>(l(),f("div",ze,[s("header",Oe,[x.hideBackButton?(l(),f("div",Ne)):(l(),f("button",{key:0,class:"back-btn",onClick:ve}," ← 返回 ")),s("div",je,[s("h1",null,v(k(i).currentText?.title||"載入中..."),1),s("div",qe,[k(i).currentText?.author?(l(),f("span",De,v(k(i).currentText.author),1)):_("",!0),k(i).currentText?.source_text?.title?(l(),f("span",Fe," · 選自《"+v(k(i).currentText.source_text.title)+"》 ",1)):_("",!0)])]),s("div",$e,[s("button",{class:R(["action-btn bookmark-btn",{active:k(i).currentText?.progress?.bookmarked}]),onClick:he,title:"收藏"},v(k(i).currentText?.progress?.bookmarked?"⭐":"☆"),3)])]),s("section",Ve,[s("button",{class:"punctuation-toggle",onClick:e[0]||(e[0]=n=>g.value=!g.value),"aria-pressed":g.value,type:"button"},[e[3]||(e[3]=s("span",{class:"toggle-label"},"顯示斷句",-1)),s("span",Xe,[s("span",{class:R(["toggle-track",{active:g.value}])},[...e[2]||(e[2]=[s("span",{class:"toggle-thumb"},null,-1)])],2)])],8,Ue),s("button",{class:R(["tts-btn",{playing:S.value}]),onClick:fe},[(l(),W(be(S.value?k(Ae):k(Me)),{size:18,"stroke-width":1.5})),s("span",null,v(S.value?" 停止朗讀":" 朗讀全文"),1)],2)]),k(i).currentText&&V.value.length>0?(l(),f("section",He,[(l(!0),f(F,null,G(V.value,(n,c)=>(l(),f("div",{key:c,class:"paragraph-block"},[s("div",Ye,[(l(!0),f(F,null,G(n.chars,(d,a)=>(l(),f("span",{key:a,class:"char-unit"},[s("span",{class:R(["char",{"has-annotation":B(n.startIdx+a),"annotation-hovered":ae(n.startIdx+a),"annotation-start":se(n.startIdx+a),"annotation-end":oe(n.startIdx+a)}]),"data-global-index":n.startIdx+a,onMouseenter:r=>re(n.startIdx+a,r),onMouseleave:ie,onClick:r=>U(n.startIdx+a,r),onTouchend:r=>U(n.startIdx+a,r)},v(d),43,Ke),a<n.chars.length-1?(l(),f("button",{key:0,class:R(["break-slot",pe(n.startIdx+a)]),onClick:r=>le(n.startIdx+a),disabled:g.value},[...e[4]||(e[4]=[s("span",{class:"break-marker"},null,-1)])],10,Qe)):_("",!0)]))),128))])]))),128)),u.value?(l(),f("div",We,[s("div",Ge,[s("span",Je,"✓ 正確："+v(u.value.correct.length),1),s("span",Ze,"○ 遺漏："+v(u.value.missed.length),1),s("span",et,"✗ 多餘："+v(u.value.extra.length),1),s("span",tt," 正確率："+v(Math.round(u.value.accuracy*100))+"% ",1)]),s("button",{class:"show-answer-btn",onClick:ue}," 查看正確答案 ")])):_("",!0),s("div",nt,[g.value?_("",!0):(l(),f(F,{key:0},[s("button",{class:"edamame-btn edamame-btn-secondary",onClick:de}," 重置 "),s("button",{class:"edamame-btn edamame-btn-primary",onClick:ce,disabled:T.value.size===0}," ✓ 驗證我的斷句 ",8,at)],64))])])):k(i).isLoading?(l(),f("section",st,[...e[5]||(e[5]=[s("span",{class:"loading-spinner"},null,-1),J(" 載入中... ",-1)])])):_("",!0),(l(),W(Te,{to:"body"},[p.value?(l(),f("div",{key:0,class:R(["annotation-tooltip",{"mobile-tooltip":y.value}]),style:Se({left:p.value.x+"px",top:p.value.y+16+"px"}),onClick:e[1]||(e[1]=Ce(()=>{},["stop"]))},[y.value?(l(),f("button",{key:0,class:"tooltip-close-btn",onClick:I,"aria-label":"關閉註釋"}," ✕ ")):_("",!0),s("div",ot,[J(v(p.value.annotation.term)+" ",1),p.value.annotation.pinyin?(l(),f("span",rt,"（"+v(p.value.annotation.pinyin)+"）",1)):_("",!0)]),s("div",it,v(p.value.annotation.annotation),1)],6)):_("",!0)]))]))}}),ct=Pe(lt,[["__scopeId","data-v-e2dee7a1"]]),ht=Object.freeze(Object.defineProperty({__proto__:null,default:ct},Symbol.toStringTag,{value:"Module"}));export{ct as R,Ae as S,Me as V,Z as a,Le as b,Ie as c,ht as d};
