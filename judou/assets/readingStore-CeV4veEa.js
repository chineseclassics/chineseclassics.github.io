import{y as $,u as F,r as p,c as L}from"./index-1aPAotcY.js";import{u as j}from"./useSupabase-C72HxeaJ.js";const H=$("reading",()=>{const o=j(),n=F(),u=p([]),c=p(null),l=p([]),g=p(!1),f=p(null),h=L(()=>u.value.filter(e=>e.progress?.bookmarked));async function m(){if(!o){f.value="Supabase å°šæœªé…ç½®";return}g.value=!0,f.value=null;try{const{data:e,error:t}=await o.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("text_type","reading").order("created_at",{ascending:!1});if(t)throw t;let i=new Map;if(n.isAuthenticated&&n.user?.id){const{data:r}=await o.from("reading_progress").select("*").eq("user_id",n.user.id);r&&r.forEach(a=>{i.set(a.text_id,a)})}u.value=(e||[]).map(r=>{const a=r.text_reading_categories?.map(s=>s.category).filter(Boolean)||[];return{...r,reading_categories:a,text_reading_categories:void 0,progress:i.get(r.id)||null}})}catch(e){f.value=e.message??"ç„¡æ³•è¼‰å…¥é–±è®€æ–‡ç« "}finally{g.value=!1}}async function v(e){if(!o)return f.value="Supabase å°šæœªé…ç½®",null;g.value=!0,f.value=null;try{const{data:t,error:i}=await o.from("practice_texts").select(`
          *,
          text_reading_categories (
            category:reading_categories (
              id,
              name,
              description,
              order_index
            )
          ),
          source_text:practice_texts!source_text_id (
            id,
            title
          )
        `).eq("id",e).single();if(i)throw i;const{data:r}=await o.from("text_annotations").select("*").eq("text_id",e).order("start_index",{ascending:!0});let a=null;if(n.isAuthenticated&&n.user?.id){const{data:d}=await o.from("reading_progress").select("*").eq("text_id",e).eq("user_id",n.user.id).maybeSingle();a=d||null}const s=t.text_reading_categories?.map(d=>d.category).filter(Boolean)||[];return c.value={...t,reading_categories:s,text_reading_categories:void 0,annotations:r||[],progress:a},c.value}catch(t){return f.value=t.message??"ç„¡æ³•è¼‰å…¥æ–‡ç« è©³æƒ…",null}finally{g.value=!1}}async function y(e,t,i){if(!(!o||!n.isAuthenticated||!n.user?.id))try{const{data:r,error:a}=await o.from("reading_progress").upsert({user_id:n.user.id,text_id:e,progress_percent:t,last_paragraph:i,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(a)throw a;c.value?.id===e&&(c.value.progress=r);const s=u.value.findIndex(_=>_.id===e),d=u.value[s];s!==-1&&r&&d&&(d.progress=r)}catch(r){console.error("æ›´æ–°é–±è®€é€²åº¦å¤±æ•—:",r)}}async function E(e){if(!o||!n.isAuthenticated||!n.user?.id)return;const i=(u.value.find(r=>r.id===e)||c.value)?.progress?.bookmarked??!1;try{const{data:r,error:a}=await o.from("reading_progress").upsert({user_id:n.user.id,text_id:e,bookmarked:!i,updated_at:new Date().toISOString()},{onConflict:"user_id,text_id"}).select().single();if(a)throw a;c.value?.id===e&&(c.value.progress=r);const s=u.value.findIndex(_=>_.id===e),d=u.value[s];return s!==-1&&r&&d&&(d.progress=r),r?.bookmarked}catch(r){return console.error("åˆ‡æ›æ›¸ç±¤å¤±æ•—:",r),null}}async function S(e){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");if(!n.isTeacher&&!n.isAdmin)throw new Error("åªæœ‰è€å¸«æˆ–ç®¡ç†å“¡å¯ä»¥æ·»åŠ è¨»é‡‹");const{data:t,error:i}=await o.from("text_annotations").insert({...e,created_by:n.user.id}).select().single();if(i)throw i;return c.value?.id===e.text_id&&t&&(c.value.annotations=[...c.value.annotations||[],t].sort((r,a)=>r.start_index-a.start_index)),t}async function b(e,t){if(!o)throw new Error("Supabase å°šæœªé…ç½®");const{data:i,error:r}=await o.from("text_annotations").update({annotation:t}).eq("id",e).select().single();if(r)throw r;if(c.value?.annotations){const a=c.value.annotations.findIndex(s=>s.id===e);a!==-1&&(c.value.annotations[a]=i)}return i}async function k(e){if(!o)throw new Error("Supabase å°šæœªé…ç½®");const{error:t}=await o.from("text_annotations").delete().eq("id",e);if(t)throw t;c.value?.annotations&&(c.value.annotations=c.value.annotations.filter(i=>i.id!==e))}async function A(e,t=!1){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");const{data:i,error:r}=await o.from("practice_texts").insert({title:e.title,author:e.author??null,source:e.source??null,summary:e.summary??null,category_id:e.category_id||null,content:e.content,text_type:"reading",source_text_id:e.source_text_id||null,source_start_index:e.source_start_index??null,source_end_index:e.source_end_index??null,is_system:t,created_by:t?null:n.user.id}).select("*").single();if(r)throw r;const a=e.reading_category_ids||[];if(i&&a.length>0){const{error:d}=await o.from("text_reading_categories").insert(a.map(_=>({text_id:i.id,category_id:_})));d&&console.error("é—œè¯æ–‡é›†å¤±æ•—:",d)}const s=a.length>0?l.value.filter(d=>a.includes(d.id)):[];return i&&u.value.unshift({...i,reading_categories:s,progress:null,annotations:[]}),i}async function q(e,t,i,r,a){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.user)throw new Error("è«‹å…ˆç™»å…¥");const s=u.value.find(U=>U.id===e)||c.value,{data:d,error:_}=await o.from("practice_texts").insert({title:a.title,author:s?.author??null,source:s?.source??null,category_id:a.category_id||null,content:r,difficulty:a.difficulty||2,text_type:"practice",source_text_id:e,source_start_index:t,source_end_index:i,is_system:!0,created_by:null}).select().single();if(_)throw _;return d}function D(){c.value=null}let w=null;function T(){w=Date.now()}async function x(e,t=0,i=!1){if(!o||!n.isAuthenticated||!n.user?.id)return;const r=w?Math.floor((Date.now()-w)/1e3):0;if(w=null,!(r<3))try{const{error:a}=await o.from("reading_records").upsert({user_id:n.user.id,text_id:e,progress:Math.max(t,0),is_completed:i,read_duration:r,read_count:1,last_read_at:new Date().toISOString()},{onConflict:"user_id,text_id",ignoreDuplicates:!1});if(a){if(a.code==="42P01"){console.log("é–±è®€è¨˜éŒ„è¡¨å°šæœªå‰µå»º");return}const{error:s}=await o.rpc("update_reading_record",{p_user_id:n.user.id,p_text_id:e,p_duration:r,p_progress:t,p_completed:i});if(s){const{data:d}=await o.from("reading_records").select("id, read_duration, read_count, progress, is_completed").eq("user_id",n.user.id).eq("text_id",e).maybeSingle();d&&await o.from("reading_records").update({read_duration:d.read_duration+r,read_count:d.read_count+1,progress:Math.max(d.progress,t),is_completed:d.is_completed||i,last_read_at:new Date().toISOString(),completed_at:i&&!d.is_completed?new Date().toISOString():void 0}).eq("id",d.id)}}console.log(`ðŸ“– è¨˜éŒ„é–±è®€ï¼š${r} ç§’ï¼Œé€²åº¦ ${t}%`)}catch(a){console.error("ä¿å­˜é–±è®€è¨˜éŒ„å¤±æ•—:",a)}}async function C(e){await x(e,100,!0)}async function R(e,t){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°æ–‡é›†");const{error:i}=await o.from("text_reading_categories").delete().eq("text_id",e);if(i)throw i;if(t.length>0){const{error:s}=await o.from("text_reading_categories").insert(t.map(d=>({text_id:e,category_id:d})));if(s)throw s}const r=l.value.filter(s=>t.includes(s.id));c.value?.id===e&&(c.value.reading_categories=r);const a=u.value.findIndex(s=>s.id===e);a!==-1&&u.value[a]&&(u.value[a].reading_categories=r)}async function O(){if(o)try{const{data:e,error:t}=await o.from("reading_categories").select("*").order("order_index",{ascending:!0});if(t)throw t;l.value=e||[]}catch(e){console.error("ç²å–é–±è®€åˆ†é¡žå¤±æ•—:",e)}}async function M(e,t){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥å‰µå»ºåˆ†é¡ž");const i=l.value.reduce((s,d)=>Math.max(s,d.order_index),0),{data:r,error:a}=await o.from("reading_categories").insert({name:e,description:t||null,order_index:i+1,created_by:n.user?.id}).select().single();if(a)throw a;return r&&l.value.push(r),r}async function B(e,t){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥æ›´æ–°åˆ†é¡ž");const{data:i,error:r}=await o.from("reading_categories").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;const a=l.value.findIndex(s=>s.id===e);return a!==-1&&i&&(l.value[a]=i),i}async function P(e){if(!o)throw new Error("Supabase å°šæœªé…ç½®");if(!n.isAdmin)throw new Error("åªæœ‰ç®¡ç†å“¡å¯ä»¥åˆªé™¤åˆ†é¡ž");const{error:t}=await o.from("reading_categories").delete().eq("id",e);if(t)throw t;l.value=l.value.filter(i=>i.id!==e)}return{readingTexts:u,currentText:c,readingCategories:l,bookmarkedTexts:h,isLoading:g,error:f,fetchReadingTexts:m,fetchTextDetail:v,createReadingText:A,extractPracticeFragment:q,clearCurrentText:D,updateProgress:y,toggleBookmark:E,startReadingTracking:T,saveReadingRecord:x,markAsCompleted:C,addAnnotation:S,updateAnnotation:b,deleteAnnotation:k,fetchReadingCategories:O,createReadingCategory:M,updateReadingCategory:B,deleteReadingCategory:P,updateTextCategories:R}});export{H as u};
