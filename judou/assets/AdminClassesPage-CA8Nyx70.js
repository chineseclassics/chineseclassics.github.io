import{q as I,u as K,r as v,c as H,H as i,d as ee,s as se,v as te,a as o,e as k,F as D,b as a,f as N,t as c,z as R,A as j,h as J,G as ae,y as G,n as le,o as d,_ as ne}from"./index-CdEzt6GW.js";const ie=I("class",()=>{const r=K(),f=v([]),m=v(null),y=v([]),C=v([]),u=v(!1),l=v(null),P=/^[a-zA-Z0-9._-]+@student\.isf\.edu\.hk$/i,A=H(()=>f.value),_=H(()=>f.value.filter(t=>t.is_active));async function E(t,e){if(!i||!r.user)return l.value="è«‹å…ˆç™»å…¥",null;if(!r.isTeacher)return l.value="åªæœ‰è€å¸«å¯ä»¥å‰µå»ºç­ç´š",null;u.value=!0,l.value=null;try{const{data:s,error:n}=await i.from("classes").insert({teacher_id:r.user.id,class_name:t,description:e||null}).select().single();return n?(l.value=n.message,null):(f.value.push(s),s)}catch(s){return l.value=s.message,null}finally{u.value=!1}}async function g(){if(!(!i||!r.user)){u.value=!0,l.value=null;try{const{data:t,error:e}=await i.from("classes").select(`
          *,
          member_count:class_members(count)
        `).eq("teacher_id",r.user.id).order("created_at",{ascending:!1});if(e){l.value=e.message;return}f.value=(t||[]).map(s=>({...s,member_count:s.member_count?.[0]?.count||0}))}catch(t){l.value=t.message}finally{u.value=!1}}}async function S(t){if(i){u.value=!0,l.value=null;try{const{data:e,error:s}=await i.from("class_members").select(`
          *,
          student:users!class_members_student_id_fkey (
            id,
            email,
            display_name,
            avatar_url
          )
        `).eq("class_id",t).order("added_at",{ascending:!1});if(s){l.value=s.message;return}y.value=e||[]}catch(e){l.value=e.message}finally{u.value=!1}}}async function x(t,e){if(!i||!r.isTeacher)return l.value="ç„¡æ¬Šé™",!1;u.value=!0,l.value=null;try{const{data:s,error:n}=await i.from("users").select("id").eq("email",e).single();if(n||!s)return l.value="æ‰¾ä¸åˆ°è©²å­¸ç”Ÿï¼Œè«‹ç¢ºèªéƒµç®±æ­£ç¢ºä¸”å­¸ç”Ÿå·²ç™»å…¥éŽ",!1;const{error:w}=await i.from("class_members").insert({class_id:t,student_id:s.id,added_by:r.user?.id});return w?(w.code==="23505"?l.value="è©²å­¸ç”Ÿå·²åœ¨ç­ç´šä¸­":l.value=w.message,!1):(await S(t),!0)}catch(s){return l.value=s.message,!1}finally{u.value=!1}}async function T(t,e){if(!i||!r.isTeacher)return l.value="ç„¡æ¬Šé™",!1;u.value=!0,l.value=null;try{const{error:s}=await i.from("class_members").delete().eq("class_id",t).eq("student_id",e);return s?(l.value=s.message,!1):(y.value=y.value.filter(n=>!(n.class_id===t&&n.student_id===e)),!0)}catch(s){return l.value=s.message,!1}finally{u.value=!1}}function b(t){return t?t.split(/[\n,;]/).map(e=>e.trim().toLowerCase()).filter(e=>e!==""):[]}function M(t){const e=[],s=[];return t.forEach(n=>{P.test(n)?e.push(n):s.push(n)}),{validEmails:e,invalidEmails:s}}async function h(t,e){if(!i||!r.isTeacher||!r.user)throw new Error("ç„¡æ¬Šé™");const s=b(e),{validEmails:n,invalidEmails:w}=M(s);if(n.length===0)throw new Error("æ²’æœ‰æœ‰æ•ˆçš„å­¸ç”Ÿéƒµç®±åœ°å€ã€‚è«‹ä½¿ç”¨ @student.isf.edu.hk æ ¼å¼");const{data:O}=await i.from("class_members").select("student:users!class_members_student_id_fkey(email)").eq("class_id",t),{data:Q}=await i.from("pending_students").select("email").eq("class_id",t),W=new Set([...O?.map(p=>p.student?.email).filter(Boolean)||[],...Q?.map(p=>p.email)||[]]),X=n.filter(p=>W.has(p)),Y=n.filter(p=>!W.has(p));let Z=0;for(const p of Y)try{const{error:$}=await i.from("pending_students").insert({class_id:t,email:p,added_by:r.user.id});if($){$.code==="23505"?console.log(`éƒµç®± ${p} å·²åœ¨å¾…åŠ å…¥åˆ—è¡¨ä¸­`):console.warn(`æ·»åŠ éƒµç®± ${p} å¤±æ•—:`,$);continue}Z++}catch($){console.warn(`è™•ç†éƒµç®± ${p} æ™‚å‡ºéŒ¯:`,$)}return{validEmails:n.length,invalidEmails:w.length,duplicates:X.length,added:Z,invalidList:w}}async function q(t){if(i)try{const{data:e,error:s}=await i.from("pending_students").select("*").eq("class_id",t).order("added_at",{ascending:!1});if(s){console.error("ç²å–å¾…æ¿€æ´»å­¸ç”Ÿå¤±æ•—:",s);return}C.value=e||[]}catch(e){console.error("ç²å–å¾…æ¿€æ´»å­¸ç”Ÿå¤±æ•—:",e)}}async function V(t){if(!i||!r.isTeacher)return l.value="ç„¡æ¬Šé™",!1;try{const{error:e}=await i.from("pending_students").delete().eq("id",t);return e?(l.value=e.message,!1):(C.value=C.value.filter(s=>s.id!==t),!0)}catch(e){return l.value=e.message,!1}}async function B(t,e){if(!i||!r.isTeacher)return l.value="ç„¡æ¬Šé™",!1;u.value=!0,l.value=null;try{const{error:s}=await i.from("classes").update(e).eq("id",t).eq("teacher_id",r.user?.id);if(s)return l.value=s.message,!1;const n=f.value.findIndex(w=>w.id===t);return n!==-1&&(f.value[n]={...f.value[n],...e}),!0}catch(s){return l.value=s.message,!1}finally{u.value=!1}}async function U(t){if(!i||!r.isTeacher)return l.value="ç„¡æ¬Šé™",!1;u.value=!0,l.value=null;try{const{error:e}=await i.from("classes").delete().eq("id",t).eq("teacher_id",r.user?.id);return e?(l.value=e.message,!1):(f.value=f.value.filter(s=>s.id!==t),!0)}catch(e){return l.value=e.message,!1}finally{u.value=!1}}async function L(){if(!(!i||!r.user)){u.value=!0,l.value=null;try{const{data:t,error:e}=await i.from("class_members").select(`
          class:classes (
            id,
            class_name,
            description,
            created_at,
            is_active,
            teacher:users!classes_teacher_id_fkey (
              display_name
            )
          )
        `).eq("student_id",r.user.id);if(e){l.value=e.message;return}f.value=(t||[]).map(s=>s.class).filter(s=>s!==null)}catch(t){l.value=t.message}finally{u.value=!1}}}async function z(){r.isTeacher?await g():await L()}function F(){f.value=[],m.value=null,y.value=[],l.value=null}return{classes:f,currentClass:m,classMembers:y,pendingStudents:C,loading:u,error:l,myClasses:A,activeClasses:_,createClass:E,fetchMyClasses:g,fetchClassMembers:S,addStudentByEmail:x,removeStudent:T,updateClass:B,deleteClass:U,batchAddStudents:h,fetchPendingStudents:q,removePendingStudent:V,fetchStudentClasses:L,fetchClasses:z,reset:F}}),re={class:"admin-classes-container"},ue={class:"page-header"},oe={key:0,class:"error-message"},de={key:1,class:"create-form edamame-glass"},ce={class:"form-group"},ve={class:"form-group"},fe={class:"form-actions"},me=["disabled"],_e={key:2,class:"loading"},he={key:3,class:"classes-grid"},pe={class:"class-header"},ge={class:"class-name"},ye={class:"member-count"},be={key:0,class:"class-desc"},we={class:"class-footer"},ke={class:"class-date"},Ce={class:"class-actions"},Ee=["onClick"],Se=["onClick"],Te={key:4,class:"empty-state edamame-glass"},Ae={class:"page-header"},xe={class:"header-with-back"},Me={class:"page-title"},qe={class:"page-subtitle"},$e={class:"members-section"},Ne={class:"section-header"},Pe={key:0,class:"empty-members edamame-glass"},Le={key:1,class:"members-list"},De={class:"member-info"},Ve={class:"member-avatar"},Be={class:"member-details"},Ue={class:"member-name"},ze={class:"member-email"},Fe={class:"member-status-actions"},Re=["onClick"],je={class:"modal-content edamame-glass"},Ge={key:0,class:"add-result"},He={class:"result-success"},We={key:0,class:"result-warning"},Ze={key:1,class:"result-error"},Je={class:"invalid-list"},Ke={class:"modal-actions"},Oe=["disabled"],Qe=ee({__name:"AdminClassesPage",setup(r){const f=K(),m=ie(),{classes:y,classMembers:C,pendingStudents:u,loading:l,error:P}=se(m),A=v("list"),_=v(null),E=v(!1),g=v(""),S=v(""),x=v(!1),T=v(!1),b=v(""),M=v(!1),h=v(null),q=H(()=>{const t=C.value.map(s=>({id:s.id,email:s.student?.email||"æœªçŸ¥",displayName:s.student?.display_name||"æœªçŸ¥",status:"active",addedAt:s.added_at})),e=u.value.map(s=>({id:s.id,email:s.email,displayName:s.email.split("@")[0],status:"pending",addedAt:s.added_at}));return[...t,...e].sort((s,n)=>new Date(n.addedAt).getTime()-new Date(s.addedAt).getTime())});async function V(){if(g.value.trim()){x.value=!0;try{await m.createClass(g.value.trim(),S.value.trim()),g.value="",S.value="",E.value=!1}catch(t){console.error("å‰µå»ºç­ç´šå¤±æ•—:",t)}finally{x.value=!1}}}async function B(t){confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­ç´šå—Žï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚")&&await m.deleteClass(t)}async function U(t){_.value=t,A.value="detail",await Promise.all([m.fetchClassMembers(t.id),m.fetchPendingStudents(t.id)])}function L(){A.value="list",_.value=null}async function z(){if(!(!_.value||!b.value.trim())){M.value=!0,h.value=null;try{const t=await m.batchAddStudents(_.value.id,b.value);h.value=t,await m.fetchPendingStudents(_.value.id),t.invalidEmails===0&&(b.value="")}catch(t){console.error("æ‰¹é‡æ·»åŠ å¤±æ•—:",t)}finally{M.value=!1}}}async function F(t){if(!_.value)return;const e=t.status==="pending"?"ç¢ºå®šè¦ç§»é™¤é€™å€‹å¾…æ¿€æ´»çš„å­¸ç”Ÿå—Žï¼Ÿ":"ç¢ºå®šè¦å°‡æ­¤å­¸ç”Ÿå¾žç­ç´šä¸­ç§»é™¤å—Žï¼Ÿ";if(confirm(e))if(t.status==="pending")await m.removePendingStudent(t.id);else{const s=C.value.find(n=>n.id===t.id);s&&await m.removeStudent(_.value.id,s.student_id)}}return te(()=>{f.isAuthenticated&&m.fetchMyClasses()}),(t,e)=>(d(),o("main",re,[A.value==="list"?(d(),o(D,{key:0},[a("header",ue,[e[10]||(e[10]=a("div",null,[a("h1",{class:"page-title"},"ç­ç´šç®¡ç†"),a("p",{class:"page-subtitle"},"å‰µå»ºå’Œç®¡ç†ä½ çš„ç­ç´š")],-1)),a("button",{class:"create-btn",onClick:e[0]||(e[0]=s=>E.value=!0)}," + æ–°å»ºç­ç´š ")]),N(P)?(d(),o("div",oe,c(N(P)),1)):k("",!0),E.value?(d(),o("section",de,[e[13]||(e[13]=a("h2",null,"æ–°å»ºç­ç´š",-1)),a("div",ce,[e[11]||(e[11]=a("label",null,"ç­ç´šåç¨± *",-1)),R(a("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>g.value=s),type:"text",placeholder:"ä¾‹å¦‚ï¼šä¸ƒå¹´ç´šAç­",class:"form-input"},null,512),[[j,g.value]])]),a("div",ve,[e[12]||(e[12]=a("label",null,"ç­ç´šæè¿°",-1)),R(a("textarea",{"onUpdate:modelValue":e[2]||(e[2]=s=>S.value=s),placeholder:"é¸å¡«ï¼Œç°¡å–®æè¿°é€™å€‹ç­ç´š",class:"form-textarea",rows:"2"},null,512),[[j,S.value]])]),a("div",fe,[a("button",{class:"cancel-btn",onClick:e[3]||(e[3]=s=>E.value=!1)},"å–æ¶ˆ"),a("button",{class:"submit-btn",onClick:V,disabled:!g.value.trim()||x.value},c(x.value?"å‰µå»ºä¸­...":"å‰µå»ºç­ç´š"),9,me)])])):k("",!0),N(l)?(d(),o("div",_e," è¼‰å…¥ä¸­... ")):N(y).length>0?(d(),o("section",he,[(d(!0),o(D,null,J(N(y),s=>(d(),o("article",{key:s.id,class:"class-card edamame-glass"},[a("div",pe,[a("h3",ge,c(s.class_name),1),a("span",ye,c(s.member_count||0)+" åå­¸ç”Ÿ",1)]),s.description?(d(),o("p",be,c(s.description),1)):k("",!0),a("div",we,[a("span",ke," å‰µå»ºæ–¼ "+c(new Date(s.created_at).toLocaleDateString("zh-TW")),1),a("div",Ce,[a("button",{class:"action-btn view-btn",onClick:n=>U(s)},"ç®¡ç†æˆå“¡",8,Ee),a("button",{class:"action-btn delete-btn",onClick:n=>B(s.id)},"åˆªé™¤",8,Se)])])]))),128))])):(d(),o("section",Te,[e[14]||(e[14]=a("div",{class:"empty-icon"},"ðŸ“š",-1)),e[15]||(e[15]=a("h2",null,"é‚„æ²’æœ‰ç­ç´š",-1)),e[16]||(e[16]=a("p",null,"é»žæ“Šã€Œæ–°å»ºç­ç´šã€é–‹å§‹å‰µå»ºä½ çš„ç¬¬ä¸€å€‹ç­ç´š",-1)),a("button",{class:"create-btn",onClick:e[4]||(e[4]=s=>E.value=!0)}," + æ–°å»ºç­ç´š ")]))],64)):A.value==="detail"&&_.value?(d(),o(D,{key:1},[a("header",Ae,[a("div",xe,[a("button",{class:"back-btn",onClick:L}," â† è¿”å›ž "),a("div",null,[a("h1",Me,c(_.value.class_name),1),a("p",qe,c(_.value.description||"ç®¡ç†ç­ç´šæˆå“¡"),1)])]),a("button",{class:"create-btn",onClick:e[5]||(e[5]=s=>T.value=!0)}," + æ·»åŠ å­¸ç”Ÿ ")]),a("section",$e,[a("div",Ne,[a("h2",null,"ç­ç´šæˆå“¡ ("+c(q.value.length)+")",1)]),q.value.length===0?(d(),o("div",Pe,[e[17]||(e[17]=a("p",null,"ç­ç´šä¸­é‚„æ²’æœ‰å­¸ç”Ÿ",-1)),a("button",{class:"create-btn",onClick:e[6]||(e[6]=s=>T.value=!0)}," + æ·»åŠ å­¸ç”Ÿ ")])):(d(),o("div",Le,[(d(!0),o(D,null,J(q.value,s=>(d(),o("div",{key:s.id,class:"member-card edamame-glass"},[a("div",De,[a("div",Ve,c((s.displayName||"?").charAt(0).toUpperCase()),1),a("div",Be,[a("p",Ue,c(s.displayName),1),a("p",ze,c(s.email),1)])]),a("div",Fe,[a("span",{class:le(["status-badge",s.status==="pending"?"pending":"active"])},c(s.status==="pending"?"å¾…æ¿€æ´»":"å·²æ¿€æ´»"),3),a("button",{class:"remove-btn",onClick:n=>F(s),title:"ç§»é™¤"}," âœ• ",8,Re)])]))),128))]))]),T.value?(d(),o("div",{key:0,class:"modal-overlay",onClick:e[9]||(e[9]=ae(s=>T.value=!1,["self"]))},[a("div",je,[e[18]||(e[18]=a("h2",null,"æ‰¹é‡æ·»åŠ å­¸ç”Ÿ",-1)),e[19]||(e[19]=a("p",{class:"modal-hint"},[G(" è¼¸å…¥å­¸ç”Ÿçš„å­¸æ ¡éƒµç®±åœ°å€ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œæˆ–ç”¨é€—è™Ÿåˆ†éš”ï¼‰"),a("br"),G(" æ ¼å¼ï¼š"),a("code",null,"xxxx@student.isf.edu.hk")],-1)),R(a("textarea",{"onUpdate:modelValue":e[7]||(e[7]=s=>b.value=s),class:"email-input",rows:"8",placeholder:`ä¾‹å¦‚ï¼š
student001@student.isf.edu.hk
student002@student.isf.edu.hk
student003@student.isf.edu.hk`},null,512),[[j,b.value]]),h.value?(d(),o("div",Ge,[a("p",He,"âœ“ æˆåŠŸæ·»åŠ  "+c(h.value.added)+" åå­¸ç”Ÿ",1),h.value.duplicates>0?(d(),o("p",We," âš  "+c(h.value.duplicates)+" å€‹éƒµç®±å·²åœ¨ç­ç´šä¸­ ",1)):k("",!0),h.value.invalidEmails>0?(d(),o("p",Ze,[G(" âœ• "+c(h.value.invalidEmails)+" å€‹ç„¡æ•ˆéƒµç®±ï¼š ",1),a("span",Je,c(h.value.invalidList.join(", ")),1)])):k("",!0)])):k("",!0),a("div",Ke,[a("button",{class:"cancel-btn",onClick:e[8]||(e[8]=s=>{T.value=!1,h.value=null})}," é—œé–‰ "),a("button",{class:"submit-btn",onClick:z,disabled:!b.value.trim()||M.value},c(M.value?"æ·»åŠ ä¸­...":"æ·»åŠ å­¸ç”Ÿ"),9,Oe)])])])):k("",!0)],64)):k("",!0)]))}}),Ye=ne(Qe,[["__scopeId","data-v-a4081c5d"]]);export{Ye as default};
