# 年級分級系統與故事創作優化總結

> **實施日期**：2025-10-15  
> **版本**：v2.0  
> **重大更新**：年級分級系統 + 8輪故事結構優化 + AI分級風格 + 整體點評

---

## 🎯 核心改進

### 1. 年級分級系統（1-13年級）
- ✅ 支持 1-12 年級 + 12+ 成人（共13個級別）
- ✅ 年級自動升級（基於9月學年分界）
- ✅ 首次登入強制選擇年級
- ✅ 可隨時調整年級
- ✅ 年級徽章顯示在用戶頭像旁

### 2. 分級主題系統（5個階段）
- ✅ 低年級（1-3）：可愛動物、校園生活、家庭日常、玩具世界
- ✅ 中年級（4-6）：自然探索、校園冒險、科學發現、友誼故事
- ✅ 初中（7-9）：奇幻冒險、成長故事、未來科技、推理懸疑
- ✅ 高中（10-12）：青春文學、社會觀察、哲學思考、歷史穿越
- ✅ 成人（13）：人性探索、都市現實、詩意表達、實驗創作
- ✅ **所有階段都包含「無主題模式」**

### 3. AI 分級風格（5種風格）
- ✅ 低年級：親切故事夥伴（簡單活潑，10-20字）
- ✅ 中年級：兒童文學作家（生動流暢，20-30字）
- ✅ 初中：青少年文學作家（細膩深度，20-40字）
- ✅ 高中：文學創作夥伴（典雅優雅，30-50字）
- ✅ 成人：專業作家夥伴（自由深刻，不限）

### 4. 8輪故事結構優化
- ✅ 開端期（1-2輪）：建立時空背景
- ✅ 發展期（3-4輪）：推進情節，引入問題
- ✅ 轉折期（5-6輪）：衝突加劇，關鍵轉折
- ✅ 高潮期（7輪）：開始解決，為用戶留空間
- ✅ 結局期（8輪）：用戶寫結局

### 5. 智能提示系統
- ✅ 第 6 輪：「故事過半 (6/8)」
- ✅ 第 7 輪：「倒數第二輪 - 故事快收尾了」（琥珀色警告）
- ✅ 第 8 輪：「最後一輪，寫下你的結局」（粉紅色，保持顯示）

### 6. 故事整體點評功能
- ✅ 故事完成後自動生成
- ✅ 三個維度：故事評價、創作亮點、成長建議
- ✅ 根據年級調整語言和深度

---

## 🏗️ 架構設計

### 數據庫架構

#### users 表新增欄位
```sql
grade INTEGER DEFAULT 6                    -- 年級（1-13）
grade_set_at TIMESTAMP DEFAULT NOW()       -- 設定時間
grade_auto_upgraded BOOLEAN DEFAULT FALSE  -- 是否自動升級過
```

#### grade_configs 配置表
```sql
CREATE TABLE grade_configs (
  grade INTEGER UNIQUE,        -- 年級
  grade_name TEXT,             -- 年級名稱
  age_range TEXT,              -- 年齡範圍
  difficulty_center DECIMAL,   -- 難度中心
  difficulty_min INTEGER,      -- 最小難度
  difficulty_max INTEGER       -- 最大難度
);
```

### Edge Functions 更新

| 函數名稱 | 版本 | 主要更新 |
|---------|------|---------|
| story-agent | v21 | 年級參數 + 8輪結構 + 5階段風格 |
| vocab-recommender | v13 | 年級輔助參考（不死綁定） |
| sentence-feedback | v5 | 年級語氣 + 階段感知 |
| story-summary | v2 | 新功能：整體點評 |

---

## 🎓 年級系統詳細設計

### 年級到年齡的映射
```
年級 = 年齡 - 5

1年級 → 6歲
2年級 → 7歲
...
12年級 → 17歲
12+年級 → 18歲+
```

### 年級自動升級機制

**規則**：每年 9 月自動升級一個年級

**算法**：
```javascript
// 設定時間：2024年10月 → 年級：8
// 到了：2025年9月 → 自動升級為：9

function shouldUpgrade(gradeSetAt, currentDate) {
  const setYear = gradeSetAt.getFullYear();
  const setMonth = gradeSetAt.getMonth();
  const currYear = currentDate.getFullYear();
  const currMonth = currentDate.getMonth();
  
  let yearsPassed = currYear - setYear;
  
  // 9月為分界點（月份索引 0-11，9月是索引8）
  if (currMonth >= 8 && setMonth < 8) {
    // 已跨越學年
  } else if (currMonth < 8 && setMonth >= 8) {
    // 還在同一學年
    yearsPassed--;
  }
  
  return yearsPassed > 0;
}
```

**觸發時機**：每次用戶登入時自動檢查

### 年級到難度的映射

| 年級 | 年齡 | 難度中心 | 難度範圍 |
|-----|------|---------|---------|
| 1-3 | 6-8歲 | L1-L2 | L1-L3 |
| 4-6 | 9-11歲 | L2-L3 | L2-L4 |
| 7-9 | 12-14歲 | L3.5-L4.5 | L3-L6 |
| 10-12 | 15-17歲 | L5-L6 | L4-L6 |
| 13 | 18歲+ | L6 | L5-L6 |

⚠️ **重要原則**：年級只作為初始參考，詞彙推薦**以用戶實際選詞數據為主**，不死死綁定年級。

---

## 🎬 8輪故事結構詳解

### 總體設計

```
8 輪 = 16 句
- AI 句子：8 句（第1輪開場 + 2-8輪回應）
- 用戶句子：8 句（第1-8輪）
- 最後一句：用戶的結局句
```

### 階段劃分

#### 第 1-2 輪：開端期（4句）
**AI 目標**：
- 建立清晰的時空背景
- 引入主角或關鍵元素
- 設定故事基調
- 留出懸念或動機

**用戶引導**：無提示（自由創作）

---

#### 第 3-4 輪：發展期（4句）
**AI 目標**：
- 深化場景細節
- 明確故事目標或問題
- 引入小挑戰或新角色
- 為後續衝突做鋪墊

**用戶引導**：無提示（自由創作）

---

#### 第 5-6 輪：轉折期（4句）
**AI 目標**：
- 衝突或問題進一步加劇
- 角色面臨重要選擇或掙扎
- 營造緊張感
- **第 6 輪是轉折點**：意外發現、反轉、關鍵決定

**用戶引導**：
- 第 6 輪顯示：「📖 故事過半 (6/8)」（信息提示）

---

#### 第 7 輪：高潮/解決期（2句）
**AI 目標**：
- ⚠️ **關鍵要求**：為用戶的結局留出空間！
- 開始展現解決的曙光
- 可以展現希望或出口
- **絕對不要完全解決衝突**
- 不要寫「高興地回家了」等完結性語句

**用戶引導**：
- 顯示：「⚠️ 倒數第二輪 (7/8) - 故事快收尾了」（琥珀色警告，帶脈衝動畫）

---

#### 第 8 輪：結局期（1句）
**用戶任務**：寫出故事的結局句

**用戶引導**：
- 顯示：「🎬 最後一輪，寫下你的結局」（粉紅色，保持顯示）

**AI 反饋**（如開啟）：
- 從「結局角度」評價（完整性、情感餘韻、呼應前文）

---

## 🤖 AI Prompt 優化

### story-agent 的 Prompt 結構

```
你是${角色定位}，與${年齡段}的學生共創故事。

【語言風格】${根據年級調整}
【內容偏好】${根據年級調整}
【接龍規則】必須緊密承接學生的句子
【創作要點】句式要求：${根據年級}

【當前設定】
年級：X年級（約Y歲）
主題：${主題名稱}
階段：${當前階段名稱}
輪次：X/8

【故事階段指導】
${根據輪次的詳細指導}

直接輸出繁體中文故事句，無需解釋。
```

### 分級風格示例

#### 低年級（1-3年級）示例
```
角色：親切的故事夥伴
語言：簡單、活潑、有趣
句式：10-20字
內容：日常生活、動物、遊戲

示例開場：
"一個陽光燦爛的早晨，小貓咪在院子裡玩耍。"
```

#### 高中（10-12年級）示例
```
角色：文學創作夥伴
語言：典雅、深邃、富有意境
句式：30-50字
內容：人性、哲學、社會觀察

示例開場：
"暮色漸沉，城市的喧囂隱入夜色深處，唯獨那盞路燈下，
他靜靜地翻開了塵封多年的日記本。"
```

---

## 📊 整體點評功能

### 觸發時機
故事完成後（第8輪用戶提交結局）自動在後台生成

### 點評內容
1. **故事評價**（2-3句）
   - 概括故事的完整性和特點
   
2. **創作亮點**（3個）
   - 具體指出精彩的情節、描寫或轉折
   - 引用實際的句子或情節
   
3. **成長建議**（1-2句）
   - 溫和的改進方向
   - 啟發性建議，不批評

### 根據年級調整

| 年級段 | 評價者角色 | 評價重點 | 語言風格 |
|--------|-----------|---------|---------|
| 1-3 | 故事老師 | 有趣、清楚 | 親切、童趣 |
| 4-6 | 兒童文學老師 | 結構、描寫 | 溫暖、易懂 |
| 7-9 | 語文教師 | 邏輯、情感 | 專業、深入 |
| 10-12 | 文學導師 | 手法、意境 | 典雅、啟發 |
| 13 | 文學批評者 | 技巧、創新 | 專業、批判 |

---

## 🔑 關鍵設計原則

### 1. 年級與詞彙水平的關係

⚠️ **核心原則**：以實際數據為主，年級為輔

```
年級系統：
├─ 初始參考（首次使用）
│  └─ 根據年級設定初始 baseline_level
│
└─ 持續優化（之後遊戲）
   └─ 完全基於 current_level（動態計算）
      ├─ 用戶選詞難度
      ├─ AI 評分
      └─ 最近20輪表現
```

**詞彙推薦邏輯**：
1. 優先參考 `current_level`（基於實際選詞）
2. 參考 `recent_avg_difficulty`（最近偏好）
3. 年級僅作為背景信息，不死死綁定
4. 用戶詞表和系統詞表不受年級影響

### 2. 用戶引導原則

**輕量提示，不過度干預**：
- 前 5 輪：無提示（完全自由）
- 第 6 輪：輕量提醒（故事過半）
- 第 7 輪：重要提醒（快收尾了）
- 第 8 輪：結局提示（寫下結局）

### 3. 故事完整性保證

**第 7 輪 AI 的特殊指令**：
```
⚠️ 關鍵要求：為用戶的結局留出空間！
- 開始展現解決的曙光
- 但絕對不要完全解決衝突
- 不要寫「高興地回家了」等完結性語句
- 而是寫「他們終於看到了...」「答案漸漸浮現...」
```

**第 8 輪 AI 反饋**：
```
【特別提示】這是故事的結局句！
- 評價時要從「結局角度」思考
- 是否完整收尾？是否有情感餘韻？
- 是否呼應前文？是否讓人滿意？
```

---

## 📁 文件清單

### 新增文件（5個）

1. **數據庫遷移**
   - `supabase/migrations/021_add_grade_system.sql`

2. **前端工具**
   - `js/utils/grade-manager.js` - 年級管理（自動升級、配置）

3. **後端 Prompt**
   - `supabase/functions/story-agent/prompts.ts` - 分級 prompt 系統
   - `supabase/functions/story-summary/index.ts` - 整體點評功能

### 修改文件（12個）

**認證系統**：
- `js/auth/standalone-auth.js` - 集成年級自動升級

**前端核心**：
- `js/app.js` - 傳遞年級和輪次參數
- `js/config.js` - 主題配置和映射函數
- `js/core/story-engine.js` - 傳遞年級給 story-agent
- `js/core/vocab-integration.js` - 傳遞年級給 vocab-recommender
- `js/ui/screens.js` - 年級選擇器、徽章、輪次提示、整體點評

**樣式**：
- `index.html` - 年級徽章元素
- `css/components.css` - 年級選擇器、徽章、提示、點評樣式

**後端服務**：
- `supabase/functions/story-agent/index.ts`
- `supabase/functions/vocab-recommender/index.ts`
- `supabase/functions/vocab-recommender/prompts.ts`
- `supabase/functions/sentence-feedback/index.ts`

---

## 🚀 部署記錄

### Edge Functions 部署
```bash
✅ story-agent        v21  2025-10-15 14:14:37
✅ vocab-recommender  v13  2025-10-15 14:14:53
✅ sentence-feedback  v5   2025-10-15 14:15:17
✅ story-summary      v2   2025-10-15 14:22:50
```

### 數據庫遷移
```sql
✅ users 表新增 3 個欄位
✅ grade_configs 配置表（13 個年級）
✅ RLS 策略更新
✅ 2 個輔助函數
```

---

## 📋 使用指南

### 用戶視角

1. **首次登入**
   - 必須選擇年級（1-12年級 + 12+）
   - 系統根據年級顯示對應主題

2. **開始遊戲**
   - 看到年級對應的主題選項
   - 始終可以選擇「無主題模式」

3. **創作過程**
   - 第 6 輪：看到「故事過半」提示
   - 第 7 輪：看到「快收尾了」警告
   - 第 8 輪：看到「寫下你的結局」提示
   - AI 風格符合年齡段

4. **故事完成**
   - 查看完整故事
   - 收到 AI 的整體點評（評價+亮點+建議）

5. **年級管理**
   - 每年 9 月自動升級
   - 可隨時點擊徽章調整年級

### 開發者視角

#### 添加新主題
```javascript
// 在 js/config.js 的 GRADE_THEMES 中添加
{
  id: 'new_theme',
  name: '新主題',
  icon: '🎨',
  description: '主題描述',
  gradient: 'from-blue-400 to-cyan-500',
  keywords: ['關鍵詞1', '關鍵詞2']
}
```

#### 調整 AI 風格
修改 `supabase/functions/story-agent/prompts.ts` 中的：
- `getRoleGuide()` - 角色定位
- `getStyleGuide()` - 語言風格
- `getContentGuide()` - 內容偏好
- `getSentenceGuide()` - 句式要求

#### 調整故事階段
修改 `supabase/functions/story-agent/prompts.ts` 中的 `getStoryStageInfo()` 函數

---

## 🎯 預期效果

### 用戶體驗
- ✅ 個性化內容（根據年齡段調整）
- ✅ 適齡的 AI 風格（不會太幼稚或太複雜）
- ✅ 清晰的故事結構（知道何時收尾）
- ✅ 有意義的整體點評（教學價值）

### 教學效果
- ✅ 詞彙推薦更合理（動態追蹤水平）
- ✅ 反饋更適齡（語氣和深度）
- ✅ 故事更完整（有明確的起承轉合）
- ✅ 點評更有針對性（找出真正的亮點）

---

## 🐛 已知限制與未來優化

### 當前限制
1. 年級需要手動設定（首次登入時）
2. 整體點評可能需要 3-5 秒生成
3. 主題選擇仍然是標籤化的（未來可以更開放）

### 未來優化方向
1. **主題系統**
   - 考慮改為「靈感提示」而非固定主題
   - 或完全取消主題，讓 AI 根據首句自適應

2. **年級估算**
   - 可以嘗試根據用戶文字複雜度自動估算年級
   - 減少手動設定的需求

3. **故事長度**
   - 未來可以根據年級提供不同的輪數選項
   - 低年級：6輪（快速）
   - 高年級：10輪（深度）

4. **互動性**
   - AI 偶爾提出選擇題
   - 增加故事分支可能性

---

## 📚 相關文檔

- [認證架構](../.cursor/rules/story-vocab/auth.mdc)
- [Supabase 部署規範](../.cursor/rules/story-vocab/supabase-deployment.mdc)
- [用戶 ID 使用規範](../.cursor/rules/story-vocab-user-id.mdc)
- [完整架構文檔](./DESIGN.md)

---

**維護者**：張老師「太虛幻境」AI 實驗室  
**最後更新**：2025-10-15

