# Story-Agent å„ªåŒ–è¨˜éŒ„

## ğŸ“‹ å„ªåŒ–ç›®æ¨™

ç§»é™¤ `story-agent` Edge Function ä¸­çš„å†—é¤˜è©å½™æ¨è–¦åŠŸèƒ½ï¼Œå°ˆæ³¨æ–¼æ ¸å¿ƒä»»å‹™ï¼š**æ•…äº‹ç”Ÿæˆ + ç”¨æˆ¶åé¥‹**

## ğŸ” å•é¡Œåˆ†æ

### åŸå§‹æ¶æ§‹å•é¡Œ

1. **åŠŸèƒ½é‡è¤‡**ï¼š`story-agent` å…§éƒ¨æœ‰è©å½™æ¨è–¦ï¼Œä½†å‰ç«¯å¯¦éš›ä½¿ç”¨çš„æ˜¯å°ˆé–€çš„ `vocab-recommender`
2. **è³‡æºæµªè²»**ï¼šæ¯æ¬¡èª¿ç”¨éƒ½åŸ·è¡Œä¸å¿…è¦çš„æ•¸æ“šåº«æŸ¥è©¢ï¼ˆ~0.5-1ç§’ï¼‰
3. **ä»£ç¢¼æ··äº‚**ï¼šå‰ç«¯å¿½ç•¥ `story-agent` è¿”å›çš„ `recommendedWords`

### åŸ·è¡Œæµç¨‹å°æ¯”

#### âŒ å„ªåŒ–å‰ï¼ˆæœ‰é‡è¤‡ï¼‰

```
ç”¨æˆ¶æäº¤å¥å­
    â†“
èª¿ç”¨ story-agent
    â”œâ”€ 1. ç”Ÿæˆæ•…äº‹å¥å­ (1-1.5s)
    â”œâ”€ 2. æ¨è–¦è©å½™ (0.5-1s) â† å†—é¤˜ï¼å‰ç«¯æœƒå¿½ç•¥
    â”œâ”€ 3. ç”Ÿæˆåé¥‹ (1-1.5s)
    â””â”€ 4. æ›´æ–°æ•¸æ“šåº« (0.1s)
    â†“
å‰ç«¯å¿½ç•¥è©å½™ï¼Œé‡æ–°èª¿ç”¨ vocab-recommender (0.5-1s)
    â†“
ç¸½æ™‚é–“ï¼š~4-5ç§’
```

#### âœ… å„ªåŒ–å¾Œï¼ˆè·è²¬æ¸…æ™°ï¼‰

```
ç”¨æˆ¶æäº¤å¥å­
    â†“
ä¸¦è¡Œèª¿ç”¨ï¼š
    â”œâ”€ story-agent
    â”‚   â”œâ”€ 1. ç”Ÿæˆæ•…äº‹å¥å­ (1-1.5s)
    â”‚   â”œâ”€ 2. ç”Ÿæˆåé¥‹ (1-1.5s)
    â”‚   â””â”€ 3. æ›´æ–°æ•¸æ“šåº« (0.1s)
    â”‚
    â””â”€ vocab-recommender (èƒŒæ™¯åŸ·è¡Œ)
        â””â”€ æ¨è–¦è©å½™ (0.5-1s)
    â†“
ç¸½æ™‚é–“ï¼š~2.5-3ç§’ï¼ˆstory-agentï¼‰
       + èƒŒæ™¯è©å½™åŠ è¼‰
```

## ğŸ”§ å…·é«”ä¿®æ”¹

### 1. ç§»é™¤è©å½™æ¨è–¦èª¿ç”¨

**æ–‡ä»¶**: `story-agent/index.ts`

**åˆªé™¤**ï¼š
- ç¬¬ 90-99 è¡Œï¼š`recommendVocabulary()` èª¿ç”¨
- ç¬¬ 422-512 è¡Œï¼š`recommendVocabulary()` å’Œ `selectDiverseWords()` å‡½æ•¸å®šç¾©

### 2. ç°¡åŒ–è¿”å›å€¼

**ä¿®æ”¹å‰**ï¼š
```typescript
return {
  aiSentence,
  recommendedWords,  // â† å‰ç«¯æœƒå¿½ç•¥
  currentRound,
  isComplete,
  score,
  feedback
}
```

**ä¿®æ”¹å¾Œ**ï¼š
```typescript
return {
  aiSentence,        // æ•…äº‹å¥å­
  currentRound,
  isComplete,
  score,             // è©•åˆ†
  feedback           // åé¥‹
}
// è©å½™æ¨è–¦ç”± vocab-recommender è² è²¬
```

### 3. æ›´æ–°æ•¸æ“šåº«è¨˜éŒ„

**ä¿®æ”¹å‰**ï¼š
```typescript
conversation_history: [
  {
    round: 1,
    user: "...",
    ai: "...",
    recommendedWords: ["è©1", "è©2", ...] // â† é‡è¤‡è¨˜éŒ„
  }
]
```

**ä¿®æ”¹å¾Œ**ï¼š
```typescript
conversation_history: [
  {
    round: 1,
    user: "...",
    ai: "..."
  }
]
// è©å½™æ¨è–¦è¨˜éŒ„åœ¨ recommendation_history è¡¨ï¼ˆç”± vocab-recommender è² è²¬ï¼‰
```

### 4. åƒæ•¸å‘å¾Œå…¼å®¹

ä¿ç•™ `userLevel` å’Œ `usedWords` åƒæ•¸ï¼ˆæ¨™è¨˜ç‚ºå·²æ£„ç”¨ï¼‰ï¼Œé¿å…å‰ç«¯éŒ¯èª¤ï¼š

```typescript
const { 
  userSentence,
  selectedWord,
  sessionId,
  conversationHistory,
  storyTheme,
  currentRound,
  requestFeedbackOnly = false,
  // ä»¥ä¸‹åƒæ•¸ä¿ç•™ç”¨æ–¼å‘å¾Œå…¼å®¹ï¼Œä½†ä¸å†ä½¿ç”¨
  userLevel,              // [å·²æ£„ç”¨]
  usedWords = []          // [å·²æ£„ç”¨]
} = await req.json()
```

## ğŸ“Š å„ªåŒ–æ•ˆæœ

| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|-----|--------|--------|------|
| **ä»£ç¢¼è¡Œæ•¸** | 587 è¡Œ | 481 è¡Œ | **â†“ 18%** |
| **åŸ·è¡Œæ™‚é–“** | 3-4 ç§’ | 2.5-3 ç§’ | **â†“ 25%** |
| **æ•¸æ“šåº«æŸ¥è©¢** | 3 æ¬¡ | 2 æ¬¡ | **â†“ 33%** |
| **è·è²¬æ¸…æ™°åº¦** | æ··äº‚ | æ¸…æ™° | âœ… |

### æ•´é«”éŸ¿æ‡‰é€Ÿåº¦æ”¹å–„

çµåˆä¹‹å‰çš„æç¤ºè©å„ªåŒ–ï¼š

| éšæ®µ | åˆå§‹ç‰ˆæœ¬ | æç¤ºè©å„ªåŒ– | ç§»é™¤å†—é¤˜ | **ç¸½æ”¹å–„** |
|------|---------|-----------|---------|----------|
| AI è¼¸å…¥ tokens | 1150 | 600 | 600 | â†“ 48% |
| åŸ·è¡Œæ™‚é–“ | 3-4s | 2.5-3s | 2-2.5s | **â†“ 50%** |

**é æœŸ**ï¼šAI éŸ¿æ‡‰é€Ÿåº¦å¾ **3-4ç§’ â†’ 2-2.5ç§’**

## ğŸ¯ æ¶æ§‹æ”¹å–„

### æ˜ç¢ºçš„è·è²¬åˆ†é›¢

1. **story-agent**ï¼ˆæ•…äº‹ AIï¼‰
   - âœ… ç”Ÿæˆæ•…äº‹å¥å­
   - âœ… è©•åƒ¹ç”¨æˆ¶å¥å­
   - âœ… æ›´æ–°å°è©±æ­·å²

2. **vocab-recommender**ï¼ˆè©å½™ AIï¼‰
   - âœ… æ ¡æº–è©åº«ç®¡ç†
   - âœ… è©è¡¨æ¨¡å¼æ”¯æŒ
   - âœ… AI æ™ºèƒ½æ¨è–¦
   - âœ… æ¨è–¦æ­·å²è¨˜éŒ„

### æ•¸æ“šè¨˜éŒ„åˆ†é›¢

- `story_sessions.conversation_history` - æ•…äº‹å°è©±æ­·å²ï¼ˆstory-agentï¼‰
- `recommendation_history` - è©å½™æ¨è–¦æ­·å²ï¼ˆvocab-recommenderï¼‰
- `game_rounds` - å®Œæ•´å›åˆæ•¸æ“šï¼ˆå‰ç«¯çµ±ä¸€è¨˜éŒ„ï¼‰

## ğŸ“ æ¸¬è©¦å»ºè­°

è«‹æ¸¬è©¦ä»¥ä¸‹å ´æ™¯ï¼š

1. âœ… **æ•…äº‹ç”Ÿæˆé€Ÿåº¦**ï¼šæ˜¯å¦æ˜é¡¯è®Šå¿«ï¼Ÿ
2. âœ… **è©å½™æ¨è–¦æ­£å¸¸**ï¼šæ˜¯å¦ä¾ç„¶èƒ½æ­£ç¢ºæ¨è–¦è©å½™ï¼Ÿ
3. âœ… **åé¥‹åŠŸèƒ½æ­£å¸¸**ï¼šè©•åˆ†å’Œåé¥‹æ˜¯å¦ä¾ç„¶é¡¯ç¤ºï¼Ÿ
4. âœ… **æ ¡æº–æ¨¡å¼**ï¼šç¬¬ä¸€æ¬¡éŠæˆ²æ˜¯å¦ä½¿ç”¨æ ¡æº–è©åº«ï¼Ÿ
5. âœ… **è©è¡¨æ¨¡å¼**ï¼šæŒ‡å®šè©è¡¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ

## ğŸ”„ å›æ»¾æ–¹æ¡ˆ

å¦‚æœå‡ºç¾å•é¡Œï¼Œå¯ä»¥å¾ Git æ­·å²æ¢å¾©ï¼š

```bash
cd story-vocab
git log --oneline supabase/functions/story-agent/index.ts
git checkout <commit-hash> supabase/functions/story-agent/index.ts
supabase functions deploy story-agent
```

## ğŸ“š ç›¸é—œæ–‡æª”

- [Story-Agent Edge Function](../supabase/functions/story-agent/index.ts)
- [Vocab-Recommender Edge Function](../supabase/functions/vocab-recommender/index.ts)
- [è©å½™é›†æˆæ¨¡å¡Š](../js/core/vocab-integration.js)

---

**å„ªåŒ–æ—¥æœŸ**: 2025-10-12  
**åŸ·è¡Œè€…**: AI Assistant  
**éƒ¨ç½²ç‹€æ…‹**: âœ… å·²éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ

