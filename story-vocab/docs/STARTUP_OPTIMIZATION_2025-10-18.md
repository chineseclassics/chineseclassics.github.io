# è©éŠè¨˜å•Ÿå‹•é€Ÿåº¦å„ªåŒ–ï¼ˆ2025-10-18ï¼‰

## ğŸ¯ å„ªåŒ–ç›®æ¨™

æ¸›å°‘æ‡‰ç”¨å•Ÿå‹•æ™‚çš„ Supabase é ç¨‹æŸ¥è©¢æ¬¡æ•¸ï¼Œæå‡å•Ÿå‹•é€Ÿåº¦ã€‚

## ğŸ“Š å„ªåŒ–å‰çš„å•é¡Œ

### 1. **é‡è¤‡çš„è©è¡¨ä¿¡æ¯æŸ¥è©¢** âŒ
- `standalone-auth.js` æŸ¥è©¢è©è¡¨æ™‚ç¼ºå°‘ `code` å’Œ `type` æ¬„ä½
- `screens.js` ç™¼ç¾ç¼ºå°‘ `code`ï¼Œé‡æ–°æŸ¥è©¢äº†ä¸€æ¬¡
- **çµæœ**ï¼šåŒä¸€å€‹è©è¡¨æŸ¥è©¢äº† **2 æ¬¡**

### 2. **è©è¡¨æ¨™ç±¤é‡è¤‡åŠ è¼‰** âŒ
- å…ˆå¾ Supabase çš„ `wordlist_tags` è¡¨æŸ¥è©¢æ¨™ç±¤
- ç„¶å¾Œåˆå¾ JSON æ–‡ä»¶é‡æ–°åŠ è¼‰æ¨™ç±¤
- **çµæœ**ï¼šç³»çµ±è©è¡¨çš„æ¨™ç±¤è¢«åŠ è¼‰äº† **2 æ¬¡**

### 3. **~~ä¸»é¡Œåœ¨å•Ÿå‹•æ™‚ç«‹å³åŠ è¼‰~~** âŒ èª¤åˆ¤
- ~~è©è¡¨æ¨¡å¼ç”¨æˆ¶ä¸éœ€è¦ä¸»é¡Œ~~
- **æ›´æ­£**ï¼šç¶“ç”¨æˆ¶æŒ‡æ­£ï¼Œ**å…©ç¨®æ¨¡å¼éƒ½éœ€è¦ä¸»é¡Œé¸æ“‡**
- ä¸»é¡Œé¸æ“‡åœ¨ç•Œé¢ä¸Šæ¨™è¨»ç‚ºã€Œå§‹çµ‚é¡¯ç¤ºã€
- **çµè«–**ï¼šæ­¤é …ä¸éœ€è¦å„ªåŒ–

### 3. **å•Ÿå‹•æ™‚çš„ Supabase æŸ¥è©¢æ¬¡æ•¸**
```
âœ… user_profiles: 1æ¬¡ï¼ˆå¿…éœ€ï¼‰
âœ… user_wordlist_preferences: 1æ¬¡ï¼ˆå¿…éœ€ï¼‰
âŒ wordlists: 2æ¬¡ï¼ˆé‡è¤‡ï¼ï¼‰
âŒ wordlist_tags: 1æ¬¡ï¼ˆç³»çµ±è©è¡¨å¯å¾JSONåŠ è¼‰ï¼‰
```

## âœ… å„ªåŒ–æ–¹æ¡ˆ

### 1. **ä¿®å¾©è©è¡¨æŸ¥è©¢**ï¼ˆ`standalone-auth.js:493`ï¼‰

**å„ªåŒ–å‰**ï¼š
```javascript
const { data: wordlist } = await this.supabase
  .from('wordlists')
  .select('*')  // æ²’æœ‰åŒ…å« code å’Œ type
  .eq('id', prefs.default_wordlist_id)
  .maybeSingle();
```

**å„ªåŒ–å¾Œ**ï¼š
```javascript
const { data: wordlist } = await this.supabase
  .from('wordlists')
  .select('id, name, code, type, description')  // âœ… æ˜ç¢ºåŒ…å«æ‰€éœ€æ¬„ä½
  .eq('id', prefs.default_wordlist_id)
  .maybeSingle();
```

**æ•ˆæœ**ï¼šé¿å… `screens.js` ä¸­çš„é‡è¤‡æŸ¥è©¢ï¼Œ**æ¸›å°‘ 1 æ¬¡ Supabase æŸ¥è©¢**

---

### 2. **å¾ JSON åŠ è¼‰ç³»çµ±è©è¡¨æ¨™ç±¤**ï¼ˆ`standalone-auth.js:498-552`ï¼‰

**å„ªåŒ–å‰**ï¼š
```javascript
// ç¸½æ˜¯å¾æ•¸æ“šåº«æŸ¥è©¢æ¨™ç±¤
const { data: tags } = await this.supabase
  .from('wordlist_tags')
  .select('*')
  .eq('wordlist_id', wordlist.id)
  .order('tag_level')
  .order('sort_order');
```

**å„ªåŒ–å¾Œ**ï¼š
```javascript
// âœ… å¦‚æœæ˜¯ç³»çµ±è©è¡¨ï¼Œå¾ JSON åŠ è¼‰ï¼ˆæ›´å¿«ï¼‰
if (wordlist.type === 'system' && wordlist.code) {
  try {
    const { getWordlistWithTags } = await import('../core/wordlist-loader.js');
    const jsonData = await getWordlistWithTags(wordlist.code);
    
    wordlistInfo = {
      id: wordlist.id,
      name: wordlist.name,
      code: wordlist.code,
      type: wordlist.type,
      tags: jsonData.tags || []
    };
    
    console.log('ğŸ“š è©è¡¨ä¿¡æ¯å·²å¾ JSON åŠ è¼‰');
  } catch (jsonError) {
    // å›é€€åˆ°æ•¸æ“šåº«æŸ¥è©¢
    // ...
  }
} else {
  // è‡ªå®šç¾©è©è¡¨ï¼Œä»å¾æ•¸æ“šåº«æŸ¥è©¢
  // ...
}
```

**æ•ˆæœ**ï¼š
- ç³»çµ±è©è¡¨ï¼ˆå¦‚ HSK æ¨™æº–è©è¡¨ï¼‰**æ¸›å°‘ 1 æ¬¡ Supabase æŸ¥è©¢**
- JSON æ–‡ä»¶æœ‰ç·©å­˜ï¼ˆ`wordlistCache`ï¼‰ï¼Œç¬¬äºŒæ¬¡åŠ è¼‰å¹¾ä¹ç„¡å»¶é²
- è‡ªå®šç¾©è©è¡¨ä»ä½¿ç”¨æ•¸æ“šåº«æŸ¥è©¢ï¼Œä¿æŒåŠŸèƒ½å®Œæ•´æ€§

---

### 3. **å„ªåŒ– screens.js çš„é‡è¤‡æŸ¥è©¢é‚è¼¯**ï¼ˆ`screens.js:146-180`ï¼‰

**å„ªåŒ–å‰**ï¼š
```javascript
// æª¢æŸ¥ç·©å­˜æ˜¯å¦æœ‰ codeï¼ˆèˆŠç‰ˆæœ¬å¯èƒ½æ²’æœ‰ï¼‰
if (!wordlistInfo.code) {
  console.warn('âš ï¸ ç·©å­˜çš„è©è¡¨ä¿¡æ¯ç¼ºå°‘ codeï¼Œé‡æ–°æŸ¥è©¢...');
  // é‡æ–°æŸ¥è©¢æ•´å€‹è©è¡¨
  const { data: wordlist } = await supabase
    .from('wordlists')
    .select('id, name, code, type')
    .eq('id', wordlistInfo.id)
    .maybeSingle();
  // ...
}
```

**å„ªåŒ–å¾Œ**ï¼š
```javascript
// âœ… å„ªåŒ–ï¼šèªè­‰æœå‹™å·²ç¶“æä¾›äº†å®Œæ•´çš„è©è¡¨ä¿¡æ¯
console.log('ğŸ“š è©è¡¨ä¿¡æ¯ï¼ˆå¾èªè­‰æœå‹™ï¼‰:', wordlistInfo.name);

// åªæœ‰åœ¨ä¿¡æ¯ä¸å®Œæ•´æ™‚æ‰è£œå……æŸ¥è©¢ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
if (!wordlistInfo.code || !wordlistInfo.tags || wordlistInfo.tags.length === 0) {
  console.warn('âš ï¸ è©è¡¨ä¿¡æ¯ä¸å®Œæ•´ï¼Œè£œå……åŠ è¼‰...');
  // åªæŸ¥è©¢ç¼ºå¤±çš„æ¬„ä½
  // ...
}
```

**æ•ˆæœ**ï¼š
- æ­£å¸¸æƒ…æ³ä¸‹ä¸å†éœ€è¦é‡è¤‡æŸ¥è©¢
- ä¿ç•™å‘å¾Œå…¼å®¹æ€§ï¼Œè™•ç†èˆŠç‰ˆæœ¬ç·©å­˜æ•¸æ“š

---

### ~~4. å»¶é²åŠ è¼‰ä¸»é¡Œ~~ï¼ˆâŒ å·²æ’¤å›ï¼‰

**åŸæœ¬è¨ˆåŠƒ**ï¼šå»¶é²åŠ è¼‰ä¸»é¡Œåˆ°éœ€è¦æ™‚

**æ’¤å›åŸå› **ï¼šç¶“ç”¨æˆ¶æŒ‡æ­£ï¼Œè©è¡¨æ¨¡å¼å’Œ AI æ¨¡å¼**éƒ½éœ€è¦ä¸»é¡Œé¸æ“‡**
- ç•Œé¢ä¸Šä¸»é¡Œé¸æ“‡å™¨æ¨™è¨»ç‚ºã€Œå§‹çµ‚é¡¯ç¤ºã€
- å…©ç¨®æ¨¡å¼éƒ½éœ€è¦ç”¨æˆ¶é¸æ“‡æ•…äº‹ä¸»é¡Œ
- å»¶é²åŠ è¼‰æœƒå°è‡´è©è¡¨æ¨¡å¼ç”¨æˆ¶çœ‹ä¸åˆ°ä¸»é¡Œ

**æ­£ç¢ºç†è§£**ï¼š
- **AI æ¨¡å¼**ï¼šAI èªªæ˜ + ä¸»é¡Œé¸æ“‡ + é–‹å§‹æŒ‰éˆ•
- **è©è¡¨æ¨¡å¼**ï¼šè©è¡¨å±¤ç´šé¸æ“‡ + ä¸»é¡Œé¸æ“‡ + é–‹å§‹æŒ‰éˆ•

**çµè«–**ï¼šä¸»é¡ŒåŠ è¼‰**ä¿æŒåŸæ¨£**ï¼Œä¸åšå„ªåŒ–

---

## ğŸ“ˆ å„ªåŒ–æ•ˆæœé æœŸ

### æ¸›å°‘çš„ Supabase æŸ¥è©¢
- **è©è¡¨æŸ¥è©¢**ï¼šå¾ 2 æ¬¡æ¸›å°‘åˆ° **1 æ¬¡**ï¼ˆ-50%ï¼‰
- **è©è¡¨æ¨™ç±¤æŸ¥è©¢**ï¼šç³»çµ±è©è¡¨å¾ 1 æ¬¡æ¸›å°‘åˆ° **0 æ¬¡**ï¼ˆ-100%ï¼‰
- **ç¸½é«”æ¸›å°‘**ï¼šå•Ÿå‹•æ™‚æ¸›å°‘ **1-2 æ¬¡**é ç¨‹æŸ¥è©¢

### æ¸›å°‘çš„ç¶²çµ¡å»¶é²
å‡è¨­æ¯æ¬¡ Supabase æŸ¥è©¢å»¶é² 100-300msï¼š
- **ç¯€çœæ™‚é–“**ï¼š100-600msï¼ˆå–æ±ºæ–¼ç¶²çµ¡ç‹€æ³ï¼‰

### ç¶œåˆæ•ˆæœ
- **ç¸½é«”å•Ÿå‹•é€Ÿåº¦æå‡**ï¼š100-600ms
- **æ„ŸçŸ¥é€Ÿåº¦æå‡**ï¼šæ˜é¡¯æ¸›å°‘ã€Œç­‰å¾…æ„Ÿã€
- **ç”¨æˆ¶é«”é©—**ï¼šå•Ÿå‹•æ›´æµæš¢ï¼ŒéŸ¿æ‡‰æ›´å¿«

### ~~è©è¡¨æ¨¡å¼ç”¨æˆ¶é¡å¤–å„ªåŒ–~~ï¼ˆå·²æ’¤å›ï¼‰
- ~~ä¸åŠ è¼‰ä¸»é¡Œé…ç½®å’Œ DOM~~
- ~~é¡å¤–ç¯€çœ 50-100ms~~
- **æ›´æ­£**ï¼šä¸»é¡Œåœ¨å…©ç¨®æ¨¡å¼ä¸‹éƒ½éœ€è¦ï¼Œä¸åšæ­¤å„ªåŒ–

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### è©è¡¨åŠ è¼‰å™¨ç·©å­˜æ©Ÿåˆ¶
```javascript
// wordlist-loader.js
const wordlistCache = new Map();

export async function loadWordlist(wordlistCode) {
  // æª¢æŸ¥ç·©å­˜
  if (wordlistCache.has(wordlistCode)) {
    console.log(`âœ… å¾ç·©å­˜åŠ è¼‰è©è¡¨: ${wordlistCode}`);
    return wordlistCache.get(wordlistCode);
  }
  
  // åŠ è¼‰ JSON æ–‡ä»¶
  const response = await fetch(`/assets/data/wordlists/${wordlistCode}.json`);
  const data = await response.json();
  
  // å­˜å…¥ç·©å­˜
  wordlistCache.set(wordlistCode, data);
  return data;
}
```

**å„ªå‹¢**ï¼š
- ç¬¬ä¸€æ¬¡åŠ è¼‰å¾Œï¼Œå¾ŒçºŒè¨ªå•å¹¾ä¹ç„¡å»¶é²
- ç€è¦½å™¨ä¹Ÿæœƒç·©å­˜ JSON æ–‡ä»¶ï¼ˆHTTP ç·©å­˜ï¼‰
- é›™å±¤ç·©å­˜æ©Ÿåˆ¶ç¢ºä¿æœ€å¿«è¨ªå•é€Ÿåº¦

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### 1. å•Ÿå‹•é€Ÿåº¦æ¸¬è©¦
```javascript
// åœ¨ app.js çš„ initializeApp() é–‹é ­æ·»åŠ 
const startTime = performance.now();

// åœ¨çµå°¾æ·»åŠ 
const endTime = performance.now();
console.log(`â±ï¸ å•Ÿå‹•è€—æ™‚: ${(endTime - startTime).toFixed(2)}ms`);
```

### 2. Supabase æŸ¥è©¢è¨ˆæ•¸
åœ¨ Chrome DevTools çš„ Network é¢æ¿ï¼š
- ç¯©é¸ `supabase.co/rest/v1/`
- è¨ˆç®—å•Ÿå‹•æ™‚çš„è«‹æ±‚æ•¸é‡
- **å„ªåŒ–å‰**ï¼šç´„ 4-5 å€‹è«‹æ±‚
- **å„ªåŒ–å¾Œ**ï¼šç´„ 2-3 å€‹è«‹æ±‚

### 3. ç”¨æˆ¶é«”é©—æ¸¬è©¦
- **è©è¡¨æ¨¡å¼ç”¨æˆ¶**ï¼šå•Ÿå‹•æ˜¯å¦æ›´å¿«ï¼Ÿ
- **AI æ¨¡å¼ç”¨æˆ¶**ï¼šä¸»é¡ŒåŠ è¼‰æ˜¯å¦é †æš¢ï¼Ÿ
- **ç¶²çµ¡æ…¢çš„ç’°å¢ƒ**ï¼šå„ªåŒ–æ•ˆæœæ˜¯å¦æ˜é¡¯ï¼Ÿ

---

## âœ… æª¢æŸ¥æ¸…å–®

- [x] ä¿®å¾©è©è¡¨æŸ¥è©¢ç¼ºå°‘ `code` å’Œ `type`
- [x] ç³»çµ±è©è¡¨å¾ JSON åŠ è¼‰æ¨™ç±¤
- [x] å„ªåŒ– screens.js çš„é‡è¤‡æŸ¥è©¢é‚è¼¯
- [x] ~~å»¶é²åŠ è¼‰ä¸»é¡Œåˆ°éœ€è¦æ™‚~~ï¼ˆå·²æ’¤å›ï¼Œå…©ç¨®æ¨¡å¼éƒ½éœ€è¦ä¸»é¡Œï¼‰
- [ ] æ¸¬è©¦å•Ÿå‹•é€Ÿåº¦ï¼ˆç”¨æˆ¶é©—è­‰ï¼‰
- [ ] ç›£æ§ Supabase æŸ¥è©¢æ¬¡æ•¸
- [ ] ç¢ºèªä¸åŒç¶²çµ¡ç’°å¢ƒä¸‹çš„æ•ˆæœ

---

## ğŸ“ å¾ŒçºŒå„ªåŒ–æ–¹å‘

### 1. é åŠ è¼‰ç­–ç•¥
- åœ¨ç©ºé–’æ™‚é åŠ è¼‰å¸¸ç”¨è©è¡¨
- ä½¿ç”¨ Service Worker ç·©å­˜ JSON æ–‡ä»¶

### 2. ä¸¦è¡ŒåŠ è¼‰
- ç”¨æˆ¶æª”æ¡ˆå’Œè©è¡¨ä¿¡æ¯å¯ä»¥ä¸¦è¡ŒæŸ¥è©¢
- ä½¿ç”¨ `Promise.all()` æ¸›å°‘ç¸½ç­‰å¾…æ™‚é–“

### 3. é€²åº¦æŒ‡ç¤º
- é¡¯ç¤ºåŠ è¼‰é€²åº¦æ¢
- æä¾›è¦–è¦ºåé¥‹ï¼Œæ¸›å°‘ç­‰å¾…ç„¦æ…®

---

**å„ªåŒ–æ—¥æœŸ**ï¼š2025-10-18  
**å½±éŸ¿æ–‡ä»¶**ï¼š
- `story-vocab/js/auth/standalone-auth.js`ï¼ˆå·²å„ªåŒ–ï¼‰
- `story-vocab/js/ui/screens.js`ï¼ˆå·²å„ªåŒ–ï¼‰

**å¯¦éš›å„ªåŒ–é …ç›®**ï¼š
1. âœ… ä¿®å¾©è©è¡¨æŸ¥è©¢ç¼ºå°‘ `code` å’Œ `type`ï¼ˆæ¸›å°‘ 1 æ¬¡æŸ¥è©¢ï¼‰
2. âœ… ç³»çµ±è©è¡¨å¾ JSON åŠ è¼‰æ¨™ç±¤ï¼ˆæ¸›å°‘ 1 æ¬¡æŸ¥è©¢ï¼‰
3. âœ… å„ªåŒ–é‡è¤‡æŸ¥è©¢é‚è¼¯
4. âŒ å»¶é²åŠ è¼‰ä¸»é¡Œï¼ˆå·²æ’¤å›ï¼Œç¶“ç”¨æˆ¶æŒ‡æ­£å…©ç¨®æ¨¡å¼éƒ½éœ€è¦ä¸»é¡Œï¼‰

**æ¸¬è©¦ç‹€æ…‹**ï¼šå¾…ç”¨æˆ¶é©—è­‰

