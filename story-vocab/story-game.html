<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö ÊïÖ‰∫ãË©ûÂΩôÊé•Èæç - ËàáAIÂÖ±ÂâµÁ≤æÂΩ©ÊïÖ‰∫ã</title>
    <style>
        /* ===== Âü∫Á°ÄÊ†∑Âºè ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #FF69B4;
            --primary-blue: #4A90E2;
            --primary-yellow: #FFD700;
            --primary-purple: #9B59B6;
            --primary-green: #2ECC71;
            --light-pink: #FFE4F0;
            --light-blue: #E3F2FD;
            --light-yellow: #FFF9E6;
            --text-dark: #333;
            --text-light: #666;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        /* ===== È°µÈù¢ÂàáÊç¢ ===== */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== ÈÄöÁî®ÁªÑ‰ª∂ ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-pink), var(--primary-purple));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        button {
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-pink), var(--primary-purple));
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-green));
            color: white;
        }

        /* ===== ÂêØÂä®ÁïåÈù¢ ===== */
        .level-selector {
            margin: 30px 0;
        }

        .level-selector h2,
        .theme-selector h2 {
            color: var(--text-dark);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .level-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .level-card {
            background: var(--light-blue);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-card:hover {
            transform: scale(1.05);
            border-color: var(--primary-blue);
        }

        .level-card.selected {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, var(--light-blue), var(--light-pink));
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .level-card input[type="radio"] {
            display: none;
        }

        .level-card .level-name {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }

        .level-card .level-desc {
            font-size: 0.9em;
            color: var(--text-light);
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .theme-btn {
            background: white;
            border: 3px solid var(--light-pink);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .theme-btn:hover {
            transform: scale(1.05);
        }

        .theme-btn.selected {
            border-color: var(--primary-pink);
            background: linear-gradient(135deg, var(--light-pink), var(--light-yellow));
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
        }

        .theme-btn .emoji {
            font-size: 2.5em;
            display: block;
            margin-bottom: 10px;
        }

        .start-button-container {
            text-align: center;
            margin-top: 40px;
        }

        /* ===== Ê∏∏ÊàèÁïåÈù¢ ===== */
        .game-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-green));
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-info {
            font-size: 1.2em;
            font-weight: bold;
        }

        .level-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .story-display {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 30px;
            background: var(--light-blue);
            border-radius: 15px;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.ai {
            background: white;
            border-left: 4px solid var(--primary-blue);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .message.user {
            background: linear-gradient(135deg, var(--light-pink), var(--light-yellow));
            border-left: 4px solid var(--primary-pink);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .message-label {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-label.ai {
            color: var(--primary-blue);
        }

        .message-label.user {
            color: var(--primary-pink);
        }

        .message-content {
            line-height: 2;
            font-size: 1.3em;
            color: var(--text-dark);
        }

        .clickable-word {
            color: var(--primary-purple);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            padding: 2px 6px;
            border-radius: 6px;
            background: rgba(155, 89, 182, 0.1);
            border-bottom: 2px solid var(--primary-purple);
        }

        .clickable-word:hover {
            color: white;
            background: var(--primary-purple);
            transform: translateY(-2px);
        }
        
        .highlighted-word {
            color: var(--primary-pink);
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 6px;
            background: rgba(255, 105, 180, 0.15);
            border-bottom: 3px solid var(--primary-pink);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .highlighted-word:hover {
            color: white;
            background: var(--primary-pink);
            transform: translateY(-2px);
        }
        
        /* ÊâìÂ≠óÊú∫ÊïàÊûú */
        @keyframes typing {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .typing-char {
            animation: typing 0.1s ease-in;
        }

        .word-choices-section {
            margin-bottom: 30px;
        }

        .word-choices-section h3 {
            color: var(--text-dark);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .word-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .word-btn {
            background: white;
            border: 3px solid var(--light-pink);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-dark);
            position: relative;
        }

        .word-btn:hover {
            transform: translateY(-5px);
            border-color: var(--primary-pink);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.3);
        }

        .word-btn.selected {
            background: linear-gradient(135deg, var(--primary-pink), var(--primary-purple));
            color: white;
            border-color: var(--primary-pink);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
        }

        .word-meta {
            font-size: 0.7em;
            color: var(--text-light);
            margin-top: 5px;
        }

        .word-btn.selected .word-meta {
            color: rgba(255, 255, 255, 0.9);
        }

        .user-input-section {
            background: var(--light-yellow);
            border-radius: 15px;
            padding: 25px;
        }

        .user-input-section h3 {
            color: var(--text-dark);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .selected-word-display {
            background: white;
            border-left: 4px solid var(--primary-yellow);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--text-dark);
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            padding: 15px 20px;
            border: 3px solid var(--light-blue);
            border-radius: 50px;
            font-size: 1.1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            border-color: var(--primary-blue);
        }

        .input-group button {
            padding: 15px 35px;
        }

        /* ===== ÂÆåÊàêÁïåÈù¢ ===== */
        .finish-content {
            text-align: center;
        }

        .celebration {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .finish-content h2 {
            color: var(--primary-purple);
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .story-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--light-blue), var(--light-pink));
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            color: var(--text-light);
        }

        .full-story-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .full-story-container h3 {
            color: var(--primary-purple);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .full-story-text {
            line-height: 2;
            font-size: 1.2em;
            color: var(--text-dark);
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        /* ===== ËØçÊ±áËØ¶ÊÉÖÂºπÁ™ó ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-pink);
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--primary-pink);
            color: white;
            transform: rotate(90deg);
        }

        .word-detail-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .word-detail-header h2 {
            font-size: 3em;
            color: var(--primary-purple);
            margin-bottom: 10px;
        }

        .word-detail-header .pinyin {
            font-size: 1.5em;
            color: var(--text-light);
        }

        .word-detail-section {
            margin-bottom: 25px;
        }

        .word-detail-section h3 {
            color: var(--primary-blue);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .word-detail-section .content {
            background: var(--light-blue);
            padding: 20px;
            border-radius: 10px;
            line-height: 2;
            font-size: 1.1em;
            white-space: pre-line;
            max-height: 300px;
            overflow-y: auto;
        }

        .add-to-wordbook-btn {
            width: 100%;
            margin-top: 20px;
        }

        /* ===== Âä†ËΩΩÂä®Áîª ===== */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--light-blue);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1.2em;
            color: var(--text-light);
        }

        /* ===== ÁîüËØçÊú¨ÊåâÈíÆ ===== */
        .wordbook-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-yellow), var(--primary-pink));
            color: white;
            font-size: 1.5em;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .wordbook-button:hover {
            transform: scale(1.1);
        }

        .wordbook-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary-pink);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* ===== ÂìçÂ∫îÂºèËÆæËÆ° ===== */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }

            .level-options {
                grid-template-columns: 1fr;
            }

            .word-choices {
                grid-template-columns: repeat(2, 1fr);
            }

            .input-group {
                flex-direction: column;
            }

            .input-group button {
                width: 100%;
            }

            .story-stats {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        /* ===== ÊèêÁ§∫Ê∂àÊÅØ ===== */
        .toast {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-green);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toast.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===== ÂêØÂä®ÁïåÈù¢ ===== -->
        <div id="start-screen" class="screen active">
            <div class="header">
                <h1>üìö ÊïÖ‰∫ãË©ûÂΩôÊé•Èæç</h1>
                <p>ËàáAIÂÖ±ÂâµÁ≤æÂΩ©ÊïÖ‰∫ãÔºåËºïÈ¨ÜÁ©çÁ¥ØË©ûÂΩô</p>
            </div>
            <div class="content">
                <div class="level-selector">
                    <h2>üéØ ÈÅ∏Êìá‰Ω†ÁöÑÁ¥öÂà•Ôºö</h2>
                    <div class="level-options">
                        <label class="level-card">
                            <input type="radio" name="level" value="L1">
                            <div class="level-name">L1 ÂïüËíô</div>
                            <div class="level-desc">2-3Âπ¥Á¥ö | Á∞°ÂñÆË©ûÂΩô</div>
                        </label>
                        <label class="level-card selected">
                            <input type="radio" name="level" value="L2" checked>
                            <div class="level-name">L2 ÂàùÁ¥ö</div>
                            <div class="level-desc">3-4Âπ¥Á¥ö | ÂÆπÊòìË©ûÂΩô</div>
                        </label>
                        <label class="level-card">
                            <input type="radio" name="level" value="L3">
                            <div class="level-name">L3 ÈÄ≤Èöé</div>
                            <div class="level-desc">4-5Âπ¥Á¥ö | ‰∏≠Á≠âË©ûÂΩô</div>
                        </label>
                        <label class="level-card">
                            <input type="radio" name="level" value="L4">
                            <div class="level-name">L4 È´òÁ¥ö</div>
                            <div class="level-desc">5-6Âπ¥Á¥ö | ËºÉÈõ£Ë©ûÂΩô</div>
                        </label>
                        <label class="level-card">
                            <input type="radio" name="level" value="L5">
                            <div class="level-name">L5 Á≤æÈÄö</div>
                            <div class="level-desc">Âàù‰∏≠ | È´òÁ¥öË©ûÂΩô</div>
                        </label>
                        <label class="level-card">
                            <input type="radio" name="level" value="L6">
                            <div class="level-name">L6 Â§ßÂ∏´</div>
                            <div class="level-desc">È´ò‰∏≠ | ÊñáÂ≠∏Ë©ûÂΩô</div>
                        </label>
                    </div>
                </div>

                <div class="theme-selector">
                    <h2>üé≠ ÈÅ∏ÊìáÊïÖ‰∫ã‰∏ªÈ°åÔºö</h2>
                    <div class="theme-buttons">
                        <button class="theme-btn selected" data-theme="nature">
                            <span class="emoji">üå≥</span>
                            Ëá™ÁÑ∂Êé¢Á¥¢
                        </button>
                        <button class="theme-btn" data-theme="campus">
                            <span class="emoji">üè´</span>
                            Ê†°ÂúíÁîüÊ¥ª
                        </button>
                        <button class="theme-btn" data-theme="fantasy">
                            <span class="emoji">‚ú®</span>
                            Â•áÂπªÂÜíÈö™
                        </button>
                        <button class="theme-btn" data-theme="scifi">
                            <span class="emoji">üöÄ</span>
                            ÁßëÂπªÊú™‰æÜ
                        </button>
                    </div>
                </div>

                <div class="start-button-container">
                    <button class="btn-primary" onclick="startGame()">ÈñãÂßãÂâµ‰ΩúÊïÖ‰∫ã ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- ===== Ê∏∏ÊàèÁïåÈù¢ ===== -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="progress-info">
                    Á¨¨ <span id="turn-count">1</span>/18 Ëº™
                </div>
                <div class="level-info">
                    <span id="current-level">L2</span> ¬∑ <span id="current-theme">Ëá™ÁÑ∂Êé¢Á¥¢</span>
                </div>
            </div>
            <div class="content">
                <!-- ÊïÖ‰∫ãÊòæÁ§∫Âå∫Âüü -->
                <div class="story-display" id="story-display">
                    <div class="message ai">
                        <div class="message-label ai">ü§ñ AI ÊïÖ‰∫ãÂÆ∂</div>
                        <div class="message-content">Ê≠£Âú®ÊßãÊÄùÊïÖ‰∫ãÈñãÈ†≠...</div>
                    </div>
                </div>

                <!-- ËØçÊ±áÈÄâÊã©Âå∫Âüü -->
                <div class="word-choices-section">
                    <h3>üí° Ë´ãÈÅ∏Êìá‰∏ÄÂÄãË©û‰æÜÈÄ†Âè•Ôºö</h3>
                    <div class="word-choices" id="word-choices">
                        <!-- ËØçÊ±áÊåâÈíÆÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>

                <!-- Áî®Êà∑ËæìÂÖ•Âå∫Âüü -->
                <div class="user-input-section">
                    <h3>‚úçÔ∏è Ââµ‰Ωú‰Ω†ÁöÑÂè•Â≠êÔºö</h3>
                    <div class="selected-word-display" id="selected-word-display">
                        Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãË©ûÂΩô...
                    </div>
                    <div class="input-group">
                        <input type="text" id="user-input" placeholder="Áî®ÈÅ∏‰∏≠ÁöÑË©ûÂØ´‰∏ÄÂÄãÂè•Â≠êÔºåÁπºÁ∫åÊïÖ‰∫ã..." disabled>
                        <button class="btn-secondary" onclick="submitSentence()" disabled id="submit-btn">ÁôºÈÄÅ ‚Üí</button>
                    </div>
                </div>

                <!-- Âä†ËΩΩÂä®Áîª -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">AI Ê≠£Âú®Ââµ‰Ωú‰∏≠...</div>
                </div>
            </div>
        </div>

        <!-- ===== ÂÆåÊàêÁïåÈù¢ ===== -->
        <div id="finish-screen" class="screen">
            <div class="header">
                <h1>üéâ ÊïÖ‰∫ãÂâµ‰ΩúÂÆåÊàêÔºÅ</h1>
                <p>‰Ω†ÂíåAI‰∏ÄËµ∑Ââµ‰Ωú‰∫Ü‰∏ÄÂÄãÁ≤æÂΩ©ÁöÑÊïÖ‰∫ã</p>
            </div>
            <div class="content finish-content">
                <div class="celebration">üéä</div>
                <h2>Â§™Ê£í‰∫ÜÔºÅ</h2>

                <div class="story-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-turns">18</div>
                        <div class="stat-label">Ââµ‰ΩúËº™Ê¨°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="vocab-used">9</div>
                        <div class="stat-label">‰ΩøÁî®Ë©ûÂΩô</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="story-length">0</div>
                        <div class="stat-label">ÊïÖ‰∫ãÂ≠óÊï∏</div>
                    </div>
                </div>

                <div class="full-story-container">
                    <h3>üìñ ÂÆåÊï¥ÊïÖ‰∫ã</h3>
                    <div class="full-story-text" id="full-story-text">
                        <!-- ÂÆåÊï¥ÊïÖ‰∫ãÊñáÊú¨Â∞ÜÈÄöËøá JavaScript ÁîüÊàê -->
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" onclick="restartGame()">üîÑ ÂÜçÁé©‰∏ÄÊ¨°</button>
                    <button class="btn-secondary" onclick="shareStory()">üì§ ÂàÜ‰∫´ÊïÖ‰∫ã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ËØçÊ±áËØ¶ÊÉÖÂºπÁ™ó ===== -->
    <div id="word-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeWordModal()">√ó</button>
            <div class="word-detail-header">
                <h2 id="modal-word">Ë©ûÂΩô</h2>
                <div class="pinyin" id="modal-pinyin">pinyin</div>
            </div>
            <div class="word-detail-section">
                <h3>üåç Ëã±ÊñáÁøªË≠Ø</h3>
                <div class="content" id="modal-translation">ËºâÂÖ•‰∏≠...</div>
            </div>
            <div class="word-detail-section">
                <h3>üìñ ÈáãÁæ©</h3>
                <div class="content" id="modal-definition">ËºâÂÖ•‰∏≠...</div>
            </div>
            <div class="word-detail-section">
                <h3>üìù ‰æãÂè•</h3>
                <div class="content" id="modal-example">ËºâÂÖ•‰∏≠...</div>
            </div>
            <button class="btn-primary add-to-wordbook-btn" onclick="addToWordbook()">‚≠ê Êî∂ËóèÂà∞ÁîüË©ûÊú¨</button>
        </div>
    </div>

    <!-- ===== ÁîüËØçÊú¨ÊåâÈíÆ ===== -->
    <button class="wordbook-button" onclick="openWordbook()" title="ÊàëÁöÑÁîüË©ûÊú¨">
        üìö
        <span class="wordbook-count" id="wordbook-count">0</span>
    </button>

    <!-- ===== ÊèêÁ§∫Ê∂àÊÅØ ===== -->
    <div id="toast" class="toast"></div>

    <!-- ===== JavaScript ===== -->
    <script>
        // Èò≤Ê≠¢Á¨¨‰∏âÊñπËÖ≥Êú¨ÈåØË™§ÂΩ±ÈüøÊáâÁî®
        window.addEventListener('error', function(e) {
            // Â¶ÇÊûúÈåØË™§‰æÜËá™Á¨¨‰∏âÊñπËÖ≥Êú¨ÔºåÈùúÈªòËôïÁêÜ
            if (e.filename && (e.filename.includes('extension') || e.filename.includes('content-script'))) {
                e.preventDefault();
                return true;
            }
        }, true);
        
        // ÊçïÁç≤ Promise ÈåØË™§
        window.addEventListener('unhandledrejection', function(e) {
            // Ë®òÈåÑ‰ΩÜ‰∏ç‰∏≠Êñ∑ÊáâÁî®
            console.warn('Promise rejection:', e.reason);
        });
    </script>
    <script type="module">
        // ÂØºÂÖ•ÈÖçÁΩÆÂíåÂÆ¢Êà∑Á´Ø
        import { initSupabase, getSupabase, signInAnonymously, getRecommendedVocabulary, recordVocabularyUsage, addToWordbook, getUserWordbook, callStoryAgent, createStorySession, updateStorySession, completeStorySession } from './js/supabase-client.js';
        import { SUPABASE_CONFIG } from './js/config.js';

        // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´Ø
        let supabase = null;
        
        // ÂºÇÊ≠•ÂàùÂßãÂåñ
        async function initializeApp() {
            try {
                supabase = await initSupabase();
                console.log('‚úÖ Supabase ÂÆ¢Êà∂Á´ØÂàùÂßãÂåñÊàêÂäü');
                
                // ÂåøÂêçÁôªÈåÑ
                const user = await signInAnonymously();
                gameState.userId = user.id;
                console.log('‚úÖ Áî®Êà∂ÁôªÈåÑÊàêÂäü:', gameState.userId);
                
                console.log('‚úÖ ÊáâÁî®ÂàùÂßãÂåñÂÆåÊàê');
                // ÊáâÁî®Â∑≤Ê∫ñÂÇôÂ∞±Á∑íÔºåÁ≠âÂæÖÁî®Êà∂ÈñãÂßãÈÅäÊà≤
            } catch (error) {
                console.error('‚ùå ÊáâÁî®ÂàùÂßãÂåñÂ§±Êïó:', error);
                showToast('ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÂà∑Êñ∞È†ÅÈù¢ÈáçË©¶');
            }
        }

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            level: 'L2',
            theme: 'nature',
            turn: 1,
            maxTurns: 18,
            storyHistory: [],
            sessionId: null,
            userId: null,  // Â∞ÜÂú®ÂåøÂêçÁôªÂΩïÂêéËÆæÁΩÆ
            selectedWord: null,
            currentWords: [],
            usedWords: [],
            allRecommendedWords: []  // ‰øùÂ≠òÊØèËº™ÁöÑÊé®Ëñ¶Ë©ûÂΩôÂàóË°®
        };

        // ÁîüË©ûÊú¨
        let wordbook = JSON.parse(localStorage.getItem('story_wordbook') || '[]');
        updateWordbookCount();

        // ===== È†ÅÈù¢ÂàáÊèõÂáΩÊï∏ =====
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // ===== È°ØÁ§∫ÊèêÁ§∫Ê∂àÊÅØ =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // ===== ÂïüÂãïÁïåÈù¢‰∫§‰∫í =====
        // Á¥öÂà•ÈÅ∏Êìá
        document.querySelectorAll('.level-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });

        // ‰∏ªÈ°åÈÅ∏Êìá
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // ===== ÈñãÂßãÈÅäÊà≤ =====
        window.startGame = async function() {
            // Á¢∫‰øùÁî®Êà∂Â∑≤ÁôªÈåÑ
            if (!gameState.userId) {
                showToast('Ê≠£Âú®ÂàùÂßãÂåñÔºåË´ãÁ®çÂÄô...');
                return;
            }
            
            const level = document.querySelector('input[name="level"]:checked').value;
            const theme = document.querySelector('.theme-btn.selected').dataset.theme;
            
            gameState.level = level;
            gameState.theme = theme;
            gameState.turn = 1;
            gameState.storyHistory = [];
            gameState.usedWords = [];
            gameState.allRecommendedWords = [];
            gameState.sessionId = null;
            
            // Êõ¥Êñ∞ÈÅäÊà≤ÁïåÈù¢‰ø°ÊÅØ
            document.getElementById('current-level').textContent = level;
            document.getElementById('current-theme').textContent = getThemeName(theme);
            document.getElementById('turn-count').textContent = '1';
            
            // Ê∏ÖÁ©∫ÊïÖ‰∫ãÈ°ØÁ§∫ÂçÄÂüü
            document.getElementById('story-display').innerHTML = '';
            
            showScreen('game-screen');
            
            try {
                // ÂâµÂª∫Êï∏ÊìöÂ∫´ÊúÉË©±Ë®òÈåÑ
                showLoading(true);
                const themeMapping = {
                    'nature': 'natural_exploration',
                    'campus': 'school_life',
                    'fantasy': 'fantasy_adventure',
                    'scifi': 'sci_fi'
                };
                
                const session = await createStorySession(gameState.userId, {
                    theme: themeMapping[theme] || theme,
                    choice: 'ÈñãÂßãÊïÖ‰∫ã',
                    variant: 1,
                    maxRounds: gameState.maxTurns
                });
                
                gameState.sessionId = session.id;
                console.log('‚úÖ ÊúÉË©±ÂâµÂª∫ÊàêÂäü:', gameState.sessionId);
                
                // ÈñãÂßãÁç≤Âèñ AI ÈüøÊáâ
                await getAIResponse();
            } catch (error) {
                console.error('‚ùå ÂâµÂª∫ÊúÉË©±Â§±Êïó:', error);
                showToast('ÂïüÂãïÈÅäÊà≤Â§±ÊïóÔºåË´ãÈáçË©¶');
                showLoading(false);
            }
        };

        // ===== Áç≤Âèñ‰∏ªÈ°å‰∏≠ÊñáÂêç =====
        function getThemeName(theme) {
            const names = {
                nature: 'Ëá™ÁÑ∂Êé¢Á¥¢',
                campus: 'Ê†°ÂúíÁîüÊ¥ª',
                fantasy: 'Â•áÂπªÂÜíÈö™',
                scifi: 'ÁßëÂπªÊú™‰æÜ'
            };
            return names[theme] || theme;
        }

        // ===== Ë∞ÉÁî® AI Agent =====
        async function getAIResponse(userSentence = '', selectedWord = '') {
            showLoading(true);
            
            try {
                // Á¢∫‰øùÊúÉË©± ID Â≠òÂú®
                if (!gameState.sessionId) {
                    throw new Error('ÊúÉË©±Êú™ÂàùÂßãÂåñ');
                }
                
                // ËΩâÊèõÁ¥öÂà•Ê†ºÂºè (L2 -> 2)
                const userLevel = parseFloat(gameState.level.replace('L', ''));
                
                // ËΩâÊèõ‰∏ªÈ°åÊ†ºÂºè‰ª•ÂåπÈÖç Edge Function ÊúüÊúõÁöÑÂÄº
                const themeMapping = {
                    'nature': 'natural_exploration',
                    'campus': 'school_life',
                    'fantasy': 'fantasy_adventure',
                    'scifi': 'sci_fi'
                };
                const storyTheme = themeMapping[gameState.theme] || gameState.theme;
                
                // ÊßãÂª∫Â∞çË©±Ê≠∑Âè≤ÔºàÂè™ÂåÖÂê´ÊñáÊú¨Ôºâ
                const conversationHistory = gameState.storyHistory.map(entry => entry.sentence);
                
                // ÁôºÈÄÅË´ãÊ±ÇÂà∞ Edge FunctionÔºå‰ΩøÁî®Ê≠£Á¢∫ÁöÑÂèÉÊï∏Âêç
                const requestBody = {
                    userSentence: userSentence || 'ÈñãÂßãÊïÖ‰∫ã',  // Á¨¨‰∏ÄÊ¨°Ë™øÁî®ÊôÇ‰ΩøÁî®ÈªòË™çÂÄº
                    selectedWord: selectedWord,
                    sessionId: gameState.sessionId,
                    conversationHistory: conversationHistory,
                    userLevel: userLevel,
                    storyTheme: storyTheme,
                    currentRound: gameState.turn - 1  // Ëº™Ê¨°Âæû 0 ÈñãÂßã
                };
                
                console.log('üì§ ÁôºÈÄÅË´ãÊ±Ç:', requestBody);
                
                const response = await fetch(
                    `${SUPABASE_CONFIG.url}/functions/v1/story-agent`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
                        },
                        body: JSON.stringify(requestBody)
                    }
                );
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API ÈåØË™§ÈüøÊáâ:', errorText);
                    throw new Error(`API Ë´ãÊ±ÇÂ§±Êïó: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('üì• AI ÈüøÊáâ:', result);
                
                // Ê™¢Êü•ÊòØÂê¶ÊàêÂäü
                if (!result.success) {
                    throw new Error(result.error || 'AI Ë™øÁî®Â§±Êïó');
                }
                
                const data = result.data;
                
                // Ê∑ªÂä†Âà∞Ê≠∑Âè≤
                gameState.storyHistory.push({
                    role: 'ai',
                    sentence: data.aiSentence
                });
                
                // ‰øùÂ≠òÊé®Ëñ¶Ë©ûÂΩô
                gameState.currentWords = data.recommendedWords || [];
                
                // È°ØÁ§∫ AI ÈüøÊáâ
                displayAIResponse(data);
                
            } catch (error) {
                console.error('AI Ë™øÁî®Â§±Êïó:', error);
                showToast('‚ùå AI Ë™øÁî®Â§±ÊïóÔºö' + error.message);
                showLoading(false);
            }
        }

        // ===== ÊâìÂ≠óÊ©üÊïàÊûúÈ°ØÁ§∫ÊñáÊú¨ =====
        async function typewriterEffect(element, text, delay = 20) {
            element.innerHTML = '';
            const storyDisplay = document.getElementById('story-display');
            
            for (let i = 0; i < text.length; i++) {
                const char = text.charAt(i);
                const span = document.createElement('span');
                span.className = 'typing-char';
                span.textContent = char;
                element.appendChild(span);
                
                // ÊØèÈ°ØÁ§∫ÂπæÂÄãÂ≠óÁ¨¶Â∞±ÊªæÂãï‰∏ÄÊ¨°
                if (i % 5 === 0) {
                    storyDisplay.scrollTop = storyDisplay.scrollHeight;
                }
                
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            // ÊúÄÂæåÁ¢∫‰øùÊªæÂãïÂà∞Â∫ïÈÉ®
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
        }

        // ===== È°ØÁ§∫ AI ÈüøÊáâ =====
        async function displayAIResponse(data) {
            showLoading(false);
            
            // Ê∑ªÂä† AI Ê∂àÊÅØÂà∞ÊïÖ‰∫ãÈ°ØÁ§∫ÂçÄÂüü
            const storyDisplay = document.getElementById('story-display');
            const aiMessage = document.createElement('div');
            aiMessage.className = 'message ai';
            aiMessage.innerHTML = `
                <div class="message-label ai">ü§ñ AI ÊïÖ‰∫ãÂÆ∂</div>
                <div class="message-content"></div>
            `;
            storyDisplay.appendChild(aiMessage);
            
            const messageContent = aiMessage.querySelector('.message-content');
            
            // ÂÖàÁî®ÊâìÂ≠óÊ©üÊïàÊûúÈ°ØÁ§∫Á¥îÊñáÊú¨
            await typewriterEffect(messageContent, data.aiSentence, 30);
            
            // ‰øùÂ≠òÊé®Ëñ¶Ë©ûÂΩôÂà∞ÈÅäÊà≤ÁãÄÊÖã
            gameState.currentWords = data.recommendedWords || [];
            gameState.allRecommendedWords.push(data.recommendedWords || []);
            
            // ÁÑ∂ÂæåÊõøÊèõÁÇ∫ÂèØÈªûÊìäÁöÑË©ûË™ûÁâàÊú¨
            messageContent.innerHTML = makeAIWordsClickable(data.aiSentence, data.recommendedWords);
            
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
            
            // È°ØÁ§∫Ë©ûÂΩôÈÅ∏È†Ö
            const wordsContainer = document.getElementById('word-choices');
            wordsContainer.innerHTML = '';
            
            if (data.recommendedWords && data.recommendedWords.length > 0) {
                data.recommendedWords.forEach(wordObj => {
                    const wordBtn = document.createElement('button');
                    wordBtn.className = 'word-btn';
                    wordBtn.innerHTML = `
                        <div>${wordObj.word}</div>
                        <div class="word-meta">${wordObj.pinyin || ''}</div>
                    `;
                    wordBtn.onclick = () => selectWord(wordObj);
                    wordsContainer.appendChild(wordBtn);
                });
            }
            
            // ÈáçÁΩÆËº∏ÂÖ•
            gameState.selectedWord = null;
            document.getElementById('selected-word-display').textContent = 'Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãË©ûÂΩô...';
            document.getElementById('user-input').value = '';
            document.getElementById('user-input').disabled = true;
            document.getElementById('submit-btn').disabled = true;
        }

        // ===== AIÂè•Â≠ê‰∏≠Ê®ôË®òË©ûÂ∫´‰∏≠ÁöÑË©ûË™ûÔºàÂèØÈªûÊìäÊü•Ë©¢Ôºâ =====
        function makeAIWordsClickable(text, recommendedWords) {
            if (!text) return '';
            
            // ÂæûÊé®Ëñ¶Ë©ûÂ∫´‰∏≠ÊèêÂèñÊâÄÊúâË©ûË™û
            const vocabularyWords = recommendedWords ? recommendedWords.map(w => w.word) : [];
            
            // ÊåâÈï∑Â∫¶ÈôçÂ∫èÊéíÂ∫èÔºåÂÑ™ÂÖàÂåπÈÖçÈï∑Ë©û
            vocabularyWords.sort((a, b) => b.length - a.length);
            
            let result = text;
            const replacements = [];
            
            // ÊâæÂá∫ÊâÄÊúâË©ûÂ∫´‰∏≠ÁöÑË©ûË™û‰ΩçÁΩÆ
            vocabularyWords.forEach(word => {
                let index = 0;
                while ((index = result.indexOf(word, index)) !== -1) {
                    // Ê™¢Êü•ÊòØÂê¶ËàáÂ∑≤ÊúâÊõøÊèõÈáçÁñä
                    const overlaps = replacements.some(r => 
                        (index >= r.start && index < r.end) || 
                        (index + word.length > r.start && index + word.length <= r.end)
                    );
                    
                    if (!overlaps) {
                        replacements.push({
                            start: index,
                            end: index + word.length,
                            word: word
                        });
                    }
                    index += word.length;
                }
            });
            
            // Êåâ‰ΩçÁΩÆÊéíÂ∫è
            replacements.sort((a, b) => a.start - b.start);
            
            // ÊßãÂª∫ÁµêÊûúÂ≠óÁ¨¶‰∏≤
            let finalResult = '';
            let lastIndex = 0;
            
            replacements.forEach(replacement => {
                finalResult += text.substring(lastIndex, replacement.start);
                finalResult += `<span class="clickable-word" onclick="showWordDetailFromVocab('${replacement.word}')">${replacement.word}</span>`;
                lastIndex = replacement.end;
            });
            
            finalResult += text.substring(lastIndex);
            
            return finalResult;
        }
        
        // ===== Áî®Êà∂Âè•Â≠ê‰∏≠Ê®ôË®òÈÅ∏‰∏≠ÁöÑË©ûË™ûÔºàÂèØÈªûÊìäÊü•Ë©¢Ôºâ =====
        function makeUserSentenceClickable(text, selectedWord) {
            if (!text || !selectedWord) return text;
            
            // ÊâæÂà∞Áî®Êà∂ÈÅ∏ÊìáÁöÑË©ûË™û‰∏¶È´ò‰∫Æ
            const word = selectedWord.word;
            let result = text;
            const index = result.indexOf(word);
            
            if (index !== -1) {
                result = result.substring(0, index) + 
                         `<span class="highlighted-word" onclick="showWordDetailFromVocab('${word}')">${word}</span>` + 
                         result.substring(index + word.length);
            }
            
            return result;
        }

        // ===== ÈÅ∏ÊìáË©ûÂΩô =====
        window.selectWord = function(wordObj) {
            gameState.selectedWord = wordObj;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.word-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.closest('.word-btn').classList.add('selected');
            
            // Êõ¥Êñ∞È°ØÁ§∫
            document.getElementById('selected-word-display').innerHTML = `
                Â∑≤ÈÅ∏Ë©ûÂΩôÔºö<strong>${wordObj.word}</strong> (${wordObj.pinyin || ''})
            `;
            
            // ÂïüÁî®Ëº∏ÂÖ•
            document.getElementById('user-input').disabled = false;
            document.getElementById('user-input').focus();
            document.getElementById('submit-btn').disabled = false;
        };

        // ===== Êèê‰∫§Âè•Â≠ê =====
        window.submitSentence = async function() {
            const input = document.getElementById('user-input');
            const sentence = input.value.trim();
            
            if (!sentence) {
                showToast('Ë´ãËº∏ÂÖ•Âè•Â≠êÔºÅ');
                return;
            }
            
            if (!gameState.selectedWord) {
                showToast('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãË©ûÂΩôÔºÅ');
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶‰ΩøÁî®‰∫ÜÈÅ∏‰∏≠ÁöÑË©û
            if (!sentence.includes(gameState.selectedWord.word)) {
                showToast(`Ë´ãÂú®Âè•Â≠ê‰∏≠‰ΩøÁî®Ë©ûÂΩôÔºö${gameState.selectedWord.word}`);
                return;
            }
            
            // Ë®òÈåÑ‰ΩøÁî®ÁöÑË©ûÂΩô
            const usedWord = gameState.selectedWord;
            gameState.usedWords.push(usedWord);
            
            // Ê∑ªÂä†Âà∞Ê≠∑Âè≤
            gameState.storyHistory.push({
                role: 'user',
                sentence: sentence,
                word_used: usedWord.word
            });
            
            // È°ØÁ§∫Áî®Êà∂Ê∂àÊÅØÔºåÈ´ò‰∫ÆÁî®Êà∂ÈÅ∏ÊìáÁöÑË©ûË™û
            const storyDisplay = document.getElementById('story-display');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.innerHTML = `
                <div class="message-label user">üë§ ‰Ω†</div>
                <div class="message-content">${makeUserSentenceClickable(sentence, usedWord)}</div>
            `;
            storyDisplay.appendChild(userMessage);
            storyDisplay.scrollTop = storyDisplay.scrollHeight;
            
            // Á¶ÅÁî®Ëº∏ÂÖ•
            document.getElementById('user-input').disabled = true;
            document.getElementById('submit-btn').disabled = true;
            
            // Â¢ûÂä†Ëº™Ê¨°
            gameState.turn++;
            document.getElementById('turn-count').textContent = gameState.turn;
            
            // Ê™¢Êü•ÊòØÂê¶ÂÆåÊàê
            if (gameState.turn > gameState.maxTurns) {
                setTimeout(() => {
                    finishStory();
                }, 1000);
            } else {
                // ÁπºÁ∫åÁç≤Âèñ AI ÈüøÊáâÔºåÂÇ≥ÈÅûÁî®Êà∂Âè•Â≠êÂíåÈÅ∏‰∏≠ÁöÑË©ûÂΩô
                await getAIResponse(sentence, gameState.selectedWord.word);
            }
        };

        // Ëº∏ÂÖ•Ê°ÜÂõûËªäÊèê‰∫§
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !this.disabled) {
                window.submitSentence();
            }
        });

        // ===== È°ØÁ§∫/Èö±ËóèËºâÂÖ•ÂãïÁï´ =====
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        // ===== ÂÆåÊàêÊïÖ‰∫ã =====
        function finishStory() {
            showScreen('finish-screen');
            
            // Ë®àÁÆóÁµ±Ë®àÊï∏Êìö
            const totalTurns = gameState.storyHistory.filter(h => h.role === 'user').length;
            const vocabUsed = gameState.usedWords.length;
            const fullStory = gameState.storyHistory.map(h => h.sentence).join('');
            const storyLength = fullStory.length;
            
            // Êõ¥Êñ∞È°ØÁ§∫
            document.getElementById('total-turns').textContent = totalTurns;
            document.getElementById('vocab-used').textContent = vocabUsed;
            document.getElementById('story-length').textContent = storyLength;
            
            // È°ØÁ§∫ÂÆåÊï¥ÊïÖ‰∫ã
            const fullStoryText = document.getElementById('full-story-text');
            fullStoryText.innerHTML = '';
            
            gameState.storyHistory.forEach((item, index) => {
                const p = document.createElement('p');
                p.style.marginBottom = '15px';
                p.style.lineHeight = '2';
                p.style.fontSize = '1.2em';
                
                if (item.role === 'ai') {
                    // AIÂè•Â≠êÔºöÊ®ôË®òÁï∂ÊôÇÊé®Ëñ¶ÁöÑË©ûÂΩôÔºà‰ΩøÁî®allRecommendedWordsÔºâ
                    const aiIndex = Math.floor(index / 2);
                    const recommendedWords = aiIndex < gameState.allRecommendedWords.length ? 
                        gameState.allRecommendedWords[aiIndex] : [];
                    p.innerHTML = `ü§ñ ${makeAIWordsClickable(item.sentence, recommendedWords)}`;
                } else {
                    // Áî®Êà∂Âè•Â≠êÔºöÈ´ò‰∫ÆÁî®Êà∂‰ΩøÁî®ÁöÑË©ûÂΩô
                    const userIndex = Math.floor((index - 1) / 2);
                    const usedWord = userIndex < gameState.usedWords.length ? 
                        gameState.usedWords[userIndex] : null;
                    p.innerHTML = `üë§ ${makeUserSentenceClickable(item.sentence, usedWord)}`;
                }
                fullStoryText.appendChild(p);
            });
        }

        // ===== ÈáçÊñ∞ÈñãÂßã =====
        window.restartGame = function() {
            showScreen('start-screen');
        };

        // ===== ÂàÜ‰∫´ÊïÖ‰∫ã =====
        window.shareStory = function() {
            const fullStory = gameState.storyHistory.map(h => h.sentence).join('');
            
            if (navigator.share) {
                navigator.share({
                    title: 'ÊàëÂíåAIÂâµ‰ΩúÁöÑÊïÖ‰∫ã',
                    text: fullStory
                }).catch(err => console.log('ÂàÜ‰∫´Â§±Êïó:', err));
            } else {
                // Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø
                navigator.clipboard.writeText(fullStory).then(() => {
                    showToast('‚úÖ ÊïÖ‰∫ãÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùøÔºÅ');
                }).catch(() => {
                    showToast('‚ùå Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω');
                });
            }
        };

        // ===== ÂæûË©ûÂ∫´‰∏≠Êü•Ë©¢Ë©ûÂΩôË©≥ÊÉÖÔºàÂÑ™ÂÖà‰ΩøÁî®Ë©ûÂ∫´Êï∏ÊìöÔºåÁÑ∂ÂæåË™øÁî®ËêåÂÖ∏Ôºâ =====
        window.showWordDetailFromVocab = async function(word) {
            const modal = document.getElementById('word-modal');
            modal.classList.add('active');
            
            document.getElementById('modal-word').textContent = word;
            document.getElementById('modal-pinyin').innerHTML = '<span style="color: var(--text-light);">üîÑ Êü•Ë©¢‰∏≠...</span>';
            document.getElementById('modal-translation').innerHTML = '<span style="color: var(--text-light);">Ê≠£Âú®Áç≤ÂèñËã±ÊñáÁøªË≠Ø...</span>';
            document.getElementById('modal-definition').innerHTML = '<span style="color: var(--text-light);">Ê≠£Âú®Áç≤ÂèñÈáãÁæ©...</span>';
            document.getElementById('modal-example').innerHTML = '<span style="color: var(--text-light);">Ê≠£Âú®Áç≤Âèñ‰æãÂè•...</span>';
            
            try {
                // Ê∏ÖÁêÜËêåÂÖ∏ÁâπÊÆäÊ®ôË®òÁ¨¶ËôüÁöÑÂáΩÊï∏
                function cleanMoedictText(text) {
                    if (!text) return '';
                    // ÁßªÈô§ËêåÂÖ∏ÁöÑÁâπÊÆäÊ®ôË®òÔºö`` ` `` ÈáçÈü≥Ê®ôË®ò„ÄÅ`~` ÈÄ£Êé•Á¨¶„ÄÅ`Ôøπ` `Ôøª` ÂàÜÈöîÁ¨¶Á≠â
                    return text.replace(/[`~ÔøπÔøª]/g, '').trim();
                }
                
                // È¶ñÂÖàÊ™¢Êü•ÊòØÂê¶Âú®Áï∂ÂâçÊé®Ëñ¶Ë©ûÂΩô‰∏≠
                const vocabWord = gameState.currentWords.find(w => w.word === word);
                
                if (vocabWord && vocabWord.pinyin) {
                    document.getElementById('modal-pinyin').textContent = vocabWord.pinyin;
                }
                
                // ÂêåÊôÇË™øÁî®ÂÖ©ÂÄãAPIÔºöÂúãË™ûËæ≠ÂÖ∏ÂíåÂÖ©Â≤∏Ë©ûÂÖ∏
                const promises = [];
                
                // 1. Ë™øÁî®ÂúãË™ûËæ≠ÂÖ∏ API Áç≤ÂèñË©≥Á¥∞‰ø°ÊÅØÔºàÈáãÁæ©„ÄÅ‰æãÂè•Ôºâ
                let mainApiUrl;
                if (word.length === 1) {
                    // ÂñÆÂ≠ó‰ΩøÁî® uni API
                    mainApiUrl = `https://www.moedict.tw/uni/${encodeURIComponent(word)}`;
                } else {
                    // Ë©ûË™û‰ΩøÁî® a API
                    mainApiUrl = `https://www.moedict.tw/a/${encodeURIComponent(word)}.json`;
                }
                promises.push(fetch(mainApiUrl).then(r => r.ok ? r.json() : null).catch(() => null));
                
                // 2. Ë™øÁî®ÂÖ©Â≤∏Ë©ûÂÖ∏ API Áç≤ÂèñËã±ÊñáÁøªË≠Ø
                const crossStraitApiUrl = `https://www.moedict.tw/c/${encodeURIComponent(word)}.json`;
                promises.push(fetch(crossStraitApiUrl).then(r => r.ok ? r.json() : null).catch(() => null));
                
                const [mainData, crossStraitData] = await Promise.all(promises);
                
                console.log('ËêåÂÖ∏ÂúãË™ûËæ≠ÂÖ∏APIËøîÂõû:', mainData);
                console.log('ËêåÂÖ∏ÂÖ©Â≤∏Ë©ûÂÖ∏APIËøîÂõû:', crossStraitData);
                
                // ËôïÁêÜÊãºÈü≥ÔºàÂÑ™ÂÖà‰ΩøÁî® bopomofo2 Êàñ pinyin Â≠óÊÆµÔºåÈÄô‰∫õÂåÖÂê´Êº¢Ë™ûÊãºÈü≥Ôºâ
                if (mainData && mainData.heteronyms && mainData.heteronyms[0] && !vocabWord) {
                    // ÂÑ™ÂÖà‰ΩøÁî® bopomofo2ÔºàÊº¢Ë™ûÊãºÈü≥Ê†ºÂºèÔºâÊàñ pinyin Â≠óÊÆµ
                    const pinyin = mainData.heteronyms[0].bopomofo2 || 
                                   mainData.heteronyms[0].pinyin || 
                                   mainData.heteronyms[0].bopomofo || '';
                    document.getElementById('modal-pinyin').textContent = pinyin || 'ÁÑ°ÊãºÈü≥';
                }
                
                // È°ØÁ§∫Ëã±ÊñáÁøªË≠Ø
                if (crossStraitData && crossStraitData.translation && crossStraitData.translation.English) {
                    const englishTranslations = crossStraitData.translation.English;
                    if (Array.isArray(englishTranslations) && englishTranslations.length > 0) {
                        // ÂèñÂâç5ÂÄãÁøªË≠Ø
                        const translationText = englishTranslations.slice(0, 5).join('; ');
                        document.getElementById('modal-translation').textContent = translationText;
                    } else {
                        document.getElementById('modal-translation').innerHTML = '<span style="color: var(--text-light);">Êö´ÁÑ°Ëã±ÊñáÁøªË≠Ø</span>';
                    }
                } else {
                    document.getElementById('modal-translation').innerHTML = '<span style="color: var(--text-light);">Êö´ÁÑ°Ëã±ÊñáÁøªË≠Ø</span>';
                }
                
                // È°ØÁ§∫ÈáãÁæ©
                if (mainData && mainData.heteronyms && mainData.heteronyms[0] && mainData.heteronyms[0].definitions) {
                    const definitions = mainData.heteronyms[0].definitions;
                    let definitionText = '';
                    
                    definitions.forEach((def, index) => {
                        if (def.def) {
                            const cleanDef = cleanMoedictText(def.def);
                            if (definitions.length > 1) {
                                definitionText += `${index + 1}. ${cleanDef}\n\n`;
                            } else {
                                definitionText += cleanDef;
                            }
                        }
                    });
                    
                    if (definitionText) {
                        document.getElementById('modal-definition').textContent = definitionText;
                    } else {
                        document.getElementById('modal-definition').innerHTML = '<span style="color: var(--text-light);">Êö´ÁÑ°ÈáãÁæ©</span>';
                    }
                    
                    // È°ØÁ§∫‰æãÂè•ÔºàÂèñÂâç3ÂÄãÔºâ
                    let exampleText = '';
                    let exampleCount = 0;
                    definitions.forEach(def => {
                        if (def.example && def.example.length > 0 && exampleCount < 3) {
                            def.example.forEach(ex => {
                                if (exampleCount < 3) {
                                    const cleanExample = cleanMoedictText(ex);
                                    if (cleanExample) {
                                        exampleText += `‚Ä¢ ${cleanExample}\n\n`;
                                        exampleCount++;
                                    }
                                }
                            });
                        }
                    });
                    
                    if (exampleText) {
                        document.getElementById('modal-example').textContent = exampleText;
                    } else {
                        document.getElementById('modal-example').innerHTML = '<span style="color: var(--text-light);">Êö´ÁÑ°‰æãÂè•</span>';
                    }
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâdefinitionsÊï∏Êìö
                    document.getElementById('modal-definition').innerHTML = '<span style="color: var(--text-light);">Êö´ÁÑ°ÈáãÁæ©</span>';
                    document.getElementById('modal-example').innerHTML = '<span style="color: var(--text-light);">Êö´ÁÑ°‰æãÂè•</span>';
                }
                
            } catch (error) {
                console.error('Êü•Ë©¢Ë©ûÂΩôÂ§±Êïó:', error);
                document.getElementById('modal-pinyin').innerHTML = '<span style="color: #E74C3C;">‚ùå Êü•Ë©¢Â§±Êïó</span>';
                document.getElementById('modal-translation').innerHTML = '<span style="color: var(--text-light);">ÁÑ°Ê≥ïÁç≤ÂèñÁøªË≠Ø</span>';
                document.getElementById('modal-definition').innerHTML = '<span style="color: var(--text-light);">Êä±Ê≠âÔºåÊö´ÊôÇÁÑ°Ê≥ïÁç≤ÂèñË©≤Ë©ûÁöÑË©≥Á¥∞ÈáãÁæ©„ÄÇ<br>Ë´ãÁ®çÂæåÈáçË©¶ÊàñÂòóË©¶ÂÖ∂‰ªñË©ûË™û„ÄÇ</span>';
                document.getElementById('modal-example').innerHTML = '<span style="color: var(--text-light);">ÁÑ°Ê≥ïÁç≤Âèñ‰æãÂè•</span>';
            }
            
            // ‰øùÂ≠òÁï∂ÂâçÊü•ÁúãÁöÑË©ûÂΩô
            modal.dataset.currentWord = word;
        };

        // ===== ÈóúÈñâË©ûÂΩôË©≥ÊÉÖ =====
        window.closeWordModal = function() {
            document.getElementById('word-modal').classList.remove('active');
        };

        // ÈªûÊìäËÉåÊôØÈóúÈñâÂΩàÁ™ó
        document.getElementById('word-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWordModal();
            }
        });

        // ===== Ê∑ªÂä†Âà∞ÁîüË©ûÊú¨ =====
        window.addToWordbook = function() {
            const modal = document.getElementById('word-modal');
            const word = modal.dataset.currentWord;
            const pinyin = document.getElementById('modal-pinyin').textContent;
            const translation = document.getElementById('modal-translation').textContent;
            const definition = document.getElementById('modal-definition').textContent;
            
            if (!word) return;
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if (wordbook.some(w => w.word === word)) {
                showToast('Ë©≤Ë©ûÂ∑≤Âú®ÁîüË©ûÊú¨‰∏≠ÔºÅ');
                return;
            }
            
            // Ê∑ªÂä†Âà∞ÁîüË©ûÊú¨
            wordbook.push({
                word: word,
                pinyin: pinyin,
                translation: translation,
                definition: definition,
                addedAt: new Date().toISOString()
            });
            
            // ‰øùÂ≠òÂà∞ localStorage
            localStorage.setItem('story_wordbook', JSON.stringify(wordbook));
            updateWordbookCount();
            
            showToast(`‚úÖ "${word}" Â∑≤Ê∑ªÂä†Âà∞ÁîüË©ûÊú¨ÔºÅ`);
        };

        // ===== Êõ¥Êñ∞ÁîüË©ûÊú¨Ë®àÊï∏ =====
        function updateWordbookCount() {
            document.getElementById('wordbook-count').textContent = wordbook.length;
        }

        // ===== ÊâìÈñãÁîüË©ûÊú¨ =====
        window.openWordbook = function() {
            if (wordbook.length === 0) {
                showToast('ÁîüË©ûÊú¨ÈÇÑÊòØÁ©∫ÁöÑÔºåÂø´ÂéªÊî∂Ëóè‰∏Ä‰∫õË©ûÂΩôÂêßÔºÅ');
                return;
            }
            
            let wordbookHTML = '<h2 style="margin-bottom: 20px;">üìö ÊàëÁöÑÁîüË©ûÊú¨</h2>';
            wordbook.forEach((item, index) => {
                wordbookHTML += `
                    <div style="background: var(--light-blue); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 1.5em; font-weight: bold; color: var(--primary-purple);">${item.word}</div>
                        <div style="color: var(--text-light); margin: 5px 0;">${item.pinyin}</div>
                        ${item.translation ? `<div style="color: var(--primary-blue); margin: 5px 0; font-style: italic;">üåç ${item.translation}</div>` : ''}
                        <div style="color: var(--text-dark); line-height: 1.6;">${item.definition}</div>
                    </div>
                `;
            });
            
            const modal = document.getElementById('word-modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <button class="modal-close" onclick="closeWordModal()">√ó</button>
                ${wordbookHTML}
                <button class="btn-secondary" onclick="closeWordModal()" style="width: 100%; margin-top: 20px;">ÈóúÈñâ</button>
            `;
            modal.classList.add('active');
        };

        // ===== ÂïüÂãïÊáâÁî® =====
        console.log('üéÆ ÊïÖ‰∫ãË©ûÂΩôÊé•ÈæçÈÅäÊà≤Â∑≤ËºâÂÖ•ÔºÅ');
        
        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
