# 詞表系統測試指南

## ✅ 修復完成

### 已修復的問題

1. **設置頁面顯示正常**
   - 統一下拉菜單：AI智能推薦（默認）、系統詞表、我的詞表
   - 點擊"➕ 添加自定義詞表"打開上傳模態窗口
   - 添加了所有必要的樣式類（`.form-label`, `.btn-primary`, `.btn-secondary`）

2. **初始創作界面布局優化**
   - **默認顯示**：AI智能推薦模式的歡迎信息
   - **底部提示**：默認顯示"當前：AI智能推薦"（不再是"加載中..."）
   - **層級卡片位置**：詞表層級卡片顯示在主題選擇**上方**（而不是下方）
   - **動態切換**：
     - AI模式：顯示歡迎信息，隱藏層級區域
     - 詞表模式（有層級）：隱藏歡迎信息，顯示層級卡片

3. **初始化邏輯優化**
   - 默認狀態設為AI模式，確保頁面加載後立即顯示正確內容
   - 只有在用戶明確選擇了詞表且詞表有層級時，才顯示層級卡片
   - 錯誤處理：加載失敗時自動降級到AI模式

## 🧪 測試步驟

### 測試1：默認AI模式

1. 打開瀏覽器，訪問 `http://localhost:8000/index.html`
2. **期望結果**：
   - ✅ 顯示AI歡迎信息："讓我們一起創作精彩的故事！"
   - ✅ 底部顯示："當前：AI智能推薦 | [更換]"
   - ✅ 沒有顯示任何層級卡片
   - ✅ 主題選擇正常顯示
   - ✅ "開始創作故事"按鈕可用

### 測試2：設置頁面功能

1. 訪問 `http://localhost:8000/settings.html`
2. **期望結果**：
   - ✅ 看到"📚 詞表設置"標題
   - ✅ 下拉菜單顯示"🤖 AI智能推荐（默认）"
   - ✅ 下拉菜單中有"系統詞表"和"我的詞表"分組（可能為空）
   - ✅ 下拉菜單最底部有"➕ 添加自定義詞表"
   - ✅ "💾 保存设置"按鈕可見

3. 點擊"➕ 添加自定義詞表"
4. **期望結果**：
   - ✅ 彈出模態窗口
   - ✅ 窗口標題："➕ 上傳自定義詞表"
   - ✅ 有詞表名稱輸入框
   - ✅ 有詞表描述輸入框
   - ✅ 有"📥 下載模板"按鈕
   - ✅ 有文件上傳區域（可拖拽）
   - ✅ 有"取消"和"確認上傳"按鈕

5. 點擊"取消"或關閉按鈕
6. **期望結果**：
   - ✅ 模態窗口關閉
   - ✅ 下拉菜單恢復到之前的選擇

### 測試3：上傳自定義詞表

1. 在設置頁面，點擊"📥 下載模板"
2. **期望結果**：
   - ✅ 下載一個CSV文件："詞表導入模板.csv"
   - ✅ 文件包含示例數據：詞語、第二層級、第三層級

3. 編輯CSV文件，添加一些測試詞彙：
   ```csv
   詞語,第二層級,第三層級
   美麗,第一單元,課文一
   聰明,第一單元,課文一
   勇敢,第一單元,課文二
   友善,第二單元,課文三
   ```

4. 點擊"➕ 添加自定義詞表"
5. 填寫詞表名稱：例如"測試詞表"
6. 上傳剛才編輯的CSV文件
7. 點擊"確認上傳"
8. **期望結果**：
   - ✅ 顯示進度條（10% → 30% → 40% → 90% → 100%）
   - ✅ 顯示進度文字："讀取文件中..." → "創建詞表中..." → "導入詞彙中..."
   - ✅ 成功後彈出提示："✅ 詞表'測試詞表'已成功上傳！"
   - ✅ 模態窗口自動關閉
   - ✅ 下拉菜單中出現新詞表："[我的詞表] 測試詞表 (4詞)"

### 測試4：使用自定義詞表

1. 在設置頁面，選擇剛才上傳的"測試詞表"
2. 點擊"💾 保存设置"
3. **期望結果**：
   - ✅ 彈出提示："✅ 設置已保存！"

4. 點擊"← 返回主页"
5. **期望結果**：
   - ✅ **AI歡迎信息已隱藏**
   - ✅ **顯示"📚 選擇範圍："標題**
   - ✅ **在主題選擇上方顯示第二層級卡片**：
     - 卡片1："第一單元"
     - 卡片2："第二單元"
   - ✅ 底部顯示："當前：測試詞表 | [更換]"

6. 點擊"第一單元"卡片
7. **期望結果**：
   - ✅ 卡片被選中（高亮）
   - ✅ 下方展開第三層級卡片：
     - 卡片1："課文一"
     - 卡片2："課文二"

8. 點擊"課文一"卡片
9. **期望結果**：
   - ✅ 卡片被選中（高亮）

10. 選擇一個主題（例如"🌳 自然探索"）
11. 點擊"開始創作故事"
12. **期望結果**：
    - ✅ 遊戲開始
    - ✅ 推薦的詞彙來自"測試詞表 > 第一單元 > 課文一"

### 測試5：切換回AI模式

1. 點擊底部的"[更換]"鏈接
2. **期望結果**：
   - ✅ 跳轉到設置頁面
   - ✅ 當前選中的是"測試詞表"

3. 在下拉菜單中選擇"🤖 AI智能推荐（默认）"
4. 點擊"💾 保存设置"
5. 點擊"← 返回主页"
6. **期望結果**：
   - ✅ 顯示AI歡迎信息
   - ✅ 隱藏層級卡片區域
   - ✅ 底部顯示："當前：AI智能推薦 | [更換]"

### 測試6：控制台日誌檢查

打開瀏覽器開發者工具（F12），查看控制台：

**AI模式時**：
```
✅ 使用AI智能推荐模式
📚 开始游戏 - 词表模式: ai
📚 词表ID: null
📚 层级2: null
📚 层级3: null
```

**詞表模式時**：
```
📋 词表: 測試詞表
📋 词表标签: [...]
📚 显示词表层级卡片
📚 开始游戏 - 词表模式: wordlist
📚 词表ID: <uuid>
📚 层级2: 第一單元
📚 层级3: 課文一
```

## 🐛 常見問題排查

### 問題1：設置頁面下拉菜單為空

**原因**：還沒有上傳任何自定義詞表，也沒有導入系統詞表

**解決**：
- 正常現象，"系統詞表"和"我的詞表"分組可能顯示"暫無系統詞表"或"暫無自定義詞表"
- 可以通過"➕ 添加自定義詞表"功能上傳第一個詞表

### 問題2：主頁顯示"加載中..."

**原因**：JavaScript尚未執行完成

**解決**：
- 刷新頁面
- 檢查瀏覽器控制台是否有錯誤
- 確認 `js/ui/screens.js` 和 `js/ui/hierarchy-cards.js` 文件正確加載

### 問題3：層級卡片不顯示

**原因**：
1. 詞表沒有層級標籤
2. 用戶選擇了AI模式
3. JavaScript錯誤

**解決**：
- 檢查上傳的CSV文件是否包含"第二層級"和"第三層級"列
- 確認在設置頁面選擇了正確的詞表並保存
- 查看瀏覽器控制台錯誤日誌

### 問題4：上傳詞表時進度卡住

**原因**：
1. CSV文件格式錯誤
2. 網絡連接問題（Supabase）
3. 詞彙數量太大

**解決**：
- 檢查CSV文件格式（UTF-8編碼，逗號分隔）
- 確認Supabase連接正常
- 嘗試上傳較小的詞表（少於100個詞）進行測試

## 📊 數據流確認

```
用戶操作流程：
settings.html
  ↓ 
選擇詞表並保存
  ↓
Supabase: user_wordlist_preferences 表
  ↓
index.html 加載
  ↓
initStartScreen() 讀取設置
  ↓
根據設置顯示：
  - AI模式：歡迎信息
  - 詞表模式（有層級）：層級卡片
  ↓
用戶選擇層級（如果有）+ 主題
  ↓
handleStartGame()
  ↓
gameState 包含：
  - wordlistMode: 'ai' 或 'wordlist'
  - wordlistId: <uuid> 或 null
  - level2Tag: '第一單元' 或 null
  - level3Tag: '課文一' 或 null
  ↓
vocab-recommender Edge Function
  ↓
根據詞表參數推薦詞彙
```

## 🎉 測試通過標準

- ✅ 默認顯示AI模式，無"加載中..."
- ✅ 設置頁面下拉菜單正常顯示
- ✅ 上傳詞表功能正常，進度條正確顯示
- ✅ 層級卡片在主題選擇**上方**顯示
- ✅ 點擊層級卡片可以選中和展開
- ✅ 底部詞表名稱正確顯示
- ✅ 切換模式後立即生效
- ✅ 遊戲開始時控制台日誌正確

---

**測試日期**：2025-10-10  
**測試狀態**：✅ 所有功能實施完成，待用戶測試確認

