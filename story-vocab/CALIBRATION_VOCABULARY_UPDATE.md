# 📚 校準詞庫擴充說明

## 🎯 更新內容

### 版本升級
- **舊版本**: 1.0 - 50個詞（每級8-9個）
- **新版本**: 2.0 - 150個詞（每級25個）

### 擴充原因

#### 1. 詞汇不足問題
在第6-10輪動態選詞時，50詞版本容易出現：
- **詞汇重複**：同一難度需要選擇多次，但可選詞太少
- **跨輪次衝突**：前面用過的詞在後續輪次無法避免
- **選擇受限**：相鄰難度補充時選項不足

#### 2. 未來擴展需求
- 目前：10輪校準遊戲
- 未來：可能調整為15-20輪以獲得更精確評估
- 150詞版本可支持最多20輪遊戲

#### 3. 詞汇多樣性
- **類型多樣**：動詞、形容詞、名詞、成語等
- **主題廣泛**：情感、自然、描寫、動作等
- **風格豐富**：口語、書面語、文言色彩等

---

## 📊 詞庫結構對比

### 舊版本（1.0）- 50詞

| 等級 | 詞數 | 10輪遊戲餘裕 | 20輪遊戲餘裕 |
|------|------|--------------|--------------|
| L1   | 8    | ⚠️ 勉強       | ❌ 不足       |
| L2   | 9    | ⚠️ 勉強       | ❌ 不足       |
| L3   | 9    | ⚠️ 勉強       | ❌ 不足       |
| L4   | 8    | ⚠️ 勉強       | ❌ 不足       |
| L5   | 8    | ⚠️ 勉強       | ❌ 不足       |
| L6   | 8    | ⚠️ 勉強       | ❌ 不足       |
| **總計** | **50** | **🟡 緊張** | **🔴 嚴重不足** |

### 新版本（2.0）- 150詞

| 等級 | 詞數 | 10輪遊戲餘裕 | 20輪遊戲餘裕 |
|------|------|--------------|--------------|
| L1   | 25   | ✅ 充足       | ✅ 充足       |
| L2   | 25   | ✅ 充足       | ✅ 充足       |
| L3   | 25   | ✅ 充足       | ✅ 充足       |
| L4   | 25   | ✅ 充足       | ✅ 充足       |
| L5   | 25   | ✅ 充足       | ✅ 充足       |
| L6   | 25   | ✅ 充足       | ✅ 充足       |
| **總計** | **150** | **🟢 非常充足** | **🟢 充足** |

---

## 🔍 詞彙選擇標準

### L1（25詞）- 日常高頻詞
- **特徵**：口語常用，2個字為主
- **示例**：吃、玩、笑、跑步、高興、朋友、學校、漂亮
- **頻率**：74-100
- **HSK**: 1級

### L2（25詞）- 擴展詞彙
- **特徵**：書面語起步，2-3個字
- **示例**：探險、勇敢、發現、森林、驚訝、飛翔、夢想
- **頻率**：59-85
- **HSK**: 2-3級

### L3（25詞）- 文學詞彙
- **特徵**：文學性增強，3-4個字
- **示例**：寧靜、凝視、沉思、壯麗、幽靜、縈繞、霎時
- **頻率**：41-66
- **HSK**: 4級

### L4（25詞）- 抽象詞彙
- **特徵**：抽象概念，文學性強
- **示例**：滄桑、蛻變、翱翔、眷戀、璀璨、遐想、憧憬
- **頻率**：27-50
- **HSK**: 5級

### L5（25詞）- 文言詞彙
- **特徵**：文言色彩、成語、書面語
- **示例**：悠然、斟酌、漣漪、蔥蘢、躊躇滿志、蜿蜒曲折
- **頻率**：16-40
- **HSK**: 6級+

### L6（25詞）- 古雅詞彙
- **特徵**：典雅書面語、生僻成語
- **示例**：婉約、旖旎、綺麗、翩躚、婆娑起舞、氤氳、流光溢彩
- **頻率**：3-28
- **HSK**: 超範圍

---

## 💡 技術改進

### 1. 跨輪次去重機制
```javascript
// 從 recommendation_history 查詢本次會話已推薦的所有詞
const { data: history } = await supabase
  .from('recommendation_history')
  .select('recommended_words')
  .eq('session_id', gameState.sessionId)

// 過濾掉已使用的詞（本輪內 + 跨輪次）
const availableCandidates = candidates.filter(w => 
  !usedWords.has(w.word) && !usedWordsInSession.has(w.word)
)
```

### 2. 三級回退機制
- **第1級**：從目標等級選詞
- **第2級**：目標等級不夠 → 從相鄰等級補充
- **第3級**：相鄰等級也不夠 → 從所有等級補充

### 3. 動態選詞邏輯優化
- 前5輪：固定詞表（大跨度探索）
- 後5輪：動態選擇（基於前5輪評估）
  - 評估用戶等級
  - 確定測試範圍（±1級）
  - 從25詞池中隨機選擇，確保不重複

---

## 📈 預期效果

### 修復的問題
- ✅ **詞彙重複**：不再出現3個相同詞的情況
- ✅ **詞數不足**：每輪穩定推薦5個不同的詞
- ✅ **選擇單一**：大幅增加詞彙多樣性

### 提升的體驗
- ✅ **評估更準確**：更多詞彙樣本 → 更精準的水平判斷
- ✅ **學習更豐富**：接觸更多不同類型的詞彙
- ✅ **系統更穩定**：支持未來擴展至20輪

---

## 🚀 使用說明

### 文件位置
```
story-vocab/data/calibration-vocabulary.json
```

### 自動加載
校準遊戲管理器會自動加載擴充版詞庫：

```javascript
async function loadCalibrationVocabulary() {
  if (CALIBRATION_POOL) {
    return CALIBRATION_POOL
  }
  
  const response = await fetch('/story-vocab/data/calibration-vocabulary.json')
  const data = await response.json()
  CALIBRATION_POOL = data.calibration_words
  
  return CALIBRATION_POOL
}
```

### 無需額外配置
系統會自動：
1. 檢測詞庫版本（150詞 vs 50詞）
2. 使用擴充版進行校準測試
3. 應用去重和回退機制
4. 記錄推薦歷史到數據庫

---

## ✅ 測試清單

部署後請驗證：

- [ ] 第1-5輪：固定詞表，無重複
- [ ] 第6-10輪：動態選詞，無重複
- [ ] 控制台日誌：顯示 `本次會話已用 X 個詞`
- [ ] 每輪穩定推薦5個不同的詞
- [ ] 詞彙難度符合評估等級
- [ ] 沒有出現 `詞語不足` 的警告

---

## 📝 版本記錄

- **2025-10-08**: 創建 v2.0 擴充版（150詞）
- **原始版本**: v1.0 基礎版（50詞）

---

**維護者**: 請確保校準詞庫與 `sample-vocabulary.json` 保持一致的難度標準。

