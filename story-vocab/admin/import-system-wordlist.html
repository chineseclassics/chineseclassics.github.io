<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¼å…¥ç³»ç»Ÿè¯è¡¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #1565c0;
    }
    
    .form-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .log-entry.success {
      color: #2e7d32;
    }
    
    .log-entry.error {
      color: #c62828;
    }

    .template-section {
      margin: 20px 0;
      padding: 20px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .template-section h3 {
      margin-bottom: 15px;
      color: #856404;
    }

    .template-section pre {
      background: white;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š å¯¼å…¥ç³»ç»Ÿè¯è¡¨</h1>
    <p class="subtitle">å¯¼å…¥ HSKã€æ•™æç­‰æ ‡å‡†è¯è¡¨åˆ°ç³»ç»Ÿ</p>

    <div class="alert alert-info">
      <strong>ğŸ“ æ“ä½œè¯´æ˜ï¼š</strong>
      æœ¬å·¥å…·ç”¨äºå¯¼å…¥ç³»ç»Ÿé¢„è®¾è¯è¡¨ï¼ˆå¦‚ HSKã€äººæ•™ç‰ˆæ•™æç­‰ï¼‰ã€‚<br><br>
      <strong>é‡è¦æ­¥éª¤ï¼š</strong><br>
      1ï¸âƒ£ å…ˆå¡«å†™è¯è¡¨åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€ä»£ç ç­‰ï¼‰<br>
      2ï¸âƒ£ å†ä¸Šä¼  CSV æ–‡ä»¶ï¼ˆæ–‡ä»¶ä¼šè‡ªåŠ¨è§£æï¼‰<br>
      3ï¸âƒ£ ç¡®è®¤é¢„è§ˆæ— è¯¯åï¼Œç‚¹å‡»"å¼€å§‹å¯¼å…¥"æŒ‰é’®<br><br>
      âš ï¸ <strong>æ³¨æ„ï¼š</strong>åªæœ‰æˆåŠŸä¸Šä¼ å¹¶è§£ææ–‡ä»¶åï¼Œ"å¼€å§‹å¯¼å…¥"æŒ‰é’®æ‰ä¼šå˜ä¸ºå¯ç‚¹å‡»çŠ¶æ€ã€‚å¦‚æœæŒ‰é’®ä¸€ç›´æ— æ³•ç‚¹å‡»ï¼Œè¯·æŒ‰ F12 æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€‚
    </div>

    <!-- CSVæ ¼å¼è¯´æ˜ -->
    <div class="template-section">
      <h3>ğŸ“‹ CSV æ–‡ä»¶æ ¼å¼è¦æ±‚</h3>
      <p style="margin-bottom: 10px;">æ–‡ä»¶åº”åŒ…å«ä»¥ä¸‹åˆ—ï¼ˆé¡ºåºæ— å…³ï¼Œåˆ—åå¿…é¡»åŒ¹é…ï¼‰ï¼š</p>
      <pre>è¯è¯­,ç¬¬äºŒå±‚çº§,ç¬¬ä¸‰å±‚çº§
é«˜èˆˆ,HSK1çº§,
æœ‹å‹,HSK1çº§,
æ¢éšª,HSK3çº§,
å‹‡æ•¢,HSK3çº§,</pre>
      <p style="margin-top: 10px; font-size: 12px; color: #856404;">
        ğŸ’¡ ç¬¬äºŒå±‚çº§å’Œç¬¬ä¸‰å±‚çº§å¯ä»¥ä¸ºç©ºã€‚å¦‚æœä¸ºç©ºï¼Œè¯¥è¯å±äºè¯è¡¨ä½†ä¸åœ¨ä»»ä½•å­åˆ†ç±»ä¸­ã€‚
      </p>
    </div>

    <!-- è¯è¡¨ä¿¡æ¯è¡¨å• -->
    <div class="form-section">
      <h2 style="margin-bottom: 20px;">1ï¸âƒ£ è¯è¡¨åŸºæœ¬ä¿¡æ¯</h2>
      
      <div class="form-group">
        <label class="form-label">è¯è¡¨åç§° *</label>
        <input type="text" id="wordlist-name" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šHSKæ ‡å‡†è¯è¡¨" required>
      </div>

      <div class="form-group">
        <label class="form-label">è¯è¡¨ä»£ç  *</label>
        <input type="text" id="wordlist-code" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šhsk_standardï¼ˆè‹±æ–‡ï¼Œå”¯ä¸€æ ‡è¯†ï¼‰" required>
        <div class="form-hint">åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</div>
      </div>

      <div class="form-group">
        <label class="form-label">ç¬¬äºŒå±‚çº§æ ‡ç­¾åç§°</label>
        <input type="text" id="level-2-label" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šç­‰çº§ã€å¹´çº§ã€åˆ†ç±»ï¼ˆå¯é€‰ï¼‰">
        <div class="form-hint">å¦‚è¯è¡¨æœ‰åˆ†çº§ï¼Œè¯·å¡«å†™ï¼›æ— åˆ†çº§åˆ™ç•™ç©º</div>
      </div>

      <div class="form-group">
        <label class="form-label">ç¬¬ä¸‰å±‚çº§æ ‡ç­¾åç§°</label>
        <input type="text" id="level-3-label" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šå•å…ƒã€ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰">
        <div class="form-hint">å¦‚æœ‰æ›´ç»†çš„åˆ†ç±»ï¼Œè¯·å¡«å†™ï¼›å¦åˆ™ç•™ç©º</div>
      </div>

      <div class="form-group">
        <label class="form-label">è¯è¡¨æè¿°</label>
        <textarea id="wordlist-desc" class="form-textarea" 
                  placeholder="ç®€å•æè¿°è¿™ä¸ªè¯è¡¨çš„ç”¨é€”å’Œç‰¹ç‚¹"></textarea>
      </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼  -->
    <div class="form-section">
      <h2 style="margin-bottom: 20px;">2ï¸âƒ£ ä¸Šä¼ è¯è¡¨æ–‡ä»¶</h2>
      
      <div class="form-group">
        <label class="form-label">é€‰æ‹© CSV æˆ– JSON æ–‡ä»¶</label>
        <input type="file" id="file-input" accept=".csv,.json" class="form-input">
        <div class="form-hint">
          CSV æ ¼å¼ï¼šè¯è¯­,ç¬¬äºŒå±‚çº§,ç¬¬ä¸‰å±‚çº§<br>
          JSON æ ¼å¼ï¼š[{word, level_2_tag, level_3_tag}, ...]
        </div>
      </div>

      <div id="file-preview" style="display: none; margin-top: 20px;">
        <h3>æ–‡ä»¶é¢„è§ˆ</h3>
        <div id="preview-content"></div>
      </div>
    </div>

    <!-- å¯¼å…¥æŒ‰é’® -->
    <button class="btn btn-primary" id="import-btn" disabled>
      ğŸš€ å¼€å§‹å¯¼å…¥
    </button>

    <!-- è¿›åº¦ -->
    <div id="progress-section" style="display: none; margin-top: 30px;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
      </div>
      <p id="progress-text" style="text-align: center; margin-top: 10px;"></p>
    </div>

    <!-- æ—¥å¿— -->
    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script type="module">
    import { initSupabase, getSupabase } from '../js/supabase-client.js'

    let supabase = null
    let fileData = null
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    console.log('=== ç³»ç»Ÿè¯è¡¨å¯¼å…¥å·¥å…· ===')
    
    // åˆå§‹åŒ– Supabase
    async function initialize() {
      try {
        console.log('æ­£åœ¨åˆå§‹åŒ– Supabase...')
        supabase = await initSupabase()
        console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ')
        
        // æµ‹è¯•è¿æ¥
        const { data, error } = await supabase.from('wordlists').select('count').limit(1)
        if (error) throw error
        console.log('âœ… Supabase è¿æ¥æ­£å¸¸')
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error)
        alert('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼\n\nè¯·ç¡®ä¿ï¼š\n1. æ•°æ®åº“è¿ç§»å·²å®Œæˆ\n2. ç½‘ç»œè¿æ¥æ­£å¸¸\n3. Supabase é…ç½®æ­£ç¡®\n\né”™è¯¯: ' + error.message)
      }
    }
    
    // ç«‹å³æ‰§è¡Œåˆå§‹åŒ–
    initialize()
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('file-input')
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect)
        console.log('âœ… æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶å·²ç»‘å®š')
      }
      
      const importBtn = document.getElementById('import-btn')
      if (importBtn) {
        importBtn.addEventListener('click', importWordlist)
        console.log('âœ… å¯¼å…¥æŒ‰é’®äº‹ä»¶å·²ç»‘å®š')
      }
    })

    /**
     * å¤„ç†æ–‡ä»¶é€‰æ‹©
     */
    async function handleFileSelect(event) {
      const file = event.target.files[0]
      if (!file) {
        console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶')
        return
      }

      console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'bytes')

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.textContent = 'è§£æä¸­...'

      try {
        console.log('å¼€å§‹è¯»å–æ–‡ä»¶...')
        const text = await file.text()
        console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', text.length)
        
        if (file.name.endsWith('.csv')) {
          console.log('å¼€å§‹è§£æ CSV...')
          fileData = parseCSV(text)
          console.log('CSV è§£ææˆåŠŸï¼Œè¯æ±‡æ•°é‡:', fileData.length)
        } else if (file.name.endsWith('.json')) {
          console.log('å¼€å§‹è§£æ JSON...')
          fileData = JSON.parse(text)
          console.log('JSON è§£ææˆåŠŸï¼Œè¯æ±‡æ•°é‡:', fileData.length)
        } else {
          throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä½¿ç”¨ .csv æˆ– .json æ–‡ä»¶')
        }

        if (!fileData || fileData.length === 0) {
          throw new Error('æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¯æ±‡æ•°æ®')
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        console.log('æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ...')
        showPreview(fileData)
        
        btn.disabled = false
        btn.textContent = 'ğŸš€ å¼€å§‹å¯¼å…¥'
        console.log('âœ… æ–‡ä»¶åŠ è½½æˆåŠŸï¼ŒæŒ‰é’®å·²å¯ç”¨')

      } catch (error) {
        console.error('æ–‡ä»¶è§£æå¤±è´¥:', error)
        alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚')
        btn.disabled = true
        btn.textContent = 'âŒ è§£æå¤±è´¥'
      }
    }

    /**
     * è§£æ CSV
     */
    function parseCSV(text) {
      console.log('å¼€å§‹è§£æ CSV æ–‡æœ¬...')
      
      const lines = text.trim().split('\n')
      console.log('æ€»è¡Œæ•°:', lines.length)
      
      if (lines.length < 2) {
        throw new Error('CSV æ–‡ä»¶å†…å®¹å¤ªå°‘ï¼Œè‡³å°‘éœ€è¦è¡¨å¤´å’Œä¸€è¡Œæ•°æ®')
      }
      
      const headers = lines[0].split(',').map(h => h.trim())
      console.log('è¡¨å¤´:', headers)
      
      // æ£€æŸ¥å¿…éœ€çš„åˆ—
      if (!headers.includes('è¯è¯­')) {
        throw new Error('CSV æ–‡ä»¶ç¼ºå°‘"è¯è¯­"åˆ—ã€‚å½“å‰è¡¨å¤´: ' + headers.join(', '))
      }

      const wordIndex = headers.indexOf('è¯è¯­')
      const level2Index = headers.indexOf('ç¬¬äºŒå±‚çº§')
      const level3Index = headers.indexOf('ç¬¬ä¸‰å±‚çº§')
      
      console.log('åˆ—ç´¢å¼• - è¯è¯­:', wordIndex, 'ç¬¬äºŒå±‚çº§:', level2Index, 'ç¬¬ä¸‰å±‚çº§:', level3Index)

      const data = []
      let skipped = 0
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim()
        if (!line) {
          skipped++
          continue
        }
        
        const cells = line.split(',').map(c => c.trim())
        
        if (cells[wordIndex] && cells[wordIndex].length > 0) {
          data.push({
            word: cells[wordIndex],
            level_2_tag: (level2Index >= 0 && cells[level2Index]) ? cells[level2Index] : null,
            level_3_tag: (level3Index >= 0 && cells[level3Index]) ? cells[level3Index] : null
          })
        } else {
          skipped++
        }
        
        // æ¯è§£æ1000è¡Œè¾“å‡ºä¸€æ¬¡è¿›åº¦
        if (i % 1000 === 0) {
          console.log('å·²è§£æ', i, 'è¡Œï¼Œæå–', data.length, 'ä¸ªè¯æ±‡')
        }
      }
      
      console.log('è§£æå®Œæˆ - æ€»è¡Œæ•°:', lines.length, 'æœ‰æ•ˆè¯æ±‡:', data.length, 'è·³è¿‡:', skipped)

      if (data.length === 0) {
        throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è¯æ±‡æ•°æ®')
      }

      return data
    }

    /**
     * æ˜¾ç¤ºé¢„è§ˆ
     */
    function showPreview(data) {
      const preview = document.getElementById('file-preview')
      const content = document.getElementById('preview-content')
      
      // ç»Ÿè®¡
      const stats = {
        total: data.length,
        hasLevel2: data.filter(d => d.level_2_tag).length,
        hasLevel3: data.filter(d => d.level_3_tag).length,
        level2Tags: [...new Set(data.map(d => d.level_2_tag).filter(Boolean))],
        level3Tags: [...new Set(data.map(d => d.level_3_tag).filter(Boolean))]
      }

      content.innerHTML = `
        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
          <p><strong>æ–‡ä»¶ç»Ÿè®¡ï¼š</strong></p>
          <p>â€¢ æ€»è¯æ±‡æ•°ï¼š${stats.total}</p>
          <p>â€¢ æœ‰ç¬¬äºŒå±‚çº§æ ‡ç­¾ï¼š${stats.hasLevel2} ä¸ª</p>
          <p>â€¢ æœ‰ç¬¬ä¸‰å±‚çº§æ ‡ç­¾ï¼š${stats.hasLevel3} ä¸ª</p>
          <p>â€¢ æ£€æµ‹åˆ°çš„ç¬¬äºŒå±‚çº§æ ‡ç­¾ï¼š${stats.level2Tags.join('ã€') || 'æ— '}</p>
          <p>â€¢ æ£€æµ‹åˆ°çš„ç¬¬ä¸‰å±‚çº§æ ‡ç­¾ï¼š${stats.level3Tags.join('ã€') || 'æ— '}</p>
        </div>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px;">
          <table style="width: 100%; font-size: 12px;">
            <tr style="background: #f5f5f5; font-weight: bold;">
              <th style="padding: 8px;">è¯è¯­</th>
              <th style="padding: 8px;">ç¬¬äºŒå±‚çº§</th>
              <th style="padding: 8px;">ç¬¬ä¸‰å±‚çº§</th>
            </tr>
            ${data.slice(0, 10).map(d => `
              <tr>
                <td style="padding: 8px;">${d.word}</td>
                <td style="padding: 8px;">${d.level_2_tag || '-'}</td>
                <td style="padding: 8px;">${d.level_3_tag || '-'}</td>
              </tr>
            `).join('')}
            ${data.length > 10 ? `<tr><td colspan="3" style="text-align: center; padding: 8px; color: #999;">... è¿˜æœ‰ ${data.length - 10} ä¸ªè¯</td></tr>` : ''}
          </table>
        </div>
      `
      
      preview.style.display = 'block'
    }

    /**
     * å¯¼å…¥è¯è¡¨
     */
    async function importWordlist() {
      if (!fileData || fileData.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶')
        return
      }

      // è·å–è¡¨å•æ•°æ®
      const name = document.getElementById('wordlist-name').value.trim()
      const code = document.getElementById('wordlist-code').value.trim()
      const level2Label = document.getElementById('level-2-label').value.trim() || null
      const level3Label = document.getElementById('level-3-label').value.trim() || null
      const description = document.getElementById('wordlist-desc').value.trim()

      if (!name || !code) {
        alert('è¯·å¡«å†™è¯è¡¨åç§°å’Œä»£ç ')
        return
      }

      // éªŒè¯ä»£ç æ ¼å¼
      if (!/^[a-z0-9_]+$/.test(code)) {
        alert('è¯è¡¨ä»£ç åªèƒ½åŒ…å«å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿')
        return
      }

      const confirmed = confirm(
        `ç¡®å®šè¦å¯¼å…¥è¯è¡¨å—ï¼Ÿ\n\n` +
        `è¯è¡¨åç§°ï¼š${name}\n` +
        `è¯è¡¨ä»£ç ï¼š${code}\n` +
        `è¯æ±‡æ•°é‡ï¼š${fileData.length}\n\n` +
        `å¯¼å…¥è¿‡ç¨‹ä¸­ä¼šï¼š\n` +
        `1. åˆ›å»ºè¯è¡¨è®°å½•\n` +
        `2. åˆ›å»ºå±‚çº§æ ‡ç­¾\n` +
        `3. å¯¼å…¥è¯æ±‡ï¼ˆä¸å­˜åœ¨çš„è¯ä¼šè°ƒç”¨AIè¯„ä¼°éš¾åº¦ï¼‰\n` +
        `4. åˆ›å»ºè¯æ±‡-è¯è¡¨å…³è”`
      )

      if (!confirmed) return

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.innerHTML = '<span class="spinner"></span> å¯¼å…¥ä¸­...'

      const progressSection = document.getElementById('progress-section')
      const logDiv = document.getElementById('log')
      progressSection.style.display = 'block'
      logDiv.style.display = 'block'

      try {
        // 1. åˆ›å»ºè¯è¡¨
        addLog('ğŸ“ åˆ›å»ºè¯è¡¨è®°å½•...', 'success')
        
        const { data: wordlist, error: wlError } = await supabase
          .from('wordlists')
          .insert({
            name,
            code,
            type: 'system',
            hierarchy_config: {
              level_2_label: level2Label,
              level_3_label: level3Label
            },
            description
          })
          .select()
          .single()

        if (wlError) throw wlError
        addLog(`âœ… è¯è¡¨åˆ›å»ºæˆåŠŸ: ${name} (${code})`, 'success')

        // 2. æå–å¹¶åˆ›å»ºæ ‡ç­¾
        addLog('\nğŸ“‹ åˆ›å»ºå±‚çº§æ ‡ç­¾...', 'success')
        
        const level2Tags = [...new Set(fileData.map(d => d.level_2_tag).filter(Boolean))]
        const level3Tags = [...new Set(fileData.map(d => d.level_3_tag).filter(Boolean))]

        const level2TagMap = {}
        const level3TagMap = {}

        // åˆ›å»ºç¬¬äºŒå±‚çº§æ ‡ç­¾
        for (const tag of level2Tags) {
          const { data: tagData, error: tagError } = await supabase
            .from('wordlist_tags')
            .insert({
              wordlist_id: wordlist.id,
              tag_level: 2,
              tag_code: tag,
              tag_display_name: tag,
              sort_order: level2Tags.indexOf(tag)
            })
            .select()
            .single()

          if (tagError) throw tagError
          level2TagMap[tag] = tagData.id
          addLog(`  âœ… ç¬¬äºŒå±‚çº§: ${tag}`, 'success')
        }

        // åˆ›å»ºç¬¬ä¸‰å±‚çº§æ ‡ç­¾
        for (const tag of level3Tags) {
          const { data: tagData, error: tagError } = await supabase
            .from('wordlist_tags')
            .insert({
              wordlist_id: wordlist.id,
              tag_level: 3,
              tag_code: tag,
              tag_display_name: tag,
              sort_order: level3Tags.indexOf(tag)
            })
            .select()
            .single()

          if (tagError) throw tagError
          level3TagMap[tag] = tagData.id
          addLog(`  âœ… ç¬¬ä¸‰å±‚çº§: ${tag}`, 'success')
        }

        // 3. å¯¼å…¥è¯æ±‡
        addLog('\nğŸ“š å¼€å§‹å¯¼å…¥è¯æ±‡...', 'success')
        
        let newVocabCount = 0
        let existingVocabCount = 0
        let aiEvaluatedCount = 0
        let mappingCount = 0

        for (let i = 0; i < fileData.length; i++) {
          const item = fileData[i]
          
          updateProgress((i / fileData.length) * 100)

          try {
            // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯æ±‡
            let { data: vocab, error: findError } = await supabase
              .from('vocabulary')
              .select('*')
              .eq('word', item.word)
              .maybeSingle()

            if (findError) throw findError

            if (!vocab) {
              // æ–°è¯æ±‡ï¼šéœ€è¦AIè¯„ä¼°éš¾åº¦
              addLog(`  ğŸ¤– æ–°è¯"${item.word}"ï¼Œè°ƒç”¨AIè¯„ä¼°éš¾åº¦...`)
              
              // è°ƒç”¨AIè¯„ä¼°
              const { data: evalData, error: evalError } = await supabase.functions.invoke(
                'vocab-difficulty-evaluator',
                {
                  body: {
                    words: [{ word: item.word }],
                    mode: 'single'
                  }
                }
              )

              if (evalError) {
                console.error('AIè¯„ä¼°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', evalError)
              }

              const evaluation = evalData?.results?.[0] || { 
                difficulty: 3, 
                category: 'æœªçŸ¥', 
                confidence: 'low',
                reasoning: 'AIè¯„ä¼°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼'
              }

              // åˆ›å»ºè¯æ±‡
              const { data: newVocab, error: insertError } = await supabase
                .from('vocabulary')
                .insert({
                  word: item.word,
                  difficulty_level: evaluation.difficulty,
                  category: evaluation.category,
                  frequency: 50,
                  difficulty_confidence: evaluation.confidence,
                  difficulty_reasoning: evaluation.reasoning,
                  difficulty_evaluated_at: new Date().toISOString()
                })
                .select()
                .single()

              if (insertError) throw insertError
              
              vocab = newVocab
              newVocabCount++
              aiEvaluatedCount++
              addLog(`  âœ… æ–°å¢: ${item.word} (AIè¯„ä¼°ä¸º L${evaluation.difficulty})`, 'success')
            } else {
              existingVocabCount++
            }

            // åˆ›å»ºå…³è”
            const tagPath = [item.level_2_tag, item.level_3_tag].filter(Boolean)
            
            const { error: mappingError } = await supabase
              .from('vocabulary_wordlist_mapping')
              .insert({
                vocabulary_id: vocab.id,
                wordlist_id: wordlist.id,
                tag_path: JSON.stringify(tagPath),
                level_2_tag: item.level_2_tag || null,
                level_3_tag: item.level_3_tag || null
              })

            if (mappingError && mappingError.code !== '23505') { // å¿½ç•¥é‡å¤é”™è¯¯
              throw mappingError
            }
            
            mappingCount++

          } catch (error) {
            console.error(`å¤„ç†å¤±è´¥: ${item.word}`, error)
            addLog(`  âŒ å¤±è´¥: ${item.word} - ${error.message}`, 'error')
          }
        }

        updateProgress(100)

        addLog('\n============================', 'success')
        addLog(`âœ… å¯¼å…¥å®Œæˆï¼`, 'success')
        addLog(`ğŸ“Š ç»Ÿè®¡ï¼š`, 'success')
        addLog(`  - æ–°å¢è¯æ±‡: ${newVocabCount}`, 'success')
        addLog(`  - å·²å­˜åœ¨è¯æ±‡: ${existingVocabCount}`, 'success')
        addLog(`  - AIè¯„ä¼°: ${aiEvaluatedCount}`, 'success')
        addLog(`  - åˆ›å»ºå…³è”: ${mappingCount}`, 'success')
        addLog('============================', 'success')

        btn.textContent = 'âœ… å¯¼å…¥å®Œæˆ'
        
        setTimeout(() => {
          alert(
            `âœ… ç³»ç»Ÿè¯è¡¨å¯¼å…¥æˆåŠŸï¼\n\n` +
            `è¯è¡¨åç§°ï¼š${name}\n` +
            `å¯¼å…¥è¯æ±‡ï¼š${fileData.length} ä¸ª\n` +
            `æ–°å¢è¯æ±‡ï¼š${newVocabCount} ä¸ª\n` +
            `AIè¯„ä¼°ï¼š${aiEvaluatedCount} ä¸ª`
          )
        }, 500)

      } catch (error) {
        console.error('å¯¼å…¥å¤±è´¥:', error)
        addLog(`\nâŒ å¯¼å…¥å¤±è´¥: ${error.message}`, 'error')
        btn.textContent = 'âŒ å¯¼å…¥å¤±è´¥'
        btn.disabled = false
        alert('å¯¼å…¥å¤±è´¥: ' + error.message)
      }
    }

    /**
     * æ›´æ–°è¿›åº¦
     */
    function updateProgress(percent) {
      const fill = document.getElementById('progress-fill')
      const text = document.getElementById('progress-text')
      
      fill.style.width = percent + '%'
      fill.textContent = Math.round(percent) + '%'
      text.textContent = `å¤„ç†ä¸­... ${Math.round(percent)}%`
    }

    /**
     * æ·»åŠ æ—¥å¿—
     */
    function addLog(message, type = '') {
      const logDiv = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = 'log-entry ' + type
      entry.textContent = message
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }
  </script>
</body>
</html>

