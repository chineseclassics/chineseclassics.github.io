<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>导入系统词表</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #1565c0;
    }
    
    .form-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .log-entry.success {
      color: #2e7d32;
    }
    
    .log-entry.error {
      color: #c62828;
    }

    .template-section {
      margin: 20px 0;
      padding: 20px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }

    .template-section h3 {
      margin-bottom: 15px;
      color: #856404;
    }

    .template-section pre {
      background: white;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📚 导入系统词表</h1>
    <p class="subtitle">导入 HSK、教材等标准词表到系统</p>

    <div class="alert alert-info">
      <strong>📝 操作说明：</strong>
      本工具用于导入系统预设词表（如 HSK、人教版教材等）。<br><br>
      <strong>重要步骤：</strong><br>
      1️⃣ 先填写词表基本信息（名称、代码等）<br>
      2️⃣ 再上传 CSV 文件（文件会自动解析）<br>
      3️⃣ 确认预览无误后，点击"开始导入"按钮<br><br>
      ⚠️ <strong>注意：</strong>只有成功上传并解析文件后，"开始导入"按钮才会变为可点击状态。如果按钮一直无法点击，请按 F12 打开浏览器控制台查看错误信息。
    </div>

    <!-- CSV格式说明 -->
    <div class="template-section">
      <h3>📋 CSV 文件格式要求</h3>
      <p style="margin-bottom: 10px;">文件应包含以下列（顺序无关，列名必须匹配）：</p>
      <pre>词语,第二层级,第三层级
高興,HSK1级,
朋友,HSK1级,
探險,HSK3级,
勇敢,HSK3级,</pre>
      <p style="margin-top: 10px; font-size: 12px; color: #856404;">
        💡 第二层级和第三层级可以为空。如果为空，该词属于词表但不在任何子分类中。
      </p>
    </div>

    <!-- 词表信息表单 -->
    <div class="form-section">
      <h2 style="margin-bottom: 20px;">1️⃣ 词表基本信息</h2>
      
      <div class="form-group">
        <label class="form-label">词表名称 *</label>
        <input type="text" id="wordlist-name" class="form-input" 
               placeholder="例如：HSK标准词表" required>
      </div>

      <div class="form-group">
        <label class="form-label">词表代码 *</label>
        <input type="text" id="wordlist-code" class="form-input" 
               placeholder="例如：hsk_standard（英文，唯一标识）" required>
        <div class="form-hint">只能包含英文字母、数字和下划线</div>
      </div>

      <div class="form-group">
        <label class="form-label">第二层级标签名称</label>
        <input type="text" id="level-2-label" class="form-input" 
               placeholder="例如：等级、年级、分类（可选）">
        <div class="form-hint">如词表有分级，请填写；无分级则留空</div>
      </div>

      <div class="form-group">
        <label class="form-label">第三层级标签名称</label>
        <input type="text" id="level-3-label" class="form-input" 
               placeholder="例如：单元、主题（可选）">
        <div class="form-hint">如有更细的分类，请填写；否则留空</div>
      </div>

      <div class="form-group">
        <label class="form-label">词表描述</label>
        <textarea id="wordlist-desc" class="form-textarea" 
                  placeholder="简单描述这个词表的用途和特点"></textarea>
      </div>
    </div>

    <!-- 文件上传 -->
    <div class="form-section">
      <h2 style="margin-bottom: 20px;">2️⃣ 上传词表文件</h2>
      
      <div class="form-group">
        <label class="form-label">选择 CSV 或 JSON 文件</label>
        <input type="file" id="file-input" accept=".csv,.json" class="form-input">
        <div class="form-hint">
          CSV 格式：词语,第二层级,第三层级<br>
          JSON 格式：[{word, level_2_tag, level_3_tag}, ...]
        </div>
      </div>

      <div id="file-preview" style="display: none; margin-top: 20px;">
        <h3>文件预览</h3>
        <div id="preview-content"></div>
      </div>
    </div>

    <!-- 导入按钮 -->
    <button class="btn btn-primary" id="import-btn" disabled>
      🚀 开始导入
    </button>

    <!-- 进度 -->
    <div id="progress-section" style="display: none; margin-top: 30px;">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
      </div>
      <p id="progress-text" style="text-align: center; margin-top: 10px;"></p>
    </div>

    <!-- 日志 -->
    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script type="module">
    import { initSupabase, getSupabase } from '../js/supabase-client.js'

    let supabase = null
    let fileData = null
    
    // 页面加载时初始化
    console.log('=== 系统词表导入工具 ===')
    
    // 初始化 Supabase
    async function initialize() {
      try {
        console.log('正在初始化 Supabase...')
        supabase = await initSupabase()
        console.log('✅ Supabase 客户端初始化成功')
        
        // 测试连接
        const { data, error } = await supabase.from('wordlists').select('count').limit(1)
        if (error) throw error
        console.log('✅ Supabase 连接正常')
      } catch (error) {
        console.error('❌ 初始化失败:', error)
        alert('⚠️ 数据库连接失败！\n\n请确保：\n1. 数据库迁移已完成\n2. 网络连接正常\n3. Supabase 配置正确\n\n错误: ' + error.message)
      }
    }
    
    // 立即执行初始化
    initialize()
    
    // 绑定事件监听器
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('file-input')
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect)
        console.log('✅ 文件选择器事件已绑定')
      }
      
      const importBtn = document.getElementById('import-btn')
      if (importBtn) {
        importBtn.addEventListener('click', importWordlist)
        console.log('✅ 导入按钮事件已绑定')
      }
    })

    /**
     * 处理文件选择
     */
    async function handleFileSelect(event) {
      const file = event.target.files[0]
      if (!file) {
        console.log('没有选择文件')
        return
      }

      console.log('选择的文件:', file.name, '大小:', file.size, 'bytes')

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.textContent = '解析中...'

      try {
        console.log('开始读取文件...')
        const text = await file.text()
        console.log('文件读取成功，内容长度:', text.length)
        
        if (file.name.endsWith('.csv')) {
          console.log('开始解析 CSV...')
          fileData = parseCSV(text)
          console.log('CSV 解析成功，词汇数量:', fileData.length)
        } else if (file.name.endsWith('.json')) {
          console.log('开始解析 JSON...')
          fileData = JSON.parse(text)
          console.log('JSON 解析成功，词汇数量:', fileData.length)
        } else {
          throw new Error('不支持的文件格式，请使用 .csv 或 .json 文件')
        }

        if (!fileData || fileData.length === 0) {
          throw new Error('文件中没有找到任何词汇数据')
        }

        // 显示预览
        console.log('显示文件预览...')
        showPreview(fileData)
        
        btn.disabled = false
        btn.textContent = '🚀 开始导入'
        console.log('✅ 文件加载成功，按钮已启用')

      } catch (error) {
        console.error('文件解析失败:', error)
        alert('文件解析失败: ' + error.message + '\n\n请检查浏览器控制台查看详细信息。')
        btn.disabled = true
        btn.textContent = '❌ 解析失败'
      }
    }

    /**
     * 解析 CSV
     */
    function parseCSV(text) {
      console.log('开始解析 CSV 文本...')
      
      const lines = text.trim().split('\n')
      console.log('总行数:', lines.length)
      
      if (lines.length < 2) {
        throw new Error('CSV 文件内容太少，至少需要表头和一行数据')
      }
      
      const headers = lines[0].split(',').map(h => h.trim())
      console.log('表头:', headers)
      
      // 检查必需的列
      if (!headers.includes('词语')) {
        throw new Error('CSV 文件缺少"词语"列。当前表头: ' + headers.join(', '))
      }

      const wordIndex = headers.indexOf('词语')
      const level2Index = headers.indexOf('第二层级')
      const level3Index = headers.indexOf('第三层级')
      
      console.log('列索引 - 词语:', wordIndex, '第二层级:', level2Index, '第三层级:', level3Index)

      const data = []
      let skipped = 0
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim()
        if (!line) {
          skipped++
          continue
        }
        
        const cells = line.split(',').map(c => c.trim())
        
        if (cells[wordIndex] && cells[wordIndex].length > 0) {
          data.push({
            word: cells[wordIndex],
            level_2_tag: (level2Index >= 0 && cells[level2Index]) ? cells[level2Index] : null,
            level_3_tag: (level3Index >= 0 && cells[level3Index]) ? cells[level3Index] : null
          })
        } else {
          skipped++
        }
        
        // 每解析1000行输出一次进度
        if (i % 1000 === 0) {
          console.log('已解析', i, '行，提取', data.length, '个词汇')
        }
      }
      
      console.log('解析完成 - 总行数:', lines.length, '有效词汇:', data.length, '跳过:', skipped)

      if (data.length === 0) {
        throw new Error('没有找到有效的词汇数据')
      }

      return data
    }

    /**
     * 显示预览
     */
    function showPreview(data) {
      const preview = document.getElementById('file-preview')
      const content = document.getElementById('preview-content')
      
      // 统计
      const stats = {
        total: data.length,
        hasLevel2: data.filter(d => d.level_2_tag).length,
        hasLevel3: data.filter(d => d.level_3_tag).length,
        level2Tags: [...new Set(data.map(d => d.level_2_tag).filter(Boolean))],
        level3Tags: [...new Set(data.map(d => d.level_3_tag).filter(Boolean))]
      }

      content.innerHTML = `
        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px;">
          <p><strong>文件统计：</strong></p>
          <p>• 总词汇数：${stats.total}</p>
          <p>• 有第二层级标签：${stats.hasLevel2} 个</p>
          <p>• 有第三层级标签：${stats.hasLevel3} 个</p>
          <p>• 检测到的第二层级标签：${stats.level2Tags.join('、') || '无'}</p>
          <p>• 检测到的第三层级标签：${stats.level3Tags.join('、') || '无'}</p>
        </div>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px;">
          <table style="width: 100%; font-size: 12px;">
            <tr style="background: #f5f5f5; font-weight: bold;">
              <th style="padding: 8px;">词语</th>
              <th style="padding: 8px;">第二层级</th>
              <th style="padding: 8px;">第三层级</th>
            </tr>
            ${data.slice(0, 10).map(d => `
              <tr>
                <td style="padding: 8px;">${d.word}</td>
                <td style="padding: 8px;">${d.level_2_tag || '-'}</td>
                <td style="padding: 8px;">${d.level_3_tag || '-'}</td>
              </tr>
            `).join('')}
            ${data.length > 10 ? `<tr><td colspan="3" style="text-align: center; padding: 8px; color: #999;">... 还有 ${data.length - 10} 个词</td></tr>` : ''}
          </table>
        </div>
      `
      
      preview.style.display = 'block'
    }

    /**
     * 导入词表
     */
    async function importWordlist() {
      if (!fileData || fileData.length === 0) {
        alert('请先选择文件')
        return
      }

      // 获取表单数据
      const name = document.getElementById('wordlist-name').value.trim()
      const code = document.getElementById('wordlist-code').value.trim()
      const level2Label = document.getElementById('level-2-label').value.trim() || null
      const level3Label = document.getElementById('level-3-label').value.trim() || null
      const description = document.getElementById('wordlist-desc').value.trim()

      if (!name || !code) {
        alert('请填写词表名称和代码')
        return
      }

      // 验证代码格式
      if (!/^[a-z0-9_]+$/.test(code)) {
        alert('词表代码只能包含小写英文字母、数字和下划线')
        return
      }

      const confirmed = confirm(
        `确定要导入词表吗？\n\n` +
        `词表名称：${name}\n` +
        `词表代码：${code}\n` +
        `词汇数量：${fileData.length}\n\n` +
        `导入过程中会：\n` +
        `1. 创建词表记录\n` +
        `2. 创建层级标签\n` +
        `3. 导入词汇（不存在的词会调用AI评估难度）\n` +
        `4. 创建词汇-词表关联`
      )

      if (!confirmed) return

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.innerHTML = '<span class="spinner"></span> 导入中...'

      const progressSection = document.getElementById('progress-section')
      const logDiv = document.getElementById('log')
      progressSection.style.display = 'block'
      logDiv.style.display = 'block'

      try {
        // 1. 创建词表
        addLog('📝 创建词表记录...', 'success')
        
        const { data: wordlist, error: wlError } = await supabase
          .from('wordlists')
          .insert({
            name,
            code,
            type: 'system',
            hierarchy_config: {
              level_2_label: level2Label,
              level_3_label: level3Label
            },
            description
          })
          .select()
          .single()

        if (wlError) throw wlError
        addLog(`✅ 词表创建成功: ${name} (${code})`, 'success')

        // 2. 提取并创建标签
        addLog('\n📋 创建层级标签...', 'success')
        
        const level2Tags = [...new Set(fileData.map(d => d.level_2_tag).filter(Boolean))]
        const level3Tags = [...new Set(fileData.map(d => d.level_3_tag).filter(Boolean))]

        const level2TagMap = {}
        const level3TagMap = {}

        // 创建第二层级标签
        for (const tag of level2Tags) {
          const { data: tagData, error: tagError } = await supabase
            .from('wordlist_tags')
            .insert({
              wordlist_id: wordlist.id,
              tag_level: 2,
              tag_code: tag,
              tag_display_name: tag,
              sort_order: level2Tags.indexOf(tag)
            })
            .select()
            .single()

          if (tagError) throw tagError
          level2TagMap[tag] = tagData.id
          addLog(`  ✅ 第二层级: ${tag}`, 'success')
        }

        // 创建第三层级标签
        for (const tag of level3Tags) {
          const { data: tagData, error: tagError } = await supabase
            .from('wordlist_tags')
            .insert({
              wordlist_id: wordlist.id,
              tag_level: 3,
              tag_code: tag,
              tag_display_name: tag,
              sort_order: level3Tags.indexOf(tag)
            })
            .select()
            .single()

          if (tagError) throw tagError
          level3TagMap[tag] = tagData.id
          addLog(`  ✅ 第三层级: ${tag}`, 'success')
        }

        // 3. 导入词汇
        addLog('\n📚 开始导入词汇...', 'success')
        
        let newVocabCount = 0
        let existingVocabCount = 0
        let aiEvaluatedCount = 0
        let mappingCount = 0

        for (let i = 0; i < fileData.length; i++) {
          const item = fileData[i]
          
          updateProgress((i / fileData.length) * 100)

          try {
            // 查找或创建词汇
            let { data: vocab, error: findError } = await supabase
              .from('vocabulary')
              .select('*')
              .eq('word', item.word)
              .maybeSingle()

            if (findError) throw findError

            if (!vocab) {
              // 新词汇：需要AI评估难度
              addLog(`  🤖 新词"${item.word}"，调用AI评估难度...`)
              
              // 调用AI评估
              const { data: evalData, error: evalError } = await supabase.functions.invoke(
                'vocab-difficulty-evaluator',
                {
                  body: {
                    words: [{ word: item.word }],
                    mode: 'single'
                  }
                }
              )

              if (evalError) {
                console.error('AI评估失败，使用默认值', evalError)
              }

              const evaluation = evalData?.results?.[0] || { 
                difficulty: 3, 
                category: '未知', 
                confidence: 'low',
                reasoning: 'AI评估失败，使用默认值'
              }

              // 创建词汇
              const { data: newVocab, error: insertError } = await supabase
                .from('vocabulary')
                .insert({
                  word: item.word,
                  difficulty_level: evaluation.difficulty,
                  category: evaluation.category,
                  frequency: 50,
                  difficulty_confidence: evaluation.confidence,
                  difficulty_reasoning: evaluation.reasoning,
                  difficulty_evaluated_at: new Date().toISOString()
                })
                .select()
                .single()

              if (insertError) throw insertError
              
              vocab = newVocab
              newVocabCount++
              aiEvaluatedCount++
              addLog(`  ✅ 新增: ${item.word} (AI评估为 L${evaluation.difficulty})`, 'success')
            } else {
              existingVocabCount++
            }

            // 创建关联
            const tagPath = [item.level_2_tag, item.level_3_tag].filter(Boolean)
            
            const { error: mappingError } = await supabase
              .from('vocabulary_wordlist_mapping')
              .insert({
                vocabulary_id: vocab.id,
                wordlist_id: wordlist.id,
                tag_path: JSON.stringify(tagPath),
                level_2_tag: item.level_2_tag || null,
                level_3_tag: item.level_3_tag || null
              })

            if (mappingError && mappingError.code !== '23505') { // 忽略重复错误
              throw mappingError
            }
            
            mappingCount++

          } catch (error) {
            console.error(`处理失败: ${item.word}`, error)
            addLog(`  ❌ 失败: ${item.word} - ${error.message}`, 'error')
          }
        }

        updateProgress(100)

        addLog('\n============================', 'success')
        addLog(`✅ 导入完成！`, 'success')
        addLog(`📊 统计：`, 'success')
        addLog(`  - 新增词汇: ${newVocabCount}`, 'success')
        addLog(`  - 已存在词汇: ${existingVocabCount}`, 'success')
        addLog(`  - AI评估: ${aiEvaluatedCount}`, 'success')
        addLog(`  - 创建关联: ${mappingCount}`, 'success')
        addLog('============================', 'success')

        btn.textContent = '✅ 导入完成'
        
        setTimeout(() => {
          alert(
            `✅ 系统词表导入成功！\n\n` +
            `词表名称：${name}\n` +
            `导入词汇：${fileData.length} 个\n` +
            `新增词汇：${newVocabCount} 个\n` +
            `AI评估：${aiEvaluatedCount} 个`
          )
        }, 500)

      } catch (error) {
        console.error('导入失败:', error)
        addLog(`\n❌ 导入失败: ${error.message}`, 'error')
        btn.textContent = '❌ 导入失败'
        btn.disabled = false
        alert('导入失败: ' + error.message)
      }
    }

    /**
     * 更新进度
     */
    function updateProgress(percent) {
      const fill = document.getElementById('progress-fill')
      const text = document.getElementById('progress-text')
      
      fill.style.width = percent + '%'
      fill.textContent = Math.round(percent) + '%'
      text.textContent = `处理中... ${Math.round(percent)}%`
    }

    /**
     * 添加日志
     */
    function addLog(message, type = '') {
      const logDiv = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = 'log-entry ' + type
      entry.textContent = message
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }
  </script>
</body>
</html>

