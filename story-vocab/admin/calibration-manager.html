<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>校准词管理器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    
    .action-bar {
      display: flex;
      gap: 10px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .level-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }
    
    .level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .level-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .badge {
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .words-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .word-card {
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.2s;
    }
    
    .word-card.modified {
      border-color: #ffa500;
      background: #fff8e1;
      box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);
    }
    
    .word-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .word-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .word-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .word-meta span {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .confidence {
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .confidence.high {
      background: #d4edda;
      color: #155724;
    }
    
    .confidence.medium {
      background: #fff3cd;
      color: #856404;
    }
    
    .confidence.low {
      background: #f8d7da;
      color: #721c24;
    }
    
    .reasoning {
      font-size: 11px;
      color: #666;
      font-style: italic;
      margin-bottom: 12px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .difficulty-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .difficulty-btn {
      flex: 1;
      height: 40px;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .difficulty-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: scale(1.05);
    }
    
    .difficulty-btn:hover:not(.active) {
      border-color: #667eea;
      background: #f0f2ff;
    }
    
    .word-actions {
      display: flex;
      gap: 8px;
    }
    
    .word-actions button {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .word-actions button:hover {
      background: #f5f5f5;
    }
    
    .add-word-section {
      margin: 30px 0;
      padding: 25px;
      background: #e3f2fd;
      border-radius: 12px;
      border-left: 5px solid #2196f3;
    }
    
    .add-word-form {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .add-word-form input,
    .add-word-form select {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .add-word-form input {
      flex: 2;
      min-width: 200px;
    }
    
    .add-word-form select {
      flex: 1;
      min-width: 120px;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📚 校准词库管理器</h1>
    <p class="subtitle">管理150个黄金标准词汇，为AI评估系统提供参考基准</p>

    <!-- 统计信息 -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">总计</div>
        <div class="stat-value" id="total-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">高置信度</div>
        <div class="stat-value" id="high-confidence-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">待校对</div>
        <div class="stat-value" id="pending-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">已修改</div>
        <div class="stat-value" id="modified-count">0</div>
      </div>
    </div>

    <!-- 操作按钮 -->
    <div class="action-bar">
      <button class="btn btn-primary" id="save-btn" onclick="saveAllChanges()" disabled>
        💾 保存所有修改
      </button>
      <button class="btn btn-secondary" onclick="reEvaluateAllWords()">
        🤖 重新评估所有词汇
      </button>
      <button class="btn btn-secondary" onclick="exportCalibration()">
        📤 导出校准词库
      </button>
      <button class="btn btn-secondary" onclick="location.href='import-calibration-words.html'">
        📥 重新导入JSON
      </button>
      <button class="btn btn-secondary" onclick="location.href='index.html'">
        ← 返回Admin首页
      </button>
    </div>

    <!-- 添加新校准词 -->
    <div class="add-word-section">
      <h3 style="margin-bottom: 15px;">➕ 添加新校准词</h3>
      <div class="add-word-form">
        <input type="text" id="new-word" placeholder="输入词语（繁体中文）">
        <select id="new-difficulty">
          <option value="1">L1 (7-8岁)</option>
          <option value="2">L2 (9-10岁)</option>
          <option value="3" selected>L3 (11-12岁)</option>
          <option value="4">L4 (13-14岁)</option>
          <option value="5">L5 (15-16岁)</option>
          <option value="6">L6 (17-18岁)</option>
        </select>
        <select id="new-category">
          <option value="動詞">動詞</option>
          <option value="形容詞">形容詞</option>
          <option value="名詞">名詞</option>
          <option value="成語">成語</option>
          <option value="副詞">副詞</option>
        </select>
        <button class="btn btn-primary" onclick="addCalibrationWord()">
          添加
        </button>
      </div>
    </div>

    <!-- 按难度等级分组显示 -->
    <div id="calibration-words">
      <p style="text-align: center; color: #999; padding: 40px;">
        加载中...
      </p>
    </div>
  </div>

  <script type="module">
    import { getSupabase } from '../js/supabase-client.js'

    const supabase = getSupabase()
    let calibrationWords = []
    let modifiedWords = new Set()

    /**
     * 加载所有校准词
     */
    async function loadCalibrationWords() {
      try {
        const { data, error } = await supabase
          .from('vocabulary')
          .select('*')
          .eq('is_calibration', true)
          .order('calibration_order')

        if (error) throw error

        calibrationWords = data || []
        renderCalibrationWords()
        updateStats()

        console.log(`✅ 加载了 ${calibrationWords.length} 个校准词`)
      } catch (error) {
        console.error('加载失败:', error)
        document.getElementById('calibration-words').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <p style="font-size: 24px; margin-bottom: 10px;">❌ 加载失败</p>
            <p>${error.message}</p>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px; width: auto;">
              重新加载
            </button>
          </div>
        `
      }
    }

    /**
     * 按难度等级渲染
     */
    function renderCalibrationWords() {
      const container = document.getElementById('calibration-words')
      
      if (calibrationWords.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #999; padding: 40px;">
            <p style="font-size: 24px; margin-bottom: 10px;">📭 暂无校准词</p>
            <p>请先使用"导入JSON"功能导入校准词库</p>
            <button class="btn btn-primary" onclick="location.href='import-calibration-words.html'" style="margin-top: 20px; width: auto;">
              前往导入
            </button>
          </div>
        `
        return
      }
      
      // 按难度分组
      const byLevel = calibrationWords.reduce((acc, word) => {
        const level = word.difficulty_level || 0
        if (!acc[level]) acc[level] = []
        acc[level].push(word)
        return acc
      }, {})

      container.innerHTML = ''

      for (let level = 1; level <= 6; level++) {
        const words = byLevel[level] || []
        
        const section = document.createElement('div')
        section.className = 'level-section'
        section.innerHTML = `
          <div class="level-header">
            <div class="level-title">
              L${level} 级 - ${getLevelDescription(level)}
            </div>
            <span class="badge">${words.length} 个词</span>
          </div>
          <div class="words-grid" id="level-${level}"></div>
        `
        container.appendChild(section)

        const wordsGrid = section.querySelector(`#level-${level}`)
        words.forEach(word => {
          wordsGrid.appendChild(createWordCard(word))
        })
      }
    }

    /**
     * 创建词汇卡片
     */
    function createWordCard(word) {
      const card = document.createElement('div')
      card.className = 'word-card'
      card.id = `word-${word.id}`
      
      if (modifiedWords.has(word.id)) {
        card.classList.add('modified')
      }

      card.innerHTML = `
        <div class="word-title">${word.word}</div>
        
        <div class="word-meta">
          <span>类型: ${word.category || '未知'}</span>
          <span>频率: ${word.frequency || '-'}</span>
          <span>顺序: #${word.calibration_order || '-'}</span>
          ${word.difficulty_confidence ? 
            `<span class="confidence ${word.difficulty_confidence}">
              ${word.difficulty_confidence}
            </span>` : ''}
        </div>
        
        ${word.difficulty_reasoning ? 
          `<div class="reasoning">
            💡 ${word.difficulty_reasoning}
          </div>` : ''}
        
        <div class="difficulty-selector">
          ${[1,2,3,4,5,6].map(level => `
            <button 
              class="difficulty-btn ${word.difficulty_level === level ? 'active' : ''}"
              onclick="changeDifficulty('${word.id}', ${level})"
              title="L${level}"
            >
              ${level}
            </button>
          `).join('')}
        </div>
        
        <div class="word-actions">
          <button onclick="removeFromCalibration('${word.id}')" title="移除校准词">
            🗑️ 移除
          </button>
          <button onclick="viewWordDetail('${word.word}')" title="查萌典">
            🔍 查询
          </button>
        </div>
      `
      
      return card
    }

    /**
     * 修改难度等级
     */
    window.changeDifficulty = function(wordId, newLevel) {
      const word = calibrationWords.find(w => w.id === wordId)
      if (!word) return

      const oldLevel = word.difficulty_level

      // 更新本地数据
      word.difficulty_level = newLevel
      word.difficulty_confidence = 'high' // 人工调整后置信度为high
      word.difficulty_reasoning = oldLevel === newLevel 
        ? word.difficulty_reasoning 
        : `人工校准（原 L${oldLevel} → L${newLevel}）`
      
      // 标记为已修改
      modifiedWords.add(wordId)
      
      // 重新渲染
      renderCalibrationWords()
      updateStats()
      
      // 启用保存按钮
      document.getElementById('save-btn').disabled = false

      console.log(`${word.word}: L${oldLevel} → L${newLevel}`)
    }

    /**
     * 保存所有修改
     */
    window.saveAllChanges = async function() {
      if (modifiedWords.size === 0) {
        alert('没有修改需要保存')
        return
      }

      const confirmed = confirm(
        `确定要保存 ${modifiedWords.size} 个词的修改吗？\n\n` +
        `保存后会自动重新排序校准词。`
      )

      if (!confirmed) return

      const btn = document.getElementById('save-btn')
      btn.disabled = true
      btn.innerHTML = '<span class="spinner"></span> 保存中...'

      let successCount = 0
      let errorCount = 0

      for (const wordId of modifiedWords) {
        const word = calibrationWords.find(w => w.id === wordId)
        
        try {
          const { error } = await supabase
            .from('vocabulary')
            .update({
              difficulty_level: word.difficulty_level,
              difficulty_confidence: word.difficulty_confidence,
              difficulty_reasoning: word.difficulty_reasoning,
              difficulty_evaluated_at: new Date().toISOString()
            })
            .eq('id', wordId)

          if (error) throw error
          successCount++
        } catch (error) {
          console.error(`保存失败: ${word.word}`, error)
          errorCount++
        }
      }

      // 重新计算校准顺序
      await recalculateCalibrationOrder()

      modifiedWords.clear()
      
      btn.textContent = '💾 保存所有修改'
      btn.disabled = true

      alert(
        `✅ 保存完成！\n\n` +
        `成功: ${successCount} 个\n` +
        `失败: ${errorCount} 个`
      )
      
      // 询问是否重新评估
      const reEvaluate = confirm(
        '校准标准已更新！\n\n' +
        '是否要基于新的标准重新评估所有其他词汇的难度？\n' +
        '（这可能需要几分钟，会消耗 DeepSeek API 额度）'
      )
      
      if (reEvaluate) {
        await reEvaluateAllWords()
      }

      loadCalibrationWords()
    }

    /**
     * 重新计算校准顺序
     */
    async function recalculateCalibrationOrder() {
      // 按难度排序，同难度按频率排序
      const sorted = [...calibrationWords].sort((a, b) => {
        if (a.difficulty_level !== b.difficulty_level) {
          return a.difficulty_level - b.difficulty_level
        }
        return (b.frequency || 0) - (a.frequency || 0)
      })

      for (let i = 0; i < sorted.length; i++) {
        await supabase
          .from('vocabulary')
          .update({ calibration_order: i + 1 })
          .eq('id', sorted[i].id)
      }

      console.log('✅ 已重新排序校准词')
    }

    /**
     * 从校准词库移除
     */
    window.removeFromCalibration = async function(wordId) {
      const word = calibrationWords.find(w => w.id === wordId)
      if (!word) return

      const confirmed = confirm(
        `确定要将"${word.word}"从校准词库中移除吗？\n\n` +
        `它仍会保留在词汇库中，但不再作为 AI 评估的参考标准。`
      )

      if (!confirmed) return

      try {
        const { error } = await supabase
          .from('vocabulary')
          .update({
            is_calibration: false,
            calibration_order: null
          })
          .eq('id', wordId)

        if (error) throw error

        alert(`✅ 已移除"${word.word}"`)
        loadCalibrationWords()
      } catch (error) {
        alert('移除失败: ' + error.message)
      }
    }

    /**
     * 添加新校准词
     */
    window.addCalibrationWord = async function() {
      const wordInput = document.getElementById('new-word')
      const difficultySelect = document.getElementById('new-difficulty')
      const categorySelect = document.getElementById('new-category')
      
      const word = wordInput.value.trim()
      const difficulty = parseInt(difficultySelect.value)
      const category = categorySelect.value

      if (!word) {
        alert('请输入词语')
        return
      }

      try {
        // 检查词语是否存在
        const { data: existing } = await supabase
          .from('vocabulary')
          .select('*')
          .eq('word', word)
          .maybeSingle()

        if (existing && existing.is_calibration) {
          alert(`"${word}"已经是校准词！`)
          return
        }

        // 计算新的顺序
        const maxOrder = Math.max(...calibrationWords.map(w => w.calibration_order || 0), 0)

        if (existing) {
          // 更新现有词汇
          const { error } = await supabase
            .from('vocabulary')
            .update({
              is_calibration: true,
              calibration_order: maxOrder + 1,
              difficulty_level: difficulty,
              category: category,
              difficulty_confidence: 'high',
              difficulty_reasoning: '人工添加的校准词',
              difficulty_evaluated_at: new Date().toISOString()
            })
            .eq('id', existing.id)

          if (error) throw error
        } else {
          // 创建新词汇
          const { error } = await supabase
            .from('vocabulary')
            .insert({
              word: word,
              difficulty_level: difficulty,
              category: category,
              frequency: 50,
              is_calibration: true,
              calibration_order: maxOrder + 1,
              difficulty_confidence: 'high',
              difficulty_reasoning: '人工添加的校准词',
              difficulty_evaluated_at: new Date().toISOString()
            })

          if (error) throw error
        }

        alert(`✅ 已添加"${word}"为 L${difficulty} 校准词`)
        wordInput.value = ''
        loadCalibrationWords()

      } catch (error) {
        alert('添加失败: ' + error.message)
      }
    }

    /**
     * 重新评估所有词汇
     */
    window.reEvaluateAllWords = async function() {
      const confirmed = confirm(
        '⚠️ 这将基于当前的校准词，重新评估所有其他词汇的难度。\n\n' +
        '这可能需要几分钟时间，并会消耗 DeepSeek API 额度。\n\n' +
        '确定继续吗？'
      )

      if (!confirmed) return

      try {
        // 获取所有非校准词
        const { data: wordsToEvaluate, error } = await supabase
          .from('vocabulary')
          .select('*')
          .eq('is_calibration', false)

        if (error) throw error

        console.log(`开始评估 ${wordsToEvaluate.length} 个词汇...`)

        // 调用 AI 评估 Edge Function
        const { data, error: funcError } = await supabase.functions.invoke(
          'vocab-difficulty-evaluator',
          {
            body: {
              words: wordsToEvaluate,
              mode: 'recalibrate_all'
            }
          }
        )

        if (funcError) throw funcError

        alert(
          `✅ 评估完成！\n\n` +
          `成功: ${data.success_count} 个\n` +
          `失败: ${data.error_count} 个`
        )

      } catch (error) {
        alert('评估失败: ' + error.message)
      }
    }

    /**
     * 导出校准词库
     */
    window.exportCalibration = function() {
      if (calibrationWords.length === 0) {
        alert('没有可导出的校准词')
        return
      }

      // 按等级分组
      const byLevel = calibrationWords.reduce((acc, word) => {
        const level = `L${word.difficulty_level}`
        if (!acc[level]) acc[level] = []
        acc[level].push({
          word: word.word,
          difficulty: word.difficulty_level,
          category: word.category,
          frequency: word.frequency
        })
        return acc
      }, {})

      const exportData = {
        metadata: {
          name: '校准词库',
          version: '3.0',
          exported_at: new Date().toISOString(),
          total_words: calibrationWords.length,
          purpose: '用于第一次游戏的基准测试和AI评估参考'
        },
        calibration_words: byLevel
      }

      const json = JSON.stringify(exportData, null, 2)
      const blob = new Blob([json], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `calibration-words-${Date.now()}.json`
      a.click()

      console.log('✅ 已导出校准词库')
    }

    /**
     * 查看词语详情（萌典）
     */
    window.viewWordDetail = function(word) {
      window.open(`https://www.moedict.tw/~${word}`, '_blank')
    }

    /**
     * 更新统计
     */
    function updateStats() {
      document.getElementById('total-count').textContent = calibrationWords.length
      document.getElementById('high-confidence-count').textContent = 
        calibrationWords.filter(w => w.difficulty_confidence === 'high').length
      document.getElementById('pending-count').textContent = 
        calibrationWords.filter(w => w.difficulty_confidence !== 'high').length
      document.getElementById('modified-count').textContent = modifiedWords.size
      
      // 如果有修改，启用保存按钮
      document.getElementById('save-btn').disabled = modifiedWords.size === 0
    }

    /**
     * 辅助函数
     */
    function getLevelDescription(level) {
      const descriptions = {
        1: '7-8岁，小学2-3年级',
        2: '9-10岁，小学4-5年级',
        3: '11-12岁，小学6年级-初一',
        4: '13-14岁，初二-初三',
        5: '15-16岁，高一-高二',
        6: '17-18岁，高三及以上'
      }
      return descriptions[level] || ''
    }

    // 页面加载时执行
    window.addEventListener('load', () => {
      loadCalibrationWords()
    })
  </script>
</body>
</html>

