<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ¡å‡†è¯ç®¡ç†å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    
    .action-bar {
      display: flex;
      gap: 10px;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .level-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }
    
    .level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .level-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .badge {
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .words-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .word-card {
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.2s;
    }
    
    .word-card.modified {
      border-color: #ffa500;
      background: #fff8e1;
      box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);
    }
    
    .word-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .word-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .word-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .word-meta span {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .confidence {
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .confidence.high {
      background: #d4edda;
      color: #155724;
    }
    
    .confidence.medium {
      background: #fff3cd;
      color: #856404;
    }
    
    .confidence.low {
      background: #f8d7da;
      color: #721c24;
    }
    
    .reasoning {
      font-size: 11px;
      color: #666;
      font-style: italic;
      margin-bottom: 12px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .difficulty-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .difficulty-btn {
      flex: 1;
      height: 40px;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .difficulty-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
      transform: scale(1.05);
    }
    
    .difficulty-btn:hover:not(.active) {
      border-color: #667eea;
      background: #f0f2ff;
    }
    
    .word-actions {
      display: flex;
      gap: 8px;
    }
    
    .word-actions button {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .word-actions button:hover {
      background: #f5f5f5;
    }
    
    .add-word-section {
      margin: 30px 0;
      padding: 25px;
      background: #e3f2fd;
      border-radius: 12px;
      border-left: 5px solid #2196f3;
    }
    
    .add-word-form {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .add-word-form input,
    .add-word-form select {
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .add-word-form input {
      flex: 2;
      min-width: 200px;
    }
    
    .add-word-form select {
      flex: 1;
      min-width: 120px;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š æ ¡å‡†è¯åº“ç®¡ç†å™¨</h1>
    <p class="subtitle">ç®¡ç†150ä¸ªé»„é‡‘æ ‡å‡†è¯æ±‡ï¼Œä¸ºAIè¯„ä¼°ç³»ç»Ÿæä¾›å‚è€ƒåŸºå‡†</p>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">æ€»è®¡</div>
        <div class="stat-value" id="total-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">é«˜ç½®ä¿¡åº¦</div>
        <div class="stat-value" id="high-confidence-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å¾…æ ¡å¯¹</div>
        <div class="stat-value" id="pending-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å·²ä¿®æ”¹</div>
        <div class="stat-value" id="modified-count">0</div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-bar">
      <button class="btn btn-primary" id="save-btn" onclick="saveAllChanges()" disabled>
        ğŸ’¾ ä¿å­˜æ‰€æœ‰ä¿®æ”¹
      </button>
      <button class="btn btn-secondary" onclick="reEvaluateAllWords()">
        ğŸ¤– é‡æ–°è¯„ä¼°æ‰€æœ‰è¯æ±‡
      </button>
      <button class="btn btn-secondary" onclick="exportCalibration()">
        ğŸ“¤ å¯¼å‡ºæ ¡å‡†è¯åº“
      </button>
      <button class="btn btn-secondary" onclick="location.href='import-calibration-words.html'">
        ğŸ“¥ é‡æ–°å¯¼å…¥JSON
      </button>
      <button class="btn btn-secondary" onclick="location.href='index.html'">
        â† è¿”å›Adminé¦–é¡µ
      </button>
    </div>

    <!-- æ·»åŠ æ–°æ ¡å‡†è¯ -->
    <div class="add-word-section">
      <h3 style="margin-bottom: 15px;">â• æ·»åŠ æ–°æ ¡å‡†è¯</h3>
      <div class="add-word-form">
        <input type="text" id="new-word" placeholder="è¾“å…¥è¯è¯­ï¼ˆç¹ä½“ä¸­æ–‡ï¼‰">
        <select id="new-difficulty">
          <option value="1">L1 (7-8å²)</option>
          <option value="2">L2 (9-10å²)</option>
          <option value="3" selected>L3 (11-12å²)</option>
          <option value="4">L4 (13-14å²)</option>
          <option value="5">L5 (15-16å²)</option>
          <option value="6">L6 (17-18å²)</option>
        </select>
        <select id="new-category">
          <option value="å‹•è©">å‹•è©</option>
          <option value="å½¢å®¹è©">å½¢å®¹è©</option>
          <option value="åè©">åè©</option>
          <option value="æˆèª">æˆèª</option>
          <option value="å‰¯è©">å‰¯è©</option>
        </select>
        <button class="btn btn-primary" onclick="addCalibrationWord()">
          æ·»åŠ 
        </button>
      </div>
    </div>

    <!-- æŒ‰éš¾åº¦ç­‰çº§åˆ†ç»„æ˜¾ç¤º -->
    <div id="calibration-words">
      <p style="text-align: center; color: #999; padding: 40px;">
        åŠ è½½ä¸­...
      </p>
    </div>
  </div>

  <script type="module">
    import { getSupabase } from '../js/supabase-client.js'

    const supabase = getSupabase()
    let calibrationWords = []
    let modifiedWords = new Set()

    /**
     * åŠ è½½æ‰€æœ‰æ ¡å‡†è¯
     */
    async function loadCalibrationWords() {
      try {
        const { data, error } = await supabase
          .from('vocabulary')
          .select('*')
          .eq('is_calibration', true)
          .order('calibration_order')

        if (error) throw error

        calibrationWords = data || []
        renderCalibrationWords()
        updateStats()

        console.log(`âœ… åŠ è½½äº† ${calibrationWords.length} ä¸ªæ ¡å‡†è¯`)
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error)
        document.getElementById('calibration-words').innerHTML = `
          <div style="text-align: center; color: #dc3545; padding: 40px;">
            <p style="font-size: 24px; margin-bottom: 10px;">âŒ åŠ è½½å¤±è´¥</p>
            <p>${error.message}</p>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px; width: auto;">
              é‡æ–°åŠ è½½
            </button>
          </div>
        `
      }
    }

    /**
     * æŒ‰éš¾åº¦ç­‰çº§æ¸²æŸ“
     */
    function renderCalibrationWords() {
      const container = document.getElementById('calibration-words')
      
      if (calibrationWords.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #999; padding: 40px;">
            <p style="font-size: 24px; margin-bottom: 10px;">ğŸ“­ æš‚æ— æ ¡å‡†è¯</p>
            <p>è¯·å…ˆä½¿ç”¨"å¯¼å…¥JSON"åŠŸèƒ½å¯¼å…¥æ ¡å‡†è¯åº“</p>
            <button class="btn btn-primary" onclick="location.href='import-calibration-words.html'" style="margin-top: 20px; width: auto;">
              å‰å¾€å¯¼å…¥
            </button>
          </div>
        `
        return
      }
      
      // æŒ‰éš¾åº¦åˆ†ç»„
      const byLevel = calibrationWords.reduce((acc, word) => {
        const level = word.difficulty_level || 0
        if (!acc[level]) acc[level] = []
        acc[level].push(word)
        return acc
      }, {})

      container.innerHTML = ''

      for (let level = 1; level <= 6; level++) {
        const words = byLevel[level] || []
        
        const section = document.createElement('div')
        section.className = 'level-section'
        section.innerHTML = `
          <div class="level-header">
            <div class="level-title">
              L${level} çº§ - ${getLevelDescription(level)}
            </div>
            <span class="badge">${words.length} ä¸ªè¯</span>
          </div>
          <div class="words-grid" id="level-${level}"></div>
        `
        container.appendChild(section)

        const wordsGrid = section.querySelector(`#level-${level}`)
        words.forEach(word => {
          wordsGrid.appendChild(createWordCard(word))
        })
      }
    }

    /**
     * åˆ›å»ºè¯æ±‡å¡ç‰‡
     */
    function createWordCard(word) {
      const card = document.createElement('div')
      card.className = 'word-card'
      card.id = `word-${word.id}`
      
      if (modifiedWords.has(word.id)) {
        card.classList.add('modified')
      }

      card.innerHTML = `
        <div class="word-title">${word.word}</div>
        
        <div class="word-meta">
          <span>ç±»å‹: ${word.category || 'æœªçŸ¥'}</span>
          <span>é¢‘ç‡: ${word.frequency || '-'}</span>
          <span>é¡ºåº: #${word.calibration_order || '-'}</span>
          ${word.difficulty_confidence ? 
            `<span class="confidence ${word.difficulty_confidence}">
              ${word.difficulty_confidence}
            </span>` : ''}
        </div>
        
        ${word.difficulty_reasoning ? 
          `<div class="reasoning">
            ğŸ’¡ ${word.difficulty_reasoning}
          </div>` : ''}
        
        <div class="difficulty-selector">
          ${[1,2,3,4,5,6].map(level => `
            <button 
              class="difficulty-btn ${word.difficulty_level === level ? 'active' : ''}"
              onclick="changeDifficulty('${word.id}', ${level})"
              title="L${level}"
            >
              ${level}
            </button>
          `).join('')}
        </div>
        
        <div class="word-actions">
          <button onclick="removeFromCalibration('${word.id}')" title="ç§»é™¤æ ¡å‡†è¯">
            ğŸ—‘ï¸ ç§»é™¤
          </button>
          <button onclick="viewWordDetail('${word.word}')" title="æŸ¥èŒå…¸">
            ğŸ” æŸ¥è¯¢
          </button>
        </div>
      `
      
      return card
    }

    /**
     * ä¿®æ”¹éš¾åº¦ç­‰çº§
     */
    window.changeDifficulty = function(wordId, newLevel) {
      const word = calibrationWords.find(w => w.id === wordId)
      if (!word) return

      const oldLevel = word.difficulty_level

      // æ›´æ–°æœ¬åœ°æ•°æ®
      word.difficulty_level = newLevel
      word.difficulty_confidence = 'high' // äººå·¥è°ƒæ•´åç½®ä¿¡åº¦ä¸ºhigh
      word.difficulty_reasoning = oldLevel === newLevel 
        ? word.difficulty_reasoning 
        : `äººå·¥æ ¡å‡†ï¼ˆåŸ L${oldLevel} â†’ L${newLevel}ï¼‰`
      
      // æ ‡è®°ä¸ºå·²ä¿®æ”¹
      modifiedWords.add(wordId)
      
      // é‡æ–°æ¸²æŸ“
      renderCalibrationWords()
      updateStats()
      
      // å¯ç”¨ä¿å­˜æŒ‰é’®
      document.getElementById('save-btn').disabled = false

      console.log(`${word.word}: L${oldLevel} â†’ L${newLevel}`)
    }

    /**
     * ä¿å­˜æ‰€æœ‰ä¿®æ”¹
     */
    window.saveAllChanges = async function() {
      if (modifiedWords.size === 0) {
        alert('æ²¡æœ‰ä¿®æ”¹éœ€è¦ä¿å­˜')
        return
      }

      const confirmed = confirm(
        `ç¡®å®šè¦ä¿å­˜ ${modifiedWords.size} ä¸ªè¯çš„ä¿®æ”¹å—ï¼Ÿ\n\n` +
        `ä¿å­˜åä¼šè‡ªåŠ¨é‡æ–°æ’åºæ ¡å‡†è¯ã€‚`
      )

      if (!confirmed) return

      const btn = document.getElementById('save-btn')
      btn.disabled = true
      btn.innerHTML = '<span class="spinner"></span> ä¿å­˜ä¸­...'

      let successCount = 0
      let errorCount = 0

      for (const wordId of modifiedWords) {
        const word = calibrationWords.find(w => w.id === wordId)
        
        try {
          const { error } = await supabase
            .from('vocabulary')
            .update({
              difficulty_level: word.difficulty_level,
              difficulty_confidence: word.difficulty_confidence,
              difficulty_reasoning: word.difficulty_reasoning,
              difficulty_evaluated_at: new Date().toISOString()
            })
            .eq('id', wordId)

          if (error) throw error
          successCount++
        } catch (error) {
          console.error(`ä¿å­˜å¤±è´¥: ${word.word}`, error)
          errorCount++
        }
      }

      // é‡æ–°è®¡ç®—æ ¡å‡†é¡ºåº
      await recalculateCalibrationOrder()

      modifiedWords.clear()
      
      btn.textContent = 'ğŸ’¾ ä¿å­˜æ‰€æœ‰ä¿®æ”¹'
      btn.disabled = true

      alert(
        `âœ… ä¿å­˜å®Œæˆï¼\n\n` +
        `æˆåŠŸ: ${successCount} ä¸ª\n` +
        `å¤±è´¥: ${errorCount} ä¸ª`
      )
      
      // è¯¢é—®æ˜¯å¦é‡æ–°è¯„ä¼°
      const reEvaluate = confirm(
        'æ ¡å‡†æ ‡å‡†å·²æ›´æ–°ï¼\n\n' +
        'æ˜¯å¦è¦åŸºäºæ–°çš„æ ‡å‡†é‡æ–°è¯„ä¼°æ‰€æœ‰å…¶ä»–è¯æ±‡çš„éš¾åº¦ï¼Ÿ\n' +
        'ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œä¼šæ¶ˆè€— DeepSeek API é¢åº¦ï¼‰'
      )
      
      if (reEvaluate) {
        await reEvaluateAllWords()
      }

      loadCalibrationWords()
    }

    /**
     * é‡æ–°è®¡ç®—æ ¡å‡†é¡ºåº
     */
    async function recalculateCalibrationOrder() {
      // æŒ‰éš¾åº¦æ’åºï¼ŒåŒéš¾åº¦æŒ‰é¢‘ç‡æ’åº
      const sorted = [...calibrationWords].sort((a, b) => {
        if (a.difficulty_level !== b.difficulty_level) {
          return a.difficulty_level - b.difficulty_level
        }
        return (b.frequency || 0) - (a.frequency || 0)
      })

      for (let i = 0; i < sorted.length; i++) {
        await supabase
          .from('vocabulary')
          .update({ calibration_order: i + 1 })
          .eq('id', sorted[i].id)
      }

      console.log('âœ… å·²é‡æ–°æ’åºæ ¡å‡†è¯')
    }

    /**
     * ä»æ ¡å‡†è¯åº“ç§»é™¤
     */
    window.removeFromCalibration = async function(wordId) {
      const word = calibrationWords.find(w => w.id === wordId)
      if (!word) return

      const confirmed = confirm(
        `ç¡®å®šè¦å°†"${word.word}"ä»æ ¡å‡†è¯åº“ä¸­ç§»é™¤å—ï¼Ÿ\n\n` +
        `å®ƒä»ä¼šä¿ç•™åœ¨è¯æ±‡åº“ä¸­ï¼Œä½†ä¸å†ä½œä¸º AI è¯„ä¼°çš„å‚è€ƒæ ‡å‡†ã€‚`
      )

      if (!confirmed) return

      try {
        const { error } = await supabase
          .from('vocabulary')
          .update({
            is_calibration: false,
            calibration_order: null
          })
          .eq('id', wordId)

        if (error) throw error

        alert(`âœ… å·²ç§»é™¤"${word.word}"`)
        loadCalibrationWords()
      } catch (error) {
        alert('ç§»é™¤å¤±è´¥: ' + error.message)
      }
    }

    /**
     * æ·»åŠ æ–°æ ¡å‡†è¯
     */
    window.addCalibrationWord = async function() {
      const wordInput = document.getElementById('new-word')
      const difficultySelect = document.getElementById('new-difficulty')
      const categorySelect = document.getElementById('new-category')
      
      const word = wordInput.value.trim()
      const difficulty = parseInt(difficultySelect.value)
      const category = categorySelect.value

      if (!word) {
        alert('è¯·è¾“å…¥è¯è¯­')
        return
      }

      try {
        // æ£€æŸ¥è¯è¯­æ˜¯å¦å­˜åœ¨
        const { data: existing } = await supabase
          .from('vocabulary')
          .select('*')
          .eq('word', word)
          .maybeSingle()

        if (existing && existing.is_calibration) {
          alert(`"${word}"å·²ç»æ˜¯æ ¡å‡†è¯ï¼`)
          return
        }

        // è®¡ç®—æ–°çš„é¡ºåº
        const maxOrder = Math.max(...calibrationWords.map(w => w.calibration_order || 0), 0)

        if (existing) {
          // æ›´æ–°ç°æœ‰è¯æ±‡
          const { error } = await supabase
            .from('vocabulary')
            .update({
              is_calibration: true,
              calibration_order: maxOrder + 1,
              difficulty_level: difficulty,
              category: category,
              difficulty_confidence: 'high',
              difficulty_reasoning: 'äººå·¥æ·»åŠ çš„æ ¡å‡†è¯',
              difficulty_evaluated_at: new Date().toISOString()
            })
            .eq('id', existing.id)

          if (error) throw error
        } else {
          // åˆ›å»ºæ–°è¯æ±‡
          const { error } = await supabase
            .from('vocabulary')
            .insert({
              word: word,
              difficulty_level: difficulty,
              category: category,
              frequency: 50,
              is_calibration: true,
              calibration_order: maxOrder + 1,
              difficulty_confidence: 'high',
              difficulty_reasoning: 'äººå·¥æ·»åŠ çš„æ ¡å‡†è¯',
              difficulty_evaluated_at: new Date().toISOString()
            })

          if (error) throw error
        }

        alert(`âœ… å·²æ·»åŠ "${word}"ä¸º L${difficulty} æ ¡å‡†è¯`)
        wordInput.value = ''
        loadCalibrationWords()

      } catch (error) {
        alert('æ·»åŠ å¤±è´¥: ' + error.message)
      }
    }

    /**
     * é‡æ–°è¯„ä¼°æ‰€æœ‰è¯æ±‡
     */
    window.reEvaluateAllWords = async function() {
      const confirmed = confirm(
        'âš ï¸ è¿™å°†åŸºäºå½“å‰çš„æ ¡å‡†è¯ï¼Œé‡æ–°è¯„ä¼°æ‰€æœ‰å…¶ä»–è¯æ±‡çš„éš¾åº¦ã€‚\n\n' +
        'è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œå¹¶ä¼šæ¶ˆè€— DeepSeek API é¢åº¦ã€‚\n\n' +
        'ç¡®å®šç»§ç»­å—ï¼Ÿ'
      )

      if (!confirmed) return

      try {
        // è·å–æ‰€æœ‰éæ ¡å‡†è¯
        const { data: wordsToEvaluate, error } = await supabase
          .from('vocabulary')
          .select('*')
          .eq('is_calibration', false)

        if (error) throw error

        console.log(`å¼€å§‹è¯„ä¼° ${wordsToEvaluate.length} ä¸ªè¯æ±‡...`)

        // è°ƒç”¨ AI è¯„ä¼° Edge Function
        const { data, error: funcError } = await supabase.functions.invoke(
          'vocab-difficulty-evaluator',
          {
            body: {
              words: wordsToEvaluate,
              mode: 'recalibrate_all'
            }
          }
        )

        if (funcError) throw funcError

        alert(
          `âœ… è¯„ä¼°å®Œæˆï¼\n\n` +
          `æˆåŠŸ: ${data.success_count} ä¸ª\n` +
          `å¤±è´¥: ${data.error_count} ä¸ª`
        )

      } catch (error) {
        alert('è¯„ä¼°å¤±è´¥: ' + error.message)
      }
    }

    /**
     * å¯¼å‡ºæ ¡å‡†è¯åº“
     */
    window.exportCalibration = function() {
      if (calibrationWords.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ ¡å‡†è¯')
        return
      }

      // æŒ‰ç­‰çº§åˆ†ç»„
      const byLevel = calibrationWords.reduce((acc, word) => {
        const level = `L${word.difficulty_level}`
        if (!acc[level]) acc[level] = []
        acc[level].push({
          word: word.word,
          difficulty: word.difficulty_level,
          category: word.category,
          frequency: word.frequency
        })
        return acc
      }, {})

      const exportData = {
        metadata: {
          name: 'æ ¡å‡†è¯åº“',
          version: '3.0',
          exported_at: new Date().toISOString(),
          total_words: calibrationWords.length,
          purpose: 'ç”¨äºç¬¬ä¸€æ¬¡æ¸¸æˆçš„åŸºå‡†æµ‹è¯•å’ŒAIè¯„ä¼°å‚è€ƒ'
        },
        calibration_words: byLevel
      }

      const json = JSON.stringify(exportData, null, 2)
      const blob = new Blob([json], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `calibration-words-${Date.now()}.json`
      a.click()

      console.log('âœ… å·²å¯¼å‡ºæ ¡å‡†è¯åº“')
    }

    /**
     * æŸ¥çœ‹è¯è¯­è¯¦æƒ…ï¼ˆèŒå…¸ï¼‰
     */
    window.viewWordDetail = function(word) {
      window.open(`https://www.moedict.tw/~${word}`, '_blank')
    }

    /**
     * æ›´æ–°ç»Ÿè®¡
     */
    function updateStats() {
      document.getElementById('total-count').textContent = calibrationWords.length
      document.getElementById('high-confidence-count').textContent = 
        calibrationWords.filter(w => w.difficulty_confidence === 'high').length
      document.getElementById('pending-count').textContent = 
        calibrationWords.filter(w => w.difficulty_confidence !== 'high').length
      document.getElementById('modified-count').textContent = modifiedWords.size
      
      // å¦‚æœæœ‰ä¿®æ”¹ï¼Œå¯ç”¨ä¿å­˜æŒ‰é’®
      document.getElementById('save-btn').disabled = modifiedWords.size === 0
    }

    /**
     * è¾…åŠ©å‡½æ•°
     */
    function getLevelDescription(level) {
      const descriptions = {
        1: '7-8å²ï¼Œå°å­¦2-3å¹´çº§',
        2: '9-10å²ï¼Œå°å­¦4-5å¹´çº§',
        3: '11-12å²ï¼Œå°å­¦6å¹´çº§-åˆä¸€',
        4: '13-14å²ï¼ŒåˆäºŒ-åˆä¸‰',
        5: '15-16å²ï¼Œé«˜ä¸€-é«˜äºŒ',
        6: '17-18å²ï¼Œé«˜ä¸‰åŠä»¥ä¸Š'
      }
      return descriptions[level] || ''
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.addEventListener('load', () => {
      loadCalibrationWords()
    })
  </script>
</body>
</html>

