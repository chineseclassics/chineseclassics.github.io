<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent æµ‹è¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .alert {
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border-left: 4px solid;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #0c5460;
    }
    
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-color: #856404;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-color: #155724;
    }
    
    .alert strong {
      display: block;
      margin-bottom: 8px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    
    .story-display {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .story-message {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
    }
    
    .story-message.user {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
    }
    
    .story-message.ai {
      background: #f3e5f5;
      border-left: 4px solid #9c27b0;
    }
    
    .message-label {
      font-size: 12px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }
    
    .message-text {
      color: #333;
      line-height: 1.6;
    }
    
    .word-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #667eea;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    
    .recommended-words {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .word-button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .word-button:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .word-button.selected {
      background: #28a745;
    }
    
    textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-label {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }
    
    select {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
    }
    
    select:focus {
      outline: none;
      border-color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– AI Agent æµ‹è¯•å·¥å…·</h1>
    <p class="subtitle">æµ‹è¯• DeepSeek æ•…äº‹ç”ŸæˆåŠŸèƒ½</p>
    
    <div class="alert alert-info" id="status-alert">
      <strong>ğŸ“¡ è¿æ¥çŠ¶æ€</strong>
      <p>æ£€æŸ¥ Edge Function æ˜¯å¦éƒ¨ç½²...</p>
    </div>
    
    <!-- é…ç½®åŒºåŸŸ -->
    <div class="section">
      <div class="section-title">âš™ï¸ æµ‹è¯•é…ç½®</div>
      
      <div class="input-group">
        <label class="input-label">ç”¨æˆ·çº§åˆ«</label>
        <select id="user-level">
          <option value="1">L1 (7-8å²) - åŸºç¡€è¯æ±‡</option>
          <option value="2" selected>L2 (9-10å²) - è¿›é˜¶è¯æ±‡</option>
          <option value="3">L3 (11-12å²) - æ‰©å±•è¯æ±‡</option>
          <option value="4">L4 (13-14å²) - å¤æ‚è¯æ±‡</option>
          <option value="5">L5 (15-16å²) - é«˜çº§è¯æ±‡</option>
          <option value="6">L6 (17-18å²) - æ–‡å­¦è¯æ±‡</option>
        </select>
      </div>
      
      <div class="input-group">
        <label class="input-label">æ•…äº‹ä¸»é¢˜</label>
        <select id="story-theme">
          <option value="natural_exploration" selected>è‡ªç„¶æ¢ç´¢</option>
          <option value="school_life">æ ¡å›­ç”Ÿæ´»</option>
          <option value="fantasy_adventure">å¥‡å¹»å†’é™©</option>
          <option value="sci_fi">ç§‘å¹»æœªæ¥</option>
        </select>
      </div>
      
      <button class="btn" onclick="startNewStory()">ğŸ¬ å¼€å§‹æ–°æ•…äº‹</button>
    </div>
    
    <!-- è¿›åº¦æ˜¾ç¤º -->
    <div class="section" id="progress-section" style="display: none;">
      <div class="section-title">ğŸ“Š æ•…äº‹è¿›åº¦</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <p style="text-align: center; color: #666; font-size: 14px;">
        ç¬¬ <span id="current-round">0</span> / 18 è½®
      </p>
    </div>
    
    <!-- æ•…äº‹æ˜¾ç¤º -->
    <div class="section" id="story-section" style="display: none;">
      <div class="section-title">ğŸ“– æ•…äº‹å†…å®¹</div>
      <div class="story-display" id="story-display"></div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="section" id="input-section" style="display: none;">
      <div class="section-title">âœï¸ æ‚¨çš„å›åˆ</div>
      
      <div style="margin-bottom: 15px;">
        <div class="input-label">æ¨èè¯æ±‡ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</div>
        <div class="recommended-words" id="recommended-words"></div>
      </div>
      
      <div class="input-group">
        <label class="input-label">è¾“å…¥æ‚¨çš„å¥å­</label>
        <textarea id="user-input" placeholder="å†™ä¸‹æ‚¨çš„æ•…äº‹..."></textarea>
      </div>
      
      <button class="btn" id="submit-btn" onclick="submitSentence()">
        ğŸ“¤ æäº¤ç»§ç»­
      </button>
    </div>
  </div>

  <script type="module">
    import { initSupabase, getSupabase } from '../js/supabase-client.js';
    import { SUPABASE_CONFIG } from '../js/config.js';
    
    await initSupabase();
    
    let currentSession = null;
    let selectedWord = null;
    let conversationHistory = [];
    let recommendedWords = [];
    let currentRound = 0;
    
    // æ£€æŸ¥ Edge Function çŠ¶æ€
    async function checkEdgeFunctionStatus() {
      const statusAlert = document.getElementById('status-alert');
      
      try {
        const response = await fetch(
          `${SUPABASE_CONFIG.url}/functions/v1/story-agent`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
            },
            body: JSON.stringify({ test: true })
          }
        );
        
        if (response.status === 400 || response.status === 200) {
          // Edge Function å­˜åœ¨ï¼ˆå³ä½¿è¿”å›é”™è¯¯ä¹Ÿè¯´æ˜éƒ¨ç½²äº†ï¼‰
          statusAlert.innerHTML = `
            <strong>âœ… Edge Function å·²éƒ¨ç½²</strong>
            <p>å¯ä»¥å¼€å§‹æµ‹è¯•æ•…äº‹ç”ŸæˆåŠŸèƒ½</p>
          `;
          statusAlert.className = 'alert alert-success';
        } else {
          throw new Error('Edge Function æœªæ‰¾åˆ°');
        }
      } catch (error) {
        statusAlert.innerHTML = `
          <strong>âš ï¸ Edge Function æœªéƒ¨ç½²</strong>
          <p>è¯·å…ˆéƒ¨ç½² Edge Functionã€‚é”™è¯¯: ${error.message}</p>
          <p style="margin-top: 10px; font-size: 13px;">
            éƒ¨ç½²å‘½ä»¤ï¼š<code>supabase functions deploy story-agent</code>
          </p>
        `;
        statusAlert.className = 'alert alert-warning';
      }
    }
    
    // å¼€å§‹æ–°æ•…äº‹
    window.startNewStory = async function() {
      const userLevel = parseInt(document.getElementById('user-level').value);
      const storyTheme = document.getElementById('story-theme').value;
      
      const supabase = getSupabase();
      
      // åˆ›å»ºæ–°çš„æ•…äº‹ä¼šè¯
      const { data, error } = await supabase
        .from('story_sessions')
        .insert({
          story_theme: storyTheme,
          initial_choice: 'å¼€å§‹æ–°æ•…äº‹',
          current_round: 0,
          conversation_history: []
        })
        .select()
        .single();
      
      if (error) {
        alert('åˆ›å»ºæ•…äº‹ä¼šè¯å¤±è´¥: ' + error.message);
        return;
      }
      
      currentSession = data;
      conversationHistory = [];
      currentRound = 0;
      
      // æ˜¾ç¤ºç•Œé¢
      document.getElementById('progress-section').style.display = 'block';
      document.getElementById('story-section').style.display = 'block';
      document.getElementById('input-section').style.display = 'block';
      
      // è·å–åˆå§‹æ¨èè¯æ±‡
      await getInitialWords(userLevel, storyTheme);
      
      updateProgress();
    };
    
    // è·å–åˆå§‹æ¨èè¯æ±‡
    async function getInitialWords(userLevel, storyTheme) {
      const supabase = getSupabase();
      
      const minLevel = Math.max(1, userLevel - 1);
      const maxLevel = Math.min(6, userLevel + 1);
      
      const { data, error } = await supabase
        .from('vocabulary')
        .select('*')
        .gte('difficulty_level', minLevel)
        .lte('difficulty_level', maxLevel)
        .limit(5);
      
      if (error) {
        console.error('è·å–è¯æ±‡å¤±è´¥:', error);
        return;
      }
      
      recommendedWords = data || [];
      displayRecommendedWords();
    }
    
    // æ˜¾ç¤ºæ¨èè¯æ±‡
    function displayRecommendedWords() {
      const container = document.getElementById('recommended-words');
      container.innerHTML = recommendedWords.map(word => `
        <button class="word-button" onclick="selectWord('${word.word}', '${word.id}')">
          ${word.word}
          <span style="font-size: 11px; opacity: 0.8;">(${word.pinyin})</span>
        </button>
      `).join('');
    }
    
    // é€‰æ‹©è¯æ±‡
    window.selectWord = function(word, id) {
      selectedWord = word;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('.word-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      // è‡ªåŠ¨æ’å…¥åˆ°è¾“å…¥æ¡†
      const textarea = document.getElementById('user-input');
      textarea.value += word;
      textarea.focus();
    };
    
    // æäº¤å¥å­
    window.submitSentence = async function() {
      const userInput = document.getElementById('user-input').value.trim();
      
      if (!userInput) {
        alert('è¯·è¾“å…¥æ‚¨çš„å¥å­');
        return;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span> AI æ€è€ƒä¸­...';
      
      try {
        // è°ƒç”¨ Edge Function
        const response = await fetch(
          `${SUPABASE_CONFIG.url}/functions/v1/story-agent`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`
            },
            body: JSON.stringify({
              userSentence: userInput,
              selectedWord: selectedWord,
              sessionId: currentSession.id,
              conversationHistory: conversationHistory,
              userLevel: parseInt(document.getElementById('user-level').value),
              storyTheme: document.getElementById('story-theme').value,
              currentRound: currentRound
            })
          }
        );
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error);
        }
        
        // æ›´æ–°æ˜¾ç¤º
        conversationHistory.push(userInput);
        conversationHistory.push(result.data.aiSentence);
        
        addMessageToStory('user', userInput, selectedWord);
        addMessageToStory('ai', result.data.aiSentence);
        
        // æ›´æ–°æ¨èè¯æ±‡
        recommendedWords = result.data.recommendedWords;
        displayRecommendedWords();
        
        // æ›´æ–°è¿›åº¦
        currentRound = result.data.currentRound;
        updateProgress();
        
        // æ¸…ç©ºè¾“å…¥
        document.getElementById('user-input').value = '';
        selectedWord = null;
        
        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
        if (result.data.isComplete) {
          alert('ğŸ‰ æ•…äº‹å®Œæˆï¼å…± 18 è½®');
          document.getElementById('input-section').style.display = 'none';
        }
        
      } catch (error) {
        alert('å‘ç”Ÿé”™è¯¯: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ“¤ æäº¤ç»§ç»­';
      }
    };
    
    // æ·»åŠ æ¶ˆæ¯åˆ°æ•…äº‹æ˜¾ç¤º
    function addMessageToStory(type, text, word = null) {
      const container = document.getElementById('story-display');
      const messageDiv = document.createElement('div');
      messageDiv.className = `story-message ${type}`;
      
      const label = type === 'user' ? 'ğŸ‘¤ æ‚¨' : 'ğŸ¤– AI';
      const wordBadge = word ? `<span class="word-badge">${word}</span>` : '';
      
      messageDiv.innerHTML = `
        <div class="message-label">${label} ${wordBadge}</div>
        <div class="message-text">${text}</div>
      `;
      
      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    // æ›´æ–°è¿›åº¦
    function updateProgress() {
      const progress = (currentRound / 18) * 100;
      document.getElementById('progress-fill').style.width = progress + '%';
      document.getElementById('current-round').textContent = currentRound;
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
    checkEdgeFunctionStatus();
  </script>
</body>
</html>

