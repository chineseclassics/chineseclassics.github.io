<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¼å…¥æ ¡å‡†è¯åº“</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      color: #1565c0;
    }
    
    .alert-warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      color: #e65100;
    }
    
    .alert-success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      color: #667eea;
    }
    
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 14px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .progress-section {
      margin: 20px 0;
      display: none;
    }
    
    .progress-section.active {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .log-entry.success {
      color: #2e7d32;
    }
    
    .log-entry.error {
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“š å¯¼å…¥æ ¡å‡†è¯åº“</h1>
    <p class="subtitle">å°†150ä¸ªé»„é‡‘æ ‡å‡†è¯æ±‡å¯¼å…¥Supabaseæ•°æ®åº“</p>

    <div class="alert alert-info">
      <strong>ğŸ“ è¯´æ˜ï¼š</strong> 
      æœ¬å·¥å…·å°†ä» <code>calibration-vocabulary.json</code> è¯»å–150ä¸ªç²¾é€‰æ ¡å‡†è¯æ±‡ï¼Œ
      å¹¶å¯¼å…¥åˆ° Supabase æ•°æ®åº“çš„ <code>vocabulary</code> è¡¨ä¸­ï¼Œæ ‡è®°ä¸ºé»„é‡‘æ ‡å‡†è¯æ±‡ã€‚
      è¿™äº›è¯æ±‡å°†ä½œä¸º AI è‡ªåŠ¨è¯„çº§ç³»ç»Ÿçš„å‚è€ƒåŸºå‡†ã€‚
    </div>

    <div class="alert alert-warning">
      <strong>âš ï¸ é‡è¦ï¼š</strong>
      å¯¼å…¥å‰è¯·ç¡®ä¿å·²è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ <code>007_wordlist_system.sql</code>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats">
      <div class="stat-box">
        <div class="stat-label">JSONæ–‡ä»¶è¯æ±‡</div>
        <div class="stat-value" id="json-count">-</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">æ•°æ®åº“ç°æœ‰</div>
        <div class="stat-value" id="db-count">-</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">å¾…å¯¼å…¥</div>
        <div class="stat-value" id="pending-count">-</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">å·²å¯¼å…¥</div>
        <div class="stat-value" id="imported-count">0</div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div>
      <button class="btn" id="load-btn" onclick="loadCalibrationData()">
        ğŸ“¥ 1. åŠ è½½æ ¡å‡†è¯åº“JSON
      </button>
      
      <button class="btn" id="import-btn" onclick="importToDatabase()" disabled>
        ğŸš€ 2. å¯¼å…¥åˆ°æ•°æ®åº“
      </button>
      
      <button class="btn btn-secondary" onclick="window.location.href='calibration-manager.html'">
        ğŸ”§ æ‰“å¼€æ ¡å‡†è¯ç®¡ç†å™¨
      </button>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-section" id="progress-section">
      <h3>å¯¼å…¥è¿›åº¦</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
      </div>
      <p id="progress-text">ç­‰å¾…å¼€å§‹...</p>
    </div>

    <!-- æ—¥å¿— -->
    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { getSupabase } from '../js/supabase-client.js'

    const supabase = getSupabase()
    let calibrationData = null

    /**
     * åŠ è½½æ ¡å‡†è¯åº“JSON
     */
    window.loadCalibrationData = async function() {
      const btn = document.getElementById('load-btn')
      btn.disabled = true
      btn.textContent = 'åŠ è½½ä¸­...'

      try {
        const response = await fetch('../data/calibration-vocabulary.json')
        const data = await response.json()
        
        calibrationData = data.calibration_words
        
        // ç»Ÿè®¡è¯æ±‡æ•°é‡
        let totalWords = 0
        for (const level in calibrationData) {
          totalWords += calibrationData[level].length
        }
        
        document.getElementById('json-count').textContent = totalWords
        
        // æŸ¥è¯¢æ•°æ®åº“ç°æœ‰æ ¡å‡†è¯æ•°é‡
        const { count } = await supabase
          .from('vocabulary')
          .select('*', { count: 'exact', head: true })
          .eq('is_calibration', true)
        
        document.getElementById('db-count').textContent = count || 0
        document.getElementById('pending-count').textContent = totalWords - (count || 0)
        
        // å¯ç”¨å¯¼å…¥æŒ‰é’®
        document.getElementById('import-btn').disabled = false
        
        addLog('âœ… æˆåŠŸåŠ è½½æ ¡å‡†è¯åº“JSON', 'success')
        addLog(`ğŸ“Š å…± ${totalWords} ä¸ªè¯æ±‡ï¼Œæ•°æ®åº“å·²æœ‰ ${count || 0} ä¸ª`, 'success')
        
        btn.textContent = 'âœ… å·²åŠ è½½'
        btn.disabled = false
        
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error)
        addLog('âŒ åŠ è½½å¤±è´¥: ' + error.message, 'error')
        btn.textContent = 'âŒ åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•'
        btn.disabled = false
      }
    }

    /**
     * å¯¼å…¥åˆ°æ•°æ®åº“
     */
    window.importToDatabase = async function() {
      if (!calibrationData) {
        alert('è¯·å…ˆåŠ è½½æ ¡å‡†è¯åº“JSON')
        return
      }

      const confirmed = confirm(
        'ç¡®å®šè¦å¯¼å…¥æ ¡å‡†è¯åº“å—ï¼Ÿ\n\n' +
        'è¿™å°†ï¼š\n' +
        '1. åˆ›å»ºæˆ–æ›´æ–°è¯æ±‡è®°å½•\n' +
        '2. æ ‡è®°ä¸ºæ ¡å‡†è¯ï¼ˆis_calibration=trueï¼‰\n' +
        '3. è®¾ç½®æ ¡å‡†é¡ºåº\n\n' +
        'å·²å­˜åœ¨çš„è¯æ±‡ä¸ä¼šé‡å¤åˆ›å»ºã€‚'
      )

      if (!confirmed) return

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.textContent = 'å¯¼å…¥ä¸­...'

      const progressSection = document.getElementById('progress-section')
      progressSection.classList.add('active')

      let totalWords = 0
      let importedCount = 0
      let updatedCount = 0
      let errorCount = 0
      let order = 1

      // ç»Ÿè®¡æ€»æ•°
      for (const level in calibrationData) {
        totalWords += calibrationData[level].length
      }

      addLog(`å¼€å§‹å¯¼å…¥ ${totalWords} ä¸ªæ ¡å‡†è¯...`, 'success')

      // æŒ‰ç­‰çº§å¯¼å…¥
      for (const level in calibrationData) {
        const levelNum = parseInt(level.substring(1)) // L1 -> 1
        const words = calibrationData[level]
        
        addLog(`\nğŸ“– å¯¼å…¥ L${levelNum} è¯æ±‡ (${words.length}ä¸ª)...`)

        for (const wordData of words) {
          try {
            // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨
            const { data: existing } = await supabase
              .from('vocabulary')
              .select('id')
              .eq('word', wordData.word)
              .maybeSingle()

            if (existing) {
              // æ›´æ–°ç°æœ‰è®°å½•
              const { error } = await supabase
                .from('vocabulary')
                .update({
                  difficulty_level: wordData.difficulty,
                  category: wordData.category,
                  frequency: wordData.frequency,
                  is_calibration: true,
                  calibration_order: order,
                  difficulty_confidence: 'high',
                  difficulty_reasoning: 'å¼€å‘è€…ç²¾å¿ƒæ ‡æ³¨çš„é»„é‡‘æ ‡å‡†',
                  difficulty_evaluated_at: new Date().toISOString()
                })
                .eq('id', existing.id)

              if (error) throw error
              updatedCount++
              addLog(`  âœï¸ æ›´æ–°: ${wordData.word} (L${levelNum})`)
            } else {
              // åˆ›å»ºæ–°è®°å½•
              const { error } = await supabase
                .from('vocabulary')
                .insert({
                  word: wordData.word,
                  difficulty_level: wordData.difficulty,
                  category: wordData.category,
                  frequency: wordData.frequency,
                  is_calibration: true,
                  calibration_order: order,
                  difficulty_confidence: 'high',
                  difficulty_reasoning: 'å¼€å‘è€…ç²¾å¿ƒæ ‡æ³¨çš„é»„é‡‘æ ‡å‡†',
                  difficulty_evaluated_at: new Date().toISOString()
                })

              if (error) throw error
              importedCount++
              addLog(`  âœ… æ–°å¢: ${wordData.word} (L${levelNum})`, 'success')
            }

            order++
            
            // æ›´æ–°è¿›åº¦
            const progress = ((importedCount + updatedCount + errorCount) / totalWords) * 100
            updateProgress(progress)

          } catch (error) {
            console.error(`å¯¼å…¥å¤±è´¥: ${wordData.word}`, error)
            addLog(`  âŒ å¤±è´¥: ${wordData.word} - ${error.message}`, 'error')
            errorCount++
          }
        }
      }

      // å®Œæˆ
      updateProgress(100)
      
      addLog('\n============================', 'success')
      addLog(`âœ… å¯¼å…¥å®Œæˆï¼`, 'success')
      addLog(`ğŸ“Š ç»Ÿè®¡ï¼š`, 'success')
      addLog(`  - æ–°å¢: ${importedCount} ä¸ª`, 'success')
      addLog(`  - æ›´æ–°: ${updatedCount} ä¸ª`, 'success')
      addLog(`  - å¤±è´¥: ${errorCount} ä¸ª`, errorCount > 0 ? 'error' : 'success')
      addLog(`  - æ€»è®¡: ${importedCount + updatedCount} / ${totalWords}`, 'success')
      addLog('============================', 'success')

      document.getElementById('imported-count').textContent = importedCount + updatedCount

      btn.textContent = 'âœ… å¯¼å…¥å®Œæˆ'
      btn.disabled = false

      if (errorCount === 0) {
        setTimeout(() => {
          alert('âœ… æ ¡å‡†è¯åº“å¯¼å…¥æˆåŠŸï¼\n\nä¸‹ä¸€æ­¥ï¼šæ‰“å¼€"æ ¡å‡†è¯ç®¡ç†å™¨"è¿›è¡Œäººå·¥æ ¡å‡†ã€‚')
        }, 500)
      }
    }

    /**
     * æ›´æ–°è¿›åº¦æ¡
     */
    function updateProgress(percent) {
      const fill = document.getElementById('progress-fill')
      const text = document.getElementById('progress-text')
      
      fill.style.width = percent + '%'
      fill.textContent = Math.round(percent) + '%'
      text.textContent = `å·²å¤„ç† ${Math.round(percent)}%`
    }

    /**
     * æ·»åŠ æ—¥å¿—
     */
    function addLog(message, type = '') {
      const logDiv = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = 'log-entry ' + type
      entry.textContent = message
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ•°æ®åº“è¿æ¥
    window.addEventListener('load', async () => {
      try {
        const { data, error } = await supabase
          .from('vocabulary')
          .select('id', { count: 'exact', head: true })
          .eq('is_calibration', true)

        if (error) {
          addLog('âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥: ' + error.message, 'error')
          addLog('è¯·æ£€æŸ¥ Supabase é…ç½®', 'error')
        } else {
          addLog('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success')
          document.getElementById('db-count').textContent = data || 0
        }
      } catch (error) {
        addLog('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error')
      }
    })
  </script>
</body>
</html>

