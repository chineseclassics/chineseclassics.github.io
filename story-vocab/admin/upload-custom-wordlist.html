<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸Šä¼ è‡ªå®šä¹‰è¯è¡¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #1565c0;
    }
    
    .alert-success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }
    
    .form-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
      width: 100%;
      margin-top: 10px;
    }
    
    .file-upload {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .file-upload:hover {
      background: #e8ebff;
      border-color: #5568d3;
    }
    
    .file-upload.dragover {
      background: #d4d8ff;
      border-color: #4a5bc5;
    }
    
    .preview-section {
      margin: 20px 0;
      padding: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .progress-section {
      display: none;
      margin: 20px 0;
    }
    
    .progress-section.active {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .log-entry.success {
      color: #2e7d32;
    }
    
    .log-entry.error {
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âœï¸ ä¸Šä¼ è‡ªå®šä¹‰è¯è¡¨</h1>
    <p class="subtitle">ä¸Šä¼ æ‚¨è‡ªå·±çš„è¯æ±‡åˆ—è¡¨ï¼ˆè€å¸ˆ/å®¶é•¿ä¸“ç”¨ï¼‰</p>

    <div class="alert alert-info">
      <strong>ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
      1. ä¸‹è½½CSVæ¨¡æ¿ï¼Œå¡«å†™è¯è¯­å’Œå¯é€‰çš„åˆ†ç±»æ ‡ç­¾<br>
      2. ä¸Šä¼ CSVæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å±‚çº§ç»“æ„<br>
      3. AIä¼šè‡ªåŠ¨è¯„ä¼°æ–°è¯æ±‡çš„éš¾åº¦ç­‰çº§<br>
      4. å¯¼å…¥åï¼Œå­¦ç”Ÿåœ¨æ¸¸æˆä¸­å¯ä»¥é€‰æ‹©ä½¿ç”¨æ‚¨çš„è¯è¡¨
    </div>

    <!-- ä¸‹è½½æ¨¡æ¿ -->
    <div style="margin: 20px 0;">
      <a href="templates/è¯è¡¨å¯¼å…¥æ¨¡æ¿.csv" download class="btn btn-secondary">
        ğŸ“¥ ä¸‹è½½CSVæ¨¡æ¿
      </a>
    </div>

    <!-- è¯è¡¨ä¿¡æ¯ -->
    <div class="form-section">
      <h3 style="margin-bottom: 20px;">ğŸ“‹ è¯è¡¨ä¿¡æ¯</h3>
      
      <div class="form-group">
        <label class="form-label">è¯è¡¨åç§° *</label>
        <input type="text" id="wordlist-name" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šå››å¹´çº§æœŸæœ«å¤ä¹ ã€ä½œæ–‡æå‡è¯æ±‡">
        <div class="form-hint">ç»™æ‚¨çš„è¯è¡¨èµ·ä¸ªåå­—ï¼Œå­¦ç”Ÿä¼šçœ‹åˆ°è¿™ä¸ªåç§°</div>
      </div>

      <div class="form-group">
        <label class="form-label">è¯è¡¨æè¿°ï¼ˆå¯é€‰ï¼‰</label>
        <textarea id="wordlist-desc" class="form-textarea" 
                  placeholder="ç®€å•æè¿°è¿™ä¸ªè¯è¡¨çš„ç”¨é€”ï¼Œä¾‹å¦‚ï¼šä¸ºå››å¹´çº§ä¸‹å­¦æœŸæœŸæœ«è€ƒè¯•å‡†å¤‡çš„é‡ç‚¹è¯æ±‡"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" id="is-public" style="width: auto; margin-right: 8px;">
          å…¬å¼€åˆ†äº«ï¼ˆå…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°å’Œä½¿ç”¨è¿™ä¸ªè¯è¡¨ï¼‰
        </label>
      </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼  -->
    <div class="form-section">
      <h3 style="margin-bottom: 20px;">ğŸ“¤ ä¸Šä¼ è¯è¡¨æ–‡ä»¶</h3>
      
      <div class="file-upload" id="file-upload" 
           onclick="document.getElementById('file-input').click()"
           ondrop="handleDrop(event)" 
           ondragover="handleDragOver(event)" 
           ondragleave="handleDragLeave(event)">
        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
        <p style="font-size: 16px; color: #667eea; font-weight: 500; margin-bottom: 5px;">
          ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ
        </p>
        <p style="font-size: 12px; color: #999;">
          æ”¯æŒ CSVã€JSON æ ¼å¼
        </p>
        <input type="file" id="file-input" accept=".csv,.json" 
               style="display: none;" onchange="handleFileSelect(event)">
      </div>

      <div id="file-info" style="margin-top: 15px; display: none;">
        <p style="color: #2e7d32;">
          âœ… å·²é€‰æ‹©æ–‡ä»¶: <strong id="file-name"></strong>
        </p>
      </div>
    </div>

    <!-- é¢„è§ˆ -->
    <div id="preview-section" style="display: none;">
      <h3 style="margin: 20px 0;">ğŸ‘€ æ•°æ®é¢„è§ˆ</h3>
      <div class="preview-section" id="preview-content"></div>
    </div>

    <!-- å±‚çº§é…ç½® -->
    <div id="hierarchy-section" class="form-section" style="display: none;">
      <h3 style="margin-bottom: 20px;">ğŸ·ï¸ å±‚çº§æ ‡ç­¾é…ç½®</h3>
      <p style="color: #666; margin-bottom: 15px;">
        ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨çš„è¯è¡¨åŒ…å«å±‚çº§æ ‡ç­¾ã€‚è¯·ä¸ºè¿™äº›å±‚çº§èµ·ä¸ªåå­—ï¼ˆç”¨äºæ¸¸æˆç•Œé¢æ˜¾ç¤ºï¼‰ï¼š
      </p>
      
      <div class="form-group" id="level-2-config" style="display: none;">
        <label class="form-label">ç¬¬äºŒå±‚çº§æ ‡ç­¾åç§°</label>
        <input type="text" id="level-2-label-name" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šåˆ†ç±»ã€ç­‰çº§ã€å¹´çº§">
        <div class="form-hint">
          æ£€æµ‹åˆ°çš„æ ‡ç­¾ï¼š<span id="level-2-tags"></span>
        </div>
      </div>

      <div class="form-group" id="level-3-config" style="display: none;">
        <label class="form-label">ç¬¬ä¸‰å±‚çº§æ ‡ç­¾åç§°</label>
        <input type="text" id="level-3-label-name" class="form-input" 
               placeholder="ä¾‹å¦‚ï¼šä¸»é¢˜ã€å•å…ƒã€ç»„åˆ«">
        <div class="form-hint">
          æ£€æµ‹åˆ°çš„æ ‡ç­¾ï¼š<span id="level-3-tags"></span>
        </div>
      </div>
    </div>

    <!-- å¯¼å…¥æŒ‰é’® -->
    <button class="btn btn-primary" id="import-btn" onclick="importCustomWordlist()" disabled>
      ğŸš€ å¼€å§‹å¯¼å…¥
    </button>

    <!-- è¿›åº¦ -->
    <div class="progress-section" id="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
      </div>
      <p id="progress-text" style="text-align: center;"></p>
    </div>

    <!-- æ—¥å¿— -->
    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script type="module">
    import { getSupabase } from '../js/supabase-client.js'

    const supabase = getSupabase()
    let fileData = null
    let detectedHierarchy = {
      level2Tags: [],
      level3Tags: []
    }

    /**
     * æ‹–æ‹½å¤„ç†
     */
    window.handleDragOver = function(e) {
      e.preventDefault()
      e.stopPropagation()
      document.getElementById('file-upload').classList.add('dragover')
    }

    window.handleDragLeave = function(e) {
      e.preventDefault()
      e.stopPropagation()
      document.getElementById('file-upload').classList.remove('dragover')
    }

    window.handleDrop = function(e) {
      e.preventDefault()
      e.stopPropagation()
      document.getElementById('file-upload').classList.remove('dragover')
      
      const files = e.dataTransfer.files
      if (files.length > 0) {
        processFile(files[0])
      }
    }

    /**
     * æ–‡ä»¶é€‰æ‹©å¤„ç†
     */
    window.handleFileSelect = function(event) {
      const file = event.target.files[0]
      if (file) {
        processFile(file)
      }
    }

    /**
     * å¤„ç†æ–‡ä»¶
     */
    async function processFile(file) {
      try {
        document.getElementById('file-name').textContent = file.name
        document.getElementById('file-info').style.display = 'block'
        
        const text = await file.text()
        
        if (file.name.endsWith('.csv')) {
          fileData = parseCSV(text)
        } else if (file.name.endsWith('.json')) {
          const json = JSON.parse(text)
          fileData = json.vocabulary || json
        } else {
          throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä½¿ç”¨CSVæˆ–JSON')
        }

        // æ£€æµ‹å±‚çº§ç»“æ„
        detectHierarchy(fileData)
        
        // æ˜¾ç¤ºé¢„è§ˆ
        showPreview(fileData)
        
        // å¯ç”¨å¯¼å…¥æŒ‰é’®
        document.getElementById('import-btn').disabled = false

      } catch (error) {
        alert('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message)
        console.error(error)
      }
    }

    /**
     * è§£æ CSV
     */
    function parseCSV(text) {
      const lines = text.trim().split('\n')
      const headers = lines[0].split(',').map(h => h.trim())
      
      if (!headers.includes('è¯è¯­')) {
        throw new Error('CSVç¼ºå°‘"è¯è¯­"åˆ—')
      }

      const wordIndex = headers.indexOf('è¯è¯­')
      const level2Index = headers.indexOf('ç¬¬äºŒå±‚çº§')
      const level3Index = headers.indexOf('ç¬¬ä¸‰å±‚çº§')

      const data = []
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim()
        if (!line) continue
        
        const cells = line.split(',').map(c => c.trim())
        
        if (cells[wordIndex]) {
          data.push({
            word: cells[wordIndex],
            level_2_tag: level2Index >= 0 && cells[level2Index] ? cells[level2Index] : null,
            level_3_tag: level3Index >= 0 && cells[level3Index] ? cells[level3Index] : null
          })
        }
      }

      return data
    }

    /**
     * æ£€æµ‹å±‚çº§ç»“æ„
     */
    function detectHierarchy(data) {
      detectedHierarchy.level2Tags = [...new Set(data.map(d => d.level_2_tag).filter(Boolean))]
      detectedHierarchy.level3Tags = [...new Set(data.map(d => d.level_3_tag).filter(Boolean))]

      const hierarchySection = document.getElementById('hierarchy-section')
      
      if (detectedHierarchy.level2Tags.length > 0 || detectedHierarchy.level3Tags.length > 0) {
        hierarchySection.style.display = 'block'
        
        if (detectedHierarchy.level2Tags.length > 0) {
          document.getElementById('level-2-config').style.display = 'block'
          document.getElementById('level-2-tags').textContent = 
            detectedHierarchy.level2Tags.slice(0, 5).join('ã€') + 
            (detectedHierarchy.level2Tags.length > 5 ? '...' : '')
          
          // è‡ªåŠ¨å¡«å……å»ºè®®
          document.getElementById('level-2-label-name').value = 'åˆ†ç±»'
        }
        
        if (detectedHierarchy.level3Tags.length > 0) {
          document.getElementById('level-3-config').style.display = 'block'
          document.getElementById('level-3-tags').textContent = 
            detectedHierarchy.level3Tags.slice(0, 5).join('ã€') + 
            (detectedHierarchy.level3Tags.length > 5 ? '...' : '')
          
          // è‡ªåŠ¨å¡«å……å»ºè®®
          document.getElementById('level-3-label-name').value = 'ä¸»é¢˜'
        }
      } else {
        hierarchySection.style.display = 'none'
      }
    }

    /**
     * æ˜¾ç¤ºé¢„è§ˆ
     */
    function showPreview(data) {
      const previewSection = document.getElementById('preview-section')
      const content = document.getElementById('preview-content')
      
      const stats = {
        total: data.length,
        hasLevel2: data.filter(d => d.level_2_tag).length,
        hasLevel3: data.filter(d => d.level_3_tag).length
      }

      content.innerHTML = `
        <div style="padding: 15px; background: #e8f5e9; border-radius: 6px; margin-bottom: 15px;">
          <p><strong>ğŸ“Š æ–‡ä»¶ç»Ÿè®¡</strong></p>
          <p>â€¢ æ€»è¯æ±‡æ•°ï¼š${stats.total}</p>
          <p>â€¢ æœ‰ç¬¬äºŒå±‚çº§ï¼š${stats.hasLevel2} ä¸ª</p>
          <p>â€¢ æœ‰ç¬¬ä¸‰å±‚çº§ï¼š${stats.hasLevel3} ä¸ª</p>
        </div>
        <table style="width: 100%; font-size: 13px;">
          <tr style="background: #f5f5f5; font-weight: bold;">
            <th style="padding: 10px; text-align: left;">è¯è¯­</th>
            <th style="padding: 10px; text-align: left;">ç¬¬äºŒå±‚çº§</th>
            <th style="padding: 10px; text-align: left;">ç¬¬ä¸‰å±‚çº§</th>
          </tr>
          ${data.slice(0, 15).map(d => `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px;">${d.word}</td>
              <td style="padding: 8px; color: #666;">${d.level_2_tag || '-'}</td>
              <td style="padding: 8px; color: #666;">${d.level_3_tag || '-'}</td>
            </tr>
          `).join('')}
          ${data.length > 15 ? `
            <tr>
              <td colspan="3" style="text-align: center; padding: 10px; color: #999;">
                ... è¿˜æœ‰ ${data.length - 15} ä¸ªè¯
              </td>
            </tr>
          ` : ''}
        </table>
      `
      
      previewSection.style.display = 'block'
    }

    /**
     * å¯¼å…¥è‡ªå®šä¹‰è¯è¡¨
     */
    window.importCustomWordlist = async function() {
      if (!fileData || fileData.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶')
        return
      }

      const name = document.getElementById('wordlist-name').value.trim()
      const description = document.getElementById('wordlist-desc').value.trim()
      const isPublic = document.getElementById('is-public').checked

      if (!name) {
        alert('è¯·å¡«å†™è¯è¡¨åç§°')
        return
      }

      // è·å–å±‚çº§æ ‡ç­¾åç§°
      const level2Label = detectedHierarchy.level2Tags.length > 0 
        ? document.getElementById('level-2-label-name').value.trim() || 'åˆ†ç±»'
        : null
      
      const level3Label = detectedHierarchy.level3Tags.length > 0
        ? document.getElementById('level-3-label-name').value.trim() || 'ä¸»é¢˜'
        : null

      const confirmed = confirm(
        `ç¡®å®šè¦å¯¼å…¥æ­¤è‡ªå®šä¹‰è¯è¡¨å—ï¼Ÿ\n\n` +
        `è¯è¡¨åç§°ï¼š${name}\n` +
        `è¯æ±‡æ•°é‡ï¼š${fileData.length}\n` +
        `ç¬¬äºŒå±‚çº§ï¼š${level2Label || 'æ— '}\n` +
        `ç¬¬ä¸‰å±‚çº§ï¼š${level3Label || 'æ— '}\n` +
        `å…¬å¼€åˆ†äº«ï¼š${isPublic ? 'æ˜¯' : 'å¦'}`
      )

      if (!confirmed) return

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.innerHTML = 'å¯¼å…¥ä¸­...'

      const progressSection = document.getElementById('progress-section')
      const logDiv = document.getElementById('log')
      progressSection.classList.add('active')
      logDiv.style.display = 'block'

      try {
        // è·å–å½“å‰ç”¨æˆ·ID
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) throw new Error('è¯·å…ˆç™»å½•')

        const userId = user.id

        // 1. åˆ›å»ºè¯è¡¨
        addLog('ğŸ“ åˆ›å»ºè‡ªå®šä¹‰è¯è¡¨...', 'success')
        
        const code = `custom_${userId}_${Date.now()}`
        
        const { data: wordlist, error: wlError } = await supabase
          .from('wordlists')
          .insert({
            name,
            code,
            type: 'custom',
            owner_id: userId,
            hierarchy_config: {
              level_2_label: level2Label,
              level_3_label: level3Label
            },
            description,
            is_public: isPublic
          })
          .select()
          .single()

        if (wlError) throw wlError
        addLog(`âœ… è¯è¡¨åˆ›å»ºæˆåŠŸ: ${name}`, 'success')

        // 2. åˆ›å»ºæ ‡ç­¾
        const level2TagMap = {}
        const level3TagMap = {}

        if (detectedHierarchy.level2Tags.length > 0) {
          addLog('\nğŸ“‹ åˆ›å»ºç¬¬äºŒå±‚çº§æ ‡ç­¾...', 'success')
          
          for (let i = 0; i < detectedHierarchy.level2Tags.length; i++) {
            const tag = detectedHierarchy.level2Tags[i]
            
            const { data: tagData, error: tagError } = await supabase
              .from('wordlist_tags')
              .insert({
                wordlist_id: wordlist.id,
                tag_level: 2,
                tag_code: tag,
                tag_display_name: tag,
                sort_order: i
              })
              .select()
              .single()

            if (tagError) throw tagError
            level2TagMap[tag] = tagData.id
            addLog(`  âœ… ${tag}`, 'success')
          }
        }

        if (detectedHierarchy.level3Tags.length > 0) {
          addLog('\nğŸ“‹ åˆ›å»ºç¬¬ä¸‰å±‚çº§æ ‡ç­¾...', 'success')
          
          for (let i = 0; i < detectedHierarchy.level3Tags.length; i++) {
            const tag = detectedHierarchy.level3Tags[i]
            
            const { data: tagData, error: tagError } = await supabase
              .from('wordlist_tags')
              .insert({
                wordlist_id: wordlist.id,
                tag_level: 3,
                tag_code: tag,
                tag_display_name: tag,
                sort_order: i
              })
              .select()
              .single()

            if (tagError) throw tagError
            level3TagMap[tag] = tagData.id
            addLog(`  âœ… ${tag}`, 'success')
          }
        }

        // 3. å¯¼å…¥è¯æ±‡
        addLog('\nğŸ“š å¼€å§‹å¯¼å…¥è¯æ±‡...', 'success')
        
        let newVocabCount = 0
        let existingVocabCount = 0
        let aiEvaluatedCount = 0
        let mappingCount = 0

        for (let i = 0; i < fileData.length; i++) {
          const item = fileData[i]
          
          updateProgress((i / fileData.length) * 100)

          try {
            // æŸ¥æ‰¾è¯æ±‡
            let { data: vocab } = await supabase
              .from('vocabulary')
              .select('*')
              .eq('word', item.word)
              .maybeSingle()

            if (!vocab) {
              // æ–°è¯æ±‡ï¼šè°ƒç”¨AIè¯„ä¼°
              addLog(`  ğŸ¤– æ–°è¯"${item.word}"ï¼ŒAIè¯„ä¼°ä¸­...`)
              
              const { data: evalData } = await supabase.functions.invoke(
                'vocab-difficulty-evaluator',
                {
                  body: {
                    words: [{ word: item.word }],
                    mode: 'single'
                  }
                }
              )

              const evaluation = evalData?.results?.[0] || {
                difficulty: 3,
                category: 'æœªçŸ¥',
                confidence: 'low',
                reasoning: 'AIè¯„ä¼°å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼'
              }

              // åˆ›å»ºè¯æ±‡
              const { data: newVocab, error } = await supabase
                .from('vocabulary')
                .insert({
                  word: item.word,
                  difficulty_level: evaluation.difficulty,
                  category: evaluation.category,
                  frequency: 50,
                  difficulty_confidence: evaluation.confidence,
                  difficulty_reasoning: evaluation.reasoning,
                  difficulty_evaluated_at: new Date().toISOString()
                })
                .select()
                .single()

              if (error) throw error
              
              vocab = newVocab
              newVocabCount++
              aiEvaluatedCount++
              addLog(`  âœ… ${item.word} (L${evaluation.difficulty})`, 'success')
            } else {
              existingVocabCount++
            }

            // åˆ›å»ºå…³è”
            const tagPath = [item.level_2_tag, item.level_3_tag].filter(Boolean)
            
            const { error: mappingError } = await supabase
              .from('vocabulary_wordlist_mapping')
              .insert({
                vocabulary_id: vocab.id,
                wordlist_id: wordlist.id,
                tag_path: JSON.stringify(tagPath),
                level_2_tag: item.level_2_tag || null,
                level_3_tag: item.level_3_tag || null
              })

            if (mappingError && mappingError.code !== '23505') {
              throw mappingError
            }
            
            mappingCount++

          } catch (error) {
            console.error(`å¤„ç†å¤±è´¥: ${item.word}`, error)
            addLog(`  âŒ ${item.word} - ${error.message}`, 'error')
          }
        }

        updateProgress(100)

        addLog('\n============================', 'success')
        addLog(`âœ… å¯¼å…¥å®Œæˆï¼`, 'success')
        addLog(`ğŸ“Š ç»Ÿè®¡ï¼š`, 'success')
        addLog(`  - è¯æ±‡æ€»æ•°: ${fileData.length}`, 'success')
        addLog(`  - æ–°å¢è¯æ±‡: ${newVocabCount}`, 'success')
        addLog(`  - å·²å­˜åœ¨è¯æ±‡: ${existingVocabCount}`, 'success')
        addLog(`  - AIè‡ªåŠ¨è¯„ä¼°: ${aiEvaluatedCount}`, 'success')
        addLog(`  - åˆ›å»ºå…³è”: ${mappingCount}`, 'success')
        addLog('============================', 'success')

        btn.textContent = 'âœ… å¯¼å…¥å®Œæˆ'
        
        setTimeout(() => {
          alert(
            `âœ… è‡ªå®šä¹‰è¯è¡¨å¯¼å…¥æˆåŠŸï¼\n\n` +
            `è¯è¡¨åç§°ï¼š${name}\n` +
            `å¯¼å…¥è¯æ±‡ï¼š${fileData.length} ä¸ª\n` +
            `æ–°å¢è¯æ±‡ï¼š${newVocabCount} ä¸ª\n\n` +
            `å­¦ç”Ÿç°åœ¨å¯ä»¥åœ¨æ¸¸æˆä¸­é€‰æ‹©ä½¿ç”¨æ‚¨çš„è¯è¡¨äº†ï¼`
          )
        }, 500)

      } catch (error) {
        console.error('å¯¼å…¥å¤±è´¥:', error)
        addLog(`\nâŒ å¯¼å…¥å¤±è´¥: ${error.message}`, 'error')
        btn.textContent = 'âŒ å¯¼å…¥å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•'
        btn.disabled = false
        alert('å¯¼å…¥å¤±è´¥: ' + error.message)
      }
    }

    /**
     * æ›´æ–°è¿›åº¦
     */
    function updateProgress(percent) {
      const fill = document.getElementById('progress-fill')
      const text = document.getElementById('progress-text')
      
      fill.style.width = percent + '%'
      fill.textContent = Math.round(percent) + '%'
      text.textContent = `å¤„ç†ä¸­... ${Math.round(percent)}%`
    }

    /**
     * æ·»åŠ æ—¥å¿—
     */
    function addLog(message, type = '') {
      const logDiv = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = 'log-entry ' + type
      entry.textContent = message
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }
  </script>
</body>
</html>

