<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>上传自定义词表</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      color: #1565c0;
    }
    
    .alert-success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }
    
    .form-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
      width: 100%;
      margin-top: 10px;
    }
    
    .file-upload {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .file-upload:hover {
      background: #e8ebff;
      border-color: #5568d3;
    }
    
    .file-upload.dragover {
      background: #d4d8ff;
      border-color: #4a5bc5;
    }
    
    .preview-section {
      margin: 20px 0;
      padding: 20px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .progress-section {
      display: none;
      margin: 20px 0;
    }
    
    .progress-section.active {
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 20px;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .log-entry.success {
      color: #2e7d32;
    }
    
    .log-entry.error {
      color: #c62828;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>✏️ 上传自定义词表</h1>
    <p class="subtitle">上传您自己的词汇列表（老师/家长专用）</p>

    <div class="alert alert-info">
      <strong>📝 使用说明：</strong><br>
      1. 下载CSV模板，填写词语和可选的分类标签<br>
      2. 上传CSV文件，系统会自动识别层级结构<br>
      3. AI会自动评估新词汇的难度等级<br>
      4. 导入后，学生在游戏中可以选择使用您的词表
    </div>

    <!-- 下载模板 -->
    <div style="margin: 20px 0;">
      <a href="templates/词表导入模板.csv" download class="btn btn-secondary">
        📥 下载CSV模板
      </a>
    </div>

    <!-- 词表信息 -->
    <div class="form-section">
      <h3 style="margin-bottom: 20px;">📋 词表信息</h3>
      
      <div class="form-group">
        <label class="form-label">词表名称 *</label>
        <input type="text" id="wordlist-name" class="form-input" 
               placeholder="例如：四年级期末复习、作文提升词汇">
        <div class="form-hint">给您的词表起个名字，学生会看到这个名称</div>
      </div>

      <div class="form-group">
        <label class="form-label">词表描述（可选）</label>
        <textarea id="wordlist-desc" class="form-textarea" 
                  placeholder="简单描述这个词表的用途，例如：为四年级下学期期末考试准备的重点词汇"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">
          <input type="checkbox" id="is-public" style="width: auto; margin-right: 8px;">
          公开分享（其他用户可以看到和使用这个词表）
        </label>
      </div>
    </div>

    <!-- 文件上传 -->
    <div class="form-section">
      <h3 style="margin-bottom: 20px;">📤 上传词表文件</h3>
      
      <div class="file-upload" id="file-upload" 
           onclick="document.getElementById('file-input').click()"
           ondrop="handleDrop(event)" 
           ondragover="handleDragOver(event)" 
           ondragleave="handleDragLeave(event)">
        <div style="font-size: 48px; margin-bottom: 10px;">📁</div>
        <p style="font-size: 16px; color: #667eea; font-weight: 500; margin-bottom: 5px;">
          点击选择文件或拖拽文件到这里
        </p>
        <p style="font-size: 12px; color: #999;">
          支持 CSV、JSON 格式
        </p>
        <input type="file" id="file-input" accept=".csv,.json" 
               style="display: none;" onchange="handleFileSelect(event)">
      </div>

      <div id="file-info" style="margin-top: 15px; display: none;">
        <p style="color: #2e7d32;">
          ✅ 已选择文件: <strong id="file-name"></strong>
        </p>
      </div>
    </div>

    <!-- 预览 -->
    <div id="preview-section" style="display: none;">
      <h3 style="margin: 20px 0;">👀 数据预览</h3>
      <div class="preview-section" id="preview-content"></div>
    </div>

    <!-- 层级配置 -->
    <div id="hierarchy-section" class="form-section" style="display: none;">
      <h3 style="margin-bottom: 20px;">🏷️ 层级标签配置</h3>
      <p style="color: #666; margin-bottom: 15px;">
        系统检测到您的词表包含层级标签。请为这些层级起个名字（用于游戏界面显示）：
      </p>
      
      <div class="form-group" id="level-2-config" style="display: none;">
        <label class="form-label">第二层级标签名称</label>
        <input type="text" id="level-2-label-name" class="form-input" 
               placeholder="例如：分类、等级、年级">
        <div class="form-hint">
          检测到的标签：<span id="level-2-tags"></span>
        </div>
      </div>

      <div class="form-group" id="level-3-config" style="display: none;">
        <label class="form-label">第三层级标签名称</label>
        <input type="text" id="level-3-label-name" class="form-input" 
               placeholder="例如：主题、单元、组别">
        <div class="form-hint">
          检测到的标签：<span id="level-3-tags"></span>
        </div>
      </div>
    </div>

    <!-- 导入按钮 -->
    <button class="btn btn-primary" id="import-btn" onclick="importCustomWordlist()" disabled>
      🚀 开始导入
    </button>

    <!-- 进度 -->
    <div class="progress-section" id="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
      </div>
      <p id="progress-text" style="text-align: center;"></p>
    </div>

    <!-- 日志 -->
    <div class="log" id="log" style="display: none;"></div>
  </div>

  <script type="module">
    import { getSupabase } from '../js/supabase-client.js'

    const supabase = getSupabase()
    let fileData = null
    let detectedHierarchy = {
      level2Tags: [],
      level3Tags: []
    }

    /**
     * 拖拽处理
     */
    window.handleDragOver = function(e) {
      e.preventDefault()
      e.stopPropagation()
      document.getElementById('file-upload').classList.add('dragover')
    }

    window.handleDragLeave = function(e) {
      e.preventDefault()
      e.stopPropagation()
      document.getElementById('file-upload').classList.remove('dragover')
    }

    window.handleDrop = function(e) {
      e.preventDefault()
      e.stopPropagation()
      document.getElementById('file-upload').classList.remove('dragover')
      
      const files = e.dataTransfer.files
      if (files.length > 0) {
        processFile(files[0])
      }
    }

    /**
     * 文件选择处理
     */
    window.handleFileSelect = function(event) {
      const file = event.target.files[0]
      if (file) {
        processFile(file)
      }
    }

    /**
     * 处理文件
     */
    async function processFile(file) {
      try {
        document.getElementById('file-name').textContent = file.name
        document.getElementById('file-info').style.display = 'block'
        
        const text = await file.text()
        
        if (file.name.endsWith('.csv')) {
          fileData = parseCSV(text)
        } else if (file.name.endsWith('.json')) {
          const json = JSON.parse(text)
          fileData = json.vocabulary || json
        } else {
          throw new Error('不支持的文件格式，请使用CSV或JSON')
        }

        // 检测层级结构
        detectHierarchy(fileData)
        
        // 显示预览
        showPreview(fileData)
        
        // 启用导入按钮
        document.getElementById('import-btn').disabled = false

      } catch (error) {
        alert('文件处理失败: ' + error.message)
        console.error(error)
      }
    }

    /**
     * 解析 CSV
     */
    function parseCSV(text) {
      const lines = text.trim().split('\n')
      const headers = lines[0].split(',').map(h => h.trim())
      
      if (!headers.includes('词语')) {
        throw new Error('CSV缺少"词语"列')
      }

      const wordIndex = headers.indexOf('词语')
      const level2Index = headers.indexOf('第二层级')
      const level3Index = headers.indexOf('第三层级')

      const data = []
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim()
        if (!line) continue
        
        const cells = line.split(',').map(c => c.trim())
        
        if (cells[wordIndex]) {
          data.push({
            word: cells[wordIndex],
            level_2_tag: level2Index >= 0 && cells[level2Index] ? cells[level2Index] : null,
            level_3_tag: level3Index >= 0 && cells[level3Index] ? cells[level3Index] : null
          })
        }
      }

      return data
    }

    /**
     * 检测层级结构
     */
    function detectHierarchy(data) {
      detectedHierarchy.level2Tags = [...new Set(data.map(d => d.level_2_tag).filter(Boolean))]
      detectedHierarchy.level3Tags = [...new Set(data.map(d => d.level_3_tag).filter(Boolean))]

      const hierarchySection = document.getElementById('hierarchy-section')
      
      if (detectedHierarchy.level2Tags.length > 0 || detectedHierarchy.level3Tags.length > 0) {
        hierarchySection.style.display = 'block'
        
        if (detectedHierarchy.level2Tags.length > 0) {
          document.getElementById('level-2-config').style.display = 'block'
          document.getElementById('level-2-tags').textContent = 
            detectedHierarchy.level2Tags.slice(0, 5).join('、') + 
            (detectedHierarchy.level2Tags.length > 5 ? '...' : '')
          
          // 自动填充建议
          document.getElementById('level-2-label-name').value = '分类'
        }
        
        if (detectedHierarchy.level3Tags.length > 0) {
          document.getElementById('level-3-config').style.display = 'block'
          document.getElementById('level-3-tags').textContent = 
            detectedHierarchy.level3Tags.slice(0, 5).join('、') + 
            (detectedHierarchy.level3Tags.length > 5 ? '...' : '')
          
          // 自动填充建议
          document.getElementById('level-3-label-name').value = '主题'
        }
      } else {
        hierarchySection.style.display = 'none'
      }
    }

    /**
     * 显示预览
     */
    function showPreview(data) {
      const previewSection = document.getElementById('preview-section')
      const content = document.getElementById('preview-content')
      
      const stats = {
        total: data.length,
        hasLevel2: data.filter(d => d.level_2_tag).length,
        hasLevel3: data.filter(d => d.level_3_tag).length
      }

      content.innerHTML = `
        <div style="padding: 15px; background: #e8f5e9; border-radius: 6px; margin-bottom: 15px;">
          <p><strong>📊 文件统计</strong></p>
          <p>• 总词汇数：${stats.total}</p>
          <p>• 有第二层级：${stats.hasLevel2} 个</p>
          <p>• 有第三层级：${stats.hasLevel3} 个</p>
        </div>
        <table style="width: 100%; font-size: 13px;">
          <tr style="background: #f5f5f5; font-weight: bold;">
            <th style="padding: 10px; text-align: left;">词语</th>
            <th style="padding: 10px; text-align: left;">第二层级</th>
            <th style="padding: 10px; text-align: left;">第三层级</th>
          </tr>
          ${data.slice(0, 15).map(d => `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 8px;">${d.word}</td>
              <td style="padding: 8px; color: #666;">${d.level_2_tag || '-'}</td>
              <td style="padding: 8px; color: #666;">${d.level_3_tag || '-'}</td>
            </tr>
          `).join('')}
          ${data.length > 15 ? `
            <tr>
              <td colspan="3" style="text-align: center; padding: 10px; color: #999;">
                ... 还有 ${data.length - 15} 个词
              </td>
            </tr>
          ` : ''}
        </table>
      `
      
      previewSection.style.display = 'block'
    }

    /**
     * 导入自定义词表
     */
    window.importCustomWordlist = async function() {
      if (!fileData || fileData.length === 0) {
        alert('请先上传文件')
        return
      }

      const name = document.getElementById('wordlist-name').value.trim()
      const description = document.getElementById('wordlist-desc').value.trim()
      const isPublic = document.getElementById('is-public').checked

      if (!name) {
        alert('请填写词表名称')
        return
      }

      // 获取层级标签名称
      const level2Label = detectedHierarchy.level2Tags.length > 0 
        ? document.getElementById('level-2-label-name').value.trim() || '分类'
        : null
      
      const level3Label = detectedHierarchy.level3Tags.length > 0
        ? document.getElementById('level-3-label-name').value.trim() || '主题'
        : null

      const confirmed = confirm(
        `确定要导入此自定义词表吗？\n\n` +
        `词表名称：${name}\n` +
        `词汇数量：${fileData.length}\n` +
        `第二层级：${level2Label || '无'}\n` +
        `第三层级：${level3Label || '无'}\n` +
        `公开分享：${isPublic ? '是' : '否'}`
      )

      if (!confirmed) return

      const btn = document.getElementById('import-btn')
      btn.disabled = true
      btn.innerHTML = '导入中...'

      const progressSection = document.getElementById('progress-section')
      const logDiv = document.getElementById('log')
      progressSection.classList.add('active')
      logDiv.style.display = 'block'

      try {
        // 获取当前用户ID
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) throw new Error('请先登录')

        const userId = user.id

        // 1. 创建词表
        addLog('📝 创建自定义词表...', 'success')
        
        const code = `custom_${userId}_${Date.now()}`
        
        const { data: wordlist, error: wlError } = await supabase
          .from('wordlists')
          .insert({
            name,
            code,
            type: 'custom',
            owner_id: userId,
            hierarchy_config: {
              level_2_label: level2Label,
              level_3_label: level3Label
            },
            description,
            is_public: isPublic
          })
          .select()
          .single()

        if (wlError) throw wlError
        addLog(`✅ 词表创建成功: ${name}`, 'success')

        // 2. 创建标签
        const level2TagMap = {}
        const level3TagMap = {}

        if (detectedHierarchy.level2Tags.length > 0) {
          addLog('\n📋 创建第二层级标签...', 'success')
          
          for (let i = 0; i < detectedHierarchy.level2Tags.length; i++) {
            const tag = detectedHierarchy.level2Tags[i]
            
            const { data: tagData, error: tagError } = await supabase
              .from('wordlist_tags')
              .insert({
                wordlist_id: wordlist.id,
                tag_level: 2,
                tag_code: tag,
                tag_display_name: tag,
                sort_order: i
              })
              .select()
              .single()

            if (tagError) throw tagError
            level2TagMap[tag] = tagData.id
            addLog(`  ✅ ${tag}`, 'success')
          }
        }

        if (detectedHierarchy.level3Tags.length > 0) {
          addLog('\n📋 创建第三层级标签...', 'success')
          
          for (let i = 0; i < detectedHierarchy.level3Tags.length; i++) {
            const tag = detectedHierarchy.level3Tags[i]
            
            const { data: tagData, error: tagError } = await supabase
              .from('wordlist_tags')
              .insert({
                wordlist_id: wordlist.id,
                tag_level: 3,
                tag_code: tag,
                tag_display_name: tag,
                sort_order: i
              })
              .select()
              .single()

            if (tagError) throw tagError
            level3TagMap[tag] = tagData.id
            addLog(`  ✅ ${tag}`, 'success')
          }
        }

        // 3. 导入词汇
        addLog('\n📚 开始导入词汇...', 'success')
        
        let newVocabCount = 0
        let existingVocabCount = 0
        let aiEvaluatedCount = 0
        let mappingCount = 0

        for (let i = 0; i < fileData.length; i++) {
          const item = fileData[i]
          
          updateProgress((i / fileData.length) * 100)

          try {
            // 查找词汇
            let { data: vocab } = await supabase
              .from('vocabulary')
              .select('*')
              .eq('word', item.word)
              .maybeSingle()

            if (!vocab) {
              // 新词汇：调用AI评估
              addLog(`  🤖 新词"${item.word}"，AI评估中...`)
              
              const { data: evalData } = await supabase.functions.invoke(
                'vocab-difficulty-evaluator',
                {
                  body: {
                    words: [{ word: item.word }],
                    mode: 'single'
                  }
                }
              )

              const evaluation = evalData?.results?.[0] || {
                difficulty: 3,
                category: '未知',
                confidence: 'low',
                reasoning: 'AI评估失败，使用默认值'
              }

              // 创建词汇
              const { data: newVocab, error } = await supabase
                .from('vocabulary')
                .insert({
                  word: item.word,
                  difficulty_level: evaluation.difficulty,
                  category: evaluation.category,
                  frequency: 50,
                  difficulty_confidence: evaluation.confidence,
                  difficulty_reasoning: evaluation.reasoning,
                  difficulty_evaluated_at: new Date().toISOString()
                })
                .select()
                .single()

              if (error) throw error
              
              vocab = newVocab
              newVocabCount++
              aiEvaluatedCount++
              addLog(`  ✅ ${item.word} (L${evaluation.difficulty})`, 'success')
            } else {
              existingVocabCount++
            }

            // 创建关联
            const tagPath = [item.level_2_tag, item.level_3_tag].filter(Boolean)
            
            const { error: mappingError } = await supabase
              .from('vocabulary_wordlist_mapping')
              .insert({
                vocabulary_id: vocab.id,
                wordlist_id: wordlist.id,
                tag_path: JSON.stringify(tagPath),
                level_2_tag: item.level_2_tag || null,
                level_3_tag: item.level_3_tag || null
              })

            if (mappingError && mappingError.code !== '23505') {
              throw mappingError
            }
            
            mappingCount++

          } catch (error) {
            console.error(`处理失败: ${item.word}`, error)
            addLog(`  ❌ ${item.word} - ${error.message}`, 'error')
          }
        }

        updateProgress(100)

        addLog('\n============================', 'success')
        addLog(`✅ 导入完成！`, 'success')
        addLog(`📊 统计：`, 'success')
        addLog(`  - 词汇总数: ${fileData.length}`, 'success')
        addLog(`  - 新增词汇: ${newVocabCount}`, 'success')
        addLog(`  - 已存在词汇: ${existingVocabCount}`, 'success')
        addLog(`  - AI自动评估: ${aiEvaluatedCount}`, 'success')
        addLog(`  - 创建关联: ${mappingCount}`, 'success')
        addLog('============================', 'success')

        btn.textContent = '✅ 导入完成'
        
        setTimeout(() => {
          alert(
            `✅ 自定义词表导入成功！\n\n` +
            `词表名称：${name}\n` +
            `导入词汇：${fileData.length} 个\n` +
            `新增词汇：${newVocabCount} 个\n\n` +
            `学生现在可以在游戏中选择使用您的词表了！`
          )
        }, 500)

      } catch (error) {
        console.error('导入失败:', error)
        addLog(`\n❌ 导入失败: ${error.message}`, 'error')
        btn.textContent = '❌ 导入失败，点击重试'
        btn.disabled = false
        alert('导入失败: ' + error.message)
      }
    }

    /**
     * 更新进度
     */
    function updateProgress(percent) {
      const fill = document.getElementById('progress-fill')
      const text = document.getElementById('progress-text')
      
      fill.style.width = percent + '%'
      fill.textContent = Math.round(percent) + '%'
      text.textContent = `处理中... ${Math.round(percent)}%`
    }

    /**
     * 添加日志
     */
    function addLog(message, type = '') {
      const logDiv = document.getElementById('log')
      const entry = document.createElement('div')
      entry.className = 'log-entry ' + type
      entry.textContent = message
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }
  </script>
</body>
</html>

