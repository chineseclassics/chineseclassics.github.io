-- =====================================================
-- 锁定 vocabulary 表的修改和删除权限
-- 创建日期：2025-10-12
-- 问题：当前允许任何用户修改/删除全局词汇表
-- 风险：用户可能污染全局词汇库，影响所有用户
-- =====================================================

BEGIN;

-- ========================================
-- 1. 删除危险的策略
-- ========================================

-- 删除允许所有人更新的策略
DROP POLICY IF EXISTS "public_update_vocabulary" ON vocabulary;

-- 删除允许所有人删除的策略
DROP POLICY IF EXISTS "public_delete_vocabulary" ON vocabulary;

-- ========================================
-- 2. 保留必要的策略
-- ========================================

-- ✅ 保留：允许所有人读取词汇（这是必要的）
-- public_read_vocabulary 策略保持不变

-- ✅ 保留：允许插入新词（用于用户上传词表）
-- public_insert_vocabulary 策略保持不变
-- 注意：这仍然存在风险，未来应考虑更严格的验证

COMMIT;

-- ========================================
-- 验证结果
-- ========================================

DO $$
BEGIN
  RAISE NOTICE '✅ vocabulary 表权限已收紧';
  RAISE NOTICE '   ✓ 保留读取权限（所有用户）';
  RAISE NOTICE '   ✓ 保留插入权限（用户上传词表需要）';
  RAISE NOTICE '   ✗ 删除更新权限（防止恶意修改）';
  RAISE NOTICE '   ✗ 删除删除权限（防止恶意删除）';
  RAISE NOTICE '';
  RAISE NOTICE '⚠️  注意：仍然允许插入新词';
  RAISE NOTICE '   建议未来实施词汇审核机制';
END $$;

-- =====================================================
-- 遷移完成說明
-- =====================================================
-- 
-- 修復內容：
-- 1. 刪除 public_update_vocabulary 策略
--    - 防止用戶修改已存在的詞彙
--    - 保護詞彙的 category, difficulty 等屬性
--
-- 2. 刪除 public_delete_vocabulary 策略
--    - 防止用戶刪除詞彙
--    - 保護詞彙庫的完整性
--
-- 保留的權限：
-- - SELECT: 所有用戶可以讀取詞彙
-- - INSERT: 允許添加新詞（用於用戶上傳詞表）
--
-- 未來建議：
-- 1. 實施詞彙審核機制
--    - 用戶上傳的新詞先進入待審核狀態
--    - 管理員審核後才加入正式詞彙庫
--
-- 2. 考慮分離詞彙表
--    - system_vocabulary: 系統詞彙（管理員管理）
--    - custom_vocabulary: 用戶自定義詞彙
--
-- 3. 添加詞彙驗證
--    - 檢查詞語長度（1-10 個字）
--    - 檢查是否為中文
--    - 檢查是否重複
-- =====================================================

