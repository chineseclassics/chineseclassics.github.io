<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>設置 - 故事詞彙接龍</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 自定义样式 -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  
  <style>
    .settings-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .setting-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .setting-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mode-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .mode-card {
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .mode-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .mode-card.active {
      border-color: #667eea;
      background: #f0f2ff;
    }

    .mode-card .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .mode-card .title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .mode-card .desc {
      font-size: 12px;
      color: #666;
    }

    .wordlist-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wordlist-info {
      flex: 1;
    }

    .wordlist-name {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .wordlist-meta {
      font-size: 12px;
      color: #666;
    }

    .wordlist-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-icon:hover {
      background: #f5f5f5;
    }

    .select-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      margin: 10px 0;
    }

    .select-input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* 模态窗口样式 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      cursor: pointer;
      color: #999;
      background: none;
      border: none;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    .file-upload-zone {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
      margin: 15px 0;
    }

    .file-upload-zone:hover {
      background: #e8ebff;
      border-color: #5568d3;
    }

    .file-upload-zone.dragover {
      background: #d4d8ff;
      border-color: #4a5bc5;
    }

    .progress-section {
      display: none;
      margin: 20px 0;
    }

    .progress-section.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 25px;
      background: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-500 to-indigo-600 min-h-screen">
  <div class="settings-container">
    <!-- 返回按钮 -->
    <div style="margin-bottom: 20px;">
      <button onclick="location.href='index.html'" 
              class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 transition">
        ← 返回主页
      </button>
    </div>

    <h1 class="text-4xl font-bold text-white mb-6">⚙️ 設置</h1>

    <!-- 词表设置 -->
    <div class="setting-section">
      <div class="setting-title">
        📚 詞表設置
      </div>
      <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
        選擇您要使用的詞表模式，設置後將在開始創作時自動應用
      </p>

      <div style="margin: 20px 0;">
        <label class="form-label">選擇詞表</label>
        <select id="wordlist-selector" class="select-input" onchange="onWordlistSelect()">
          <option value="ai">🤖 AI智能推荐（默认）</option>
          <optgroup label="系統詞表" id="system-wordlists-group"></optgroup>
          <optgroup label="我的詞表" id="custom-wordlists-group"></optgroup>
          <option value="__add_custom__">➕ 添加自定義詞表</option>
        </select>
      </div>

      <button class="btn-primary mt-4" onclick="saveWordlistPreference()">
        💾 保存设置
      </button>
    </div>
  </div>

  <!-- 上传自定义词表模态窗口 -->
  <div class="modal-overlay" id="upload-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">➕ 上傳自定義詞表</h2>
        <button class="modal-close" onclick="closeUploadModal()">×</button>
      </div>

      <div class="form-group">
        <label class="form-label">詞表名稱 *</label>
        <input type="text" id="wordlist-name" class="form-input" placeholder="例如：四年級復習詞彙">
      </div>

      <div class="form-group">
        <label class="form-label">詞表描述（可選）</label>
        <textarea id="wordlist-desc" class="form-input" rows="2" placeholder="簡短描述這個詞表的用途..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">下載CSV模板</label>
        <button class="btn-secondary" onclick="downloadTemplate()">📥 下載模板</button>
      </div>

      <div class="form-group">
        <label class="form-label">上傳CSV文件 *</label>
        <div class="file-upload-zone" id="upload-zone">
          <p style="margin: 0; font-size: 32px;">📁</p>
          <p style="margin: 10px 0; color: #667eea; font-weight: 500;">拖拽文件到這裡或點擊選擇</p>
          <p style="margin: 0; font-size: 12px; color: #999;">支持 .csv 格式</p>
          <input type="file" id="csv-file" accept=".csv" style="display: none;">
        </div>
        <p id="file-name" style="margin-top: 10px; font-size: 14px; color: #666;"></p>
      </div>

      <div class="progress-section" id="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
        </div>
        <p id="progress-text" style="text-align: center; color: #666; font-size: 14px; margin-top: 10px;">準備中...</p>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-secondary" style="width: auto; flex: 1;" onclick="closeUploadModal()">取消</button>
        <button class="btn-primary" style="width: auto; flex: 1;" onclick="uploadWordlist()" id="upload-btn">確認上傳</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { getSupabase } from './js/supabase-client.js'

    const supabase = getSupabase()
    let currentUser = null
    let selectedWordlistId = null  // 当前选中的词表ID
    let uploadedFile = null  // 上传的文件

    /**
     * 初始化
     */
    async function initialize() {
      try {
        // 获取当前用户
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) {
          alert('請先登錄')
          location.href = 'index.html'
          return
        }
        currentUser = user
        console.log('✅ 用戶:', currentUser.id)

        // 加载词表列表
        await loadWordlistSelector()

        // 初始化文件上传
        initFileUpload()

      } catch (error) {
        console.error('❌ 初始化失败:', error)
        alert('初始化失败: ' + error.message)
      }
    }

    /**
     * 加载词表选择器
     */
    async function loadWordlistSelector() {
      // 加载用户偏好
      const { data: prefs } = await supabase
        .from('user_wordlist_preferences')
        .select('*')
        .eq('user_id', currentUser.id)
        .maybeSingle()

      // 加载所有可用词表
      const { data: wordlists } = await supabase
        .from('wordlists')
        .select('*')
        .or(`type.eq.system,owner_id.eq.${currentUser.id}`)
        .order('type', { ascending: false })
        .order('name')

      const systemWordlists = wordlists?.filter(w => w.type === 'system') || []
      const customWordlists = wordlists?.filter(w => w.owner_id === currentUser.id) || []

      // 填充系统词表
      const systemGroup = document.getElementById('system-wordlists-group')
      systemGroup.innerHTML = systemWordlists.map(wl => `
        <option value="${wl.id}">${wl.name} (${wl.total_words || 0}詞)</option>
      `).join('') || '<option disabled>暫無系統詞表</option>'

      // 填充自定义词表
      const customGroup = document.getElementById('custom-wordlists-group')
      customGroup.innerHTML = customWordlists.map(wl => `
        <option value="${wl.id}">${wl.name} (${wl.total_words || 0}詞)</option>
      `).join('') || '<option disabled>暫無自定義詞表</option>'

      // 设置当前选中
      const selector = document.getElementById('wordlist-selector')
      if (prefs?.default_wordlist_id) {
        selector.value = prefs.default_wordlist_id
        selectedWordlistId = prefs.default_wordlist_id
      } else {
        selector.value = 'ai'
        selectedWordlistId = null
      }
    }

    /**
     * 词表选择变化
     */
    window.onWordlistSelect = function() {
      const selector = document.getElementById('wordlist-selector')
      const value = selector.value

      if (value === '__add_custom__') {
        // 打开上传模态窗口
        document.getElementById('upload-modal').classList.add('active')
        // 重置选择器到之前的值
        selector.value = selectedWordlistId || 'ai'
      } else if (value === 'ai') {
        selectedWordlistId = null
      } else {
        selectedWordlistId = value
      }
    }

    /**
     * 保存词表偏好
     */
    window.saveWordlistPreference = async function() {
      try {
        const selector = document.getElementById('wordlist-selector')
        const value = selector.value

        const { error } = await supabase
          .from('user_wordlist_preferences')
          .upsert({
            user_id: currentUser.id,
            default_mode: value === 'ai' ? 'ai' : 'wordlist',
            default_wordlist_id: value === 'ai' ? null : value,
            default_level_2_tag: null,
            default_level_3_tag: null,
            updated_at: new Date().toISOString()
          })

        if (error) throw error

        alert('✅ 設置已保存！')
        console.log('✅ 詞表偏好已保存:', value)

      } catch (error) {
        alert('保存失敗: ' + error.message)
        console.error('❌ 保存失敗:', error)
      }
    }

    /**
     * 初始化文件上传
     */
    function initFileUpload() {
      const uploadZone = document.getElementById('upload-zone')
      const fileInput = document.getElementById('csv-file')

      // 点击上传区域
      uploadZone.addEventListener('click', () => {
        fileInput.click()
      })

      // 文件选择
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]
        if (file) {
          uploadedFile = file
          document.getElementById('file-name').textContent = `已選擇: ${file.name}`
        }
      })

      // 拖拽
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault()
        uploadZone.classList.add('dragover')
      })

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover')
      })

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault()
        uploadZone.classList.remove('dragover')
        const file = e.dataTransfer.files[0]
        if (file && file.name.endsWith('.csv')) {
          uploadedFile = file
          document.getElementById('file-name').textContent = `已選擇: ${file.name}`
        } else {
          alert('請上傳 CSV 格式文件')
        }
      })
    }

    /**
     * 关闭上传模态窗口
     */
    window.closeUploadModal = function() {
      document.getElementById('upload-modal').classList.remove('active')
      // 重置表单
      document.getElementById('wordlist-name').value = ''
      document.getElementById('wordlist-desc').value = ''
      document.getElementById('csv-file').value = ''
      document.getElementById('file-name').textContent = ''
      uploadedFile = null
      document.getElementById('progress-section').classList.remove('active')
    }

    /**
     * 下载CSV模板
     */
    window.downloadTemplate = function() {
      const template = '詞語,第二層級,第三層級\n生字,第一單元,課文一\n詞彙,第一單元,課文一\n句子,第二單元,課文二'
      const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = '詞表導入模板.csv'
      a.click()
    }

    /**
     * 上传词表
     */
    window.uploadWordlist = async function() {
      const name = document.getElementById('wordlist-name').value.trim()
      const desc = document.getElementById('wordlist-desc').value.trim()

      if (!name) {
        alert('請輸入詞表名稱')
        return
      }

      if (!uploadedFile) {
        alert('請選擇CSV文件')
        return
      }

      // 显示进度
      const progressSection = document.getElementById('progress-section')
      const progressFill = document.getElementById('progress-fill')
      const progressText = document.getElementById('progress-text')
      const uploadBtn = document.getElementById('upload-btn')

      progressSection.classList.add('active')
      uploadBtn.disabled = true

      try {
        // 读取CSV
        progressText.textContent = '讀取文件中...'
        progressFill.style.width = '10%'
        progressFill.textContent = '10%'

        const text = await uploadedFile.text()
        const rows = text.split('\n').map(row => row.trim()).filter(row => row)
        
        if (rows.length < 2) {
          throw new Error('CSV文件內容為空或格式錯誤')
        }

        // 解析CSV
        const headers = rows[0].split(',')
        const data = rows.slice(1).map(row => {
          const cols = row.split(',')
          return {
            word: cols[0]?.trim(),
            level2: cols[1]?.trim() || '',
            level3: cols[2]?.trim() || ''
          }
        }).filter(d => d.word)

        console.log(`📊 解析了 ${data.length} 個詞語`)

        // 创建词表
        progressText.textContent = '創建詞表中...'
        progressFill.style.width = '30%'
        progressFill.textContent = '30%'

        const { data: wordlist, error: wlError } = await supabase
          .from('wordlists')
          .insert({
            name,
            description: desc || null,
            type: 'custom',
            owner_id: currentUser.id,
            total_words: data.length,
            hierarchy_config: {
              level_2_label: '第二層級',
              level_3_label: '第三層級'
            }
          })
          .select()
          .single()

        if (wlError) throw wlError

        console.log('✅ 詞表已創建:', wordlist.id)

        // 提取唯一的标签
        const level2Tags = [...new Set(data.map(d => d.level2).filter(t => t))]
        const level3Tags = [...new Set(data.map(d => d.level3).filter(t => t))]

        // 插入标签
        progressText.textContent = '創建標籤中...'
        progressFill.style.width = '40%'
        progressFill.textContent = '40%'

        const tagsToInsert = [
          ...level2Tags.map((tag, idx) => ({
            wordlist_id: wordlist.id,
            tag_level: 2,
            tag_code: tag,
            tag_display_name: tag,
            sort_order: idx
          })),
          ...level3Tags.map((tag, idx) => ({
            wordlist_id: wordlist.id,
            tag_level: 3,
            tag_code: tag,
            tag_display_name: tag,
            sort_order: idx
          }))
        ]

        if (tagsToInsert.length > 0) {
          const { error: tagError } = await supabase
            .from('wordlist_tags')
            .insert(tagsToInsert)

          if (tagError) throw tagError
          console.log(`✅ 已創建 ${tagsToInsert.length} 個標籤`)
        }

        // 插入词汇并关联
        progressText.textContent = `導入詞彙中... (0/${data.length})`
        progressFill.style.width = '50%'
        progressFill.textContent = '50%'

        let imported = 0
        const batchSize = 50

        for (let i = 0; i < data.length; i += batchSize) {
          const batch = data.slice(i, i + batchSize)
          
          // 获取或创建词汇
          for (const item of batch) {
            // 检查词汇是否存在
            let { data: existingWord } = await supabase
              .from('vocabulary')
              .select('id')
              .eq('word', item.word)
              .maybeSingle()

            let vocabId
            if (existingWord) {
              vocabId = existingWord.id
            } else {
              // 创建新词汇
              const { data: newWord, error: vocabError } = await supabase
                .from('vocabulary')
                .insert({
                  word: item.word,
                  difficulty_level: 3  // 默认中等难度
                })
                .select('id')
                .single()

              if (vocabError) throw vocabError
              vocabId = newWord.id
            }

            // 关联到词表
            const { error: mappingError } = await supabase
              .from('vocabulary_wordlist_mapping')
              .insert({
                wordlist_id: wordlist.id,
                vocabulary_id: vocabId,
                level_2_tag: item.level2 || null,
                level_3_tag: item.level3 || null
              })

            if (mappingError) throw mappingError
            imported++
          }

          const progress = 50 + Math.floor((imported / data.length) * 40)
          progressFill.style.width = `${progress}%`
          progressFill.textContent = `${progress}%`
          progressText.textContent = `導入詞彙中... (${imported}/${data.length})`
        }

        // 完成
        progressFill.style.width = '100%'
        progressFill.textContent = '100%'
        progressText.textContent = `✅ 成功導入 ${imported} 個詞語！`

        setTimeout(() => {
          closeUploadModal()
          alert(`✅ 詞表"${name}"已成功上傳！`)
          loadWordlistSelector()  // 刷新列表
        }, 1500)

      } catch (error) {
        console.error('❌ 上傳失敗:', error)
        alert('上傳失敗: ' + error.message)
        progressSection.classList.remove('active')
        uploadBtn.disabled = false
      }
    }

    // 页面加载时初始化
    window.addEventListener('load', () => {
      initialize()
    })
  </script>
</body>
</html>

