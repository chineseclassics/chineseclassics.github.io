<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨­ç½® - æ•…äº‹è©å½™æ¥é¾</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  
  <style>
    .settings-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .setting-section {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .setting-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mode-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .mode-card {
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .mode-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .mode-card.active {
      border-color: #667eea;
      background: #f0f2ff;
    }

    .mode-card .icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .mode-card .title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .mode-card .desc {
      font-size: 12px;
      color: #666;
    }

    .wordlist-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wordlist-info {
      flex: 1;
    }

    .wordlist-name {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .wordlist-meta {
      font-size: 12px;
      color: #666;
    }

    .wordlist-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-icon:hover {
      background: #f5f5f5;
    }

    .select-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      margin: 10px 0;
    }

    .select-input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* æ¨¡æ€çª—å£æ ·å¼ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      cursor: pointer;
      color: #999;
      background: none;
      border: none;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .modal-close:hover {
      background: #f5f5f5;
      color: #333;
    }

    .file-upload-zone {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
      margin: 15px 0;
    }

    .file-upload-zone:hover {
      background: #e8ebff;
      border-color: #5568d3;
    }

    .file-upload-zone.dragover {
      background: #d4d8ff;
      border-color: #4a5bc5;
    }

    .progress-section {
      display: none;
      margin: 20px 0;
    }

    .progress-section.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 25px;
      background: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-500 to-indigo-600 min-h-screen">
  <div class="settings-container">
    <!-- è¿”å›æŒ‰é’® -->
    <div style="margin-bottom: 20px;">
      <button onclick="location.href='index.html'" 
              class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 transition">
        â† è¿”å›ä¸»é¡µ
      </button>
    </div>

    <h1 class="text-4xl font-bold text-white mb-6">âš™ï¸ è¨­ç½®</h1>

    <!-- è¯è¡¨è®¾ç½® -->
    <div class="setting-section">
      <div class="setting-title">
        ğŸ“š è©è¡¨è¨­ç½®
      </div>
      <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
        é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„è©è¡¨æ¨¡å¼ï¼Œè¨­ç½®å¾Œå°‡åœ¨é–‹å§‹å‰µä½œæ™‚è‡ªå‹•æ‡‰ç”¨
      </p>

      <div style="margin: 20px 0;">
        <label class="form-label">é¸æ“‡è©è¡¨</label>
        <select id="wordlist-selector" class="select-input" onchange="onWordlistSelect()">
          <option value="ai">ğŸ¤– AIæ™ºèƒ½æ¨èï¼ˆé»˜è®¤ï¼‰</option>
          <optgroup label="ç³»çµ±è©è¡¨" id="system-wordlists-group"></optgroup>
          <optgroup label="æˆ‘çš„è©è¡¨" id="custom-wordlists-group"></optgroup>
          <option value="__add_custom__">â• æ·»åŠ è‡ªå®šç¾©è©è¡¨</option>
        </select>
      </div>

      <button class="btn-primary mt-4" onclick="saveWordlistPreference()">
        ğŸ’¾ ä¿å­˜è®¾ç½®
      </button>
    </div>
  </div>

  <!-- ä¸Šä¼ è‡ªå®šä¹‰è¯è¡¨æ¨¡æ€çª—å£ -->
  <div class="modal-overlay" id="upload-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">â• ä¸Šå‚³è‡ªå®šç¾©è©è¡¨</h2>
        <button class="modal-close" onclick="closeUploadModal()">Ã—</button>
      </div>

      <div class="form-group">
        <label class="form-label">è©è¡¨åç¨± *</label>
        <input type="text" id="wordlist-name" class="form-input" placeholder="ä¾‹å¦‚ï¼šå››å¹´ç´šå¾©ç¿’è©å½™">
      </div>

      <div class="form-group">
        <label class="form-label">è©è¡¨æè¿°ï¼ˆå¯é¸ï¼‰</label>
        <textarea id="wordlist-desc" class="form-input" rows="2" placeholder="ç°¡çŸ­æè¿°é€™å€‹è©è¡¨çš„ç”¨é€”..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">ä¸‹è¼‰CSVæ¨¡æ¿</label>
        <button class="btn-secondary" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è¼‰æ¨¡æ¿</button>
      </div>

      <div class="form-group">
        <label class="form-label">ä¸Šå‚³CSVæ–‡ä»¶ *</label>
        <div class="file-upload-zone" id="upload-zone">
          <p style="margin: 0; font-size: 32px;">ğŸ“</p>
          <p style="margin: 10px 0; color: #667eea; font-weight: 500;">æ‹–æ‹½æ–‡ä»¶åˆ°é€™è£¡æˆ–é»æ“Šé¸æ“‡</p>
          <p style="margin: 0; font-size: 12px; color: #999;">æ”¯æŒ .csv æ ¼å¼</p>
          <input type="file" id="csv-file" accept=".csv" style="display: none;">
        </div>
        <p id="file-name" style="margin-top: 10px; font-size: 14px; color: #666;"></p>
      </div>

      <div class="progress-section" id="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
        </div>
        <p id="progress-text" style="text-align: center; color: #666; font-size: 14px; margin-top: 10px;">æº–å‚™ä¸­...</p>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn-secondary" style="width: auto; flex: 1;" onclick="closeUploadModal()">å–æ¶ˆ</button>
        <button class="btn-primary" style="width: auto; flex: 1;" onclick="uploadWordlist()" id="upload-btn">ç¢ºèªä¸Šå‚³</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { getSupabase } from './js/supabase-client.js'

    const supabase = getSupabase()
    let currentUser = null
    let selectedWordlistId = null  // å½“å‰é€‰ä¸­çš„è¯è¡¨ID
    let uploadedFile = null  // ä¸Šä¼ çš„æ–‡ä»¶

    /**
     * åˆå§‹åŒ–
     */
    async function initialize() {
      try {
        // è·å–å½“å‰ç”¨æˆ·
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) {
          alert('è«‹å…ˆç™»éŒ„')
          location.href = 'index.html'
          return
        }
        currentUser = user
        console.log('âœ… ç”¨æˆ¶:', currentUser.id)

        // åŠ è½½è¯è¡¨åˆ—è¡¨
        await loadWordlistSelector()

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
        initFileUpload()

      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error)
        alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message)
      }
    }

    /**
     * åŠ è½½è¯è¡¨é€‰æ‹©å™¨
     */
    async function loadWordlistSelector() {
      // åŠ è½½ç”¨æˆ·åå¥½
      const { data: prefs } = await supabase
        .from('user_wordlist_preferences')
        .select('*')
        .eq('user_id', currentUser.id)
        .maybeSingle()

      // åŠ è½½æ‰€æœ‰å¯ç”¨è¯è¡¨
      const { data: wordlists } = await supabase
        .from('wordlists')
        .select('*')
        .or(`type.eq.system,owner_id.eq.${currentUser.id}`)
        .order('type', { ascending: false })
        .order('name')

      const systemWordlists = wordlists?.filter(w => w.type === 'system') || []
      const customWordlists = wordlists?.filter(w => w.owner_id === currentUser.id) || []

      // å¡«å……ç³»ç»Ÿè¯è¡¨
      const systemGroup = document.getElementById('system-wordlists-group')
      systemGroup.innerHTML = systemWordlists.map(wl => `
        <option value="${wl.id}">${wl.name} (${wl.total_words || 0}è©)</option>
      `).join('') || '<option disabled>æš«ç„¡ç³»çµ±è©è¡¨</option>'

      // å¡«å……è‡ªå®šä¹‰è¯è¡¨
      const customGroup = document.getElementById('custom-wordlists-group')
      customGroup.innerHTML = customWordlists.map(wl => `
        <option value="${wl.id}">${wl.name} (${wl.total_words || 0}è©)</option>
      `).join('') || '<option disabled>æš«ç„¡è‡ªå®šç¾©è©è¡¨</option>'

      // è®¾ç½®å½“å‰é€‰ä¸­
      const selector = document.getElementById('wordlist-selector')
      if (prefs?.default_wordlist_id) {
        selector.value = prefs.default_wordlist_id
        selectedWordlistId = prefs.default_wordlist_id
      } else {
        selector.value = 'ai'
        selectedWordlistId = null
      }
    }

    /**
     * è¯è¡¨é€‰æ‹©å˜åŒ–
     */
    window.onWordlistSelect = function() {
      const selector = document.getElementById('wordlist-selector')
      const value = selector.value

      if (value === '__add_custom__') {
        // æ‰“å¼€ä¸Šä¼ æ¨¡æ€çª—å£
        document.getElementById('upload-modal').classList.add('active')
        // é‡ç½®é€‰æ‹©å™¨åˆ°ä¹‹å‰çš„å€¼
        selector.value = selectedWordlistId || 'ai'
      } else if (value === 'ai') {
        selectedWordlistId = null
      } else {
        selectedWordlistId = value
      }
    }

    /**
     * ä¿å­˜è¯è¡¨åå¥½
     */
    window.saveWordlistPreference = async function() {
      try {
        const selector = document.getElementById('wordlist-selector')
        const value = selector.value

        const { error } = await supabase
          .from('user_wordlist_preferences')
          .upsert({
            user_id: currentUser.id,
            default_mode: value === 'ai' ? 'ai' : 'wordlist',
            default_wordlist_id: value === 'ai' ? null : value,
            default_level_2_tag: null,
            default_level_3_tag: null,
            updated_at: new Date().toISOString()
          })

        if (error) throw error

        alert('âœ… è¨­ç½®å·²ä¿å­˜ï¼')
        console.log('âœ… è©è¡¨åå¥½å·²ä¿å­˜:', value)

      } catch (error) {
        alert('ä¿å­˜å¤±æ•—: ' + error.message)
        console.error('âŒ ä¿å­˜å¤±æ•—:', error)
      }
    }

    /**
     * åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
     */
    function initFileUpload() {
      const uploadZone = document.getElementById('upload-zone')
      const fileInput = document.getElementById('csv-file')

      // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
      uploadZone.addEventListener('click', () => {
        fileInput.click()
      })

      // æ–‡ä»¶é€‰æ‹©
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]
        if (file) {
          uploadedFile = file
          document.getElementById('file-name').textContent = `å·²é¸æ“‡: ${file.name}`
        }
      })

      // æ‹–æ‹½
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault()
        uploadZone.classList.add('dragover')
      })

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover')
      })

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault()
        uploadZone.classList.remove('dragover')
        const file = e.dataTransfer.files[0]
        if (file && file.name.endsWith('.csv')) {
          uploadedFile = file
          document.getElementById('file-name').textContent = `å·²é¸æ“‡: ${file.name}`
        } else {
          alert('è«‹ä¸Šå‚³ CSV æ ¼å¼æ–‡ä»¶')
        }
      })
    }

    /**
     * å…³é—­ä¸Šä¼ æ¨¡æ€çª—å£
     */
    window.closeUploadModal = function() {
      document.getElementById('upload-modal').classList.remove('active')
      // é‡ç½®è¡¨å•
      document.getElementById('wordlist-name').value = ''
      document.getElementById('wordlist-desc').value = ''
      document.getElementById('csv-file').value = ''
      document.getElementById('file-name').textContent = ''
      uploadedFile = null
      document.getElementById('progress-section').classList.remove('active')
    }

    /**
     * ä¸‹è½½CSVæ¨¡æ¿
     */
    window.downloadTemplate = function() {
      const template = 'è©èª,ç¬¬äºŒå±¤ç´š,ç¬¬ä¸‰å±¤ç´š\nç”Ÿå­—,ç¬¬ä¸€å–®å…ƒ,èª²æ–‡ä¸€\nè©å½™,ç¬¬ä¸€å–®å…ƒ,èª²æ–‡ä¸€\nå¥å­,ç¬¬äºŒå–®å…ƒ,èª²æ–‡äºŒ'
      const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'è©è¡¨å°å…¥æ¨¡æ¿.csv'
      a.click()
    }

    /**
     * ä¸Šä¼ è¯è¡¨
     */
    window.uploadWordlist = async function() {
      const name = document.getElementById('wordlist-name').value.trim()
      const desc = document.getElementById('wordlist-desc').value.trim()

      if (!name) {
        alert('è«‹è¼¸å…¥è©è¡¨åç¨±')
        return
      }

      if (!uploadedFile) {
        alert('è«‹é¸æ“‡CSVæ–‡ä»¶')
        return
      }

      // æ˜¾ç¤ºè¿›åº¦
      const progressSection = document.getElementById('progress-section')
      const progressFill = document.getElementById('progress-fill')
      const progressText = document.getElementById('progress-text')
      const uploadBtn = document.getElementById('upload-btn')

      progressSection.classList.add('active')
      uploadBtn.disabled = true

      try {
        // è¯»å–CSV
        progressText.textContent = 'è®€å–æ–‡ä»¶ä¸­...'
        progressFill.style.width = '10%'
        progressFill.textContent = '10%'

        const text = await uploadedFile.text()
        const rows = text.split('\n').map(row => row.trim()).filter(row => row)
        
        if (rows.length < 2) {
          throw new Error('CSVæ–‡ä»¶å…§å®¹ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤')
        }

        // è§£æCSV
        const headers = rows[0].split(',')
        const data = rows.slice(1).map(row => {
          const cols = row.split(',')
          return {
            word: cols[0]?.trim(),
            level2: cols[1]?.trim() || '',
            level3: cols[2]?.trim() || ''
          }
        }).filter(d => d.word)

        console.log(`ğŸ“Š è§£æäº† ${data.length} å€‹è©èª`)

        // åˆ›å»ºè¯è¡¨
        progressText.textContent = 'å‰µå»ºè©è¡¨ä¸­...'
        progressFill.style.width = '30%'
        progressFill.textContent = '30%'

        const { data: wordlist, error: wlError } = await supabase
          .from('wordlists')
          .insert({
            name,
            description: desc || null,
            type: 'custom',
            owner_id: currentUser.id,
            total_words: data.length,
            hierarchy_config: {
              level_2_label: 'ç¬¬äºŒå±¤ç´š',
              level_3_label: 'ç¬¬ä¸‰å±¤ç´š'
            }
          })
          .select()
          .single()

        if (wlError) throw wlError

        console.log('âœ… è©è¡¨å·²å‰µå»º:', wordlist.id)

        // æå–å”¯ä¸€çš„æ ‡ç­¾
        const level2Tags = [...new Set(data.map(d => d.level2).filter(t => t))]
        const level3Tags = [...new Set(data.map(d => d.level3).filter(t => t))]

        // æ’å…¥æ ‡ç­¾
        progressText.textContent = 'å‰µå»ºæ¨™ç±¤ä¸­...'
        progressFill.style.width = '40%'
        progressFill.textContent = '40%'

        const tagsToInsert = [
          ...level2Tags.map((tag, idx) => ({
            wordlist_id: wordlist.id,
            tag_level: 2,
            tag_code: tag,
            tag_display_name: tag,
            sort_order: idx
          })),
          ...level3Tags.map((tag, idx) => ({
            wordlist_id: wordlist.id,
            tag_level: 3,
            tag_code: tag,
            tag_display_name: tag,
            sort_order: idx
          }))
        ]

        if (tagsToInsert.length > 0) {
          const { error: tagError } = await supabase
            .from('wordlist_tags')
            .insert(tagsToInsert)

          if (tagError) throw tagError
          console.log(`âœ… å·²å‰µå»º ${tagsToInsert.length} å€‹æ¨™ç±¤`)
        }

        // æ’å…¥è¯æ±‡å¹¶å…³è”
        progressText.textContent = `å°å…¥è©å½™ä¸­... (0/${data.length})`
        progressFill.style.width = '50%'
        progressFill.textContent = '50%'

        let imported = 0
        const batchSize = 50

        for (let i = 0; i < data.length; i += batchSize) {
          const batch = data.slice(i, i + batchSize)
          
          // è·å–æˆ–åˆ›å»ºè¯æ±‡
          for (const item of batch) {
            // æ£€æŸ¥è¯æ±‡æ˜¯å¦å­˜åœ¨
            let { data: existingWord } = await supabase
              .from('vocabulary')
              .select('id')
              .eq('word', item.word)
              .maybeSingle()

            let vocabId
            if (existingWord) {
              vocabId = existingWord.id
            } else {
              // åˆ›å»ºæ–°è¯æ±‡
              const { data: newWord, error: vocabError } = await supabase
                .from('vocabulary')
                .insert({
                  word: item.word,
                  difficulty_level: 3  // é»˜è®¤ä¸­ç­‰éš¾åº¦
                })
                .select('id')
                .single()

              if (vocabError) throw vocabError
              vocabId = newWord.id
            }

            // å…³è”åˆ°è¯è¡¨
            const { error: mappingError } = await supabase
              .from('vocabulary_wordlist_mapping')
              .insert({
                wordlist_id: wordlist.id,
                vocabulary_id: vocabId,
                level_2_tag: item.level2 || null,
                level_3_tag: item.level3 || null
              })

            if (mappingError) throw mappingError
            imported++
          }

          const progress = 50 + Math.floor((imported / data.length) * 40)
          progressFill.style.width = `${progress}%`
          progressFill.textContent = `${progress}%`
          progressText.textContent = `å°å…¥è©å½™ä¸­... (${imported}/${data.length})`
        }

        // å®Œæˆ
        progressFill.style.width = '100%'
        progressFill.textContent = '100%'
        progressText.textContent = `âœ… æˆåŠŸå°å…¥ ${imported} å€‹è©èªï¼`

        setTimeout(() => {
          closeUploadModal()
          alert(`âœ… è©è¡¨"${name}"å·²æˆåŠŸä¸Šå‚³ï¼`)
          loadWordlistSelector()  // åˆ·æ–°åˆ—è¡¨
        }, 1500)

      } catch (error) {
        console.error('âŒ ä¸Šå‚³å¤±æ•—:', error)
        alert('ä¸Šå‚³å¤±æ•—: ' + error.message)
        progressSection.classList.remove('active')
        uploadBtn.disabled = false
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      initialize()
    })
  </script>
</body>
</html>

