<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>《紅樓夢》人物關係圖 · 互動學習</title>
  <meta name="description" content="基於 d3.js 的《紅樓夢》人物關係互動圖，幫助學生快速理解四大家族與主要角色關係。">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    /* 主題字體（僅標題使用，保持正文易讀） */
    @font-face {
      font-family: "JiA JinWen";
      src: url('/files/jiajinwen.ttf') format('truetype');
      font-display: swap;
    }

    :root {
      /* 主題色：胭脂紅、鎏金、玉色，營造古雅又現代的視覺 */
      --bg: #fdf6f3;
      --panel: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --brand: #b91c1c;      /* 胭脂紅 */
      --edge: #d7c4b0;       /* 宣紙描邊 */
      --accent: #10b981;     /* 玉色 */
      --shadow: 0 10px 28px rgba(0,0,0,.08);
      --radius: 16px;
      /* 家族色：和諧而區分明確 */
      --family-jia: #c81e1e;     /* 賈家：朱紅 */
      --family-wang: #1e3a8a;    /* 王家：帝藍/權勢 */
      --family-xue: #eab308;     /* 薛家：金黃/財富 */
      --family-shi: #7c3aed;     /* 史家：高貴紫 */
      --family-lin: #16a34a;     /* 林家：翠綠/玉色 */
      --family-others: #94a3b8;  /* 其他：青灰 */
      --family-servant: #0d9488; /* 僕役：青綠（與藍綠分開） */
      /* 關係色：偏中性、在各族色上都有對比 */
      --link-parent: #7c2d12;    /* 血親：赭棕 */
      --link-marriage: #dc2626;  /* 婚姻：赤紅 */
      --link-sibling: #2563eb;   /* 兄弟姊妹：青藍 */
      --link-cousin: #059669;    /* 表親：玉綠 */
      --link-friend: #b45309;    /* 交誼：琥珀 */
      --link-servant: #7c3aed;   /* 主僕：紫 */
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Roboto, Arial, sans-serif;
      color: var(--ink);
      /* 宣紙質感的柔和漸層背景：胭脂紅與鎏金的淡淡暈染 */
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(185,28,28,.08) 0%, transparent 60%),
        radial-gradient(1200px 800px at 110% 20%, rgba(245,158,11,.10) 0%, transparent 60%),
        radial-gradient(800px 600px at -10% 90%, rgba(16,185,129,.08) 0%, transparent 60%),
        var(--bg);
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #f1e6da;
    }
    .topbar .title {
      font-weight: 800;
      letter-spacing: .5px;
      font-family: "JiA JinWen", ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC";
      color: #7f1d1d;
    }
    .container {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      padding: 16px;
      height: calc(100% - 60px);
      box-sizing: border-box;
    }
    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      border: 1px solid #f2e8dd;
    }
    .panel h3 { margin: 0 0 6px; font-size: 16px; }
    .panel .group { border-top: 1px dashed #eee; padding-top: 10px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: #faf5ef;
      border-radius: 999px;
      font-size: 12px;
      color: #6b7280;
      border: 1px solid #efe2d3;
    }
    .legend { display: flex; flex-wrap: wrap; gap: 8px; }
    .legend .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .legend .line { width: 24px; height: 0; border-top: 3px solid var(--edge); display: inline-block; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      outline: none;
      transition: box-shadow .2s ease;
      background: #fffdfb;
    }
    .row input[type="text"]:focus { box-shadow: 0 0 0 4px rgba(124,58,237,.15); }
    button {
      border: 0; background: linear-gradient(180deg, #be123c, #991b1b); color: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .12s ease, filter .15s ease;
    }
    button.ghost { background: #e9d5ff; color: #5b21b6; }
    button.flat { background: #f1f5f9; color: #334155; }
    button:hover { filter: brightness(1.02); transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    .graph {
      position: relative;
      background: linear-gradient(180deg, #fffefd, #fff9f2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid #f3e7d7;
    }
    .graph-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
      border: 1px solid #efe2d3;
      z-index: 5;
    }
    .tooltip {
      position: absolute; pointer-events: none; background: #111827; color: #fff; font-size: 12px;
      padding: 6px 8px; border-radius: 8px; opacity: 0; transform: translate(-50%, -120%);
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,.08);
    }

    .node rect {
      rx: 12px; ry: 12px;
      transition: filter .2s ease, stroke-width .18s ease;
      transform-origin: center;
      paint-order: stroke fill;
    }
    .node text { font-size: 13px; pointer-events: none; user-select: none; }
    .node:hover rect { filter: brightness(1.05); }
    .node rect.main { stroke-width: 2.5; }
    .node .badge { font-size: 10px; fill: #334155; }
    .link { stroke: var(--edge); stroke-opacity: .85; }
    .link.marriage { stroke: var(--link-marriage); }
    .link.parent { stroke: var(--link-parent); }
    .link.sibling { stroke: var(--link-sibling); stroke-dasharray: 4 4; }
    .link.cousin { stroke: var(--link-cousin); stroke-dasharray: 6 4; }
    .link.friend { stroke: var(--link-friend); stroke-dasharray: 2 3; }
    .link.servant { stroke: var(--link-servant); }
    .link { transition: opacity .25s ease, stroke-width .25s ease; }
    .link.active { stroke-width: 3.5; }
    .link.hovered { stroke-width: 5; filter: url(#glow); }
    .hidden { opacity: .08; }
    .focus { stroke: #0ea5e9; stroke-width: 3; filter: url(#glow); animation: breath 2s ease-in-out infinite; }
    .focusSoft { stroke: #38bdf8; stroke-width: 2.5; filter: url(#glow); }

    @keyframes breath {
      0% { stroke-opacity: .9; filter: url(#glow); }
      50% { stroke-opacity: .4; }
      100% { stroke-opacity: .9; filter: url(#glow); }
    }

    .details { font-size: 14px; color: #475569; }
    .details h2 { margin: 0 0 8px; font-size: 20px; color: #0f172a; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 6px 10px; background: #f1f5f9; border-radius: 999px; font-size: 12px; }
    .game { background: #fafafa; border: 1px dashed #e5e7eb; border-radius: 12px; padding: 12px; }
    .game h4 { margin: 0 0 8px; font-size: 14px; color: #0f172a; }
    .game .clue { padding: 8px 10px; border-radius: 10px; background: #eef2ff; color: #1e293b; margin-bottom: 8px; }
    .game .status { font-size: 12px; color: #475569; }
    .game .row { margin-top: 8px; }
    .correctPulse { stroke: #10b981 !important; filter: url(#glow); animation: correct 800ms ease-in-out 1; }
    .wrongShake { animation: wrong 400ms ease-in-out 1; }
    @keyframes correct { 0% { transform: scale(1); } 50% { transform: scale(1.06); } 100% { transform: scale(1); } }
    @keyframes wrong { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

    @media (max-width: 968px) {
      .container { grid-template-columns: 1fr; height: auto; }
      .graph { height: 68vh; }
    }
    ::selection { background: rgba(185,28,28,.18); color: #111827; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">《紅樓夢》人物關係 · 交互圖譜</div>
    <span class="pill">使用方法：拖拽節點、滾輪縮放、點擊查看詳情、搜索關鍵字</span>
  </div>

  <div class="container">
    <aside class="panel" id="controls">
      <div class="row">
        <input id="search" type="text" placeholder="搜尋人物（例：寶玉 / 黛玉 / 熙鳳）">
        <button class="flat" id="clearSearch">清除</button>
      </div>

      <div class="group">
        <h3>四大家族</h3>
        <div class="legend">
          <span class="pill"><i class="dot" style="background: var(--family-jia)"></i>賈家</span>
          <span class="pill"><i class="dot" style="background: var(--family-wang)"></i>王家</span>
          <span class="pill"><i class="dot" style="background: var(--family-xue)"></i>薛家</span>
          <span class="pill"><i class="dot" style="background: var(--family-shi)"></i>史家</span>
          <span class="pill"><i class="dot" style="background: var(--family-lin)"></i>林家</span>
          <span class="pill"><i class="dot" style="background: var(--family-servant)"></i>僕役</span>
          <span class="pill"><i class="dot" style="background: var(--family-others)"></i>其他</span>
        </div>
        <div class="chips" id="familyFilters"></div>
      </div>

      <div class="group">
        <h3>關係類型</h3>
        <div class="legend">
          <span class="pill"><i class="line" style="border-color: var(--link-parent)"></i>血親（父母/子女）</span>
          <span class="pill"><i class="line" style="border-color: var(--link-marriage)"></i>婚姻</span>
          <span class="pill"><i class="line" style="border-color: var(--link-sibling)"></i>兄弟姊妹</span>
          <span class="pill"><i class="line" style="border-color: var(--link-cousin)"></i>表親/堂親</span>
          <span class="pill"><i class="line" style="border-color: var(--link-friend)"></i>知交/情誼</span>
          <span class="pill"><i class="line" style="border-color: var(--link-servant)"></i>主僕</span>
        </div>
        <div class="chips" id="relationFilters"></div>
      </div>

      <div class="group">
        <h3>視圖</h3>
        <div class="row">
          <button id="fit">重置視圖</button>
          <button id="isolateMain" class="ghost">只看主線人物</button>
        </div>
      </div>

      <div class="group details" id="details">
        <h3>人物詳情</h3>
        <div class="empty">點擊圖中任一人物查看。</div>
      </div>

      <div class="group">
        <h3>小遊戲</h3>
        <div class="game" id="gameBox">
          <h4>關係偵探</h4>
          <div class="clue" id="gameClue">點「開始出題」後，依線索在圖上點選人物。</div>
          <div class="status" id="gameStatus">題目：0｜得分：0</div>
          <div class="row">
            <button id="gameStart" class="ghost">開始出題</button>
            <button id="gameHint" class="flat">提示</button>
            <button id="gameSkip" class="flat">換一題</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="graph">
      <svg id="svg" width="100%" height="100%" viewBox="0 0 1400 900" preserveAspectRatio="xMidYMid meet"></svg>
      <div class="tooltip" id="tooltip"></div>
    </main>
  </div>

  <script>
    const families = {
      jia: { name: '賈家', color: getComputedStyle(document.documentElement).getPropertyValue('--family-jia').trim() },
      wang: { name: '王家', color: getComputedStyle(document.documentElement).getPropertyValue('--family-wang').trim() },
      xue: { name: '薛家', color: getComputedStyle(document.documentElement).getPropertyValue('--family-xue').trim() },
      shi: { name: '史家', color: getComputedStyle(document.documentElement).getPropertyValue('--family-shi').trim() },
      lin: { name: '林家', color: getComputedStyle(document.documentElement).getPropertyValue('--family-lin').trim() },
      servant: { name: '僕役', color: getComputedStyle(document.documentElement).getPropertyValue('--family-servant').trim() },
      other: { name: '其他', color: getComputedStyle(document.documentElement).getPropertyValue('--family-others').trim() },
    };

    const mainCast = new Set(['賈寶玉','林黛玉','薛寶釵','王熙鳳','賈母','王夫人','賈政','史湘雲','妙玉','探春','迎春','惜春','元春','李紈']);

    const nodes = [
      { id: '賈母', family: 'shi', alias: '史太君', brief: '榮國府最高長輩，慈嚴並重。' },
      { id: '賈政', family: 'jia', brief: '榮國府中堅，尚理學。' },
      { id: '王夫人', family: 'wang', brief: '賈寶玉之母，王家出身。' },
      { id: '賈赦', family: 'jia', brief: '賈政之兄。' },
      { id: '邢夫人', family: 'other', brief: '賈赦之妻。' },
      { id: '劉姥姥', family: 'other', brief: '樸直機敏，數進榮國府，曾解危巧姐。' },
      { id: '賈珠', family: 'jia', brief: '賈政長子，早逝。' },
      { id: '李紈', family: 'other', brief: '賈珠遺孀，守節持家。' },
      { id: '賈蘭', family: 'jia', brief: '賈珠、李紈之子。' },
      { id: '賈寶玉', family: 'jia', brief: '通靈寶玉所化，情至性靈。' },
      { id: '林黛玉', family: 'lin', brief: '林如海與賈敏之女，聰慧多感。' },
      { id: '薛寶釵', family: 'xue', brief: '薛姨媽之女，穩重雍容。' },
      { id: '薛蟠', family: 'xue', brief: '寶釵之兄。' },
      { id: '薛姨媽', family: 'wang', brief: '王夫人之妹，薛家女主人。' },
      { id: '史湘雲', family: 'shi', brief: '賈母侄孫女，性爽直。' },
      { id: '王熙鳳', family: 'wang', brief: '鳳辣子，理家能手。' },
      { id: '賈琏', family: 'jia', brief: '賈赦之子，與鳳姐主理榮府。' },
      { id: '平兒', family: 'servant', brief: '王熙鳳貼身心腹，通房大丫鬟。' },
      { id: '秦可卿', family: 'other', brief: '寧國府潤玉，與榮府往來密切。' },
      { id: '賈敬', family: 'jia', brief: '寧國府老爺，嗜道煉丹。' },
      { id: '賈珍', family: 'jia', brief: '寧國府當家，奢靡放縱。' },
      { id: '尤氏', family: 'other', brief: '賈珍之妻。' },
      { id: '賈蓉', family: 'jia', brief: '賈珍之子，娶秦可卿。' },
      { id: '尤二姐', family: 'other', brief: '尤氏之妹，後為賈琏之妾。' },
      { id: '尤三姐', family: 'other', brief: '尤氏之妹，性烈。' },
      { id: '尤老娘', family: 'other', brief: '尤氏之繼母；尤二姐、尤三姐之生母。' },
      { id: '元春', family: 'jia', brief: '賈政、王夫人長女，貴妃。' },
      { id: '迎春', family: 'jia', brief: '二小姐，性懦弱。' },
      { id: '探春', family: 'jia', brief: '三小姐，理家有方。' },
      { id: '惜春', family: 'jia', brief: '四小姐，性清冷。' },
      { id: '秦鐘', family: 'other', brief: '秦可卿之弟，與寶玉同窗相契，早逝。' },
      { id: '賈瑞', family: 'jia', brief: '賈氏旁支，迷戀王熙鳳，中邪而亡。' },
      { id: '板兒', family: 'other', brief: '劉姥姥之外孫，淳樸機靈。' },
      { id: '妙玉', family: 'other', brief: '女尼，嗜茶潔癖。' },
      { id: '晴雯', family: 'servant', brief: '機敏剛烈，金釧之妹，後被逐。' },
      { id: '襲人', family: 'servant', brief: '柔婉穩重，寶玉貼身大丫鬟。' },
      { id: '李嬤嬤', family: 'servant', brief: '榮府老人，久侍賈母。' },
      { id: '巧姐', family: 'jia', brief: '王熙鳳、賈琏之女。' },
      { id: '王子騰', family: 'wang', brief: '王家長輩，顯宦；與王夫人為兄妹。' },
      { id: '賈環', family: 'jia', brief: '賈政庶子，性情偏狹，與寶玉多有龃龉。' },
      { id: '趙姨娘', family: 'other', brief: '賈政之側室，探春與賈環之母。' },
      { id: '賈敏', family: 'jia', brief: '賈政之妹，林黛玉之母。' },
      { id: '林如海', family: 'lin', brief: '林黛玉之父，江南巡鹽御史。' },
      { id: '司棋', family: 'servant', brief: '迎春貼身丫鬟。' },
      { id: '入畫', family: 'servant', brief: '惜春貼身丫鬟。' },
      { id: '抱琴', family: 'servant', brief: '元春貼身侍女。' },
      { id: '侍書', family: 'servant', brief: '探春貼身丫鬟。' },
      { id: '賈代儒', family: 'jia', brief: '賈氏族中長輩，賈瑞之祖父。' },
      { id: '蔣玉菡', family: 'other', brief: '優伶，與賈寶玉相交。' },
      { id: '柳湘蓮', family: 'other', brief: '風流倜儻，與賈寶玉意氣相投。' },
      // 僕役新增
      { id: '鴛鴦', family: 'servant', brief: '賈母貼身首席大丫鬟。' },
      { id: '傻大姐', family: 'servant', brief: '賈府粗使丫頭，天真烏託。' },
      { id: '金釧', family: 'servant', brief: '王夫人丫鬟，後跳井自盡。' },
      { id: '玉釧', family: 'servant', brief: '王夫人丫鬟，金釧之妹。' },
      { id: '彩雲', family: 'servant', brief: '王夫人身邊丫鬟。' },
      { id: '彩霞', family: 'servant', brief: '王夫人身邊丫鬟。' },
      { id: '周瑞家的', family: 'servant', brief: '王夫人陪房，庶務管事。' },
      { id: '吳新登家的', family: 'servant', brief: '庫房總管。' },
      { id: '小紅', family: 'servant', alias: '林紅玉', brief: '王熙鳳調用之丫鬟。' },
      { id: '興兒', family: 'servant', brief: '王熙鳳所用小廝。' },
      { id: '旺兒', family: 'servant', brief: '王熙鳳心腹小廝。' },
      { id: '來旺媳婦', family: 'servant', brief: '王熙鳳身邊婆子。' },
      { id: '麝月', family: 'servant', brief: '賈寶玉貼身大丫鬟。' },
      { id: '芳官', family: 'servant', brief: '小丫鬟，戲班散後分入園中。' },
      { id: '茗煙', family: 'servant', brief: '賈寶玉書僮，最得信任。' },
      { id: '紫鵑', family: 'servant', brief: '林黛玉貼身丫鬟，原名鸚哥。' },
      { id: '雪雁', family: 'servant', brief: '林黛玉從林家帶來幼婢。' },
      { id: '鶯兒', family: 'servant', brief: '薛寶釵貼身丫鬟，擅編織。' },
    ];

    const links = [
      { source: '賈政', target: '王夫人', type: 'marriage' },
      { source: '賈赦', target: '邢夫人', type: 'marriage' },
      { source: '賈琏', target: '王熙鳳', type: 'marriage' },
      { source: '賈珠', target: '李紈', type: 'marriage' },
      { source: '賈珍', target: '尤氏', type: 'marriage' },
      { source: '賈蓉', target: '秦可卿', type: 'marriage' },
      { source: '賈琏', target: '尤二姐', type: 'marriage' },
      { source: '林如海', target: '賈敏', type: 'marriage' },
      { source: '賈政', target: '趙姨娘', type: 'marriage' },

      { source: '賈母', target: '賈政', type: 'parent' },
      { source: '賈母', target: '賈赦', type: 'parent' },
      { source: '賈母', target: '賈敏', type: 'parent' },
      { source: '賈敬', target: '賈珍', type: 'parent' },
      { source: '賈敬', target: '惜春', type: 'parent' },
      { source: '賈母', target: '史湘雲', type: 'parent' },
      { source: '賈珍', target: '賈蓉', type: 'parent' },
      { source: '尤氏', target: '賈蓉', type: 'parent' },
      { source: '賈政', target: '賈寶玉', type: 'parent' },
      { source: '王夫人', target: '賈寶玉', type: 'parent' },
      { source: '賈政', target: '元春', type: 'parent' },
      { source: '王夫人', target: '元春', type: 'parent' },
      { source: '賈赦', target: '迎春', type: 'parent' },
      { source: '賈政', target: '探春', type: 'parent' },
      { source: '賈政', target: '賈珠', type: 'parent' },
      { source: '王夫人', target: '賈珠', type: 'parent' },
      { source: '賈赦', target: '賈琏', type: 'parent' },
      { source: '尤老娘', target: '尤氏', type: 'parent' },
      { source: '尤老娘', target: '尤二姐', type: 'parent' },
      { source: '尤老娘', target: '尤三姐', type: 'parent' },
      { source: '王熙鳳', target: '巧姐', type: 'parent' },
      { source: '賈琏', target: '巧姐', type: 'parent' },
      { source: '賈珠', target: '賈蘭', type: 'parent' },
      { source: '李紈', target: '賈蘭', type: 'parent' },
      { source: '劉姥姥', target: '板兒', type: 'parent' },
      { source: '林如海', target: '林黛玉', type: 'parent' },
      { source: '賈敏', target: '林黛玉', type: 'parent' },

      { source: '賈寶玉', target: '元春', type: 'sibling' },
      { source: '賈寶玉', target: '探春', type: 'sibling' },
      { source: '賈寶玉', target: '賈珠', type: 'sibling' },
      { source: '賈珠', target: '元春', type: 'sibling' },
      { source: '賈珠', target: '探春', type: 'sibling' },
      { source: '賈寶玉', target: '迎春', type: 'cousin' },
      { source: '賈寶玉', target: '惜春', type: 'cousin' },
      { source: '秦鐘', target: '秦可卿', type: 'sibling' },
      { source: '薛姨媽', target: '王夫人', type: 'sibling' },
      { source: '賈寶玉', target: '林黛玉', type: 'cousin' },
      { source: '賈寶玉', target: '薛寶釵', type: 'cousin' },
      { source: '史湘雲', target: '賈寶玉', type: 'cousin' },
      { source: '賈琏', target: '賈珍', type: 'cousin' },
      { source: '賈政', target: '賈珍', type: 'cousin' },

      { source: '薛姨媽', target: '薛寶釵', type: 'parent' },
      { source: '薛姨媽', target: '薛蟠', type: 'parent' },
      { source: '薛蟠', target: '薛寶釵', type: 'sibling' },

      { source: '賈瑞', target: '賈珍', type: 'cousin' },
      { source: '王熙鳳', target: '王夫人', type: 'cousin' },
      { source: '賈琏', target: '賈政', type: 'cousin' },

      { source: '賈寶玉', target: '妙玉', type: 'friend' },
      { source: '賈寶玉', target: '王熙鳳', type: 'friend' },
      { source: '賈寶玉', target: '秦鐘', type: 'friend' },
      { source: '林黛玉', target: '薛寶釵', type: 'friend' },
      { source: '王熙鳳', target: '平兒', type: 'friend' },
      { source: '賈母', target: '李嬤嬤', type: 'friend' },
      { source: '秦可卿', target: '王熙鳳', type: 'friend' },
      { source: '劉姥姥', target: '賈母', type: 'friend' },
      { source: '劉姥姥', target: '王熙鳳', type: 'friend' },
      { source: '劉姥姥', target: '巧姐', type: 'friend' },
      { source: '板兒', target: '巧姐', type: 'friend' },

      // 主僕關係（新）
      { source: '賈母', target: '鴛鴦', type: 'servant' },
      { source: '賈母', target: '傻大姐', type: 'servant' },
      { source: '賈母', target: '李嬤嬤', type: 'servant' },
      { source: '王夫人', target: '金釧', type: 'servant' },
      { source: '王夫人', target: '玉釧', type: 'servant' },
      { source: '王夫人', target: '彩雲', type: 'servant' },
      { source: '王夫人', target: '彩霞', type: 'servant' },
      { source: '王夫人', target: '周瑞家的', type: 'servant' },
      { source: '王夫人', target: '吳新登家的', type: 'servant' },
      { source: '王熙鳳', target: '平兒', type: 'servant' },
      { source: '王熙鳳', target: '小紅', type: 'servant' },
      { source: '王熙鳳', target: '興兒', type: 'servant' },
      { source: '王熙鳳', target: '旺兒', type: 'servant' },
      { source: '王熙鳳', target: '來旺媳婦', type: 'servant' },
      { source: '賈寶玉', target: '襲人', type: 'servant' },
      { source: '賈寶玉', target: '晴雯', type: 'servant' },
      { source: '賈寶玉', target: '麝月', type: 'servant' },
      { source: '賈寶玉', target: '芳官', type: 'servant' },
      { source: '賈寶玉', target: '茗煙', type: 'servant' },
      { source: '林黛玉', target: '紫鵑', type: 'servant' },
      { source: '林黛玉', target: '雪雁', type: 'servant' },
      { source: '薛寶釵', target: '鶯兒', type: 'servant' },
      { source: '賈瑞', target: '賈代儒', type: 'parent' },
      { source: '趙姨娘', target: '賈環', type: 'parent' },
      { source: '趙姨娘', target: '探春', type: 'parent' },
      { source: '賈寶玉', target: '賈珠', type: 'sibling' },
      { source: '賈珠', target: '元春', type: 'sibling' },
      { source: '賈珠', target: '探春', type: 'sibling' },
      { source: '賈政', target: '賈赦', type: 'sibling' },
      { source: '賈環', target: '探春', type: 'sibling' },
      { source: '賈寶玉', target: '賈環', type: 'sibling' },
      { source: '賈赦', target: '賈敏', type: 'sibling' },
      { source: '賈政', target: '賈敏', type: 'sibling' },
      { source: '尤氏', target: '尤二姐', type: 'sibling' },
      { source: '尤氏', target: '尤三姐', type: 'sibling' },
      { source: '尤二姐', target: '尤三姐', type: 'sibling' },

      { source: '賈寶玉', target: '迎春', type: 'cousin' },
      { source: '賈寶玉', target: '惜春', type: 'cousin' },

      { source: '薛姨媽', target: '王夫人', type: 'sibling' },

      { source: '賈寶玉', target: '林黛玉', type: 'cousin' },
      { source: '賈寶玉', target: '薛寶釵', type: 'cousin' },
      { source: '史湘雲', target: '賈寶玉', type: 'cousin' },
      { source: '賈琏', target: '賈珍', type: 'cousin' },
      { source: '賈政', target: '賈珍', type: 'cousin' },

      { source: '薛姨媽', target: '薛寶釵', type: 'parent' },
      { source: '薛姨媽', target: '薛蟠', type: 'parent' },
      { source: '薛蟠', target: '薛寶釵', type: 'sibling' },

      { source: '賈琏', target: '賈政', type: 'cousin' },
      { source: '王熙鳳', target: '王夫人', type: 'cousin' },
      { source: '賈瑞', target: '賈珍', type: 'cousin' },

      { source: '賈寶玉', target: '妙玉', type: 'friend' },
      { source: '賈寶玉', target: '王熙鳳', type: 'friend' },
      { source: '賈寶玉', target: '秦鐘', type: 'friend' },
      { source: '林黛玉', target: '薛寶釵', type: 'friend' },
      { source: '林黛玉', target: '史湘雲', type: 'friend' },
      { source: '襲人', target: '鴛鴦', type: 'friend' },
      { source: '賈寶玉', target: '蔣玉菡', type: 'friend' },
      { source: '賈寶玉', target: '柳湘蓮', type: 'friend' },
      { source: '王熙鳳', target: '平兒', type: 'friend' },
      { source: '賈母', target: '李嬤嬤', type: 'friend' },
      { source: '秦可卿', target: '王熙鳳', type: 'friend' },
      { source: '劉姥姥', target: '賈母', type: 'friend' },
      { source: '劉姥姥', target: '王熙鳳', type: 'friend' },
      { source: '劉姥姥', target: '巧姐', type: 'friend' },
      { source: '板兒', target: '巧姐', type: 'friend' },

      // 主僕關係（新）
      { source: '賈母', target: '鴛鴦', type: 'servant' },
      { source: '賈母', target: '傻大姐', type: 'servant' },
      { source: '賈母', target: '李嬤嬤', type: 'servant' },
      { source: '王夫人', target: '金釧', type: 'servant' },
      { source: '王夫人', target: '玉釧', type: 'servant' },
      { source: '王夫人', target: '彩雲', type: 'servant' },
      { source: '王夫人', target: '彩霞', type: 'servant' },
      { source: '王夫人', target: '周瑞家的', type: 'servant' },
      { source: '王夫人', target: '吳新登家的', type: 'servant' },
      { source: '王熙鳳', target: '平兒', type: 'servant' },
      { source: '王熙鳳', target: '小紅', type: 'servant' },
      { source: '王熙鳳', target: '興兒', type: 'servant' },
      { source: '王熙鳳', target: '旺兒', type: 'servant' },
      { source: '王熙鳳', target: '來旺媳婦', type: 'servant' },
      { source: '賈寶玉', target: '襲人', type: 'servant' },
      { source: '賈寶玉', target: '晴雯', type: 'servant' },
      { source: '賈寶玉', target: '麝月', type: 'servant' },
      { source: '賈寶玉', target: '芳官', type: 'servant' },
      { source: '賈寶玉', target: '茗煙', type: 'servant' },
      { source: '林黛玉', target: '紫鵑', type: 'servant' },
      { source: '林黛玉', target: '雪雁', type: 'servant' },
      { source: '薛寶釵', target: '鶯兒', type: 'servant' },
      { source: '賈瑞', target: '賈代儒', type: 'parent' },
      { source: '迎春', target: '司棋', type: 'servant' },
      { source: '惜春', target: '入畫', type: 'servant' },
      { source: '元春', target: '抱琴', type: 'servant' },
      { source: '探春', target: '侍書', type: 'servant' },
    ];

    // 連線去重：以無向對（source/target排序後）與類型為鍵去重
    (function dedupeLinks(){
      const seen = new Set();
      const unique = [];
      for (const l of links) {
        const a = typeof l.source === 'string' ? l.source : l.source?.id;
        const b = typeof l.target === 'string' ? l.target : l.target?.id;
        if (!a || !b) { unique.push(l); continue; }
        const key = [a,b].sort((x,y)=>x.localeCompare(y)).join('|') + '|' + l.type;
        if (!seen.has(key)) { seen.add(key); unique.push(l); }
      }
      links.splice(0, links.length, ...unique);
    })();

    const relationTypes = ['parent','marriage','sibling','cousin','friend','servant'];

    const svg = d3.select('#svg');
    // 當前聚焦的人物ID（若有）
    let focusedNodeId = null;
    // 取得節點ID（兼容字串或物件）
    const getId = (v) => (typeof v === 'string' ? v : v?.id);
    // SVG filters for soft shadow and glow
    const defs = svg.append('defs');
    const softShadow = defs.append('filter').attr('id','softShadow').attr('x','-50%').attr('y','-50%').attr('width','200%').attr('height','200%');
    softShadow.append('feDropShadow')
      .attr('dx',0).attr('dy',2).attr('stdDeviation',2)
      .attr('flood-color','#0f172a').attr('flood-opacity',.12);
    const glow = defs.append('filter').attr('id','glow');
    glow.append('feGaussianBlur').attr('stdDeviation',3).attr('result','coloredBlur');
    const feMerge = glow.append('feMerge');
    feMerge.append('feMergeNode').attr('in','coloredBlur');
    feMerge.append('feMergeNode').attr('in','SourceGraphic');
    const g = svg.append('g');
    const linkGroup = g.append('g').attr('stroke-width', 2);
    const linkHitGroup = g.append('g');
    const nodeGroup = g.append('g');
    // 線上浮標籤（放在最上層，避免被節點遮擋）
    const linkLabelLayer = g.append('g').attr('pointer-events','none');

    const zoom = d3.zoom()
      .scaleExtent([0.25, 3])
      .on('zoom', (e) => g.attr('transform', e.transform));
    svg.call(zoom);
    // 右側視圖區空白處點擊：全域重置（清空家族/關係聚焦與人物聚焦）
    svg.on('click.reset', (event) => {
      if (event.target === svg.node()) {
        resetAllView();
      }
    });

    const colorByFamily = (f) => families[f]?.color || families.other.color;
    // 根據背景色亮度自動決定字色（深背景→白字；淺背景→深字）
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex || '');
      return m ? { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) } : { r: 0, g: 0, b: 0 };
    }
    function getLuminance(hex){
      const { r, g, b } = hexToRgb(hex);
      const [R, G, B] = [r, g, b].map(v => {
        const p = v/255;
        return p <= 0.03928 ? p/12.92 : Math.pow((p+0.055)/1.055, 2.4);
      });
      return 0.2126*R + 0.7152*G + 0.0722*B;
    }
    function textColorByFamily(f){
      const bg = colorByFamily(f);
      const L = getLuminance(bg);
      // 閾值約 0.55：金黃、淺灰走深字；藍、紅、紫、青綠走白字
      return L > 0.55 ? '#0f172a' : '#ffffff';
    }
    const sizeByImportance = (d) => mainCast.has(d.id) ? 90 : 70;

    const sim = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d => d.id)
        .distance(l => ({ parent: 90, marriage: 90, sibling: 120, cousin: 130, friend: 150, servant: 100 }[l.type] || 120))
        .strength(l => l.type === 'marriage' ? 0.8 : 0.5))
      .force('charge', d3.forceManyBody().strength(-500))
      .force('collide', d3.forceCollide().radius(d => (sizeByImportance(d) / 2) + 14))
      .force('center', d3.forceCenter(700, 450));

    const link = linkGroup
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('class', d => `link ${d.type}`)
      .attr('data-type', d => d.type);

    // 關係中文映射與具體概述
    const relationMap = { parent:'血親', marriage:'婚姻', sibling:'兄妹', cousin:'表親', friend:'知交', servant:'主僕' };
    const pairKey = (a,b) => [a,b].sort((x,y)=>x.localeCompare(y)).join('|');
    const relationSummary = new Map([
      // 婚姻
      [pairKey('賈政','王夫人'), '榮國府夫婦，賈寶玉等人的父母。'],
      [pairKey('賈赦','邢夫人'), '賈府長房夫婦，管轄寧榮兩府長房事。'],
      [pairKey('賈琏','王熙鳳'), '賈府內外事務主理的夫妻。'],
      [pairKey('賈珠','李紈'), '賈政長子與其遺孀。'],
      [pairKey('賈珍','尤氏'), '寧國府當家夫妻。'],
      [pairKey('賈蓉','秦可卿'), '寧國府賈蓉與其妻秦可卿。'],
      [pairKey('賈琏','尤二姐'), '賈琏納尤二姐為妾，鳳姐後發難。'],
      [pairKey('林如海','賈敏'), '林如海與賈政之妹賈敏為夫婦。'],
      [pairKey('賈政','趙姨娘'), '賈政之側室，按婚姻夫妻處理。'],
      // 血親
      [pairKey('賈母','賈政'), '賈政之母，史太君。'],
      [pairKey('賈母','賈赦'), '賈赦之母，史太君。'],
      [pairKey('賈母','賈敏'), '賈敏之母，史太君。'],
      [pairKey('賈敬','賈珍'), '賈珍之父。'],
      [pairKey('賈敬','惜春'), '惜春之父，寧國府。'],
      [pairKey('賈母','史湘雲'), '姑祖母與侄孫女。'],
      [pairKey('賈珍','賈蓉'), '賈珍之子。'],
      [pairKey('尤氏','賈蓉'), '賈蓉之母。'],
      [pairKey('王熙鳳','巧姐'), '巧姐之母。'],
      [pairKey('賈琏','巧姐'), '巧姐之父。'],
      [pairKey('賈珠','賈蘭'), '賈蘭之父。'],
      [pairKey('李紈','賈蘭'), '賈蘭之母。'],
      [pairKey('劉姥姥','板兒'), '外祖母與外孫。'],
      // 兄妹/手足
      [pairKey('賈寶玉','元春'), '同父母的兄妹。'],
      [pairKey('賈寶玉','探春'), '同父異母的兄妹。'],
      [pairKey('賈寶玉','賈珠'), '兄弟，賈珠為兄。'],
      [pairKey('賈珠','元春'), '同父母的兄妹。'],
      [pairKey('賈珠','探春'), '同父異母的姐弟。'],
      [pairKey('賈政','賈敏'), '親兄妹。'],
      [pairKey('賈赦','賈敏'), '親兄妹。'],
      [pairKey('賈環','探春'), '同母兄妹。'],
      [pairKey('賈寶玉','賈環'), '同父異母的兄弟。'],
      [pairKey('秦鐘','秦可卿'), '秦可卿之弟與其姊。'],
      [pairKey('薛姨媽','王夫人'), '姊妹。'],
      // 表親/族親
      [pairKey('賈寶玉','迎春'), '榮國府與長房之間的堂兄妹。'],
      [pairKey('賈寶玉','惜春'), '寧國府一支，與寶玉為族親。'],
      [pairKey('賈寶玉','林黛玉'), '姑舅表兄妹（賈敏為賈政之妹）。'],
      [pairKey('賈寶玉','薛寶釵'), '姨表兄妹（薛姨媽為王夫人之妹）。'],
      [pairKey('史湘雲','賈寶玉'), '賈母侄孫女，與寶玉為從表親。'],
      [pairKey('賈琏','賈珍'), '榮寧兩府的族兄弟。'],
      [pairKey('賈政','賈珍'), '榮寧兩府的族兄弟。'],
      [pairKey('賈琏','賈政'), '叔侄。'],
      [pairKey('王熙鳳','王夫人'), '王夫人之侄女。'],
      [pairKey('王夫人','王子騰'), '王夫人之兄。'],
      [pairKey('王熙鳳','王子騰'), '叔侄/族親，王家長輩與侄女。'],
      [pairKey('賈瑞','賈珍'), '同族晚輩，與寧府有親。'],
      // 交誼
      [pairKey('賈寶玉','妙玉'), '大觀園中相交，寶玉敬其清潔。'],
      [pairKey('賈寶玉','王熙鳳'), '嬸侄往來，鳳姐常照拂寶玉。'],
      [pairKey('賈寶玉','秦鐘'), '同窗金蘭，情誼深篤。'],
      [pairKey('林黛玉','薛寶釵'), '情同姊妹亦有競合。'],
      [pairKey('王熙鳳','平兒'), '主僕亦心腹，鳳姐倚重平兒。'],
      [pairKey('賈母','李嬤嬤'), '久侍之僕，情分深厚。'],
      [pairKey('秦可卿','王熙鳳'), '姻親往來密切，鳳姐常過寧府。'],
      [pairKey('劉姥姥','賈母'), '賈母周濟劉姥姥，一直有恩義往來。'],
      [pairKey('劉姥姥','王熙鳳'), '鳳姐機鋒周旋，後與劉姥姥合力護巧姐。'],
      [pairKey('劉姥姥','巧姐'), '劉姥姥出力救巧姐脫險。'],
      [pairKey('板兒','巧姐'), '兒時玩伴，曾同住劉姥姥家。'],
      // 主僕
      [pairKey('賈母','鴛鴦'), '賈母貼身首席大丫鬟。'],
      [pairKey('賈母','傻大姐'), '賈府粗使丫頭。'],
      [pairKey('賈母','李嬤嬤'), '久侍之僕，照看子弟。'],
      [pairKey('王夫人','金釧'), '王夫人丫鬟，後跳井自盡。'],
      [pairKey('王夫人','玉釧'), '金釧之妹，侍王夫人。'],
      [pairKey('王夫人','彩雲'), '王夫人身邊丫鬟。'],
      [pairKey('王夫人','彩霞'), '王夫人身邊丫鬟。'],
      [pairKey('王夫人','周瑞家的'), '王夫人之陪房，庶務管事。'],
      [pairKey('王夫人','吳新登家的'), '庫房總管。'],
      [pairKey('王熙鳳','平兒'), '鳳姐心腹通房大丫鬟。'],
      [pairKey('王熙鳳','小紅'), '林紅玉，後被鳳姐調用。'],
      [pairKey('王熙鳳','興兒'), '王熙鳳所用小廝。'],
      [pairKey('王熙鳳','旺兒'), '王熙鳳心腹小廝。'],
      [pairKey('王熙鳳','來旺媳婦'), '身邊婆子。'],
      [pairKey('賈寶玉','襲人'), '貼身大丫鬟，後成準姨娘。'],
      [pairKey('賈寶玉','晴雯'), '貼身大丫鬟，後被逐。'],
      [pairKey('賈寶玉','麝月'), '貼身大丫鬟。'],
      [pairKey('賈寶玉','芳官'), '小丫鬟，戲班散後分入。'],
      [pairKey('賈寶玉','茗煙'), '書僮，最得信任。'],
      [pairKey('林黛玉','紫鵑'), '貼身丫鬟，原名鸚哥。'],
      [pairKey('林黛玉','雪雁'), '從林家帶來幼婢。'],
      [pairKey('薛寶釵','鶯兒'), '貼身丫鬟，擅編織。'],
      [pairKey('賈政','賈環'), '賈環之父。'],
      [pairKey('趙姨娘','賈環'), '賈環之母。'],
      [pairKey('趙姨娘','探春'), '探春之母。'],
      [pairKey('尤老娘','尤氏'), '繼母。'],
      [pairKey('尤老娘','尤二姐'), '生母。'],
      [pairKey('尤老娘','尤三姐'), '生母。'],
    ]);
    function getRelationSummary(d){
      const k = pairKey(d.source.id, d.target.id);
      return relationSummary.get(k) || `${relationMap[d.type] || d.type}關係`;
    }

    // 為每條邊創建一個對應的標籤（初始隱藏）
    const linkLabels = linkLabelLayer.selectAll('g.rel-label')
      .data(links)
      .join('g')
      .attr('class','rel-label')
      .style('opacity',0);
    linkLabels.append('rect')
      .attr('rx',8).attr('ry',8)
      .attr('fill','#111827')
      .attr('opacity',0.85);
    linkLabels.append('text')
      .attr('fill','#fff')
      .attr('font-size',12)
      .attr('x',8).attr('y',14)
      .text(d=>getRelationSummary(d));
    // 依文字大小自適應背景
    linkLabels.each(function(){
      const t = d3.select(this).select('text').node();
      const b = t.getBBox();
      d3.select(this).select('rect').attr('width', b.width+16).attr('height', b.height+8);
    });

    const node = nodeGroup
      .selectAll('g')
      .data(nodes)
      .join('g')
      .attr('class', 'node')
      .call(d3.drag()
        .on('start', (event, d) => {
          if (!event.active) sim.alphaTarget(0.3).restart();
          d.fx = d.x; d.fy = d.y;
        })
        .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
        .on('end', (event, d) => { if (!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; })
      );

    node.append('rect')
      .attr('width', d => sizeByImportance(d))
      .attr('height', 34)
      .attr('x', d => -sizeByImportance(d)/2)
      .attr('y', -18)
      .attr('fill', d => colorByFamily(d.family))
      .attr('stroke', '#0f172a1a')
      .attr('stroke-width', 1.6)
      .attr('class', d => mainCast.has(d.id) ? 'main' : null)
      .attr('filter', 'url(#softShadow)')
      .style('opacity', 0)
      .transition().duration(500).style('opacity', 1);

    node.append('text')
      .attr('text-anchor', 'middle')
      .attr('dominant-baseline', 'central')
      .attr('fill', d => textColorByFamily(d.family))
      .text(d => d.id);
    // 移除家族文字徽標（顏色已表明家族）

    const tooltip = d3.select('#tooltip');
    node.on('mouseenter', (e, d) => {
      tooltip.style('opacity', 1).text(`${d.id} · ${d.brief || ''}`);
      // highlight connected links subtly on hover
      d3.selectAll('.link').classed('active', l => l.source.id === d.id || l.target.id === d.id);
    }).on('mousemove', (e) => {
      const box = e.currentTarget.ownerSVGElement.getBoundingClientRect();
      tooltip.style('left', `${e.clientX - box.left}px`).style('top', `${e.clientY - box.top - 8}px`);
    }).on('mouseleave', () => { tooltip.style('opacity', 0); d3.selectAll('.link').classed('active', false); });

    node.on('click', (_, d) => showDetails(d));

    sim.on('tick', () => {
      link.attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
      linkHit.attr('x1', d => d.source.x)
             .attr('y1', d => d.source.y)
             .attr('x2', d => d.target.x)
             .attr('y2', d => d.target.y);
      linkLabels.attr('transform', d => {
        const mx = (d.source.x + d.target.x)/2;
        const my = (d.source.y + d.target.y)/2;
        return `translate(${mx},${my})`;
      });
      node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    // 增加寬鬆的命中區域，以提升懸停容錯
    const linkHit = linkHitGroup.selectAll('line')
      .data(links)
      .join('line')
      .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x).attr('y2', d => d.target.y)
      .attr('stroke', 'rgba(0,0,0,0.001)')
      .attr('stroke-width', 18)
      .style('pointer-events', 'stroke');

    // 邊的懸停互動：加粗並顯示標籤（由 hit 線觸發）
    linkHit.on('mouseenter', function(e,d){
      // 若處於聚焦狀態，僅允許與聚焦人物相連的邊顯示說明
      const a = getId(d.source), b = getId(d.target);
      if (focusedNodeId && !(a===focusedNodeId || b===focusedNodeId)) return;
      link.filter(l=>l===d).classed('hovered', true);
      // 確保標籤在最上層，避免被其他元素遮擋
      linkLabelLayer.raise();
      linkLabels.filter(l=>l===d).raise().transition().duration(120).style('opacity',1);
      node.filter(n=>n.id===a || n.id===b).select('rect').classed('focusSoft', true);
    }).on('mouseleave', function(e,d){
      // 若處於聚焦狀態，僅允許與聚焦人物相連的邊顯示說明
      const a = getId(d.source), b = getId(d.target);
      if (focusedNodeId && !(a===focusedNodeId || b===focusedNodeId)) return;
      link.filter(l=>l===d).classed('hovered', false);
      linkLabels.filter(l=>l===d).transition().duration(120).style('opacity',0);
      node.select('rect').classed('focusSoft', false);
    });

    function showDetails(d) {
      // 清除任何家族/關係過濾，保證可見該人物的所有關聯
      if (activeFamilyFilter || activeRelationFilter) {
        activeFamilyFilter = null;
        activeRelationFilter = null;
        const legends = Array.from(document.querySelectorAll('#controls .legend'));
        const familyLegend = legends[0];
        const relationLegend = legends[1];
        if (familyLegend) Array.from(familyLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = '1');
        if (relationLegend) Array.from(relationLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = '1');
      }
      // 設置聚焦人物ID
      focusedNodeId = d.id;
      d3.selectAll('.node rect').classed('focus', n => n.id === d.id);
      const neighbors = new Set([d.id]);
      links.forEach(l => {
        const a = getId(l.source), b = getId(l.target);
        if (a === d.id) neighbors.add(b);
        if (b === d.id) neighbors.add(a);
      });
      d3.selectAll('.node').classed('hidden', n => !neighbors.has(n.id));
      d3.selectAll('.link')
        .classed('hidden', l => {
          const a = getId(l.source), b = getId(l.target);
          return !(a === d.id || b === d.id);
        })
        .classed('active', l => {
          const a = getId(l.source), b = getId(l.target);
          return (a === d.id || b === d.id);
        });

      // 僅允許與聚焦人物相關的 hit 線可交互，避免無關邊觸發標籤
      linkHit.style('pointer-events', l => {
        const a = getId(l.source), b = getId(l.target);
        return (a===focusedNodeId || b===focusedNodeId) ? 'stroke' : 'none';
      });

      const rels = links.filter(l => l.source.id === d.id || l.target.id === d.id);
      const info = document.getElementById('details');
      info.innerHTML = '';
      const title = document.createElement('h2');
      title.textContent = d.id + (d.alias ? `（${d.alias}）` : '');
      info.appendChild(title);
      if (d.brief) {
        const p = document.createElement('p');
        p.textContent = d.brief;
        info.appendChild(p);
      }
      const fam = document.createElement('div');
      fam.className = 'chips';
      fam.innerHTML = `<span class="chip">家族：${families[d.family]?.name || '—'}</span>`;
      info.appendChild(fam);
      const list = document.createElement('div');
      list.innerHTML = '<h3>關聯人物</h3>';
      const ul = document.createElement('ul');
      ul.style.paddingLeft = '18px';
      ul.style.margin = '6px 0 0';
      const seenRelItems = new Set();
      rels.forEach(r => {
        const other = r.source.id === d.id ? r.target.id : r.source.id;
        const key = `${other}|${r.type}`;
        if (seenRelItems.has(key)) return;
        seenRelItems.add(key);
        const li = document.createElement('li');
        const map = { parent: '血親', marriage: '婚姻', sibling: '手足', cousin: '表親', friend: '知交', servant: '主僕' };
        li.textContent = `${other}（${map[r.type]}）`;
        ul.appendChild(li);
      });
      list.appendChild(ul);
      info.appendChild(list);
    }

    function resetFocus() {
      // 清除聚焦人物ID，恢復所有邊可交互
      focusedNodeId = null;
      d3.selectAll('.node, .link').classed('hidden', false);
      d3.selectAll('.link').classed('active', false);
      d3.selectAll('.node rect').classed('focus', false);
      linkHit.style('pointer-events', 'stroke');
    }

    function fitView() {
      resetFocus();
      svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(0,0).scale(1));
    }

    // 全域重置：清除家族/關係聚焦與人物聚焦，並復位視圖
    function resetAllView(){
      activeFamilyFilter = null;
      activeRelationFilter = null;
      // 還原圖例透明度
      const legends = Array.from(document.querySelectorAll('#controls .legend'));
      const familyLegend = legends[0];
      const relationLegend = legends[1];
      if (familyLegend) Array.from(familyLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = '1');
      if (relationLegend) Array.from(relationLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = '1');
      // 恢復顯示與互動
      resetFocus();
      d3.selectAll('.node, .link').classed('hidden', false);
      linkHit.style('pointer-events', 'stroke');
      // 復位視圖
      svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(0,0).scale(1));
    }

    document.getElementById('fit').addEventListener('click', fitView);
    document.getElementById('isolateMain').addEventListener('click', () => {
      resetFocus();
      const keep = new Set([...mainCast]);
      d3.selectAll('.node').classed('hidden', d => !keep.has(d.id));
      d3.selectAll('.link').classed('hidden', l => !(keep.has(l.source.id) && keep.has(l.target.id)));
    });
    // 左側面板空白/非互動區點擊：全域重置
    const controlsEl = document.getElementById('controls');
    controlsEl.addEventListener('click', (e) => {
      const isInteractive = e.target.closest('button, input, .pill, .legend, .row');
      if (!isInteractive) resetAllView();
    });

    // 單選過濾狀態
    let activeFamilyFilter = null; // 'jia' | 'wang' | ... | null
    let activeRelationFilter = null; // 'parent' | 'marriage' | 'sibling' | 'cousin' | 'friend' | null

    function applyFilters() {
      // 基於家族過濾的初始可見集合
      const baseIds = new Set(
        activeFamilyFilter ? nodes.filter(n => n.family === activeFamilyFilter).map(n => n.id) : nodes.map(n => n.id)
      );
      // 若選擇了關係類型，則僅保留該類型邊涉及的節點（同時滿足家族過濾）
      let visibleNodeIds;
      if (activeRelationFilter) {
        const edgeNodes = new Set();
        links.forEach(l => {
          if (l.type !== activeRelationFilter) return;
          const a = getId(l.source), b = getId(l.target);
          if (!baseIds.has(a) || !baseIds.has(b)) return;
          edgeNodes.add(a);
          edgeNodes.add(b);
        });
        visibleNodeIds = edgeNodes;
      } else {
        visibleNodeIds = baseIds;
      }
      // 邊可見條件
      const edgeVisible = (l) => {
        const a = getId(l.source), b = getId(l.target);
        return visibleNodeIds.has(a) && visibleNodeIds.has(b) && (!activeRelationFilter || l.type === activeRelationFilter);
      };
      // 應用節點與邊顯示
      d3.selectAll('.node').classed('hidden', d => !visibleNodeIds.has(d.id));
      d3.selectAll('.link')
        .classed('hidden', l => !edgeVisible(l))
        .classed('active', l => edgeVisible(l) && !!activeRelationFilter);
      // 命中層交互
      linkHit
        .classed('hidden', l => !edgeVisible(l))
        .style('pointer-events', l => edgeVisible(l) ? 'stroke' : 'none');
    }

    // 使家族圖例成為可點擊的單選按鈕
    const legends = Array.from(document.querySelectorAll('#controls .legend'));
    const familyLegend = legends[0];
    const relationLegend = legends[1];
    if (familyLegend) {
      const familyNameToKey = Object.fromEntries(Object.entries(families).map(([k, v]) => [v.name, k]));
      Array.from(familyLegend.querySelectorAll('.pill')).forEach(pill => {
        pill.style.cursor = 'pointer';
        pill.addEventListener('click', () => {
          resetFocus();
          const name = pill.textContent.trim();
          const key = familyNameToKey[name];
          if (!key) return;
          if (activeFamilyFilter === key) {
            activeFamilyFilter = null;
            // 還原所有家族圖例的透明度
            Array.from(familyLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = '1');
          } else {
            activeFamilyFilter = key;
            Array.from(familyLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = (el === pill) ? '1' : '.35');
          }
          applyFilters();
        });
      });
    }

    // 使關係類型圖例成為可點擊的單選突出顯示
    if (relationLegend) {
      const detectType = (labelText) => {
        if (labelText.includes('血親')) return 'parent';
        if (labelText.includes('婚姻')) return 'marriage';
        if (labelText.includes('兄') || labelText.includes('姊妹')) return 'sibling';
        if (labelText.includes('表親') || labelText.includes('堂親')) return 'cousin';
        if (labelText.includes('知交') || labelText.includes('情誼')) return 'friend';
        if (labelText.includes('主僕')) return 'servant';
        return null;
      };
      Array.from(relationLegend.querySelectorAll('.pill')).forEach(pill => {
        pill.style.cursor = 'pointer';
        pill.addEventListener('click', () => {
          resetFocus();
          const t = detectType(pill.textContent.trim());
          if (!t) return;
          if (activeRelationFilter === t) {
            activeRelationFilter = null;
            Array.from(relationLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = '1');
          } else {
            activeRelationFilter = t;
            Array.from(relationLegend.querySelectorAll('.pill')).forEach(el => el.style.opacity = (el === pill) ? '1' : '.35');
          }
          applyFilters();
        });
      });
    }

    // 將「重置視圖/只看主線人物」移動到右側視圖區浮層
    (function mountGraphControls(){
      const graphEl = document.querySelector('.graph');
      if (!graphEl) return;
      let box = graphEl.querySelector('.graph-controls');
      if (!box) {
        box = document.createElement('div');
        box.className = 'graph-controls';
        graphEl.appendChild(box);
      }
      const fitBtn = document.getElementById('fit');
      const isoBtn = document.getElementById('isolateMain');
      if (fitBtn) box.appendChild(fitBtn);
      if (isoBtn) box.appendChild(isoBtn);
      // 隱藏左側殘留的「視圖」欄位
      const viewGroup = Array.from(controlsEl.querySelectorAll('.group')).find(g => g.querySelector('h3')?.textContent?.trim() === '視圖');
      if (viewGroup) viewGroup.style.display = 'none';
    })();

    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearSearch');
    function doSearch() {
      const q = searchInput.value.trim();
      if (!q) { resetFocus(); return; }
      const matched = nodes.filter(n => n.id.includes(q));
      if (matched.length === 0) return;
      const first = matched[0];
      showDetails(first);
      const t = d3.zoomIdentity.translate(700 - (first.x || 0), 420 - (first.y || 0)).scale(1.2);
      svg.transition().duration(400).call(zoom.transform, t);
    }
    searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
    clearBtn.addEventListener('click', () => { searchInput.value = ''; resetFocus(); });

    window.addEventListener('resize', () => setTimeout(() => svg.dispatch('resize'), 50));
    // ----------------------
    // 關係偵探 · 小遊戲
    // ----------------------
    const game = {
      total: 0,
      score: 0,
      current: null,
      listening: false,
    };

    const gameClue = document.getElementById('gameClue');
    const gameStatus = document.getElementById('gameStatus');
    const btnStart = document.getElementById('gameStart');
    const btnHint = document.getElementById('gameHint');
    const btnSkip = document.getElementById('gameSkip');

    function pickRelationWord(type){
      const m = { parent:'父母/子女', sibling:'兄妹/手足', marriage:'配偶', cousin:'表親', friend:'好友', servant:'主僕'};
      return m[type] || type;
    }

    function neighborsByType(id, type){
      const set = new Set();
      links.forEach(l=>{
        if (l.type!==type) return;
        if (l.source.id===id) set.add(l.target.id);
        if (l.target.id===id) set.add(l.source.id);
      });
      return [...set];
    }

    function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function nextQuestion(){
      resetFocus();
      // 首題：賈瑞對王熙鳳起色心，最終被設計害死（情節題）
      if (!game._askedJiarui) {
        const src = nodes.find(n => n.id === '王熙鳳');
        const target = nodes.find(n => n.id === '賈瑞');
        if (src && target) {
          game.current = { src, type: 'custom', answers: new Set([target.id]) };
          game.total += 1; gameStatus.textContent = `題目：${game.total}｜得分：${game.score}`;
          gameClue.textContent = '誰是對「王熙鳳」起色心，最終被其設計害死的人？';
          showDetails(src);
          game.listening = true;
          game._askedJiarui = true;
          return;
        }
        game._askedJiarui = true; // 安全處理：若節點缺失則跳過
      }
      // 抽一個有人際關係較多的人作為出題源
      const candidates = nodes.filter(n=>{
        const deg = links.filter(l=> l.source.id===n.id || l.target.id===n.id).length;
        return deg>=2; });
      const src = randomPick(candidates);
      // 隨機選一種關係，優先保證有答案；"parent" 類型使用有方向的提示
      const types = ['parent','sibling','marriage','cousin','friend','servant'];
      let type = null; let targets = []; let clue = '';
      for (let i=0;i<12;i++){
        type = randomPick(types);
        if (type==='parent'){
          const children = links.filter(l=>l.type==='parent' && l.source.id===src.id).map(l=>l.target.id);
          const parents = links.filter(l=>l.type==='parent' && l.target.id===src.id).map(l=>l.source.id);
          if (children.length>0 && parents.length>0){
            if (Math.random()<0.5){ targets = children; clue = `誰是「${src.id}」的子女？`; }
            else { targets = parents; clue = `誰是「${src.id}」的父或母？`; }
          } else if (children.length>0){ targets = children; clue = `誰是「${src.id}」的子女？`; }
          else if (parents.length>0){ targets = parents; clue = `誰是「${src.id}」的父或母？`; }
          else { continue; }
        } else {
          targets = neighborsByType(src.id, type);
          if (targets.length===0) continue;
          const map = { sibling: '兄妹/手足', marriage: '配偶', cousin: '表親', friend: '好友', servant: '主僕' };
          const word = map[type] || pickRelationWord(type);
          clue = `與「${src.id}」為${word}的是誰？`;
        }
        break;
      }
      if (!type || targets.length===0){ nextQuestion(); return; }
      game.current = { src, type, answers: new Set(targets) };
      game.total += 1; gameStatus.textContent = `題目：${game.total}｜得分：${game.score}`;
      gameClue.textContent = clue;
      // 聚焦出題源
      showDetails(src);
      game.listening = true;
    }

    function markNode(id, cls, duration=700){
      node.filter(d=>d.id===id).select('rect').classed(cls, true);
      setTimeout(()=> node.filter(d=>d.id===id).select('rect').classed(cls, false), duration);
    }

    // 監聽答題：點圖中任意人物（不覆蓋原本點擊詳情邏輯）
    node.on('click.game', (_, d) => {
      if (!game.listening || !game.current) { showDetails(d); return; }
      const { answers, src } = game.current;
      if (answers.has(d.id)){
        game.score += 1;
        game.listening = false;
        markNode(d.id, 'correctPulse');
        gameStatus.textContent = `題目：${game.total}｜得分：${game.score}`;
        setTimeout(nextQuestion, 600);
      } else {
        // 錯誤反饋
        markNode(d.id, 'wrongShake');
        // 額外提示：高亮出題人節點
        node.filter(n=>n.id===src.id).select('rect').classed('focus', true);
        setTimeout(()=> node.filter(n=>n.id===src.id).select('rect').classed('focus', false), 600);
      }
    });

    btnStart?.addEventListener('click', () => { nextQuestion(); });
    btnSkip?.addEventListener('click', () => { if (game.listening) nextQuestion(); });
    btnHint?.addEventListener('click', () => {
      if (!game.current) return;
      const { answers } = game.current;
      // 高亮其中一個正確答案位置作為提示
      const one = randomPick([...answers]);
      node.filter(d=>d.id===one).select('rect').classed('focus', true);
      setTimeout(()=> node.filter(d=>d.id===one).select('rect').classed('focus', false), 1000);
    });
  </script>
</body>
</html>


