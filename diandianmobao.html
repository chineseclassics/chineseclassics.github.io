<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>點點墨寶</title>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5.0/dist/hanzi-writer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 小學生活潑友善配色方案 */
            --primary: #FF6B9D;          /* 活潑粉紅色 */
            --secondary: #4DABF7;        /* 清新藍色 */
            --accent: #FFE66D;           /* 陽光黃色 */
            --background: #FFFDF7;       /* 溫暖乳白色 */
            --success: #51CF66;          /* 成功綠色 */
            --danger: #FF6B6B;           /* 友善紅色 */
            --warning: #FFB366;          /* 溫暖橙色 */
            --text: #2D3436;             /* 深灰色文字 */
            --light-text: #636E72;       /* 淡灰色 */
            --border-radius: 16px;       /* 更圓潤的邊角 */
            --ink-color: #2D3436;        /* 深灰色墨水 */
            --highlight-color: #FF7675;  /* 高亮粉色 */
            --border-color: #E3E8F0;     /* 柔和邊框色 */
            --panel-bg: #FFFFFF;         /* 純白面板背景 */
            
            /* 小學生友好的補充顏色 */
            --purple: #A29BFE;           /* 可愛紫色 */
            --mint: #81ECEC;             /* 薄荷綠色 */
            --coral: #FF7675;            /* 珊瑚色 */
            --lavender: #DDD6FE;         /* 薰衣草色 */
            --peach: #FDCB6E;            /* 桃子色 */
            --sky: #74B9FF;              /* 天空藍 */
            --lime: #00B894;             /* 青檸色 */
            --rose: #FD79A8;             /* 玫瑰色 */
            
            /* 活潑漸變色變量 */
            --ink-gradient: linear-gradient(135deg, #FF6B9D 0%, #4DABF7 100%);
            --paper-gradient: linear-gradient(135deg, #FFFDF7 0%, #FFF0F6 100%);
            --accent-gradient: linear-gradient(135deg, #FFE66D 0%, #FFB366 100%);
            --success-gradient: linear-gradient(135deg, #51CF66 0%, #81ECEC 100%);
            --info-gradient: linear-gradient(135deg, #74B9FF 0%, #A29BFE 100%);
            --rainbow-gradient: linear-gradient(135deg, #FF6B9D 0%, #4DABF7 25%, #FFE66D 50%, #51CF66 75%, #A29BFE 100%);
        }
        
        body {
            font-family: 'Noto Serif TC', 'Source Han Serif', 'Georgia', serif;
            background: var(--background);  /* 使用純色背景 */
            margin: 0;
            padding: 10px;
            color: var(--text);
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* 優化字體渲染 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: "kern" 1, "liga" 1;
        }
        
        /* 新增微交互效果 */
        .interactive-element {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .interactive-element:hover {
            filter: brightness(1.05);
        }
        
        .interactive-element:active {
            transform: scale(0.98);
            filter: brightness(0.95);
        }
        
        /* 焦點狀態優化 - 小學生友善 */
        .btn:focus,
        .nav-button:focus,
        input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.4);
            transform: scale(1.02);
        }
        
        /* 加載狀態優化 */
        .loading-state {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }
        
        .loading-state::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255, 107, 157, 0.3);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* 成功狀態反饋 - 簡化版本 */
        .success-feedback {
            animation: sparkle 0.6s ease-out;
        }
        
        /* 錯誤狀態反饋 - 溫和晃動 */
        .error-feedback {
            animation: gentle-shake 0.5s ease-in-out;
        }
        
        /* 小學生專屬動畫 */
        @keyframes sparkle {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.3) saturate(1.5); transform: scale(1.05); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        @keyframes gentle-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }
        

        

        
        /* 整體布局優化 - 縮減整體寬度 */
        .app-container {
            max-width: 900px;  /* 從1200px縮減到900px */
            margin: 0 auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        /* 全局文本寬度控制 */
        * {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* 主面板寬度統一控制 */
        .main-panel {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        /* 頂部導航設計 */
        header {
            text-align: center;
            padding: 15px 15px;
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            color: var(--text);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        /* 主導航設計 - 縮減寬度 */
        .main-nav {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            padding: 5px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .nav-container {
            display: flex;
            justify-content: center;  /* 改為center，配合gap使用 */
            gap: 8px;  /* 添加按鈕之間的間距 */
            max-width: 480px;  /* 從600px縮減到480px */
            margin: 0 auto;
            padding: 0 8px;  /* 添加左右內邊距 */
        }
        
        .nav-button {
            flex: 1;
            max-width: 110px;  /* 限制最大寬度，防止按鈕過寬 */
            padding: 14px 8px;  /* 減少左右內邊距 */
            border: none;
            background: transparent;
            color: var(--light-text);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-family: 'Noto Serif TC', serif;
            position: relative;
            overflow: hidden;
            /* 增強觸覺反饋 */
            -webkit-tap-highlight-color: transparent;
            /* 防止按鈕變形 */
            min-width: 0;
            box-sizing: border-box;
        }
        
        .nav-button::before {
            content: '';
            position: absolute;
            top: 2px;  /* 留出邊距 */
            left: 2px;  /* 留出邊距 */
            right: 2px;  /* 留出邊距 */
            bottom: 2px;  /* 留出邊距 */
            background: #FFE66D;  /* 統一使用黃色 */
            opacity: 0;
            transition: opacity 0.35s ease;
            z-index: -1;
            border-radius: calc(var(--border-radius) - 2px);  /* 調整圓角 */
        }
        
        .nav-button svg {
            margin-bottom: 3px;
            transition: all 0.3s ease;
        }
        
        .nav-button.active {
            color: #8B6914;  /* 深色文字確保在黃色背景上清晰 */
            font-weight: 700;
            text-shadow: none;  /* 移除文字陰影 */
        }
        
        .nav-button.active::before {
            opacity: 1;
        }
        
        .nav-button.active svg {
            transform: scale(1.1);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }
        
        .nav-button:not(.active):hover {
            background-color: rgba(139, 69, 19, 0.08);
            color: var(--ink-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);  /* 添加陰影效果 */
        }
        
        .nav-button:not(.active):hover svg {
            transform: scale(1.05);
        }
        
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: 2px;  /* 調整位置 */
            left: 20%;  /* 調整位置 */
            width: 60%;  /* 調整寬度 */
            height: 3px;  /* 稍微減少高度 */
            background: #E6B800;  /* 使用純色代替漸變 */
            border-radius: 3px 3px 0 0;  /* 調整圓角 */
            box-shadow: 0 -2px 6px rgba(230, 184, 0, 0.3);
        }
        

        

        

        

        
        .content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            color: var(--ink-color);
            font-weight: bold;
            letter-spacing: 2px;
            font-family: 'Noto Serif TC', serif;
            line-height: 1.2;
        }
        
        .tagline {
            font-size: 1em;
            margin-top: 5px;
            color: var(--secondary);
            font-weight: normal;
            font-family: 'Noto Serif TC', serif;
        }
        
        /* 主要內容區採用兩欄布局 */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
        }
        
        /* 主面板 - 功能展示區域，縮減寬度 */
        .main-panel {
            flex: 2.5;  /* 從flex: 3 調整為 2.5 */
            min-width: 280px;  /* 從320px縮減到280px */
            max-width: 600px;  /* 從800px縮減到600px */
            width: 100%;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        /* 側邊面板區域 - 調整寬度保持平衡 */
        .side-panel-container {
            flex: 1.5;  /* 從flex: 1 調整為 1.5 */
            min-width: 200px;  /* 從220px縮減到200px */
            max-width: 280px;  /* 從300px縮減到280px */
            display: flex;
            flex-direction: column;
        }
        
        /* 今日漢字樣式 */
        .daily-character-display {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .daily-character {
            font-size: 100px;  /* 從120px縮減到100px */
            line-height: 1.2;
            margin-bottom: 15px;
            font-family: 'Noto Serif TC', serif;
            color: var(--ink-color);
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-height: 120px;  /* 從140px縮減到120px */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .daily-character:hover {
            transform: scale(1.05);
            text-shadow: 2px 2px 8px rgba(142, 62, 26, 0.2);
        }
        
        .daily-character-hint {
            font-size: 14px;
            color: var(--light-text);
            text-align: center;
            line-height: 1.5;
            margin-top: 8px;
            font-style: italic;
        }
        
        .panel {
            background: var(--panel-bg);  /* 使用純色背景 */
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);  /* 簡化陰影 */
            position: relative;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;  /* 簡化過渡 */
        }
        
        .panel:hover {
            transform: translateY(-1px);  /* 減少移動距離 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);  /* 簡化陰影 */
        }
        
        .panel-compact {
            padding: 12px;
        }
        
        .panel h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: var(--ink-color);
            position: relative;
            padding-left: 15px;
            font-family: 'Noto Serif TC', serif;
        }
        
        .panel h2::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 80%;
            background-color: var(--highlight-color);
            border-radius: 2px;
        }
        
        /* 更古典的輸入區域 */
        .character-search {
            display: flex;
            margin-bottom: 15px;
            padding: 3px;
            background-color: rgba(255, 255, 255, 0.4);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        
        .character-input {
            flex-grow: 1;
            padding: 8px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            color: var(--text);
            font-family: 'Noto Serif TC', serif;
        }
        
        .character-input:focus {
            outline: none;
            border-color: var(--highlight-color);
            box-shadow: 0 0 0 2px rgba(142, 62, 26, 0.2);
        }
        
        .search-button {
            background-color: var(--accent);
            color: white;
            font-size: 16px;
            padding: 8px 15px;
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-family: 'Noto Serif TC', serif;
        }
        
        .search-button:hover {
            background-color: #3A3F60;
        }
        
        .search-button svg {
            margin-right: 6px;
        }
        
        .error-message {
            color: var(--danger);
            text-align: center;
            margin: 5px 0;
            display: none;
            font-weight: bold;
            font-size: 14px;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .loader-container {
            position: relative;
            height: 30px;
            width: 100%;
            margin: 5px 0;
        }
        
        .loader {
            border: 3px solid rgba(35, 45, 82, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -12px;
            margin-left: -12px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .loader.active {
            opacity: 1;
            visibility: visible;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 優化漢字展示區 */
        .character-display-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            padding-top: 10px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;  
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        

        
        .character-board {
            position: relative;
            width: 220px;  /* 從250px縮減到220px */
            height: 220px;  /* 從250px縮減到220px */
            margin: 0 auto 10px;
            background-color: #F9F5EC;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .grid-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            border: 1px solid #E8DFD0;
        }
        
        .grid-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(to right, 
                    transparent calc(50% - 1px), 
                    rgba(142, 62, 26, 0.15) calc(50% - 1px), 
                    rgba(142, 62, 26, 0.15) calc(50% + 1px), 
                    transparent calc(50% + 1px)
                ),
                linear-gradient(to bottom, 
                    transparent calc(50% - 1px), 
                    rgba(142, 62, 26, 0.15) calc(50% - 1px), 
                    rgba(142, 62, 26, 0.15) calc(50% + 1px), 
                    transparent calc(50% + 1px)
                );
        }
        
        .character-target {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        .character-info {
            text-align: center;
            margin: 10px 0 15px 0;
        }
        
        .character-label {
            font-size: 48px;
            font-weight: bold;
            color: var(--ink-color);
            margin-right: 5px;
            display: inline-block;
            font-family: 'Noto Serif TC', serif;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .pinyin {
            font-size: 24px;
            color: var(--secondary);
            display: block;
            margin-top: 5px;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 600;
        }
        
        .stroke-count {
            font-size: 14px;
            color: var(--light-text);
            margin-top: 3px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        

        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 18px;
            font-size: 14px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
            white-space: nowrap;
            font-family: 'Noto Serif TC', serif;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            /* 觸覺反饋優化 */
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        /* 按鈕漣漪效果 */
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: 1;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn svg {
            margin-right: 6px;
            width: 16px;
            height: 16px;
            transition: transform 0.25s ease;
            z-index: 2;
            position: relative;
        }
        
        .btn:hover svg {
            transform: scale(1.1);
        }
        
        /* 統一按鈕配色 - 活潑但不花哨 */
        .btn-primary {
            background: #FF6B9D;  /* 粉紅色 - 主要操作 */
            color: white;
            border: 1px solid transparent;
        }
        
        .btn-primary:hover {
            background: #E85A87;  /* 深一點的粉紅色 */
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3), 0 3px 8px rgba(255, 107, 157, 0.2);
        }
        
        .btn-secondary {
            background: #4DABF7;  /* 藍色 - 次要操作 */
            color: white;
            border: 1px solid transparent;
        }
        
        .btn-secondary:hover {
            background: #3490DC;  /* 深一點的藍色 */
            box-shadow: 0 8px 25px rgba(77, 171, 247, 0.3), 0 3px 8px rgba(77, 171, 247, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background: rgba(255, 230, 109, 0.15);  /* 淺黃色背景 */
            color: #E6B800;  /* 深黃色文字 */
            border: 2px solid #FFE66D;  /* 黃色邊框 */
            font-weight: 600;
        }
        
        .btn-outline:hover {
            background: #FFE66D;  /* 黃色背景 */
            border-color: #E6B800;
            color: #8B6914;  /* 深色文字確保對比度 */
            box-shadow: 0 8px 20px rgba(255, 230, 109, 0.4);
        }
        
        .btn-solid-light {
            background: #F8F9FA;  /* 淺灰色背景 */
            color: #6C757D;  /* 中灰色文字 */
            border: 1px solid #DEE2E6;  /* 淺邊框 */
            font-weight: 600;
        }
        
        .btn-solid-light:hover {
            background: #E9ECEF;  /* 稍深的淺灰色 */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            color: #495057;  /* 深一點的文字顏色 */
        }
        

        
        /* 選項卡式界面 */
        .tab-container {
            margin-top: 5px;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 12px;
        }
        
        .tab-button {
            padding: 8px 15px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: bold;
            color: var(--light-text);
            font-size: 14px;
            transition: all 0.3s;
            font-family: 'Noto Serif TC', serif;
        }
        
        .tab-button.active {
            color: #B8860B;
            border-bottom-color: #B8860B;
            background: rgba(255, 230, 109, 0.15);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* 游戏模式部分 */
        .game-modes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .game-card {
            flex: 1 1 calc(50% - 10px);
            min-width: 130px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--highlight-color);
        }
        
        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #FFE66D;  /* 統一使用黃色裝飾條 */
            opacity: 0.8;
        }
        
        .game-card-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--ink-color);
            font-family: 'Noto Serif TC', serif;
        }
        
        .game-card-description {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 8px;
            line-height: 1.4;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 6px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .badge-primary {
            background-color: rgba(255, 230, 109, 0.2);
            color: #B8860B;
            border: 1px solid rgba(184, 134, 11, 0.3);
        }
        
        .badge-warning {
            background-color: rgba(183, 148, 63, 0.1);
            color: var(--warning);
        }
        
        /* 字詞本樣式 */
        .vocabulary-book-content {
            margin-top: 15px;
        }
        
        .vocabulary-count {
            font-size: 12px;
            color: var(--light-text);
            margin-left: 5px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .vocabulary-list {
            max-height: 280px;
            overflow-y: auto;
        }
        
        .vocabulary-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #FFFDF7 0%, #FFF8E1 100%);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .vocabulary-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(255, 107, 157, 0.2);
            border-color: var(--primary);
        }
        
        .vocabulary-item-number {
            font-size: 12px;
            color: var(--secondary);
            font-weight: bold;
            margin-right: 10px;
            min-width: 20px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .vocabulary-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .vocabulary-item-text {
            display: flex;
            align-items: flex-end;
            margin-top: 2px;
        }
        
        .vocabulary-character-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 4px;
        }
        
        .vocabulary-character-container:last-child {
            margin-right: 0;
        }
        
        .vocabulary-character-pinyin {
            font-size: 9px;
            color: var(--secondary);
            font-family: 'Noto Sans TC', sans-serif;
            margin-bottom: 1px;
            text-align: center;
            font-weight: 500;
            height: 12px;
            line-height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
        }
        
        .vocabulary-character-box {
            position: relative;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FFFDF7 0%, #FFF8E1 100%);
            border: 1px solid rgba(255, 107, 157, 0.3);
            border-radius: 4px;
        }
        
        /* 田字格背景 */
        .vocabulary-character-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(to right, rgba(255, 107, 157, 0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 107, 157, 0.3) 1px, transparent 1px);
            background-size: 50% 50%;
            background-position: 0 0;
        }
        
        .vocabulary-character {
            font-size: 16px;
            font-weight: bold;
            color: var(--ink-color);
            font-family: 'Noto Serif TC', serif;
            z-index: 2;
            position: relative;
        }
        

        
        .vocabulary-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3;
            transition: all 0.2s ease;
        }
        
        .vocabulary-item:hover .vocabulary-remove {
            display: flex;
        }
        
        .vocabulary-remove:hover {
            background: #E74C3C;
            transform: scale(1.1);
        }
        
        .vocabulary-more {
            margin-top: 10px;
            text-align: center;
        }
        
        .btn-more {
            width: 100%;
            font-size: 12px;
            padding: 8px 12px;
        }
        
        .empty-vocabulary {
            text-align: center;
            padding: 20px;
            color: var(--light-text);
        }
        
        .empty-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .empty-text {
            font-size: 14px;
            margin-bottom: 4px;
            font-family: 'Noto Serif TC', serif;
        }
        
        .empty-hint {
            font-size: 12px;
            opacity: 0.7;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        /* 模態窗口樣式 */
        .vocabulary-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .vocabulary-modal-content {
            background: var(--background);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .vocabulary-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .vocabulary-modal-header h3 {
            margin: 0;
            color: var(--ink-color);
            font-family: 'Noto Serif TC', serif;
        }
        
        .vocabulary-modal-count {
            font-size: 14px;
            color: var(--light-text);
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .vocabulary-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--light-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .vocabulary-modal-close:hover {
            background: var(--danger);
            color: white;
        }
        
        .vocabulary-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .vocabulary-modal-list {
            display: grid;
            gap: 8px;
        }
        
        /* 收藏按鈕樣式 */
        .btn-favorite {
            background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%);
            color: white;
            border: none;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-favorite:hover {
            background: linear-gradient(135deg, #FF1493 0%, #DC143C 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 20, 147, 0.4);
        }
        
        .btn-favorite.favorited {
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
            animation: heartbeat 0.6s ease-in-out;
        }
        
        .btn-favorite.favorited:hover {
            background: linear-gradient(135deg, #228B22 0%, #006400 100%);
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        

        
        /* 笔顺挑战模式 */
        .quiz-container {
            display: none;
            text-align: center;
            padding: 12px;
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        .quiz-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent);
            font-family: 'Noto Serif TC', serif;
        }
        
        .quiz-instruction {
            color: var(--light-text);
            margin-bottom: 10px;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .quiz-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50px;
            padding: 3px;
            border: 1px solid var(--border-color);
        }
        
        .quiz-progress-level {
            flex: 1;
            padding: 5px;
            font-size: 12px;
            border-radius: 50px;
            text-align: center;
            transition: all 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .quiz-progress-level.active {
            background-color: var(--accent);
            color: white;
            font-weight: bold;
        }
        
        .quiz-target {
            width: 220px;  /* 與HanziWriter尺寸一致 */
            height: 220px;  /* 與HanziWriter尺寸一致 */
            margin: 0 auto 25px;  /* 增加底部間距從10px到25px */
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            background-color: #F9F5EC;
        }
        
        .quiz-result {
            display: none;
            padding: 12px;
            border-radius: var(--border-radius);
            margin-top: 15px;  /* 增加頂部間距從10px到15px */
            text-align: center;
            animation: fadeIn 0.5s ease;
            font-size: 14px;
            border: 1px solid var(--border-color);
        }
        
        .quiz-result.success {
            background-color: rgba(58, 115, 85, 0.1);
            color: var(--success);
        }
        
        .quiz-result.error {
            background-color: rgba(180, 61, 61, 0.1);
            color: var(--danger);
        }
        
        .quiz-result-message {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: 'Noto Serif TC', serif;
        }
        
        .quiz-result-detail {
            font-size: 13px;
            opacity: 0.8;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .quiz-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;  /* 增加頂部間距從10px到20px */
            flex-wrap: wrap;
        }
        
        /* 記憶遊戲 */
        .memory-game-container {
            display: none;
            text-align: center;
            padding: 12px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        .memory-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--warning);
            font-family: 'Noto Serif TC', serif;
        }
        
        .memory-instruction {
            color: var(--light-text);
            margin-bottom: 15px;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .memory-level {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .level-btn {
            padding: 6px 12px;
            font-size: 14px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.4);
            color: var(--light-text);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .level-btn.active {
            background: #51CF66;  /* 統一使用綠色 */
            color: white;
            font-weight: bold;
            border-color: #51CF66;
            box-shadow: 0 2px 8px rgba(81, 207, 102, 0.3);
        }
        
        .memory-characters {
            display: grid;
            grid-template-columns: repeat(auto-fit, 55px);  /* 從60px縮減到55px */
            gap: 10px;  /* 從12px縮減到10px */
            margin-bottom: 20px;
            justify-content: center;
            width: 100%;
            max-width: 280px;  /* 從320px縮減到280px */
            margin-left: auto;
            margin-right: auto;
        }
        
        .memory-character {
            width: 55px;  /* 從60px縮減到55px */
            height: 55px;  /* 從60px縮減到55px */
            display: flex;
            align-items: center;
            justify-content: center;
            background: #4DABF7;  /* 統一使用藍色 */
            color: white;
            font-size: 26px;  /* 從28px縮減到26px */
            font-weight: bold;
            border-radius: 5px;
            box-shadow: 0 3px 8px rgba(77, 171, 247, 0.3);
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease;
            font-family: 'Noto Serif TC', serif;
            border: 1px solid rgba(77, 171, 247, 0.3);
        }
        
        .memory-character.hidden {
            background-color: #E0E0E0;
            color: transparent;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            border-color: var(--border-color);
            position: relative;
        }
        
        .memory-character.hidden::after {
            content: "?";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            color: var(--light-text);
            font-weight: bold;
        }
        
        .memory-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            width: 100%;
            justify-items: center;
        }
        
        .memory-option {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
            font-family: 'Noto Serif TC', serif;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .memory-option:hover {
            border-color: #FF6B9D;  /* 統一使用粉紅色 */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
        }
        
        .memory-option.selected {
            background: #FF6B9D;  /* 統一使用粉紅色 */
            color: white;
            border-color: #FF6B9D;
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(255, 107, 157, 0.4);
        }
        
        /* 選對的字 */
        .memory-option.correct {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        
        /* 選錯的字 */
        .memory-option.wrong {
            background-color: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        /* 未選擇但應該選的字 */
        .memory-option.missed {
            background-color: rgba(255, 255, 255, 0.4);
            border: 1px dashed var(--success);
            position: relative;
        }
        
        .memory-option.missed::after {
            content: "✓";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: var(--success);
            font-weight: bold;
        }
        
        .memory-timer {
            font-size: 16px;
            font-weight: bold;
            color: var(--light-text);
            margin-bottom: 15px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .memory-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .memory-result {
            display: none;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
            border: 1px solid var(--border-color);
        }
        
        .memory-result.success {
            background-color: rgba(58, 115, 85, 0.1);
            color: var(--success);
        }
        
        .memory-result.error {
            background-color: rgba(180, 61, 61, 0.1);
            color: var(--danger);
        }
        
        /* 脉动提示效果 */
        .stroke-hint {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 107, 157, 0.4);
            animation: pulse 1.5s infinite;
            pointer-events: none;
            z-index: 10;
            display: none;
            border: 2px solid rgba(255, 107, 157, 0.6);
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.4;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.7;
            }
        }
        
        /* 笔顺提示 */
        .stroke-animation-hint {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #51CF66;  /* 統一使用綠色 */
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(81, 207, 102, 0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .stroke-animation-hint.visible {
            opacity: 1;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-5px); }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-6px); }
        }
        
        .bounce {
            animation: bounce 1s ease;
        }
        
        /* HanziWriter 定制样式 */
        #quiz-target-field {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 5;
            cursor: pointer;
        }
        
        #quiz-target-field svg {
            overflow: visible !important;
        }
        
        /* 可愛星星装饰 - 小學生友善 */
        .seal-decoration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            opacity: 0.8;
            z-index: 1;

            filter: drop-shadow(0 2px 4px rgba(255, 107, 157, 0.3));
        }
        

        
        /* 书法字体风格覆盖 */
        .chinese-text {
            font-family: 'Noto Serif TC', serif;
            letter-spacing: 1px;
        }
        
        /* 多字符選擇器樣式 */
        .character-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            width: 100%;
            box-sizing: border-box;
        }
        
        .selector-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 12px;
            text-align: center;
            font-family: 'Noto Serif TC', serif;
        }
        
        .character-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }
        
        .character-btn {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            font-family: 'Noto Serif TC', serif;
            color: var(--ink-color);
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* 田字格背景 */
            background-image: 
                linear-gradient(to right, var(--border-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--border-color) 1px, transparent 1px),
                linear-gradient(to right, rgba(255, 107, 157, 0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 107, 157, 0.3) 1px, transparent 1px);
            background-size: 25px 25px, 25px 25px, 50px 50px, 50px 50px;
            background-position: 0 0, 0 0, 0 0, 0 0;
            }
            
        .character-btn:hover:not(.active) {
            transform: translateY(-2px) scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
            background-color: rgba(255, 107, 157, 0.05);
        }
        
        .character-btn.active:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
            }
            
        .character-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #22c55e;
            font-weight: 900;
            border: 3px solid #22c55e;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
            /* 田字格保持原始顏色，不使用綠色 */
            background-image: 
                linear-gradient(to right, var(--border-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--border-color) 1px, transparent 1px),
                linear-gradient(to right, rgba(255, 107, 157, 0.3) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 107, 157, 0.3) 1px, transparent 1px);
            background-size: 25px 25px, 25px 25px, 50px 50px, 50px 50px;
            background-position: 0 0, 0 0, 0 0, 0 0;

        }
        
        .character-btn:active {
            transform: translateY(0) scale(1.02);
            }
            
        /* 為選中狀態添加輕微的閃爍動畫 */

        
        /* 字義解釋區樣式 - 簡潔版本 */
        .character-definition {
            margin-top: 20px;
            padding: 18px;
            background: var(--panel-bg);  /* 使用純色背景 */
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);  /* 簡化陰影 */
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        .character-definition::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #FFE66D;  /* 統一使用黃色裝飾條 */
        }
        
        .definition-header {
            font-size: 16px;
            font-weight: 700;
            color: var(--ink-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Noto Serif TC', serif;
            letter-spacing: 0.5px;
        }
        
        .definition-content {
            text-align: left;
        }
        
        .definition-item {
            margin-bottom: 16px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            position: relative;
        }
        
        .definition-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            }
            
        .definition-main {
            margin-bottom: 8px;
            line-height: 1.8;
        }
        
        .definition-type {
            display: inline-block;
            font-size: 11px;
            color: white;
            background: #FF6B9D;  /* 統一使用粉紅色 */
            padding: 4px 10px;
            border-radius: 12px;
            margin-right: 10px;
            margin-bottom: 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(255, 107, 157, 0.3);
            vertical-align: baseline;
            }
            
        .definition-text {
            color: var(--ink-color);
            font-size: 16px;
            line-height: 1.7;
            font-family: 'Noto Serif TC', serif;
            margin-bottom: 8px;
            text-align: left;
            font-weight: 400;
            display: inline;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: normal;
            overflow: hidden;
            }
            
        .definition-english {
            color: #2563eb;
            font-size: 15px;
            line-height: 1.6;
            font-family: 'Georgia', serif;
            margin: 8px 0;
            padding: 10px 14px;
            background: rgba(37, 99, 235, 0.05);
            border-left: 3px solid #2563eb;
            border-radius: 0 6px 6px 0;
            font-style: italic;
            text-align: left;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: normal;
            overflow: hidden;
            }
            
        .definition-example {
            font-size: 14px;
            color: #64748b;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(100, 116, 139, 0.05);
            border-radius: 6px;
            font-family: 'Noto Serif TC', serif;
            line-height: 1.5;
            text-align: left;
            position: relative;
            border-left: 2px solid var(--accent);
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: normal;
            overflow: hidden;
            }
            
        .definition-example::before {
            content: "例：";
            color: var(--primary);
            font-weight: bold;
            margin-right: 6px;
        }
        
        .definition-loading {
            text-align: center;
            color: var(--light-text);
            font-style: italic;
            font-size: 13px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            }
            
        .definition-loading::before {
            content: '🔍';
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
            }
            
        /* 響應式調整 */
        @media (max-width: 768px) {
            .character-definition {
                padding: 15px;
                margin-top: 15px;
            }
            
            .definition-header {
                font-size: 15px;
            }
            
            .definition-text {
                font-size: 15px;
            }
            
            .definition-english {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .definition-example {
                font-size: 13px;
                padding: 6px 10px;
            }
        }
        

        

        
        /* 新增功能區樣式 */
        .character-search-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .function-section {
            position: relative;
            min-width: 100%;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        .function-container {
            width: 100%;
            max-width: 100%;
            min-height: 500px;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        

        

        
        .side-panel {
            margin-bottom: 15px;
        }
        
        .side-panel-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .side-panel-header h2 {
            margin: 0;
            font-size: 1.2em;
            padding-left: 0;
        }
        
        .side-panel-header h2::before {
            display: none;
        }
        
        .side-panel-header svg {
            color: var(--highlight-color);
        }
        
        .tip-content {
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            color: var(--text);
        }
        
        .tip-source {
            text-align: right;
            font-style: italic;
            margin-top: 5px;
            color: var(--light-text);
            font-size: 12px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .main-panel, .side-panel-container {
                width: 100%;
                max-width: 100%;
            }
            
            .character-board, .quiz-target {
                width: 220px;
                height: 220px;
            }
            
            .game-card {
                flex: 1 1 100%;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .seal-decoration {
                width: 40px;
                height: 40px;
                bottom: 5px;
                right: 5px;
            }
            
            .nav-container {
                width: 100%;
            }
            
            .nav-button span {
                font-size: 14px;
            }
            
            /* 字符選擇器響應式 */
            .character-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .character-buttons {
                gap: 6px;
            }
            
            .selector-title {
                font-size: 14px;
            }
        }
        
        @media (min-width: 768px) {
            .tagline {
                display: block;
                font-size: 1.1em;
                margin-top: 8px;
                letter-spacing: 1px;
            }
            
            .panel {
                padding: 20px;
            }
            
            .character-board, .quiz-target {
                width: 240px;  /* 從280px縮減到240px */
                height: 240px;  /* 從280px縮減到240px */
            }
        }
        
        /* 部首組字遊戲樣式 */
        .radical-game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 100%;
            text-align: center;
            padding: 2px;
            position: relative;
            height: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        /* 顶部游戏介绍和难度选择区域 - 更紧凑的设计 */
        .radical-header-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
            padding: 5px;
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        /* 头部标题 */
        .radical-head-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 5px;
            width: 100%;
            text-align: center;
        }
        
        .radical-instruction {
            color: var(--text);
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Noto Sans TC', sans-serif;
            line-height: 1.3;
            background-color: rgba(255, 255, 255, 0.4);
            padding: 5px 8px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(142, 62, 26, 0.2);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .radical-level-wrapper {
            width: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .radical-level-label {
            font-size: 16px;
            font-weight: bold;
            color: var(--highlight-color);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .radical-level {
            display: flex;
            gap: 15px;
            margin: 0 auto;
            justify-content: center;
            width: 100%;
            max-width: 350px;
        }
        
        /* 下方功能区 */
        .radical-game-board {
            width: 100%;
            max-width: 420px;  /* 從500px縮減到420px */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.4);
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        /* 功能区域标签样式 */
        .workspace-label, .radicals-label {
            font-size: 16px;
            font-weight: bold;
            color: var(--highlight-color);
            margin-bottom: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        
        .target-word-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.6);
            padding: 8px 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }
        
        .target-word-label {
            font-size: 18px;
            font-weight: bold;
            color: var(--highlight-color);
            margin-bottom: 10px;
        }
        
        .target-word {
            font-size: 60px;  /* 從70px縮減到60px */
            color: var(--ink-color);
            line-height: 1;
            width: 85px;  /* 從100px縮減到85px */
            height: 85px;  /* 從100px縮減到85px */
            font-family: 'Noto Serif TC', serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15);
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .radical-workspace {
            position: relative;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: var(--border-radius);
            border: 2px dashed var(--highlight-color);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .radical-drop-area {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            min-height: 80px;
        }
        
        .drop-placeholder {
            color: var(--light-text);
            font-size: 14px;
            text-align: center;
            font-style: italic;
        }
        
        .radicals-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            justify-content: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
            border: 1px solid var(--highlight-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        @media (max-width: 540px) {
            .radicals-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 400px) {
            .radicals-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        .radical-item {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--highlight-color);
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.25s ease;
            font-family: 'Noto Serif TC', serif;
            position: relative;
            margin: 0 auto;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .radical-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            background-color: rgba(142, 62, 26, 0.1);
        }
        
        .radical-item.selected {
            background-color: rgba(35, 45, 82, 0.1);
            transform: scale(0.95);
        }
        
        .radical-item.selected::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background-color: var(--accent);
            border-radius: 50%;
        }
        
        .radical-item-workspace {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--accent);
            border-radius: 8px;
            user-select: none;
            transition: all 0.3s ease;
            font-family: 'Noto Serif TC', serif;
            position: relative;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            margin: 5px;
        }
        
        .radical-item-workspace:hover {
            background-color: rgba(35, 45, 82, 0.05);
        }
        
        .radical-item-workspace::after {
            content: '×';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background-color: var(--primary);
            border-radius: 50%;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .radical-result {
            display: none;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
            border: 1px solid var(--border-color);
        }
        
        .radical-result.success {
            background-color: rgba(58, 115, 85, 0.1);
            color: var(--success);
        }
        
        .radical-result.error {
            background-color: rgba(180, 61, 61, 0.1);
            color: var(--danger);
        }
        
        .radical-hint {
            display: none;
            color: var(--highlight-color);
            font-size: 14px;
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            background-color: rgba(142, 62, 26, 0.05);
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px dashed var(--border-color);
        }
        
        .radical-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* 字词查询模式 */
        .word-lookup-container {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
        }
        
        .word-search-section {
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }
        
        .word-search {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .word-input {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 16px;
            font-family: 'Noto Serif TC', serif;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .word-input:focus {
            outline: none;
            border-color: #4DABF7;
            box-shadow: 0 4px 12px rgba(77, 171, 247, 0.3);
            transform: translateY(-1px);
        }
        
        .word-result-section {
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }
        
        .word-display {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--panel-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .word-title {
            font-size: 56px;
            font-weight: bold;
            color: var(--ink-color);
            font-family: 'Noto Serif TC', serif;
            margin-bottom: 12px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            line-height: 1.2;
        }
        
        .word-pronunciation {
            font-size: 20px;
            color: #4DABF7;
            font-weight: 600;
            margin-bottom: 0;
            font-family: 'Noto Sans TC', sans-serif;
            letter-spacing: 1px;
        }
        
        .word-control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            padding: 0 20px;
        }
        
        .word-definition {
            margin-top: 0;
            padding: 20px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow-x: hidden;
            text-align: left;
        }
        
        .word-definition::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4DABF7;
        }
        
        .word-lookup-container .definition-type {
            display: inline-block;
            background: #4DABF7;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(77, 171, 247, 0.3);
            vertical-align: baseline;
            margin-right: 8px;
        }
        
        /* 字词查询模式专用样式 */
        .word-lookup-container .definition-text {
            color: var(--ink-color);
            font-size: 18px;  /* 比笔顺查询的16px更大 */
            line-height: 1.7;
            font-family: 'Noto Serif TC', serif;
            margin-bottom: 8px;
            text-align: left;
            font-weight: 500;  /* 比笔顺查询的400更粗 */
            display: inline;  /* 改为inline，与词性标签在同一行 */
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: normal;
            overflow: hidden;
        }
        
        .word-lookup-container .definition-main {
            margin-bottom: 12px;
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .word-lookup-container .definition-example {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(77, 171, 247, 0.1);
            border-left: 3px solid #4DABF7;
            border-radius: 0 6px 6px 0;
            font-size: 14px;  /* 保持14px，比解释文字的18px小 */
            color: #666;
            font-style: italic;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            white-space: normal;
            overflow: hidden;
        }
        
        .word-lookup-container .definition-example::before {
            content: "例：";
            color: #4DABF7;
            font-weight: bold;
            margin-right: 6px;
        }
        
        .definition-header {
            font-size: 18px;
            font-weight: bold;
            color: #4DABF7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .definition-loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        /* 响应式调整 - 字词查询模式 */
        @media (max-width: 768px) {
            .word-lookup-container .definition-text {
                font-size: 16px;  /* 小屏幕上稍微缩小 */
            }
            
            .word-lookup-container .definition-example {
                font-size: 13px;  /* 小屏幕上例句更小 */
                padding: 6px 10px;
            }
        }
        
        /* 记忆游戏 */
        
        /* 墨寶積分系統樣式 */
        
        /* 頂部狀態欄 */
        .moba-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #FF6B9D, #4DABF7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .moba-player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .moba-level {
            font-weight: bold;
            font-size: 16px;
        }
        
        .moba-points {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .moba-progress-container {
            flex: 1;
            max-width: 200px;
            margin: 0 20px;
        }
        
        .moba-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .moba-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFE66D, #51CF66);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .moba-streak {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        /* 通知樣式 */
        .points-notification,
        .level-up-notification,
        .achievement-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 2000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 300px;
        }
        
        .points-notification.show,
        .level-up-notification.show,
        .achievement-notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .points-notification.hide,
        .level-up-notification.hide,
        .achievement-notification.hide {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .points-notification {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #FFE66D, #FF6B9D);
            color: white;
        }
        
        .points-icon {
            font-size: 24px;
        }
        
        .points-amount {
            font-weight: bold;
            font-size: 16px;
        }
        
        .points-desc {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .level-up-notification {
            background: linear-gradient(135deg, #4DABF7, #51CF66);
            color: white;
            text-align: center;
        }
        
        .level-up-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .level-up-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .level-up-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .old-level,
        .new-level {
            font-weight: bold;
            font-size: 16px;
        }
        
        .level-arrow {
            font-size: 14px;
        }
        
        .level-up-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .level-up-desc {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .achievement-notification {
            background: linear-gradient(135deg, #51CF66, #FFE66D);
            color: white;
        }
        
        .achievement-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .achievement-icon-large {
            font-size: 32px;
        }
        
        .achievement-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .achievement-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .achievement-desc {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .achievement-points {
            font-size: 12px;
            font-weight: bold;
        }
        
        /* 頂部狀態欄樣式 */
        .top-status-bar {
            background: linear-gradient(135deg, #FF6B9D22, #4DABF722);
            border: 2px solid #FF6B9D44;
            border-radius: 15px;
            padding: 12px 20px;
            margin: 0 auto 20px auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.15);
            backdrop-filter: blur(10px);
            width: calc(100% - 40px);
            max-width: 1200px;
            position: relative;
            z-index: 10;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .level-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #FF6B9D, #FF8787);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
        }

        .level-number {
            font-size: 16px;
            font-weight: 900;
        }

        .level-name {
            font-size: 14px;
            font-weight: 600;
        }

        .points-display {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 15px;
            border: 2px solid #FFD43B;
            box-shadow: 0 2px 6px rgba(255, 212, 59, 0.2);
        }

        .points-icon {
            font-size: 16px;
        }

        .points-value {
            font-size: 16px;
            font-weight: bold;
            color: #FF6B9D;
        }

        .progress-section {
            flex: 1;
            max-width: 300px;
            margin: 0 20px;
        }

        .progress-bar-container {
            position: relative;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            border: 2px solid #4DABF7;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4DABF7, #51CF66);
            border-radius: 8px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .streak-info {
            display: flex;
            align-items: center;
        }

        .streak-display {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #FFD43B, #FFE66D);
            padding: 6px 12px;
            border-radius: 15px;
            border: 2px solid #FF8787;
            box-shadow: 0 2px 6px rgba(255, 212, 59, 0.2);
        }

        .streak-icon {
            font-size: 16px;
        }

        .streak-value {
            font-size: 16px;
            font-weight: bold;
            color: #E03131;
        }

        .streak-label {
            font-size: 12px;
            color: #E03131;
            font-weight: 600;
        }

        /* 通知動畫樣式 */
        .point-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #51CF66, #40C057);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.4);
            z-index: 1000;
            animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD43B, #FFE66D);
            color: #E03131;
            padding: 20px 30px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 212, 59, 0.5);
            z-index: 1001;
            animation: bounceIn 0.6s ease, fadeOut 0.5s ease 3s forwards;
            border: 3px solid #FF6B9D;
        }

        .achievement-notification {
            position: fixed;
            top: 150px;
            right: 20px;
            background: linear-gradient(135deg, #9775FA, #845EF7);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 6px 20px rgba(151, 117, 250, 0.4);
            z-index: 1002;
            animation: slideInRight 0.5s ease, fadeOut 0.5s ease 4s forwards;
            max-width: 300px;
        }

        .achievement-notification .achievement-title {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .achievement-notification .achievement-desc {
            font-size: 12px;
            opacity: 0.9;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes bounceIn {
            0% {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* 更新成就面板樣式 */
        .achievement-count {
            font-size: 12px;
            color: var(--light-text);
            margin-left: 8px;
        }

        .achievements-summary {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recent-achievements {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recent-achievement {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: linear-gradient(135deg, rgba(151, 117, 250, 0.1), rgba(255, 107, 157, 0.1));
            border-radius: 8px;
            border: 1px solid rgba(151, 117, 250, 0.2);
            animation: slideInRight 0.5s ease;
        }

        .recent-achievement-icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .recent-achievement-info {
            flex: 1;
        }

        .recent-achievement-name {
            font-size: 12px;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 2px;
        }

        .recent-achievement-desc {
            font-size: 10px;
            color: var(--light-text);
        }

        .recent-achievement-points {
            font-size: 11px;
            color: #9775FA;
            font-weight: bold;
        }

        .achievement-progress-overview {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .progress-item:last-child {
            border-bottom: none;
        }

        .progress-label {
            font-size: 12px;
            color: var(--text);
        }

        .progress-value {
            font-size: 12px;
            font-weight: bold;
            color: var(--accent);
        }

        .btn-view-all {
            width: 100%;
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }

        /* 成就模態窗口樣式 */
        .achievements-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .achievements-modal-content {
            background: var(--panel-bg);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
        }

        .achievements-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
            background: linear-gradient(135deg, #FF6B9D22, #4DABF722);
        }

        .achievements-modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--ink-color);
            font-family: 'Noto Serif TC', serif;
        }

        .achievements-modal-count {
            font-size: 14px;
            color: var(--light-text);
        }

        .achievements-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--light-text);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .achievements-modal-close:hover {
            background: rgba(255, 107, 157, 0.1);
            color: var(--accent);
        }

        .achievements-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .achievements-modal-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .achievement-category {
            font-weight: bold;
            color: var(--ink-color);
            font-size: 14px;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .achievement-category:first-child {
            margin-top: 0;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .achievement {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            min-height: 70px;
            position: relative;
            overflow: hidden;
        }

        .achievement:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, rgba(81, 207, 102, 0.1), rgba(255, 230, 109, 0.1));
            border-color: #51CF66;
            box-shadow: 0 2px 8px rgba(81, 207, 102, 0.2);
        }

        .achievement.unlocked:hover {
            box-shadow: 0 6px 16px rgba(81, 207, 102, 0.3);
        }

        .achievement.locked {
            opacity: 0.6;
            background: rgba(200, 200, 200, 0.1);
        }

        .achievement.locked:hover {
            opacity: 0.8;
        }

        .achievement-icon {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .achievement.unlocked .achievement-icon {
            background: linear-gradient(135deg, #51CF66, #40C057);
            color: white;
            border-color: #51CF66;
        }

        .achievement-details {
            flex: 1;
            min-width: 0; /* 允許文字換行 */
        }

        .achievement-name {
            font-size: 14px;
            font-weight: bold;
            color: var(--ink-color);
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .achievement-description {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 4px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .achievement-progress {
            font-size: 11px;
            color: var(--accent);
            font-weight: bold;
            background: rgba(77, 171, 247, 0.1);
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
        }

        .achievement-points {
            font-size: 12px;
            font-weight: bold;
            color: #9775FA;
            background: rgba(151, 117, 250, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(151, 117, 250, 0.2);
        }

        /* 響應式設計 */
        @media (max-width: 1200px) {
            .achievement-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .achievements-modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .achievements-modal-header {
                padding: 15px;
            }

            .achievements-modal-header h3 {
                font-size: 16px;
            }

            .achievements-modal-body {
                padding: 15px;
                max-height: 65vh;
            }

            .achievement-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .achievement {
                padding: 10px;
                gap: 10px;
                min-height: 60px;
            }

            .achievement-icon {
                width: 28px;
                height: 28px;
                font-size: 18px;
            }

            .achievement-name {
                font-size: 13px;
            }

            .achievement-description {
                font-size: 11px;
            }

            .achievement-points {
                font-size: 11px;
                padding: 3px 6px;
            }

            .recent-achievement {
                padding: 6px;
                gap: 6px;
            }

            .recent-achievement-icon {
                font-size: 14px;
                width: 20px;
            }

            .recent-achievement-name {
                font-size: 11px;
            }

            .recent-achievement-desc {
                font-size: 9px;
            }

            .recent-achievement-points {
                font-size: 10px;
            }

            .progress-item {
                padding: 3px 0;
            }

            .progress-label,
            .progress-value {
                font-size: 11px;
            }

            .btn-view-all {
                padding: 6px;
                font-size: 11px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .achievement-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) {
            .achievement-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }
        
        /* 調整主內容區域以適應頂部狀態欄 */
        .container {
            margin-top: 70px;
        }
        
        /* 響應式設計 - 墨寶積分系統 */
        @media (max-width: 768px) {
            .top-status-bar {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
                width: calc(100% - 30px);
            }
            
            .player-info {
                gap: 10px;
            }
            
            .level-badge {
                padding: 4px 8px;
            }
            
            .level-number {
                font-size: 14px;
            }
            
            .level-name {
                font-size: 12px;
            }
            
            .points-display {
                padding: 4px 8px;
            }
            
            .points-value {
                font-size: 14px;
            }
            
            .progress-section {
                max-width: 200px;
                margin: 0;
            }
            
            .streak-display {
                padding: 4px 8px;
            }
            
            .streak-value {
                font-size: 14px;
            }
            
            .points-notification,
            .level-up-notification,
            .achievement-notification {
                right: 10px;
                max-width: 250px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="content">
                <h1>点点墨宝</h1>
                <p class="tagline">弘立书院中文经典AI实验室出品</p>
            </div>
        </header>
        
        <!-- 主导航 -->
        <div class="main-nav">
            <div class="nav-container">
                <button id="nav-lookup" class="nav-button active">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <span>笔顺查询</span>
                </button>
                <button id="nav-word-lookup" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                    <span>字词查询</span>
                </button>
                <button id="nav-practice" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                        <circle cx="11" cy="11" r="2"></circle>
                    </svg>
                    <span>笔顺大师</span>
                </button>
                <button id="nav-memory" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                        <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                        <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                    </svg>
                    <span>记忆挑战</span>
                </button>
                <button id="nav-radical" class="nav-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 11V4h7"></path>
                        <path d="M4 7l7 7"></path>
                        <path d="M20 11V4h-7"></path>
                        <path d="M20 7l-7 7"></path>
                        <path d="M4 13v7h7"></path>
                        <path d="M4 17l7-7"></path>
                        <path d="M20 13v7h-7"></path>
                        <path d="M20 17l-7-7"></path>
                    </svg>
                    <span>部首组字</span>
                </button>
            </div>
        </div>
        
        <!-- 頂部狀態欄 -->
        <div class="top-status-bar">
            <div class="player-info">
                <div class="level-badge">
                    <span class="level-number" id="player-level">1</span>
                    <span class="level-name" id="player-level-name">墨韻初心</span>
                </div>
                <div class="points-display">
                                            <span class="points-icon">🖌️</span>
                    <span class="points-value" id="player-points">0</span>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="level-progress-bar">
                        <div class="progress-fill" id="level-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="level-progress-text">0/100</div>
                </div>
            </div>
            <div class="streak-info">
                <div class="streak-display">
                    <span class="streak-icon">🔥</span>
                    <span class="streak-value" id="login-streak">0</span>
                    <span class="streak-label">天</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- 功能区域面板 -->
            <div class="panel main-panel">
                <!-- 顶部: 通用汉字查询部分 -->
                <div id="character-search-section" class="character-search-section">
                    <div class="character-search">
                        <input type="text" id="character-input" class="character-input" placeholder="请输入汉字或短句（最多20字）" maxlength="20">
                        <button id="search-button" class="search-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            查询
                        </button>
                    </div>
                    
                    <div id="error-message" class="error-message">请输入有效的中文字</div>
                    
                    <div class="loader-container">
                        <div id="loader" class="loader"></div>
                    </div>
                </div>
                
                <!-- 功能模式容器 - 只会显示一个 -->
                <div class="function-container">
                    <!-- 多字符选择器 -->
                    <div id="character-selector" class="character-selector" style="display: none;">
                        <div class="selector-title">点击要查询的汉字：</div>
                        <div id="character-buttons" class="character-buttons"></div>
                    </div>
                    
                    <!-- 功能1: 笔顺查询模式 -->
                    <div id="character-display-section" class="character-display-section function-section">
                        <div class="character-board">
                            <div class="grid-background"></div>
                            <div id="character-target" class="character-target"></div>
                        </div>
                        
                        <div class="character-info">
                            <span id="character-display" class="character-label" style="display: none;"></span>
                            <span id="pinyin-display" class="pinyin"></span>
                            <div id="stroke-count" class="stroke-count"></div>
                        </div>
                        
                        <div class="control-buttons">
                            <button id="animate-button" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                                重播笔顺
                            </button>
                            <button id="quiz-button" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                                    <circle cx="11" cy="11" r="2"></circle>
                                </svg>
                                练习书写
                            </button>
                            <button id="speak-button" class="btn btn-outline">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                </svg>
                                朗读
                            </button>
                            <button id="character-favorite-btn" class="btn btn-favorite" title="收藏字">
                                💝 收藏
                            </button>
                        </div>
                        
                        <!-- 新增：字义解释区 -->
                        <div id="character-definition" class="character-definition" style="display: none;">
                            <div class="definition-header">📖 字义解释</div>
                            <div id="definition-content" class="definition-content"></div>
                            <div id="definition-loading" class="definition-loading" style="display: none;">
                                正在查询字义...
                            </div>
                    </div>
                    
                        <!-- 可爱星星装饰 -->
                        <img class="seal-decoration" src="data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cstar cx='30' cy='30' r1='15' r2='8' fill='%23FF6B9D66'/%3E%3Ccircle cx='30' cy='30' r='12' fill='%23FFE66D55'/%3E%3Ctext x='30' y='35' text-anchor='middle' font-size='8' font-family='serif' fill='%23FF6B9D' font-weight='bold'%3E棒棒%3C/text%3E%3C/svg%3E">
                    </div>
                    
                    <!-- 功能2: 字词查询模式 -->
                    <div id="word-lookup-container" class="word-lookup-container function-section">
                        <div class="word-search-section">
                            <div class="word-search">
                                <input type="text" id="word-input" class="word-input" placeholder="请输入要查询的字或词语（如：学、学习、美丽）" maxlength="10">
                                <button id="word-search-button" class="search-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    查询
                                </button>
                            </div>
                            
                            <div id="word-error-message" class="error-message" style="display: none;">请输入有效的中文字或词语</div>
                            
                            <div class="loader-container">
                                <div id="word-loader" class="loader" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <div id="word-result-section" class="word-result-section" style="display: none;">
                            <div class="word-display">
                                <div id="word-title" class="word-title"></div>
                                <div id="word-pronunciation" class="word-pronunciation"></div>
                            </div>
                            
                            <div class="word-control-buttons">
                                <button id="word-speak-button" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
                                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                    </svg>
                                    朗读
                                </button>
                                <button id="word-practice-button" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                                    <circle cx="11" cy="11" r="2"></circle>
                                </svg>
                                    拆字练习
                                </button>
                                <button id="word-favorite-btn" class="btn btn-favorite" title="收藏词语">
                                    💝 收藏
                                </button>
                        </div>
                            
                            <!-- 词语解释区 -->
                            <div id="word-definition" class="word-definition">
                                                            <div class="definition-header">📚 字词解释</div>
                                <div id="word-definition-content" class="definition-content"></div>
                                <div id="word-definition-loading" class="definition-loading" style="display: none;">
                                    正在查询字词解释...
                                </div>
                            </div>
                        </div>
                        
                        <!-- 可爱星星装饰 -->
                        <img class="seal-decoration" src="data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cstar cx='30' cy='30' r1='15' r2='8' fill='%234DABF766'/%3E%3Ccircle cx='30' cy='30' r='12' fill='%23FFE66D55'/%3E%3Ctext x='30' y='35' text-anchor='middle' font-size='8' font-family='serif' fill='%234DABF7' font-weight='bold'%3E词典%3C/text%3E%3C/svg%3E">
                    </div>
                    
                    <!-- 功能3: 笔顺练习模式 -->
                    <div id="quiz-container" class="quiz-container function-section">
                        <div class="quiz-instruction">请按照正确的笔顺点击完成汉字！</div>
                        
                        <div class="quiz-progress" id="quiz-progress">
                            <!-- 动态生成进度条 -->
                        </div>
                        
                        <div class="quiz-target">
                            <div class="grid-background"></div>
                            <div id="quiz-target-field"></div>
                            <div id="stroke-hint" class="stroke-hint"></div>
                            <div id="stroke-animation-hint" class="stroke-animation-hint">点击这里！</div>
                        </div>
                        
                        <div id="quiz-result" class="quiz-result">
                            <div class="quiz-result-message">真棒！你完成了这个汉字！</div>
                            <div class="quiz-result-detail">你成功按照正确的笔顺完成了「人」字！</div>
                        </div>
                        
                        <div class="quiz-buttons">
                            <button id="quiz-retry" class="btn btn-primary">重新挑战</button>
                            <button id="quiz-next" class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                                下一个汉字
                            </button>
                            <button id="quiz-hint" class="btn btn-outline">显示提示</button>
                        </div>
                    </div>
                    
                    <!-- 功能4: 记忆挑战模式 -->
                    <div id="memory-game-container" class="memory-game-container function-section">
                        <div class="memory-instruction">记住显示的汉字，然后在它们消失后选出正确的汉字！</div>
                        
                        <div class="memory-level">
                            <button class="level-btn active" data-level="3">初级 (3字)</button>
                            <button class="level-btn" data-level="5">中级 (5字)</button>
                            <button class="level-btn" data-level="8">高级 (8字)</button>
                        </div>
                        
                        <div class="memory-timer" id="memory-timer">准备开始...</div>
                        
                        <div class="memory-characters" id="memory-characters">
                            <!-- 动态生成字符卡片 -->
                        </div>
                        
                        <div class="memory-options" id="memory-options">
                            <!-- 动态生成选项 -->
                        </div>
                        
                        <div id="memory-result" class="memory-result">
                            <div class="memory-result-message">做得好！你记住了所有汉字！</div>
                            <div class="memory-result-score">得分：3/3</div>
                        </div>
                        
                        <div class="memory-controls">
                            <button id="memory-start" class="btn btn-primary">开始游戏</button>
                        </div>
                    </div>
                    
                    <!-- 功能5: 部首组字游戏 -->
                    <div id="radical-game-container" class="radical-game-container function-section">
                        <!-- 顶部难度选择区域 -->
                        <div class="radical-header-section">
                            <div class="radical-level-wrapper">
                                <div class="radical-level">
                                    <button class="level-btn active" data-level="easy">初级</button>
                                    <button class="level-btn" data-level="medium">中级</button>
                                    <button class="level-btn" data-level="hard">高级</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 下方功能区 - 完全垂直布局 -->
                        <div class="radical-game-board">
                            <!-- 目标字区域 -->
                            <div class="target-word-container">
                                <div class="target-word-label">目标字</div>
                                <div id="target-word" class="target-word">?</div>
                            </div>
                            
                            <!-- 部首工作区 -->
                            <div class="radical-workspace">
                                <div id="radical-drop-area" class="radical-drop-area">
                                    <div class="drop-placeholder">点击下方部首添加到此处</div>
                                </div>
                            </div>
                            
                            <!-- 部首选择区 -->
                            <div class="radicals-selection-area">
                                <div class="radicals-label">部首选择</div>
                                <div id="radicals-container" class="radicals-container">
                                    <!-- 这里将动态生成部首元素 -->
                                </div>
                            </div>
                            
                            <!-- 操作按钮区域 -->
                            <div class="radical-controls">
                                <button id="radical-check" class="btn btn-primary">检查</button>
                                <button id="radical-hint-btn" class="btn btn-solid-light">显示提示</button>
                                <button id="radical-clear" class="btn btn-solid-light">清除</button>
                                <button id="radical-next" class="btn btn-secondary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M9 18l6-6-6-6"/>
                                    </svg>
                                    下一题
                                </button>
                            </div>
                        </div>
                        
                        <!-- 结果和提示区域 -->
                        <div id="radical-result" class="radical-result">
                            <div class="radical-result-message">非常棒！你成功组字了！</div>
                            <div class="radical-result-message">非常棒！你成功組字了！</div>
                            <div class="radical-result-detail">你成功組合了「好」字！</div>
                        </div>
                        
                        <div class="radical-hint" id="radical-hint">提示：「女」和「子」組成「好」</div>
                    </div>
                </div>
            </div>
            
            <!-- 側邊面板區域 -->
            <div class="side-panel-container">
                <!-- 成就面板 -->
                <div class="panel panel-compact side-panel" id="achievements-panel">
                    <div class="side-panel-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"></path>
                        </svg>
                        <h2 class="chinese-text">我的成就</h2>
                        <span class="achievement-count" id="achievement-count">(0/40)</span>
                    </div>
                    <div class="achievements-summary">
                        <div class="recent-achievements" id="recent-achievements">
                            <!-- 最近獲得的成就 -->
                        </div>
                        <div class="achievement-progress-overview">
                            <div class="progress-item">
                                <span class="progress-label">基礎探索</span>
                                <span class="progress-value" id="basic-progress">0/4</span>
                            </div>
                            <div class="progress-item">
                                <span class="progress-label">筆順修煉</span>
                                <span class="progress-value" id="stroke-progress">0/4</span>
                            </div>
                            <div class="progress-item">
                                <span class="progress-label">記憶挑戰</span>
                                <span class="progress-value" id="memory-progress">0/4</span>
                            </div>
                        </div>
                        <button class="btn btn-outline btn-view-all" id="view-all-achievements">
                            查看全部成就
                        </button>
                    </div>
                </div>

                <!-- 全部成就模態窗口 -->
                <div class="achievements-modal" id="achievements-modal" style="display: none;">
                    <div class="achievements-modal-content">
                        <div class="achievements-modal-header">
                            <h3>🏆 全部成就</h3>
                            <span class="achievements-modal-count" id="achievements-modal-count">(0/40)</span>
                            <button class="achievements-modal-close" id="achievements-modal-close">×</button>
                        </div>
                        <div class="achievements-modal-body">
                            <div class="achievements-modal-list" id="achievements-modal-list">
                                <!-- 動態生成完整成就列表 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 字詞本 -->
                <div class="panel panel-compact side-panel" id="vocabulary-book-panel">
                    <div class="side-panel-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            <path d="M12 6v12"></path>
                            <path d="M8 12h8"></path>
                        </svg>
                        <h2 class="chinese-text">我的字詞本</h2>
                        <span class="vocabulary-count" id="vocabulary-count">(0)</span>
                    </div>
                    <div class="vocabulary-book-content">
                        <div class="vocabulary-list" id="vocabulary-list">
                            <div class="empty-vocabulary">
                                <div class="empty-icon">📚</div>
                                <div class="empty-text">還沒有收藏任何字詞</div>
                                <div class="empty-hint">查詢字詞時點擊收藏按鈕</div>
                            </div>
                        </div>
                        <div class="vocabulary-more" id="vocabulary-more" style="display: none;">
                            <button class="btn btn-outline btn-more" id="vocabulary-more-btn">
                                查看全部 (<span id="total-count">0</span>)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 字詞本模態窗口 -->
                <div class="vocabulary-modal" id="vocabulary-modal" style="display: none;">
                    <div class="vocabulary-modal-content">
                        <div class="vocabulary-modal-header">
                            <h3>我的字詞本</h3>
                            <span class="vocabulary-modal-count" id="vocabulary-modal-count">(0)</span>
                            <button class="vocabulary-modal-close" id="vocabulary-modal-close">×</button>
                        </div>
                        <div class="vocabulary-modal-body">
                            <div class="vocabulary-modal-list" id="vocabulary-modal-list">
                                <!-- 動態生成完整列表 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 今日漢字 -->
                <div class="panel panel-compact side-panel">
                    <div class="side-panel-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <h2 class="chinese-text">你的今日漢字</h2>
                    </div>
                    <div class="daily-character-display">
                        <div id="daily-character" class="daily-character"></div>
                        <div id="daily-character-hint" class="daily-character-hint">思考一下，今天的你與這個字有什麼聯繫？</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // 墨寶積分系統 - 完整的玩家數據結構
            let playerData = {
                points: 0,
                level: 1,
                levelName: '墨韻初心',
                dailyLoginStreak: 0,
                lastLoginDate: null,
                totalCharactersLearned: 0,
                totalWordsLearned: 0,
                totalStrokePractices: 0,
                totalMemoryGames: 0,
                totalRadicalGames: 0,
                totalCollections: 0,
                perfectMemoryGames: 0,
                perfectRadicalGames: 0,
                functionsUsed: new Set(),
                firstTimeActions: new Set(),
                achievements: new Set(),
                statistics: {
                    charactersToday: 0,
                    wordsToday: 0,
                    practiceToday: 0,
                    gamesPlayedToday: 0,
                    lastResetDate: new Date().toDateString()
                }
            };

            // 等級系統定義
            const levelSystem = [
                { level: 1, name: '墨韻初心', minPoints: 0, maxPoints: 99, color: '#FF6B9D' },
                { level: 2, name: '筆墨新手', minPoints: 100, maxPoints: 299, color: '#4DABF7' },
                { level: 3, name: '字海探索', minPoints: 300, maxPoints: 599, color: '#51CF66' },
                { level: 4, name: '詞韻小成', minPoints: 600, maxPoints: 999, color: '#FFD43B' },
                { level: 5, name: '墨香書生', minPoints: 1000, maxPoints: 1999, color: '#FF8787' },
                { level: 6, name: '文字達人', minPoints: 2000, maxPoints: 3499, color: '#9775FA' },
                { level: 7, name: '筆韻大師', minPoints: 3500, maxPoints: 5499, color: '#20C997' },
                { level: 8, name: '墨寶學者', minPoints: 5500, maxPoints: 7999, color: '#FD7E14' },
                { level: 9, name: '字聖傳人', minPoints: 8000, maxPoints: 9999, color: '#E03131' },
                { level: 10, name: '墨寶宗師', minPoints: 10000, maxPoints: 999999, color: '#FFD700' }
            ];

            // 成就系統定義 - 按類別組織
            const achievementCategories = {
                basic: {
                    name: '基礎探索',
                    achievements: [
                        { id: 'first_character', name: '初識漢字', desc: '查詢第一個漢字', points: 20, icon: '🔤' },
                        { id: 'first_word', name: '詞海初航', desc: '查詢第一個詞語', points: 20, icon: '📖' },
                        { id: 'first_collection', name: '珍藏墨寶', desc: '收藏第一個字詞', points: 20, icon: '💎' },
                        { id: 'first_login', name: '每日墨香', desc: '完成每日登入', points: 20, icon: '🌅' }
                    ]
                },
                stroke: {
                    name: '筆順修煉',
                    achievements: [
                        { id: 'stroke_beginner', name: '筆順啟蒙', desc: '完成5次筆順練習', points: 50, icon: '✏️', requirement: 5 },
                        { id: 'stroke_intermediate', name: '筆法小成', desc: '完成20次筆順練習', points: 100, icon: '🖌️', requirement: 20 },
                        { id: 'stroke_advanced', name: '筆順大師', desc: '完成50次筆順練習', points: 200, icon: '🎨', requirement: 50 },
                        { id: 'stroke_master', name: '筆韻宗師', desc: '完成100次筆順練習', points: 300, icon: '🏆', requirement: 100 }
                    ]
                },
                memory: {
                    name: '記憶挑戰',
                    achievements: [
                        { id: 'memory_first', name: '記憶初試', desc: '完成第一場記憶遊戲', points: 30, icon: '🧠' },
                        { id: 'memory_good', name: '過目不忘', desc: '完成10場記憶遊戲', points: 80, icon: '💭', requirement: 10 },
                        { id: 'memory_expert', name: '記憶達人', desc: '完成25場記憶遊戲', points: 150, icon: '🎯', requirement: 25 },
                        { id: 'memory_legend', name: '記憶傳說', desc: '完成50場記憶遊戲', points: 250, icon: '⭐', requirement: 50 }
                    ]
                },
                radical: {
                    name: '部首遊戲',
                    achievements: [
                        { id: 'radical_first', name: '部首初探', desc: '完成第一場部首遊戲', points: 30, icon: '🔍' },
                        { id: 'radical_builder', name: '造字工匠', desc: '完成15場部首遊戲', points: 100, icon: '🔨', requirement: 15 },
                        { id: 'radical_master', name: '字構大師', desc: '完成30場部首遊戲', points: 180, icon: '🏗️', requirement: 30 }
                    ]
                },
                learning: {
                    name: '學習里程',
                    achievements: [
                        { id: 'char_collector', name: '字海拾貝', desc: '學習50個漢字', points: 100, icon: '🐚', requirement: 50 },
                        { id: 'char_scholar', name: '字庫豐富', desc: '學習150個漢字', points: 200, icon: '📚', requirement: 150 },
                        { id: 'char_master', name: '字海博學', desc: '學習300個漢字', points: 350, icon: '🎓', requirement: 300 },
                        { id: 'word_starter', name: '詞彙初豐', desc: '學習30個詞語', points: 80, icon: '🌱', requirement: 30 },
                        { id: 'word_expert', name: '詞海暢遊', desc: '學習100個詞語', points: 180, icon: '🌊', requirement: 100 }
                    ]
                },
                collection: {
                    name: '收藏成就',
                    achievements: [
                        { id: 'collector', name: '墨寶收藏家', desc: '收藏20個字詞', points: 120, icon: '📦', requirement: 20 },
                        { id: 'treasure_hunter', name: '珍藏大師', desc: '收藏50個字詞', points: 250, icon: '💰', requirement: 50 },
                        { id: 'archive_keeper', name: '墨寶典藏', desc: '收藏100個字詞', points: 400, icon: '🏛️', requirement: 100 }
                    ]
                },
                daily: {
                    name: '每日堅持',
                    achievements: [
                        { id: 'streak_3', name: '三日墨香', desc: '連續登入3天', points: 60, icon: '🔥', requirement: 3 },
                        { id: 'streak_7', name: '一週堅持', desc: '連續登入7天', points: 140, icon: '📅', requirement: 7 },
                        { id: 'streak_30', name: '月圓墨滿', desc: '連續登入30天', points: 500, icon: '🌕', requirement: 30 }
                    ]
                },
                exploration: {
                    name: '功能探索',
                    achievements: [
                        { id: 'explorer', name: '功能探索者', desc: '使用所有主要功能', points: 150, icon: '🗺️' },
                        { id: 'game_master', name: '遊戲全能', desc: '玩過所有遊戲模式', points: 120, icon: '🎮' }
                    ]
                },
                special: {
                    name: '特殊成就',
                    achievements: [
                        { id: 'lightning_memory', name: '閃電記憶', desc: '記憶遊戲5秒內完成', points: 100, icon: '⚡' },
                        { id: 'perfectionist', name: '完美主義', desc: '連續10次完美遊戲', points: 200, icon: '💯' },
                        { id: 'night_owl', name: '夜讀墨香', desc: '晚上10點後學習', points: 80, icon: '🌙' },
                        { id: 'early_bird', name: '晨讀書香', desc: '早上6點前學習', points: 80, icon: '🌅' }
                    ]
                }
            };

            // 積分獎勵規則
            const pointRewards = {
                characterLookup: 2,
                wordLookup: 3,
                strokePractice: 5,
                memoryGame: 10,
                memoryGamePerfect: 20,
                radicalGame: 15,
                radicalGamePerfect: 25,
                collection: 8,
                dailyLogin: 10,
                streakBonus: 5,
                firstTime: 20
            };
            
            // 字詞本功能變量
            let vocabularyBook = {
                items: [] // 統一存儲字和詞
            };
            let currentSearchCharacter = '';
            let currentSearchWord = '';
            let lastLookedUpCharacter = '';
            let lastLookedUpCharacterPinyin = '';
            let lastLookedUpWord = '';
            let lastLookedUpWordPinyin = '';
            

            
            // 書法經典字庫
            const calligraphyData = [
                { char: '道', style: 'kaishu', author: '顏真卿', work: '《多寶塔碑》', dynasty: '唐' },
                { char: '德', style: 'kaishu', author: '柳公權', work: '《玄秘塔碑》', dynasty: '唐' },
                { char: '天', style: 'xingshu', author: '王羲之', work: '《蘭亭序》', dynasty: '東晉' },
                { char: '地', style: 'caoshu', author: '張旭', work: '《古詩四帖》', dynasty: '唐' },
                { char: '人', style: 'kaishu', author: '歐陽詢', work: '《九成宮醴泉銘》', dynasty: '唐' },
                { char: '心', style: 'lishu', author: '蔡邕', work: '《熹平石經》', dynasty: '漢' },
                { char: '山', style: 'kaishu', author: '褚遂良', work: '《雁塔聖教序》', dynasty: '唐' },
                { char: '水', style: 'xingshu', author: '米芾', work: '《蜀素帖》', dynasty: '宋' },
                { char: '大', style: 'zhuanshu', author: '李斯', work: '《泰山刻石》', dynasty: '秦' },
                { char: '小', style: 'kaishu', author: '趙孟頫', work: '《洛神賦》', dynasty: '元' },
                { char: '美', style: 'xingshu', author: '懷素', work: '《自敘帖》', dynasty: '唐' },
                { char: '善', style: 'kaishu', author: '顏真卿', work: '《顏氏家廟碑》', dynasty: '唐' }
            ];
            
            // 今日漢字庫 - 專為中小學生設計的有意義且可供聯想的漢字
            const meaningfulCharacters = [
                // 基礎積極品格特質 (適合中小學生的重要品德)
                '好', '善', '真', '美', '勇', '誠', '勤', '孝', '友', '禮',
                '信', '愛', '恩', '仁', '和', '忍', '謙', '志', '樂', '智',
                
                // 學校生活
                '學', '校', '讀', '寫', '算', '課', '班', '同', '書', '筆',
                '本', '紙', '桌', '椅', '考', '問', '答', '習', '思', '教',
                
                // 家庭生活
                '家', '爸', '媽', '父', '母', '兄', '姊', '弟', '妹', '親',
                '愛', '笑', '飯', '房', '床', '玩', '聊', '休', '看', '聽',
                
                // 常見物品與事物
                '書', '筆', '球', '車', '話', '門', '窗', '鞋', '帽', '杯',
                '碗', '盤', '電', '機', '包', '傘', '燈', '鐘', '布', '被',
                
                // 身體健康
                '身', '體', '頭', '手', '腳', '眼', '耳', '口', '鼻', '心',
                '肺', '病', '痛', '康', '動', '靜', '跑', '跳', '走', '睡',
                
                // 食物飲食
                '飯', '菜', '肉', '湯', '麵', '果', '糖', '水', '茶', '餅',
                '魚', '蛋', '奶', '麪', '飲', '吃', '喝', '甜', '酸', '辣',
                
                // 情緒與感受 (簡化為中小學生常用)
                '笑', '哭', '怒', '喜', '樂', '悲', '好', '壞', '煩', '怕',
                '想', '念', '急', '慢', '忙', '閒', '累', '困', '驚', '疑',
                
                // 自然與環境
                '天', '地', '日', '月', '星', '風', '雨', '雪', '雲', '山',
                '水', '海', '河', '花', '草', '樹', '木', '林', '蟲', '鳥',
                
                // 時間與季節
                '年', '月', '日', '時', '分', '秒', '早', '晚', '春', '夏',
                '秋', '冬', '冷', '熱', '暖', '涼', '快', '慢', '前', '後',
                
                // 顏色與形狀
                '紅', '黃', '藍', '綠', '白', '黑', '紫', '橙', '圓', '方',
                '長', '短', '高', '低', '大', '小', '多', '少', '深', '淺',
                
                // 數位科技 (中小學生常接觸)
                '網', '遊', '視', '聽', '電', '話', '機', '影', '片', '拍',
                '照', '傳', '信', '息', '訊', '玩', '打', '按', '查', '搜',
                
                // 學習動作
                '讀', '寫', '看', '聽', '說', '想', '記', '背', '畫', '做',
                '問', '答', '想', '創', '學', '教', '練', '習', '思', '考',
                
                // 社交互動
                '朋', '友', '同', '學', '師', '幫', '助', '謝', '請', '好',
                '會', '見', '聚', '分', '享', '送', '拿', '給', '問', '答',
                
                // 休閒活動
                '玩', '跳', '跑', '跨', '爬', '畫', '唱', '聽', '看', '玩',
                '騎', '踢', '遊', '玩', '笑', '舞', '跳', '打', '游', '戲'
            ];
            
            // 顯示今日漢字
            function showDailyCharacter() {
                const dailyCharElement = document.getElementById('daily-character');
                
                // 從有意義的漢字庫中隨機選擇一個
                const randomIndex = Math.floor(Math.random() * meaningfulCharacters.length);
                const todayCharacter = meaningfulCharacters[randomIndex];
                
                // 設置今日漢字
                dailyCharElement.textContent = todayCharacter;
                
                // 添加動畫效果
                dailyCharElement.classList.add('bounce');
                setTimeout(() => {
                    dailyCharElement.classList.remove('bounce');
                }, 1000);
            }
            
            // 顯示今日隨機漢字
            showDailyCharacter();

            // ===== 墨寶積分系統核心功能 =====
            
            // 載入玩家數據
            function loadPlayerData() {
                const saved = localStorage.getItem('diandianmobao_player_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    // 轉換Set類型的數據
                    if (data.functionsUsed && Array.isArray(data.functionsUsed)) {
                        data.functionsUsed = new Set(data.functionsUsed);
                    }
                    if (data.firstTimeActions && Array.isArray(data.firstTimeActions)) {
                        data.firstTimeActions = new Set(data.firstTimeActions);
                    }
                    if (data.achievements && Array.isArray(data.achievements)) {
                        data.achievements = new Set(data.achievements);
                    }
                    Object.assign(playerData, data);
                }
                
                // 檢查每日重置
                const today = new Date().toDateString();
                if (playerData.statistics.lastResetDate !== today) {
                    playerData.statistics = {
                        charactersToday: 0,
                        wordsToday: 0,
                        practiceToday: 0,
                        gamesPlayedToday: 0,
                        lastResetDate: today
                    };
                }
                
                updateUI();
                handleDailyLogin();
            }

            // 保存玩家數據
            function savePlayerData() {
                const dataToSave = {
                    ...playerData,
                    functionsUsed: Array.from(playerData.functionsUsed),
                    firstTimeActions: Array.from(playerData.firstTimeActions),
                    achievements: Array.from(playerData.achievements)
                };
                localStorage.setItem('diandianmobao_player_data', JSON.stringify(dataToSave));
            }

            // 處理每日登入
            function handleDailyLogin() {
                const today = new Date().toDateString();
                const lastLogin = playerData.lastLoginDate;
                
                if (lastLogin !== today) {
                    if (lastLogin) {
                        const lastDate = new Date(lastLogin);
                        const todayDate = new Date(today);
                        const daysDiff = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff === 1) {
                            // 連續登入
                            playerData.dailyLoginStreak++;
                        } else {
                            // 中斷連續登入
                            playerData.dailyLoginStreak = 1;
                        }
                    } else {
                        // 首次登入
                        playerData.dailyLoginStreak = 1;
                        checkAchievement('first_login');
                    }
                    
                    playerData.lastLoginDate = today;
                    
                    // 每日登入獎勵
                    let dailyPoints = pointRewards.dailyLogin;
                    if (playerData.dailyLoginStreak > 1) {
                        dailyPoints += pointRewards.streakBonus * Math.min(playerData.dailyLoginStreak - 1, 10);
                    }
                    
                    awardPoints(dailyPoints, `每日登入 +${dailyPoints} 🖌️`);
                    
                    // 檢查連續登入成就
                    if (playerData.dailyLoginStreak >= 3) checkAchievement('streak_3');
                    if (playerData.dailyLoginStreak >= 7) checkAchievement('streak_7');
                    if (playerData.dailyLoginStreak >= 30) checkAchievement('streak_30');
                    
                    savePlayerData();
                }
            }

            // 獎勵積分
            function awardPoints(points, message = '') {
                playerData.points += points;
                updatePlayerLevel();
                updateUI();
                savePlayerData();
                
                if (message) {
                    showPointNotification(message);
                }
            }

            // 更新玩家等級
            function updatePlayerLevel() {
                const currentLevel = levelSystem.find(level => 
                    playerData.points >= level.minPoints && playerData.points <= level.maxPoints
                );
                
                if (currentLevel && currentLevel.level !== playerData.level) {
                    const oldLevel = playerData.level;
                    playerData.level = currentLevel.level;
                    playerData.levelName = currentLevel.name;
                    
                    if (currentLevel.level > oldLevel) {
                        showLevelUpNotification(currentLevel.level, currentLevel.name);
                    }
                }
            }

            // 檢查成就
            function checkAchievement(achievementId) {
                if (playerData.achievements.has(achievementId)) return;
                
                // 查找成就
                let achievement = null;
                for (const category of Object.values(achievementCategories)) {
                    achievement = category.achievements.find(a => a.id === achievementId);
                    if (achievement) break;
                }
                
                if (!achievement) return;
                
                // 檢查成就條件
                let unlocked = false;
                
                switch (achievementId) {
                    case 'first_character':
                    case 'first_word':
                    case 'first_collection':
                    case 'first_login':
                    case 'memory_first':
                    case 'radical_first':
                        unlocked = true;
                        break;
                        
                    case 'stroke_beginner':
                        unlocked = playerData.totalStrokePractices >= 5;
                        break;
                    case 'stroke_intermediate':
                        unlocked = playerData.totalStrokePractices >= 20;
                        break;
                    case 'stroke_advanced':
                        unlocked = playerData.totalStrokePractices >= 50;
                        break;
                    case 'stroke_master':
                        unlocked = playerData.totalStrokePractices >= 100;
                        break;
                        
                    case 'memory_good':
                        unlocked = playerData.totalMemoryGames >= 10;
                        break;
                    case 'memory_expert':
                        unlocked = playerData.totalMemoryGames >= 25;
                        break;
                    case 'memory_legend':
                        unlocked = playerData.totalMemoryGames >= 50;
                        break;
                        
                    case 'radical_builder':
                        unlocked = playerData.totalRadicalGames >= 15;
                        break;
                    case 'radical_master':
                        unlocked = playerData.totalRadicalGames >= 30;
                        break;
                        
                    case 'char_collector':
                        unlocked = playerData.totalCharactersLearned >= 50;
                        break;
                    case 'char_scholar':
                        unlocked = playerData.totalCharactersLearned >= 150;
                        break;
                    case 'char_master':
                        unlocked = playerData.totalCharactersLearned >= 300;
                        break;
                    case 'word_starter':
                        unlocked = playerData.totalWordsLearned >= 30;
                        break;
                    case 'word_expert':
                        unlocked = playerData.totalWordsLearned >= 100;
                        break;
                        
                    case 'collector':
                        unlocked = playerData.totalCollections >= 20;
                        break;
                    case 'treasure_hunter':
                        unlocked = playerData.totalCollections >= 50;
                        break;
                    case 'archive_keeper':
                        unlocked = playerData.totalCollections >= 100;
                        break;
                        
                    case 'streak_3':
                        unlocked = playerData.dailyLoginStreak >= 3;
                        break;
                    case 'streak_7':
                        unlocked = playerData.dailyLoginStreak >= 7;
                        break;
                    case 'streak_30':
                        unlocked = playerData.dailyLoginStreak >= 30;
                        break;
                        
                    case 'explorer':
                        unlocked = playerData.functionsUsed.size >= 5;
                        break;
                    case 'game_master':
                        unlocked = playerData.functionsUsed.has('memory') && playerData.functionsUsed.has('radical');
                        break;
                        
                    case 'perfectionist':
                        unlocked = (playerData.perfectMemoryGames + playerData.perfectRadicalGames) >= 10;
                        break;
                        
                    case 'night_owl':
                        unlocked = new Date().getHours() >= 22;
                        break;
                    case 'early_bird':
                        unlocked = new Date().getHours() <= 6;
                        break;
                }
                
                if (unlocked) {
                    playerData.achievements.add(achievementId);
                    awardPoints(achievement.points, `🏆 ${achievement.name} +${achievement.points} 🖌️`);
                    showAchievementNotification(achievement);
                    updateAchievementsDisplay();
                }
            }

            // 更新UI顯示
            function updateUI() {
                // 更新頂部狀態欄
                document.getElementById('player-level').textContent = playerData.level;
                document.getElementById('player-level-name').textContent = playerData.levelName;
                document.getElementById('player-points').textContent = playerData.points;
                document.getElementById('login-streak').textContent = playerData.dailyLoginStreak;
                
                // 更新進度條
                const currentLevelData = levelSystem.find(l => l.level === playerData.level);
                if (currentLevelData) {
                    const progress = ((playerData.points - currentLevelData.minPoints) / 
                                    (currentLevelData.maxPoints - currentLevelData.minPoints)) * 100;
                    document.getElementById('level-progress-fill').style.width = `${Math.min(progress, 100)}%`;
                    document.getElementById('level-progress-text').textContent = 
                        `${playerData.points - currentLevelData.minPoints}/${currentLevelData.maxPoints - currentLevelData.minPoints}`;
                }
                
                updateAchievementsDisplay();
            }

            // 更新成就顯示
            function updateAchievementsDisplay() {
                updateRecentAchievements();
                updateAchievementProgress();
                updateAchievementCounts();
            }

            // 更新最近獲得的成就
            function updateRecentAchievements() {
                const container = document.getElementById('recent-achievements');
                container.innerHTML = '';
                
                // 獲取最近解鎖的3個成就
                const recentAchievements = [];
                for (const [categoryKey, category] of Object.entries(achievementCategories)) {
                    for (const achievement of category.achievements) {
                        if (playerData.achievements.has(achievement.id)) {
                            recentAchievements.push(achievement);
                        }
                    }
                }
                
                // 顯示最近的3個成就
                const recent = recentAchievements.slice(-3);
                
                if (recent.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--light-text); font-size: 12px; padding: 10px;">
                            開始學習來解鎖成就吧！
                        </div>
                    `;
                } else {
                    recent.forEach(achievement => {
                        const achievementEl = document.createElement('div');
                        achievementEl.className = 'recent-achievement';
                        achievementEl.innerHTML = `
                            <div class="recent-achievement-icon">${achievement.icon}</div>
                            <div class="recent-achievement-info">
                                <div class="recent-achievement-name">${achievement.name}</div>
                                <div class="recent-achievement-desc">${achievement.desc}</div>
                            </div>
                            <div class="recent-achievement-points">+${achievement.points}</div>
                        `;
                        container.appendChild(achievementEl);
                    });
                }
            }

            // 更新成就進度概覽
            function updateAchievementProgress() {
                const categories = {
                    'basic': { element: 'basic-progress', total: 4 },
                    'stroke': { element: 'stroke-progress', total: 4 },
                    'memory': { element: 'memory-progress', total: 4 }
                };
                
                for (const [categoryKey, categoryInfo] of Object.entries(categories)) {
                    const category = achievementCategories[categoryKey];
                    if (category) {
                        let unlocked = 0;
                        for (const achievement of category.achievements) {
                            if (playerData.achievements.has(achievement.id)) {
                                unlocked++;
                            }
                        }
                        document.getElementById(categoryInfo.element).textContent = `${unlocked}/${categoryInfo.total}`;
                    }
                }
            }

            // 更新成就計數
            function updateAchievementCounts() {
                const totalAchievements = Object.values(achievementCategories).reduce((total, category) => total + category.achievements.length, 0);
                const unlockedAchievements = playerData.achievements.size;
                
                document.getElementById('achievement-count').textContent = `(${unlockedAchievements}/${totalAchievements})`;
                document.getElementById('achievements-modal-count').textContent = `(${unlockedAchievements}/${totalAchievements})`;
            }

            // 更新模態窗口中的全部成就
            function updateFullAchievementsDisplay() {
                const container = document.getElementById('achievements-modal-list');
                container.innerHTML = '';
                
                // 按類別顯示成就
                for (const [categoryKey, category] of Object.entries(achievementCategories)) {
                    // 添加類別標題
                    const categoryTitle = document.createElement('div');
                    categoryTitle.className = 'achievement-category';
                    categoryTitle.textContent = category.name;
                    container.appendChild(categoryTitle);
                    
                    // 創建該類別的成就網格容器
                    const achievementGrid = document.createElement('div');
                    achievementGrid.className = 'achievement-grid';
                    
                    // 添加該類別的成就
                    for (const achievement of category.achievements) {
                        const achievementEl = document.createElement('div');
                        achievementEl.className = `achievement ${playerData.achievements.has(achievement.id) ? 'unlocked' : 'locked'}`;
                        
                        // 計算進度
                        let progress = '';
                        if (achievement.requirement) {
                            let current = 0;
                            switch (achievement.id) {
                                case 'stroke_beginner':
                                case 'stroke_intermediate':
                                case 'stroke_advanced':
                                case 'stroke_master':
                                    current = playerData.totalStrokePractices;
                                    break;
                                case 'memory_good':
                                case 'memory_expert':
                                case 'memory_legend':
                                    current = playerData.totalMemoryGames;
                                    break;
                                case 'radical_builder':
                                case 'radical_master':
                                    current = playerData.totalRadicalGames;
                                    break;
                                case 'char_collector':
                                case 'char_scholar':
                                case 'char_master':
                                    current = playerData.totalCharactersLearned;
                                    break;
                                case 'word_starter':
                                case 'word_expert':
                                    current = playerData.totalWordsLearned;
                                    break;
                                case 'collector':
                                case 'treasure_hunter':
                                case 'archive_keeper':
                                    current = playerData.totalCollections;
                                    break;
                                case 'streak_3':
                                case 'streak_7':
                                case 'streak_30':
                                    current = playerData.dailyLoginStreak;
                                    break;
                            }
                            progress = `${Math.min(current, achievement.requirement)}/${achievement.requirement}`;
                        }
                        
                        achievementEl.innerHTML = `
                            <div class="achievement-icon">${achievement.icon}</div>
                            <div class="achievement-details">
                                <div class="achievement-name">${achievement.name}</div>
                                <div class="achievement-description">${achievement.desc}</div>
                                ${progress ? `<div class="achievement-progress">${progress}</div>` : ''}
                            </div>
                            <div class="achievement-points">+${achievement.points}</div>
                        `;
                        
                        achievementGrid.appendChild(achievementEl);
                    }
                    
                    container.appendChild(achievementGrid);
                }
            }

            // 顯示積分通知
            function showPointNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'point-notification';
                notification.innerHTML = `<span>🖌️</span> ${message}`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // 顯示升級通知
            function showLevelUpNotification(level, levelName) {
                const notification = document.createElement('div');
                notification.className = 'level-up-notification';
                notification.innerHTML = `
                    <div>🎉 恭喜升級！</div>
                    <div>等級 ${level}: ${levelName}</div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3500);
            }

            // 顯示成就通知
            function showAchievementNotification(achievement) {
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-title">${achievement.icon} ${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }

            // 初始化積分系統
            loadPlayerData();

            // 設置成就模態窗口事件監聽器
            function setupAchievementsModal() {
                const viewAllBtn = document.getElementById('view-all-achievements');
                const modal = document.getElementById('achievements-modal');
                const closeBtn = document.getElementById('achievements-modal-close');

                // 打開模態窗口
                viewAllBtn.addEventListener('click', () => {
                    updateFullAchievementsDisplay();
                    modal.style.display = 'flex';
                });

                // 關閉模態窗口
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                // 點擊背景關閉模態窗口
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });

                // ESC鍵關閉模態窗口
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
            }

            // 初始化成就模態窗口
            setupAchievementsModal();
            
            // 獲取所有DOM元素（必須在函數定義之前）
            const navLookup = document.getElementById('nav-lookup');
            const navWordLookup = document.getElementById('nav-word-lookup');
            const navPractice = document.getElementById('nav-practice');
            const navMemory = document.getElementById('nav-memory');
            const navRadical = document.getElementById('nav-radical');
            
            const characterDisplaySection = document.getElementById('character-display-section');
            const wordLookupContainer = document.getElementById('word-lookup-container');
            const quizContainer = document.getElementById('quiz-container');
            const memoryGameContainer = document.getElementById('memory-game-container');
            const radicalGameContainer = document.getElementById('radical-game-container');
            
            // 切換主導航頁面
            function switchMainFunction(activeButton, activeSection) {
                // 重置所有按鈕的激活狀態
                [navLookup, navWordLookup, navPractice, navMemory, navRadical].forEach(button => {
                    button.classList.remove('active');
                });
                
                // 隱藏所有功能區域
                [characterDisplaySection, wordLookupContainer, quizContainer, memoryGameContainer, radicalGameContainer].forEach(section => {
                    section.style.display = 'none';
                });
                
                // 激活選中的按鈕和區域
                activeButton.classList.add('active');
                
                // 根據不同的功能區域設置正確的display值
                if (activeSection === quizContainer) {
                    activeSection.style.display = 'block';  // 筆順大師使用block布局
                } else {
                    activeSection.style.display = 'flex';   // 其他功能區域使用flex布局
                }
                
                // 處理搜索框和字符選擇器的顯示/隱藏
                const searchSection = document.getElementById('character-search-section');
                if (activeSection === characterDisplaySection) {
                    // 在筆順查詢頁面顯示搜索框
                    searchSection.style.display = 'block';
                    // 保持字符選擇器的當前狀態（不強制隱藏）
                } else {
                    // 在其他頁面隱藏搜索框和字符選擇器
                    searchSection.style.display = 'none';
                    hideCharacterSelector();
                }
                
                // 根據不同頁面啟動對應功能
                if (activeSection === memoryGameContainer) {
                    // 啟動記憶遊戲，使用隨機選取的字而不是當前字符
                    startIndependentMemoryGame();
                } else if (activeSection === radicalGameContainer) {
                    // 若切換到部首組字，初始化部首組字遊戲
                    startRadicalGame();
                }
                // 移除筆順練習的自動啟動，讓外部控制何時啟動
            }
            
            // 添加一個標記來避免衝突
            let preventAutoStart = false;
            
            // 設置主導航事件監聽器
            navLookup.addEventListener('click', function() {
                switchMainFunction(navLookup, characterDisplaySection);
                // 記錄功能使用
                playerData.functionsUsed.add('stroke_lookup');
                checkAchievement('explorer');
            });
            
            navWordLookup.addEventListener('click', function() {
                switchMainFunction(navWordLookup, wordLookupContainer);
                // 記錄功能使用
                playerData.functionsUsed.add('word_lookup_page');
                checkAchievement('explorer');
            });
            
            navPractice.addEventListener('click', function() {
                switchMainFunction(navPractice, quizContainer);
                // 記錄功能使用
                playerData.functionsUsed.add('practice_page');
                checkAchievement('explorer');
                // 只有在沒有設置防止自動啟動標記時才啟動隨機練習
                if (!preventAutoStart) {
                    setTimeout(() => {
                        startIndependentQuizMode();
                    }, 100);
                } else {
                    // 重置標記
                    preventAutoStart = false;
                }
            });
            
            navMemory.addEventListener('click', function() {
                switchMainFunction(navMemory, memoryGameContainer);
                // 記錄功能使用
                playerData.functionsUsed.add('memory_page');
                checkAchievement('explorer');
            });
            // 獲取DOM元素
            const characterInput = document.getElementById('character-input');
            const searchButton = document.getElementById('search-button');
            const characterDisplay = document.getElementById('character-display');
            const characterSelector = document.getElementById('character-selector');
            const characterButtons = document.getElementById('character-buttons');
            const pinyinDisplay = document.getElementById('pinyin-display');
            const characterDefinition = document.getElementById('character-definition');
            const definitionContent = document.getElementById('definition-content');
            const definitionLoading = document.getElementById('definition-loading');
            const strokeCount = document.getElementById('stroke-count');
            const animateButton = document.getElementById('animate-button');
            const speakButton = document.getElementById('speak-button');
            const quizButton = document.getElementById('quiz-button');
            const errorMessage = document.getElementById('error-message');
            const loader = document.getElementById('loader');
            const characterTarget = document.getElementById('character-target');
            
            // 字詞查詢相關元素
            const wordInput = document.getElementById('word-input');
            const wordSearchButton = document.getElementById('word-search-button');
            const wordErrorMessage = document.getElementById('word-error-message');
            const wordLoader = document.getElementById('word-loader');
            const wordResultSection = document.getElementById('word-result-section');
            const wordTitle = document.getElementById('word-title');
            const wordPronunciation = document.getElementById('word-pronunciation');
            const wordSpeakButton = document.getElementById('word-speak-button');
            const wordPracticeButton = document.getElementById('word-practice-button');
            const wordDefinition = document.getElementById('word-definition');
            const wordDefinitionContent = document.getElementById('word-definition-content');
            const wordDefinitionLoading = document.getElementById('word-definition-loading');
            
            // 遊戲相關元素
            const quizResult = document.getElementById('quiz-result');

            const quizRetry = document.getElementById('quiz-retry');
            const quizHint = document.getElementById('quiz-hint');
            const quizProgress = document.getElementById('quiz-progress');
            const quizTargetField = document.getElementById('quiz-target-field');
            const strokeHint = document.getElementById('stroke-hint');
            const strokeAnimationHint = document.getElementById('stroke-animation-hint');
            
            // 記憶遊戲相關元素
            const memoryCharacters = document.getElementById('memory-characters');
            const memoryOptions = document.getElementById('memory-options');
            const memoryTimer = document.getElementById('memory-timer');
            const memoryStart = document.getElementById('memory-start');
            const memoryResult = document.getElementById('memory-result');
            const levelButtons = document.querySelectorAll('#memory-game-container .level-btn');
            
            // 不需要選項卡相關元素，已移除舊的選項卡功能
            
            // 學習記錄
            let learnedCharacters = [];
            let currentCharacterId = 0;
            let currentCharacter = '';
            let writer = null;
            let quizWriter = null;
            let hintTimer = null;
            
            // 記憶遊戲狀態
            let memoryGameActive = false;
            let memoryLevel = 3;
            let memoryTargetChars = [];
            let memorySelectedChars = [];
            let memoryTimer_id = null;
            let memoryOptionElements = [];  // 存储选项元素的引用
            let memorySelectionStartTime = null;  // 記錄用戶開始選字的時間
            let memorySelectionDuration = 0;  // 記錄用戶選字所用時間（秒）
            

            
            // 常用漢字列表（适合小學生學習的基礎漢字）
            const commonCharacters = [
                '一', '二', '三', '四', '五', '六', '七', '八', '九', '十',
                '人', '大', '小', '中', '天', '地', '日', '月', '水', '火',
                '木', '金', '土', '山', '石', '田', '口', '手', '足', '目',
                '耳', '心', '女', '子', '好', '文', '字', '學', '生', '先',
                '花', '草', '魚', '鳥', '羊', '馬', '牛', '豬', '米', '茶'
            ];
            
            // 檢查是否為中文字
            function isChineseCharacter(char) {
                return /[\u4e00-\u9fa5]/.test(char);
            }
            
            // 檢查是否全為中文字符
            function isAllChineseCharacters(text) {
                return /^[\u4e00-\u9fa5]+$/.test(text);
            }
            
            // 提取文本中的所有中文字符
            function extractChineseCharacters(text) {
                const matches = text.match(/[\u4e00-\u9fa5]/g);
                return matches ? [...new Set(matches)] : []; // 去重
            }
            
            // 查詢萌典API獲取字義
            async function fetchCharacterDefinition(character) {
                try {
                    // 顯示加載狀態
                    characterDefinition.style.display = 'block';
                    characterDefinition.style.opacity = '1';
                    characterDefinition.style.transform = 'translateY(0)';
                    characterDefinition.style.transition = 'none';
                    definitionLoading.style.display = 'block';
                    definitionContent.innerHTML = '';
                    
                    const response = await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(character)}`);
                    
                    if (!response.ok) {
                        throw new Error('查詢失敗');
                    }
                    
                    const data = await response.json();
                    
                    // 調試：打印完整數據結構
                    console.log('萌典API返回數據:', JSON.stringify(data, null, 2));
                    
                    displayCharacterDefinition(data);
                } catch (error) {
                    console.error('萌典API查詢錯誤:', error);
                    definitionContent.innerHTML = '<div class="definition-item"><span class="definition-text">暫時無法獲取字義解釋</span></div>';
                } finally {
                    definitionLoading.style.display = 'none';
                }
            }
            
                            // 顯示字義解釋
            function displayCharacterDefinition(data) {
                if (!data || !data.heteronyms || data.heteronyms.length === 0) {
                    definitionContent.innerHTML = '<div class="definition-item"><div class="definition-text">未找到字義資料</div></div>';
                    // 添加漸入動畫
                    characterDefinition.style.opacity = '0';
                    characterDefinition.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        characterDefinition.style.transition = 'all 0.4s ease-out';
                        characterDefinition.style.opacity = '1';
                        characterDefinition.style.transform = 'translateY(0)';
                    }, 100);
                    return;
                }
                
                let html = '';
                
                // 遍歷所有讀音和釋義
                data.heteronyms.forEach((heteronym, index) => {
                    if (heteronym.definitions && heteronym.definitions.length > 0) {
                        // 顯示拼音（如果有的話）
                        const pinyin = heteronym.pinyin || '';
                        if (pinyin && index === 0) {
                            // 更新主要的拼音顯示
                            pinyinDisplay.textContent = pinyin;
                            // 保存到查詢歷史以供字詞本使用
                            lastLookedUpCharacterPinyin = pinyin;
                        }
                        
                        // 遍歷所有釋義
                        heteronym.definitions.forEach((def, defIndex) => {
                            html += '<div class="definition-item">';
                            
                            // 詞性標籤和中文釋義內容在同一行
                            html += '<div class="definition-main">';
                            if (def.type) {
                                html += `<span class="definition-type">${def.type}</span>`;
                            }
                            if (def.def) {
                                html += `<span class="definition-text">${def.def}</span>`;
                            }
                            html += '</div>';
                            
                            // 英文釋義
                            if (def.english) {
                                html += `<div class="definition-english">🇺🇸 ${def.english}</div>`;
                            }
                            
                            // 檢查是否有其他格式的英文釋義
                            if (def.en) {
                                html += `<div class="definition-english">🇺🇸 ${def.en}</div>`;
                            }
                            
                            // 例句顯示 - 檢查多種可能的例句字段
                            const examples = [];
                            
                            // 檢查 example 字段
                            if (def.example) {
                                if (Array.isArray(def.example)) {
                                    examples.push(...def.example);
                                } else if (typeof def.example === 'string') {
                                    examples.push(def.example);
                                }
                            }
                            
                            // 檢查 quote 字段
                            if (def.quote) {
                                if (Array.isArray(def.quote)) {
                                    examples.push(...def.quote);
                                } else if (typeof def.quote === 'string') {
                                    examples.push(def.quote);
                                }
                            }
                            
                            // 檢查 synonyms 相關的例句
                            if (def.synonyms && Array.isArray(def.synonyms)) {
                                def.synonyms.forEach(syn => {
                                    if (syn.example) {
                                        if (Array.isArray(syn.example)) {
                                            examples.push(...syn.example);
                                        } else if (typeof syn.example === 'string') {
                                            examples.push(syn.example);
                                        }
                                    }
                                });
                            }
                            
                            // 顯示例句（最多2個）
                            examples.slice(0, 2).forEach(example => {
                                if (example && example.trim()) {
                                    // 移除HTML標籤，只保留純文本，並清理多餘空格
                                    let cleanExample = example.replace(/<[^>]*>/g, '').trim();
                                    
                                    // 限制例句長度，避免過長
                                    if (cleanExample.length > 50) {
                                        cleanExample = cleanExample.substring(0, 47) + '...';
                                    }
                                    
                                    html += `<div class="definition-example">${cleanExample}</div>`;
                                }
                            });
                            
                            html += '</div>';
                        });
                    }
                });
                
                if (html) {
                    definitionContent.innerHTML = html;
                } else {
                    definitionContent.innerHTML = '<div class="definition-item"><div class="definition-text">未找到詳細釋義</div></div>';
                }
                
                // 添加漸入動畫
                characterDefinition.style.opacity = '0';
                characterDefinition.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    characterDefinition.style.transition = 'all 0.4s ease-out';
                    characterDefinition.style.opacity = '1';
                    characterDefinition.style.transform = 'translateY(0)';
                }, 100);
            }
            
            // 顯示加載動畫
            function showLoader() {
                loader.classList.add('active');
            }
            
            // 隱藏加載動畫
            function hideLoader() {
                loader.classList.remove('active');
            }
            
            // 創建字符選擇器
            function createCharacterSelector(characters) {
                characterButtons.innerHTML = '';
                
                characters.forEach((char, index) => {
                    const button = document.createElement('button');
                    button.className = 'character-btn';
                    button.textContent = char;
                    button.dataset.character = char;
                    
                    // 設置第一個字符為激活狀態
                    if (index === 0) {
                        button.classList.add('active');
                    }
                    
                    // 點擊事件
                    button.addEventListener('click', function() {
                        // 移除其他按鈕的激活狀態
                        characterButtons.querySelectorAll('.character-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        
                        // 激活當前按鈕
                        this.classList.add('active');
                        
                        // 切換到這個字符
                        switchToCharacter(char);
                    });
                    
                    characterButtons.appendChild(button);
                });
                
                // 顯示選擇器
                characterSelector.style.display = 'block';
                }
                
            // 隱藏字符選擇器
            function hideCharacterSelector() {
                characterSelector.style.display = 'none';
                characterButtons.innerHTML = '';
                // 同時隱藏字義解釋區
                characterDefinition.style.display = 'none';
            }
            
            // 切換到指定字符
            function switchToCharacter(character) {
                currentCharacter = character;
                currentSearchCharacter = character; // 更新當前搜索的字符
                
                // 保存到字詞本查詢歷史
                lastLookedUpCharacter = character;
                lastLookedUpCharacterPinyin = ''; // 將從萌典API獲取
                
                // 更新顯示的漢字和拼音
                characterDisplay.textContent = character;
                pinyinDisplay.textContent = ''; // 拼音將從萌典API獲取並更新
                
                showLoader();
                
                // 清理writer
                cleanupWriter('main');
                
                // 清空並添加新容器
                characterTarget.innerHTML = '';
                
                // 更新收藏按鈕狀態
                updateFavoriteButtonState('character', character);
                
                // 初始化漢字筆順
                writer = HanziWriter.create('character-target', character, {
                    width: window.innerWidth > 768 ? 240 : 220,  // 調整為與田字格一致
                    height: window.innerWidth > 768 ? 240 : 220,  // 調整為與田字格一致
                    padding: 20,  // 增加內邊距確保漢字在田字格內
                    strokeColor: '#232D52',
                    outlineColor: '#DDD8C8',
                    strokeAnimationSpeed: 1,
                    delayBetweenStrokes: 1000,
                    radicalColor: '#8E3E1A',
                    onLoadCharDataSuccess: function() {
                        hideLoader();
                        
                        // 顯示筆畫數
                        if (writer && writer._char && writer._char.strokes) {
                            const totalStrokes = writer._char.strokes.length;
                            strokeCount.textContent = `筆畫數：${totalStrokes}`;
                            updateQuizProgressSteps(totalStrokes);
                        }
                        
                        // 自動播放筆順動畫
                        writer.animateCharacter();
                        
                        // 添加到學習記錄
                        addToLearnedCharacters(character);
                        
                        // 墨寶積分系統 - 字符查詢獎勵
                        playerData.totalCharactersLearned++;
                        playerData.statistics.charactersToday++;
                        playerData.functionsUsed.add('character_lookup');
                        
                        // 首次查詢獎勵
                        if (!playerData.firstTimeActions.has('first_character')) {
                            playerData.firstTimeActions.add('first_character');
                            checkAchievement('first_character');
                        }
                        
                        // 查詢積分獎勵
                        awardPoints(pointRewards.characterLookup, `查詢漢字 +${pointRewards.characterLookup} 🖌️`);
                        
                        // 檢查學習里程成就
                        checkAchievement('char_collector');
                        checkAchievement('char_scholar');
                        checkAchievement('char_master');
                        
                        // 檢查時間相關成就
                        checkAchievement('night_owl');
                        checkAchievement('early_bird');
                        
                        // 更新成就
                        updateAchievements();
                        
                        // 查詢字義解釋
                        fetchCharacterDefinition(character);
                    },
                    onLoadCharDataError: function() {
                        hideLoader();
                        alert('找不到這個漢字的筆順資料，請嘗試其他漢字');
                        
                        // 即使筆順資料失敗，也嘗試查詢字義
                        fetchCharacterDefinition(character);
                    }
                });
            }
            
            // 查詢漢字
            function queryCharacter() {
                const inputText = characterInput.value.trim();
                
                // 驗證輸入
                if (!inputText) {
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = '請輸入漢字';
                    return;
                }
                
                // 提取中文字符
                const chineseCharacters = extractChineseCharacters(inputText);
                
                if (chineseCharacters.length === 0) {
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = '請輸入有效的中文字';
                    return;
                }
                
                if (chineseCharacters.length > 20) {
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = '最多只能輸入20個漢字';
                    return;
                }
                
                // 隱藏筆順挑戰模式和記憶遊戲，顯示一般模式
                showNormalMode();
                
                // 隱藏錯誤訊息
                errorMessage.style.display = 'none';
                
                if (chineseCharacters.length === 1) {
                    // 單個字符，隱藏選擇器，直接顯示
                    hideCharacterSelector();
                    switchToCharacter(chineseCharacters[0]);
                } else {
                    // 多個字符，顯示選擇器
                    createCharacterSelector(chineseCharacters);
                    // 默認顯示第一個字符
                    switchToCharacter(chineseCharacters[0]);
                }
            }
            
            // 清理writer實例
            function cleanupWriter(type) {
                if (type === 'main' || type === 'all') {
                    // 清理主顯示區的writer
                    if (writer) {
                        try {
                            if (writer.isLoadingCharData) {
                                console.log('主显示区正在加载数据，无法清理');
                                return;
                            }
                            
                            if (typeof writer.cancelQuiz === 'function') {
                                writer.cancelQuiz();
                            }
                            if (typeof writer.hideCharacter === 'function') {
                                writer.hideCharacter();
                            }
                            writer = null;
                        } catch (e) {
                            console.error('清理writer時出錯:', e);
                        }
                    }
                }
                
                if (type === 'quiz' || type === 'all') {
                    // 清理練習區的writer
                    if (quizWriter) {
                        try {
                            if (quizWriter.isLoadingCharData) {
                                console.log('练习区正在加载数据，无法清理');
                                return;
                            }
                            
                            if (typeof quizWriter.cancelQuiz === 'function') {
                                quizWriter.cancelQuiz();
                            }
                            if (typeof quizWriter.hideCharacter === 'function') {
                                quizWriter.hideCharacter();
                            }
                            quizWriter = null;
                        } catch (e) {
                            console.error('清理quizWriter時出錯:', e);
                        }
                    }
                }
                
                // 清除提示定时器
                if (hintTimer) {
                    clearInterval(hintTimer);
                    hintTimer = null;
                }
            }
            
            // 朗讀當前漢字
            function speakCharacter() {
                const character = characterDisplay.textContent;
                if (!character) return;
                
                if ('speechSynthesis' in window) {
                    // 創建語音實例
                    const utterance = new SpeechSynthesisUtterance(character);
                    
                    // 設置語言為中文
                    utterance.lang = 'zh-TW';
                    
                    // 嘗試找到中文語音
                    const voices = speechSynthesis.getVoices();
                    const chineseVoice = voices.find(voice => 
                        voice.lang.includes('zh') || 
                        voice.lang.includes('cmn') || 
                        voice.lang.includes('yue')
                    );
                    
                    if (chineseVoice) {
                        utterance.voice = chineseVoice;
                    }
                    
                    // 朗讀速度調慢一點
                    utterance.rate = 0.8;
                    utterance.pitch = 1.2;  // 提高音調，更適合兒童
                    
                    // 播放語音
                    speechSynthesis.speak(utterance);
                    
                    // 添加彈跳效果
                    characterDisplay.classList.add('bounce');
                    setTimeout(() => {
                        characterDisplay.classList.remove('bounce');
                    }, 1000);
                } else {
                    alert('抱歉，您的瀏覽器不支持語音功能');
                }
            }
            
            // 啟動筆順練習模式 - 獨立模式，不需要先查詢漢字
            function startIndependentQuizMode() {
                // 隨機選擇一個漢字進行練習
                const randomChar = getRandomCharacter();
                currentCharacter = randomChar;
                
                showLoader();
                
                // 清理之前的quizWriter
                cleanupWriter('quiz');
                
                // 清空練習區域並創建新的容器
                quizTargetField.innerHTML = '';
                
                // 只需要處理quiz容器內部的元素狀態，不需要重複設置容器的顯示狀態
                // 因為switchMainFunction已經處理了容器的顯示/隱藏
                quizResult.style.display = 'none';
                
                // 隱藏提示
                strokeHint.style.display = 'none';
                strokeAnimationHint.classList.remove('visible');
                
                console.log('开始创建quizWriter，字符:', currentCharacter);
                
                // 创建新的笔顺练习实例
                quizWriter = HanziWriter.create('quiz-target-field', currentCharacter, {
                    width: window.innerWidth > 768 ? 240 : 220,  // 調整為與田字格一致
                    height: window.innerWidth > 768 ? 240 : 220,  // 調整為與田字格一致
                    padding: 20,  // 增加內邊距確保漢字在田字格內
                    strokeColor: '#232D52',
                    outlineColor: '#DDD8C8',
                    radicalColor: '#8E3E1A',
                    drawingWidth: 25, // 增加笔画宽度使点击更容易
                    drawingColor: '#8E3E1A', // 用户绘制笔画的颜色
                    showOutline: true, // 显示轮廓
                    onLoadCharDataSuccess: function() {
                        console.log('quizWriter加载成功');
                        hideLoader();
                        
                        // 獲取總筆畫數並更新進度條
                        if (quizWriter && quizWriter._char && quizWriter._char.strokes) {
                            const totalStrokes = quizWriter._char.strokes.length;
                            updateQuizProgressSteps(totalStrokes);
                            console.log('总笔画数:', totalStrokes);
                        }
                        
                        // 启动笔顺练习
                        startQuizPractice();
                    },
                    onLoadCharDataError: function(err) {
                        console.error('加载失败:', err);
                        hideLoader();
                        alert('無法載入筆順練習數據，將嘗試其他漢字');
                        // 再嘗試另一個漢字
                        challengeNextCharacter();
                    }
                });
            }
            
            // 現在也保留舊的 startQuizMode 用於筆順查詢中的練習功能
            function startQuizMode() {
                if (!currentCharacter) {
                    startIndependentQuizMode();
                    return;
                }
                
                showLoader();
                
                // 清理之前的quizWriter
                cleanupWriter('quiz');
                
                // 清空練習區域並創建新的容器
                quizTargetField.innerHTML = '';
                
                // 只需要處理quiz容器內部的元素狀態，不需要重複設置容器的顯示狀態
                // 因為switchMainFunction已經處理了容器的顯示/隱藏
                quizResult.style.display = 'none';
                
                // 隱藏提示
                strokeHint.style.display = 'none';
                strokeAnimationHint.classList.remove('visible');
                
                console.log('开始创建quizWriter，字符:', currentCharacter);
                
                // 创建新的笔顺练习实例
                quizWriter = HanziWriter.create('quiz-target-field', currentCharacter, {
                    width: window.innerWidth > 768 ? 240 : 220,  // 調整為與田字格一致
                    height: window.innerWidth > 768 ? 240 : 220,  // 調整為與田字格一致
                    padding: 20,  // 增加內邊距確保漢字在田字格內
                    strokeColor: '#232D52',
                    outlineColor: '#DDD8C8',
                    radicalColor: '#8E3E1A',
                    drawingWidth: 25, // 增加笔画宽度使点击更容易
                    drawingColor: '#8E3E1A', // 用户绘制笔画的颜色
                    showOutline: true, // 显示轮廓
                    onLoadCharDataSuccess: function() {
                        console.log('quizWriter加载成功');
                        hideLoader();
                        
                        // 獲取總筆畫數並更新進度條
                        if (quizWriter && quizWriter._char && quizWriter._char.strokes) {
                            const totalStrokes = quizWriter._char.strokes.length;
                            updateQuizProgressSteps(totalStrokes);
                            console.log('总笔画数:', totalStrokes);
                        }
                        
                        // 启动笔顺练习
                        startQuizPractice();
                    },
                    onLoadCharDataError: function(err) {
                        console.error('加载失败:', err);
                        hideLoader();
                        alert('無法載入筆順練習數據，請嘗試其他漢字');
                        showNormalMode();
                    }
                });
            }
            
            // 启动笔顺练习
            function startQuizPractice() {
                if (!quizWriter) {
                    console.error('quizWriter不存在，无法启动练习');
                    return;
                }
                
                console.log('启动笔顺练习');
                
                // 显示引导提示
                showStrokeHint(0);
                
                // 启动Quiz模式
                quizWriter.quiz({
                    showHintAfterMisses: 1, // 错一次就显示提示
                    highlightOnComplete: true, // 完成时高亮显示整个字符
                    strokeHighlightSpeed: 2, // 高亮速度
                    drawingFadeDuration: 600, // 用户绘制的笔画淡出时间
                    onMistake: function(strokeNumber) {
                        console.log('用户点击错误，笔画索引:', strokeNumber);
                        // 震动提示
                        if (navigator.vibrate) {
                            navigator.vibrate(100);
                        }
                        
                        // 显示提示
                        showStrokeHint(strokeNumber);
                    },
                    onCorrectStroke: function(strokeNumber, mistakesOnStroke) {
                        console.log('用户点击正确，笔画索引:', strokeNumber, '错误次数:', mistakesOnStroke);
                        // 更新進度
                        updateQuizProgress(strokeNumber);
                        
                        // 移动提示到下一笔
                        setTimeout(() => {
                            showStrokeHint(strokeNumber + 1);
                        }, 300);
                    },
                    onComplete: function() {
                        console.log('完成所有笔画');
                        // 隐藏提示
                        hideStrokeHint();
                        
                        // 显示结果
                        showQuizResult(true);
                        
                        // 墨寶積分系統 - 筆順練習獎勵
                        playerData.totalStrokePractices++;
                        playerData.statistics.practiceToday++;
                        playerData.functionsUsed.add('stroke_practice');
                        
                        // 筆順練習積分獎勵
                        awardPoints(pointRewards.strokePractice, `筆順練習 +${pointRewards.strokePractice} 🖌️`);
                        
                        // 檢查筆順練習成就
                        checkAchievement('stroke_beginner');
                        checkAchievement('stroke_intermediate');
                        checkAchievement('stroke_advanced');
                        checkAchievement('stroke_master');
                        
                        // 更新成就
                        addToLearnedCharacters(currentCharacter);
                        updateAchievements();
                    }
                });
            }
            
            // 显示笔画提示
            function showStrokeHint(strokeNumber) {
                // 停止之前的提示定时器
                if (hintTimer) {
                    clearInterval(hintTimer);
                    hintTimer = null;
                }
                
                // 如果已经完成所有笔画，隐藏提示
                if (!quizWriter || !quizWriter._char || 
                    !quizWriter._char.strokes || 
                    strokeNumber >= quizWriter._char.strokes.length) {
                    hideStrokeHint();
                    return;
                }
                
                // 获取笔画开始位置
                const stroke = quizWriter._char.strokes[strokeNumber];
                if (!stroke) {
                    console.error('无法获取笔画:', strokeNumber);
                    return;
                }
                
                // 获取笔画开始坐标
                const startPoint = stroke.getStartingPoint();
                const width = window.innerWidth > 768 ? 240 : 220;  // 與HanziWriter尺寸一致
                const padding = 20;  // 與HanziWriter padding一致
                const startX = (startPoint.x * (width - padding * 2) / 1024) + padding;
                const startY = (startPoint.y * (width - padding * 2) / 1024) + padding;
                
                // 设置提示位置
                strokeHint.style.left = `${startX - 15}px`;
                strokeHint.style.top = `${startY - 15}px`;
                strokeHint.style.display = 'block';
                
                // 显示文字提示
                strokeAnimationHint.classList.add('visible');
                
                // 定时移动提示，模拟笔画轨迹
                let progress = 0;
                const points = stroke.points;
                
                hintTimer = setInterval(() => {
                    progress += 0.05;
                    if (progress > 1) progress = 0;
                    
                    const idx = Math.floor(progress * (points.length - 1));
                    const point = points[idx];
                    
                    const x = (point.x * (width - padding * 2) / 1024) + padding;
                    const y = (point.y * (width - padding * 2) / 1024) + padding;
                    
                    strokeHint.style.left = `${x - 15}px`;
                    strokeHint.style.top = `${y - 15}px`;
                }, 100);
            }
            
            // 隐藏笔画提示
            function hideStrokeHint() {
                strokeHint.style.display = 'none';
                strokeAnimationHint.classList.remove('visible');
                
                if (hintTimer) {
                    clearInterval(hintTimer);
                    hintTimer = null;
                }
            }
            
            // 回到一般顯示模式
            function showNormalMode() {
                // 點擊頂部導航，切換到筆順查詢
                navLookup.click();
            }
            
            // 重設筆順練習模式
            function resetQuizMode() {
                // 隱藏結果
                quizResult.style.display = 'none';
                
                // 重新启动笔顺练习
                startQuizMode();
            }
            
            // 更新筆順練習進度條數量
            function updateQuizProgressSteps(totalStrokes) {
                // 清空進度條
                quizProgress.innerHTML = '';
                
                // 創建進度步驟元素
                for (let i = 0; i < totalStrokes; i++) {
                    const step = document.createElement('div');
                    step.className = 'quiz-progress-level';
                    step.textContent = `第${i+1}筆`;
                    if (i === 0) step.classList.add('active');
                    quizProgress.appendChild(step);
                }
            }
            
            // 更新筆順練習進度
            function updateQuizProgress(currentStroke) {
                const steps = document.querySelectorAll('.quiz-progress-level');
                
                steps.forEach((step, index) => {
                    if (index <= currentStroke) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
            }
            
            // 顯示筆順練習結果
            function showQuizResult(success) {
                quizResult.style.display = 'block';
                
                if (success) {
                    quizResult.className = 'quiz-result success';
                    quizResult.querySelector('.quiz-result-message').textContent = '真棒！你完成了這個漢字！';
                    quizResult.querySelector('.quiz-result-detail').textContent = 
                        `你成功按照正確的筆順完成了「${currentCharacter}」字！`;
                    
                    // 播放成功音效
                    playSuccessSound();
                } else {
                    quizResult.className = 'quiz-result error';
                    quizResult.querySelector('.quiz-result-message').textContent = '加油！再試一次！';
                    quizResult.querySelector('.quiz-result-detail').textContent = 
                        '記住筆順的正確順序，慢慢寫會更容易記住哦！';
                }
            }
            
            // 播放成功音效
            function playSuccessSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // 創建振盪器
                    const oscillator1 = audioContext.createOscillator();
                    const oscillator2 = audioContext.createOscillator();
                    const oscillator3 = audioContext.createOscillator();
                    
                    // 創建音量控制
                    const gainNode = audioContext.createGain();
                    gainNode.gain.value = 0.1;  // 設置較低的音量
                    
                    // 連接振盪器到音量控制
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    oscillator3.connect(gainNode);
                    
                    // 連接音量控制到輸出
                    gainNode.connect(audioContext.destination);
                    
                    // 設置音頻參數
                    oscillator1.type = 'sine';
                    oscillator2.type = 'sine';
                    oscillator3.type = 'sine';
                    
                    oscillator1.frequency.value = 523.25;  // C5
                    oscillator2.frequency.value = 659.25;  // E5
                    oscillator3.frequency.value = 783.99;  // G5
                    
                    // 設置音量逐漸降低
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.5);
                    
                    // 開始播放
                    oscillator1.start();
                    oscillator2.start(audioContext.currentTime + 0.1);
                    oscillator3.start(audioContext.currentTime + 0.2);
                    
                    // 停止播放
                    oscillator1.stop(audioContext.currentTime + 1.5);
                    oscillator2.stop(audioContext.currentTime + 1.5);
                    oscillator3.stop(audioContext.currentTime + 1.5);
                } catch(e) {
                    console.error('播放音效失敗:', e);
                }
            }
            
            // 添加到學習記錄 (僅内存存儲)
            function addToLearnedCharacters(character) {
                if (!learnedCharacters.includes(character)) {
                    learnedCharacters.push(character);
                    console.log('字符已添加到學習記錄:', character);
                }
            }
            
            // 載入學習記錄 (在沙盒环境中无法使用 localStorage)
            function loadLearnedCharacters() {
                // 在沙盒環境中，學習記錄僅保存在當前會話中
                console.log('初始化學習記錄');
                // 可以预设一些字符作为初始学习记录
                if (learnedCharacters.length === 0) {
                    learnedCharacters = ['人'];
                }
            }
            
            // 更新成就
            function updateAchievements() {
                const uniqueCharsCount = learnedCharacters.length;
                
                // 更新所有成就進度
                document.querySelectorAll('.achievement').forEach(achievement => {
                    const progressElement = achievement.querySelector('.achievement-progress');
                    const nameElement = achievement.querySelector('.achievement-name');
                    
                    if (nameElement.textContent === '筆順新手') {
                        progressElement.textContent = `${Math.min(uniqueCharsCount, 1)}/1`;
                        if (uniqueCharsCount >= 1) {
                            achievement.classList.remove('locked');
                        }
                    } else if (nameElement.textContent === '筆順高手') {
                        progressElement.textContent = `${Math.min(uniqueCharsCount, 5)}/5`;
                        if (uniqueCharsCount >= 5) {
                            achievement.classList.remove('locked');
                        }
                    } else if (nameElement.textContent === '筆順達人') {
                        progressElement.textContent = `${Math.min(uniqueCharsCount, 10)}/10`;
                        if (uniqueCharsCount >= 10) {
                            achievement.classList.remove('locked');
                        }
                    } else if (nameElement.textContent === '筆順大師') {
                        progressElement.textContent = `${Math.min(uniqueCharsCount, 25)}/25`;
                        if (uniqueCharsCount >= 25) {
                            achievement.classList.remove('locked');
                        }
                    } else if (nameElement.textContent === '筆順王者') {
                        progressElement.textContent = `${Math.min(uniqueCharsCount, 50)}/50`;
                        if (uniqueCharsCount >= 50) {
                            achievement.classList.remove('locked');
                        }
                    }
                });
            }
            
            // 移除了選項卡切換功能，因為新界面不再使用選項卡
            
            // 啟動記憶遊戲 - 獨立功能，不依賴筆順查詢
            function startIndependentMemoryGame() {
                // 顯示記憶遊戲界面
                characterDisplaySection.style.display = 'none';
                quizContainer.style.display = 'none';
                memoryGameContainer.style.display = 'block';
                
                // 重置遊戲到初始狀態
                resetMemoryGame();
            }
            
            // 保留舊函數用於筆順查詢使用
            function startMemoryGame() {
                startIndependentMemoryGame();
            }
            
            // 開始記憶遊戲挑戰
            function startMemoryChallenge() {
                // 檢查memoryLevel是否為有效數字，如果不是則重置為3
                if (isNaN(memoryLevel) || memoryLevel < 3) {
                    memoryLevel = 3;
                    console.warn('memoryLevel無效，重置為默認值3');
                }
                
                // 重置游戏状态
                memoryGameActive = true;
                memorySelectedChars = [];  // 确保清空之前的选择
                
                // 更新按鈕狀態
                updateMemoryButton();
                
                // 清除上一轮选项的选中状态
                memoryOptionElements.forEach(option => {
                    option.classList.remove('selected');
                });
                
                // 清空结果显示
                memoryResult.style.display = 'none';
                
                // 清空选项区域，移除所有之前的选项
                memoryOptions.innerHTML = '';
                memoryOptionElements = [];
                
                // 從常用漢字中隨機選擇目標字符
                memoryTargetChars = getRandomCharacters(memoryLevel);
                
                // 顯示目標字符，根據難度調整排列方式
                memoryCharacters.innerHTML = '';
                
                if (memoryLevel === 5) {
                    // 5字挑戰顯示在一行
                    memoryCharacters.style.gridTemplateColumns = 'repeat(5, 60px)';
                } else if (memoryLevel === 8) {
                    // 8字挑戰分為兩行，每行4個
                    memoryCharacters.style.gridTemplateColumns = 'repeat(4, 60px)';
                } else {
                    // 3字挑戰使用默認排列
                    memoryCharacters.style.gridTemplateColumns = 'repeat(3, 60px)';
                }
                
                // 添加目標字符到顯示區
                memoryTargetChars.forEach(char => {
                    const charElement = document.createElement('div');
                    charElement.className = 'memory-character';
                    charElement.textContent = char;
                    memoryCharacters.appendChild(charElement);
                });
                
                // 開始倒計時
                let timeLeft = 5; // 5秒記憶時間
                memoryTimer.textContent = `記憶時間：${timeLeft}秒`;
                
                memoryTimer_id = setInterval(() => {
                    timeLeft--;
                    memoryTimer.textContent = `記憶時間：${timeLeft}秒`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(memoryTimer_id);
                        hideCharactersAndShowOptions();
                    }
                }, 1000);
            }
            
            // 隱藏字符並顯示選項
            function hideCharactersAndShowOptions() {
                // 隱藏目標字符
                const charElements = document.querySelectorAll('.memory-character');
                charElements.forEach(el => {
                    el.classList.add('hidden');
                    el.textContent = '?';
                });
                
                // 記錄開始選擇的時間
                memorySelectionStartTime = new Date();
                
                // 開始計時並顯示
                updateSelectionTimer();
                
                // 根據難度級別設定待選字數量
                let totalOptionsCount;
                let columnsPerRow;
                
                if (memoryLevel === 3) {
                    totalOptionsCount = 9;   // 3字挑戰顯示9個選項
                    columnsPerRow = 3;       // 每行3個，共3行
                } else if (memoryLevel === 5) {
                    totalOptionsCount = 15;  // 5字挑戰顯示15個選項
                    columnsPerRow = 5;       // 每行5個，共3行
                } else if (memoryLevel === 8) {
                    totalOptionsCount = 24;  // 8字挑戰顯示24個選項
                    columnsPerRow = 6;       // 每行6個，共4行
                }
                
                // 根據小螢幕調整列數
                if (window.innerWidth < 500) {
                    if (memoryLevel === 8) {
                        columnsPerRow = 4; // 在小螢幕上改為4列，6行
                    } else if (memoryLevel === 5) {
                        columnsPerRow = 3; // 在小螢幕上改為3列，5行
                    }
                }
                
                // 生成選項（包括目標字符和足夠的干擾字符）
                const allOptions = [...memoryTargetChars];
                while (allOptions.length < totalOptionsCount) {
                    const randomChar = getRandomCharacter();
                    if (!allOptions.includes(randomChar)) {
                        allOptions.push(randomChar);
                    }
                }
                
                // 打亂選項順序
                shuffleArray(allOptions);
                
                // 清空舊選項，避免事件重複
                memoryOptions.innerHTML = '';
                memoryOptionElements = [];
                
                // 設置網格列數
                memoryOptions.style.gridTemplateColumns = `repeat(${columnsPerRow}, 1fr)`;
                
                // 顯示選項
                allOptions.forEach(char => {
                    const option = document.createElement('div');
                    option.className = 'memory-option';
                    option.textContent = char;
                    option.dataset.char = char;  // 使用數據屬性存儲字符
                    
                    // 使用事件委托而不是直接添加事件
                    memoryOptions.appendChild(option);
                    memoryOptionElements.push(option);  // 保存選項元素引用
                });
                
                // 更新提示
                memoryTimer.textContent = `請選擇您記得的${memoryLevel}個漢字 | 用時：0秒`;
            }
            
            // 選擇記憶選項（使用事件委托处理）
            function selectMemoryOption(char, optionElement) {
                console.log('选择选项:', char);
                
                // 如果游戏未激活，忽略点击
                if (!memoryGameActive) {
                    console.log('游戏未激活，忽略点击');
                    return;
                }
                
                // 如果已经选择了这个字符，取消选择
                const charIndex = memorySelectedChars.indexOf(char);
                if (charIndex !== -1) {
                    console.log('取消选择:', char);
                    memorySelectedChars.splice(charIndex, 1);
                    optionElement.classList.remove('selected');
                    return;
                }
                
                // 如果已经选择了足够的字符，且这不是取消选择操作，则忽略
                if (memorySelectedChars.length >= memoryLevel) {
                    console.log('已选择足够的字符，忽略点击');
                    return;
                }
                
                // 添加到选择列表并更新样式
                console.log('添加到选择列表:', char);
                memorySelectedChars.push(char);
                optionElement.classList.add('selected');
                
                // 检查是否已选择足够的字符
                if (memorySelectedChars.length === memoryLevel) {
                    console.log('已选择足够字符，检查结果');
                    setTimeout(checkMemoryResult, 500);
                }
            }
            
            // 更新選字計時
            function updateSelectionTimer() {
                if (!memorySelectionStartTime || !memoryGameActive) return;
                
                const now = new Date();
                const elapsedSeconds = Math.floor((now - memorySelectionStartTime) / 1000);
                memorySelectionDuration = elapsedSeconds;
                
                // 更新顯示的用時
                memoryTimer.textContent = `請選擇您記得的${memoryLevel}個漢字 | 用時：${elapsedSeconds}秒`;
                
                // 如果遊戲仍在進行中，繼續更新計時
                if (memoryGameActive) {
                    setTimeout(updateSelectionTimer, 1000);
                }
            }
            
            // 檢查記憶遊戲結果
            function checkMemoryResult() {
                // 停止計時
                memoryGameActive = false;
                
                // 計算正確數量
                let correctCount = 0;
                
                // 清除上一次的結果標記
                memoryOptionElements.forEach(option => {
                    option.classList.remove('correct', 'wrong', 'missed');
                });
                
                // 用於記錄已經處理過的選項，避免重複處理
                const processedOptions = new Set();
                
                // 檢查用戶選擇的每個字符
                memorySelectedChars.forEach(char => {
                    // 查找對應的選項元素
                    const optionElement = memoryOptionElements.find(element => 
                        element.dataset.char === char && !processedOptions.has(element)
                    );
                    
                    if (!optionElement) return;
                    
                    // 標記為已處理
                    processedOptions.add(optionElement);
                    
                    // 檢查是否選對
                    if (memoryTargetChars.includes(char)) {
                        // 選對了 - 綠色
                        optionElement.classList.remove('selected');
                        optionElement.classList.add('correct');
                        correctCount++;
                        
                        // 將這個字符添加到學習記錄
                        addToLearnedCharacters(char);
                    } else {
                        // 選錯了 - 紅色
                        optionElement.classList.remove('selected');
                        optionElement.classList.add('wrong');
                    }
                });
                
                // 標記那些應該選但沒選的字符
                memoryTargetChars.forEach(targetChar => {
                    // 如果這個目標字符沒有被用戶選中
                    if (!memorySelectedChars.includes(targetChar)) {
                        // 查找這個字符的選項元素
                        const missedOption = memoryOptionElements.find(element => 
                            element.dataset.char === targetChar && !processedOptions.has(element)
                        );
                        
                        if (missedOption) {
                            // 標記為應該選的
                            missedOption.classList.add('missed');
                            processedOptions.add(missedOption);
                        }
                    }
                });
                
                // 墨寶積分系統 - 記憶遊戲獎勵
                playerData.totalMemoryGames++;
                playerData.statistics.gamesPlayedToday++;
                playerData.functionsUsed.add('memory');
                
                // 首次遊戲獎勵
                if (!playerData.firstTimeActions.has('memory_first')) {
                    playerData.firstTimeActions.add('memory_first');
                    checkAchievement('memory_first');
                }
                
                // 根據表現給予積分
                let gamePoints = pointRewards.memoryGame;
                if (correctCount === memoryLevel) {
                    // 完美表現
                    gamePoints = pointRewards.memoryGamePerfect;
                    playerData.perfectMemoryGames++;
                    
                    // 檢查閃電記憶成就（5秒內完成）
                    if (memorySelectionDuration > 0 && memorySelectionDuration <= 5) {
                        checkAchievement('lightning_memory');
                    }
                }
                
                awardPoints(gamePoints, `記憶挑戰 +${gamePoints} 🖌️`);
                
                // 檢查記憶遊戲成就
                checkAchievement('memory_good');
                checkAchievement('memory_expert');
                checkAchievement('memory_legend');
                checkAchievement('perfectionist');
                checkAchievement('game_master');
                
                // 更新成就
                updateAchievements();
                
                // 顯示結果
                memoryResult.style.display = 'block';
                
                // 獲取最終用時
                const timeString = memorySelectionDuration > 0 
                    ? `，用時：${memorySelectionDuration}秒`
                    : '';
                
                if (correctCount === memoryLevel) {
                    // 全部正確
                    memoryResult.className = 'memory-result success';
                    memoryResult.querySelector('.memory-result-message').textContent = '太棒了！你全部記住了！';
                    memoryResult.querySelector('.memory-result-score').textContent = `得分：${correctCount}/${memoryLevel}${timeString}`;
                    playSuccessSound();
                } else if (correctCount >= memoryLevel / 2) {
                    // 部分正確
                    memoryResult.className = 'memory-result success';
                    memoryResult.querySelector('.memory-result-message').textContent = '做得不錯！再接再厲！';
                    memoryResult.querySelector('.memory-result-score').textContent = `得分：${correctCount}/${memoryLevel}${timeString}`;
                } else {
                    // 大部分錯誤
                    memoryResult.className = 'memory-result error';
                    memoryResult.querySelector('.memory-result-message').textContent = '加油！需要多練習！';
                    memoryResult.querySelector('.memory-result-score').textContent = `得分：${correctCount}/${memoryLevel}${timeString}`;
                }
                
                // 更新按鈕狀態
                updateMemoryButton();
                
                // 重新顯示原始字符
                const charElements = document.querySelectorAll('.memory-character');
                charElements.forEach((el, idx) => {
                    if (idx < memoryTargetChars.length) {
                        el.classList.remove('hidden');
                        el.textContent = memoryTargetChars[idx];
                    }
                });
            }
            
            // 停止記憶遊戲
            function stopMemoryGame() {
                memoryGameActive = false;
                if (memoryTimer_id) {
                    clearInterval(memoryTimer_id);
                    memoryTimer_id = null;
                }
            }
            
            // 重置記憶遊戲到初始狀態
            function resetMemoryGame() {
                // 停止遊戲
                stopMemoryGame();
                
                // 重置遊戲狀態
                memoryGameActive = false;
                memorySelectedChars = [];
                memoryOptionElements = [];
                memoryTargetChars = [];
                memorySelectionStartTime = null;
                memorySelectionDuration = 0;
                
                // 清空界面
                memoryOptions.innerHTML = '';
                memoryCharacters.innerHTML = '';
                memoryResult.style.display = 'none';
                
                // 重置提示文字和按鈕
                memoryTimer.textContent = '準備開始...';
                updateMemoryButton();
            }
            
            // 更新記憶遊戲按鈕文字
            function updateMemoryButton() {
                if (memoryGameActive) {
                    memoryStart.textContent = '停止遊戲';
                    memoryStart.className = 'btn btn-outline';
                } else if (memoryResult.style.display === 'block') {
                    memoryStart.textContent = '再來一局';
                    memoryStart.className = 'btn btn-primary';
                } else {
                    memoryStart.textContent = '開始遊戲';
                    memoryStart.className = 'btn btn-primary';
                }
                memoryStart.disabled = false;
            }
            
            // 開始新一局遊戲 - 重置並立即開始
            function startNewRound() {
                // 先清除結果顯示和重置部分狀態
                memoryResult.style.display = 'none';
                memorySelectedChars = [];
                memoryOptionElements = [];
                memorySelectionStartTime = null;
                memorySelectionDuration = 0;
                
                // 清空選項和字符顯示區域
                memoryOptions.innerHTML = '';
                memoryCharacters.innerHTML = '';
                
                // 直接開始新遊戲
                startMemoryChallenge();
            }
            
            // ============ 字詞本功能 ============
            
            // 初始化字詞本
            function initVocabularyBook() {
                // 從本地存儲載入字詞本
                const savedVocabularyBook = localStorage.getItem('vocabularyBook');
                if (savedVocabularyBook) {
                    const data = JSON.parse(savedVocabularyBook);
                    // 兼容舊版本數據
                    if (data.characters || data.words) {
                        vocabularyBook.items = [];
                        if (data.characters) {
                            data.characters.forEach(item => {
                                vocabularyBook.items.push({...item, type: 'character'});
                            });
                        }
                        if (data.words) {
                            data.words.forEach(item => {
                                vocabularyBook.items.push({...item, type: 'word'});
                            });
                        }
                        // 按時間戳排序
                        vocabularyBook.items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        saveVocabularyBook(); // 保存為新格式
                    } else {
                        vocabularyBook = data;
                    }
                }
                updateVocabularyBookDisplay();
                setupVocabularyBookEventListeners();
            }
            
            // 保存字詞本到本地存儲
            function saveVocabularyBook() {
                localStorage.setItem('vocabularyBook', JSON.stringify(vocabularyBook));
            }
            
            // 添加字詞到收藏
            function addToVocabularyBook(text, pinyin, type) {
                // 檢查是否已經收藏
                const exists = vocabularyBook.items.find(item => item.text === text);
                if (exists) {
                    return false; // 已經收藏過了
                }
                
                // 添加到收藏（最新的在前面）
                vocabularyBook.items.unshift({
                    text: text,
                    pinyin: pinyin || '',
                    type: type,
                    timestamp: Date.now()
                });
                
                saveVocabularyBook();
                updateVocabularyBookDisplay();
                
                // 墨寶積分系統 - 收藏獎勵
                playerData.totalCollections++;
                playerData.functionsUsed.add('collection');
                
                // 首次收藏獎勵
                if (!playerData.firstTimeActions.has('first_collection')) {
                    playerData.firstTimeActions.add('first_collection');
                    checkAchievement('first_collection');
                }
                
                // 收藏積分獎勵
                awardPoints(pointRewards.collection, `收藏字詞 +${pointRewards.collection} 🖌️`);
                
                // 檢查收藏成就
                checkAchievement('collector');
                checkAchievement('treasure_hunter');
                checkAchievement('archive_keeper');
                
                return true; // 成功添加
            }
            
            // 從收藏中移除字詞（全局函數）
            window.removeFromVocabularyBook = function(text) {
                const index = vocabularyBook.items.findIndex(item => item.text === text);
                
                if (index !== -1) {
                    vocabularyBook.items.splice(index, 1);
                    saveVocabularyBook();
                    updateVocabularyBookDisplay();
                    return true;
                }
                return false;
            }
            
            // 檢查是否已收藏
            function isInVocabularyBook(text) {
                return vocabularyBook.items.some(item => item.text === text);
            }
            
            // 創建字詞項目HTML
            function createVocabularyItemHTML(item, number) {
                const characters = item.text.split('');
                const pinyinParts = item.pinyin ? item.pinyin.split(' ') : [];
                
                let characterBoxes = '';
                characters.forEach((char, index) => {
                    const charPinyin = pinyinParts[index] || '';
                    characterBoxes += `
                        <div class="vocabulary-character-container">
                            ${charPinyin ? `<div class="vocabulary-character-pinyin">${charPinyin}</div>` : ''}
                            <div class="vocabulary-character-box">
                                <div class="vocabulary-character">${char}</div>
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div class="vocabulary-item" onclick="navigateToVocabularyItem('${item.type}', '${item.text}')">
                        <div class="vocabulary-item-number">${number}.</div>
                        <div class="vocabulary-item-content">
                            <div class="vocabulary-item-text">
                                ${characterBoxes}
                            </div>
                        </div>
                        <button class="vocabulary-remove" onclick="event.stopPropagation(); removeFromVocabularyBook('${item.text}')">×</button>
                    </div>
                `;
            }
            
            // 更新字詞本顯示
            function updateVocabularyBookDisplay() {
                const vocabularyList = document.getElementById('vocabulary-list');
                const vocabularyCount = document.getElementById('vocabulary-count');
                const vocabularyMore = document.getElementById('vocabulary-more');
                const totalCountSpan = document.getElementById('total-count');
                
                if (!vocabularyList || !vocabularyCount) return;
                
                const totalCount = vocabularyBook.items.length;
                vocabularyCount.textContent = `(${totalCount})`;
                
                if (totalCount === 0) {
                    vocabularyList.innerHTML = `
                        <div class="empty-vocabulary">
                            <div class="empty-icon">📚</div>
                            <div class="empty-text">還沒有收藏任何字詞</div>
                            <div class="empty-hint">查詢字詞時點擊收藏按鈕</div>
                        </div>
                    `;
                    if (vocabularyMore) vocabularyMore.style.display = 'none';
                    return;
                }
                
                // 顯示最近的5個
                const displayItems = vocabularyBook.items.slice(0, 5);
                
                vocabularyList.innerHTML = displayItems.map((item, index) => {
                    return createVocabularyItemHTML(item, index + 1);
                }).join('');
                
                // 顯示或隱藏"查看全部"按鈕
                if (vocabularyMore && totalCountSpan) {
                    if (totalCount > 5) {
                        vocabularyMore.style.display = 'block';
                        totalCountSpan.textContent = totalCount;
                    } else {
                        vocabularyMore.style.display = 'none';
                    }
                }
            }
            
            // 打開模態窗口
            function openVocabularyModal() {
                const modal = document.getElementById('vocabulary-modal');
                const modalList = document.getElementById('vocabulary-modal-list');
                const modalCount = document.getElementById('vocabulary-modal-count');
                
                if (!modal || !modalList || !modalCount) return;
                
                modalCount.textContent = `(${vocabularyBook.items.length})`;
                
                modalList.innerHTML = vocabularyBook.items.map((item, index) => {
                    return createVocabularyItemHTML(item, index + 1);
                }).join('');
                
                modal.style.display = 'flex';
            }
            
            // 關閉模態窗口
            function closeVocabularyModal() {
                const modal = document.getElementById('vocabulary-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            // 導航到字詞項目（全局函數）
            window.navigateToVocabularyItem = function(type, text) {
                closeVocabularyModal(); // 關閉模態窗口
                
                if (type === 'character') {
                    // 跳轉到字的筆順查詢
                    const navLookup = document.getElementById('nav-lookup');
                    const characterDisplaySection = document.getElementById('character-display-section');
                    switchMainFunction(navLookup, characterDisplaySection);
                    const characterInput = document.getElementById('character-input');
                    if (characterInput) {
                        characterInput.value = text;
                        queryCharacter();
                    }
                } else {
                    // 跳轉到詞語查詢
                    const navWordLookup = document.getElementById('nav-word-lookup');
                    const wordLookupContainer = document.getElementById('word-lookup-container');
                    switchMainFunction(navWordLookup, wordLookupContainer);
                    const wordInput = document.getElementById('word-input');
                    if (wordInput) {
                        wordInput.value = text;
                        fetchWordDefinition(text);
                    }
                }
            }
            
            // 設置字詞本事件監聽器
            function setupVocabularyBookEventListeners() {
                // 字收藏按鈕
                const characterFavoriteBtn = document.getElementById('character-favorite-btn');
                if (characterFavoriteBtn) {
                    characterFavoriteBtn.addEventListener('click', () => {
                        const currentChar = lastLookedUpCharacter;
                        const currentPinyin = lastLookedUpCharacterPinyin;
                        
                        if (!currentChar) {
                            showVocabularyFeedback('請先查詢一個字！', true);
                            return;
                        }
                        
                        const exists = isInVocabularyBook(currentChar);
                        
                        if (exists) {
                            removeFromVocabularyBook(currentChar);
                            characterFavoriteBtn.textContent = '💝 收藏';
                            characterFavoriteBtn.classList.remove('favorited');
                            showVocabularyFeedback('已取消收藏');
                        } else {
                            if (addToVocabularyBook(currentChar, currentPinyin || '', 'character')) {
                                characterFavoriteBtn.textContent = '💖 已收藏';
                                characterFavoriteBtn.classList.add('favorited');
                                showVocabularyFeedback('字已收藏！');
                            }
                        }
                    });
                }
                
                // 詞語收藏按鈕
                const wordFavoriteBtn = document.getElementById('word-favorite-btn');
                if (wordFavoriteBtn) {
                    wordFavoriteBtn.addEventListener('click', () => {
                        const currentWord = lastLookedUpWord;
                        const currentPinyin = lastLookedUpWordPinyin;
                        
                        if (!currentWord) {
                            showVocabularyFeedback('請先查詢一個詞語！', true);
                            return;
                        }
                        
                        const exists = isInVocabularyBook(currentWord);
                        
                        if (exists) {
                            removeFromVocabularyBook(currentWord);
                            wordFavoriteBtn.textContent = '💝 收藏';
                            wordFavoriteBtn.classList.remove('favorited');
                            showVocabularyFeedback('已取消收藏');
                        } else {
                            if (addToVocabularyBook(currentWord, currentPinyin || '', 'word')) {
                                wordFavoriteBtn.textContent = '💖 已收藏';
                                wordFavoriteBtn.classList.add('favorited');
                                showVocabularyFeedback('詞已收藏！');
                            }
                        }
                    });
                }
                
                // 查看全部按鈕
                const moreBtn = document.getElementById('vocabulary-more-btn');
                if (moreBtn) {
                    moreBtn.addEventListener('click', openVocabularyModal);
                }
                
                // 模態窗口關閉
                const modalClose = document.getElementById('vocabulary-modal-close');
                const modal = document.getElementById('vocabulary-modal');
                if (modalClose && modal) {
                    modalClose.addEventListener('click', closeVocabularyModal);
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeVocabularyModal();
                        }
                    });
                }
            }
            
            // 更新收藏按鈕狀態
            function updateFavoriteButtonState(type, text) {
                const btn = type === 'character' ? 
                    document.getElementById('character-favorite-btn') : 
                    document.getElementById('word-favorite-btn');
                
                if (!btn) return;
                
                const exists = isInVocabularyBook(text);
                
                if (exists) {
                    btn.textContent = '💖 已收藏';
                    btn.classList.add('favorited');
                } else {
                    btn.textContent = '💝 收藏';
                    btn.classList.remove('favorited');
                }
            }
            
            // 顯示字詞本反饋消息
            function showVocabularyFeedback(message, isError = false) {
                const toast = document.createElement('div');
                toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${isError ? 'var(--danger)' : 'var(--success)'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    z-index: 10000;
                    animation: toastSlideIn 0.3s ease;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'toastSlideOut 0.3s ease';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 2000);
            }
            
            // 獲取隨機漢字
            function getRandomCharacter() {
                const randomIndex = Math.floor(Math.random() * commonCharacters.length);
                return commonCharacters[randomIndex];
            }
            
            // 獲取不重複的隨機漢字集合
            function getRandomCharacters(count) {
                const result = [];
                const availableChars = [...commonCharacters];
                
                while (result.length < count && availableChars.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableChars.length);
                    const char = availableChars.splice(randomIndex, 1)[0];
                    result.push(char);
                }
                
                return result;
            }
            
            // 隨機打亂數組
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            // 獲取不重複的隨機漢字（用於筆順挑戰下一個）
            function getNextRandomCharacter() {
                let nextChar;
                // 優先從學習過的字符中選擇，增加複習效果
                if (learnedCharacters.length > 1) {
                    // 排除當前字符，避免連續出現相同的字
                    const availableChars = learnedCharacters.filter(char => char !== currentCharacter);
                    if (availableChars.length > 0) {
                        // 有60%概率從學習過的字符中選擇
                        if (Math.random() < 0.6) {
                            const randomIndex = Math.floor(Math.random() * availableChars.length);
                            nextChar = availableChars[randomIndex];
                            return nextChar;
                        }
                    }
                }
                
                // 從常用漢字中選擇一個不同於當前字符的漢字
                let filteredChars = commonCharacters.filter(char => char !== currentCharacter);
                const randomIndex = Math.floor(Math.random() * filteredChars.length);
                nextChar = filteredChars[randomIndex];
                return nextChar;
            }
            
            // 挑戰下一個漢字
            function challengeNextCharacter() {
                // 獲取隨機漢字
                const nextChar = getNextRandomCharacter();
                
                // 更新當前字符
                currentCharacter = nextChar;
                
                // 更新輸入框
                characterInput.value = nextChar;
                
                // 重置並開始新的挑戰
                quizResult.style.display = 'none';
                startQuizMode();
            }
            
            // 預加載語音引擎
            function preloadVoices() {
                if ('speechSynthesis' in window) {
                    // 先獲取一次聲音列表以初始化語音引擎
                    speechSynthesis.getVoices();
                    
                    // 在某些瀏覽器上需要等待 voiceschanged 事件
                    speechSynthesis.addEventListener('voiceschanged', function() {
                        speechSynthesis.getVoices();
                    });
                }
            }
            
            // 設置事件監聽器
            searchButton.addEventListener('click', queryCharacter);
            
            // 添加回車鍵支持
            characterInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    queryCharacter();
                }
            });
            
            animateButton.addEventListener('click', function() {
                if (writer && typeof writer.animateCharacter === 'function') {
                    writer.animateCharacter();
                }
            });
            
            speakButton.addEventListener('click', speakCharacter);
            
            quizButton.addEventListener('click', function() {
                // 切換到筆順大師功能區，並使用當前查詢的字符進行練習
                if (currentCharacter) {
                    // 保存當前字符，防止被重置
                    const targetCharacter = currentCharacter;
                    console.log('練習書寫按鈕點擊，目標字符:', targetCharacter);
                    
                    // 直接同步切換，避免閃動
                    // 重置所有按鈕的激活狀態
                    [navLookup, navPractice, navMemory, navRadical].forEach(button => {
                        button.classList.remove('active');
                    });
                    
                    // 隱藏所有功能區域
                    [characterDisplaySection, memoryGameContainer, radicalGameContainer].forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // 激活筆順大師按鈕和區域
                    navPractice.classList.add('active');
                    quizContainer.style.display = 'block';
                    
                    // 隱藏搜索框和字符選擇器
                    const searchSection = document.getElementById('character-search-section');
                    searchSection.style.display = 'none';
                    hideCharacterSelector();
                    
                    // 確保使用正確的字符並立即開始筆順練習
                    currentCharacter = targetCharacter;
                    startQuizMode();
                } else {
                    // 如果沒有當前字符，則切換到筆順大師並開始隨機練習
                    switchMainFunction(navPractice, quizContainer);
                    setTimeout(() => {
                startIndependentQuizMode();
                    }, 100);
                }
            });
            

            
            quizRetry.addEventListener('click', resetQuizMode);
            
            quizHint.addEventListener('click', function() {
                if (quizWriter && quizWriter._currentStroke !== undefined) {
                    showStrokeHint(quizWriter._currentStroke);
                }
            });
            
            // 下一個漢字按鈕點擊事件
            document.getElementById('quiz-next').addEventListener('click', challengeNextCharacter);
            
            // 記憶遊戲控制按鈕 - 智能按鈕，根據遊戲狀態改變功能
            memoryStart.addEventListener('click', function() {
                if (memoryGameActive) {
                    // 如果遊戲正在進行，停止遊戲並重置
                stopMemoryGame();
                    resetMemoryGame();
                } else if (memoryResult.style.display === 'block') {
                    // 如果顯示了結果，直接開始新一局遊戲
                    startNewRound();
                } else {
                    // 否則開始新遊戲
                    startMemoryChallenge();
                }
            });
            
            // 使用事件委托处理记忆游戏选项点击
            memoryOptions.addEventListener('click', function(e) {
                // 只处理选项元素的点击
                if (e.target.classList.contains('memory-option')) {
                    selectMemoryOption(e.target.dataset.char, e.target);
                }
            });
            
            // 設置記憶挑戰難度按鈕點擊事件
            levelButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 只處理記憶挑戰容器內的按鈕
                    const memoryLevelButtons = document.querySelectorAll('#memory-game-container .level-btn');
                    memoryLevelButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const level = parseInt(this.getAttribute('data-level'));
                    if (!isNaN(level) && level > 0) {
                        memoryLevel = level;
                        console.log('記憶挑戰難度設置為:', memoryLevel);
                    }
                });
            });
            
            // 調整大小時更新漢字顯示
            window.addEventListener('resize', function() {
                const isWide = window.innerWidth > 768;
                const size = isWide ? 280 : 220;
                
                if (writer) {
                    try {
                        writer.updateDimensions({
                            width: size,
                            height: size
                        });
                    } catch(e) {
                        console.error('调整大小时出错:', e);
                    }
                }
                
                if (quizWriter) {
                    try {
                        quizWriter.updateDimensions({
                            width: size,
                            height: size
                        });
                    } catch(e) {
                        console.error('调整大小时出错:', e);
                    }
                }
            });
            
            // 初始化記憶挑戰難度
            function initMemoryGameLevel() {
                const activeMemoryButton = document.querySelector('#memory-game-container .level-btn.active');
                if (activeMemoryButton) {
                    const level = parseInt(activeMemoryButton.getAttribute('data-level'));
                    if (!isNaN(level) && level > 0) {
                        memoryLevel = level;
                        console.log('初始化記憶挑戰難度為:', memoryLevel);
                    }
                }
            }
            
            // 添加田字格觸摸事件處理，防止頁面滾動
            function preventTouchScroll(element) {
                element.addEventListener('touchstart', function(e) {
                    // 如果是田字格區域，阻止滾動
                    e.stopPropagation();
                }, { passive: false });
                
                element.addEventListener('touchmove', function(e) {
                    // 阻止滾動事件
                    e.preventDefault();
                    e.stopPropagation();
                }, { passive: false });
                
                element.addEventListener('touchend', function(e) {
                    e.stopPropagation();
                }, { passive: false });
            }
            
            // 為田字格元素添加防滾動處理
            preventTouchScroll(characterTarget);
            preventTouchScroll(quizTargetField);
            
            // 載入學習記錄和預加載語音
            loadLearnedCharacters();
            updateAchievements();
            preloadVoices();
            
            // 初始化記憶挑戰
            initMemoryGameLevel();
            
            // 部首組字遊戲功能
            
            // 添加對部首組字遊戲導航按鈕的監聽
            
            navRadical.addEventListener('click', function() {
                // 使用通用的切換功能，保持代碼一致性
                switchMainFunction(navRadical, radicalGameContainer);
                // 記錄功能使用
                playerData.functionsUsed.add('radical_game');
                checkAchievement('explorer');
            });
            
            // 部首字典 - 常用部首及其可組成的字
            const radicalDictionary = {
                'easy': [
                    { target: '好', components: ['女', '子'] },
                    { target: '明', components: ['日', '月'] },
                    { target: '休', components: ['亻', '木'] },
                    { target: '看', components: ['手', '目'] },
                    { target: '林', components: ['木', '木'] },
                    { target: '男', components: ['田', '力'] },
                    { target: '信', components: ['亻', '言'] },
                    { target: '同', components: ['口', '冂'] },
                    { target: '和', components: ['禾', '口'] },
                    { target: '坐', components: ['土', '人'] },
                    // 新增简单汉字
                    { target: '好', components: ['女', '子'] },
                    { target: '你', components: ['亻', '尔'] },
                    { target: '他', components: ['亻', '也'] },
                    { target: '她', components: ['女', '也'] },
                    { target: '们', components: ['亻', '门'] },
                    { target: '叫', components: ['口', '丩'] },
                    { target: '吃', components: ['口', '乞'] },
                    { target: '吗', components: ['口', '马'] },
                    { target: '吧', components: ['口', '巴'] },
                    { target: '听', components: ['口', '斤'] },
                    { target: '呢', components: ['口', '尼'] },
                    { target: '呀', components: ['口', '牙'] },
                    { target: '哪', components: ['口', '那'] },
                    { target: '家', components: ['宀', '豕'] },
                    { target: '对', components: ['又', '寸'] },
                    { target: '时', components: ['日', '寸'] },
                    { target: '想', components: ['相', '心'] },
                    { target: '里', components: ['田', '土'] },
                    { target: '走', components: ['土', '走'] },
                    { target: '起', components: ['走', '己'] },
                    { target: '这', components: ['辶', '文'] },
                    { target: '都', components: ['者', '阝'] },
                    { target: '什', components: ['亻', '十'] },
                    { target: '从', components: ['人', '人'] },
                    { target: '们', components: ['亻', '门'] },
                    { target: '会', components: ['人', '云'] },
                    { target: '但', components: ['亻', '旦'] },
                    { target: '住', components: ['亻', '主'] },
                    { target: '作', components: ['亻', '乍'] },
                    { target: '坐', components: ['土', '人'] },
                    { target: '安', components: ['宀', '女'] },
                    { target: '定', components: ['宀', '正'] },
                    { target: '客', components: ['宀', '各'] },
                    { target: '容', components: ['宀', '谷'] },
                    { target: '字', components: ['宀', '子'] },
                    { target: '它', components: ['宀', '匕'] },
                    { target: '室', components: ['宀', '至'] },
                    { target: '家', components: ['宀', '豕'] },
                    { target: '害', components: ['宀', '丰'] }
                ],
                'medium': [
                    { target: '想', components: ['相', '心'] },
                    { target: '福', components: ['礻', '畐'] },
                    { target: '謝', components: ['言', '射'] },
                    { target: '飯', components: ['飠', '反'] },
                    { target: '歡', components: ['欠', '雚'] },
                    { target: '學', components: ['𦥯', '子'] },
                    { target: '語', components: ['言', '吾'] },
                    { target: '親', components: ['見', '辛'] },
                    { target: '聽', components: ['耳', '𢆶'] },
                    { target: '說', components: ['言', '兌'] },
                    // 新增中等难度汉字
                    { target: '教', components: ['孝', '攵'] },
                    { target: '授', components: ['扌', '受'] },
                    { target: '採', components: ['扌', '采'] },
                    { target: '握', components: ['扌', '屋'] },
                    { target: '摘', components: ['扌', '啇'] },
                    { target: '提', components: ['扌', '是'] },
                    { target: '換', components: ['扌', '奐'] },
                    { target: '搭', components: ['扌', '荅'] },
                    { target: '撥', components: ['扌', '發'] },
                    { target: '撞', components: ['扌', '童'] },
                    { target: '樂', components: ['幺', '木'] },
                    { target: '機', components: ['木', '幾'] },
                    { target: '權', components: ['木', '雚'] },
                    { target: '樓', components: ['木', '婁'] },
                    { target: '標', components: ['木', '票'] },
                    { target: '樹', components: ['木', '尌'] },
                    { target: '橋', components: ['木', '喬'] },
                    { target: '櫃', components: ['木', '貴'] },
                    { target: '清', components: ['氵', '青'] },
                    { target: '港', components: ['氵', '巷'] },
                    { target: '湖', components: ['氵', '胡'] },
                    { target: '潔', components: ['氵', '絜'] },
                    { target: '潮', components: ['氵', '朝'] },
                    { target: '濤', components: ['氵', '壽'] },
                    { target: '激', components: ['氵', '敫'] },
                    { target: '煮', components: ['者', '灬'] },
                    { target: '熟', components: ['孰', '灬'] },
                    { target: '熱', components: ['埶', '灬'] },
                    { target: '燉', components: ['享', '灬'] },
                    { target: '燒', components: ['堯', '灬'] },
                    { target: '愛', components: ['爫', '心'] },
                    { target: '懂', components: ['董', '心'] },
                    { target: '慢', components: ['曼', '心'] },
                    { target: '憂', components: ['夂', '心'] },
                    { target: '應', components: ['广', '應'] },
                    { target: '懷', components: ['褱', '心'] }
                ],
                'hard': [
                    { target: '鱷', components: ['魚', '咢'] },
                    { target: '籠', components: ['竹', '龍'] },
                    { target: '鼕', components: ['鼓', '冬'] },
                    { target: '鸚', components: ['鳥', '嬰'] },
                    { target: '鱺', components: ['魚', '朁'] },
                    { target: '驢', components: ['馬', '戾'] },
                    { target: '靈', components: ['雨', '靈'] },
                    { target: '鷹', components: ['鳥', '英'] },
                    { target: '鷺', components: ['鳥', '路'] },
                    { target: '鱟', components: ['魚', '候'] },
                    // 新增高难度汉字
                    { target: '曉', components: ['日', '堯'] },
                    { target: '礙', components: ['石', '疑'] },
                    { target: '讓', components: ['言', '襄'] },
                    { target: '識', components: ['言', '戠'] },
                    { target: '讚', components: ['言', '贊'] },
                    { target: '警', components: ['言', '敬'] },
                    { target: '譯', components: ['言', '睪'] },
                    { target: '議', components: ['言', '義'] },
                    { target: '離', components: ['离', '隹'] },
                    { target: '難', components: ['堇', '隹'] },
                    { target: '雞', components: ['鳥', '奚'] },
                    { target: '雜', components: ['隹', '集'] },
                    { target: '雖', components: ['虽', '唯'] },
                    { target: '電', components: ['雨', '電'] },
                    { target: '露', components: ['雨', '路'] },
                    { target: '響', components: ['郎', '音'] },
                    { target: '頂', components: ['丁', '頁'] },
                    { target: '頑', components: ['元', '頁'] },
                    { target: '領', components: ['令', '頁'] },
                    { target: '須', components: ['彡', '頁'] },
                    { target: '額', components: ['客', '頁'] },
                    { target: '顯', components: ['日', '頁'] },
                    { target: '顧', components: ['雇', '頁'] },
                    { target: '願', components: ['原', '頁'] },
                    { target: '類', components: ['田', '頁'] },
                    { target: '顫', components: ['亶', '頁'] },
                    { target: '飄', components: ['票', '風'] },
                    { target: '飆', components: ['猋', '風'] },
                    { target: '餓', components: ['我', '食'] },
                    { target: '餘', components: ['余', '食'] },
                    { target: '館', components: ['飠', '官'] },
                    { target: '饑', components: ['飠', '几'] },
                    { target: '饒', components: ['飠', '堯'] },
                    { target: '騎', components: ['馬', '奇'] },
                    { target: '騰', components: ['馬', '滕'] },
                    { target: '驅', components: ['馬', '區'] },
                    { target: '驚', components: ['馬', '敬'] },
                    { target: '驗', components: ['馬', '僉'] },
                    { target: '髮', components: ['彡', '髟'] },
                    { target: '魔', components: ['麻', '鬼'] }
                ]
            };
            
            // 替代部首 - 因為某些部首難以顯示，用簡化的代替
            const simplifiedRadicals = {
                '亻': '人',   // 單人旁簡化為人
                '礻': '示',   // 示字旁簡化為示
                '飠': '食',   // 食字旁簡化為食
                '龸': '龍',   // 簡化龍字
                '𦥯': '學',   // 簡化學字上部
                '𢆶': '允',   // 簡化允字
                '辶': '走',   // 走之旁簡化為走
                '忄': '心',   // 豎心旁簡化為心
                '氵': '水',   // 三點水簡化為水
                '扌': '手',   // 提手旁簡化為手
                '犭': '犬',   // 反犬旁簡化為犬
                '阝': '阜',   // 阜字旁簡化為阜
                '灬': '火',   // 四點底簡化為火
                '艹': '草',   // 草字頭簡化為草
                '衤': '衣',   // 衣字旁簡化為衣
                '血': '血',
                '刂': '刀',
                '爿': '片',
                '囗': '口',
                '宀': '宀'
            };
            
            // 當前遊戲狀態
            let currentRadicalLevel = 'easy';
            let currentRadicalPuzzle = null;
            let selectedRadicals = [];
            let currentRadicalAttempts = 0;
            
            // 取得簡化後的部首
            function getSimplifiedRadical(radical) {
                return simplifiedRadicals[radical] || radical;
            }
            
            // 啟動部首組字遊戲
            function startRadicalGame() {
                // 獲取當前難度級別
                const radicalLevelButtons = document.querySelectorAll('.radical-level .level-btn');
                radicalLevelButtons.forEach(btn => {
                    if (btn.classList.contains('active')) {
                        currentRadicalLevel = btn.getAttribute('data-level');
                    }
                });
                
                // 重置遊戲狀態
                selectedRadicals = [];
                currentRadicalAttempts = 0;
                
                // 隱藏結果和提示
                document.getElementById('radical-result').style.display = 'none';
                document.getElementById('radical-hint').style.display = 'none';
                
                // 從字典中隨機選擇一個難度相符的謎題
                const puzzles = radicalDictionary[currentRadicalLevel];
                const randomIndex = Math.floor(Math.random() * puzzles.length);
                currentRadicalPuzzle = puzzles[randomIndex];
                
                // 顯示目標字
                document.getElementById('target-word').textContent = '?';
                
                // 清空工作區和提示區
                const dropArea = document.getElementById('radical-drop-area');
                dropArea.innerHTML = '<div class="drop-placeholder">拖放部首到此處組字</div>';
                
                // 準備部首選項
                const radicalsContainer = document.getElementById('radicals-container');
                radicalsContainer.innerHTML = '';
                
                // 創建目標字的部首
                const targetRadicals = [...currentRadicalPuzzle.components];
                
                // 添加一些隨機部首作為干擾項
                const allRadicals = [];
                Object.values(radicalDictionary).forEach(puzzles => {
                    puzzles.forEach(puzzle => {
                        puzzle.components.forEach(radical => {
                            if (!allRadicals.includes(radical)) {
                                allRadicals.push(radical);
                            }
                        });
                    });
                });
                
                // 過濾掉已選中的部首
                const availableRadicals = allRadicals.filter(r => !targetRadicals.includes(r));
                
                // 隨機選擇額外部首
                const extraRadicalsCount = currentRadicalLevel === 'easy' ? 4 : 
                                          currentRadicalLevel === 'medium' ? 6 : 8;
                
                for (let i = 0; i < extraRadicalsCount && availableRadicals.length > 0; i++) {
                    const randomIdx = Math.floor(Math.random() * availableRadicals.length);
                    const radical = availableRadicals.splice(randomIdx, 1)[0];
                    targetRadicals.push(radical);
                }
                
                // 打亂部首順序
                shuffleArray(targetRadicals);
                
                // 創建部首元素
                targetRadicals.forEach(radical => {
                    const radicalElement = document.createElement('div');
                    radicalElement.className = 'radical-item';
                    // 使用簡化後的部首
                    radicalElement.textContent = getSimplifiedRadical(radical);
                    radicalElement.dataset.radical = radical;
                    
                    radicalElement.addEventListener('click', function() {
                        selectRadical(this);
                    });
                    
                    radicalsContainer.appendChild(radicalElement);
                });
            }
            
            // 選擇部首
            function selectRadical(radicalElement) {
                const radical = radicalElement.dataset.radical;
                
                // 如果部首已經被選中，則不執行任何操作
                if (radicalElement.classList.contains('selected')) {
                    return;
                }
                
                // 標記為已選中
                radicalElement.classList.add('selected');
                
                // 將部首添加到工作區
                const dropArea = document.getElementById('radical-drop-area');
                
                // 移除預設提示文字
                const placeholder = dropArea.querySelector('.drop-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // 創建部首元素
                const workspaceRadical = document.createElement('div');
                workspaceRadical.className = 'radical-item-workspace';
                workspaceRadical.textContent = getSimplifiedRadical(radical);
                workspaceRadical.dataset.radical = radical;
                
                // 添加點擊事件以移除
                workspaceRadical.addEventListener('click', function() {
                    // 從選中列表中移除
                    const idx = selectedRadicals.indexOf(radical);
                    if (idx !== -1) {
                        selectedRadicals.splice(idx, 1);
                    }
                    
                    // 取消原始部首的選中狀態
                    const originalRadical = document.querySelector(`.radical-item[data-radical="${radical}"]`);
                    if (originalRadical) {
                        originalRadical.classList.remove('selected');
                    }
                    
                    // 移除工作區中的部首
                    this.remove();
                    
                    // 如果工作區為空，則顯示提示
                    if (dropArea.children.length === 0) {
                        dropArea.innerHTML = '<div class="drop-placeholder">拖放部首到此處組字</div>';
                    }
                });
                
                // 添加到工作區
                dropArea.appendChild(workspaceRadical);
                
                // 添加到選中列表
                selectedRadicals.push(radical);
            }
            
            // 檢查組字結果
            function checkRadicalResult() {
                // 檢查選擇的部首是否和目標字的部首相符
                const targetComponents = currentRadicalPuzzle.components;
                
                // 如果選擇的部首數量不符合，則直接顯示錯誤
                if (selectedRadicals.length !== targetComponents.length) {
                    showRadicalResult(false);
                    return;
                }
                
                // 檢查所有部首是否匹配
                const allMatch = targetComponents.every(component => 
                    selectedRadicals.includes(component)
                );
                
                if (allMatch) {
                    // 完全匹配
                    showRadicalResult(true);
                    addToLearnedCharacters(currentRadicalPuzzle.target);
                    
                    // 墨寶積分系統 - 部首遊戲獎勵
                    playerData.totalRadicalGames++;
                    playerData.statistics.gamesPlayedToday++;
                    playerData.functionsUsed.add('radical');
                    
                    // 首次遊戲獎勵
                    if (!playerData.firstTimeActions.has('radical_first')) {
                        playerData.firstTimeActions.add('radical_first');
                        checkAchievement('radical_first');
                    }
                    
                    // 根據表現給予積分
                    let gamePoints = pointRewards.radicalGame;
                    if (currentRadicalAttempts === 1) {
                        // 一次成功，完美表現
                        gamePoints = pointRewards.radicalGamePerfect;
                        playerData.perfectRadicalGames++;
                    }
                    
                    awardPoints(gamePoints, `部首組字 +${gamePoints} 🖌️`);
                    
                    // 檢查部首遊戲成就
                    checkAchievement('radical_builder');
                    checkAchievement('radical_master');
                    checkAchievement('perfectionist');
                    checkAchievement('game_master');
                    
                    updateAchievements();
                } else {
                    // 不匹配
                    showRadicalResult(false);
                }
                
                // 增加嘗試次數
                currentRadicalAttempts++;
            }
            
            // 創建特效 - 只保留水墨擴散效果
            function createSuccessAnimation(targetElement) {
                // 獲取元素位置
                const rect = targetElement.getBoundingClientRect();
                const container = document.getElementById('radical-game-container');
                
                // 測試水墨特效是否顯示
                console.log("創建成功動畫, 目標元素尺寸:", rect.width, "x", rect.height, "位置:", rect.left, rect.top);
                
                // 創建墨水擴散效果 - 增加數量並使效果更明顯
                for (let i = 0; i < 7; i++) {
                    const inkSplash = document.createElement('div');
                    inkSplash.className = 'ink-splash';
                    
                    // 以目標字為中心，適當擴散
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    // 在中心周圍產生隨機位置
                    const distance = i === 0 ? 0 : Math.random() * 40; // 第一個墨滴在中心
                    const angle = Math.random() * Math.PI * 2;
                    const randomX = centerX + Math.cos(angle) * distance;
                    const randomY = centerY + Math.sin(angle) * distance;
                    
                    // 添加隨機旋轉効果
                    const randomRotation = Math.random() * 360;
                    inkSplash.style.transform = `rotate(${randomRotation}deg)`;
                    
                    inkSplash.style.left = `${randomX - 100}px`; // 調整中心點
                    inkSplash.style.top = `${randomY - 100}px`;  // 調整中心點
                    
                    // 隨機縮放 - 不同大小的墨水效果
                    const randomScale = 0.8 + Math.random() * 0.8; // 0.8-1.6倍
                    inkSplash.style.transform += ` scale(${randomScale})`;
                    
                    document.body.appendChild(inkSplash);
                    
                    // 適當延遲後顯示，創造墨滴依次擴散的效果
                    setTimeout(() => {
                        inkSplash.style.opacity = "1";
                    }, i * 80);
                    
                    // 2秒後移除
                    setTimeout(() => {
                        inkSplash.remove();
                    }, 2000 + i * 100);
                    
                    // 發出輕微提示音效果，幫助使用者理解特效是與成功相關的
                    console.log("墨水擴散效果已創建: " + i);
                }
                
                // 目標字元素的發光動畫 - 保留這個以強調成功字符
                targetElement.style.animation = 'character-glow 1.5s ease-in-out';
                
                // 動畫結束後清除
                setTimeout(() => {
                    targetElement.style.animation = '';
                }, 1500);
            }
            
            // 顯示組字結果
            function showRadicalResult(success) {
                const resultElement = document.getElementById('radical-result');
                resultElement.style.display = 'block';
                
                // 顯示目標字
                const targetWordElement = document.getElementById('target-word');
                targetWordElement.textContent = currentRadicalPuzzle.target;
                
                if (success) {
                    resultElement.className = 'radical-result success';
                    resultElement.querySelector('.radical-result-message').textContent = '非常棒！你成功組字了！';
                    resultElement.querySelector('.radical-result-detail').textContent = 
                        `你成功組合了「${currentRadicalPuzzle.target}」字！`;
                    
                    // 播放成功音效
                    playSuccessSound();
                    
                    // 成功組字特效
                    createSuccessAnimation(targetWordElement);
                } else {
                    resultElement.className = 'radical-result error';
                    resultElement.querySelector('.radical-result-message').textContent = '加油！再試一次！';
                    
                    const correctComponents = currentRadicalPuzzle.components.map(c => getSimplifiedRadical(c)).join('、');
                    resultElement.querySelector('.radical-result-detail').textContent = 
                        `「${currentRadicalPuzzle.target}」字由 ${correctComponents} 組成`;
                }
            }
            
            // 顯示提示
            function showRadicalHint() {
                const hintElement = document.getElementById('radical-hint');
                hintElement.style.display = 'block';
                
                const components = currentRadicalPuzzle.components.map(c => 
                    `「${getSimplifiedRadical(c)}」`
                ).join('和');
                
                hintElement.textContent = `提示：${components}組成「${currentRadicalPuzzle.target}」`;
            }
            
            // 清空工作區
            function clearRadicalWorkspace() {
                // 清空選中列表
                selectedRadicals = [];
                
                // 清空工作區
                const dropArea = document.getElementById('radical-drop-area');
                dropArea.innerHTML = '<div class="drop-placeholder">拖放部首到此處組字</div>';
                
                // 取消所有部首的選中狀態
                const selectedRadicalElements = document.querySelectorAll('.radical-item.selected');
                selectedRadicalElements.forEach(el => {
                    el.classList.remove('selected');
                });
            }
            
            // 設置部首遊戲相關的事件監聽器
            const radicalLevelButtons = document.querySelectorAll('.radical-level .level-btn');
            radicalLevelButtons.forEach(button => {
                button.addEventListener('click', function() {
                    radicalLevelButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentRadicalLevel = this.getAttribute('data-level');
                    startRadicalGame();
                });
            });
            
            // 檢查按鈕
            document.getElementById('radical-check').addEventListener('click', checkRadicalResult);
            
            // 提示按鈕
            document.getElementById('radical-hint-btn').addEventListener('click', showRadicalHint);
            
            // 清空按鈕
            document.getElementById('radical-clear').addEventListener('click', clearRadicalWorkspace);
            
            // 下一題按鈕
            document.getElementById('radical-next').addEventListener('click', startRadicalGame);
            
            // ===== 字詞查詢功能 =====
            
            // 字詞查詢變量
            let currentWord = '';
            
            // 檢查是否為有效的中文字詞
            function isValidChineseWord(text) {
                // 檢查是否為1-10個中文字符（支持單字和詞語）
                return /^[\u4e00-\u9fa5]{1,10}$/.test(text.trim());
            }
            
            // 清理文本中的特殊符號（如萌典API返回的~符號）
            function cleanText(text) {
                if (!text) return '';
                // 移除~符號和其他特殊標記
                return text.replace(/~/g, '').replace(/`/g, '').trim();
            }
            
            // 查詢字詞解釋（統一入口）
            async function fetchWordDefinition(word) {
                currentSearchWord = word; // 更新當前搜索的詞語
                
                // 保存到字詞本查詢歷史
                lastLookedUpWord = word;
                
                try {
                    showWordLoader();
                    hideWordError();
                    
                    // 判斷是單字還是詞語
                    if (word.length === 1) {
                        // 單字查詢：復用筆順查詢的單字解釋功能
                        await fetchSingleCharacterDefinition(word);
                    } else {
                        // 詞語查詢：使用萌典詞語API
                        await fetchMultiCharacterDefinition(word);
                    }
                } catch (error) {
                    console.error('字詞查詢錯誤:', error);
                    showWordError('暫時無法獲取字詞解釋，請稍後重試');
                } finally {
                    hideWordLoader();
                    // 更新收藏按鈕狀態
                    updateFavoriteButtonState('word', word);
                    
                    // 墨寶積分系統 - 詞語查詢獎勵
                    playerData.totalWordsLearned++;
                    playerData.statistics.wordsToday++;
                    playerData.functionsUsed.add('word_lookup');
                    
                    // 首次查詢獎勵
                    if (!playerData.firstTimeActions.has('first_word')) {
                        playerData.firstTimeActions.add('first_word');
                        checkAchievement('first_word');
                    }
                    
                    // 查詢積分獎勵
                    awardPoints(pointRewards.wordLookup, `查詢詞語 +${pointRewards.wordLookup} 🖌️`);
                    
                    // 檢查學習里程成就
                    checkAchievement('word_starter');
                    checkAchievement('word_expert');
                    
                    // 檢查時間相關成就
                    checkAchievement('night_owl');
                    checkAchievement('early_bird');
                }
            }
            
            // 單字查詢（復用筆順查詢功能）
            async function fetchSingleCharacterDefinition(character) {
                const response = await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(character)}`);
                
                if (!response.ok) {
                    throw new Error('查詢失敗');
                }
                
                const data = await response.json();
                console.log('萌典單字API返回數據:', JSON.stringify(data, null, 2));
                
                displaySingleCharacterDefinition(data, character);
            }
            
            // 詞語查詢
            async function fetchMultiCharacterDefinition(word) {
                const response = await fetch(`https://www.moedict.tw/a/${encodeURIComponent(word)}.json`);
                
                if (!response.ok) {
                    throw new Error('查詢失敗');
                }
                
                const data = await response.json();
                console.log('萌典詞語API返回數據:', JSON.stringify(data, null, 2));
                
                displayMultiCharacterDefinition(data, word);
            }
            
            // 顯示單字定義（復用筆順查詢的邏輯）
            function displaySingleCharacterDefinition(data, character) {
                currentWord = character;
                
                // 設置字詞標題
                wordTitle.textContent = character;
                
                // 設置讀音
                let pronunciation = '';
                if (data && data.heteronyms && data.heteronyms.length > 0) {
                    const pronunciations = data.heteronyms.map(h => h.pinyin || '').filter(p => p);
                    if (pronunciations.length > 0) {
                        pronunciation = pronunciations.join('、');
                    }
                }
                wordPronunciation.textContent = pronunciation ? `[${pronunciation}]` : '';
                
                // 保存拼音到查詢歷史
                lastLookedUpWordPinyin = pronunciation;
                
                // 顯示結果區域
                wordResultSection.style.display = 'block';
                
                // 使用與筆順查詢相同的解釋顯示邏輯
                displaySingleCharacterContent(data);
            }
            
            // 顯示單字解釋內容（復用筆順查詢邏輯）
            function displaySingleCharacterContent(data) {
                if (!data || !data.heteronyms || data.heteronyms.length === 0) {
                    wordDefinitionContent.innerHTML = '<div class="definition-item"><div class="definition-text">未找到字義資料</div></div>';
                    return;
                }
                
                let html = '';
                
                // 遍歷所有讀音和釋義（與筆順查詢相同的邏輯）
                data.heteronyms.forEach((heteronym, index) => {
                    if (heteronym.definitions && heteronym.definitions.length > 0) {
                        // 遍歷所有釋義
                        heteronym.definitions.forEach((def, defIndex) => {
                            html += '<div class="definition-item">';
                            
                            // 詞性標籤和中文釋義內容在同一行
                            html += '<div class="definition-main">';
                            if (def.type) {
                                html += `<span class="definition-type">${cleanText(def.type)}</span>`;
                            }
                            if (def.def) {
                                html += `<span class="definition-text">${cleanText(def.def)}</span>`;
                            }
                            html += '</div>';
                            
                            // 英文釋義
                            if (def.english) {
                                html += `<div class="definition-english">🇺🇸 ${cleanText(def.english)}</div>`;
                            }
                            
                            // 檢查是否有其他格式的英文釋義
                            if (def.en) {
                                html += `<div class="definition-english">🇺🇸 ${cleanText(def.en)}</div>`;
                            }
                            
                            // 例句顯示
                            const examples = [];
                            
                            // 檢查 example 字段
                            if (def.example) {
                                if (Array.isArray(def.example)) {
                                    examples.push(...def.example);
                                } else if (typeof def.example === 'string') {
                                    examples.push(def.example);
                                }
                            }
                            
                            // 檢查 quote 字段
                            if (def.quote) {
                                if (Array.isArray(def.quote)) {
                                    examples.push(...def.quote);
                                } else if (typeof def.quote === 'string') {
                                    examples.push(def.quote);
                                }
                            }
                            
                            // 顯示例句（最多2個）
                            examples.slice(0, 2).forEach(example => {
                                if (example && example.trim()) {
                                    // 清理例句中的特殊符號和HTML標籤
                                    let cleanExample = cleanText(example.replace(/<[^>]*>/g, '').trim());
                                    
                                    // 限制例句長度，避免過長
                                    if (cleanExample.length > 50) {
                                        cleanExample = cleanExample.substring(0, 47) + '...';
                                    }
                                    
                                    html += `<div class="definition-example">${cleanExample}</div>`;
                                }
                            });
                            
                            html += '</div>';
                        });
                    }
                });
                
                if (html) {
                    wordDefinitionContent.innerHTML = html;
                } else {
                    wordDefinitionContent.innerHTML = '<div class="definition-item"><div class="definition-text">未找到詳細釋義</div></div>';
                }
            }
            
            // 顯示詞語定義
            function displayMultiCharacterDefinition(data, word) {
                currentWord = word;
                
                // 設置詞語標題
                wordTitle.textContent = word;
                
                // 設置讀音（如果有的話）
                let pronunciation = '';
                if (data && data.h && data.h.length > 0) {
                    const heteronyms = data.h;
                    const pronunciations = heteronyms.map(h => h.p || '').filter(p => p);
                    if (pronunciations.length > 0) {
                        pronunciation = pronunciations.join('、');
                    }
                }
                wordPronunciation.textContent = pronunciation ? `[${pronunciation}]` : '';
                
                // 保存拼音到查詢歷史
                lastLookedUpWordPinyin = pronunciation;
                
                // 顯示結果區域
                wordResultSection.style.display = 'block';
                
                // 設置詞語解釋
                displayMultiCharacterContent(data, word);
            }
            
            // 顯示詞語解釋內容（修復符號問題）
            function displayMultiCharacterContent(data, word) {
                wordDefinitionContent.innerHTML = '';
                
                if (!data || !data.h || data.h.length === 0) {
                    wordDefinitionContent.innerHTML = '<div class="definition-item"><div class="definition-text">未找到詞語資料</div></div>';
                    return;
                }
                
                let html = '';
                
                // 遍歷所有讀音和釋義
                data.h.forEach((heteronym, index) => {
                    if (heteronym.d && heteronym.d.length > 0) {
                        heteronym.d.forEach((definition, defIndex) => {
                            html += '<div class="definition-item">';
                            
                            // 詞性標籤和中文釋義內容在同一行（與單字查詢保持一致）
                            html += '<div class="definition-main">';
                            if (definition.f) {
                                html += `<span class="definition-type">${cleanText(definition.f)}</span>`;
                            }
                            if (definition.d) {
                                html += `<span class="definition-text">${cleanText(definition.d)}</span>`;
                            }
                            html += '</div>';
                            
                            // 顯示例句（如果有，清理特殊符號）
                            if (definition.e && definition.e.length > 0) {
                                definition.e.forEach(example => {
                                    const cleanExample = cleanText(example);
                                    if (cleanExample) {
                                        html += `<div class="definition-example">${cleanExample}</div>`;
                                    }
                                });
                            }
                            
                            html += '</div>';
                        });
                    }
                });
                
                if (html === '') {
                    html = '<div class="definition-item"><div class="definition-text">未找到詳細解釋</div></div>';
                }
                
                wordDefinitionContent.innerHTML = html;
            }
            
            // 顯示字詞查詢錯誤
            function showWordError(message) {
                wordErrorMessage.textContent = message;
                wordErrorMessage.style.display = 'block';
                wordResultSection.style.display = 'none';
            }
            
            // 隱藏字詞查詢錯誤
            function hideWordError() {
                wordErrorMessage.style.display = 'none';
            }
            
            // 顯示字詞查詢載入器
            function showWordLoader() {
                wordLoader.style.display = 'block';
            }
            
            // 隱藏字詞查詢載入器
            function hideWordLoader() {
                wordLoader.style.display = 'none';
            }
            
            // 朗讀字詞
            function speakWord(word) {
                if (!word) return;
                
                if ('speechSynthesis' in window) {
                    // 停止當前語音
                    speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'zh-TW';
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    
                    speechSynthesis.speak(utterance);
                } else {
                    alert('您的瀏覽器不支持語音合成功能');
                }
            }
            
            // 字詞拆字練習功能
            function startWordPractice(word) {
                if (!word) return;
                
                // 獲取詞語中的每個字符
                const characters = Array.from(word);
                
                if (characters.length === 0) return;
                
                // 切換到筆順查詢頁面
                switchMainFunction(navLookup, characterDisplaySection);
                
                // 設置第一個字符進行查詢
                const firstChar = characters[0];
                characterInput.value = firstChar;
                searchButton.click();
                
                // 提示用戶
                setTimeout(() => {
                    alert(`開始練習「${word}」的第一個字「${firstChar}」！\n您可以依次練習每個字的筆順。`);
                }, 500);
            }
            
            // 字詞查詢事件監聽器
            wordSearchButton.addEventListener('click', function() {
                const word = wordInput.value.trim();
                
                if (!word) {
                    showWordError('請輸入字或詞語');
                    return;
                }
                
                if (!isValidChineseWord(word)) {
                    showWordError('請輸入有效的中文字或詞語（1-10個字）');
                    return;
                }
                
                fetchWordDefinition(word);
            });
            
            // 字詞輸入框回車事件
            wordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    wordSearchButton.click();
                }
            });
            
            // 字詞朗讀按鈕事件
            wordSpeakButton.addEventListener('click', function() {
                if (currentWord) {
                    speakWord(currentWord);
                }
            });
            
            // 字詞拆字練習按鈕事件
            wordPracticeButton.addEventListener('click', function() {
                if (currentWord) {
                    startWordPractice(currentWord);
                }
            });
            
            // 最後進行初始化
            // 初始化字詞本
            initVocabularyBook();
            
            // 載入默認漢字
            characterInput.value = '人';
            queryCharacter();
            
        }); // 關閉DOMContentLoaded事件監聽器
    </script>
</body>
</html>
