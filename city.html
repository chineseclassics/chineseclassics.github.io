<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>長安城 2D 模型</title>
  <style>
    html, body { height: 100%; }
    body { margin: 0; background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Heiti SC", sans-serif; }
    .toolbar { position: sticky; top: 0; z-index: 10; padding: 10px 12px; background: rgba(0,0,0,.7); backdrop-filter: blur(6px); border-bottom: 1px solid rgba(255,255,255,.08); display: flex; align-items: center; gap: 12px; }
    .toolbar .title { font-weight: 600; letter-spacing: .5px; }
    .toolbar .hint { opacity: .8; font-size: 14px; }
    .stage { height: calc(100vh - 48px); }
    .stage object { width: 100%; height: 100%; display: block; }
    .btn { padding: 6px 10px; font-size: 14px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color: #fff; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: rgba(255,255,255,.12); }
  </style>
  <script>
    // 可選工具：重置所有區域名稱（使用與 SVG 相同的 localStorage 鍵）
    function resetNames() {
      if (!confirm('確定要重置所有區域名稱嗎？此操作不可還原。')) return;
      try { localStorage.removeItem('changan_area_names'); alert('已重置。重新載入頁面以生效。'); location.reload(); } catch (e) {}
    }
    function exportNames() {
      try {
        var data = localStorage.getItem('changan_area_names') || '{}';
        var blob = new Blob([data], { type: 'application/json;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url; a.download = 'changan_area_names.json'; a.click();
        URL.revokeObjectURL(url);
      } catch (e) {}
    }
    // 導出佈局草稿：掃描嵌入的 SVG，抓取互動矩形與 viewBox
    function exportLayoutDraft() {
      var obj = document.getElementById('changanMap');
      var svg = obj && obj.contentDocument && obj.contentDocument.querySelector('svg');
      if (!svg) { alert('SVG 尚未載入'); return; }
      var vb = (svg.getAttribute('viewBox')||'0 0 1474 1606').split(/\s+/).map(Number);
      var rects = [].slice.call(svg.querySelectorAll('#interactive-areas rect'));
      var labels = [].slice.call(svg.querySelectorAll('#interactive-labels text'));
      var idToName = {}; labels.forEach(function(t){ var id=t.getAttribute('data-id'); if(id){ idToName[id]=t.textContent||('區域 '+id); }});
      var out = {
        meta: { version: 1, viewBox: vb.map(function(n){return isFinite(n)?n:0;}) },
        areas: rects.map(function(r){
          var id = r.getAttribute('data-id') || '';
          var x = parseFloat(r.getAttribute('x')||0);
          var y = parseFloat(r.getAttribute('y')||0);
          var w = parseFloat(r.getAttribute('width')||0);
          var h = parseFloat(r.getAttribute('height')||0);
          // 初始全部標為未知類型，供你勾選：ward/road/palace/market/gate/wall/water
          return { id: id, name: idToName[id]||('區域 '+id), kind: "unknown", clickable: true, bbox: { x:x, y:y, w:w, h:h } };
        })
      };
      var blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json;charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a'); a.href = url; a.download = 'changan-layout-draft.json'; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
  <!--
    提示：嵌入的 file (2).svg 已內建互動腳本，支援：
    - 點擊矩形：選取/取消選取
    - 雙擊矩形：命名區域（自動保存至 localStorage: changan_area_names）
  -->
  </head>
<body>
  <div class="toolbar">
    <div class="title">長安城 2D 模型</div>
    <div class="hint">提示：點擊選中，雙擊命名；名稱會自動保存</div>
    <div style="flex:1"></div>
    <button class="btn" onclick="exportNames()">導出名稱</button>
    <button class="btn" onclick="resetNames()">重置名稱</button>
    <button class="btn" onclick="exportLayoutDraft()">導出佈局草稿</button>
  </div>
  <div class="stage">
    <object id="changanMap" type="image/svg+xml" data="file (2).svg" aria-label="長安城平面圖"></object>
  </div>
</body>
</html>

