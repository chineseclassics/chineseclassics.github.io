<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—é¢¨è©©è©çµ„å¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Supabase UMD -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.56.0/dist/umd/supabase.js"></script>
    <script>
        // æŒ‡å®šæœ¬é ä½¿ç”¨çš„ Supabase å°ˆæ¡ˆåƒæ•¸ï¼ˆè¦†è“‹é è¨­ï¼‰
        window.SUPABASE_URL = 'https://onregacmigwiyomhmjyt.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ucmVnYWNtaWd3aXlvbWhtanl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NzIzMDcsImV4cCI6MjA3NDU0ODMwN30.VxLyR3SMlnVYubFLdQNJqYMyJnT5foo7wUkVEmi4QcY';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆæ·»åŠ æ˜ç¢ºçš„ auth é…ç½®ï¼‰
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
            window.sb = window.supabase.createClient(
                window.SUPABASE_URL, 
                window.SUPABASE_ANON_KEY,
                {
                    auth: {
                        persistSession: true,      // æŒä¹…åŒ– session
                        autoRefreshToken: true,    // è‡ªå‹•åˆ·æ–° token
                        detectSessionInUrl: true,  // æª¢æ¸¬ URL ä¸­çš„ session
                        storage: window.localStorage  // æ˜ç¢ºæŒ‡å®šä½¿ç”¨ localStorage
                    }
                }
            );
            console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸï¼ˆè¯—è¯ç»„å¥ï¼‰');
        } else {
            console.error('âŒ Supabase UMD åº“æœªåŠ è½½');
        }
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ç°ä»£è“ç´«æ¸å˜ä¸»è‰²ç³»
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe', 
                            400: '#38bdf8',
                            500: '#0ea5e9', // ä¸»è“è‰²
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e'
                        },
                        // ç°ä»£è–„è·ç»¿è¾…åŠ©è‰²
                        secondary: {
                            400: '#4ade80',
                            500: '#22c55e', // ä¸»ç»¿è‰²
                            600: '#16a34a',
                            700: '#15803d'
                        },
                        // ç°ä»£ç´«è‰²å¼ºè°ƒè‰²
                        accent: {
                            400: '#a78bfa',
                            500: '#8b5cf6', // ç´«è‰²å¼ºè°ƒ
                            600: '#7c3aed'
                        },
                        // ç°ä»£ä¸­æ€§è‰²èƒŒæ™¯
                        surface: {
                            50: '#fafafa',
                            100: '#f4f4f5',
                            200: '#e4e4e7',
                            800: '#27272a',
                            900: '#18181b'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'kai': ['KaiTi', 'SimKai', 'serif'],
                        'modern': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                        'bounce-gentle': 'bounceGentle 2s ease-in-out infinite',
                        'pulse-modern': 'pulseModern 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                    }
                }
            }
        }
    </script>
    
    <!-- æ·»åŠ åŠ¨ç”»æ•ˆæœ -->
    <style>
        /* å·²é¸å­—æ¨£å¼ï¼ˆæ¸…æ™°å€åˆ†ï¼‰ */
        .character-btn.selected {
            background-color: rgba(59, 121, 96, 0.15);
            border-color: #3B7960;
            box-shadow: 0 0 0 2px rgba(59,121,96,0.35) inset;
            color: #0f172a;
        }
        .character-btn.selected::after {
            content: "âœ“";
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 0.9rem;
            color: #3B7960;
            opacity: 0.95;
        }
        /* é¸ä¸­å­—ä¿æŒé¸ä¸­æ¨£å¼ï¼Œä¸å— hover ç¶ è‰²å½±éŸ¿ */
        .character-btn.selected:hover {
            background-color: rgba(59, 121, 96, 0.15);
            border-color: #3B7960;
            box-shadow: 0 0 0 2px rgba(59,121,96,0.35) inset;
            color: #0f172a;
        }
        /* å­—ç¬¦æŒ‰é’®ç‚¹å‡»åŠ¨ç”» */
        @keyframes buttonPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 10px rgba(59, 121, 96, 0.5); }
            100% { transform: scale(1); }
        }
        
        .animate-click {
            animation: buttonPulse 0.3s ease-in-out;
        }
        
        /* æ­£ç¡®ç­”æ¡ˆåŠ¨ç”» */
        @keyframes correctAnswer {
            0% { transform: scale(1); }
            10% { transform: scale(1.05); }
            20% { transform: scale(1); }
            30% { transform: scale(1.05); }
            40% { transform: scale(1); }
            50% { transform: scale(1.05); }
            60% { transform: scale(1); }
        }
        
        .animate-correct {
            animation: correctAnswer 1s ease-in-out;
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.7);
        }
        
        /* é”™è¯¯ç­”æ¡ˆåŠ¨ç”» */
        @keyframes wrongAnswer {
            0% { transform: translateX(0); }
            10% { transform: translateX(-5px); }
            20% { transform: translateX(5px); }
            30% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            60% { transform: translateX(5px); }
            70% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            90% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .animate-wrong {
            animation: wrongAnswer 0.5s ease-in-out;
        }
        
        /* åˆ†æ•°å˜åŒ–åŠ¨ç”» */
        @keyframes scoreChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #DAA520; }
            100% { transform: scale(1); }
        }
        
        .animate-score {
            animation: scoreChange 0.8s ease-in-out;
        }
        
        /* é¢æ¿æ·¡å…¥åŠ¨ç”» */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* æ–°å¢ï¼šæ·¡å…¥ä¸Šæµ®é€²å ´ */
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(12px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-up { animation: fadeUp 500ms ease-out both; }

        /* æ–°å¢ï¼šç¸®æ”¾é€²å ´ */
        @keyframes scaleIn {
            0% { opacity: 0; transform: scale(0.92); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in { animation: scaleIn 420ms ease-out both; }

        /* æ–°å¢ï¼šæ…¢é€Ÿè„ˆå‹•ï¼ˆç”¨æ–¼ç·Šå¼µæ™‚åˆ»ï¼‰ */
        @keyframes pulseSlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }
        .timer-warning { color: #dc2626; animation: pulseSlow 1s ease-in-out infinite; }

        /* æ–°å¢ï¼šæŒ‰éˆ•æŠ¬å‡èˆ‡å¾®äº’å‹• */
        .interactive {
            transition: transform 160ms ease, box-shadow 200ms ease, background-color 200ms ease, color 200ms ease;
        }
        .interactive:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .interactive:active { transform: translateY(0); box-shadow: 0 2px 6px rgba(0,0,0,0.12); }

        /* ä¸‹ä¸€è¼ªæŒ‰éˆ•ï¼šå°ºå¯¸+10% ä¸¦åŠ å…¥å¸å¼•é»æ“Šçš„æŸ”å’Œè„ˆå‹•èˆ‡å…‰æšˆ */
        .next-round-button {
            border-radius: 1rem; /* èˆ‡ rounded-2xl å°é½Š */
            position: relative;
            transition: transform 180ms ease, box-shadow 240ms ease, filter 240ms ease;
            animation: nextRoundPulse 1.25s ease-in-out infinite;
        }
        .next-round-button:hover {
            box-shadow: 0 16px 40px rgba(14,165,233,0.6), 0 0 0 2px rgba(255,255,255,0.24) inset;
            filter: brightness(1.1);
        }
        .next-round-button:active {
            transform: translateY(0) scale(1.02);
        }
        /* å¤–ç’°å…‰æšˆï¼ˆé transform å‹•ç•«ï¼Œé¿å…èˆ‡ hover ç¸®æ”¾è¡çªï¼‰ */
        .next-round-button::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 125%;
            height: 150%;
            border-radius: 1.2rem;
            pointer-events: none;
            background: radial-gradient(closest-side, rgba(14,165,233,0.5), rgba(14,165,233,0) 74%);
            opacity: 0.0;
            animation: nextRoundGlow 1.5s ease-in-out infinite;
        }
        @keyframes nextRoundPulse {
            0%, 100% { box-shadow: 0 12px 26px rgba(14,165,233,0.46); }
            50% { box-shadow: 0 20px 46px rgba(14,165,233,0.78); }
        }
        @keyframes nextRoundGlow {
            0%, 100% { opacity: 0.38; }
            50% { opacity: 0.78; }
        }

        /* å°æˆ°æ¨¡å¼ç©åˆ†å¡ç‰‡æ¨£å¼ */
        #battleScoreboard { pointer-events: none; }
        #battleScoreboard .player-score-card { pointer-events: auto; }
        .player-score-card {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem;
            border-radius: 1.25rem; /* 20px */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            text-align: center;
        }

        .player-score-card.active {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.9);
            animation: pulse-gentle 1.5s infinite;
        }
        
        /* 6ç§ä¸åŒçš„ç©å®¶ä¸»é¢˜è‰² (èƒŒæ™¯æ¸å˜) */
        .player-theme-1 { background: linear-gradient(180deg, rgba(142, 68, 173, 0.3), rgba(142, 68, 173, 0.1)); } /* ç´« */
        .player-theme-2 { background: linear-gradient(180deg, rgba(41, 128, 185, 0.3), rgba(41, 128, 185, 0.1)); } /* è“ */
        .player-theme-3 { background: linear-gradient(180deg, rgba(39, 174, 96, 0.3), rgba(39, 174, 96, 0.1)); } /* ç»¿ */
        .player-theme-4 { background: linear-gradient(180deg, rgba(241, 196, 15, 0.3), rgba(241, 196, 15, 0.1)); } /* é»„ */
        .player-theme-5 { background: linear-gradient(180deg, rgba(230, 126, 34, 0.3), rgba(230, 126, 34, 0.1)); } /* æ©™ */
        .player-theme-6 { background: linear-gradient(180deg, rgba(192, 57, 43, 0.3), rgba(192, 57, 43, 0.1)); } /* çº¢ */

        .player-theme-1.active { box-shadow: 0 0 30px rgba(142, 68, 173, 0.8); }
        .player-theme-2.active { box-shadow: 0 0 30px rgba(41, 128, 185, 0.8); }
        .player-theme-3.active { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8); }
        .player-theme-4.active { box-shadow: 0 0 30px rgba(241, 196, 15, 0.8); }
        .player-theme-5.active { box-shadow: 0 0 30px rgba(230, 126, 34, 0.8); }
        .player-theme-6.active { box-shadow: 0 0 30px rgba(192, 57, 43, 0.8); }

        .player-name {
            font-family: 'modern', 'KaiTi', sans-serif;
            font-weight: 700;
            font-size: 1.25rem; 
            color: #1F2937; /* æ·±ç°è‰²ï¼Œæé«˜å¯¹æ¯”åº¦ */
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.2);
        }
        
        .player-score {
            font-family: 'modern', sans-serif;
            font-size: 2.25rem;
            font-weight: 900;
            color: #FFFFFF;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5); /* åŠ æ·±é˜´å½± */
        }

        .current-turn-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background-color: #34D399; /* é²œç»¿è‰²æŒ‡ç¤ºç¯ */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px #34D399, 0 0 20px #34D399;
            animation: pulse-gentle 1.5s infinite;
        }

        @keyframes pulse-gentle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        /* æ–°å¢ï¼šå­—å¡å¾®å‹•æ•ˆèˆ‡é»æ“Šæ³¢ç´‹å®¹å™¨ */
        .character-btn {
            position: relative; overflow: hidden;
            transition: transform 120ms ease, box-shadow 180ms ease, background-color 180ms ease, color 180ms ease;
        }
        .character-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.10); }
        .character-btn:active { transform: translateY(0); }
        .character-btn:disabled { transform: none !important; box-shadow: none !important; }

        /* é©åº¦æ”¾å¤§æ¡Œé¢ç«¯å¾…é¸å­—ï¼Œä¸æ”¹paddingï¼Œé¿å…å½±éŸ¿é»æ“Šèˆ‡æ’ç‰ˆ */
        .character-btn.char-modern { font-size: 1.75rem; line-height: 1; }
        @media (min-width: 768px) {
            .character-btn.char-modern { font-size: 2rem; }
        }

        /* æ–°å¢ï¼šé»æ“Šæ³¢ç´‹ */
        .ripple {
            position: absolute; border-radius: 9999px; transform: translate(-50%, -50%);
            background: rgba(59, 121, 96, 0.25); pointer-events: none; width: 10px; height: 10px;
            animation: ripple 600ms ease-out forwards;
        }
        @keyframes ripple {
            from { opacity: 0.35; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(16); }
        }
    </style>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;600;700&display=swap');
        
        /* è‡ªå®šä¹‰å­—ä½“æ ·å¼ - ä½¿ç”¨æ›´é€šç”¨çš„å­—ä½“å †æ ˆ */
        .font-title {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'STHeiti', 'SimHei', 'Heiti SC', 'Noto Sans CJK SC', 'Source Han Sans SC', sans-serif;
            font-weight: 700;
        }
        
        .font-text {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'STHeiti', 'SimHei', 'Heiti SC', 'Noto Sans CJK SC', 'Source Han Sans SC', sans-serif;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #C03A5C;
            border-radius: 4px;
        }
        
        /* ä¸­å›½ä¼ ç»Ÿè£…é¥°è¾¹æ¡† */
        .border-chinese {
            border-image: url('https://cdn.jsdelivr.net/gh/ant-design/ant-design@4.10.0/components/style/color/images/colorPalette.less') 30 stretch;
        }
        
        /* æ°´å¢¨é£æ ¼èƒŒæ™¯ */
        .bg-chinese-light {
            background-color: #f9f5e9;
            background-image: 
                linear-gradient(rgba(249, 245, 233, 0.7), rgba(249, 245, 233, 0.7)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23C03A5C' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .bg-chinese-dark {
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(26, 26, 26, 0.7), rgba(26, 26, 26, 0.7)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23C03A5C' fill-opacity='0.12' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* ä¸­å›½é£çº¸å¼ æ•ˆæœ */
        .paper-effect {
            background-color: #FFF6E5; /* æš–å®£ç´™ */
            box-shadow: 0 6px 18px rgba(12, 16, 39, 0.08);
            position: relative;
            border: 1px solid rgba(46, 125, 109, 0.18);
        }
        
        .paper-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M77 63a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm-50-3a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm2-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm48-3a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12z' fill='%23000000' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
            z-index: 0;
        }
        
        .paper-effect > * {
            position: relative;
            z-index: 1;
        }
        
        .dark .paper-effect {
            background-color: #2a2a2a;
        }

        /* å°ç« æ•ˆæœ */
        .seal {
            position: relative;
        }
        
        .seal::after {
            content: "è©©";
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'STHeiti', 'SimHei', sans-serif;
            color: rgba(192, 58, 92, 0.50);
            font-size: 2.5rem;
            font-weight: bold;
            transform: rotate(-15deg);
            border: 2px solid rgba(192, 58, 92, 0.50);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }
        
        /* æ¯›ç¬”å…‰æ ‡æ•ˆæœ - ä½¿ç”¨ç»è¿‡Base64ç¼–ç çš„å†…åµŒæ¯›ç¬”å›¾æ ‡ */
        .character-btn, 
        #clearSelection, 
        #submitPoem, 
        #nextRound,
        #adminModeToggle,
        #saveCustomPoem,
        button,
        select,
        a {
            cursor: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAF8WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMDgtMDhUMTA6MTA6MDcrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjExZDYwN2VkLTM0NzAtNGRhOC1hZTBmLTU2YTRhNmEyNWVkMCIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjE3YmRlN2E4LWZjMmMtM2I0Zi05NWJlLWIyYWZjYzA2YmExNSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjc1ODRkNTJhLTY5MDUtNGI0OS1iNTBkLTk0OTEwNGU2ZWI1ZCI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6NzU4NGQ1MmEtNjkwNS00YjQ5LWI1MGQtOTQ5MTA0ZTZlYjVkIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEwOjA3KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MTFkNjA3ZWQtMzQ3MC00ZGE4LWFlMGYtNTZhNGE2YTI1ZWQwIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6s3PW0AAAGS0lEQVRYhe2XW2wc1RnHf+fM7M7O7K69u77EMSROY1yTUiUlJCqElqZQXCmKVBrCrYAqSEiAhMQD4oHS9AklXngBISQEVYAXArRRaZuWAiIoUFWlSvNAAoi6SRwIie/r9e7s7F7m8jC21zHeLeqL9H87c77zne87/++c811QVW5kWDeUHuiP5bGzEsxB7NzLXgm8yF5xt57y1r0zGG4+lLrF+UNvtkEPIhLhcxfFT5Y6K98OOF58Y6TlXa+jNOvBLPxYsOeW1xoATZZs5Pl75M+RP4mWNKVadlvQwuWiZrOHVPW9T9VH2b9nIzAA6Jx/ILpRRH4GbEUxPLM5V/cAXm3LXtPO/9Yd6+sKF/xbX4wOb/pDYs9xWA/8+Mujw6LWVWDzBxeLNwzHi+FYYYdv+28B3UFjzVbTiO3oLK0rXfWQUv4vCDR9D+cXhWJhXW2K9qbG3JpGj5sA/T85kQJ2M3OcsgmBnQ3ZrmVEq7/PwtJYrj8Zs9LLW3l5aMPIJT8Cze8M16LJHQqra5d6wuH0WjEi24AO4J++NXRxf+bEbVvTO7uGwhPpBw+mF2/JjKdP6+mdnxnY2gS0AxTyZC70MG//M8nBhkM9Dy5Jnz5QUV8E2AhsSpcCbYNHD84fTh+y4tFHXduevCbRz4iAKt4DJxBjh2fZvyQSjUvU2gwUgIuhTLlHKKFEASzHsYJQpqqyEkh9GsKMoHLDuVXhOPzH7Og7ApkxAI/rAKAjF4+sL9dGPz1/KrjVqxmn4T0P8O56j6qf/3BKy+5/psvNe1y3qCJmYxlxdZtv2wcB9m7fGwU2ASXgjB3PvdPqvbmuPLDmGRG5M0i9FjWX1aWiSybLt3yDhZ8+ghEKzajyZXTHXG+OBJZVzwL0p8f2Ae3V7YTHxhrKIzU5NTQPoFYg56ta0eaHjnH60XpO/KCO/ptixCpiJFsW0frTp6nYfFfs7Fu4KvFEAEZfRaWJPVmQEJ7j3NObOQvQxHIZcLtKhYjBttfV1lY9N3qXEat/JTOe/XD3QAfBLUd8EZEFzCRUAPU6B/+XkZoM9LTnzw+uKxX94pDLXX3p2pnNxqMN09vu5SIg0nj4Xag+D6SCnTlU4GBDrr7Pc/aV6Ww96Tgf7R5qebB3aXB9hk+I6jjyP4kIBsYd0ZpLxejQYxhjIZ5iiYMKgD4gvGfbFgF5GDAAz0/mxsJpY6iISBeXdEZK3qmx7KeEq+gD/8kEUHnddg1uVaEawRiXQ/s1FPX/2P3G3c9XPnEfWFegxPHh7IXyVNLu/VBD7ePMvlAF0NKV3OC7Xut0t2cbn9R0d/uIXDx4+U9/vvOJc2xnTUoiG2bYAgLbDtwcXgcVwqwXHiOw3cuzNTKwLAV9z+S19iQv9Ldk2yZ8/VNvfbbd3zx5x9AjM3kA9G0ZwvB2A9a1Z0BwHLTU1ppL2I/3LPwDBwfb+z+/DP1v5FvDI8mF50cS55rKy9wWwpHLzhnPcbsV0WvSvUGgoihGBKIr1kBoCTC0GnStVNAYQnF3zx0QijMdGp8lZrP0lhUfhJrTGQBvMj2BcM1wXY/A4OTr75y+gvCsPpdZ8cKk0/ysb5d+ZRhjcaH1A0LLVwGUJsbGgbrrIqCaRMZOVZlRu+PfKxvbZoJHXvyZlkd+RaS6mUjDN4l1PUvLz56CQhLgHJCZTVL4GqiI0nA0vbBtjFgNhbE3MRYvksmb53fQev+vady0A3xFBTxnBLBOj5ze3ck9b2HbNcD8TxcYgTwqqKE9i7sG0g+NjBl7+hsWdHa08uLOteTa1qMa4BfTRFz4VhORMBOH3sOMVBGqnMf1k/jjTB0mIEtmdHCTCxgawAj6dMEVQsMGElW0Pfon3Pcp0M0q7vH0kZ+yM3UIcDeA/wFmJLRzcQNZNQGGU/3jw2M3leKB11oGGrJVw2nK9eDdFXZ93s89PpxpWJRVMZFrZ/lKsMCYihxMj51NjPVfbTw+4evKh6/K8M9DqICiXlPh3MTRjsUWqjQDGUH+BF+9XR/5rNbSHQA87QnVdEpEvgCiS+M+u2fH7v4bqgZoA30OAgLaIQB6vf8m+q9fwpcZdwCW+xvg/wHA/4vAjbiM/wJrDSl2bWPqbQAAAABJRU5ErkJggg==") 1 25, auto;
        }
        
        /* ç¡®ä¿é¼ æ ‡æ‚¬åœçŠ¶æ€ä¸‹ä¹Ÿä½¿ç”¨æ¯›ç¬”å…‰æ ‡ */
        .character-btn:hover,
        button:hover,
        select:hover,
        a:hover {
            cursor: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAF8WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMDgtMDhUMTA6MTA6MDcrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjExZDYwN2VkLTM0NzAtNGRhOC1hZTBmLTU2YTRhNmEyNWVkMCIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjE3YmRlN2E4LWZjMmMtM2I0Zi05NWJlLWIyYWZjYzA2YmExNSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjc1ODRkNTJhLTY5MDUtNGI0OS1iNTBkLTk0OTEwNGU2ZWI1ZCI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6NzU4NGQ1MmEtNjkwNS00YjQ5LWI1MGQtOTQ5MTA0ZTZlYjVkIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEwOjA3KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MTFkNjA3ZWQtMzQ3MC00ZGE4LWFlMGYtNTZhNGE2YTI1ZWQwIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6s3PW0AAAGS0lEQVRYhe2XW2wc1RnHf+fM7M7O7K69u77EMSROY1yTUiUlJCqElqZQXCmKVBrCrYAqSEiAhMQD4oHS9AklXngBISQEVYAXArRRaZuWAiIoUFWlSvNAAoi6SRwIie/r9e7s7F7m8jC21zHeLeqL9H87c77zne87/++c811QVW5kWDeUHuiP5bGzEsxB7NzLXgm8yF5xt57y1r0zGG4+lLrF+UNvtkEPIhLhcxfFT5Y6K98OOF58Y6TlXa+jNOvBLPxYsOeW1xoATZZs5Pl75M+RP4mWNKVadlvQwuWiZrOHVPW9T9VH2b9nIzAA6Jx/ILpRRH4GbEUxPLM5V/cAXm3LXtPO/9Yd6+sKF/xbX4wOb/pDYs9xWA/8+Mujw6LWVWDzBxeLNwzHi+FYYYdv+28B3UFjzVbTiO3oLK0rXfWQUv4vCDR9D+cXhWJhXW2K9qbG3JpGj5sA/T85kQJ2M3OcsgmBnQ3ZrmVEq7/PwtJYrj8Zs9LLW3l5aMPIJT8Cze8M16LJHQqra5d6wuH0WjEi24AO4J++NXRxf+bEbVvTO7uGwhPpBw+mF2/JjKdP6+mdnxnY2gS0AxTyZC70MG//M8nBhkM9Dy5Jnz5QUV8E2AhsSpcCbYNHD84fTh+y4tFHXduevCbRz4iAKt4DJxBjh2fZvyQSjUvU2gwUgIuhTLlHKKFEASzHsYJQpqqyEkh9GsKMoHLDuVXhOPzH7Og7ApkxAI/rAKAjF4+sL9dGPz1/KrjVqxmn4T0P8O56j6qf/3BKy+5/psvNe1y3qCJmYxlxdZtv2wcB9m7fGwU2ASXgjB3PvdPqvbmuPLDmGRG5M0i9FjWX1aWiSybLt3yDhZ8+ghEKzajyZXTHXG+OBJZVzwL0p8f2Ae3V7YTHxhrKIzU5NTQPoFYg56ta0eaHjnH60XpO/KCO/ptixCpiJFsW0frTp6nYfFfs7Fu4KvFEAEZfRaWJPVmQEJ7j3NObOQvQxHIZcLtKhYjBttfV1lY9N3qXEat/JTOe/XD3QAfBLUd8EZEFzCRUAPU6B/+XkZoM9LTnzw+uKxX94pDLXX3p2pnNxqMN09vu5SIg0nj4Xag+D6SCnTlU4GBDrr7Pc/aV6Ww96Tgf7R5qebB3aXB9hk+I6jjyP4kIBsYd0ZpLxejQYxhjIZ5iiYMKgD4gvGfbFgF5GDAAz0/mxsJpY6iISBeXdEZK3qmx7KeEq+gD/8kEUHnddg1uVaEawRiXQ/s1FPX/2P3G3c9XPnEfWFegxPHh7IXyVNLu/VBD7ePMvlAF0NKV3OC7Xut0t2cbn9R0d/uIXDx4+U9/vvOJc2xnTUoiG2bYAgLbDtwcXgcVwqwXHiOw3cuzNTKwLAV9z+S19iQv9Ldk2yZ8/VNvfbbd3zx5x9AjM3kA9G0ZwvB2A9a1Z0BwHLTU1ppL2I/3LPwDBwfb+z+/DP1v5FvDI8mF50cS55rKy9wWwpHLzhnPcbsV0WvSvUGgoihGBKIr1kBoCTC0GnStVNAYQnF3zx0QijMdGp8lZrP0lhUfhJrTGQBvMj2BcM1wXY/A4OTr75y+gvCsPpdZ8cKk0/ysb5d+ZRhjcaH1A0LLVwGUJsbGgbrrIqCaRMZOVZlRu+PfKxvbZoJHXvyZlkd+RaS6mUjDN4l1PUvLz56CQhLgHJCZTVL4GqiI0nA0vbBtjFgNhbE3MRYvksmb53fQev+vady0A3xFBTxnBLBOj5ze3ck9b2HbNcD8TxcYgTwqqKE9i7sG0g+NjBl7+hsWdHa08uLOteTa1qMa4BfTRFz4VhORMBOH3sOMVBGqnMf1k/jjTB0mIEtmdHCTCxgawAj6dMEVQsMGElW0Pfon3Pcp0M0q7vH0kZ+yM3UIcDeA/wFmJLRzcQNZNQGGU/3jw2M3leKB11oGGrJVw2nK9eDdFXZ93s89PpxpWJRVMZFrZ/lKsMCYihxMj51NjPVfbTw+4evKh6/K8M9DqICiXlPh3MTRjsUWqjQDGUH+BF+9XR/5rNbSHQA87QnVdEpEvgCiS+M+u2fH7v4bqgZoA30OAgLaIQB6vf8m+q9fwpcZdwCW+xvg/wHA/4vAjbiM/wJrDSl2bWPqbQAAAABJRU5ErkJggg==") 1 25, pointer;
        }
        
        /* ç¦ç”¨çŠ¶æ€ä»ç„¶ä½¿ç”¨é»˜è®¤å…‰æ ‡ */
        .character-btn:disabled {
            cursor: not-allowed;
        }
        
        /* iframeç’°å¢ƒå„ªåŒ– */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari åœ¨ iframe ä¸­çš„ç‰¹æ®Šè™•ç† */
            html, body {
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                -webkit-overflow-scrolling: touch;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
            }
        }
        
        /* å¼·åˆ¶å…ƒç´ ä¸è¶…å‡ºé‚Šç•Œ */
        * {
            box-sizing: border-box;
        }
        
        /* ç¢ºä¿å­—ç¬¦æŒ‰éˆ•å¯é»æ“Š */
        .character-btn {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ç§»å‹•ç«¯iframeå…¨å±å„ªåŒ– */
        @media (max-width: 768px) {
            /* ä¸»å®¹å™¨å„ªåŒ– */
            .max-w-5xl {
                padding: 0.25rem !important;
                height: 100vh !important;
                height: 100dvh !important;
            }

            /* å¤´éƒ¨åŒºåŸŸå‹ç¼© */
            .flex.justify-between.items-center.mb-3 {
                margin-bottom: 0.5rem !important;
            }

            /* æ ‡é¢˜åŒºåŸŸå‹ç¼© */
            .font-title {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* æ§åˆ¶æŒ‰é’®åŒºåŸŸå‹ç¼© */
            .flex.items-center.justify-end.space-x-2.mb-2 {
                margin-bottom: 0.25rem !important;
            }

            /* è¯—å¥æ˜¾ç¤ºåŒºåŸŸä¼˜åŒ– */
            .paper-effect.p-3.rounded-lg.shadow-md.border.border-secondary\/30.seal {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* æ±‰å­—é€‰æ‹©åŒºåŸŸæ ‡é¢˜å‹ç¼© */
            #charactersGrid + div h2 {
                font-size: 1rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* å­—ç¬¦æŒ‰é’®å¤§å°è°ƒæ•´ */
            .character-btn {
                padding: 0.5rem !important;
                font-size: 1.25rem !important;
            }

            /* è¯—æ­Œæ˜¾ç¤ºæ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– - ä¿æŒä¸€è¡Œé«˜åº¦ */
            #poemDisplay {
                font-size: 1.25rem !important;
                height: 2.5rem !important;
                line-height: 2.5rem !important;
                padding: 0.25rem !important;
                overflow: hidden !important;
                white-space: nowrap !important;
            }

            /* æŒ‰é’®åŒºåŸŸå‹ç¼© */
            .flex.justify-center.space-x-20.mt-4 {
                margin-top: 0.5rem !important;
                gap: 1rem !important;
            }

            .flex.justify-center.space-x-20.mt-4 button {
                padding: 0.5rem 1rem !important;
                font-size: 1rem !important;
            }

            /* å­—ç¬¦ç½‘æ ¼ä¼˜åŒ– - ç¡®ä¿æ˜¾ç¤º3è¡Œï¼Œå»æ‰æ»šåŠ¨æ¡ */
            #charactersGrid {
                grid-template-rows: repeat(3, 1fr) !important;
                gap: 0.25rem !important;
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 4px !important;
            }

            /* æ±‰å­—é€‰æ‹©åŒºåŸŸå®¹å™¨ä¼˜åŒ– */
            .paper-effect.p-3.rounded-lg.shadow-md.border.border-secondary\/30 {
                overflow: visible !important;
                max-height: none !important;
            }

            /* æ¸¸æˆæ¶ˆæ¯åŒºåŸŸç§»åŠ¨ç«¯ä¼˜åŒ– */
            #gameMessage {
                width: 95vw !important;
                top: 50% !important;
                left: 50% !important;
            }

            #gameMessage .glass-card-strong {
                padding: 1rem !important;
            }

            #correctAnswer {
                font-size: 2rem !important; /* ç§»åŠ¨ç«¯é€‚ä¸­å¤§å° */
                padding: 0.75rem !important;
            }
        }

        /* è¶…å°å±å¹•è¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (max-width: 480px) {
            .character-btn {
                padding: 0.375rem !important;
                font-size: 1.125rem !important;
            }

            #poemDisplay {
                font-size: 1.125rem !important;
                height: 2.25rem !important;
                line-height: 2.25rem !important;
                overflow: hidden !important;
                white-space: nowrap !important;
            }

            .font-title {
                font-size: 1.25rem !important;
            }
        }

        /* ç°ä»£åŒ–åŠ¨ç”»æ•ˆæœ */
        @keyframes slideUp {
            0% { 
                transform: translateY(20px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounceGentle {
            0%, 100% { 
                transform: translateY(0); 
            }
            50% { 
                transform: translateY(-4px); 
            }
        }

        @keyframes pulseModern {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.03);
                opacity: 0.9;
            }
        }

        /* æµ®çª—ä¸“ç”¨åŠ¨ç”» */
        @keyframes modalSlideIn {
            0% { 
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes modalSlideOut {
            0% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }
        }

        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-card-strong {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* è¨­ç½®æ¨¡æ…‹çª—å£ - ç¾ä»£ç»ç’ƒæ“¬æ…‹èˆ‡æ›´é«˜å°æ¯” */
        .glass-modal {
            background: linear-gradient(180deg, rgba(255,255,255,0.94), rgba(255,255,255,0.88));
            backdrop-filter: blur(24px) saturate(120%);
            -webkit-backdrop-filter: blur(24px) saturate(120%);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.18);
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - é€‚é…ä½é€æ˜åº¦èƒŒæ™¯ */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
            background-clip: content-box;
        }

        /* ç°ä»£åŒ–æŒ‰é’®æ•ˆæœ */
        .modern-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .modern-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* å­—ç¬¦æŒ‰é’®ç°ä»£åŒ– */
        .char-modern {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .char-modern:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.95);
        }

        /* æ¸å˜èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
        }

        .gradient-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #22c55e 0%, #4ade80 100%);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        /* AI è§£è®€å°ˆç”¨æ¨£å¼ï¼Œèˆ‡ä¸»æŒ‰éˆ•è‰²ç³»å€åˆ†ä¸”å”èª¿ */
        .ai-explain-button {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #111827;
        }
        .ai-explain-button:hover { filter: brightness(1.05); }
        .ai-explain-loading { opacity: 0.7; pointer-events: none; }

        /* AI å…§å®¹ç¾åŒ– */
        .ai-section {
            border-radius: 1rem;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(14px);
            padding: 12px 14px;
        }
        .ai-title {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 0.9rem;
            color: #0f172a;
            background: linear-gradient(135deg, #e0f2fe, #fae8ff);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 999px;
            padding: 4px 10px;
            margin-bottom: 8px;
        }
        .ai-body { color: #0f172a; line-height: 1.7; font-size: 0.95rem; }
        .ai-poem-block {
            white-space: pre-wrap;
            font-family: ui-serif, Georgia, "Noto Serif CJK TC", serif;
            font-size: 1rem;
            color: #0f172a;
            background: rgba(255,255,255,0.75);
            border: 1px dashed rgba(15,23,42,0.2);
            border-radius: 0.75rem;
            padding: 10px 12px;
        }
        .ai-highlight {
            background: linear-gradient(180deg, rgba(250,204,21,0.45), rgba(250,204,21,0.15));
            border-radius: 8px;
            padding: 0 4px;
            font-weight: 800;
            color: #92400e;
        }
        .ai-toggle {
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #0f172a;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 999px;
            padding: 6px 10px;
        }

        /* AI è¼‰å…¥å‹•ç•« */
        @keyframes aiSpin { to { transform: rotate(360deg); } }
        .ai-loading-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 18px 0; }
        .ai-spinner {
            width: 28px; height: 28px; border-radius: 9999px;
            border: 3px solid rgba(15,23,42,0.15);
            border-top-color: #8b5cf6; /* èˆ‡ accent å”èª¿ */
            animation: aiSpin 1s linear infinite;
        }
        .ai-loading-text { margin-top: 10px; font-size: 0.9rem; color: #334155; }

        /* å°æˆ°çµæœçª—å£ç¾åŒ– */
        #battleResultModal .winner-card {
            position: relative;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.22), rgba(255, 165, 0, 0.12));
            border: 2px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 12px 32px rgba(212, 163, 0, 0.25);
            overflow: hidden;
        }
        #battleResultModal .winner-card::after {
            content: "";
            position: absolute;
            left: -60%;
            top: -50%;
            width: 60%;
            height: 200%;
            transform: rotate(25deg);
            background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.35), rgba(255,255,255,0.0));
            animation: winnerShine 2.6s ease-in-out infinite;
        }
        @keyframes winnerShine {
            0% { left: -60%; }
            60% { left: 120%; }
            100% { left: 120%; }
        }

        #battleResultModal .rank-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.9rem;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(17, 24, 39, 0.08);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
            opacity: 0;
            transform: translateY(10px);
            animation: slideIn 540ms ease-out forwards;
        }

        #battleResultModal .rank-item:hover {
            transform: translateY(0) scale(1.01);
            box-shadow: 0 16px 28px rgba(0,0,0,0.14);
        }

        #battleResultModal .rank-medal { font-size: 1.25rem; }
        #battleResultModal .rank-name { color: #0f172a; font-weight: 700; }
        #battleResultModal .rank-score { margin-left: auto; font-weight: 800; color: #0f172a; }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'XiqueGuZiDian';
            src: url('https://chineseclassics.github.io/files/fonts/%E5%96%9C%E9%B9%8A%E5%8F%A4%E5%AD%97%E5%85%B8%E4%BD%93(%E7%AE%80+%E7%B9%81%E4%BD%93).ttf') format('truetype');
            font-display: swap;
        }
        @font-face {
            font-family: 'HuaKangGuJiMiLiuGBK';
            src: url('https://chineseclassics.github.io/files/fonts/%E5%8D%8E%E5%BA%B7%E5%8F%A4%E7%B1%8D%E7%B3%B8%E6%9F%B3GBK.TTF') format('truetype');
            font-display: swap;
        }
        .font-xique-guzidian {
            font-family: 'XiqueGuZiDian', serif;
        }
        .font-huakang-miliu {
            font-family: 'HuaKangGuJiMiLiuGBK', serif;
        }
        .font-ma-shan-zheng {
            font-family: 'Ma Shan Zheng', cursive;
        }
    </style>
    
    <!-- Font Awesome å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å¤ªè™›å¹»å¢ƒæ‡‰ç”¨åˆ‡æ›å™¨çµ„ä»¶ -->
    <script src="/assets/js/taixu-app-switcher.js"></script>
</head>
<body class="font-modern gradient-bg" style="margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; display: flex; flex-direction: column;">
    <div class="max-w-5xl mx-auto" style="height: 100%; width: 100%; display: flex; flex-direction: column; padding: 6px; box-sizing: border-box; position: relative;">
        <!-- é¸æ‰‹ç©åˆ†é¡¯ç¤ºå€åŸŸï¼ˆå·¦å³å…©å´å›ºå®šï¼‰ -->
        <div id="battleScoreboard" class="hidden z-10">
            <!-- å·¦å´é¸æ‰‹ç©åˆ†ï¼ˆå›ºå®šåœ¨å·¦ï¼‰ -->
            <div id="leftPlayers" class="fixed left-2 top-1/2 -translate-y-1/2 flex flex-col space-y-2 w-40"></div>
            
            <!-- å³å´é¸æ‰‹ç©åˆ†ï¼ˆå›ºå®šåœ¨å³ï¼‰ -->
            <div id="rightPlayers" class="fixed right-2 top-1/2 -translate-y-1/2 flex flex-col space-y-2 w-40"></div>
        </div>
        <div class="flex justify-between items-center mb-3">
            <!-- å·¦ä¾§å¾—åˆ†/è¼ªæ¬¡æ˜¾ç¤º - ç°ä»£åŒ– -->
            <div class="glass-card p-3 sm:p-4 rounded-2xl flex items-center animate-slide-up modern-button" style="animation-delay:40ms">
                <span id="scoreLabel" class="font-modern text-sm sm:text-base text-surface-800 font-medium">åˆ†æ•¸</span>
                <span id="score" class="text-2xl sm:text-4xl font-bold text-primary-500 ml-2 sm:ml-3">0</span>
            </div>
            
            <!-- ä¸­é—´æ ‡é¢˜ - ç°ä»£åŒ– -->
            <div class="flex-grow flex flex-col items-center justify-center mx-3 relative animate-slide-up" style="animation-delay:80ms">
                <!-- æ¸¸æˆæ ‡é¢˜ -->
                <div class="flex-grow flex items-center justify-center">
                    <h1 class="text-3xl sm:text-4xl text-black font-huakang-miliu font-black leading-none" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.2);">å—é¢¨è©©è©çµ„å¥</h1>
                </div>
                
                <!-- å‰¯æ ‡é¢˜ -->
                <div class="text-xs text-surface-800/70 mt-1 font-modern tracking-wide">
                    ä¸­æ–‡ç¶“å…¸AIå¯¦é©—å®¤
                </div>
            </div>
            
            <!-- å³ä¾§å€’è®¡æ—¶ - ç°ä»£åŒ– -->
            <div class="glass-card-strong p-3 sm:p-4 rounded-2xl flex items-center animate-slide-up modern-button gradient-accent" style="animation-delay:120ms">
                <span id="timer" class="text-2xl sm:text-4xl font-bold text-white font-modern">30</span>
                <span class="font-modern text-sm sm:text-base text-white/90 ml-1 font-medium">ç§’</span>
            </div>
        </div>
        
        <!-- å€’è¨ˆæ™‚é€²åº¦æ¢ / è³½é“å®¹å™¨ -->
        <div id="timeBarContainer" class="w-full h-6 sm:h-7 bg-surface-200 rounded-full overflow-hidden mb-3 animate-scale-in shadow-inner relative">
            <div id="timeBarFill" class="h-full gradient-primary rounded-full transition-all duration-300 ease-out" style="width: 100%"></div>
            <!-- é ç¨‹/æœ¬åœ°å°æˆ°ï¼šè³½é“è¦–åœ–ï¼ˆæ™‚é–“æ¢ä¸Šå±¤è¦†è“‹ï¼‰ -->
            <div id="raceTrack" class="absolute inset-0 hidden px-1 flex items-center gap-1"></div>
        </div>
        
        <div class="flex items-center justify-end space-x-3 mb-2">
            <div id="difficultySelector" class="inline-block glass-card px-3 py-2 rounded-xl hidden animate-slide-up">
                <span class="font-modern text-xs text-surface-800 mr-2 font-medium">é›£åº¦ï¼š</span>
                <select id="difficultySelect" class="bg-white/90 rounded-lg px-3 py-1 text-xs border-none focus:ring-2 focus:ring-primary-400 font-modern">
                    <option value="easy">ç°¡å–®</option>
                    <option value="medium" selected>ä¸­ç­‰</option>
                    <option value="hard">å›°é›£</option>
                </select>
            </div>
            <button id="soundToggle" class="glass-card hover:glass-card-strong text-surface-800 px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                </svg>
                éŸ³æ•ˆé–‹
            </button>
            <button id="localBattleBtn" class="glass-card hover:glass-card-strong text-white px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern bg-gradient-to-r from-secondary-500 to-secondary-600 border-none shadow-md transform transition-transform hover:scale-105">
                <span class="mr-1.5">ğŸ‘¥</span>
                æœ¬åœ°å°æˆ°
            </button>
            <button id="remoteBattleBtn" class="glass-card hover:glass-card-strong text-white px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern bg-gradient-to-r from-primary-500 to-accent-500 border-none shadow-md transform transition-transform hover:scale-105">
                <span class="mr-1.5">ğŸŒ</span>
                é ç¨‹å°æˆ°
            </button>
            <button id="adminModeToggle" class="glass-card hover:glass-card-strong text-surface-800 px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                è¨­ç½®
            </button>
        </div>
        
        <!-- å°æˆ°çµæŸç¸½çµçª—å£ -->
        <div id="battleResultModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(500px,90vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- çª—å£æ¨™é¡Œ -->
                <div class="flex justify-center items-center p-6 border-b border-white/20 gradient-primary rounded-t-3xl flex-shrink-0">
                    <h2 class="text-2xl font-modern font-bold text-white">ğŸ† å°æˆ°çµæœ</h2>
                </div>
                
                <!-- å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
                <div class="overflow-y-auto custom-scrollbar flex-grow p-6">
                    <!-- è·èƒœè€…å¡ç‰‡ -->
                    <div id="winnerCard" class="winner-card p-6 rounded-2xl text-center mb-6 transform transition-all duration-500 hover:scale-105">
                        <div class="text-2xl font-modern font-black mb-2 text-surface-900" id="winnerAnnouncement"></div>
                        <div class="text-lg font-modern font-semibold text-surface-700" id="winnerScore"></div>
                    </div>
            
                    <!-- é€‰æ‰‹æ’è¡Œæ¦œ -->
                    <div>
                        <h3 class="text-xl font-modern font-bold mb-4 text-center text-surface-900">ğŸ“Š æœ€çµ‚æ’è¡Œæ¦œ</h3>
                        <div id="battleRankings" class="space-y-3">
                            <!-- æ’è¡Œæ¦œå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <!-- åº•éƒ¨æŒ‰éˆ• -->
                <div class="flex justify-center space-x-4 p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <button id="newBattleBtn" class="gradient-primary text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">
                        ğŸ”„ å†ä¾†ä¸€å±€
                    </button>
                    <button id="exitBattleBtn" class="glass-card text-surface-800 px-6 py-3 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">
                        ğŸ  å›åˆ°å–®äººæ¨¡å¼
                    </button>
                </div>
            </div>
        </div>

        <!-- æœ¬åœ°å°æˆ°æ¨¡æ…‹çª—å£ -->
        <div id="localBattleModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(600px,90vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- å½ˆçª—æ¨™é¡Œ -->
                <div class="flex justify-between items-center p-6 border-b border-white/20 bg-gradient-to-r from-secondary-500 to-secondary-600 rounded-t-3xl flex-shrink-0">
                    <h2 class="text-2xl font-modern font-bold text-white">ğŸ‘¥ æœ¬åœ°å°æˆ°è¨­ç½®</h2>
                    <button id="closeLocalBattleModal" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                
                <!-- å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
                <div class="overflow-y-auto custom-scrollbar flex-grow">
                    <!-- è¨­ç½®å…§å®¹ -->
                    <div class="p-6 space-y-6">
                        <!-- é¸æ‰‹è¨­ç½® -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">ğŸ‘¥ é¸æ‰‹è¨­ç½®</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="font-modern text-sm text-surface-800">é¸æ‰‹æ•¸é‡ï¼š</span>
                                    <select id="localPlayerCount" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern">
                                        <option value="2" selected>2åé¸æ‰‹</option>
                                        <option value="3">3åé¸æ‰‹</option>
                                        <option value="4">4åé¸æ‰‹</option>
                                        <option value="5">5åé¸æ‰‹</option>
                                        <option value="6">6åé¸æ‰‹</option>
                                        <option value="7">7åé¸æ‰‹</option>
                                        <option value="8">8åé¸æ‰‹</option>
                                        <option value="9">9åé¸æ‰‹</option>
                                        <option value="10">10åé¸æ‰‹</option>
                                        <option value="11">11åé¸æ‰‹</option>
                                        <option value="12">12åé¸æ‰‹</option>
                                        <option value="13">13åé¸æ‰‹</option>
                                        <option value="14">14åé¸æ‰‹</option>
                                        <option value="15">15åé¸æ‰‹</option>
                                        <option value="16">16åé¸æ‰‹</option>
                                        <option value="17">17åé¸æ‰‹</option>
                                        <option value="18">18åé¸æ‰‹</option>
                                        <option value="19">19åé¸æ‰‹</option>
                                        <option value="20">20åé¸æ‰‹</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-modern text-sm text-surface-800 mb-2 block">é¸æ‰‹åç¨±ï¼š</label>
                                    <div id="localPlayerNamesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <!-- é¸æ‰‹åç¨±è¼¸å…¥æ¡†å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ¯”è³½è¨­ç½® -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">ğŸ® æ¯”è³½è¨­ç½®</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between gap-3">
                                    <label for="localQuestionCount" class="font-modern text-sm text-surface-800">é¡Œç›®æ•¸ï¼š</label>
                                    <input id="localQuestionCount" type="number" min="5" max="100" value="10" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern w-28" />
                                </div>
                                <div class="flex items-center justify-between gap-3">
                                    <label for="localPoemSetSelect" class="font-modern text-sm text-surface-800">è©©è©åº«ï¼š</label>
                                    <select id="localPoemSetSelect" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern flex-1">
                                        <!-- è©©è©åº«é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                                    </select>
                                </div>
                                <div class="flex items-center justify-between gap-3">
                                    <label for="localSpeedMode" class="font-modern text-sm text-surface-800">é€Ÿåº¦æ¨¡å¼ï¼ˆç­”é¡Œè¶Šå¿«å¾—åˆ†è¶Šé«˜ï¼‰</label>
                                    <input id="localSpeedMode" type="checkbox" class="w-5 h-5 accent-secondary-600" />
                                </div>
                            </div>
                        </div>

                        <!-- æç¤ºä¿¡æ¯ -->
                        <div class="glass-card rounded-2xl p-4 border border-blue-200/60 bg-blue-50">
                            <h3 class="text-base font-modern font-semibold text-blue-700 mb-2">ğŸ’¡ éŠæˆ²èªªæ˜</h3>
                            <ul class="text-sm font-modern text-blue-700 leading-relaxed space-y-1">
                                <li>â€¢ é¸æ‰‹åœ¨åŒä¸€å°è¨­å‚™ä¸Šè¼ªæµç­”é¡Œ</li>
                                <li>â€¢ ç­”å°å¾—åˆ†ï¼Œç­”éŒ¯ä¸æ‰£åˆ†</li>
                                <li>â€¢ æ‰€æœ‰é¡Œç›®å®Œæˆå¾Œçµ±è¨ˆæœ€çµ‚æ’å</li>
                                <li>â€¢ æ™‚é–“é™åˆ¶å’Œå¾…é¸å­—æ•¸é‡å¯åœ¨"è¨­ç½®"ä¸­èª¿æ•´</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- å½ˆçª—åº•éƒ¨æŒ‰éˆ• -->
                <div class="flex justify-end items-center p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <div class="flex space-x-3">
                        <button id="cancelLocalBattle" class="glass-card text-surface-800 px-6 py-3 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">
                            å–æ¶ˆ
                        </button>
                        <button id="startLocalBattle" class="bg-gradient-to-r from-secondary-500 to-secondary-600 text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">
                            é–‹å§‹å°æˆ°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨­ç½®æ¨¡æ…‹å½ˆçª— -->
        <div id="settingsModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(600px,90vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- å½ˆçª—æ¨™é¡Œ -->
                <div class="flex justify-between items-center p-6 border-b border-white/20 gradient-primary rounded-t-3xl flex-shrink-0">
                    <h2 class="text-2xl font-modern font-bold text-white">âš™ï¸ éŠæˆ²è¨­ç½®</h2>
                    <button id="closeSettingsModal" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                
                <!-- å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
                <div class="overflow-y-auto custom-scrollbar flex-grow">
                    <!-- è¨­ç½®å…§å®¹ -->
                    <div class="p-6 space-y-6">
                        <!-- 1. è©©è©åº«ç®¡ç† -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">ğŸ“š è©©è©åº«ç®¡ç†</h3>
                            <div class="space-y-3">
                                <div class="p-3 rounded-xl bg-blue-50 border border-blue-200">
                                    <p class="text-xs font-modern text-blue-700">
                                        <span class="font-semibold">ğŸ’¡ èªªæ˜ï¼š</span>æ­¤è™•è©©è©åº«é¸æ“‡åƒ…å½±éŸ¿<span class="font-semibold">å–®äººæ¨¡å¼</span>ã€‚æœ¬åœ°å°æˆ°å’Œé ç¨‹å°æˆ°çš„è©©è©åº«å¯åœ¨å„è‡ªçš„å°æˆ°è¨­ç½®ä¸­é¸æ“‡ã€‚
                                    </p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="text-sm font-modern text-surface-800">å–®äººæ¨¡å¼è©©è©åº«ï¼š</label>
                                    <select id="userLibraryTagSelect" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-primary text-sm font-modern flex-1"></select>
                                </div>
                                <div class="pt-3 border-t border-white/20">
                                    <h4 class="text-sm font-modern font-semibold text-surface-700 mb-2">è©©è©åº«å°å…¥/å°å‡º</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="exportExcelBtn" class="glass-card text-surface-800 px-3 py-1.5 rounded-lg modern-button text-sm border border-white/30">å°å‡º Excel</button>
                                        <button id="importExcelBtn" class="gradient-secondary text-white px-3 py-1.5 rounded-lg modern-button text-sm">å°å…¥ Excel</button>
                                        <input id="importExcelInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
                                    </div>
                                    <p class="text-xs text-surface-600 mt-2">æç¤ºï¼šExcel æ¨¡æ¿æ¬„ä½ç‚º lineï¼ˆè©©å¥ï¼‰ã€authorï¼ˆä½œè€…ï¼‰ã€poemï¼ˆè©©åï¼‰ã€tagsï¼ˆå¯ç”¨ä¸­æ–‡åˆ†è™Ÿã€Œï¼›ã€æˆ–ä¸­æ–‡é€—è™Ÿã€Œï¼Œã€åˆ†éš”ï¼›äº¦æ”¯æ´å¤šåˆ— tag1ã€tag2...ï¼‰ã€‚</p>
                                </div>
                            </div>
                        
                            
                        </div>
            
                        <!-- 2. å…¨å±€éŠæˆ²åƒæ•¸ -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">âš™ï¸ å…¨å±€éŠæˆ²åƒæ•¸</h3>
                            <div class="p-3 rounded-xl bg-amber-50 border border-amber-200 mb-4">
                                <p class="text-xs font-modern text-amber-700">
                                    <span class="font-semibold">âš¡ èªªæ˜ï¼š</span>ä»¥ä¸‹è¨­ç½®å°‡å½±éŸ¿<span class="font-semibold">æ‰€æœ‰æ¨¡å¼</span>ï¼ˆå–®äººã€æœ¬åœ°å°æˆ°ã€é ç¨‹å°æˆ°ï¼‰ã€‚
                                </p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="p-3 rounded-xl bg-gradient-to-br from-white/80 to-blue-50 border border-gray-200 backdrop-blur-sm shadow-sm hover:shadow-md hover:ring-1 hover:ring-blue-200 transition">
                                    <label class="flex items-center justify-between text-sm font-modern font-medium mb-2 text-surface-800">
                                        <span>â±ï¸ æ™‚é–“é™åˆ¶</span>
                                        <span class="inline-flex items-center gap-1">
                                            <span id="timeLimitValue" class="font-semibold text-blue-600">30</span>
                                            <span class="text-xs text-surface-600">ç§’</span>
                                        </span>
                                    </label>
                                    <input type="range" id="timeLimit" min="10" max="60" step="5" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                    <div class="flex justify-between mt-1 text-sm text-surface-600">
                                        <span>10</span>
                                        <span>60</span>
                                    </div>
                                </div>
                                <div class="p-3 rounded-xl bg-gradient-to-br from-white/80 to-emerald-50 border border-gray-200 backdrop-blur-sm shadow-sm hover:shadow-md hover:ring-1 hover:ring-emerald-200 transition">
                                    <label class="flex items-center justify-between text-sm font-modern font-medium mb-2 text-surface-800">
                                        <span>ğŸ”£ å¾…é¸å­—æ•¸é‡</span>
                                        <span class="inline-flex items-center gap-1">
                                            <span id="charCountValue" class="font-semibold text-emerald-600">20</span>
                                            <span class="text-xs text-surface-600">å­—</span>
                                        </span>
                                    </label>
                                    <input type="range" id="charCount" min="10" max="30" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                    <div class="flex justify-between mt-1 text-sm text-surface-600">
                                        <span>10</span>
                                        <span>30</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å½ˆçª—åº•éƒ¨æŒ‰éˆ• -->
                <div class="flex justify-end items-center p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <div class="flex space-x-3">
                        <button id="cancelSettings" class="glass-card text-surface-800 px-6 py-3 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">
                            å–æ¶ˆ
                        </button>
                        <button id="saveSettings" class="gradient-primary text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">
                            ä¿å­˜è¨­ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å°æˆ°æ¨¡å¼é–‹å ´é è¦½ -->
        <div id="battlePreviewModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/40 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(640px,92vw)] max-h-[88vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-white/20 gradient-accent rounded-t-3xl flex-shrink-0">
                    <div>
                        <h2 class="text-2xl font-modern font-bold text-white">âš”ï¸ å°æˆ°å³å°‡é–‹å§‹</h2>
                        <p class="text-sm text-white/80 mt-1 font-modern">ç¢ºèªåƒè³½è³‡è¨Šï¼Œæº–å‚™è¯éº—çš„è©©è©å°æ±º</p>
                    </div>
                    <button id="battlePreviewClose" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-grow p-6 space-y-5">
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">åƒè³½éšŠä¼</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-3xl font-bold text-primary-600" id="battlePreviewPlayerCount">0</span>
                                <span class="text-sm font-modern text-surface-700">ä½é¸æ‰‹è¼ªæµæ‡‰æˆ°</span>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">æ¯ä½é¡Œæ•¸</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-3xl font-bold text-secondary-600" id="battlePreviewRounds">0</span>
                                <span class="text-sm font-modern text-surface-700">é¡Œï¼é¸æ‰‹</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">ç¸½é¡Œæ•¸</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-3xl font-bold text-amber-600" id="battlePreviewTotalQuestions">0</span>
                                <span class="text-sm font-modern text-surface-700">é¡Œå³å°‡å‡ºé¡Œ</span>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">å›åˆè¨­å®š</h3>
                            <div class="space-y-1 text-sm font-modern text-surface-700">
                                <div>ç­”é¡Œæ™‚é™ï¼š<span class="font-semibold text-surface-900" id="battlePreviewTimeLimit">0 ç§’</span></div>
                                <div>å¾…é¸å­—æ•¸ï¼š<span class="font-semibold text-surface-900" id="battlePreviewCharCount">0 å­—</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-md">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-modern font-semibold text-surface-800">åƒè³½åå–®</h3>
                            <span class="text-xs text-surface-500 font-modern">å°‡ä¾æ¬¡ä¸Šå ´ç­”é¡Œ</span>
                        </div>
                        <div id="battlePreviewPlayersList" class="grid gap-3 sm:grid-cols-2"></div>
                    </div>
                    <div id="battlePreviewSpeedRow" class="glass-card rounded-2xl p-4 border border-accent-200/60 bg-accent-50 shadow-inner hidden">
                        <h3 class="text-base font-modern font-semibold text-accent-700 mb-2">â±ï¸ é€Ÿåº¦æ¨¡å¼åŠ åˆ†</h3>
                        <p id="battlePreviewSpeedText" class="text-sm font-modern text-accent-700"></p>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/15">
                        <h3 class="text-base font-modern font-semibold text-surface-800 mb-2">å°æˆ°æç¤º</h3>
                        <p id="battlePreviewNote" class="text-sm font-modern text-surface-600 leading-relaxed"></p>
                    </div>
                </div>
                <div class="flex justify-between items-center p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <button id="battlePreviewBack" class="glass-card text-surface-800 px-5 py-2.5 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">è¿”å›è¨­ç½®</button>
                    <button id="battlePreviewStart" class="gradient-primary text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">é–‹å§‹å°æˆ°</button>
                </div>
            </div>
        </div>

        <!-- AI è§£è®€æ¨¡æ…‹å½ˆçª— -->
        <div id="aiExplainModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(680px,92vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- æ¨™é¡Œå€ -->
                <div class="flex justify-between items-center p-5 border-b border-white/20 gradient-accent rounded-t-3xl flex-shrink-0">
                    <h2 class="text-xl font-modern font-bold text-white">âœ¨ AI è§£è®€</h2>
                    <button id="aiExplainClose" class="text-white/90 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                <!-- å…§å®¹å€ -->
                <div class="p-5 overflow-auto space-y-4">
                    <div class="glass-card rounded-2xl p-4">
                        <div class="text-xs font-modern text-surface-800/70 mb-1">è©©å¥</div>
                        <div id="aiExplainLine" class="text-2xl font-kai font-bold text-primary-700"></div>
                        <div id="aiExplainMeta" class="text-xs font-modern text-surface-700 mt-1"></div>
                    </div>
                    <div id="aiExplainContent" class="font-modern text-surface-800 space-y-3"></div>
                    <div id="aiExplainError" class="hidden text-red-600 text-sm font-modern"></div>
                </div>
                <!-- åº•éƒ¨æŒ‰éˆ• -->
                <div class="flex justify-end items-center gap-3 p-4 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <button id="aiExplainReload" class="glass-card text-surface-800 px-4 py-2 rounded-xl font-modern font-semibold border border-white/30 modern-button">é‡æ–°ç”Ÿæˆ</button>
                    <button id="aiExplainOK" class="gradient-primary text-white px-5 py-2 rounded-xl font-modern font-semibold modern-button">é—œé–‰</button>
                </div>
            </div>
        </div>

        <!-- è¯—å¥æ˜¾ç¤ºåŒºåŸŸ - ç°ä»£åŒ– -->
        <div class="glass-card-strong p-4 rounded-3xl mb-4 animate-slide-up" style="animation-delay:160ms">
            <!-- é¢˜ç›®ä½œè€…ä¿¡æ¯å’Œå­—æ•° - åŒä¸€è¡Œæ˜¾ç¤º -->
            <div class="text-center mb-5">
                <div class="inline-flex items-center space-x-6">
                    <!-- é¢˜ç›®ä½œè€…ä¿¡æ¯ -->
                    <div id="poemHint" class="text-base md:text-lg font-kai font-bold px-5 py-3 rounded-2xl glass-card text-surface-800 transform transition-all duration-500 hover:scale-105 animate-pulse-modern modern-button"></div>
                    
                    <!-- å­—æ•°æ˜¾ç¤º -->
                    <div class="inline-flex items-center space-x-2">
                        <span id="charCountDisplay" class="text-xl font-modern font-black text-white bg-gradient-to-br from-accent-500 to-accent-600 rounded-full w-12 h-12 flex items-center justify-center shadow-lg animate-bounce-gentle modern-button"></span>
                        <span class="text-sm font-modern text-surface-800 font-semibold">å­—</span>
            </div>
        </div>
            </div>
            
            <!-- è¯—å¥è¾“å…¥æ¡† - æ›´å¤§å­—ä½“ç°ä»£åŒ– -->
            <div class="flex items-center justify-center mb-2">
                <div class="relative w-full">
                    <input id="poemDisplay" type="text" class="w-full px-4 rounded-2xl glass-card text-4xl font-kai font-bold text-center focus:outline-none text-surface-800 transition-all duration-300" readonly style="height: 4.5rem; line-height: 4.5rem; text-align-last: center;">
                    <!-- é”™è¯¯å›¾æ ‡ - åŠ¨æ€å®šä½åœ¨æ–‡å­—å³ä¾§ -->
                    <div id="poemErrorIcon" class="hidden absolute top-1/2 transform -translate-y-1/2 pointer-events-none">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center animate-pulse">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç­”å°æƒ…æ³ï¼šAI è§£è®€æŒ‰éˆ•ç½®æ–¼ç©å®¶ç­”æ¡ˆæ­£ä¸‹æ–¹ï¼ŒåŒå€å¡Šå…§ -->
            <div id="aiExplainSuccessRow" class="hidden mb-3 flex justify-center">
                <button id="aiExplainBtnSuccess" class="ai-explain-button px-4 py-2 rounded-2xl font-modern font-semibold text-xs shadow-md modern-button" title="AI è§£è®€æ­¤å¥">âœ¨ AI è§£è®€</button>
            </div>
            
            <!-- æ¸¸æˆç»“æœåŒºåŸŸ - ä½äºè¯—å¥è¾“å…¥æ¡†ä¸‹æ–¹ -->
            <div id="gameMessage" class="hidden mb-3">
                <div class="glass-card p-3 rounded-2xl text-center border border-white/20 backdrop-blur-lg">
                    <!-- æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º -->
                    <div id="correctAnswer" class="hidden mb-2">
                        <div class="text-xs font-modern text-surface-800/60 mb-2">æ­£ç¢ºç­”æ¡ˆ</div>
                        <div id="correctAnswerText" class="text-4xl font-kai font-bold text-primary-600 py-2 px-3 glass-card rounded-xl"></div>
                        <!-- ç­”éŒ¯æƒ…æ³ï¼šAI è§£è®€æŒ‰éˆ•ç½®æ–¼æ­£ç¢ºè©©å¥æ­£ä¸‹æ–¹ï¼ŒåŒå€å¡Šå…§ -->
                        <div id="aiExplainFailRow" class="hidden mt-2 flex justify-center">
                            <button id="aiExplainBtnFail" class="ai-explain-button px-4 py-2 rounded-2xl font-modern font-semibold text-xs shadow-md modern-button" title="AI è§£è®€æ­¤å¥">âœ¨ AI è§£è®€</button>
                        </div>
                    </div>
                    
                    <!-- æˆåŠŸæ—¶åªæ˜¾ç¤ºå›¾æ ‡ï¼Œä¸æ˜¾ç¤ºé¢å¤–æ–‡å­— -->
                    <div id="successIcon" class="hidden mb-3">
                        <div class="w-12 h-12 mx-auto rounded-full gradient-secondary flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- ä¸‹ä¸€è½®æŒ‰é’® -->
                    <button id="closeGameMessage" class="gradient-primary text-white px-8 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button next-round-button">
                        ä¸‹ä¸€è¼ª
                    </button>
                </div>
            </div>
            
            <div id="selectionStatus" class="text-right text-xs text-surface-800/70 font-modern font-medium">å·²é¸ 0 / 0</div>
        </div>
        
        <!-- æ±‰å­—é€‰æ‹©åŒºåŸŸ - ç°ä»£åŒ– -->
        <div class="glass-card-strong rounded-3xl p-4 animate-slide-up" style="flex: 1; min-height: 0; display: flex; flex-direction: column; max-height: none; overflow: visible; animation-delay:200ms">
            <h2 class="text-sm font-modern font-semibold mb-3 text-surface-800 animate-slide-up" style="flex-shrink: 0; animation-delay:240ms">é»é¸æ¼¢å­—çµ„æˆè©©å¥</h2>
            <div id="charactersGrid" class="grid grid-cols-5 gap-3" style="flex: 1; overflow: visible; padding: 8px; display: grid; align-content: start; max-height: none;">
                <!-- Characters will be inserted here by JavaScript -->
            </div>
            
            <!-- ç°ä»£åŒ–æŒ‰é’®å¸ƒå±€ -->
            <div class="flex justify-center space-x-8 mt-4" style="flex-shrink: 0;">
                <button id="clearSelection" class="gradient-secondary text-white px-6 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button animate-slide-up" style="animation-delay:280ms">é€€ä¸€å­—</button>
                <button id="submitPoem" class="gradient-primary text-white px-8 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button animate-slide-up" style="animation-delay:320ms">æäº¤</button>
            </div>
        </div>
        
        <!-- Custom notification element - ç°ä»£åŒ– -->
        <div id="notification" class="fixed top-6 right-6 left-6 transform transition-all duration-500 ease-out translate-y-[-150%] z-50">
            <div class="max-w-md mx-auto glass-card-strong border border-white/30 shadow-2xl p-4 rounded-2xl animate-slide-up">
                <div class="flex items-center">
                    <div class="text-accent-500 flex-shrink-0">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p id="notificationText" class="text-sm text-surface-800 font-modern font-medium"></p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button id="closeNotification" class="text-surface-800/60 hover:text-surface-800 focus:outline-none modern-button">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ çµ±ä¸€éŠæˆ²ç‹€æ…‹ç®¡ç†ï¼ˆé‡æ§‹ v2.0ï¼‰============
        window.GameState = {
            // ===== æ ¸å¿ƒæ¨¡å¼æ¨™è­˜ =====
            mode: 'solo',        // 'solo' | 'remote' | 'local'
            subMode: null,       // remote: 'timed_score' | 'turn_based' | 'relay'
                                 // local:  'turn_based' | 'buzzer' | 'coop'
            isActive: false,
            
            // ===== ç©å®¶æ•¸æ“šï¼ˆçµ±ä¸€çµæ§‹ï¼‰ =====
            players: [],
            // æ¯å€‹ç©å®¶å°è±¡çµæ§‹ï¼š
            // {
            //   uid: string,          // é ç¨‹: Supabase user_id; æœ¬åœ°: 'L0', 'L1'...
            //   name: string,         // é¡¯ç¤ºåç¨±
            //   emoji: string,        // è³½é“é¡¯ç¤ºç”¨å‹•ç‰© emoji
            //   score: number,        // ç•¶å‰åˆ†æ•¸
            //   answered: number,     // å·²ç­”é¡Œæ•¸
            //   correct: number,      // æ­£ç¢ºæ•¸
            //   lastAnswerTs: number, // æœ€å¾Œç­”é¡Œæ™‚é–“æˆ³ï¼ˆç”¨æ–¼æ’åï¼‰
            //   isReady: boolean,     // é ç¨‹: æº–å‚™ç‹€æ…‹
            //   isActive: boolean     // æœ¬åœ°è¼ªæµ: ç•¶å‰å›åˆæ¨™è¨˜
            // }
            
            // ===== é ç¨‹å°æˆ°å°ˆç”¨ =====
            remote: {
                room: null,           // Supabase room å°è±¡
                channel: null,        // Realtime channel
                currentUserId: null,  // ç•¶å‰ç”¨æˆ¶ ID
                isHost: false,        // æ˜¯å¦ç‚ºæˆ¿ä¸»
                seenEids: {}          // äº‹ä»¶å»é‡è¨˜éŒ„
            },
            
            // ===== é™æ™‚æ¨¡å¼å°ˆç”¨ =====
            timed: {
                endsAt: 0,            // çµæŸæ™‚é–“æˆ³
                duration: 0,          // ç¸½æ™‚é•·ï¼ˆç§’ï¼‰
                timer: null           // setInterval å¼•ç”¨
            },
            
            // ===== å›åˆåˆ¶å°ˆç”¨ =====
            turnBased: {
                currentTurnIndex: 0,  // æœ¬åœ°è¼ªæµ: ç•¶å‰ç©å®¶ç´¢å¼•
                roundsPerPlayer: 3,   // æ¯äººå›åˆæ•¸
                currentRound: 0,      // ç•¶å‰å›åˆ
                totalRounds: 0        // ç¸½å›åˆæ•¸
            },
            
            // ===== éŠæˆ²å…§å®¹ =====
            content: {
                tag: 'all',           // è©©è©åº«æ¨™ç±¤
                currentQuestion: null,// ç•¶å‰é¡Œç›®
                options: []           // ç•¶å‰é¸é …
            }
        };
        
        // ===== æ¨¡å¼åˆ¤æ–·å·¥å…·å‡½æ•¸ï¼ˆçµ±ä¸€æ¥å£ï¼‰=====
        window.GameMode = {
            isSolo: () => window.GameState.mode === 'solo',
            isRemote: () => window.GameState.mode === 'remote',
            isLocal: () => window.GameState.mode === 'local',
            isTimedScore: () => window.GameState.mode === 'remote' && window.GameState.subMode === 'timed_score',
            isTurnBased: () => (window.GameState.mode === 'remote' && window.GameState.subMode === 'turn_based') ||
                               (window.GameState.mode === 'local' && window.GameState.subMode === 'turn_based'),
            isAnyBattle: () => window.GameState.isActive && (window.GameState.mode === 'remote' || window.GameState.mode === 'local')
        };
        
        // ã€é‡æ§‹ã€‘å·²ç§»é™¤ syncLegacyToGameState()ï¼Œæ‰€æœ‰æ•¸æ“šç›´æ¥åœ¨ GameState ä¸­ç®¡ç†
        
        // æª¢æ¸¬iframeç’°å¢ƒä¸¦å„ªåŒ–å¸ƒå±€
        function optimizeForIframe() {
            // æª¢æ¸¬æ˜¯å¦åœ¨iframeä¸­
            const inIframe = window.parent !== window;
            
            if (inIframe) {
                // ç¢ºä¿bodyä½¿ç”¨å¯¦éš›çš„iframeå°ºå¯¸
                const updateBodySize = () => {
                    const body = document.body;
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    
                    // å¼·åˆ¶è¨­ç½®ç²¾ç¢ºå°ºå¯¸
                    body.style.width = width + 'px';
                    body.style.height = height + 'px';
                    body.style.maxWidth = width + 'px';
                    body.style.maxHeight = height + 'px';
                    body.style.overflow = 'hidden';
                    
                    // ç¢ºä¿æ²’æœ‰å¤šé¤˜çš„é‚Šè·
                    body.style.margin = '0';
                    body.style.padding = '0';
                };
                
                // åˆå§‹è¨­ç½®
                updateBodySize();
                
                // ç›£è½çª—å£å¤§å°è®ŠåŒ–
                window.addEventListener('resize', updateBodySize);
                window.addEventListener('orientationchange', () => {
                    setTimeout(updateBodySize, 100);
                });
            }
        }

        // ===== Local Storage å·¥å…·èˆ‡éµå =====
        const LS_KEYS = {
            settings: 'sczj_settings_v1',
            userLibrary: 'sczj_user_library_v1',
            activeTag: 'sczj_active_library_tag_v1'
        };

        function lsSafeParse(json, fallback) {
            try { return JSON.parse(json); } catch { return fallback; }
        }

        function loadSettings() {
            const raw = localStorage.getItem(LS_KEYS.settings);
            return lsSafeParse(raw, {
                gameMode: 'single',
                poemDatabase: 'default',
                timeLimit: 30,
                charCount: 20,
                difficulty: 'medium',
                soundOn: true,
                battle: { playerCount: 2, roundsPerPlayer: 5, speedMode: false, playerNames: [] }
            });
        }

        function persistSettings(settings) {
            localStorage.setItem(LS_KEYS.settings, JSON.stringify(settings));
        }

        

        // ç”¨æˆ¶åº«ï¼ˆçµ±ä¸€çš„ poems é™£åˆ—ï¼‰èˆ‡æ¨™ç±¤
        function loadUserLibrary() {
            const raw = localStorage.getItem(LS_KEYS.userLibrary);
            const data = lsSafeParse(raw, { poems: [] });
            return (data && Array.isArray(data.poems)) ? data : { poems: [] };
        }
        function saveUserLibrary(data) {
            localStorage.setItem(LS_KEYS.userLibrary, JSON.stringify(data));
        }
        function loadActiveTag() {
            return localStorage.getItem(LS_KEYS.activeTag) || '';
        }
        function saveActiveTag(tag) {
            localStorage.setItem(LS_KEYS.activeTag, tag || '');
        }

        // å°å‡º/å°å…¥å·¥å…·
        function computePoemStableId(poem) {
            const a = (poem.author || '').trim().toLowerCase();
            const b = (poem.poem || '').trim().toLowerCase();
            const c = (poem.line || '').trim().toLowerCase();
            return `${a}|${b}|${c}`;
        }
        function normalizePoem(poem) {
            return {
                line: String(poem.line || '').trim(),
                author: String(poem.author || '').trim(),
                poem: String(poem.poem || '').trim(),
                tags: Array.isArray(poem.tags)
                    ? poem.tags.map(t => String(t).trim()).filter(Boolean)
                    : []
            };
        }
        function mergePoemsUnique(list) {
            const map = new Map();
            list.forEach(p0 => {
                const p = normalizePoem(p0);
                if (!p.line || !p.author || !p.poem) return;
                const id = computePoemStableId(p);
                if (!map.has(id)) {
                    map.set(id, { ...p, tags: [...new Set(p.tags)] });
                } else {
                    const old = map.get(id);
                    // ä»¥æ–°å…§å®¹ç‚ºæº–ï¼ˆä¾¿æ–¼å¤–éƒ¨ç”¨ Excel/JSON ä¿®è¨‚ï¼‰
                    const merged = {
                        line: p.line || old.line,
                        author: p.author || old.author,
                        poem: p.poem || old.poem,
                        tags: Array.from(new Set([...(old.tags||[]), ...(p.tags||[])]))
                    };
                    map.set(id, merged);
                }
            });
            return Array.from(map.values());
        }
        function buildExportPoems() {
            return mergePoemsUnique(getAllPoemsUnified());
        }
        function downloadBlob(filename, blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }
        function exportAsExcel() {
            const poems = buildExportPoems();
            const rows = poems.map(p => ({
                line: p.line,
                author: p.author,
                poem: p.poem,
                tags: (p.tags || []).join('ï¼›')
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'poems');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            downloadBlob('poems-export.xlsx', blob);
        }
        // JSON å°å…¥/å°å‡ºå·²ç§»é™¤
        function importFromExcelFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
                    const incoming = rows.map(r => {
                        // æ”¯æ´å¤šç¨®åˆ†éš”ï¼šä¸­æ–‡åˆ†è™Ÿã€ä¸­æ–‡é€—è™Ÿã€é “è™Ÿã€è‹±æ–‡åˆ†è™Ÿ/é€—è™Ÿã€æ›è¡Œã€ç©ºç™½
                        const rawTags = [];
                        const cell = (r.tags ?? '').toString();
                        if (cell) rawTags.push(...cell.split(/[ï¼›;ï¼Œ,ã€\n\r\t ]+/));
                        // æ”¯æ´å¤šåˆ— tag1, tag2, æ¨™ç±¤1, æ¨™ç±¤2 ...
                        Object.keys(r).forEach(k => {
                            const kNorm = String(k).toLowerCase();
                            if (/^tag\d+$/.test(kNorm) || /^æ¨™ç±¤\d+$/.test(k)) {
                                const v = (r[k] ?? '').toString().trim();
                                if (v) rawTags.push(v);
                            }
                        });
                        const tags = rawTags.map(s => s.trim()).filter(Boolean);
                        return normalizePoem({
                            line: r.line,
                            author: r.author,
                            poem: r.poem,
                            tags
                        });
                    });
                    // è¦†è“‹æ¨¡å¼ï¼šä»¥æœ¬æ¬¡ Excel çš„å…§å®¹å®Œå…¨æ›¿æ›ç”¨æˆ¶åº«
                    const replaced = mergePoemsUnique(incoming);
                    saveUserLibrary({ poems: replaced });
                    populateUserTagSelect();
                    showNotification(`å·²å°å…¥ ${incoming.length} é¦–è©©ï¼ˆExcelï¼‰`);
                } catch (e) {
                    alert('Excel å°å…¥å¤±æ•—ï¼š' + e.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å·²ç§»é™¤æš—è‰²æ¨¡å¼è‡ªå‹•åˆ‡æ›ï¼Œçµ±ä¸€ä½¿ç”¨äº®è‰²ä¸»é¡Œ
        
        // éŸ³æ•ˆç®¡ç†é¡
        class SoundManager {
            constructor() {
                this.audioContext = null;
                this.isMuted = false;
                this.sounds = {};
                this.init();
            }
            
            init() {
                try {
                    // å‰µå»ºéŸ³é »ä¸Šä¸‹æ–‡
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                    
                    // å‰µå»ºå„ç¨®éŸ³æ•ˆ
                    this.createSounds();
                } catch (e) {
                    console.error('Web Audio API ä¸æ”¯æŒ:', e);
                }
            }
            
            createSounds() {
                // æ¼¢å­—é»æ“ŠéŸ³æ•ˆ (å¤ç®éŸ³è‰²)
                this.sounds.charClick = {
                    play: () => this.playTone(600, 0.1, "triangle", 0.3)
                };
                
                // å›ç­”æ­£ç¢ºéŸ³æ•ˆ (ä¸­åœ‹å‚³çµ±æ¨‚å™¨éŸ³è‰²)
                this.sounds.correct = {
                    play: () => {
                        // æ¨¡æ“¬ä¸­åœ‹å‚³çµ±æ¨‚å™¨çš„éŸ³éš
                        setTimeout(() => this.playTone(523.25, 0.15, "sine", 0.4), 0);   // C5
                        setTimeout(() => this.playTone(587.33, 0.15, "sine", 0.4), 150); // D5
                        setTimeout(() => this.playTone(659.25, 0.15, "sine", 0.4), 300); // E5
                        setTimeout(() => this.playTone(783.99, 0.3, "sine", 0.4), 450);  // G5
                    }
                };
                
                // å›ç­”éŒ¯èª¤éŸ³æ•ˆ
                this.sounds.wrong = {
                    play: () => {
                        setTimeout(() => this.playTone(349.23, 0.2, "sine", 0.4), 0);    // F4
                        setTimeout(() => this.playTone(329.63, 0.3, "sine", 0.4), 250);  // E4
                    }
                };
                
                // æ™‚é–“è­¦å‘ŠéŸ³æ•ˆ
                this.sounds.timeWarning = {
                    play: () => {
                        setTimeout(() => this.playTone(440, 0.1, "sine", 0.2), 0);  
                        setTimeout(() => this.playTone(440, 0.1, "sine", 0.2), 200);
                    }
                };
                
                // æ™‚é–“çµæŸéŸ³æ•ˆ
                this.sounds.timeUp = {
                    play: () => {
                        setTimeout(() => this.playTone(523.25, 0.15, "sawtooth", 0.3), 0);    // C5
                        setTimeout(() => this.playTone(392.00, 0.15, "sawtooth", 0.3), 200);  // G4
                        setTimeout(() => this.playTone(329.63, 0.3, "sawtooth", 0.3), 400);   // E4
                    }
                };
                
                // æŒ‰éˆ•é»æ“ŠéŸ³æ•ˆ
                this.sounds.buttonClick = {
                    play: () => this.playTone(440, 0.1, "sine", 0.15)
                };
                
                // æ–°å›åˆé–‹å§‹éŸ³æ•ˆ
                this.sounds.newRound = {
                    play: () => {
                        // é¡ä¼¼æ–¼ä¸­åœ‹å‚³çµ±éŸ³æ¨‚çš„äº”è²éŸ³éš (C, D, E, G, A)
                        setTimeout(() => this.playTone(523.25, 0.15, "sine", 0.3), 0);    // C5
                        setTimeout(() => this.playTone(587.33, 0.15, "sine", 0.3), 120);   // D5
                        setTimeout(() => this.playTone(659.25, 0.15, "sine", 0.3), 240);   // E5
                        setTimeout(() => this.playTone(783.99, 0.15, "sine", 0.3), 360);   // G5
                        setTimeout(() => this.playTone(880.00, 0.3, "sine", 0.3), 480);    // A5
                    }
                };
            }
            
            // æ’­æ”¾éŸ³èª¿
            playTone(frequency, duration, type = "sine", volume = 0.5) {
                if (this.isMuted || !this.audioContext) return;
                
                try {
                    // å¦‚æœéŸ³é »ä¸Šä¸‹æ–‡è¢«æš«åœï¼Œé‡å•Ÿå®ƒ
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    // å‰µå»ºæŒ¯ç›ªå™¨
                    const oscillator = this.audioContext.createOscillator();
                    oscillator.type = type;
                    oscillator.frequency.value = frequency;
                    
                    // å‰µå»ºéŸ³é‡æ§åˆ¶
                    const gainNode = this.audioContext.createGain();
                    gainNode.gain.value = volume;
                    
                    // é€£æ¥ç¯€é»
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // è¨­ç½®è¡°æ¸›
                    gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                    
                    // æ’­æ”¾è²éŸ³
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.error('æ’­æ”¾éŸ³æ•ˆå¤±æ•—:', e);
                }
            }
            
            // åˆ‡æ›éœéŸ³
            toggleMute() {
                this.isMuted = !this.isMuted;
                return this.isMuted;
            }
            
            // æ’­æ”¾æŒ‡å®šéŸ³æ•ˆ
            play(soundName) {
                if (this.isMuted || !this.sounds[soundName]) return;
                this.sounds[soundName].play();
            }
        }
        
        // å‰µå»ºå…¨å±€éŸ³æ•ˆç®¡ç†å™¨
        const soundManager = new SoundManager();

        // å°å­¸ç”Ÿè©©è©æ•¸æ“šåº« - å¾æä¾›çš„æ–‡ä»¶ä¸­é¸å–çš„ç¶“å…¸è©©å¥
        const elementaryPoemLines = [
            // è˜‡è»¾ä½œå“
            { line: "è·ç›¡å·²ç„¡æ“é›¨è“‹", author: "è˜‡è»¾", poem: "è´ˆåˆ˜æ™¯æ–‡" },
            { line: "èŠæ®˜çŒ¶æœ‰å‚²éœœæ", author: "è˜‡è»¾", poem: "è´ˆåˆ˜æ™¯æ–‡" },
            { line: "ä¸€å¹´å¥½æ™¯å›é ˆè¨˜", author: "è˜‡è»¾", poem: "è´ˆåˆ˜æ™¯æ–‡" },
            { line: "æœ€æ˜¯æ©™é»ƒæ©˜ç¶ æ™‚", author: "è˜‡è»¾", poem: "è´ˆåˆ˜æ™¯æ–‡" },
            
            { line: "æ©«çœ‹æˆå¶ºå´æˆå³°", author: "è˜‡è»¾", poem: "é¡Œè¥¿æ—å£" },
            { line: "é è¿‘é«˜ä½å„ä¸åŒ", author: "è˜‡è»¾", poem: "é¡Œè¥¿æ—å£" },
            { line: "ä¸è­˜å»¬å±±çœŸé¢ç›®", author: "è˜‡è»¾", poem: "é¡Œè¥¿æ—å£" },
            { line: "åªç·£èº«åœ¨æ­¤å±±ä¸­", author: "è˜‡è»¾", poem: "é¡Œè¥¿æ—å£" },
            
            { line: "ç«¹å¤–æ¡ƒèŠ±ä¸‰å…©æ", author: "è˜‡è»¾", poem: "æƒ å´‡æ˜¥æ±Ÿæ™šæ™¯" },
            { line: "æ˜¥æ±Ÿæ°´æš–é´¨å…ˆçŸ¥", author: "è˜‡è»¾", poem: "æƒ å´‡æ˜¥æ±Ÿæ™šæ™¯" },
            
            { line: "æ¬²æŠŠè¥¿æ¹–æ¯”è¥¿å­", author: "è˜‡è»¾", poem: "é£²æ¹–ä¸Šåˆæ™´å¾Œé›¨" },
            { line: "æ·¡å¦æ¿ƒæŠ¹ç¸½ç›¸å®œ", author: "è˜‡è»¾", poem: "é£²æ¹–ä¸Šåˆæ™´å¾Œé›¨" },
            
            // ç‹å®‰çŸ³ä½œå“
            { line: "å¢»è§’æ•¸ææ¢…", author: "ç‹å®‰çŸ³", poem: "æ¢…èŠ±" },
            { line: "å‡Œå¯’ç¨è‡ªé–‹", author: "ç‹å®‰çŸ³", poem: "æ¢…èŠ±" },
            { line: "é™çŸ¥ä¸æ˜¯é›ª", author: "ç‹å®‰çŸ³", poem: "æ¢…èŠ±" },
            { line: "ç‚ºæœ‰æš—é¦™ä¾†", author: "ç‹å®‰çŸ³", poem: "æ¢…èŠ±" },
            
            { line: "æ˜¥é¢¨åˆç¶ æ±Ÿå—å²¸", author: "ç‹å®‰çŸ³", poem: "æ³Šèˆ¹ç“œæ´²" },
            { line: "æ˜æœˆä½•æ™‚ç…§æˆ‘é‚„", author: "ç‹å®‰çŸ³", poem: "æ³Šèˆ¹ç“œæ´²" },
            
            { line: "çˆ†ç«¹è²ä¸­ä¸€æ­²é™¤", author: "ç‹å®‰çŸ³", poem: "å…ƒæ—¥" },
            { line: "æ˜¥é¢¨é€æš–å…¥å± è˜‡", author: "ç‹å®‰çŸ³", poem: "å…ƒæ—¥" },
            { line: "åƒé–€è¬æˆ¶æ›ˆæ›ˆæ—¥", author: "ç‹å®‰çŸ³", poem: "å…ƒæ—¥" },
            { line: "ç¸½æŠŠæ–°æ¡ƒæ›èˆŠç¬¦", author: "ç‹å®‰çŸ³", poem: "å…ƒæ—¥" },
            
            // æ¥Šè¬é‡Œä½œå“
            { line: "æ¥å¤©è“®è‘‰ç„¡çª®ç¢§", author: "æ¥Šè¬é‡Œ", poem: "æ™“å‡ºå‡€æ…ˆå¯ºé€æ—å­æ–¹" },
            { line: "æ˜ æ—¥è·èŠ±åˆ¥æ¨£ç´…", author: "æ¥Šè¬é‡Œ", poem: "æ™“å‡ºå‡€æ…ˆå¯ºé€æ—å­æ–¹" },
            
            // é™¸æ¸¸ä½œå“
            { line: "ç‹å¸«åŒ—å®šä¸­åŸæ—¥", author: "é™¸æ¸¸", poem: "ç¤ºå„¿" },
            { line: "å®¶ç¥­ç„¡å¿˜å‘Šä¹ƒç¿", author: "é™¸æ¸¸", poem: "ç¤ºå„¿" },
            
            // èŒƒæˆå¤§ä½œå“
            { line: "æ¢…å­é‡‘é»ƒæå­è‚¥", author: "èŒƒæˆå¤§", poem: "å››æ—¶ç”°å›­æ‚å…´" },
            { line: "éº¥èŠ±é›ªç™½èœèŠ±ç¨€", author: "èŒƒæˆå¤§", poem: "å››æ—¶ç”°å›­æ‚å…´" },
            
            // é‚µé›ä½œå“
            { line: "ä¸€å»äºŒä¸‰é‡Œ", author: "é‚µé›", poem: "å±±æ‘å’æ€€" },
            { line: "ç…™æ‘å››äº”å®¶", author: "é‚µé›", poem: "å±±æ‘å’æ€€" },
            { line: "äº­è‡ºå…­ä¸ƒåº§", author: "é‚µé›", poem: "å±±æ‘å’æ€€" },
            { line: "å…«ä¹åæèŠ±", author: "é‚µé›", poem: "å±±æ‘å’æ€€" },
            
            // æœ±ç†¹ä½œå“
            { line: "ç­‰é–’è­˜å¾—æ±é¢¨é¢", author: "æœ±ç†¹", poem: "æ˜¥æ—¥" },
            { line: "è¬ç´«åƒç´…ç¸½æ˜¯æ˜¥", author: "æœ±ç†¹", poem: "æ˜¥æ—¥" },
            
            // æ—å‡ä½œå“
            { line: "å±±å¤–é’å±±æ¨“å¤–æ¨“", author: "æ—å‡", poem: "é¡Œè‡¨å®‰é‚¸" },
            { line: "è¥¿æ¹–æ­Œèˆå¹¾æ™‚ä¼‘", author: "æ—å‡", poem: "é¡Œè‡¨å®‰é‚¸" },
            { line: "æš–é¢¨ç†å¾—éŠäººé†‰", author: "æ—å‡", poem: "é¡Œè‡¨å®‰é‚¸" },
            { line: "ç›´æŠŠæ­å·ä½œæ±´å·", author: "æ—å‡", poem: "é¡Œè‡¨å®‰é‚¸" },
            
            // è‘‰ç´¹ç¿ä½œå“
            { line: "æ˜¥è‰²æ»¿åœ’é—œä¸ä½", author: "è‘‰ç´¹ç¿", poem: "æ¸¸å›­ä¸å€¼" },
            { line: "ä¸€æç´…æå‡ºç‰†ä¾†", author: "è‘‰ç´¹ç¿", poem: "æ¸¸å›­ä¸å€¼" },
            
            // æç™½ä½œå“
            { line: "åºŠå‰æ˜æœˆå…‰", author: "æç™½", poem: "é™å¤œæ€" },
            { line: "ç–‘æ˜¯åœ°ä¸Šéœœ", author: "æç™½", poem: "é™å¤œæ€" },
            { line: "èˆ‰é ­æœ›æ˜æœˆ", author: "æç™½", poem: "é™å¤œæ€" },
            { line: "ä½é ­æ€æ•…é„‰", author: "æç™½", poem: "é™å¤œæ€" },
            
            { line: "æç™½ä¹˜èˆŸå°‡æ¬²è¡Œ", author: "æç™½", poem: "èµ æ±ªä¼¦" },
            { line: "å¿½èå²¸ä¸Šè¸æ­Œè²", author: "æç™½", poem: "èµ æ±ªä¼¦" },
            { line: "æ¡ƒèŠ±æ½­æ°´æ·±åƒå°º", author: "æç™½", poem: "èµ æ±ªä¼¦" },
            { line: "ä¸åŠæ±ªå€«é€æˆ‘æƒ…", author: "æç™½", poem: "èµ æ±ªä¼¦" },
            
            { line: "å¤©é–€ä¸­æ–·æ¥šæ±Ÿé–‹", author: "æç™½", poem: "æœ›å¤©é–€å±±" },
            { line: "ç¢§æ°´æ±æµè‡³æ­¤å›", author: "æç™½", poem: "æœ›å¤©é–€å±±" },
            { line: "å…©å²¸é’å±±ç›¸å°å‡º", author: "æç™½", poem: "æœ›å¤©é–€å±±" },
            { line: "å­¤å¸†ä¸€ç‰‡æ—¥é‚Šä¾†", author: "æç™½", poem: "æœ›å¤©é–€å±±" },
            
            { line: "æœè¾­ç™½å¸å½©é›²é–“", author: "æç™½", poem: "æ—©å‘ç™½å¸åŸ" },
            { line: "åƒé‡Œæ±Ÿé™µä¸€æ—¥é‚„", author: "æç™½", poem: "æ—©å‘ç™½å¸åŸ" },
            { line: "å…©å²¸çŒ¿è²å•¼ä¸ä½", author: "æç™½", poem: "æ—©å‘ç™½å¸åŸ" },
            { line: "è¼•èˆŸå·²éè¬é‡å±±", author: "æç™½", poem: "æ—©å‘ç™½å¸åŸ" },
            
            { line: "é£›æµç›´ä¸‹ä¸‰åƒå°º", author: "æç™½", poem: "æœ›åºå±±ç€‘å¸ƒ" },
            { line: "ç–‘æ˜¯éŠ€æ²³è½ä¹å¤©", author: "æç™½", poem: "æœ›åºå±±ç€‘å¸ƒ" },
            
            // æœç”«ä½œå“
            { line: "å…©å€‹é»ƒé¸é³´ç¿ æŸ³", author: "æœç”«", poem: "ç»å¥" },
            { line: "ä¸€è¡Œç™½é·ºä¸Šé’å¤©", author: "æœç”«", poem: "ç»å¥" },
            { line: "çª—å«è¥¿å¶ºåƒç§‹é›ª", author: "æœç”«", poem: "ç»å¥" },
            { line: "é–€æ³Šæ±å³è¬é‡Œèˆ¹", author: "æœç”«", poem: "ç»å¥" },
            
            { line: "å¥½é›¨çŸ¥æ™‚ç¯€", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            { line: "ç•¶æ˜¥ä¹ƒç™¼ç”Ÿ", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            { line: "éš¨é¢¨æ½›å…¥å¤œ", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            { line: "æ½¤ç‰©ç´°ç„¡è²", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            
            // æœç‰§ä½œå“
            { line: "æ¸…æ˜æ™‚ç¯€é›¨ç´›ç´›", author: "æœç‰§", poem: "æ¸…æ˜" },
            { line: "è·¯ä¸Šè¡Œäººæ¬²æ–·é­‚", author: "æœç‰§", poem: "æ¸…æ˜" },
            { line: "å€Ÿå•é…’å®¶ä½•è™•æœ‰", author: "æœç‰§", poem: "æ¸…æ˜" },
            { line: "ç‰§ç«¥é™æŒ‡æèŠ±æ‘", author: "æœç‰§", poem: "æ¸…æ˜" },
            
            { line: "åœè»Šåæ„›æ¥“æ—æ™š", author: "æœç‰§", poem: "å±±è¡Œ" },
            { line: "éœœè‘‰ç´…æ–¼äºŒæœˆèŠ±", author: "æœç‰§", poem: "å±±è¡Œ" },
            
            // æå•†éš±ä½œå“
            { line: "å¤•é™½ç„¡é™å¥½", author: "æå•†éš±", poem: "ç™»æ¨‚æ¸¸åŸ" },
            { line: "åªæ˜¯è¿‘é»ƒæ˜", author: "æå•†éš±", poem: "ç™»æ¨‚æ¸¸åŸ" },
            
            // ç™½å±…æ˜“ä½œå“
            { line: "é›¢é›¢åŸä¸Šè‰", author: "ç™½å±…æ˜“", poem: "èµ‹å¾—å¤åŸè‰é€åˆ«" },
            { line: "ä¸€æ­²ä¸€æ¯æ¦®", author: "ç™½å±…æ˜“", poem: "èµ‹å¾—å¤åŸè‰é€åˆ«" },
            { line: "é‡ç«ç‡’ä¸ç›¡", author: "ç™½å±…æ˜“", poem: "èµ‹å¾—å¤åŸè‰é€åˆ«" },
            { line: "æ˜¥é¢¨å¹åˆç”Ÿ", author: "ç™½å±…æ˜“", poem: "èµ‹å¾—å¤åŸè‰é€åˆ«" },
            
            // é«˜é©ä½œå“
            { line: "è«æ„å‰è·¯ç„¡çŸ¥å·±", author: "é«˜é©", poem: "åˆ«è‘£å¤§" },
            { line: "å¤©ä¸‹èª°äººä¸è­˜å›", author: "é«˜é©", poem: "åˆ«è‘£å¤§" },
            
            // å¼µç¹¼ä½œå“
            { line: "æœˆè½çƒå•¼éœœæ»¿å¤©", author: "å¼µç¹¼", poem: "æ«æ¡¥å¤œæ³Š" },
            { line: "æ±Ÿæ¥“æ¼ç«å°æ„çœ ", author: "å¼µç¹¼", poem: "æ«æ¡¥å¤œæ³Š" },
            { line: "å§‘è˜‡åŸå¤–å¯’å±±å¯º", author: "å¼µç¹¼", poem: "æ«æ¡¥å¤œæ³Š" },
            { line: "å¤œåŠé˜è²åˆ°å®¢èˆ¹", author: "å¼µç¹¼", poem: "æ«æ¡¥å¤œæ³Š" },
            
            // å­ŸéƒŠä½œå“
            { line: "èª°è¨€å¯¸è‰å¿ƒ", author: "å­ŸéƒŠ", poem: "æ¸¸å­åŸ" },
            { line: "å ±å¾—ä¸‰æ˜¥æš‰", author: "å­ŸéƒŠ", poem: "æ¸¸å­åŸ" },
            
            // åŠ‰ç¦¹éŒ«ä½œå“
            { line: "èˆŠæ™‚ç‹è¬å ‚å‰ç‡•", author: "åŠ‰ç¦¹éŒ«", poem: "ä¹Œè¡£å··" },
            { line: "é£›å…¥å°‹å¸¸ç™¾å§“å®¶", author: "åŠ‰ç¦¹éŒ«", poem: "ä¹Œè¡£å··" },
            
            // æç´³ä½œå“
            { line: "é‹¤ç¦¾æ—¥ç•¶åˆ", author: "æç´³", poem: "æ‚¯å†œ" },
            { line: "æ±—æ»´ç¦¾ä¸‹åœŸ", author: "æç´³", poem: "æ‚¯å†œ" },
            { line: "èª°çŸ¥ç›¤ä¸­é¤", author: "æç´³", poem: "æ‚¯å†œ" },
            { line: "ç²’ç²’çš†è¾›è‹¦", author: "æç´³", poem: "æ‚¯å†œ" },
            
            // å´”è­·ä½œå“
            { line: "äººé¢ä¸çŸ¥ä½•è™•å»", author: "å´”è­·", poem: "é¢˜éƒ½åŸå—åº„" },
            { line: "æ¡ƒèŠ±ä¾èˆŠç¬‘æ˜¥é¢¨", author: "å´”è­·", poem: "é¢˜éƒ½åŸå—åº„" },
            
            // æŸ³å®—å…ƒä½œå“
            { line: "åƒå±±é³¥é£›çµ•", author: "æŸ³å®—å…ƒ", poem: "æ±Ÿé›ª" },
            { line: "è¬å¾‘äººè¹¤æ»…", author: "æŸ³å®—å…ƒ", poem: "æ±Ÿé›ª" },
            { line: "å­¤èˆŸè“‘ç¬ ç¿", author: "æŸ³å®—å…ƒ", poem: "æ±Ÿé›ª" },
            { line: "ç¨é‡£å¯’æ±Ÿé›ª", author: "æŸ³å®—å…ƒ", poem: "æ±Ÿé›ª" },
            
            // é§±è³“ç‹ä½œå“
            { line: "éµéµéµ", author: "é§±è³“ç‹", poem: "å’é¹…" },
            { line: "æ›²é …å‘å¤©æ­Œ", author: "é§±è³“ç‹", poem: "å’é¹…" },
            { line: "ç™½æ¯›æµ®ç¶ æ°´", author: "é§±è³“ç‹", poem: "å’é¹…" },
            { line: "ç´…æŒæ’¥æ¸…æ³¢", author: "é§±è³“ç‹", poem: "å’é¹…" },
            
            // è³€çŸ¥ç« ä½œå“
            { line: "ç¢§ç‰å¦æˆä¸€æ¨¹é«˜", author: "è³€çŸ¥ç« ", poem: "å’æŸ³" },
            { line: "è¬æ¢å‚ä¸‹ç¶ çµ²çµ¡", author: "è³€çŸ¥ç« ", poem: "å’æŸ³" },
            { line: "ä¸çŸ¥ç´°è‘‰èª°è£å‡º", author: "è³€çŸ¥ç« ", poem: "å’æŸ³" },
            { line: "äºŒæœˆæ˜¥é¢¨ä¼¼å‰ªåˆ€", author: "è³€çŸ¥ç« ", poem: "å’æŸ³" },
            
            // ç‹ä¹‹æ¸™ä½œå“
            { line: "ç™½æ—¥ä¾å±±ç›¡", author: "ç‹ä¹‹æ¸™", poem: "ç™»é¹³é›€æ¥¼" },
            { line: "é»ƒæ²³å…¥æµ·æµ", author: "ç‹ä¹‹æ¸™", poem: "ç™»é¹³é›€æ¥¼" },
            { line: "æ¬²çª®åƒé‡Œç›®", author: "ç‹ä¹‹æ¸™", poem: "ç™»é¹³é›€æ¥¼" },
            { line: "æ›´ä¸Šä¸€å±¤æ¨“", author: "ç‹ä¹‹æ¸™", poem: "ç™»é¹³é›€æ¥¼" },
            
            // å­Ÿæµ©ç„¶ä½œå“
            { line: "æ˜¥çœ ä¸è¦ºæ›‰", author: "å­Ÿæµ©ç„¶", poem: "æ˜¥æ™“" },
            { line: "è™•è™•èå•¼é³¥", author: "å­Ÿæµ©ç„¶", poem: "æ˜¥æ™“" },
            { line: "å¤œä¾†é¢¨é›¨è²", author: "å­Ÿæµ©ç„¶", poem: "æ˜¥æ™“" },
            { line: "èŠ±è½çŸ¥å¤šå°‘", author: "å­Ÿæµ©ç„¶", poem: "æ˜¥æ™“" },
            
            // ç‹ç¶­ä½œå“
            { line: "ç¨åœ¨ç•°é„‰ç‚ºç•°å®¢", author: "ç‹ç¶­", poem: "ä¹æœˆä¹æ—¥å¿†å±±ä¸œå…„å¼Ÿ" },
            { line: "æ¯é€¢ä½³ç¯€å€æ€è¦ª", author: "ç‹ç¶­", poem: "ä¹æœˆä¹æ—¥å¿†å±±ä¸œå…„å¼Ÿ" },
            
            { line: "ç´…è±†ç”Ÿå—åœ‹", author: "ç‹ç¶­", poem: "ç›¸æ€" },
            { line: "æ˜¥ä¾†ç™¼å¹¾æ", author: "ç‹ç¶­", poem: "ç›¸æ€" },
            { line: "é¡˜å›å¤šæ¡æ“·", author: "ç‹ç¶­", poem: "ç›¸æ€" },
            { line: "æ­¤ç‰©æœ€ç›¸æ€", author: "ç‹ç¶­", poem: "ç›¸æ€" },
            
            { line: "å‹¸å›æ›´ç›¡ä¸€æ¯é…’", author: "ç‹ç¶­", poem: "é€å…ƒäºŒä½¿å®‰è¥¿" },
            { line: "è¥¿å‡ºé™½é—œç„¡æ•…äºº", author: "ç‹ç¶­", poem: "é€å…ƒäºŒä½¿å®‰è¥¿" },
            
            // éœå¤çš„éƒ¨åˆ†
            { line: "å°æ¾åˆæ•¸å°º", author: "ç‹å»º", poem: "å°æ¾" },
            { line: "æœªæœ‰ç›´ç”Ÿæ", author: "ç‹å»º", poem: "å°æ¾" }
        ];
        
        // è©©è©åº« - å¾è©©è©åº«AIéŠæˆ².docxä¸­å°å…¥çš„è©©å¥
        const tangPoetryLines = [
            // æ¼¢æ¨‚åºœã€Šé•·æ­Œè¡Œã€‹
            { line: "é’é’åœ’ä¸­è‘µ", author: "æ¼¢æ¨‚åºœ", poem: "é•·æ­Œè¡Œ" },
            { line: "æœéœ²å¾…æ—¥æ™", author: "æ¼¢æ¨‚åºœ", poem: "é•·æ­Œè¡Œ" },
            { line: "å°‘å£¯ä¸åŠªåŠ›", author: "æ¼¢æ¨‚åºœ", poem: "é•·æ­Œè¡Œ" },
            { line: "è€å¤§å¾’å‚·æ‚²", author: "æ¼¢æ¨‚åºœ", poem: "é•·æ­Œè¡Œ" },
            
            // å¤è©©åä¹é¦–ã€Šåº­ä¸­æœ‰å¥‡æ¨¹ã€‹
            { line: "åº­ä¸­æœ‰å¥‡æ¨¹", author: "å¤è©©åä¹é¦–", poem: "åº­ä¸­æœ‰å¥‡æ¨¹" },
            { line: "ç¶ è‘‰ç™¼è¯æ»‹", author: "å¤è©©åä¹é¦–", poem: "åº­ä¸­æœ‰å¥‡æ¨¹" },
            { line: "æ­¤ç‰©ä½•è¶³è²´", author: "å¤è©©åä¹é¦–", poem: "åº­ä¸­æœ‰å¥‡æ¨¹" },
            { line: "ä½†æ„Ÿåˆ¥ç¶“æ™‚", author: "å¤è©©åä¹é¦–", poem: "åº­ä¸­æœ‰å¥‡æ¨¹" },
            
            // é§±è³“ç‹ã€Šè© éµã€‹
            { line: "ç™½æ¯›æµ®ç¶ æ°´", author: "é§±è³“ç‹", poem: "è© éµ" },
            { line: "ç´…æŒæ’¥æ¸…æ³¢", author: "é§±è³“ç‹", poem: "è© éµ" },
            
            // è³€çŸ¥ç« ã€Šè© æŸ³ã€‹
            { line: "ä¸çŸ¥ç´°è‘‰èª°è£å‡º", author: "è³€çŸ¥ç« ", poem: "è© æŸ³" },
            { line: "äºŒæœˆæ˜¥é¢¨ä¼¼å‰ªåˆ€", author: "è³€çŸ¥ç« ", poem: "è© æŸ³" },
            
            // ç‹ä¹‹æ¸™ã€Šç™»é¸›é›€æ¨“ã€‹
            { line: "æ¬²çª®åƒé‡Œç›®", author: "ç‹ä¹‹æ¸™", poem: "ç™»é¸›é›€æ¨“" },
            { line: "æ›´ä¸Šä¸€å±¤æ¨“", author: "ç‹ä¹‹æ¸™", poem: "ç™»é¸›é›€æ¨“" },
            
            // å­Ÿæµ©ç„¶ã€Šæ˜¥æ›‰ã€‹
            { line: "å¤œä¾†é¢¨é›¨è²", author: "å­Ÿæµ©ç„¶", poem: "æ˜¥æ›‰" },
            { line: "èŠ±è½çŸ¥å¤šå°‘", author: "å­Ÿæµ©ç„¶", poem: "æ˜¥æ›‰" },
            
            // ç‹ç¶­ã€Šä¹æœˆä¹æ—¥æ†¶å±±æ±å…„å¼Ÿã€‹
            { line: "ç¨åœ¨ç•°é„‰ç‚ºç•°å®¢", author: "ç‹ç¶­", poem: "ä¹æœˆä¹æ—¥æ†¶å±±æ±å…„å¼Ÿ" },
            { line: "æ¯é€¢ä½³ç¯€å€æ€è¦ª", author: "ç‹ç¶­", poem: "ä¹æœˆä¹æ—¥æ†¶å±±æ±å…„å¼Ÿ" },
            
            // ç‹ç¶­ã€Šç›¸æ€ã€‹
            { line: "é¡˜å›å¤šæ¡æ“·", author: "ç‹ç¶­", poem: "ç›¸æ€" },
            { line: "æ­¤ç‰©æœ€ç›¸æ€", author: "ç‹ç¶­", poem: "ç›¸æ€" },
            
            // ç‹ç¶­ã€Šé€å…ƒäºŒä½¿å®‰è¥¿ã€‹
            { line: "å‹¸å›æ›´ç›¡ä¸€æ¯é…’", author: "ç‹ç¶­", poem: "é€å…ƒäºŒä½¿å®‰è¥¿" },
            { line: "è¥¿å‡ºé™½é—œç„¡æ•…äºº", author: "ç‹ç¶­", poem: "é€å…ƒäºŒä½¿å®‰è¥¿" },
            
            // ç‹ç¶­ã€Šç«¹é‡Œé¤¨ã€‹
            { line: "æ·±æ—äººä¸çŸ¥", author: "ç‹ç¶­", poem: "ç«¹é‡Œé¤¨" },
            { line: "æ˜æœˆä¾†ç›¸ç…§", author: "ç‹ç¶­", poem: "ç«¹é‡Œé¤¨" },
            
            // ç‹æ˜Œé½¡ã€Šå‡ºå¡ã€‹å…¶ä¸€
            { line: "ä½†ä½¿é¾åŸé£›å°‡åœ¨", author: "ç‹æ˜Œé½¡", poem: "å‡ºå¡" },
            { line: "ä¸æ•™èƒ¡é¦¬åº¦é™°å±±", author: "ç‹æ˜Œé½¡", poem: "å‡ºå¡" },
            
            // ç‹æ˜Œé½¡ã€Šå¾è»è¡Œã€‹å…¶ä¸€
            { line: "æ›´å¹ç¾Œç¬›é—œå±±æœˆ", author: "ç‹æ˜Œé½¡", poem: "å¾è»è¡Œ" },
            { line: "ç„¡é‚£é‡‘é–¨è¬é‡Œæ„", author: "ç‹æ˜Œé½¡", poem: "å¾è»è¡Œ" },
            
            // é«˜é©ã€Šåˆ¥è‘£å¤§ã€‹å…¶ä¸€
            { line: "è«æ„å‰è·¯ç„¡çŸ¥å·±", author: "é«˜é©", poem: "åˆ¥è‘£å¤§" },
            { line: "å¤©ä¸‹èª°äººä¸è­˜å›", author: "é«˜é©", poem: "åˆ¥è‘£å¤§" },
            
            // æç™½ã€Šéœå¤œæ€ã€‹
            { line: "èˆ‰é ­æœ›æ˜æœˆ", author: "æç™½", poem: "éœå¤œæ€" },
            { line: "ä½é ­æ€æ•…é„‰", author: "æç™½", poem: "éœå¤œæ€" },
            
            // æç™½ã€Šé€å‹äººã€‹
            { line: "æµ®é›²éŠå­æ„", author: "æç™½", poem: "é€å‹äºº" },
            { line: "è½æ—¥æ•…äººæƒ…", author: "æç™½", poem: "é€å‹äºº" },
            
            // æç™½ã€Šè´ˆæ±ªå€«ã€‹
            { line: "æ¡ƒèŠ±æ½­æ°´æ·±åƒå°º", author: "æç™½", poem: "è´ˆæ±ªå€«" },
            { line: "ä¸åŠæ±ªå€«é€æˆ‘æƒ…", author: "æç™½", poem: "è´ˆæ±ªå€«" },
            
            // æç™½ã€Šæœ›å»¬å±±ç€‘å¸ƒã€‹å…¶äºŒ
            { line: "é£›æµç›´ä¸‹ä¸‰åƒå°º", author: "æç™½", poem: "æœ›å»¬å±±ç€‘å¸ƒ" },
            { line: "ç–‘æ˜¯éŠ€æ²³è½ä¹å¤©", author: "æç™½", poem: "æœ›å»¬å±±ç€‘å¸ƒ" },
            
            // æç™½ã€Šç¨åæ•¬äº­å±±ã€‹
            { line: "ç›¸çœ‹å…©ä¸å­", author: "æç™½", poem: "ç¨åæ•¬äº­å±±" },
            { line: "åªæœ‰æ•¬äº­å±±", author: "æç™½", poem: "ç¨åæ•¬äº­å±±" },
            
            // æç™½ã€Šé»ƒé¶´æ¨“é€å­Ÿæµ©ç„¶ä¹‹å»£é™µã€‹
            { line: "å­¤å¸†é å½±ç¢§ç©ºç›¡", author: "æç™½", poem: "é»ƒé¶´æ¨“é€å­Ÿæµ©ç„¶ä¹‹å»£é™µ" },
            { line: "å”¯è¦‹é•·æ±Ÿå¤©éš›æµ", author: "æç™½", poem: "é»ƒé¶´æ¨“é€å­Ÿæµ©ç„¶ä¹‹å»£é™µ" },
            
            // æç™½ã€Šæœ›å¤©é–€å±±ã€‹
            { line: "å…©å²¸é’å±±ç›¸å°å‡º", author: "æç™½", poem: "æœ›å¤©é–€å±±" },
            { line: "å­¤å¸†ä¸€ç‰‡æ—¥é‚Šä¾†", author: "æç™½", poem: "æœ›å¤©é–€å±±" },
            
            // æœç”«ã€Šå®¢è‡³ã€‹
            { line: "èŠ±å¾‘ä¸æ›¾ç·£å®¢æƒ", author: "æœç”«", poem: "å®¢è‡³" },
            { line: "è“¬é–€ä»Šå§‹ç‚ºå›é–‹", author: "æœç”«", poem: "å®¢è‡³" },
            
            // æœç”«ã€Šæ˜¥å¤œå–œé›¨ã€‹
            { line: "éš¨é¢¨æ½›å…¥å¤œ", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            { line: "æ½¤ç‰©ç´°ç„¡è²", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            { line: "æ›‰çœ‹ç´…æ¿•è™•", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            { line: "èŠ±é‡éŒ¦å®˜åŸ", author: "æœç”«", poem: "æ˜¥å¤œå–œé›¨" },
            
            // æœç”«ã€Šçµ•å¥ã€‹
            { line: "å…©å€‹é»ƒé¸é³´ç¿ æŸ³", author: "æœç”«", poem: "çµ•å¥" },
            { line: "ä¸€è¡Œç™½é·ºä¸Šé’å¤©", author: "æœç”«", poem: "çµ•å¥" },
            
            // å¼µç±ã€Šæ¥“æ©‹å¤œæ³Šã€‹
            { line: "æœˆè½çƒå•¼éœœæ»¿å¤©", author: "å¼µç±", poem: "æ¥“æ©‹å¤œæ³Š" },
            { line: "æ±Ÿæ¥“æ¼ç«å°æ„çœ ", author: "å¼µç±", poem: "æ¥“æ©‹å¤œæ³Š" },
            
            // å­ŸéƒŠã€ŠéŠå­åŸã€‹
            { line: "èª°è¨€å¯¸è‰å¿ƒ", author: "å­ŸéƒŠ", poem: "éŠå­åŸ" },
            { line: "å ±å¾—ä¸‰æ˜¥æš‰", author: "å­ŸéƒŠ", poem: "éŠå­åŸ" },
            
            // ç™½å±…æ˜“ã€Šè³¦å¾—å¤åŸè‰é€åˆ¥ã€‹
            { line: "é‡ç«ç‡’ä¸ç›¡", author: "ç™½å±…æ˜“", poem: "è³¦å¾—å¤åŸè‰é€åˆ¥" },
            { line: "æ˜¥é¢¨å¹åˆç”Ÿ", author: "ç™½å±…æ˜“", poem: "è³¦å¾—å¤åŸè‰é€åˆ¥" },
            
            // ç™½å±…æ˜“ã€Šæš®æ±ŸåŸã€‹
            { line: "ä¸€é“æ®˜é™½é‹ªæ°´ä¸­", author: "ç™½å±…æ˜“", poem: "æš®æ±ŸåŸ" },
            { line: "åŠæ±Ÿç‘Ÿç‘ŸåŠæ±Ÿç´…", author: "ç™½å±…æ˜“", poem: "æš®æ±ŸåŸ" },
            
            // ç™½å±…æ˜“ã€Šè³£ç‚­ç¿ã€‹
            { line: "å¯æ†èº«ä¸Šè¡£æ­£å–®", author: "ç™½å±…æ˜“", poem: "è³£ç‚­ç¿" },
            { line: "å¿ƒæ†‚ç‚­è³¤é¡˜å¤©å¯’", author: "ç™½å±…æ˜“", poem: "è³£ç‚­ç¿" },
            
            // ç™½å±…æ˜“ã€Šå¤§æ—å¯ºæ¡ƒèŠ±ã€‹
            { line: "äººé–“å››æœˆèŠ³è²ç›¡", author: "ç™½å±…æ˜“", poem: "å¤§æ—å¯ºæ¡ƒèŠ±" },
            { line: "å±±å¯ºæ¡ƒèŠ±å§‹ç››é–‹", author: "ç™½å±…æ˜“", poem: "å¤§æ—å¯ºæ¡ƒèŠ±" },
            
            // è³ˆå³¶ã€Šå°‹éš±è€…ä¸é‡ã€‹
            { line: "åªåœ¨æ­¤å±±ä¸­", author: "è³ˆå³¶", poem: "å°‹éš±è€…ä¸é‡" },
            { line: "é›²æ·±ä¸çŸ¥è™•", author: "è³ˆå³¶", poem: "å°‹éš±è€…ä¸é‡" },
            
            // æœç‰§ã€Šå±±è¡Œã€‹
            { line: "åœè»Šåæ„›æ¥“æ—æ™š", author: "æœç‰§", poem: "å±±è¡Œ" },
            { line: "éœœè‘‰ç´…æ–¼äºŒæœˆèŠ±", author: "æœç‰§", poem: "å±±è¡Œ" },
            
            // æœç‰§ã€Šæ±Ÿå—æ˜¥ã€‹
            { line: "å—æœå››ç™¾å…«åå¯º", author: "æœç‰§", poem: "æ±Ÿå—æ˜¥" },
            { line: "å¤šå°‘æ¨“è‡ºç…™é›¨ä¸­", author: "æœç‰§", poem: "æ±Ÿå—æ˜¥" },
            
            // å¼µå¿—å’Œã€Šæ¼æ­Œå­ã€‹
            { line: "é’ç®¬ç¬ ", author: "å¼µå¿—å’Œ", poem: "æ¼æ­Œå­" },
            { line: "ç¶ è“‘è¡£", author: "å¼µå¿—å’Œ", poem: "æ¼æ­Œå­" },
            { line: "æ–œé¢¨ç´°é›¨ä¸é ˆæ­¸", author: "å¼µå¿—å’Œ", poem: "æ¼æ­Œå­" },
            
            // ç‹å®‰çŸ³ã€Šæ¢…èŠ±ã€‹
            { line: "é™çŸ¥ä¸æ˜¯é›ª", author: "ç‹å®‰çŸ³", poem: "æ¢…èŠ±" },
            { line: "ç‚ºæœ‰æš—é¦™ä¾†", author: "ç‹å®‰çŸ³", poem: "æ¢…èŠ±" },
            
            // ç‹å®‰çŸ³ã€Šæ›¸æ¹–é™°å…ˆç”Ÿå£ã€‹å…¶ä¸€
            { line: "ä¸€æ°´è­·ç”°å°‡ç¶ ç¹", author: "ç‹å®‰çŸ³", poem: "æ›¸æ¹–é™°å…ˆç”Ÿå£" },
            { line: "å…©å±±æ’é—¥é€é’ä¾†", author: "ç‹å®‰çŸ³", poem: "æ›¸æ¹–é™°å…ˆç”Ÿå£" },
            
            // è˜‡è»¾ã€Šæ°´èª¿æ­Œé ­ã€‹
            { line: "ä½†é¡˜äººé•·ä¹…", author: "è˜‡è»¾", poem: "æ°´èª¿æ­Œé ­" },
            { line: "åƒé‡Œå…±å¬‹å¨Ÿ", author: "è˜‡è»¾", poem: "æ°´èª¿æ­Œé ­" },
            { line: "äººæœ‰æ‚²æ­¡é›¢åˆ", author: "è˜‡è»¾", poem: "æ°´èª¿æ­Œé ­" },
            { line: "æœˆæœ‰é™°æ™´åœ“ç¼º", author: "è˜‡è»¾", poem: "æ°´èª¿æ­Œé ­" },
            
            // è˜‡è»¾ã€Šé¡Œè¥¿æ—å£ã€‹
            { line: "ä¸è­˜å»¬å±±çœŸé¢ç›®", author: "è˜‡è»¾", poem: "é¡Œè¥¿æ—å£" },
            { line: "åªç·£èº«åœ¨æ­¤å±±ä¸­", author: "è˜‡è»¾", poem: "é¡Œè¥¿æ—å£" },
            
            // è˜‡è»¾ã€Šé£²æ¹–ä¸Šåˆæ™´å¾Œé›¨ã€‹
            { line: "æ¬²æŠŠè¥¿æ¹–æ¯”è¥¿å­", author: "è˜‡è»¾", poem: "é£²æ¹–ä¸Šåˆæ™´å¾Œé›¨" },
            { line: "æ·¡å¦æ¿ƒæŠ¹ç¸½ç›¸å®œ", author: "è˜‡è»¾", poem: "é£²æ¹–ä¸Šåˆæ™´å¾Œé›¨" },
            
            // æ¥Šè¬é‡Œã€Šæ›‰å‡ºæ·¨æ…ˆå¯ºé€æ—å­æ–¹ã€‹å…¶äºŒ
            { line: "æ¥å¤©è“®è‘‰ç„¡çª®ç¢§", author: "æ¥Šè¬é‡Œ", poem: "æ›‰å‡ºæ·¨æ…ˆå¯ºé€æ—å­æ–¹" },
            { line: "æ˜ æ—¥è·èŠ±åˆ¥æ¨£ç´…", author: "æ¥Šè¬é‡Œ", poem: "æ›‰å‡ºæ·¨æ…ˆå¯ºé€æ—å­æ–¹" },
            
            // æœ±ç†¹ã€Šè§€æ›¸æœ‰æ„Ÿã€‹
            { line: "å•æ¸ é‚£å¾—æ¸…å¦‚è¨±", author: "æœ±ç†¹", poem: "è§€æ›¸æœ‰æ„Ÿ" },
            { line: "ç‚ºæœ‰æºé ­æ´»æ°´ä¾†", author: "æœ±ç†¹", poem: "è§€æ›¸æœ‰æ„Ÿ" },
            
            // æ—å‡ã€Šé¡Œè‡¨å®‰é‚¸ã€‹
            { line: "æš–é¢¨è–°å¾—éŠäººé†‰", author: "æ—å‡", poem: "é¡Œè‡¨å®‰é‚¸" },
            { line: "ç›´æŠŠæ­å·ä½œæ±´å·", author: "æ—å‡", poem: "é¡Œè‡¨å®‰é‚¸" },
            
            // é¦¬è‡´é ã€Šå¤©æ·¨æ²™Â·ç§‹æ€ã€‹
            { line: "æ¯è—¤è€æ¨¹æ˜é´‰", author: "é¦¬è‡´é ", poem: "å¤©æ·¨æ²™Â·ç§‹æ€" },
            { line: "å°æ©‹æµæ°´äººå®¶", author: "é¦¬è‡´é ", poem: "å¤©æ·¨æ²™Â·ç§‹æ€" },
            { line: "å¤•é™½è¥¿ä¸‹", author: "é¦¬è‡´é ", poem: "å¤©æ·¨æ²™Â·ç§‹æ€" },
            { line: "æ–·è…¸äººåœ¨å¤©æ¶¯", author: "é¦¬è‡´é ", poem: "å¤©æ·¨æ²™Â·ç§‹æ€" },
            
            // ã€Šè©©ç¶“Â·é—œé›ã€‹
            { line: "é—œé—œé›é³©", author: "è©©ç¶“", poem: "é—œé›" },
            { line: "åœ¨æ²³ä¹‹æ´²", author: "è©©ç¶“", poem: "é—œé›" },
            { line: "çªˆçª•æ·‘å¥³", author: "è©©ç¶“", poem: "é—œé›" },
            { line: "å›å­å¥½é€‘", author: "è©©ç¶“", poem: "é—œé›" },
            
            // ã€Šè©©ç¶“Â·è’¹è‘­ã€‹
            { line: "è’¹è‘­è’¼è’¼", author: "è©©ç¶“", poem: "è’¹è‘­" },
            { line: "ç™½éœ²ç‚ºéœœ", author: "è©©ç¶“", poem: "è’¹è‘­" },
            { line: "æ‰€è¬‚ä¼Šäºº", author: "è©©ç¶“", poem: "è’¹è‘­" },
            { line: "åœ¨æ°´ä¸€æ–¹", author: "è©©ç¶“", poem: "è’¹è‘­" },
            
            // æ›¹æ¤ã€Šä¸ƒå“€è©©ã€‹
            { line: "æ˜æœˆç…§é«˜æ¨“", author: "æ›¹æ¤", poem: "ä¸ƒå“€è©©" },
            { line: "æµå…‰æ­£å¾˜å¾Š", author: "æ›¹æ¤", poem: "ä¸ƒå“€è©©" },
            { line: "é¡˜ç‚ºè¥¿å—é¢¨", author: "æ›¹æ¤", poem: "ä¸ƒå“€è©©" },
            { line: "é•·é€å…¥å›æ‡·", author: "æ›¹æ¤", poem: "ä¸ƒå“€è©©" },
            
            // é™¶æ·µæ˜ã€Šæ­¸åœ’ç”°å±…ã€‹å…¶ä¸€
            { line: "ç¾ˆé³¥æˆ€èˆŠæ—", author: "é™¶æ·µæ˜", poem: "æ­¸åœ’ç”°å±…" },
            { line: "æ± é­šæ€æ•…æ·µ", author: "é™¶æ·µæ˜", poem: "æ­¸åœ’ç”°å±…" },
            { line: "ä¹…åœ¨æ¨Šç± è£", author: "é™¶æ·µæ˜", poem: "æ­¸åœ’ç”°å±…" },
            { line: "å¾©å¾—è¿”è‡ªç„¶", author: "é™¶æ·µæ˜", poem: "æ­¸åœ’ç”°å±…" },
            
            // é™¶æ·µæ˜ã€Šé£²é…’è©©ã€‹
            { line: "æ¡èŠæ±ç±¬ä¸‹", author: "é™¶æ·µæ˜", poem: "é£²é…’è©©" },
            { line: "æ‚ ç„¶è¦‹å—å±±", author: "é™¶æ·µæ˜", poem: "é£²é…’è©©" },
            { line: "å•å›ä½•èƒ½çˆ¾", author: "é™¶æ·µæ˜", poem: "é£²é…’è©©" },
            { line: "å¿ƒé åœ°è‡ªå", author: "é™¶æ·µæ˜", poem: "é£²é…’è©©" },
            
            // å¼µè‹¥è™›ã€Šæ˜¥æ±ŸèŠ±æœˆå¤œã€‹
            { line: "æ˜¥æ±Ÿæ½®æ°´é€£æµ·å¹³", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "æµ·ä¸Šæ˜æœˆå…±æ½®ç”Ÿ", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "æ±Ÿç•”ä½•äººåˆè¦‹æœˆ", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "æ±Ÿæœˆä½•å¹´åˆç…§äºº", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "äººç”Ÿä»£ä»£ç„¡çª®å·²", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "æ±Ÿæœˆå¹´å¹´åªç›¸ä¼¼", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "ä¸çŸ¥æ±Ÿæœˆå¾…ä½•äºº", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            { line: "ä½†è¦‹é•·æ±Ÿé€æµæ°´", author: "å¼µè‹¥è™›", poem: "æ˜¥æ±ŸèŠ±æœˆå¤œ" },
            
            // æç™½ã€Šèœ€é“é›£ã€‹
            { line: "èœ€é“ä¹‹é›£", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "é›£æ–¼ä¸Šé’å¤©", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "ä¸€å¤«ç•¶é—œ", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "è¬å¤«è«é–‹", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "é€£å³°å»å¤©ä¸ç›ˆå°º", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "æ¯æ¾å€’æ›å€šçµ•å£", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "åŠé–£å´¢å¶¸è€Œå´”åµ¬", author: "æç™½", poem: "èœ€é“é›£" },
            { line: "æ‰€å®ˆæˆ–åŒªè¦ª", author: "æç™½", poem: "èœ€é“é›£" },
            
            // æç™½ã€Šå¤¢éŠå¤©å§¥åŸç•™åˆ¥ã€‹
            { line: "å®‰èƒ½æ‘§çœ‰æŠ˜è…°äº‹æ¬Šè²´", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "ä½¿æˆ‘ä¸å¾—é–‹å¿ƒé¡", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "åŠå£è¦‹æµ·æ—¥", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "ç©ºä¸­èå¤©é›", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "éœ“ç‚ºè¡£å…®é¢¨ç‚ºé¦¬", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "é›²ä¹‹å›å…®ç´›ç´›è€Œä¾†ä¸‹", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "ä¸”æ”¾ç™½é¹¿é’å´–é–“", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            { line: "é ˆè¡Œå³é¨è¨ªåå±±", author: "æç™½", poem: "å¤¢éŠå¤©å§¥åŸç•™åˆ¥" },
            
            // æç™½ã€Šå°‡é€²é…’ã€‹
            { line: "å›ä¸è¦‹é»ƒæ²³ä¹‹æ°´å¤©ä¸Šä¾†", author: "æç™½", poem: "å°‡é€²é…’" },
            { line: "å¥”æµåˆ°æµ·ä¸å¾©å›", author: "æç™½", poem: "å°‡é€²é…’" },
            { line: "å¤©ç”Ÿæˆ‘æå¿…æœ‰ç”¨", author: "æç™½", poem: "å°‡é€²é…’" },
            { line: "åƒé‡‘æ•£ç›¡é‚„å¾©ä¾†", author: "æç™½", poem: "å°‡é€²é…’" },
            { line: "å¤ä¾†è–è³¢çš†å¯‚å¯", author: "æç™½", poem: "å°‡é€²é…’" },
            { line: "æƒŸæœ‰é£²è€…ç•™å…¶å", author: "æç™½", poem: "å°‡é€²é…’" },
            
            // æœç”«ã€Šç™»é«˜ã€‹
            { line: "ç„¡é‚Šè½æœ¨è•­è•­ä¸‹", author: "æœç”«", poem: "ç™»é«˜" },
            { line: "ä¸ç›¡é•·æ±Ÿæ»¾æ»¾ä¾†", author: "æœç”«", poem: "ç™»é«˜" },
            { line: "è¬é‡Œæ‚²ç§‹å¸¸ä½œå®¢", author: "æœç”«", poem: "ç™»é«˜" },
            { line: "ç™¾å¹´å¤šç—…ç¨ç™»è‡º", author: "æœç”«", poem: "ç™»é«˜" },
            
            // æå•†éš±ã€Šç„¡é¡Œã€‹
            { line: "æ˜¥è ¶åˆ°æ­»çµ²æ–¹ç›¡", author: "æå•†éš±", poem: "ç„¡é¡Œ" },
            { line: "è Ÿç‚¬æˆç°æ·šå§‹ä¹¾", author: "æå•†éš±", poem: "ç„¡é¡Œ" },
            { line: "èº«ç„¡å½©é³³é›™é£›ç¿¼", author: "æå•†éš±", poem: "ç„¡é¡Œ" },
            { line: "å¿ƒæœ‰éˆçŠ€ä¸€é»é€š", author: "æå•†éš±", poem: "ç„¡é¡Œ" },
            
            // ç™½å±…æ˜“ã€Šé•·æ¨æ­Œã€‹
            { line: "å›çœ¸ä¸€ç¬‘ç™¾åªšç”Ÿ", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "å…­å®®ç²‰é»›ç„¡é¡è‰²", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "åœ¨å¤©é¡˜ä½œæ¯”ç¿¼é³¥", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "åœ¨åœ°é¡˜ç‚ºé€£ç†æ", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "å¤©é•·åœ°ä¹…æœ‰æ™‚ç›¡", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "æ­¤æ¨ç¶¿ç¶¿ç„¡çµ•æœŸ", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "æ˜¥é¢¨æ¡ƒæèŠ±é–‹æ—¥", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            { line: "ç§‹é›¨æ¢§æ¡è‘‰è½æ™‚", author: "ç™½å±…æ˜“", poem: "é•·æ¨æ­Œ" },
            
            // æç…œã€Šè™ç¾äººã€‹
            { line: "å•å›èƒ½æœ‰å¹¾å¤šæ„", author: "æç…œ", poem: "è™ç¾äºº" },
            { line: "æ°ä¼¼ä¸€æ±Ÿæ˜¥æ°´å‘æ±æµ", author: "æç…œ", poem: "è™ç¾äºº" },
            
            // è¾›æ£„ç–¾ã€Šé’ç‰æ¡ˆÂ·å…ƒå¤•ã€‹
            { line: "çœ¾è£å°‹ä»–åƒç™¾åº¦", author: "è¾›æ£„ç–¾", poem: "é’ç‰æ¡ˆÂ·å…ƒå¤•" },
            { line: "é©€ç„¶å›é¦–", author: "è¾›æ£„ç–¾", poem: "é’ç‰æ¡ˆÂ·å…ƒå¤•" },
            { line: "é‚£äººå»åœ¨", author: "è¾›æ£„ç–¾", poem: "é’ç‰æ¡ˆÂ·å…ƒå¤•" },
            { line: "ç‡ˆç«é—ŒçŠè™•", author: "è¾›æ£„ç–¾", poem: "é’ç‰æ¡ˆÂ·å…ƒå¤•" },
            
            // æ–‡å¤©ç¥¥ã€Šéé›¶ä¸æ´‹ã€‹
            { line: "äººç”Ÿè‡ªå¤èª°ç„¡æ­»", author: "æ–‡å¤©ç¥¥", poem: "éé›¶ä¸æ´‹" },
            { line: "ç•™å–ä¸¹å¿ƒç…§æ±—é’", author: "æ–‡å¤©ç¥¥", poem: "éé›¶ä¸æ´‹" },
            { line: "å±±æ²³ç ´ç¢é¢¨é£„çµ®", author: "æ–‡å¤©ç¥¥", poem: "éé›¶ä¸æ´‹" },
            { line: "èº«ä¸–æµ®æ²‰é›¨æ‰“è", author: "æ–‡å¤©ç¥¥", poem: "éé›¶ä¸æ´‹" },
            
            // ç´è˜­æ€§å¾·ã€Šæœ¨è˜­èŠ±Â·æ“¬å¤æ±ºçµ•è©ã€‹
            { line: "äººç”Ÿè‹¥åªå¦‚åˆè¦‹", author: "ç´è˜­æ€§å¾·", poem: "æœ¨è˜­èŠ±Â·æ“¬å¤æ±ºçµ•è©" },
            { line: "ä½•äº‹ç§‹é¢¨æ‚²ç•«æ‰‡", author: "ç´è˜­æ€§å¾·", poem: "æœ¨è˜­èŠ±Â·æ“¬å¤æ±ºçµ•è©" },
            { line: "ç­‰é–’è®Šå»æ•…äººå¿ƒ", author: "ç´è˜­æ€§å¾·", poem: "æœ¨è˜­èŠ±Â·æ“¬å¤æ±ºçµ•è©" },
            { line: "å»é“æ•…äººå¿ƒæ˜“è®Š", author: "ç´è˜­æ€§å¾·", poem: "æœ¨è˜­èŠ±Â·æ“¬å¤æ±ºçµ•è©" },
            
            // æç™½ã€Šå®£å·è¬è„æ¨“é¤åˆ¥æ ¡æ›¸å”é›²ã€‹
            { line: "æŠ½åˆ€æ–·æ°´æ°´æ›´æµ", author: "æç™½", poem: "å®£å·è¬è„æ¨“é¤åˆ¥æ ¡æ›¸å”é›²" },
            { line: "èˆ‰æ¯æ¶ˆæ„æ„æ›´æ„", author: "æç™½", poem: "å®£å·è¬è„æ¨“é¤åˆ¥æ ¡æ›¸å”é›²" },
            { line: "äººç”Ÿåœ¨ä¸–ä¸ç¨±æ„", author: "æç™½", poem: "å®£å·è¬è„æ¨“é¤åˆ¥æ ¡æ›¸å”é›²" },
            { line: "æ˜æœæ•£é«®å¼„æ‰èˆŸ", author: "æç™½", poem: "å®£å·è¬è„æ¨“é¤åˆ¥æ ¡æ›¸å”é›²" },
            
            // æè³€ã€Šé›é–€å¤ªå®ˆè¡Œã€‹
            { line: "é»‘é›²å£“åŸåŸæ¬²æ‘§", author: "æè³€", poem: "é›é–€å¤ªå®ˆè¡Œ" },
            { line: "ç”²å…‰å‘æ—¥é‡‘é±—é–‹", author: "æè³€", poem: "é›é–€å¤ªå®ˆè¡Œ" },
            { line: "å ±å›é»ƒé‡‘è‡ºä¸Šæ„", author: "æè³€", poem: "é›é–€å¤ªå®ˆè¡Œ" },
            { line: "ææ”œç‰é¾ç‚ºå›æ­»", author: "æè³€", poem: "é›é–€å¤ªå®ˆè¡Œ" }
        ];

        // DOM elements
        const charactersGrid = document.getElementById('charactersGrid');
        const poemDisplay = document.getElementById('poemDisplay');
        const poemHint = document.getElementById('poemHint');
        const charCountDisplay = document.getElementById('charCountDisplay');
        const timerElement = document.getElementById('timer');
        const clearSelectionButton = document.getElementById('clearSelection');
        const submitButton = document.getElementById('submitPoem');
        const scoreElement = document.getElementById('score');
        const scoreLabel = document.getElementById('scoreLabel');
        const gameMessage = document.getElementById('gameMessage');
        const resultIcon = document.getElementById('resultIcon');
        const poemErrorIcon = document.getElementById('poemErrorIcon');
        const successIcon = document.getElementById('successIcon');
        const correctAnswer = document.getElementById('correctAnswer');
        const correctAnswerText = document.getElementById('correctAnswerText');
        const closeGameMessage = document.getElementById('closeGameMessage');
        const aiExplainSuccessRow = document.getElementById('aiExplainSuccessRow');
        const aiExplainBtnSuccess = document.getElementById('aiExplainBtnSuccess');
        const aiExplainFailRow = document.getElementById('aiExplainFailRow');
        const aiExplainBtnFail = document.getElementById('aiExplainBtnFail');
        const aiExplainModal = document.getElementById('aiExplainModal');
        const aiExplainClose = document.getElementById('aiExplainClose');
        const aiExplainOK = document.getElementById('aiExplainOK');
        const aiExplainReload = document.getElementById('aiExplainReload');
        const aiExplainLine = document.getElementById('aiExplainLine');
        const aiExplainMeta = document.getElementById('aiExplainMeta');
        const aiExplainContent = document.getElementById('aiExplainContent');
        const aiExplainError = document.getElementById('aiExplainError');
        
        // Notification elements
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const closeNotification = document.getElementById('closeNotification');
        const timeBarFill = document.getElementById('timeBarFill');
        const timeBarContainer = document.getElementById('timeBarContainer');
        const selectionStatus = document.getElementById('selectionStatus');

        // ===== æ¨¡å¼è¼”åŠ©ï¼šé›†ä¸­åˆ¤æ–·å…¥å£ï¼Œé¿å…æ¢ä»¶åˆ†æ•£é‡è¦† =====
        // ã€é‡æ§‹ã€‘å·²ç§»é™¤ window.GameMode.isTimedScore()ï¼Œæ”¹ç”¨ GameMode.isTimedScore()
        function isLocalBattle(){
            try { return window.GameMode.isLocal() && window.GameState.isActive; } catch(_) { return false; }
        }

        // æä¾›å‘½åç©ºé–“å ä½ï¼Œå¾ŒçºŒå¯é€æ­¥æŠŠç›¸é—œå‡½å¼æ›è¼‰è‡³æ­¤ï¼Œé¿å…æ··å
        window.LocalBattle = window.LocalBattle || {};
        window.RemoteTimed = window.RemoteTimed || {};
        // ===== ç«¶è³½è³½é“ï¼šemoji åˆ†é…èˆ‡æ¸²æŸ“ =====
        (function(){
            const EMOJI_POOL = Array.from(
                'ğŸ¯ğŸ¦ŠğŸ¼ğŸ¸ğŸ¶ğŸ±ğŸ°ğŸ¦ğŸµğŸ¦„ğŸ¨ğŸ·ğŸ®ğŸ”ğŸ¤ğŸ¦†ğŸ¦‰ğŸ¦‡ğŸ™ğŸ¦‘ğŸ¦€ğŸ¦ğŸ¦ğŸ ğŸŸğŸ¬ğŸ³ğŸŠğŸ¢ğŸ¦ğŸğŸğŸ¦‹ğŸğŸœğŸ•·ï¸ğŸ¦‚ğŸŒğŸ›ğŸ¦”ğŸ¦¥ğŸ¦¨ğŸ¦˜ğŸ¦ğŸ¦šğŸ¦œğŸ¦¢ğŸ¦©ğŸ•Šï¸ğŸ§ğŸ¦ğŸ¤ğŸ¦†ğŸ¦…ğŸºğŸ¦„ğŸ¦’ğŸ¦“ğŸ¦ŒğŸ—ğŸ¦ğŸ˜ğŸ«ğŸªğŸ¦™ğŸğŸğŸ‘ğŸğŸ„'
            );
            const nameMax = { cn: 3, en: 6 };
            function isMostlyChinese(s){
                const m = (s||'').match(/[\u4e00-\u9fa5]/g);
                return (m ? m.length : 0) * 2 >= String(s||'').length; // ç²—ç•¥åˆ¤æ–·
            }
            function trimName(s){
                s = String(s||'');
                const max = isMostlyChinese(s) ? nameMax.cn : nameMax.en;
                if (s.length <= max) return s;
                return s.slice(0, max) + 'â€¦';
            }
            function seededPick(arr, seed){
                let h = 2166136261>>>0; const str = String(seed||'');
                for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = (h * 16777619)>>>0; }
                return arr[h % arr.length];
            }
            function assignEmojisFor(ids, roomCode){
                const used = new Set();
                const map = {};
                (ids||[]).forEach((id, idx) => {
                    let pick = seededPick(EMOJI_POOL, roomCode+':'+id+':'+idx);
                    let guard=0;
                    while (used.has(pick) && guard<EMOJI_POOL.length) { pick = seededPick(EMOJI_POOL, roomCode+':'+id+':'+idx+':'+(guard)); guard++; }
                    used.add(pick); map[id] = pick;
                });
                return map;
            }
            window.RaceTrack = {
                buildEmojiMap(ids, roomCode){ return assignEmojisFor(ids, roomCode||'ROOM'); },
                ensureEmojis(){
                    // ã€é‡æ§‹ã€‘ä¸å†éœ€è¦ï¼Œemoji åœ¨åˆå§‹åŒ–æ™‚å·²åˆ†é…åˆ° GameState.players
                    try { console.debug('[race] ensureEmojis: skipped (using GameState)'); } catch(_){ }
                },
                render(){
                    try {
                        // console.log('[race] render: START'); // å·²é—œé–‰èª¿è©¦æ—¥å¿—
                        const track = document.getElementById('raceTrack');
                        if (!track) return;
                        
                        // ã€é‡æ§‹ã€‘ç›´æ¥åˆ¤æ–·æ¨¡å¼ï¼Œä¸å†éœ€è¦åŒæ­¥
                        if (!window.GameMode.isAnyBattle()) {
                            track.classList.add('hidden');
                            // æ¢å¾©å€’è¨ˆæ™‚é€²åº¦æ¢é¡¯ç¤º
                            try {
                                const timeBarFill = document.getElementById('timeBarFill');
                                if (timeBarFill && timeBarFill.style.display === 'none') {
                                    timeBarFill.style.display = '';
                                }
                            } catch(_){}
                            return;
                        }
                        
                        track.classList.remove('hidden');
                        
                        // ã€é‡æ§‹ã€‘ç›´æ¥è®€å–çµ±ä¸€æ•¸æ“šæº
                        const players = window.GameState.players;
                        if (!players || players.length === 0) {
                            return;
                        }
                        
                        const rows = players.map(p => ({
                            uid: p.uid,
                            name: trimName(p.name),
                            score: p.score || 0,
                            last: p.lastAnswerTs || 0,
                            emoji: p.emoji || 'ğŸƒ'
                        }));
                        
                        const maxScore = Math.max(1, ...rows.map(r => r.score));
                        // console.log('[race] render scores:', rows.map(r => `${r.name}: ${r.score}`).join(', '), 'maxScore:', maxScore); // å·²é—œé–‰èª¿è©¦æ—¥å¿—
                        
                        // æ’åï¼ˆåƒ…ä¾›å¾½ç« ä½¿ç”¨ï¼‰
                        const ranked = [...rows].sort((a,b) => (b.score - a.score) || (a.last - b.last));
                        const rankByUid = {}; ranked.forEach((r,i)=> rankByUid[r.uid] = i+1);
                        
                        // é¦–æ¬¡æ¸²æŸ“å»ºæ¨¹
                        if (!track.dataset.built) { track.innerHTML = ''; track.dataset.built = '1'; }
                        
                        // ç²å–ç•¶å‰ç”¨æˆ¶ IDï¼ˆç”¨æ–¼é«˜äº®ï¼Œåƒ…é ç¨‹æ¨¡å¼ï¼‰
                        const currentUserId = (window.GameMode.isRemote() && window.GameState.remote.currentUserId) || null;
                        
                        // ç‚ºæ¯ä½é¸æ‰‹å»º/æ›´æ–°ç¯€é»
                        rows.forEach((r, i) => {
                            // åªåœ¨é ç¨‹æ¨¡å¼é«˜äº®è‡ªå·±ï¼Œæœ¬åœ°æ¨¡å¼ä¸é«˜äº®
                            const isMe = window.GameMode.isRemote() && (currentUserId && r.uid === currentUserId);
                            let pin = track.querySelector(`[data-uid="${r.uid}"]`);
                            if (!pin) {
                                pin = document.createElement('div');
                                pin.dataset.uid = r.uid;
                                // ç°¡åŒ–è³½é“ï¼šåªé¡¯ç¤º emojiï¼Œè‡ªå·±çš„å‹•ç‰©æ”¾å¤§ä¸”åŠ é™°å½±
                                const emojiSize = isMe ? 'text-3xl sm:text-4xl' : 'text-2xl sm:text-3xl';
                                const pinClass = isMe ? 'shadow-lg ring-2 ring-yellow-400' : 'shadow-md';
                                pin.className = `w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/90 flex items-center justify-center ${pinClass} transition-all duration-500 ease-out will-change-transform`;
                                pin.style.position = 'absolute';
                                pin.style.top = '50%';
                                pin.innerHTML = `<span class="emoji ${emojiSize}">${r.emoji}</span>`;
                                track.appendChild(pin);
                                // console.log('[race] render: created pin for', r.name, 'emoji=', r.emoji, 'isMe=', isMe); // å·²é—œé–‰èª¿è©¦æ—¥å¿—
                            } else {
                                pin.querySelector('.emoji').textContent = r.emoji;
                                // æ›´æ–°é«˜äº®ç‹€æ…‹
                                const emojiEl = pin.querySelector('.emoji');
                                if (isMe) {
                                    emojiEl.className = 'emoji text-3xl sm:text-4xl';
                                    pin.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/90 flex items-center justify-center shadow-lg ring-2 ring-yellow-400 transition-all duration-500 ease-out will-change-transform';
                                } else {
                                    emojiEl.className = 'emoji text-2xl sm:text-3xl';
                                    pin.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/90 flex items-center justify-center shadow-md transition-all duration-500 ease-out will-change-transform';
                                }
                            }
                            
                            // ã€ä¿®å¾©ã€‘æ ¹æ“šåˆ†æ•¸è¨ˆç®—ä½ç½®ï¼Œæ­£ç¢ºè¨­ç½® left å’Œ transform
                            const pct = Math.max(3, Math.min(97, Math.round((r.score / maxScore) * 94 + 3)));
                            const offsetY = ((r.uid||'').charCodeAt(0)%5)-2; // -2..+2 å‚ç›´éŒ¯å±¤
                            const scale = isMe ? 1.2 : 1;
                            // console.log(`[race] ${r.name}: score=${r.score}, maxScore=${maxScore}, pct=${pct}%`); // å·²é—œé–‰èª¿è©¦æ—¥å¿—
                            
                            // ä½¿ç”¨ left è¨­ç½®æ°´å¹³ä½ç½®ï¼Œtransform åªè² è²¬å±…ä¸­ã€å‚ç›´åç§»å’Œç¸®æ”¾
                            pin.style.left = pct + '%';
                            pin.style.transform = `translate(-50%, calc(-50% + ${offsetY}px)) scale(${scale})`;
                        });
                        // console.log('[race] render: COMPLETE. rendered', rows.length, 'pins'); // å·²é—œé–‰èª¿è©¦æ—¥å¿—
                    } catch(e){ console.error('[race] render ERROR:', e); }
                }
            };
        })();

        // Difficulty settings
        const difficultySettings = {
            easy: { timeLimit: 45, charCount: 15 },
            medium: { timeLimit: 30, charCount: 15 },
            hard: { timeLimit: 15, charCount: 15 }
        };
        
        // Game state variables
        let timerInterval;
        let timeLeft = 30;
        let charCount = 15;
        let score = 0;
        let currentPoem;
        let isGameActive = false;
        let poemCharacters = [];
        let shuffledCharacters = [];
        let currentGameMode = 'preset'; // 'preset', 'custom', or 'battle'
        let customPoems = [];
        let roundTimeLimit = 30; // ç•¶å‰å›åˆæ™‚é–“ä¸Šé™ï¼Œç”¨æ–¼é€²åº¦æ¢æ¯”ä¾‹
        let areCoreListenersBound = false; // é˜²æ­¢é‡è¤‡ç¶å®š
        let selectionStack = []; // å·²é¸å­—å †ç–Šï¼ˆæ”¯æŒæ’¤å›ï¼‰
        
        // ã€é‡æ§‹ã€‘å°æˆ°æ¨¡å¼æ•¸æ“šå·²é·ç§»åˆ° window.GameStateï¼Œä¸å†ä½¿ç”¨å±€éƒ¨ battleMode å°è±¡
        
        // Difficulty settings elements
        const difficultySelect = document.getElementById('difficultySelect');
        const timeLimitSlider = document.getElementById('timeLimit');
        const timeLimitValue = document.getElementById('timeLimitValue');
        const charCountSlider = document.getElementById('charCount');
        const charCountValue = document.getElementById('charCountValue');
        
        // Custom poem elements (gameMode å·²ç§»è‡³è¨­ç½®æ¨¡æ…‹å½ˆçª—ä¸­çš„radioæŒ‰éˆ•)
        // å·²ç§»é™¤è‡ªå®šç¾©è©©å¥åŠŸèƒ½ï¼ˆç›¸é—œå…ƒç´ ä¸å†ä½¿ç”¨ï¼‰
        // è¨­ç½®æ¨¡æ…‹å½ˆçª—å…ƒç´ 
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const adminModeToggle = document.getElementById('adminModeToggle');
        
        // å°æˆ°çµæŸç¸½çµçª—å£å…ƒç´ 
        const battleResultModal = document.getElementById('battleResultModal');
        const winnerAnnouncement = document.getElementById('winnerAnnouncement');
        const winnerScore = document.getElementById('winnerScore');
        const battleRankings = document.getElementById('battleRankings');
        const newBattleBtn = document.getElementById('newBattleBtn');
        const exitBattleBtn = document.getElementById('exitBattleBtn');
        
        // å°æˆ°æ¨¡å¼å…ƒç´ 
        const battleModeSettings = document.getElementById('battleModeSettings');
        const playerCountSelect = document.getElementById('playerCount');
        const playerNamesContainer = document.getElementById('playerNamesContainer');
        const roundsPerPlayerInput = document.getElementById('roundsPerPlayer');
        const speedModeCheckbox = document.getElementById('speedMode');
        const battleScoreboard = document.getElementById('battleScoreboard');
        const leftPlayersContainer = document.getElementById('leftPlayers');
        const rightPlayersContainer = document.getElementById('rightPlayers');
        const battlePreviewModal = document.getElementById('battlePreviewModal');
        const battlePreviewClose = document.getElementById('battlePreviewClose');
        const battlePreviewBack = document.getElementById('battlePreviewBack');
        const battlePreviewStart = document.getElementById('battlePreviewStart');
        const battlePreviewPlayerCount = document.getElementById('battlePreviewPlayerCount');
        const battlePreviewRounds = document.getElementById('battlePreviewRounds');
        const battlePreviewTotalQuestions = document.getElementById('battlePreviewTotalQuestions');
        const battlePreviewTimeLimit = document.getElementById('battlePreviewTimeLimit');
        const battlePreviewCharCount = document.getElementById('battlePreviewCharCount');
        const battlePreviewPlayersList = document.getElementById('battlePreviewPlayersList');
        const battlePreviewSpeedRow = document.getElementById('battlePreviewSpeedRow');
        const battlePreviewSpeedText = document.getElementById('battlePreviewSpeedText');
        const battlePreviewNote = document.getElementById('battlePreviewNote');
        // startBattleBtn å·²ç§»é™¤ï¼Œå°æˆ°æ¨¡å¼é€šéä¿å­˜è¨­ç½®è‡ªå‹•å•Ÿå‹•
        const customPoemInput = document.getElementById('customPoem');
        const saveCustomPoemButton = document.getElementById('saveCustomPoem');
        const savedPoemsList = document.getElementById('savedPoemsList');
        const noSavedPoems = document.getElementById('noSavedPoems');

        // Show notification
        const showNotification = (message, duration = 3000) => {
            notificationText.textContent = message;
            notification.classList.remove('translate-y-[-150%]');
            notification.classList.add('translate-y-0');
            
            setTimeout(() => {
                notification.classList.remove('translate-y-0');
                notification.classList.add('translate-y-[-150%]');
            }, duration);
        };

        // Close notification manually
        closeNotification.addEventListener('click', () => {
            notification.classList.remove('translate-y-0');
            notification.classList.add('translate-y-[-150%]');
        });

        // Close game message manually
        closeGameMessage.addEventListener('click', () => {
            hideResultModal();
            // é™æ™‚æ¨¡å¼ä¸‹ä¸è§¸ç™¼ä»»ä½•æœ¬åœ°è¼ªæµæˆ–æ‰‹å‹•æ›é¡Œæµç¨‹ï¼ˆå·²è‡ªå‹•æ›é¡Œï¼‰
            if (window.GameMode.isTimedScore()) {
                return;
            }
            // å¦‚æœæ˜¯å¯¹æˆ˜æ¨¡å¼ä¸”æ¸¸æˆç»“æŸï¼Œåˆ™è¿›å…¥ä¸‹ä¸€è½®
            if (window.GameMode.isLocal() && window.GameState.isActive && !isGameActive) {
                // å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°å…³é—­åŠ¨ç”»
                setTimeout(() => {
                    if (typeof window.LocalBattle?.startRound === 'function') window.LocalBattle.startRound();
                }, 250);
            } else if (!isGameActive) {
                // å•äººæ¨¡å¼ï¼Œå¼€å§‹æ–°ä¸€è½®
                setTimeout(() => {
                    startNewRound();
                }, 250);
            }
        });

        // è®¡ç®—å¹¶è®¾ç½®é”™è¯¯å›¾æ ‡ä½ç½®
        const positionErrorIcon = () => {
            if (!poemDisplay.value || poemDisplay.value === 'æ™‚é–“åˆ°') return;
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å…ƒç´ æ¥æµ‹é‡æ–‡å­—å®½åº¦
            const tempSpan = document.createElement('span');
            tempSpan.style.font = window.getComputedStyle(poemDisplay).font;
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.whiteSpace = 'nowrap';
            tempSpan.textContent = poemDisplay.value;
            document.body.appendChild(tempSpan);
            
            const textWidth = tempSpan.offsetWidth;
            document.body.removeChild(tempSpan);
            
            // è®¡ç®—å›¾æ ‡ä½ç½®ï¼šå®¹å™¨ä¸­å¿ƒ + æ–‡å­—å®½åº¦çš„ä¸€åŠ + é—´è·
            const containerWidth = poemDisplay.offsetWidth;
            const iconLeft = (containerWidth / 2) + (textWidth / 2) + 8; // 8pxé—´è·
            
            // ç¡®ä¿å›¾æ ‡ä¸è¶…å‡ºå®¹å™¨è¾¹ç•Œ
            const maxLeft = containerWidth - 32; // 32px = å›¾æ ‡å®½åº¦ + è¾¹è·
            poemErrorIcon.style.left = Math.min(iconLeft, maxLeft) + 'px';
        };

        // æ˜¾ç¤ºç»“æœæµ®çª—
        const showResultModal = (isSuccess, message, answer = null) => {
            // é™æ™‚æ¨¡å¼ï¼šä¸é¡¯ç¤ºæœ¬åœ°çµæœæµ®çª—
            if (window.GameMode.isTimedScore()) {
                return;
            }
            if (isSuccess) {
                // ç­”å¯¹äº†ï¼šåªæ˜¾ç¤ºæˆåŠŸå›¾æ ‡ï¼Œç”¨æˆ·ç­”æ¡ˆä¿æŒç»¿è‰²
                successIcon.classList.remove('hidden');
                // ä¸é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆå€ï¼ˆæ²¿ç”¨åŸå…ˆé‚è¼¯ï¼‰ï¼Œåƒ…é¡¯ç¤º AI æŒ‰éˆ•
                correctAnswer.classList.add('hidden');
                poemErrorIcon.classList.add('hidden');
                if (aiExplainSuccessRow) aiExplainSuccessRow.classList.remove('hidden');
                if (aiExplainFailRow) aiExplainFailRow.classList.add('hidden');
                
                // ä¿æŒç”¨æˆ·ç­”æ¡ˆçš„ç»¿è‰²æ ·å¼ï¼ˆåœ¨endRoundä¸­å·²è®¾ç½®ï¼‰
            } else {
                // ç­”é”™äº†ï¼šæ˜¾ç¤ºé”™è¯¯å›¾æ ‡åœ¨ç”¨æˆ·ç­”æ¡ˆæ—ï¼Œç”¨æˆ·ç­”æ¡ˆå˜çº¢
                if (poemDisplay.value && poemDisplay.value !== 'æ™‚é–“åˆ°') {
                    // åªæœ‰å½“æœ‰ç”¨æˆ·ç­”æ¡ˆæ—¶æ‰æ˜¾ç¤ºé”™è¯¯å›¾æ ‡
                    positionErrorIcon();
                    poemErrorIcon.classList.remove('hidden');
                    
                    // å°†ç”¨æˆ·é€‰æ‹©çš„è¯—å¥å˜ä¸ºçº¢è‰²
                    poemDisplay.classList.remove('text-surface-800', 'text-secondary');
                    poemDisplay.classList.add('text-red-600');
                } else {
                    poemErrorIcon.classList.add('hidden');
                }
                
                if (answer) {
                    correctAnswerText.textContent = answer;
                    correctAnswer.classList.remove('hidden');
                } else {
                    correctAnswer.classList.add('hidden');
                }
                successIcon.classList.add('hidden');
                if (aiExplainFailRow) aiExplainFailRow.classList.remove('hidden');
                if (aiExplainSuccessRow) aiExplainSuccessRow.classList.add('hidden');
            }

            // æ ¹æ“šæ¨¡å¼åˆ‡æ›ä¸‹ä¸€æ­¥æŒ‰éˆ•æ–‡æ¡ˆï¼š
            // å–®äºº=ã€Œä¸‹ä¸€é¦–ã€ï¼›å°æˆ°=ã€ŒXX é–‹å§‹ç­”é¡Œã€ï¼ˆä¸‹ä¸€ä½é¸æ‰‹ï¼‰
            if (closeGameMessage) {
                // é ç¨‹é™æ™‚ï¼šçµ±ä¸€é¡¯ç¤ºã€Œä¸‹ä¸€é¦–ã€ï¼›æœ¬åœ°è¼ªæµç¶­æŒåŸæ–‡æ¡ˆ
                if (window.GameMode.isTimedScore()) {
                    closeGameMessage.textContent = 'ä¸‹ä¸€é¦–';
                } else if (window.GameMode.isLocal() && window.GameState.isActive && Array.isArray(window.GameState.players) && window.GameState.players.length > 0) {
                    const nextIndex = (window.GameState.turnBased.currentTurnIndex + 1) % window.GameState.players.length;
                    const nextPlayer = window.GameState.players[nextIndex];
                    const name = (nextPlayer && nextPlayer.name) ? nextPlayer.name : 'é¸æ‰‹';
                    closeGameMessage.textContent = `${name} é–‹å§‹ç­”é¡Œ`;
                } else {
                    closeGameMessage.textContent = 'ä¸‹ä¸€é¦–';
                }
            }

            // æ˜¾ç¤ºæµ®çª—ï¼Œä½¿ç”¨ç®€å•çš„æ»‘å…¥åŠ¨ç”»
            gameMessage.classList.remove('hidden');
            const modalContent = gameMessage.querySelector('div');
            modalContent.style.animation = 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards';
            // ç¢ºä¿ã€Œä¸‹ä¸€è¼ªã€ç¨ç«‹ä¸€è¡Œï¼šæ­¤è™•çµæ§‹ä¸Šå·²åœ¨å¦ä¸€å€‹å®¹å™¨ä¸­ï¼Œä¸åŒ flex è¡Œ
        };

        // DeepSeek ä»£ç†èª¿ç”¨ï¼ˆéä¸²æµï¼‰
        async function callDeepSeek(messages) {
            const DEFAULT_PROXY = 'https://deepseek-proxy-chi.vercel.app/api/deepseek';
            const url = window.DEEPSEEK_PROXY_URL || localStorage.getItem('DEEPSEEK_PROXY_URL') || DEFAULT_PROXY;
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages,
                    temperature: 0.7,
                    max_tokens: 900
                })
            });
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();
            return data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : '';
        }

        // æº–å‚™æç¤ºè©ï¼ˆé©åˆä¸­å­¸ç”Ÿã€å…ˆè­¯æ–‡ã€å†åŸä½œå…¨æ–‡èˆ‡ç°¡è¦è³æã€é‡é»èªªæ˜æ­¤å¥ä¹‹ç¾ï¼‰
        function buildAiPrompt(poemObj) {
            const line = poemObj?.line || '';
            const author = poemObj?.author || '';
            const poemTitle = poemObj?.poem || '';
            return [
                { role: 'system', content: 'ä½ æ˜¯ä¸€ä½æº«æŸ”è€Œå°ˆæ¥­çš„åœ‹å­¸å°å¸«ï¼Œæ“…é•·ç”¨æ¸…æ™°ã€å„ªç¾ã€è²¼è¿‘ä¸­å­¸ç”Ÿçš„èªè¨€è¬›è§£å¤å…¸è©©è©ã€‚è«‹å°‡ç¸½å­—æ•¸æ§åˆ¶åœ¨ç´„300å­—ï¼Œèªè¨€ç²¾ç…‰ã€æ˜“æ‡‚ã€‚ä¸è¦ä½¿ç”¨ç²—é«”æˆ–ä»»ä½• Markdown èªæ³•å¼·èª¿ã€‚' },
                { role: 'user', content: `è«‹å¹«æˆ‘è§£è®€ä¸‹é¢é€™å¥è©©ï¼Œè¼¸å‡ºçµæ§‹ç‚ºä¸‰æ®µï¼ˆç´„300å­—ï¼‰ï¼š\nã€è­¯æ–‡ã€‘ç”¨1-2å¥çµ¦å‡ºæº–ç¢ºã€å„ªç¾çš„ç¾ä»£æ–‡ç¿»è­¯ï¼›\nã€åŸä½œã€‘èªªæ˜è©©å¥å‡ºè™•ï¼Œçµ¦å‡ºåŸä½œå…¨æ–‡ï¼ˆè‹¥éé•·å¯ç¯€é¸æ ¸å¿ƒæ®µè½ï¼‰ï¼Œä¿æŒæ’ç‰ˆæ¸…æ™°ï¼›\nã€è³æã€‘ç”¨2-3å¥æŒ‡å‡ºæ•´é¦–ä½œå“çš„æ°£æ°›èˆ‡æƒ…æ„Ÿï¼Œä¸¦è‘—é‡è©•é»é¡Œç›®è©²å¥ã€Œ${line}ã€çš„ç¾ï¼ˆæ„è±¡/ç¯€å¥/å°ä»—ç­‰ï¼‰ã€‚\nè«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œé¢¨æ ¼å‹å–„ï¼Œé©åˆä¸­å­¸ç”Ÿã€‚\nè©©å¥ï¼š${line}\nä½œè€…ï¼š${author}\nè©©é¡Œï¼š${poemTitle}` }
            ];
        }

        function openAiExplainModal() {
            if (!currentPoem) return;
            aiExplainError.classList.add('hidden');
            aiExplainError.textContent = '';
            aiExplainContent.innerHTML = '<div class="ai-loading-wrap"><div class="ai-spinner"></div><div class="ai-loading-text">æ­£åœ¨ç”Ÿæˆè§£è®€ï¼Œè«‹ç¨å€™â€¦</div></div>';
            aiExplainLine.textContent = currentPoem.line || '';
            aiExplainMeta.textContent = currentPoem.author && currentPoem.poem ? `å‡ºè‡ªã€Š${currentPoem.poem}ã€‹Â·${currentPoem.author}` : '';
            aiExplainModal.classList.remove('hidden');
        }

        async function generateAiExplanation(triggerButton) {
            try {
                if (triggerButton) triggerButton.classList.add('ai-explain-loading');
                aiExplainReload && aiExplainReload.classList.add('ai-explain-loading');
                const messages = buildAiPrompt(currentPoem);
                const content = await callDeepSeek(messages);
                const pretty = formatAiContent(content || '', currentPoem.line || '');
                aiExplainContent.innerHTML = pretty || '<div class="text-surface-700">æš«ç„¡å…§å®¹</div>';
                aiExplainError.classList.add('hidden');
            } catch (err) {
                aiExplainError.textContent = 'ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚' + 'ï¼ˆ' + String(err) + 'ï¼‰';
                aiExplainError.classList.remove('hidden');
            } finally {
                if (triggerButton) triggerButton.classList.remove('ai-explain-loading');
                aiExplainReload && aiExplainReload.classList.remove('ai-explain-loading');
            }
        }

        // å°‡æ¨¡å‹è¼¸å‡ºæ ¼å¼åŒ–ç‚ºæœ¬ç«™ç¾å­¸é¢¨æ ¼ï¼Œä¸¦åšé•·åº¦æ§åˆ¶èˆ‡é«˜äº®
        function formatAiContent(raw, targetLine) {
            // å»é™¤å·¦å³ç©ºç™½èˆ‡å¯èƒ½çš„ Markdown ç²—é«”æ˜Ÿè™Ÿ
            const text = (raw || '')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/^[\s\u200B\ufeff]+|[\s\u200B\ufeff]+$/g, '');
            // ç²—ç•¥æˆªæ–·è‡³ç´„300å­—
            const limited = text.length > 420 ? text.slice(0, 420) + 'â€¦' : text;
            // åˆ‡åˆ†æ®µè½ï¼ˆä»¥ã€ã€‘æ¨™é¡Œæˆ–ç©ºè¡Œç‚ºç•Œï¼‰
            const parts = limited.split(/\n{2,}|(?=ã€è­¯æ–‡|ã€åŸä½œ|ã€è³æ)/).map(p=>p.trim()).filter(Boolean);
            const esc = (s)=>s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
            // ç›®æ¨™è©©å¥é«˜äº®
            const highlight = (s)=>s.replace(new RegExp(targetLine.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'), `<span class=\"ai-highlight\">${esc(targetLine)}</span>`);

            const sections = [];
            let y = parts.join('\n');
            // ç›¡é‡æå–ä¸‰æ®µ
            const yiz = /ã€è­¯æ–‡ã€‘([\s\S]*?)(?=ã€|$)/.exec(y);
            const yuanz = /ã€åŸä½œã€‘([\s\S]*?)(?=ã€|$)/.exec(y);
            const shang = /ã€è³æã€‘([\s\S]*?)(?=ã€|$)/.exec(y);

            if (yiz) sections.push(`<div class=\"ai-section\"><div class=\"ai-title\">ğŸ“˜ è­¯æ–‡</div><div class=\"ai-body\">${esc(yiz[1].trim())}</div></div>`);
            if (yuanz) sections.push(`<div class=\"ai-section\"><div class=\"ai-title\">ğŸ“œ åŸä½œ</div><div class=\"ai-poem-block\">${esc(yuanz[1].trim())}</div></div>`);
            if (shang) sections.push(`<div class=\"ai-section\"><div class=\"ai-title\">ğŸŒŸ è³æ</div><div class=\"ai-body\">${highlight(esc(shang[1].trim()))}</div></div>`);

            if (!sections.length) {
                // å¾Œå‚™ï¼šä»¥æ®µè½æ‹†åˆ†
                const paras = parts.map(p=>`<p>${highlight(esc(p))}</p>`).join('');
                return `<div class=\"ai-section\">${paras}</div>`;
            }
            return sections.join('<div style=\"height:8px\"></div>');
        }
        
        if (aiExplainBtnSuccess) {
            aiExplainBtnSuccess.addEventListener('click', (e) => {
                openAiExplainModal();
                generateAiExplanation(e.currentTarget);
            });
        }
        if (aiExplainBtnFail) {
            aiExplainBtnFail.addEventListener('click', (e) => {
                openAiExplainModal();
                generateAiExplanation(e.currentTarget);
            });
        }
        if (aiExplainClose) {
            aiExplainClose.addEventListener('click', () => {
                aiExplainModal.classList.add('hidden');
            });
        }
        if (aiExplainOK) {
            aiExplainOK.addEventListener('click', () => {
                aiExplainModal.classList.add('hidden');
            });
        }
        if (aiExplainReload) {
            aiExplainReload.addEventListener('click', (e) => {
                openAiExplainModal();
                generateAiExplanation(e.currentTarget);
            });
        }

        // éšè—ç»“æœæµ®çª—
        const hideResultModal = () => {
            const modalContent = gameMessage.querySelector('div');
            modalContent.style.transform = 'translateY(10px)';
            modalContent.style.opacity = '0';
            modalContent.style.transition = 'all 0.2s ease-out';
            
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—å…ƒç´ 
            setTimeout(() => {
                gameMessage.classList.add('hidden');
                modalContent.style.transform = '';
                modalContent.style.opacity = '';
                modalContent.style.transition = '';
                // æ¸…ç†æ‰€æœ‰çŠ¶æ€
                successIcon.classList.add('hidden');
                correctAnswer.classList.add('hidden');
                poemErrorIcon.classList.add('hidden');
                if (aiExplainSuccessRow) aiExplainSuccessRow.classList.add('hidden');
                if (aiExplainFailRow) aiExplainFailRow.classList.add('hidden');
                // é‡ç½®ç”¨æˆ·ç­”æ¡ˆé¢œè‰²
                poemDisplay.classList.remove('text-red-600', 'text-secondary', 'font-bold');
                poemDisplay.classList.add('text-surface-800');
            }, 200);
        };

        // Shuffle array (Fisher-Yates algorithm)
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        // è©©è©æ•¸æ“šåº«é¸é …
        // æ”¹ç‚ºä½¿ç”¨ç”¨æˆ¶æ¨™ç±¤ä½œç‚ºè©©è©åº«é¸æ“‡
        let activeDatabase = tangPoetryLines; // ä»ä¿ç•™å…§å»ºæ•¸æ“šä½œç‚ºåŸºç¤ä¾†æº
        function getAllPoemsUnified() {
            // å…§å»ºåº«åŠ æ¨™ç±¤ï¼šå—é¢¨è©©è©åº« / å°å­¸ç”Ÿè©©è©åº«
            const builtinTang = (tangPoetryLines || []).map(p => ({ ...p, tags: Array.isArray(p.tags)? p.tags : ['å—é¢¨è©©è©åº«'] }));
            const builtinElem = (elementaryPoemLines || []).map(p => ({ ...p, tags: Array.isArray(p.tags)? p.tags : ['å°å­¸ç”Ÿè©©è©åº«'] }));
            const imported = loadUserLibrary().poems || [];
            return [...builtinTang, ...builtinElem, ...imported];
        }
        function getAllTags() {
            const set = new Set();
            getAllPoemsUnified().forEach(p => {
                (Array.isArray(p.tags) ? p.tags : []).forEach(t => set.add(String(t)));
            });
            // éæ¿¾æ‰å·²å»¢é™¤çš„ã€Œè‡ªå®šç¾©è©©å¥ã€æ¨™ç±¤
            return Array.from(set)
                .filter(t => t !== 'è‡ªå®šç¾©è©©å¥')
                .sort((a,b)=>a.localeCompare(b));
        }
        function populateUserTagSelect() {
            const sel = document.getElementById('userLibraryTagSelect');
            if (!sel) return;
            const tags = getAllTags();
            sel.innerHTML = '';
            tags.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                sel.appendChild(opt);
            });
        }
        
        // æ ¹æ“šé¸æ“‡çš„æ•¸æ“šåº«é¸æ“‡è©©å¥
        const selectRandomPoem = () => {
            return activeDatabase[Math.floor(Math.random() * activeDatabase.length)];
        };
        
        // è©©è©æ•¸æ“šåº«åˆ‡æ›åŠŸèƒ½å·²ç§»è‡³è¨­ç½®æ¨¡æ…‹å½ˆçª—è™•ç†

        // Generate characters for the game
        const generateGameCharacters = () => {
            // Reset character arrays
            poemCharacters = [];
            shuffledCharacters = [];
            
            // Get all characters from the current poem
            poemCharacters = currentPoem.line.split('');
            
            // Create a set of characters for the game based on difficulty
            const totalCharsTarget = Math.max(charCount, poemCharacters.length);
            const distractorCount = Math.max(0, totalCharsTarget - poemCharacters.length);
            
            // Create a pool of distractor characters (excluding those in the poem)
            const allDistractors = [];
            
            // Add characters from other poems as distractors
            tangPoetryLines.forEach(poem => {
                if (poem.line !== currentPoem.line) {
                    poem.line.split('').forEach(char => {
                        // Only add if not already in the poem
                        if (!poemCharacters.includes(char)) {
                            allDistractors.push(char);
                        }
                    });
                }
            });
            
            // Shuffle and take the needed number of distractors
            const shuffledDistractors = shuffleArray([...new Set(allDistractors)]);
            const selectedDistractors = shuffledDistractors.slice(0, distractorCount);
            
            // Combine poem characters with distractors and shuffle
            shuffledCharacters = shuffleArray([...poemCharacters, ...selectedDistractors]);
        };

        // Populate the characters grid with the game characters
        const populateCharactersGrid = () => {
            charactersGrid.innerHTML = '';
            let idx = 0;
            shuffledCharacters.forEach(char => {
                const charButton = document.createElement('button');
                charButton.textContent = char;
                charButton.className = 'character-btn char-modern rounded-2xl p-3 md:p-4 text-2xl md:text-3xl font-kai font-bold animate-slide-up';
                charButton.dataset.char = char;
                charButton.style.animationDelay = `${20 * idx}ms`;
                idx++;
                
                charButton.addEventListener('click', (ev) => {
                    if (isGameActive) {
                        // é”ä¸Šé™å‰‡ä¸å…è¨±å†é¸ï¼ˆé™¤éæ˜¯å–æ¶ˆé¸ä¸­ï¼‰
                        const targetLen = currentPoem ? currentPoem.line.length : 0;
                        if (!charButton.classList.contains('selected') && selectionStack.length >= targetLen) {
                            soundManager.play('wrong');
                            charButton.classList.add('animate-wrong');
                            setTimeout(() => charButton.classList.remove('animate-wrong'), 500);
                            if (typeof showNotification === 'function') {
                                showNotification('å·²é”æœ¬å¥å­—æ•¸ä¸Šé™');
                            }
                            return;
                        }

                        // æ’­æ”¾æ¼¢å­—é»æ“ŠéŸ³æ•ˆ
                        soundManager.play('charClick');
                        
                        // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
                        charButton.classList.add('animate-click');
                        setTimeout(() => {
                            charButton.classList.remove('animate-click');
                        }, 300);
                        
                        // é»æ“Šæ³¢ç´‹
                        const rect = charButton.getBoundingClientRect();
                        const ripple = document.createElement('span');
                        ripple.className = 'ripple';
                        const offsetX = ev instanceof MouseEvent ? (ev.clientX - rect.left) : rect.width/2;
                        const offsetY = ev instanceof MouseEvent ? (ev.clientY - rect.top) : rect.height/2;
                        ripple.style.left = offsetX + 'px';
                        ripple.style.top = offsetY + 'px';
                        charButton.appendChild(ripple);
                        setTimeout(() => ripple.remove(), 650);
                        
                        // åˆ‡æ›é¸ä¸­ç‹€æ…‹
                        const wasSelected = charButton.classList.toggle('selected');
                        if (wasSelected) {
                            // é¸ä¸­å¾Œç§»é™¤ hover ç¶ è‰²ï¼Œä¿æŒé¸ä¸­è¦–è¦º
                            charButton.classList.remove('hover:bg-secondary', 'hover:text-white');
                            selectionStack.push({ char, btn: charButton });
                        } else {
                            // å–æ¶ˆé¸ä¸­éœ€å¾å †ç–Šç§»é™¤æœ€è¿‘ä¸€æ¬¡å°æ‡‰è©²å­—çš„è¨˜éŒ„
                            for (let i = selectionStack.length - 1; i >= 0; i--) {
                                if (selectionStack[i].btn === charButton) {
                                    selectionStack.splice(i, 1);
                                    break;
                                }
                            }
                            // å–æ¶ˆé¸ä¸­æ¢å¾© hover ç¶ è‰²
                            charButton.classList.add('hover:bg-secondary', 'hover:text-white');
                        }

                        // é‡å»ºé¡¯ç¤ºçš„è©©å¥å­—ä¸²
                        poemDisplay.value = selectionStack.map(x => x.char).join('');

                        // æ›´æ–°å·²é¸å­—ç‹€æ…‹èˆ‡æäº¤æŒ‰éˆ•å¯ç”¨æ€§
                        updateSelectionStatus();
                    }
                });
                
                charactersGrid.appendChild(charButton);
            });
        };

        // Apply difficulty settings (åªæ›´æ–°è¨­å®šé¡¯ç¤ºï¼›ç•¶å‰å›åˆä¸è®Š)
        const applyDifficultySettings = (difficulty) => {
            const settings = difficultySettings[difficulty];
            // æ›´æ–°ä¸‹å›åˆçš„é è¨­æ»‘å¡Šå€¼
            timeLimitSlider.value = settings.timeLimit;
            timeLimitValue.textContent = settings.timeLimit;
            charCountSlider.value = settings.charCount;
            charCountValue.textContent = settings.charCount;
            // ä¸ä¿®æ”¹ç•¶å‰å›åˆ timeLeftï¼›è‹¥ééŠæˆ²ä¸­ï¼Œé‡ç½®é¡¯ç¤º
            if (!isGameActive && !window.GameMode.isTimedScore()) {
                roundTimeLimit = settings.timeLimit;
                timeLeft = roundTimeLimit;
                if (timerElement) timerElement.textContent = timeLeft;
                if (timeBarFill) timeBarFill.style.width = '100%';
            }
        };
        
        // Select a poem based on current game mode
        const selectPoem = () => {
            const tagSel = document.getElementById('userLibraryTagSelect');
            let activeTag = tagSel?.value || loadActiveTag() || 'å—é¢¨è©©è©åº«';
            if (activeTag === 'è‡ªå®šç¾©è©©å¥') activeTag = 'å—é¢¨è©©è©åº«';
            const pool = getAllPoemsUnified().filter(p => Array.isArray(p.tags) && p.tags.includes(activeTag));
            if (pool.length === 0) {
                showNotification('è©²è©©è©åº«ä¸‹æš«ç„¡è©©å¥ï¼Œè«‹æ›´æ›æ¨™ç±¤æˆ–å°å…¥æ›´å¤šè©©å¥', 5000);
                return null;
            }
            saveActiveTag(activeTag);
            return pool[Math.floor(Math.random() * pool.length)];
        };
        
        // Start a new game round
        const startNewRound = () => {
            console.log('[startNewRound] called, GameMode:', { isTimedScore: window.GameMode.isTimedScore(), isAnyBattle: window.GameMode.isAnyBattle(), isSolo: window.GameMode.isSolo() });
            // Reset UI
            selectionStack = [];
            poemDisplay.value = '';
            gameMessage.classList.add('hidden');
            
            // æ¸…é™¤ä¸Šä¸€è¼ªçš„æ‰€æœ‰é¢œè‰²å’Œå›¾æ ‡çŠ¶æ€
            poemDisplay.classList.remove('text-secondary', 'text-red-600', 'font-bold');
            poemDisplay.classList.add('text-surface-800');
            poemErrorIcon.classList.add('hidden');
            successIcon.classList.add('hidden');
            correctAnswer.classList.add('hidden');
            
            // æ’­æ”¾æ–°å›åˆéŸ³æ•ˆ
            soundManager.play('newRound');
            
            // Select a new poem based on game mode
            currentPoem = selectPoem();
            
            // If no poem is available, return
            if (!currentPoem) {
                return;
            }
            
            // Display the poem hint (author and name) without character count
            poemHint.textContent = `ã€Š${currentPoem.poem}ã€‹ - ${currentPoem.author}`;
            
            // Display character count separately
            const targetLen = currentPoem.line.length;
            const charCountDisplay = document.getElementById('charCountDisplay');
            if (charCountDisplay) {
                charCountDisplay.textContent = targetLen;
            }
            
            // æ‡‰ç”¨ä¸‹å›åˆçš„å­—å…ƒæ•¸ï¼ˆä¸å°æ–¼è©©å¥é•·åº¦ï¼‰
            charCount = Math.max(parseInt(charCountSlider.value), currentPoem.line.length);
            // Generate and display characters
            generateGameCharacters();
            populateCharactersGrid();
            
            // åœ¨é ç¨‹é™æ™‚æ¨¡å¼ä¸­ï¼Œä¸ä½¿ç”¨å–®é¡Œå€’æ•¸ï¼Œåªé¡¯ç¤ºå…¨å±€å€’æ•¸
            if (window.GameMode.isTimedScore()) {
                // é™æ™‚æ¨¡å¼ï¼šéš±è—é€²åº¦æ¢å¡«å……ï¼ˆä½†ä¿æŒå®¹å™¨å¯è¦‹ä»¥é¡¯ç¤ºè³½é“ï¼‰ï¼Œåªé¡¯ç¤ºå…¨å±€ç§’æ•¸
                try { if (timeBarFill) { timeBarFill.style.width = '0%'; timeBarFill.style.display = 'none'; } } catch(_){ }
                try { if (timeBarContainer) timeBarContainer.style.display = ''; } catch(_){ }
                try {
                    const remainMs = Math.max(0, (state.timedEndsAt || Date.now()) - Date.now());
                    timerElement.textContent = String(Math.ceil(remainMs / 1000));
                } catch(_){ }
                // ç¢ºä¿ä¸æœƒå•Ÿå‹•å–®é¡Œè¨ˆæ™‚å™¨
            } else {
                // Reset timer based on current slider (ä¸‹ä¸€è¼ªç”Ÿæ•ˆçš„è¨­å®š)
                roundTimeLimit = parseInt(timeLimitSlider.value);
                timeLeft = roundTimeLimit;
                timerElement.textContent = timeLeft;
                if (timeBarFill) {
                    timeBarFill.style.width = '100%';
                    timeBarFill.classList.remove('bg-red-500');
                    timeBarFill.classList.add('bg-primary');
                }
                try { if (timeBarContainer) timeBarContainer.style.display = ''; } catch(_){ }
            }
            
            // ç¡®ä¿æŒ‰é’®åŒºåŸŸæ˜¾ç¤ºå’ŒçŠ¶æ€æ­£ç¡®
            const buttonContainer = clearSelectionButton.parentElement;
            if (buttonContainer) {
                buttonContainer.classList.remove('hidden');
            }
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            updateSelectionStatus();
            
            // Start the game
            isGameActive = true;
            try { window.RaceTrack && window.RaceTrack.ensureEmojis && window.RaceTrack.ensureEmojis(); } catch(_){ }
            try { window.RaceTrack && window.RaceTrack.render && window.RaceTrack.render(); } catch(_){ }
            
            // å–®é¡Œè¨ˆæ™‚ï¼šåƒ…åœ¨éé ç¨‹é™æ™‚æ¨¡å¼ä¸‹å•Ÿç”¨
            clearInterval(timerInterval);
            if (!window.GameMode.isTimedScore()) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                    if (timeBarFill && roundTimeLimit > 0) {
                        const pct = Math.max(0, Math.min(100, (timeLeft / roundTimeLimit) * 100));
                        timeBarFill.style.width = pct + '%';
                        if (timeLeft <= 10 && timeLeft > 0) {
                            timeBarFill.classList.remove('bg-primary');
                            timeBarFill.classList.add('bg-red-500');
                        }
                    }
                    if (timeLeft === 10) {
                        soundManager.play('timeWarning');
                        timerElement.classList.add('timer-warning');
                        setTimeout(() => timerElement.classList.remove('timer-warning'), 12000);
                    }
                    if (timeLeft <= 0) {
                        endRound(false);
                    }
                }, 1000);
            }

            // é™æ™‚æ¨¡å¼ï¼š5ç§’æœªæäº¤é¡¯ç¤ºã€Œè·³éã€æŒ‰éˆ•
            try {
                const buttonContainer = clearSelectionButton.parentElement;
                if (buttonContainer && window.GameMode.isTimedScore()) {
                    let skipBtn = document.getElementById('skipPoem');
                    if (!skipBtn) {
                        skipBtn = document.createElement('button');
                        skipBtn.id = 'skipPoem';
                        skipBtn.className = 'gradient-secondary text-white px-6 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button ml-4 opacity-0 pointer-events-none transition-all';
                        skipBtn.textContent = 'è·³é';
                        buttonContainer.appendChild(skipBtn);
                        skipBtn.addEventListener('click', () => {
                            if (isGameActive) endRound(false, 'skip');
                        });
                    }
                    skipBtn.style.opacity = '0';
                    skipBtn.style.pointerEvents = 'none';
                    setTimeout(() => {
                        if (isGameActive && window.GameMode.isTimedScore()) {
                            skipBtn.style.opacity = '1';
                            skipBtn.style.pointerEvents = 'auto';
                        }
                    }, 5000);
                }
            } catch(_){}
        };

        // End the current round
        const endRound = (success, reason = 'timeout') => {
            // Stop the timer
            clearInterval(timerInterval);
            isGameActive = false;
            
            // ä¸å†éšè—æŒ‰é’®ï¼Œä¿æŒæŒ‰é’®åŒºåŸŸå¯è§
            
            if (success) {
                // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ
                soundManager.play('correct');
                
                // æ˜¾ç¤ºç­”å¯¹åŠ¨ç”»
                poemDisplay.classList.add('animate-correct');
                
                // å°†è¯—å¥æ–‡å­—å˜ä¸ºç»¿è‰²ï¼ˆä¸æäº¤æŒ‰é’®ç›¸åŒçš„é¢œè‰²ï¼‰
                poemDisplay.classList.add('text-secondary');
                poemDisplay.classList.add('font-bold');
                
                setTimeout(() => {
                    poemDisplay.classList.remove('animate-correct');
                }, 1000);
                
                // æ›´æ–°åˆ†æ•¸
                if (window.GameMode.isTimedScore()) {
                    // å›ºå®š +10 åˆ†ï¼›ç­”å°
                    applyScoreDelta(10, true);
                } else if (!window.GameMode.isLocal() || !window.GameState.isActive) {
                    score++;
                }
                
                // æ·»åŠ åˆ†æ•°å˜åŒ–åŠ¨ç”»
                scoreElement.classList.add('animate-score');
                scoreElement.textContent = score;
                setTimeout(() => {
                    scoreElement.classList.remove('animate-score');
                }, 800);
                
                // é™æ™‚æ¨¡å¼ï¼šä¸å½ˆå‡ºæœ¬åœ°çµæœæµ®çª—ï¼Œä½†æä¾›è¼•é‡æç¤º
                if (window.GameMode.isTimedScore()) {
                    try { if (typeof showNotification === 'function') showNotification('ç­”å°ï¼+10 åˆ†'); } catch(_){}
                } else {
                    showResultModal(true, 'æ­å–œï¼ç­”å°äº†ï¼');
                }
            } else {
                // æ’­æ”¾éŒ¯èª¤/æ™‚é–“åˆ°éŸ³æ•ˆ
                soundManager.play('timeUp');
                
                // æ ¹æ®å¤±è´¥åŸå› æ˜¾ç¤ºä¸åŒå†…å®¹
                if (reason === 'timeout') {
                    // æ—¶é—´åˆ°ï¼šæ˜¾ç¤ºçº¢è‰²"æ™‚é–“åˆ°"æ–‡å­—
                    poemDisplay.value = 'æ™‚é–“åˆ°';
                    poemDisplay.classList.remove('text-surface-800');
                    poemDisplay.classList.add('text-red-600', 'font-bold');
                    // ä¸æ˜¾ç¤ºé”™è¯¯å›¾æ ‡ï¼Œå› ä¸ºæ²¡æœ‰ç”¨æˆ·ç­”æ¡ˆ
                    poemErrorIcon.classList.add('hidden');
                } else {
                    // ç”¨æˆ·ç­”é”™ï¼šæ˜¾ç¤ºç­”é”™åŠ¨ç”»
                    poemDisplay.classList.add('animate-wrong');
                    setTimeout(() => {
                        poemDisplay.classList.remove('animate-wrong');
                    }, 500);
                }
                
                // é™æ™‚æ¨¡å¼ï¼šä¸å½ˆå‡ºæœ¬åœ°çµæœæµ®çª—ï¼Œä½†æä¾›è¼•é‡æç¤º
                if (window.GameMode.isTimedScore()) {
                    try { if (typeof showNotification === 'function') showNotification(reason === 'timeout' ? 'æ™‚é–“åˆ°' : 'ç­”éŒ¯äº†'); } catch(_){}
                } else {
                    showResultModal(false, reason === 'timeout' ? 'æ™‚é–“åˆ°ï¼' : 'ç­”éŒ¯äº†ï¼', currentPoem.line);
                }
                // é™æ™‚æ¨¡å¼ä¸‹è¨˜ä¸€æ¬¡ä½œç­”ï¼ˆä¸åŠ åˆ†ï¼‰
                if (window.GameMode.isTimedScore()) {
                    applyScoreDelta(0, false);
                }
            }
            
            // é™æ™‚æ¨¡å¼ï¼šçµæŸå¾Œè‡ªå‹•ä¸‹ä¸€é¡Œï¼›éé™æ™‚ä»èµ°åŸé‚è¼¯
            if (window.GameMode.isTimedScore()) {
                // é¿å…ç›´æ¥å¼•ç”¨å±€éƒ¨ IIFE å…§çš„ state é€ æˆ ReferenceError
                setTimeout(() => {
                    try {
                        if (typeof state !== 'undefined' && state && state.timedMode !== true) return;
                    } catch(_){}
                    startNewRound();
                }, 600);
                return; // é¿å…è½å…¥è¼ªæµæµç¨‹
            } else if (window.GameMode.isLocal() && window.GameState.isActive) {
                if (typeof window.LocalBattle?.endRound === 'function') window.LocalBattle.endRound(success);
            }
        };

        // è®“é ç«¯äº‹ä»¶å¯ç›´æ¥å‘¼å«æ–°å›åˆï¼ˆé¿å… const è²æ˜æœªæ›åˆ° windowï¼‰
        try { window.startNewRound = startNewRound; } catch(_) {}

        // Verify if the current input matches the poem
        const verifyPoem = () => {
            return poemDisplay.value === currentPoem.line;
        };

        function applyScoreDelta(delta, isCorrect){
            try {
                // æœ¬åœ°ï¼šå–®äººå´è¨ˆåˆ†
                scoreElement.classList.add('animate-score');
                setTimeout(() => scoreElement.classList.remove('animate-score'), 800);
                
                // ã€é‡æ§‹ã€‘é ç¨‹é™æ™‚ï¼šåªå»£æ’­ï¼Œä¸åœ¨æœ¬åœ°é å…ˆæ›´æ–°ï¼ˆçµ±ä¸€ç”±æ¥æ”¶å»£æ’­æ™‚æ›´æ–°ï¼‰
                if (window.GameMode.isTimedScore()) {
                    const uid = window.GameState.remote.currentUserId;
                    if (!uid) return;
                    
                    // å»£æ’­åˆ†æ•¸æ›´æ–°ï¼ˆè®“æ‰€æœ‰å®¢æˆ¶ç«¯åŒ…æ‹¬è‡ªå·±çµ±ä¸€è™•ç†ï¼‰
                    window.RemoteBattle.sendGameEvent('score_update', { userId: uid, delta, answeredInc:1, correctInc: isCorrect?1:0 });
                }
            } catch(_){}
        }

        // æ›´æ–°å·²é¸å­—ç‹€æ…‹èˆ‡æäº¤å¯ç”¨æ€§
        const updateSelectionStatus = () => {
            const selected = poemDisplay.value.length;
            const target = currentPoem ? currentPoem.line.length : 0;
            const statusEl = document.getElementById('selectionStatus');
            if (statusEl) {
                statusEl.textContent = `å·²é¸ ${selected} / ${target}`;
                statusEl.classList.remove('text-red-600');
            }
            const submitBtn = document.getElementById('submitPoem');
            if (submitBtn) {
                if (window.GameMode.isTimedScore()) {
                    // é™æ™‚æ¨¡å¼ï¼šå§‹çµ‚å…è¨±æäº¤ï¼ˆæœªæ»¿å­—æ•¸è¦–ç‚ºéŒ¯èª¤è™•ç†ï¼‰
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                } else {
                    // æœ¬åœ°/å–®äººï¼šåƒ…åœ¨å­—æ•¸å®Œå…¨åŒ¹é…æ™‚å…è¨±æäº¤
                    const canSubmit = selected === target && target > 0;
                    submitBtn.disabled = !canSubmit;
                    if (submitBtn.disabled) {
                        submitBtn.classList.add('opacity-60', 'cursor-not-allowed');
                    } else {
                        submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                    }
                }
            }
            // è¶…å‡ºå­—æ•¸æç¤º
            if (selected > target && statusEl) {
                statusEl.classList.add('text-red-600');
            }
        };

        // Event listeners
        clearSelectionButton.addEventListener('click', () => {
            if (isGameActive) {
                soundManager.play('buttonClick');
                // å¾Œé€€ä¸€å­—ï¼šå½ˆå‡ºå †ç–Šæœ€å¾Œä¸€å€‹å­—ï¼Œä¸¦é‚„åŸå…¶æŒ‰éˆ•ç‹€æ…‹
                const last = selectionStack.pop();
                if (last && last.btn) {
                    last.btn.classList.remove('selected');
                    // æ¢å¾© hover ç¶ è‰²
                    last.btn.classList.add('hover:bg-secondary', 'hover:text-white');
                }
                poemDisplay.value = selectionStack.map(x => x.char).join('');
                updateSelectionStatus();
            }
        });

        submitButton.addEventListener('click', () => {
            if (isGameActive) {
                // æ’­æ”¾æŒ‰éˆ•é»æ“ŠéŸ³æ•ˆ
                soundManager.play('buttonClick');
                
                if (window.GameMode.isTimedScore()) {
                    const target = currentPoem ? currentPoem.line.length : 0;
                    if (poemDisplay.value.trim().length < target) {
                        // æœªæ»¿å­—æ•¸ï¼šè¦–ç‚ºéŒ¯èª¤å¿«é€Ÿåé¥‹
                        endRound(false, 'wrong');
                        return;
                    }
                } else {
                    if (poemDisplay.value.trim().length === 0) {
                        showNotification('è«‹å…ˆé¸æ“‡æ¼¢å­—å†æäº¤ï¼');
                        return;
                    }
                }

                const isCorrect = verifyPoem();
                endRound(isCorrect, isCorrect ? 'correct' : 'wrong');
            }
        });

        // Difficulty select event listener
        difficultySelect.addEventListener('change', () => {
            const difficulty = difficultySelect.value;
            applyDifficultySettings(difficulty);
            
            if (isGameActive) {
                showNotification('é›£åº¦å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
            }
        });
        
        // Time limit slider event listenerï¼ˆåªæ›´æ–°é¡¯ç¤ºï¼Œä¸‹å›åˆç”Ÿæ•ˆï¼‰
        timeLimitSlider.addEventListener('input', () => {
            const nextTime = parseInt(timeLimitSlider.value);
            timeLimitValue.textContent = nextTime;
            if (isGameActive) {
                showNotification('æ™‚é–“é™åˆ¶å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
            }
        });
        
        // Character count slider event listener
        charCountSlider.addEventListener('input', () => {
            charCount = parseInt(charCountSlider.value);
            charCountValue.textContent = charCount;
            
            if (isGameActive) {
                showNotification('å¾…é¸å­—æ•¸é‡å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
            }
        });
        
        // è‡ªå®šç¾©è©©å¥åŠŸèƒ½å·²ç§»é™¤
        
        // èˆŠçš„äº‹ä»¶ç›£è½å™¨å·²ç§»è‡³è¨­ç½®æ¨¡æ…‹å½ˆçª—ä¸­è™•ç†
        
        // Save custom poem event listener (å·²åœ¨è¨­ç½®æ¨¡æ…‹å½ˆçª—ä¸­è™•ç†)
        
        // Admin mode toggle (èˆŠåŠŸèƒ½å·²ç§»è‡³è¨­ç½®æ¨¡æ…‹å½ˆçª—)
        const difficultySelector = document.getElementById('difficultySelector');
        let isAdminMode = false;
        
        // èˆŠçš„ Toggle admin mode åŠŸèƒ½å·²ç§»è‡³è¨­ç½®æ¨¡æ…‹å½ˆçª—
        
        // Enhance characters display
        const enhanceCharacterDisplay = () => {
            // Make the characters larger in the grid
            document.querySelectorAll('.character-btn').forEach(btn => {
                btn.classList.remove('p-3', 'text-xl', 'text-2xl');
                btn.classList.add('p-4', 'text-3xl');
            });
        };
        
        // å®‰å…¨æ·»åŠ äº‹ä»¶ç›‘å¬å™¨çš„è¾…åŠ©å‡½æ•°
        const safeAddEventListener = (elementId, event, handler) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(event, handler);
            }
        };

        // å®‰å…¨åœ°æ£€æŸ¥å’Œæ·»åŠ æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        const setupEventListeners = () => {
            // å·²æœ‰æ ¸å¿ƒç›£è½åœ¨ä¸Šæ–¹ç¶å®šï¼Œé€™è£¡é¿å…é‡è¤‡
            if (areCoreListenersBound) return;
            areCoreListenersBound = true;
            return;
            
            // ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
            if (clearSelectionButton) {
                clearSelectionButton.addEventListener('click', () => {
                    if (isGameActive) {
                        poemDisplay.value = '';
                        // Re-enable all character buttons
                        document.querySelectorAll('.character-btn').forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                            btn.classList.add('hover:bg-secondary', 'hover:text-white');
                        });
                    }
                });
            }

            if (submitButton) {
                submitButton.addEventListener('click', () => {
                    if (isGameActive) {
                        if (poemDisplay.value.trim().length === 0) {
                            showNotification('è«‹å…ˆé¸æ“‡æ¼¢å­—å†æäº¤ï¼');
                            return;
                        }
                        
                        const isCorrect = verifyPoem();
                        endRound(isCorrect, isCorrect ? 'correct' : 'wrong');
                    }
                });
            }

            if (difficultySelect) {
                difficultySelect.addEventListener('change', () => {
                    const difficulty = difficultySelect.value;
                    applyDifficultySettings(difficulty);
                    
                    if (isGameActive) {
                        showNotification('é›£åº¦å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
                    }
                });
            }

            if (timeLimitSlider) {
                timeLimitSlider.addEventListener('input', () => {
                    timeLeft = parseInt(timeLimitSlider.value);
                    timeLimitValue.textContent = timeLeft;
                    
                    if (isGameActive) {
                        showNotification('æ™‚é–“é™åˆ¶å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
                    }
                });
            }

            if (charCountSlider) {
                charCountSlider.addEventListener('input', () => {
                    charCount = parseInt(charCountSlider.value);
                    charCountValue.textContent = charCount;
                    
                    if (isGameActive) {
                        showNotification('å¾…é¸å­—æ•¸é‡å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
                    }
                });
            }

            if (gameMode) {
                gameMode.addEventListener('change', () => {
                    currentGameMode = gameMode.value;
                    
                    if (currentGameMode === 'custom') {
                        customPoemSettings.classList.remove('hidden');
                        updateSavedPoemsList();
                    } else {
                        customPoemSettings.classList.add('hidden');
                    }
                    
                    if (isGameActive) {
                        showNotification('æ¨¡å¼å·²è®Šæ›´ï¼Œå°‡åœ¨ä¸‹ä¸€è¼ªç”Ÿæ•ˆ');
                    }
                });
            }

            if (saveCustomPoemButton) {
                saveCustomPoemButton.addEventListener('click', saveCustomPoem);
            }

            // èˆŠçš„ adminModeToggle äº‹ä»¶ç›£è½å™¨å·²ç§»è‡³ setupSettingsEventListeners

            if (closeNotification) {
                closeNotification.addEventListener('click', () => {
                    notification.classList.remove('translate-y-0');
                    notification.classList.add('translate-y-[-150%]');
                });
            }
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        const initGame = () => {
            console.log("åˆå§‹åŒ–éŠæˆ²...");
            
            // é¦–å…ˆå„ªåŒ–iframeå¸ƒå±€
            optimizeForIframe();
            
            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            // setupEventListeners(); // å·²ç§»è‡³setupSettingsEventListeners
            
            // æ‡‰ç”¨åˆå§‹é›£åº¦è¨­ç½®
            if (difficultySelect) {
                applyDifficultySettings(difficultySelect.value);
            }
            
            // è™•ç†éŸ³æ•ˆé–‹é—œæŒ‰éˆ•
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                console.log("ç¶å®šéŸ³æ•ˆé–‹é—œæŒ‰éˆ•äº‹ä»¶");
                
                // ç§»é™¤æ‰€æœ‰å·²æœ‰çš„äº‹ä»¶ç›£è½å™¨
                const newSoundToggle = soundToggle.cloneNode(true);
                soundToggle.parentNode.replaceChild(newSoundToggle, soundToggle);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
                newSoundToggle.addEventListener('click', function() {
                    // æ’­æ”¾æŒ‰éµé»æ“ŠéŸ³æ•ˆï¼ˆåœ¨éœéŸ³å‰ï¼‰
                    soundManager.play('buttonClick');
                    
                    // åˆ‡æ›éœéŸ³ç‹€æ…‹
                    const isMuted = soundManager.toggleMute();
                    
                    window.soundEnabled = !isMuted;
                    // æ›´æ–°ä¿å­˜ç‹€æ…‹ï¼ˆå³æ™‚ä¿å­˜ï¼‰
                    try {
                        const s = loadSettings();
                        s.soundOn = window.soundEnabled;
                        persistSettings(s);
                    } catch {}

                    // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œåœ–ç¤º
                    if (isMuted) {
                        newSoundToggle.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.531V19.94a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.506-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.395C2.806 8.757 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            éŸ³æ•ˆé—œ
                        `;
                    } else {
                        newSoundToggle.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            éŸ³æ•ˆé–‹
                        `;
                    }
                });
            }
            
            // èˆŠçš„ç®¡ç†å“¡æŒ‰éˆ•åŠŸèƒ½å·²ç§»è‡³ setupSettingsEventListeners ä¸­çš„è¨­ç½®æ¨¡æ…‹å½ˆçª—
            
            // å¾æœ¬åœ°å­˜å„²æ¢å¾© UI èˆ‡ç‹€æ…‹
            try { restoreFromLocalStorage(); } catch (e) { console.warn('restoreFromLocalStorage failed', e); }
            // è‹¥é ç¨‹å°æˆ°é…ç½®é¢æ¿å·²é–‹å•Ÿæˆ–æ­£è™•æ–¼é ç¨‹é™æ™‚æ¨¡å¼ï¼Œç¦æ­¢å–®äººæ¨¡å¼è‡ªå‹•é–‹å±€
            const rbm = document.getElementById('remoteBattleModal');
            const remotePanelOpen = !!(rbm && !rbm.classList.contains('hidden'));
            const remoteTimed = (typeof state !== 'undefined' && state.timedMode);
            if (!remotePanelOpen && !remoteTimed) {
                startNewRound();
            }
        };

        // è¨­ç½®æ¨¡æ…‹å½ˆçª—ç›¸é—œå‡½æ•¸
        let gameWasPaused = false;
        let timerWasActive = false;
        
        function openSettingsModal() {
            // æš«åœéŠæˆ²
            gameWasPaused = isGameActive;
            timerWasActive = !!timerInterval;
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            isGameActive = false;
            
            // é¡¯ç¤ºæ¨¡æ…‹å½ˆçª—
            settingsModal.classList.remove('hidden');
            
            // åŒæ­¥ç•¶å‰è¨­ç½®åˆ°æ¨¡æ…‹å½ˆçª—
            syncSettingsToModal();
        }
        
        function closeSettingsModalFunc() {
            settingsModal.classList.add('hidden');
            
            // å¦‚æœéŠæˆ²ä¹‹å‰æ˜¯æ´»èºçš„ï¼Œæ¢å¾©éŠæˆ²ç‹€æ…‹
            if (gameWasPaused && timerWasActive) {
                isGameActive = true;
                // é™æ™‚æ¨¡å¼ï¼šä¸æ¢å¾©å–®é¡Œè¨ˆæ™‚å™¨
                if (!(window.RemoteBattle?.room && typeof state !== 'undefined' && state.timedMode)) {
                    startTimer();
                }
            }
        }
        
        function syncSettingsToModal() {
            // åŒæ­¥éŠæˆ²æ¨¡å¼ï¼ˆåƒ…è™•ç†å–®äºº/å°æˆ°ï¼‰
            const currentMode = (window.GameMode.isLocal() && window.GameState.isActive) ? 'battle' : 'single';
            const modeRadio = document.querySelector(`input[name="gameMode"][value="${currentMode}"]`);
            if (modeRadio) modeRadio.checked = true;

            // æ ¹æ“šæ¨¡å¼é¡¯ç¤º/éš±è—ç›¸é—œè¨­ç½®
            updateModalSections();
        }

        // ===== æœ¬åœ°å°æˆ°æ¨¡æ…‹çª—å£ç›¸é—œå‡½æ•¸ =====
        function openLocalBattleModal() {
            const modal = document.getElementById('localBattleModal');
            if (!modal) return;

            // æš«åœéŠæˆ²
            if (timerInterval) clearInterval(timerInterval);
            isGameActive = false;

            // è¼‰å…¥ä¿å­˜çš„è¨­ç½®
            loadLocalBattleSettings();

            // å¡«å……è©©è©åº«é¸é …
            populateLocalPoemSetSelect();

            // ç”Ÿæˆé¸æ‰‹åç¨±è¼¸å…¥æ¡†
            generateLocalPlayerNameInputs();

            // é¡¯ç¤ºæ¨¡æ…‹çª—å£
            modal.classList.remove('hidden');
        }

        function closeLocalBattleModalFunc() {
            const modal = document.getElementById('localBattleModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function loadLocalBattleSettings() {
            // å¾ localStorage è¼‰å…¥è¨­ç½®
            const saved = localStorage.getItem('shicizuju_local_battle_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    const localPlayerCount = document.getElementById('localPlayerCount');
                    const localQuestionCount = document.getElementById('localQuestionCount');
                    const localSpeedMode = document.getElementById('localSpeedMode');

                    if (localPlayerCount && config.playerCount) {
                        localPlayerCount.value = config.playerCount;
                    }
                    if (localQuestionCount && config.questionCount) {
                        localQuestionCount.value = config.questionCount;
                    }
                    if (localSpeedMode && typeof config.speedMode === 'boolean') {
                        localSpeedMode.checked = config.speedMode;
                    }
                } catch (e) {
                    console.error('è¼‰å…¥æœ¬åœ°å°æˆ°è¨­ç½®å¤±æ•—:', e);
                }
            }
        }

        function saveLocalBattleSettings(config) {
            localStorage.setItem('shicizuju_local_battle_config', JSON.stringify(config));
        }

        function populateLocalPoemSetSelect() {
            const select = document.getElementById('localPoemSetSelect');
            if (!select) return;

            // æ¸…ç©ºç¾æœ‰é¸é …
            select.innerHTML = '';

            // ä½¿ç”¨ç¾æœ‰çš„getAllTagså‡½æ•¸ç²å–æ‰€æœ‰æ¨™ç±¤
            const tags = getAllTags();
            const allPoems = getAllPoemsUnified();

            // æ·»åŠ é¸é …
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                const count = allPoems.filter(p => p.tags && p.tags.includes(tag)).length;
                option.textContent = `${tag} (${count}é¡Œ)`;
                select.appendChild(option);
            });

            // å¦‚æœæœ‰ä¿å­˜çš„è¨­ç½®ï¼Œé¸æ“‡è©²è©©è©åº«
            const saved = localStorage.getItem('shicizuju_local_battle_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    if (config.poemSet) {
                        select.value = config.poemSet;
                    }
                } catch (e) {}
            }
        }

        function generateLocalPlayerNameInputs() {
            const container = document.getElementById('localPlayerNamesContainer');
            const localPlayerCount = document.getElementById('localPlayerCount');
            if (!container || !localPlayerCount) return;

            const count = parseInt(localPlayerCount.value) || 2;
            container.innerHTML = '';

            // å˜—è©¦å¾ä¿å­˜çš„è¨­ç½®ä¸­ç²å–é¸æ‰‹åç¨±
            let savedNames = [];
            const saved = localStorage.getItem('shicizuju_local_battle_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    savedNames = config.playerNames || [];
                } catch (e) {}
            }

            for (let i = 0; i < count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `localPlayer${i + 1}Name`;
                input.value = savedNames[i] || `é¸æ‰‹${i + 1}`;
                input.placeholder = `é¸æ‰‹${i + 1}`;
                input.className = 'glass-card rounded-lg px-3 py-2 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern';
                container.appendChild(input);
            }
        }

        function startLocalBattleGame() {
            // æ”¶é›†é…ç½®
            const localPlayerCount = document.getElementById('localPlayerCount');
            const localQuestionCount = document.getElementById('localQuestionCount');
            const localSpeedMode = document.getElementById('localSpeedMode');
            const localPoemSetSelect = document.getElementById('localPoemSetSelect');

            if (!localPlayerCount || !localQuestionCount || !localPoemSetSelect) {
                alert('é…ç½®å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            const playerCount = parseInt(localPlayerCount.value) || 2;
            const questionCount = parseInt(localQuestionCount.value) || 10;
            const speedMode = localSpeedMode ? localSpeedMode.checked : false;
            const poemSet = localPoemSetSelect.value;

            // æ”¶é›†é¸æ‰‹åç¨±
            const playerNames = [];
            for (let i = 0; i < playerCount; i++) {
                const input = document.getElementById(`localPlayer${i + 1}Name`);
                const name = input ? input.value.trim() : '';
                if (!name) {
                    alert(`è«‹è¼¸å…¥é¸æ‰‹${i + 1}çš„åç¨±`);
                    return;
                }
                playerNames.push(name);
            }

            // é©—è­‰é¸æ‰‹åç¨±ä¸é‡è¤‡
            const uniqueNames = new Set(playerNames);
            if (uniqueNames.size !== playerNames.length) {
                alert('é¸æ‰‹åç¨±ä¸èƒ½é‡è¤‡');
                return;
            }

            // é©—è­‰é¡Œç›®æ•¸
            if (questionCount < 5) {
                alert('é¡Œç›®æ•¸è‡³å°‘ç‚º5é¡Œ');
                return;
            }

            // ä¿å­˜é…ç½®
            const config = {
                playerCount,
                playerNames,
                questionCount,
                speedMode,
                poemSet
            };
            saveLocalBattleSettings(config);

            // é—œé–‰æ¨¡æ…‹çª—å£
            closeLocalBattleModalFunc();

            // å•Ÿå‹•æœ¬åœ°å°æˆ°æ¨¡å¼ï¼ˆä½¿ç”¨ç¾æœ‰çš„å°æˆ°æ¨¡å¼é‚è¼¯ï¼‰
            startLocalBattle(config);
        }

        function startLocalBattle(config) {
            // åˆ‡æ›åˆ°æŒ‡å®šçš„è©©è©åº«
            const tagSelect = document.getElementById('userLibraryTagSelect');
            if (tagSelect && config.poemSet) {
                tagSelect.value = config.poemSet;
                saveActiveTag(config.poemSet);
            }

            // å¾æ»‘å¡Šç²å–å…¨å±€åƒæ•¸
            const timeLimitSlider = document.getElementById('timeLimit');
            const charCountSlider = document.getElementById('charCount');
            const currentTimeLimit = timeLimitSlider ? parseInt(timeLimitSlider.value) : 30;
            const currentCharCount = charCountSlider ? parseInt(charCountSlider.value) : 20;

            // è¨ˆç®—æ¯ä½é¸æ‰‹çš„é¡Œç›®æ•¸
            const roundsPerPlayer = Math.ceil(config.questionCount / config.playerCount);

            // ä¿å­˜è¨­ç½®åˆ° localStorage
            const settings = {
                mode: 'battle',
                battle: {
                    playerCount: config.playerCount,
                    roundsPerPlayer: roundsPerPlayer,
                    playerNames: config.playerNames,
                    speedMode: config.speedMode
                },
                timeLimit: currentTimeLimit,
                charCount: currentCharCount
            };

            persistSettings(settings);

            // ã€é‡æ§‹ã€‘ç›´æ¥åœ¨ GameState ä¸­åˆå§‹åŒ–æœ¬åœ°å°æˆ°
            window.GameState.mode = 'local';
            window.GameState.subMode = 'turn_based';
            window.GameState.isActive = true;
            window.GameState.turnBased.currentTurnIndex = 0;
            window.GameState.turnBased.roundsPerPlayer = roundsPerPlayer;
            window.GameState.turnBased.currentRound = 0;
            window.GameState.turnBased.totalRounds = config.playerCount * roundsPerPlayer;
            
            // ç‚ºæœ¬åœ°å°æˆ°ç©å®¶åˆ†é… emoji
            const localPlayerIds = config.playerNames.map((_, i) => 'L' + i);
            const emojiMap = window.RaceTrack.buildEmojiMap(localPlayerIds, 'LOCAL_BATTLE');
            
            window.GameState.players = config.playerNames.map((name, i) => ({
                uid: localPlayerIds[i],
                name: name,
                emoji: emojiMap[localPlayerIds[i]] || 'ğŸƒ',
                score: 0,
                answered: 0,
                correct: 0,
                lastAnswerTs: 0,
                isReady: false,
                isActive: i === 0
            }));
            
            // é¡¯ç¤ºç©åˆ†æ¿
            if (typeof window.LocalBattle?.updateScoreboard === 'function') {
                window.LocalBattle.updateScoreboard();
            }
            const battleScoreboard = document.getElementById('battleScoreboard');
            if (battleScoreboard) {
                battleScoreboard.classList.remove('hidden');
            }

            // é¡¯ç¤ºè³½é“
            const raceTrack = document.getElementById('raceTrack');
            if (raceTrack && window.RaceTrack) {
                raceTrack.classList.remove('hidden');
                window.RaceTrack.render();
            }

            // æ›´æ–°å·¦ä¸Šè§’é¡¯ç¤ºç‚ºè¼ªæ¬¡
            const scoreLabel = document.getElementById('scoreLabel');
            const scoreElement = document.getElementById('score');
            if (scoreLabel && scoreElement) {
                scoreLabel.textContent = 'è¼ªæ¬¡';
                scoreElement.textContent = `1 / ${window.GameState.turnBased.totalRounds}`;
            }

            // é¡¯ç¤ºç•¶å‰é¸æ‰‹é€šçŸ¥
            const currentPlayer = window.GameState.players[0];
            showNotification(`${currentPlayer.name} çš„å›åˆé–‹å§‹ï¼`);

            // é–‹å§‹ç¬¬ä¸€è¼ª
            startNewRound();
        }
        
        function updateModalSections() {
            const selectedModeEl = document.querySelector('input[name="gameMode"]:checked');
            const selectedMode = selectedModeEl ? selectedModeEl.value : 'single';

            // é¡¯ç¤º/éš±è—å°æˆ°æ¨¡å¼è¨­ç½®ï¼ˆå®‰å…¨åˆ¤æ–·ç¯€é»å­˜åœ¨ï¼‰
            if (battleModeSettings) {
                if (selectedMode === 'battle') {
                    battleModeSettings.classList.remove('hidden');
                    // ç”Ÿæˆé¸æ‰‹åç¨±è¼¸å…¥æ¡†
                    generatePlayerNameInputs();
                } else {
                    battleModeSettings.classList.add('hidden');
                }
            }
        }
        
        function openBattlePreviewModal(settings) {
            if (!battlePreviewModal) return;

            const playerCount = settings.battle?.playerCount || 0;
            const roundsPerPlayer = settings.battle?.roundsPerPlayer || 0;
            const players = settings.battle?.playerNames || [];
            const totalRounds = playerCount * roundsPerPlayer;
            const totalQuestions = totalRounds;

            if (battlePreviewPlayerCount) battlePreviewPlayerCount.textContent = String(playerCount);
            if (battlePreviewRounds) battlePreviewRounds.textContent = String(roundsPerPlayer);
            if (battlePreviewTotalQuestions) battlePreviewTotalQuestions.textContent = String(totalQuestions);

            const tl = typeof settings.timeLimit === 'number' ? settings.timeLimit : roundTimeLimit;
            if (battlePreviewTimeLimit) battlePreviewTimeLimit.textContent = `${tl} ç§’`;

            const cc = typeof settings.charCount === 'number' ? settings.charCount : charCount;
            if (battlePreviewCharCount) battlePreviewCharCount.textContent = `${cc} å­—`;

            if (battlePreviewPlayersList) {
                battlePreviewPlayersList.innerHTML = '';
                players.forEach((name, index) => {
                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-2xl p-3 border border-white/20 flex items-center gap-3 shadow-sm';
                    card.innerHTML = `
                        <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center text-primary-600 font-modern font-bold">${index + 1}</div>
                        <div>
                            <div class="text-base font-modern font-semibold text-surface-800">${name}</div>
                            <div class="text-xs text-surface-500 font-modern">ç¬¬ ${index + 1} ä½ä¸Šå ´</div>
                        </div>
                    `;
                    battlePreviewPlayersList.appendChild(card);
                });
            }

            const isSpeed = !!settings.battle?.speedMode;
            if (battlePreviewSpeedRow) {
                if (isSpeed) {
                    battlePreviewSpeedRow.classList.remove('hidden');
                    if (battlePreviewSpeedText) {
                        battlePreviewSpeedText.textContent = 'é€Ÿåº¦æ¨¡å¼å·²é–‹å•Ÿï¼šè¶Šå¿«å®Œæˆç­”é¡Œï¼Œè¶Šå¯ä»¥ç²å¾—é¡å¤–åŠ åˆ†ï¼ˆæœ€é«˜å¯å†åŠ  50%ï¼‰ã€‚';
                    }
                } else {
                    battlePreviewSpeedRow.classList.add('hidden');
                }
            }

            if (battlePreviewNote) {
                const noteLines = [
                    'å°‡æŒ‰ç…§åå–®é †åºè¼ªæµç­”é¡Œï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„åˆ†æ•¸ã€‚',
                    'è‹¥ç­”éŒ¯æˆ–è¶…æ™‚å°‡ä¸åŠ åˆ†ï¼Œè«‹å°ˆå¿ƒå®Œæˆæ¯é¡Œè©©å¥çµ„åˆã€‚',
                    isSpeed ? 'é€Ÿåº¦åŠ åˆ†æœƒä¾ç…§å‰©é¤˜æ™‚é–“å³æ™‚è¨ˆç®—ã€‚' : 'æ­¤å ´å°æˆ°ä»¥æº–ç¢ºåº¦ç‚ºä¸»ï¼Œä¿æŒç©©å®šç¯€å¥å³å¯ã€‚'
                ];
                battlePreviewNote.innerHTML = noteLines.map(line => `<div class="flex items-start gap-2"><span class="text-primary-500">â€¢</span><span>${line}</span></div>`).join('');
            }

            battlePreviewModal.classList.remove('hidden');
        }

        function closeBattlePreviewModal() {
            if (!battlePreviewModal) return;
            battlePreviewModal.classList.add('hidden');
        }

        function saveSettingsFromModal() {
            const selectedMode = document.querySelector('input[name="gameMode"]:checked')?.value || 'single';
            const selectedDB = 'tag';
            
            // ä¿å­˜éŠæˆ²æ¨¡å¼
            if (selectedMode === 'battle') {
                currentGameMode = 'battle';
            } else {
                currentGameMode = selectedDB === 'custom' ? 'custom' : 'preset';
            }
            
            // ä¿å­˜è©©è©åº«è¨­ç½®
            if (selectedDB === 'default') {
                activeDatabase = tangPoetryLines;
            } else if (selectedDB === 'elementary') {
                activeDatabase = elementaryPoemLines;
            }
            // è©©è©åº«æ”¹ç‚ºæ¨™ç±¤æ¨¡å¼ï¼Œä¿å­˜ç•¶å‰é¸ä¸­çš„æ¨™ç±¤
            const tagSel = document.getElementById('userLibraryTagSelect');
            if (tagSel) saveActiveTag(tagSel.value || '');

            // ä¿å­˜è¨­ç½®åˆ° localStorage
            const settingsToSave = {
                gameMode: selectedMode,
                poemDatabase: selectedDB,
                timeLimit: parseInt(timeLimitSlider?.value || '30'),
                charCount: parseInt(charCountSlider?.value || '20'),
                difficulty: difficultySelect?.value || 'medium',
                soundOn: !!window.soundEnabled,
                battle: {
                    playerCount: parseInt(playerCountSelect?.value || '2'),
                    roundsPerPlayer: Math.max(1, Math.min(50, parseInt(roundsPerPlayerInput?.value || '5'))),
                    speedMode: !!(speedModeCheckbox && speedModeCheckbox.checked),
                    playerNames: Array.from({ length: parseInt(playerCountSelect?.value || '2') }, (_, i) => {
                        const input = document.getElementById(`player${i + 1}Name`);
                        return input ? input.value || `é¸æ‰‹${i + 1}` : `é¸æ‰‹${i + 1}`;
                    })
                }
            };
            persistSettings(settingsToSave);
            
            // å°æˆ°æ¨¡å¼å…ˆé¡¯ç¤ºé è¦½æ¨¡æ…‹ï¼›å–®äººæ¨¡å¼éœ€å®‰å…¨é€€å‡ºå°æˆ°
            if (selectedMode === 'battle') {
                closeSettingsModalFunc();
                openBattlePreviewModal(settingsToSave);
            } else {
                // è‹¥æ­£è™•æ–¼å°æˆ°æ¨¡å¼ï¼Œå®‰å…¨é€€å‡ºä¸¦åˆ‡å›å–®äººæ¨¡å¼
                if (window.GameMode.isLocal() && window.GameState.isActive) {
                    window.GameState.mode = 'solo';
                    window.GameState.subMode = null;
                    window.GameState.isActive = false;
                    window.GameState.players = [];
                    battleScoreboard && battleScoreboard.classList.add('hidden');
                    
                    // éš±è—è³½é“
                    try {
                        const track = document.getElementById('raceTrack');
                        if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                    } catch(_){}
                }
                currentGameMode = 'preset';
                closeSettingsModalFunc();
                showNotification('å·²åˆ‡æ›åˆ°å–®äººæ¨¡å¼');
                // ç«‹å³é–‹å§‹å–®äººæ–°å›åˆ
                startNewRound();
            }
        }
        
        function startTimer() {
            // é™æ™‚æ¨¡å¼ï¼šä¸å•Ÿç”¨å–®é¡Œè¨ˆæ™‚å™¨
            if (window.GameMode.isTimedScore()) return;
            if (timeLeft > 0) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                    if (timeBarFill && roundTimeLimit > 0) {
                        const pct = Math.max(0, Math.min(100, (timeLeft / roundTimeLimit) * 100));
                        timeBarFill.style.width = pct + '%';
                        if (timeLeft <= 10 && timeLeft > 0) {
                            timeBarFill.classList.remove('bg-primary');
                            timeBarFill.classList.add('bg-red-500');
                        }
                    }
                    
                    if (timeLeft === 10) {
                        soundManager.play('timeWarning');
                    }
                    
                    if (timeLeft <= 0) {
                        endRound(false);
                    }
                }, 1000);
            }
        }

        // å°æˆ°æ¨¡å¼ç›¸é—œå‡½æ•¸
        function initializeBattleMode() {
            // ç”Ÿæˆé¸æ‰‹åç¨±è¼¸å…¥æ¡†
            generatePlayerNameInputs();
            
            // ç¶å®šé¸æ‰‹æ•¸é‡è®Šæ›´äº‹ä»¶
            if (playerCountSelect) {
                playerCountSelect.addEventListener('change', generatePlayerNameInputs);
            }
            if (roundsPerPlayerInput) {
                roundsPerPlayerInput.addEventListener('input', () => {
                    const v = Math.max(1, Math.min(50, parseInt(roundsPerPlayerInput.value || '5')));
                    roundsPerPlayerInput.value = String(isNaN(v) ? 5 : v);
                });
            }
            
            // é–‹å§‹å°æˆ°åŠŸèƒ½å·²æ•´åˆåˆ°ä¿å­˜è¨­ç½®ä¸­
        }
        
        function generatePlayerNameInputs() {
            const playerCount = parseInt(playerCountSelect.value);
            playerNamesContainer.innerHTML = '';
            
            for (let i = 0; i < playerCount; i++) {
                const inputDiv = document.createElement('div');
                inputDiv.innerHTML = `
                    <label class="block text-sm font-medium mb-1">é¸æ‰‹ ${i + 1}ï¼š</label>
                    <input type="text" id="player${i + 1}Name" placeholder="è¼¸å…¥é¸æ‰‹åç¨±" 
                           class="w-full p-2 rounded-md border border-gray-300 bg-white text-base" 
                           value="é¸æ‰‹${i + 1}">
                `;
                playerNamesContainer.appendChild(inputDiv);
            }

            // å¾æœ¬åœ°å­˜å„²æ¢å¾©ç©å®¶åç¨±ï¼ˆè‹¥æœ‰ï¼‰
            const saved = loadSettings();
            if (saved && saved.battle && Array.isArray(saved.battle.playerNames)) {
                saved.battle.playerNames.forEach((name, idx) => {
                    const input = document.getElementById(`player${idx + 1}Name`);
                    if (input && name) input.value = name;
                });
            }
        }
        
        function confirmStartBattleMode() {
            // è‹¥é ç¨‹é™æ™‚æ¨¡å¼é€²è¡Œä¸­ï¼Œç¦æ­¢å•Ÿå‹•æœ¬åœ°è¼ªæµï¼Œç›´æ¥è¿”å›
            if (window.GameMode.isTimedScore()) {
                try { showNotification && showNotification('ç›®å‰ç‚ºé ç¨‹é™æ™‚ç«¶è³½ï¼Œå·²ç¦ç”¨æœ¬åœ°è¼ªæµæ¨¡å¼'); } catch(_){ }
                return;
            }
            
            // æ”¶é›†é¸æ‰‹åç¨±å’Œè¨­ç½®
            const playerCount = parseInt(playerCountSelect.value);
            const roundsPerPlayer = Math.max(1, Math.min(50, parseInt(roundsPerPlayerInput.value || '5')));
            const playerNames = [];
            
            for (let i = 0; i < playerCount; i++) {
                const nameInput = document.getElementById(`player${i + 1}Name`);
                const playerName = nameInput ? nameInput.value || `é¸æ‰‹${i + 1}` : `é¸æ‰‹${i + 1}`;
                playerNames.push(playerName);
            }

            // å¯«å›ä¿å­˜ç©å®¶è¨­ç½®
            const s = loadSettings();
            s.battle = s.battle || {}; 
            s.battle.playerCount = playerCount;
            s.battle.roundsPerPlayer = roundsPerPlayer;
            s.battle.speedMode = !!(speedModeCheckbox && speedModeCheckbox.checked);
            s.battle.playerNames = playerNames;
            persistSettings(s);
            
            // ã€é‡æ§‹ã€‘ç›´æ¥åœ¨ GameState ä¸­åˆå§‹åŒ–æœ¬åœ°å°æˆ°
            window.GameState.mode = 'local';
            window.GameState.subMode = 'turn_based';
            window.GameState.isActive = true;
            window.GameState.turnBased.currentTurnIndex = 0;
            window.GameState.turnBased.roundsPerPlayer = roundsPerPlayer;
            window.GameState.turnBased.currentRound = 0;
            window.GameState.turnBased.totalRounds = playerCount * roundsPerPlayer;
            
            // ç‚ºæœ¬åœ°å°æˆ°ç©å®¶åˆ†é… emoji
            const localPlayerIds = playerNames.map((_, i) => 'L' + i);
            const emojiMap = window.RaceTrack.buildEmojiMap(localPlayerIds, 'LOCAL_BATTLE');
            
            window.GameState.players = playerNames.map((name, i) => ({
                uid: localPlayerIds[i],
                name: name,
                emoji: emojiMap[localPlayerIds[i]] || 'ğŸƒ',
                score: 0,
                answered: 0,
                correct: 0,
                lastAnswerTs: 0,
                isReady: false,
                isActive: i === 0
            }));
            
            console.log('[local] battle started. GameState:', {
                mode: window.GameState.mode,
                players: window.GameState.players.map(p => ({ name: p.name, emoji: p.emoji, uid: p.uid }))
            });
            
            // é¡¯ç¤ºç©åˆ†æ¿
            if (typeof window.LocalBattle?.updateScoreboard === 'function') window.LocalBattle.updateScoreboard();
            battleScoreboard.classList.remove('hidden');
            
            // è§¸ç™¼è³½é“æ¸²æŸ“
            try {
                console.log('[local] calling RaceTrack.render...');
                if (!window.RaceTrack) {
                    console.error('[local] RaceTrack not found!');
                } else if (!window.RaceTrack.render) {
                    console.error('[local] RaceTrack.render not found!');
                } else {
                    window.RaceTrack.render();
                    console.log('[local] RaceTrack.render called successfully');
                }
            } catch(e){ console.error('[local] RaceTrack.render error:', e); }
            
            // é–‹å§‹ç¬¬ä¸€è¼ª
            // å¦‚æœéŠæˆ²æš«åœæˆ–å°šæœªå•Ÿå‹•ï¼Œç›´æ¥é–‹å§‹ï¼›è‹¥å·²æœ‰è¨ˆæ™‚ï¼Œé‡ç½®ç‹€æ…‹
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            isGameActive = false;
            if (typeof window.LocalBattle?.startRound === 'function') window.LocalBattle.startRound();
            showNotification('å°æˆ°æ¨¡å¼å·²å•Ÿå‹•ï¼');
        }
        
        // åˆ†æ•¸æ•¸å­—å‹•ç•«ï¼ˆå¾ from åˆ° toï¼Œæ™‚é•·æ¯«ç§’ï¼‰
        function animateScoreValue(element, from, to, duration) {
            const start = performance.now();
            const change = to - from;
            if (change === 0) {
                element.textContent = String(to);
                return;
            }
            const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
            function step(now) {
                const elapsed = now - start;
                const progress = Math.min(1, elapsed / duration);
                const eased = easeOutCubic(progress);
                const current = Math.round(from + change * eased);
                element.textContent = String(current);
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

window.LocalBattle.updateScoreboard = function updateBattleScoreboard() {
            leftPlayersContainer.innerHTML = '';
            rightPlayersContainer.innerHTML = '';
            
            // ã€é‡æ§‹ã€‘çµ±ä¸€å¾ GameState è®€å–ç©å®¶æ•¸æ“š
            console.log('[scoreboard] updating, GameState:', { 
                mode: window.GameState.mode, 
                subMode: window.GameState.subMode, 
                isActive: window.GameState.isActive,
                isAnyBattle: window.GameMode.isAnyBattle(),
                playersCount: window.GameState.players?.length || 0
            });
            
            if (!window.GameMode.isAnyBattle()) {
                console.log('[scoreboard] not in battle mode, skipping');
                return;
            }
            
            const players = window.GameState.players;
            if (!players || players.length === 0) {
                console.log('[scoreboard] no players data');
                return;
            }
            
            console.log('[scoreboard] rendering', players.length, 'players');
            
            const isTimed = window.GameMode.isTimedScore();
            
            // è¨ˆç®—åæ¬¡ï¼ˆåƒ…é™æ™‚æ¨¡å¼é¡¯ç¤ºå¾½ç« ï¼‰
            const rankByUid = {};
            if (isTimed) {
                const ranked = [...players].sort((a,b) => (b.score - a.score) || (a.lastAnswerTs - b.lastAnswerTs));
                ranked.forEach((p, i) => rankByUid[p.uid] = i + 1);
            }

            const leftCount = Math.ceil(players.length / 2);

            players.forEach((player, index) => {
                const isLeftSide = index < leftCount;
                const container = isLeftSide ? leftPlayersContainer : rightPlayersContainer;
                
                const playerCard = document.createElement('div');
                const themeClass = `player-theme-${(index % 6) + 1}`;
                const showActive = window.GameMode.isLocal() && !!player.isActive;
                playerCard.className = `player-score-card ${themeClass} ${showActive ? 'active' : ''} relative`;
                
                const displayScoreValue = player.score || 0;
                const rankBadge = isTimed && rankByUid[player.uid] ? `<div class="absolute -top-2 -left-2 w-7 h-7 rounded-full bg-primary text-white text-sm font-bold flex items-center justify-center shadow">${rankByUid[player.uid]}</div>` : '';
                
                // é¡¯ç¤ºç©å®¶ emoji
                const playerEmoji = player.emoji ? `<span class="text-2xl mr-2">${player.emoji}</span>` : '';
                
                playerCard.innerHTML = `
                    ${rankBadge}
                    <div class="player-name text-lg md:text-xl font-bold flex items-center">${playerEmoji}${player.name}</div>
                    <div class="player-score text-2xl md:text-3xl">${displayScoreValue}</div>
                    ${showActive ? '<div class=\"current-turn-indicator\"></div>' : ''}
                `;
                
                container.appendChild(playerCard);

                // åˆ†æ•¸æ»¾å‹•å‹•ç•«
                const scoreEl = playerCard.querySelector('.player-score');
                if (player._prevScore !== undefined && player._prevScore !== player.score) {
                    scoreEl.classList.add('animate-score');
                    animateScoreValue(scoreEl, player._prevScore, player.score, 700);
                    setTimeout(() => scoreEl.classList.remove('animate-score'), 800);
                }
                player._prevScore = player.score;
            });
        }
        
        window.LocalBattle.startRound = function startBattleRound() {
            // é™æ™‚æ¨¡å¼ä¸‹ä¸ä½¿ç”¨æœ¬åœ°è¼ªæµå›åˆ
            if (window.GameMode.isTimedScore()) return;
            const currentPlayer = window.GameState.players[window.GameState.turnBased.currentTurnIndex];
            showNotification(`${currentPlayer.name} çš„å›åˆé–‹å§‹ï¼`);
            
            // é–‹å§‹æ–°çš„ä¸€è¼ªéŠæˆ²
            startNewRound();

            // å·¦ä¸Šè§’é¡¯ç¤ºå°æˆ°è¼ªæ¬¡ï¼ˆæ›¿ä»£åˆ†æ•¸ï¼‰
            if (scoreLabel && scoreElement) {
                // é™æ™‚æ¨¡å¼ä¸‹ç¶­æŒåˆ†æ•¸æ¨™ç±¤
                if (window.GameMode.isTimedScore()) {
                    scoreLabel.textContent = 'åˆ†æ•¸';
                    scoreElement.textContent = String(score);
                } else {
                    scoreLabel.textContent = 'è¼ªæ¬¡';
                    scoreElement.textContent = `${window.GameState.turnBased.currentRound + 1} / ${window.GameState.turnBased.totalRounds}`;
                }
            }
        }
        
        window.LocalBattle.endRound = function endBattleRound(isCorrect) {
            // é™æ™‚æ¨¡å¼ä¸‹ä¸ä½¿ç”¨æœ¬åœ°è¼ªæµå›åˆçµæŸ
            if (window.GameMode.isTimedScore()) return;
            
            // ã€é‡æ§‹ã€‘ç›´æ¥å¾ GameState è®€å–å’Œæ›´æ–°
            const currentIndex = window.GameState.turnBased.currentTurnIndex;
            const currentPlayer = window.GameState.players[currentIndex];
            if (!currentPlayer) return;
            
            if (isCorrect) {
                // åŸºç¤åˆ†
                let gained = 10;
                // é€Ÿåº¦æ¨¡å¼åŠ æˆ
                if (speedModeCheckbox && speedModeCheckbox.checked && roundTimeLimit > 0) {
                    const ratio = Math.max(0, Math.min(1, timeLeft / roundTimeLimit));
                    const bonus = Math.floor(gained * 0.5 * ratio);
                    gained += bonus;
                    showNotification(`${currentPlayer.name} ç­”å°ï¼é€Ÿåº¦åŠ æˆ +${bonus} åˆ†`);
                } else {
                    showNotification(`${currentPlayer.name} ç­”å°äº†ï¼ç²å¾—${gained}åˆ†`);
                }
                currentPlayer.score += gained;
                currentPlayer.correct += 1;
            } else {
                showNotification(`${currentPlayer.name} ç­”éŒ¯äº†`);
            }
            currentPlayer.answered += 1;
            currentPlayer.lastAnswerTs = Date.now();
            
            // è§¸ç™¼ UI æ›´æ–°
            try {
                window.LocalBattle?.updateScoreboard();
                window.RaceTrack?.render();
            } catch(e){ console.error('[local] UI update error:', e); }
            
            // æª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰å›åˆ
            window.GameState.turnBased.currentRound++;
            // æ›´æ–°å·¦ä¸Šè§’è¼ªæ¬¡é¡¯ç¤º
            if (scoreLabel && scoreElement) {
                scoreLabel.textContent = 'è¼ªæ¬¡';
                scoreElement.textContent = `${Math.min(window.GameState.turnBased.currentRound + 1, window.GameState.turnBased.totalRounds)} / ${window.GameState.turnBased.totalRounds}`;
            }
            if (window.GameState.turnBased.currentRound >= window.GameState.turnBased.totalRounds) {
                if (typeof window.LocalBattle?.endMode === 'function') window.LocalBattle.endMode();
                return;
            }
            
            // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹é¸æ‰‹
            const prevIndex = window.GameState.turnBased.currentTurnIndex;
            window.GameState.players[prevIndex].isActive = false;
            window.GameState.turnBased.currentTurnIndex = (window.GameState.turnBased.currentTurnIndex + 1) % window.GameState.players.length;
            window.GameState.players[window.GameState.turnBased.currentTurnIndex].isActive = true;
            
            // å…ˆåˆ‡æ› activeï¼Œå†æ›´æ–°ç©åˆ†æ¿ï¼Œè®“å‘¼å¸å‹•ç•«è·Ÿéš¨ç›®å‰ç­”é¡Œè€…
            if (typeof window.LocalBattle?.updateScoreboard === 'function') window.LocalBattle.updateScoreboard();
            
            // é–‹å§‹ä¸‹ä¸€è¼ª - ç§»é™¤è‡ªåŠ¨å»¶è¿Ÿï¼Œæ”¹ä¸ºæ‰‹åŠ¨æ§åˆ¶
            // startBattleRound() å°†ç”±æµ®çª—çš„"ä¸‹ä¸€è¼ª"æŒ‰é’®è°ƒç”¨
        }
        
window.LocalBattle.endMode = function endBattleMode() {
            // é™æ™‚æ¨¡å¼ä¸‹ä¸èµ°æœ¬åœ°è¼ªæµçµç®—
            if (window.RemoteBattle?.room && typeof state !== 'undefined' && state.timedMode) return;
            window.GameState.isActive = false;
            
            // éš±è—ç©åˆ†æ¿
            battleScoreboard.classList.add('hidden');
            
            // éš±è—è³½é“ï¼Œæ¢å¾©å€’è¨ˆæ™‚é€²åº¦æ¢
            try { 
                const track = document.getElementById('raceTrack'); 
                if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                const timeBarFill = document.getElementById('timeBarFill');
                if (timeBarFill) { timeBarFill.style.display = ''; timeBarFill.style.width = '100%'; }
            } catch(_){}
            
            // é¡¯ç¤ºå°æˆ°çµæœç¸½çµçª—å£ï¼ˆåœ¨æ¸…ç©ºç©å®¶æ•¸æ“šä¹‹å‰èª¿ç”¨ï¼‰
            showBattleResultModal();

            // æ¸…ç† GameStateï¼ˆåœ¨é¡¯ç¤ºçµæœçª—å£ä¹‹å¾Œï¼‰
            try { 
                window.GameState.mode = 'solo'; 
                window.GameState.subMode = null; 
                window.GameState.isActive = false; 
                window.GameState.players = [];
            } catch(_){}

            // æ¢å¾©å–®äººæ¨¡å¼å·¦ä¸Šè§’é¡¯ç¤ºç‚ºåˆ†æ•¸
            if (scoreLabel && scoreElement) {
                scoreLabel.textContent = 'åˆ†æ•¸';
                scoreElement.textContent = String(score);
            }
        }
        
        function showBattleResultModal() {
            // ã€é‡æ§‹ã€‘1) é ç¨‹é™æ™‚æ¨¡å¼çµæœï¼šç›´æ¥å¾ GameState è®€å–
            if (window.RemoteBattle?.room && window.GameMode.isTimedScore()) {
                const timedEnded = !window.GameState.isActive;
                if (timedEnded) {
                    try {
                        const rows = window.GameState.players.map(p => ({
                            name: p.name,
                            score: p.score || 0,
                            _last: p.lastAnswerTs || 0
                        })).sort((a,b) => (b.score - a.score) || (a._last - b._last));

                        // æ¨™é¡Œ
                        winnerAnnouncement.textContent = 'ç«¶è³½çµæŸ';
                        if (rows.length && rows[0].score > 0) {
                            winnerScore.textContent = `æœ€é«˜åˆ†ï¼š${rows[0].name} ${rows[0].score} åˆ†`;
                        } else {
                            winnerScore.textContent = '';
                        }

                        // æ’è¡Œå…§å®¹
                        battleRankings.innerHTML = '';
                        rows.forEach((r, i) => {
                            const rank = i + 1;
                            const rankItem = document.createElement('div');
                            rankItem.className = 'rank-item';
                            rankItem.style.animationDelay = `${i * 0.06}s`;
                            const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
                            const rankText = rank <= 3 ? medals[rank-1] : `#${rank}`;
                            rankItem.innerHTML = `
                                <div class="rank-medal w-12 text-center">${rankText}</div>
                                <div class="rank-name flex-grow text-lg">${r.name}</div>
                                <div class="rank-score text-xl">${r.score} <span class="text-sm">åˆ†</span></div>
                            `;
                            battleRankings.appendChild(rankItem);
                        });

                        // æŒ‰éˆ•ï¼šåƒ…é¡¯ç¤ºé—œé–‰ï¼Œé»æ“Šå¾Œè¿”å›å–®äººæ¨¡å¼ä¸¦è‡ªå‹•é–‹å±€
                        try {
                            const newBattleBtn = document.getElementById('newBattleBtn');
                            const exitBattleBtn = document.getElementById('exitBattleBtn');
                            if (newBattleBtn) newBattleBtn.classList.add('hidden');
                            if (exitBattleBtn) {
                                exitBattleBtn.textContent = 'é—œé–‰';
                                exitBattleBtn.classList.remove('hidden');
                                exitBattleBtn.onclick = () => {
                                    battleResultModal.classList.add('hidden');
                                    // ã€é‡æ§‹ã€‘æ¸…ç† GameState
                                    try { 
                                        window.GameState.mode = 'solo'; 
                                        window.GameState.subMode = null; 
                                        window.GameState.isActive = false; 
                                        window.GameState.players = [];
                                    } catch(_){}
                                    // éš±è—å·¦/å³å´è¨˜åˆ†å¡
                                    try { const board = document.getElementById('battleScoreboard'); board && board.classList.add('hidden'); } catch(_){ }
                                    // éš±è—è³½é“ï¼Œæ¢å¾©å€’è¨ˆæ™‚é€²åº¦æ¢
                                    try { 
                                        const track = document.getElementById('raceTrack'); 
                                        if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                                        const timeBarFill = document.getElementById('timeBarFill');
                                        if (timeBarFill) { timeBarFill.style.display = ''; timeBarFill.style.width = '100%'; }
                                    } catch(_){}
                                    // è‡ªå‹•é–‹å§‹å–®äººä¸€å±€
                                    if (typeof window.startNewRound === 'function') window.startNewRound();
                                };
                            }
                        } catch(_){}

                        battleResultModal.classList.remove('hidden');
                        return;
                    } catch(_) { /* fallback åˆ°èˆŠç‰ˆ */ }
                }
            }

            // 2) èˆŠæ¨¡å¼ï¼ˆæœ¬åœ°è¼ªæµï¼‰ï¼šå¾ GameState è®€å–
            const sortedPlayers = [...window.GameState.players].sort((a, b) => b.score - a.score);
            
            // 2. æ‰¾å‡ºæœ€é«˜åˆ†
            const highScore = sortedPlayers.length > 0 ? sortedPlayers[0].score : 0;
            
            // 3. æ‰¾å‡ºæ‰€æœ‰è·å¾—æœ€é«˜åˆ†çš„ç©å®¶
            const winners = sortedPlayers.filter(player => player.score === highScore);

            // 4. è®¾ç½®è·èƒœè€…ä¿¡æ¯
            if (winners.length > 1) {
                // å¹³å±€æˆ–å¤šäººå¹¶åˆ—ç¬¬ä¸€
                const winnerNames = winners.map(p => p.name).join(', ');
                winnerAnnouncement.textContent = `ğŸ† å¹³å±€ï¼`;
                winnerScore.textContent = `${winnerNames} å¹¶åˆ—ç¬¬ä¸€!`;
            } else if (winners.length === 1) {
                // å•ç‹¬è·èƒœè€…
                const winner = winners[0];
                winnerAnnouncement.textContent = `ğŸ‰ æ­å–œ ${winner.name} è·èƒœï¼`;
                winnerScore.textContent = `æœ€ç»ˆå¾—åˆ†: ${winner.score}`;
            } else {
                // æ²¡æœ‰ç©å®¶çš„æƒ…å†µ
                winnerAnnouncement.textContent = 'æ¯”èµ›ç»“æŸ';
                winnerScore.textContent = 'æ²¡æœ‰ç©å®¶å‚ä¸';
            }
            
            // 5. ç”Ÿæˆæ’è¡Œæ¦œ (å¤„ç†å¹¶åˆ—æ’å)
            battleRankings.innerHTML = '';
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            let rank = 1;
            for (let i = 0; i < sortedPlayers.length; i++) {
                const player = sortedPlayers[i];

                // å¦‚æœå½“å‰ç©å®¶åˆ†æ•°ä½äºå‰ä¸€ä¸ªç©å®¶ï¼Œæ›´æ–°æ’å
                if (i > 0 && player.score < sortedPlayers[i-1].score) {
                    rank = i + 1;
                }

                const rankItem = document.createElement('div');
                rankItem.className = 'rank-item';
                rankItem.style.animationDelay = `${i * 0.1}s`;

                const rankText = rank <= 3 ? medals[rank - 1] : `#${rank}`;
                
                rankItem.innerHTML = `
                    <div class="rank-medal w-12 text-center">${rankText}</div>
                    <div class="rank-name flex-grow text-lg">${player.name}</div>
                    <div class="rank-score text-xl">${player.score} <span class="text-sm">åˆ†</span></div>
                `;
                
                battleRankings.appendChild(rankItem);
            }
            
            // 6. é¡¯ç¤ºç¸½çµçª—å£
            battleResultModal.classList.remove('hidden');
        }
        
        function startNewBattle() {
            // ã€é‡æ§‹ã€‘é‡ç½® GameStateï¼ˆä¸»æ•¸æ“šæºï¼‰
            window.GameState.mode = 'local';
            window.GameState.subMode = 'turn_based';
            window.GameState.isActive = true;
            window.GameState.turnBased.currentTurnIndex = 0;
            window.GameState.turnBased.currentRound = 0;
            
            // é‡ç½®ç©å®¶æ•¸æ“šï¼ˆä¿æŒ emoji å’Œ åç¨±ï¼‰
            window.GameState.players.forEach(player => {
                player.score = 0;
                player.answered = 0;
                player.correct = 0;
                player.lastAnswerTs = 0;
                player.isActive = false;
            });
            if (window.GameState.players.length > 0) {
                window.GameState.players[0].isActive = true;
            }
            
            // é—œé–‰ç¸½çµçª—å£
            battleResultModal.classList.add('hidden');
            
            // é‡æ–°é–‹å§‹å°æˆ°
            updateBattleScoreboard();
            battleScoreboard.classList.remove('hidden');
            if (typeof window.LocalBattle?.startRound === 'function') window.LocalBattle.startRound();
            
            showNotification('æ–°çš„å°æˆ°é–‹å§‹ï¼');
        }
        
        function exitBattleMode() {
            // é—œé–‰ç¸½çµçª—å£
            battleResultModal.classList.add('hidden');
            
            // ã€é‡æ§‹ã€‘æ¸…ç† GameState
            window.GameState.mode = 'solo';
            window.GameState.subMode = null;
            window.GameState.isActive = false;
            window.GameState.players = [];
            currentGameMode = 'preset';
            
            // éš±è—è³½é“å’Œç©åˆ†æ¿
            try {
                const track = document.getElementById('raceTrack');
                if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                const scoreboard = document.getElementById('battleScoreboard');
                if (scoreboard) scoreboard.classList.add('hidden');
            } catch(_){}
            
            // é–‹å§‹å–®äººæ¨¡å¼
            showNotification('å·²åˆ‡æ›åˆ°å–®äººæ¨¡å¼');
            startNewRound();
        }

        // è¨­ç½®æ¨¡æ…‹å½ˆçª—äº‹ä»¶ç›£è½å™¨
        function setupSettingsEventListeners() {
            // è¨­ç½®æŒ‰éˆ•é»æ“Šäº‹ä»¶
            if (adminModeToggle) {
                adminModeToggle.addEventListener('click', openSettingsModal);
            }
            
            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            if (closeSettingsModal) {
                closeSettingsModal.addEventListener('click', closeSettingsModalFunc);
            }
            
            if (cancelSettings) {
                cancelSettings.addEventListener('click', closeSettingsModalFunc);
            }
            
            // ä¿å­˜è¨­ç½®æŒ‰éˆ•äº‹ä»¶
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => {
                    saveSettingsFromModal();
                    // ç«‹å³åˆ·æ–° UI ä»¥åæ˜ å¯èƒ½çš„é¡¯ç¤ºæ”¹è®Š
                    updateModalSections();
                });
            }

            // è©©è©åº«å°å‡º/å°å…¥
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const importExcelBtn = document.getElementById('importExcelBtn');
            const importExcelInput = document.getElementById('importExcelInput');
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportAsExcel);
            if (importExcelBtn && importExcelInput) {
                importExcelBtn.addEventListener('click', () => importExcelInput.click());
                importExcelInput.addEventListener('change', (e) => {
                    const file = e.target.files?.[0];
                    if (file) importFromExcelFile(file);
                    importExcelInput.value = '';
                });
            }
            
            // è©©è©åº«æ¨™ç±¤è®Šæ›´äº‹ä»¶
            const tagSel = document.getElementById('userLibraryTagSelect');
            if (tagSel) {
                tagSel.addEventListener('change', () => saveActiveTag(tagSel.value || ''));
            }
            
            // è©©è©åº«è®Šæ›´äº‹ä»¶ï¼ˆè‹¥è©©è©åº«é¸é …ä¸å­˜åœ¨å‰‡è·³éï¼‰
            const poemDBRadios = document.querySelectorAll('input[name="poemDatabase"]');
            if (poemDBRadios && poemDBRadios.length) {
                poemDBRadios.forEach(radio => radio.addEventListener('change', updateModalSections));
            }
            
            // éŠæˆ²æ¨¡å¼è®Šæ›´äº‹ä»¶ï¼ˆå–®äºº/å°æˆ°ï¼‰
            document.querySelectorAll('input[name="gameMode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateModalSections();
                });
            });
            
            // æ»‘å‹•æ¢äº‹ä»¶
            if (timeLimitSlider) {
                timeLimitSlider.addEventListener('input', () => {
                    timeLimitValue.textContent = timeLimitSlider.value;
                });
            }
            
            if (charCountSlider) {
                charCountSlider.addEventListener('input', () => {
                    charCountValue.textContent = charCountSlider.value;
                });
            }
            
            // è‡ªå®šç¾©è©©å¥ä¿å­˜äº‹ä»¶
            if (saveCustomPoemButton) {
                saveCustomPoemButton.addEventListener('click', saveCustomPoem);
            }
            
            // å°æˆ°æ¨¡å¼é¸æ‰‹æ•¸é‡è®Šæ›´äº‹ä»¶
            if (playerCountSelect) {
                playerCountSelect.addEventListener('change', generatePlayerNameInputs);
            }
            
            // å°æˆ°çµæŸç¸½çµçª—å£äº‹ä»¶
            if (newBattleBtn) {
                newBattleBtn.addEventListener('click', startNewBattle);
            }
            
            if (exitBattleBtn) {
                exitBattleBtn.addEventListener('click', exitBattleMode);
            }

            if (battlePreviewClose) {
                battlePreviewClose.addEventListener('click', closeBattlePreviewModal);
            }

            if (battlePreviewBack) {
                battlePreviewBack.addEventListener('click', () => {
                    closeBattlePreviewModal();
                    openSettingsModal();
                });
            }

            if (battlePreviewStart) {
                battlePreviewStart.addEventListener('click', () => {
                    closeBattlePreviewModal();
                    confirmStartBattleMode();
                });
            }

            // ===== æœ¬åœ°å°æˆ°æ¨¡æ…‹çª—å£äº‹ä»¶ =====
            const localBattleBtn = document.getElementById('localBattleBtn');
            const localBattleModal = document.getElementById('localBattleModal');
            const closeLocalBattleModal = document.getElementById('closeLocalBattleModal');
            const cancelLocalBattle = document.getElementById('cancelLocalBattle');
            const startLocalBattle = document.getElementById('startLocalBattle');
            const localPlayerCount = document.getElementById('localPlayerCount');

            // æ‰“é–‹æœ¬åœ°å°æˆ°æ¨¡æ…‹çª—å£
            if (localBattleBtn) {
                localBattleBtn.addEventListener('click', () => {
                    openLocalBattleModal();
                });
            }

            // é—œé–‰æœ¬åœ°å°æˆ°æ¨¡æ…‹çª—å£
            if (closeLocalBattleModal) {
                closeLocalBattleModal.addEventListener('click', closeLocalBattleModalFunc);
            }
            if (cancelLocalBattle) {
                cancelLocalBattle.addEventListener('click', closeLocalBattleModalFunc);
            }

            // é¸æ‰‹æ•¸é‡è®Šæ›´
            if (localPlayerCount) {
                localPlayerCount.addEventListener('change', generateLocalPlayerNameInputs);
            }

            // é–‹å§‹æœ¬åœ°å°æˆ°
            if (startLocalBattle) {
                startLocalBattle.addEventListener('click', startLocalBattleGame);
            }
        }

        // ===== åˆå§‹åŒ–ï¼šå¾æœ¬åœ°å­˜å„²æ¢å¾©è¨­ç½®èˆ‡è‡ªå®šç¾©è©©å¥ =====
        function restoreFromLocalStorage() {
            const sRaw = loadSettings();
            const s = sRaw && typeof sRaw === 'object' ? sRaw : {};
            // è©©è©åº«æ¨™ç±¤ä¸‹æ‹‰
            populateUserTagSelect();
            const tagSel = document.getElementById('userLibraryTagSelect');
            let active = loadActiveTag();
            if (active === 'è‡ªå®šç¾©è©©å¥') active = 'å—é¢¨è©©è©åº«';
            if (tagSel) {
                if (active) {
                    const exists = Array.from(tagSel.options).some(o => o.value === active);
                    tagSel.value = exists ? active : (tagSel.options[0]?.value || '');
                }
                saveActiveTag(tagSel.value || '');
            }
            // æ™‚é–“é™åˆ¶
            if (typeof s.timeLimit === 'number' && timeLimit && timeLimitValue) {
                timeLimit.value = String(s.timeLimit);
                timeLimitValue.textContent = String(s.timeLimit);
                roundTimeLimit = s.timeLimit;
            }
            // å¾…é¸å­—æ•¸é‡
            if (typeof s.charCount === 'number' && charCount && charCountValue) {
                charCount.value = String(s.charCount);
                charCountValue.textContent = String(s.charCount);
                charactersPerRound = s.charCount;
            }
            // é›£åº¦
            if (difficultySelect && s.difficulty) {
                difficultySelect.value = s.difficulty;
            }
            // è²éŸ³
            if (soundToggle) {
                window.soundEnabled = !!s.soundOn;
                const svg = soundToggle.querySelector('svg');
                if (svg) svg.style.opacity = window.soundEnabled ? '1' : '0.5';
            }
            // å°æˆ°è¨­ç½®
            if (s.battle) {
                if (playerCountSelect) playerCountSelect.value = String(s.battle.playerCount || 2);
                if (roundsPerPlayerInput) roundsPerPlayerInput.value = String(Math.max(1, Math.min(50, s.battle.roundsPerPlayer || 5)));
                if (speedModeCheckbox) speedModeCheckbox.checked = !!s.battle.speedMode;
                generatePlayerNameInputs();
                if (Array.isArray(s.battle.playerNames)) {
                    s.battle.playerNames.forEach((name, i) => {
                        const input = document.getElementById(`player${i + 1}Name`);
                        if (input) input.value = name || `é¸æ‰‹${i + 1}`;
                    });
                }
            }
            // è‡ªå®šç¾©è©©å¥åŠŸèƒ½å·²ç§»é™¤
            updateModalSections();
        }

        // ç¢ºä¿DOMå®Œå…¨åŠ è¼‰å¾Œåˆå§‹åŒ–éŠæˆ²
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initGame();
                setupSettingsEventListeners();
            });
        } else {
            initGame();
            setupSettingsEventListeners();
        }
    </script>
    
    <!-- é ç¨‹å°æˆ°æ¨¡æ…‹çª—å£ -->
    <div id="remoteBattleModal" class="fixed inset-0 z-[60] hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
        <div class="glass-modal rounded-3xl shadow-2xl w-[min(680px,92vw)] max-h-[90vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
            <!-- å½ˆçª—æ¨™é¡Œ -->
            <div class="flex justify-between items-center px-5 py-4 border-b border-white/20 bg-gradient-to-r from-primary-500 to-accent-500 rounded-t-3xl flex-shrink-0">
                <h2 class="text-xl font-modern font-bold text-white">ğŸŒ é ç¨‹å°æˆ°</h2>
                <button id="rbClose" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
            </div>

            <!-- å…§å®¹å€åŸŸ -->
            <div class="overflow-y-auto custom-scrollbar flex-grow p-4">
                <!-- åˆå§‹ç‹€æ…‹ï¼šå»ºç«‹æˆ–åŠ å…¥æˆ¿é–“ -->
                <div id="rbInitialView" class="grid md:grid-cols-2 gap-4">
                    <!-- å·¦å´ï¼šå»ºç«‹æˆ¿é–“ -->
                    <div class="space-y-3">
                        <input id="rbNickname" type="text" class="glass-card rounded-lg px-3 border border-white/30 focus:ring-2 focus:ring-primary-500 text-sm font-modern w-full h-12" placeholder="ğŸ‘¤ è¼¸å…¥ä½ çš„æš±ç¨±">
                        <button id="rbCreateBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-secondary-500 to-secondary-600 text-white font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">å»ºç«‹æˆ¿é–“</button>
                    </div>

                    <!-- å³å´ï¼šåŠ å…¥æˆ¿é–“ -->
                    <div class="space-y-3">
                        <input 
                            id="rbJoinCode" 
                            type="tel" 
                            inputmode="numeric" 
                            pattern="[0-9]{6}" 
                            class="glass-card rounded-lg px-3 border border-white/30 focus:ring-2 focus:ring-primary-500 text-center text-xl font-mono font-bold w-full h-12" 
                            style="letter-spacing: 0.35em;"
                            placeholder="123456" 
                            maxlength="6"
                        >
                        <button id="rbJoinBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-primary-500 to-accent-500 text-white font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">åŠ å…¥æˆ¿é–“</button>
                    </div>
                </div>

                <!-- æˆ¿ä¸»ç®¡ç†è¦–åœ– -->
                <div id="rbHostView" class="hidden space-y-3">
                    <!-- æˆ¿é–“ä»£ç¢¼ -->
                    <div class="glass-card rounded-xl p-3 border border-white/10">
                        <div class="text-xs font-modern text-surface-600 mb-2">æˆ¿é–“ä»£ç¢¼</div>
                        <div class="bg-gradient-to-br from-secondary-50 to-secondary-100 rounded-lg p-3 border border-secondary-300 text-center">
                            <span id="rbRoomCodeDisplay" class="font-mono font-bold text-3xl text-secondary-700" style="letter-spacing: 0.35em;"></span>
                        </div>
                    </div>

                    <!-- åœ¨ç·šç©å®¶ -->
                    <div class="glass-card rounded-xl p-3 border border-white/10">
                        <div class="text-xs font-modern text-surface-700 mb-2">åœ¨ç·šç©å®¶</div>
                        <div id="rbPresenceList" class="flex flex-wrap gap-2 min-h-[60px]"></div>
                    </div>

                    <!-- éŠæˆ²è¨­å®š -->
                    <div id="rbHostSettings" class="glass-card rounded-xl p-3 border border-white/10">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-xs font-modern text-surface-700 mb-1 block">é™æ™‚ï¼ˆåˆ†é˜ï¼‰</label>
                                <input id="rbTimedMinutes" type="number" min="1" max="10" value="3" class="glass-card rounded-lg px-2 py-1.5 border border-white/30 focus:ring-2 focus:ring-primary-500 text-sm font-modern w-full">
                            </div>
                            <div>
                                <label class="text-xs font-modern text-surface-700 mb-1 block">è©©è©åº«</label>
                                <select id="rbPoemTag" class="glass-card rounded-lg px-2 py-1.5 border border-white/30 focus:ring-2 focus:ring-primary-500 text-sm font-modern w-full"></select>
                            </div>
                        </div>
                        <button id="rbStartTimedBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-primary-500 to-accent-500 text-white font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">é–‹å§‹é™æ™‚ç«¶è³½</button>
                    </div>
                </div>

                <!-- éæˆ¿ä¸»ç©å®¶ç­‰å¾…è¦–åœ– -->
                <div id="rbPlayerWaitingView" class="hidden">
                    <div class="glass-card rounded-2xl p-6 border border-white/10 text-center">
                        <div class="text-6xl mb-4">â³</div>
                        <h3 class="text-xl font-modern font-bold text-surface-800 mb-2">å·²åŠ å…¥æˆ¿é–“</h3>
                        <p class="text-sm font-modern text-surface-600 mb-6">ç­‰å¾…æˆ¿ä¸»é–‹å§‹éŠæˆ²...</p>
                        
                        <!-- åœ¨ç·šç©å®¶ -->
                        <div class="glass-card rounded-xl p-4 border border-white/10 bg-white/30">
                            <div class="text-sm font-modern font-semibold text-surface-700 mb-3">ğŸ‘¥ åœ¨ç·šç©å®¶</div>
                            <div id="rbPresenceListWaiting" class="flex flex-wrap gap-2 min-h-[80px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- èªªæ˜å€åŸŸ -->
            <div class="border-t border-white/20 px-4 py-3 glass-card rounded-b-3xl flex-shrink-0">
                <p class="text-xs font-modern text-surface-700 leading-relaxed">
                    ğŸ’¡ æˆ¿ä¸»å»ºç«‹æˆ¿é–“å¾Œè¨­ç½®ç«¶è³½æ™‚é•·ä¸¦é–‹å§‹æ¯”è³½ï¼›æ‰€æœ‰ç©å®¶åœ¨å„è‡ªè£ç½®åŒæ­¥ä½œç­”ï¼Œåˆ†æ•¸å³æ™‚æ›´æ–°ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- é™æ™‚ç«¶è³½é–‹è³½å‰ 3 ç§’é å‚™å€’è¨ˆæ™‚ç–Šå±¤ -->
    <div id="rbPrepOverlay" class="fixed inset-0 z-[70] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative z-[71] bg-white rounded-2xl border border-slate-200 shadow-2xl px-10 py-8 text-center">
            <div class="text-slate-500 text-sm mb-2">æ¯”è³½å³å°‡é–‹å§‹</div>
            <div id="rbPrepNumber" class="text-6xl font-extrabold text-primary-500">3</div>
        </div>
    </div>

    <script>
    (function(){
        const sb = (window.ccAuth && window.ccAuth.getClient && window.ccAuth.getClient()) || window.sb;
        const state = {
            user: null,
            room: null,
            channel: null,
            dbChannel: null,
            roster: [],           // [{user_id, nickname, joined_at}]
            rosterUserIds: [],    // èˆ‡é ç¨‹é™æ™‚æ¨¡å¼åŒæ­¥çš„ user_id åˆ—è¡¨
            presenceMap: {},
            seenEids: {}          // äº‹ä»¶å»é‡ï¼šeid -> 1
        };
        // ã€é‡æ§‹ã€‘ä¸å†æš´éœ² __REMOTE_STATE__ï¼Œæ‰€æœ‰æ•¸æ“šçµ±ä¸€åœ¨ GameState ä¸­

        // åœ¨ GitHub Pages ä¸Šå¶ç™¼ localStorage ä¸­æ®˜ç•™çš„å£ session å°è‡´ auth æ›èµ·
        // é€™è£¡åœ¨èªè­‰æµç¨‹é–‹å§‹å‰åšä¸€æ¬¡æ¸…ç†èˆ‡å¥æª¢ï¼Œå±¬æ–¼ä¸€æ¬¡æ€§æ ¹æ²»æªæ–½
        function sanitizeSupabaseSessionStorage() {
            try {
                const ls = window.localStorage;
                if (!ls) return;
                const keys = [];
                for (let i = 0; i < ls.length; i++) {
                    const k = ls.key(i);
                    if (k && k.startsWith('sb-') && k.endsWith('-auth-token')) keys.push(k);
                }
                let removed = 0;
                keys.forEach(k => {
                    const raw = ls.getItem(k);
                    if (!raw) return;
                    try {
                        const obj = JSON.parse(raw);
                        // åŸºæœ¬å½¢ç‹€æª¢æŸ¥ï¼šç•¶å‰ Supabase v2 æœŸæœ›æœ‰ currentSession / expires_at ç­‰å­—æ®µ
                        const ok = !!(obj && (obj.currentSession || obj.user || obj.access_token || obj.session));
                        if (!ok) { ls.removeItem(k); removed++; console.warn('[remote][auth] ç§»é™¤ç„¡æ•ˆ session æ¢ç›®:', k); }
                    } catch (e) {
                        // JSON è§£æå¤±æ•—ï¼Œè¦–ç‚ºæå£
                        ls.removeItem(k);
                        removed++;
                        console.warn('[remote][auth] ç§»é™¤æå£ sessionï¼ˆJSON è§£æå¤±æ•—ï¼‰:', k);
                    }
                });
                if (removed > 0) {
                    console.warn('[remote][auth] session æ¸…ç†å®Œæˆï¼Œç§»é™¤æ•¸é‡:', removed);
                }
            } catch (e) {
                console.warn('[remote][auth] session æ¸…ç†æ™‚ç™¼ç”Ÿä¾‹å¤–ï¼Œå¿½ç•¥ï¼š', e);
            }
        }

        function withTimeout(promise, ms, label) {
            let timer;
            const timeout = new Promise((_, reject) => {
                timer = setTimeout(() => reject(new Error((label||'operation') + ' è¶…æ™‚')), ms);
            });
            return Promise.race([
                promise.finally(() => clearTimeout(timer)),
                timeout
            ]);
        }

        // ç¢ºä¿ç”¨æˆ¶å·²èªè­‰ï¼ˆæ”¯æŒ Google ç™»å…¥å’ŒåŒ¿åç™»å…¥ï¼‰
        async function ensureAnonLogin(){
            console.log('[remote] èªè­‰æª¢æŸ¥é–‹å§‹');
            if (!sb || !sb.auth) throw new Error('Supabase client æœªå°±ç·’');
            
            try {
                // 0. å•Ÿå‹•å‰æ¸…ç†å¯èƒ½çš„å£ session
                sanitizeSupabaseSessionStorage();

                // 1. æª¢æŸ¥ç•¶å‰æœƒè©±ï¼ˆå¸¶è¶…æ™‚ä¿è­·ï¼‰
                const sessionResp = await withTimeout(sb.auth.getSession(), 4000, 'getSession');
                const sessionUser = sessionResp?.data?.session?.user || null;
                if (sessionUser) {
                    state.user = sessionUser;
                    const userType = sessionUser.app_metadata?.provider === 'google' ? 'Google' : 'åŒ¿å';
                    console.log('[remote] âœ… æ‰¾åˆ°ç¾æœ‰æœƒè©±:', userType, 'ç”¨æˆ¶ï¼ŒID:', sessionUser.id);
                    return;
                }

                // 2. ç„¡ sessionï¼Œå†æ¬¡å˜—è©¦ getUserï¼ˆå…¼å®¹æŸäº›ç‰ˆæœ¬è¡Œç‚ºï¼‰ï¼Œå¸¶è¶…æ™‚
                try {
                    const userResp = await withTimeout(sb.auth.getUser(), 3000, 'getUser');
                    const user = userResp?.data?.user || null;
                    if (user) {
                        state.user = user;
                        const userType = user.app_metadata?.provider === 'google' ? 'Google' : 'åŒ¿å';
                        console.log('[remote] âœ… æ‰¾åˆ°ç¾æœ‰æœƒè©±(user):', userType, 'ç”¨æˆ¶ï¼ŒID:', user.id);
                        return;
                    }
                } catch (e) {
                    console.warn('[remote] getUser å¤±æ•—æˆ–è¶…æ™‚ï¼Œå°‡åŸ·è¡ŒåŒ¿åç™»å…¥:', e?.message || e);
                    // é‡åˆ°ç•°å¸¸æ™‚ä¸»å‹•ç°½å‡ºä¸¦æ¸…ç†
                    try { await sb.auth.signOut(); } catch(_){}
                    sanitizeSupabaseSessionStorage();
                }
                
                // 3. æ²’æœ‰æœƒè©±ï¼ŒåŸ·è¡ŒåŒ¿åç™»å…¥
                console.log('[remote] æ²’æœ‰ç¾æœ‰æœƒè©±ï¼ŒåŸ·è¡ŒåŒ¿åç™»å…¥...');
                const { data, error } = await withTimeout(sb.auth.signInAnonymously(), 6000, 'signInAnonymously');
                
                if (error) {
                    console.error('[remote] âŒ åŒ¿åç™»å…¥å¤±æ•—:', error);
                    throw error;
                }
                
                if (data?.user) {
                    state.user = data.user;
                    console.log('[remote] âœ… åŒ¿åç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶ID:', data.user.id);
                } else {
                    throw new Error('åŒ¿åç™»å…¥æˆåŠŸä½†ç„¡ç”¨æˆ¶æ•¸æ“š');
                }
            } catch (err) {
                console.error('[remote] èªè­‰å¤±æ•—:', err);
                throw err;
            }
        }

        function genRoomCode(){
            // ç”Ÿæˆ6ä½çº¯æ•°å­—ä»£ç ï¼ˆ100000-999999ï¼‰
            // é¿å…å…¨0ã€å…¨ç›¸åŒç­‰ç‰¹æ®Šæƒ…å†µ
            let code;
            do {
                code = Math.floor(100000 + Math.random() * 900000).toString();
            } while (
                /^(.)\1{5}$/.test(code) || // é¿å…å…¨ç›¸åŒï¼ˆå¦‚111111ï¼‰
                code === '000000'           // é¿å…å…¨0
            );
            return code;
        }

        async function createRoom(name, nickname){
            await ensureAnonLogin();
            console.log('[remote] createRoom: é–‹å§‹å»ºç«‹æˆ¿é–“ï¼Œç”¨æˆ¶ID:', state.user.id);
            
            let room = null; let lastErr = null;
            for (let i=0;i<5;i++) {
                const code = genRoomCode();
                console.log('[remote] createRoom: å˜—è©¦æ’å…¥ rooms è¡¨ï¼Œä»£ç¢¼:', code);
                
                const { data, error } = await sb
                    .from('rooms')
                    .insert({ code, host_id: state.user.id, name })
                    .select()
                    .single();
                
                if (!error && data) { 
                    room = data; 
                    console.log('[remote] createRoom: âœ… rooms è¡¨æ’å…¥æˆåŠŸ');
                    break; 
                }
                lastErr = error;
                console.warn('[remote] createRoom: rooms æ’å…¥éŒ¯èª¤:', error);
                if (!(error && String(error.code) === '23505')) break; // å”¯ä¸€éµè¡çªæ‰é‡è©¦
            }
            if (!room) throw lastErr || new Error('å»ºç«‹æˆ¿é–“å¤±æ•—');

            console.log('[remote] createRoom: æ’å…¥ room_players è¡¨...');
            const { error: er2 } = await sb
                .from('room_players')
                .insert({ room_id: room.id, user_id: state.user.id, nickname: nickname || 'ç©å®¶', is_host: true });
            
            if (er2) {
                console.error('[remote] createRoom: room_players æ’å…¥å¤±æ•—:', er2);
                throw er2;
            }
            console.log('[remote] createRoom: âœ… room_players è¡¨æ’å…¥æˆåŠŸ');

            console.log('[remote] createRoom: åŠ å…¥ Realtime...');
            await joinRealtime(room, nickname || 'ç©å®¶');
            subscribeDbChanges(room.id);
            console.log('[remote] createRoom: âœ… æˆ¿é–“å»ºç«‹å®Œæˆ');
            return room;
        }

        async function joinRoomByCode(code, nickname){
            await ensureAnonLogin();
            // åªä¿ç•™æ•°å­—ï¼Œå»é™¤å…¶ä»–å­—ç¬¦
            code = String(code||'').trim().replace(/\D/g, '');
            if (code.length !== 6) {
                throw new Error('æˆ¿é–“ä»£ç¢¼å¿…é ˆæ˜¯6ä½æ•¸å­—');
            }
            const { data: room, error } = await sb.from('rooms').select('*').eq('code', code).single();
            if (error || !room) throw new Error('æ‰¾ä¸åˆ°æˆ¿é–“');

            // æª¢æŸ¥æˆ¿é–“äººæ•¸é™åˆ¶ï¼ˆæœ€å¤š20äººï¼‰
            const { data: players, error: countError } = await sb
                .from('room_players')
                .select('user_id')
                .eq('room_id', room.id);
            
            if (!countError && players && players.length >= 20) {
                throw new Error('æˆ¿é–“å·²æ»¿ï¼ˆæœ€å¤š20äººï¼‰');
            }

            await sb.from('room_players').upsert({
                room_id: room.id, user_id: state.user.id, nickname: nickname || 'ç©å®¶', is_host: room.host_id === state.user.id
            });

            await joinRealtime(room, nickname || 'ç©å®¶');
            subscribeDbChanges(room.id);
            return room;
        }

        async function joinRealtime(room, nickname){
            state.room = room;
            if (state.channel) { try { await state.channel.unsubscribe(); } catch(_){} }
            const channel = sb.channel(`room:${room.code}`, { 
                config: { 
                    presence: { key: state.user.id },
                    broadcast: { self: true, ack: false }  // self: true ç”¨æ–¼èª¿è©¦ï¼ˆç™¼é€è€…ä¹Ÿèƒ½çœ‹åˆ°è‡ªå·±çš„æ¶ˆæ¯ï¼‰
                } 
            });

            channel.on('presence', { event: 'sync' }, () => {
                const st = channel.presenceState();
                state.presenceMap = st || {};
                renderPresence(st);
            });

            channel.on('broadcast', { event: 'move' }, (msg) => {
                console.log('[remote] broadcast received in channel.on, payload:', msg?.payload);
                handleIncomingMove(msg?.payload);
            });

            channel.on('broadcast', { event: 'kick' }, (msg) => {
                console.log('[remote] kick event received:', msg?.payload);
                const payload = msg?.payload?.payload || msg?.payload;
                const targetUserId = payload?.targetUserId;
                const currentUserId = state.user?.id;
                
                // å¦‚æœè¢«è¸¢çš„æ˜¯è‡ªå·±ï¼Œé€€å‡ºæˆ¿é–“
                if (targetUserId === currentUserId) {
                    alert('æ‚¨å·²è¢«æˆ¿ä¸»ç§»å‡ºæˆ¿é–“');
                    // é—œé–‰æ¨¡æ…‹çª—å£
                    const modal = document.getElementById('remoteBattleModal');
                    if (modal) modal.classList.add('hidden');
                    // é‡ç½®è¦–åœ–
                    const initialView = document.getElementById('rbInitialView');
                    const hostView = document.getElementById('rbHostView');
                    const waitingView = document.getElementById('rbPlayerWaitingView');
                    if (initialView) initialView.classList.remove('hidden');
                    if (hostView) hostView.classList.add('hidden');
                    if (waitingView) waitingView.classList.add('hidden');
                    // æ¸…ç†ç‹€æ…‹
                    state.room = null;
                    state.channel = null;
                }
            });

            await channel.subscribe((status) => {
                console.log('[remote] channel subscription status:', status);
                if (status === 'SUBSCRIBED') {
                    console.log('[remote] channel SUBSCRIBED, tracking presence');
                    channel.track({ nickname });
                }
            });

            state.channel = channel;
            console.log('[remote] channel set to state, state:', channel.state);
            await refreshRoster();
        }

        function subscribeDbChanges(room_id){
            if (state.dbChannel) { try { state.dbChannel.unsubscribe(); } catch(_){} }
            const ch = sb.channel('db:'+room_id)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'room_events', filter: `room_id=eq.${room_id}` }, (c)=>{
                    handleIncomingMove({ type: c.new.event_type, payload: c.new.payload, fromDb: true, from: c.new.user_id, ts: Date.now(), eid: c.new.eid });
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${room_id}` }, (c)=>{
                    handleRoomUpdate(c.new);
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'room_players', filter: `room_id=eq.${room_id}` }, async ()=>{
                    await refreshRoster();
                })
                .subscribe();
            state.dbChannel = ch;
        }

        // çµ±ä¸€çš„ç©å®¶åˆ—è¡¨æ¸²æŸ“å‡½æ•¸ï¼ˆæ‰å¹³èƒ¶å›Šæ ·å¼ï¼‰
        function renderPlayerListToContainer(container, players) {
            if (!container) return;
            container.innerHTML = '';
            const isHost = window.RemoteBattle?.isHost();
            const currentUserId = state.user?.id;
            
            players.forEach(p => {
                const div = document.createElement('div');
                // æ‰å¹³èƒ¶å›Šæ ·å¼ï¼ˆå¢å¤§1.5å€ï¼‰ï¼šå›ºå®šé«˜åº¦ã€æ°´å¹³æ’åˆ—
                div.className = 'inline-flex items-center gap-2 h-10 px-5 rounded-full bg-gradient-to-r from-primary-100 to-accent-100 border border-primary-200 text-base font-modern font-semibold text-primary-700 relative group shadow-sm hover:shadow-md hover:scale-105 transition-all whitespace-nowrap';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = (p && p.nickname) ? p.nickname : 'ç©å®¶';
                div.appendChild(nameSpan);
                
                // æˆ¿ä¸»å¯ä»¥è¸¢äººï¼ˆé™¤äº†è‡ªå·±ï¼‰
                if (isHost && p.user_id !== currentUserId) {
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'opacity-0 group-hover:opacity-100 transition-all text-red-400 hover:text-white hover:bg-red-500 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold leading-none flex-shrink-0 ml-1';
                    kickBtn.textContent = 'âœ•';
                    kickBtn.title = 'è¸¢å‡ºæˆ¿é–“';
                    kickBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (confirm(`ç¢ºå®šè¦è¸¢å‡º ${p.nickname || 'ç©å®¶'} å—ï¼Ÿ`)) {
                            await kickPlayer(p.user_id);
                        }
                    });
                    div.appendChild(kickBtn);
                }
                
                container.appendChild(div);
            });
        }

        async function refreshRoster(){
            if (!state.room) return;
            const { data, error } = await sb
                .from('room_players')
                .select('user_id, nickname, joined_at')
                .eq('room_id', state.room.id)
                .order('joined_at', { ascending: true });
            let roster = (!error && Array.isArray(data)) ? data : [];
            if (!roster || roster.length === 0) {
                // fallback to presence
                const presence = state.presenceMap || {};
                roster = Object.keys(presence).map(uid => {
                    const meta = (presence[uid] && presence[uid][0]) || {};
                    return { user_id: uid, nickname: meta.nickname || 'ç©å®¶', joined_at: null };
                });
            }
            state.roster = Array.isArray(roster) ? roster.filter(Boolean) : [];
            
            // æ›´æ–°åœ¨ç·šæ¸…å–®çš„é¡¯ç¤ºï¼ˆåŒæ™‚æ›´æ–°å…©å€‹åˆ—è¡¨å€åŸŸï¼‰
            const list = document.getElementById('rbPresenceList');
            const listWaiting = document.getElementById('rbPresenceListWaiting');
            renderPlayerListToContainer(list, state.roster);
            renderPlayerListToContainer(listWaiting, state.roster);
        }

        function genEid(){
            try { return `${state.user?.id||'u'}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`; } catch(_) { return `${Date.now()}-${Math.random()}`; }
        }

        async function sendGameEvent(type, payload){
            if (!state.room || !state.channel) {
                console.error('[remote] sendGameEvent failed: no room or channel');
                return;
            }
            
                // console.log(`[remote] sendGameEvent preparing to send: ${type}, channel state:`, state.channel.state); // å·²ç°¡åŒ–
            const out = { type, payload, ts: Date.now(), from: state.user?.id, eid: genEid() };
            
            // ç¢ºä¿ channel å·²é€£æ¥
            if (state.channel.state !== 'joined') {
                console.warn(`[remote] channel not joined (state: ${state.channel.state}), waiting...`);
                await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾… 500ms
                if (state.channel.state !== 'joined') {
                    console.error(`[remote] channel still not joined after wait (state: ${state.channel.state})`);
                }
            }
            
            // é€šé Realtime channel å»£æ’­äº‹ä»¶
            try {
                // console.log(`[remote] calling channel.send for: ${type}, channel state:`, state.channel.state); // å·²ç°¡åŒ–
                const result = await state.channel.send({ type: 'broadcast', event: 'move', payload: out });
                console.log(`[remote] broadcast sent successfully: ${type}`, result);
            } catch (e) {
                console.error(`[remote] broadcast error for ${type}:`, e);
                throw e; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…çŸ¥é“å¤±è´¥äº†
            }
            
            // æ•¸æ“šåº«è¨˜éŒ„ï¼ˆå¯é¸ï¼Œå¤±æ•—ä¸å½±éŸ¿éŠæˆ²ï¼‰
            try {
                await sb.from('room_events').insert({ 
                    room_id: state.room.id, 
                    user_id: state.user.id, 
                    event_type: type, 
                    payload, 
                    eid: out.eid 
                });
                console.log(`[remote] db record saved for: ${type}`);
            } catch (e) {
                console.warn(`[remote] db insert failed (non-critical) for ${type}:`, e.message);
            }
        }

        async function kickPlayer(userId){
            if (!window.RemoteBattle?.isHost()) {
                console.warn('[remote] åªæœ‰æˆ¿ä¸»å¯ä»¥è¸¢äºº');
                return;
            }
            if (!userId) return;
            
            try {
                console.log('[remote] kicking player:', userId);
                
                // ç™¼é€è¸¢äººäº‹ä»¶çµ¦è©²ç©å®¶
                await sendGameEvent('kick', { targetUserId: userId });
                
                // å¾æ•¸æ“šåº«ä¸­ç§»é™¤è©²ç©å®¶
                if (state.room?.id) {
                    await sb.from('room_players')
                        .delete()
                        .eq('room_id', state.room.id)
                        .eq('user_id', userId);
                }
                
                // åˆ·æ–°ç©å®¶åˆ—è¡¨
                await refreshRoster();
                
                console.log('[remote] player kicked successfully:', userId);
            } catch (e) {
                console.error('[remote] kick player error:', e);
                alert('è¸¢äººå¤±æ•—ï¼š' + (e?.message || e));
            }
        }

        function handleIncomingMove(msg){
            if (!msg) {
                console.warn('[remote] handleIncomingMove: empty message');
                return;
            }
            console.log('[remote] handleIncomingMove received:', msg.type, 'from:', msg.from, 'my id:', state.user?.id);
            
            // æš«æ™‚å…è¨±è™•ç†è‡ªå·±çš„æ¶ˆæ¯ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
            const isOwnMessage = msg.from && state.user && msg.from === state.user.id;
            if (isOwnMessage) {
                console.log('[remote] received own message (allowing for debug)');
            }
            
            try {
                // äº‹ä»¶å»é‡ï¼šè‹¥å·²æœ‰ç›¸åŒ eid å‰‡å¿½ç•¥
                if (msg.eid) {
                    if (state.seenEids[msg.eid]) return;
                    state.seenEids[msg.eid] = 1;
                }
                // é ç¨‹é™æ™‚æ¨¡å¼ï¼šåš´æ ¼ç™½åå–®åƒ…å…è¨± timed_start/score_update/timed_end
                if (state && state.timedMode === true) {
                    const allowed = { timed_start:1, score_update:1, timed_end:1 };
                    if (!allowed[msg.type]) {
                        // å¿½ç•¥ä»»ä½•è¼ªæµ/é…ç½®é¡äº‹ä»¶ï¼Œé¿å…ä¸²å°
                        return;
                    }
                }
                switch (msg.type) {
                    case 'timed_start':
                        // æ¥æ”¶é™æ™‚é–‹å§‹ï¼šåˆå§‹åŒ– GameState
                        console.log('[remote] timed_start received, payload=', msg.payload);
                        
                        // ã€é‡æ§‹ã€‘ç›´æ¥åˆå§‹åŒ– GameState
                        window.GameState.mode = 'remote';
                        window.GameState.subMode = 'timed_score';
                        window.GameState.isActive = true;
                        window.GameState.timed.endsAt = msg.payload?.endsAt || (Date.now() + (msg.payload?.mins || 3) * 60000);
                        window.GameState.timed.duration = msg.payload?.mins || 3;
                        window.GameState.remote.currentUserId = state.user?.id || null;
                        
                        // åˆå§‹åŒ–ç©å®¶æ•¸æ“š
                        if (Array.isArray(msg.payload?.players) && msg.payload?.emojiMap) {
                            window.GameState.players = msg.payload.players.map((p, idx) => ({
                                uid: p.id || state.rosterUserIds?.[idx] || null,
                                name: p.name || ('ç©å®¶' + (idx + 1)),
                                emoji: msg.payload.emojiMap[p.id || state.rosterUserIds?.[idx]] || 'ğŸƒ',
                                score: 0,
                                answered: 0,
                                correct: 0,
                                lastAnswerTs: 0,
                                isReady: true,
                                isActive: false
                            }));
                            console.log('[remote] receiver GameState.players initialized:', window.GameState.players.map(p => ({ name: p.name, emoji: p.emoji })));
                        } else {
                            console.warn('[remote] receiver failed to initialize players - missing data:', { 
                                hasPlayers: Array.isArray(msg.payload?.players), 
                                hasEmojiMap: !!msg.payload?.emojiMap,
                                payload: msg.payload 
                            });
                        }
                        console.log('[remote] receiver GameState:', { mode: window.GameState.mode, subMode: window.GameState.subMode, isActive: window.GameState.isActive, playersCount: window.GameState.players?.length || 0 });
                        
                        // èˆŠç³»çµ±åŒæ­¥ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                        // ã€é‡æ§‹ã€‘ä¸å†è¨­ç½® __REMOTE_TIMED__ï¼Œæ”¹ç”¨ GameState.isActive åˆ¤æ–·
                        state.timedMode = true;
                        state.timedEndsAt = window.GameState.timed.endsAt;
                        if (msg.payload?.emojiMap) state.emojiMap = msg.payload.emojiMap;
                        if (Array.isArray(msg.payload?.players)) {
                            applyBattleConfig({ players: msg.payload.players, roundsPerPlayer: 1 });
                        }
                        
                        // åŒæ­¥è©©è©åº«
                        if (msg.payload?.tag) {
                            try {
                                const tagSel = document.getElementById('userLibraryTagSelect');
                                if (tagSel) { tagSel.value = msg.payload.tag; saveActiveTag(msg.payload.tag); }
                            } catch(_){}
                        }
                        
                        showPrepCountdown(Math.max(1000, msg.payload?.prepMs || 3000), () => {
                            console.log('[remote] receiver entering game, GameMode.isTimedScore()=', window.GameMode.isTimedScore(), 'GameMode.isAnyBattle()=', window.GameMode.isAnyBattle());
                            beginTimedTicker();
                            try { document.getElementById('remoteBattleModal')?.classList.add('hidden'); } catch(_){ }
                            // é¡¯ç¤ºè¨˜åˆ†æ¿ï¼ˆå…ˆæ–¼UIæ¸²æŸ“ï¼‰
                            try { 
                                const board = document.getElementById('battleScoreboard');
                                if (board) board.classList.remove('hidden');
                            } catch(_){}
                            // è§¸ç™¼è³½é“å’Œè¨˜åˆ†æ¿æ¸²æŸ“ï¼ˆåœ¨startNewRoundä¹‹å‰ï¼‰
                            try {
                                console.log('[remote] receiver starting game, rendering UI');
                                window.RaceTrack?.render();
                                window.LocalBattle?.updateScoreboard();
                                console.log('[remote] receiver UI rendered, players count:', window.GameState.players?.length || 0);
                            } catch(e){ console.error('[remote] receiver UI initialization error:', e); }
                            // æœ€å¾Œé–‹å§‹ä½œç­”
                            if (typeof window.startNewRound === 'function') window.startNewRound();
                        });
                        break;
                    case 'timed_end':
                        state.timedMode = false;
                        window.GameState.isActive = false; // ã€é‡æ§‹ã€‘æ”¹ç”¨ GameState
                        try { clearInterval(state.timedTimer); } catch(_){}
                        // é¡¯ç¤ºé ç¨‹é™æ™‚å°ˆå±¬æ’è¡Œæ¦œ
                        if (typeof showBattleResultModal === 'function') showBattleResultModal();
                        break;
                    case 'score_update':
                        try {
                            const p = msg.payload || {};
                            const uid = p.userId;
                            if (!uid) break;
                            
                            // ã€ä¿®å¾©ã€‘æ‰€æœ‰å®¢æˆ¶ç«¯çµ±ä¸€é€šéæ­¤è™•æ›´æ–°åˆ†æ•¸ï¼ˆåŒ…æ‹¬ç™¼é€è€…è‡ªå·±ï¼‰
                            // ã€é‡æ§‹ã€‘ç›´æ¥æ›´æ–° GameState
                            const player = window.GameState.players.find(pl => pl.uid === uid);
                            if (player) {
                                player.score += Number(p.delta || 0);
                                player.answered += Number(p.answeredInc || 0);
                                player.correct += Number(p.correctInc || 0);
                                player.lastAnswerTs = Date.now();
                            }
                            
                            // åŒæ­¥åˆ°èˆŠç³»çµ±ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                            state.stats[uid] = state.stats[uid] || { score:0, answered:0, correct:0, nickname:'' };
                            const s = state.stats[uid];
                            s.score += Number(p.delta || 0);
                            s.answered += Number(p.answeredInc || 0);
                            s.correct += Number(p.correctInc || 0);
                            s.lastTs = Date.now();
                            
                            // è§¸ç™¼ UI æ›´æ–°
                            try {
                                window.LocalBattle?.updateScoreboard();
                                window.RaceTrack?.render();
                            } catch(e){ console.error('[remote] UI update error:', e); }
                        } catch(e){ console.error('[remote] score_update error:', e); }
                        break;
                    default:
                        console.log('[remote] unhandled move', msg);
                }
            } catch (e) {
                console.warn('[remote] handleIncomingMove error', e);
            }
        }

        function handleRoomUpdate(room){
            // å¯é¸ï¼šæ ¹æ“šæˆ¿ä¸»æ›´æ–°åŒæ­¥ UI
            console.log('[remote] room update', room);
        }

        function applyBattleConfig(conf){
            try {
                if (!conf) return;
                
                // ã€é‡æ§‹ã€‘ä¸å†ä½¿ç”¨ battleModeï¼Œç›´æ¥åˆå§‹åŒ– state.stats ç”¨æ–¼é ç¨‹å°æˆ°
                const players = (conf.players || []).filter(Boolean);
                const names = players.map(p => (typeof p === 'string' ? p : ((p && p.name) || 'ç©å®¶')));
                const ids = players.map(p => (typeof p === 'string' ? null : ((p && p.id) || null)));
                
                state.rosterUserIds = ids;
                state.stats = state.stats || {};
                
                // åˆå§‹åŒ–çµ±è¨ˆæ•¸æ“š
                (ids || []).forEach((uid, i) => {
                    if (!uid) return;
                    state.stats[uid] = state.stats[uid] || { score:0, answered:0, correct:0, nickname:'', lastTs:0 };
                    state.stats[uid].nickname = names[i] || state.stats[uid].nickname || 'ç©å®¶';
                });
                
                // é ç¨‹é™æ™‚æ¨¡å¼ä¸ä½¿ç”¨ç©åˆ†æ¿ï¼ˆä½¿ç”¨è³½é“é¡¯ç¤ºï¼‰ï¼Œæ‰€ä»¥ä¸é¡¯ç¤º
                // é ç¨‹è¼ªæµæ¨¡å¼å·²ç§»é™¤ï¼Œä¸å†éœ€è¦ turnUserId å’Œ updateSubmitGate
            } catch (e) {
                console.warn('[remote] applyBattleConfig error', e);
            }
        }

        function renderPresence(presenceState){
            const list = document.getElementById('rbPresenceList');
            const listWaiting = document.getElementById('rbPresenceListWaiting');
            
            const users = [];
            Object.keys(presenceState || {}).forEach(uid => {
                (presenceState[uid] || []).forEach(meta => {
                    users.push({ user_id: uid, nickname: meta.nickname || 'ç©å®¶' });
                });
            });
            
            // ä½¿ç”¨çµ±ä¸€çš„æ¸²æŸ“å‡½æ•¸
            renderPlayerListToContainer(list, users);
            renderPlayerListToContainer(listWaiting, users);
        }

        // å¡«å……æˆ¿ä¸»å¯é¸çš„è©©è©åº«æ¨™ç±¤ï¼ˆå¾ä¸»è¨­ç½®çš„ userLibraryTagSelect è¤‡è£½ï¼‰
        window.populatePoemTags = function(){
            try {
                const dst = document.getElementById('rbPoemTag');
                if (!dst) return;
                dst.innerHTML = '';
                const src = document.getElementById('userLibraryTagSelect');
                let filled = false;
                if (src && src.options && src.options.length) {
                    Array.from(src.options).forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt.value;
                        o.textContent = opt.textContent || opt.value;
                        dst.appendChild(o);
                    });
                    filled = true;
                }
                if (!filled) {
                    // å¾Œå‚™ï¼šçµ¦å‡ºä¸€å€‹å¸¸ç”¨é è¨­
                    const o = document.createElement('option');
                    o.value = 'å—é¢¨è©©è©åº«';
                    o.textContent = 'å—é¢¨è©©è©åº«';
                    dst.appendChild(o);
                }
                // é è¨­é¸ä¸­ç•¶å‰å•Ÿç”¨æ¨™ç±¤
                try {
                    const active = (typeof loadActiveTag === 'function') ? (loadActiveTag() || 'å—é¢¨è©©è©åº«') : 'å—é¢¨è©©è©åº«';
                    const has = Array.from(dst.options).some(op => op.value === active);
                    dst.value = has ? active : (dst.options[0]?.value || 'å—é¢¨è©©è©åº«');
                } catch(_){}
            } catch(_){}
        }

        // å°è£åˆ°å…¨åŸŸï¼Œä¾›å¾ŒçºŒéŠæˆ²æµç¨‹èª¿ç”¨
        window.RemoteBattle = {
            get user(){ return state.user; },
            get room(){ return state.room; },
            get channel(){ return state.channel; },
            isHost(){ return !!(state.room && state.user && state.room.host_id === state.user.id); },
            ensureAnonLogin,
            createRoom,
            joinRoomByCode,
            sendGameEvent
        };

        // ====== UI ç¶å®š ======
        function $(id){ return document.getElementById(id); }
        const btn = $('remoteBattleBtn');
        const modal = $('remoteBattleModal');
        const closeBtn = $('rbClose');
        const nicknameInput = $('rbNickname');
        const createBtn = $('rbCreateBtn');
        const createdInfo = $('rbCreatedInfo');
        const codeDisplay = $('rbRoomCodeDisplay');
        const joinCodeInput = $('rbJoinCode');
        const joinBtn = $('rbJoinBtn');
        const hostSettings = document.getElementById('rbHostSettings');
        const timedMinInput = document.getElementById('rbTimedMinutes');
        const startTimedBtn = document.getElementById('rbStartTimedBtn');
        const poemTagSelect = document.getElementById('rbPoemTag');

        function openModal(){
            if (modal) {
                modal.classList.remove('hidden');
                // æ‰“é–‹é ç¨‹æ¨¡æ…‹æ™‚æš«åœå–®äººæ¨¡å¼ï¼Œé¿å…èƒŒæ™¯è‡ªå‹•é‹è¡Œ
                try { clearInterval(timerInterval); } catch(_){}
                isGameActive = false;
            }
        }
        function closeModal(){ 
            if (modal) {
                modal.classList.add('hidden');
                // é‡ç½®è¦–åœ–ç‹€æ…‹ï¼ˆé¡¯ç¤ºåˆå§‹è¦–åœ–ï¼Œéš±è—æˆ¿ä¸»è¦–åœ–å’Œç­‰å¾…è¦–åœ–ï¼‰
                const initialView = document.getElementById('rbInitialView');
                const hostView = document.getElementById('rbHostView');
                const waitingView = document.getElementById('rbPlayerWaitingView');
                if (initialView) initialView.classList.remove('hidden');
                if (hostView) hostView.classList.add('hidden');
                if (waitingView) waitingView.classList.add('hidden');
            }
        }

        btn?.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);

        // è¾“å…¥æ¡†å®æ—¶éªŒè¯ï¼ˆåªå…è®¸æ•°å­—ï¼Œä¸æ·»åŠ ç©ºæ ¼ï¼‰
        if (joinCodeInput) {
            joinCodeInput.addEventListener('input', (e) => {
                // åªä¿ç•™æ•°å­—
                let value = e.target.value.replace(/\D/g, '');
                
                // é™åˆ¶6ä½
                if (value.length > 6) {
                    value = value.slice(0, 6);
                }
                
                // ç›´æ¥æ˜¾ç¤ºæ•°å­—ï¼Œä¸æ·»åŠ ç©ºæ ¼
                e.target.value = value;
            });
        }

        createBtn?.addEventListener('click', async () => {
            try {
                console.log('[remote] create clicked');
                if (!sb) { alert('Supabase æœªå°±ç·’'); return; }
                const nickname = (nicknameInput?.value || '').trim() || 'ç©å®¶';
                if (createBtn) { createBtn.disabled = true; createBtn.textContent = 'èªè­‰ä¸­â€¦'; }
                const room = await createRoom('', nickname);
                console.log('[remote] room created', room && room.code);
                
                // æ˜¾ç¤ºæˆ¿é—´ä»£ç 
                if (codeDisplay) {
                    codeDisplay.textContent = room.code;
                }
                
                // æˆ¿ä¸»ï¼šéš±è—åˆå§‹è¦–åœ–ï¼Œé¡¯ç¤ºæˆ¿ä¸»ç®¡ç†è¦–åœ–
                const initialView = document.getElementById('rbInitialView');
                const hostView = document.getElementById('rbHostView');
                if (initialView) initialView.classList.add('hidden');
                if (hostView) hostView.classList.remove('hidden');
                
                // å¡«å……è©©è©åº«é¸é …
                if (window.RemoteBattle?.isHost()) {
                    populatePoemTags();
                }
                
                if (createBtn) { createBtn.textContent = 'å·²å»ºç«‹'; setTimeout(()=>{ createBtn.disabled = false; createBtn.textContent = 'å»ºç«‹æˆ¿é–“'; }, 1200); }
            } catch (e) {
                console.warn('[remote] create error', e);
                if (createBtn) { createBtn.disabled = false; createBtn.textContent = 'å»ºç«‹æˆ¿é–“'; }
                alert('å»ºç«‹å¤±æ•—ï¼š' + (e?.message || e));
            }
        });

        joinBtn?.addEventListener('click', async () => {
            try {
                console.log('[remote] join clicked');
                const nickname = (nicknameInput?.value || '').trim() || 'ç©å®¶';
                const code = (joinCodeInput?.value || '').trim();
                const room = await joinRoomByCode(code, nickname);
                console.log('[remote] joined room', room && room.code);
                
                // éæˆ¿ä¸»ç©å®¶ï¼šéš±è—åˆå§‹è¦–åœ–ï¼Œé¡¯ç¤ºç­‰å¾…è¦–åœ–
                const initialView = document.getElementById('rbInitialView');
                const waitingView = document.getElementById('rbPlayerWaitingView');
                if (initialView) initialView.classList.add('hidden');
                if (waitingView) waitingView.classList.remove('hidden');
                
            } catch (e) {
                console.warn('[remote] join error', e);
                alert('åŠ å…¥å¤±æ•—ï¼š' + (e?.message || e));
            }
        });

        // é ç¨‹è¼ªæµæ¨¡å¼å·²ç§»é™¤ï¼Œåƒ…ä¿ç•™é ç¨‹é™æ™‚æ¨¡å¼
        
        try {

        // ===== é™æ™‚ç«¶è³½ï¼šé–‹å§‹ã€è¨ˆæ™‚èˆ‡çµç®— =====
        state.timedMode = false;
        state.timedEndsAt = 0;
        state.timedTimer = null;
        state.stats = {}; // userId -> { score, answered, correct, nickname, lastTs }

        startTimedBtn?.addEventListener('click', async () => {
            try {
                console.log('[remote] startTimed clicked');
                if (!window.RemoteBattle?.isHost()) { alert('åƒ…æˆ¿ä¸»å¯é–‹å§‹'); return; }
                await refreshRoster();
                const roster = state.roster || [];
                if (roster.length === 0) { alert('å°šç„¡ç©å®¶åŠ å…¥'); return; }
                const mins = Math.max(1, Math.min(10, parseInt((timedMinInput?.value || '3'), 10)));
                const endsAt = Date.now() + mins * 60 * 1000;
                // å»ºç«‹å°æˆ°æ¿ï¼ˆç©å®¶åå–®ï¼‰ï¼Œä½†ä¸é–‹å•Ÿè¼ªæµé™åˆ¶
                const activeTag = (poemTagSelect?.value || loadActiveTag() || 'å—é¢¨è©©è©åº«');
                const conf = { players: roster.map(p => ({ id: p.user_id, name: p.nickname || 'ç©å®¶' })), roundsPerPlayer: 1 };
                // ã€é‡æ§‹ã€‘æ¨™è¨˜é ç¨‹é™æ™‚æ¨¡å¼ï¼ˆæ”¹ç”¨ GameStateï¼‰
                // window.__REMOTE_TIMED__ = true; // å·²ç§»é™¤
                state.timedMode = true;
                state.timedEndsAt = endsAt;
                
                // ã€é‡æ§‹ã€‘ä¸»æ©Ÿç«¯ä¹Ÿéœ€è¦åˆå§‹åŒ– GameStateï¼ˆèˆ‡æ¥æ”¶æ–¹ä¿æŒä¸€è‡´ï¼‰
                window.GameState.mode = 'remote';
                window.GameState.subMode = 'timed_score';
                window.GameState.isActive = true;
                window.GameState.timed.endsAt = endsAt;
                window.GameState.timed.duration = mins;
                window.GameState.remote.currentUserId = state.user?.id || null;
                window.GameState.remote.isHost = true;
                
                // åˆå§‹åŒ–ç©å®¶æ•¸æ“šï¼ˆåœ¨ç”Ÿæˆ emojiMap ä¹‹å‰ï¼‰
                applyBattleConfig(conf);
                // ä¿éšªï¼šæ¸…ç†ä»»ä½•å–®é¡Œè¨ˆæ™‚èˆ‡æœ¬åœ°å›åˆç‹€æ…‹
                try { clearInterval(timerInterval); } catch(_){ }
                try { timerInterval = null; } catch(_){ }
                try { isGameActive = false; } catch(_){ }
                try { if (typeof hideResultModal === 'function') hideResultModal(); } catch(_){ }
                try { gameMessage?.classList.add('hidden'); } catch(_){ }
                try { if (timeBarFill) timeBarFill.style.width = '0%'; } catch(_){ }
                // å»£æ’­åŒ…å« players + emoji åˆ†é…ï¼Œä¸¦é™„å¸¶ 3 ç§’é å‚™
                const userIds = roster.map(p => p.user_id);
                const emojiMap = window.RaceTrack.buildEmojiMap(userIds, state.room?.code || 'ROOM');
                state.emojiMap = emojiMap; // ä¿å­˜åˆ° state
                console.log('[remote] host generated emojiMap:', emojiMap);
                // console.log('[remote] host emojiMap details:', Object.keys(emojiMap).map(k => `${k}: ${emojiMap[k]}`)); // å·²é—œé–‰èª¿è©¦æ—¥å¿—
                
                // ã€é‡æ§‹ã€‘ä¸»æ©Ÿç«¯å¡«å…… GameState.playersï¼ˆèˆ‡æ¥æ”¶æ–¹ä¿æŒä¸€è‡´ï¼‰
                window.GameState.players = conf.players.map((p, idx) => ({
                    uid: p.id || userIds[idx] || null,
                    name: p.name || ('ç©å®¶' + (idx + 1)),
                    emoji: emojiMap[p.id || userIds[idx]] || 'ğŸƒ',
                    score: 0,
                    answered: 0,
                    correct: 0,
                    lastAnswerTs: 0,
                    isReady: true,
                    isActive: false
                }));
                
                // é¡¯ç¤ºè¨˜åˆ†æ¿
                try { 
                    const board = document.getElementById('battleScoreboard');
                    if (board) board.classList.remove('hidden');
                } catch(_){}
                
                console.log('[remote] host GameState initialized:', {
                    mode: window.GameState.mode,
                    subMode: window.GameState.subMode, 
                    players: window.GameState.players.length
                });
                
                // ç™¼é€éŠæˆ²é–‹å§‹äº‹ä»¶ä¸¦ç­‰å¾…å®Œæˆ
                await window.RemoteBattle.sendGameEvent('timed_start', { endsAt, mins, players: conf.players, prepMs: 3000, tag: activeTag, emojiMap });
                console.log('[remote] timed_start event sent');
                
                showPrepCountdown(3000, () => {
                    console.log('[remote] host entering game, GameMode.isTimedScore()=', window.GameMode.isTimedScore(), 'GameMode.isAnyBattle()=', window.GameMode.isAnyBattle());
                    beginTimedTicker();
                    // é—œé–‰é ç¨‹æ¨¡æ…‹
                    try { document.getElementById('remoteBattleModal')?.classList.add('hidden'); } catch(_){ }
                    // è§¸ç™¼è³½é“å’Œè¨˜åˆ†æ¿æ¸²æŸ“
                    try {
                        console.log('[remote] host starting game, rendering UI');
                        window.RaceTrack?.render();
                        window.LocalBattle?.updateScoreboard();
                    } catch(e){ console.error('[remote] host UI initialization error:', e); }
                    // ç«‹å³é–‹å§‹ä½œç­”
                    if (typeof window.startNewRound === 'function') window.startNewRound();
                });
            } catch (e) {
                alert('ç„¡æ³•é–‹å§‹é™æ™‚ç«¶è³½ï¼š' + (e?.message || e));
            }
        });

        // äº‹ä»¶ä»£ç†ä¿éšªï¼ˆé¿å…æŒ‰éˆ•è¢«é‡å»ºå°è‡´ç›£è½ä¸Ÿå¤±ï¼‰
        document.getElementById('remoteBattleModal')?.addEventListener('click', function(ev){
            const t = ev.target;
            if (!t) return;
            if (t.id === 'rbStartTimedBtn' || t.closest?.('#rbStartTimedBtn')) {
                ev.preventDefault();
                try { startTimedBtn?.click(); } catch(_) {}
            }
        }, true);

        function beginTimedTicker(){
            try { clearInterval(state.timedTimer); } catch(_){}
            updateTimedUI();
            // é™æ™‚æ¨¡å¼ï¼šé¡¯ç¤ºè³½é“å®¹å™¨ã€éš±è—æ™‚é–“å¡«å……æ¢
            try { if (timeBarContainer) timeBarContainer.style.display = ''; } catch(_){ }
            try { if (timeBarFill) timeBarFill.style.display = 'none'; } catch(_){ }
            state.timedTimer = setInterval(() => {
                updateTimedUI();
                // é€±æœŸæ€§é‡ç¹ªè¨˜åˆ†æ¿èˆ‡è³½é“ï¼Œç¢ºä¿æœªæäº¤ç«¯ä¹Ÿèƒ½å³æ™‚çœ‹åˆ°ä»–äººåˆ†æ•¸è®ŠåŒ–
                try { if (typeof window.LocalBattle?.updateScoreboard === 'function') window.LocalBattle.updateScoreboard(); } catch(_){ }
                try { window.RaceTrack && window.RaceTrack.ensureEmojis && window.RaceTrack.ensureEmojis(); } catch(_){ }
                try { window.RaceTrack && window.RaceTrack.render && window.RaceTrack.render(); } catch(_){ }
                if (!state.timedMode) { clearInterval(state.timedTimer); return; }
                if (Date.now() >= state.timedEndsAt) {
                    clearInterval(state.timedTimer);
                    state.timedMode = false;
                    window.GameState.isActive = false; // ã€é‡æ§‹ã€‘æ”¹ç”¨ GameState
                    window.RemoteBattle.sendGameEvent('timed_end', {});
                    showBattleResultModal && showBattleResultModal();
                }
            }, 1000);
        }

        function updateTimedUI(){
            const remainMs = Math.max(0, state.timedEndsAt - Date.now());
            const remainSec = Math.ceil(remainMs / 1000);
            const timer = document.getElementById('timer');
            if (timer && state.timedMode) timer.textContent = String(remainSec);
        }

        function showPrepCountdown(ms, onDone){
            const overlay = document.getElementById('rbPrepOverlay');
            const num = document.getElementById('rbPrepNumber');
            if (!overlay || !num) { if (onDone) onDone(); return; }
            overlay.classList.remove('hidden');
            let remain = Math.max(1, Math.round(ms/1000));
            num.textContent = String(remain);
            const iv = setInterval(() => {
                remain -= 1;
                if (remain <= 0) {
                    clearInterval(iv);
                    overlay.classList.add('hidden');
                    if (onDone) onDone();
                } else {
                    num.textContent = String(remain);
                }
            }, 1000);
        }
        } catch (e) { console.warn('[remote] error', e); }
    })();
    </script>
    
</body>
</html>
