<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂçóÈ¢®Ë©©Ë©ûÁµÑÂè•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Supabase UMD ËàáÂÖ®ÂüüÁôªÂÖ•ÁãÄÊÖãÂàó -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.56.0/dist/umd/supabase.js"></script>
    <script>
        // ÊåáÂÆöÊú¨È†Å‰ΩøÁî®ÁöÑ Supabase Â∞àÊ°àÂèÉÊï∏ÔºàË¶ÜËìãÈ†êË®≠Ôºâ
        window.SUPABASE_URL = 'https://onregacmigwiyomhmjyt.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ucmVnYWNtaWd3aXlvbWhtanl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NzIzMDcsImV4cCI6MjA3NDU0ODMwN30.VxLyR3SMlnVYubFLdQNJqYMyJnT5foo7wUkVEmi4QcY';
    </script>
    <script src="assets/js/cc-auth.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Áé∞‰ª£ËìùÁ¥´Ê∏êÂèò‰∏ªËâ≤Á≥ª
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe', 
                            400: '#38bdf8',
                            500: '#0ea5e9', // ‰∏ªËìùËâ≤
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e'
                        },
                        // Áé∞‰ª£ËñÑËç∑ÁªøËæÖÂä©Ëâ≤
                        secondary: {
                            400: '#4ade80',
                            500: '#22c55e', // ‰∏ªÁªøËâ≤
                            600: '#16a34a',
                            700: '#15803d'
                        },
                        // Áé∞‰ª£Á¥´Ëâ≤Âº∫Ë∞ÉËâ≤
                        accent: {
                            400: '#a78bfa',
                            500: '#8b5cf6', // Á¥´Ëâ≤Âº∫Ë∞É
                            600: '#7c3aed'
                        },
                        // Áé∞‰ª£‰∏≠ÊÄßËâ≤ËÉåÊôØ
                        surface: {
                            50: '#fafafa',
                            100: '#f4f4f5',
                            200: '#e4e4e7',
                            800: '#27272a',
                            900: '#18181b'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'kai': ['KaiTi', 'SimKai', 'serif'],
                        'modern': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                        'bounce-gentle': 'bounceGentle 2s ease-in-out infinite',
                        'pulse-modern': 'pulseModern 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                    }
                }
            }
        }
    </script>
    
    <!-- Ê∑ªÂä†Âä®ÁîªÊïàÊûú -->
    <style>
        /* Â∑≤ÈÅ∏Â≠óÊ®£ÂºèÔºàÊ∏ÖÊô∞ÂçÄÂàÜÔºâ */
        .character-btn.selected {
            background-color: rgba(59, 121, 96, 0.15);
            border-color: #3B7960;
            box-shadow: 0 0 0 2px rgba(59,121,96,0.35) inset;
            color: #0f172a;
        }
        .character-btn.selected::after {
            content: "‚úì";
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 0.9rem;
            color: #3B7960;
            opacity: 0.95;
        }
        /* ÈÅ∏‰∏≠Â≠ó‰øùÊåÅÈÅ∏‰∏≠Ê®£ÂºèÔºå‰∏çÂèó hover Á∂†Ëâ≤ÂΩ±Èüø */
        .character-btn.selected:hover {
            background-color: rgba(59, 121, 96, 0.15);
            border-color: #3B7960;
            box-shadow: 0 0 0 2px rgba(59,121,96,0.35) inset;
            color: #0f172a;
        }
        /* Â≠óÁ¨¶ÊåâÈíÆÁÇπÂáªÂä®Áîª */
        @keyframes buttonPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 10px rgba(59, 121, 96, 0.5); }
            100% { transform: scale(1); }
        }
        
        .animate-click {
            animation: buttonPulse 0.3s ease-in-out;
        }
        
        /* Ê≠£Á°ÆÁ≠îÊ°àÂä®Áîª */
        @keyframes correctAnswer {
            0% { transform: scale(1); }
            10% { transform: scale(1.05); }
            20% { transform: scale(1); }
            30% { transform: scale(1.05); }
            40% { transform: scale(1); }
            50% { transform: scale(1.05); }
            60% { transform: scale(1); }
        }
        
        .animate-correct {
            animation: correctAnswer 1s ease-in-out;
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.7);
        }
        
        /* ÈîôËØØÁ≠îÊ°àÂä®Áîª */
        @keyframes wrongAnswer {
            0% { transform: translateX(0); }
            10% { transform: translateX(-5px); }
            20% { transform: translateX(5px); }
            30% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            60% { transform: translateX(5px); }
            70% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            90% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .animate-wrong {
            animation: wrongAnswer 0.5s ease-in-out;
        }
        
        /* ÂàÜÊï∞ÂèòÂåñÂä®Áîª */
        @keyframes scoreChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #DAA520; }
            100% { transform: scale(1); }
        }
        
        .animate-score {
            animation: scoreChange 0.8s ease-in-out;
        }
        
        /* Èù¢ÊùøÊ∑°ÂÖ•Âä®Áîª */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Êñ∞Â¢ûÔºöÊ∑°ÂÖ•‰∏äÊµÆÈÄ≤Â†¥ */
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(12px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-up { animation: fadeUp 500ms ease-out both; }

        /* Êñ∞Â¢ûÔºöÁ∏ÆÊîæÈÄ≤Â†¥ */
        @keyframes scaleIn {
            0% { opacity: 0; transform: scale(0.92); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in { animation: scaleIn 420ms ease-out both; }

        /* Êñ∞Â¢ûÔºöÊÖ¢ÈÄüËÑàÂãïÔºàÁî®ÊñºÁ∑äÂºµÊôÇÂàªÔºâ */
        @keyframes pulseSlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }
        .timer-warning { color: #dc2626; animation: pulseSlow 1s ease-in-out infinite; }

        /* Êñ∞Â¢ûÔºöÊåâÈàïÊä¨ÂçáËàáÂæÆ‰∫íÂãï */
        .interactive {
            transition: transform 160ms ease, box-shadow 200ms ease, background-color 200ms ease, color 200ms ease;
        }
        .interactive:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .interactive:active { transform: translateY(0); box-shadow: 0 2px 6px rgba(0,0,0,0.12); }

        /* ‰∏ã‰∏ÄËº™ÊåâÈàïÔºöÂ∞∫ÂØ∏+10% ‰∏¶Âä†ÂÖ•Âê∏ÂºïÈªûÊìäÁöÑÊüîÂíåËÑàÂãïËàáÂÖâÊöà */
        .next-round-button {
            border-radius: 1rem; /* Ëàá rounded-2xl Â∞çÈΩä */
            position: relative;
            transition: transform 180ms ease, box-shadow 240ms ease, filter 240ms ease;
            animation: nextRoundPulse 1.25s ease-in-out infinite;
        }
        .next-round-button:hover {
            box-shadow: 0 16px 40px rgba(14,165,233,0.6), 0 0 0 2px rgba(255,255,255,0.24) inset;
            filter: brightness(1.1);
        }
        .next-round-button:active {
            transform: translateY(0) scale(1.02);
        }
        /* Â§ñÁí∞ÂÖâÊöàÔºàÈùû transform ÂãïÁï´ÔºåÈÅøÂÖçËàá hover Á∏ÆÊîæË°ùÁ™ÅÔºâ */
        .next-round-button::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 125%;
            height: 150%;
            border-radius: 1.2rem;
            pointer-events: none;
            background: radial-gradient(closest-side, rgba(14,165,233,0.5), rgba(14,165,233,0) 74%);
            opacity: 0.0;
            animation: nextRoundGlow 1.5s ease-in-out infinite;
        }
        @keyframes nextRoundPulse {
            0%, 100% { box-shadow: 0 12px 26px rgba(14,165,233,0.46); }
            50% { box-shadow: 0 20px 46px rgba(14,165,233,0.78); }
        }
        @keyframes nextRoundGlow {
            0%, 100% { opacity: 0.38; }
            50% { opacity: 0.78; }
        }

        /* Â∞çÊà∞Ê®°ÂºèÁ©çÂàÜÂç°ÁâáÊ®£Âºè */
        #battleScoreboard { pointer-events: none; }
        #battleScoreboard .player-score-card { pointer-events: auto; }
        .player-score-card {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem;
            border-radius: 1.25rem; /* 20px */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            text-align: center;
        }

        .player-score-card.active {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.9);
            animation: pulse-gentle 1.5s infinite;
        }
        
        /* 6Áßç‰∏çÂêåÁöÑÁé©ÂÆ∂‰∏ªÈ¢òËâ≤ (ËÉåÊôØÊ∏êÂèò) */
        .player-theme-1 { background: linear-gradient(180deg, rgba(142, 68, 173, 0.3), rgba(142, 68, 173, 0.1)); } /* Á¥´ */
        .player-theme-2 { background: linear-gradient(180deg, rgba(41, 128, 185, 0.3), rgba(41, 128, 185, 0.1)); } /* Ëìù */
        .player-theme-3 { background: linear-gradient(180deg, rgba(39, 174, 96, 0.3), rgba(39, 174, 96, 0.1)); } /* Áªø */
        .player-theme-4 { background: linear-gradient(180deg, rgba(241, 196, 15, 0.3), rgba(241, 196, 15, 0.1)); } /* ÈªÑ */
        .player-theme-5 { background: linear-gradient(180deg, rgba(230, 126, 34, 0.3), rgba(230, 126, 34, 0.1)); } /* Ê©ô */
        .player-theme-6 { background: linear-gradient(180deg, rgba(192, 57, 43, 0.3), rgba(192, 57, 43, 0.1)); } /* Á∫¢ */

        .player-theme-1.active { box-shadow: 0 0 30px rgba(142, 68, 173, 0.8); }
        .player-theme-2.active { box-shadow: 0 0 30px rgba(41, 128, 185, 0.8); }
        .player-theme-3.active { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8); }
        .player-theme-4.active { box-shadow: 0 0 30px rgba(241, 196, 15, 0.8); }
        .player-theme-5.active { box-shadow: 0 0 30px rgba(230, 126, 34, 0.8); }
        .player-theme-6.active { box-shadow: 0 0 30px rgba(192, 57, 43, 0.8); }

        .player-name {
            font-family: 'modern', 'KaiTi', sans-serif;
            font-weight: 700;
            font-size: 1.25rem; 
            color: #1F2937; /* Ê∑±ÁÅ∞Ëâ≤ÔºåÊèêÈ´òÂØπÊØîÂ∫¶ */
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.2);
        }
        
        .player-score {
            font-family: 'modern', sans-serif;
            font-size: 2.25rem;
            font-weight: 900;
            color: #FFFFFF;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5); /* Âä†Ê∑±Èò¥ÂΩ± */
        }

        .current-turn-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background-color: #34D399; /* È≤úÁªøËâ≤ÊåáÁ§∫ÁÅØ */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px #34D399, 0 0 20px #34D399;
            animation: pulse-gentle 1.5s infinite;
        }

        @keyframes pulse-gentle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        /* Êñ∞Â¢ûÔºöÂ≠óÂç°ÂæÆÂãïÊïàËàáÈªûÊìäÊ≥¢Á¥ãÂÆπÂô® */
        .character-btn {
            position: relative; overflow: hidden;
            transition: transform 120ms ease, box-shadow 180ms ease, background-color 180ms ease, color 180ms ease;
        }
        .character-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.10); }
        .character-btn:active { transform: translateY(0); }
        .character-btn:disabled { transform: none !important; box-shadow: none !important; }

        /* ÈÅ©Â∫¶ÊîæÂ§ßÊ°åÈù¢Á´ØÂæÖÈÅ∏Â≠óÔºå‰∏çÊîπpaddingÔºåÈÅøÂÖçÂΩ±ÈüøÈªûÊìäËàáÊéíÁâà */
        .character-btn.char-modern { font-size: 1.75rem; line-height: 1; }
        @media (min-width: 768px) {
            .character-btn.char-modern { font-size: 2rem; }
        }

        /* Êñ∞Â¢ûÔºöÈªûÊìäÊ≥¢Á¥ã */
        .ripple {
            position: absolute; border-radius: 9999px; transform: translate(-50%, -50%);
            background: rgba(59, 121, 96, 0.25); pointer-events: none; width: 10px; height: 10px;
            animation: ripple 600ms ease-out forwards;
        }
        @keyframes ripple {
            from { opacity: 0.35; transform: translate(-50%, -50%) scale(1); }
            to { opacity: 0; transform: translate(-50%, -50%) scale(16); }
        }
    </style>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;600;700&display=swap');
        
        /* Ëá™ÂÆö‰πâÂ≠ó‰ΩìÊ†∑Âºè - ‰ΩøÁî®Êõ¥ÈÄöÁî®ÁöÑÂ≠ó‰ΩìÂ†ÜÊ†à */
        .font-title {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'STHeiti', 'SimHei', 'Heiti SC', 'Noto Sans CJK SC', 'Source Han Sans SC', sans-serif;
            font-weight: 700;
        }
        
        .font-text {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'STHeiti', 'SimHei', 'Heiti SC', 'Noto Sans CJK SC', 'Source Han Sans SC', sans-serif;
        }
        
        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #C03A5C;
            border-radius: 4px;
        }
        
        /* ‰∏≠ÂõΩ‰º†ÁªüË£ÖÈ•∞ËæπÊ°Ü */
        .border-chinese {
            border-image: url('https://cdn.jsdelivr.net/gh/ant-design/ant-design@4.10.0/components/style/color/images/colorPalette.less') 30 stretch;
        }
        
        /* Ê∞¥Â¢®È£éÊ†ºËÉåÊôØ */
        .bg-chinese-light {
            background-color: #f9f5e9;
            background-image: 
                linear-gradient(rgba(249, 245, 233, 0.7), rgba(249, 245, 233, 0.7)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23C03A5C' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .bg-chinese-dark {
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(26, 26, 26, 0.7), rgba(26, 26, 26, 0.7)),
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23C03A5C' fill-opacity='0.12' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* ‰∏≠ÂõΩÈ£éÁ∫∏Âº†ÊïàÊûú */
        .paper-effect {
            background-color: #FFF6E5; /* ÊöñÂÆ£Á¥ô */
            box-shadow: 0 6px 18px rgba(12, 16, 39, 0.08);
            position: relative;
            border: 1px solid rgba(46, 125, 109, 0.18);
        }
        
        .paper-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M77 63a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm-50-3a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm2-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm48-3a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 3a6 6 0 1 1 0-12 6 6 0 0 1 0 12z' fill='%23000000' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
            z-index: 0;
        }
        
        .paper-effect > * {
            position: relative;
            z-index: 1;
        }
        
        .dark .paper-effect {
            background-color: #2a2a2a;
        }

        /* Âç∞Á´†ÊïàÊûú */
        .seal {
            position: relative;
        }
        
        .seal::after {
            content: "Ë©©";
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'STHeiti', 'SimHei', sans-serif;
            color: rgba(192, 58, 92, 0.50);
            font-size: 2.5rem;
            font-weight: bold;
            transform: rotate(-15deg);
            border: 2px solid rgba(192, 58, 92, 0.50);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }
        
        /* ÊØõÁ¨îÂÖâÊ†áÊïàÊûú - ‰ΩøÁî®ÁªèËøáBase64ÁºñÁ†ÅÁöÑÂÜÖÂµåÊØõÁ¨îÂõæÊ†á */
        .character-btn, 
        #clearSelection, 
        #submitPoem, 
        #nextRound,
        #adminModeToggle,
        #saveCustomPoem,
        button,
        select,
        a {
            cursor: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAF8WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMDgtMDhUMTA6MTA6MDcrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjExZDYwN2VkLTM0NzAtNGRhOC1hZTBmLTU2YTRhNmEyNWVkMCIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjE3YmRlN2E4LWZjMmMtM2I0Zi05NWJlLWIyYWZjYzA2YmExNSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjc1ODRkNTJhLTY5MDUtNGI0OS1iNTBkLTk0OTEwNGU2ZWI1ZCI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6NzU4NGQ1MmEtNjkwNS00YjQ5LWI1MGQtOTQ5MTA0ZTZlYjVkIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEwOjA3KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MTFkNjA3ZWQtMzQ3MC00ZGE4LWFlMGYtNTZhNGE2YTI1ZWQwIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6s3PW0AAAGS0lEQVRYhe2XW2wc1RnHf+fM7M7O7K69u77EMSROY1yTUiUlJCqElqZQXCmKVBrCrYAqSEiAhMQD4oHS9AklXngBISQEVYAXArRRaZuWAiIoUFWlSvNAAoi6SRwIie/r9e7s7F7m8jC21zHeLeqL9H87c77zne87/++c811QVW5kWDeUHuiP5bGzEsxB7NzLXgm8yF5xt57y1r0zGG4+lLrF+UNvtkEPIhLhcxfFT5Y6K98OOF58Y6TlXa+jNOvBLPxYsOeW1xoATZZs5Pl75M+RP4mWNKVadlvQwuWiZrOHVPW9T9VH2b9nIzAA6Jx/ILpRRH4GbEUxPLM5V/cAXm3LXtPO/9Yd6+sKF/xbX4wOb/pDYs9xWA/8+Mujw6LWVWDzBxeLNwzHi+FYYYdv+28B3UFjzVbTiO3oLK0rXfWQUv4vCDR9D+cXhWJhXW2K9qbG3JpGj5sA/T85kQJ2M3OcsgmBnQ3ZrmVEq7/PwtJYrj8Zs9LLW3l5aMPIJT8Cze8M16LJHQqra5d6wuH0WjEi24AO4J++NXRxf+bEbVvTO7uGwhPpBw+mF2/JjKdP6+mdnxnY2gS0AxTyZC70MG//M8nBhkM9Dy5Jnz5QUV8E2AhsSpcCbYNHD84fTh+y4tFHXduevCbRz4iAKt4DJxBjh2fZvyQSjUvU2gwUgIuhTLlHKKFEASzHsYJQpqqyEkh9GsKMoHLDuVXhOPzH7Og7ApkxAI/rAKAjF4+sL9dGPz1/KrjVqxmn4T0P8O56j6qf/3BKy+5/psvNe1y3qCJmYxlxdZtv2wcB9m7fGwU2ASXgjB3PvdPqvbmuPLDmGRG5M0i9FjWX1aWiSybLt3yDhZ8+ghEKzajyZXTHXG+OBJZVzwL0p8f2Ae3V7YTHxhrKIzU5NTQPoFYg56ta0eaHjnH60XpO/KCO/ptixCpiJFsW0frTp6nYfFfs7Fu4KvFEAEZfRaWJPVmQEJ7j3NObOQvQxHIZcLtKhYjBttfV1lY9N3qXEat/JTOe/XD3QAfBLUd8EZEFzCRUAPU6B/+XkZoM9LTnzw+uKxX94pDLXX3p2pnNxqMN09vu5SIg0nj4Xag+D6SCnTlU4GBDrr7Pc/aV6Ww96Tgf7R5qebB3aXB9hk+I6jjyP4kIBsYd0ZpLxejQYxhjIZ5iiYMKgD4gvGfbFgF5GDAAz0/mxsJpY6iISBeXdEZK3qmx7KeEq+gD/8kEUHnddg1uVaEawRiXQ/s1FPX/2P3G3c9XPnEfWFegxPHh7IXyVNLu/VBD7ePMvlAF0NKV3OC7Xut0t2cbn9R0d/uIXDx4+U9/vvOJc2xnTUoiG2bYAgLbDtwcXgcVwqwXHiOw3cuzNTKwLAV9z+S19iQv9Ldk2yZ8/VNvfbbd3zx5x9AjM3kA9G0ZwvB2A9a1Z0BwHLTU1ppL2I/3LPwDBwfb+z+/DP1v5FvDI8mF50cS55rKy9wWwpHLzhnPcbsV0WvSvUGgoihGBKIr1kBoCTC0GnStVNAYQnF3zx0QijMdGp8lZrP0lhUfhJrTGQBvMj2BcM1wXY/A4OTr75y+gvCsPpdZ8cKk0/ysb5d+ZRhjcaH1A0LLVwGUJsbGgbrrIqCaRMZOVZlRu+PfKxvbZoJHXvyZlkd+RaS6mUjDN4l1PUvLz56CQhLgHJCZTVL4GqiI0nA0vbBtjFgNhbE3MRYvksmb53fQev+vady0A3xFBTxnBLBOj5ze3ck9b2HbNcD8TxcYgTwqqKE9i7sG0g+NjBl7+hsWdHa08uLOteTa1qMa4BfTRFz4VhORMBOH3sOMVBGqnMf1k/jjTB0mIEtmdHCTCxgawAj6dMEVQsMGElW0Pfon3Pcp0M0q7vH0kZ+yM3UIcDeA/wFmJLRzcQNZNQGGU/3jw2M3leKB11oGGrJVw2nK9eDdFXZ93s89PpxpWJRVMZFrZ/lKsMCYihxMj51NjPVfbTw+4evKh6/K8M9DqICiXlPh3MTRjsUWqjQDGUH+BF+9XR/5rNbSHQA87QnVdEpEvgCiS+M+u2fH7v4bqgZoA30OAgLaIQB6vf8m+q9fwpcZdwCW+xvg/wHA/4vAjbiM/wJrDSl2bWPqbQAAAABJRU5ErkJggg==") 1 25, auto;
        }
        
        /* Á°Æ‰øùÈº†Ê†áÊÇ¨ÂÅúÁä∂ÊÄÅ‰∏ã‰πü‰ΩøÁî®ÊØõÁ¨îÂÖâÊ†á */
        .character-btn:hover,
        button:hover,
        select:hover,
        a:hover {
            cursor: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAF8WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNi4wLWMwMDIgNzkuMTY0NDYwLCAyMDIwLzA1LzEyLTE2OjA0OjE3ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMDgtMDhUMTA6MTA6MDcrMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjExZDYwN2VkLTM0NzAtNGRhOC1hZTBmLTU2YTRhNmEyNWVkMCIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjE3YmRlN2E4LWZjMmMtM2I0Zi05NWJlLWIyYWZjYzA2YmExNSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjc1ODRkNTJhLTY5MDUtNGI0OS1iNTBkLTk0OTEwNGU2ZWI1ZCI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6NzU4NGQ1MmEtNjkwNS00YjQ5LWI1MGQtOTQ5MTA0ZTZlYjVkIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEwOjA3KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIvPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MTFkNjA3ZWQtMzQ3MC00ZGE4LWFlMGYtNTZhNGE2YTI1ZWQwIiBzdEV2dDp3aGVuPSIyMDIwLTA4LTA4VDEwOjEyOjE5KzA4OjAwIiBzdEV2dDpzb2Z0d2FyZUFnZW50PSJBZG9iZSBQaG90b3Nob3AgMjEuMiAoTWFjaW50b3NoKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6s3PW0AAAGS0lEQVRYhe2XW2wc1RnHf+fM7M7O7K69u77EMSROY1yTUiUlJCqElqZQXCmKVBrCrYAqSEiAhMQD4oHS9AklXngBISQEVYAXArRRaZuWAiIoUFWlSvNAAoi6SRwIie/r9e7s7F7m8jC21zHeLeqL9H87c77zne87/++c811QVW5kWDeUHuiP5bGzEsxB7NzLXgm8yF5xt57y1r0zGG4+lLrF+UNvtkEPIhLhcxfFT5Y6K98OOF58Y6TlXa+jNOvBLPxYsOeW1xoATZZs5Pl75M+RP4mWNKVadlvQwuWiZrOHVPW9T9VH2b9nIzAA6Jx/ILpRRH4GbEUxPLM5V/cAXm3LXtPO/9Yd6+sKF/xbX4wOb/pDYs9xWA/8+Mujw6LWVWDzBxeLNwzHi+FYYYdv+28B3UFjzVbTiO3oLK0rXfWQUv4vCDR9D+cXhWJhXW2K9qbG3JpGj5sA/T85kQJ2M3OcsgmBnQ3ZrmVEq7/PwtJYrj8Zs9LLW3l5aMPIJT8Cze8M16LJHQqra5d6wuH0WjEi24AO4J++NXRxf+bEbVvTO7uGwhPpBw+mF2/JjKdP6+mdnxnY2gS0AxTyZC70MG//M8nBhkM9Dy5Jnz5QUV8E2AhsSpcCbYNHD84fTh+y4tFHXduevCbRz4iAKt4DJxBjh2fZvyQSjUvU2gwUgIuhTLlHKKFEASzHsYJQpqqyEkh9GsKMoHLDuVXhOPzH7Og7ApkxAI/rAKAjF4+sL9dGPz1/KrjVqxmn4T0P8O56j6qf/3BKy+5/psvNe1y3qCJmYxlxdZtv2wcB9m7fGwU2ASXgjB3PvdPqvbmuPLDmGRG5M0i9FjWX1aWiSybLt3yDhZ8+ghEKzajyZXTHXG+OBJZVzwL0p8f2Ae3V7YTHxhrKIzU5NTQPoFYg56ta0eaHjnH60XpO/KCO/ptixCpiJFsW0frTp6nYfFfs7Fu4KvFEAEZfRaWJPVmQEJ7j3NObOQvQxHIZcLtKhYjBttfV1lY9N3qXEat/JTOe/XD3QAfBLUd8EZEFzCRUAPU6B/+XkZoM9LTnzw+uKxX94pDLXX3p2pnNxqMN09vu5SIg0nj4Xag+D6SCnTlU4GBDrr7Pc/aV6Ww96Tgf7R5qebB3aXB9hk+I6jjyP4kIBsYd0ZpLxejQYxhjIZ5iiYMKgD4gvGfbFgF5GDAAz0/mxsJpY6iISBeXdEZK3qmx7KeEq+gD/8kEUHnddg1uVaEawRiXQ/s1FPX/2P3G3c9XPnEfWFegxPHh7IXyVNLu/VBD7ePMvlAF0NKV3OC7Xut0t2cbn9R0d/uIXDx4+U9/vvOJc2xnTUoiG2bYAgLbDtwcXgcVwqwXHiOw3cuzNTKwLAV9z+S19iQv9Ldk2yZ8/VNvfbbd3zx5x9AjM3kA9G0ZwvB2A9a1Z0BwHLTU1ppL2I/3LPwDBwfb+z+/DP1v5FvDI8mF50cS55rKy9wWwpHLzhnPcbsV0WvSvUGgoihGBKIr1kBoCTC0GnStVNAYQnF3zx0QijMdGp8lZrP0lhUfhJrTGQBvMj2BcM1wXY/A4OTr75y+gvCsPpdZ8cKk0/ysb5d+ZRhjcaH1A0LLVwGUJsbGgbrrIqCaRMZOVZlRu+PfKxvbZoJHXvyZlkd+RaS6mUjDN4l1PUvLz56CQhLgHJCZTVL4GqiI0nA0vbBtjFgNhbE3MRYvksmb53fQev+vady0A3xFBTxnBLBOj5ze3ck9b2HbNcD8TxcYgTwqqKE9i7sG0g+NjBl7+hsWdHa08uLOteTa1qMa4BfTRFz4VhORMBOH3sOMVBGqnMf1k/jjTB0mIEtmdHCTCxgawAj6dMEVQsMGElW0Pfon3Pcp0M0q7vH0kZ+yM3UIcDeA/wFmJLRzcQNZNQGGU/3jw2M3leKB11oGGrJVw2nK9eDdFXZ93s89PpxpWJRVMZFrZ/lKsMCYihxMj51NjPVfbTw+4evKh6/K8M9DqICiXlPh3MTRjsUWqjQDGUH+BF+9XR/5rNbSHQA87QnVdEpEvgCiS+M+u2fH7v4bqgZoA30OAgLaIQB6vf8m+q9fwpcZdwCW+xvg/wHA/4vAjbiM/wJrDSl2bWPqbQAAAABJRU5ErkJggg==") 1 25, pointer;
        }
        
        /* Á¶ÅÁî®Áä∂ÊÄÅ‰ªçÁÑ∂‰ΩøÁî®ÈªòËÆ§ÂÖâÊ†á */
        .character-btn:disabled {
            cursor: not-allowed;
        }
        
        /* iframeÁí∞Â¢ÉÂÑ™Âåñ */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari Âú® iframe ‰∏≠ÁöÑÁâπÊÆäËôïÁêÜ */
            html, body {
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                -webkit-overflow-scrolling: touch;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
            }
        }
        
        /* Âº∑Âà∂ÂÖÉÁ¥†‰∏çË∂ÖÂá∫ÈÇäÁïå */
        * {
            box-sizing: border-box;
        }
        
        /* Á¢∫‰øùÂ≠óÁ¨¶ÊåâÈàïÂèØÈªûÊìä */
        .character-btn {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ÁßªÂãïÁ´ØiframeÂÖ®Â±èÂÑ™Âåñ */
        @media (max-width: 768px) {
            /* ‰∏ªÂÆπÂô®ÂÑ™Âåñ */
            .max-w-5xl {
                padding: 0.25rem !important;
                height: 100vh !important;
                height: 100dvh !important;
            }

            /* Â§¥ÈÉ®Âå∫ÂüüÂéãÁº© */
            .flex.justify-between.items-center.mb-3 {
                margin-bottom: 0.5rem !important;
            }

            /* Ê†áÈ¢òÂå∫ÂüüÂéãÁº© */
            .font-title {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* ÊéßÂà∂ÊåâÈíÆÂå∫ÂüüÂéãÁº© */
            .flex.items-center.justify-end.space-x-2.mb-2 {
                margin-bottom: 0.25rem !important;
            }

            /* ËØóÂè•ÊòæÁ§∫Âå∫Âüü‰ºòÂåñ */
            .paper-effect.p-3.rounded-lg.shadow-md.border.border-secondary\/30.seal {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Ê±âÂ≠óÈÄâÊã©Âå∫ÂüüÊ†áÈ¢òÂéãÁº© */
            #charactersGrid + div h2 {
                font-size: 1rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Â≠óÁ¨¶ÊåâÈíÆÂ§ßÂ∞èË∞ÉÊï¥ */
            .character-btn {
                padding: 0.5rem !important;
                font-size: 1.25rem !important;
            }

            /* ËØóÊ≠åÊòæÁ§∫Ê°ÜÁßªÂä®Á´Ø‰ºòÂåñ - ‰øùÊåÅ‰∏ÄË°åÈ´òÂ∫¶ */
            #poemDisplay {
                font-size: 1.25rem !important;
                height: 2.5rem !important;
                line-height: 2.5rem !important;
                padding: 0.25rem !important;
                overflow: hidden !important;
                white-space: nowrap !important;
            }

            /* ÊåâÈíÆÂå∫ÂüüÂéãÁº© */
            .flex.justify-center.space-x-20.mt-4 {
                margin-top: 0.5rem !important;
                gap: 1rem !important;
            }

            .flex.justify-center.space-x-20.mt-4 button {
                padding: 0.5rem 1rem !important;
                font-size: 1rem !important;
            }

            /* Â≠óÁ¨¶ÁΩëÊ†º‰ºòÂåñ - Á°Æ‰øùÊòæÁ§∫3Ë°åÔºåÂéªÊéâÊªöÂä®Êù° */
            #charactersGrid {
                grid-template-rows: repeat(3, 1fr) !important;
                gap: 0.25rem !important;
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 4px !important;
            }

            /* Ê±âÂ≠óÈÄâÊã©Âå∫ÂüüÂÆπÂô®‰ºòÂåñ */
            .paper-effect.p-3.rounded-lg.shadow-md.border.border-secondary\/30 {
                overflow: visible !important;
                max-height: none !important;
            }

            /* Ê∏∏ÊàèÊ∂àÊÅØÂå∫ÂüüÁßªÂä®Á´Ø‰ºòÂåñ */
            #gameMessage {
                width: 95vw !important;
                top: 50% !important;
                left: 50% !important;
            }

            #gameMessage .glass-card-strong {
                padding: 1rem !important;
            }

            #correctAnswer {
                font-size: 2rem !important; /* ÁßªÂä®Á´ØÈÄÇ‰∏≠Â§ßÂ∞è */
                padding: 0.75rem !important;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπïËøõ‰∏ÄÊ≠•‰ºòÂåñ */
        @media (max-width: 480px) {
            .character-btn {
                padding: 0.375rem !important;
                font-size: 1.125rem !important;
            }

            #poemDisplay {
                font-size: 1.125rem !important;
                height: 2.25rem !important;
                line-height: 2.25rem !important;
                overflow: hidden !important;
                white-space: nowrap !important;
            }

            .font-title {
                font-size: 1.25rem !important;
            }
        }

        /* Áé∞‰ª£ÂåñÂä®ÁîªÊïàÊûú */
        @keyframes slideUp {
            0% { 
                transform: translateY(20px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes bounceGentle {
            0%, 100% { 
                transform: translateY(0); 
            }
            50% { 
                transform: translateY(-4px); 
            }
        }

        @keyframes pulseModern {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.03);
                opacity: 0.9;
            }
        }

        /* ÊµÆÁ™ó‰∏ìÁî®Âä®Áîª */
        @keyframes modalSlideIn {
            0% { 
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes modalSlideOut {
            0% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }
        }

        /* ÁéªÁíÉÊãüÊÄÅÊïàÊûú */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-card-strong {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Ë®≠ÁΩÆÊ®°ÊÖãÁ™óÂè£ - Áèæ‰ª£ÁéªÁíÉÊì¨ÊÖãËàáÊõ¥È´òÂ∞çÊØî */
        .glass-modal {
            background: linear-gradient(180deg, rgba(255,255,255,0.94), rgba(255,255,255,0.88));
            backdrop-filter: blur(24px) saturate(120%);
            -webkit-backdrop-filter: blur(24px) saturate(120%);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.18);
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè - ÈÄÇÈÖç‰ΩéÈÄèÊòéÂ∫¶ËÉåÊôØ */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.3) transparent;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
            background-clip: content-box;
        }

        /* Áé∞‰ª£ÂåñÊåâÈíÆÊïàÊûú */
        .modern-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .modern-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Â≠óÁ¨¶ÊåâÈíÆÁé∞‰ª£Âåñ */
        .char-modern {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .char-modern:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.95);
        }

        /* Ê∏êÂèòËÉåÊôØ */
        .gradient-bg {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
        }

        .gradient-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #22c55e 0%, #4ade80 100%);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }

        /* AI Ëß£ËÆÄÂ∞àÁî®Ê®£ÂºèÔºåËàá‰∏ªÊåâÈàïËâ≤Á≥ªÂçÄÂàÜ‰∏îÂçîË™ø */
        .ai-explain-button {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #111827;
        }
        .ai-explain-button:hover { filter: brightness(1.05); }
        .ai-explain-loading { opacity: 0.7; pointer-events: none; }

        /* AI ÂÖßÂÆπÁæéÂåñ */
        .ai-section {
            border-radius: 1rem;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(14px);
            padding: 12px 14px;
        }
        .ai-title {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 0.9rem;
            color: #0f172a;
            background: linear-gradient(135deg, #e0f2fe, #fae8ff);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 999px;
            padding: 4px 10px;
            margin-bottom: 8px;
        }
        .ai-body { color: #0f172a; line-height: 1.7; font-size: 0.95rem; }
        .ai-poem-block {
            white-space: pre-wrap;
            font-family: ui-serif, Georgia, "Noto Serif CJK TC", serif;
            font-size: 1rem;
            color: #0f172a;
            background: rgba(255,255,255,0.75);
            border: 1px dashed rgba(15,23,42,0.2);
            border-radius: 0.75rem;
            padding: 10px 12px;
        }
        .ai-highlight {
            background: linear-gradient(180deg, rgba(250,204,21,0.45), rgba(250,204,21,0.15));
            border-radius: 8px;
            padding: 0 4px;
            font-weight: 800;
            color: #92400e;
        }
        .ai-toggle {
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #0f172a;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 999px;
            padding: 6px 10px;
        }

        /* AI ËºâÂÖ•ÂãïÁï´ */
        @keyframes aiSpin { to { transform: rotate(360deg); } }
        .ai-loading-wrap { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 18px 0; }
        .ai-spinner {
            width: 28px; height: 28px; border-radius: 9999px;
            border: 3px solid rgba(15,23,42,0.15);
            border-top-color: #8b5cf6; /* Ëàá accent ÂçîË™ø */
            animation: aiSpin 1s linear infinite;
        }
        .ai-loading-text { margin-top: 10px; font-size: 0.9rem; color: #334155; }

        /* Â∞çÊà∞ÁµêÊûúÁ™óÂè£ÁæéÂåñ */
        #battleResultModal .winner-card {
            position: relative;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.22), rgba(255, 165, 0, 0.12));
            border: 2px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 12px 32px rgba(212, 163, 0, 0.25);
            overflow: hidden;
        }
        #battleResultModal .winner-card::after {
            content: "";
            position: absolute;
            left: -60%;
            top: -50%;
            width: 60%;
            height: 200%;
            transform: rotate(25deg);
            background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.35), rgba(255,255,255,0.0));
            animation: winnerShine 2.6s ease-in-out infinite;
        }
        @keyframes winnerShine {
            0% { left: -60%; }
            60% { left: 120%; }
            100% { left: 120%; }
        }

        #battleResultModal .rank-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.9rem;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(17, 24, 39, 0.08);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
            opacity: 0;
            transform: translateY(10px);
            animation: slideIn 540ms ease-out forwards;
        }

        #battleResultModal .rank-item:hover {
            transform: translateY(0) scale(1.01);
            box-shadow: 0 16px 28px rgba(0,0,0,0.14);
        }

        #battleResultModal .rank-medal { font-size: 1.25rem; }
        #battleResultModal .rank-name { color: #0f172a; font-weight: 700; }
        #battleResultModal .rank-score { margin-left: auto; font-weight: 800; color: #0f172a; }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'XiqueGuZiDian';
            src: url('https://chineseclassics.github.io/files/fonts/%E5%96%9C%E9%B9%8A%E5%8F%A4%E5%AD%97%E5%85%B8%E4%BD%93(%E7%AE%80+%E7%B9%81%E4%BD%93).ttf') format('truetype');
            font-display: swap;
        }
        @font-face {
            font-family: 'HuaKangGuJiMiLiuGBK';
            src: url('https://chineseclassics.github.io/files/fonts/%E5%8D%8E%E5%BA%B7%E5%8F%A4%E7%B1%8D%E7%B3%B8%E6%9F%B3GBK.TTF') format('truetype');
            font-display: swap;
        }
        .font-xique-guzidian {
            font-family: 'XiqueGuZiDian', serif;
        }
        .font-huakang-miliu {
            font-family: 'HuaKangGuJiMiLiuGBK', serif;
        }
        .font-ma-shan-zheng {
            font-family: 'Ma Shan Zheng', cursive;
        }
    </style>
</head>
<body class="font-modern gradient-bg" style="margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; display: flex; flex-direction: column;">
    <div class="max-w-5xl mx-auto" style="height: 100%; width: 100%; display: flex; flex-direction: column; padding: 6px; box-sizing: border-box; position: relative;">
        <!-- ÈÅ∏ÊâãÁ©çÂàÜÈ°ØÁ§∫ÂçÄÂüüÔºàÂ∑¶Âè≥ÂÖ©ÂÅ¥Âõ∫ÂÆöÔºâ -->
        <div id="battleScoreboard" class="hidden z-10">
            <!-- Â∑¶ÂÅ¥ÈÅ∏ÊâãÁ©çÂàÜÔºàÂõ∫ÂÆöÂú®Â∑¶Ôºâ -->
            <div id="leftPlayers" class="fixed left-2 top-1/2 -translate-y-1/2 flex flex-col space-y-2 w-40"></div>
            
            <!-- Âè≥ÂÅ¥ÈÅ∏ÊâãÁ©çÂàÜÔºàÂõ∫ÂÆöÂú®Âè≥Ôºâ -->
            <div id="rightPlayers" class="fixed right-2 top-1/2 -translate-y-1/2 flex flex-col space-y-2 w-40"></div>
        </div>
        <div class="flex justify-between items-center mb-3">
            <!-- Â∑¶‰æßÂæóÂàÜ/Ëº™Ê¨°ÊòæÁ§∫ - Áé∞‰ª£Âåñ -->
            <div class="glass-card p-3 sm:p-4 rounded-2xl flex items-center animate-slide-up modern-button" style="animation-delay:40ms">
                <span id="scoreLabel" class="font-modern text-sm sm:text-base text-surface-800 font-medium">ÂàÜÊï∏</span>
                <span id="score" class="text-2xl sm:text-4xl font-bold text-primary-500 ml-2 sm:ml-3">0</span>
            </div>
            
            <!-- ‰∏≠Èó¥Ê†áÈ¢ò - Áé∞‰ª£Âåñ -->
            <div class="flex-grow flex flex-col items-center justify-center mx-3 relative animate-slide-up" style="animation-delay:80ms">
                <!-- Ê∏∏ÊàèÊ†áÈ¢ò -->
                <div class="flex-grow flex items-center justify-center">
                    <h1 class="text-3xl sm:text-4xl text-black font-huakang-miliu font-black leading-none" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.2);">ÂçóÈ¢®Ë©©Ë©ûÁµÑÂè•</h1>
                </div>
                
                <!-- ÂâØÊ†áÈ¢ò -->
                <div class="text-xs text-surface-800/70 mt-1 font-modern tracking-wide">
                    ‰∏≠ÊñáÁ∂ìÂÖ∏AIÂØ¶È©óÂÆ§
                </div>
            </div>
            
            <!-- Âè≥‰æßÂÄíËÆ°Êó∂ - Áé∞‰ª£Âåñ -->
            <div class="glass-card-strong p-3 sm:p-4 rounded-2xl flex items-center animate-slide-up modern-button gradient-accent" style="animation-delay:120ms">
                <span id="timer" class="text-2xl sm:text-4xl font-bold text-white font-modern">30</span>
                <span class="font-modern text-sm sm:text-base text-white/90 ml-1 font-medium">Áßí</span>
            </div>
        </div>
        
        <!-- ÂÄíË®àÊôÇÈÄ≤Â∫¶Ê¢ù / Ë≥ΩÈÅìÂÆπÂô® -->
        <div id="timeBarContainer" class="w-full h-6 sm:h-7 bg-surface-200 rounded-full overflow-hidden mb-3 animate-scale-in shadow-inner relative">
            <div id="timeBarFill" class="h-full gradient-primary rounded-full transition-all duration-300 ease-out" style="width: 100%"></div>
            <!-- ÈÅ†Á®ã/Êú¨Âú∞Â∞çÊà∞ÔºöË≥ΩÈÅìË¶ñÂúñÔºàÊôÇÈñìÊ¢ù‰∏äÂ±§Ë¶ÜËìãÔºâ -->
            <div id="raceTrack" class="absolute inset-0 hidden px-1 flex items-center gap-1"></div>
        </div>
        
        <div class="flex items-center justify-end space-x-3 mb-2">
            <div id="difficultySelector" class="inline-block glass-card px-3 py-2 rounded-xl hidden animate-slide-up">
                <span class="font-modern text-xs text-surface-800 mr-2 font-medium">Èõ£Â∫¶Ôºö</span>
                <select id="difficultySelect" class="bg-white/90 rounded-lg px-3 py-1 text-xs border-none focus:ring-2 focus:ring-primary-400 font-modern">
                    <option value="easy">Á∞°ÂñÆ</option>
                    <option value="medium" selected>‰∏≠Á≠â</option>
                    <option value="hard">Âõ∞Èõ£</option>
                </select>
            </div>
            <button id="soundToggle" class="glass-card hover:glass-card-strong text-surface-800 px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                </svg>
                Èü≥ÊïàÈñã
            </button>
            <button id="localBattleBtn" class="glass-card hover:glass-card-strong text-white px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern bg-gradient-to-r from-secondary-500 to-secondary-600 border-none shadow-md transform transition-transform hover:scale-105">
                <span class="mr-1.5">üë•</span>
                Êú¨Âú∞Â∞çÊà∞
            </button>
            <button id="remoteBattleBtn" class="glass-card hover:glass-card-strong text-white px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern bg-gradient-to-r from-primary-500 to-accent-500 border-none shadow-md transform transition-transform hover:scale-105">
                <span class="mr-1.5">üåê</span>
                ÈÅ†Á®ãÂ∞çÊà∞
            </button>
            <button id="adminModeToggle" class="glass-card hover:glass-card-strong text-surface-800 px-3 py-2 rounded-xl text-xs flex items-center modern-button font-modern">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Ë®≠ÁΩÆ
            </button>
        </div>
        
        <!-- Â∞çÊà∞ÁµêÊùüÁ∏ΩÁµêÁ™óÂè£ -->
        <div id="battleResultModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(500px,90vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- Á™óÂè£Ê®ôÈ°å -->
                <div class="flex justify-center items-center p-6 border-b border-white/20 gradient-primary rounded-t-3xl flex-shrink-0">
                    <h2 class="text-2xl font-modern font-bold text-white">üèÜ Â∞çÊà∞ÁµêÊûú</h2>
                </div>
                
                <!-- ÂèØÊªöÂä®ÂÜÖÂÆπÂå∫Âüü -->
                <div class="overflow-y-auto custom-scrollbar flex-grow p-6">
                    <!-- Ëé∑ËÉúËÄÖÂç°Áâá -->
                    <div id="winnerCard" class="winner-card p-6 rounded-2xl text-center mb-6 transform transition-all duration-500 hover:scale-105">
                        <div class="text-2xl font-modern font-black mb-2 text-surface-900" id="winnerAnnouncement"></div>
                        <div class="text-lg font-modern font-semibold text-surface-700" id="winnerScore"></div>
                    </div>
            
                    <!-- ÈÄâÊâãÊéíË°åÊ¶ú -->
                    <div>
                        <h3 class="text-xl font-modern font-bold mb-4 text-center text-surface-900">üìä ÊúÄÁµÇÊéíË°åÊ¶ú</h3>
                        <div id="battleRankings" class="space-y-3">
                            <!-- ÊéíË°åÊ¶úÂ∞ÜÁî±JavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                
                <!-- Â∫ïÈÉ®ÊåâÈàï -->
                <div class="flex justify-center space-x-4 p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <button id="newBattleBtn" class="gradient-primary text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">
                        üîÑ ÂÜç‰æÜ‰∏ÄÂ±Ä
                    </button>
                    <button id="exitBattleBtn" class="glass-card text-surface-800 px-6 py-3 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">
                        üè† ÂõûÂà∞ÂñÆ‰∫∫Ê®°Âºè
                    </button>
                </div>
            </div>
        </div>

        <!-- Êú¨Âú∞Â∞çÊà∞Ê®°ÊÖãÁ™óÂè£ -->
        <div id="localBattleModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(600px,90vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- ÂΩàÁ™óÊ®ôÈ°å -->
                <div class="flex justify-between items-center p-6 border-b border-white/20 bg-gradient-to-r from-secondary-500 to-secondary-600 rounded-t-3xl flex-shrink-0">
                    <h2 class="text-2xl font-modern font-bold text-white">üë• Êú¨Âú∞Â∞çÊà∞Ë®≠ÁΩÆ</h2>
                    <button id="closeLocalBattleModal" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                
                <!-- ÂèØÊªöÂä®ÂÜÖÂÆπÂå∫Âüü -->
                <div class="overflow-y-auto custom-scrollbar flex-grow">
                    <!-- Ë®≠ÁΩÆÂÖßÂÆπ -->
                    <div class="p-6 space-y-6">
                        <!-- ÈÅ∏ÊâãË®≠ÁΩÆ -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">üë• ÈÅ∏ÊâãË®≠ÁΩÆ</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="font-modern text-sm text-surface-800">ÈÅ∏ÊâãÊï∏ÈáèÔºö</span>
                                    <select id="localPlayerCount" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern">
                                        <option value="2" selected>2ÂêçÈÅ∏Êâã</option>
                                        <option value="3">3ÂêçÈÅ∏Êâã</option>
                                        <option value="4">4ÂêçÈÅ∏Êâã</option>
                                        <option value="5">5ÂêçÈÅ∏Êâã</option>
                                        <option value="6">6ÂêçÈÅ∏Êâã</option>
                                        <option value="7">7ÂêçÈÅ∏Êâã</option>
                                        <option value="8">8ÂêçÈÅ∏Êâã</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-modern text-sm text-surface-800 mb-2 block">ÈÅ∏ÊâãÂêçÁ®±Ôºö</label>
                                    <div id="localPlayerNamesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <!-- ÈÅ∏ÊâãÂêçÁ®±Ëº∏ÂÖ•Ê°ÜÂ∞áÁî±JavaScriptÂãïÊÖãÁîüÊàê -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÊØîË≥ΩË®≠ÁΩÆ -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">üéÆ ÊØîË≥ΩË®≠ÁΩÆ</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between gap-3">
                                    <label for="localQuestionCount" class="font-modern text-sm text-surface-800">È°åÁõÆÊï∏Ôºö</label>
                                    <input id="localQuestionCount" type="number" min="5" max="100" value="10" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern w-28" />
                                </div>
                                <div class="flex items-center justify-between gap-3">
                                    <label for="localPoemSetSelect" class="font-modern text-sm text-surface-800">Ë©©Ë©ûÂ∫´Ôºö</label>
                                    <select id="localPoemSetSelect" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern flex-1">
                                        <!-- Ë©©Ë©ûÂ∫´ÈÅ∏È†ÖÂ∞áÁî±JavaScriptÂãïÊÖãÁîüÊàê -->
                                    </select>
                                </div>
                                <div class="flex items-center justify-between gap-3">
                                    <label for="localSpeedMode" class="font-modern text-sm text-surface-800">ÈÄüÂ∫¶Ê®°ÂºèÔºàÁ≠îÈ°åË∂äÂø´ÂæóÂàÜË∂äÈ´òÔºâ</label>
                                    <input id="localSpeedMode" type="checkbox" class="w-5 h-5 accent-secondary-600" />
                                </div>
                            </div>
                        </div>

                        <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
                        <div class="glass-card rounded-2xl p-4 border border-blue-200/60 bg-blue-50">
                            <h3 class="text-base font-modern font-semibold text-blue-700 mb-2">üí° ÈÅäÊà≤Ë™™Êòé</h3>
                            <ul class="text-sm font-modern text-blue-700 leading-relaxed space-y-1">
                                <li>‚Ä¢ ÈÅ∏ÊâãÂú®Âêå‰∏ÄÂè∞Ë®≠ÂÇô‰∏äËº™ÊµÅÁ≠îÈ°å</li>
                                <li>‚Ä¢ Á≠îÂ∞çÂæóÂàÜÔºåÁ≠îÈåØ‰∏çÊâ£ÂàÜ</li>
                                <li>‚Ä¢ ÊâÄÊúâÈ°åÁõÆÂÆåÊàêÂæåÁµ±Ë®àÊúÄÁµÇÊéíÂêç</li>
                                <li>‚Ä¢ ÊôÇÈñìÈôêÂà∂ÂíåÂæÖÈÅ∏Â≠óÊï∏ÈáèÂèØÂú®"Ë®≠ÁΩÆ"‰∏≠Ë™øÊï¥</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- ÂΩàÁ™óÂ∫ïÈÉ®ÊåâÈàï -->
                <div class="flex justify-end items-center p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <div class="flex space-x-3">
                        <button id="cancelLocalBattle" class="glass-card text-surface-800 px-6 py-3 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">
                            ÂèñÊ∂à
                        </button>
                        <button id="startLocalBattle" class="bg-gradient-to-r from-secondary-500 to-secondary-600 text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">
                            ÈñãÂßãÂ∞çÊà∞
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó -->
        <div id="settingsModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(600px,90vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- ÂΩàÁ™óÊ®ôÈ°å -->
                <div class="flex justify-between items-center p-6 border-b border-white/20 gradient-primary rounded-t-3xl flex-shrink-0">
                    <h2 class="text-2xl font-modern font-bold text-white">‚öôÔ∏è ÈÅäÊà≤Ë®≠ÁΩÆ</h2>
                    <button id="closeSettingsModal" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                
                <!-- ÂèØÊªöÂä®ÂÜÖÂÆπÂå∫Âüü -->
                <div class="overflow-y-auto custom-scrollbar flex-grow">
                    <!-- Ë®≠ÁΩÆÂÖßÂÆπ -->
                    <div class="p-6 space-y-6">
                        <!-- 1. Ë©©Ë©ûÂ∫´ÁÆ°ÁêÜ -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">üìö Ë©©Ë©ûÂ∫´ÁÆ°ÁêÜ</h3>
                            <div class="space-y-3">
                                <div class="p-3 rounded-xl bg-blue-50 border border-blue-200">
                                    <p class="text-xs font-modern text-blue-700">
                                        <span class="font-semibold">üí° Ë™™ÊòéÔºö</span>Ê≠§ËôïË©©Ë©ûÂ∫´ÈÅ∏ÊìáÂÉÖÂΩ±Èüø<span class="font-semibold">ÂñÆ‰∫∫Ê®°Âºè</span>„ÄÇÊú¨Âú∞Â∞çÊà∞ÂíåÈÅ†Á®ãÂ∞çÊà∞ÁöÑË©©Ë©ûÂ∫´ÂèØÂú®ÂêÑËá™ÁöÑÂ∞çÊà∞Ë®≠ÁΩÆ‰∏≠ÈÅ∏Êìá„ÄÇ
                                    </p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="text-sm font-modern text-surface-800">ÂñÆ‰∫∫Ê®°ÂºèË©©Ë©ûÂ∫´Ôºö</label>
                                    <select id="userLibraryTagSelect" class="glass-card rounded-lg px-3 py-1 border border-white/30 focus:ring-2 focus:ring-primary text-sm font-modern flex-1"></select>
                                </div>
                                <div class="pt-3 border-t border-white/20">
                                    <h4 class="text-sm font-modern font-semibold text-surface-700 mb-2">Ë©©Ë©ûÂ∫´Â∞éÂÖ•/Â∞éÂá∫</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="exportExcelBtn" class="glass-card text-surface-800 px-3 py-1.5 rounded-lg modern-button text-sm border border-white/30">Â∞éÂá∫ Excel</button>
                                        <button id="importExcelBtn" class="gradient-secondary text-white px-3 py-1.5 rounded-lg modern-button text-sm">Â∞éÂÖ• Excel</button>
                                        <input id="importExcelInput" type="file" accept=".xlsx,.xls,.csv" class="hidden" />
                                    </div>
                                    <p class="text-xs text-surface-600 mt-2">ÊèêÁ§∫ÔºöExcel Ê®°ÊùøÊ¨Ñ‰ΩçÁÇ∫ lineÔºàË©©Âè•Ôºâ„ÄÅauthorÔºà‰ΩúËÄÖÔºâ„ÄÅpoemÔºàË©©ÂêçÔºâ„ÄÅtagsÔºàÂèØÁî®‰∏≠ÊñáÂàÜËôü„ÄåÔºõ„ÄçÊàñ‰∏≠ÊñáÈÄóËôü„ÄåÔºå„ÄçÂàÜÈöîÔºõ‰∫¶ÊîØÊè¥Â§öÂàó tag1„ÄÅtag2...Ôºâ„ÄÇ</p>
                                </div>
                            </div>
                        
                            
                        </div>
            
                        <!-- 2. ÂÖ®Â±ÄÈÅäÊà≤ÂèÉÊï∏ -->
                        <div class="glass-card rounded-2xl p-4 border border-white/10">
                            <h3 class="text-lg font-modern font-semibold text-surface-800 mb-3">‚öôÔ∏è ÂÖ®Â±ÄÈÅäÊà≤ÂèÉÊï∏</h3>
                            <div class="p-3 rounded-xl bg-amber-50 border border-amber-200 mb-4">
                                <p class="text-xs font-modern text-amber-700">
                                    <span class="font-semibold">‚ö° Ë™™ÊòéÔºö</span>‰ª•‰∏ãË®≠ÁΩÆÂ∞áÂΩ±Èüø<span class="font-semibold">ÊâÄÊúâÊ®°Âºè</span>ÔºàÂñÆ‰∫∫„ÄÅÊú¨Âú∞Â∞çÊà∞„ÄÅÈÅ†Á®ãÂ∞çÊà∞Ôºâ„ÄÇ
                                </p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="p-3 rounded-xl bg-gradient-to-br from-white/80 to-blue-50 border border-gray-200 backdrop-blur-sm shadow-sm hover:shadow-md hover:ring-1 hover:ring-blue-200 transition">
                                    <label class="flex items-center justify-between text-sm font-modern font-medium mb-2 text-surface-800">
                                        <span>‚è±Ô∏è ÊôÇÈñìÈôêÂà∂</span>
                                        <span class="inline-flex items-center gap-1">
                                            <span id="timeLimitValue" class="font-semibold text-blue-600">30</span>
                                            <span class="text-xs text-surface-600">Áßí</span>
                                        </span>
                                    </label>
                                    <input type="range" id="timeLimit" min="10" max="60" step="5" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                    <div class="flex justify-between mt-1 text-sm text-surface-600">
                                        <span>10</span>
                                        <span>60</span>
                                    </div>
                                </div>
                                <div class="p-3 rounded-xl bg-gradient-to-br from-white/80 to-emerald-50 border border-gray-200 backdrop-blur-sm shadow-sm hover:shadow-md hover:ring-1 hover:ring-emerald-200 transition">
                                    <label class="flex items-center justify-between text-sm font-modern font-medium mb-2 text-surface-800">
                                        <span>üî£ ÂæÖÈÅ∏Â≠óÊï∏Èáè</span>
                                        <span class="inline-flex items-center gap-1">
                                            <span id="charCountValue" class="font-semibold text-emerald-600">20</span>
                                            <span class="text-xs text-surface-600">Â≠ó</span>
                                        </span>
                                    </label>
                                    <input type="range" id="charCount" min="10" max="30" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                    <div class="flex justify-between mt-1 text-sm text-surface-600">
                                        <span>10</span>
                                        <span>30</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÂΩàÁ™óÂ∫ïÈÉ®ÊåâÈàï -->
                <div class="flex justify-end items-center p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <div class="flex space-x-3">
                        <button id="cancelSettings" class="glass-card text-surface-800 px-6 py-3 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">
                            ÂèñÊ∂à
                        </button>
                        <button id="saveSettings" class="gradient-primary text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">
                            ‰øùÂ≠òË®≠ÁΩÆ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∞çÊà∞Ê®°ÂºèÈñãÂ†¥È†êË¶Ω -->
        <div id="battlePreviewModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/40 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(640px,92vw)] max-h-[88vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-white/20 gradient-accent rounded-t-3xl flex-shrink-0">
                    <div>
                        <h2 class="text-2xl font-modern font-bold text-white">‚öîÔ∏è Â∞çÊà∞Âç≥Â∞áÈñãÂßã</h2>
                        <p class="text-sm text-white/80 mt-1 font-modern">Á¢∫Ë™çÂèÉË≥ΩË≥áË®äÔºåÊ∫ñÂÇôËèØÈ∫óÁöÑË©©Ë©ûÂ∞çÊ±∫</p>
                    </div>
                    <button id="battlePreviewClose" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-grow p-6 space-y-5">
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">ÂèÉË≥ΩÈöä‰ºç</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-3xl font-bold text-primary-600" id="battlePreviewPlayerCount">0</span>
                                <span class="text-sm font-modern text-surface-700">‰ΩçÈÅ∏ÊâãËº™ÊµÅÊáâÊà∞</span>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">ÊØè‰ΩçÈ°åÊï∏</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-3xl font-bold text-secondary-600" id="battlePreviewRounds">0</span>
                                <span class="text-sm font-modern text-surface-700">È°åÔºèÈÅ∏Êâã</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">Á∏ΩÈ°åÊï∏</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-3xl font-bold text-amber-600" id="battlePreviewTotalQuestions">0</span>
                                <span class="text-sm font-modern text-surface-700">È°åÂç≥Â∞áÂá∫È°å</span>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-sm">
                            <h3 class="text-sm font-modern text-surface-600 mb-2">ÂõûÂêàË®≠ÂÆö</h3>
                            <div class="space-y-1 text-sm font-modern text-surface-700">
                                <div>Á≠îÈ°åÊôÇÈôêÔºö<span class="font-semibold text-surface-900" id="battlePreviewTimeLimit">0 Áßí</span></div>
                                <div>ÂæÖÈÅ∏Â≠óÊï∏Ôºö<span class="font-semibold text-surface-900" id="battlePreviewCharCount">0 Â≠ó</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/15 shadow-md">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-base font-modern font-semibold text-surface-800">ÂèÉË≥ΩÂêçÂñÆ</h3>
                            <span class="text-xs text-surface-500 font-modern">Â∞á‰æùÊ¨°‰∏äÂ†¥Á≠îÈ°å</span>
                        </div>
                        <div id="battlePreviewPlayersList" class="grid gap-3 sm:grid-cols-2"></div>
                    </div>
                    <div id="battlePreviewSpeedRow" class="glass-card rounded-2xl p-4 border border-accent-200/60 bg-accent-50 shadow-inner hidden">
                        <h3 class="text-base font-modern font-semibold text-accent-700 mb-2">‚è±Ô∏è ÈÄüÂ∫¶Ê®°ÂºèÂä†ÂàÜ</h3>
                        <p id="battlePreviewSpeedText" class="text-sm font-modern text-accent-700"></p>
                    </div>
                    <div class="glass-card rounded-2xl p-4 border border-white/15">
                        <h3 class="text-base font-modern font-semibold text-surface-800 mb-2">Â∞çÊà∞ÊèêÁ§∫</h3>
                        <p id="battlePreviewNote" class="text-sm font-modern text-surface-600 leading-relaxed"></p>
                    </div>
                </div>
                <div class="flex justify-between items-center p-6 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <button id="battlePreviewBack" class="glass-card text-surface-800 px-5 py-2.5 rounded-xl font-modern font-semibold border border-white/30 modern-button transform transition-transform hover:scale-105">ËøîÂõûË®≠ÁΩÆ</button>
                    <button id="battlePreviewStart" class="gradient-primary text-white px-6 py-3 rounded-xl font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">ÈñãÂßãÂ∞çÊà∞</button>
                </div>
            </div>
        </div>

        <!-- AI Ëß£ËÆÄÊ®°ÊÖãÂΩàÁ™ó -->
        <div id="aiExplainModal" class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
            <div class="glass-modal rounded-3xl shadow-2xl w-[min(680px,92vw)] max-h-[85vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
                <!-- Ê®ôÈ°åÂçÄ -->
                <div class="flex justify-between items-center p-5 border-b border-white/20 gradient-accent rounded-t-3xl flex-shrink-0">
                    <h2 class="text-xl font-modern font-bold text-white">‚ú® AI Ëß£ËÆÄ</h2>
                    <button id="aiExplainClose" class="text-white/90 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
                </div>
                <!-- ÂÖßÂÆπÂçÄ -->
                <div class="p-5 overflow-auto space-y-4">
                    <div class="glass-card rounded-2xl p-4">
                        <div class="text-xs font-modern text-surface-800/70 mb-1">Ë©©Âè•</div>
                        <div id="aiExplainLine" class="text-2xl font-kai font-bold text-primary-700"></div>
                        <div id="aiExplainMeta" class="text-xs font-modern text-surface-700 mt-1"></div>
                    </div>
                    <div id="aiExplainContent" class="font-modern text-surface-800 space-y-3"></div>
                    <div id="aiExplainError" class="hidden text-red-600 text-sm font-modern"></div>
                </div>
                <!-- Â∫ïÈÉ®ÊåâÈàï -->
                <div class="flex justify-end items-center gap-3 p-4 border-t border-white/20 glass-card rounded-b-3xl flex-shrink-0">
                    <button id="aiExplainReload" class="glass-card text-surface-800 px-4 py-2 rounded-xl font-modern font-semibold border border-white/30 modern-button">ÈáçÊñ∞ÁîüÊàê</button>
                    <button id="aiExplainOK" class="gradient-primary text-white px-5 py-2 rounded-xl font-modern font-semibold modern-button">ÈóúÈñâ</button>
                </div>
            </div>
        </div>

        <!-- ËØóÂè•ÊòæÁ§∫Âå∫Âüü - Áé∞‰ª£Âåñ -->
        <div class="glass-card-strong p-4 rounded-3xl mb-4 animate-slide-up" style="animation-delay:160ms">
            <!-- È¢òÁõÆ‰ΩúËÄÖ‰ø°ÊÅØÂíåÂ≠óÊï∞ - Âêå‰∏ÄË°åÊòæÁ§∫ -->
            <div class="text-center mb-5">
                <div class="inline-flex items-center space-x-6">
                    <!-- È¢òÁõÆ‰ΩúËÄÖ‰ø°ÊÅØ -->
                    <div id="poemHint" class="text-base md:text-lg font-kai font-bold px-5 py-3 rounded-2xl glass-card text-surface-800 transform transition-all duration-500 hover:scale-105 animate-pulse-modern modern-button"></div>
                    
                    <!-- Â≠óÊï∞ÊòæÁ§∫ -->
                    <div class="inline-flex items-center space-x-2">
                        <span id="charCountDisplay" class="text-xl font-modern font-black text-white bg-gradient-to-br from-accent-500 to-accent-600 rounded-full w-12 h-12 flex items-center justify-center shadow-lg animate-bounce-gentle modern-button"></span>
                        <span class="text-sm font-modern text-surface-800 font-semibold">Â≠ó</span>
            </div>
        </div>
            </div>
            
            <!-- ËØóÂè•ËæìÂÖ•Ê°Ü - Êõ¥Â§ßÂ≠ó‰ΩìÁé∞‰ª£Âåñ -->
            <div class="flex items-center justify-center mb-2">
                <div class="relative w-full">
                    <input id="poemDisplay" type="text" class="w-full px-4 rounded-2xl glass-card text-4xl font-kai font-bold text-center focus:outline-none text-surface-800 transition-all duration-300" readonly style="height: 4.5rem; line-height: 4.5rem; text-align-last: center;">
                    <!-- ÈîôËØØÂõæÊ†á - Âä®ÊÄÅÂÆö‰ΩçÂú®ÊñáÂ≠óÂè≥‰æß -->
                    <div id="poemErrorIcon" class="hidden absolute top-1/2 transform -translate-y-1/2 pointer-events-none">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center animate-pulse">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Á≠îÂ∞çÊÉÖÊ≥ÅÔºöAI Ëß£ËÆÄÊåâÈàïÁΩÆÊñºÁé©ÂÆ∂Á≠îÊ°àÊ≠£‰∏ãÊñπÔºåÂêåÂçÄÂ°äÂÖß -->
            <div id="aiExplainSuccessRow" class="hidden mb-3 flex justify-center">
                <button id="aiExplainBtnSuccess" class="ai-explain-button px-4 py-2 rounded-2xl font-modern font-semibold text-xs shadow-md modern-button" title="AI Ëß£ËÆÄÊ≠§Âè•">‚ú® AI Ëß£ËÆÄ</button>
            </div>
            
            <!-- Ê∏∏ÊàèÁªìÊûúÂå∫Âüü - ‰Ωç‰∫éËØóÂè•ËæìÂÖ•Ê°Ü‰∏ãÊñπ -->
            <div id="gameMessage" class="hidden mb-3">
                <div class="glass-card p-3 rounded-2xl text-center border border-white/20 backdrop-blur-lg">
                    <!-- Ê≠£Á°ÆÁ≠îÊ°àÊòæÁ§∫ -->
                    <div id="correctAnswer" class="hidden mb-2">
                        <div class="text-xs font-modern text-surface-800/60 mb-2">Ê≠£Á¢∫Á≠îÊ°à</div>
                        <div id="correctAnswerText" class="text-4xl font-kai font-bold text-primary-600 py-2 px-3 glass-card rounded-xl"></div>
                        <!-- Á≠îÈåØÊÉÖÊ≥ÅÔºöAI Ëß£ËÆÄÊåâÈàïÁΩÆÊñºÊ≠£Á¢∫Ë©©Âè•Ê≠£‰∏ãÊñπÔºåÂêåÂçÄÂ°äÂÖß -->
                        <div id="aiExplainFailRow" class="hidden mt-2 flex justify-center">
                            <button id="aiExplainBtnFail" class="ai-explain-button px-4 py-2 rounded-2xl font-modern font-semibold text-xs shadow-md modern-button" title="AI Ëß£ËÆÄÊ≠§Âè•">‚ú® AI Ëß£ËÆÄ</button>
                        </div>
                    </div>
                    
                    <!-- ÊàêÂäüÊó∂Âè™ÊòæÁ§∫ÂõæÊ†áÔºå‰∏çÊòæÁ§∫È¢ùÂ§ñÊñáÂ≠ó -->
                    <div id="successIcon" class="hidden mb-3">
                        <div class="w-12 h-12 mx-auto rounded-full gradient-secondary flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- ‰∏ã‰∏ÄËΩÆÊåâÈíÆ -->
                    <button id="closeGameMessage" class="gradient-primary text-white px-8 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button next-round-button">
                        ‰∏ã‰∏ÄËº™
                    </button>
                </div>
            </div>
            
            <div id="selectionStatus" class="text-right text-xs text-surface-800/70 font-modern font-medium">Â∑≤ÈÅ∏ 0 / 0</div>
        </div>
        
        <!-- Ê±âÂ≠óÈÄâÊã©Âå∫Âüü - Áé∞‰ª£Âåñ -->
        <div class="glass-card-strong rounded-3xl p-4 animate-slide-up" style="flex: 1; min-height: 0; display: flex; flex-direction: column; max-height: none; overflow: visible; animation-delay:200ms">
            <h2 class="text-sm font-modern font-semibold mb-3 text-surface-800 animate-slide-up" style="flex-shrink: 0; animation-delay:240ms">ÈªûÈÅ∏Êº¢Â≠óÁµÑÊàêË©©Âè•</h2>
            <div id="charactersGrid" class="grid grid-cols-5 gap-3" style="flex: 1; overflow: visible; padding: 8px; display: grid; align-content: start; max-height: none;">
                <!-- Characters will be inserted here by JavaScript -->
            </div>
            
            <!-- Áé∞‰ª£ÂåñÊåâÈíÆÂ∏ÉÂ±Ä -->
            <div class="flex justify-center space-x-8 mt-4" style="flex-shrink: 0;">
                <button id="clearSelection" class="gradient-secondary text-white px-6 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button animate-slide-up" style="animation-delay:280ms">ÈÄÄ‰∏ÄÂ≠ó</button>
                <button id="submitPoem" class="gradient-primary text-white px-8 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button animate-slide-up" style="animation-delay:320ms">Êèê‰∫§</button>
            </div>
        </div>
        
        <!-- Custom notification element - Áé∞‰ª£Âåñ -->
        <div id="notification" class="fixed top-6 right-6 left-6 transform transition-all duration-500 ease-out translate-y-[-150%] z-50">
            <div class="max-w-md mx-auto glass-card-strong border border-white/30 shadow-2xl p-4 rounded-2xl animate-slide-up">
                <div class="flex items-center">
                    <div class="text-accent-500 flex-shrink-0">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p id="notificationText" class="text-sm text-surface-800 font-modern font-medium"></p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button id="closeNotification" class="text-surface-800/60 hover:text-surface-800 focus:outline-none modern-button">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ Áµ±‰∏ÄÈÅäÊà≤ÁãÄÊÖãÁÆ°ÁêÜÔºàÈáçÊßã v2.0Ôºâ============
        window.GameState = {
            // ===== Ê†∏ÂøÉÊ®°ÂºèÊ®ôË≠ò =====
            mode: 'solo',        // 'solo' | 'remote' | 'local'
            subMode: null,       // remote: 'timed_score' | 'turn_based' | 'relay'
                                 // local:  'turn_based' | 'buzzer' | 'coop'
            isActive: false,
            
            // ===== Áé©ÂÆ∂Êï∏ÊìöÔºàÁµ±‰∏ÄÁµêÊßãÔºâ =====
            players: [],
            // ÊØèÂÄãÁé©ÂÆ∂Â∞çË±°ÁµêÊßãÔºö
            // {
            //   uid: string,          // ÈÅ†Á®ã: Supabase user_id; Êú¨Âú∞: 'L0', 'L1'...
            //   name: string,         // È°ØÁ§∫ÂêçÁ®±
            //   emoji: string,        // Ë≥ΩÈÅìÈ°ØÁ§∫Áî®ÂãïÁâ© emoji
            //   score: number,        // Áï∂ÂâçÂàÜÊï∏
            //   answered: number,     // Â∑≤Á≠îÈ°åÊï∏
            //   correct: number,      // Ê≠£Á¢∫Êï∏
            //   lastAnswerTs: number, // ÊúÄÂæåÁ≠îÈ°åÊôÇÈñìÊà≥ÔºàÁî®ÊñºÊéíÂêçÔºâ
            //   isReady: boolean,     // ÈÅ†Á®ã: Ê∫ñÂÇôÁãÄÊÖã
            //   isActive: boolean     // Êú¨Âú∞Ëº™ÊµÅ: Áï∂ÂâçÂõûÂêàÊ®ôË®ò
            // }
            
            // ===== ÈÅ†Á®ãÂ∞çÊà∞Â∞àÁî® =====
            remote: {
                room: null,           // Supabase room Â∞çË±°
                channel: null,        // Realtime channel
                currentUserId: null,  // Áï∂ÂâçÁî®Êà∂ ID
                isHost: false,        // ÊòØÂê¶ÁÇ∫Êàø‰∏ª
                seenEids: {}          // ‰∫ã‰ª∂ÂéªÈáçË®òÈåÑ
            },
            
            // ===== ÈôêÊôÇÊ®°ÂºèÂ∞àÁî® =====
            timed: {
                endsAt: 0,            // ÁµêÊùüÊôÇÈñìÊà≥
                duration: 0,          // Á∏ΩÊôÇÈï∑ÔºàÁßíÔºâ
                timer: null           // setInterval ÂºïÁî®
            },
            
            // ===== ÂõûÂêàÂà∂Â∞àÁî® =====
            turnBased: {
                currentTurnIndex: 0,  // Êú¨Âú∞Ëº™ÊµÅ: Áï∂ÂâçÁé©ÂÆ∂Á¥¢Âºï
                roundsPerPlayer: 3,   // ÊØè‰∫∫ÂõûÂêàÊï∏
                currentRound: 0,      // Áï∂ÂâçÂõûÂêà
                totalRounds: 0        // Á∏ΩÂõûÂêàÊï∏
            },
            
            // ===== ÈÅäÊà≤ÂÖßÂÆπ =====
            content: {
                tag: 'all',           // Ë©©Ë©ûÂ∫´Ê®ôÁ±§
                currentQuestion: null,// Áï∂ÂâçÈ°åÁõÆ
                options: []           // Áï∂ÂâçÈÅ∏È†Ö
            }
        };
        
        // ===== Ê®°ÂºèÂà§Êñ∑Â∑•ÂÖ∑ÂáΩÊï∏ÔºàÁµ±‰∏ÄÊé•Âè£Ôºâ=====
        window.GameMode = {
            isSolo: () => window.GameState.mode === 'solo',
            isRemote: () => window.GameState.mode === 'remote',
            isLocal: () => window.GameState.mode === 'local',
            isTimedScore: () => window.GameState.mode === 'remote' && window.GameState.subMode === 'timed_score',
            isTurnBased: () => (window.GameState.mode === 'remote' && window.GameState.subMode === 'turn_based') ||
                               (window.GameState.mode === 'local' && window.GameState.subMode === 'turn_based'),
            isAnyBattle: () => window.GameState.isActive && (window.GameState.mode === 'remote' || window.GameState.mode === 'local')
        };
        
        // „ÄêÈáçÊßã„ÄëÂ∑≤ÁßªÈô§ syncLegacyToGameState()ÔºåÊâÄÊúâÊï∏ÊìöÁõ¥Êé•Âú® GameState ‰∏≠ÁÆ°ÁêÜ
        
        // Ê™¢Ê∏¨iframeÁí∞Â¢É‰∏¶ÂÑ™ÂåñÂ∏ÉÂ±Ä
        function optimizeForIframe() {
            // Ê™¢Ê∏¨ÊòØÂê¶Âú®iframe‰∏≠
            const inIframe = window.parent !== window;
            
            if (inIframe) {
                // Á¢∫‰øùbody‰ΩøÁî®ÂØ¶ÈöõÁöÑiframeÂ∞∫ÂØ∏
                const updateBodySize = () => {
                    const body = document.body;
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    
                    // Âº∑Âà∂Ë®≠ÁΩÆÁ≤æÁ¢∫Â∞∫ÂØ∏
                    body.style.width = width + 'px';
                    body.style.height = height + 'px';
                    body.style.maxWidth = width + 'px';
                    body.style.maxHeight = height + 'px';
                    body.style.overflow = 'hidden';
                    
                    // Á¢∫‰øùÊ≤íÊúâÂ§öÈ§òÁöÑÈÇäË∑ù
                    body.style.margin = '0';
                    body.style.padding = '0';
                };
                
                // ÂàùÂßãË®≠ÁΩÆ
                updateBodySize();
                
                // Áõ£ËÅΩÁ™óÂè£Â§ßÂ∞èËÆäÂåñ
                window.addEventListener('resize', updateBodySize);
                window.addEventListener('orientationchange', () => {
                    setTimeout(updateBodySize, 100);
                });
            }
        }

        // ===== Local Storage Â∑•ÂÖ∑ËàáÈçµÂêç =====
        const LS_KEYS = {
            settings: 'sczj_settings_v1',
            userLibrary: 'sczj_user_library_v1',
            activeTag: 'sczj_active_library_tag_v1'
        };

        function lsSafeParse(json, fallback) {
            try { return JSON.parse(json); } catch { return fallback; }
        }

        function loadSettings() {
            const raw = localStorage.getItem(LS_KEYS.settings);
            return lsSafeParse(raw, {
                gameMode: 'single',
                poemDatabase: 'default',
                timeLimit: 30,
                charCount: 20,
                difficulty: 'medium',
                soundOn: true,
                battle: { playerCount: 2, roundsPerPlayer: 5, speedMode: false, playerNames: [] }
            });
        }

        function persistSettings(settings) {
            localStorage.setItem(LS_KEYS.settings, JSON.stringify(settings));
        }

        

        // Áî®Êà∂Â∫´ÔºàÁµ±‰∏ÄÁöÑ poems Èô£ÂàóÔºâËàáÊ®ôÁ±§
        function loadUserLibrary() {
            const raw = localStorage.getItem(LS_KEYS.userLibrary);
            const data = lsSafeParse(raw, { poems: [] });
            return (data && Array.isArray(data.poems)) ? data : { poems: [] };
        }
        function saveUserLibrary(data) {
            localStorage.setItem(LS_KEYS.userLibrary, JSON.stringify(data));
        }
        function loadActiveTag() {
            return localStorage.getItem(LS_KEYS.activeTag) || '';
        }
        function saveActiveTag(tag) {
            localStorage.setItem(LS_KEYS.activeTag, tag || '');
        }

        // Â∞éÂá∫/Â∞éÂÖ•Â∑•ÂÖ∑
        function computePoemStableId(poem) {
            const a = (poem.author || '').trim().toLowerCase();
            const b = (poem.poem || '').trim().toLowerCase();
            const c = (poem.line || '').trim().toLowerCase();
            return `${a}|${b}|${c}`;
        }
        function normalizePoem(poem) {
            return {
                line: String(poem.line || '').trim(),
                author: String(poem.author || '').trim(),
                poem: String(poem.poem || '').trim(),
                tags: Array.isArray(poem.tags)
                    ? poem.tags.map(t => String(t).trim()).filter(Boolean)
                    : []
            };
        }
        function mergePoemsUnique(list) {
            const map = new Map();
            list.forEach(p0 => {
                const p = normalizePoem(p0);
                if (!p.line || !p.author || !p.poem) return;
                const id = computePoemStableId(p);
                if (!map.has(id)) {
                    map.set(id, { ...p, tags: [...new Set(p.tags)] });
                } else {
                    const old = map.get(id);
                    // ‰ª•Êñ∞ÂÖßÂÆπÁÇ∫Ê∫ñÔºà‰æøÊñºÂ§ñÈÉ®Áî® Excel/JSON ‰øÆË®ÇÔºâ
                    const merged = {
                        line: p.line || old.line,
                        author: p.author || old.author,
                        poem: p.poem || old.poem,
                        tags: Array.from(new Set([...(old.tags||[]), ...(p.tags||[])]))
                    };
                    map.set(id, merged);
                }
            });
            return Array.from(map.values());
        }
        function buildExportPoems() {
            return mergePoemsUnique(getAllPoemsUnified());
        }
        function downloadBlob(filename, blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }
        function exportAsExcel() {
            const poems = buildExportPoems();
            const rows = poems.map(p => ({
                line: p.line,
                author: p.author,
                poem: p.poem,
                tags: (p.tags || []).join('Ôºõ')
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'poems');
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            downloadBlob('poems-export.xlsx', blob);
        }
        // JSON Â∞éÂÖ•/Â∞éÂá∫Â∑≤ÁßªÈô§
        function importFromExcelFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
                    const incoming = rows.map(r => {
                        // ÊîØÊè¥Â§öÁ®ÆÂàÜÈöîÔºö‰∏≠ÊñáÂàÜËôü„ÄÅ‰∏≠ÊñáÈÄóËôü„ÄÅÈ†ìËôü„ÄÅËã±ÊñáÂàÜËôü/ÈÄóËôü„ÄÅÊèõË°å„ÄÅÁ©∫ÁôΩ
                        const rawTags = [];
                        const cell = (r.tags ?? '').toString();
                        if (cell) rawTags.push(...cell.split(/[Ôºõ;Ôºå,„ÄÅ\n\r\t ]+/));
                        // ÊîØÊè¥Â§öÂàó tag1, tag2, Ê®ôÁ±§1, Ê®ôÁ±§2 ...
                        Object.keys(r).forEach(k => {
                            const kNorm = String(k).toLowerCase();
                            if (/^tag\d+$/.test(kNorm) || /^Ê®ôÁ±§\d+$/.test(k)) {
                                const v = (r[k] ?? '').toString().trim();
                                if (v) rawTags.push(v);
                            }
                        });
                        const tags = rawTags.map(s => s.trim()).filter(Boolean);
                        return normalizePoem({
                            line: r.line,
                            author: r.author,
                            poem: r.poem,
                            tags
                        });
                    });
                    // Ë¶ÜËìãÊ®°ÂºèÔºö‰ª•Êú¨Ê¨° Excel ÁöÑÂÖßÂÆπÂÆåÂÖ®ÊõøÊèõÁî®Êà∂Â∫´
                    const replaced = mergePoemsUnique(incoming);
                    saveUserLibrary({ poems: replaced });
                    populateUserTagSelect();
                    showNotification(`Â∑≤Â∞éÂÖ• ${incoming.length} È¶ñË©©ÔºàExcelÔºâ`);
                } catch (e) {
                    alert('Excel Â∞éÂÖ•Â§±ÊïóÔºö' + e.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Â∑≤ÁßªÈô§ÊöóËâ≤Ê®°ÂºèËá™ÂãïÂàáÊèõÔºåÁµ±‰∏Ä‰ΩøÁî®‰∫ÆËâ≤‰∏ªÈ°å
        
        // Èü≥ÊïàÁÆ°ÁêÜÈ°û
        class SoundManager {
            constructor() {
                this.audioContext = null;
                this.isMuted = false;
                this.sounds = {};
                this.init();
            }
            
            init() {
                try {
                    // ÂâµÂª∫Èü≥È†ª‰∏ä‰∏ãÊñá
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContext();
                    
                    // ÂâµÂª∫ÂêÑÁ®ÆÈü≥Êïà
                    this.createSounds();
                } catch (e) {
                    console.error('Web Audio API ‰∏çÊîØÊåÅ:', e);
                }
            }
            
            createSounds() {
                // Êº¢Â≠óÈªûÊìäÈü≥Êïà (Âè§ÁÆèÈü≥Ëâ≤)
                this.sounds.charClick = {
                    play: () => this.playTone(600, 0.1, "triangle", 0.3)
                };
                
                // ÂõûÁ≠îÊ≠£Á¢∫Èü≥Êïà (‰∏≠ÂúãÂÇ≥Áµ±Ê®ÇÂô®Èü≥Ëâ≤)
                this.sounds.correct = {
                    play: () => {
                        // Ê®°Êì¨‰∏≠ÂúãÂÇ≥Áµ±Ê®ÇÂô®ÁöÑÈü≥Èöé
                        setTimeout(() => this.playTone(523.25, 0.15, "sine", 0.4), 0);   // C5
                        setTimeout(() => this.playTone(587.33, 0.15, "sine", 0.4), 150); // D5
                        setTimeout(() => this.playTone(659.25, 0.15, "sine", 0.4), 300); // E5
                        setTimeout(() => this.playTone(783.99, 0.3, "sine", 0.4), 450);  // G5
                    }
                };
                
                // ÂõûÁ≠îÈåØË™§Èü≥Êïà
                this.sounds.wrong = {
                    play: () => {
                        setTimeout(() => this.playTone(349.23, 0.2, "sine", 0.4), 0);    // F4
                        setTimeout(() => this.playTone(329.63, 0.3, "sine", 0.4), 250);  // E4
                    }
                };
                
                // ÊôÇÈñìË≠¶ÂëäÈü≥Êïà
                this.sounds.timeWarning = {
                    play: () => {
                        setTimeout(() => this.playTone(440, 0.1, "sine", 0.2), 0);  
                        setTimeout(() => this.playTone(440, 0.1, "sine", 0.2), 200);
                    }
                };
                
                // ÊôÇÈñìÁµêÊùüÈü≥Êïà
                this.sounds.timeUp = {
                    play: () => {
                        setTimeout(() => this.playTone(523.25, 0.15, "sawtooth", 0.3), 0);    // C5
                        setTimeout(() => this.playTone(392.00, 0.15, "sawtooth", 0.3), 200);  // G4
                        setTimeout(() => this.playTone(329.63, 0.3, "sawtooth", 0.3), 400);   // E4
                    }
                };
                
                // ÊåâÈàïÈªûÊìäÈü≥Êïà
                this.sounds.buttonClick = {
                    play: () => this.playTone(440, 0.1, "sine", 0.15)
                };
                
                // Êñ∞ÂõûÂêàÈñãÂßãÈü≥Êïà
                this.sounds.newRound = {
                    play: () => {
                        // È°û‰ººÊñº‰∏≠ÂúãÂÇ≥Áµ±Èü≥Ê®ÇÁöÑ‰∫îËÅ≤Èü≥Èöé (C, D, E, G, A)
                        setTimeout(() => this.playTone(523.25, 0.15, "sine", 0.3), 0);    // C5
                        setTimeout(() => this.playTone(587.33, 0.15, "sine", 0.3), 120);   // D5
                        setTimeout(() => this.playTone(659.25, 0.15, "sine", 0.3), 240);   // E5
                        setTimeout(() => this.playTone(783.99, 0.15, "sine", 0.3), 360);   // G5
                        setTimeout(() => this.playTone(880.00, 0.3, "sine", 0.3), 480);    // A5
                    }
                };
            }
            
            // Êí≠ÊîæÈü≥Ë™ø
            playTone(frequency, duration, type = "sine", volume = 0.5) {
                if (this.isMuted || !this.audioContext) return;
                
                try {
                    // Â¶ÇÊûúÈü≥È†ª‰∏ä‰∏ãÊñáË¢´Êö´ÂÅúÔºåÈáçÂïüÂÆÉ
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }
                    
                    // ÂâµÂª∫ÊåØÁõ™Âô®
                    const oscillator = this.audioContext.createOscillator();
                    oscillator.type = type;
                    oscillator.frequency.value = frequency;
                    
                    // ÂâµÂª∫Èü≥ÈáèÊéßÂà∂
                    const gainNode = this.audioContext.createGain();
                    gainNode.gain.value = volume;
                    
                    // ÈÄ£Êé•ÁØÄÈªû
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    // Ë®≠ÁΩÆË°∞Ê∏õ
                    gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                    
                    // Êí≠ÊîæËÅ≤Èü≥
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.error('Êí≠ÊîæÈü≥ÊïàÂ§±Êïó:', e);
                }
            }
            
            // ÂàáÊèõÈùúÈü≥
            toggleMute() {
                this.isMuted = !this.isMuted;
                return this.isMuted;
            }
            
            // Êí≠ÊîæÊåáÂÆöÈü≥Êïà
            play(soundName) {
                if (this.isMuted || !this.sounds[soundName]) return;
                this.sounds[soundName].play();
            }
        }
        
        // ÂâµÂª∫ÂÖ®Â±ÄÈü≥ÊïàÁÆ°ÁêÜÂô®
        const soundManager = new SoundManager();

        // Â∞èÂ≠∏ÁîüË©©Ë©ûÊï∏ÊìöÂ∫´ - ÂæûÊèê‰æõÁöÑÊñá‰ª∂‰∏≠ÈÅ∏ÂèñÁöÑÁ∂ìÂÖ∏Ë©©Âè•
        const elementaryPoemLines = [
            // ËòáËªæ‰ΩúÂìÅ
            { line: "Ëç∑Áõ°Â∑≤ÁÑ°ÊìéÈõ®Ëìã", author: "ËòáËªæ", poem: "Ë¥àÂàòÊôØÊñá" },
            { line: "ËèäÊÆòÁå∂ÊúâÂÇ≤ÈúúÊûù", author: "ËòáËªæ", poem: "Ë¥àÂàòÊôØÊñá" },
            { line: "‰∏ÄÂπ¥Â•ΩÊôØÂêõÈ†àË®ò", author: "ËòáËªæ", poem: "Ë¥àÂàòÊôØÊñá" },
            { line: "ÊúÄÊòØÊ©ôÈªÉÊ©òÁ∂†ÊôÇ", author: "ËòáËªæ", poem: "Ë¥àÂàòÊôØÊñá" },
            
            { line: "Ê©´ÁúãÊàêÂ∂∫ÂÅ¥ÊàêÂ≥∞", author: "ËòáËªæ", poem: "È°åË•øÊûóÂ£Å" },
            { line: "ÈÅ†ËøëÈ´ò‰ΩéÂêÑ‰∏çÂêå", author: "ËòáËªæ", poem: "È°åË•øÊûóÂ£Å" },
            { line: "‰∏çË≠òÂª¨Â±±ÁúüÈù¢ÁõÆ", author: "ËòáËªæ", poem: "È°åË•øÊûóÂ£Å" },
            { line: "Âè™Á∑£Ë∫´Âú®Ê≠§Â±±‰∏≠", author: "ËòáËªæ", poem: "È°åË•øÊûóÂ£Å" },
            
            { line: "Á´πÂ§ñÊ°ÉËä±‰∏âÂÖ©Êûù", author: "ËòáËªæ", poem: "ÊÉ†Â¥áÊò•Ê±üÊôöÊôØ" },
            { line: "Êò•Ê±üÊ∞¥ÊöñÈ¥®ÂÖàÁü•", author: "ËòáËªæ", poem: "ÊÉ†Â¥áÊò•Ê±üÊôöÊôØ" },
            
            { line: "Ê¨≤ÊääË•øÊπñÊØîË•øÂ≠ê", author: "ËòáËªæ", poem: "È£≤Êπñ‰∏äÂàùÊô¥ÂæåÈõ®" },
            { line: "Ê∑°Â¶ùÊøÉÊäπÁ∏ΩÁõ∏ÂÆú", author: "ËòáËªæ", poem: "È£≤Êπñ‰∏äÂàùÊô¥ÂæåÈõ®" },
            
            // ÁéãÂÆâÁü≥‰ΩúÂìÅ
            { line: "Â¢ªËßíÊï∏ÊûùÊ¢Ö", author: "ÁéãÂÆâÁü≥", poem: "Ê¢ÖËä±" },
            { line: "ÂáåÂØíÁç®Ëá™Èñã", author: "ÁéãÂÆâÁü≥", poem: "Ê¢ÖËä±" },
            { line: "ÈÅôÁü•‰∏çÊòØÈõ™", author: "ÁéãÂÆâÁü≥", poem: "Ê¢ÖËä±" },
            { line: "ÁÇ∫ÊúâÊöóÈ¶ô‰æÜ", author: "ÁéãÂÆâÁü≥", poem: "Ê¢ÖËä±" },
            
            { line: "Êò•È¢®ÂèàÁ∂†Ê±üÂçóÂ≤∏", author: "ÁéãÂÆâÁü≥", poem: "Ê≥äËàπÁìúÊ¥≤" },
            { line: "ÊòéÊúà‰ΩïÊôÇÁÖßÊàëÈÇÑ", author: "ÁéãÂÆâÁü≥", poem: "Ê≥äËàπÁìúÊ¥≤" },
            
            { line: "ÁàÜÁ´πËÅ≤‰∏≠‰∏ÄÊ≠≤Èô§", author: "ÁéãÂÆâÁü≥", poem: "ÂÖÉÊó•" },
            { line: "Êò•È¢®ÈÄÅÊöñÂÖ•Â±†Ëòá", author: "ÁéãÂÆâÁü≥", poem: "ÂÖÉÊó•" },
            { line: "ÂçÉÈñÄËê¨Êà∂ÊõàÊõàÊó•", author: "ÁéãÂÆâÁü≥", poem: "ÂÖÉÊó•" },
            { line: "Á∏ΩÊääÊñ∞Ê°ÉÊèõËàäÁ¨¶", author: "ÁéãÂÆâÁü≥", poem: "ÂÖÉÊó•" },
            
            // Ê•äËê¨Èáå‰ΩúÂìÅ
            { line: "Êé•Â§©ËìÆËëâÁÑ°Á™ÆÁ¢ß", author: "Ê•äËê¨Èáå", poem: "ÊôìÂá∫ÂáÄÊÖàÂØ∫ÈÄÅÊûóÂ≠êÊñπ" },
            { line: "Êò†Êó•Ëç∑Ëä±Âà•Ê®£Á¥Ö", author: "Ê•äËê¨Èáå", poem: "ÊôìÂá∫ÂáÄÊÖàÂØ∫ÈÄÅÊûóÂ≠êÊñπ" },
            
            // Èô∏Ê∏∏‰ΩúÂìÅ
            { line: "ÁéãÂ∏´ÂåóÂÆö‰∏≠ÂéüÊó•", author: "Èô∏Ê∏∏", poem: "Á§∫ÂÑø" },
            { line: "ÂÆ∂Á•≠ÁÑ°ÂøòÂëä‰πÉÁøÅ", author: "Èô∏Ê∏∏", poem: "Á§∫ÂÑø" },
            
            // ËåÉÊàêÂ§ß‰ΩúÂìÅ
            { line: "Ê¢ÖÂ≠êÈáëÈªÉÊùèÂ≠êËÇ•", author: "ËåÉÊàêÂ§ß", poem: "ÂõõÊó∂Áî∞Âõ≠ÊùÇÂÖ¥" },
            { line: "È∫•Ëä±Èõ™ÁôΩËèúËä±Á®Ä", author: "ËåÉÊàêÂ§ß", poem: "ÂõõÊó∂Áî∞Âõ≠ÊùÇÂÖ¥" },
            
            // ÈÇµÈõç‰ΩúÂìÅ
            { line: "‰∏ÄÂéª‰∫å‰∏âÈáå", author: "ÈÇµÈõç", poem: "Â±±ÊùëÂíèÊÄÄ" },
            { line: "ÁÖôÊùëÂõõ‰∫îÂÆ∂", author: "ÈÇµÈõç", poem: "Â±±ÊùëÂíèÊÄÄ" },
            { line: "‰∫≠Ëá∫ÂÖ≠‰∏ÉÂ∫ß", author: "ÈÇµÈõç", poem: "Â±±ÊùëÂíèÊÄÄ" },
            { line: "ÂÖ´‰πùÂçÅÊûùËä±", author: "ÈÇµÈõç", poem: "Â±±ÊùëÂíèÊÄÄ" },
            
            // Êú±ÁÜπ‰ΩúÂìÅ
            { line: "Á≠âÈñíË≠òÂæóÊù±È¢®Èù¢", author: "Êú±ÁÜπ", poem: "Êò•Êó•" },
            { line: "Ëê¨Á¥´ÂçÉÁ¥ÖÁ∏ΩÊòØÊò•", author: "Êú±ÁÜπ", poem: "Êò•Êó•" },
            
            // ÊûóÂçá‰ΩúÂìÅ
            { line: "Â±±Â§ñÈùíÂ±±Ê®ìÂ§ñÊ®ì", author: "ÊûóÂçá", poem: "È°åËá®ÂÆâÈÇ∏" },
            { line: "Ë•øÊπñÊ≠åËàûÂπæÊôÇ‰ºë", author: "ÊûóÂçá", poem: "È°åËá®ÂÆâÈÇ∏" },
            { line: "ÊöñÈ¢®ÁÜèÂæóÈÅä‰∫∫ÈÜâ", author: "ÊûóÂçá", poem: "È°åËá®ÂÆâÈÇ∏" },
            { line: "Áõ¥ÊääÊù≠Â∑û‰ΩúÊ±¥Â∑û", author: "ÊûóÂçá", poem: "È°åËá®ÂÆâÈÇ∏" },
            
            // ËëâÁ¥πÁøÅ‰ΩúÂìÅ
            { line: "Êò•Ëâ≤ÊªøÂúíÈóú‰∏ç‰Ωè", author: "ËëâÁ¥πÁøÅ", poem: "Ê∏∏Âõ≠‰∏çÂÄº" },
            { line: "‰∏ÄÊûùÁ¥ÖÊùèÂá∫ÁâÜ‰æÜ", author: "ËëâÁ¥πÁøÅ", poem: "Ê∏∏Âõ≠‰∏çÂÄº" },
            
            // ÊùéÁôΩ‰ΩúÂìÅ
            { line: "Â∫äÂâçÊòéÊúàÂÖâ", author: "ÊùéÁôΩ", poem: "ÈùôÂ§úÊÄù" },
            { line: "ÁñëÊòØÂú∞‰∏äÈúú", author: "ÊùéÁôΩ", poem: "ÈùôÂ§úÊÄù" },
            { line: "ËàâÈ†≠ÊúõÊòéÊúà", author: "ÊùéÁôΩ", poem: "ÈùôÂ§úÊÄù" },
            { line: "‰ΩéÈ†≠ÊÄùÊïÖÈÑâ", author: "ÊùéÁôΩ", poem: "ÈùôÂ§úÊÄù" },
            
            { line: "ÊùéÁôΩ‰πòËàüÂ∞áÊ¨≤Ë°å", author: "ÊùéÁôΩ", poem: "Ëµ†Ê±™‰º¶" },
            { line: "ÂøΩËÅûÂ≤∏‰∏äË∏èÊ≠åËÅ≤", author: "ÊùéÁôΩ", poem: "Ëµ†Ê±™‰º¶" },
            { line: "Ê°ÉËä±ÊΩ≠Ê∞¥Ê∑±ÂçÉÂ∞∫", author: "ÊùéÁôΩ", poem: "Ëµ†Ê±™‰º¶" },
            { line: "‰∏çÂèäÊ±™ÂÄ´ÈÄÅÊàëÊÉÖ", author: "ÊùéÁôΩ", poem: "Ëµ†Ê±™‰º¶" },
            
            { line: "Â§©ÈñÄ‰∏≠Êñ∑Ê•öÊ±üÈñã", author: "ÊùéÁôΩ", poem: "ÊúõÂ§©ÈñÄÂ±±" },
            { line: "Á¢ßÊ∞¥Êù±ÊµÅËá≥Ê≠§Âõû", author: "ÊùéÁôΩ", poem: "ÊúõÂ§©ÈñÄÂ±±" },
            { line: "ÂÖ©Â≤∏ÈùíÂ±±Áõ∏Â∞çÂá∫", author: "ÊùéÁôΩ", poem: "ÊúõÂ§©ÈñÄÂ±±" },
            { line: "Â≠§Â∏Ü‰∏ÄÁâáÊó•ÈÇä‰æÜ", author: "ÊùéÁôΩ", poem: "ÊúõÂ§©ÈñÄÂ±±" },
            
            { line: "ÊúùËæ≠ÁôΩÂ∏ùÂΩ©Èõ≤Èñì", author: "ÊùéÁôΩ", poem: "Êó©ÂèëÁôΩÂ∏ùÂüé" },
            { line: "ÂçÉÈáåÊ±üÈôµ‰∏ÄÊó•ÈÇÑ", author: "ÊùéÁôΩ", poem: "Êó©ÂèëÁôΩÂ∏ùÂüé" },
            { line: "ÂÖ©Â≤∏ÁåøËÅ≤Âïº‰∏ç‰Ωè", author: "ÊùéÁôΩ", poem: "Êó©ÂèëÁôΩÂ∏ùÂüé" },
            { line: "ËºïËàüÂ∑≤ÈÅéËê¨ÈáçÂ±±", author: "ÊùéÁôΩ", poem: "Êó©ÂèëÁôΩÂ∏ùÂüé" },
            
            { line: "È£õÊµÅÁõ¥‰∏ã‰∏âÂçÉÂ∞∫", author: "ÊùéÁôΩ", poem: "ÊúõÂ∫êÂ±±ÁÄëÂ∏É" },
            { line: "ÁñëÊòØÈäÄÊ≤≥ËêΩ‰πùÂ§©", author: "ÊùéÁôΩ", poem: "ÊúõÂ∫êÂ±±ÁÄëÂ∏É" },
            
            // ÊùúÁî´‰ΩúÂìÅ
            { line: "ÂÖ©ÂÄãÈªÉÈ∏ùÈ≥¥Áø†Êü≥", author: "ÊùúÁî´", poem: "ÁªùÂè•" },
            { line: "‰∏ÄË°åÁôΩÈ∑∫‰∏äÈùíÂ§©", author: "ÊùúÁî´", poem: "ÁªùÂè•" },
            { line: "Á™óÂê´Ë•øÂ∂∫ÂçÉÁßãÈõ™", author: "ÊùúÁî´", poem: "ÁªùÂè•" },
            { line: "ÈñÄÊ≥äÊù±Âê≥Ëê¨ÈáåËàπ", author: "ÊùúÁî´", poem: "ÁªùÂè•" },
            
            { line: "Â•ΩÈõ®Áü•ÊôÇÁØÄ", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            { line: "Áï∂Êò•‰πÉÁôºÁîü", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            { line: "Èö®È¢®ÊΩõÂÖ•Â§ú", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            { line: "ÊΩ§Áâ©Á¥∞ÁÑ°ËÅ≤", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            
            // ÊùúÁâß‰ΩúÂìÅ
            { line: "Ê∏ÖÊòéÊôÇÁØÄÈõ®Á¥õÁ¥õ", author: "ÊùúÁâß", poem: "Ê∏ÖÊòé" },
            { line: "Ë∑Ø‰∏äË°å‰∫∫Ê¨≤Êñ∑È≠Ç", author: "ÊùúÁâß", poem: "Ê∏ÖÊòé" },
            { line: "ÂÄüÂïèÈÖíÂÆ∂‰ΩïËôïÊúâ", author: "ÊùúÁâß", poem: "Ê∏ÖÊòé" },
            { line: "ÁâßÁ´•ÈÅôÊåáÊùèËä±Êùë", author: "ÊùúÁâß", poem: "Ê∏ÖÊòé" },
            
            { line: "ÂÅúËªäÂùêÊÑõÊ•ìÊûóÊôö", author: "ÊùúÁâß", poem: "Â±±Ë°å" },
            { line: "ÈúúËëâÁ¥ÖÊñº‰∫åÊúàËä±", author: "ÊùúÁâß", poem: "Â±±Ë°å" },
            
            // ÊùéÂïÜÈö±‰ΩúÂìÅ
            { line: "Â§ïÈôΩÁÑ°ÈôêÂ•Ω", author: "ÊùéÂïÜÈö±", poem: "ÁôªÊ®ÇÊ∏∏Âéü" },
            { line: "Âè™ÊòØËøëÈªÉÊòè", author: "ÊùéÂïÜÈö±", poem: "ÁôªÊ®ÇÊ∏∏Âéü" },
            
            // ÁôΩÂ±ÖÊòì‰ΩúÂìÅ
            { line: "Èõ¢Èõ¢Âéü‰∏äËçâ", author: "ÁôΩÂ±ÖÊòì", poem: "ËµãÂæóÂè§ÂéüËçâÈÄÅÂà´" },
            { line: "‰∏ÄÊ≠≤‰∏ÄÊûØÊ¶Æ", author: "ÁôΩÂ±ÖÊòì", poem: "ËµãÂæóÂè§ÂéüËçâÈÄÅÂà´" },
            { line: "ÈáéÁÅ´Ááí‰∏çÁõ°", author: "ÁôΩÂ±ÖÊòì", poem: "ËµãÂæóÂè§ÂéüËçâÈÄÅÂà´" },
            { line: "Êò•È¢®ÂêπÂèàÁîü", author: "ÁôΩÂ±ÖÊòì", poem: "ËµãÂæóÂè§ÂéüËçâÈÄÅÂà´" },
            
            // È´òÈÅ©‰ΩúÂìÅ
            { line: "Ëé´ÊÑÅÂâçË∑ØÁÑ°Áü•Â∑±", author: "È´òÈÅ©", poem: "Âà´Ëë£Â§ß" },
            { line: "Â§©‰∏ãË™∞‰∫∫‰∏çË≠òÂêõ", author: "È´òÈÅ©", poem: "Âà´Ëë£Â§ß" },
            
            // ÂºµÁπº‰ΩúÂìÅ
            { line: "ÊúàËêΩÁÉèÂïºÈúúÊªøÂ§©", author: "ÂºµÁπº", poem: "Êû´Ê°•Â§úÊ≥ä" },
            { line: "Ê±üÊ•ìÊºÅÁÅ´Â∞çÊÑÅÁú†", author: "ÂºµÁπº", poem: "Êû´Ê°•Â§úÊ≥ä" },
            { line: "ÂßëËòáÂüéÂ§ñÂØíÂ±±ÂØ∫", author: "ÂºµÁπº", poem: "Êû´Ê°•Â§úÊ≥ä" },
            { line: "Â§úÂçäÈêòËÅ≤Âà∞ÂÆ¢Ëàπ", author: "ÂºµÁπº", poem: "Êû´Ê°•Â§úÊ≥ä" },
            
            // Â≠üÈÉä‰ΩúÂìÅ
            { line: "Ë™∞Ë®ÄÂØ∏ËçâÂøÉ", author: "Â≠üÈÉä", poem: "Ê∏∏Â≠êÂêü" },
            { line: "Â†±Âæó‰∏âÊò•Êöâ", author: "Â≠üÈÉä", poem: "Ê∏∏Â≠êÂêü" },
            
            // ÂäâÁ¶πÈå´‰ΩúÂìÅ
            { line: "ËàäÊôÇÁéãË¨ùÂ†ÇÂâçÁáï", author: "ÂäâÁ¶πÈå´", poem: "‰πåË°£Â∑∑" },
            { line: "È£õÂÖ•Â∞ãÂ∏∏ÁôæÂßìÂÆ∂", author: "ÂäâÁ¶πÈå´", poem: "‰πåË°£Â∑∑" },
            
            // ÊùéÁ¥≥‰ΩúÂìÅ
            { line: "Èã§Á¶æÊó•Áï∂Âçà", author: "ÊùéÁ¥≥", poem: "ÊÇØÂÜú" },
            { line: "Ê±óÊª¥Á¶æ‰∏ãÂúü", author: "ÊùéÁ¥≥", poem: "ÊÇØÂÜú" },
            { line: "Ë™∞Áü•Áõ§‰∏≠È§ê", author: "ÊùéÁ¥≥", poem: "ÊÇØÂÜú" },
            { line: "Á≤íÁ≤íÁöÜËæõËã¶", author: "ÊùéÁ¥≥", poem: "ÊÇØÂÜú" },
            
            // Â¥îË≠∑‰ΩúÂìÅ
            { line: "‰∫∫Èù¢‰∏çÁü•‰ΩïËôïÂéª", author: "Â¥îË≠∑", poem: "È¢òÈÉΩÂüéÂçóÂ∫Ñ" },
            { line: "Ê°ÉËä±‰æùËàäÁ¨ëÊò•È¢®", author: "Â¥îË≠∑", poem: "È¢òÈÉΩÂüéÂçóÂ∫Ñ" },
            
            // Êü≥ÂÆóÂÖÉ‰ΩúÂìÅ
            { line: "ÂçÉÂ±±È≥•È£õÁµï", author: "Êü≥ÂÆóÂÖÉ", poem: "Ê±üÈõ™" },
            { line: "Ëê¨Âæë‰∫∫Ëπ§ÊªÖ", author: "Êü≥ÂÆóÂÖÉ", poem: "Ê±üÈõ™" },
            { line: "Â≠§ËàüËìëÁ¨†ÁøÅ", author: "Êü≥ÂÆóÂÖÉ", poem: "Ê±üÈõ™" },
            { line: "Áç®Èá£ÂØíÊ±üÈõ™", author: "Êü≥ÂÆóÂÖÉ", poem: "Ê±üÈõ™" },
            
            // Èß±Ë≥ìÁéã‰ΩúÂìÅ
            { line: "ÈµùÈµùÈµù", author: "Èß±Ë≥ìÁéã", poem: "ÂíèÈπÖ" },
            { line: "Êõ≤È†ÖÂêëÂ§©Ê≠å", author: "Èß±Ë≥ìÁéã", poem: "ÂíèÈπÖ" },
            { line: "ÁôΩÊØõÊµÆÁ∂†Ê∞¥", author: "Èß±Ë≥ìÁéã", poem: "ÂíèÈπÖ" },
            { line: "Á¥ÖÊéåÊí•Ê∏ÖÊ≥¢", author: "Èß±Ë≥ìÁéã", poem: "ÂíèÈπÖ" },
            
            // Ë≥ÄÁü•Á´†‰ΩúÂìÅ
            { line: "Á¢ßÁéâÂ¶ùÊàê‰∏ÄÊ®πÈ´ò", author: "Ë≥ÄÁü•Á´†", poem: "ÂíèÊü≥" },
            { line: "Ëê¨Ê¢ùÂûÇ‰∏ãÁ∂†Áµ≤Áµ°", author: "Ë≥ÄÁü•Á´†", poem: "ÂíèÊü≥" },
            { line: "‰∏çÁü•Á¥∞ËëâË™∞Ë£ÅÂá∫", author: "Ë≥ÄÁü•Á´†", poem: "ÂíèÊü≥" },
            { line: "‰∫åÊúàÊò•È¢®‰ººÂâ™ÂàÄ", author: "Ë≥ÄÁü•Á´†", poem: "ÂíèÊü≥" },
            
            // Áéã‰πãÊ∏ô‰ΩúÂìÅ
            { line: "ÁôΩÊó•‰æùÂ±±Áõ°", author: "Áéã‰πãÊ∏ô", poem: "ÁôªÈπ≥ÈõÄÊ•º" },
            { line: "ÈªÉÊ≤≥ÂÖ•Êµ∑ÊµÅ", author: "Áéã‰πãÊ∏ô", poem: "ÁôªÈπ≥ÈõÄÊ•º" },
            { line: "Ê¨≤Á™ÆÂçÉÈáåÁõÆ", author: "Áéã‰πãÊ∏ô", poem: "ÁôªÈπ≥ÈõÄÊ•º" },
            { line: "Êõ¥‰∏ä‰∏ÄÂ±§Ê®ì", author: "Áéã‰πãÊ∏ô", poem: "ÁôªÈπ≥ÈõÄÊ•º" },
            
            // Â≠üÊµ©ÁÑ∂‰ΩúÂìÅ
            { line: "Êò•Áú†‰∏çË¶∫Êõâ", author: "Â≠üÊµ©ÁÑ∂", poem: "Êò•Êôì" },
            { line: "ËôïËôïËÅûÂïºÈ≥•", author: "Â≠üÊµ©ÁÑ∂", poem: "Êò•Êôì" },
            { line: "Â§ú‰æÜÈ¢®Èõ®ËÅ≤", author: "Â≠üÊµ©ÁÑ∂", poem: "Êò•Êôì" },
            { line: "Ëä±ËêΩÁü•Â§öÂ∞ë", author: "Â≠üÊµ©ÁÑ∂", poem: "Êò•Êôì" },
            
            // ÁéãÁ∂≠‰ΩúÂìÅ
            { line: "Áç®Âú®Áï∞ÈÑâÁÇ∫Áï∞ÂÆ¢", author: "ÁéãÁ∂≠", poem: "‰πùÊúà‰πùÊó•ÂøÜÂ±±‰∏úÂÖÑÂºü" },
            { line: "ÊØèÈÄ¢‰Ω≥ÁØÄÂÄçÊÄùË¶™", author: "ÁéãÁ∂≠", poem: "‰πùÊúà‰πùÊó•ÂøÜÂ±±‰∏úÂÖÑÂºü" },
            
            { line: "Á¥ÖË±ÜÁîüÂçóÂúã", author: "ÁéãÁ∂≠", poem: "Áõ∏ÊÄù" },
            { line: "Êò•‰æÜÁôºÂπæÊûù", author: "ÁéãÁ∂≠", poem: "Áõ∏ÊÄù" },
            { line: "È°òÂêõÂ§öÊé°Êì∑", author: "ÁéãÁ∂≠", poem: "Áõ∏ÊÄù" },
            { line: "Ê≠§Áâ©ÊúÄÁõ∏ÊÄù", author: "ÁéãÁ∂≠", poem: "Áõ∏ÊÄù" },
            
            { line: "Âã∏ÂêõÊõ¥Áõ°‰∏ÄÊùØÈÖí", author: "ÁéãÁ∂≠", poem: "ÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø" },
            { line: "Ë•øÂá∫ÈôΩÈóúÁÑ°ÊïÖ‰∫∫", author: "ÁéãÁ∂≠", poem: "ÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø" },
            
            // ÈùúÂ§èÁöÑÈÉ®ÂàÜ
            { line: "Â∞èÊùæÂàùÊï∏Â∞∫", author: "ÁéãÂª∫", poem: "Â∞èÊùæ" },
            { line: "Êú™ÊúâÁõ¥ÁîüÊûù", author: "ÁéãÂª∫", poem: "Â∞èÊùæ" }
        ];
        
        // Ë©©Ë©ûÂ∫´ - ÂæûË©©Ë©ûÂ∫´AIÈÅäÊà≤.docx‰∏≠Â∞éÂÖ•ÁöÑË©©Âè•
        const tangPoetryLines = [
            // Êº¢Ê®ÇÂ∫ú„ÄäÈï∑Ê≠åË°å„Äã
            { line: "ÈùíÈùíÂúí‰∏≠Ëëµ", author: "Êº¢Ê®ÇÂ∫ú", poem: "Èï∑Ê≠åË°å" },
            { line: "ÊúùÈú≤ÂæÖÊó•Êôû", author: "Êº¢Ê®ÇÂ∫ú", poem: "Èï∑Ê≠åË°å" },
            { line: "Â∞ëÂ£Ø‰∏çÂä™Âäõ", author: "Êº¢Ê®ÇÂ∫ú", poem: "Èï∑Ê≠åË°å" },
            { line: "ËÄÅÂ§ßÂæíÂÇ∑ÊÇ≤", author: "Êº¢Ê®ÇÂ∫ú", poem: "Èï∑Ê≠åË°å" },
            
            // Âè§Ë©©ÂçÅ‰πùÈ¶ñ„ÄäÂ∫≠‰∏≠ÊúâÂ•áÊ®π„Äã
            { line: "Â∫≠‰∏≠ÊúâÂ•áÊ®π", author: "Âè§Ë©©ÂçÅ‰πùÈ¶ñ", poem: "Â∫≠‰∏≠ÊúâÂ•áÊ®π" },
            { line: "Á∂†ËëâÁôºËèØÊªã", author: "Âè§Ë©©ÂçÅ‰πùÈ¶ñ", poem: "Â∫≠‰∏≠ÊúâÂ•áÊ®π" },
            { line: "Ê≠§Áâ©‰ΩïË∂≥Ë≤¥", author: "Âè§Ë©©ÂçÅ‰πùÈ¶ñ", poem: "Â∫≠‰∏≠ÊúâÂ•áÊ®π" },
            { line: "‰ΩÜÊÑüÂà•Á∂ìÊôÇ", author: "Âè§Ë©©ÂçÅ‰πùÈ¶ñ", poem: "Â∫≠‰∏≠ÊúâÂ•áÊ®π" },
            
            // Èß±Ë≥ìÁéã„ÄäË©†Èµù„Äã
            { line: "ÁôΩÊØõÊµÆÁ∂†Ê∞¥", author: "Èß±Ë≥ìÁéã", poem: "Ë©†Èµù" },
            { line: "Á¥ÖÊéåÊí•Ê∏ÖÊ≥¢", author: "Èß±Ë≥ìÁéã", poem: "Ë©†Èµù" },
            
            // Ë≥ÄÁü•Á´†„ÄäË©†Êü≥„Äã
            { line: "‰∏çÁü•Á¥∞ËëâË™∞Ë£ÅÂá∫", author: "Ë≥ÄÁü•Á´†", poem: "Ë©†Êü≥" },
            { line: "‰∫åÊúàÊò•È¢®‰ººÂâ™ÂàÄ", author: "Ë≥ÄÁü•Á´†", poem: "Ë©†Êü≥" },
            
            // Áéã‰πãÊ∏ô„ÄäÁôªÈ∏õÈõÄÊ®ì„Äã
            { line: "Ê¨≤Á™ÆÂçÉÈáåÁõÆ", author: "Áéã‰πãÊ∏ô", poem: "ÁôªÈ∏õÈõÄÊ®ì" },
            { line: "Êõ¥‰∏ä‰∏ÄÂ±§Ê®ì", author: "Áéã‰πãÊ∏ô", poem: "ÁôªÈ∏õÈõÄÊ®ì" },
            
            // Â≠üÊµ©ÁÑ∂„ÄäÊò•Êõâ„Äã
            { line: "Â§ú‰æÜÈ¢®Èõ®ËÅ≤", author: "Â≠üÊµ©ÁÑ∂", poem: "Êò•Êõâ" },
            { line: "Ëä±ËêΩÁü•Â§öÂ∞ë", author: "Â≠üÊµ©ÁÑ∂", poem: "Êò•Êõâ" },
            
            // ÁéãÁ∂≠„Ää‰πùÊúà‰πùÊó•ÊÜ∂Â±±Êù±ÂÖÑÂºü„Äã
            { line: "Áç®Âú®Áï∞ÈÑâÁÇ∫Áï∞ÂÆ¢", author: "ÁéãÁ∂≠", poem: "‰πùÊúà‰πùÊó•ÊÜ∂Â±±Êù±ÂÖÑÂºü" },
            { line: "ÊØèÈÄ¢‰Ω≥ÁØÄÂÄçÊÄùË¶™", author: "ÁéãÁ∂≠", poem: "‰πùÊúà‰πùÊó•ÊÜ∂Â±±Êù±ÂÖÑÂºü" },
            
            // ÁéãÁ∂≠„ÄäÁõ∏ÊÄù„Äã
            { line: "È°òÂêõÂ§öÊé°Êì∑", author: "ÁéãÁ∂≠", poem: "Áõ∏ÊÄù" },
            { line: "Ê≠§Áâ©ÊúÄÁõ∏ÊÄù", author: "ÁéãÁ∂≠", poem: "Áõ∏ÊÄù" },
            
            // ÁéãÁ∂≠„ÄäÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø„Äã
            { line: "Âã∏ÂêõÊõ¥Áõ°‰∏ÄÊùØÈÖí", author: "ÁéãÁ∂≠", poem: "ÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø" },
            { line: "Ë•øÂá∫ÈôΩÈóúÁÑ°ÊïÖ‰∫∫", author: "ÁéãÁ∂≠", poem: "ÈÄÅÂÖÉ‰∫å‰ΩøÂÆâË•ø" },
            
            // ÁéãÁ∂≠„ÄäÁ´πÈáåÈ§®„Äã
            { line: "Ê∑±Êûó‰∫∫‰∏çÁü•", author: "ÁéãÁ∂≠", poem: "Á´πÈáåÈ§®" },
            { line: "ÊòéÊúà‰æÜÁõ∏ÁÖß", author: "ÁéãÁ∂≠", poem: "Á´πÈáåÈ§®" },
            
            // ÁéãÊòåÈΩ°„ÄäÂá∫Â°û„ÄãÂÖ∂‰∏Ä
            { line: "‰ΩÜ‰ΩøÈæçÂüéÈ£õÂ∞áÂú®", author: "ÁéãÊòåÈΩ°", poem: "Âá∫Â°û" },
            { line: "‰∏çÊïôËÉ°È¶¨Â∫¶Èô∞Â±±", author: "ÁéãÊòåÈΩ°", poem: "Âá∫Â°û" },
            
            // ÁéãÊòåÈΩ°„ÄäÂæûËªçË°å„ÄãÂÖ∂‰∏Ä
            { line: "Êõ¥ÂêπÁæåÁ¨õÈóúÂ±±Êúà", author: "ÁéãÊòåÈΩ°", poem: "ÂæûËªçË°å" },
            { line: "ÁÑ°ÈÇ£ÈáëÈñ®Ëê¨ÈáåÊÑÅ", author: "ÁéãÊòåÈΩ°", poem: "ÂæûËªçË°å" },
            
            // È´òÈÅ©„ÄäÂà•Ëë£Â§ß„ÄãÂÖ∂‰∏Ä
            { line: "Ëé´ÊÑÅÂâçË∑ØÁÑ°Áü•Â∑±", author: "È´òÈÅ©", poem: "Âà•Ëë£Â§ß" },
            { line: "Â§©‰∏ãË™∞‰∫∫‰∏çË≠òÂêõ", author: "È´òÈÅ©", poem: "Âà•Ëë£Â§ß" },
            
            // ÊùéÁôΩ„ÄäÈùúÂ§úÊÄù„Äã
            { line: "ËàâÈ†≠ÊúõÊòéÊúà", author: "ÊùéÁôΩ", poem: "ÈùúÂ§úÊÄù" },
            { line: "‰ΩéÈ†≠ÊÄùÊïÖÈÑâ", author: "ÊùéÁôΩ", poem: "ÈùúÂ§úÊÄù" },
            
            // ÊùéÁôΩ„ÄäÈÄÅÂèã‰∫∫„Äã
            { line: "ÊµÆÈõ≤ÈÅäÂ≠êÊÑè", author: "ÊùéÁôΩ", poem: "ÈÄÅÂèã‰∫∫" },
            { line: "ËêΩÊó•ÊïÖ‰∫∫ÊÉÖ", author: "ÊùéÁôΩ", poem: "ÈÄÅÂèã‰∫∫" },
            
            // ÊùéÁôΩ„ÄäË¥àÊ±™ÂÄ´„Äã
            { line: "Ê°ÉËä±ÊΩ≠Ê∞¥Ê∑±ÂçÉÂ∞∫", author: "ÊùéÁôΩ", poem: "Ë¥àÊ±™ÂÄ´" },
            { line: "‰∏çÂèäÊ±™ÂÄ´ÈÄÅÊàëÊÉÖ", author: "ÊùéÁôΩ", poem: "Ë¥àÊ±™ÂÄ´" },
            
            // ÊùéÁôΩ„ÄäÊúõÂª¨Â±±ÁÄëÂ∏É„ÄãÂÖ∂‰∫å
            { line: "È£õÊµÅÁõ¥‰∏ã‰∏âÂçÉÂ∞∫", author: "ÊùéÁôΩ", poem: "ÊúõÂª¨Â±±ÁÄëÂ∏É" },
            { line: "ÁñëÊòØÈäÄÊ≤≥ËêΩ‰πùÂ§©", author: "ÊùéÁôΩ", poem: "ÊúõÂª¨Â±±ÁÄëÂ∏É" },
            
            // ÊùéÁôΩ„ÄäÁç®ÂùêÊï¨‰∫≠Â±±„Äã
            { line: "Áõ∏ÁúãÂÖ©‰∏çÂé≠", author: "ÊùéÁôΩ", poem: "Áç®ÂùêÊï¨‰∫≠Â±±" },
            { line: "Âè™ÊúâÊï¨‰∫≠Â±±", author: "ÊùéÁôΩ", poem: "Áç®ÂùêÊï¨‰∫≠Â±±" },
            
            // ÊùéÁôΩ„ÄäÈªÉÈ∂¥Ê®ìÈÄÅÂ≠üÊµ©ÁÑ∂‰πãÂª£Èôµ„Äã
            { line: "Â≠§Â∏ÜÈÅ†ÂΩ±Á¢ßÁ©∫Áõ°", author: "ÊùéÁôΩ", poem: "ÈªÉÈ∂¥Ê®ìÈÄÅÂ≠üÊµ©ÁÑ∂‰πãÂª£Èôµ" },
            { line: "ÂîØË¶ãÈï∑Ê±üÂ§©ÈöõÊµÅ", author: "ÊùéÁôΩ", poem: "ÈªÉÈ∂¥Ê®ìÈÄÅÂ≠üÊµ©ÁÑ∂‰πãÂª£Èôµ" },
            
            // ÊùéÁôΩ„ÄäÊúõÂ§©ÈñÄÂ±±„Äã
            { line: "ÂÖ©Â≤∏ÈùíÂ±±Áõ∏Â∞çÂá∫", author: "ÊùéÁôΩ", poem: "ÊúõÂ§©ÈñÄÂ±±" },
            { line: "Â≠§Â∏Ü‰∏ÄÁâáÊó•ÈÇä‰æÜ", author: "ÊùéÁôΩ", poem: "ÊúõÂ§©ÈñÄÂ±±" },
            
            // ÊùúÁî´„ÄäÂÆ¢Ëá≥„Äã
            { line: "Ëä±Âæë‰∏çÊõæÁ∑£ÂÆ¢ÊéÉ", author: "ÊùúÁî´", poem: "ÂÆ¢Ëá≥" },
            { line: "Ëì¨ÈñÄ‰ªäÂßãÁÇ∫ÂêõÈñã", author: "ÊùúÁî´", poem: "ÂÆ¢Ëá≥" },
            
            // ÊùúÁî´„ÄäÊò•Â§úÂñúÈõ®„Äã
            { line: "Èö®È¢®ÊΩõÂÖ•Â§ú", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            { line: "ÊΩ§Áâ©Á¥∞ÁÑ°ËÅ≤", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            { line: "ÊõâÁúãÁ¥ÖÊøïËôï", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            { line: "Ëä±ÈáçÈå¶ÂÆòÂüé", author: "ÊùúÁî´", poem: "Êò•Â§úÂñúÈõ®" },
            
            // ÊùúÁî´„ÄäÁµïÂè•„Äã
            { line: "ÂÖ©ÂÄãÈªÉÈ∏ùÈ≥¥Áø†Êü≥", author: "ÊùúÁî´", poem: "ÁµïÂè•" },
            { line: "‰∏ÄË°åÁôΩÈ∑∫‰∏äÈùíÂ§©", author: "ÊùúÁî´", poem: "ÁµïÂè•" },
            
            // ÂºµÁ±ç„ÄäÊ•ìÊ©ãÂ§úÊ≥ä„Äã
            { line: "ÊúàËêΩÁÉèÂïºÈúúÊªøÂ§©", author: "ÂºµÁ±ç", poem: "Ê•ìÊ©ãÂ§úÊ≥ä" },
            { line: "Ê±üÊ•ìÊºÅÁÅ´Â∞çÊÑÅÁú†", author: "ÂºµÁ±ç", poem: "Ê•ìÊ©ãÂ§úÊ≥ä" },
            
            // Â≠üÈÉä„ÄäÈÅäÂ≠êÂêü„Äã
            { line: "Ë™∞Ë®ÄÂØ∏ËçâÂøÉ", author: "Â≠üÈÉä", poem: "ÈÅäÂ≠êÂêü" },
            { line: "Â†±Âæó‰∏âÊò•Êöâ", author: "Â≠üÈÉä", poem: "ÈÅäÂ≠êÂêü" },
            
            // ÁôΩÂ±ÖÊòì„ÄäË≥¶ÂæóÂè§ÂéüËçâÈÄÅÂà•„Äã
            { line: "ÈáéÁÅ´Ááí‰∏çÁõ°", author: "ÁôΩÂ±ÖÊòì", poem: "Ë≥¶ÂæóÂè§ÂéüËçâÈÄÅÂà•" },
            { line: "Êò•È¢®ÂêπÂèàÁîü", author: "ÁôΩÂ±ÖÊòì", poem: "Ë≥¶ÂæóÂè§ÂéüËçâÈÄÅÂà•" },
            
            // ÁôΩÂ±ÖÊòì„ÄäÊöÆÊ±üÂêü„Äã
            { line: "‰∏ÄÈÅìÊÆòÈôΩÈã™Ê∞¥‰∏≠", author: "ÁôΩÂ±ÖÊòì", poem: "ÊöÆÊ±üÂêü" },
            { line: "ÂçäÊ±üÁëüÁëüÂçäÊ±üÁ¥Ö", author: "ÁôΩÂ±ÖÊòì", poem: "ÊöÆÊ±üÂêü" },
            
            // ÁôΩÂ±ÖÊòì„ÄäË≥£ÁÇ≠ÁøÅ„Äã
            { line: "ÂèØÊÜêË∫´‰∏äË°£Ê≠£ÂñÆ", author: "ÁôΩÂ±ÖÊòì", poem: "Ë≥£ÁÇ≠ÁøÅ" },
            { line: "ÂøÉÊÜÇÁÇ≠Ë≥§È°òÂ§©ÂØí", author: "ÁôΩÂ±ÖÊòì", poem: "Ë≥£ÁÇ≠ÁøÅ" },
            
            // ÁôΩÂ±ÖÊòì„ÄäÂ§ßÊûóÂØ∫Ê°ÉËä±„Äã
            { line: "‰∫∫ÈñìÂõõÊúàËä≥Ëè≤Áõ°", author: "ÁôΩÂ±ÖÊòì", poem: "Â§ßÊûóÂØ∫Ê°ÉËä±" },
            { line: "Â±±ÂØ∫Ê°ÉËä±ÂßãÁõõÈñã", author: "ÁôΩÂ±ÖÊòì", poem: "Â§ßÊûóÂØ∫Ê°ÉËä±" },
            
            // Ë≥àÂ≥∂„ÄäÂ∞ãÈö±ËÄÖ‰∏çÈÅá„Äã
            { line: "Âè™Âú®Ê≠§Â±±‰∏≠", author: "Ë≥àÂ≥∂", poem: "Â∞ãÈö±ËÄÖ‰∏çÈÅá" },
            { line: "Èõ≤Ê∑±‰∏çÁü•Ëôï", author: "Ë≥àÂ≥∂", poem: "Â∞ãÈö±ËÄÖ‰∏çÈÅá" },
            
            // ÊùúÁâß„ÄäÂ±±Ë°å„Äã
            { line: "ÂÅúËªäÂùêÊÑõÊ•ìÊûóÊôö", author: "ÊùúÁâß", poem: "Â±±Ë°å" },
            { line: "ÈúúËëâÁ¥ÖÊñº‰∫åÊúàËä±", author: "ÊùúÁâß", poem: "Â±±Ë°å" },
            
            // ÊùúÁâß„ÄäÊ±üÂçóÊò•„Äã
            { line: "ÂçóÊúùÂõõÁôæÂÖ´ÂçÅÂØ∫", author: "ÊùúÁâß", poem: "Ê±üÂçóÊò•" },
            { line: "Â§öÂ∞ëÊ®ìËá∫ÁÖôÈõ®‰∏≠", author: "ÊùúÁâß", poem: "Ê±üÂçóÊò•" },
            
            // ÂºµÂøóÂíå„ÄäÊºÅÊ≠åÂ≠ê„Äã
            { line: "ÈùíÁÆ¨Á¨†", author: "ÂºµÂøóÂíå", poem: "ÊºÅÊ≠åÂ≠ê" },
            { line: "Á∂†ËìëË°£", author: "ÂºµÂøóÂíå", poem: "ÊºÅÊ≠åÂ≠ê" },
            { line: "ÊñúÈ¢®Á¥∞Èõ®‰∏çÈ†àÊ≠∏", author: "ÂºµÂøóÂíå", poem: "ÊºÅÊ≠åÂ≠ê" },
            
            // ÁéãÂÆâÁü≥„ÄäÊ¢ÖËä±„Äã
            { line: "ÈÅôÁü•‰∏çÊòØÈõ™", author: "ÁéãÂÆâÁü≥", poem: "Ê¢ÖËä±" },
            { line: "ÁÇ∫ÊúâÊöóÈ¶ô‰æÜ", author: "ÁéãÂÆâÁü≥", poem: "Ê¢ÖËä±" },
            
            // ÁéãÂÆâÁü≥„ÄäÊõ∏ÊπñÈô∞ÂÖàÁîüÂ£Å„ÄãÂÖ∂‰∏Ä
            { line: "‰∏ÄÊ∞¥Ë≠∑Áî∞Â∞áÁ∂†Áπû", author: "ÁéãÂÆâÁü≥", poem: "Êõ∏ÊπñÈô∞ÂÖàÁîüÂ£Å" },
            { line: "ÂÖ©Â±±ÊéíÈó•ÈÄÅÈùí‰æÜ", author: "ÁéãÂÆâÁü≥", poem: "Êõ∏ÊπñÈô∞ÂÖàÁîüÂ£Å" },
            
            // ËòáËªæ„ÄäÊ∞¥Ë™øÊ≠åÈ†≠„Äã
            { line: "‰ΩÜÈ°ò‰∫∫Èï∑‰πÖ", author: "ËòáËªæ", poem: "Ê∞¥Ë™øÊ≠åÈ†≠" },
            { line: "ÂçÉÈáåÂÖ±Â¨ãÂ®ü", author: "ËòáËªæ", poem: "Ê∞¥Ë™øÊ≠åÈ†≠" },
            { line: "‰∫∫ÊúâÊÇ≤Ê≠°Èõ¢Âêà", author: "ËòáËªæ", poem: "Ê∞¥Ë™øÊ≠åÈ†≠" },
            { line: "ÊúàÊúâÈô∞Êô¥ÂúìÁº∫", author: "ËòáËªæ", poem: "Ê∞¥Ë™øÊ≠åÈ†≠" },
            
            // ËòáËªæ„ÄäÈ°åË•øÊûóÂ£Å„Äã
            { line: "‰∏çË≠òÂª¨Â±±ÁúüÈù¢ÁõÆ", author: "ËòáËªæ", poem: "È°åË•øÊûóÂ£Å" },
            { line: "Âè™Á∑£Ë∫´Âú®Ê≠§Â±±‰∏≠", author: "ËòáËªæ", poem: "È°åË•øÊûóÂ£Å" },
            
            // ËòáËªæ„ÄäÈ£≤Êπñ‰∏äÂàùÊô¥ÂæåÈõ®„Äã
            { line: "Ê¨≤ÊääË•øÊπñÊØîË•øÂ≠ê", author: "ËòáËªæ", poem: "È£≤Êπñ‰∏äÂàùÊô¥ÂæåÈõ®" },
            { line: "Ê∑°Â¶ùÊøÉÊäπÁ∏ΩÁõ∏ÂÆú", author: "ËòáËªæ", poem: "È£≤Êπñ‰∏äÂàùÊô¥ÂæåÈõ®" },
            
            // Ê•äËê¨Èáå„ÄäÊõâÂá∫Ê∑®ÊÖàÂØ∫ÈÄÅÊûóÂ≠êÊñπ„ÄãÂÖ∂‰∫å
            { line: "Êé•Â§©ËìÆËëâÁÑ°Á™ÆÁ¢ß", author: "Ê•äËê¨Èáå", poem: "ÊõâÂá∫Ê∑®ÊÖàÂØ∫ÈÄÅÊûóÂ≠êÊñπ" },
            { line: "Êò†Êó•Ëç∑Ëä±Âà•Ê®£Á¥Ö", author: "Ê•äËê¨Èáå", poem: "ÊõâÂá∫Ê∑®ÊÖàÂØ∫ÈÄÅÊûóÂ≠êÊñπ" },
            
            // Êú±ÁÜπ„ÄäËßÄÊõ∏ÊúâÊÑü„Äã
            { line: "ÂïèÊ∏†ÈÇ£ÂæóÊ∏ÖÂ¶ÇË®±", author: "Êú±ÁÜπ", poem: "ËßÄÊõ∏ÊúâÊÑü" },
            { line: "ÁÇ∫ÊúâÊ∫êÈ†≠Ê¥ªÊ∞¥‰æÜ", author: "Êú±ÁÜπ", poem: "ËßÄÊõ∏ÊúâÊÑü" },
            
            // ÊûóÂçá„ÄäÈ°åËá®ÂÆâÈÇ∏„Äã
            { line: "ÊöñÈ¢®Ëñ∞ÂæóÈÅä‰∫∫ÈÜâ", author: "ÊûóÂçá", poem: "È°åËá®ÂÆâÈÇ∏" },
            { line: "Áõ¥ÊääÊù≠Â∑û‰ΩúÊ±¥Â∑û", author: "ÊûóÂçá", poem: "È°åËá®ÂÆâÈÇ∏" },
            
            // È¶¨Ëá¥ÈÅ†„ÄäÂ§©Ê∑®Ê≤ô¬∑ÁßãÊÄù„Äã
            { line: "ÊûØËó§ËÄÅÊ®πÊòèÈ¥â", author: "È¶¨Ëá¥ÈÅ†", poem: "Â§©Ê∑®Ê≤ô¬∑ÁßãÊÄù" },
            { line: "Â∞èÊ©ãÊµÅÊ∞¥‰∫∫ÂÆ∂", author: "È¶¨Ëá¥ÈÅ†", poem: "Â§©Ê∑®Ê≤ô¬∑ÁßãÊÄù" },
            { line: "Â§ïÈôΩË•ø‰∏ã", author: "È¶¨Ëá¥ÈÅ†", poem: "Â§©Ê∑®Ê≤ô¬∑ÁßãÊÄù" },
            { line: "Êñ∑ËÖ∏‰∫∫Âú®Â§©Ê∂Ø", author: "È¶¨Ëá¥ÈÅ†", poem: "Â§©Ê∑®Ê≤ô¬∑ÁßãÊÄù" },
            
            // „ÄäË©©Á∂ì¬∑ÈóúÈõé„Äã
            { line: "ÈóúÈóúÈõéÈ≥©", author: "Ë©©Á∂ì", poem: "ÈóúÈõé" },
            { line: "Âú®Ê≤≥‰πãÊ¥≤", author: "Ë©©Á∂ì", poem: "ÈóúÈõé" },
            { line: "Á™àÁ™ïÊ∑ëÂ•≥", author: "Ë©©Á∂ì", poem: "ÈóúÈõé" },
            { line: "ÂêõÂ≠êÂ•ΩÈÄë", author: "Ë©©Á∂ì", poem: "ÈóúÈõé" },
            
            // „ÄäË©©Á∂ì¬∑ËíπËë≠„Äã
            { line: "ËíπËë≠ËíºËíº", author: "Ë©©Á∂ì", poem: "ËíπËë≠" },
            { line: "ÁôΩÈú≤ÁÇ∫Èúú", author: "Ë©©Á∂ì", poem: "ËíπËë≠" },
            { line: "ÊâÄË¨Ç‰ºä‰∫∫", author: "Ë©©Á∂ì", poem: "ËíπËë≠" },
            { line: "Âú®Ê∞¥‰∏ÄÊñπ", author: "Ë©©Á∂ì", poem: "ËíπËë≠" },
            
            // ÊõπÊ§ç„Ää‰∏ÉÂìÄË©©„Äã
            { line: "ÊòéÊúàÁÖßÈ´òÊ®ì", author: "ÊõπÊ§ç", poem: "‰∏ÉÂìÄË©©" },
            { line: "ÊµÅÂÖâÊ≠£ÂæòÂæä", author: "ÊõπÊ§ç", poem: "‰∏ÉÂìÄË©©" },
            { line: "È°òÁÇ∫Ë•øÂçóÈ¢®", author: "ÊõπÊ§ç", poem: "‰∏ÉÂìÄË©©" },
            { line: "Èï∑ÈÄùÂÖ•ÂêõÊá∑", author: "ÊõπÊ§ç", poem: "‰∏ÉÂìÄË©©" },
            
            // Èô∂Ê∑µÊòé„ÄäÊ≠∏ÂúíÁî∞Â±Ö„ÄãÂÖ∂‰∏Ä
            { line: "ÁæàÈ≥•ÊàÄËàäÊûó", author: "Èô∂Ê∑µÊòé", poem: "Ê≠∏ÂúíÁî∞Â±Ö" },
            { line: "Ê±†È≠öÊÄùÊïÖÊ∑µ", author: "Èô∂Ê∑µÊòé", poem: "Ê≠∏ÂúíÁî∞Â±Ö" },
            { line: "‰πÖÂú®Ê®äÁ±†Ë£è", author: "Èô∂Ê∑µÊòé", poem: "Ê≠∏ÂúíÁî∞Â±Ö" },
            { line: "Âæ©ÂæóËøîËá™ÁÑ∂", author: "Èô∂Ê∑µÊòé", poem: "Ê≠∏ÂúíÁî∞Â±Ö" },
            
            // Èô∂Ê∑µÊòé„ÄäÈ£≤ÈÖíË©©„Äã
            { line: "Êé°ËèäÊù±Á±¨‰∏ã", author: "Èô∂Ê∑µÊòé", poem: "È£≤ÈÖíË©©" },
            { line: "ÊÇ†ÁÑ∂Ë¶ãÂçóÂ±±", author: "Èô∂Ê∑µÊòé", poem: "È£≤ÈÖíË©©" },
            { line: "ÂïèÂêõ‰ΩïËÉΩÁàæ", author: "Èô∂Ê∑µÊòé", poem: "È£≤ÈÖíË©©" },
            { line: "ÂøÉÈÅ†Âú∞Ëá™ÂÅè", author: "Èô∂Ê∑µÊòé", poem: "È£≤ÈÖíË©©" },
            
            // ÂºµËã•Ëôõ„ÄäÊò•Ê±üËä±ÊúàÂ§ú„Äã
            { line: "Êò•Ê±üÊΩÆÊ∞¥ÈÄ£Êµ∑Âπ≥", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "Êµ∑‰∏äÊòéÊúàÂÖ±ÊΩÆÁîü", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "Ê±üÁïî‰Ωï‰∫∫ÂàùË¶ãÊúà", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "Ê±üÊúà‰ΩïÂπ¥ÂàùÁÖß‰∫∫", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "‰∫∫Áîü‰ª£‰ª£ÁÑ°Á™ÆÂ∑≤", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "Ê±üÊúàÂπ¥Âπ¥Âè™Áõ∏‰ºº", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "‰∏çÁü•Ê±üÊúàÂæÖ‰Ωï‰∫∫", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            { line: "‰ΩÜË¶ãÈï∑Ê±üÈÄÅÊµÅÊ∞¥", author: "ÂºµËã•Ëôõ", poem: "Êò•Ê±üËä±ÊúàÂ§ú" },
            
            // ÊùéÁôΩ„ÄäËúÄÈÅìÈõ£„Äã
            { line: "ËúÄÈÅì‰πãÈõ£", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "Èõ£Êñº‰∏äÈùíÂ§©", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "‰∏ÄÂ§´Áï∂Èóú", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "Ëê¨Â§´Ëé´Èñã", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "ÈÄ£Â≥∞ÂéªÂ§©‰∏çÁõàÂ∞∫", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "ÊûØÊùæÂÄíÊéõÂÄöÁµïÂ£Å", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "ÂäçÈñ£Â¥¢Â∂∏ËÄåÂ¥îÂµ¨", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            { line: "ÊâÄÂÆàÊàñÂå™Ë¶™", author: "ÊùéÁôΩ", poem: "ËúÄÈÅìÈõ£" },
            
            // ÊùéÁôΩ„ÄäÂ§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•„Äã
            { line: "ÂÆâËÉΩÊëßÁúâÊäòËÖ∞‰∫ãÊ¨äË≤¥", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "‰ΩøÊàë‰∏çÂæóÈñãÂøÉÈ°è", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "ÂçäÂ£ÅË¶ãÊµ∑Êó•", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "Á©∫‰∏≠ËÅûÂ§©Èõû", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "ÈúìÁÇ∫Ë°£ÂÖÆÈ¢®ÁÇ∫È¶¨", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "Èõ≤‰πãÂêõÂÖÆÁ¥õÁ¥õËÄå‰æÜ‰∏ã", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "‰∏îÊîæÁôΩÈπøÈùíÂ¥ñÈñì", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            { line: "È†àË°åÂç≥È®éË®™ÂêçÂ±±", author: "ÊùéÁôΩ", poem: "Â§¢ÈÅäÂ§©Âß•ÂêüÁïôÂà•" },
            
            // ÊùéÁôΩ„ÄäÂ∞áÈÄ≤ÈÖí„Äã
            { line: "Âêõ‰∏çË¶ãÈªÉÊ≤≥‰πãÊ∞¥Â§©‰∏ä‰æÜ", author: "ÊùéÁôΩ", poem: "Â∞áÈÄ≤ÈÖí" },
            { line: "Â•îÊµÅÂà∞Êµ∑‰∏çÂæ©Âõû", author: "ÊùéÁôΩ", poem: "Â∞áÈÄ≤ÈÖí" },
            { line: "Â§©ÁîüÊàëÊùêÂøÖÊúâÁî®", author: "ÊùéÁôΩ", poem: "Â∞áÈÄ≤ÈÖí" },
            { line: "ÂçÉÈáëÊï£Áõ°ÈÇÑÂæ©‰æÜ", author: "ÊùéÁôΩ", poem: "Â∞áÈÄ≤ÈÖí" },
            { line: "Âè§‰æÜËÅñË≥¢ÁöÜÂØÇÂØû", author: "ÊùéÁôΩ", poem: "Â∞áÈÄ≤ÈÖí" },
            { line: "ÊÉüÊúâÈ£≤ËÄÖÁïôÂÖ∂Âêç", author: "ÊùéÁôΩ", poem: "Â∞áÈÄ≤ÈÖí" },
            
            // ÊùúÁî´„ÄäÁôªÈ´ò„Äã
            { line: "ÁÑ°ÈÇäËêΩÊú®Ëï≠Ëï≠‰∏ã", author: "ÊùúÁî´", poem: "ÁôªÈ´ò" },
            { line: "‰∏çÁõ°Èï∑Ê±üÊªæÊªæ‰æÜ", author: "ÊùúÁî´", poem: "ÁôªÈ´ò" },
            { line: "Ëê¨ÈáåÊÇ≤ÁßãÂ∏∏‰ΩúÂÆ¢", author: "ÊùúÁî´", poem: "ÁôªÈ´ò" },
            { line: "ÁôæÂπ¥Â§öÁóÖÁç®ÁôªËá∫", author: "ÊùúÁî´", poem: "ÁôªÈ´ò" },
            
            // ÊùéÂïÜÈö±„ÄäÁÑ°È°å„Äã
            { line: "Êò•Ë†∂Âà∞Ê≠ªÁµ≤ÊñπÁõ°", author: "ÊùéÂïÜÈö±", poem: "ÁÑ°È°å" },
            { line: "Ë†üÁÇ¨ÊàêÁÅ∞Ê∑öÂßã‰πæ", author: "ÊùéÂïÜÈö±", poem: "ÁÑ°È°å" },
            { line: "Ë∫´ÁÑ°ÂΩ©È≥≥ÈõôÈ£õÁøº", author: "ÊùéÂïÜÈö±", poem: "ÁÑ°È°å" },
            { line: "ÂøÉÊúâÈùàÁäÄ‰∏ÄÈªûÈÄö", author: "ÊùéÂïÜÈö±", poem: "ÁÑ°È°å" },
            
            // ÁôΩÂ±ÖÊòì„ÄäÈï∑ÊÅ®Ê≠å„Äã
            { line: "ÂõûÁú∏‰∏ÄÁ¨ëÁôæÂ™öÁîü", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "ÂÖ≠ÂÆÆÁ≤âÈªõÁÑ°È°èËâ≤", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "Âú®Â§©È°ò‰ΩúÊØîÁøºÈ≥•", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "Âú®Âú∞È°òÁÇ∫ÈÄ£ÁêÜÊûù", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "Â§©Èï∑Âú∞‰πÖÊúâÊôÇÁõ°", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "Ê≠§ÊÅ®Á∂øÁ∂øÁÑ°ÁµïÊúü", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "Êò•È¢®Ê°ÉÊùéËä±ÈñãÊó•", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            { line: "ÁßãÈõ®Ê¢ßÊ°êËëâËêΩÊôÇ", author: "ÁôΩÂ±ÖÊòì", poem: "Èï∑ÊÅ®Ê≠å" },
            
            // ÊùéÁÖú„ÄäËôûÁæé‰∫∫„Äã
            { line: "ÂïèÂêõËÉΩÊúâÂπæÂ§öÊÑÅ", author: "ÊùéÁÖú", poem: "ËôûÁæé‰∫∫" },
            { line: "ÊÅ∞‰ºº‰∏ÄÊ±üÊò•Ê∞¥ÂêëÊù±ÊµÅ", author: "ÊùéÁÖú", poem: "ËôûÁæé‰∫∫" },
            
            // ËæõÊ£ÑÁñæ„ÄäÈùíÁéâÊ°à¬∑ÂÖÉÂ§ï„Äã
            { line: "ÁúæË£èÂ∞ã‰ªñÂçÉÁôæÂ∫¶", author: "ËæõÊ£ÑÁñæ", poem: "ÈùíÁéâÊ°à¬∑ÂÖÉÂ§ï" },
            { line: "È©ÄÁÑ∂ÂõûÈ¶ñ", author: "ËæõÊ£ÑÁñæ", poem: "ÈùíÁéâÊ°à¬∑ÂÖÉÂ§ï" },
            { line: "ÈÇ£‰∫∫ÂçªÂú®", author: "ËæõÊ£ÑÁñæ", poem: "ÈùíÁéâÊ°à¬∑ÂÖÉÂ§ï" },
            { line: "ÁáàÁÅ´ÈóåÁèäËôï", author: "ËæõÊ£ÑÁñæ", poem: "ÈùíÁéâÊ°à¬∑ÂÖÉÂ§ï" },
            
            // ÊñáÂ§©Á••„ÄäÈÅéÈõ∂‰∏ÅÊ¥ã„Äã
            { line: "‰∫∫ÁîüËá™Âè§Ë™∞ÁÑ°Ê≠ª", author: "ÊñáÂ§©Á••", poem: "ÈÅéÈõ∂‰∏ÅÊ¥ã" },
            { line: "ÁïôÂèñ‰∏πÂøÉÁÖßÊ±óÈùí", author: "ÊñáÂ§©Á••", poem: "ÈÅéÈõ∂‰∏ÅÊ¥ã" },
            { line: "Â±±Ê≤≥Á†¥Á¢éÈ¢®È£ÑÁµÆ", author: "ÊñáÂ§©Á••", poem: "ÈÅéÈõ∂‰∏ÅÊ¥ã" },
            { line: "Ë∫´‰∏ñÊµÆÊ≤âÈõ®ÊâìËêç", author: "ÊñáÂ§©Á••", poem: "ÈÅéÈõ∂‰∏ÅÊ¥ã" },
            
            // Á¥çËò≠ÊÄßÂæ∑„ÄäÊú®Ëò≠Ëä±¬∑Êì¨Âè§Ê±∫ÁµïË©û„Äã
            { line: "‰∫∫ÁîüËã•Âè™Â¶ÇÂàùË¶ã", author: "Á¥çËò≠ÊÄßÂæ∑", poem: "Êú®Ëò≠Ëä±¬∑Êì¨Âè§Ê±∫ÁµïË©û" },
            { line: "‰Ωï‰∫ãÁßãÈ¢®ÊÇ≤Áï´Êâá", author: "Á¥çËò≠ÊÄßÂæ∑", poem: "Êú®Ëò≠Ëä±¬∑Êì¨Âè§Ê±∫ÁµïË©û" },
            { line: "Á≠âÈñíËÆäÂçªÊïÖ‰∫∫ÂøÉ", author: "Á¥çËò≠ÊÄßÂæ∑", poem: "Êú®Ëò≠Ëä±¬∑Êì¨Âè§Ê±∫ÁµïË©û" },
            { line: "ÂçªÈÅìÊïÖ‰∫∫ÂøÉÊòìËÆä", author: "Á¥çËò≠ÊÄßÂæ∑", poem: "Êú®Ëò≠Ëä±¬∑Êì¨Âè§Ê±∫ÁµïË©û" },
            
            // ÊùéÁôΩ„ÄäÂÆ£Â∑ûË¨ùËÑÅÊ®ìÈ§ûÂà•Ê†°Êõ∏ÂèîÈõ≤„Äã
            { line: "ÊäΩÂàÄÊñ∑Ê∞¥Ê∞¥Êõ¥ÊµÅ", author: "ÊùéÁôΩ", poem: "ÂÆ£Â∑ûË¨ùËÑÅÊ®ìÈ§ûÂà•Ê†°Êõ∏ÂèîÈõ≤" },
            { line: "ËàâÊùØÊ∂àÊÑÅÊÑÅÊõ¥ÊÑÅ", author: "ÊùéÁôΩ", poem: "ÂÆ£Â∑ûË¨ùËÑÅÊ®ìÈ§ûÂà•Ê†°Êõ∏ÂèîÈõ≤" },
            { line: "‰∫∫ÁîüÂú®‰∏ñ‰∏çÁ®±ÊÑè", author: "ÊùéÁôΩ", poem: "ÂÆ£Â∑ûË¨ùËÑÅÊ®ìÈ§ûÂà•Ê†°Êõ∏ÂèîÈõ≤" },
            { line: "ÊòéÊúùÊï£È´ÆÂºÑÊâÅËàü", author: "ÊùéÁôΩ", poem: "ÂÆ£Â∑ûË¨ùËÑÅÊ®ìÈ§ûÂà•Ê†°Êõ∏ÂèîÈõ≤" },
            
            // ÊùéË≥Ä„ÄäÈõÅÈñÄÂ§™ÂÆàË°å„Äã
            { line: "ÈªëÈõ≤Â£ìÂüéÂüéÊ¨≤Êëß", author: "ÊùéË≥Ä", poem: "ÈõÅÈñÄÂ§™ÂÆàË°å" },
            { line: "Áî≤ÂÖâÂêëÊó•ÈáëÈ±óÈñã", author: "ÊùéË≥Ä", poem: "ÈõÅÈñÄÂ§™ÂÆàË°å" },
            { line: "Â†±ÂêõÈªÉÈáëËá∫‰∏äÊÑè", author: "ÊùéË≥Ä", poem: "ÈõÅÈñÄÂ§™ÂÆàË°å" },
            { line: "ÊèêÊîúÁéâÈæçÁÇ∫ÂêõÊ≠ª", author: "ÊùéË≥Ä", poem: "ÈõÅÈñÄÂ§™ÂÆàË°å" }
        ];

        // DOM elements
        const charactersGrid = document.getElementById('charactersGrid');
        const poemDisplay = document.getElementById('poemDisplay');
        const poemHint = document.getElementById('poemHint');
        const charCountDisplay = document.getElementById('charCountDisplay');
        const timerElement = document.getElementById('timer');
        const clearSelectionButton = document.getElementById('clearSelection');
        const submitButton = document.getElementById('submitPoem');
        const scoreElement = document.getElementById('score');
        const scoreLabel = document.getElementById('scoreLabel');
        const gameMessage = document.getElementById('gameMessage');
        const resultIcon = document.getElementById('resultIcon');
        const poemErrorIcon = document.getElementById('poemErrorIcon');
        const successIcon = document.getElementById('successIcon');
        const correctAnswer = document.getElementById('correctAnswer');
        const correctAnswerText = document.getElementById('correctAnswerText');
        const closeGameMessage = document.getElementById('closeGameMessage');
        const aiExplainSuccessRow = document.getElementById('aiExplainSuccessRow');
        const aiExplainBtnSuccess = document.getElementById('aiExplainBtnSuccess');
        const aiExplainFailRow = document.getElementById('aiExplainFailRow');
        const aiExplainBtnFail = document.getElementById('aiExplainBtnFail');
        const aiExplainModal = document.getElementById('aiExplainModal');
        const aiExplainClose = document.getElementById('aiExplainClose');
        const aiExplainOK = document.getElementById('aiExplainOK');
        const aiExplainReload = document.getElementById('aiExplainReload');
        const aiExplainLine = document.getElementById('aiExplainLine');
        const aiExplainMeta = document.getElementById('aiExplainMeta');
        const aiExplainContent = document.getElementById('aiExplainContent');
        const aiExplainError = document.getElementById('aiExplainError');
        
        // Notification elements
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const closeNotification = document.getElementById('closeNotification');
        const timeBarFill = document.getElementById('timeBarFill');
        const timeBarContainer = document.getElementById('timeBarContainer');
        const selectionStatus = document.getElementById('selectionStatus');

        // ===== Ê®°ÂºèËºîÂä©ÔºöÈõÜ‰∏≠Âà§Êñ∑ÂÖ•Âè£ÔºåÈÅøÂÖçÊ¢ù‰ª∂ÂàÜÊï£ÈáçË¶Ü =====
        // „ÄêÈáçÊßã„ÄëÂ∑≤ÁßªÈô§ window.GameMode.isTimedScore()ÔºåÊîπÁî® GameMode.isTimedScore()
        function isLocalBattle(){
            try { return window.GameMode.isLocal() && window.GameState.isActive; } catch(_) { return false; }
        }

        // Êèê‰æõÂëΩÂêçÁ©∫ÈñìÂç†‰ΩçÔºåÂæåÁ∫åÂèØÈÄêÊ≠•ÊääÁõ∏ÈóúÂáΩÂºèÊéõËºâËá≥Ê≠§ÔºåÈÅøÂÖçÊ∑∑Âêç
        window.LocalBattle = window.LocalBattle || {};
        window.RemoteTimed = window.RemoteTimed || {};
        // ===== Á´∂Ë≥ΩË≥ΩÈÅìÔºöemoji ÂàÜÈÖçËàáÊ∏≤Êüì =====
        (function(){
            const EMOJI_POOL = Array.from(
                'üêØü¶äüêºüê∏üê∂üê±üê∞ü¶Åüêµü¶Ñüê®üê∑üêÆüêîüê§ü¶Üü¶âü¶áüêôü¶ëü¶Äü¶ûü¶êüê†üêüüê¨üê≥üêäüê¢ü¶éüêçüêùü¶ãüêûüêúüï∑Ô∏èü¶Çüêåüêõü¶îü¶•ü¶®ü¶òü¶ùü¶öü¶úü¶¢ü¶©üïäÔ∏èüêßüê¶üê§ü¶Üü¶Öüê∫ü¶Ñü¶íü¶ìü¶åüêóü¶èüêòüê´üê™ü¶ôüêêüêèüêëüêéüêÑ'
            );
            const nameMax = { cn: 3, en: 6 };
            function isMostlyChinese(s){
                const m = (s||'').match(/[\u4e00-\u9fa5]/g);
                return (m ? m.length : 0) * 2 >= String(s||'').length; // Á≤óÁï•Âà§Êñ∑
            }
            function trimName(s){
                s = String(s||'');
                const max = isMostlyChinese(s) ? nameMax.cn : nameMax.en;
                if (s.length <= max) return s;
                return s.slice(0, max) + '‚Ä¶';
            }
            function seededPick(arr, seed){
                let h = 2166136261>>>0; const str = String(seed||'');
                for (let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = (h * 16777619)>>>0; }
                return arr[h % arr.length];
            }
            function assignEmojisFor(ids, roomCode){
                const used = new Set();
                const map = {};
                (ids||[]).forEach((id, idx) => {
                    let pick = seededPick(EMOJI_POOL, roomCode+':'+id+':'+idx);
                    let guard=0;
                    while (used.has(pick) && guard<EMOJI_POOL.length) { pick = seededPick(EMOJI_POOL, roomCode+':'+id+':'+idx+':'+(guard)); guard++; }
                    used.add(pick); map[id] = pick;
                });
                return map;
            }
            window.RaceTrack = {
                buildEmojiMap(ids, roomCode){ return assignEmojisFor(ids, roomCode||'ROOM'); },
                ensureEmojis(){
                    // „ÄêÈáçÊßã„Äë‰∏çÂÜçÈúÄË¶ÅÔºåemoji Âú®ÂàùÂßãÂåñÊôÇÂ∑≤ÂàÜÈÖçÂà∞ GameState.players
                    try { console.debug('[race] ensureEmojis: skipped (using GameState)'); } catch(_){ }
                },
                render(){
                    try {
                        // console.log('[race] render: START'); // Â∑≤ÈóúÈñâË™øË©¶Êó•Âøó
                        const track = document.getElementById('raceTrack');
                        if (!track) return;
                        
                        // „ÄêÈáçÊßã„ÄëÁõ¥Êé•Âà§Êñ∑Ê®°ÂºèÔºå‰∏çÂÜçÈúÄË¶ÅÂêåÊ≠•
                        if (!window.GameMode.isAnyBattle()) {
                            track.classList.add('hidden');
                            // ÊÅ¢Âæ©ÂÄíË®àÊôÇÈÄ≤Â∫¶Ê¢ùÈ°ØÁ§∫
                            try {
                                const timeBarFill = document.getElementById('timeBarFill');
                                if (timeBarFill && timeBarFill.style.display === 'none') {
                                    timeBarFill.style.display = '';
                                }
                            } catch(_){}
                            return;
                        }
                        
                        track.classList.remove('hidden');
                        
                        // „ÄêÈáçÊßã„ÄëÁõ¥Êé•ËÆÄÂèñÁµ±‰∏ÄÊï∏ÊìöÊ∫ê
                        const players = window.GameState.players;
                        if (!players || players.length === 0) {
                            return;
                        }
                        
                        const rows = players.map(p => ({
                            uid: p.uid,
                            name: trimName(p.name),
                            score: p.score || 0,
                            last: p.lastAnswerTs || 0,
                            emoji: p.emoji || 'üèÉ'
                        }));
                        
                        const maxScore = Math.max(1, ...rows.map(r => r.score));
                        // console.log('[race] render scores:', rows.map(r => `${r.name}: ${r.score}`).join(', '), 'maxScore:', maxScore); // Â∑≤ÈóúÈñâË™øË©¶Êó•Âøó
                        
                        // ÊéíÂêçÔºàÂÉÖ‰æõÂæΩÁ´†‰ΩøÁî®Ôºâ
                        const ranked = [...rows].sort((a,b) => (b.score - a.score) || (a.last - b.last));
                        const rankByUid = {}; ranked.forEach((r,i)=> rankByUid[r.uid] = i+1);
                        
                        // È¶ñÊ¨°Ê∏≤ÊüìÂª∫Ê®π
                        if (!track.dataset.built) { track.innerHTML = ''; track.dataset.built = '1'; }
                        
                        // Áç≤ÂèñÁï∂ÂâçÁî®Êà∂ IDÔºàÁî®ÊñºÈ´ò‰∫ÆÔºåÂÉÖÈÅ†Á®ãÊ®°ÂºèÔºâ
                        const currentUserId = (window.GameMode.isRemote() && window.GameState.remote.currentUserId) || null;
                        
                        // ÁÇ∫ÊØè‰ΩçÈÅ∏ÊâãÂª∫/Êõ¥Êñ∞ÁØÄÈªû
                        rows.forEach((r, i) => {
                            // Âè™Âú®ÈÅ†Á®ãÊ®°ÂºèÈ´ò‰∫ÆËá™Â∑±ÔºåÊú¨Âú∞Ê®°Âºè‰∏çÈ´ò‰∫Æ
                            const isMe = window.GameMode.isRemote() && (currentUserId && r.uid === currentUserId);
                            let pin = track.querySelector(`[data-uid="${r.uid}"]`);
                            if (!pin) {
                                pin = document.createElement('div');
                                pin.dataset.uid = r.uid;
                                // Á∞°ÂåñË≥ΩÈÅìÔºöÂè™È°ØÁ§∫ emojiÔºåËá™Â∑±ÁöÑÂãïÁâ©ÊîæÂ§ß‰∏îÂä†Èô∞ÂΩ±
                                const emojiSize = isMe ? 'text-3xl sm:text-4xl' : 'text-2xl sm:text-3xl';
                                const pinClass = isMe ? 'shadow-lg ring-2 ring-yellow-400' : 'shadow-md';
                                pin.className = `w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/90 flex items-center justify-center ${pinClass} transition-all duration-500 ease-out will-change-transform`;
                                pin.style.position = 'absolute';
                                pin.style.top = '50%';
                                pin.innerHTML = `<span class="emoji ${emojiSize}">${r.emoji}</span>`;
                                track.appendChild(pin);
                                // console.log('[race] render: created pin for', r.name, 'emoji=', r.emoji, 'isMe=', isMe); // Â∑≤ÈóúÈñâË™øË©¶Êó•Âøó
                            } else {
                                pin.querySelector('.emoji').textContent = r.emoji;
                                // Êõ¥Êñ∞È´ò‰∫ÆÁãÄÊÖã
                                const emojiEl = pin.querySelector('.emoji');
                                if (isMe) {
                                    emojiEl.className = 'emoji text-3xl sm:text-4xl';
                                    pin.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/90 flex items-center justify-center shadow-lg ring-2 ring-yellow-400 transition-all duration-500 ease-out will-change-transform';
                                } else {
                                    emojiEl.className = 'emoji text-2xl sm:text-3xl';
                                    pin.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-white/90 flex items-center justify-center shadow-md transition-all duration-500 ease-out will-change-transform';
                                }
                            }
                            
                            // „Äê‰øÆÂæ©„ÄëÊ†πÊìöÂàÜÊï∏Ë®àÁÆó‰ΩçÁΩÆÔºåÊ≠£Á¢∫Ë®≠ÁΩÆ left Âíå transform
                            const pct = Math.max(3, Math.min(97, Math.round((r.score / maxScore) * 94 + 3)));
                            const offsetY = ((r.uid||'').charCodeAt(0)%5)-2; // -2..+2 ÂûÇÁõ¥ÈåØÂ±§
                            const scale = isMe ? 1.2 : 1;
                            // console.log(`[race] ${r.name}: score=${r.score}, maxScore=${maxScore}, pct=${pct}%`); // Â∑≤ÈóúÈñâË™øË©¶Êó•Âøó
                            
                            // ‰ΩøÁî® left Ë®≠ÁΩÆÊ∞¥Âπ≥‰ΩçÁΩÆÔºåtransform Âè™Ë≤†Ë≤¨Â±Ö‰∏≠„ÄÅÂûÇÁõ¥ÂÅèÁßªÂíåÁ∏ÆÊîæ
                            pin.style.left = pct + '%';
                            pin.style.transform = `translate(-50%, calc(-50% + ${offsetY}px)) scale(${scale})`;
                        });
                        // console.log('[race] render: COMPLETE. rendered', rows.length, 'pins'); // Â∑≤ÈóúÈñâË™øË©¶Êó•Âøó
                    } catch(e){ console.error('[race] render ERROR:', e); }
                }
            };
        })();

        // Difficulty settings
        const difficultySettings = {
            easy: { timeLimit: 45, charCount: 15 },
            medium: { timeLimit: 30, charCount: 15 },
            hard: { timeLimit: 15, charCount: 15 }
        };
        
        // Game state variables
        let timerInterval;
        let timeLeft = 30;
        let charCount = 15;
        let score = 0;
        let currentPoem;
        let isGameActive = false;
        let poemCharacters = [];
        let shuffledCharacters = [];
        let currentGameMode = 'preset'; // 'preset', 'custom', or 'battle'
        let customPoems = [];
        let roundTimeLimit = 30; // Áï∂ÂâçÂõûÂêàÊôÇÈñì‰∏äÈôêÔºåÁî®ÊñºÈÄ≤Â∫¶Ê¢ùÊØî‰æã
        let areCoreListenersBound = false; // Èò≤Ê≠¢ÈáçË§áÁ∂ÅÂÆö
        let selectionStack = []; // Â∑≤ÈÅ∏Â≠óÂ†ÜÁñäÔºàÊîØÊåÅÊí§ÂõûÔºâ
        
        // „ÄêÈáçÊßã„ÄëÂ∞çÊà∞Ê®°ÂºèÊï∏ÊìöÂ∑≤ÈÅ∑ÁßªÂà∞ window.GameStateÔºå‰∏çÂÜç‰ΩøÁî®Â±ÄÈÉ® battleMode Â∞çË±°
        
        // Difficulty settings elements
        const difficultySelect = document.getElementById('difficultySelect');
        const timeLimitSlider = document.getElementById('timeLimit');
        const timeLimitValue = document.getElementById('timeLimitValue');
        const charCountSlider = document.getElementById('charCount');
        const charCountValue = document.getElementById('charCountValue');
        
        // Custom poem elements (gameMode Â∑≤ÁßªËá≥Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó‰∏≠ÁöÑradioÊåâÈàï)
        // Â∑≤ÁßªÈô§Ëá™ÂÆöÁæ©Ë©©Âè•ÂäüËÉΩÔºàÁõ∏ÈóúÂÖÉÁ¥†‰∏çÂÜç‰ΩøÁî®Ôºâ
        // Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™óÂÖÉÁ¥†
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const adminModeToggle = document.getElementById('adminModeToggle');
        
        // Â∞çÊà∞ÁµêÊùüÁ∏ΩÁµêÁ™óÂè£ÂÖÉÁ¥†
        const battleResultModal = document.getElementById('battleResultModal');
        const winnerAnnouncement = document.getElementById('winnerAnnouncement');
        const winnerScore = document.getElementById('winnerScore');
        const battleRankings = document.getElementById('battleRankings');
        const newBattleBtn = document.getElementById('newBattleBtn');
        const exitBattleBtn = document.getElementById('exitBattleBtn');
        
        // Â∞çÊà∞Ê®°ÂºèÂÖÉÁ¥†
        const battleModeSettings = document.getElementById('battleModeSettings');
        const playerCountSelect = document.getElementById('playerCount');
        const playerNamesContainer = document.getElementById('playerNamesContainer');
        const roundsPerPlayerInput = document.getElementById('roundsPerPlayer');
        const speedModeCheckbox = document.getElementById('speedMode');
        const battleScoreboard = document.getElementById('battleScoreboard');
        const leftPlayersContainer = document.getElementById('leftPlayers');
        const rightPlayersContainer = document.getElementById('rightPlayers');
        const battlePreviewModal = document.getElementById('battlePreviewModal');
        const battlePreviewClose = document.getElementById('battlePreviewClose');
        const battlePreviewBack = document.getElementById('battlePreviewBack');
        const battlePreviewStart = document.getElementById('battlePreviewStart');
        const battlePreviewPlayerCount = document.getElementById('battlePreviewPlayerCount');
        const battlePreviewRounds = document.getElementById('battlePreviewRounds');
        const battlePreviewTotalQuestions = document.getElementById('battlePreviewTotalQuestions');
        const battlePreviewTimeLimit = document.getElementById('battlePreviewTimeLimit');
        const battlePreviewCharCount = document.getElementById('battlePreviewCharCount');
        const battlePreviewPlayersList = document.getElementById('battlePreviewPlayersList');
        const battlePreviewSpeedRow = document.getElementById('battlePreviewSpeedRow');
        const battlePreviewSpeedText = document.getElementById('battlePreviewSpeedText');
        const battlePreviewNote = document.getElementById('battlePreviewNote');
        // startBattleBtn Â∑≤ÁßªÈô§ÔºåÂ∞çÊà∞Ê®°ÂºèÈÄöÈÅé‰øùÂ≠òË®≠ÁΩÆËá™ÂãïÂïüÂãï
        const customPoemInput = document.getElementById('customPoem');
        const saveCustomPoemButton = document.getElementById('saveCustomPoem');
        const savedPoemsList = document.getElementById('savedPoemsList');
        const noSavedPoems = document.getElementById('noSavedPoems');

        // Show notification
        const showNotification = (message, duration = 3000) => {
            notificationText.textContent = message;
            notification.classList.remove('translate-y-[-150%]');
            notification.classList.add('translate-y-0');
            
            setTimeout(() => {
                notification.classList.remove('translate-y-0');
                notification.classList.add('translate-y-[-150%]');
            }, duration);
        };

        // Close notification manually
        closeNotification.addEventListener('click', () => {
            notification.classList.remove('translate-y-0');
            notification.classList.add('translate-y-[-150%]');
        });

        // Close game message manually
        closeGameMessage.addEventListener('click', () => {
            hideResultModal();
            // ÈôêÊôÇÊ®°Âºè‰∏ã‰∏çËß∏Áôº‰ªª‰ΩïÊú¨Âú∞Ëº™ÊµÅÊàñÊâãÂãïÊèõÈ°åÊµÅÁ®ãÔºàÂ∑≤Ëá™ÂãïÊèõÈ°åÔºâ
            if (window.GameMode.isTimedScore()) {
                return;
            }
            // Â¶ÇÊûúÊòØÂØπÊàòÊ®°Âºè‰∏îÊ∏∏ÊàèÁªìÊùüÔºåÂàôËøõÂÖ•‰∏ã‰∏ÄËΩÆ
            if (window.GameMode.isLocal() && window.GameState.isActive && !isGameActive) {
                // Âª∂Ëøü‰∏Ä‰∏ãËÆ©Áî®Êà∑ÁúãÂà∞ÂÖ≥Èó≠Âä®Áîª
                setTimeout(() => {
                    if (typeof window.LocalBattle?.startRound === 'function') window.LocalBattle.startRound();
                }, 250);
            } else if (!isGameActive) {
                // Âçï‰∫∫Ê®°ÂºèÔºåÂºÄÂßãÊñ∞‰∏ÄËΩÆ
                setTimeout(() => {
                    startNewRound();
                }, 250);
            }
        });

        // ËÆ°ÁÆóÂπ∂ËÆæÁΩÆÈîôËØØÂõæÊ†á‰ΩçÁΩÆ
        const positionErrorIcon = () => {
            if (!poemDisplay.value || poemDisplay.value === 'ÊôÇÈñìÂà∞') return;
            
            // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÂÖÉÁ¥†Êù•ÊµãÈáèÊñáÂ≠óÂÆΩÂ∫¶
            const tempSpan = document.createElement('span');
            tempSpan.style.font = window.getComputedStyle(poemDisplay).font;
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.whiteSpace = 'nowrap';
            tempSpan.textContent = poemDisplay.value;
            document.body.appendChild(tempSpan);
            
            const textWidth = tempSpan.offsetWidth;
            document.body.removeChild(tempSpan);
            
            // ËÆ°ÁÆóÂõæÊ†á‰ΩçÁΩÆÔºöÂÆπÂô®‰∏≠ÂøÉ + ÊñáÂ≠óÂÆΩÂ∫¶ÁöÑ‰∏ÄÂçä + Èó¥Ë∑ù
            const containerWidth = poemDisplay.offsetWidth;
            const iconLeft = (containerWidth / 2) + (textWidth / 2) + 8; // 8pxÈó¥Ë∑ù
            
            // Á°Æ‰øùÂõæÊ†á‰∏çË∂ÖÂá∫ÂÆπÂô®ËæπÁïå
            const maxLeft = containerWidth - 32; // 32px = ÂõæÊ†áÂÆΩÂ∫¶ + ËæπË∑ù
            poemErrorIcon.style.left = Math.min(iconLeft, maxLeft) + 'px';
        };

        // ÊòæÁ§∫ÁªìÊûúÊµÆÁ™ó
        const showResultModal = (isSuccess, message, answer = null) => {
            // ÈôêÊôÇÊ®°ÂºèÔºö‰∏çÈ°ØÁ§∫Êú¨Âú∞ÁµêÊûúÊµÆÁ™ó
            if (window.GameMode.isTimedScore()) {
                return;
            }
            if (isSuccess) {
                // Á≠îÂØπ‰∫ÜÔºöÂè™ÊòæÁ§∫ÊàêÂäüÂõæÊ†áÔºåÁî®Êà∑Á≠îÊ°à‰øùÊåÅÁªøËâ≤
                successIcon.classList.remove('hidden');
                // ‰∏çÈ°ØÁ§∫Ê≠£Á¢∫Á≠îÊ°àÂçÄÔºàÊ≤øÁî®ÂéüÂÖàÈÇèËºØÔºâÔºåÂÉÖÈ°ØÁ§∫ AI ÊåâÈàï
                correctAnswer.classList.add('hidden');
                poemErrorIcon.classList.add('hidden');
                if (aiExplainSuccessRow) aiExplainSuccessRow.classList.remove('hidden');
                if (aiExplainFailRow) aiExplainFailRow.classList.add('hidden');
                
                // ‰øùÊåÅÁî®Êà∑Á≠îÊ°àÁöÑÁªøËâ≤Ê†∑ÂºèÔºàÂú®endRound‰∏≠Â∑≤ËÆæÁΩÆÔºâ
            } else {
                // Á≠îÈîô‰∫ÜÔºöÊòæÁ§∫ÈîôËØØÂõæÊ†áÂú®Áî®Êà∑Á≠îÊ°àÊóÅÔºåÁî®Êà∑Á≠îÊ°àÂèòÁ∫¢
                if (poemDisplay.value && poemDisplay.value !== 'ÊôÇÈñìÂà∞') {
                    // Âè™ÊúâÂΩìÊúâÁî®Êà∑Á≠îÊ°àÊó∂ÊâçÊòæÁ§∫ÈîôËØØÂõæÊ†á
                    positionErrorIcon();
                    poemErrorIcon.classList.remove('hidden');
                    
                    // Â∞ÜÁî®Êà∑ÈÄâÊã©ÁöÑËØóÂè•Âèò‰∏∫Á∫¢Ëâ≤
                    poemDisplay.classList.remove('text-surface-800', 'text-secondary');
                    poemDisplay.classList.add('text-red-600');
                } else {
                    poemErrorIcon.classList.add('hidden');
                }
                
                if (answer) {
                    correctAnswerText.textContent = answer;
                    correctAnswer.classList.remove('hidden');
                } else {
                    correctAnswer.classList.add('hidden');
                }
                successIcon.classList.add('hidden');
                if (aiExplainFailRow) aiExplainFailRow.classList.remove('hidden');
                if (aiExplainSuccessRow) aiExplainSuccessRow.classList.add('hidden');
            }

            // Ê†πÊìöÊ®°ÂºèÂàáÊèõ‰∏ã‰∏ÄÊ≠•ÊåâÈàïÊñáÊ°àÔºö
            // ÂñÆ‰∫∫=„Äå‰∏ã‰∏ÄÈ¶ñ„ÄçÔºõÂ∞çÊà∞=„ÄåXX ÈñãÂßãÁ≠îÈ°å„ÄçÔºà‰∏ã‰∏Ä‰ΩçÈÅ∏ÊâãÔºâ
            if (closeGameMessage) {
                // ÈÅ†Á®ãÈôêÊôÇÔºöÁµ±‰∏ÄÈ°ØÁ§∫„Äå‰∏ã‰∏ÄÈ¶ñ„ÄçÔºõÊú¨Âú∞Ëº™ÊµÅÁ∂≠ÊåÅÂéüÊñáÊ°à
                if (window.GameMode.isTimedScore()) {
                    closeGameMessage.textContent = '‰∏ã‰∏ÄÈ¶ñ';
                } else if (window.GameMode.isLocal() && window.GameState.isActive && Array.isArray(window.GameState.players) && window.GameState.players.length > 0) {
                    const nextIndex = (window.GameState.turnBased.currentTurnIndex + 1) % window.GameState.players.length;
                    const nextPlayer = window.GameState.players[nextIndex];
                    const name = (nextPlayer && nextPlayer.name) ? nextPlayer.name : 'ÈÅ∏Êâã';
                    closeGameMessage.textContent = `${name} ÈñãÂßãÁ≠îÈ°å`;
                } else {
                    closeGameMessage.textContent = '‰∏ã‰∏ÄÈ¶ñ';
                }
            }

            // ÊòæÁ§∫ÊµÆÁ™óÔºå‰ΩøÁî®ÁÆÄÂçïÁöÑÊªëÂÖ•Âä®Áîª
            gameMessage.classList.remove('hidden');
            const modalContent = gameMessage.querySelector('div');
            modalContent.style.animation = 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards';
            // Á¢∫‰øù„Äå‰∏ã‰∏ÄËº™„ÄçÁç®Á´ã‰∏ÄË°åÔºöÊ≠§ËôïÁµêÊßã‰∏äÂ∑≤Âú®Âè¶‰∏ÄÂÄãÂÆπÂô®‰∏≠Ôºå‰∏çÂêå flex Ë°å
        };

        // DeepSeek ‰ª£ÁêÜË™øÁî®ÔºàÈùû‰∏≤ÊµÅÔºâ
        async function callDeepSeek(messages) {
            const DEFAULT_PROXY = 'https://deepseek-proxy-chi.vercel.app/api/deepseek';
            const url = window.DEEPSEEK_PROXY_URL || localStorage.getItem('DEEPSEEK_PROXY_URL') || DEFAULT_PROXY;
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages,
                    temperature: 0.7,
                    max_tokens: 900
                })
            });
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();
            return data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : '';
        }

        // Ê∫ñÂÇôÊèêÁ§∫Ë©ûÔºàÈÅ©Âêà‰∏≠Â≠∏Áîü„ÄÅÂÖàË≠ØÊñá„ÄÅÂÜçÂéü‰ΩúÂÖ®ÊñáËàáÁ∞°Ë¶ÅË≥ûÊûê„ÄÅÈáçÈªûË™™ÊòéÊ≠§Âè•‰πãÁæéÔºâ
        function buildAiPrompt(poemObj) {
            const line = poemObj?.line || '';
            const author = poemObj?.author || '';
            const poemTitle = poemObj?.poem || '';
            return [
                { role: 'system', content: '‰Ω†ÊòØ‰∏Ä‰ΩçÊ∫´ÊüîËÄåÂ∞àÊ•≠ÁöÑÂúãÂ≠∏Â∞éÂ∏´ÔºåÊìÖÈï∑Áî®Ê∏ÖÊô∞„ÄÅÂÑ™Áæé„ÄÅË≤ºËøë‰∏≠Â≠∏ÁîüÁöÑË™ûË®ÄË¨õËß£Âè§ÂÖ∏Ë©©Ë©û„ÄÇË´ãÂ∞áÁ∏ΩÂ≠óÊï∏ÊéßÂà∂Âú®Á¥Ñ300Â≠óÔºåË™ûË®ÄÁ≤æÁÖâ„ÄÅÊòìÊáÇ„ÄÇ‰∏çË¶Å‰ΩøÁî®Á≤óÈ´îÊàñ‰ªª‰Ωï Markdown Ë™ûÊ≥ïÂº∑Ë™ø„ÄÇ' },
                { role: 'user', content: `Ë´ãÂπ´ÊàëËß£ËÆÄ‰∏ãÈù¢ÈÄôÂè•Ë©©ÔºåËº∏Âá∫ÁµêÊßãÁÇ∫‰∏âÊÆµÔºàÁ¥Ñ300Â≠óÔºâÔºö\n„ÄêË≠ØÊñá„ÄëÁî®1-2Âè•Áµ¶Âá∫Ê∫ñÁ¢∫„ÄÅÂÑ™ÁæéÁöÑÁèæ‰ª£ÊñáÁøªË≠ØÔºõ\n„ÄêÂéü‰Ωú„ÄëË™™ÊòéË©©Âè•Âá∫ËôïÔºåÁµ¶Âá∫Âéü‰ΩúÂÖ®ÊñáÔºàËã•ÈÅéÈï∑ÂèØÁØÄÈÅ∏Ê†∏ÂøÉÊÆµËêΩÔºâÔºå‰øùÊåÅÊéíÁâàÊ∏ÖÊô∞Ôºõ\n„ÄêË≥ûÊûê„ÄëÁî®2-3Âè•ÊåáÂá∫Êï¥È¶ñ‰ΩúÂìÅÁöÑÊ∞£Ê∞õËàáÊÉÖÊÑüÔºå‰∏¶ËëóÈáçË©ïÈªûÈ°åÁõÆË©≤Âè•„Äå${line}„ÄçÁöÑÁæéÔºàÊÑèË±°/ÁØÄÂ•è/Â∞ç‰ªóÁ≠âÔºâ„ÄÇ\nË´ã‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠îÔºåÈ¢®Ê†ºÂèãÂñÑÔºåÈÅ©Âêà‰∏≠Â≠∏Áîü„ÄÇ\nË©©Âè•Ôºö${line}\n‰ΩúËÄÖÔºö${author}\nË©©È°åÔºö${poemTitle}` }
            ];
        }

        function openAiExplainModal() {
            if (!currentPoem) return;
            aiExplainError.classList.add('hidden');
            aiExplainError.textContent = '';
            aiExplainContent.innerHTML = '<div class="ai-loading-wrap"><div class="ai-spinner"></div><div class="ai-loading-text">Ê≠£Âú®ÁîüÊàêËß£ËÆÄÔºåË´ãÁ®çÂÄô‚Ä¶</div></div>';
            aiExplainLine.textContent = currentPoem.line || '';
            aiExplainMeta.textContent = currentPoem.author && currentPoem.poem ? `Âá∫Ëá™„Ää${currentPoem.poem}„Äã¬∑${currentPoem.author}` : '';
            aiExplainModal.classList.remove('hidden');
        }

        async function generateAiExplanation(triggerButton) {
            try {
                if (triggerButton) triggerButton.classList.add('ai-explain-loading');
                aiExplainReload && aiExplainReload.classList.add('ai-explain-loading');
                const messages = buildAiPrompt(currentPoem);
                const content = await callDeepSeek(messages);
                const pretty = formatAiContent(content || '', currentPoem.line || '');
                aiExplainContent.innerHTML = pretty || '<div class="text-surface-700">Êö´ÁÑ°ÂÖßÂÆπ</div>';
                aiExplainError.classList.add('hidden');
            } catch (err) {
                aiExplainError.textContent = 'ÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÈáçË©¶„ÄÇ' + 'Ôºà' + String(err) + 'Ôºâ';
                aiExplainError.classList.remove('hidden');
            } finally {
                if (triggerButton) triggerButton.classList.remove('ai-explain-loading');
                aiExplainReload && aiExplainReload.classList.remove('ai-explain-loading');
            }
        }

        // Â∞áÊ®°ÂûãËº∏Âá∫Ê†ºÂºèÂåñÁÇ∫Êú¨Á´ôÁæéÂ≠∏È¢®Ê†ºÔºå‰∏¶ÂÅöÈï∑Â∫¶ÊéßÂà∂ËàáÈ´ò‰∫Æ
        function formatAiContent(raw, targetLine) {
            // ÂéªÈô§Â∑¶Âè≥Á©∫ÁôΩËàáÂèØËÉΩÁöÑ Markdown Á≤óÈ´îÊòüËôü
            const text = (raw || '')
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/^[\s\u200B\ufeff]+|[\s\u200B\ufeff]+$/g, '');
            // Á≤óÁï•Êà™Êñ∑Ëá≥Á¥Ñ300Â≠ó
            const limited = text.length > 420 ? text.slice(0, 420) + '‚Ä¶' : text;
            // ÂàáÂàÜÊÆµËêΩÔºà‰ª•„Äê„ÄëÊ®ôÈ°åÊàñÁ©∫Ë°åÁÇ∫ÁïåÔºâ
            const parts = limited.split(/\n{2,}|(?=„ÄêË≠ØÊñá|„ÄêÂéü‰Ωú|„ÄêË≥ûÊûê)/).map(p=>p.trim()).filter(Boolean);
            const esc = (s)=>s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
            // ÁõÆÊ®ôË©©Âè•È´ò‰∫Æ
            const highlight = (s)=>s.replace(new RegExp(targetLine.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'), `<span class=\"ai-highlight\">${esc(targetLine)}</span>`);

            const sections = [];
            let y = parts.join('\n');
            // Áõ°ÈáèÊèêÂèñ‰∏âÊÆµ
            const yiz = /„ÄêË≠ØÊñá„Äë([\s\S]*?)(?=„Äê|$)/.exec(y);
            const yuanz = /„ÄêÂéü‰Ωú„Äë([\s\S]*?)(?=„Äê|$)/.exec(y);
            const shang = /„ÄêË≥ûÊûê„Äë([\s\S]*?)(?=„Äê|$)/.exec(y);

            if (yiz) sections.push(`<div class=\"ai-section\"><div class=\"ai-title\">üìò Ë≠ØÊñá</div><div class=\"ai-body\">${esc(yiz[1].trim())}</div></div>`);
            if (yuanz) sections.push(`<div class=\"ai-section\"><div class=\"ai-title\">üìú Âéü‰Ωú</div><div class=\"ai-poem-block\">${esc(yuanz[1].trim())}</div></div>`);
            if (shang) sections.push(`<div class=\"ai-section\"><div class=\"ai-title\">üåü Ë≥ûÊûê</div><div class=\"ai-body\">${highlight(esc(shang[1].trim()))}</div></div>`);

            if (!sections.length) {
                // ÂæåÂÇôÔºö‰ª•ÊÆµËêΩÊãÜÂàÜ
                const paras = parts.map(p=>`<p>${highlight(esc(p))}</p>`).join('');
                return `<div class=\"ai-section\">${paras}</div>`;
            }
            return sections.join('<div style=\"height:8px\"></div>');
        }
        
        if (aiExplainBtnSuccess) {
            aiExplainBtnSuccess.addEventListener('click', (e) => {
                openAiExplainModal();
                generateAiExplanation(e.currentTarget);
            });
        }
        if (aiExplainBtnFail) {
            aiExplainBtnFail.addEventListener('click', (e) => {
                openAiExplainModal();
                generateAiExplanation(e.currentTarget);
            });
        }
        if (aiExplainClose) {
            aiExplainClose.addEventListener('click', () => {
                aiExplainModal.classList.add('hidden');
            });
        }
        if (aiExplainOK) {
            aiExplainOK.addEventListener('click', () => {
                aiExplainModal.classList.add('hidden');
            });
        }
        if (aiExplainReload) {
            aiExplainReload.addEventListener('click', (e) => {
                openAiExplainModal();
                generateAiExplanation(e.currentTarget);
            });
        }

        // ÈöêËóèÁªìÊûúÊµÆÁ™ó
        const hideResultModal = () => {
            const modalContent = gameMessage.querySelector('div');
            modalContent.style.transform = 'translateY(10px)';
            modalContent.style.opacity = '0';
            modalContent.style.transition = 'all 0.2s ease-out';
            
            // Á≠âÂæÖÂä®ÁîªÂÆåÊàêÂêéÈöêËóèÂÖÉÁ¥†
            setTimeout(() => {
                gameMessage.classList.add('hidden');
                modalContent.style.transform = '';
                modalContent.style.opacity = '';
                modalContent.style.transition = '';
                // Ê∏ÖÁêÜÊâÄÊúâÁä∂ÊÄÅ
                successIcon.classList.add('hidden');
                correctAnswer.classList.add('hidden');
                poemErrorIcon.classList.add('hidden');
                if (aiExplainSuccessRow) aiExplainSuccessRow.classList.add('hidden');
                if (aiExplainFailRow) aiExplainFailRow.classList.add('hidden');
                // ÈáçÁΩÆÁî®Êà∑Á≠îÊ°àÈ¢úËâ≤
                poemDisplay.classList.remove('text-red-600', 'text-secondary', 'font-bold');
                poemDisplay.classList.add('text-surface-800');
            }, 200);
        };

        // Shuffle array (Fisher-Yates algorithm)
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        // Ë©©Ë©ûÊï∏ÊìöÂ∫´ÈÅ∏È†Ö
        // ÊîπÁÇ∫‰ΩøÁî®Áî®Êà∂Ê®ôÁ±§‰ΩúÁÇ∫Ë©©Ë©ûÂ∫´ÈÅ∏Êìá
        let activeDatabase = tangPoetryLines; // ‰ªç‰øùÁïôÂÖßÂª∫Êï∏Êìö‰ΩúÁÇ∫Âü∫Á§é‰æÜÊ∫ê
        function getAllPoemsUnified() {
            // ÂÖßÂª∫Â∫´Âä†Ê®ôÁ±§ÔºöÂçóÈ¢®Ë©©Ë©ûÂ∫´ / Â∞èÂ≠∏ÁîüË©©Ë©ûÂ∫´
            const builtinTang = (tangPoetryLines || []).map(p => ({ ...p, tags: Array.isArray(p.tags)? p.tags : ['ÂçóÈ¢®Ë©©Ë©ûÂ∫´'] }));
            const builtinElem = (elementaryPoemLines || []).map(p => ({ ...p, tags: Array.isArray(p.tags)? p.tags : ['Â∞èÂ≠∏ÁîüË©©Ë©ûÂ∫´'] }));
            const imported = loadUserLibrary().poems || [];
            return [...builtinTang, ...builtinElem, ...imported];
        }
        function getAllTags() {
            const set = new Set();
            getAllPoemsUnified().forEach(p => {
                (Array.isArray(p.tags) ? p.tags : []).forEach(t => set.add(String(t)));
            });
            // ÈÅéÊøæÊéâÂ∑≤Âª¢Èô§ÁöÑ„ÄåËá™ÂÆöÁæ©Ë©©Âè•„ÄçÊ®ôÁ±§
            return Array.from(set)
                .filter(t => t !== 'Ëá™ÂÆöÁæ©Ë©©Âè•')
                .sort((a,b)=>a.localeCompare(b));
        }
        function populateUserTagSelect() {
            const sel = document.getElementById('userLibraryTagSelect');
            if (!sel) return;
            const tags = getAllTags();
            sel.innerHTML = '';
            tags.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                sel.appendChild(opt);
            });
        }
        
        // Ê†πÊìöÈÅ∏ÊìáÁöÑÊï∏ÊìöÂ∫´ÈÅ∏ÊìáË©©Âè•
        const selectRandomPoem = () => {
            return activeDatabase[Math.floor(Math.random() * activeDatabase.length)];
        };
        
        // Ë©©Ë©ûÊï∏ÊìöÂ∫´ÂàáÊèõÂäüËÉΩÂ∑≤ÁßªËá≥Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™óËôïÁêÜ

        // Generate characters for the game
        const generateGameCharacters = () => {
            // Reset character arrays
            poemCharacters = [];
            shuffledCharacters = [];
            
            // Get all characters from the current poem
            poemCharacters = currentPoem.line.split('');
            
            // Create a set of characters for the game based on difficulty
            const totalCharsTarget = Math.max(charCount, poemCharacters.length);
            const distractorCount = Math.max(0, totalCharsTarget - poemCharacters.length);
            
            // Create a pool of distractor characters (excluding those in the poem)
            const allDistractors = [];
            
            // Add characters from other poems as distractors
            tangPoetryLines.forEach(poem => {
                if (poem.line !== currentPoem.line) {
                    poem.line.split('').forEach(char => {
                        // Only add if not already in the poem
                        if (!poemCharacters.includes(char)) {
                            allDistractors.push(char);
                        }
                    });
                }
            });
            
            // Shuffle and take the needed number of distractors
            const shuffledDistractors = shuffleArray([...new Set(allDistractors)]);
            const selectedDistractors = shuffledDistractors.slice(0, distractorCount);
            
            // Combine poem characters with distractors and shuffle
            shuffledCharacters = shuffleArray([...poemCharacters, ...selectedDistractors]);
        };

        // Populate the characters grid with the game characters
        const populateCharactersGrid = () => {
            charactersGrid.innerHTML = '';
            let idx = 0;
            shuffledCharacters.forEach(char => {
                const charButton = document.createElement('button');
                charButton.textContent = char;
                charButton.className = 'character-btn char-modern rounded-2xl p-3 md:p-4 text-2xl md:text-3xl font-kai font-bold animate-slide-up';
                charButton.dataset.char = char;
                charButton.style.animationDelay = `${20 * idx}ms`;
                idx++;
                
                charButton.addEventListener('click', (ev) => {
                    if (isGameActive) {
                        // ÈÅî‰∏äÈôêÂâá‰∏çÂÖÅË®±ÂÜçÈÅ∏ÔºàÈô§ÈùûÊòØÂèñÊ∂àÈÅ∏‰∏≠Ôºâ
                        const targetLen = currentPoem ? currentPoem.line.length : 0;
                        if (!charButton.classList.contains('selected') && selectionStack.length >= targetLen) {
                            soundManager.play('wrong');
                            charButton.classList.add('animate-wrong');
                            setTimeout(() => charButton.classList.remove('animate-wrong'), 500);
                            if (typeof showNotification === 'function') {
                                showNotification('Â∑≤ÈÅîÊú¨Âè•Â≠óÊï∏‰∏äÈôê');
                            }
                            return;
                        }

                        // Êí≠ÊîæÊº¢Â≠óÈªûÊìäÈü≥Êïà
                        soundManager.play('charClick');
                        
                        // Ê∑ªÂä†ÁÇπÂáªÂä®Áîª
                        charButton.classList.add('animate-click');
                        setTimeout(() => {
                            charButton.classList.remove('animate-click');
                        }, 300);
                        
                        // ÈªûÊìäÊ≥¢Á¥ã
                        const rect = charButton.getBoundingClientRect();
                        const ripple = document.createElement('span');
                        ripple.className = 'ripple';
                        const offsetX = ev instanceof MouseEvent ? (ev.clientX - rect.left) : rect.width/2;
                        const offsetY = ev instanceof MouseEvent ? (ev.clientY - rect.top) : rect.height/2;
                        ripple.style.left = offsetX + 'px';
                        ripple.style.top = offsetY + 'px';
                        charButton.appendChild(ripple);
                        setTimeout(() => ripple.remove(), 650);
                        
                        // ÂàáÊèõÈÅ∏‰∏≠ÁãÄÊÖã
                        const wasSelected = charButton.classList.toggle('selected');
                        if (wasSelected) {
                            // ÈÅ∏‰∏≠ÂæåÁßªÈô§ hover Á∂†Ëâ≤Ôºå‰øùÊåÅÈÅ∏‰∏≠Ë¶ñË¶∫
                            charButton.classList.remove('hover:bg-secondary', 'hover:text-white');
                            selectionStack.push({ char, btn: charButton });
                        } else {
                            // ÂèñÊ∂àÈÅ∏‰∏≠ÈúÄÂæûÂ†ÜÁñäÁßªÈô§ÊúÄËøë‰∏ÄÊ¨°Â∞çÊáâË©≤Â≠óÁöÑË®òÈåÑ
                            for (let i = selectionStack.length - 1; i >= 0; i--) {
                                if (selectionStack[i].btn === charButton) {
                                    selectionStack.splice(i, 1);
                                    break;
                                }
                            }
                            // ÂèñÊ∂àÈÅ∏‰∏≠ÊÅ¢Âæ© hover Á∂†Ëâ≤
                            charButton.classList.add('hover:bg-secondary', 'hover:text-white');
                        }

                        // ÈáçÂª∫È°ØÁ§∫ÁöÑË©©Âè•Â≠ó‰∏≤
                        poemDisplay.value = selectionStack.map(x => x.char).join('');

                        // Êõ¥Êñ∞Â∑≤ÈÅ∏Â≠óÁãÄÊÖãËàáÊèê‰∫§ÊåâÈàïÂèØÁî®ÊÄß
                        updateSelectionStatus();
                    }
                });
                
                charactersGrid.appendChild(charButton);
            });
        };

        // Apply difficulty settings (Âè™Êõ¥Êñ∞Ë®≠ÂÆöÈ°ØÁ§∫ÔºõÁï∂ÂâçÂõûÂêà‰∏çËÆä)
        const applyDifficultySettings = (difficulty) => {
            const settings = difficultySettings[difficulty];
            // Êõ¥Êñ∞‰∏ãÂõûÂêàÁöÑÈ†êË®≠ÊªëÂ°äÂÄº
            timeLimitSlider.value = settings.timeLimit;
            timeLimitValue.textContent = settings.timeLimit;
            charCountSlider.value = settings.charCount;
            charCountValue.textContent = settings.charCount;
            // ‰∏ç‰øÆÊîπÁï∂ÂâçÂõûÂêà timeLeftÔºõËã•ÈùûÈÅäÊà≤‰∏≠ÔºåÈáçÁΩÆÈ°ØÁ§∫
            if (!isGameActive && !window.GameMode.isTimedScore()) {
                roundTimeLimit = settings.timeLimit;
                timeLeft = roundTimeLimit;
                if (timerElement) timerElement.textContent = timeLeft;
                if (timeBarFill) timeBarFill.style.width = '100%';
            }
        };
        
        // Select a poem based on current game mode
        const selectPoem = () => {
            const tagSel = document.getElementById('userLibraryTagSelect');
            let activeTag = tagSel?.value || loadActiveTag() || 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´';
            if (activeTag === 'Ëá™ÂÆöÁæ©Ë©©Âè•') activeTag = 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´';
            const pool = getAllPoemsUnified().filter(p => Array.isArray(p.tags) && p.tags.includes(activeTag));
            if (pool.length === 0) {
                showNotification('Ë©≤Ë©©Ë©ûÂ∫´‰∏ãÊö´ÁÑ°Ë©©Âè•ÔºåË´ãÊõ¥ÊèõÊ®ôÁ±§ÊàñÂ∞éÂÖ•Êõ¥Â§öË©©Âè•', 5000);
                return null;
            }
            saveActiveTag(activeTag);
            return pool[Math.floor(Math.random() * pool.length)];
        };
        
        // Start a new game round
        const startNewRound = () => {
            console.log('[startNewRound] called, GameMode:', { isTimedScore: window.GameMode.isTimedScore(), isAnyBattle: window.GameMode.isAnyBattle(), isSolo: window.GameMode.isSolo() });
            // Reset UI
            selectionStack = [];
            poemDisplay.value = '';
            gameMessage.classList.add('hidden');
            
            // Ê∏ÖÈô§‰∏ä‰∏ÄËº™ÁöÑÊâÄÊúâÈ¢úËâ≤ÂíåÂõæÊ†áÁä∂ÊÄÅ
            poemDisplay.classList.remove('text-secondary', 'text-red-600', 'font-bold');
            poemDisplay.classList.add('text-surface-800');
            poemErrorIcon.classList.add('hidden');
            successIcon.classList.add('hidden');
            correctAnswer.classList.add('hidden');
            
            // Êí≠ÊîæÊñ∞ÂõûÂêàÈü≥Êïà
            soundManager.play('newRound');
            
            // Select a new poem based on game mode
            currentPoem = selectPoem();
            
            // If no poem is available, return
            if (!currentPoem) {
                return;
            }
            
            // Display the poem hint (author and name) without character count
            poemHint.textContent = `„Ää${currentPoem.poem}„Äã - ${currentPoem.author}`;
            
            // Display character count separately
            const targetLen = currentPoem.line.length;
            const charCountDisplay = document.getElementById('charCountDisplay');
            if (charCountDisplay) {
                charCountDisplay.textContent = targetLen;
            }
            
            // ÊáâÁî®‰∏ãÂõûÂêàÁöÑÂ≠óÂÖÉÊï∏Ôºà‰∏çÂ∞èÊñºË©©Âè•Èï∑Â∫¶Ôºâ
            charCount = Math.max(parseInt(charCountSlider.value), currentPoem.line.length);
            // Generate and display characters
            generateGameCharacters();
            populateCharactersGrid();
            
            // Âú®ÈÅ†Á®ãÈôêÊôÇÊ®°Âºè‰∏≠Ôºå‰∏ç‰ΩøÁî®ÂñÆÈ°åÂÄíÊï∏ÔºåÂè™È°ØÁ§∫ÂÖ®Â±ÄÂÄíÊï∏
            if (window.GameMode.isTimedScore()) {
                // ÈôêÊôÇÊ®°ÂºèÔºöÈö±ËóèÈÄ≤Â∫¶Ê¢ùÂ°´ÂÖÖÔºà‰ΩÜ‰øùÊåÅÂÆπÂô®ÂèØË¶ã‰ª•È°ØÁ§∫Ë≥ΩÈÅìÔºâÔºåÂè™È°ØÁ§∫ÂÖ®Â±ÄÁßíÊï∏
                try { if (timeBarFill) { timeBarFill.style.width = '0%'; timeBarFill.style.display = 'none'; } } catch(_){ }
                try { if (timeBarContainer) timeBarContainer.style.display = ''; } catch(_){ }
                try {
                    const remainMs = Math.max(0, (state.timedEndsAt || Date.now()) - Date.now());
                    timerElement.textContent = String(Math.ceil(remainMs / 1000));
                } catch(_){ }
                // Á¢∫‰øù‰∏çÊúÉÂïüÂãïÂñÆÈ°åË®àÊôÇÂô®
            } else {
                // Reset timer based on current slider (‰∏ã‰∏ÄËº™ÁîüÊïàÁöÑË®≠ÂÆö)
                roundTimeLimit = parseInt(timeLimitSlider.value);
                timeLeft = roundTimeLimit;
                timerElement.textContent = timeLeft;
                if (timeBarFill) {
                    timeBarFill.style.width = '100%';
                    timeBarFill.classList.remove('bg-red-500');
                    timeBarFill.classList.add('bg-primary');
                }
                try { if (timeBarContainer) timeBarContainer.style.display = ''; } catch(_){ }
            }
            
            // Á°Æ‰øùÊåâÈíÆÂå∫ÂüüÊòæÁ§∫ÂíåÁä∂ÊÄÅÊ≠£Á°Æ
            const buttonContainer = clearSelectionButton.parentElement;
            if (buttonContainer) {
                buttonContainer.classList.remove('hidden');
            }
            
            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            updateSelectionStatus();
            
            // Start the game
            isGameActive = true;
            try { window.RaceTrack && window.RaceTrack.ensureEmojis && window.RaceTrack.ensureEmojis(); } catch(_){ }
            try { window.RaceTrack && window.RaceTrack.render && window.RaceTrack.render(); } catch(_){ }
            
            // ÂñÆÈ°åË®àÊôÇÔºöÂÉÖÂú®ÈùûÈÅ†Á®ãÈôêÊôÇÊ®°Âºè‰∏ãÂïüÁî®
            clearInterval(timerInterval);
            if (!window.GameMode.isTimedScore()) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                    if (timeBarFill && roundTimeLimit > 0) {
                        const pct = Math.max(0, Math.min(100, (timeLeft / roundTimeLimit) * 100));
                        timeBarFill.style.width = pct + '%';
                        if (timeLeft <= 10 && timeLeft > 0) {
                            timeBarFill.classList.remove('bg-primary');
                            timeBarFill.classList.add('bg-red-500');
                        }
                    }
                    if (timeLeft === 10) {
                        soundManager.play('timeWarning');
                        timerElement.classList.add('timer-warning');
                        setTimeout(() => timerElement.classList.remove('timer-warning'), 12000);
                    }
                    if (timeLeft <= 0) {
                        endRound(false);
                    }
                }, 1000);
            }

            // ÈôêÊôÇÊ®°ÂºèÔºö5ÁßíÊú™Êèê‰∫§È°ØÁ§∫„ÄåË∑≥ÈÅé„ÄçÊåâÈàï
            try {
                const buttonContainer = clearSelectionButton.parentElement;
                if (buttonContainer && window.GameMode.isTimedScore()) {
                    let skipBtn = document.getElementById('skipPoem');
                    if (!skipBtn) {
                        skipBtn = document.createElement('button');
                        skipBtn.id = 'skipPoem';
                        skipBtn.className = 'gradient-secondary text-white px-6 py-3 rounded-2xl font-modern font-semibold text-sm shadow-lg modern-button ml-4 opacity-0 pointer-events-none transition-all';
                        skipBtn.textContent = 'Ë∑≥ÈÅé';
                        buttonContainer.appendChild(skipBtn);
                        skipBtn.addEventListener('click', () => {
                            if (isGameActive) endRound(false, 'skip');
                        });
                    }
                    skipBtn.style.opacity = '0';
                    skipBtn.style.pointerEvents = 'none';
                    setTimeout(() => {
                        if (isGameActive && window.GameMode.isTimedScore()) {
                            skipBtn.style.opacity = '1';
                            skipBtn.style.pointerEvents = 'auto';
                        }
                    }, 5000);
                }
            } catch(_){}
        };

        // End the current round
        const endRound = (success, reason = 'timeout') => {
            // Stop the timer
            clearInterval(timerInterval);
            isGameActive = false;
            
            // ‰∏çÂÜçÈöêËóèÊåâÈíÆÔºå‰øùÊåÅÊåâÈíÆÂå∫ÂüüÂèØËßÅ
            
            if (success) {
                // Êí≠ÊîæÊ≠£Á¢∫Èü≥Êïà
                soundManager.play('correct');
                
                // ÊòæÁ§∫Á≠îÂØπÂä®Áîª
                poemDisplay.classList.add('animate-correct');
                
                // Â∞ÜËØóÂè•ÊñáÂ≠óÂèò‰∏∫ÁªøËâ≤Ôºà‰∏éÊèê‰∫§ÊåâÈíÆÁõ∏ÂêåÁöÑÈ¢úËâ≤Ôºâ
                poemDisplay.classList.add('text-secondary');
                poemDisplay.classList.add('font-bold');
                
                setTimeout(() => {
                    poemDisplay.classList.remove('animate-correct');
                }, 1000);
                
                // Êõ¥Êñ∞ÂàÜÊï∏
                if (window.GameMode.isTimedScore()) {
                    // Âõ∫ÂÆö +10 ÂàÜÔºõÁ≠îÂ∞ç
                    applyScoreDelta(10, true);
                } else if (!window.GameMode.isLocal() || !window.GameState.isActive) {
                    score++;
                }
                
                // Ê∑ªÂä†ÂàÜÊï∞ÂèòÂåñÂä®Áîª
                scoreElement.classList.add('animate-score');
                scoreElement.textContent = score;
                setTimeout(() => {
                    scoreElement.classList.remove('animate-score');
                }, 800);
                
                // ÈôêÊôÇÊ®°ÂºèÔºö‰∏çÂΩàÂá∫Êú¨Âú∞ÁµêÊûúÊµÆÁ™óÔºå‰ΩÜÊèê‰æõËºïÈáèÊèêÁ§∫
                if (window.GameMode.isTimedScore()) {
                    try { if (typeof showNotification === 'function') showNotification('Á≠îÂ∞çÔºÅ+10 ÂàÜ'); } catch(_){}
                } else {
                    showResultModal(true, 'ÊÅ≠ÂñúÔºÅÁ≠îÂ∞ç‰∫ÜÔºÅ');
                }
            } else {
                // Êí≠ÊîæÈåØË™§/ÊôÇÈñìÂà∞Èü≥Êïà
                soundManager.play('timeUp');
                
                // Ê†πÊçÆÂ§±Ë¥•ÂéüÂõ†ÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ
                if (reason === 'timeout') {
                    // Êó∂Èó¥Âà∞ÔºöÊòæÁ§∫Á∫¢Ëâ≤"ÊôÇÈñìÂà∞"ÊñáÂ≠ó
                    poemDisplay.value = 'ÊôÇÈñìÂà∞';
                    poemDisplay.classList.remove('text-surface-800');
                    poemDisplay.classList.add('text-red-600', 'font-bold');
                    // ‰∏çÊòæÁ§∫ÈîôËØØÂõæÊ†áÔºåÂõ†‰∏∫Ê≤°ÊúâÁî®Êà∑Á≠îÊ°à
                    poemErrorIcon.classList.add('hidden');
                } else {
                    // Áî®Êà∑Á≠îÈîôÔºöÊòæÁ§∫Á≠îÈîôÂä®Áîª
                    poemDisplay.classList.add('animate-wrong');
                    setTimeout(() => {
                        poemDisplay.classList.remove('animate-wrong');
                    }, 500);
                }
                
                // ÈôêÊôÇÊ®°ÂºèÔºö‰∏çÂΩàÂá∫Êú¨Âú∞ÁµêÊûúÊµÆÁ™óÔºå‰ΩÜÊèê‰æõËºïÈáèÊèêÁ§∫
                if (window.GameMode.isTimedScore()) {
                    try { if (typeof showNotification === 'function') showNotification(reason === 'timeout' ? 'ÊôÇÈñìÂà∞' : 'Á≠îÈåØ‰∫Ü'); } catch(_){}
                } else {
                    showResultModal(false, reason === 'timeout' ? 'ÊôÇÈñìÂà∞ÔºÅ' : 'Á≠îÈåØ‰∫ÜÔºÅ', currentPoem.line);
                }
                // ÈôêÊôÇÊ®°Âºè‰∏ãË®ò‰∏ÄÊ¨°‰ΩúÁ≠îÔºà‰∏çÂä†ÂàÜÔºâ
                if (window.GameMode.isTimedScore()) {
                    applyScoreDelta(0, false);
                }
            }
            
            // ÈôêÊôÇÊ®°ÂºèÔºöÁµêÊùüÂæåËá™Âãï‰∏ã‰∏ÄÈ°åÔºõÈùûÈôêÊôÇ‰ªçËµ∞ÂéüÈÇèËºØ
            if (window.GameMode.isTimedScore()) {
                // ÈÅøÂÖçÁõ¥Êé•ÂºïÁî®Â±ÄÈÉ® IIFE ÂÖßÁöÑ state ÈÄ†Êàê ReferenceError
                setTimeout(() => {
                    try {
                        if (typeof state !== 'undefined' && state && state.timedMode !== true) return;
                    } catch(_){}
                    startNewRound();
                }, 600);
                return; // ÈÅøÂÖçËêΩÂÖ•Ëº™ÊµÅÊµÅÁ®ã
            } else if (window.GameMode.isLocal() && window.GameState.isActive) {
                if (typeof window.LocalBattle?.endRound === 'function') window.LocalBattle.endRound(success);
            }
        };

        // ËÆìÈÅ†Á´Ø‰∫ã‰ª∂ÂèØÁõ¥Êé•ÂëºÂè´Êñ∞ÂõûÂêàÔºàÈÅøÂÖç const ËÅ≤ÊòéÊú™ÊéõÂà∞ windowÔºâ
        try { window.startNewRound = startNewRound; } catch(_) {}

        // Verify if the current input matches the poem
        const verifyPoem = () => {
            return poemDisplay.value === currentPoem.line;
        };

        function applyScoreDelta(delta, isCorrect){
            try {
                // Êú¨Âú∞ÔºöÂñÆ‰∫∫ÂÅ¥Ë®àÂàÜ
                scoreElement.classList.add('animate-score');
                setTimeout(() => scoreElement.classList.remove('animate-score'), 800);
                
                // „ÄêÈáçÊßã„ÄëÈÅ†Á®ãÈôêÊôÇÔºöÂè™Âª£Êí≠Ôºå‰∏çÂú®Êú¨Âú∞È†êÂÖàÊõ¥Êñ∞ÔºàÁµ±‰∏ÄÁî±Êé•Êî∂Âª£Êí≠ÊôÇÊõ¥Êñ∞Ôºâ
                if (window.GameMode.isTimedScore()) {
                    const uid = window.GameState.remote.currentUserId;
                    if (!uid) return;
                    
                    // Âª£Êí≠ÂàÜÊï∏Êõ¥Êñ∞ÔºàËÆìÊâÄÊúâÂÆ¢Êà∂Á´ØÂåÖÊã¨Ëá™Â∑±Áµ±‰∏ÄËôïÁêÜÔºâ
                    window.RemoteBattle.sendGameEvent('score_update', { userId: uid, delta, answeredInc:1, correctInc: isCorrect?1:0 });
                }
            } catch(_){}
        }

        // Êõ¥Êñ∞Â∑≤ÈÅ∏Â≠óÁãÄÊÖãËàáÊèê‰∫§ÂèØÁî®ÊÄß
        const updateSelectionStatus = () => {
            const selected = poemDisplay.value.length;
            const target = currentPoem ? currentPoem.line.length : 0;
            const statusEl = document.getElementById('selectionStatus');
            if (statusEl) {
                statusEl.textContent = `Â∑≤ÈÅ∏ ${selected} / ${target}`;
                statusEl.classList.remove('text-red-600');
            }
            const submitBtn = document.getElementById('submitPoem');
            if (submitBtn) {
                if (window.GameMode.isTimedScore()) {
                    // ÈôêÊôÇÊ®°ÂºèÔºöÂßãÁµÇÂÖÅË®±Êèê‰∫§ÔºàÊú™ÊªøÂ≠óÊï∏Ë¶ñÁÇ∫ÈåØË™§ËôïÁêÜÔºâ
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                } else {
                    // Êú¨Âú∞/ÂñÆ‰∫∫ÔºöÂÉÖÂú®Â≠óÊï∏ÂÆåÂÖ®ÂåπÈÖçÊôÇÂÖÅË®±Êèê‰∫§
                    const canSubmit = selected === target && target > 0;
                    submitBtn.disabled = !canSubmit;
                    if (submitBtn.disabled) {
                        submitBtn.classList.add('opacity-60', 'cursor-not-allowed');
                    } else {
                        submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                    }
                }
            }
            // Ë∂ÖÂá∫Â≠óÊï∏ÊèêÁ§∫
            if (selected > target && statusEl) {
                statusEl.classList.add('text-red-600');
            }
        };

        // Event listeners
        clearSelectionButton.addEventListener('click', () => {
            if (isGameActive) {
                soundManager.play('buttonClick');
                // ÂæåÈÄÄ‰∏ÄÂ≠óÔºöÂΩàÂá∫Â†ÜÁñäÊúÄÂæå‰∏ÄÂÄãÂ≠óÔºå‰∏¶ÈÇÑÂéüÂÖ∂ÊåâÈàïÁãÄÊÖã
                const last = selectionStack.pop();
                if (last && last.btn) {
                    last.btn.classList.remove('selected');
                    // ÊÅ¢Âæ© hover Á∂†Ëâ≤
                    last.btn.classList.add('hover:bg-secondary', 'hover:text-white');
                }
                poemDisplay.value = selectionStack.map(x => x.char).join('');
                updateSelectionStatus();
            }
        });

        submitButton.addEventListener('click', () => {
            if (isGameActive) {
                // Êí≠ÊîæÊåâÈàïÈªûÊìäÈü≥Êïà
                soundManager.play('buttonClick');
                
                if (window.GameMode.isTimedScore()) {
                    const target = currentPoem ? currentPoem.line.length : 0;
                    if (poemDisplay.value.trim().length < target) {
                        // Êú™ÊªøÂ≠óÊï∏ÔºöË¶ñÁÇ∫ÈåØË™§Âø´ÈÄüÂèçÈ•ã
                        endRound(false, 'wrong');
                        return;
                    }
                } else {
                    if (poemDisplay.value.trim().length === 0) {
                        showNotification('Ë´ãÂÖàÈÅ∏ÊìáÊº¢Â≠óÂÜçÊèê‰∫§ÔºÅ');
                        return;
                    }
                }

                const isCorrect = verifyPoem();
                endRound(isCorrect, isCorrect ? 'correct' : 'wrong');
            }
        });

        // Difficulty select event listener
        difficultySelect.addEventListener('change', () => {
            const difficulty = difficultySelect.value;
            applyDifficultySettings(difficulty);
            
            if (isGameActive) {
                showNotification('Èõ£Â∫¶Â∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
            }
        });
        
        // Time limit slider event listenerÔºàÂè™Êõ¥Êñ∞È°ØÁ§∫Ôºå‰∏ãÂõûÂêàÁîüÊïàÔºâ
        timeLimitSlider.addEventListener('input', () => {
            const nextTime = parseInt(timeLimitSlider.value);
            timeLimitValue.textContent = nextTime;
            if (isGameActive) {
                showNotification('ÊôÇÈñìÈôêÂà∂Â∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
            }
        });
        
        // Character count slider event listener
        charCountSlider.addEventListener('input', () => {
            charCount = parseInt(charCountSlider.value);
            charCountValue.textContent = charCount;
            
            if (isGameActive) {
                showNotification('ÂæÖÈÅ∏Â≠óÊï∏ÈáèÂ∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
            }
        });
        
        // Ëá™ÂÆöÁæ©Ë©©Âè•ÂäüËÉΩÂ∑≤ÁßªÈô§
        
        // ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®Â∑≤ÁßªËá≥Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó‰∏≠ËôïÁêÜ
        
        // Save custom poem event listener (Â∑≤Âú®Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó‰∏≠ËôïÁêÜ)
        
        // Admin mode toggle (ËàäÂäüËÉΩÂ∑≤ÁßªËá≥Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó)
        const difficultySelector = document.getElementById('difficultySelector');
        let isAdminMode = false;
        
        // ËàäÁöÑ Toggle admin mode ÂäüËÉΩÂ∑≤ÁßªËá≥Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó
        
        // Enhance characters display
        const enhanceCharacterDisplay = () => {
            // Make the characters larger in the grid
            document.querySelectorAll('.character-btn').forEach(btn => {
                btn.classList.remove('p-3', 'text-xl', 'text-2xl');
                btn.classList.add('p-4', 'text-3xl');
            });
        };
        
        // ÂÆâÂÖ®Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÁöÑËæÖÂä©ÂáΩÊï∞
        const safeAddEventListener = (elementId, event, handler) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(event, handler);
            }
        };

        // ÂÆâÂÖ®Âú∞Ê£ÄÊü•ÂíåÊ∑ªÂä†ÊâÄÊúâ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const setupEventListeners = () => {
            // Â∑≤ÊúâÊ†∏ÂøÉÁõ£ËÅΩÂú®‰∏äÊñπÁ∂ÅÂÆöÔºåÈÄôË£°ÈÅøÂÖçÈáçË§á
            if (areCoreListenersBound) return;
            areCoreListenersBound = true;
            return;
            
            // Áé∞ÊúâÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ËÆæÁΩÆ
            if (clearSelectionButton) {
                clearSelectionButton.addEventListener('click', () => {
                    if (isGameActive) {
                        poemDisplay.value = '';
                        // Re-enable all character buttons
                        document.querySelectorAll('.character-btn').forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                            btn.classList.add('hover:bg-secondary', 'hover:text-white');
                        });
                    }
                });
            }

            if (submitButton) {
                submitButton.addEventListener('click', () => {
                    if (isGameActive) {
                        if (poemDisplay.value.trim().length === 0) {
                            showNotification('Ë´ãÂÖàÈÅ∏ÊìáÊº¢Â≠óÂÜçÊèê‰∫§ÔºÅ');
                            return;
                        }
                        
                        const isCorrect = verifyPoem();
                        endRound(isCorrect, isCorrect ? 'correct' : 'wrong');
                    }
                });
            }

            if (difficultySelect) {
                difficultySelect.addEventListener('change', () => {
                    const difficulty = difficultySelect.value;
                    applyDifficultySettings(difficulty);
                    
                    if (isGameActive) {
                        showNotification('Èõ£Â∫¶Â∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
                    }
                });
            }

            if (timeLimitSlider) {
                timeLimitSlider.addEventListener('input', () => {
                    timeLeft = parseInt(timeLimitSlider.value);
                    timeLimitValue.textContent = timeLeft;
                    
                    if (isGameActive) {
                        showNotification('ÊôÇÈñìÈôêÂà∂Â∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
                    }
                });
            }

            if (charCountSlider) {
                charCountSlider.addEventListener('input', () => {
                    charCount = parseInt(charCountSlider.value);
                    charCountValue.textContent = charCount;
                    
                    if (isGameActive) {
                        showNotification('ÂæÖÈÅ∏Â≠óÊï∏ÈáèÂ∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
                    }
                });
            }

            if (gameMode) {
                gameMode.addEventListener('change', () => {
                    currentGameMode = gameMode.value;
                    
                    if (currentGameMode === 'custom') {
                        customPoemSettings.classList.remove('hidden');
                        updateSavedPoemsList();
                    } else {
                        customPoemSettings.classList.add('hidden');
                    }
                    
                    if (isGameActive) {
                        showNotification('Ê®°ÂºèÂ∑≤ËÆäÊõ¥ÔºåÂ∞áÂú®‰∏ã‰∏ÄËº™ÁîüÊïà');
                    }
                });
            }

            if (saveCustomPoemButton) {
                saveCustomPoemButton.addEventListener('click', saveCustomPoem);
            }

            // ËàäÁöÑ adminModeToggle ‰∫ã‰ª∂Áõ£ËÅΩÂô®Â∑≤ÁßªËá≥ setupSettingsEventListeners

            if (closeNotification) {
                closeNotification.addEventListener('click', () => {
                    notification.classList.remove('translate-y-0');
                    notification.classList.add('translate-y-[-150%]');
                });
            }
        };

        // ÂàùÂßãÂåñÊ∏∏Êàè
        const initGame = () => {
            console.log("ÂàùÂßãÂåñÈÅäÊà≤...");
            
            // È¶ñÂÖàÂÑ™ÂåñiframeÂ∏ÉÂ±Ä
            optimizeForIframe();
            
            // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            // setupEventListeners(); // Â∑≤ÁßªËá≥setupSettingsEventListeners
            
            // ÊáâÁî®ÂàùÂßãÈõ£Â∫¶Ë®≠ÁΩÆ
            if (difficultySelect) {
                applyDifficultySettings(difficultySelect.value);
            }
            
            // ËôïÁêÜÈü≥ÊïàÈñãÈóúÊåâÈàï
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                console.log("Á∂ÅÂÆöÈü≥ÊïàÈñãÈóúÊåâÈàï‰∫ã‰ª∂");
                
                // ÁßªÈô§ÊâÄÊúâÂ∑≤ÊúâÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
                const newSoundToggle = soundToggle.cloneNode(true);
                soundToggle.parentNode.replaceChild(newSoundToggle, soundToggle);
                
                // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
                newSoundToggle.addEventListener('click', function() {
                    // Êí≠ÊîæÊåâÈçµÈªûÊìäÈü≥ÊïàÔºàÂú®ÈùúÈü≥ÂâçÔºâ
                    soundManager.play('buttonClick');
                    
                    // ÂàáÊèõÈùúÈü≥ÁãÄÊÖã
                    const isMuted = soundManager.toggleMute();
                    
                    window.soundEnabled = !isMuted;
                    // Êõ¥Êñ∞‰øùÂ≠òÁãÄÊÖãÔºàÂç≥ÊôÇ‰øùÂ≠òÔºâ
                    try {
                        const s = loadSettings();
                        s.soundOn = window.soundEnabled;
                        persistSettings(s);
                    } catch {}

                    // Êõ¥Êñ∞ÊåâÈàïÊñáÂ≠óÂíåÂúñÁ§∫
                    if (isMuted) {
                        newSoundToggle.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.531V19.94a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.506-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.395C2.806 8.757 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            Èü≥ÊïàÈóú
                        `;
                    } else {
                        newSoundToggle.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            Èü≥ÊïàÈñã
                        `;
                    }
                });
            }
            
            // ËàäÁöÑÁÆ°ÁêÜÂì°ÊåâÈàïÂäüËÉΩÂ∑≤ÁßªËá≥ setupSettingsEventListeners ‰∏≠ÁöÑË®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó
            
            // ÂæûÊú¨Âú∞Â≠òÂÑ≤ÊÅ¢Âæ© UI ËàáÁãÄÊÖã
            try { restoreFromLocalStorage(); } catch (e) { console.warn('restoreFromLocalStorage failed', e); }
            // Ëã•ÈÅ†Á®ãÂ∞çÊà∞ÈÖçÁΩÆÈù¢ÊùøÂ∑≤ÈñãÂïüÊàñÊ≠£ËôïÊñºÈÅ†Á®ãÈôêÊôÇÊ®°ÂºèÔºåÁ¶ÅÊ≠¢ÂñÆ‰∫∫Ê®°ÂºèËá™ÂãïÈñãÂ±Ä
            const rbm = document.getElementById('remoteBattleModal');
            const remotePanelOpen = !!(rbm && !rbm.classList.contains('hidden'));
            const remoteTimed = (typeof state !== 'undefined' && state.timedMode);
            if (!remotePanelOpen && !remoteTimed) {
                startNewRound();
            }
        };

        // Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™óÁõ∏ÈóúÂáΩÊï∏
        let gameWasPaused = false;
        let timerWasActive = false;
        
        function openSettingsModal() {
            // Êö´ÂÅúÈÅäÊà≤
            gameWasPaused = isGameActive;
            timerWasActive = !!timerInterval;
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            isGameActive = false;
            
            // È°ØÁ§∫Ê®°ÊÖãÂΩàÁ™ó
            settingsModal.classList.remove('hidden');
            
            // ÂêåÊ≠•Áï∂ÂâçË®≠ÁΩÆÂà∞Ê®°ÊÖãÂΩàÁ™ó
            syncSettingsToModal();
        }
        
        function closeSettingsModalFunc() {
            settingsModal.classList.add('hidden');
            
            // Â¶ÇÊûúÈÅäÊà≤‰πãÂâçÊòØÊ¥ªË∫çÁöÑÔºåÊÅ¢Âæ©ÈÅäÊà≤ÁãÄÊÖã
            if (gameWasPaused && timerWasActive) {
                isGameActive = true;
                // ÈôêÊôÇÊ®°ÂºèÔºö‰∏çÊÅ¢Âæ©ÂñÆÈ°åË®àÊôÇÂô®
                if (!(window.RemoteBattle?.room && typeof state !== 'undefined' && state.timedMode)) {
                    startTimer();
                }
            }
        }
        
        function syncSettingsToModal() {
            // ÂêåÊ≠•ÈÅäÊà≤Ê®°ÂºèÔºàÂÉÖËôïÁêÜÂñÆ‰∫∫/Â∞çÊà∞Ôºâ
            const currentMode = (window.GameMode.isLocal() && window.GameState.isActive) ? 'battle' : 'single';
            const modeRadio = document.querySelector(`input[name="gameMode"][value="${currentMode}"]`);
            if (modeRadio) modeRadio.checked = true;

            // Ê†πÊìöÊ®°ÂºèÈ°ØÁ§∫/Èö±ËóèÁõ∏ÈóúË®≠ÁΩÆ
            updateModalSections();
        }

        // ===== Êú¨Âú∞Â∞çÊà∞Ê®°ÊÖãÁ™óÂè£Áõ∏ÈóúÂáΩÊï∏ =====
        function openLocalBattleModal() {
            const modal = document.getElementById('localBattleModal');
            if (!modal) return;

            // Êö´ÂÅúÈÅäÊà≤
            if (timerInterval) clearInterval(timerInterval);
            isGameActive = false;

            // ËºâÂÖ•‰øùÂ≠òÁöÑË®≠ÁΩÆ
            loadLocalBattleSettings();

            // Â°´ÂÖÖË©©Ë©ûÂ∫´ÈÅ∏È†Ö
            populateLocalPoemSetSelect();

            // ÁîüÊàêÈÅ∏ÊâãÂêçÁ®±Ëº∏ÂÖ•Ê°Ü
            generateLocalPlayerNameInputs();

            // È°ØÁ§∫Ê®°ÊÖãÁ™óÂè£
            modal.classList.remove('hidden');
        }

        function closeLocalBattleModalFunc() {
            const modal = document.getElementById('localBattleModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function loadLocalBattleSettings() {
            // Âæû localStorage ËºâÂÖ•Ë®≠ÁΩÆ
            const saved = localStorage.getItem('shicizuju_local_battle_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    const localPlayerCount = document.getElementById('localPlayerCount');
                    const localQuestionCount = document.getElementById('localQuestionCount');
                    const localSpeedMode = document.getElementById('localSpeedMode');

                    if (localPlayerCount && config.playerCount) {
                        localPlayerCount.value = config.playerCount;
                    }
                    if (localQuestionCount && config.questionCount) {
                        localQuestionCount.value = config.questionCount;
                    }
                    if (localSpeedMode && typeof config.speedMode === 'boolean') {
                        localSpeedMode.checked = config.speedMode;
                    }
                } catch (e) {
                    console.error('ËºâÂÖ•Êú¨Âú∞Â∞çÊà∞Ë®≠ÁΩÆÂ§±Êïó:', e);
                }
            }
        }

        function saveLocalBattleSettings(config) {
            localStorage.setItem('shicizuju_local_battle_config', JSON.stringify(config));
        }

        function populateLocalPoemSetSelect() {
            const select = document.getElementById('localPoemSetSelect');
            if (!select) return;

            // Ê∏ÖÁ©∫ÁèæÊúâÈÅ∏È†Ö
            select.innerHTML = '';

            // ‰ΩøÁî®ÁèæÊúâÁöÑgetAllTagsÂáΩÊï∏Áç≤ÂèñÊâÄÊúâÊ®ôÁ±§
            const tags = getAllTags();
            const allPoems = getAllPoemsUnified();

            // Ê∑ªÂä†ÈÅ∏È†Ö
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                const count = allPoems.filter(p => p.tags && p.tags.includes(tag)).length;
                option.textContent = `${tag} (${count}È°å)`;
                select.appendChild(option);
            });

            // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑË®≠ÁΩÆÔºåÈÅ∏ÊìáË©≤Ë©©Ë©ûÂ∫´
            const saved = localStorage.getItem('shicizuju_local_battle_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    if (config.poemSet) {
                        select.value = config.poemSet;
                    }
                } catch (e) {}
            }
        }

        function generateLocalPlayerNameInputs() {
            const container = document.getElementById('localPlayerNamesContainer');
            const localPlayerCount = document.getElementById('localPlayerCount');
            if (!container || !localPlayerCount) return;

            const count = parseInt(localPlayerCount.value) || 2;
            container.innerHTML = '';

            // ÂòóË©¶Âæû‰øùÂ≠òÁöÑË®≠ÁΩÆ‰∏≠Áç≤ÂèñÈÅ∏ÊâãÂêçÁ®±
            let savedNames = [];
            const saved = localStorage.getItem('shicizuju_local_battle_config');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    savedNames = config.playerNames || [];
                } catch (e) {}
            }

            for (let i = 0; i < count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `localPlayer${i + 1}Name`;
                input.value = savedNames[i] || `ÈÅ∏Êâã${i + 1}`;
                input.placeholder = `ÈÅ∏Êâã${i + 1}`;
                input.className = 'glass-card rounded-lg px-3 py-2 border border-white/30 focus:ring-2 focus:ring-secondary-500 text-sm font-modern';
                container.appendChild(input);
            }
        }

        function startLocalBattleGame() {
            // Êî∂ÈõÜÈÖçÁΩÆ
            const localPlayerCount = document.getElementById('localPlayerCount');
            const localQuestionCount = document.getElementById('localQuestionCount');
            const localSpeedMode = document.getElementById('localSpeedMode');
            const localPoemSetSelect = document.getElementById('localPoemSetSelect');

            if (!localPlayerCount || !localQuestionCount || !localPoemSetSelect) {
                alert('ÈÖçÁΩÆÂÖÉÁ¥†Êú™ÊâæÂà∞');
                return;
            }

            const playerCount = parseInt(localPlayerCount.value) || 2;
            const questionCount = parseInt(localQuestionCount.value) || 10;
            const speedMode = localSpeedMode ? localSpeedMode.checked : false;
            const poemSet = localPoemSetSelect.value;

            // Êî∂ÈõÜÈÅ∏ÊâãÂêçÁ®±
            const playerNames = [];
            for (let i = 0; i < playerCount; i++) {
                const input = document.getElementById(`localPlayer${i + 1}Name`);
                const name = input ? input.value.trim() : '';
                if (!name) {
                    alert(`Ë´ãËº∏ÂÖ•ÈÅ∏Êâã${i + 1}ÁöÑÂêçÁ®±`);
                    return;
                }
                playerNames.push(name);
            }

            // È©óË≠âÈÅ∏ÊâãÂêçÁ®±‰∏çÈáçË§á
            const uniqueNames = new Set(playerNames);
            if (uniqueNames.size !== playerNames.length) {
                alert('ÈÅ∏ÊâãÂêçÁ®±‰∏çËÉΩÈáçË§á');
                return;
            }

            // È©óË≠âÈ°åÁõÆÊï∏
            if (questionCount < 5) {
                alert('È°åÁõÆÊï∏Ëá≥Â∞ëÁÇ∫5È°å');
                return;
            }

            // ‰øùÂ≠òÈÖçÁΩÆ
            const config = {
                playerCount,
                playerNames,
                questionCount,
                speedMode,
                poemSet
            };
            saveLocalBattleSettings(config);

            // ÈóúÈñâÊ®°ÊÖãÁ™óÂè£
            closeLocalBattleModalFunc();

            // ÂïüÂãïÊú¨Âú∞Â∞çÊà∞Ê®°ÂºèÔºà‰ΩøÁî®ÁèæÊúâÁöÑÂ∞çÊà∞Ê®°ÂºèÈÇèËºØÔºâ
            startLocalBattle(config);
        }

        function startLocalBattle(config) {
            // ÂàáÊèõÂà∞ÊåáÂÆöÁöÑË©©Ë©ûÂ∫´
            const tagSelect = document.getElementById('userLibraryTagSelect');
            if (tagSelect && config.poemSet) {
                tagSelect.value = config.poemSet;
                saveActiveTag(config.poemSet);
            }

            // ÂæûÊªëÂ°äÁç≤ÂèñÂÖ®Â±ÄÂèÉÊï∏
            const timeLimitSlider = document.getElementById('timeLimit');
            const charCountSlider = document.getElementById('charCount');
            const currentTimeLimit = timeLimitSlider ? parseInt(timeLimitSlider.value) : 30;
            const currentCharCount = charCountSlider ? parseInt(charCountSlider.value) : 20;

            // Ë®àÁÆóÊØè‰ΩçÈÅ∏ÊâãÁöÑÈ°åÁõÆÊï∏
            const roundsPerPlayer = Math.ceil(config.questionCount / config.playerCount);

            // ‰øùÂ≠òË®≠ÁΩÆÂà∞ localStorage
            const settings = {
                mode: 'battle',
                battle: {
                    playerCount: config.playerCount,
                    roundsPerPlayer: roundsPerPlayer,
                    playerNames: config.playerNames,
                    speedMode: config.speedMode
                },
                timeLimit: currentTimeLimit,
                charCount: currentCharCount
            };

            persistSettings(settings);

            // „ÄêÈáçÊßã„ÄëÁõ¥Êé•Âú® GameState ‰∏≠ÂàùÂßãÂåñÊú¨Âú∞Â∞çÊà∞
            window.GameState.mode = 'local';
            window.GameState.subMode = 'turn_based';
            window.GameState.isActive = true;
            window.GameState.turnBased.currentTurnIndex = 0;
            window.GameState.turnBased.roundsPerPlayer = roundsPerPlayer;
            window.GameState.turnBased.currentRound = 0;
            window.GameState.turnBased.totalRounds = config.playerCount * roundsPerPlayer;
            
            // ÁÇ∫Êú¨Âú∞Â∞çÊà∞Áé©ÂÆ∂ÂàÜÈÖç emoji
            const localPlayerIds = config.playerNames.map((_, i) => 'L' + i);
            const emojiMap = window.RaceTrack.buildEmojiMap(localPlayerIds, 'LOCAL_BATTLE');
            
            window.GameState.players = config.playerNames.map((name, i) => ({
                uid: localPlayerIds[i],
                name: name,
                emoji: emojiMap[localPlayerIds[i]] || 'üèÉ',
                score: 0,
                answered: 0,
                correct: 0,
                lastAnswerTs: 0,
                isReady: false,
                isActive: i === 0
            }));
            
            // È°ØÁ§∫Á©çÂàÜÊùø
            if (typeof window.LocalBattle?.updateScoreboard === 'function') {
                window.LocalBattle.updateScoreboard();
            }
            const battleScoreboard = document.getElementById('battleScoreboard');
            if (battleScoreboard) {
                battleScoreboard.classList.remove('hidden');
            }

            // È°ØÁ§∫Ë≥ΩÈÅì
            const raceTrack = document.getElementById('raceTrack');
            if (raceTrack && window.RaceTrack) {
                raceTrack.classList.remove('hidden');
                window.RaceTrack.render();
            }

            // Êõ¥Êñ∞Â∑¶‰∏äËßíÈ°ØÁ§∫ÁÇ∫Ëº™Ê¨°
            const scoreLabel = document.getElementById('scoreLabel');
            const scoreElement = document.getElementById('score');
            if (scoreLabel && scoreElement) {
                scoreLabel.textContent = 'Ëº™Ê¨°';
                scoreElement.textContent = `1 / ${window.GameState.turnBased.totalRounds}`;
            }

            // È°ØÁ§∫Áï∂ÂâçÈÅ∏ÊâãÈÄöÁü•
            const currentPlayer = window.GameState.players[0];
            showNotification(`${currentPlayer.name} ÁöÑÂõûÂêàÈñãÂßãÔºÅ`);

            // ÈñãÂßãÁ¨¨‰∏ÄËº™
            startNewRound();
        }
        
        function updateModalSections() {
            const selectedModeEl = document.querySelector('input[name="gameMode"]:checked');
            const selectedMode = selectedModeEl ? selectedModeEl.value : 'single';

            // È°ØÁ§∫/Èö±ËóèÂ∞çÊà∞Ê®°ÂºèË®≠ÁΩÆÔºàÂÆâÂÖ®Âà§Êñ∑ÁØÄÈªûÂ≠òÂú®Ôºâ
            if (battleModeSettings) {
                if (selectedMode === 'battle') {
                    battleModeSettings.classList.remove('hidden');
                    // ÁîüÊàêÈÅ∏ÊâãÂêçÁ®±Ëº∏ÂÖ•Ê°Ü
                    generatePlayerNameInputs();
                } else {
                    battleModeSettings.classList.add('hidden');
                }
            }
        }
        
        function openBattlePreviewModal(settings) {
            if (!battlePreviewModal) return;

            const playerCount = settings.battle?.playerCount || 0;
            const roundsPerPlayer = settings.battle?.roundsPerPlayer || 0;
            const players = settings.battle?.playerNames || [];
            const totalRounds = playerCount * roundsPerPlayer;
            const totalQuestions = totalRounds;

            if (battlePreviewPlayerCount) battlePreviewPlayerCount.textContent = String(playerCount);
            if (battlePreviewRounds) battlePreviewRounds.textContent = String(roundsPerPlayer);
            if (battlePreviewTotalQuestions) battlePreviewTotalQuestions.textContent = String(totalQuestions);

            const tl = typeof settings.timeLimit === 'number' ? settings.timeLimit : roundTimeLimit;
            if (battlePreviewTimeLimit) battlePreviewTimeLimit.textContent = `${tl} Áßí`;

            const cc = typeof settings.charCount === 'number' ? settings.charCount : charCount;
            if (battlePreviewCharCount) battlePreviewCharCount.textContent = `${cc} Â≠ó`;

            if (battlePreviewPlayersList) {
                battlePreviewPlayersList.innerHTML = '';
                players.forEach((name, index) => {
                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-2xl p-3 border border-white/20 flex items-center gap-3 shadow-sm';
                    card.innerHTML = `
                        <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-primary-100 to-primary-200 flex items-center justify-center text-primary-600 font-modern font-bold">${index + 1}</div>
                        <div>
                            <div class="text-base font-modern font-semibold text-surface-800">${name}</div>
                            <div class="text-xs text-surface-500 font-modern">Á¨¨ ${index + 1} ‰Ωç‰∏äÂ†¥</div>
                        </div>
                    `;
                    battlePreviewPlayersList.appendChild(card);
                });
            }

            const isSpeed = !!settings.battle?.speedMode;
            if (battlePreviewSpeedRow) {
                if (isSpeed) {
                    battlePreviewSpeedRow.classList.remove('hidden');
                    if (battlePreviewSpeedText) {
                        battlePreviewSpeedText.textContent = 'ÈÄüÂ∫¶Ê®°ÂºèÂ∑≤ÈñãÂïüÔºöË∂äÂø´ÂÆåÊàêÁ≠îÈ°åÔºåË∂äÂèØ‰ª•Áç≤ÂæóÈ°çÂ§ñÂä†ÂàÜÔºàÊúÄÈ´òÂèØÂÜçÂä† 50%Ôºâ„ÄÇ';
                    }
                } else {
                    battlePreviewSpeedRow.classList.add('hidden');
                }
            }

            if (battlePreviewNote) {
                const noteLines = [
                    'Â∞áÊåâÁÖßÂêçÂñÆÈ†ÜÂ∫èËº™ÊµÅÁ≠îÈ°åÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïË®òÈåÑÂàÜÊï∏„ÄÇ',
                    'Ëã•Á≠îÈåØÊàñË∂ÖÊôÇÂ∞á‰∏çÂä†ÂàÜÔºåË´ãÂ∞àÂøÉÂÆåÊàêÊØèÈ°åË©©Âè•ÁµÑÂêà„ÄÇ',
                    isSpeed ? 'ÈÄüÂ∫¶Âä†ÂàÜÊúÉ‰æùÁÖßÂâ©È§òÊôÇÈñìÂç≥ÊôÇË®àÁÆó„ÄÇ' : 'Ê≠§Â†¥Â∞çÊà∞‰ª•Ê∫ñÁ¢∫Â∫¶ÁÇ∫‰∏ªÔºå‰øùÊåÅÁ©©ÂÆöÁØÄÂ•èÂç≥ÂèØ„ÄÇ'
                ];
                battlePreviewNote.innerHTML = noteLines.map(line => `<div class="flex items-start gap-2"><span class="text-primary-500">‚Ä¢</span><span>${line}</span></div>`).join('');
            }

            battlePreviewModal.classList.remove('hidden');
        }

        function closeBattlePreviewModal() {
            if (!battlePreviewModal) return;
            battlePreviewModal.classList.add('hidden');
        }

        function saveSettingsFromModal() {
            const selectedMode = document.querySelector('input[name="gameMode"]:checked')?.value || 'single';
            const selectedDB = 'tag';
            
            // ‰øùÂ≠òÈÅäÊà≤Ê®°Âºè
            if (selectedMode === 'battle') {
                currentGameMode = 'battle';
            } else {
                currentGameMode = selectedDB === 'custom' ? 'custom' : 'preset';
            }
            
            // ‰øùÂ≠òË©©Ë©ûÂ∫´Ë®≠ÁΩÆ
            if (selectedDB === 'default') {
                activeDatabase = tangPoetryLines;
            } else if (selectedDB === 'elementary') {
                activeDatabase = elementaryPoemLines;
            }
            // Ë©©Ë©ûÂ∫´ÊîπÁÇ∫Ê®ôÁ±§Ê®°ÂºèÔºå‰øùÂ≠òÁï∂ÂâçÈÅ∏‰∏≠ÁöÑÊ®ôÁ±§
            const tagSel = document.getElementById('userLibraryTagSelect');
            if (tagSel) saveActiveTag(tagSel.value || '');

            // ‰øùÂ≠òË®≠ÁΩÆÂà∞ localStorage
            const settingsToSave = {
                gameMode: selectedMode,
                poemDatabase: selectedDB,
                timeLimit: parseInt(timeLimitSlider?.value || '30'),
                charCount: parseInt(charCountSlider?.value || '20'),
                difficulty: difficultySelect?.value || 'medium',
                soundOn: !!window.soundEnabled,
                battle: {
                    playerCount: parseInt(playerCountSelect?.value || '2'),
                    roundsPerPlayer: Math.max(1, Math.min(50, parseInt(roundsPerPlayerInput?.value || '5'))),
                    speedMode: !!(speedModeCheckbox && speedModeCheckbox.checked),
                    playerNames: Array.from({ length: parseInt(playerCountSelect?.value || '2') }, (_, i) => {
                        const input = document.getElementById(`player${i + 1}Name`);
                        return input ? input.value || `ÈÅ∏Êâã${i + 1}` : `ÈÅ∏Êâã${i + 1}`;
                    })
                }
            };
            persistSettings(settingsToSave);
            
            // Â∞çÊà∞Ê®°ÂºèÂÖàÈ°ØÁ§∫È†êË¶ΩÊ®°ÊÖãÔºõÂñÆ‰∫∫Ê®°ÂºèÈúÄÂÆâÂÖ®ÈÄÄÂá∫Â∞çÊà∞
            if (selectedMode === 'battle') {
                closeSettingsModalFunc();
                openBattlePreviewModal(settingsToSave);
            } else {
                // Ëã•Ê≠£ËôïÊñºÂ∞çÊà∞Ê®°ÂºèÔºåÂÆâÂÖ®ÈÄÄÂá∫‰∏¶ÂàáÂõûÂñÆ‰∫∫Ê®°Âºè
                if (window.GameMode.isLocal() && window.GameState.isActive) {
                    window.GameState.mode = 'solo';
                    window.GameState.subMode = null;
                    window.GameState.isActive = false;
                    window.GameState.players = [];
                    battleScoreboard && battleScoreboard.classList.add('hidden');
                    
                    // Èö±ËóèË≥ΩÈÅì
                    try {
                        const track = document.getElementById('raceTrack');
                        if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                    } catch(_){}
                }
                currentGameMode = 'preset';
                closeSettingsModalFunc();
                showNotification('Â∑≤ÂàáÊèõÂà∞ÂñÆ‰∫∫Ê®°Âºè');
                // Á´ãÂç≥ÈñãÂßãÂñÆ‰∫∫Êñ∞ÂõûÂêà
                startNewRound();
            }
        }
        
        function startTimer() {
            // ÈôêÊôÇÊ®°ÂºèÔºö‰∏çÂïüÁî®ÂñÆÈ°åË®àÊôÇÂô®
            if (window.GameMode.isTimedScore()) return;
            if (timeLeft > 0) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;
                    if (timeBarFill && roundTimeLimit > 0) {
                        const pct = Math.max(0, Math.min(100, (timeLeft / roundTimeLimit) * 100));
                        timeBarFill.style.width = pct + '%';
                        if (timeLeft <= 10 && timeLeft > 0) {
                            timeBarFill.classList.remove('bg-primary');
                            timeBarFill.classList.add('bg-red-500');
                        }
                    }
                    
                    if (timeLeft === 10) {
                        soundManager.play('timeWarning');
                    }
                    
                    if (timeLeft <= 0) {
                        endRound(false);
                    }
                }, 1000);
            }
        }

        // Â∞çÊà∞Ê®°ÂºèÁõ∏ÈóúÂáΩÊï∏
        function initializeBattleMode() {
            // ÁîüÊàêÈÅ∏ÊâãÂêçÁ®±Ëº∏ÂÖ•Ê°Ü
            generatePlayerNameInputs();
            
            // Á∂ÅÂÆöÈÅ∏ÊâãÊï∏ÈáèËÆäÊõ¥‰∫ã‰ª∂
            if (playerCountSelect) {
                playerCountSelect.addEventListener('change', generatePlayerNameInputs);
            }
            if (roundsPerPlayerInput) {
                roundsPerPlayerInput.addEventListener('input', () => {
                    const v = Math.max(1, Math.min(50, parseInt(roundsPerPlayerInput.value || '5')));
                    roundsPerPlayerInput.value = String(isNaN(v) ? 5 : v);
                });
            }
            
            // ÈñãÂßãÂ∞çÊà∞ÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞‰øùÂ≠òË®≠ÁΩÆ‰∏≠
        }
        
        function generatePlayerNameInputs() {
            const playerCount = parseInt(playerCountSelect.value);
            playerNamesContainer.innerHTML = '';
            
            for (let i = 0; i < playerCount; i++) {
                const inputDiv = document.createElement('div');
                inputDiv.innerHTML = `
                    <label class="block text-sm font-medium mb-1">ÈÅ∏Êâã ${i + 1}Ôºö</label>
                    <input type="text" id="player${i + 1}Name" placeholder="Ëº∏ÂÖ•ÈÅ∏ÊâãÂêçÁ®±" 
                           class="w-full p-2 rounded-md border border-gray-300 bg-white text-base" 
                           value="ÈÅ∏Êâã${i + 1}">
                `;
                playerNamesContainer.appendChild(inputDiv);
            }

            // ÂæûÊú¨Âú∞Â≠òÂÑ≤ÊÅ¢Âæ©Áé©ÂÆ∂ÂêçÁ®±ÔºàËã•ÊúâÔºâ
            const saved = loadSettings();
            if (saved && saved.battle && Array.isArray(saved.battle.playerNames)) {
                saved.battle.playerNames.forEach((name, idx) => {
                    const input = document.getElementById(`player${idx + 1}Name`);
                    if (input && name) input.value = name;
                });
            }
        }
        
        function confirmStartBattleMode() {
            // Ëã•ÈÅ†Á®ãÈôêÊôÇÊ®°ÂºèÈÄ≤Ë°å‰∏≠ÔºåÁ¶ÅÊ≠¢ÂïüÂãïÊú¨Âú∞Ëº™ÊµÅÔºåÁõ¥Êé•ËøîÂõû
            if (window.GameMode.isTimedScore()) {
                try { showNotification && showNotification('ÁõÆÂâçÁÇ∫ÈÅ†Á®ãÈôêÊôÇÁ´∂Ë≥ΩÔºåÂ∑≤Á¶ÅÁî®Êú¨Âú∞Ëº™ÊµÅÊ®°Âºè'); } catch(_){ }
                return;
            }
            
            // Êî∂ÈõÜÈÅ∏ÊâãÂêçÁ®±ÂíåË®≠ÁΩÆ
            const playerCount = parseInt(playerCountSelect.value);
            const roundsPerPlayer = Math.max(1, Math.min(50, parseInt(roundsPerPlayerInput.value || '5')));
            const playerNames = [];
            
            for (let i = 0; i < playerCount; i++) {
                const nameInput = document.getElementById(`player${i + 1}Name`);
                const playerName = nameInput ? nameInput.value || `ÈÅ∏Êâã${i + 1}` : `ÈÅ∏Êâã${i + 1}`;
                playerNames.push(playerName);
            }

            // ÂØ´Âõû‰øùÂ≠òÁé©ÂÆ∂Ë®≠ÁΩÆ
            const s = loadSettings();
            s.battle = s.battle || {}; 
            s.battle.playerCount = playerCount;
            s.battle.roundsPerPlayer = roundsPerPlayer;
            s.battle.speedMode = !!(speedModeCheckbox && speedModeCheckbox.checked);
            s.battle.playerNames = playerNames;
            persistSettings(s);
            
            // „ÄêÈáçÊßã„ÄëÁõ¥Êé•Âú® GameState ‰∏≠ÂàùÂßãÂåñÊú¨Âú∞Â∞çÊà∞
            window.GameState.mode = 'local';
            window.GameState.subMode = 'turn_based';
            window.GameState.isActive = true;
            window.GameState.turnBased.currentTurnIndex = 0;
            window.GameState.turnBased.roundsPerPlayer = roundsPerPlayer;
            window.GameState.turnBased.currentRound = 0;
            window.GameState.turnBased.totalRounds = playerCount * roundsPerPlayer;
            
            // ÁÇ∫Êú¨Âú∞Â∞çÊà∞Áé©ÂÆ∂ÂàÜÈÖç emoji
            const localPlayerIds = playerNames.map((_, i) => 'L' + i);
            const emojiMap = window.RaceTrack.buildEmojiMap(localPlayerIds, 'LOCAL_BATTLE');
            
            window.GameState.players = playerNames.map((name, i) => ({
                uid: localPlayerIds[i],
                name: name,
                emoji: emojiMap[localPlayerIds[i]] || 'üèÉ',
                score: 0,
                answered: 0,
                correct: 0,
                lastAnswerTs: 0,
                isReady: false,
                isActive: i === 0
            }));
            
            console.log('[local] battle started. GameState:', {
                mode: window.GameState.mode,
                players: window.GameState.players.map(p => ({ name: p.name, emoji: p.emoji, uid: p.uid }))
            });
            
            // È°ØÁ§∫Á©çÂàÜÊùø
            if (typeof window.LocalBattle?.updateScoreboard === 'function') window.LocalBattle.updateScoreboard();
            battleScoreboard.classList.remove('hidden');
            
            // Ëß∏ÁôºË≥ΩÈÅìÊ∏≤Êüì
            try {
                console.log('[local] calling RaceTrack.render...');
                if (!window.RaceTrack) {
                    console.error('[local] RaceTrack not found!');
                } else if (!window.RaceTrack.render) {
                    console.error('[local] RaceTrack.render not found!');
                } else {
                    window.RaceTrack.render();
                    console.log('[local] RaceTrack.render called successfully');
                }
            } catch(e){ console.error('[local] RaceTrack.render error:', e); }
            
            // ÈñãÂßãÁ¨¨‰∏ÄËº™
            // Â¶ÇÊûúÈÅäÊà≤Êö´ÂÅúÊàñÂ∞öÊú™ÂïüÂãïÔºåÁõ¥Êé•ÈñãÂßãÔºõËã•Â∑≤ÊúâË®àÊôÇÔºåÈáçÁΩÆÁãÄÊÖã
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            isGameActive = false;
            if (typeof window.LocalBattle?.startRound === 'function') window.LocalBattle.startRound();
            showNotification('Â∞çÊà∞Ê®°ÂºèÂ∑≤ÂïüÂãïÔºÅ');
        }
        
        // ÂàÜÊï∏Êï∏Â≠óÂãïÁï´ÔºàÂæû from Âà∞ toÔºåÊôÇÈï∑ÊØ´ÁßíÔºâ
        function animateScoreValue(element, from, to, duration) {
            const start = performance.now();
            const change = to - from;
            if (change === 0) {
                element.textContent = String(to);
                return;
            }
            const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
            function step(now) {
                const elapsed = now - start;
                const progress = Math.min(1, elapsed / duration);
                const eased = easeOutCubic(progress);
                const current = Math.round(from + change * eased);
                element.textContent = String(current);
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

window.LocalBattle.updateScoreboard = function updateBattleScoreboard() {
            leftPlayersContainer.innerHTML = '';
            rightPlayersContainer.innerHTML = '';
            
            // „ÄêÈáçÊßã„ÄëÁµ±‰∏ÄÂæû GameState ËÆÄÂèñÁé©ÂÆ∂Êï∏Êìö
            console.log('[scoreboard] updating, GameState:', { 
                mode: window.GameState.mode, 
                subMode: window.GameState.subMode, 
                isActive: window.GameState.isActive,
                isAnyBattle: window.GameMode.isAnyBattle(),
                playersCount: window.GameState.players?.length || 0
            });
            
            if (!window.GameMode.isAnyBattle()) {
                console.log('[scoreboard] not in battle mode, skipping');
                return;
            }
            
            const players = window.GameState.players;
            if (!players || players.length === 0) {
                console.log('[scoreboard] no players data');
                return;
            }
            
            console.log('[scoreboard] rendering', players.length, 'players');
            
            const isTimed = window.GameMode.isTimedScore();
            
            // Ë®àÁÆóÂêçÊ¨°ÔºàÂÉÖÈôêÊôÇÊ®°ÂºèÈ°ØÁ§∫ÂæΩÁ´†Ôºâ
            const rankByUid = {};
            if (isTimed) {
                const ranked = [...players].sort((a,b) => (b.score - a.score) || (a.lastAnswerTs - b.lastAnswerTs));
                ranked.forEach((p, i) => rankByUid[p.uid] = i + 1);
            }

            const leftCount = Math.ceil(players.length / 2);

            players.forEach((player, index) => {
                const isLeftSide = index < leftCount;
                const container = isLeftSide ? leftPlayersContainer : rightPlayersContainer;
                
                const playerCard = document.createElement('div');
                const themeClass = `player-theme-${(index % 6) + 1}`;
                const showActive = window.GameMode.isLocal() && !!player.isActive;
                playerCard.className = `player-score-card ${themeClass} ${showActive ? 'active' : ''} relative`;
                
                const displayScoreValue = player.score || 0;
                const rankBadge = isTimed && rankByUid[player.uid] ? `<div class="absolute -top-2 -left-2 w-7 h-7 rounded-full bg-primary text-white text-sm font-bold flex items-center justify-center shadow">${rankByUid[player.uid]}</div>` : '';
                
                // È°ØÁ§∫Áé©ÂÆ∂ emoji
                const playerEmoji = player.emoji ? `<span class="text-2xl mr-2">${player.emoji}</span>` : '';
                
                playerCard.innerHTML = `
                    ${rankBadge}
                    <div class="player-name text-lg md:text-xl font-bold flex items-center">${playerEmoji}${player.name}</div>
                    <div class="player-score text-2xl md:text-3xl">${displayScoreValue}</div>
                    ${showActive ? '<div class=\"current-turn-indicator\"></div>' : ''}
                `;
                
                container.appendChild(playerCard);

                // ÂàÜÊï∏ÊªæÂãïÂãïÁï´
                const scoreEl = playerCard.querySelector('.player-score');
                if (player._prevScore !== undefined && player._prevScore !== player.score) {
                    scoreEl.classList.add('animate-score');
                    animateScoreValue(scoreEl, player._prevScore, player.score, 700);
                    setTimeout(() => scoreEl.classList.remove('animate-score'), 800);
                }
                player._prevScore = player.score;
            });
        }
        
        window.LocalBattle.startRound = function startBattleRound() {
            // ÈôêÊôÇÊ®°Âºè‰∏ã‰∏ç‰ΩøÁî®Êú¨Âú∞Ëº™ÊµÅÂõûÂêà
            if (window.GameMode.isTimedScore()) return;
            const currentPlayer = window.GameState.players[window.GameState.turnBased.currentTurnIndex];
            showNotification(`${currentPlayer.name} ÁöÑÂõûÂêàÈñãÂßãÔºÅ`);
            
            // ÈñãÂßãÊñ∞ÁöÑ‰∏ÄËº™ÈÅäÊà≤
            startNewRound();

            // Â∑¶‰∏äËßíÈ°ØÁ§∫Â∞çÊà∞Ëº™Ê¨°ÔºàÊõø‰ª£ÂàÜÊï∏Ôºâ
            if (scoreLabel && scoreElement) {
                // ÈôêÊôÇÊ®°Âºè‰∏ãÁ∂≠ÊåÅÂàÜÊï∏Ê®ôÁ±§
                if (window.GameMode.isTimedScore()) {
                    scoreLabel.textContent = 'ÂàÜÊï∏';
                    scoreElement.textContent = String(score);
                } else {
                    scoreLabel.textContent = 'Ëº™Ê¨°';
                    scoreElement.textContent = `${window.GameState.turnBased.currentRound + 1} / ${window.GameState.turnBased.totalRounds}`;
                }
            }
        }
        
        window.LocalBattle.endRound = function endBattleRound(isCorrect) {
            // ÈôêÊôÇÊ®°Âºè‰∏ã‰∏ç‰ΩøÁî®Êú¨Âú∞Ëº™ÊµÅÂõûÂêàÁµêÊùü
            if (window.GameMode.isTimedScore()) return;
            
            // „ÄêÈáçÊßã„ÄëÁõ¥Êé•Âæû GameState ËÆÄÂèñÂíåÊõ¥Êñ∞
            const currentIndex = window.GameState.turnBased.currentTurnIndex;
            const currentPlayer = window.GameState.players[currentIndex];
            if (!currentPlayer) return;
            
            if (isCorrect) {
                // Âü∫Á§éÂàÜ
                let gained = 10;
                // ÈÄüÂ∫¶Ê®°ÂºèÂä†Êàê
                if (speedModeCheckbox && speedModeCheckbox.checked && roundTimeLimit > 0) {
                    const ratio = Math.max(0, Math.min(1, timeLeft / roundTimeLimit));
                    const bonus = Math.floor(gained * 0.5 * ratio);
                    gained += bonus;
                    showNotification(`${currentPlayer.name} Á≠îÂ∞çÔºÅÈÄüÂ∫¶Âä†Êàê +${bonus} ÂàÜ`);
                } else {
                    showNotification(`${currentPlayer.name} Á≠îÂ∞ç‰∫ÜÔºÅÁç≤Âæó${gained}ÂàÜ`);
                }
                currentPlayer.score += gained;
                currentPlayer.correct += 1;
            } else {
                showNotification(`${currentPlayer.name} Á≠îÈåØ‰∫Ü`);
            }
            currentPlayer.answered += 1;
            currentPlayer.lastAnswerTs = Date.now();
            
            // Ëß∏Áôº UI Êõ¥Êñ∞
            try {
                window.LocalBattle?.updateScoreboard();
                window.RaceTrack?.render();
            } catch(e){ console.error('[local] UI update error:', e); }
            
            // Ê™¢Êü•ÊòØÂê¶ÂÆåÊàêÊâÄÊúâÂõûÂêà
            window.GameState.turnBased.currentRound++;
            // Êõ¥Êñ∞Â∑¶‰∏äËßíËº™Ê¨°È°ØÁ§∫
            if (scoreLabel && scoreElement) {
                scoreLabel.textContent = 'Ëº™Ê¨°';
                scoreElement.textContent = `${Math.min(window.GameState.turnBased.currentRound + 1, window.GameState.turnBased.totalRounds)} / ${window.GameState.turnBased.totalRounds}`;
            }
            if (window.GameState.turnBased.currentRound >= window.GameState.turnBased.totalRounds) {
                if (typeof window.LocalBattle?.endMode === 'function') window.LocalBattle.endMode();
                return;
            }
            
            // ÂàáÊèõÂà∞‰∏ã‰∏ÄÂÄãÈÅ∏Êâã
            const prevIndex = window.GameState.turnBased.currentTurnIndex;
            window.GameState.players[prevIndex].isActive = false;
            window.GameState.turnBased.currentTurnIndex = (window.GameState.turnBased.currentTurnIndex + 1) % window.GameState.players.length;
            window.GameState.players[window.GameState.turnBased.currentTurnIndex].isActive = true;
            
            // ÂÖàÂàáÊèõ activeÔºåÂÜçÊõ¥Êñ∞Á©çÂàÜÊùøÔºåËÆìÂëºÂê∏ÂãïÁï´Ë∑üÈö®ÁõÆÂâçÁ≠îÈ°åËÄÖ
            if (typeof window.LocalBattle?.updateScoreboard === 'function') window.LocalBattle.updateScoreboard();
            
            // ÈñãÂßã‰∏ã‰∏ÄËº™ - ÁßªÈô§Ëá™Âä®Âª∂ËøüÔºåÊîπ‰∏∫ÊâãÂä®ÊéßÂà∂
            // startBattleRound() Â∞ÜÁî±ÊµÆÁ™óÁöÑ"‰∏ã‰∏ÄËº™"ÊåâÈíÆË∞ÉÁî®
        }
        
window.LocalBattle.endMode = function endBattleMode() {
            // ÈôêÊôÇÊ®°Âºè‰∏ã‰∏çËµ∞Êú¨Âú∞Ëº™ÊµÅÁµêÁÆó
            if (window.RemoteBattle?.room && typeof state !== 'undefined' && state.timedMode) return;
            window.GameState.isActive = false;
            
            // Èö±ËóèÁ©çÂàÜÊùø
            battleScoreboard.classList.add('hidden');
            
            // Èö±ËóèË≥ΩÈÅìÔºåÊÅ¢Âæ©ÂÄíË®àÊôÇÈÄ≤Â∫¶Ê¢ù
            try { 
                const track = document.getElementById('raceTrack'); 
                if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                const timeBarFill = document.getElementById('timeBarFill');
                if (timeBarFill) { timeBarFill.style.display = ''; timeBarFill.style.width = '100%'; }
            } catch(_){}
            
            // È°ØÁ§∫Â∞çÊà∞ÁµêÊûúÁ∏ΩÁµêÁ™óÂè£ÔºàÂú®Ê∏ÖÁ©∫Áé©ÂÆ∂Êï∏Êìö‰πãÂâçË™øÁî®Ôºâ
            showBattleResultModal();

            // Ê∏ÖÁêÜ GameStateÔºàÂú®È°ØÁ§∫ÁµêÊûúÁ™óÂè£‰πãÂæåÔºâ
            try { 
                window.GameState.mode = 'solo'; 
                window.GameState.subMode = null; 
                window.GameState.isActive = false; 
                window.GameState.players = [];
            } catch(_){}

            // ÊÅ¢Âæ©ÂñÆ‰∫∫Ê®°ÂºèÂ∑¶‰∏äËßíÈ°ØÁ§∫ÁÇ∫ÂàÜÊï∏
            if (scoreLabel && scoreElement) {
                scoreLabel.textContent = 'ÂàÜÊï∏';
                scoreElement.textContent = String(score);
            }
        }
        
        function showBattleResultModal() {
            // „ÄêÈáçÊßã„Äë1) ÈÅ†Á®ãÈôêÊôÇÊ®°ÂºèÁµêÊûúÔºöÁõ¥Êé•Âæû GameState ËÆÄÂèñ
            if (window.RemoteBattle?.room && window.GameMode.isTimedScore()) {
                const timedEnded = !window.GameState.isActive;
                if (timedEnded) {
                    try {
                        const rows = window.GameState.players.map(p => ({
                            name: p.name,
                            score: p.score || 0,
                            _last: p.lastAnswerTs || 0
                        })).sort((a,b) => (b.score - a.score) || (a._last - b._last));

                        // Ê®ôÈ°å
                        winnerAnnouncement.textContent = 'Á´∂Ë≥ΩÁµêÊùü';
                        if (rows.length && rows[0].score > 0) {
                            winnerScore.textContent = `ÊúÄÈ´òÂàÜÔºö${rows[0].name} ${rows[0].score} ÂàÜ`;
                        } else {
                            winnerScore.textContent = '';
                        }

                        // ÊéíË°åÂÖßÂÆπ
                        battleRankings.innerHTML = '';
                        rows.forEach((r, i) => {
                            const rank = i + 1;
                            const rankItem = document.createElement('div');
                            rankItem.className = 'rank-item';
                            rankItem.style.animationDelay = `${i * 0.06}s`;
                            const medals = ['ü•á','ü•à','ü•â'];
                            const rankText = rank <= 3 ? medals[rank-1] : `#${rank}`;
                            rankItem.innerHTML = `
                                <div class="rank-medal w-12 text-center">${rankText}</div>
                                <div class="rank-name flex-grow text-lg">${r.name}</div>
                                <div class="rank-score text-xl">${r.score} <span class="text-sm">ÂàÜ</span></div>
                            `;
                            battleRankings.appendChild(rankItem);
                        });

                        // ÊåâÈàïÔºöÂÉÖÈ°ØÁ§∫ÈóúÈñâÔºåÈªûÊìäÂæåËøîÂõûÂñÆ‰∫∫Ê®°Âºè‰∏¶Ëá™ÂãïÈñãÂ±Ä
                        try {
                            const newBattleBtn = document.getElementById('newBattleBtn');
                            const exitBattleBtn = document.getElementById('exitBattleBtn');
                            if (newBattleBtn) newBattleBtn.classList.add('hidden');
                            if (exitBattleBtn) {
                                exitBattleBtn.textContent = 'ÈóúÈñâ';
                                exitBattleBtn.classList.remove('hidden');
                                exitBattleBtn.onclick = () => {
                                    battleResultModal.classList.add('hidden');
                                    // „ÄêÈáçÊßã„ÄëÊ∏ÖÁêÜ GameState
                                    try { 
                                        window.GameState.mode = 'solo'; 
                                        window.GameState.subMode = null; 
                                        window.GameState.isActive = false; 
                                        window.GameState.players = [];
                                    } catch(_){}
                                    // Èö±ËóèÂ∑¶/Âè≥ÂÅ¥Ë®òÂàÜÂç°
                                    try { const board = document.getElementById('battleScoreboard'); board && board.classList.add('hidden'); } catch(_){ }
                                    // Èö±ËóèË≥ΩÈÅìÔºåÊÅ¢Âæ©ÂÄíË®àÊôÇÈÄ≤Â∫¶Ê¢ù
                                    try { 
                                        const track = document.getElementById('raceTrack'); 
                                        if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                                        const timeBarFill = document.getElementById('timeBarFill');
                                        if (timeBarFill) { timeBarFill.style.display = ''; timeBarFill.style.width = '100%'; }
                                    } catch(_){}
                                    // Ëá™ÂãïÈñãÂßãÂñÆ‰∫∫‰∏ÄÂ±Ä
                                    if (typeof window.startNewRound === 'function') window.startNewRound();
                                };
                            }
                        } catch(_){}

                        battleResultModal.classList.remove('hidden');
                        return;
                    } catch(_) { /* fallback Âà∞ËàäÁâà */ }
                }
            }

            // 2) ËàäÊ®°ÂºèÔºàÊú¨Âú∞Ëº™ÊµÅÔºâÔºöÂæû GameState ËÆÄÂèñ
            const sortedPlayers = [...window.GameState.players].sort((a, b) => b.score - a.score);
            
            // 2. ÊâæÂá∫ÊúÄÈ´òÂàÜ
            const highScore = sortedPlayers.length > 0 ? sortedPlayers[0].score : 0;
            
            // 3. ÊâæÂá∫ÊâÄÊúâËé∑ÂæóÊúÄÈ´òÂàÜÁöÑÁé©ÂÆ∂
            const winners = sortedPlayers.filter(player => player.score === highScore);

            // 4. ËÆæÁΩÆËé∑ËÉúËÄÖ‰ø°ÊÅØ
            if (winners.length > 1) {
                // Âπ≥Â±ÄÊàñÂ§ö‰∫∫Âπ∂ÂàóÁ¨¨‰∏Ä
                const winnerNames = winners.map(p => p.name).join(', ');
                winnerAnnouncement.textContent = `üèÜ Âπ≥Â±ÄÔºÅ`;
                winnerScore.textContent = `${winnerNames} Âπ∂ÂàóÁ¨¨‰∏Ä!`;
            } else if (winners.length === 1) {
                // ÂçïÁã¨Ëé∑ËÉúËÄÖ
                const winner = winners[0];
                winnerAnnouncement.textContent = `üéâ ÊÅ≠Âñú ${winner.name} Ëé∑ËÉúÔºÅ`;
                winnerScore.textContent = `ÊúÄÁªàÂæóÂàÜ: ${winner.score}`;
            } else {
                // Ê≤°ÊúâÁé©ÂÆ∂ÁöÑÊÉÖÂÜµ
                winnerAnnouncement.textContent = 'ÊØîËµõÁªìÊùü';
                winnerScore.textContent = 'Ê≤°ÊúâÁé©ÂÆ∂ÂèÇ‰∏é';
            }
            
            // 5. ÁîüÊàêÊéíË°åÊ¶ú (Â§ÑÁêÜÂπ∂ÂàóÊéíÂêç)
            battleRankings.innerHTML = '';
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            let rank = 1;
            for (let i = 0; i < sortedPlayers.length; i++) {
                const player = sortedPlayers[i];

                // Â¶ÇÊûúÂΩìÂâçÁé©ÂÆ∂ÂàÜÊï∞‰Ωé‰∫éÂâç‰∏Ä‰∏™Áé©ÂÆ∂ÔºåÊõ¥Êñ∞ÊéíÂêç
                if (i > 0 && player.score < sortedPlayers[i-1].score) {
                    rank = i + 1;
                }

                const rankItem = document.createElement('div');
                rankItem.className = 'rank-item';
                rankItem.style.animationDelay = `${i * 0.1}s`;

                const rankText = rank <= 3 ? medals[rank - 1] : `#${rank}`;
                
                rankItem.innerHTML = `
                    <div class="rank-medal w-12 text-center">${rankText}</div>
                    <div class="rank-name flex-grow text-lg">${player.name}</div>
                    <div class="rank-score text-xl">${player.score} <span class="text-sm">ÂàÜ</span></div>
                `;
                
                battleRankings.appendChild(rankItem);
            }
            
            // 6. È°ØÁ§∫Á∏ΩÁµêÁ™óÂè£
            battleResultModal.classList.remove('hidden');
        }
        
        function startNewBattle() {
            // „ÄêÈáçÊßã„ÄëÈáçÁΩÆ GameStateÔºà‰∏ªÊï∏ÊìöÊ∫êÔºâ
            window.GameState.mode = 'local';
            window.GameState.subMode = 'turn_based';
            window.GameState.isActive = true;
            window.GameState.turnBased.currentTurnIndex = 0;
            window.GameState.turnBased.currentRound = 0;
            
            // ÈáçÁΩÆÁé©ÂÆ∂Êï∏ÊìöÔºà‰øùÊåÅ emoji Âíå ÂêçÁ®±Ôºâ
            window.GameState.players.forEach(player => {
                player.score = 0;
                player.answered = 0;
                player.correct = 0;
                player.lastAnswerTs = 0;
                player.isActive = false;
            });
            if (window.GameState.players.length > 0) {
                window.GameState.players[0].isActive = true;
            }
            
            // ÈóúÈñâÁ∏ΩÁµêÁ™óÂè£
            battleResultModal.classList.add('hidden');
            
            // ÈáçÊñ∞ÈñãÂßãÂ∞çÊà∞
            updateBattleScoreboard();
            battleScoreboard.classList.remove('hidden');
            if (typeof window.LocalBattle?.startRound === 'function') window.LocalBattle.startRound();
            
            showNotification('Êñ∞ÁöÑÂ∞çÊà∞ÈñãÂßãÔºÅ');
        }
        
        function exitBattleMode() {
            // ÈóúÈñâÁ∏ΩÁµêÁ™óÂè£
            battleResultModal.classList.add('hidden');
            
            // „ÄêÈáçÊßã„ÄëÊ∏ÖÁêÜ GameState
            window.GameState.mode = 'solo';
            window.GameState.subMode = null;
            window.GameState.isActive = false;
            window.GameState.players = [];
            currentGameMode = 'preset';
            
            // Èö±ËóèË≥ΩÈÅìÂíåÁ©çÂàÜÊùø
            try {
                const track = document.getElementById('raceTrack');
                if (track) { track.classList.add('hidden'); track.innerHTML = ''; track.dataset.built = ''; }
                const scoreboard = document.getElementById('battleScoreboard');
                if (scoreboard) scoreboard.classList.add('hidden');
            } catch(_){}
            
            // ÈñãÂßãÂñÆ‰∫∫Ê®°Âºè
            showNotification('Â∑≤ÂàáÊèõÂà∞ÂñÆ‰∫∫Ê®°Âºè');
            startNewRound();
        }

        // Ë®≠ÁΩÆÊ®°ÊÖãÂΩàÁ™ó‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupSettingsEventListeners() {
            // Ë®≠ÁΩÆÊåâÈàïÈªûÊìä‰∫ã‰ª∂
            if (adminModeToggle) {
                adminModeToggle.addEventListener('click', openSettingsModal);
            }
            
            // ÈóúÈñâÊåâÈàï‰∫ã‰ª∂
            if (closeSettingsModal) {
                closeSettingsModal.addEventListener('click', closeSettingsModalFunc);
            }
            
            if (cancelSettings) {
                cancelSettings.addEventListener('click', closeSettingsModalFunc);
            }
            
            // ‰øùÂ≠òË®≠ÁΩÆÊåâÈàï‰∫ã‰ª∂
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => {
                    saveSettingsFromModal();
                    // Á´ãÂç≥Âà∑Êñ∞ UI ‰ª•ÂèçÊò†ÂèØËÉΩÁöÑÈ°ØÁ§∫ÊîπËÆä
                    updateModalSections();
                });
            }

            // Ë©©Ë©ûÂ∫´Â∞éÂá∫/Â∞éÂÖ•
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const importExcelBtn = document.getElementById('importExcelBtn');
            const importExcelInput = document.getElementById('importExcelInput');
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportAsExcel);
            if (importExcelBtn && importExcelInput) {
                importExcelBtn.addEventListener('click', () => importExcelInput.click());
                importExcelInput.addEventListener('change', (e) => {
                    const file = e.target.files?.[0];
                    if (file) importFromExcelFile(file);
                    importExcelInput.value = '';
                });
            }
            
            // Ë©©Ë©ûÂ∫´Ê®ôÁ±§ËÆäÊõ¥‰∫ã‰ª∂
            const tagSel = document.getElementById('userLibraryTagSelect');
            if (tagSel) {
                tagSel.addEventListener('change', () => saveActiveTag(tagSel.value || ''));
            }
            
            // Ë©©Ë©ûÂ∫´ËÆäÊõ¥‰∫ã‰ª∂ÔºàËã•Ë©©Ë©ûÂ∫´ÈÅ∏È†Ö‰∏çÂ≠òÂú®ÂâáË∑≥ÈÅéÔºâ
            const poemDBRadios = document.querySelectorAll('input[name="poemDatabase"]');
            if (poemDBRadios && poemDBRadios.length) {
                poemDBRadios.forEach(radio => radio.addEventListener('change', updateModalSections));
            }
            
            // ÈÅäÊà≤Ê®°ÂºèËÆäÊõ¥‰∫ã‰ª∂ÔºàÂñÆ‰∫∫/Â∞çÊà∞Ôºâ
            document.querySelectorAll('input[name="gameMode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateModalSections();
                });
            });
            
            // ÊªëÂãïÊ¢ù‰∫ã‰ª∂
            if (timeLimitSlider) {
                timeLimitSlider.addEventListener('input', () => {
                    timeLimitValue.textContent = timeLimitSlider.value;
                });
            }
            
            if (charCountSlider) {
                charCountSlider.addEventListener('input', () => {
                    charCountValue.textContent = charCountSlider.value;
                });
            }
            
            // Ëá™ÂÆöÁæ©Ë©©Âè•‰øùÂ≠ò‰∫ã‰ª∂
            if (saveCustomPoemButton) {
                saveCustomPoemButton.addEventListener('click', saveCustomPoem);
            }
            
            // Â∞çÊà∞Ê®°ÂºèÈÅ∏ÊâãÊï∏ÈáèËÆäÊõ¥‰∫ã‰ª∂
            if (playerCountSelect) {
                playerCountSelect.addEventListener('change', generatePlayerNameInputs);
            }
            
            // Â∞çÊà∞ÁµêÊùüÁ∏ΩÁµêÁ™óÂè£‰∫ã‰ª∂
            if (newBattleBtn) {
                newBattleBtn.addEventListener('click', startNewBattle);
            }
            
            if (exitBattleBtn) {
                exitBattleBtn.addEventListener('click', exitBattleMode);
            }

            if (battlePreviewClose) {
                battlePreviewClose.addEventListener('click', closeBattlePreviewModal);
            }

            if (battlePreviewBack) {
                battlePreviewBack.addEventListener('click', () => {
                    closeBattlePreviewModal();
                    openSettingsModal();
                });
            }

            if (battlePreviewStart) {
                battlePreviewStart.addEventListener('click', () => {
                    closeBattlePreviewModal();
                    confirmStartBattleMode();
                });
            }

            // ===== Êú¨Âú∞Â∞çÊà∞Ê®°ÊÖãÁ™óÂè£‰∫ã‰ª∂ =====
            const localBattleBtn = document.getElementById('localBattleBtn');
            const localBattleModal = document.getElementById('localBattleModal');
            const closeLocalBattleModal = document.getElementById('closeLocalBattleModal');
            const cancelLocalBattle = document.getElementById('cancelLocalBattle');
            const startLocalBattle = document.getElementById('startLocalBattle');
            const localPlayerCount = document.getElementById('localPlayerCount');

            // ÊâìÈñãÊú¨Âú∞Â∞çÊà∞Ê®°ÊÖãÁ™óÂè£
            if (localBattleBtn) {
                localBattleBtn.addEventListener('click', () => {
                    openLocalBattleModal();
                });
            }

            // ÈóúÈñâÊú¨Âú∞Â∞çÊà∞Ê®°ÊÖãÁ™óÂè£
            if (closeLocalBattleModal) {
                closeLocalBattleModal.addEventListener('click', closeLocalBattleModalFunc);
            }
            if (cancelLocalBattle) {
                cancelLocalBattle.addEventListener('click', closeLocalBattleModalFunc);
            }

            // ÈÅ∏ÊâãÊï∏ÈáèËÆäÊõ¥
            if (localPlayerCount) {
                localPlayerCount.addEventListener('change', generateLocalPlayerNameInputs);
            }

            // ÈñãÂßãÊú¨Âú∞Â∞çÊà∞
            if (startLocalBattle) {
                startLocalBattle.addEventListener('click', startLocalBattleGame);
            }
        }

        // ===== ÂàùÂßãÂåñÔºöÂæûÊú¨Âú∞Â≠òÂÑ≤ÊÅ¢Âæ©Ë®≠ÁΩÆËàáËá™ÂÆöÁæ©Ë©©Âè• =====
        function restoreFromLocalStorage() {
            const sRaw = loadSettings();
            const s = sRaw && typeof sRaw === 'object' ? sRaw : {};
            // Ë©©Ë©ûÂ∫´Ê®ôÁ±§‰∏ãÊãâ
            populateUserTagSelect();
            const tagSel = document.getElementById('userLibraryTagSelect');
            let active = loadActiveTag();
            if (active === 'Ëá™ÂÆöÁæ©Ë©©Âè•') active = 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´';
            if (tagSel) {
                if (active) {
                    const exists = Array.from(tagSel.options).some(o => o.value === active);
                    tagSel.value = exists ? active : (tagSel.options[0]?.value || '');
                }
                saveActiveTag(tagSel.value || '');
            }
            // ÊôÇÈñìÈôêÂà∂
            if (typeof s.timeLimit === 'number' && timeLimit && timeLimitValue) {
                timeLimit.value = String(s.timeLimit);
                timeLimitValue.textContent = String(s.timeLimit);
                roundTimeLimit = s.timeLimit;
            }
            // ÂæÖÈÅ∏Â≠óÊï∏Èáè
            if (typeof s.charCount === 'number' && charCount && charCountValue) {
                charCount.value = String(s.charCount);
                charCountValue.textContent = String(s.charCount);
                charactersPerRound = s.charCount;
            }
            // Èõ£Â∫¶
            if (difficultySelect && s.difficulty) {
                difficultySelect.value = s.difficulty;
            }
            // ËÅ≤Èü≥
            if (soundToggle) {
                window.soundEnabled = !!s.soundOn;
                const svg = soundToggle.querySelector('svg');
                if (svg) svg.style.opacity = window.soundEnabled ? '1' : '0.5';
            }
            // Â∞çÊà∞Ë®≠ÁΩÆ
            if (s.battle) {
                if (playerCountSelect) playerCountSelect.value = String(s.battle.playerCount || 2);
                if (roundsPerPlayerInput) roundsPerPlayerInput.value = String(Math.max(1, Math.min(50, s.battle.roundsPerPlayer || 5)));
                if (speedModeCheckbox) speedModeCheckbox.checked = !!s.battle.speedMode;
                generatePlayerNameInputs();
                if (Array.isArray(s.battle.playerNames)) {
                    s.battle.playerNames.forEach((name, i) => {
                        const input = document.getElementById(`player${i + 1}Name`);
                        if (input) input.value = name || `ÈÅ∏Êâã${i + 1}`;
                    });
                }
            }
            // Ëá™ÂÆöÁæ©Ë©©Âè•ÂäüËÉΩÂ∑≤ÁßªÈô§
            updateModalSections();
        }

        // Á¢∫‰øùDOMÂÆåÂÖ®Âä†ËºâÂæåÂàùÂßãÂåñÈÅäÊà≤
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initGame();
                setupSettingsEventListeners();
            });
        } else {
            initGame();
            setupSettingsEventListeners();
        }
    </script>
    
    <!-- ÈÅ†Á®ãÂ∞çÊà∞Ê®°ÊÖãÁ™óÂè£ -->
    <div id="remoteBattleModal" class="fixed inset-0 z-[60] hidden backdrop-blur-sm bg-surface-900/30 flex items-center justify-center animate-slide-up">
        <div class="glass-modal rounded-3xl shadow-2xl w-[min(680px,92vw)] max-h-[90vh] border border-white/20 animate-scale-in flex flex-col overflow-hidden">
            <!-- ÂΩàÁ™óÊ®ôÈ°å -->
            <div class="flex justify-between items-center px-5 py-4 border-b border-white/20 bg-gradient-to-r from-primary-500 to-accent-500 rounded-t-3xl flex-shrink-0">
                <h2 class="text-xl font-modern font-bold text-white">üåê ÈÅ†Á®ãÂ∞çÊà∞</h2>
                <button id="rbClose" class="text-white/80 hover:text-white text-2xl font-bold transform transition-transform hover:scale-110">&times;</button>
            </div>

            <!-- ÂÖßÂÆπÂçÄÂüü -->
            <div class="overflow-y-auto custom-scrollbar flex-grow p-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Â∑¶ÂÅ¥ÔºöÂª∫Á´ãÊàøÈñì -->
                    <div class="space-y-3">
                        <input id="rbNickname" type="text" class="glass-card rounded-lg px-3 py-2 border border-white/30 focus:ring-2 focus:ring-primary-500 text-sm font-modern w-full" placeholder="üë§ Ëº∏ÂÖ•‰Ω†ÁöÑÊö±Á®±">
                        
                        <button id="rbCreateBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-secondary-500 to-secondary-600 text-white font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">Âª∫Á´ãÊàøÈñì</button>

                        <!-- ÊàøÈñì‰ª£Á¢ºÈ°ØÁ§∫ -->
                        <div id="rbCreatedInfo" class="hidden glass-card rounded-xl p-3 border border-white/10">
                            <div class="text-xs font-modern text-surface-600 mb-2">ÊàøÈñì‰ª£Á¢º</div>
                            <div class="bg-gradient-to-br from-secondary-50 to-secondary-100 rounded-lg p-3 border border-secondary-300 text-center">
                                <span id="rbRoomCodeDisplay" class="font-mono font-bold text-3xl text-secondary-700" style="letter-spacing: 0.35em;"></span>
                            </div>
                        </div>

                        <!-- Êàø‰∏ªË®≠ÂÆö -->
                        <div id="rbHostSettings" class="hidden glass-card rounded-xl p-3 border border-white/10">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-modern text-surface-700 mb-1 block">ÈôêÊôÇÔºàÂàÜÈêòÔºâ</label>
                                    <input id="rbTimedMinutes" type="number" min="1" max="10" value="3" class="glass-card rounded-lg px-2 py-1.5 border border-white/30 focus:ring-2 focus:ring-primary-500 text-sm font-modern w-full">
                                </div>
                                <div>
                                    <label class="text-xs font-modern text-surface-700 mb-1 block">Ë©©Ë©ûÂ∫´</label>
                                    <select id="rbPoemTag" class="glass-card rounded-lg px-2 py-1.5 border border-white/30 focus:ring-2 focus:ring-primary-500 text-sm font-modern w-full"></select>
                                </div>
                            </div>
                            <button id="rbStartTimedBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-primary-500 to-accent-500 text-white font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">ÈñãÂßãÈôêÊôÇÁ´∂Ë≥Ω</button>
                        </div>
                    </div>

                    <!-- Âè≥ÂÅ¥ÔºöÂä†ÂÖ•ÊàøÈñì -->
                    <div class="space-y-3">
                        <input 
                            id="rbJoinCode" 
                            type="tel" 
                            inputmode="numeric" 
                            pattern="[0-9]{6}" 
                            class="glass-card rounded-lg px-3 py-2 border border-white/30 focus:ring-2 focus:ring-primary-500 text-center text-xl font-mono font-bold w-full" 
                            style="letter-spacing: 0.35em;"
                            placeholder="123456" 
                            maxlength="6"
                        >
                        <button id="rbJoinBtn" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-primary-500 to-accent-500 text-white font-modern font-semibold shadow-md modern-button transform transition-transform hover:scale-105">Âä†ÂÖ•ÊàøÈñì</button>

                        <!-- Âú®Á∑öÁé©ÂÆ∂ -->
                        <div class="glass-card rounded-xl p-3 border border-white/10">
                            <div class="text-xs font-modern text-surface-700 mb-2">Âú®Á∑öÁé©ÂÆ∂</div>
                            <div id="rbPresenceList" class="grid grid-cols-2 gap-2 min-h-[60px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ë™™ÊòéÂçÄÂüü -->
            <div class="border-t border-white/20 px-4 py-3 glass-card rounded-b-3xl flex-shrink-0">
                <p class="text-xs font-modern text-surface-700 leading-relaxed">
                    üí° Êàø‰∏ªÂª∫Á´ãÊàøÈñìÂæåË®≠ÁΩÆÁ´∂Ë≥ΩÊôÇÈï∑‰∏¶ÈñãÂßãÊØîË≥ΩÔºõÊâÄÊúâÁé©ÂÆ∂Âú®ÂêÑËá™Ë£ùÁΩÆÂêåÊ≠•‰ΩúÁ≠îÔºåÂàÜÊï∏Âç≥ÊôÇÊõ¥Êñ∞„ÄÇ
                </p>
            </div>
        </div>
    </div>

    <!-- ÈôêÊôÇÁ´∂Ë≥ΩÈñãË≥ΩÂâç 3 ÁßíÈ†êÂÇôÂÄíË®àÊôÇÁñäÂ±§ -->
    <div id="rbPrepOverlay" class="fixed inset-0 z-[70] hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/60"></div>
        <div class="relative z-[71] bg-white rounded-2xl border border-slate-200 shadow-2xl px-10 py-8 text-center">
            <div class="text-slate-500 text-sm mb-2">ÊØîË≥ΩÂç≥Â∞áÈñãÂßã</div>
            <div id="rbPrepNumber" class="text-6xl font-extrabold text-primary-500">3</div>
        </div>
    </div>

    <script>
    (function(){
        const sb = (window.ccAuth && window.ccAuth.getClient && window.ccAuth.getClient()) || window.sb;
        const state = {
            user: null,
            room: null,
            channel: null,
            dbChannel: null,
            roster: [],           // [{user_id, nickname, joined_at}]
            rosterUserIds: [],    // ËàáÈÅ†Á®ãÈôêÊôÇÊ®°ÂºèÂêåÊ≠•ÁöÑ user_id ÂàóË°®
            presenceMap: {},
            seenEids: {}          // ‰∫ã‰ª∂ÂéªÈáçÔºöeid -> 1
        };
        // „ÄêÈáçÊßã„Äë‰∏çÂÜçÊö¥Èú≤ __REMOTE_STATE__ÔºåÊâÄÊúâÊï∏ÊìöÁµ±‰∏ÄÂú® GameState ‰∏≠

        // Á¢∫‰øùÂåøÂêçÁôªÂÖ•
        async function ensureAnonLogin(){
            if (!sb || !sb.auth) throw new Error('Supabase client Êú™Â∞±Á∑í');
            const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('auth timeout')), ms));
            const getOrLogin = (async () => {
                const sess = await sb.auth.getSession();
                if (!sess.data.session) await sb.auth.signInAnonymously();
                const user = (await sb.auth.getUser()).data.user;
                return user;
            })();
            state.user = await Promise.race([getOrLogin, timeout(8000)]);
            if (!state.user) throw new Error('anonymous auth failed');
            console.log('[remote] auth user', state.user && state.user.id);
        }

        function genRoomCode(){
            // ÁîüÊàê6‰ΩçÁ∫ØÊï∞Â≠ó‰ª£Á†ÅÔºà100000-999999Ôºâ
            // ÈÅøÂÖçÂÖ®0„ÄÅÂÖ®Áõ∏ÂêåÁ≠âÁâπÊÆäÊÉÖÂÜµ
            let code;
            do {
                code = Math.floor(100000 + Math.random() * 900000).toString();
            } while (
                /^(.)\1{5}$/.test(code) || // ÈÅøÂÖçÂÖ®Áõ∏ÂêåÔºàÂ¶Ç111111Ôºâ
                code === '000000'           // ÈÅøÂÖçÂÖ®0
            );
            return code;
        }

        async function createRoom(name, nickname){
            await ensureAnonLogin();
            let room = null; let lastErr = null;
            for (let i=0;i<5;i++) {
                const code = genRoomCode();
                const { data, error } = await sb
                    .from('rooms')
                    .insert({ code, host_id: state.user.id, name })
                    .select()
                    .single();
                if (!error && data) { room = data; break; }
                lastErr = error;
                if (!(error && String(error.code) === '23505')) break; // ÂîØ‰∏ÄÈçµË°ùÁ™ÅÊâçÈáçË©¶
            }
            if (!room) throw lastErr || new Error('Âª∫Á´ãÊàøÈñìÂ§±Êïó');

            const { error: er2 } = await sb
                .from('room_players')
                .insert({ room_id: room.id, user_id: state.user.id, nickname: nickname || 'Áé©ÂÆ∂', is_host: true });
            if (er2) throw er2;

            await joinRealtime(room, nickname || 'Áé©ÂÆ∂');
            subscribeDbChanges(room.id);
            return room;
        }

        async function joinRoomByCode(code, nickname){
            await ensureAnonLogin();
            // Âè™‰øùÁïôÊï∞Â≠óÔºåÂéªÈô§ÂÖ∂‰ªñÂ≠óÁ¨¶
            code = String(code||'').trim().replace(/\D/g, '');
            if (code.length !== 6) {
                throw new Error('ÊàøÈñì‰ª£Á¢ºÂøÖÈ†àÊòØ6‰ΩçÊï∏Â≠ó');
            }
            const { data: room, error } = await sb.from('rooms').select('*').eq('code', code).single();
            if (error || !room) throw new Error('Êâæ‰∏çÂà∞ÊàøÈñì');

            await sb.from('room_players').upsert({
                room_id: room.id, user_id: state.user.id, nickname: nickname || 'Áé©ÂÆ∂', is_host: room.host_id === state.user.id
            });

            await joinRealtime(room, nickname || 'Áé©ÂÆ∂');
            subscribeDbChanges(room.id);
            return room;
        }

        async function joinRealtime(room, nickname){
            state.room = room;
            if (state.channel) { try { await state.channel.unsubscribe(); } catch(_){} }
            const channel = sb.channel(`room:${room.code}`, { 
                config: { 
                    presence: { key: state.user.id },
                    broadcast: { self: true, ack: false }  // self: true Áî®ÊñºË™øË©¶ÔºàÁôºÈÄÅËÄÖ‰πüËÉΩÁúãÂà∞Ëá™Â∑±ÁöÑÊ∂àÊÅØÔºâ
                } 
            });

            channel.on('presence', { event: 'sync' }, () => {
                const st = channel.presenceState();
                state.presenceMap = st || {};
                renderPresence(st);
            });

            channel.on('broadcast', { event: 'move' }, (msg) => {
                console.log('[remote] broadcast received in channel.on, payload:', msg?.payload);
                handleIncomingMove(msg?.payload);
            });

            await channel.subscribe((status) => {
                console.log('[remote] channel subscription status:', status);
                if (status === 'SUBSCRIBED') {
                    console.log('[remote] channel SUBSCRIBED, tracking presence');
                    channel.track({ nickname });
                }
            });

            state.channel = channel;
            console.log('[remote] channel set to state, state:', channel.state);
            await refreshRoster();
        }

        function subscribeDbChanges(room_id){
            if (state.dbChannel) { try { state.dbChannel.unsubscribe(); } catch(_){} }
            const ch = sb.channel('db:'+room_id)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'room_events', filter: `room_id=eq.${room_id}` }, (c)=>{
                    handleIncomingMove({ type: c.new.event_type, payload: c.new.payload, fromDb: true, from: c.new.user_id, ts: Date.now(), eid: c.new.eid });
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${room_id}` }, (c)=>{
                    handleRoomUpdate(c.new);
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'room_players', filter: `room_id=eq.${room_id}` }, async ()=>{
                    await refreshRoster();
                })
                .subscribe();
            state.dbChannel = ch;
        }

        async function refreshRoster(){
            if (!state.room) return;
            const { data, error } = await sb
                .from('room_players')
                .select('user_id, nickname, joined_at')
                .eq('room_id', state.room.id)
                .order('joined_at', { ascending: true });
            let roster = (!error && Array.isArray(data)) ? data : [];
            if (!roster || roster.length === 0) {
                // fallback to presence
                const presence = state.presenceMap || {};
                roster = Object.keys(presence).map(uid => {
                    const meta = (presence[uid] && presence[uid][0]) || {};
                    return { user_id: uid, nickname: meta.nickname || 'Áé©ÂÆ∂', joined_at: null };
                });
            }
            state.roster = Array.isArray(roster) ? roster.filter(Boolean) : [];
            // Êõ¥Êñ∞Âú®Á∑öÊ∏ÖÂñÆÁöÑÈ°ØÁ§∫
            const list = document.getElementById('rbPresenceList');
            if (list) {
                list.innerHTML = '';
                state.roster.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'px-3 py-2 rounded-lg border bg-white text-sm';
                    div.textContent = (p && p.nickname) ? p.nickname : 'Áé©ÂÆ∂';
                    list.appendChild(div);
                });
            }
        }

        function genEid(){
            try { return `${state.user?.id||'u'}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`; } catch(_) { return `${Date.now()}-${Math.random()}`; }
        }

        async function sendGameEvent(type, payload){
            if (!state.room || !state.channel) {
                console.error('[remote] sendGameEvent failed: no room or channel');
                return;
            }
            
                // console.log(`[remote] sendGameEvent preparing to send: ${type}, channel state:`, state.channel.state); // Â∑≤Á∞°Âåñ
            const out = { type, payload, ts: Date.now(), from: state.user?.id, eid: genEid() };
            
            // Á¢∫‰øù channel Â∑≤ÈÄ£Êé•
            if (state.channel.state !== 'joined') {
                console.warn(`[remote] channel not joined (state: ${state.channel.state}), waiting...`);
                await new Promise(resolve => setTimeout(resolve, 500)); // Á≠âÂæÖ 500ms
                if (state.channel.state !== 'joined') {
                    console.error(`[remote] channel still not joined after wait (state: ${state.channel.state})`);
                }
            }
            
            // ÈÄöÈÅé Realtime channel Âª£Êí≠‰∫ã‰ª∂
            try {
                // console.log(`[remote] calling channel.send for: ${type}, channel state:`, state.channel.state); // Â∑≤Á∞°Âåñ
                const result = await state.channel.send({ type: 'broadcast', event: 'move', payload: out });
                console.log(`[remote] broadcast sent successfully: ${type}`, result);
            } catch (e) {
                console.error(`[remote] broadcast error for ${type}:`, e);
                throw e; // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®ËÄÖÁü•ÈÅìÂ§±Ë¥•‰∫Ü
            }
            
            // Êï∏ÊìöÂ∫´Ë®òÈåÑÔºàÂèØÈÅ∏ÔºåÂ§±Êïó‰∏çÂΩ±ÈüøÈÅäÊà≤Ôºâ
            try {
                await sb.from('room_events').insert({ 
                    room_id: state.room.id, 
                    user_id: state.user.id, 
                    event_type: type, 
                    payload, 
                    eid: out.eid 
                });
                console.log(`[remote] db record saved for: ${type}`);
            } catch (e) {
                console.warn(`[remote] db insert failed (non-critical) for ${type}:`, e.message);
            }
        }

        function handleIncomingMove(msg){
            if (!msg) {
                console.warn('[remote] handleIncomingMove: empty message');
                return;
            }
            console.log('[remote] handleIncomingMove received:', msg.type, 'from:', msg.from, 'my id:', state.user?.id);
            
            // Êö´ÊôÇÂÖÅË®±ËôïÁêÜËá™Â∑±ÁöÑÊ∂àÊÅØÔºàÁî®ÊñºË™øË©¶Ôºâ
            const isOwnMessage = msg.from && state.user && msg.from === state.user.id;
            if (isOwnMessage) {
                console.log('[remote] received own message (allowing for debug)');
            }
            
            try {
                // ‰∫ã‰ª∂ÂéªÈáçÔºöËã•Â∑≤ÊúâÁõ∏Âêå eid ÂâáÂøΩÁï•
                if (msg.eid) {
                    if (state.seenEids[msg.eid]) return;
                    state.seenEids[msg.eid] = 1;
                }
                // ÈÅ†Á®ãÈôêÊôÇÊ®°ÂºèÔºöÂö¥Ê†ºÁôΩÂêçÂñÆÂÉÖÂÖÅË®± timed_start/score_update/timed_end
                if (state && state.timedMode === true) {
                    const allowed = { timed_start:1, score_update:1, timed_end:1 };
                    if (!allowed[msg.type]) {
                        // ÂøΩÁï•‰ªª‰ΩïËº™ÊµÅ/ÈÖçÁΩÆÈ°û‰∫ã‰ª∂ÔºåÈÅøÂÖç‰∏≤Âè∞
                        return;
                    }
                }
                switch (msg.type) {
                    case 'timed_start':
                        // Êé•Êî∂ÈôêÊôÇÈñãÂßãÔºöÂàùÂßãÂåñ GameState
                        console.log('[remote] timed_start received, payload=', msg.payload);
                        
                        // „ÄêÈáçÊßã„ÄëÁõ¥Êé•ÂàùÂßãÂåñ GameState
                        window.GameState.mode = 'remote';
                        window.GameState.subMode = 'timed_score';
                        window.GameState.isActive = true;
                        window.GameState.timed.endsAt = msg.payload?.endsAt || (Date.now() + (msg.payload?.mins || 3) * 60000);
                        window.GameState.timed.duration = msg.payload?.mins || 3;
                        window.GameState.remote.currentUserId = state.user?.id || null;
                        
                        // ÂàùÂßãÂåñÁé©ÂÆ∂Êï∏Êìö
                        if (Array.isArray(msg.payload?.players) && msg.payload?.emojiMap) {
                            window.GameState.players = msg.payload.players.map((p, idx) => ({
                                uid: p.id || state.rosterUserIds?.[idx] || null,
                                name: p.name || ('Áé©ÂÆ∂' + (idx + 1)),
                                emoji: msg.payload.emojiMap[p.id || state.rosterUserIds?.[idx]] || 'üèÉ',
                                score: 0,
                                answered: 0,
                                correct: 0,
                                lastAnswerTs: 0,
                                isReady: true,
                                isActive: false
                            }));
                            console.log('[remote] receiver GameState.players initialized:', window.GameState.players.map(p => ({ name: p.name, emoji: p.emoji })));
                        } else {
                            console.warn('[remote] receiver failed to initialize players - missing data:', { 
                                hasPlayers: Array.isArray(msg.payload?.players), 
                                hasEmojiMap: !!msg.payload?.emojiMap,
                                payload: msg.payload 
                            });
                        }
                        console.log('[remote] receiver GameState:', { mode: window.GameState.mode, subMode: window.GameState.subMode, isActive: window.GameState.isActive, playersCount: window.GameState.players?.length || 0 });
                        
                        // ËàäÁ≥ªÁµ±ÂêåÊ≠•ÔºàÂêëÂæåÂÖºÂÆπÔºâ
                        // „ÄêÈáçÊßã„Äë‰∏çÂÜçË®≠ÁΩÆ __REMOTE_TIMED__ÔºåÊîπÁî® GameState.isActive Âà§Êñ∑
                        state.timedMode = true;
                        state.timedEndsAt = window.GameState.timed.endsAt;
                        if (msg.payload?.emojiMap) state.emojiMap = msg.payload.emojiMap;
                        if (Array.isArray(msg.payload?.players)) {
                            applyBattleConfig({ players: msg.payload.players, roundsPerPlayer: 1 });
                        }
                        
                        // ÂêåÊ≠•Ë©©Ë©ûÂ∫´
                        if (msg.payload?.tag) {
                            try {
                                const tagSel = document.getElementById('userLibraryTagSelect');
                                if (tagSel) { tagSel.value = msg.payload.tag; saveActiveTag(msg.payload.tag); }
                            } catch(_){}
                        }
                        
                        showPrepCountdown(Math.max(1000, msg.payload?.prepMs || 3000), () => {
                            console.log('[remote] receiver entering game, GameMode.isTimedScore()=', window.GameMode.isTimedScore(), 'GameMode.isAnyBattle()=', window.GameMode.isAnyBattle());
                            beginTimedTicker();
                            try { document.getElementById('remoteBattleModal')?.classList.add('hidden'); } catch(_){ }
                            // È°ØÁ§∫Ë®òÂàÜÊùøÔºàÂÖàÊñºUIÊ∏≤ÊüìÔºâ
                            try { 
                                const board = document.getElementById('battleScoreboard');
                                if (board) board.classList.remove('hidden');
                            } catch(_){}
                            // Ëß∏ÁôºË≥ΩÈÅìÂíåË®òÂàÜÊùøÊ∏≤ÊüìÔºàÂú®startNewRound‰πãÂâçÔºâ
                            try {
                                console.log('[remote] receiver starting game, rendering UI');
                                window.RaceTrack?.render();
                                window.LocalBattle?.updateScoreboard();
                                console.log('[remote] receiver UI rendered, players count:', window.GameState.players?.length || 0);
                            } catch(e){ console.error('[remote] receiver UI initialization error:', e); }
                            // ÊúÄÂæåÈñãÂßã‰ΩúÁ≠î
                            if (typeof window.startNewRound === 'function') window.startNewRound();
                        });
                        break;
                    case 'timed_end':
                        state.timedMode = false;
                        window.GameState.isActive = false; // „ÄêÈáçÊßã„ÄëÊîπÁî® GameState
                        try { clearInterval(state.timedTimer); } catch(_){}
                        // È°ØÁ§∫ÈÅ†Á®ãÈôêÊôÇÂ∞àÂ±¨ÊéíË°åÊ¶ú
                        if (typeof showBattleResultModal === 'function') showBattleResultModal();
                        break;
                    case 'score_update':
                        try {
                            const p = msg.payload || {};
                            const uid = p.userId;
                            if (!uid) break;
                            
                            // „Äê‰øÆÂæ©„ÄëÊâÄÊúâÂÆ¢Êà∂Á´ØÁµ±‰∏ÄÈÄöÈÅéÊ≠§ËôïÊõ¥Êñ∞ÂàÜÊï∏ÔºàÂåÖÊã¨ÁôºÈÄÅËÄÖËá™Â∑±Ôºâ
                            // „ÄêÈáçÊßã„ÄëÁõ¥Êé•Êõ¥Êñ∞ GameState
                            const player = window.GameState.players.find(pl => pl.uid === uid);
                            if (player) {
                                player.score += Number(p.delta || 0);
                                player.answered += Number(p.answeredInc || 0);
                                player.correct += Number(p.correctInc || 0);
                                player.lastAnswerTs = Date.now();
                            }
                            
                            // ÂêåÊ≠•Âà∞ËàäÁ≥ªÁµ±ÔºàÂêëÂæåÂÖºÂÆπÔºâ
                            state.stats[uid] = state.stats[uid] || { score:0, answered:0, correct:0, nickname:'' };
                            const s = state.stats[uid];
                            s.score += Number(p.delta || 0);
                            s.answered += Number(p.answeredInc || 0);
                            s.correct += Number(p.correctInc || 0);
                            s.lastTs = Date.now();
                            
                            // Ëß∏Áôº UI Êõ¥Êñ∞
                            try {
                                window.LocalBattle?.updateScoreboard();
                                window.RaceTrack?.render();
                            } catch(e){ console.error('[remote] UI update error:', e); }
                        } catch(e){ console.error('[remote] score_update error:', e); }
                        break;
                    default:
                        console.log('[remote] unhandled move', msg);
                }
            } catch (e) {
                console.warn('[remote] handleIncomingMove error', e);
            }
        }

        function handleRoomUpdate(room){
            // ÂèØÈÅ∏ÔºöÊ†πÊìöÊàø‰∏ªÊõ¥Êñ∞ÂêåÊ≠• UI
            console.log('[remote] room update', room);
        }

        function applyBattleConfig(conf){
            try {
                if (!conf) return;
                
                // „ÄêÈáçÊßã„Äë‰∏çÂÜç‰ΩøÁî® battleModeÔºåÁõ¥Êé•ÂàùÂßãÂåñ state.stats Áî®ÊñºÈÅ†Á®ãÂ∞çÊà∞
                const players = (conf.players || []).filter(Boolean);
                const names = players.map(p => (typeof p === 'string' ? p : ((p && p.name) || 'Áé©ÂÆ∂')));
                const ids = players.map(p => (typeof p === 'string' ? null : ((p && p.id) || null)));
                
                state.rosterUserIds = ids;
                state.stats = state.stats || {};
                
                // ÂàùÂßãÂåñÁµ±Ë®àÊï∏Êìö
                (ids || []).forEach((uid, i) => {
                    if (!uid) return;
                    state.stats[uid] = state.stats[uid] || { score:0, answered:0, correct:0, nickname:'', lastTs:0 };
                    state.stats[uid].nickname = names[i] || state.stats[uid].nickname || 'Áé©ÂÆ∂';
                });
                
                // ÈÅ†Á®ãÈôêÊôÇÊ®°Âºè‰∏ç‰ΩøÁî®Á©çÂàÜÊùøÔºà‰ΩøÁî®Ë≥ΩÈÅìÈ°ØÁ§∫ÔºâÔºåÊâÄ‰ª•‰∏çÈ°ØÁ§∫
                // ÈÅ†Á®ãËº™ÊµÅÊ®°ÂºèÂ∑≤ÁßªÈô§Ôºå‰∏çÂÜçÈúÄË¶Å turnUserId Âíå updateSubmitGate
            } catch (e) {
                console.warn('[remote] applyBattleConfig error', e);
            }
        }

        function renderPresence(presenceState){
            const list = document.getElementById('rbPresenceList');
            if (!list) return;
            list.innerHTML = '';
            const users = [];
            Object.keys(presenceState || {}).forEach(uid => {
                (presenceState[uid] || []).forEach(meta => users.push(meta.nickname || 'Áé©ÂÆ∂'));
            });
            users.forEach(name => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 rounded-lg border bg-white text-sm';
                div.textContent = name;
                list.appendChild(div);
            });
        }

        // Â°´ÂÖÖÊàø‰∏ªÂèØÈÅ∏ÁöÑË©©Ë©ûÂ∫´Ê®ôÁ±§ÔºàÂæû‰∏ªË®≠ÁΩÆÁöÑ userLibraryTagSelect Ë§áË£ΩÔºâ
        window.populatePoemTags = function(){
            try {
                const dst = document.getElementById('rbPoemTag');
                if (!dst) return;
                dst.innerHTML = '';
                const src = document.getElementById('userLibraryTagSelect');
                let filled = false;
                if (src && src.options && src.options.length) {
                    Array.from(src.options).forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt.value;
                        o.textContent = opt.textContent || opt.value;
                        dst.appendChild(o);
                    });
                    filled = true;
                }
                if (!filled) {
                    // ÂæåÂÇôÔºöÁµ¶Âá∫‰∏ÄÂÄãÂ∏∏Áî®È†êË®≠
                    const o = document.createElement('option');
                    o.value = 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´';
                    o.textContent = 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´';
                    dst.appendChild(o);
                }
                // È†êË®≠ÈÅ∏‰∏≠Áï∂ÂâçÂïüÁî®Ê®ôÁ±§
                try {
                    const active = (typeof loadActiveTag === 'function') ? (loadActiveTag() || 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´') : 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´';
                    const has = Array.from(dst.options).some(op => op.value === active);
                    dst.value = has ? active : (dst.options[0]?.value || 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´');
                } catch(_){}
            } catch(_){}
        }

        // Â∞ÅË£ùÂà∞ÂÖ®ÂüüÔºå‰æõÂæåÁ∫åÈÅäÊà≤ÊµÅÁ®ãË™øÁî®
        window.RemoteBattle = {
            get user(){ return state.user; },
            get room(){ return state.room; },
            get channel(){ return state.channel; },
            isHost(){ return !!(state.room && state.user && state.room.host_id === state.user.id); },
            ensureAnonLogin,
            createRoom,
            joinRoomByCode,
            sendGameEvent
        };

        // ====== UI Á∂ÅÂÆö ======
        function $(id){ return document.getElementById(id); }
        const btn = $('remoteBattleBtn');
        const modal = $('remoteBattleModal');
        const closeBtn = $('rbClose');
        const nicknameInput = $('rbNickname');
        const createBtn = $('rbCreateBtn');
        const createdInfo = $('rbCreatedInfo');
        const codeDisplay = $('rbRoomCodeDisplay');
        const joinCodeInput = $('rbJoinCode');
        const joinBtn = $('rbJoinBtn');
        const hostSettings = document.getElementById('rbHostSettings');
        const timedMinInput = document.getElementById('rbTimedMinutes');
        const startTimedBtn = document.getElementById('rbStartTimedBtn');
        const poemTagSelect = document.getElementById('rbPoemTag');

        function openModal(){
            if (modal) {
                modal.classList.remove('hidden');
                // ÊâìÈñãÈÅ†Á®ãÊ®°ÊÖãÊôÇÊö´ÂÅúÂñÆ‰∫∫Ê®°ÂºèÔºåÈÅøÂÖçËÉåÊôØËá™ÂãïÈÅãË°å
                try { clearInterval(timerInterval); } catch(_){}
                isGameActive = false;
            }
        }
        function closeModal(){ 
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        btn?.addEventListener('click', openModal);
        closeBtn?.addEventListener('click', closeModal);

        // ËæìÂÖ•Ê°ÜÂÆûÊó∂È™åËØÅÔºàÂè™ÂÖÅËÆ∏Êï∞Â≠óÔºå‰∏çÊ∑ªÂä†Á©∫Ê†ºÔºâ
        if (joinCodeInput) {
            joinCodeInput.addEventListener('input', (e) => {
                // Âè™‰øùÁïôÊï∞Â≠ó
                let value = e.target.value.replace(/\D/g, '');
                
                // ÈôêÂà∂6‰Ωç
                if (value.length > 6) {
                    value = value.slice(0, 6);
                }
                
                // Áõ¥Êé•ÊòæÁ§∫Êï∞Â≠óÔºå‰∏çÊ∑ªÂä†Á©∫Ê†º
                e.target.value = value;
            });
        }

        createBtn?.addEventListener('click', async () => {
            try {
                console.log('[remote] create clicked');
                if (!sb) { alert('Supabase Êú™Â∞±Á∑í'); return; }
                const nickname = (nicknameInput?.value || '').trim() || 'Áé©ÂÆ∂';
                if (createBtn) { createBtn.disabled = true; createBtn.textContent = 'Âª∫Á´ã‰∏≠‚Ä¶'; }
                const room = await createRoom('', nickname);
                console.log('[remote] room created', room && room.code);
                
                // ÊòæÁ§∫‰ª£Á†ÅÔºà‰∏çÊ∑ªÂä†Á©∫Ê†ºÔºåÈÄöËøáCSSÁöÑletter-spacingÂÆûÁé∞ËßÜËßâÈó¥Ë∑ùÔºâ
                if (codeDisplay) {
                    codeDisplay.textContent = room.code;
                }
                
                createdInfo?.classList.remove('hidden');
                if (window.RemoteBattle?.isHost()) {
                    hostSettings?.classList.remove('hidden');
                    populatePoemTags();
                }
                if (createBtn) { createBtn.textContent = 'Â∑≤Âª∫Á´ã'; setTimeout(()=>{ createBtn.disabled = false; createBtn.textContent = 'Âª∫Á´ãÊàøÈñì'; }, 1200); }
            } catch (e) {
                console.warn('[remote] create error', e);
                if (createBtn) { createBtn.disabled = false; createBtn.textContent = 'Âª∫Á´ãÊàøÈñì'; }
                alert('Âª∫Á´ãÂ§±ÊïóÔºö' + (e?.message || e));
            }
        });

        joinBtn?.addEventListener('click', async () => {
            try {
                console.log('[remote] join clicked');
                const nickname = (nicknameInput?.value || '').trim() || 'Áé©ÂÆ∂';
                const code = (joinCodeInput?.value || '').trim();
                const room = await joinRoomByCode(code, nickname);
                console.log('[remote] joined room', room && room.code);
                if (codeDisplay) codeDisplay.textContent = room.code;
                createdInfo?.classList.remove('hidden');
                hostSettings?.classList.add('hidden');
            } catch (e) {
                console.warn('[remote] join error', e);
                alert('Âä†ÂÖ•Â§±ÊïóÔºö' + (e?.message || e));
            }
        });

        // ÈÅ†Á®ãËº™ÊµÅÊ®°ÂºèÂ∑≤ÁßªÈô§ÔºåÂÉÖ‰øùÁïôÈÅ†Á®ãÈôêÊôÇÊ®°Âºè
        
        try {

        // ===== ÈôêÊôÇÁ´∂Ë≥ΩÔºöÈñãÂßã„ÄÅË®àÊôÇËàáÁµêÁÆó =====
        state.timedMode = false;
        state.timedEndsAt = 0;
        state.timedTimer = null;
        state.stats = {}; // userId -> { score, answered, correct, nickname, lastTs }

        startTimedBtn?.addEventListener('click', async () => {
            try {
                console.log('[remote] startTimed clicked');
                if (!window.RemoteBattle?.isHost()) { alert('ÂÉÖÊàø‰∏ªÂèØÈñãÂßã'); return; }
                await refreshRoster();
                const roster = state.roster || [];
                if (roster.length === 0) { alert('Â∞öÁÑ°Áé©ÂÆ∂Âä†ÂÖ•'); return; }
                const mins = Math.max(1, Math.min(10, parseInt((timedMinInput?.value || '3'), 10)));
                const endsAt = Date.now() + mins * 60 * 1000;
                // Âª∫Á´ãÂ∞çÊà∞ÊùøÔºàÁé©ÂÆ∂ÂêçÂñÆÔºâÔºå‰ΩÜ‰∏çÈñãÂïüËº™ÊµÅÈôêÂà∂
                const activeTag = (poemTagSelect?.value || loadActiveTag() || 'ÂçóÈ¢®Ë©©Ë©ûÂ∫´');
                const conf = { players: roster.map(p => ({ id: p.user_id, name: p.nickname || 'Áé©ÂÆ∂' })), roundsPerPlayer: 1 };
                // „ÄêÈáçÊßã„ÄëÊ®ôË®òÈÅ†Á®ãÈôêÊôÇÊ®°ÂºèÔºàÊîπÁî® GameStateÔºâ
                // window.__REMOTE_TIMED__ = true; // Â∑≤ÁßªÈô§
                state.timedMode = true;
                state.timedEndsAt = endsAt;
                
                // „ÄêÈáçÊßã„Äë‰∏ªÊ©üÁ´Ø‰πüÈúÄË¶ÅÂàùÂßãÂåñ GameStateÔºàËàáÊé•Êî∂Êñπ‰øùÊåÅ‰∏ÄËá¥Ôºâ
                window.GameState.mode = 'remote';
                window.GameState.subMode = 'timed_score';
                window.GameState.isActive = true;
                window.GameState.timed.endsAt = endsAt;
                window.GameState.timed.duration = mins;
                window.GameState.remote.currentUserId = state.user?.id || null;
                window.GameState.remote.isHost = true;
                
                // ÂàùÂßãÂåñÁé©ÂÆ∂Êï∏ÊìöÔºàÂú®ÁîüÊàê emojiMap ‰πãÂâçÔºâ
                applyBattleConfig(conf);
                // ‰øùÈö™ÔºöÊ∏ÖÁêÜ‰ªª‰ΩïÂñÆÈ°åË®àÊôÇËàáÊú¨Âú∞ÂõûÂêàÁãÄÊÖã
                try { clearInterval(timerInterval); } catch(_){ }
                try { timerInterval = null; } catch(_){ }
                try { isGameActive = false; } catch(_){ }
                try { if (typeof hideResultModal === 'function') hideResultModal(); } catch(_){ }
                try { gameMessage?.classList.add('hidden'); } catch(_){ }
                try { if (timeBarFill) timeBarFill.style.width = '0%'; } catch(_){ }
                // Âª£Êí≠ÂåÖÂê´ players + emoji ÂàÜÈÖçÔºå‰∏¶ÈôÑÂ∏∂ 3 ÁßíÈ†êÂÇô
                const userIds = roster.map(p => p.user_id);
                const emojiMap = window.RaceTrack.buildEmojiMap(userIds, state.room?.code || 'ROOM');
                state.emojiMap = emojiMap; // ‰øùÂ≠òÂà∞ state
                console.log('[remote] host generated emojiMap:', emojiMap);
                // console.log('[remote] host emojiMap details:', Object.keys(emojiMap).map(k => `${k}: ${emojiMap[k]}`)); // Â∑≤ÈóúÈñâË™øË©¶Êó•Âøó
                
                // „ÄêÈáçÊßã„Äë‰∏ªÊ©üÁ´ØÂ°´ÂÖÖ GameState.playersÔºàËàáÊé•Êî∂Êñπ‰øùÊåÅ‰∏ÄËá¥Ôºâ
                window.GameState.players = conf.players.map((p, idx) => ({
                    uid: p.id || userIds[idx] || null,
                    name: p.name || ('Áé©ÂÆ∂' + (idx + 1)),
                    emoji: emojiMap[p.id || userIds[idx]] || 'üèÉ',
                    score: 0,
                    answered: 0,
                    correct: 0,
                    lastAnswerTs: 0,
                    isReady: true,
                    isActive: false
                }));
                
                // È°ØÁ§∫Ë®òÂàÜÊùø
                try { 
                    const board = document.getElementById('battleScoreboard');
                    if (board) board.classList.remove('hidden');
                } catch(_){}
                
                console.log('[remote] host GameState initialized:', {
                    mode: window.GameState.mode,
                    subMode: window.GameState.subMode, 
                    players: window.GameState.players.length
                });
                
                // ÁôºÈÄÅÈÅäÊà≤ÈñãÂßã‰∫ã‰ª∂‰∏¶Á≠âÂæÖÂÆåÊàê
                await window.RemoteBattle.sendGameEvent('timed_start', { endsAt, mins, players: conf.players, prepMs: 3000, tag: activeTag, emojiMap });
                console.log('[remote] timed_start event sent');
                
                showPrepCountdown(3000, () => {
                    console.log('[remote] host entering game, GameMode.isTimedScore()=', window.GameMode.isTimedScore(), 'GameMode.isAnyBattle()=', window.GameMode.isAnyBattle());
                    beginTimedTicker();
                    // ÈóúÈñâÈÅ†Á®ãÊ®°ÊÖã
                    try { document.getElementById('remoteBattleModal')?.classList.add('hidden'); } catch(_){ }
                    // Ëß∏ÁôºË≥ΩÈÅìÂíåË®òÂàÜÊùøÊ∏≤Êüì
                    try {
                        console.log('[remote] host starting game, rendering UI');
                        window.RaceTrack?.render();
                        window.LocalBattle?.updateScoreboard();
                    } catch(e){ console.error('[remote] host UI initialization error:', e); }
                    // Á´ãÂç≥ÈñãÂßã‰ΩúÁ≠î
                    if (typeof window.startNewRound === 'function') window.startNewRound();
                });
            } catch (e) {
                alert('ÁÑ°Ê≥ïÈñãÂßãÈôêÊôÇÁ´∂Ë≥ΩÔºö' + (e?.message || e));
            }
        });

        // ‰∫ã‰ª∂‰ª£ÁêÜ‰øùÈö™ÔºàÈÅøÂÖçÊåâÈàïË¢´ÈáçÂª∫Â∞éËá¥Áõ£ËÅΩ‰∏üÂ§±Ôºâ
        document.getElementById('remoteBattleModal')?.addEventListener('click', function(ev){
            const t = ev.target;
            if (!t) return;
            if (t.id === 'rbStartTimedBtn' || t.closest?.('#rbStartTimedBtn')) {
                ev.preventDefault();
                try { startTimedBtn?.click(); } catch(_) {}
            }
        }, true);

        function beginTimedTicker(){
            try { clearInterval(state.timedTimer); } catch(_){}
            updateTimedUI();
            // ÈôêÊôÇÊ®°ÂºèÔºöÈ°ØÁ§∫Ë≥ΩÈÅìÂÆπÂô®„ÄÅÈö±ËóèÊôÇÈñìÂ°´ÂÖÖÊ¢ù
            try { if (timeBarContainer) timeBarContainer.style.display = ''; } catch(_){ }
            try { if (timeBarFill) timeBarFill.style.display = 'none'; } catch(_){ }
            state.timedTimer = setInterval(() => {
                updateTimedUI();
                // ÈÄ±ÊúüÊÄßÈáçÁπ™Ë®òÂàÜÊùøËàáË≥ΩÈÅìÔºåÁ¢∫‰øùÊú™Êèê‰∫§Á´Ø‰πüËÉΩÂç≥ÊôÇÁúãÂà∞‰ªñ‰∫∫ÂàÜÊï∏ËÆäÂåñ
                try { if (typeof window.LocalBattle?.updateScoreboard === 'function') window.LocalBattle.updateScoreboard(); } catch(_){ }
                try { window.RaceTrack && window.RaceTrack.ensureEmojis && window.RaceTrack.ensureEmojis(); } catch(_){ }
                try { window.RaceTrack && window.RaceTrack.render && window.RaceTrack.render(); } catch(_){ }
                if (!state.timedMode) { clearInterval(state.timedTimer); return; }
                if (Date.now() >= state.timedEndsAt) {
                    clearInterval(state.timedTimer);
                    state.timedMode = false;
                    window.GameState.isActive = false; // „ÄêÈáçÊßã„ÄëÊîπÁî® GameState
                    window.RemoteBattle.sendGameEvent('timed_end', {});
                    showBattleResultModal && showBattleResultModal();
                }
            }, 1000);
        }

        function updateTimedUI(){
            const remainMs = Math.max(0, state.timedEndsAt - Date.now());
            const remainSec = Math.ceil(remainMs / 1000);
            const timer = document.getElementById('timer');
            if (timer && state.timedMode) timer.textContent = String(remainSec);
        }

        function showPrepCountdown(ms, onDone){
            const overlay = document.getElementById('rbPrepOverlay');
            const num = document.getElementById('rbPrepNumber');
            if (!overlay || !num) { if (onDone) onDone(); return; }
            overlay.classList.remove('hidden');
            let remain = Math.max(1, Math.round(ms/1000));
            num.textContent = String(remain);
            const iv = setInterval(() => {
                remain -= 1;
                if (remain <= 0) {
                    clearInterval(iv);
                    overlay.classList.add('hidden');
                    if (onDone) onDone();
                } else {
                    num.textContent = String(remain);
                }
            }, 1000);
        }
        } catch (e) { console.warn('[remote] error', e); }
    })();
    </script>
    
</body>
</html>
