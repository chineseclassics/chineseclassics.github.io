<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·å¹²è¡Œæ™‚å…‰æ‹¼åœ–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#5D5CDE', // ä¸»è‰²
                            700: '#4542b9',
                            800: '#393796',
                            900: '#312f79',
                            950: '#1e1c47'
                        },
                        emotion: {
                            joy: '#FFD166',
                            sorrow: '#4E8098',
                            love: '#EF767A',
                            longing: '#9381FF',
                            hope: '#78C091'
                        }
                    },
                    fontFamily: {
                        'sans': ['LXGW WenKai Screen TC', 'sans-serif'],
                        'serif': ['LXGW WenKai TC', 'serif'],
                        'cursive': ['LXGW WenKai TC', 'cursive']
                    },
                    boxShadow: {
                        'elegant': '0 4px 10px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1)',
                        'hover': '0 10px 20px rgba(93, 92, 222, 0.1), 0 6px 6px rgba(93, 92, 222, 0.06)',
                        'btn': '0 4px 6px rgba(93, 92, 222, 0.1), 0 1px 3px rgba(93, 92, 222, 0.08)'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        /* ä½¿ç”¨preloadé˜²æ­¢å­—ä½“æ–‡ä»¶é˜»å¡æ¸²æŸ“ */
        @import url('https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css');
@import url('https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-tc-webfont@1.0.0/style.css');
        
        /* å­—ä½“fallbackä»¥æé«˜æ€§èƒ½å’Œå¯é æ€§ */
        :root {
            --font-poem: 'LXGW WenKai TC', serif;
            --font-sans: 'LXGW WenKai Screen TC', sans-serif;
            --font-serif: 'LXGW WenKai TC', serif;
            --font-title: 'LXGW WenKai TC', serif;
            --font-subtitle: 'LXGW WenKai TC', serif;
            --font-content: 'LXGW WenKai TC', serif;
        }
        
        /* å­—ä½“å¤§å°å“åº”å¼è®¾ç½® */
        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        @media (max-width: 767px) {
            html {
                font-size: 15px;
            }
        }
        
        /* ç»Ÿä¸€è‡ªå®šä¹‰å­—ä½“ç±»ï¼Œç¡®ä¿ä¸€è‡´æ€§ */
        .font-standard {
            font-family: var(--font-serif);
        }
        
        .font-serif {
            font-family: var(--font-serif);
        }
        
        .font-poem {
            font-family: var(--font-serif);
            font-weight: 500;
            letter-spacing: 0.02em;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-serif);
            background-color: #f5f2ea; /* æ·¡é›…çš„ç±³è‰²èƒŒæ™¯ */
            min-height: 100dvh;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        /* é’æ¢…åœ–æ¨™ SVG */
        .plum-icon {
            width: 28px;
            height: 28px;
            fill: #9BBF8A;
            opacity: 0.8;
            margin: 0 8px;
            vertical-align: middle;
        }
        
        .poem-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: grab;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            overflow: hidden;
            width: 100%;
            margin-bottom: 0.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 3rem; /* æ¸›å°é«˜åº¦ä»¥åœ¨ç§»å‹•è¨­å‚™ä¸Šæ›´ç·Šæ¹Š */
            /* å¢åŠ 3Dæ„Ÿå’Œè§¸è¦ºåé¥‹ */
            transform-origin: center center;
            backface-visibility: hidden;
            will-change: transform, box-shadow;
            user-select: none; /* é˜²æ­¢æ‹–æ‹½æ™‚é¸ä¸­æ–‡æœ¬ */
            font-family: var(--font-poem);
            font-size: 0.95rem; /* ç•¥å¾®æ¸›å°å­—é«”å¤§å°ä»¥æ›´ç·Šæ¹Š */
            line-height: 1.4;
            letter-spacing: 0.02em; /* æ¸›å°‘å­—æ¯é–“è· */
            font-weight: 500;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            white-space: nowrap; /* é˜²æ­¢æ–‡æœ¬æ›è¡Œ */
            padding: 0.65rem 1rem; /* æ¸›å°å‚ç›´å…§é‚Šè· */
        }
        
        .poem-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: #5D5CDE;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: scaleY(0.7);
        }
        
        .poem-card:hover {
            box-shadow: 0 5px 12px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            transform: translateY(-3px) scale(1.01);
        }
        
        .poem-card:hover:before {
            opacity: 1;
            transform: scaleY(1);
        }
        
        .poem-card:active {
            cursor: grabbing;
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .poem-card.dragging {
            opacity: 0.3; /* å¯¦éš›æ‹–æ‹½å…ƒç´ åŠé€æ˜ */
            pointer-events: none; /* é˜²æ­¢å¹²æ“¾å…¶ä»–å…ƒç´  */
        }
        
        /* æ‹–æ‹½å…‹éš†é«”æ¨£å¼ */
        .drag-clone {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 14px 28px rgba(93, 92, 222, 0.25), 0 10px 10px rgba(93, 92, 222, 0.22);
            border: 2px solid rgba(93, 92, 222, 0.5);
            transform: rotate(2deg) scale(1.05);
            transition: transform 0.1s ease-out;
            will-change: transform, left, top;
        }
        
        /* æ”¾ç½®æŒ‡ç¤ºå™¨ */
        .drop-indicator {
            border: 2px dashed #5D5CDE;
            border-radius: 0.5rem;
            background-color: rgba(93, 92, 222, 0.05);
            margin: 0.25rem 0;
            height: 2.8rem; /* æ¸›å°é«˜åº¦ä½¿æ›´ç·Šæ¹Š */
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-border 1.5s infinite ease-in-out;
        }
        
        @keyframes pulse-border {
            0% { border-color: rgba(93, 92, 222, 0.5); }
            50% { border-color: rgba(93, 92, 222, 1); }
            100% { border-color: rgba(93, 92, 222, 0.5); }
        }
        
        @keyframes card-pulse {
            0% { box-shadow: 0 12px 24px rgba(93, 92, 222, 0.25), 0 8px 8px rgba(93, 92, 222, 0.15); }
            50% { box-shadow: 0 12px 24px rgba(93, 92, 222, 0.35), 0 8px 8px rgba(93, 92, 222, 0.25); }
            100% { box-shadow: 0 12px 24px rgba(93, 92, 222, 0.25), 0 8px 8px rgba(93, 92, 222, 0.15); }
        }
        
        .scroll-container::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        
        .scroll-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.03);
            border-radius: 10px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.3);
            border-radius: 10px;
        }
        
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(93, 92, 222, 0.5);
        }
        
        .scene-illustration {
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 0.75rem;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .emotion-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            backdrop-filter: blur(2px);
        }
        
        .text-container {
            max-width: 90%;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 0.85rem 1.25rem;
            border-radius: 0.75rem;
            backdrop-filter: blur(4px);
            transform: translateY(0);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
            100% { transform: translateY(0px); }
        }
        
        .fixed-height-container {
            min-height: calc(100vh - 70px); 
            display: flex;
            flex-direction: column;
            padding-bottom: 70px; /* ç¢ºä¿æŒ‰éˆ•å¯è¦‹ */
            position: relative;
            overflow: hidden; /* å®¹å™¨æœ¬èº«ä¸æ»¾å‹•ï¼Œè®“å…§éƒ¨å…ƒç´ æ»¾å‹• */
        }
        
        @media (max-width: 767px) {
            .fixed-height-container {
                padding-bottom: 100px; /* ç§»å‹•è¨­å‚™ä¸Šå¢åŠ åº•éƒ¨é–“è· */
                height: auto;
                min-height: 100%;
            }
        }
        
        .tab-container {
            display: none;
        }
        
        .tab-container.active {
            display: block !important;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* æ”¹å–„iOSä¸Šçš„æ»¾å‹•é«”é©— */
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
                /* ä¿ç•™å¯è¦‹å…§å®¹ï¼Œé¿å…è£åˆ‡ */
                overflow: visible;
            }
        }
        
        @media (max-width: 767px) {
            .main-content {
                flex-direction: column;
                overflow-y: auto;
                height: auto;
                min-height: 100%;
                padding-bottom: 50px; /* æ¸›å°‘åº•éƒ¨é–“è· */
                position: relative; /* ç‚ºå®šä½æä¾›åƒè€ƒ */
            }
            
            .content-area {
                min-height: 650px;
                margin-top: 0; /* ç§»é™¤é–“è·ï¼Œå®Œå…¨å–æ¶ˆç©ºç™½ */
                position: relative; /* ç‚ºå®šä½æä¾›åƒè€ƒ */
                z-index: 5; /* ç¢ºä¿åœ¨é©ç•¶å±¤ç´š */
                background-color: #f5f2ea; /* èˆ‡é é¢èƒŒæ™¯ç›¸åŒï¼Œå¢åŠ è¦–è¦ºåˆ†é›¢ */
                border-top-left-radius: 15px;
                border-top-right-radius: 15px;
                padding-top: 15px;
                box-shadow: 0 -4px 8px rgba(0,0,0,0.04); /* é ‚éƒ¨é™°å½±å¢åŠ è¦–è¦ºå±¤æ¬¡ */
            }
            
            .dark .content-area {
                background-color: #1a1a1a; /* æ·±è‰²æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
            }
            
            /* å„ªåŒ–åœ¨ç§»å‹•è¨­å‚™ä¸Šçš„å¸ƒå±€ */
            #puzzleTab {
                overflow-y: visible;
                padding-bottom: 60px;
            }
            
            /* ç¢ºä¿æ¨™ç±¤å®¹å™¨åœ¨ç§»å‹•è¨­å‚™ä¸Šçš„ä½ç½®æ­£ç¢º */
            .tabs-container {
                margin-top: 5px; /* æ¸›å°‘é ‚éƒ¨é–“è· */
                position: sticky; /* ä½¿å°èˆªæ¬„å›ºå®š */
                top: 0; /* å›ºå®šåœ¨é ‚éƒ¨ */
                z-index: 5; /* é™ä½å±¤ç´šï¼Œé¿å…é®æ“‹toast/æç¤º */
                background-color: #f5f2ea; /* èˆ‡é é¢èƒŒæ™¯ç›¸åŒï¼Œé˜²æ­¢é€æ˜èƒŒæ™¯é€ æˆè¦–è¦ºæ··äº‚ */
                border-radius: 0 0 10px 10px; /* æ·»åŠ åº•éƒ¨åœ“è§’ */
                box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* æ·»åŠ è¼•å¾®é™°å½±ï¼Œå¢å¼·åˆ†é›¢æ„Ÿ */
                padding-bottom: 2px; /* åº•éƒ¨ç•¥å¾®å¡«å…… */
            }
            
            .dark .tabs-container {
                background-color: #1a1a1a; /* æ·±è‰²æ¨¡å¼ä¸‹çš„èƒŒæ™¯è‰² */
            }
        }
        
        .side-panel {
            flex: 0 0 22%;
            display: flex;
            flex-direction: column;
            height: auto;
        }
        
        @media (max-width: 767px) {
            /* å´é‚Šé¢æ¿åœ¨ç§»å‹•è¨­å‚™ä¸Šçš„å®Œæ•´é‡æ–°é…ç½® */
            .side-panel {
                min-height: 330px; /* é€²ä¸€æ­¥æ¸›å°‘æ•´é«”é«˜åº¦ä»¥æ¶ˆé™¤ç©ºç™½ */
                margin-bottom: 0; /* ç§»é™¤åº•éƒ¨é–“è· */
                width: 100%;
                position: relative;
                display: flex;
                flex-direction: column;
                overflow: visible;
                padding-bottom: 0;
            }
            
            /* å ´æ™¯åœ–ç¤ºå€åŸŸèª¿æ•´ */
            .side-panel > div:first-child {
                height: 200px !important;
                margin-bottom: 8px;
            }
            
            /* å¿ƒå¢ƒè®ŠåŒ–åœ–å¡ç‰‡çš„å…¨é¢å„ªåŒ– */
            .side-panel .card {
                margin-top: 5px;
                height: 130px !important; /* é€²ä¸€æ­¥å£“ç¸®é«˜åº¦ä»¥æ¶ˆé™¤ç©ºç™½ */
                width: 100% !important;
                display: flex;
                flex-direction: column;
                padding: 0;
                box-sizing: border-box;
                overflow: visible;
            }
            
            /* åœ–è¡¨æ¨™é¡Œæ¨£å¼ */
            .chart-title {
                font-size: 0.9rem;
                margin: 0 0 5px 0;
                padding: 0 10px;
                font-weight: 600;
                line-height: 1.1;
                text-align: center;
                color: #5D5CDE;
            }
            
            /* åœ–è¡¨å®¹å™¨å®Œæ•´é‡è¨­ */
            .emotion-chart-container {
                height: 105px !important;
                min-height: 105px !important;
                margin: 0 !important;
                padding: 0 5px !important;
                position: relative;
                width: 100% !important;
                flex-grow: 1;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* ç¢ºä¿Canvaså…ƒç´ é¡¯ç¤ºæ­£ç¢º */
            #emotion-chart {
                width: 100% !important;
                max-width: 100% !important;
                height: 100% !important;
                max-height: 220px !important;
            }
            
            /* ç§»å‹•ç«¯ï¼šç·Šè²¼å¿ƒå¢ƒè®ŠåŒ–åœ–ï¼Œå»é™¤å¤šé¤˜ç©ºç™½ */
            .content-area {
                margin-top: 0 !important;
                padding-top: 6px !important;
            }
        }
        
        .content-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 767px) {
            .content-area {
                overflow-y: visible; /* è¡Œå‹•ç«¯ä¸åšå…§å±¤æ»¾å‹•ï¼Œé¿å…è£åˆ‡ */
            }
        }
        
        @media (max-width: 767px) {
            body {
                overflow-y: auto; /* å…è¨±æ»¾å‹•æ•´å€‹é é¢ */
                height: auto;
            }
            
            #app {
                overflow-y: visible;
                min-height: 100dvh;
                height: auto;
            }
            
            .fixed-height-container {
                height: auto;
                overflow-y: visible;
            }
        }
        
        .tab-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            border-color: #5D5CDE !important;
        }
        
        .tab-button.active:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #5D5CDE;
            transform: scaleX(1);
        }
        
        .shine-effect {
            position: relative;
            overflow: hidden;
        }
        
        .shine-effect:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, rgba(255,255,255,0) 20%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 80%);
            transform: rotate(30deg);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .shine-effect:hover:after {
            opacity: 1;
            animation: shine 1.5s forwards;
        }
        
        @keyframes shine {
            0% {
                transform: translateX(-100%) rotate(30deg);
            }
            100% {
                transform: translateX(100%) rotate(30deg);
            }
        }
        
        /* ç¾åŒ–å¿ƒå¢ƒæ¢ç´¢ä¸­çš„é¸é … */
        .quiz-option {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border-left: 0 solid transparent;
        }
        
        .quiz-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(93, 92, 222, 0.15);
        }
        
        .quiz-option.selected {
            border-color: #5D5CDE;
            border-width: 2px;
            background-color: rgba(93, 92, 222, 0.05);
            box-shadow: 0 4px 10px rgba(93, 92, 222, 0.2);
            border-left: 4px solid #5D5CDE;
            padding-left: calc(0.75rem - 2px);
        }
        
        .quiz-option.selected:after {
            content: 'âœ“';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #5D5CDE;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* è‡ªå®šç¾©æŒ‰éˆ• */
        .btn-primary {
            background-color: #5D5CDE;
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(93, 92, 222, 0.1), 0 1px 3px rgba(93, 92, 222, 0.08);
            white-space: nowrap; /* æŒ‰éˆ•æ–‡å­—å–®è¡Œé¡¯ç¤º */
        }
        
        .btn-primary:hover {
            background-color: #4542b9;
            transform: translateY(-1px);
            box-shadow: 0 7px 14px rgba(93, 92, 222, 0.15), 0 3px 6px rgba(93, 92, 222, 0.1);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(93, 92, 222, 0.1);
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: 0 10px 20px rgba(93, 92, 222, 0.1), 0 6px 6px rgba(93, 92, 222, 0.06);
        }
        
        .card-header {
            font-family: var(--font-serif);
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .card-body {
            padding: 1rem;
            overflow-y: auto; /* ç¢ºä¿å…§å®¹å¯æ»¾å‹• */
        }
        
        /* å‚ç›´æ’åºå€åŸŸæ¨£å¼ */
        .vertical-sort-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 280px;
            min-height: 280px;
            max-height: 280px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            padding-bottom: 10px;
        }
        
        @media (max-width: 767px) {
            .vertical-sort-area {
                height: 330px;
                min-height: 330px;
                max-height: 330px;
            }
        }
        
        .vertical-sort-area.highlight {
            border: 2px solid #5D5CDE;
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        /* è©©å¥æ’åˆ—æ¨£å¼ - å…©è¡Œä¸¦è‡ªé©æ‡‰å¤§å° */
        .poem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            grid-gap: 0.75rem;
            width: 100%;
            justify-items: center;
            transition: all 0.3s ease;
        }
        
        .poem-grid.highlight {
            border: 2px solid #5D5CDE;
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        /* ä¸‹ä¸€é—œæŒ‰éˆ• */
        .next-level-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(93, 92, 222, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(93, 92, 222, 0);
            }
        }
        
        .vertical-spacer {
            flex-grow: 1;
        }
        
        .tab-content-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-height: calc(100dvh - 210px);
            padding-right: 10px;
        }

        @media (max-width: 767px) {
            .tab-content-scroll {
                max-height: none; /* è¡Œå‹•ç«¯ä¸é™åˆ¶é«˜åº¦ï¼Œäº¤ç”± body æ»¾å‹• */
                overflow-y: visible;
            }
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
            }
            
            .card {
                background-color: #222;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.3);
            }
            
            .card-header {
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            .dark .bg-white {
                background-color: #222;
            }
            
            .dark .text-gray-800 {
                color: #e0e0e0;
            }
            
            .dark .text-gray-700 {
                color: #d0d0d0;
            }
            
            .dark .text-gray-600 {
                color: #b0b0b0;
            }
            
            .dark .border-gray-200 {
                border-color: #333;
            }
            
            .dark .bg-green-100 {
                background-color: #1b3a28;
            }
            
            .dark .text-green-800 {
                color: #7ae0a9;
            }
            
            .poem-card {
                background-color: #2a2a2a;
                box-shadow: 0 1px 3px rgba(0,0,0,0.24), 0 1px 2px rgba(0,0,0,0.36);
            }
            
            .poem-card:hover {
                box-shadow: 0 3px 6px rgba(0,0,0,0.32), 0 3px 6px rgba(0,0,0,0.46);
            }
            
            .quiz-option.selected {
                background-color: rgba(93, 92, 222, 0.15);
            }
            
            .drop-indicator {
                background-color: rgba(93, 92, 222, 0.15);
            }
            
            /* ä¿®å¤æ·±è‰²æ¨¡å¼ä¸‹çš„ç§»åŠ¨ç«¯è¦–åœ–å•é¡Œ */
            .tabs-container {
                background-color: #1a1a1a !important;
            }
        }
        
        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            padding: 12px;
            background-color: #5D5CDE;
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .music-control:hover {
            transform: scale(1.1);
            background-color: #4542b9;
        }
        
        .music-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            width: 300px;
            padding: 12px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
            display: none;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .music-control:hover .music-tooltip {
            display: block;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .dark .music-tooltip {
            background-color: #252525;
            color: #e0e0e0;
        }
        
        /* æ¸¸æ¨™ä¸‹çš„è©©å¥è¼•è¼•æµ®å‹• */
        @keyframes gentle-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* å¿ƒå¢ƒè®ŠåŒ–åœ–æ¨™é¡Œæ¨£å¼ */
        .chart-title {
            font-family: var(--font-poem);
            font-size: 1.25rem;
            color: #5D5CDE;
            text-align: center;
            margin-bottom: 0.5rem;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            letter-spacing: 0.03em;
        }
        
        /* æ·»åŠ å¤é¢¨åœ–æ¨™ */
        .ancient-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            width: 1.5rem;
            height: 1.5rem;
            font-size: 1.1em;
            opacity: 0.9;
            vertical-align: middle;
            color: currentColor;
            transition: transform 0.2s ease;
        }
        
        button:hover .ancient-icon {
            transform: scale(1.15);
        }
        
        /* æ–°å¢ï¼šæ¼‚äº®çš„æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(93, 92, 222, 0.05);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.2);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(93, 92, 222, 0.4);
        }
        
        /* æ–°å¢: è¯—å¥è£…é¥° */
        .poem-decoration {
            position: relative;
        }
        
        .poem-decoration:before, .poem-decoration:after {
            content: 'â–';
            color: rgba(93, 92, 222, 0.3);
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .poem-decoration:before {
            left: -20px;
        }
        
        .poem-decoration:after {
            right: -20px;
        }
        
        /* æ–°å¢ï¼šæ ‡ç­¾é¡µçš„æ›´å¥½è¦–è¦ºæ•ˆæœ */
        .tabs-container {
            position: relative;
        }
        
        .tabs-highlight {
            position: absolute;
            height: 3px;
            bottom: 0;
            left: 0;
            background-color: #5D5CDE;
            transition: all 0.3s ease;
        }
        
        /* æ–°å¢ï¼šæˆå°±æ ‡è®° */
        .achievement-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #FFD166;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-size: 12px;
            font-weight: bold;
            color: white;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .achievement-badge.show {
            opacity: 1;
            transform: scale(1);
        }
        
        /* æ–°å¢ï¼šçŸ¥è¯†ç‚¹å†…å®¹æ›´å¥½çš„æ’ç‰ˆ */
        .knowledge-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        
        .knowledge-content .highlight {
            background-color: rgba(93, 92, 222, 0.1);
            border-radius: 0.25rem;
            padding: 2px 4px;
            font-weight: 500;
            color: #5D5CDE;
        }
        
        /* æå‡å­—ä½“æ•ˆæœ */
        .ancient-font {
            font-family: var(--font-poem);
            letter-spacing: 0.02em;
            text-rendering: optimizeLegibility;
        }
        
        .serif-font {
            font-family: var(--font-serif);
            letter-spacing: 0.01em;
            text-rendering: optimizeLegibility;
        }
        
        /* æ–°å¢æ ‡é¢˜å­—ä½“æ ·å¼ */
        .font-title {
            font-family: var(--font-title);
            font-weight: 600;
            letter-spacing: 0.05em;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            text-shadow: 1px 1px 2px rgba(93, 92, 222, 0.1);
        }
        
        .font-subtitle {
            font-family: var(--font-subtitle);
            letter-spacing: 0.03em;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }
        
        .text-shadow-elegant {
            text-shadow: 0 2px 4px rgba(93, 92, 222, 0.15);
        }
        
        /* ä¿®å¤çŸ¥è¯†ç‚¹å†…å®¹æ˜¾ç¤ºé—®é¢˜ */
        #knowledgeTab.active {
            display: block !important;
        }
        
        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-message {
            background-color: rgba(220, 38, 38, 0.1);
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }
        
        /* æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #777;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .step-circle.completed {
            background-color: #5D5CDE;
            color: white;
        }
        
        .step-circle.active {
            background-color: #5D5CDE;
            color: white;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }
        
        .step-label {
            font-size: 0.8rem;
            color: #777;
            transition: all 0.3s ease;
        }
        
        .step-label.active, .step-label.completed {
            color: #5D5CDE;
            font-weight: 500;
        }
        
        .progress-line {
            position: absolute;
            top: 15px;
            left: 20%;
            right: 20%;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 0;
        }
        
        .progress-line-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #5D5CDE;
            transition: width 0.5s ease;
        }
        
        .dark .step-circle {
            background-color: #444;
            color: #bbb;
        }
        
        .dark .step-label {
            color: #bbb;
        }
        
        .dark .progress-line {
            background-color: #444;
        }
        
        /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        
        .bounce-animation {
            animation: bounce 2s infinite;
        }
        
        /* æ‹–æ‹½å‹•ç•« */
        @keyframes ripple {
            0% { transform: scale(0.5); opacity: 0.4; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        @keyframes dropBounce {
            0% { transform: scale(1.02); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
        
        @keyframes pop {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
</style>

<!-- Font Awesome å›¾æ ‡åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- å¤ªè™›å¹»å¢ƒæ‡‰ç”¨åˆ‡æ›å™¨çµ„ä»¶ -->
<script src="/assets/js/taixu-app-switcher.js"></script>
</head>
<body>
    <div id="app" class="container mx-auto px-4 py-4 max-w-6xl flex flex-col">
        <!-- èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å™¨ -->
        <audio id="background-music" loop preload="auto" style="display:none;">
            <source src="https://dl.dropboxusercontent.com/scl/fi/p0docwf6s28hm08k3qjmc/music.mp3?rlkey=5vwue7zhitw4mx3yvon9c2wwo&st=16rjoefj&dl=1" type="audio/mpeg">
        </audio>
        <!-- éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• -->
        <div class="music-control" id="music-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
            <div class="music-tooltip">
                <p class="font-medium mb-2">èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶</p>
                <p class="mb-2">é»æ“Šå¯é—œé–‰èƒŒæ™¯éŸ³æ¨‚</p>
            </div>
        </div>
        
        <!-- æ¸¸æˆè§†å›¾å®¹å™¨ -->
        <div id="game-view" class="hidden fixed-height-container animate__animated animate__fadeIn">
            <header class="mb-4 text-center">
                <h1 class="relative mb-3 tracking-wide animate__animated animate__fadeInDown">
                        <div class="w-full text-center flex flex-col items-center justify-center">
                            <!-- ä½¿ç”¨flex-rowè®“æ¨™é¡Œä½”ç”¨æ•´è¡Œï¼Œä¸”å¼·åˆ¶å–®è¡Œé¡¯ç¤º -->
                            <div class="inline-flex items-center justify-center flex-nowrap whitespace-nowrap">
                                <svg class="plum-icon h-5 w-5 sm:h-6 sm:w-6 md:h-7 md:w-7 shrink-0" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="plumGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" stop-color="#b0d68c"/>
                                            <stop offset="100%" stop-color="#9BBF8A"/>
                                        </linearGradient>
                                        <radialGradient id="plumHighlight1" cx="40%" cy="40%" r="60%" fx="40%" fy="40%">
                                            <stop offset="0%" stop-color="#c2e09e" stop-opacity="0.6"/>
                                            <stop offset="100%" stop-color="#9BBF8A" stop-opacity="0"/>
                                        </radialGradient>
                                    </defs>
                                    <ellipse cx="8" cy="12" rx="4" ry="4.5" fill="url(#plumGradient1)" />
                                    <ellipse cx="8" cy="12" rx="3" ry="3.3" fill="url(#plumHighlight1)" />
                                    <ellipse cx="15" cy="13" rx="3.5" ry="4" fill="url(#plumGradient1)" />
                                    <ellipse cx="15" cy="13" rx="2.5" ry="2.8" fill="url(#plumHighlight1)" />
                                    <path d="M8,8C7.5,6,8,4.5,9,3.5C10,2.5,12,3,12,3" stroke="#8aae7a" stroke-width="0.5" fill="none" />
                                    <path d="M15,9.5C15.2,7,14,5,13,4C12,3,10,2.5,9,3" stroke="#8aae7a" stroke-width="0.5" fill="none" />
                                    <path d="M6.2,7.3C4.5,5.5,6,4,9,5.5" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.3" />
                                    <path d="M14,4C14.8,2.2,12,1.8,11,4" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.3" />
                                </svg>
                                <span class="font-title text-primary-600 block text-shadow-elegant relative z-10 text-2xl sm:text-3xl md:text-4xl tracking-wide mx-1 sm:mx-2">é•·å¹²è¡Œ</span>
                                <svg class="plum-icon h-5 w-5 sm:h-6 sm:w-6 md:h-7 md:w-7 shrink-0" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="plumGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" stop-color="#b0d68c"/>
                                            <stop offset="100%" stop-color="#9BBF8A"/>
                                        </linearGradient>
                                        <radialGradient id="plumHighlight2" cx="40%" cy="40%" r="60%" fx="40%" fy="40%">
                                            <stop offset="0%" stop-color="#c2e09e" stop-opacity="0.6"/>
                                            <stop offset="100%" stop-color="#9BBF8A" stop-opacity="0"/>
                                        </radialGradient>
                                    </defs>
                                    <ellipse cx="8" cy="12" rx="4" ry="4.5" fill="url(#plumGradient2)" />
                                    <ellipse cx="8" cy="12" rx="3" ry="3.3" fill="url(#plumHighlight2)" />
                                    <ellipse cx="15" cy="13" rx="3.5" ry="4" fill="url(#plumGradient2)" />
                                    <ellipse cx="15" cy="13" rx="2.5" ry="2.8" fill="url(#plumHighlight2)" />
                                    <path d="M8,8C7.5,6,8,4.5,9,3.5C10,2.5,12,3,12,3" stroke="#8aae7a" stroke-width="0.5" fill="none" />
                                    <path d="M15,9.5C15.2,7,14,5,13,4C12,3,10,2.5,9,3" stroke="#8aae7a" stroke-width="0.5" fill="none" />
                                    <path d="M6.2,7.3C4.5,5.5,6,4,9,5.5" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.3" />
                                    <path d="M14,4C14.8,2.2,12,1.8,11,4" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.3" />
                                </svg>
                            </div>
                            <span class="font-subtitle text-primary-700 block mt-1 text-lg sm:text-xl md:text-2xl relative z-0">æ™‚å…‰æ‹¼åœ–</span>
                        </div>
                        <div class="absolute -bottom-1 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-primary-500 to-transparent"></div>
                    </h1>
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">é—œå¡ï¼š</span>
                        <span id="level-display" class="font-semibold text-primary-600"></span>
                    </div>
                    <div class="flex space-x-3">
                        <!-- å®Œæ•´è¯—æ–‡æŒ‰é’®åœ¨æ¸¸æˆä¸­éšè— -->
                        <button id="show-full-poem" class="bg-white dark:bg-gray-800 text-primary-600 rounded-lg border border-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900 transition-all text-sm px-3 py-1.5 shadow-btn hidden">
                            <span class="ancient-icon">ğŸ“œ</span>å®Œæ•´è©©æ–‡
                        </button>
                    </div>
                </div>
                

            </header>
            
            <div class="main-content">
                <!-- å·¦ä¾§é¢æ¿: åœºæ™¯å’Œæƒ…æ„Ÿå›¾è¡¨ -->
                <div class="side-panel mr-2">
                    <div style="height: 300px;" class="mb-3">
                        <div id="scene-illustration" class="scene-illustration animate__animated animate__fadeIn">
                            <div class="emotion-badge" id="emotion-badge"></div>
                            <div class="text-container">
                                <p id="character-monologue" class="text-white italic text-center text-shadow" style="font-family: var(--font-serif);"></p>
                            </div>
                        </div>
                    </div>
                    <div style="height: 250px;" class="card animate__animated animate__fadeIn animate__delay-1s flex flex-col justify-center">
                        <div class="chart-title">å¿ƒå¢ƒè®ŠåŒ–åœ–</div>
                        <div class="emotion-chart-container px-2 pb-2 flex-grow flex items-center justify-center">
                            <canvas id="emotion-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ä¸»è¦å†…å®¹åŒºï¼šæ ‡ç­¾å¼å¯¼èˆª -->
                <div class="content-area">
                    <div class="tabs-container flex mb-3 relative">
                        <button class="tab-button flex-1 py-2 text-center border-b-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400" data-tab="puzzleTab">
                            <span class="ancient-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <rect x="2" y="2" width="9" height="9" rx="1"></rect>
                <rect x="13" y="2" width="9" height="9" rx="1"></rect>
                <rect x="2" y="13" width="9" height="9" rx="1"></rect>
                <rect x="13" y="13" width="9" height="9" rx="1"></rect>
              </svg>
            </span>è©©å¥æ’åº
                        </button>
                        <button class="tab-button flex-1 py-2 text-center border-b-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400" data-tab="knowledgeTab">
                            <span class="ancient-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
              </svg>
            </span>çŸ¥è­˜é»
                        </button>
                        <button class="tab-button flex-1 py-2 text-center border-b-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400" data-tab="quizTab">
                            <span class="ancient-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v.01"></path>
                <path d="M8 10a4 4 0 0 1 8 0c0 1.5-.5 2.5-2 3-1.4.4-2 1-2 3"></path>
              </svg>
            </span>å¿ƒå¢ƒæ¢ç´¢
                        </button>
                    </div>
                    
                    <div class="tab-containers h-full">
                        <!-- æ‹¼å›¾æ ‡ç­¾ -->
                        <div id="puzzleTab" class="tab-container min-h-fit sm:h-full flex flex-col">
                            
                            <div class="flex flex-col flex-1 overflow-visible mb-12">
                                <!-- ä¸¤è¡Œè¯—å¥å¸ƒå±€ -->
                                <div>
                                    <h3 class="text-lg font-medium mb-2 text-gray-800 dark:text-gray-200 pl-2 border-l-4 border-primary-600" style="font-family: var(--font-serif);">
                                        å¾…æ’åºè©©å¥
                                    </h3>
                                    <div id="poem-pieces" class="poem-grid bg-white dark:bg-gray-800 rounded-lg shadow-elegant p-3 border border-gray-100 dark:border-gray-700 animate__animated animate__fadeIn">
                                        <!-- è¯—å¥å¡ç‰‡å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œï¼Œä¸¤è¡Œæ’åˆ— -->
                                    </div>
                                </div>
                                
                                <!-- å‚ç›´æ’åºåŒºåŸŸ -->
                                <div class="flex-1 overflow-hidden mt-4">
                                    <h3 class="text-lg font-medium mb-2 text-gray-800 dark:text-gray-200 pl-2 border-l-4 border-primary-600" style="font-family: var(--font-serif);">
                                        è©©å¥æ’åº <span class="text-sm text-gray-500 dark:text-gray-400" style="font-family: var(--font-serif);">(å¾ä¸Šè‡³ä¸‹)</span>
                                    </h3>
                                    <div id="poem-sequence" class="vertical-sort-area bg-white dark:bg-gray-800 rounded-lg shadow-elegant border border-gray-100 dark:border-gray-700 p-3 custom-scrollbar animate__animated animate__fadeIn">
                                        <!-- æ’åºåçš„è¯—å¥å°†ä»ä¸Šè‡³ä¸‹æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3 mb-4">
                                    <button id="check-button" class="btn-primary px-8 py-2.5 shine-effect animate__animated animate__fadeIn animate__delay-1s">
                                        <span class="ancient-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </span>æª¢æŸ¥æ’åº
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- çŸ¥è¯†ç‚¹æ ‡ç­¾ -->
                        <div id="knowledgeTab" class="tab-container h-full flex flex-col">
                            <div class="card flex-1 flex flex-col overflow-hidden animate__animated animate__fadeIn">
                                <div class="card-header bg-primary-50 dark:bg-primary-900 text-primary-700 dark:text-primary-300">
                                    <span class="ancient-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
            </span>è©©è©çŸ¥è­˜é»
                                </div>
                                <div class="card-body flex-1 overflow-y-auto custom-scrollbar">
                                    <div id="knowledge-content" class="knowledge-content text-gray-700 dark:text-gray-300 leading-relaxed"></div>
                                </div>
                                <div class="p-4 border-t border-gray-100 dark:border-gray-800 text-center">
                                    <button id="to-explore-button" class="btn-primary px-6 py-2 animate__animated animate__fadeIn" style="display: none;">
                                        <span class="ancient-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                <circle cx="12" cy="10" r="2"></circle>
                                                <path d="M12 10v.01"></path>
                                            </svg>
                                        </span>é€²å…¥å¿ƒå¢ƒæ¢ç´¢
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- äº’åŠ¨é—®ç­”æ ‡ç­¾ -->
                        <div id="quizTab" class="tab-container h-full flex flex-col">
                            <div class="card flex-1 flex flex-col overflow-visible animate__animated animate__fadeIn">
                                <div class="card-header bg-primary-50 dark:bg-primary-900 text-primary-700 dark:text-primary-300">
                                    <span class="ancient-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <path d="M11 5a7 7 0 0 1 7 7m-7 7a7 7 0 1 1 0-14"></path>
                <path d="M11 5v14"></path>
                <path d="M11 12H4"></path>
                <path d="M15 8a1 1 0 1 0 2 0 1 1 0 0 0-2 0z"></path>
                <path d="M17 16a1 1 0 1 0 2 0 1 1 0 0 0-2 0z"></path>
              </svg>
            </span>å¿ƒå¢ƒæ¢ç´¢
                                </div>
                                <div class="card-body flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar pb-4">
                                    <!-- å…§å®¹å€åŸŸåˆ†ç‚ºå…©éƒ¨åˆ†ï¼Œä½¿ç”¨æ›´å½ˆæ€§çš„ä½ˆå±€ -->
                                    <div class="quiz-content">
                                        <p id="quiz-question" class="text-gray-700 dark:text-gray-300 mb-3 font-medium poem-decoration break-words w-full text-base"></p>
                                        <div id="quiz-options" class="grid grid-cols-1 gap-2 mb-3 w-full">
                                            <!-- é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                                        </div>
                                        <div class="mb-3 flex items-center gap-4 flex-wrap">
                                            <button id="submit-quiz" class="btn-primary shine-effect">
                                                <span class="ancient-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                                    <circle cx="11" cy="11" r="8"></circle>
                                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                </svg>
                                            </span>ç¢ºèªç­”æ¡ˆ
                                            </button>
                                            
                                            <!-- ä½¿ç”¨display:noneç¡®ä¿åˆå§‹éšè— -->
                                            <button id="next-level-button" class="btn-primary next-level-btn px-6 py-2" 
                                                   style="display: none;">
                                                <span class="ancient-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                                        <path d="M5 12h14"></path>
                                                        <path d="m12 5 7 7-7 7"></path>
                                                    </svg>
                                                </span>é€²å…¥ä¸‹ä¸€é—œ
                                            </button>
                                        </div>
                                    </div>
                                    <!-- åé¥‹å€åŸŸå„ªåŒ–ï¼Œç¢ºä¿åœ¨å„ç¨®å±å¹•å°ºå¯¸ä¸Šéƒ½èƒ½å®Œæ•´é¡¯ç¤º -->
                                    <div id="quiz-feedback" class="hidden mb-4 w-full break-words feedback-container overflow-y-auto max-h-64 md:max-h-96"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»èœå• -->
        <div id="main-menu" class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="text-center mb-12 animate__animated animate__fadeIn">
                <h1 class="relative mb-6 tracking-wide">
                    <div class="flex items-center justify-center">
                        <svg class="plum-icon h-12 w-12 md:h-14 md:w-14" viewBox="0 0 24 24">
                            <defs>
                                <linearGradient id="plumGradientMain1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#c0e693"/>
                                    <stop offset="100%" stop-color="#9BBF8A"/>
                                </linearGradient>
                                <radialGradient id="plumShineMain1" cx="35%" cy="35%" r="60%" fx="35%" fy="35%">
                                    <stop offset="0%" stop-color="#deffb5" stop-opacity="0.7"/>
                                    <stop offset="100%" stop-color="#9BBF8A" stop-opacity="0"/>
                                </radialGradient>
                            </defs>
                            <!-- Left plum -->
                            <ellipse cx="9" cy="12" rx="4.5" ry="5" fill="url(#plumGradientMain1)" />
                            <ellipse cx="9" cy="12" rx="3" ry="3.5" fill="url(#plumShineMain1)" />
                            
                            <!-- Right plum -->
                            <ellipse cx="16" cy="11" rx="4" ry="4.5" fill="url(#plumGradientMain1)" />
                            <ellipse cx="16" cy="11" rx="2.5" ry="3" fill="url(#plumShineMain1)" />
                            
                            <!-- Stems and leaves -->
                            <path d="M9,7.5C9,5,10,3,12,2C14,1,16,2,16,2" stroke="#8aae7a" stroke-width="0.6" fill="none" />
                            <path d="M16,7C16,5,15,3,14,2" stroke="#8aae7a" stroke-width="0.5" fill="none" />
                            
                            <!-- Leaf 1 - larger and more detailed -->
                            <path d="M7,4C3,4,3,7,5,9" stroke="#8aae7a" stroke-width="0.4" fill="none" />
                            <path d="M5,9C3,7,3.5,4,7,4C9,4,11,5,10,9" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.4" />
                            <path d="M6,6.5C7,7,8,7,7,8" stroke="#8aae7a" stroke-width="0.3" fill="none" />
                            
                            <!-- Leaf 2 -->
                            <path d="M13,3C10,1,14,1,15,4" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.4" />
                            <path d="M13.5,2.5C14,2,15,2,14.5,3" stroke="#8aae7a" stroke-width="0.3" fill="none" />
                            
                            <!-- Plum textures -->
                            <path d="M8,10C9,10.5,10,10.5,11,10" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            <path d="M15,9C16,9.5,17,9.5,18,9" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            <path d="M7,14C8,13.5,10,13.5,11,14" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            <path d="M14,13C15,12.5,17,12.5,18,13" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            
                            <!-- Highlight details -->
                            <path d="M9,9C9.5,8.5,10,9,9.5,9.5" stroke="#8aae7a" stroke-width="0.2" fill="none" opacity="0.7" />
                            <path d="M16,8C16.5,7.5,17,8,16.5,8.5" stroke="#8aae7a" stroke-width="0.2" fill="none" opacity="0.7" />
                        </svg>
                        <span class="font-title text-primary-600 block text-shadow-elegant relative z-10 text-5xl md:text-6xl tracking-wide">é•·å¹²è¡Œ</span>
                        <svg class="plum-icon h-12 w-12 md:h-14 md:w-14" viewBox="0 0 24 24">
                            <defs>
                                <linearGradient id="plumGradientMain2" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#c0e693"/>
                                    <stop offset="100%" stop-color="#9BBF8A"/>
                                </linearGradient>
                                <radialGradient id="plumShineMain2" cx="35%" cy="35%" r="60%" fx="35%" fy="35%">
                                    <stop offset="0%" stop-color="#deffb5" stop-opacity="0.7"/>
                                    <stop offset="100%" stop-color="#9BBF8A" stop-opacity="0"/>
                                </radialGradient>
                            </defs>
                            <!-- Left plum -->
                            <ellipse cx="9" cy="12" rx="4.5" ry="5" fill="url(#plumGradientMain2)" />
                            <ellipse cx="9" cy="12" rx="3" ry="3.5" fill="url(#plumShineMain2)" />
                            
                            <!-- Right plum -->
                            <ellipse cx="16" cy="11" rx="4" ry="4.5" fill="url(#plumGradientMain2)" />
                            <ellipse cx="16" cy="11" rx="2.5" ry="3" fill="url(#plumShineMain2)" />
                            
                            <!-- Stems and leaves -->
                            <path d="M9,7.5C9,5,10,3,12,2C14,1,16,2,16,2" stroke="#8aae7a" stroke-width="0.6" fill="none" />
                            <path d="M16,7C16,5,15,3,14,2" stroke="#8aae7a" stroke-width="0.5" fill="none" />
                            
                            <!-- Leaf 1 - larger and more detailed -->
                            <path d="M7,4C3,4,3,7,5,9" stroke="#8aae7a" stroke-width="0.4" fill="none" />
                            <path d="M5,9C3,7,3.5,4,7,4C9,4,11,5,10,9" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.4" />
                            <path d="M6,6.5C7,7,8,7,7,8" stroke="#8aae7a" stroke-width="0.3" fill="none" />
                            
                            <!-- Leaf 2 -->
                            <path d="M13,3C10,1,14,1,15,4" fill="#9BBF8A" stroke="#8aae7a" stroke-width="0.4" />
                            <path d="M13.5,2.5C14,2,15,2,14.5,3" stroke="#8aae7a" stroke-width="0.3" fill="none" />
                            
                            <!-- Plum textures -->
                            <path d="M8,10C9,10.5,10,10.5,11,10" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            <path d="M15,9C16,9.5,17,9.5,18,9" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            <path d="M7,14C8,13.5,10,13.5,11,14" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            <path d="M14,13C15,12.5,17,12.5,18,13" stroke="#8aae7a" stroke-width="0.3" fill="none" opacity="0.5" />
                            
                            <!-- Highlight details -->
                            <path d="M9,9C9.5,8.5,10,9,9.5,9.5" stroke="#8aae7a" stroke-width="0.2" fill="none" opacity="0.7" />
                            <path d="M16,8C16.5,7.5,17,8,16.5,8.5" stroke="#8aae7a" stroke-width="0.2" fill="none" opacity="0.7" />
                        </svg>
                    </div>
                    <span class="font-subtitle text-primary-700 block mt-3 text-4xl md:text-5xl relative z-0">æ™‚å…‰æ‹¼åœ–</span>
                    <div class="absolute -bottom-3 left-1/4 right-1/4 h-1.5 bg-gradient-to-r from-transparent via-primary-500 to-transparent"></div>
                </h1>
                <p class="text-gray-600 dark:text-gray-400 text-xl font-serif">æ¢ç´¢æç™½ã€Šé•·å¹²è¡Œã€‹çš„æ™‚é–“èˆ‡æƒ…æ„Ÿä¹‹æ—…</p>
            </div>
            
            <div class="flex flex-col gap-5 w-full max-w-md animate__animated animate__fadeIn animate__delay-1s">
                <button id="start-game" class="btn-primary py-5 text-xl font-medium shine-effect">
                    <span class="ancient-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <path d="M12 2v8"></path>
                <path d="M5 10v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V10"></path>
                <path d="M22 10H2"></path>
                <path d="M12 14v6"></path>
                <path d="M9 14v2"></path>
                <path d="M15 14v2"></path>
                <path d="M12 10v1"></path>
              </svg>
            </span>é–‹å§‹éŠæˆ²
                </button>
                <button id="show-poem" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg border border-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all font-medium text-xl py-5 shadow-btn">
                    <span class="ancient-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <line x1="10" y1="9" x2="8" y2="9"></line>
                      </svg>
                    </span>å®Œæ•´è©©æ–‡
                </button>
            </div>
            
            <div class="mt-12 p-5 card max-w-md text-center animate__animated animate__fadeIn animate__delay-2s">
                <p class="text-gray-700 dark:text-gray-300">éŠæˆ²å·²è‡ªå‹•æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ï¼Œå¯é€šéå³ä¸‹è§’<span class="text-primary-600">éŸ³æ¨‚æŒ‰éˆ•</span>é—œé–‰</p>
            </div>
        </div>
        
        <!-- æ¸¸æˆè¯´æ˜æ¨¡æ€æ¡† -->
        <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden animate__animated animate__fadeIn">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto animate__animated animate__zoomIn">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-200">
                        <span class="ancient-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <path d="M14 2v6h6"></path>
                                <path d="M16 13H8"></path>
                                <path d="M16 17H8"></path>
                                <path d="M10 9H8"></path>
                            </svg>
                        </span>éŠæˆ²èªªæ˜
                    </h2>
                </div>
                <div class="p-6">
                    <div class="text-gray-700 dark:text-gray-300 space-y-4">
                        <p class="leading-relaxed">ã€Šé•·å¹²è¡Œæ™‚å…‰æ‹¼åœ–ã€‹æ˜¯ä¸€æ¬¾åŸºæ–¼æç™½ç¶“å…¸è©©ä½œã€Šé•·å¹²è¡Œã€‹çš„è§£è¬æ¸¸æˆ²ã€‚</p>
                        <p class="leading-relaxed">éŠæˆ²ç›®æ¨™ï¼šæ ¹æ“šè©©ä¸­æè¿°çš„äººç”Ÿéšæ®µå’Œæ™‚é–“ç·šç´¢ï¼Œå°‡æ‰“æ•£çš„è©©å¥é‡æ–°æ’åˆ—æˆæ­£ç¢ºçš„é †åºã€‚</p>
                        <h3 class="text-xl font-serif font-semibold mt-5 mb-3 text-gray-800 dark:text-gray-200 text-primary-700">
                            <span class="ancient-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                    <path d="M6 11h4M8 9v4M15 12h.01M18 10h.01"></path>
                                    <rect width="20" height="12" x="2" y="6" rx="2"></rect>
                                </svg>
                            </span>éŠæˆ²ç©æ³•ï¼š
                        </h3>
                        <ol class="list-decimal pl-5 space-y-3">
                            <li>æ¯å€‹é—œå¡æœƒæä¾›ã€Šé•·å¹²è¡Œã€‹ä¸­çš„è©©å¥ç‰‡æ®µ</li>
                            <li>æ‹–å‹•è©©å¥å¡ç‰‡ï¼Œå°‡å®ƒå€‘æŒ‰ç…§ç”±ä¸Šè‡³ä¸‹çš„æ™‚é–“é †åºæ’åˆ—</li>
                            <li>é»æ“Šã€Œæª¢æŸ¥æ’åºã€æŒ‰éˆ•é©—è­‰æ‚¨çš„ç­”æ¡ˆ</li>
                            <li>æ­£ç¢ºæ’åºå¾Œï¼Œæ‚¨å°‡è§£é–ç›¸é—œçš„çŸ¥è­˜é»å’Œå¿ƒå¢ƒæ¢ç´¢é¡Œç›®</li>
                            <li>å›ç­”å¿ƒå¢ƒæ¢ç´¢å•é¡Œï¼Œæ·±å…¥äº†è§£è©©ä¸­å¥³å­çš„æƒ…æ„Ÿè®ŠåŒ–</li>
                            <li>å®Œæˆç•¶å‰é—œå¡å¾Œï¼Œé»æ“Šã€Œé€²å…¥ä¸‹ä¸€é—œã€ç¹¼çºŒéŠæˆ²</li>
                            <li>å¦‚æœé‡åˆ°å›°é›£ï¼Œå¯ä»¥ä½¿ç”¨ã€Œæç¤ºã€æŒ‰éˆ•ç²å–å¹«åŠ©</li>
                        </ol>
                        <p class="mt-5 leading-relaxed font-medium">æ¨è–¦æ­é…ã€Šé•·å¹²è¡ŒÂ·é›²å…’è¬ ã€‹èƒŒæ™¯éŸ³æ¨‚ï¼Œå¢å¼·æ¸¸æˆ²é«”é©—ã€‚</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-b-lg flex justify-end">
                    <button id="close-instructions" class="btn-primary">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å®Œæ•´è¯—æ–‡æ¨¡æ€æ¡† -->
        <div id="poem-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden animate__animated animate__fadeIn">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl mx-4 relative animate__animated animate__zoomIn">
                <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-200">
                        <span class="ancient-icon">ğŸ“œ</span>æç™½ã€Šé•·å¹²è¡Œã€‹
                    </h2>
                    <button id="close-poem" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="px-5 py-4 flex flex-col items-center justify-center space-y-3">
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">å¦¾é«®åˆè¦†é¡ï¼ŒæŠ˜èŠ±é–€å‰åŠ‡ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">éƒé¨ç«¹é¦¬ä¾†ï¼Œç¹åºŠå¼„é’æ¢…ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">åŒå±…é•·å¹²é‡Œï¼Œå…©å°ç„¡å«ŒçŒœã€‚</p>
                    </div>
                    
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">åå››ç‚ºå›å©¦ï¼Œç¾é¡æœªå˜—é–‹ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">ä½é ­å‘æš—å£ï¼Œåƒå–šä¸ä¸€å›ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">åäº”å§‹å±•çœ‰ï¼Œé¡˜åŒå¡µèˆ‡ç°ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">å¸¸å­˜æŠ±æŸ±ä¿¡ï¼Œè±ˆä¸Šæœ›å¤«å°ã€‚</p>
                    </div>
                    
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">åå…­å›é è¡Œï¼Œç¿å¡˜ç©æ¾¦å †ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">äº”æœˆä¸å¯è§¸ï¼ŒçŒ¿è²å¤©ä¸Šå“€ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">é–€å‰é²è¡Œè·¡ï¼Œä¸€ä¸€ç”Ÿç¶ è‹”ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">è‹”æ·±ä¸èƒ½æƒï¼Œè½è‘‰ç§‹é¢¨æ—©ã€‚</p>
                    </div>
                    
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">å…«æœˆè´è¶ä¾†ï¼Œé›™é£›è¥¿åœ’è‰ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">æ„Ÿæ­¤å‚·å¦¾å¿ƒï¼Œåæ„ç´…é¡è€ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">æ—©æ™šä¸‹ä¸‰å·´ï¼Œé å°‡æ›¸å ±å®¶ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">ç›¸è¿ä¸é“é ï¼Œç›´è‡³é•·é¢¨æ²™ã€‚</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-b-lg text-center">
                    <button id="close-poem-btn" class="btn-primary px-6 py-2">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æˆåŠŸå®Œæˆå…³å¡æç¤º -->
        <div id="success-toast" class="fixed bottom-24 right-5 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 px-5 py-3 rounded-lg shadow-md hidden animate__animated" style="z-index: 101;">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span id="success-message" class="font-medium">æˆåŠŸå®Œæˆæ’åºï¼</span>
            </div>
        </div>
        
        <!-- æ¸¸æˆå®Œæˆæ¨¡æ€æ¡† -->
        <div id="game-complete-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden animate__animated animate__fadeIn">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 animate__animated animate__zoomIn">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-serif font-bold text-primary-600">
                        <span class="ancient-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                        </span>æ­å–œï¼
                    </h2>
                </div>
                <div class="p-8 text-center">
                    <p class="text-gray-700 dark:text-gray-300 mb-6 text-lg font-medium">æ‚¨å·²å®Œæˆã€Šé•·å¹²è¡Œæ™‚å…‰æ‹¼åœ–ã€‹çš„æ‰€æœ‰é—œå¡ï¼</p>
                    <p class="text-gray-700 dark:text-gray-300 mb-6 leading-relaxed">é€šéé€™å€‹éŠæˆ²ï¼Œæ‚¨ä¸åƒ…è¨˜ä½äº†æç™½çš„ã€Šé•·å¹²è¡Œã€‹ï¼Œé‚„äº†è§£äº†é€™é¦–è©©çš„çµæ§‹å’Œæ™‚é–“åºåˆ—ï¼Œä»¥åŠè©©ä¸­å¥³å­å¾ç«¥å¹´è‡³æˆå¹´çš„å¿ƒå¢ƒè®ŠåŒ–ã€‚</p>
                    <div class="mt-8 flex justify-center space-x-4">
                        <button id="view-complete-poem" class="bg-white dark:bg-gray-900 text-primary-600 rounded-lg border-2 border-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/30 transition-all px-6 py-3 shadow-btn">
                            <span class="ancient-icon">ğŸ“œ</span>æŸ¥çœ‹å®Œæ•´è©©æ–‡
                        </button>
                        <button id="restart-game" class="btn-primary px-6 py-3 shine-effect">
                            <span class="ancient-icon">ğŸ”„</span>é‡æ–°é–‹å§‹
                        </button>
                        <button id="back-to-menu" class="bg-white dark:bg-gray-900 text-primary-600 rounded-lg border-2 border-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/30 transition-all px-6 py-3 shadow-btn">
                            <span class="ancient-icon">ğŸ </span>è¿”å›ä¸»èœå–®
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ­å–œç•«é¢ä¸Šçš„å®Œæ•´è©©æ–‡å½ˆçª— -->
        <div id="congrats-poem-modal" class="fixed inset-0 flex items-center justify-center z-[60] hidden animate__animated animate__fadeIn">
            <div class="absolute inset-0 bg-black bg-opacity-40" id="congrats-poem-backdrop"></div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-3xl mx-4 relative animate__animated animate__zoomIn">
                <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-200">
                        <span class="ancient-icon">ğŸ“œ</span>æç™½ã€Šé•·å¹²è¡Œã€‹
                    </h2>
                    <button id="close-congrats-poem" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="px-5 py-4 flex flex-col items-center justify-center space-y-3">
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">å¦¾é«®åˆè¦†é¡ï¼ŒæŠ˜èŠ±é–€å‰åŠ‡ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">éƒé¨ç«¹é¦¬ä¾†ï¼Œç¹åºŠå¼„é’æ¢…ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">åŒå±…é•·å¹²é‡Œï¼Œå…©å°ç„¡å«ŒçŒœã€‚</p>
                    </div>
                    
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">åå››ç‚ºå›å©¦ï¼Œç¾é¡æœªå˜—é–‹ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">ä½é ­å‘æš—å£ï¼Œåƒå–šä¸ä¸€å›ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">åäº”å§‹å±•çœ‰ï¼Œé¡˜åŒå¡µèˆ‡ç°ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">å¸¸å­˜æŠ±æŸ±ä¿¡ï¼Œè±ˆä¸Šæœ›å¤«å°ã€‚</p>
                    </div>
                    
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">åå…­å›é è¡Œï¼Œç¿å¡˜ç©æ¾¦å †ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">äº”æœˆä¸å¯è§¸ï¼ŒçŒ¿è²å¤©ä¸Šå“€ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">é–€å‰é²è¡Œè·¡ï¼Œä¸€ä¸€ç”Ÿç¶ è‹”ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">è‹”æ·±ä¸èƒ½æƒï¼Œè½è‘‰ç§‹é¢¨æ—©ã€‚</p>
                    </div>
                    
                    <div class="border-l-4 border-primary-600 pl-4 py-2 bg-primary-50 dark:bg-primary-900/30 rounded-r-lg w-full max-w-lg">
                        <p class="font-serif leading-relaxed text-center">å…«æœˆè´è¶ä¾†ï¼Œé›™é£›è¥¿åœ’è‰ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">æ„Ÿæ­¤å‚·å¦¾å¿ƒï¼Œåæ„ç´…é¡è€ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">æ—©æ™šä¸‹ä¸‰å·´ï¼Œé å°‡æ›¸å ±å®¶ã€‚</p>
                        <p class="font-serif leading-relaxed text-center">ç›¸è¿ä¸é“é ï¼Œç›´è‡³é•·é¢¨æ²™ã€‚</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-b-lg text-center">
                    <button id="close-congrats-poem-btn" class="btn-primary px-6 py-2">
                        è¿”å›æ­å–œç•«é¢
                    </button>
                </div>
            </div>
        </div>
        
        <!-- é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º -->
        <div id="error-message" class="error-message hidden"></div>
    </div>

    <script>
        // æ‰“å­—æ©Ÿæ•ˆæœçš„å…¨å±€å˜é‡å’Œå‡½æ•°
        let typewriterTimeout = null;
        const typeWriterSpeed = 70; // èª¿æ•´ç‚ºé©ä¸­çš„æ‰“å­—é€Ÿåº¦
        let isTypingComplete = false; // è·Ÿè¸ªæ‰“å­—æ˜¯å¦å®Œæˆ
        
        // å¢å¼·çš„æ‰“å­—æ©Ÿæ•ˆæœï¼Œæ›´å¥½åœ°è™•ç†HTMLå’Œæ›è¡Œ
        function typeWriter(element, htmlContent, onComplete) {
            // é‡ç½®æ‰“å­—ç‹€æ…‹
            isTypingComplete = false;
            
            if (!element || !htmlContent) {
                console.error("æ‰“å­—æ©Ÿæ•ˆæœåƒæ•¸ç„¡æ•ˆ:", element, htmlContent);
                if (element) element.innerHTML = htmlContent || '';
                isTypingComplete = true;
                if (typeof onComplete === 'function') onComplete();
                return;
            }
            
            try {
                // å‰µå»ºä¸€å€‹è‡¨æ™‚å®¹å™¨ä¾†è§£æHTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                
                // æ¸…ç©ºç›®æ¨™å…ƒç´ 
                element.innerHTML = '';
                
                // å‰µå»ºä¸€å€‹æ–‡æœ¬ç¯€é»æ•¸çµ„
                const nodes = [];
                
                // éæ­¸æ”¶é›†æ‰€æœ‰æ–‡æœ¬ç¯€é»å’ŒHTMLæ¨™ç±¤
                function collectNodes(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        // æ–‡æœ¬ç¯€é»æŒ‰å­—ç¬¦åˆ†å‰²
                        const textChunks = Array.from(node.textContent);
                        nodes.push(...textChunks.map(char => ({
                            type: 'text',
                            content: char
                        })));
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        // HTMLæ¨™ç±¤
                        const tagName = node.tagName.toLowerCase();
                        
                        // èµ·å§‹æ¨™ç±¤
                        const attributes = Array.from(node.attributes)
                            .map(attr => ` ${attr.name}="${attr.value}"`)
                            .join('');
                        nodes.push({
                            type: 'tag',
                            content: `<${tagName}${attributes}>`
                        });
                        
                        // è™•ç†å­ç¯€é»
                        Array.from(node.childNodes).forEach(collectNodes);
                        
                        // çµæŸæ¨™ç±¤
                        nodes.push({
                            type: 'tag',
                            content: `</${tagName}>`
                        });
                    }
                }
                
                // æ”¶é›†æ‰€æœ‰ç¯€é»
                Array.from(tempDiv.childNodes).forEach(collectNodes);
                
                // é€å€‹é¡¯ç¤ºç¯€é»
                let output = '';
                let i = 0;
                
                function showNextNode() {
                    if (i >= nodes.length) {
                        // å®Œæˆæ‰€æœ‰ç¯€é»é¡¯ç¤º
                        isTypingComplete = true;
                        if (typeof onComplete === 'function') {
                            onComplete();
                        }
                        return;
                    }
                    
                    const node = nodes[i++];
                    
                    // æ ¹æ“šç¯€é»é¡å‹è™•ç†
                    if (node.type === 'tag') {
                        // HTMLæ¨™ç±¤ç›´æ¥æ·»åŠ 
                        output += node.content;
                        element.innerHTML = output;
                        // ç«‹å³é¡¯ç¤ºä¸‹ä¸€å€‹
                        showNextNode();
                    } else {
                        // æ–‡æœ¬ç¯€é»ï¼Œçµ±ä¸€é€Ÿåº¦é¡¯ç¤º
                        output += node.content;
                        element.innerHTML = output;
                        typewriterTimeout = setTimeout(showNextNode, typeWriterSpeed);
                    }
                }
                
                // é–‹å§‹é¡¯ç¤º
                if (typewriterTimeout) {
                    clearTimeout(typewriterTimeout);
                    typewriterTimeout = null;
                }
                
                showNextNode();
                
            } catch (error) {
                console.error("æ‰“å­—æ©Ÿæ•ˆæœéŒ¯èª¤:", error);
                // å‡ºéŒ¯æ™‚ç›´æ¥é¡¯ç¤ºå®Œæ•´å…§å®¹
                element.innerHTML = htmlContent;
                isTypingComplete = true;
                if (typeof onComplete === 'function') onComplete();
            }
        }
        
        // æ¸¸æˆæ•°æ®
        const gameData = {
            levels: [
                {
                    id: 1,
                    title: "ç«¥å¹´æ™‚å…‰",
                    description: "è«‹å°‡æè¿°è©©ä¸­å¥³å­ç«¥å¹´æ™‚æœŸçš„è©©å¥æŒ‰ç…§æ­£ç¢ºé †åºæ’åˆ—ã€‚",
                    pieces: [
                        { id: "p1", text: "å¦¾é«®åˆè¦†é¡ï¼ŒæŠ˜èŠ±é–€å‰åŠ‡ã€‚" },
                        { id: "p2", text: "éƒé¨ç«¹é¦¬ä¾†ï¼Œç¹åºŠå¼„é’æ¢…ã€‚" },
                        { id: "p3", text: "åŒå±…é•·å¹²é‡Œï¼Œå…©å°ç„¡å«ŒçŒœã€‚" }
                    ],
                    correctOrder: ["p1", "p2", "p3"],
                    knowledge: `<p>é€™å¹¾å¥æ˜¯æç™½ã€Šé•·å¹²è¡Œã€‹çš„é–‹ç¯‡ï¼Œæè¿°äº†ç”·å¥³ä¸»äººå…¬ç«¥å¹´æ™‚çš„å¤©çœŸç„¡é‚ªã€‚<span class="highlight">ã€Œå¦¾é«®åˆè¦†é¡ã€</span>è¡¨ç¤ºå¥³å­å¹¼æ™‚é ­é«®å‰›é•·åˆ°èƒ½è“‹ä½é¡é ­ï¼Œ<span class="highlight">ã€Œéƒé¨ç«¹é¦¬ä¾†ã€</span>å‰‡æ˜¯<span class="highlight">ã€Œé’æ¢…ç«¹é¦¬ã€</span>å…¸æ•…çš„ä¾†æºã€‚<span class="highlight">ã€Œå…©å°ç„¡å«ŒçŒœã€</span>å‰‡æ˜¯<span class="highlight">ã€Œå…©å°ç„¡çŒœã€</span>æˆèªçš„å‡ºè™•ï¼Œè¡¨ç¤ºå…©å€‹å°å­©å­ä¹‹é–“æ²’æœ‰çŒœå¿Œä¹‹å¿ƒã€‚</p>`,
                    scene: {
                        background: "radial-gradient(circle, #a8e6cf 0%, #dcedc1 100%)",
                        emotion: { label: "å¤©çœŸçˆ›æ¼«", color: "#FFD166" },
                        monologue: "ç«¥å¹´æ™‚å…‰å¦‚åŒæ¸…é¢¨ï¼Œç„¡æ†‚ç„¡æ…®åœ°åœ¨é•·å¹²é‡Œå¬‰æˆ²ç©è€ã€‚é’æ¢…ç«¹é¦¬ï¼Œå¤©çœŸç«¥è¶£ï¼Œæ¯ä¸€å¤©éƒ½å¦‚èŠ±æœµèˆ¬ç¶»æ”¾åœ¨è¨˜æ†¶ä¸­ã€‚"
                    },
                    quiz: {
                        question: "å¾ã€Œå¦¾é«®åˆè¦†é¡ã€åˆ°ã€Œå…©å°ç„¡å«ŒçŒœã€ï¼Œè©©ä¸­å¥³å­å¹¼æ™‚çš„æ€§æ ¼ç‰¹é»æ˜¯ä»€éº¼ï¼Ÿ",
                        options: [
                            { id: "a", text: "æ´»æ½‘å¤©çœŸï¼Œå–œæ­¡èˆ‡äººç©è€" },
                            { id: "b", text: "å®‰éœå…§å‘ï¼Œå–œæ­¡ç¨è™•" },
                            { id: "c", text: "æ†‚é¬±å¤šæ€ï¼Œæ—©ç†Ÿæ•æ„Ÿ" },
                            { id: "d", text: "åš´è‚…èªçœŸï¼Œä¸å–œéŠæˆ²" }
                        ],
                        correctId: "a",
                        explanation: "å¾ã€ŒæŠ˜èŠ±é–€å‰åŠ‡ã€å¯è¦‹å¥³å­æ´»æ½‘æ„›ç©ï¼Œè€Œã€Œå…©å°ç„¡å«ŒçŒœã€å‰‡è¡¨æ˜å¥¹å¤©çœŸå–®ç´”ï¼Œæ²’æœ‰æˆäººä¸–ç•Œçš„çŒœå¿Œå¿ƒç†ã€‚æç™½é€šéé€™æ¨£çš„æå¯«ï¼Œå‹¾å‹’å‡ºäº†ä¸€å€‹æ´»æ½‘å¯æ„›çš„å°å¥³å­©å½¢è±¡ã€‚"
                    }
                },
                {
                    id: 2,
                    title: "æ–°å©šæ™‚æœŸ",
                    description: "è«‹å°‡æè¿°è©©ä¸­å¥³å­å©šå¾ŒåˆæœŸçš„è©©å¥æŒ‰ç…§æ­£ç¢ºé †åºæ’åˆ—ã€‚",
                    pieces: [
                        { id: "p1", text: "åå››ç‚ºå›å©¦ï¼Œç¾é¡æœªå˜—é–‹ã€‚" },
                        { id: "p2", text: "ä½é ­å‘æš—å£ï¼Œåƒå–šä¸ä¸€å›ã€‚" },
                        { id: "p3", text: "åäº”å§‹å±•çœ‰ï¼Œé¡˜åŒå¡µèˆ‡ç°ã€‚" },
                        { id: "p4", text: "å¸¸å­˜æŠ±æŸ±ä¿¡ï¼Œè±ˆä¸Šæœ›å¤«å°ã€‚" }
                    ],
                    correctOrder: ["p1", "p2", "p3", "p4"],
                    knowledge: `<p>é€™å¹¾å¥æè¿°äº†å¥³å­åå››æ­²å«äººæ™‚çš„ç¾æ¾€ï¼Œä»¥åŠåäº”æ­²æ™‚é€æ¼¸é©æ‡‰å©šå§»ç”Ÿæ´»çš„éç¨‹ã€‚<span class="highlight">ã€Œé¡˜åŒå¡µèˆ‡ç°ã€</span>è¡¨ç¤ºé¡˜èˆ‡ä¸ˆå¤«å…±åŒç”Ÿæ´»åˆ°è€ï¼›<span class="highlight">ã€ŒæŠ±æŸ±ä¿¡ã€</span>å…¸å‡ºå°¾ç”ŸæŠ±æŸ±çš„å…¸æ•…ï¼Œè¡¨ç¤ºå …è²çš„ä¿¡å¿µï¼›<span class="highlight">ã€Œæœ›å¤«å°ã€</span>å‰‡æ˜¯å¤ä»£å©¦å¥³æ€å¿µé è¡Œä¸ˆå¤«ï¼Œç™»é«˜çœºæœ›çš„åœ°æ–¹ã€‚è©©ä¸­é€šéã€Œç¾é¡æœªå˜—é–‹ã€å’Œã€Œåäº”å§‹å±•çœ‰ã€çš„å°æ¯”ï¼Œç”Ÿå‹•åœ°åˆ»ç•«äº†å°‘å¥³å¾ç¾æ¾€åˆ°é€æ¼¸æ¥å—å©šå§»çš„å¿ƒç†è®ŠåŒ–éç¨‹ã€‚</p>`,
                    scene: {
                        background: "linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)",
                        emotion: { label: "ç¾æ¾€", color: "#EF767A" },
                        monologue: "åˆç‚ºäººå©¦çš„ç¾æ€¯æ¼¸æ¼¸è¢«å …å®šçš„æƒ…æ„Ÿæ›¿ä»£ï¼Œå¦‚åŒå†°é›ªæ¶ˆèï¼Œå¿ƒä¸­æ¹§å‹•è‘—å°æœªä¾†çš„æœŸè¨±å’Œå°æ„›æƒ…çš„å¿ èª ã€‚"
                    },
                    quiz: {
                        question: "å¾è©©ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¥³å­å¾ç¾æ¾€åˆ°å¦ç„¶çš„å¿ƒç†è®ŠåŒ–ï¼Œåæ˜ äº†å¥¹ä»€éº¼æ¨£çš„æƒ…æ„Ÿç‰¹è³ªï¼Ÿ",
                        options: [
                            { id: "a", text: "å¥½å¥‡å¿ƒèˆ‡å†’éšªç²¾ç¥" },
                            { id: "b", text: "è„†å¼±èˆ‡ä¾è³´æ€§æ ¼" },
                            { id: "c", text: "åŸ·è‘—èˆ‡å°ˆä¸€çš„æ„›æƒ…æ…‹åº¦" },
                            { id: "d", text: "å°å©šå§»çš„æ‡·ç–‘èˆ‡ä¸å®‰" }
                        ],
                        correctId: "c",
                        explanation: "ã€Œé¡˜åŒå¡µèˆ‡ç°ã€è¡¨é”äº†å¥³å­å¸Œæœ›èˆ‡ä¸ˆå¤«å…±åŒç”Ÿæ´»åˆ°è€çš„é¡˜æœ›ï¼Œã€Œå¸¸å­˜æŠ±æŸ±ä¿¡ã€æ›´æ˜¯è¡¨æ˜å¥¹å°æ„›æƒ…çš„å …è²åŸ·è‘—ï¼Œå¦‚å°¾ç”Ÿä¸é›¢ä¿¡è«¾è€ŒæŠ±æŸ±è€Œæ­»ã€‚é€™äº›æå¯«è¡¨æ˜äº†å¤ä»£å¥³å­å°æ„›æƒ…å°ˆä¸€å¿ è²çš„æ…‹åº¦ã€‚"
                    }
                },
                {
                    id: 3,
                    title: "åˆ¥é›¢ä¹‹è‹¦",
                    description: "è«‹å°‡æè¿°è©©ä¸­ä¸ˆå¤«é è¡Œå¾Œå¥³å­æ€å¿µä¹‹æƒ…çš„è©©å¥æŒ‰ç…§æ­£ç¢ºé †åºæ’åˆ—ã€‚",
                    pieces: [
                        { id: "p1", text: "åå…­å›é è¡Œï¼Œç¿å¡˜ç©æ¾¦å †ã€‚" },
                        { id: "p2", text: "äº”æœˆä¸å¯è§¸ï¼ŒçŒ¿è²å¤©ä¸Šå“€ã€‚" },
                        { id: "p3", text: "é–€å‰é²è¡Œè·¡ï¼Œä¸€ä¸€ç”Ÿç¶ è‹”ã€‚" },
                        { id: "p4", text: "è‹”æ·±ä¸èƒ½æƒï¼Œè½è‘‰ç§‹é¢¨æ—©ã€‚" }
                    ],
                    correctOrder: ["p1", "p2", "p3", "p4"],
                    knowledge: `<p>é€™å¹¾å¥æè¿°äº†å¥³å­åå…­æ­²æ™‚ä¸ˆå¤«é è¡Œå¾Œçš„æ€å¿µä¹‹æƒ…ã€‚<span class="highlight">ã€Œç¿å¡˜ç©æ¾¦å †ã€</span>æ˜¯é•·æ±Ÿä¸‰å³½ä¸­ç¿å¡˜å³½çš„éšªç˜ï¼Œ<span class="highlight">ã€ŒçŒ¿è²å¤©ä¸Šå“€ã€</span>è¡¨ç¾äº†ç’°å¢ƒçš„æ·’æ¸…èˆ‡å¥³å­çš„æ„ç·’ã€‚<span class="highlight">ã€Œé–€å‰é²è¡Œè·¡ï¼Œä¸€ä¸€ç”Ÿç¶ è‹”ã€</span>å‰‡è¡¨ç¾äº†æ™‚é–“çš„æµé€å’Œç­‰å¾…çš„æ¼«é•·ã€‚è©©ä¸­é€šéç’°å¢ƒèˆ‡å¿ƒå¢ƒçš„å·§å¦™çµåˆï¼Œæš—ç¤ºäº†å¥³ä¸»äººå…¬ç¨è™•æ™‚å…‰ä¸­çš„å­¤ç¨èˆ‡æ€å¿µã€‚ã€Œè‹”æ·±ä¸èƒ½æƒï¼Œè½è‘‰ç§‹é¢¨æ—©ã€é€²ä¸€æ­¥åŠ å¼·äº†æ™‚å…‰æµé€ã€å­£ç¯€æ›´è¿­çš„æ„Ÿè¦ºï¼Œèˆ‡å¥³å­æŒçºŒä¸è®Šçš„ç­‰å¾…å½¢æˆå¼·çƒˆå°æ¯”ã€‚</p>`,
                    scene: {
                        background: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)",
                        emotion: { label: "æ€å¿µ", color: "#4E8098" },
                        monologue: "æ™‚å…‰åœ¨æ€å¿µä¸­æµé€ï¼Œé€£é–€å‰çš„è¶³è·¡éƒ½æ»‹ç”Ÿäº†é’è‹”ã€‚é‚£çŒ¿å•¼ä¼¼ä¹ä¹Ÿåœ¨ç‚ºæˆ‘çš„å­¤ç¨è€Œå“€é³´ï¼Œä¸€åˆ‡éƒ½èˆ‡æˆ‘çš„å¿ƒå¢ƒç›¸å‘¼æ‡‰ã€‚"
                    },
                    quiz: {
                        question: "è©©ä¸­ã€Œé–€å‰é²è¡Œè·¡ï¼Œä¸€ä¸€ç”Ÿç¶ è‹”ã€å±•ç¾äº†å¥³å­æ€æ¨£çš„æƒ…æ„Ÿï¼Ÿ",
                        options: [
                            { id: "a", text: "ç„¦æ…®å’Œä¸å®‰" },
                            { id: "b", text: "å¸Œæœ›èˆ‡æœŸå¾…" },
                            { id: "c", text: "æ‚²å‚·èˆ‡å­¤ç¨" },
                            { id: "d", text: "ç­‰å¾…èˆ‡æ™‚é–“æµé€çš„æ„Ÿæ…¨" }
                        ],
                        correctId: "d",
                        explanation: "ã€Œé–€å‰é²è¡Œè·¡ï¼Œä¸€ä¸€ç”Ÿç¶ è‹”ã€æ˜¯è©©ä¸­æœ€ç‚ºå‹•äººçš„æ„è±¡ä¹‹ä¸€ï¼Œå¥³å­ç¨è‡ªç­‰å¾…ä¸ˆå¤«æ­¸ä¾†ï¼Œåœ¨é–€å‰è¸±æ­¥ç•™ä¸‹çš„è¶³è·¡å› é•·æ™‚é–“ç„¡äººè¡Œèµ°è€Œé•·æ»¿é’è‹”ï¼Œç”Ÿå‹•åœ°è¡¨ç¾äº†æ™‚é–“çš„æµé€å’Œç­‰å¾…çš„æ¼«é•·ï¼Œä¹Ÿæš—ç¤ºäº†å¥³å­å°ä¸ˆå¤«æ­¸æœŸæ¼«é•·çš„ç„¡å¥ˆèˆ‡æ„Ÿå‚·ã€‚"
                    }
                },
                {
                    id: 4,
                    title: "ç›¸æ€ä¹‹æƒ…",
                    description: "è«‹å°‡æè¿°è©©ä¸­å¥³å­å°ä¸ˆå¤«æ·±åˆ‡æ€å¿µä»¥åŠæœŸç›¼é‡é€¢çš„è©©å¥æŒ‰ç…§æ­£ç¢ºé †åºæ’åˆ—ã€‚",
                    pieces: [
                        { id: "p1", text: "å…«æœˆè´è¶ä¾†ï¼Œé›™é£›è¥¿åœ’è‰ã€‚" },
                        { id: "p2", text: "æ„Ÿæ­¤å‚·å¦¾å¿ƒï¼Œåæ„ç´…é¡è€ã€‚" },
                        { id: "p3", text: "æ—©æ™šä¸‹ä¸‰å·´ï¼Œé å°‡æ›¸å ±å®¶ã€‚" },
                        { id: "p4", text: "ç›¸è¿ä¸é“é ï¼Œç›´è‡³é•·é¢¨æ²™ã€‚" }
                    ],
                    correctOrder: ["p1", "p2", "p3", "p4"],
                    knowledge: `<p>é€™æ˜¯è©©æ­Œçš„æœ€å¾Œéƒ¨åˆ†ï¼Œ<span class="highlight">ã€Œå…«æœˆè´è¶ä¾†ï¼Œé›™é£›è¥¿åœ’è‰ã€</span>ä¸­çš„è´è¶é›™é£›å¼•ç™¼äº†å¥³å­å°è‡ªå·±å­¤ç¨è™•å¢ƒçš„æ„Ÿæ…¨ã€‚<span class="highlight">ã€Œæ„Ÿæ­¤å‚·å¦¾å¿ƒï¼Œåæ„ç´…é¡è€ã€</span>è¡¨é”äº†å› æ€å¿µè€Œæ†‚æ„ï¼Œæ“”å¿ƒé’æ˜¥æ˜“é€ã€‚æœ€å¾Œå››å¥è¡¨é”äº†æœŸç›¼ä¸ˆå¤«æ­¸ä¾†çš„å¿ƒæƒ…ï¼Œ<span class="highlight">ã€Œç›¸è¿ä¸é“é ï¼Œç›´è‡³é•·é¢¨æ²™ã€</span>é«”ç¾äº†å¥³å­å°æ„›æƒ…çš„å¿ è²ï¼Œé¡˜æ„ä¸ç•è·¯é€”é™é å‰å»è¿æ¥ã€‚è©©çš„çµå°¾è™•å¥³ä¸»äººå…¬å¾è¢«å‹•ç­‰å¾…è½‰è®Šç‚ºä¸»å‹•è¿æ¥çš„å¿ƒæ…‹è®ŠåŒ–ï¼Œå±•ç¾äº†å¥¹å…§å¿ƒçš„å …å®šèˆ‡å°æ„›æƒ…çš„åŸ·è‘—è¿½æ±‚ã€‚</p>`,
                    scene: {
                        background: "linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)",
                        emotion: { label: "æœŸç›¼", color: "#9381FF" },
                        monologue: "è´è¶é›™é£›å‹¾èµ·äº†å¿ƒåº•çš„æ€å¿µï¼Œä½†æ¯”èµ·è¢«å‹•åœ°åå®ˆï¼Œæˆ‘æ›´é¡˜æ„ä¸»å‹•å°‹æ‰¾èˆ‡ä½ é‡é€¢çš„æ©Ÿæœƒã€‚ç„¡è«–è·¯é€”å¤šé ï¼Œæˆ‘éƒ½é¡˜æ„èµ°å‘ä½ ã€‚"
                    },
                    quiz: {
                        question: "ã€Œæ—©æ™šä¸‹ä¸‰å·´ï¼Œé å°‡æ›¸å ±å®¶ã€‚ç›¸è¿ä¸é“é ï¼Œç›´è‡³é•·é¢¨æ²™ã€‚ã€åæ˜ äº†è©©ä¸­å¥³å­ä»€éº¼æ¨£çš„å¿ƒç†è®ŠåŒ–ï¼Ÿ",
                        options: [
                            { id: "a", text: "å¾æ‚²å‚·çµ•æœ›åˆ°éº»æœ¨æ¥å—" },
                            { id: "b", text: "å¾è¢«å‹•ç­‰å¾…åˆ°ä¸»å‹•è¿æ¥" },
                            { id: "c", text: "å¾å°‘å¥³æƒ…æ‡·åˆ°æˆç†Ÿå†·éœ" },
                            { id: "d", text: "å¾ç†±çƒˆæœŸå¾…åˆ°ç†æ€§è¦åŠƒ" }
                        ],
                        correctId: "b",
                        explanation: "è©©çš„çµå°¾å››å¥é¡¯ç¤ºäº†å¥³å­å¿ƒç†çš„é‡è¦è®ŠåŒ–ã€‚å‰é¢çš„è©©å¥ä¸­ï¼Œå¥³å­éƒ½æ˜¯è¢«å‹•åœ°ç­‰å¾…ï¼Œä½†åœ¨æœ€å¾Œï¼Œå¥¹è¡¨é”äº†ä¸»å‹•è¿æ¥ä¸ˆå¤«çš„æ±ºå¿ƒï¼Œã€Œç›¸è¿ä¸é“é ï¼Œç›´è‡³é•·é¢¨æ²™ã€å±•ç¾äº†å¥¹ä¸ç•è·¯é€”é™é ï¼Œé¡˜æ„ä¸»å‹•å‰å»è¿æ¥çš„ç©æ¥µæ…‹åº¦ï¼Œé«”ç¾äº†å¥³å­å°æ„›æƒ…çš„åŸ·è‘—å’Œå‹‡æ°£ã€‚"
                    }
                }
            ],
            currentLevel: 0,
            completedLevels: [],
            // æ·»åŠ å­¦ä¹ è¿›åº¦è·Ÿè¸ª
            progress: {
                // æ¯ä¸ªå…³å¡çš„è¿›åº¦ï¼š0=æœªå¼€å§‹ï¼Œ1=å®Œæˆæ’åºï¼Œ2=æŸ¥çœ‹çŸ¥è¯†ç‚¹ï¼Œ3=å®Œæˆå¿ƒå¢ƒæ¢ç´¢
                1: 0,
                2: 0,
                3: 0,
                4: 0
            }
        };

        // å®šä¹‰DOMå…ƒç´ å˜é‡
        let mainMenu, gameView, levelDisplay, levelDescription, poemPieces, poemSequence;
        let checkButton, hintButton, knowledgeTab, knowledgeContent, quizTab, quizQuestion;
        let quizOptions, quizFeedback, submitQuizButton, toExploreButton, nextLevelButton;
        let startGameButton, showInstructionsButton, showPoemButton, showFullPoemButton;
        let viewCompletePoemButton, instructionsModal, closeInstructionsButton, poemModal;
        let closePoemButton, successToast, successMessage, gameCompleteModal, restartGameButton;
        let backToMenuButton, musicButton, tabButtons, errorMessageContainer;
        let progressLineFill, stepCircles, stepLabels;

        // æ¸¸æˆçŠ¶æ€å˜é‡ - æ‹–æ‹½ç›¸å…³
        let isDragging = false;     // æ˜¯å¦è™•æ–¼æ‹–æ‹½ç‹€æ…‹
        let draggedElement = null;  // ç•¶å‰è¢«æ‹–æ‹½çš„å…ƒç´ 
        let dragClone = null;       // æ‹–æ‹½æ™‚çš„å…‹éš†é«”
        let initialMouseX, initialMouseY; // é–‹å§‹æ‹–æ‹½æ™‚é¼ æ¨™ä½ç½®
        let offsetX, offsetY;       // é¼ æ¨™åœ¨å…ƒç´ å…§çš„åç§»
        let dropIndicator = null;   // æ”¾ç½®æŒ‡ç¤ºå™¨
        let emotionChart = null;
        // è§¸æ§é•·æŒ‰æ‹–æ‹½æ§åˆ¶
        let longPressTimer = null;
        let touchStartX = 0;
        let touchStartY = 0;
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯çš„å‡½æ•°
        function showError(message) {
            console.error(message);
            if (errorMessageContainer) {
                errorMessageContainer.textContent = message;
                errorMessageContainer.classList.remove('hidden');
                setTimeout(() => {
                    errorMessageContainer.classList.add('hidden');
                }, 5000);
            }
        }
        
        // éªŒè¯DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
        function validateDomElements() {
            try {
                // åˆ†ç‚ºå¿…è¦å…ƒç´ å’Œéå¿…è¦å…ƒç´ 
                const criticalElements = {
                    'mainMenu': mainMenu,
                    'gameView': gameView
                };
                
                const importantElements = {
                    'knowledgeTab': knowledgeTab,
                    'knowledgeContent': knowledgeContent,
                    'poemPieces': poemPieces,
                    'poemSequence': poemSequence,
                    'checkButton': checkButton,
                    'quizTab': quizTab
                };
                
                const nonCriticalElements = {
                    'toExploreButton': toExploreButton,
                    'nextLevelButton': nextLevelButton,
                    'tabButtons': tabButtons && tabButtons.length > 0
                };
                
                // æª¢æŸ¥é—œéµå…ƒç´  - é€™äº›å¿…é ˆå­˜åœ¨
                let missingCritical = [];
                for (const [name, element] of Object.entries(criticalElements)) {
                    if (!element) {
                        missingCritical.push(name);
                    }
                }
                
                if (missingCritical.length > 0) {
                    showError(`ç¼ºå°‘é—œéµå…ƒç´ ï¼Œç„¡æ³•ç¹¼çºŒ: ${missingCritical.join(', ')}`);
                    return false;
                }
                
                // æª¢æŸ¥é‡è¦å…ƒç´ 
                let missingImportant = [];
                for (const [name, element] of Object.entries(importantElements)) {
                    if (!element) {
                        missingImportant.push(name);
                    }
                }
                
                if (missingImportant.length > 0) {
                    console.warn(`ç¼ºå°‘é‡è¦å…ƒç´ ï¼Œå¯èƒ½å½±éŸ¿åŠŸèƒ½: ${missingImportant.join(', ')}`);
                }
                
                // æª¢æŸ¥éé—œéµå…ƒç´ 
                let missingNonCritical = [];
                for (const [name, element] of Object.entries(nonCriticalElements)) {
                    if (!element) {
                        missingNonCritical.push(name);
                    }
                }
                
                if (missingNonCritical.length > 0) {
                    console.warn(`ç¼ºå°‘éé—œéµå…ƒç´ : ${missingNonCritical.join(', ')}`);
                }
                
                return true;
            } catch (error) {
                console.error("é©—è­‰DOMå…ƒç´ éŒ¯èª¤:", error);
                return false;
            }
        }
        
        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator(step) {
            try {
                // æª¢æŸ¥æ‰€æœ‰éœ€è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!progressLineFill) {
                    console.warn("é€²åº¦ç·šå…ƒç´ ä¸å­˜åœ¨");
                }
                
                if (!stepCircles) {
                    console.warn("æ­¥é©Ÿåœ–ç¤ºå…ƒç´ ä¸å­˜åœ¨");
                    return; // ç„¡æ³•æ›´æ–°æ­¥é©Ÿ
                }
                
                if (!stepLabels || stepLabels.length < 3) {
                    console.warn("æ­¥é©Ÿæ¨™ç±¤å…ƒç´ ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´");
                }
                
                // æ›´æ–°è¿›åº¦æ¡ (å¦‚æœå­˜åœ¨)
                if (progressLineFill) {
                    let fillWidth = "0%";
                    if (step === 1) fillWidth = "0%";
                    else if (step === 2) fillWidth = "50%";
                    else if (step === 3) fillWidth = "100%";
                    
                    progressLineFill.style.width = fillWidth;
                }
                
                // æ›´æ–°æ­¥éª¤çŠ¶æ€
                for (let i = 1; i <= 3; i++) {
                    // æ›´æ–°åœ“åœˆç‹€æ…‹ (å¦‚æœå­˜åœ¨)
                    if (stepCircles && i-1 < stepCircles.length && stepCircles[i-1]) {
                        const circle = stepCircles[i-1];
                        
                        if (i < step) {
                            // å·²å®Œæˆçš„æ­¥éª¤
                            circle.classList.add('completed');
                            circle.classList.remove('active');
                        } else if (i === step) {
                            // å½“å‰æ­¥éª¤
                            circle.classList.add('active');
                            circle.classList.remove('completed');
                        } else {
                            // æœªå®Œæˆçš„æ­¥éª¤
                            circle.classList.remove('active', 'completed');
                        }
                    }
                    
                    // æ›´æ–°æ¨™ç±¤ç‹€æ…‹ (å¦‚æœå­˜åœ¨)
                    if (stepLabels && stepLabels.length >= i && stepLabels[i-1]) {
                        const label = stepLabels[i-1];
                        
                        if (i < step) {
                            // å·²å®Œæˆçš„æ­¥éª¤
                            label.classList.add('completed');
                            label.classList.remove('active');
                        } else if (i === step) {
                            // å½“å‰æ­¥éª¤
                            label.classList.add('active');
                            label.classList.remove('completed');
                        } else {
                            // æœªå®Œæˆçš„æ­¥éª¤
                            label.classList.remove('active', 'completed');
                        }
                    }
                }
            } catch (error) {
                console.error("æ›´æ–°é€²åº¦æŒ‡ç¤ºå™¨éŒ¯èª¤:", error);
            }
        }
        
        // åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨
                initializeDomReferences();
                
                // éªŒè¯DOMå…ƒç´ å­˜åœ¨
                if (!validateDomElements()) {
                    return;
                }
                
                // åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³å¼ºåˆ¶éšè—ä¸‹ä¸€å…³æŒ‰é’®
                if (nextLevelButton) {
                    console.log("åˆå§‹åŒ–æ™‚å¼·åˆ¶éš±è—ä¸‹ä¸€é—œæŒ‰éˆ•");
                    nextLevelButton.style.display = 'none';
                    nextLevelButton.classList.add('hidden');
                    // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„äº‹ä»¶ç›‘å¬å™¨
                    const newBtn = nextLevelButton.cloneNode(true);
                    if (nextLevelButton.parentNode) {
                        nextLevelButton.parentNode.replaceChild(newBtn, nextLevelButton);
                        nextLevelButton = newBtn;
                    }
                } else {
                    console.warn("åˆå§‹åŒ–æ™‚æ‰¾ä¸åˆ°ä¸‹ä¸€é—œæŒ‰éˆ•");
                }
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                setupEventListeners();
                
                // è®¾ç½®æš—é»‘æ¨¡å¼
                setupDarkMode();
                
                console.log("æ¸¸æˆåˆå§‹åŒ–å®Œæˆ");
                
                // åˆå§‹åŒ–å¾Œå†æ¬¡ç¢ºèªä¸‹ä¸€é—œæŒ‰éˆ•éš±è—
                setTimeout(() => {
                    const btn = document.getElementById('next-level-button');
                    if (btn) {
                        btn.style.display = 'none';
                        btn.classList.add('hidden');
                    }
                }, 500);
            } catch (error) {
                console.error("åˆå§‹åŒ–é”™è¯¯:", error);
                showError(`åˆå§‹åŒ–é”™è¯¯: ${error.message}`);
            }
        });
        
        // åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨
        function initializeDomReferences() {
            console.log("åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨...");
            mainMenu = document.getElementById('main-menu');
            gameView = document.getElementById('game-view');
            levelDisplay = document.getElementById('level-display');
            levelDescription = document.getElementById('level-description');
            poemPieces = document.getElementById('poem-pieces');
            poemSequence = document.getElementById('poem-sequence');
            checkButton = document.getElementById('check-button');
            hintButton = document.getElementById('hint-button');
            knowledgeTab = document.getElementById('knowledgeTab');
            knowledgeContent = document.getElementById('knowledge-content');
            quizTab = document.getElementById('quizTab');
            quizQuestion = document.getElementById('quiz-question');
            quizOptions = document.getElementById('quiz-options');
            quizFeedback = document.getElementById('quiz-feedback');
            submitQuizButton = document.getElementById('submit-quiz');
            toExploreButton = document.getElementById('to-explore-button');
            nextLevelButton = document.getElementById('next-level-button');
            startGameButton = document.getElementById('start-game');
            showInstructionsButton = document.getElementById('show-instructions');
            showPoemButton = document.getElementById('show-poem');
            showFullPoemButton = document.getElementById('show-full-poem');
            viewCompletePoemButton = document.getElementById('view-complete-poem');
            instructionsModal = document.getElementById('instructions-modal');
            closeInstructionsButton = document.getElementById('close-instructions');
            poemModal = document.getElementById('poem-modal');
            closePoemButton = document.getElementById('close-poem');
            successToast = document.getElementById('success-toast');
            successMessage = document.getElementById('success-message');
            gameCompleteModal = document.getElementById('game-complete-modal');
            restartGameButton = document.getElementById('restart-game');
            backToMenuButton = document.getElementById('back-to-menu');
            musicButton = document.getElementById('music-button');
            tabButtons = document.querySelectorAll('.tab-button');
            errorMessageContainer = document.getElementById('error-message');
            
            // è·å–è¿›åº¦æŒ‡ç¤ºå™¨å…ƒç´ 
            progressLineFill = document.querySelector('.progress-line-fill');
            
            // é˜²æ­¢stepCirclesä¸­æœ‰nullå€¼
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const step3 = document.getElementById('step-3');
            
            if (step1 && step2 && step3) {
                stepCircles = [step1, step2, step3];
            } else {
                console.warn("æ­¥é©ŸæŒ‡ç¤ºå™¨å…ƒç´ ä¸å®Œæ•´");
                stepCircles = null;
            }
            
            stepLabels = document.querySelectorAll('.step-label');
            if (stepLabels.length === 0) {
                console.warn("æ‰¾ä¸åˆ°æ­¥é©Ÿæ¨™ç±¤");
                stepLabels = null;
            }
            
            // é©—è­‰é—œéµå…ƒç´ 
            const criticalElements = {
                'mainMenu': mainMenu,
                'gameView': gameView,
                'tabButtons': tabButtons && tabButtons.length > 0
            };
            
            for (const [name, element] of Object.entries(criticalElements)) {
                if (!element) {
                    console.error(`é—œéµå…ƒç´  ${name} æœªæ‰¾åˆ°`);
                }
            }
        }

        // æš—é»‘æ¨¡å¼æ£€æµ‹
        function setupDarkMode() {
            try {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®æš—é»‘æ¨¡å¼é”™è¯¯:", error);
            }
        }
        
        // è®¾ç½®æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            try {
                // å¼€å§‹æ¸¸æˆ
                if (startGameButton) {
                    startGameButton.addEventListener('click', () => {
                        if (!mainMenu || !gameView) {
                            showError("æ‰¾ä¸åˆ°ä¸»èœå•æˆ–æ¸¸æˆè§†å›¾å…ƒç´ ");
                            return;
                        }
                        mainMenu.classList.add('hidden');
                        gameView.classList.remove('hidden');
                        loadLevel(1);
                        
                        // æ˜¾ç¤ºæ˜æ˜¾çš„éŸ³ä¹æ§åˆ¶æç¤º
                        setTimeout(() => {
                            showToast('èƒŒæ™¯éŸ³æ¨‚å·²è‡ªå‹•æ’­æ”¾ï¼Œé»æ“Šå³ä¸‹è§’åœ“å½¢éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ•å¯é—œé–‰');
                        }, 1000);
                    });
                }
                
                // åˆ‡æ¢æ ‡ç­¾é¡µ
                if (tabButtons) {
                    tabButtons.forEach(button => {
                        if (button) {
                            button.addEventListener('click', () => {
                                const tabId = button.getAttribute('data-tab');
                                if (!button.disabled && tabId) {
                                    switchTab(tabId);
                                }
                            });
                        }
                    });
                }
                
                // æ˜¾ç¤ºæ¸¸æˆè¯´æ˜
                if (showInstructionsButton && instructionsModal) {
                    showInstructionsButton.addEventListener('click', () => {
                        instructionsModal.classList.remove('hidden');
                    });
                }
                
                // å…³é—­æ¸¸æˆè¯´æ˜
                if (closeInstructionsButton && instructionsModal) {
                    closeInstructionsButton.addEventListener('click', () => {
                        instructionsModal.classList.add('hidden');
                    });
                }
                
                // æ˜¾ç¤ºå®Œæ•´è¯—æ–‡
                if (showPoemButton && poemModal) {
                    showPoemButton.addEventListener('click', () => {
                        poemModal.classList.remove('hidden');
                    });
                }
                
                // æ¸¸æˆä¸­æ˜¾ç¤ºå®Œæ•´è¯—æ–‡
                if (showFullPoemButton && poemModal) {
                    showFullPoemButton.addEventListener('click', () => {
                        poemModal.classList.remove('hidden');
                    });
                }
                
                // æ¸¸æˆå®Œæˆåæ˜¾ç¤ºä¸“ç”¨è¯—æ–‡å¼¹çª—
                if (viewCompletePoemButton) {
                    viewCompletePoemButton.addEventListener('click', () => {
                        // æ‰“å¼€æ­å–œä¸“ç”¨è©©æ–‡å½ˆçª—
                        const congratsPoemModal = document.getElementById('congrats-poem-modal');
                        if (congratsPoemModal) {
                            congratsPoemModal.classList.remove('hidden');
                        }
                    });
                }
                
                // å…³é—­æ­å–œè©©æ–‡å½ˆçª— - X æŒ‰é’®
                const closeCongratsPoemBtn = document.getElementById('close-congrats-poem');
                if (closeCongratsPoemBtn) {
                    closeCongratsPoemBtn.addEventListener('click', () => {
                        const congratsPoemModal = document.getElementById('congrats-poem-modal');
                        if (congratsPoemModal) {
                            congratsPoemModal.classList.add('hidden');
                        }
                    });
                }
                
                // å…³é—­æ­å–œè©©æ–‡å½ˆçª— - è¿”å›æŒ‰é’®
                const closeCongratsPoemButton = document.getElementById('close-congrats-poem-btn');
                if (closeCongratsPoemButton) {
                    closeCongratsPoemButton.addEventListener('click', () => {
                        const congratsPoemModal = document.getElementById('congrats-poem-modal');
                        if (congratsPoemModal) {
                            congratsPoemModal.classList.add('hidden');
                        }
                    });
                }
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­æ­å–œè©©æ–‡å½ˆçª—
                const congratsPoemBackdrop = document.getElementById('congrats-poem-backdrop');
                if (congratsPoemBackdrop) {
                    congratsPoemBackdrop.addEventListener('click', () => {
                        const congratsPoemModal = document.getElementById('congrats-poem-modal');
                        if (congratsPoemModal) {
                            congratsPoemModal.classList.add('hidden');
                        }
                    });
                }
                
                // å…³é—­å®Œæ•´è¯—æ–‡ - XæŒ‰é’®
                if (closePoemButton && poemModal) {
                    closePoemButton.addEventListener('click', () => {
                        poemModal.classList.add('hidden');
                    });
                }
                
                // å…³é—­å®Œæ•´è¯—æ–‡ - åº•éƒ¨å…³é—­æŒ‰é’®
                const closePoemBtn = document.getElementById('close-poem-btn');
                if (closePoemBtn && poemModal) {
                    closePoemBtn.addEventListener('click', () => {
                        poemModal.classList.add('hidden');
                    });
                }
                
                // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­æ¨¡æ€æ¡†
                document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                    if (modal) {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.classList.add('hidden');
                            }
                        });
                    }
                });
                
                // ä»çŸ¥è¯†ç‚¹è¿›å…¥å¿ƒå¢ƒæ¢ç´¢
                if (toExploreButton) {
                    toExploreButton.addEventListener('click', () => {
                        const currentLevelId = gameData.currentLevel;
                        
                        // æ›´æ–°è¿›åº¦
                        if (gameData.progress[currentLevelId] === 1) {
                            gameData.progress[currentLevelId] = 2;
                        }
                        
                        // åˆ‡æ¢åˆ°å¿ƒå¢ƒæ¢ç´¢æ ‡ç­¾
                        switchTab("quizTab");
                        
                        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
                        updateProgressIndicator(3);
                    });
                }
                
                // ä¸‹ä¸€å…³æŒ‰é’® - å®Œæˆå¿ƒå¢ƒæ¢ç´¢åæ˜¾ç¤º
                if (nextLevelButton) {
                    nextLevelButton.addEventListener('click', () => {
                        proceedToNextLevel();
                    });
                }
                
                // é‡æ–°å¼€å§‹æ¸¸æˆ
                if (restartGameButton && gameCompleteModal) {
                    restartGameButton.addEventListener('click', () => {
                        gameCompleteModal.classList.add('hidden');
                        gameData.currentLevel = 0;
                        gameData.completedLevels = [];
                        
                        // é‡ç½®æ‰€æœ‰å…³å¡è¿›åº¦
                        for (let i = 1; i <= gameData.levels.length; i++) {
                            gameData.progress[i] = 0;
                        }
                        
                        loadLevel(1);
                    });
                }
                
                // è¿”å›ä¸»èœå•
                if (backToMenuButton && gameCompleteModal && gameView && mainMenu) {
                    backToMenuButton.addEventListener('click', () => {
                        gameCompleteModal.classList.add('hidden');
                        gameView.classList.add('hidden');
                        mainMenu.classList.remove('hidden');
                    });
                }
                
                // æç¤ºæŒ‰é’®
                if (hintButton) {
                    hintButton.addEventListener('click', () => {
                        showHint();
                    });
                }
                
                // æ£€æŸ¥æ’åº
                if (checkButton) {
                    checkButton.addEventListener('click', () => {
                        checkSequence();
                    });
                }
                
                // éŸ³æ¨‚æŒ‰éˆ• - æ§åˆ¶èƒŒæ™¯éŸ³æ¨‚
                if (musicButton) {
                    const music = document.getElementById('background-music');
                    let isPlaying = false;
                    
                    // æ›´æ–°åˆå§‹æç¤ºæ–‡å­—
                    const tooltip = musicButton.querySelector('.music-tooltip');
                    if (tooltip) {
                        tooltip.innerHTML = `
                            <p class="font-medium mb-2">èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶</p>
                            <p class="mb-2">é»æ“Šå¯é—œé–‰èƒŒæ™¯éŸ³æ¨‚</p>
                        `;
                    }
                    
                    // å˜—è©¦åœ¨é é¢è¼‰å…¥å¾Œç«‹å³æ’­æ”¾éŸ³æ¨‚
                    const playBackgroundMusic = function() {
                        if (!isPlaying) {
                            music.volume = 0.3; // è¨­ç½®é©ç•¶çš„éŸ³é‡
                            music.play().then(() => {
                                isPlaying = true;
                                
                                // æ›´æ–°æŒ‰éˆ•åœ–æ¨™ç‚ºæš«åœåœ–æ¨™
                                const svg = musicButton.querySelector('svg');
                                if (svg) {
                                    svg.innerHTML = `
                                        <rect x="6" y="4" width="4" height="16"></rect>
                                        <rect x="14" y="4" width="4" height="16"></rect>
                                    `;
                                }
                                
                                // æ›´æ–°æç¤ºæ–‡å­—
                                if (tooltip) {
                                    tooltip.innerHTML = `
                                        <p class="font-medium mb-2">èƒŒæ™¯éŸ³æ¨‚å·²é–‹å•Ÿ</p>
                                        <p class="mb-2">é»æ“Šå¯é—œé–‰èƒŒæ™¯éŸ³æ¨‚</p>
                                    `;
                                }
                            }).catch(error => {
                                console.error('éŸ³æ¨‚æ’­æ”¾å¤±æ•—ï¼š', error);
                            });
                        }
                    };
                    
                    // æŒ‰éˆ•é»æ“Šäº‹ä»¶ - åˆ‡æ›éŸ³æ¨‚æ’­æ”¾ç‹€æ…‹
                    musicButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        if (isPlaying) {
                            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå‰‡æš«åœéŸ³æ¨‚
                            music.pause();
                            isPlaying = false;
                            showToast('èƒŒæ™¯éŸ³æ¨‚å·²é—œé–‰');
                            
                            // æ¢å¾©åŸå§‹éŸ³æ¨‚åœ–æ¨™
                            const svg = musicButton.querySelector('svg');
                            if (svg) {
                                svg.innerHTML = `
                                    <path d="M9 18V5l12-2v13"></path>
                                    <circle cx="6" cy="18" r="3"></circle>
                                    <circle cx="18" cy="16" r="3"></circle>
                                `;
                            }
                            
                            // æ›´æ–°æç¤ºæ–‡å­—
                            if (tooltip) {
                                tooltip.innerHTML = `
                                    <p class="font-medium mb-2">èƒŒæ™¯éŸ³æ¨‚å·²é—œé–‰</p>
                                    <p class="mb-2">é»æ“Šé–‹å•ŸèƒŒæ™¯éŸ³æ¨‚</p>
                                `;
                            }
                        } else {
                            // å¦‚æœå·²æš«åœï¼Œå‰‡é–‹å§‹æ’­æ”¾éŸ³æ¨‚
                            playBackgroundMusic();
                            showToast('èƒŒæ™¯éŸ³æ¨‚å·²é–‹å•Ÿ');
                        }
                    });
                    
                    // ç‚ºç”¨æˆ¶äº¤äº’å¾Œçš„éŸ³é »æ’­æ”¾åšæº–å‚™
                    document.addEventListener('click', function() {
                        // é åŠ è¼‰éŸ³é »
                        music.load();
                        // å˜—è©¦æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
                        playBackgroundMusic();
                    }, { once: true });
                    
                    // éŠæˆ²é–‹å§‹æ™‚æ’­æ”¾éŸ³æ¨‚
                    if (startGameButton) {
                        startGameButton.addEventListener('click', function() {
                            playBackgroundMusic();
                        });
                    }
                }
                
                // æäº¤é—®ç­”ç­”æ¡ˆ
                if (submitQuizButton) {
                    submitQuizButton.addEventListener('click', () => {
                        submitQuizAnswer();
                    });
                }
                
                // ESCé”®å…³é—­æ¨¡æ€æ¡†
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (instructionsModal) instructionsModal.classList.add('hidden');
                        if (poemModal) poemModal.classList.add('hidden');
                        if (gameCompleteModal) gameCompleteModal.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("è®¾ç½®äº‹ä»¶ç›‘å¬å™¨é”™è¯¯:", error);
                showError(`è®¾ç½®äº‹ä»¶ç›‘å¬å™¨é”™è¯¯: ${error.message}`);
            }
        }
        
        // å¾¹åº•é‡å¯«ç‰ˆ - é€²å…¥ä¸‹ä¸€é—œ
        function proceedToNextLevel() {
            try {
                // åš´æ ¼æª¢æŸ¥ç•¶å‰é—œå¡ID (ç¢ºä¿æ˜¯æ•¸å­—)
                const currentLevelId = Number(gameData.currentLevel);
                if (isNaN(currentLevelId)) {
                    console.error("ç•¶å‰é—œå¡IDç„¡æ•ˆ:", gameData.currentLevel);
                    alert("é—œå¡IDç„¡æ•ˆï¼Œè«‹åˆ·æ–°é é¢é‡è©¦");
                    return;
                }
                
                // è¨˜éŒ„å…¨é¢çš„èª¿è©¦ä¿¡æ¯
                console.log("==== é€²å…¥ä¸‹ä¸€é—œ - å…¨é¢èª¿è©¦ ====");
                console.log("ç•¶å‰éŠæˆ²ç‹€æ…‹:", {
                    currentLevel: currentLevelId,
                    completedLevels: gameData.completedLevels,
                    progress: gameData.progress
                });
                
                // æª¢æŸ¥ç•¶å‰é—œå¡æ˜¯å¦æœ‰æ•ˆ
                const currentLevel = gameData.levels.find(l => l.id === currentLevelId);
                if (!currentLevel) {
                    console.error(`ç•¶å‰é—œå¡ID ${currentLevelId} åœ¨gameData.levelsä¸­ä¸å­˜åœ¨!`);
                    showError(`ç„¡æ³•è­˜åˆ¥ç•¶å‰é—œå¡ï¼Œè«‹åˆ·æ–°é‡è©¦`);
                    return;
                }
                
                // æ‰“å°è©³ç´°çš„é—œå¡æ•¸æ“š
                console.table(gameData.levels.map(l => ({id: l.id, title: l.title})));
                
                // è¨ˆç®—ä¸‹ä¸€å€‹é—œå¡ID (å›ºå®šåŠ 1)
                // æ­¤è™•é—œå¡IDæ‡‰å¾1, 2, 3, 4...é †åºéå¢
                const nextLevelId = currentLevelId + 1;
                console.log(`è¨ˆç®—ä¸‹ä¸€é—œ: ${currentLevelId} -> ${nextLevelId}`);
                
                // ç¢ºèªä¸‹ä¸€é—œæ˜¯å¦å­˜åœ¨
                const nextLevel = gameData.levels.find(l => l.id === nextLevelId);
                if (!nextLevel) {
                    if (nextLevelId > gameData.levels.length) {
                        console.log(`å·²åˆ°é”æœ€çµ‚é—œå¡ï¼Œç„¡æ³•ç¹¼çºŒ (å˜—è©¦é€²å…¥ç¬¬${nextLevelId}é—œ)`);
                        showToast("å·²ç¶“æ˜¯æœ€å¾Œä¸€é—œï¼");
                        return;
                    } else {
                        console.error(`åš´é‡éŒ¯èª¤: IDç‚º${nextLevelId}çš„é—œå¡åœ¨æ•¸æ“šä¸­ä¸å­˜åœ¨!`);
                        console.log("é—œå¡æ•¸æ“š:", JSON.stringify(gameData.levels));
                        alert(`ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç¬¬${nextLevelId}é—œ`);
                        return;
                    }
                }
                
                // é¡¯ç¤ºå°‡è¦è¼‰å…¥çš„é—œå¡
                console.log(`æº–å‚™è¼‰å…¥ç¬¬${nextLevelId}é—œ: "${nextLevel.title}"`);
                
                // ç¢ºä¿æ­£ç¢ºè¨­ç½®nextLevelButtonçš„è¡Œç‚º
                const nextLevelButton = document.getElementById('next-level-button');
                if (nextLevelButton) {
                    // å…ˆç§»é™¤æ‰€æœ‰ç¾æœ‰äº‹ä»¶ç›£è½å™¨
                    nextLevelButton.replaceWith(nextLevelButton.cloneNode(true));
                    
                    // æ›´æ–°éŠæˆ²ç‹€æ…‹å‰ç¢ºä¿æŒ‰éˆ•éš±è—
                    nextLevelButton.style.display = 'none';
                }
                
                // å…ˆæ›´æ–°éŠæˆ²ç‹€æ…‹ï¼Œç¢ºä¿ç‹€æ…‹ä¸€è‡´
                gameData.currentLevel = nextLevelId;
                console.log(`éŠæˆ²ç‹€æ…‹å·²æ›´æ–°: currentLevel = ${gameData.currentLevel}`);
                
                // ç„¶å¾ŒåŠ è¼‰æ–°é—œå¡
                console.log(`æ­£åœ¨èª¿ç”¨loadLevel(${nextLevelId})åŠ è¼‰é—œå¡...`);
                setTimeout(() => { // çŸ­æš«å»¶é²ç¢ºä¿ç‹€æ…‹å·²æ›´æ–°
                    loadLevel(nextLevelId);
                    
                    // ç¢ºèªåŠ è¼‰å¾Œçš„ç‹€æ…‹
                    setTimeout(() => {
                        console.log(`é—œå¡åŠ è¼‰å®Œæˆï¼Œç•¶å‰é—œå¡ID: ${gameData.currentLevel}`);
                        if (gameData.currentLevel !== nextLevelId) {
                            console.error("è­¦å‘Š: é—œå¡åŠ è¼‰å¾ŒIDä¸ä¸€è‡´!");
                        }
                    }, 100);
                }, 10);
                
            } catch (error) {
                console.error("é€²å…¥ä¸‹ä¸€é—œæ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤:", error);
                alert(`é€²å…¥ä¸‹ä¸€é—œæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }
        
        // å¤„ç†å…³å¡é€‰æ‹©
        function loadLevel(levelId) {
            try {
                // æ‰¾åˆ°å…³å¡æ•°æ®
                const level = gameData.levels.find(level => level.id === levelId);
                if (!level) {
                    showError(`æ‰¾ä¸åˆ°å…³å¡${levelId}`);
                    return;
                }
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                gameData.currentLevel = levelId;
                
                // é‡ç½®å…³å¡è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœæ˜¯æ–°å…³å¡ï¼‰
                if (gameData.progress[levelId] === 0) {
                    updateProgressIndicator(1);
                }
                
                // æ›´æ–°ç•Œé¢
                if (levelDisplay) levelDisplay.textContent = `${level.id} / ${gameData.levels.length} - ${level.title}`;
                if (levelDescription) levelDescription.textContent = level.description;
                
                // æ¸…ç©ºè¯—å¥åŒºåŸŸ
                if (poemPieces) poemPieces.innerHTML = '';
                if (poemSequence) poemSequence.innerHTML = '';
                
                // åˆ›å»ºæ‰“å­—æœºæ•ˆæœçš„å‡½æ•°å’Œå˜é‡
                const typeWriterSpeed = 40; // æ‰“å­—é€Ÿåº¦ï¼Œæ•°å€¼è¶Šå°è¶Šå¿«
                let typewriterTimeout = null;
                
                function typeWriter(element, text, i = 0) {
                    if (typewriterTimeout) {
                        clearTimeout(typewriterTimeout);
                    }
                    
                    if (i < text.length) {
                        element.innerHTML = text.substring(0, i + 1);
                        typewriterTimeout = setTimeout(() => {
                            typeWriter(element, text, i + 1);
                        }, typeWriterSpeed);
                    }
                }
                
                // é¢„å¡«çŸ¥è¯†ç‚¹å†…å®¹ (ç¡®ä¿å†…å®¹å§‹ç»ˆå­˜åœ¨ï¼Œä½†ä¸ç«‹å³æ˜¾ç¤º)
                if (knowledgeContent) {
                    // å…ˆä¿å­˜çŸ¥è¯†ç‚¹å†…å®¹ï¼Œä½†ä¸ç«‹å³æ˜¾ç¤º
                    knowledgeContent.setAttribute('data-content', level.knowledge);
                    knowledgeContent.innerHTML = '';
                    
                    // ç«‹å³è¨˜éŒ„ä¸‹ä¾†ï¼Œç¢ºä¿å¾ŒçºŒèƒ½æ‰¾åˆ°
                    console.log("çŸ¥è­˜é»å…§å®¹å·²ä¿å­˜:", knowledgeContent.getAttribute('data-content'));
                }
                
                // é¢„å…ˆå¡«å……é—®ç­”åŒºåŸŸ
                if (quizQuestion) quizQuestion.textContent = level.quiz.question;
                if (quizOptions) {
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    quizOptions.innerHTML = '';
                    
                    // é‡ç½®åé¦ˆåŒºåŸŸå’Œä¸‹ä¸€å…³æŒ‰é’®
                    if (quizFeedback) {
                        quizFeedback.classList.add('hidden');
                        quizFeedback.innerHTML = '';
                    }
                    
                    // ä¸ç®¡å…³å¡çŠ¶æ€å¦‚ä½•ï¼Œéƒ½å¼ºåˆ¶éšè—ä¸‹ä¸€å…³æŒ‰é’®
                    if (nextLevelButton) {
                        nextLevelButton.style.display = 'none';
                        nextLevelButton.classList.add('hidden');
                    }
                    
                    // åˆ›å»ºæ–°é€‰é¡¹
                    level.quiz.options.forEach(option => {
                        const optionElement = document.createElement('div');
                        optionElement.className = 'quiz-option p-4 bg-white dark:bg-gray-800 rounded-md shadow-elegant border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 cursor-pointer hover:shadow-hover transition-all';
                        optionElement.setAttribute('data-id', option.id);
                        optionElement.innerHTML = `<span class="font-medium">${option.id.toUpperCase()}.</span> ${option.text}`;
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ - ç¡®ä¿æ¯æ¬¡ç‚¹å‡»éƒ½å¼ºåˆ¶éšè—ä¸‹ä¸€å…³æŒ‰é’®
                        optionElement.addEventListener('click', () => {
                            // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                            document.querySelectorAll('.quiz-option').forEach(el => {
                                if (el) {
                                    el.classList.remove('selected');
                                    el.classList.remove('animate__animated');
                                    el.classList.remove('animate__pulse');
                                }
                            });
                            
                            // æ·»åŠ é€‰ä¸­çŠ¶æ€å’ŒåŠ¨ç”»æ•ˆæœ
                            optionElement.classList.add('selected');
                            optionElement.classList.add('animate__animated');
                            optionElement.classList.add('animate__pulse');
                            
                            // ç¡®ä¿é€‰æ‹©é€‰é¡¹æ—¶éšè—"ä¸‹ä¸€å…³"æŒ‰é’® - è¿™æ˜¯å…³é”®æ­¥éª¤
                            if (nextLevelButton) {
                                console.log("ç‚¹å‡»é€‰é¡¹ï¼Œå¼ºåˆ¶éšè—ä¸‹ä¸€å…³æŒ‰é’®");
                                nextLevelButton.style.display = 'none';
                                nextLevelButton.classList.add('hidden');
                            }
                            
                            // ä¹Ÿéšè—åé¦ˆåŒºåŸŸï¼Œå¼ºåˆ¶ç”¨æˆ·ç‚¹å‡»ç¡®è®¤æŒ‰é’®
                            if (quizFeedback) {
                                quizFeedback.classList.add('hidden');
                            }
                        });
                        
                        quizOptions.appendChild(optionElement);
                    });
                    
                    // é‡è¦ï¼šåŠ è½½å…³å¡æ—¶ï¼Œç¡®ä¿æ‰€æœ‰é€‰é¡¹éƒ½æ˜¯æœªé€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.quiz-option').forEach(el => {
                        if (el) {
                            el.classList.remove('selected');
                            el.style.borderColor = '';
                            el.style.backgroundColor = '';
                        }
                    });
                }
                
                // éšè—é—®ç­”åé¦ˆ
                if (quizFeedback) quizFeedback.classList.add('hidden');
                
                // å§‹ç»ˆéšè—ä¸‹ä¸€å…³æŒ‰é’®ï¼Œå°¤å…¶å¯¹äºç¬¬å››å…³
                if (nextLevelButton) {
                    nextLevelButton.classList.add('hidden');
                    nextLevelButton.style.display = 'none';
                }
                
                // æ ¹æ®è¿›åº¦è®¾ç½®ç•Œé¢çŠ¶æ€
                const levelProgress = gameData.progress[levelId] || 0;
                if (levelProgress === 0) {
                    // æ–°å…³å¡ï¼šåªå¯ç”¨æ’åºæ ‡ç­¾
                    updateTabsAvailability(false);
                    switchTab("puzzleTab");
                } else {
                    // ä¹‹å‰å®Œæˆè¿‡çš„å…³å¡ï¼šå¯ç”¨æ‰€æœ‰æ ‡ç­¾
                    updateTabsAvailability(true);
                    
                    // æ ¹æ®è¿›åº¦æ›´æ–°æ˜¾ç¤º
                    if (levelProgress === 1) {
                        // å·²å®Œæˆæ’åºï¼Œæœªçœ‹çŸ¥è¯†ç‚¹
                        updateProgressIndicator(2);
                        switchTab("knowledgeTab");
                    } else if (levelProgress === 2) {
                        // å·²çœ‹çŸ¥è¯†ç‚¹ï¼Œæœªå®Œæˆå¿ƒå¢ƒæ¢ç´¢
                        updateProgressIndicator(3);
                        switchTab("quizTab");
                    } else if (levelProgress === 3) {
                        // å·²å®Œæˆæ‰€æœ‰å†…å®¹
                        updateProgressIndicator(3);
                        
                        // ä¿®æ”¹ï¼šä¸åœ¨é—œå¡è¼‰å…¥æ™‚é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•ï¼Œç¢ºä¿åªæœ‰åœ¨ç”¨æˆ¶ç¢ºèªç­”æ¡ˆå¾Œæ‰é¡¯ç¤º
                        // å³ä½¿é—œå¡å·²å®Œæˆï¼Œä¹Ÿçµ±ä¸€éš±è—æŒ‰éˆ•
                        if (nextLevelButton) {
                            nextLevelButton.style.display = 'none';
                            nextLevelButton.classList.add('hidden');
                        }
                        
                        switchTab("quizTab");
                    }
                }
                
                // åœ¨æœ€åä¸€å…³æˆåŠŸåæ˜¾ç¤ºå®Œæ•´è¯—æ–‡æŒ‰é’®
                if (showFullPoemButton) {
                    if (gameData.completedLevels.length === gameData.levels.length) {
                        showFullPoemButton.classList.remove('hidden');
                    } else {
                        showFullPoemButton.classList.add('hidden');
                    }
                }
                
                // æ›´æ–°åœºæ™¯
                updateScene(level.scene);
                
                // æ›´æ–°æƒ…æ„Ÿå›¾è¡¨
                updateEmotionChart(levelId - 1);
                
                // æ‰“ä¹±è¯—å¥é¡ºåºå¹¶åŠ è½½
                if (poemPieces) {
                    const shuffledPieces = [...level.pieces].sort(() => Math.random() - 0.5);
                    
                    // æ ¹æ®è¯—å¥æ•°é‡å†³å®šå¸ƒå±€
                    poemPieces.classList.add('poem-grid');
                    
                    shuffledPieces.forEach(piece => {
                        const pieceElement = createPoemPiece(piece);
                        poemPieces.appendChild(pieceElement);
                    });
                }
                
                // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                setupDragAndDrop();
            } catch (error) {
                console.error("åŠ è½½å…³å¡é”™è¯¯:", error);
                showError(`åŠ è½½å…³å¡é”™è¯¯: ${error.message}`);
            }
        }
        
        // æ›´æ–°æ ‡ç­¾å¯ç”¨æ€§
        function updateTabsAvailability(isCompleted) {
            try {
                // å›¾æ ‡
                const checkIcon = `<span class="achievement-badge ${isCompleted ? 'show' : ''}">âœ“</span>`;
                
                if (!tabButtons) {
                    showError("æ‰¾ä¸åˆ°æ ‡ç­¾æŒ‰é’®å…ƒç´ ");
                    return;
                }
                
                tabButtons.forEach(btn => {
                    if (!btn) return;
                    
                    const tabId = btn.getAttribute('data-tab');
                    if (!tabId) return;
                    
                    // é¦–å…ˆç§»é™¤ä¹‹å‰å¯èƒ½æ·»åŠ çš„æˆå°±æ ‡è®°
                    const existingBadge = btn.querySelector('.achievement-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    if (isCompleted) {
                        // å¯ç”¨æ‰€æœ‰æ ‡ç­¾
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                        btn.classList.remove('cursor-not-allowed');
                        
                        // æ·»åŠ æˆå°±æ ‡è®°åˆ°æ¯ä¸ªæ ‡ç­¾
                        if (tabId !== 'puzzleTab') {
                            btn.style.position = 'relative';
                            btn.insertAdjacentHTML('beforeend', checkIcon);
                        }
                    } else {
                        // åªå¯ç”¨æ‹¼å›¾æ ‡ç­¾ï¼Œç¦ç”¨å…¶ä»–æ ‡ç­¾
                        if (tabId !== 'puzzleTab') {
                            btn.disabled = true;
                            btn.classList.add('opacity-50');
                            btn.classList.add('cursor-not-allowed');
                        } else {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50');
                            btn.classList.remove('cursor-not-allowed');
                        }
                    }
                });
            } catch (error) {
                console.error("æ›´æ–°æ ‡ç­¾å¯ç”¨æ€§é”™è¯¯:", error);
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabId) {
            try {
                console.log("åˆ‡æ¢åˆ°æ ‡ç­¾:", tabId);
                
                if (!tabId) {
                    showError("ç„¡æ•ˆçš„æ¨™ç±¤ID");
                    return;
                }
                
                // æ¯æ¬¡åˆ‡æ›æ¨™ç±¤æ™‚éƒ½ç¢ºä¿ä¸‹ä¸€é—œæŒ‰éˆ•éš±è—
                if (nextLevelButton) {
                    nextLevelButton.style.display = 'none';
                    nextLevelButton.classList.add('hidden');
                    console.log("åˆ‡æ›æ¨™ç±¤æ™‚éš±è—ä¸‹ä¸€é—œæŒ‰éˆ•");
                }
                
                // å¦‚æœåˆ‡æ›åˆ°å¿ƒå¢ƒæ¢ç´¢æ¨™ç±¤é ï¼Œæ¸…é™¤æ‰€æœ‰é¸é …çš„é¸æ“‡ç‹€æ…‹
                if (tabId === 'quizTab') {
                    document.querySelectorAll('.quiz-option').forEach(el => {
                        if (el) {
                            el.classList.remove('selected');
                            el.style.borderColor = '';
                            el.style.backgroundColor = '';
                        }
                    });
                    
                    // éš±è—åé¥‹å€åŸŸ
                    if (quizFeedback) {
                        quizFeedback.classList.add('hidden');
                    }
                }
                
                // æª¢æŸ¥æ¨™ç±¤æŒ‰éˆ•æ˜¯å¦å­˜åœ¨
                if (!tabButtons || tabButtons.length === 0) {
                    console.warn("æ‰¾ä¸åˆ°æ¨™ç±¤æŒ‰éˆ•å…ƒç´ ");
                } else {
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(btn => {
                        if (!btn) return;
                        
                        try {
                            btn.classList.remove('active');
                            btn.classList.remove('bg-primary-600');
                            btn.classList.remove('text-white');
                            btn.classList.add('border-gray-200');
                            btn.classList.add('text-gray-600');
                            btn.classList.add('dark:border-gray-700');
                            btn.classList.add('dark:text-gray-400');
                        } catch (e) {
                            console.warn("ç„¡æ³•ä¿®æ”¹æ¨™ç±¤æŒ‰éˆ•æ¨£å¼:", e);
                        }
                    });
                    
                    // æ·»åŠ å½“å‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                    const activeTab = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
                    if (activeTab) {
                        try {
                            activeTab.classList.add('active');
                            activeTab.classList.add('bg-primary-600');
                            activeTab.classList.add('text-white');
                            activeTab.classList.remove('border-gray-200');
                            activeTab.classList.remove('text-gray-600');
                            activeTab.classList.remove('dark:border-gray-700');
                            activeTab.classList.remove('dark:text-gray-400');
                        } catch (e) {
                            console.warn("ç„¡æ³•è¨­ç½®æ´»å‹•æ¨™ç±¤æ¨£å¼:", e);
                        }
                    } else {
                        console.warn(`æ‰¾ä¸åˆ°æ¨™ç±¤æŒ‰éˆ•: ${tabId}`);
                    }
                }
                
                // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
                const tabContainers = document.querySelectorAll('.tab-container');
                if (!tabContainers || tabContainers.length === 0) {
                    console.warn("æ‰¾ä¸åˆ°æ¨™ç±¤å…§å®¹å®¹å™¨å…ƒç´ ");
                } else {
                    tabContainers.forEach(container => {
                        if (!container) return;
                        
                        try {
                            container.classList.remove('active');
                            container.classList.remove('animate__animated');
                            container.classList.remove('animate__fadeIn');
                            container.style.display = 'none'; // ç¡®ä¿ç›´æ¥éšè—
                        } catch (e) {
                            console.warn("ç„¡æ³•éš±è—æ¨™ç±¤å…§å®¹:", e);
                        }
                    });
                }
                
                // æ˜¾ç¤ºç›¸å…³çš„å†…å®¹åŒºåŸŸ
                const tabContent = document.getElementById(tabId);
                if (!tabContent) {
                    console.warn(`æ‰¾ä¸åˆ°æ¨™ç±¤å…§å®¹: ${tabId}`);
                    return;
                }
                
                try {
                    tabContent.classList.add('active');
                    tabContent.classList.add('animate__animated');
                    tabContent.classList.add('animate__fadeIn');
                    tabContent.classList.add('animate__faster');
                    tabContent.style.display = 'block'; // ç¡®ä¿ç›´æ¥æ˜¾ç¤º
                } catch (e) {
                    console.warn("ç„¡æ³•é¡¯ç¤ºæ¨™ç±¤å…§å®¹:", e);
                    
                    // å˜—è©¦æœ€åŸºæœ¬çš„é¡¯ç¤ºæ–¹å¼
                    try {
                        tabContent.style.display = 'block';
                    } catch (e2) {
                        console.error("ç„¡æ³•é¡¯ç¤ºæ¨™ç±¤å…§å®¹ï¼Œå³ä½¿ä½¿ç”¨åŸºæœ¬æ–¹å¼:", e2);
                    }
                }
                
                // ç¡®ä¿åˆ‡æ¢åˆ°çŸ¥è¯†ç‚¹æ ‡ç­¾æ—¶å†…å®¹æ­£ç¡®æ˜¾ç¤ºï¼Œå¹¶ä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
                if (tabId === 'knowledgeTab') {
                    if (!knowledgeContent) {
                        console.warn("æ‰¾ä¸åˆ°çŸ¥è­˜é»å…§å®¹å…ƒç´ ");
                    } else {
                        const level = gameData.levels.find(level => level.id === gameData.currentLevel);
                        if (level) {
                            try {
                                // å…ˆæ¸…ç©ºå†…å®¹å¹¶éšè—æ¢ç´¢æŒ‰é’®
                                knowledgeContent.innerHTML = '';
                                if (toExploreButton) {
                                    toExploreButton.style.display = 'none';
                                }
                                
                                console.log("æº–å‚™å•Ÿå‹•æ‰“å­—æ©Ÿæ•ˆæœ...");
                                
                                // è·å–ä¿å­˜çš„çŸ¥è¯†ç‚¹å†…å®¹
                                const savedContent = knowledgeContent.getAttribute('data-content') || level.knowledge;
                                
                                console.log("çŸ¥è­˜é»å…§å®¹:", savedContent ? savedContent.substring(0, 50) + "..." : "æœªæ‰¾åˆ°å…§å®¹");
                                
                                // ä½¿ç”¨å…¨å±€æ‰“å­—æœºå‡½æ•°ï¼Œæ·»åŠ å®Œæˆå›è°ƒæ¥æ˜¾ç¤ºæŒ‰é’®
                                window.setTimeout(() => {
                                    console.log("é–‹å§‹æ‰“å­—æ©Ÿæ•ˆæœ");
                                    typeWriter(knowledgeContent, savedContent, () => {
                                        // æ‰“å­—æœºæ•ˆæœå®Œæˆåæ˜¾ç¤ºæ¢ç´¢æŒ‰é’®
                                        console.log("æ‰“å­—æ©Ÿæ•ˆæœå®Œæˆï¼Œé¡¯ç¤ºæ¢ç´¢æŒ‰éˆ•");
                                        if (toExploreButton) {
                                            toExploreButton.style.display = 'block';
                                            toExploreButton.classList.add('animate__animated', 'animate__fadeIn');
                                        }
                                    });
                                }, 100);
                            } catch (e) {
                                console.warn("ç„¡æ³•è¨­ç½®çŸ¥è­˜é»å…§å®¹:", e);
                                // å‡ºé”™æ—¶ç›´æ¥æ˜¾ç¤ºå†…å®¹å’ŒæŒ‰é’®
                                try {
                                    knowledgeContent.innerHTML = level.knowledge;
                                    if (toExploreButton) {
                                        toExploreButton.style.display = 'block';
                                    }
                                } catch (err) {
                                    console.error("ç›´æ¥é¡¯ç¤ºçŸ¥è­˜é»å…§å®¹ä¹Ÿå¤±æ•—:", err);
                                }
                            }
                        } else {
                            console.warn("æ‰¾ä¸åˆ°ç•¶å‰é—œå¡æ•¸æ“š");
                        }
                    }
                }
            } catch (error) {
                console.error("åˆ‡æ›æ¨™ç±¤éŒ¯èª¤:", error);
                showError(`åˆ‡æ›æ¨™ç±¤éŒ¯èª¤: ${error.message}`);
            }
        }
        
        // æ›´æ–°åœºæ™¯
        function updateScene(scene) {
            try {
                const sceneIllustration = document.getElementById('scene-illustration');
                const emotionBadge = document.getElementById('emotion-badge');
                const characterMonologue = document.getElementById('character-monologue');
                
                // è®¾ç½®èƒŒæ™¯
                if(sceneIllustration) {
                    sceneIllustration.style.background = scene.background;
                }
                
                // è®¾ç½®æƒ…æ„Ÿå¾½ç« 
                if(emotionBadge) {
                    emotionBadge.textContent = scene.emotion.label;
                    emotionBadge.style.backgroundColor = scene.emotion.color;
                }
                
                // è®¾ç½®ç‹¬ç™½
                if(characterMonologue) {
                    characterMonologue.textContent = scene.monologue;
                }
            } catch (error) {
                console.error("æ›´æ–°åœºæ™¯é”™è¯¯:", error);
            }
        }
        
        // æƒ…æ„Ÿæ›²çº¿æ•°æ®
        const emotionData = {
            labels: ['ç«¥å¹´æ™‚å…‰', 'æ–°å©šæ™‚æœŸ', 'åˆ¥é›¢ä¹‹è‹¦', 'ç›¸æ€ä¹‹æƒ…'],
            datasets: [
                {
                    label: 'å¤©çœŸçˆ›æ¼«',
                    data: [100, 40, 10, 5],
                    borderColor: '#FFD166',
                    backgroundColor: 'rgba(255, 209, 102, 0.3)',
                    borderWidth: 2,
                    hoverBorderWidth: 3,
                },
                {
                    label: 'ç¾æ¾€',
                    data: [20, 100, 50, 30],
                    borderColor: '#EF767A',
                    backgroundColor: 'rgba(239, 118, 122, 0.3)',
                    borderWidth: 2,
                    hoverBorderWidth: 3,
                },
                {
                    label: 'æ€å¿µ',
                    data: [0, 30, 100, 85],
                    borderColor: '#4E8098',
                    backgroundColor: 'rgba(78, 128, 152, 0.3)',
                    borderWidth: 2,
                    hoverBorderWidth: 3,
                },
                {
                    label: 'æœŸç›¼',
                    data: [10, 40, 60, 100],
                    borderColor: '#9381FF',
                    backgroundColor: 'rgba(147, 129, 255, 0.3)',
                    borderWidth: 2,
                    hoverBorderWidth: 3,
                }
            ]
        };
        
        // æ›´æ–°æƒ…æ„Ÿå›¾è¡¨
        function updateEmotionChart(levelIndex) {
            try {
                // è·å–å›¾è¡¨å®¹å™¨
                const chartCanvas = document.getElementById('emotion-chart');
                const chartContainer = document.querySelector('.emotion-chart-container');
                
                if(!chartCanvas) {
                    console.log("æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨");
                    return;
                }
                
                // å…ˆæ·»åŠ æ·¡å‡ºæ•ˆæœ
                if (chartContainer) {
                    chartContainer.classList.add('animate__animated', 'animate__fadeOut');
                    chartContainer.style.animationDuration = '0.3s';
                }
                
                // çŸ­æš«å»¶é²å¾Œé‡æ–°å‰µå»ºåœ–è¡¨
                setTimeout(() => {
                    const ctx = chartCanvas.getContext('2d');
                    
                    // ç¡®ä¿å½»åº•é”€æ¯ç°æœ‰å›¾è¡¨
                    if (emotionChart) {
                        emotionChart.destroy();
                    }
                    
                    // ç§»é™¤èˆŠçš„å‹•ç•«æ•ˆæœä¸¦æº–å‚™æ·»åŠ æ–°çš„
                    if (chartContainer) {
                        chartContainer.classList.remove('animate__animated', 'animate__fadeOut', 'animate__fadeIn');
                    }
                    
                    // è®¡ç®—ä¸åŒæƒ…æ„Ÿåœ¨æ­¤å…³å¡çš„å¼ºåº¦
                    const dataForCurrentLevel = emotionData.datasets.map(dataset => ({
                        label: dataset.label,
                        data: [dataset.data[levelIndex]],
                        backgroundColor: dataset.backgroundColor,
                        borderColor: dataset.borderColor,
                        borderWidth: dataset.borderWidth,
                        hoverBorderWidth: dataset.hoverBorderWidth,
                        borderRadius: 4,
                        hoverBorderRadius: 6
                    }));
                    
                    // åˆ›å»ºæ¨ªå‘æ¡å½¢å›¾ - ç¡®ä¿æ¯æ¬¡éƒ½æœ‰å®Œæ•´åŠ¨ç”»æ•ˆæœ
                    emotionChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [''],  // ä½¿ç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£"æƒ…æ„Ÿå¼·åº¦"
                            datasets: dataForCurrentLevel
                        },
                        options: {
                            indexAxis: 'y',
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 10
                                        },
                                        callback: function(value) {
                                            return value + '%';  // æ·»åŠ ç™¾åˆ†æ¯”ç¬¦è™Ÿ
                                        }
                                    }
                                },
                                y: {
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 11,
                                            family: "'Noto Serif TC', serif"
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'center',
                                    labels: {
                                        usePointStyle: true,
                                        boxWidth: 12,
                                        padding: 12,
                                        font: {
                                            size: 12,
                                            family: "'Noto Sans TC', sans-serif"
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.raw}%`;
                                        }
                                    },
                                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                                    titleFont: {
                                        size: 13,
                                        family: "'Noto Sans TC', sans-serif",
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12,
                                        family: "'Noto Sans TC', sans-serif"
                                    },
                                    padding: 10,
                                    cornerRadius: 4,
                                    displayColors: true
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeOutQuart',
                                delay: 100 // æ·»åŠ å»¶é²ç¢ºä¿å‹•ç•«æ›´æ˜é¡¯
                            },
                            hover: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    });
                    
                    // åœ–è¡¨å‰µå»ºå¾Œæ·»åŠ æ·¡å…¥æ•ˆæœ
                    if (chartContainer) {
                        chartContainer.classList.add('animate__animated', 'animate__fadeIn');
                        chartContainer.style.animationDuration = '0.8s';
                        chartContainer.style.animationDelay = '0.1s';
                    }
                    
                }, 350); // ç­‰å¾…æ·¡å‡ºæ•ˆæœå®Œæˆå¾Œå†å‰µå»ºæ–°åœ–è¡¨
            } catch (error) {
                console.error("æ›´æ–°æƒ…æ„Ÿå›¾è¡¨é”™è¯¯:", error);
            }
        }
        
        // åˆ›å»ºè¯—å¥å¡ç‰‡ - é€‚åº”å¤§å°å¹¶å±…ä¸­
        function createPoemPiece(piece) {
            try {
                const pieceElement = document.createElement('div');
                pieceElement.className = 'poem-card p-4 bg-white dark:bg-gray-800 rounded-md shadow border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-200 select-none font-serif';
                pieceElement.setAttribute('data-id', piece.id);
                pieceElement.textContent = piece.text;
                
                // æ ¹æ®è¯—å¥é•¿åº¦è‡ªåŠ¨è°ƒæ•´å®½åº¦
                if (piece.text.length > 17) {
                    pieceElement.style.width = "100%";
                } else {
                    pieceElement.style.width = "95%";
                }
                
                return pieceElement;
            } catch (error) {
                console.error("åˆ›å»ºè¯—å¥å¡ç‰‡é”™è¯¯:", error);
                return document.createElement('div');
            }
        }
        
        // æ˜¾ç¤ºæç¤º
        function showHint() {
            try {
                const level = gameData.levels.find(level => level.id === gameData.currentLevel);
                if (!level) {
                    console.error("æ‰¾ä¸åˆ°å½“å‰å…³å¡æ•°æ®");
                    return;
                }
                
                const firstCorrectId = level.correctOrder[0];
                const firstPiece = level.pieces.find(piece => piece.id === firstCorrectId);
                
                if (firstPiece) {
                    showToast(`æç¤ºï¼šç¬¬ä¸€å¥è©©æ‡‰ç‚ºã€Œ${firstPiece.text}ã€`);
                }
            } catch (error) {
                console.error("æ˜¾ç¤ºæç¤ºé”™è¯¯:", error);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            try {
                if (!successMessage || !successToast) {
                    console.error("æ‰¾ä¸åˆ°æç¤ºæ¶ˆæ¯å…ƒç´ ");
                    return;
                }
                
                successMessage.textContent = message;
                successToast.classList.remove('hidden');
                successToast.classList.add('animate__animated');
                successToast.classList.add('animate__fadeInUp');
                
                setTimeout(() => {
                    successToast.classList.remove('animate__fadeInUp');
                    successToast.classList.add('animate__fadeOutDown');
                    
                    setTimeout(() => {
                        successToast.classList.add('hidden');
                        successToast.classList.remove('animate__fadeOutDown');
                    }, 500);
                }, 3000);
            } catch (error) {
                console.error("æ˜¾ç¤ºæç¤ºæ¶ˆæ¯é”™è¯¯:", error);
            }
        }
        
        // è®¾ç½®æ‹–æ‹½äº‹ä»¶ - ä½¿ç”¨MouseEventå¯¦ç¾ç²¾ç¢ºæ‹–æ‹½
        function setupDragAndDrop() {
            console.log("è¨­ç½®ç²¾ç¢ºæ‹–æ‹½åŠŸèƒ½...");
            try {
                // ç¢ºä¿æ‹–æ‹½å€åŸŸå­˜åœ¨
                if (!poemPieces || !poemSequence) {
                    console.error("è©©å¥å€åŸŸä¸å­˜åœ¨ï¼Œç„¡æ³•è¨­ç½®æ‹–æ‹½åŠŸèƒ½");
                    return;
                }
                
                // ç‚ºæ‰€æœ‰è©©å¥å¡ç‰‡æ·»åŠ æ»‘é¼ äº‹ä»¶
                const poemCards = document.querySelectorAll('.poem-card');
                
                // è¨˜éŒ„æ‰¾åˆ°çš„å¡ç‰‡æ•¸é‡
                console.log(`æ‰¾åˆ° ${poemCards.length} å€‹è©©å¥å¡ç‰‡`);
                
                if (poemCards.length === 0) {
                    console.warn("æœªæ‰¾åˆ°è©©å¥å¡ç‰‡ï¼Œå¯èƒ½å°šæœªåŠ è¼‰");
                    return;
                }
                
                // ç‚ºæ¯å€‹å¡ç‰‡æ·»åŠ äº‹ä»¶è™•ç†
                poemCards.forEach(card => {
                    // æ»‘é¼ æŒ‰ä¸‹äº‹ä»¶ - é–‹å§‹æ‹–æ‹½
                    card.addEventListener('mousedown', function(e) {
                        // é˜²æ­¢æ–‡æœ¬é¸æ“‡
                        e.preventDefault();
                        
                        // é–‹å§‹æ‹–æ‹½
                        startDrag(this, e.clientX, e.clientY);
                        
                        // è¨­ç½®åˆå§‹ä½ç½®å’Œåç§»
                        const rect = this.getBoundingClientRect();
                        initialMouseX = e.clientX;
                        initialMouseY = e.clientY;
                        offsetX = e.clientX - rect.left;
                        offsetY = e.clientY - rect.top;
                    });
                    
                    // è§¸æ‘¸é–‹å§‹äº‹ä»¶ (ç§»å‹•è¨­å‚™æ”¯æŒ) - ä½¿ç”¨é•·æŒ‰å•Ÿå‹•æ‹–æ‹½ï¼Œé¿å…æ””æˆªæ­£å¸¸æ»¾å‹•
                    card.addEventListener('touchstart', function(e) {
                        if (e.touches.length !== 1) return;
                        const touch = e.touches[0];
                        touchStartX = touch.clientX;
                        touchStartY = touch.clientY;

                        // é å…ˆè¨ˆç®—åç§»ï¼Œä¾›é•·æŒ‰å¾Œä½¿ç”¨
                        const rect = this.getBoundingClientRect();
                        offsetX = touch.clientX - rect.left;
                        offsetY = touch.clientY - rect.top;
                        initialMouseX = touch.clientX;
                        initialMouseY = touch.clientY;

                        // è¨­ç½®é•·æŒ‰è¨ˆæ™‚å™¨ï¼ˆç´„280msï¼‰
                        clearTimeout(longPressTimer);
                        longPressTimer = setTimeout(() => {
                            // è‹¥åœ¨é•·æŒ‰æœŸé–“ç„¡æ˜é¡¯ç§»å‹•ï¼Œé–‹å§‹æ‹–æ‹½ä¸¦é˜»æ­¢æ»¾å‹•
                            startDrag(this, initialMouseX, initialMouseY);
                        }, 280);
                    }, { passive: true });

                    // è§¸æ‘¸ç§»å‹•ï¼šè‹¥åœ¨é•·æŒ‰è§¸ç™¼å‰ç§»å‹•å¹…åº¦éå¤§ï¼Œè¦–ç‚ºæ»¾å‹•ï¼Œå–æ¶ˆæ‹–æ‹½å•Ÿå‹•
                    card.addEventListener('touchmove', function(e) {
                        if (!longPressTimer) return;
                        if (e.touches.length !== 1) return;
                        const t = e.touches[0];
                        const dx = t.clientX - touchStartX;
                        const dy = t.clientY - touchStartY;
                        const moveDist = Math.hypot(dx, dy);
                        if (moveDist > 10) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                            // ä¸é˜»æ­¢é»˜èªï¼Œè®“é é¢å¯æ­£å¸¸æ»¾å‹•
                        }
                    }, { passive: true });
                });
                
                // æ»‘é¼ ç§»å‹•äº‹ä»¶ - æ›´æ–°æ‹–æ‹½ä½ç½®
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging || !draggedElement) return;
                    
                    // ç§»å‹•å…‹éš†é«”
                    updateDragPosition(e.clientX, e.clientY);
                    
                    // æª¢æ¸¬æ”¾ç½®ä½ç½®
                    detectDropTarget(e.clientX, e.clientY);
                });
                
                // è§¸æ‘¸ç§»å‹•äº‹ä»¶
                document.addEventListener('touchmove', function(e) {
                    if (!isDragging || !draggedElement || e.touches.length === 0) return;
                    const touch = e.touches[0];

                    // åªæœ‰åœ¨å·²é€²å…¥æ‹–æ‹½ç‹€æ…‹æ™‚æ‰é˜»æ­¢é é¢æ»¾å‹•
                    e.preventDefault();

                    // ç§»å‹•å…‹éš†é«”
                    updateDragPosition(touch.clientX, touch.clientY);
                    
                    // æª¢æ¸¬æ”¾ç½®ä½ç½®
                    detectDropTarget(touch.clientX, touch.clientY);
                }, { passive: false });
                
                // æ»‘é¼ é‡‹æ”¾äº‹ä»¶ - å®Œæˆæ‹–æ‹½
                document.addEventListener('mouseup', function(e) {
                    if (isDragging) {
                        finishDrag(e.clientX, e.clientY);
                    }
                });
                
                    // è§¸æ‘¸çµæŸäº‹ä»¶
                    document.addEventListener('touchend', function(e) {
                        // çµæŸé•·æŒ‰ç­‰å¾…
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                        if (isDragging && e.changedTouches.length > 0) {
                            const touch = e.changedTouches[0];
                            finishDrag(touch.clientX, touch.clientY);
                        }
                    });
                
                // é˜²æ­¢é›¢é–‹è¦–çª—æ™‚å…ƒç´ æ‡¸æ›
                document.addEventListener('mouseleave', function() {
                    if (isDragging) {
                        cancelDrag();
                    }
                });
                
                console.log("æ‹–æ‹½äº‹ä»¶è¨­ç½®å®Œæˆ");
            } catch (error) {
                console.error("è¨­ç½®æ‹–æ‹½äº‹ä»¶éŒ¯èª¤:", error);
                showError("è¨­ç½®æ‹–æ‹½åŠŸèƒ½æ™‚ç™¼ç”ŸéŒ¯èª¤");
            }
        }
        
        // é–‹å§‹æ‹–æ‹½
        function startDrag(element, clientX, clientY) {
            try {
                // é˜²æ­¢é‡è¤‡å•Ÿå‹•æ‹–æ‹½
                if (isDragging) return;
                
                console.log("é–‹å§‹æ‹–æ‹½", element.textContent);
                
                // è¨­ç½®æ‹–æ‹½ç‹€æ…‹
                isDragging = true;
                draggedElement = element;
                
                // è¦–è¦ºåé¥‹ - åŸå…ƒç´ åŠé€æ˜
                draggedElement.classList.add('dragging');
                
                // å‰µå»ºæ‹–æ‹½å…‹éš†é«”
                createDragClone(element, clientX, clientY);
                
                // è§¸è¦ºåé¥‹
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } catch (error) {
                console.error("é–‹å§‹æ‹–æ‹½éŒ¯èª¤:", error);
                isDragging = false;
                draggedElement = null;
            }
        }
        
        // æ›´æ–°æ‹–æ‹½ä½ç½®
        function updateDragPosition(clientX, clientY) {
            if (!dragClone) return;
            
            try {
                // ä½¿ç”¨ transform è€Œä¸æ˜¯ left/topï¼Œæ€§èƒ½æ›´å¥½
                dragClone.style.left = `${clientX - offsetX}px`;
                dragClone.style.top = `${clientY - offsetY}px`;
            } catch (error) {
                console.warn("æ›´æ–°æ‹–æ‹½ä½ç½®éŒ¯èª¤:", error);
            }
        }
        
        // æª¢æ¸¬æ”¾ç½®ç›®æ¨™
        function detectDropTarget(clientX, clientY) {
            try {
                // æª¢æŸ¥æ˜¯å¦åœ¨æ’åºå€åŸŸ
                const sequenceRect = poemSequence.getBoundingClientRect();
                const piecesRect = poemPieces.getBoundingClientRect();
                
                // æ¸…é™¤æ‰€æœ‰é«˜äº®
                poemSequence.classList.remove('highlight');
                poemPieces.classList.remove('highlight');
                
                // ç§»é™¤ç¾æœ‰æŒ‡ç¤ºå™¨
                removeDropIndicator();
                
                if (isWithinRect(clientX, clientY, sequenceRect)) {
                    // é¼ æ¨™åœ¨æ’åºå€åŸŸå…§
                    poemSequence.classList.add('highlight');
                    
                    // æ‰¾å‡ºæ‡‰æ’å…¥çš„ä½ç½®
                    const insertPosition = findInsertPositionVertical(poemSequence, clientY);
                    
                    // å‰µå»ºæ”¾ç½®æŒ‡ç¤ºå™¨
                    createDropIndicator(poemSequence, insertPosition);
                } else if (isWithinRect(clientX, clientY, piecesRect)) {
                    // é¼ æ¨™åœ¨åŸå§‹å€åŸŸå…§
                    poemPieces.classList.add('highlight');
                    
                    // æ‰¾å‡ºæ‡‰æ’å…¥çš„ä½ç½®
                    const insertPosition = findInsertPositionHorizontal(poemPieces, clientX, clientY);
                    
                    // å¦‚æœç•¶å‰ä¸åœ¨åŸå§‹å€åŸŸï¼Œå‰‡å‰µå»ºæŒ‡ç¤ºå™¨
                    if (draggedElement.parentElement !== poemPieces) {
                        createDropIndicator(poemPieces, insertPosition);
                    }
                }
            } catch (error) {
                console.warn("æª¢æ¸¬æ”¾ç½®ç›®æ¨™éŒ¯èª¤:", error);
            }
        }
        
        // å®Œæˆæ‹–æ‹½ - ä¿®å¤å‚è€ƒèŠ‚ç‚¹é”™è¯¯
        function finishDrag(clientX, clientY) {
            try {
                if (!isDragging || !draggedElement) return;
                
                console.log("å®Œæˆæ‹–æ‹½");
                
                // å–å¾—ç›®æ¨™å€åŸŸ
                const sequenceRect = poemSequence.getBoundingClientRect();
                const piecesRect = poemPieces.getBoundingClientRect();
                
                let targetContainer = null;
                
                if (isWithinRect(clientX, clientY, sequenceRect)) {
                    // æ”¾å…¥æ’åºå€åŸŸ
                    targetContainer = poemSequence;
                    console.log("æ”¾å…¥æ’åºå€åŸŸ");
                } else if (isWithinRect(clientX, clientY, piecesRect)) {
                    // æ”¾å›åŸå§‹å€åŸŸ
                    targetContainer = poemPieces;
                    console.log("æ”¾å›åŸå§‹å€åŸŸ");
                }
                
                // åŸ·è¡Œæ”¾ç½®æ“ä½œ
                if (targetContainer) {
                    // æ¢å¾©å…ƒç´ æ¨£å¼
                    draggedElement.classList.remove('dragging');
                    
                    // å¾åŸä½ç½®ç§»é™¤
                    if (draggedElement.parentNode) {
                        draggedElement.parentNode.removeChild(draggedElement);
                    }
                    
                    // å®‰å…¨æ–¹å¼æ’å…¥å…ƒç´  - ä¿®å¤å…³é”®é—®é¢˜
                    try {
                        // æ ¹æ®ç›®æ ‡å®¹å™¨ç±»å‹ç¡®å®šæ’å…¥ä½ç½®
                        if (targetContainer === poemSequence) {
                            // åœ¨å‚ç›´æ’åºåŒºåŸŸï¼Œè®¡ç®—åŸºäºYåæ ‡çš„ä½ç½®
                            const mouseY = clientY;
                            const cards = Array.from(targetContainer.querySelectorAll('.poem-card:not(.dragging)'));
                            
                            // æ‰¾åˆ°é¼ æ ‡ä½ç½®ä¸‹æ–¹çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
                            let insertBeforeElement = null;
                            for (let i = 0; i < cards.length; i++) {
                                const card = cards[i];
                                const rect = card.getBoundingClientRect();
                                if (mouseY < rect.top + rect.height / 2) {
                                    insertBeforeElement = card;
                                    break;
                                }
                            }
                            
                            // ç¡®ä¿å‚è€ƒèŠ‚ç‚¹æ˜¯å½“å‰å®¹å™¨çš„å­èŠ‚ç‚¹
                            if (insertBeforeElement && insertBeforeElement.parentNode === targetContainer) {
                                targetContainer.insertBefore(draggedElement, insertBeforeElement);
                                console.log("å‚ç›´æ”¾ç½®: æ’å…¥åˆ°æŒ‡å®šå…ƒç´ å‰");
                            } else {
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œæˆ–å‚è€ƒèŠ‚ç‚¹ä¸æ˜¯å½“å‰å®¹å™¨çš„å­èŠ‚ç‚¹ï¼Œåˆ™æ·»åŠ åˆ°æœ«å°¾
                                targetContainer.appendChild(draggedElement);
                                console.log("å‚ç›´æ”¾ç½®: æ·»åŠ åˆ°æœ«å°¾");
                            }
                        } else {
                            // åœ¨æ°´å¹³ç½‘æ ¼å¸ƒå±€ä¸­ï¼Œç›´æ¥æ·»åŠ åˆ°æœ«å°¾æœ€å®‰å…¨
                            targetContainer.appendChild(draggedElement);
                            console.log("æ°´å¹³æ”¾ç½®: æ·»åŠ åˆ°æœ«å°¾");
                        }
                        
                        // æ·»åŠ æ”¾ç½®åŠ¨ç”»æ•ˆæœ
                        draggedElement.style.animation = 'pop 0.3s ease-out';
                        setTimeout(() => {
                            if (draggedElement) {  // ç¡®ä¿å…ƒç´ ä»ç„¶å­˜åœ¨
                                draggedElement.style.animation = '';
                            }
                        }, 300);
                    } catch (insertError) {
                        console.error("æ’å…¥èŠ‚ç‚¹é”™è¯¯:", insertError);
                        // å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ: ç›´æ¥æ·»åŠ åˆ°æœ«å°¾
                        try {
                            targetContainer.appendChild(draggedElement);
                            console.log("ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆæ·»åŠ å…ƒç´ ");
                        } catch (fallbackError) {
                            console.error("å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥:", fallbackError);
                            // æœ€ç»ˆå¤‡ç”¨: å°†å…ƒç´ æ¢å¤åˆ°åŸå§‹å®¹å™¨
                            if (draggedElement.parentNode !== poemPieces) {
                                poemPieces.appendChild(draggedElement);
                                console.log("æ¢å¤åˆ°åŸå§‹å®¹å™¨");
                            }
                        }
                    }
                } else {
                    // æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç›®æ ‡åŒºåŸŸï¼Œæ¢å¤åŸçŠ¶
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                    }
                }
                
                // æ¸…ç†æ‹–æ‹½çŠ¶æ€
                cleanupDrag();
                
                // è§¦è§‰åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
            } catch (error) {
                console.error("å®Œæˆæ‹–æ‹½é”™è¯¯:", error);
                cancelDrag();
            }
        }
        
        // å–æ¶ˆæ‹–æ‹½
        function cancelDrag() {
            try {
                console.log("å–æ¶ˆæ‹–æ‹½");
                
                if (draggedElement) {
                    // æ¢å¾©æ‹–æ‹½å…ƒç´ çš„æ¨£å¼
                    draggedElement.classList.remove('dragging');
                }
                
                // æ¸…ç†æ‹–æ‹½ç‹€æ…‹
                cleanupDrag();
            } catch (error) {
                console.error("å–æ¶ˆæ‹–æ‹½éŒ¯èª¤:", error);
            }
        }
        
        // æ¸…ç†æ‹–æ‹½ç‹€æ…‹
        function cleanupDrag() {
            try {
                // ç§»é™¤å…‹éš†é«”
                if (dragClone && dragClone.parentNode) {
                    dragClone.parentNode.removeChild(dragClone);
                }
                
                // ç§»é™¤æ”¾ç½®æŒ‡ç¤ºå™¨
                removeDropIndicator();
                
                // æ¸…é™¤é«˜äº®æ•ˆæœ
                if (poemSequence) poemSequence.classList.remove('highlight');
                if (poemPieces) poemPieces.classList.remove('highlight');
                
                // é‡ç½®æ‹–æ‹½ç‹€æ…‹
                isDragging = false;
                draggedElement = null;
                dragClone = null;
                dropIndicator = null;
            } catch (error) {
                console.warn("æ¸…ç†æ‹–æ‹½ç‹€æ…‹éŒ¯èª¤:", error);
            }
        }
        
        // å‰µå»ºæ‹–æ‹½å…‹éš†é«”
        function createDragClone(element, clientX, clientY) {
            try {
                // å‰µå»ºå…‹éš†é«”
                dragClone = element.cloneNode(true);
                if (!dragClone) return;  // æª¢æŸ¥å…‹éš†æ˜¯å¦æˆåŠŸ
                
                dragClone.classList.add('drag-clone');
                
                // è¨­ç½®åˆå§‹æ¨£å¼å’Œä½ç½®
                const rect = element.getBoundingClientRect();
                dragClone.style.width = `${rect.width}px`;
                dragClone.style.height = `${rect.height}px`;
                dragClone.style.left = `${clientX - offsetX}px`;
                dragClone.style.top = `${clientY - offsetY}px`;
                
                // æ·»åŠ åˆ°æ–‡æª”ä¸­
                document.body.appendChild(dragClone);
            } catch (error) {
                console.error("å‰µå»ºæ‹–æ‹½å…‹éš†é«”éŒ¯èª¤:", error);
            }
        }
        
        // å‰µå»ºæ”¾ç½®æŒ‡ç¤ºå™¨
        function createDropIndicator(container, insertBefore) {
            try {
                // å…ˆç§»é™¤ç¾æœ‰æŒ‡ç¤ºå™¨
                removeDropIndicator();
                
                // å‰µå»ºæ–°æŒ‡ç¤ºå™¨
                dropIndicator = document.createElement('div');
                dropIndicator.className = 'drop-indicator';
                
                // æ·»åŠ åˆ°å®¹å™¨
                if (insertBefore) {
                    container.insertBefore(dropIndicator, insertBefore);
                } else {
                    container.appendChild(dropIndicator);
                }
            } catch (error) {
                console.warn("å‰µå»ºæ”¾ç½®æŒ‡ç¤ºå™¨éŒ¯èª¤:", error);
            }
        }
        
        // ç§»é™¤æ”¾ç½®æŒ‡ç¤ºå™¨
        function removeDropIndicator() {
            try {
                const indicators = document.querySelectorAll('.drop-indicator');
                indicators.forEach(indicator => {
                    if (indicator && indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                });
                dropIndicator = null;
            } catch (error) {
                console.warn("ç§»é™¤æ”¾ç½®æŒ‡ç¤ºå™¨éŒ¯èª¤:", error);
            }
        }
        
        // æª¢æŸ¥é»æ˜¯å¦åœ¨çŸ©å½¢å…§
        function isWithinRect(x, y, rect) {
            return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
        }
        
        // æŸ¥æ‰¾å‚ç›´æ’å…¥ä½ç½®
        function findInsertPositionVertical(container, y) {
            try {
                const cards = Array.from(container.querySelectorAll('.poem-card:not(.dragging)'));
                
                return cards.find(card => {
                    const rect = card.getBoundingClientRect();
                    return y < rect.top + rect.height / 2;
                });
            } catch (error) {
                console.warn("æŸ¥æ‰¾å‚ç›´æ’å…¥ä½ç½®éŒ¯èª¤:", error);
                return null;
            }
        }
        
        // æŸ¥æ‰¾æ°´å¹³æ’å…¥ä½ç½® (ç¶²æ ¼å¸ƒå±€)
        function findInsertPositionHorizontal(container, x, y) {
            try {
                const cards = Array.from(container.querySelectorAll('.poem-card:not(.dragging)'));
                
                // è¨ˆç®—æ¯å€‹å¡ç‰‡çš„ä¸­å¿ƒé»ä¸¦æ‰¾å‡ºæœ€æ¥è¿‘çš„
                let closestCard = null;
                let minDistance = Infinity;
                
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestCard = card;
                    }
                });
                
                // å¦‚æœæœ‰æ‰¾åˆ°æœ€æ¥è¿‘çš„å¡ç‰‡ï¼Œå‰‡æ ¹æ“šé»æ“Šä½ç½®æ±ºå®šæ˜¯åœ¨ä¹‹å‰é‚„æ˜¯ä¹‹å¾Œæ’å…¥
                if (closestCard) {
                    const rect = closestCard.getBoundingClientRect();
                    if (x > rect.left + rect.width / 2) {
                        // é»åœ¨å¡ç‰‡å³å´ï¼Œåœ¨å¾Œé¢æ’å…¥
                        return closestCard.nextElementSibling;
                    } else {
                        // é»åœ¨å¡ç‰‡å·¦å´ï¼Œåœ¨å‰é¢æ’å…¥
                        return closestCard;
                    }
                }
                
                return null;
            } catch (error) {
                console.warn("æŸ¥æ‰¾æ°´å¹³æ’å…¥ä½ç½®éŒ¯èª¤:", error);
                return null;
            }
        }
        
        // æ£€æŸ¥æ’åº
        function checkSequence() {
            try {
                if (!poemSequence) {
                    console.error("æ‰¾ä¸åˆ°æ’åºåŒºåŸŸå…ƒç´ ");
                    return;
                }
                
                const currentSequence = Array.from(poemSequence.children)
                    .filter(child => child.classList.contains('poem-card'))  // åªé¸å–è©©å¥å¡ç‰‡ï¼Œæ’é™¤æŒ‡ç¤ºå™¨
                    .map(card => card.getAttribute('data-id'));
                    
                const level = gameData.levels.find(level => level.id === gameData.currentLevel);
                
                if (!level) {
                    console.error("æ‰¾ä¸åˆ°å½“å‰å…³å¡æ•°æ®");
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯—å¥éƒ½å·²æ’åº
                if (currentSequence.length !== level.pieces.length) {
                    showToast("è«‹å°‡æ‰€æœ‰è©©å¥æ”¾å…¥æ’åºå€åŸŸ");
                    return;
                }
                
                // æ£€æŸ¥é¡ºåºæ˜¯å¦æ­£ç¡®
                const isCorrect = level.correctOrder.every((id, index) => id === currentSequence[index]);
                
                if (isCorrect) {
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast("æ’åºæ­£ç¢ºï¼è§£é–çŸ¥è­˜é»èˆ‡å¿ƒå¢ƒæ¢ç´¢");
                    
                    // æ·»åŠ åˆ°å·²å®Œæˆå…³å¡
                    if (!gameData.completedLevels.includes(gameData.currentLevel)) {
                        gameData.completedLevels.push(gameData.currentLevel);
                    }
                    
                    // æ›´æ–°å…³å¡è¿›åº¦
                    const currentLevelId = gameData.currentLevel;
                    gameData.progress[currentLevelId] = 1; // è®¾ç½®ä¸ºå·²å®Œæˆæ’åº
                    
                    // å¯ç”¨æ‰€æœ‰æ ‡ç­¾å¹¶æ›´æ–°æ ‡ç­¾çŠ¶æ€
                    updateTabsAvailability(true);
                    
                    // ç»™å®Œæˆçš„è¯—å¥æ·»åŠ åŠ¨ç”»æ•ˆæœ
                    const poemCards = poemSequence.querySelectorAll('.poem-card');
                    poemCards.forEach((card, index) => {
                        if (card) {
                            setTimeout(() => {
                                card.classList.add('animate__animated');
                                card.classList.add('animate__pulse');
                            }, index * 200);
                        }
                    });
                    
                    // ç¡®ä¿çŸ¥è¯†ç‚¹å†…å®¹å·²åŠ è½½
                    if (knowledgeContent && level.knowledge) {
                        knowledgeContent.innerHTML = level.knowledge;
                    }
                    
                    // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
                    updateProgressIndicator(2);
                    
                    // å»¶è¿Ÿåˆ‡æ¢åˆ°çŸ¥è¯†ç‚¹æ ‡ç­¾
                    setTimeout(() => {
                        // ä½¿ç”¨æœ€å¯é çš„æ–¹æ³•åˆ‡æ¢æ ‡ç­¾
                        console.log("è‡ªåŠ¨åˆ‡æ¢åˆ°çŸ¥è¯†ç‚¹æ ‡ç­¾");
                        switchTab("knowledgeTab");
                        
                        // æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ‡æ¢
                        setTimeout(() => {
                            if (!knowledgeTab || !knowledgeTab.classList.contains('active')) {
                                console.log("çŸ¥è¯†ç‚¹æ ‡ç­¾æœªæ­£ç¡®æ¿€æ´»ï¼Œå°è¯•ç›´æ¥è®¾ç½®æ ·å¼");
                                
                                // ç›´æ¥ä¿®æ”¹æ ·å¼å’Œç±»
                                if (knowledgeTab) {
                                    knowledgeTab.style.display = 'block';
                                    knowledgeTab.classList.add('active');
                                }
                                
                                // ä¿®æ”¹æŒ‰é’®çŠ¶æ€
                                tabButtons.forEach(btn => {
                                    if (!btn) return;
                                    const tabId = btn.getAttribute('data-tab');
                                    if (tabId === 'knowledgeTab') {
                                        btn.classList.add('active');
                                    }
                                });
                            }
                        }, 500);
                    }, 1000);
                } else {
                    showToast("æ’åºæœ‰èª¤ï¼Œè«‹é‡æ–°å˜—è©¦");
                    
                    // ç»™é”™è¯¯çš„æ’åºæ·»åŠ éœ‡åŠ¨åŠ¨ç”»
                    if (poemSequence) {
                        poemSequence.classList.add('animate__animated');
                        poemSequence.classList.add('animate__shakeX');
                        
                        setTimeout(() => {
                            poemSequence.classList.remove('animate__animated');
                            poemSequence.classList.remove('animate__shakeX');
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error("æ£€æŸ¥æ’åºé”™è¯¯:", error);
                showError(`æ£€æŸ¥æ’åºé”™è¯¯: ${error.message}`);
            }
        }
        
        // æäº¤é—®ç­”ç­”æ¡ˆ - å®Œå…¨é‡å†™çš„æ–°ç‰ˆæœ¬
        function submitQuizAnswer() {
            try {
                console.log("===== æäº¤å•ç­”ç­”æ¡ˆé–‹å§‹ =====");
                
                // ç¬¬ä¸€æ­¥ï¼šç„¡æ¢ä»¶å¼·åˆ¶éš±è—ä¸‹ä¸€é—œæŒ‰éˆ•
                const hideNextLevelButton = function() {
                    console.log("å¼·åˆ¶éš±è—æ‰€æœ‰ä¸‹ä¸€é—œæŒ‰éˆ• (submitQuizAnsweré–‹å§‹)");
                    const allButtons = document.querySelectorAll('#next-level-button, .next-level-btn');
                    allButtons.forEach(btn => {
                        if (btn) {
                            btn.style.display = 'none';
                            btn.classList.add('hidden');
                        }
                    });
                };
                
                // ç«‹å³åŸ·è¡Œéš±è—æŒ‰éˆ•
                hideNextLevelButton();
                
                // ç¬¬äºŒæ­¥ï¼šæª¢æŸ¥æ˜¯å¦é¸æ“‡äº†é¸é …
                const selectedOption = document.querySelector('.quiz-option.selected');
                if (!selectedOption) {
                    console.log("æœªé¸æ“‡ä»»ä½•é¸é …");
                    showToast("è«‹é¸æ“‡ä¸€å€‹é¸é …");
                    return;
                }
                
                // ç¬¬ä¸‰æ­¥ï¼šç²å–ç•¶å‰é—œå¡æ•¸æ“š
                const currentLevelId = Number(gameData.currentLevel);
                console.log(`ç•¶å‰é—œå¡ID: ${currentLevelId}`);
                
                if (isNaN(currentLevelId)) {
                    console.error("ç•¶å‰é—œå¡IDç„¡æ•ˆ");
                    showError("é—œå¡æ•¸æ“šéŒ¯èª¤ï¼Œè«‹åˆ·æ–°é é¢");
                    return;
                }
                
                const level = gameData.levels.find(level => level.id === currentLevelId);
                if (!level) {
                    console.error(`æ‰¾ä¸åˆ°é—œå¡æ•¸æ“š: ID=${currentLevelId}`);
                    showError("æ‰¾ä¸åˆ°é—œå¡æ•¸æ“š");
                    return;
                }
                
                // ç¬¬å››æ­¥ï¼šæª¢æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¢º
                const selectedId = selectedOption.getAttribute('data-id');
                console.log(`é¸æ“‡é¸é …ID: ${selectedId}, æ­£ç¢ºé¸é …ID: ${level.quiz.correctId}`);
                const isCorrect = selectedId === level.quiz.correctId;
                
                // ç¬¬äº”æ­¥ï¼šé¡¯ç¤ºåé¥‹ä¿¡æ¯
                if (quizFeedback) {
                    const feedbackHTML = `
                        <div class="p-3 rounded-md ${isCorrect ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-100' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-100'} animate__animated animate__fadeIn">
                            <p class="font-bold text-base mb-1">${isCorrect ? 'âœ“ æ­£ç¢ºï¼' : 'âœ— ä¸æ­£ç¢º'}</p>
                            <p class="text-sm leading-relaxed">${level.quiz.explanation}</p>
                        </div>
                    `;
                    
                    quizFeedback.innerHTML = feedbackHTML;
                    quizFeedback.classList.remove('hidden');
                    
                    // æ»¾å‹•åˆ°åé¥‹å€åŸŸ
                    setTimeout(() => {
                        if (quizFeedback) {
                            quizFeedback.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }, 100);
                }
                
                // ç¬¬å…­æ­¥ï¼šè™•ç†å›ç­”éŒ¯èª¤çš„æƒ…æ³
                if (!isCorrect) {
                    console.log("ç­”æ¡ˆä¸æ­£ç¢º");
                    
                    // çµ¦éŒ¯èª¤é¸é …æ·»åŠ æ¨£å¼
                    selectedOption.style.borderColor = '#FC8181';
                    selectedOption.style.backgroundColor = 'rgba(252, 129, 129, 0.1)';
                    
                    // æ¨™è¨˜æ­£ç¢ºé¸é …
                    const correctOption = document.querySelector(`.quiz-option[data-id="${level.quiz.correctId}"]`);
                    if (correctOption) {
                        correctOption.style.borderColor = '#68D391';
                        correctOption.style.backgroundColor = 'rgba(104, 211, 145, 0.1)';
                    }
                    
                    // å†æ¬¡ç¢ºä¿ä¸‹ä¸€é—œæŒ‰éˆ•éš±è—
                    hideNextLevelButton();
                    
                    // é€€å‡ºå‡½æ•¸
                    return;
                }
                
                // å¦‚æœç­”æ¡ˆæ­£ç¢ºï¼Œç¹¼çºŒè™•ç†
                console.log("ç­”æ¡ˆæ­£ç¢º");
                
                // ç¬¬ä¸ƒæ­¥ï¼šçµ¦æ­£ç¢ºé¸é …æ·»åŠ æ¨£å¼
                selectedOption.style.borderColor = '#68D391';
                selectedOption.style.backgroundColor = 'rgba(104, 211, 145, 0.1)';
                
                // ç¬¬å…«æ­¥ï¼šæ›´æ–°é—œå¡é€²åº¦
                gameData.progress[currentLevelId] = 3; // è¨­ç½®ç‚ºå·²å®Œæˆå¿ƒå¢ƒæ¢ç´¢
                console.log(`æ›´æ–°é€²åº¦: progress[${currentLevelId}] = 3`);
                
                // ç¬¬ä¹æ­¥ï¼šè™•ç†æœ€å¾Œä¸€é—œå’Œéæœ€å¾Œä¸€é—œçš„ä¸åŒé‚è¼¯
                setTimeout(() => {
                    // é‡æ–°ç²å–ç•¶å‰é—œå¡IDï¼Œä»¥é˜²åœ¨å»¶é²æœŸé–“æœ‰è®ŠåŒ–
                    const verifiedLevelId = Number(gameData.currentLevel);
                    console.log(`ç¢ºèªé—œå¡ID: ${verifiedLevelId}`);
                    
                    if (verifiedLevelId === 4) { // ç¡¬ç·¨ç¢¼åˆ¤æ–·æœ€å¾Œä¸€é—œ
                        console.log("é€™æ˜¯æœ€å¾Œä¸€é—œï¼Œé¡¯ç¤ºæ­å–œçª—å£");
                        
                        // ç¢ºä¿ä¸‹ä¸€é—œæŒ‰éˆ•éš±è—
                        hideNextLevelButton();
                        
                        // é¡¯ç¤ºæ­å–œçª—å£
                        if (gameCompleteModal) {
                            setTimeout(() => {
                                gameCompleteModal.classList.remove('hidden');
                                console.log("é¡¯ç¤ºéŠæˆ²å®Œæˆæ¨¡æ…‹æ¡†");
                            }, 1500);
                        } else {
                            console.error("æ‰¾ä¸åˆ°éŠæˆ²å®Œæˆæ¨¡æ…‹æ¡†");
                        }
                    } else {
                        console.log("é€™ä¸æ˜¯æœ€å¾Œä¸€é—œï¼Œæº–å‚™é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•");
                        
                        // ä½¿ç”¨å°ˆé–€çš„å‡½æ•¸é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•
                        setTimeout(() => {
                            createAndShowNextLevelButton(verifiedLevelId);
                        }, 200);
                    }
                }, 500);
                
                console.log("===== æäº¤å•ç­”ç­”æ¡ˆçµæŸ =====");
                
            } catch (error) {
                console.error("æäº¤é—®ç­”ç­”æ¡ˆä¸¥é‡é”™è¯¯:", error);
                showError(`ç³»ç»Ÿé”™è¯¯: ${error.message}`);
                
                // å‡ºé”™æ—¶ç¡®ä¿ä¸‹ä¸€å…³æŒ‰é’®éšè—
                if (nextLevelButton) {
                    nextLevelButton.style.display = 'none';
                    nextLevelButton.classList.add('hidden');
                }
            }
        }
        
        // åˆ›å»ºå¹¶æ˜¾ç¤ºä¸‹ä¸€å…³æŒ‰é’®çš„ä¸“ç”¨å‡½æ•°
        function createAndShowNextLevelButton(currentLevelId) {
            try {
                console.log("===== åˆ›å»ºå¹¶æ˜¾ç¤ºä¸‹ä¸€å…³æŒ‰é’® =====");
                // è·å–å½“å‰å…³å¡ID (å†æ¬¡éªŒè¯)
                currentLevelId = Number(currentLevelId);
                if (isNaN(currentLevelId)) {
                    console.error("æ— æ•ˆçš„å…³å¡ID");
                    return;
                }
                
                console.log(`å½“å‰å…³å¡ID: ${currentLevelId}`);
                
                // ç¡¬ç¼–ç éªŒè¯æ˜¯å¦æœ€åä¸€å…³
                if (currentLevelId === 4) {
                    console.log("è¿™æ˜¯æœ€åä¸€å…³ï¼Œä¸æ˜¾ç¤ºæŒ‰é’®");
                    return;
                }
                
                // è·å–ä¸‹ä¸€å…³ID
                const nextLevelId = currentLevelId + 1;
                console.log(`ä¸‹ä¸€å…³ID: ${nextLevelId}`);
                
                // åˆ é™¤æ—§æŒ‰é’®ï¼Œåˆ›å»ºå…¨æ–°æŒ‰é’®
                const oldButton = document.getElementById('next-level-button');
                if (oldButton && oldButton.parentNode) {
                    console.log("ç§»é™¤æ—§æŒ‰é’®");
                    oldButton.parentNode.removeChild(oldButton);
                }
                
                // è·å–æŒ‰é’®å®¹å™¨
                const buttonContainer = document.querySelector('.quiz-content > div:last-child');
                if (!buttonContainer) {
                    console.error("æ‰¾ä¸åˆ°æŒ‰é’®å®¹å™¨");
                    return;
                }
                
                // åˆ›å»ºå…¨æ–°æŒ‰é’®
                const newButton = document.createElement('button');
                newButton.id = 'next-level-button';
                newButton.className = 'btn-primary next-level-btn px-6 py-2 animate__animated animate__fadeIn';
                newButton.innerHTML = `
                    <span class="ancient-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                            <path d="M5 12h14"></path>
                            <path d="m12 5 7 7-7 7"></path>
                        </svg>
                    </span>é€²å…¥ç¬¬${nextLevelId}é—œ
                `;
                
                // ç›´æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log(`ç‚¹å‡»ä¸‹ä¸€å…³æŒ‰é’®ï¼Œå½“å‰å…³å¡: ${gameData.currentLevel}`);
                    
                    // ç«‹å³éšè—è‡ªå·±ï¼Œé˜²æ­¢å¤šæ¬¡ç‚¹å‡»
                    this.style.display = 'none';
                    
                    // ç›´æ¥è°ƒç”¨è¿›å…¥ä¸‹ä¸€å…³
                    proceedToNextLevel();
                });
                
                // æ·»åŠ æŒ‰é’®åˆ°å®¹å™¨
                buttonContainer.appendChild(newButton);
                
                // ç¡®ä¿æŒ‰é’®æ˜¾ç¤º
                newButton.style.display = 'block';
                
                console.log("ä¸‹ä¸€å…³æŒ‰é’®å·²åˆ›å»ºå¹¶æ˜¾ç¤º");
                
                // æ£€æŸ¥æ˜¯å¦æˆåŠŸæ˜¾ç¤º
                setTimeout(() => {
                    const btn = document.getElementById('next-level-button');
                    if (btn && (btn.style.display !== 'block' || btn.classList.contains('hidden'))) {
                        console.warn("æŒ‰é’®æœªæ­£ç¡®æ˜¾ç¤ºï¼Œå¼ºåˆ¶æ˜¾ç¤º");
                        btn.style.display = 'block';
                        btn.classList.remove('hidden');
                    }
                }, 100);
                
            } catch (error) {
                console.error("åˆ›å»ºä¸‹ä¸€å…³æŒ‰é’®å‘ç”Ÿé”™è¯¯:", error);
            }
        }
        
        // å®Œå…¨é‡å¯« - é¡¯ç¤º"é€²å…¥ä¸‹ä¸€é—œ"æŒ‰éˆ•ï¼ˆä¿®å¾©é—œéµå•é¡Œï¼‰
        function showNextLevelButton() {
            try {
                // è¨˜éŒ„è©³ç´°èª¿è©¦ä¿¡æ¯
                console.log("==== é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ• - è©³ç´°èª¿è©¦ ====");
                
                // ç²å–ç•¶å‰é—œå¡ID (ç¢ºä¿æ˜¯æ•¸å­—é¡å‹)
                const currentLevelId = Number(gameData.currentLevel);
                console.log(`ç•¶å‰é—œå¡ID: ${currentLevelId}, é¡å‹: ${typeof currentLevelId}`);
                
                // ç¡¬ç·¨ç¢¼åˆ¤æ–·æ˜¯å¦ç‚ºæœ€å¾Œä¸€é—œ (ID = 4)
                if (currentLevelId === 4) {
                    console.log("é€™æ˜¯æœ€å¾Œä¸€é—œ(ID=4)ï¼Œä¸é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•");
                    
                    // ç²å–ä¸¦éš±è—æ‰€æœ‰å¯èƒ½çš„ä¸‹ä¸€é—œæŒ‰éˆ•
                    const allNextButtons = document.querySelectorAll('#next-level-button, .next-level-btn');
                    allNextButtons.forEach(btn => {
                        console.log("éš±è—æŒ‰éˆ•:", btn.id || "æœªçŸ¥æŒ‰éˆ•");
                        btn.style.display = 'none';
                        btn.classList.add('hidden');
                    });
                    
                    return; // æœ€å¾Œä¸€é—œç›´æ¥è¿”å›ï¼Œä¸é¡¯ç¤ºæŒ‰éˆ•
                }
                
                // è¨˜éŒ„éæœ€çµ‚é—œçš„æƒ…æ³
                console.log(`é€™æ˜¯ç¬¬${currentLevelId}é—œï¼Œä¸æ˜¯æœ€å¾Œä¸€é—œï¼Œå°‡é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•`);
                
                // ç²å–ä¸‹ä¸€é—œæŒ‰éˆ•å…ƒç´ 
                const nextBtn = document.getElementById('next-level-button');
                if (!nextBtn) {
                    console.error("è‡´å‘½éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¸‹ä¸€é—œæŒ‰éˆ•å…ƒç´ ");
                    showError("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¸‹ä¸€é—œæŒ‰éˆ•");
                    return;
                }
                
                // å¾¹åº•é‡ç½®æŒ‰éˆ•ï¼Œç§»é™¤æ‰€æœ‰ç¾æœ‰äº‹ä»¶ç›£è½å™¨
                const newBtn = nextBtn.cloneNode(true);
                if (nextBtn.parentNode) {
                    nextBtn.parentNode.replaceChild(newBtn, nextBtn);
                }
                
                // ä½¿ç”¨æ–°çš„æŒ‰éˆ•å¼•ç”¨
                const freshBtn = document.getElementById('next-level-button');
                if (!freshBtn) {
                    console.error("é‡ç½®æŒ‰éˆ•å¾Œæ‰¾ä¸åˆ°å…ƒç´ ");
                    return;
                }
                
                // è¨­ç½®æŒ‰éˆ•æ¨£å¼å’Œå…§å®¹
                freshBtn.style.display = 'block';
                freshBtn.classList.remove('hidden');
                freshBtn.innerHTML = '<span class="ancient-icon">â¡ï¸</span>é€²å…¥ä¸‹ä¸€é—œ (ç¬¬' + (currentLevelId + 1) + 'é—œ)';
                
                // æ·»åŠ å‹•ç•«æ•ˆæœ
                freshBtn.classList.add('animate__animated', 'animate__fadeIn', 'bounce-animation');
                
                // ç›´æ¥ç¶å®šé»æ“Šäº‹ä»¶ - ç¢ºä¿ä¸ä½¿ç”¨ç®­é ­å‡½æ•¸é¿å…thisç¶å®šå•é¡Œ
                freshBtn.onclick = function() {
                    console.log("ä¸‹ä¸€é—œæŒ‰éˆ•è¢«é»æ“Šï¼Œç•¶å‰é—œå¡:", gameData.currentLevel);
                    
                    // é¡å¤–å®‰å…¨æª¢æŸ¥
                    if (gameData.currentLevel !== currentLevelId) {
                        console.warn(`è­¦å‘Šï¼šé»æ“Šæ™‚é—œå¡IDå·²è®Šæ›´ ${currentLevelId} -> ${gameData.currentLevel}`);
                    }
                    
                    // èª¿ç”¨é€²å…¥ä¸‹ä¸€é—œå‡½æ•¸
                    proceedToNextLevel();
                };
                
                // å‚™ä»½é»æ“Šäº‹ä»¶åˆ°dataå±¬æ€§ç¢ºä¿å…¶ä¿ç•™
                freshBtn.setAttribute('data-next-level', currentLevelId + 1);
                
                // è¨˜éŒ„æŒ‰éˆ•ç‹€æ…‹ä»¥ä¾¿èª¿è©¦
                console.log("æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹:", freshBtn.style.display);
                console.log("ä¸‹ä¸€é—œæŒ‰éˆ•è¨­ç½®å®Œæˆï¼Œå°‡é€²å…¥é—œå¡ID:", currentLevelId + 1);
                
                // æœ€å¾Œæª¢æŸ¥
                setTimeout(() => {
                    const checkBtn = document.getElementById('next-level-button');
                    if (checkBtn && checkBtn.style.display !== 'block') {
                        console.warn("è­¦å‘Šï¼šè¨­ç½®å¾ŒæŒ‰éˆ•æœªæ­£ç¢ºé¡¯ç¤ºï¼Œå¼·åˆ¶é¡¯ç¤º");
                        checkBtn.style.display = 'block';
                    }
                }, 100);
                
            } catch (error) {
                console.error("é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                showError(`ç„¡æ³•é¡¯ç¤ºä¸‹ä¸€é—œæŒ‰éˆ•: ${error.message}`);
            }
        }
    </script>
</body>
</html>
