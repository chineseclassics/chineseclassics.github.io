# 空山应用开发计划检视报告

> **检视日期**：2025-01-XX  
> **检视者**：AI 开发助手

---

## 📋 应用核心要点总结

### 1. 核心概念：声色意境

**定义**：一个"声色意境" = 诗歌 + 音效组合 + 背景配置

**特点**：
- 系统预设的声色意境（管理员创建，默认展示）
- 用户创作的声色意境（需要审核后才能公开）
- 一首诗歌可以有多个声色意境供用户选择

### 2. 用户创作流程

1. **选择诗歌** → 查看诗歌内容
2. **创作声色意境**：
   - 从音效库选择多个音效（支持文件上传或录音）
   - 调整每个音效的音量和循环设置
   - 自定义背景色和动态效果
   - 实时预览效果
3. **保存草稿** → 可以继续编辑
4. **提交审核** → 等待管理员审核
5. **审核通过** → 公开供其他用户欣赏

### 3. 音效管理

**音效来源**：
- 系统预设音效（管理员上传）
- 用户文件上传
- 用户录音上传

**音效状态**：
- `private`：用户上传但未审核，仅创建者可用
- `pending`：已提交审核
- `approved`：审核通过，加入公共音效库
- `rejected`：审核拒绝

**关键规则**：
- 用户上传的音效（包括录音）初始为 `private` 状态
- 用户可以在自己的声色意境中使用 `private` 音效
- 审核通过后，音效自动加入公共库，供所有人使用

### 4. 审核机制

**需要审核的内容**：
1. 用户上传的音效（文件或录音）
2. 用户创作的声色意境

**审核流程**：
- 管理员可以试听音效、预览声色意境
- 批准后自动更新状态和权限
- 拒绝时提供反馈原因

### 5. 用户体验流程

**浏览模式**：
1. 选择诗歌
2. 查看该诗歌的所有声色意境（系统预设 + 用户创作）
3. 选择喜欢的声色意境
4. 欣赏：竖排诗歌 + 音效组合 + 抽象背景
5. 可以点赞、分享

**创作模式**：
1. 登录账户
2. 选择诗歌或输入诗句
3. 打开声色意境编辑器
4. 选择/上传音效，配置背景
5. 保存草稿或提交审核

---

## ✅ 计划优点

### 1. 架构设计合理

- **数据模型清晰**：`poem_atmospheres` 表统一管理声色意境，设计合理
- **状态管理完善**：音效和声色意境都有明确的状态流转
- **权限控制细致**：RLS 策略覆盖了各种使用场景

### 2. 功能层次分明

- **MVP 功能明确**：基础框架 → 用户创作 → 审核系统
- **AI 功能可选**：不影响核心功能，可以后期添加
- **扩展性良好**：支持后期添加用户输入诗句等功能

### 3. 技术选型合适

- **Web Audio API**：适合多音效混音需求
- **Canvas API**：适合抽象背景生成
- **Supabase**：一站式后端解决方案，减少复杂度

---

## ⚠️ 需要澄清的问题

### 1. 音效使用权限（重要）

**问题**：用户创作的声色意境中使用了 `private` 状态的音效，当这个声色意境被审核通过后，音效的状态如何处理？

**场景**：
- 用户 A 上传了一个 `private` 音效
- 用户 A 用这个音效创建了一个声色意境并提交审核
- 管理员审核通过这个声色意境

**疑问**：
- 音效是否自动变为 `approved` 状态？
- 还是需要单独审核音效？
- 如果音效被拒绝，声色意境如何处理？

**建议**：明确审核流程
- 方案 A：声色意境审核通过时，自动将其中使用的 `private` 音效也设为 `approved`
- 方案 B：音效和声色意境分别审核，声色意境审核时检查音效状态
- 方案 C：审核声色意境时，如果音效是 `private`，提示管理员同时审核音效

### 2. 音效替换机制

**问题**：如果声色意境中使用的音效被删除或状态变为 `rejected`，如何处理？

**场景**：
- 用户创建了一个声色意境，使用了音效 A
- 后来音效 A 被管理员删除或拒绝

**疑问**：
- 声色意境是否自动失效？
- 是否允许用户替换音效？
- 如何提示用户音效不可用？

**建议**：
- 在声色意境中标记不可用的音效
- 允许用户编辑自己的草稿，替换音效
- 已审核通过的声色意境，如果音效失效，标记为"部分音效不可用"

### 3. 默认声色意境

**问题**：一首诗歌有多个声色意境时，默认显示哪一个？

**场景**：
- 系统预设了 1 个声色意境
- 用户创作了 3 个已审核通过的声色意境

**疑问**：
- 默认显示系统预设的？
- 默认显示最受欢迎的（点赞数最多）？
- 用户可以选择默认？

**建议**：
- `poem_atmospheres.is_default` 字段可以设置默认
- 如果没有默认，按创建时间或受欢迎程度排序
- 允许用户设置个人偏好

### 4. 录音上传的格式和质量

**问题**：录音上传的具体要求是什么？

**疑问**：
- 录音时长限制？（如最长 60 秒？）
- 录音格式要求？（WebM、MP3？）
- 录音质量设置？（采样率、比特率？）
- 是否需要降噪处理？

**建议**：
- 设置合理的时长限制（如 30-120 秒）
- 使用浏览器原生支持的格式（WebM）
- 设置合适的采样率（如 44.1kHz）
- 提供录音质量提示

### 5. 背景配置的复杂度

**问题**：背景配置器的功能范围是什么？

**疑问**：
- 用户可以选择哪些背景元素？（粒子、线条、形状？）
- 颜色选择器是调色板还是自定义输入？
- 动态效果有哪些？（静态、淡入淡出、动画？）
- 是否需要预设模板供用户选择？

**建议**：
- 提供预设模板（如"宁静"、"激昂"、"忧郁"等）
- 允许用户自定义颜色和元素
- 限制复杂度，避免性能问题
- 提供实时预览

### 6. 用户输入诗句的处理

**问题**：用户输入诗句的功能优先级如何？

**疑问**：
- 这是 MVP 功能还是后期功能？
- 用户输入的诗句是否需要验证（如检查是否为真实古诗）？
- 如果用户输入现代诗或原创诗，如何处理？

**建议**：
- 明确这是第二阶段功能
- 设计诗句验证机制（可选）
- 支持用户标注作者和来源

### 7. 管理员权限定义

**问题**：如何定义和管理员权限？

**疑问**：
- 管理员是通过 Supabase 角色系统还是自定义字段？
- 如何添加管理员？
- 管理员有哪些特殊权限？

**建议**：
- 使用 Supabase 的 `user_metadata` 或自定义 `admin_users` 表
- 提供管理员管理界面（仅超级管理员可见）
- 明确管理员权限范围

### 8. 音效库的初始内容

**问题**：系统预设的音效库如何建立？

**疑问**：
- 是否需要预先准备一批音效？
- 音效从哪里获取？（Pixabay、自录、购买？）
- 初始音效库需要多少音效？

**建议**：
- 准备 20-30 个基础音效（雨声、鸟鸣、流水、风声等）
- 可以从免费音效库获取
- 建立音效分类体系

---

## 💡 改进建议

### 1. 数据一致性优化

**问题**：`poem_atmospheres.sound_combination` 使用 JSONB 存储，查询和统计不便

**建议**：
- 保留 `atmosphere_sounds` 关联表用于查询
- 使用数据库触发器同步 JSONB 和关联表
- 或者定期同步数据

### 2. 音效搜索和推荐

**建议添加**：
- 音效标签系统（已规划）
- 音效搜索功能（已规划）
- **音效推荐功能**：根据诗歌关键词推荐相关音效
- **音效组合模板**：提供预设的音效组合模板

### 3. 用户体验优化

**建议添加**：
- **收藏功能**：用户可以收藏喜欢的声色意境
- **历史记录**：记录用户浏览过的诗歌和声色意境
- **个人创作库**：用户可以查看自己创作的所有声色意境
- **分享功能**：生成分享链接或图片

### 4. 性能优化

**建议**：
- **音效预加载策略**：根据用户浏览历史预加载常用音效
- **背景渲染优化**：使用 Web Workers 处理复杂背景渲染
- **懒加载**：声色意境列表使用虚拟滚动
- **缓存策略**：缓存 AI 分析结果和常用数据

### 5. 审核效率提升

**建议添加**：
- **审核队列优先级**：按提交时间或用户等级排序
- **批量审核**：支持批量批准/拒绝
- **审核统计**：显示待审核数量、审核通过率等
- **审核提醒**：新提交时通知管理员

### 6. 错误处理和降级方案

**建议添加**：
- **音效加载失败处理**：显示占位符或使用备用音效
- **AI 分析失败降级**：提供预设建议或允许用户跳过
- **网络错误重试机制**：自动重试失败的请求
- **离线模式**：缓存已加载的诗歌和声色意境

### 7. 数据统计和分析

**建议添加**：
- **热门诗歌统计**：查看次数、点赞数
- **热门声色意境统计**：最受欢迎的创作
- **音效使用统计**：哪些音效最常用
- **用户活跃度统计**：创作数量、审核通过率

### 8. 移动端优化

**建议**：
- **触摸优化**：音量滑块、背景配置器适配触摸操作
- **录音权限处理**：移动端需要用户授权麦克风
- **响应式布局**：确保竖排文字在移动端正常显示
- **性能优化**：移动端限制同时播放音效数量

---

## 🎯 开发优先级建议

### 第一阶段：核心功能（必须）

1. ✅ 项目结构搭建
2. ⏳ 数据库设计和迁移
3. ⏳ 诗歌展示（竖排）
4. ⏳ 基础音效播放
5. ⏳ 多音效混音
6. ⏳ 系统预设声色意境
7. ⏳ 用户认证

### 第二阶段：用户创作（核心）

8. ⏳ 声色意境编辑器
9. ⏳ 音效上传（文件 + 录音）
10. ⏳ 背景配置器
11. ⏳ 保存草稿和提交审核

### 第三阶段：审核系统（重要）

12. ⏳ 管理员审核界面
13. ⏳ 音效和声色意境审核
14. ⏳ 审核通过后自动公开

### 第四阶段：用户体验（重要）

15. ⏳ 声色意境浏览和选择
16. ⏳ 点赞功能
17. ⏳ 音效库浏览

### 第五阶段：AI 功能（增强）

18. ⏳ AI 诗歌分析
19. ⏳ AI 背景生成
20. ⏳ AI 建议应用

### 第六阶段：扩展功能（可选）

21. ⏳ 用户输入诗句
22. ⏳ Pixabay 集成
23. ⏳ 分享功能
24. ⏳ 收藏功能

---

## 📝 总结

### 计划整体评价

**优点**：
- ✅ 核心概念清晰（声色意境）
- ✅ 数据模型设计合理
- ✅ 功能层次分明
- ✅ 技术选型合适

**需要完善**：
- ⚠️ 审核流程细节需要明确
- ⚠️ 音效状态管理需要细化
- ⚠️ 用户体验流程需要优化
- ⚠️ 错误处理需要加强

### 建议下一步行动

1. **澄清关键问题**：优先回答上述 8 个需要澄清的问题
2. **细化审核流程**：明确音效和声色意境的审核关系
3. **完善错误处理**：设计各种异常情况的处理方案
4. **优化用户体验**：设计用户操作流程和界面交互

---

**最后更新**：2025-01-XX

