<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 登入測試 - 太虛幻境</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.47.4/dist/umd/supabase.js"></script>
    <script src="assets/js/cc-auth.js?v=20250928"></script>
    <style>
        body { background: linear-gradient(135deg, #e0f2fe, #fde68a); }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="w-full p-4 flex items-center justify-between">
        <h1 class="text-xl font-bold text-slate-800">Google 登入測試</h1>
        <div id="authMount" class="flex items-center"></div>
    </header>

    <main class="flex-1 p-4">
        <div class="max-w-3xl mx-auto bg-white/90 border border-slate-200 rounded-xl p-4 shadow space-y-4">
            <h2 class="font-semibold">使用者資訊（即時）</h2>
            <pre id="userDump" class="text-xs p-2 bg-slate-100 rounded overflow-auto" style="max-height:260px"></pre>
            <div class="mt-1 text-sm text-slate-600">若為 null，請點右上角「用 Google 登入」。授權後應回到本頁並顯示使用者資訊。</div>

            <hr class="my-2 border-slate-200">

            <h3 class="font-semibold">除錯資訊</h3>
            <div class="grid md:grid-cols-2 gap-3">
                <div class="bg-slate-50 rounded p-3 border border-slate-200">
                    <div class="text-xs text-slate-600">當前 URL</div>
                    <pre id="urlDump" class="text-xs p-2 bg-white rounded border border-slate-200 overflow-auto"></pre>
                </div>
                <div class="bg-slate-50 rounded p-3 border border-slate-200">
                    <div class="text-xs text-slate-600">URL 查詢參數</div>
                    <pre id="qsDump" class="text-xs p-2 bg-white rounded border border-slate-200 overflow-auto"></pre>
                </div>
                <div class="bg-slate-50 rounded p-3 border border-slate-200">
                    <div class="text-xs text-slate-600">Supabase Session</div>
                    <pre id="sessionDump" class="text-xs p-2 bg-white rounded border border-slate-200 overflow-auto"></pre>
                </div>
                <div class="bg-slate-50 rounded p-3 border border-slate-200">
                    <div class="text-xs text-slate-600">localStorage（sb-*）</div>
                    <pre id="lsDump" class="text-xs p-2 bg-white rounded border border-slate-200 overflow-auto"></pre>
                </div>
                <div class="bg-amber-50 rounded p-3 border border-amber-200 md:col-span-2">
                    <div class="text-xs text-amber-700">日誌</div>
                    <pre id="logDump" class="text-xs p-2 bg-white rounded border border-amber-200 overflow-auto" style="max-height:160px"></pre>
                </div>
            </div>

            <div class="flex flex-wrap gap-2">
                <button id="btnRefresh" class="px-3 py-1.5 rounded bg-slate-800 text-white text-sm">刷新資訊</button>
                <button id="btnExchange" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm">手動交換 code</button>
                <button id="btnSignOut" class="px-3 py-1.5 rounded bg-rose-600 text-white text-sm">登出並重新整理</button>
                <button id="btnLogin" class="px-3 py-1.5 rounded bg-emerald-600 text-white text-sm">用 Google 登入</button>
            </div>
        </div>
    </main>

    <script>
    (function(){
        function dumpQS(qs){
            var o = {}; qs.forEach((v,k)=>{ o[k]=v; }); return o;
        }
        function setText(id, value){
            var el = document.getElementById(id);
            if (el) el.textContent = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
        }
        function log(){
            var el = document.getElementById('logDump');
            if (!el) return;
            var msg = Array.from(arguments).map(function(x){
                try { return typeof x === 'string' ? x : JSON.stringify(x); } catch(_) { return String(x); }
            }).join(' ');
            el.textContent += (new Date().toISOString() + ' ') + msg + '\n';
            el.scrollTop = el.scrollHeight;
        }
        async function refreshDump(){
            try {
                log('refreshDump');
                var url = new URL(location.href);
                var qs = dumpQS(url.searchParams);
                setText('urlDump', location.href);
                setText('qsDump', qs);
                var user = await (window.ccAuth && window.ccAuth.getUser ? window.ccAuth.getUser() : Promise.resolve(null));
                setText('userDump', user);
                var client = (window.ccAuth && window.ccAuth.getClient && window.ccAuth.getClient()) || window.sb;
                var sess = await (client && client.auth ? client.auth.getSession() : Promise.resolve({data:null}));
                setText('sessionDump', sess);
                var lsKeys = Object.keys(localStorage).filter(k=>k.includes('sb-'));
                var ls = {}; lsKeys.forEach(k=> ls[k] = localStorage.getItem(k));
                setText('lsDump', ls);
                log('refreshDump done. user=', !!user, 'session=', !!(sess && sess.data && sess.data.session));
            } catch (e) {
                setText('userDump', String(e && e.message || e));
                log('refreshDump error:', e && e.message || e);
            }
        }
        async function manualExchange(){
            try {
                log('manualExchange clicked');
                var url = new URL(location.href);
                var code = url.searchParams.get('code');
                if (!code) { alert('URL 中沒有 code'); log('no code in URL'); return; }
                var client = (window.ccAuth && window.ccAuth.getClient && window.ccAuth.getClient()) || window.sb;
                if (!client || !client.auth) { alert('Supabase client 未就緒'); log('client not ready'); return; }
                var ex = await client.auth.exchangeCodeForSession({ code: code });
                log('exchangeCodeForSession result:', ex && ex.data ? 'ok' : ex);
                // 清理 URL 參數
                try { ['code','state','provider','scope','authuser','prompt'].forEach(p=>url.searchParams.delete(p)); history.replaceState({}, document.title, url.toString()); } catch(_){}
                try { await window.ccAuth?.refresh(); } catch(_) {}
                await refreshDump();
            } catch (e) {
                alert(String(e && e.message || e));
                log('manualExchange error:', e && e.message || e);
            }
        }
        async function doSignOut(){
            try {
                log('signOut clicked');
                var client = (window.ccAuth && window.ccAuth.getClient && window.ccAuth.getClient()) || window.sb;
                await client?.auth?.signOut({ scope:'local' });
                log('signOut done');
            } catch(e){ log('signOut error:', e && e.message || e); }
            location.reload();
        }
        async function doLogin(){
            try { log('login clicked'); await window.ccAuth?.loginGoogle(); } catch(e){ alert(String(e && e.message || e)); log('login error:', e && e.message || e); }
        }

        document.getElementById('btnRefresh').addEventListener('click', refreshDump);
        document.getElementById('btnExchange').addEventListener('click', manualExchange);
        document.getElementById('btnSignOut').addEventListener('click', doSignOut);
        document.getElementById('btnLogin').addEventListener('click', doLogin);

        document.addEventListener('visibilitychange', function(){ if (!document.hidden) refreshDump(); });
        window.addEventListener('focus', refreshDump);
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', refreshDump);
        } else {
            refreshDump();
        }
        log('page ready. flags:', 'supabase=', !!window.supabase, 'sb=', !!window.sb, 'ccAuth=', !!window.ccAuth);
    })();
    </script>
</body>
</html>



