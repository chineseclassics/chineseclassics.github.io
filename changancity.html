<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>唐代長安城互動平面圖</title>
  <link rel="preload" href="/assets/tailwind.css" as="style">
  <link rel="stylesheet" href="/assets/tailwind.css">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans TC", "Microsoft JhengHei", "PingFang TC", sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .panel { width: 320px; }
    .map-wrap { border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); background: #fff; }
    svg { width: 100%; height: auto; display: block; }
    .city-border { fill: #f8fafc; stroke: #0f172a; stroke-width: 2; }
    .zone { cursor: pointer; transition: filter 0.2s ease, opacity 0.2s ease; }
    .zone:hover { filter: brightness(1.03); opacity: 0.95; }
    .zone.ward { fill: #f1f5f9; stroke: #334155; }
    .zone.market { fill: #fde68a; stroke: #92400e; }
    .zone.palace { fill: #fecaca; stroke: #991b1b; }
    .zone.imperial { fill: #fcd34d; stroke: #92400e; }
    .zone.lake { fill: #bae6fd; stroke: #075985; }
    .zone.avenue { fill: #e2e8f0; stroke: #334155; }
    .selected { stroke-width: 3; filter: drop-shadow(0 0 4px rgba(16,185,129,0.7)); }
    .label { font-size: 12px; fill: #111827; pointer-events: none; user-select: none; }
    .muted { color: #6b7280; }
    .legend-item { display: inline-flex; align-items: center; margin-right: 12px; }
    .legend-swatch { width: 14px; height: 14px; border-radius: 3px; margin-right: 6px; border: 1px solid rgba(0,0,0,0.25); }
    .btn { background: #111827; color: #fff; padding: 6px 10px; border-radius: 6px; }
    .input { width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="font-weight:700; font-size:28px; margin-bottom:8px;">唐代長安城互動平面圖</h1>
    <p class="muted" style="margin-bottom:16px;">根據史籍常見的格局（參考您提供的長安城坊坊圖）繪制的簡化模型。可點擊各坊與區域以查看資訊，支援搜尋。</p>

    <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
      <div style="flex:1 1 720px; min-width:640px; position:relative;" class="map-wrap">
        <img id="bgImage" alt="參考圖背景" src="./長安城佈局 2.jpeg" style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:0.22; pointer-events:none; display:block;">
        <svg id="changan-svg" viewBox="0 0 1400 1200" aria-label="長安城平面圖" style="position:relative; z-index:1;"></svg>
      </div>
      <aside class="panel" style="flex:0 0 320px;">
        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.06);">
          <div style="margin-bottom:10px;">
            <label for="search" style="display:block; font-weight:600; margin-bottom:6px;">搜尋坊/區域名稱</label>
            <input id="search" class="input" placeholder="輸入如：東市、西市、宮城、坊12…">
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
            <div class="legend-item"><span class="legend-swatch" style="background:#f1f5f9;"></span><span>坊</span></div>
            <div class="legend-item"><span class="legend-swatch" style="background:#fde68a;"></span><span>市</span></div>
            <div class="legend-item"><span class="legend-swatch" style="background:#fecaca;"></span><span>宮城</span></div>
            <div class="legend-item"><span class="legend-swatch" style="background:#fcd34d;"></span><span>大明宮</span></div>
            <div class="legend-item"><span class="legend-swatch" style="background:#bae6fd;"></span><span>曲江池</span></div>
          </div>
          <div id="info" style="border-top:1px dashed #e5e7eb; padding-top:10px;">
            <div class="muted">點擊地圖中的任一區塊以查看詳細資訊。</div>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="resetBtn" class="btn" type="button">重置視圖</button>
            <button id="editToggle" class="btn" type="button" aria-pressed="false">名稱編輯模式：關</button>
            <button id="exportBtn" class="btn" type="button">匯出名稱JSON</button>
            <button id="importBtn" class="btn" type="button">匯入名稱JSON</button>
            <button id="bgToggle" class="btn" type="button" aria-pressed="true">參考圖背景：開</button>
          </div>
          <textarea id="ioArea" class="input" placeholder="在此貼上或查看名稱JSON" style="margin-top:8px; height:120px; display:none;"></textarea>
        </div>
      </aside>
    </div>
  </div>

  <script>
    const svg = document.getElementById('changan-svg');
    const info = document.getElementById('info');
    const searchInput = document.getElementById('search');
    const resetBtn = document.getElementById('resetBtn');
    const editToggle = document.getElementById('editToggle');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const ioArea = document.getElementById('ioArea');
    const bgToggle = document.getElementById('bgToggle');
    const bgImage = document.getElementById('bgImage');

    // 依參考圖調整：長方形方格（寬>高），去除獨立大道方塊
    const unitX = 76; // 單位格寬
    const unitY = 44; // 單位格高（比寬矮，形成橫向長方形）
    const cityPadding = 36; // 城牆與內容間距
    const cols = 12; // 橫向格數
    const rows = 12; // 縱向格數

    // 基礎群組
    const root = createSvg('g', { id: 'root' });
    svg.appendChild(root);

    // 城牆邊界
    const cityWidth = cols * unitX + cityPadding * 2;
    const cityHeight = rows * unitY + cityPadding * 2 + 120; // 底部留白
    const cityX = (1400 - cityWidth) / 2;
    const cityY = 96; // 頂部留出空間給大明宮
    const cityBorder = createSvg('rect', {
      x: cityX,
      y: cityY,
      width: cityWidth,
      height: cityHeight,
      class: 'city-border'
    });
    root.appendChild(cityBorder);

    // 功能：建立區塊
    function addZone({ id, x, y, w = 1, h = 1, name, type, row = null, col = null }) {
      const rect = createSvg('rect', {
        x: cityX + cityPadding + x * unitX,
        y: cityY + cityPadding + y * unitY,
        width: w * unitX - 6,
        height: h * unitY - 6,
        rx: 6,
        ry: 6,
        class: `zone ${type}`,
        'data-id': id,
        'data-name': name,
        'data-type': type,
        'data-row': row == null ? '' : String(row),
        'data-col': col == null ? '' : String(col),
        tabindex: 0,
        role: 'button',
        'aria-label': name
      });
      rect.addEventListener('click', (e) => {
        if (isEditMode && rect.getAttribute('data-type') === 'ward') {
          e.stopPropagation();
          renameZone(rect);
          return;
        }
        selectZone(rect);
      });
      rect.addEventListener('keydown', (e) => { if (e.key === 'Enter') selectZone(rect); });
      root.appendChild(rect);

      // 置中文字標籤
      const cx = parseFloat(rect.getAttribute('x')) + parseFloat(rect.getAttribute('width')) / 2;
      const cy = parseFloat(rect.getAttribute('y')) + parseFloat(rect.getAttribute('height')) / 2 + 5;
      const text = createSvg('text', { x: cx, y: cy, 'text-anchor': 'middle', class: 'label' });
      text.textContent = name;
      root.appendChild(text);
      return rect;
    }

    // 生成坊網格（避開宮城/市場等特殊區域）
    const specials = [];

    // 宮城（城內上方中央偏上）
    // 以相對比例描述，適配不同 rows/cols 設定
    const royal = addZone({ id: 'royal-city', x: cols * 0.30, y: rows * 0.10, w: cols * 0.40, h: rows * 0.34, name: '皇城', type: 'palace' });
    specials.push(royal);
    specials.push(addZone({ id: 'taiji-palace', x: cols * 0.38, y: rows * 0.14, w: cols * 0.24, h: rows * 0.14, name: '太極宮', type: 'palace' }));

    // 東市與西市（城中偏中）
    specials.push(addZone({ id: 'west-market', x: cols * 0.10, y: rows * 0.46, w: cols * 0.18, h: rows * 0.18, name: '西市', type: 'market' }));
    specials.push(addZone({ id: 'east-market', x: cols * 0.72, y: rows * 0.46, w: cols * 0.18, h: rows * 0.18, name: '東市', type: 'market' }));

    // 興慶宮與曲江池（右側）
    specials.push(addZone({ id: 'xingqing-palace', x: cols * 0.76, y: rows * 0.22, w: cols * 0.16, h: rows * 0.14, name: '興慶宮', type: 'palace' }));
    specials.push(addZone({ id: 'qujiang', x: cols * 0.80, y: rows * 0.78, w: cols * 0.18, h: rows * 0.18, name: '曲江池', type: 'lake' }));

    // 大明宮（城北，宮城以北、出玄武門，簡化置於城牆上方）
    const daming = createSvg('rect', {
      x: cityX + cityWidth / 2 - unitX * 1.8,
      y: 20,
      width: unitX * 3.6,
      height: unitY * 2.4,
      rx: 8,
      ry: 8,
      class: 'zone imperial',
      'data-id': 'daming-palace',
      'data-name': '大明宮',
      'data-type': 'imperial'
    });
    daming.addEventListener('click', () => selectZone(daming));
    root.appendChild(daming);
    const dmText = createSvg('text', { x: parseFloat(daming.getAttribute('x')) + parseFloat(daming.getAttribute('width')) / 2, y: 20 + unitY * 1.2 + 5, 'text-anchor': 'middle', class: 'label' });
    dmText.textContent = '大明宮';
    root.appendChild(dmText);

    // 生成普通坊：填滿整個城內格網，遇到特殊區域則跳過
    const wards = [];
    const occupied = [];
    function markOccupied(x, y, w, h) {
      for (let i = Math.floor(x * 10); i < Math.ceil((x + w) * 10); i++) {
        for (let j = Math.floor(y * 10); j < Math.ceil((y + h) * 10); j++) {
          occupied.push(`${i}:${j}`);
        }
      }
    }
    specials.forEach(r => {
      const x = (parseFloat(r.getAttribute('x')) - (cityX + cityPadding)) / unitX;
      const y = (parseFloat(r.getAttribute('y')) - (cityY + cityPadding)) / unitY;
      const w = parseFloat(r.getAttribute('width')) / unitX;
      const h = parseFloat(r.getAttribute('height')) / unitY;
      markOccupied(x, y, w, h);
    });

    function isOccupied(cx, cy) {
      // 使用 0.1 精度檢查
      return occupied.includes(`${Math.floor(cx * 10)}:${Math.floor(cy * 10)}`);
    }

    let wardIndex = 1;
    const centerCol = Math.floor(cols/2);
    const centerRow = Math.floor(rows/2);
    for (let y = 0; y < rows; y++) {
      for (let x = 0; x < cols; x++) {
        const fx = x;
        const fy = y;
        // 取消獨立大道方塊，統一用間距表現道路
        // 檢查是否與特殊區域重疊
        const cx = fx + 0.5;
        const cy = fy + 0.5;
        if (isOccupied(cx, cy)) continue;
        const rect = addZone({ id: `ward-${wardIndex}`, x: fx, y: fy, name: `坊${wardIndex}`, type: 'ward', row: y, col: x });
        wards.push(rect);
        wardIndex++;
      }
    }

    // 顯示格序切換
    createGridIndexToggle();

    // 名稱保存/編輯支持
    const STORAGE_KEY = 'changanWardNamesV1';
    let isEditMode = false;

    function loadWardNames() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const mapping = JSON.parse(saved);
        for (const id in mapping) {
          const el = svg.querySelector(`[data-id="${id}"]`);
          if (!el) continue;
          setZoneName(el, mapping[id]);
        }
      } catch (err) { /* 忽略 */ }
    }

    function exportWardNames() {
      const mapping = {};
      svg.querySelectorAll('.zone.ward').forEach(el => {
        const id = el.getAttribute('data-id');
        mapping[id] = {
          name: el.getAttribute('data-name'),
          row: Number(el.getAttribute('data-row') || -1),
          col: Number(el.getAttribute('data-col') || -1)
        };
      });
      const json = JSON.stringify(mapping, null, 2);
      ioArea.style.display = 'block';
      ioArea.value = json;
      return json;
    }

    function importWardNames(json) {
      try {
        const mapping = JSON.parse(json);
        if (Array.isArray(mapping)) {
          // 支援陣列格式：[{row,col,name}]
          mapping.forEach(item => {
            const el = svg.querySelector(`.zone.ward[data-row="${item.row}"][data-col="${item.col}"]`);
            if (el) setZoneName(el, item.name);
          });
        } else {
          for (const id in mapping) {
            const record = mapping[id];
            const el = svg.querySelector(`[data-id="${id}"]`) || (record && svg.querySelector(`.zone.ward[data-row="${record.row}"][data-col="${record.col}"]`));
            if (!el) continue;
            const name = typeof record === 'string' ? record : record.name;
            setZoneName(el, name);
          }
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(mapping));
        alert('已匯入並保存。');
      } catch (e) {
        alert('JSON 格式錯誤');
      }
    }

    function setZoneName(el, newName) {
      el.setAttribute('data-name', newName);
      // 更新對應文字標籤（下一個 text 兄弟是同一區塊的標籤）
      const x = parseFloat(el.getAttribute('x')) + parseFloat(el.getAttribute('width')) / 2;
      const y = parseFloat(el.getAttribute('y')) + parseFloat(el.getAttribute('height')) / 2 + 5;
      // 找到最接近的 text（用座標匹配）
      const texts = Array.from(svg.querySelectorAll('text.label'));
      const target = texts.find(t => Math.abs(parseFloat(t.getAttribute('x')) - x) < 1 && Math.abs(parseFloat(t.getAttribute('y')) - y) < 1);
      if (target) target.textContent = newName;
    }

    function renameZone(rect) {
      const oldName = rect.getAttribute('data-name') || '';
      const newName = prompt('輸入新的坊名：', oldName);
      if (!newName) return;
      setZoneName(rect, newName);
      // 保存
      const saved = localStorage.getItem(STORAGE_KEY);
      const mapping = saved ? JSON.parse(saved) : {};
      mapping[rect.getAttribute('data-id')] = newName;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(mapping));
    }

    function selectZone(el) {
      svg.querySelectorAll('.zone').forEach(n => n.classList.remove('selected'));
      el.classList.add('selected');
      const name = el.getAttribute('data-name');
      const type = el.getAttribute('data-type');
      const id = el.getAttribute('data-id');
      info.innerHTML = `<div style="margin-bottom:6px; font-weight:700; font-size:18px;">${name}</div>
        <div class="muted" style="margin-bottom:8px;">類型：${typeLabel(type)}　代號：${id || '—'}</div>
        <div style="font-size:14px; line-height:1.6;">
          這是一個可點擊的示意區塊。您可以將名稱配置為真實坊名，或連結到對應的歷史介紹頁面。
        </div>`;
    }

    function typeLabel(t) {
      switch (t) {
        case 'ward': return '坊';
        case 'market': return '市';
        case 'palace': return '宮城';
        case 'imperial': return '大明宮';
        case 'lake': return '水域';
        case 'avenue': return '大道';
        default: return t || '區域';
      }
    }

    // 搜尋定位
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.trim();
      if (!q) return;
      const target = Array.from(svg.querySelectorAll('.zone')).find(el => {
        const nm = (el.getAttribute('data-name') || '').toLowerCase();
        const id = (el.getAttribute('data-id') || '').toLowerCase();
        return nm.includes(q.toLowerCase()) || id.includes(q.toLowerCase());
      });
      if (target) selectZone(target);
    });

    resetBtn.addEventListener('click', () => {
      svg.querySelectorAll('.zone').forEach(n => n.classList.remove('selected'));
      info.innerHTML = '<div class="muted">點擊地圖中的任一區塊以查看詳細資訊。</div>';
      searchInput.value = '';
    });

    editToggle.addEventListener('click', () => {
      isEditMode = !isEditMode;
      editToggle.setAttribute('aria-pressed', String(isEditMode));
      editToggle.textContent = `名稱編輯模式：${isEditMode ? '開' : '關'}`;
      if (isEditMode) {
        info.innerHTML = '<div>編輯模式已開啟：點擊任一「坊」即可改名，變更會自動保存（本機）。</div>';
      }
    });

    exportBtn.addEventListener('click', () => {
      const json = exportWardNames();
      // 嘗試下載檔案
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'changan_wards.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => {
      ioArea.style.display = 'block';
      if (!ioArea.value) ioArea.placeholder = '將 JSON 名稱映射貼到這裡，然後再次點擊「匯入」執行';
      else importWardNames(ioArea.value);
    });

    // 簡易 SVG 工具
    function createSvg(tag, attrs) {
      const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
      for (const k in attrs) el.setAttribute(k, attrs[k]);
      return el;
    }

    function createGridIndexToggle() {
      const btn = document.createElement('button');
      btn.textContent = '顯示格序：關';
      btn.className = 'btn';
      btn.style.margin = '8px 0 0 0';
      const panel = document.querySelector('.panel > div');
      panel.appendChild(btn);
      let on = false;
      let overlays = [];
      btn.addEventListener('click', () => {
        on = !on;
        btn.textContent = `顯示格序：${on ? '開' : '關'}`;
        if (on) {
          overlays = Array.from(svg.querySelectorAll('.zone.ward')).map(el => {
            const x = parseFloat(el.getAttribute('x')) + 6;
            const y = parseFloat(el.getAttribute('y')) + 16;
            const t = createSvg('text', { x, y, class: 'label', 'text-anchor': 'start', fill: '#6b7280' });
            t.textContent = `r${el.getAttribute('data-row')}-c${el.getAttribute('data-col')}`;
            root.appendChild(t);
            return t;
          });
        } else {
          overlays.forEach(o => o.remove());
          overlays = [];
        }
      });
    }

    // 啟動時嘗試載入本機保存的坊名
    loadWardNames();

    // 參考圖背景顯示開關
    bgToggle.addEventListener('click', () => {
      const isOn = bgImage.style.display !== 'none';
      if (isOn) {
        bgImage.style.display = 'none';
      } else {
        bgImage.style.display = 'block';
      }
      bgToggle.setAttribute('aria-pressed', String(!isOn));
      bgToggle.textContent = `參考圖背景：${!isOn ? '開' : '關'}`;
    });
  </script>
</body>
</html>


