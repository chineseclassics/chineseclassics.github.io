<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼˜ç«‹æ›¸é™¢å°ç« è¨­è¨ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap">
    <!-- åŠ è¼‰è½éœå­¤é¶©æ–‡æ¥·å­—é«” -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    <!-- åŠ è¼‰ç¯†é«”å­—é«” -->
    <style>
        @font-face {
            font-family: 'ChongXi Seal';
            src: url('https://chineseclassics.github.io/files/chongxi_seal.otf') format('opentype'),
                 url('http://chineseclassics.github.io/files/chongxi_seal.otf') format('opentype');
            font-display: swap;
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'ZiYue Seal';
            src: url('https://chineseclassics.github.io/files/ZIYueJiuDieYinZhuan-Regular.ttf') format('truetype');
            font-display: swap;
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'HuaKang Seal';
            src: url('https://chineseclassics.github.io/files/huakangxinzhuan.ttf') format('truetype');
            font-display: swap;
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'JiaJin Script';
            src: url('https://chineseclassics.github.io/files/jiajinwen.ttf') format('truetype');
            font-display: swap;
            font-weight: normal;
            font-style: normal;
        }
    </style>
    <style>
        :root {
            --primary-color: #8B4513;
            --primary-light: #A0522D;
            --primary-dark: #654321;
            --seal-color: #B22222;
            --accent-gold: #D4AF37;
            --bg-warm: #FAF9F6;
            --bg-card: #FFFFFF;
            --text-primary: #2F2F2F;
            --text-secondary: #666666;
            --border-light: #E8E6E0;
            --shadow-soft: rgba(139, 69, 19, 0.1);
        }
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-warm);
            color: var(--text-primary);
        }
        
        .seal-container {
            background-color: white;
            position: relative;
            overflow: hidden;
            width: 400px;
            height: 400px;
            margin: 0 auto;
        }
        
        #sealCanvas {
            max-width: 100%;
            height: auto;
        }
        
        .shape-option {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .shape-option:hover, .shape-option.selected {
            border-color: var(--primary-color);
        }
        
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å¯æ‹–åŠ¨å­—ç¬¦æ¨£å¼ */
        .draggable-char {
            position: absolute;
            cursor: move;
            user-select: none;
            color: white;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 4px;
            pointer-events: auto;
        }
        
        .draggable-char:hover {
            transform: scale(1.05);
        }
        
        .draggable-char.dragging {
            opacity: 0.8;
            z-index: 100;
        }
        
        .draggable-char.selected {
            z-index: 10;
        }
        
        /* é™°åˆ»æ¨¡å¼ä¸‹çš„é¸ä¸­é‚Šæ¡† */
        .draggable-char.selected.intaglio {
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }
        
        /* é™½åˆ»æ¨¡å¼ä¸‹çš„é¸ä¸­é‚Šæ¡† */
        .draggable-char.selected.relief {
            border-color: var(--accent-gold);
            box-shadow: 0 0 8px var(--shadow-soft);
        }
        
        /* å­—ä½“å¤§å°è°ƒæ•´æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--accent-gold);
            border: 2px solid white;
            border-radius: 50%;
            cursor: nw-resize;
            display: none;
            box-shadow: 0 2px 4px var(--shadow-soft);
            z-index: 15;
        }
        
        .resize-handle.bottom-right {
            bottom: -4px;
            right: -4px;
        }
        
        .resize-handle.top-left {
            top: -4px;
            left: -4px;
        }
        
        .draggable-char.selected .resize-handle {
            display: block;
        }
        
        .resize-handle:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .resize-handle.resizing {
            background: var(--primary-dark);
            transform: scale(1.2);
        }
        
        /* æç¤ºä¿¡æ¯ */
        .drag-instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            pointer-events: none;
            z-index: 5;
        }
        
        /* å­—é«”å¤§å°æ§åˆ¶å€ */
        .font-size-controls {
            margin-top: 12px;
            padding: 8px;
            border-radius: 8px;
            background-color: var(--bg-warm);
            border: 1px solid var(--border-light);
        }
        
        .size-value {
            display: inline-block;
            width: 40px;
            text-align: center;
        }
        
        /* å­—é«”å¡ç‰‡æ¨£å¼ */
        .font-card {
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .font-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .font-card.selected {
            border-color: var(--primary-color) !important;
            background-color: rgba(139, 69, 19, 0.05);
            box-shadow: 0 6px 20px var(--shadow-soft);
        }
        

        
        .font-preview {
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* å­—é«”é¸æ“‡å®¹å™¨æ»¾å‹•æ¨£å¼ */
        .font-selection-container {
            scrollbar-width: thin;
            scrollbar-color: var(--shadow-soft) transparent;
        }
        
        .font-selection-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .font-selection-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .font-selection-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 3px;
            opacity: 0.4;
        }
        
        .font-selection-container::-webkit-scrollbar-thumb:hover {
            opacity: 0.7;
        }
        
        /* åˆ»å°æ–¹å¼å¡ç‰‡æ¨£å¼ */
        .carving-option {
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .carving-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .carving-option.selected {
            border-color: var(--primary-color) !important;
            background-color: rgba(139, 69, 19, 0.05);
            box-shadow: 0 6px 20px var(--shadow-soft);
        }
        

        
        /* ç¹ªåœ–ç•«å¸ƒæ¨£å¼ */
        .canvas-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #drawCanvas {
            z-index: 40;
            cursor: crosshair;
            display: none;
            background-color: transparent;
        }
        
        #displayCanvas {
            z-index: 20;
            pointer-events: none;
            background-color: transparent;
        }
        
        /* ç¹ªåœ–æ¨¡å¼ä¸‹çš„cursor */
        .drawing-mode {
            cursor: crosshair !important;
        }
        
        /* ç¹ªåœ–æŒ‰éˆ•å’Œç­†ç•«ç²—ç´°æ§åˆ¶ */
        .drawing-controls {
            margin-top: 12px;
            padding: 8px;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.05);
        }
        

        
        /* åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* è‡ªå®šç¾©æ»‘å¡Šæ¨£å¼ */
        .thickness-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 6px;
            background: linear-gradient(to right, var(--border-light), var(--primary-light));
            border-radius: 3px;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .thickness-slider:hover {
            box-shadow: 0 2px 8px var(--shadow-soft);
        }
        
        /* WebKit æ»‘å¡Šæ‹‡æŒ‡æ¨£å¼ */
        .thickness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--accent-gold), #B8860B);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
            border: 2px solid white;
        }
        
        .thickness-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.5);
        }
        
        /* Firefox æ»‘å¡Šæ¨£å¼ */
        .thickness-slider::-moz-range-track {
            width: 100%;
            height: 6px;
            background: linear-gradient(to right, var(--border-light), var(--primary-light));
            border-radius: 3px;
            border: none;
        }
        
        .thickness-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--accent-gold), #B8860B);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
            border: 2px solid white;
        }
        
        .thickness-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.5);
        }
        
        /* Edge æ»‘å¡Šæ¨£å¼ */
        .thickness-slider::-ms-track {
            width: 100%;
            height: 6px;
            background: transparent;
            border-color: transparent;
            color: transparent;
        }
        
        .thickness-slider::-ms-fill-lower {
            background: var(--border-light);
            border-radius: 3px;
        }
        
        .thickness-slider::-ms-fill-upper {
            background: var(--primary-light);
            border-radius: 3px;
        }
        
        .thickness-slider::-ms-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--accent-gold), #B8860B);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
            border: 2px solid white;
        }
        
        /* æ»‘å¡Šå®¹å™¨æ¨£å¼ */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        
        .slider-container:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px var(--shadow-soft);
        }
        
        /* æ»‘å¡Šæ•¸å€¼é¡¯ç¤º */
        .thickness-value {
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-dark);
            min-width: 20px;
            text-align: center;
            background: var(--bg-warm);
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
        }
        
        .drawing-mode-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        #drawingThickness {
            margin-top: 8px;
        }
        
        /* æ¸…ç©ºç¹ªåœ–æŒ‰éˆ• */
        #clearDrawingBtn {
            margin-top: 8px;
        }
        
        /* ç•¶å‰ç¹ªåœ–ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .drawing-status {
            font-size: 12px;
            margin-top: 4px;
            text-align: center;
            padding: 2px 4px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        .drawing-status.active {
            display: block;
            background-color: var(--shadow-soft);
            color: var(--primary-color);
        }
        

        
        /* å°ˆé–€ç”¨æ–¼ä¸‹è¼‰çš„éš±è—ç•«å¸ƒ */
        #downloadCanvas {
            display: none;
            position: absolute;
            pointer-events: none;
        }
        
        /* ä¸‹è¼‰è¨Šæ¯ */
        #downloadMessage {
            display: none;
            font-size: 14px;
            padding: 8px;
            margin-top: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        #downloadMessage.success {
            background-color: rgba(16, 185, 129, 0.2);
            color: #10b981;
            display: block;
        }
        
        #downloadMessage.error {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            display: block;
        }

        /* ç§»å‹•ç«¯å„ªåŒ– */
        @media (max-width: 1023px) {
            /* èª¿æ•´å®¹å™¨é–“è· */
            .container {
                padding: 0.5rem;
            }
            
            /* èª¿æ•´æ¨™é¡Œå¤§å° */
            header h1 {
                font-size: 1.5rem !important;
            }
            
            /* å°ç« å®¹å™¨åœ¨ç§»å‹•ç«¯ç¸®å° */
            .seal-container {
                width: 300px;
                height: 300px;
            }
            
            /* èª¿æ•´å­—é«”å¡ç‰‡åœ¨ç§»å‹•ç«¯çš„å¤§å° */
            .font-card {
                padding: 0.5rem !important;
            }
            
            .font-preview {
                font-size: 1rem !important;
            }
            
            /* èª¿æ•´åˆ»å°æ–¹å¼å¡ç‰‡ */
            .carving-option {
                padding: 0.5rem !important;
            }
            
            .carving-preview {
                width: 2rem !important;
                height: 2rem !important;
            }
            
            /* ç¹ªåœ–æ§åˆ¶å€åœ¨ç§»å‹•ç«¯çš„èª¿æ•´ */
            .drawing-controls-mobile {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            /* æŒ‰éˆ•åœ¨ç§»å‹•ç«¯å¢å¤§è§¸æ‘¸é¢ç© */
            .mobile-button {
                min-height: 44px;
                font-size: 0.875rem;
            }
            
            /* æ»‘å¡Šå®¹å™¨åœ¨ç§»å‹•ç«¯çš„èª¿æ•´ */
            .slider-container {
                padding: 6px 8px;
            }
            
            /* èª¿æ•´æ“ä½œæŒ‰éˆ•å€åŸŸ */
            .action-buttons-mobile {
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 640px) {
            /* æ¥µå°å±å¹•çš„é¡å¤–å„ªåŒ– */
            .seal-container {
                width: 250px;
                height: 250px;
            }
            
            /* ç¹ªåœ–å·¥å…·åœ¨å°å±å¹•ä¸Šå‚ç›´æ’åˆ— */
            .drawing-tools-small {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .drawing-tools-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }
            
            /* èª¿æ•´å­—é«”é¸æ“‡å€åŸŸé«˜åº¦ */
            .font-selection-container {
                max-height: 200px;
            }
            
            /* ç¢ºä¿è§¸æ‘¸å‹å¥½çš„é–“è· */
            .mobile-spacing {
                margin-bottom: 0.75rem;
            }
        }
    </style>
</head>
<body class="min-h-screen" style="background-color: var(--bg-warm); color: var(--text-primary);">
    <div class="container mx-auto px-4 py-2 max-w-7xl h-screen flex flex-col">
        <header class="text-center mb-2 flex-shrink-0">
            <h1 class="text-2xl md:text-3xl font-bold mb-2" style="color: var(--primary-dark);">å¼˜ç«‹æ›¸é™¢å°ç« è¨­è¨ˆ</h1>
            <p class="text-sm" style="color: var(--text-secondary);">è‡ªå®šç¾©æ‚¨çš„å°ˆå±¬å°ç« è¨­è¨ˆ</p>
            <div class="w-12 h-0.5 mx-auto mt-2 rounded-full" style="background-color: var(--accent-gold);"></div>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
            <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
            <div class="lg:col-span-1 bg-white shadow-lg rounded-xl p-4 flex flex-col h-full" style="border: 1px solid var(--border-light);">
                <div class="flex items-center justify-center mb-4">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold mb-1" style="color: var(--primary-dark);">è¨­è¨ˆåƒæ•¸</h3>
                        <div class="w-12 h-0.5 mx-auto" style="background-color: var(--accent-gold);"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="nameInput" class="block font-medium mb-2" style="color: var(--text-primary);">å°ç« æ–‡å­—</label>
                    <input id="nameInput" type="text" class="w-full rounded-md px-3 py-2 text-base" style="border: 1px solid var(--border-light); background-color: var(--bg-card); color: var(--text-primary); outline: none;" placeholder="è¼¸å…¥æ‚¨çš„å§“åæˆ–æ–‡å­—" value="ç‹å¤§æ˜å°">
                </div>
                
                <div class="mb-3">
                    <label class="block font-medium mb-2" style="color: var(--text-primary);">åˆ»å°æ–¹å¼</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="carving-option cursor-pointer border-2 border-primary-500 rounded-lg p-2 text-center transition-all duration-200 hover:border-primary-400 selected" data-carving="intaglio">
                            <div class="carving-preview w-10 h-10 mx-auto mb-1 rounded border-2 flex items-center justify-center text-xs font-bold" style="background-color: #d62828; color: white; border-color: #d62828;">
                                å°
                            </div>
                            <span class="text-sm">é™°åˆ»</span>
                            <div class="text-xs text-gray-500 mt-0.5">å‡¹åˆ»ãƒ»ç™½å­—ç´…åº•</div>
                        </div>
                        <div class="carving-option cursor-pointer border-2 border-gray-300 rounded-lg p-2 text-center transition-all duration-200 hover:border-primary-400" data-carving="relief">
                            <div class="carving-preview w-10 h-10 mx-auto mb-1 rounded border-2 flex items-center justify-center text-xs font-bold" style="background-color: white; color: #d62828; border-color: #d62828;">
                                å°
                            </div>
                            <span class="text-sm">é™½åˆ»</span>
                            <div class="text-xs text-gray-500 mt-0.5">å‡¸åˆ»ãƒ»ç´…å­—ç™½åº•</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 flex flex-col min-h-0">
                    <label class="block font-medium mb-2" style="color: var(--text-primary);">å­—é«”é¸æ“‡</label>
                    <div class="font-selection-container flex-1 overflow-y-auto pr-2" style="min-height: 0;">
                        <div class="grid grid-cols-1 gap-2">
                        <!-- ç¯†é«”ä¸€å¡ç‰‡ -->
                        <div class="font-card cursor-pointer border-2 border-gray-300 rounded-lg p-3 transition-all duration-200 hover:border-primary-400" data-font="'ChongXi Seal'">
                            <div class="font-preview text-xl font-bold text-gray-800 mb-1" style="font-family: 'ChongXi Seal';">
                                ç‹å¤§æ˜å°
                            </div>
                            <div class="font-name text-sm text-gray-600">
                                ç¯†é«”ä¸€
                            </div>
                        </div>
                        
                        <!-- ç¯†é«”äºŒå¡ç‰‡ -->
                        <div class="font-card cursor-pointer border-2 border-gray-300 rounded-lg p-3 transition-all duration-200 hover:border-primary-400" data-font="'ZiYue Seal'">
                            <div class="font-preview text-xl font-bold text-gray-800 mb-1" style="font-family: 'ZiYue Seal';">
                                ç‹å¤§æ˜å°
                            </div>
                            <div class="font-name text-sm text-gray-600">
                                ç¯†é«”äºŒ
                            </div>
                        </div>
                        
                        <!-- ç¯†é«”ä¸‰å¡ç‰‡ -->
                        <div class="font-card cursor-pointer border-2 border-gray-300 rounded-lg p-3 transition-all duration-200 hover:border-primary-400" data-font="'HuaKang Seal'">
                            <div class="font-preview text-xl font-bold text-gray-800 mb-1" style="font-family: 'HuaKang Seal';">
                                ç‹å¤§æ˜å°
                            </div>
                            <div class="font-name text-sm text-gray-600">
                                ç¯†é«”ä¸‰
                            </div>
                        </div>
                        
                        <!-- é‡‘æ–‡å¡ç‰‡ -->
                        <div class="font-card cursor-pointer border-2 border-gray-300 rounded-lg p-3 transition-all duration-200 hover:border-primary-400" data-font="'JiaJin Script'">
                            <div class="font-preview text-xl font-bold text-gray-800 mb-1" style="font-family: 'JiaJin Script';">
                                ç‹å¤§æ˜å°
                            </div>
                            <div class="font-name text-sm text-gray-600">
                                é‡‘æ–‡
                            </div>
                        </div>
                        
                        <!-- è½éœå­¤é¶©æ–‡æ¥·å¡ç‰‡ -->
                        <div class="font-card cursor-pointer border-2 border-primary-500 rounded-lg p-3 transition-all duration-200 hover:border-primary-400 selected" data-font="'LXGW WenKai'">
                            <div class="font-preview text-xl font-bold text-gray-800 mb-1" style="font-family: 'LXGW WenKai';">
                                ç‹å¤§æ˜å°
                            </div>
                            <div class="font-name text-sm text-gray-600">
                                è½éœå­¤é¶©æ–‡æ¥·
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- å³å´é è¦½å€ -->
            <div class="lg:col-span-2 flex flex-col h-full">
                <div class="bg-white shadow-lg rounded-xl p-4 flex-1 flex flex-col" style="border: 1px solid var(--border-light);">
                    <div class="flex items-center justify-center mb-3">
                        <div class="text-center">
                            <h3 class="text-lg font-semibold mb-1" style="color: var(--primary-dark);">å°ç« é è¦½</h3>
                            <div class="w-12 h-0.5 mx-auto" style="background-color: var(--accent-gold);"></div>
                        </div>
                    </div>
                    
                    <!-- ç¹ªåœ–æ§åˆ¶å€ -->
                    <div class="bg-gray-50 rounded-lg p-2 mb-2 mt-2" style="border: 1px solid var(--border-light);">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-2 md:space-y-0">
                            <div class="text-sm font-medium" style="color: var(--text-primary);">
                                ç¹ªåœ–å·¥å…·
                            </div>
                            
                            <div class="flex flex-wrap items-center gap-3 text-sm">
                                <div class="flex items-center space-x-2">
                                    <span style="color: var(--text-secondary);">ç¹ªåœ–:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="drawingModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <span style="color: var(--text-secondary);">æ©¡çš®æ“¦:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="eraserModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="slider-container">
                                    <span style="color: var(--text-secondary);">ç²—ç´°:</span>
                                    <input id="drawingThickness" type="range" min="1" max="20" value="3" class="thickness-slider" />
                                    <span id="thicknessValue" class="thickness-value">3</span>
                                </div>
                                
                                <button id="clearDrawingBtn" class="text-white px-3 py-1 rounded-md text-xs font-medium transition-colors hover:opacity-90" style="background-color: var(--text-secondary);">
                                    æ¸…ç©º
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å°ç« å®¹å™¨åŒºåŸŸ - é©ä¸­ä½ç½® -->
                    <div class="flex-1 flex items-center justify-center pt-4">
                        <div id="sealContainer" class="seal-container rounded-lg flex items-center justify-center">
                            <div id="loadingIndicator" class="loader hidden"></div>
                            
                            <!-- å°ç« èƒŒæ™¯å±¤ -->
                            <div id="sealBackground" class="absolute inset-0 z-10"></div>
                            
                            <!-- é¡¯ç¤ºç¹ªåœ–å±¤ -->
                            <canvas id="displayCanvas" class="canvas-layer"></canvas>
                            
                            <!-- å­—ç¬¦å±¤ - ç¢ºä¿é€™ä¸€å±¤åœ¨ç¹ªåœ–å±¤ä¸Šé¢ -->
                            <div id="charContainer" class="absolute inset-0 z-30"></div>
                            
                            <!-- ç¹ªåœ–ç”¨Canvaså±¤ - åªåœ¨ç¹ªåœ–æ¨¡å¼ä¸‹é¡¯ç¤ºï¼Œä½æ–¼æœ€ä¸Šå±¤ -->
                            <canvas id="drawCanvas" class="canvas-layer"></canvas>
                            
                            <!-- ä¸‹è¼‰ç”¨çš„ç•«å¸ƒ -->
                            <canvas id="downloadCanvas"></canvas>
                            
                            <div class="drag-instructions z-5">é»æ“Šä¸¦æ‹–å‹•å­—ç¬¦èª¿æ•´ä½ç½®ï¼Œæ‹–æ‹½å³ä¸‹è§’è—è‰²åœ“é»èª¿æ•´å¤§å°</div>
                            
                            <!-- ç¹ªåœ–ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                            <div id="drawingStatus" class="drawing-status">
                                ç¹ªåœ–æ¨¡å¼å·²å•Ÿç”¨
                            </div>
                        </div>
                    </div>
                    
                    <!-- å°ç« é è¦½åº•éƒ¨æç¤ºæ–‡å­— -->
                    <div class="mt-2 text-center">
                        <span id="previewInstructions" class="text-sm text-gray-500">é»æ“Šå­—ç¬¦å¯èª¿æ•´å¤§å°</span>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                    <div class="mt-4 pt-3 border-t" style="border-color: var(--border-light);">
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <button id="resetPositionsBtn" class="w-full text-white font-medium py-2 px-3 rounded-lg transition-all duration-200 hover:shadow-md transform hover:scale-105 text-sm" style="background-color: var(--text-secondary);">
                                    é‡ç½®ä½ç½®
                                </button>
                                <button id="resetSizesBtn" class="w-full text-white font-medium py-2 px-3 rounded-lg transition-all duration-200 hover:shadow-md transform hover:scale-105 text-sm" style="background-color: var(--text-secondary);">
                                    é‡ç½®å¤§å°
                                </button>
                            </div>
                            
                            <div class="space-y-2">
                                <button id="downloadBtn" class="w-full text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 hover:shadow-lg transform hover:scale-105" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-light));">
                                    ğŸ“¥ ä¸‹è¼‰æ­£å­—å°ç«  (PNG)
                                </button>
                                <button id="downloadSvgBtn" class="w-full text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 hover:shadow-lg transform hover:scale-105" style="background: linear-gradient(135deg, var(--accent-gold), #B8860B);">
                                    âš¡ ä¸‹è¼‰åå­—å°ç«  (SVGæ¿€å…‰åˆ‡å‰²)
                                </button>
                            </div>
                        </div>
                        
                        <div id="downloadMessage" class="mt-3"></div>
                        <p class="text-xs mt-2 text-center" style="color: var(--text-secondary);">PNGç”¨æ–¼æŸ¥çœ‹æ•ˆæœï¼ŒSVGåå­—ç”¨æ–¼æ¿€å…‰åˆ‡å‰²</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>

        
        // ç²å–DOMå…ƒç´ 
        const nameInput = document.getElementById('nameInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetPositionsBtn = document.getElementById('resetPositionsBtn');
        const resetSizesBtn = document.getElementById('resetSizesBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const sealBackground = document.getElementById('sealBackground');
        const charContainer = document.getElementById('charContainer');
        const sealContainer = document.getElementById('sealContainer');
        const previewInstructions = document.getElementById('previewInstructions');
        const downloadMessage = document.getElementById('downloadMessage');
        
        // ç¹ªåœ–ç›¸é—œå…ƒç´  - å®Œå…¨é‡æ§‹ç¹ªåœ–åŠŸèƒ½
        const drawCanvas = document.getElementById('drawCanvas');
        const displayCanvas = document.getElementById('displayCanvas');
        const downloadCanvas = document.getElementById('downloadCanvas');
        const drawingModeToggle = document.getElementById('drawingModeToggle');
        const eraserModeToggle = document.getElementById('eraserModeToggle');
        const drawingThickness = document.getElementById('drawingThickness');
        const clearDrawingBtn = document.getElementById('clearDrawingBtn');
        const drawingStatus = document.getElementById('drawingStatus');
        
        // ç¹ªåœ–ä¸Šä¸‹æ–‡
        const drawCtx = drawCanvas.getContext('2d');
        const displayCtx = displayCanvas.getContext('2d');
        const downloadCtx = downloadCanvas.getContext('2d');
        
        // å­—é«”å¡ç‰‡ç›¸é—œå…ƒç´ 
        const fontCards = document.querySelectorAll('.font-card');
        let currentFont = "'LXGW WenKai'"; // é»˜èªå­—é«”
        
        // åˆ»å°æ–¹å¼ç›¸é—œå…ƒç´ 
        const carvingOptions = document.querySelectorAll('.carving-option');
        let currentCarving = 'intaglio'; // é»˜èªé™°åˆ»
        
        // å°ç« å½¢ç‹€é¸æ“‡
        const shapeOptions = document.querySelectorAll('.shape-option');
        let currentShape = 'square';
        
        // å­—ç¬¦æ•¸æ“š
        let charPositions = [];
        let charSizes = {};
        
        // ç”¨æ–¼å­˜å„²æ¯å€‹å­—ç¬¦çš„domå…ƒç´ å¼•ç”¨
        let charElements = [];
        
        // ç•¶å‰é¸ä¸­çš„å­—ç¬¦
        let selectedCharIndex = null;
        
        // å°ç« åƒæ•¸ - æ ¹æ“šå±å¹•å°ºå¯¸å‹•æ…‹èª¿æ•´
        let sealSize = 350;
        let padding = 30;
        let defaultFontSize = 120;
        
        // æª¢æ¸¬å±å¹•å°ºå¯¸ä¸¦èª¿æ•´åƒæ•¸
        function updateSealParameters() {
            const screenWidth = window.innerWidth;
            
            if (screenWidth <= 640) {
                // æ‰‹æ©Ÿç«¯ï¼š250x250
                sealSize = 250;
                padding = 20;
                defaultFontSize = 80;
            } else if (screenWidth <= 1023) {
                // å¹³æ¿ç«¯ï¼š300x300
                sealSize = 300;
                padding = 25;
                defaultFontSize = 100;
            } else {
                // æ¡Œé¢ç«¯ï¼š350x350
                sealSize = 350;
                padding = 30;
                defaultFontSize = 120;
            }
        }
        
        // åˆå§‹åŒ–åƒæ•¸
        updateSealParameters();
        
        // æ‹–å‹•ç‹€æ…‹
        let isDragging = false;
        let dragTarget = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let targetStartX = 0;
        let targetStartY = 0;
        
        // å­—é«”å¤§å°èª¿æ•´ç‹€æ…‹
        let isResizing = false;
        let resizeStartX = 0;
        let resizeStartY = 0;
        let initialFontSize = 0;
        let resizeHandleType = 'bottom-right'; // 'top-left' æˆ– 'bottom-right'
        
        // ç¹ªåœ–ç‹€æ…‹ - é‡æ§‹
        let isDrawing = false;
        let isDrawingMode = false;
        let isEraserMode = false;
        let prevX = 0;
        let prevY = 0;
        
        // åˆå§‹åŒ–ç•«å¸ƒå¤§å°
        function updateCanvasSize() {
            drawCanvas.width = sealSize;
            drawCanvas.height = sealSize;
            displayCanvas.width = sealSize;
            displayCanvas.height = sealSize;
            downloadCanvas.width = sealSize;
            downloadCanvas.height = sealSize;
        }
        
        updateCanvasSize();
        
        // ç›£è½çª—å£å¤§å°è®ŠåŒ–
        window.addEventListener('resize', function() {
            updateSealParameters();
            updateCanvasSize();
            // é‡æ–°ç”Ÿæˆå°ç« ä»¥é©æ‡‰æ–°çš„åƒæ•¸
            generateSeal();
        });
        
        // ç¹ªåœ–äº‹ä»¶è™•ç†å‡½æ•¸ - å®Œå…¨é‡å¯«
        function setDrawingMode(enabled) {
            isDrawingMode = enabled;
            
            if (enabled) {
                // é¡¯ç¤ºç¹ªåœ–ç•«å¸ƒ
                drawCanvas.style.display = 'block';
                sealContainer.classList.add('drawing-mode');
                drawingStatus.classList.add('active');
                
                // æ ¹æ“šåˆ»å°æ–¹å¼æ›´æ–°èªªæ˜å’Œç¹ªåœ–é¡è‰²
                const drawColor = currentCarving === 'intaglio' ? 'ç™½è‰²' : 'ç´…è‰²';
                previewInstructions.textContent = `ç¹ªåœ–æ¨¡å¼ï¼šåœ¨å°ç« ä¸Šç¹ªè£½${drawColor}ç·šæ¢`;
                document.querySelector('.drag-instructions').textContent = `åœ¨å°ç« ä¸Šç¹ªè£½${drawColor}ç·šæ¢`;
                
                // ç¦ç”¨å­—ç¬¦äº¤äº’ï¼Œä½†ä¿æŒå­—ç¬¦é¡¯ç¤º
                charElements.forEach(char => {
                    char.style.pointerEvents = 'none';
                });
                
                // æ¸…é™¤ç•¶å‰é¸ä¸­ç‹€æ…‹
                unselectChar();
            } else {
                // éš±è—ç¹ªåœ–ç•«å¸ƒ
                drawCanvas.style.display = 'none';
                sealContainer.classList.remove('drawing-mode');
                drawingStatus.classList.remove('active');
                
                // æ¢å¾©èªªæ˜
                previewInstructions.textContent = "é»æ“Šå­—ç¬¦å¯èª¿æ•´å¤§å°";
                document.querySelector('.drag-instructions').textContent = 'é»æ“Šä¸¦æ‹–å‹•å­—ç¬¦èª¿æ•´ä½ç½®ï¼Œæ‹–æ‹½å³ä¸‹è§’è—è‰²åœ“é»èª¿æ•´å¤§å°';
                
                // å•Ÿç”¨å­—ç¬¦äº¤äº’
                charElements.forEach(char => {
                    char.style.pointerEvents = 'auto';
                });
            }
        }
        
        // ç¹ªåœ–é–‹å§‹
        function startDrawing(e) {
            e.preventDefault();
            
            if (!isDrawingMode) return;
            
            isDrawing = true;
            
            const rect = drawCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // è¨ˆç®—ç•«å¸ƒåæ¨™
            const canvasX = (x / rect.width) * drawCanvas.width;
            const canvasY = (y / rect.height) * drawCanvas.height;
            
            prevX = canvasX;
            prevY = canvasY;
            
            if (isEraserMode) {
                // æ©¡çš®æ“¦æ¨¡å¼ï¼šæ“¦é™¤å…§å®¹
                drawCtx.save();
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.beginPath();
                const radius = parseInt(drawingThickness.value) / 2;
                drawCtx.arc(canvasX, canvasY, radius, 0, Math.PI * 2);
                drawCtx.fill();
                drawCtx.restore();
            } else {
                // ç¹ªåœ–æ¨¡å¼ï¼šæ ¹æ“šåˆ»å°æ–¹å¼é¸æ“‡ç¹ªåœ–é¡è‰²
                const drawColor = currentCarving === 'intaglio' ? 'white' : '#d62828';
                
                // ç¹ªè£½ä¸€å€‹é»
                drawCtx.beginPath();
                drawCtx.fillStyle = drawColor;
                const radius = parseInt(drawingThickness.value) / 2;
                drawCtx.arc(canvasX, canvasY, radius, 0, Math.PI * 2);
                drawCtx.fill();
            }
            
            // ç«‹å³æ›´æ–°é¡¯ç¤ºç•«å¸ƒ
            updateDisplayCanvas();
        }
        
        // ç¹ªåœ–éç¨‹
        function draw(e) {
            e.preventDefault();
            
            if (!isDrawing || !isDrawingMode) return;
            
            const rect = drawCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // è¨ˆç®—ç•«å¸ƒåæ¨™
            const canvasX = (x / rect.width) * drawCanvas.width;
            const canvasY = (y / rect.height) * drawCanvas.height;
            
            if (isEraserMode) {
                // æ©¡çš®æ“¦æ¨¡å¼ï¼šæ“¦é™¤å…§å®¹
                drawCtx.save();
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.beginPath();
                drawCtx.lineWidth = parseInt(drawingThickness.value);
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                
                drawCtx.moveTo(prevX, prevY);
                drawCtx.lineTo(canvasX, canvasY);
                drawCtx.stroke();
                drawCtx.restore();
            } else {
                // ç¹ªåœ–æ¨¡å¼ï¼šæ ¹æ“šåˆ»å°æ–¹å¼é¸æ“‡ç¹ªåœ–é¡è‰²
                const drawColor = currentCarving === 'intaglio' ? 'white' : '#d62828';
                
                drawCtx.beginPath();
                drawCtx.strokeStyle = drawColor;
                drawCtx.lineWidth = parseInt(drawingThickness.value);
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                
                drawCtx.moveTo(prevX, prevY);
                drawCtx.lineTo(canvasX, canvasY);
                drawCtx.stroke();
            }
            
            prevX = canvasX;
            prevY = canvasY;
            
            // æ›´æ–°é¡¯ç¤ºç•«å¸ƒ
            updateDisplayCanvas();
        }
        
        // è§¸æ‘¸é–‹å§‹
        function touchStartDrawing(e) {
            e.preventDefault();
            
            if (!isDrawingMode) return;
            
            isDrawing = true;
            
            const rect = drawCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            // è¨ˆç®—ç•«å¸ƒåæ¨™
            const canvasX = (x / rect.width) * drawCanvas.width;
            const canvasY = (y / rect.height) * drawCanvas.height;
            
            prevX = canvasX;
            prevY = canvasY;
            
            if (isEraserMode) {
                // æ©¡çš®æ“¦æ¨¡å¼ï¼šæ“¦é™¤å…§å®¹
                drawCtx.save();
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.beginPath();
                const radius = parseInt(drawingThickness.value) / 2;
                drawCtx.arc(canvasX, canvasY, radius, 0, Math.PI * 2);
                drawCtx.fill();
                drawCtx.restore();
            } else {
                // ç¹ªåœ–æ¨¡å¼ï¼šæ ¹æ“šåˆ»å°æ–¹å¼é¸æ“‡ç¹ªåœ–é¡è‰²
                const drawColor = currentCarving === 'intaglio' ? 'white' : '#d62828';
                
                // ç¹ªè£½ä¸€å€‹é»
                drawCtx.beginPath();
                drawCtx.fillStyle = drawColor;
                const radius = parseInt(drawingThickness.value) / 2;
                drawCtx.arc(canvasX, canvasY, radius, 0, Math.PI * 2);
                drawCtx.fill();
            }
            
            // æ›´æ–°é¡¯ç¤ºç•«å¸ƒ
            updateDisplayCanvas();
        }
        
        // è§¸æ‘¸ç§»å‹•
        function touchDraw(e) {
            e.preventDefault();
            
            if (!isDrawing || !isDrawingMode) return;
            
            const rect = drawCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            // è¨ˆç®—ç•«å¸ƒåæ¨™
            const canvasX = (x / rect.width) * drawCanvas.width;
            const canvasY = (y / rect.height) * drawCanvas.height;
            
            if (isEraserMode) {
                // æ©¡çš®æ“¦æ¨¡å¼ï¼šæ“¦é™¤å…§å®¹
                drawCtx.save();
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.beginPath();
                drawCtx.lineWidth = parseInt(drawingThickness.value);
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                
                drawCtx.moveTo(prevX, prevY);
                drawCtx.lineTo(canvasX, canvasY);
                drawCtx.stroke();
                drawCtx.restore();
            } else {
                // ç¹ªåœ–æ¨¡å¼ï¼šæ ¹æ“šåˆ»å°æ–¹å¼é¸æ“‡ç¹ªåœ–é¡è‰²
                const drawColor = currentCarving === 'intaglio' ? 'white' : '#d62828';
                
                drawCtx.beginPath();
                drawCtx.strokeStyle = drawColor;
                drawCtx.lineWidth = parseInt(drawingThickness.value);
                drawCtx.lineCap = 'round';
                drawCtx.lineJoin = 'round';
                
                drawCtx.moveTo(prevX, prevY);
                drawCtx.lineTo(canvasX, canvasY);
                drawCtx.stroke();
            }
            
            prevX = canvasX;
            prevY = canvasY;
            
            // æ›´æ–°é¡¯ç¤ºç•«å¸ƒ
            updateDisplayCanvas();
        }
        
        // çµæŸç¹ªåœ–
        function stopDrawing() {
            isDrawing = false;
        }
        
        // æ›´æ–°é¡¯ç¤ºç•«å¸ƒï¼ˆå°‡ç¹ªåœ–çµæœè¤‡è£½åˆ°é¡¯ç¤ºç•«å¸ƒï¼‰
        function updateDisplayCanvas() {
            displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
            displayCtx.drawImage(drawCanvas, 0, 0);
        }
        
        // æ¸…ç©ºç¹ªåœ–
        function clearDrawing() {
            drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
            updateDisplayCanvas();
        }
        
        // ç¹ªåœ–æ¨¡å¼åˆ‡æ›äº‹ä»¶
        drawingModeToggle.addEventListener('change', function() {
            setDrawingMode(this.checked);
            
            // ç¹ªåœ–æ¨¡å¼é—œé–‰æ™‚ï¼Œè‡ªå‹•é—œé–‰æ©¡çš®æ“¦æ¨¡å¼
            if (!this.checked && isEraserMode) {
                eraserModeToggle.checked = false;
                isEraserMode = false;
            }
        });
        
        // æ»‘å¡Šæ•¸å€¼æ›´æ–°äº‹ä»¶
        const thicknessValue = document.getElementById('thicknessValue');
        drawingThickness.addEventListener('input', function() {
            thicknessValue.textContent = this.value;
        });
        
        // æ©¡çš®æ“¦æ¨¡å¼åˆ‡æ›äº‹ä»¶
        eraserModeToggle.addEventListener('change', function() {
            isEraserMode = this.checked;
            
            // æ©¡çš®æ“¦æ¨¡å¼é–‹å•Ÿæ™‚ï¼Œè‡ªå‹•é–‹å•Ÿç¹ªåœ–æ¨¡å¼
            if (this.checked && !isDrawingMode) {
                drawingModeToggle.checked = true;
                setDrawingMode(true);
            }
            
            // æ›´æ–°æç¤ºæ–‡å­—
            if (isDrawingMode) {
                updateDrawingModeInstructions();
            }
        });
        
        // æ›´æ–°ç¹ªåœ–æ¨¡å¼æç¤ºæ–‡å­—
        function updateDrawingModeInstructions() {
            if (isEraserMode) {
                previewInstructions.textContent = "æ©¡çš®æ“¦æ¨¡å¼ï¼šåœ¨å°ç« ä¸Šæ“¦é™¤ç·šæ¢";
                document.querySelector('.drag-instructions').textContent = "åœ¨å°ç« ä¸Šæ“¦é™¤ç·šæ¢";
            } else {
                const drawColor = currentCarving === 'intaglio' ? 'ç™½è‰²' : 'ç´…è‰²';
                previewInstructions.textContent = `ç¹ªåœ–æ¨¡å¼ï¼šåœ¨å°ç« ä¸Šç¹ªè£½${drawColor}ç·šæ¢`;
                document.querySelector('.drag-instructions').textContent = `åœ¨å°ç« ä¸Šç¹ªè£½${drawColor}ç·šæ¢`;
            }
        }
        
        // æ¸…ç©ºç¹ªåœ–æŒ‰éˆ•äº‹ä»¶
        clearDrawingBtn.addEventListener('click', clearDrawing);
        
        // ç¹ªåœ–äº‹ä»¶ç¶å®š
        drawCanvas.addEventListener('mousedown', startDrawing);
        drawCanvas.addEventListener('mousemove', draw);
        drawCanvas.addEventListener('mouseup', stopDrawing);
        drawCanvas.addEventListener('mouseleave', stopDrawing);
        
        // è§¸æ‘¸äº‹ä»¶ç¶å®š
        drawCanvas.addEventListener('touchstart', touchStartDrawing);
        drawCanvas.addEventListener('touchmove', touchDraw);
        drawCanvas.addEventListener('touchend', stopDrawing);
        drawCanvas.addEventListener('touchcancel', stopDrawing);
        
        // å­—é«”å¡ç‰‡é¸æ“‡äº‹ä»¶
        fontCards.forEach(card => {
            card.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„é¸ä¸­ç‹€æ…‹
                fontCards.forEach(c => c.classList.remove('selected'));
                // æ·»åŠ ç•¶å‰å¡ç‰‡çš„é¸ä¸­ç‹€æ…‹
                card.classList.add('selected');
                
                // æ›´æ–°ç•¶å‰å­—é«”
                currentFont = card.getAttribute('data-font');
                
                // æ›´æ–°å­—ç¬¦æ¨£å¼
                updateCharsStyle();
            });
        });
        
        // åˆ»å°æ–¹å¼é¸æ“‡äº‹ä»¶
        carvingOptions.forEach(option => {
            option.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰é¸é …çš„é¸ä¸­ç‹€æ…‹
                carvingOptions.forEach(opt => opt.classList.remove('selected'));
                // æ·»åŠ ç•¶å‰é¸é …çš„é¸ä¸­ç‹€æ…‹
                option.classList.add('selected');
                
                // æ›´æ–°ç•¶å‰åˆ»å°æ–¹å¼
                currentCarving = option.getAttribute('data-carving');
                
                // é‡æ–°ç¹ªè£½å°ç« ä»¥æ‡‰ç”¨æ–°çš„åˆ»å°æ–¹å¼
                redrawSealBackground();
                updateCharsStyle();
                
                // å¦‚æœè™•æ–¼ç¹ªåœ–æ¨¡å¼ï¼Œæ›´æ–°æç¤ºæ–‡å­—
                if (isDrawingMode) {
                    updateDrawingModeInstructions();
                }
            });
        });
        
        // å½¢ç‹€é¸æ“‡äº‹ä»¶
        shapeOptions.forEach(option => {
            option.addEventListener('click', () => {
                shapeOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                currentShape = option.getAttribute('data-shape');
                redrawSealBackground();
            });
        });
        
        // äº‹ä»¶ç›£è½
        nameInput.addEventListener('input', () => {
            // ç•¶æ–‡å­—æ”¹è®Šæ™‚ï¼Œé‡æ–°ç”Ÿæˆå°ç« 
            generateSeal();
        });
        

        

        
        // é»æ“Šå°ç« èƒŒæ™¯å–æ¶ˆé¸æ“‡
        sealBackground.addEventListener('click', (e) => {
            // åªæœ‰åœ¨éç¹ªåœ–æ¨¡å¼ä¸‹ï¼Œç›´æ¥é»æ“ŠèƒŒæ™¯æ™‚æ‰å–æ¶ˆé¸æ“‡
            if (!isDrawingMode && e.target === sealBackground) {
                unselectChar();
            }
        });
        
        // æŒ‰éˆ•äº‹ä»¶ç¶å®š
        resetPositionsBtn.addEventListener('click', resetCharPositions);
        resetSizesBtn.addEventListener('click', resetAllCharSizes);
        downloadBtn.addEventListener('click', downloadSeal);
        
        // SVGä¸‹è¼‰æŒ‰éˆ•äº‹ä»¶
        const downloadSvgBtn = document.getElementById('downloadSvgBtn');
        downloadSvgBtn.addEventListener('click', downloadSvgSeal);
        
        // ç­‰å¾…å­—é«”åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        document.fonts.ready.then(() => {
            // å˜—è©¦åŠ è¼‰ç¯†é«”å­—é«”
            async function loadSealFonts() {
                // åŠ è¼‰ç¯†é«”ä¸€ (å´‡ç†™ç¯†é«”)
                const chongxiUrls = [
                    'https://chineseclassics.github.io/files/chongxi_seal.otf',
                    'http://chineseclassics.github.io/files/chongxi_seal.otf'
                ];
                
                for (const url of chongxiUrls) {
                    try {
                        console.log(`å˜—è©¦å¾ ${url} åŠ è¼‰å´‡ç†™ç¯†é«”`);
                        const testFont = new FontFace('ChongXi Seal', `url(${url})`);
                        await testFont.load();
                        document.fonts.add(testFont);
                        console.log('å´‡ç†™ç¯†é«”åŠ è¼‰æˆåŠŸ');
                        
                        // æ¸¬è©¦å­—é«”æ˜¯å¦çœŸæ­£å¯ç”¨
                        const testDiv = document.createElement('div');
                        testDiv.style.fontFamily = "'ChongXi Seal'";
                        testDiv.style.position = 'absolute';
                        testDiv.style.visibility = 'hidden';
                        testDiv.textContent = 'æ¸¬è©¦';
                        document.body.appendChild(testDiv);
                        
                        const computedStyle = window.getComputedStyle(testDiv);
                        document.body.removeChild(testDiv);
                        
                        if (computedStyle.fontFamily.includes('ChongXi Seal')) {
                            console.log('ç¯†é«”ä¸€é©—è­‰æˆåŠŸ');
                            break;
                        }
                    } catch (error) {
                        console.warn(`å¾ ${url} åŠ è¼‰ç¯†é«”ä¸€å¤±æ•—:`, error);
                    }
                }
                
                // åŠ è¼‰ç¯†é«”äºŒ (å­æœˆä¹ç–Šå°ç¯†)
                try {
                    console.log('å˜—è©¦åŠ è¼‰ç¯†é«”äºŒ');
                    const ziYueFont = new FontFace('ZiYue Seal', `url(https://chineseclassics.github.io/files/ZIYueJiuDieYinZhuan-Regular.ttf)`);
                    await ziYueFont.load();
                    document.fonts.add(ziYueFont);
                    console.log('ç¯†é«”äºŒåŠ è¼‰æˆåŠŸ');
                    
                    // æ¸¬è©¦å­—é«”æ˜¯å¦çœŸæ­£å¯ç”¨
                    const testDiv = document.createElement('div');
                    testDiv.style.fontFamily = "'ZiYue Seal'";
                    testDiv.style.position = 'absolute';
                    testDiv.style.visibility = 'hidden';
                    testDiv.textContent = 'æ¸¬è©¦';
                    document.body.appendChild(testDiv);
                    
                    const computedStyle = window.getComputedStyle(testDiv);
                    document.body.removeChild(testDiv);
                    
                    if (computedStyle.fontFamily.includes('ZiYue Seal')) {
                        console.log('ç¯†é«”äºŒé©—è­‰æˆåŠŸ');
                    }
                } catch (error) {
                    console.warn('ç¯†é«”äºŒåŠ è¼‰å¤±æ•—:', error);
                }
                
                // åŠ è¼‰ç¯†é«”ä¸‰ (è¯åº·æ–°ç¯†é«”)
                try {
                    console.log('å˜—è©¦åŠ è¼‰ç¯†é«”ä¸‰');
                    const huaKangFont = new FontFace('HuaKang Seal', `url(https://chineseclassics.github.io/files/huakangxinzhuan.ttf)`);
                    await huaKangFont.load();
                    document.fonts.add(huaKangFont);
                    console.log('ç¯†é«”ä¸‰åŠ è¼‰æˆåŠŸ');
                    
                    // æ¸¬è©¦å­—é«”æ˜¯å¦çœŸæ­£å¯ç”¨
                    const testDiv = document.createElement('div');
                    testDiv.style.fontFamily = "'HuaKang Seal'";
                    testDiv.style.position = 'absolute';
                    testDiv.style.visibility = 'hidden';
                    testDiv.textContent = 'æ¸¬è©¦';
                    document.body.appendChild(testDiv);
                    
                    const computedStyle = window.getComputedStyle(testDiv);
                    document.body.removeChild(testDiv);
                    
                    if (computedStyle.fontFamily.includes('HuaKang Seal')) {
                        console.log('ç¯†é«”ä¸‰é©—è­‰æˆåŠŸ');
                    }
                } catch (error) {
                    console.warn('ç¯†é«”ä¸‰åŠ è¼‰å¤±æ•—:', error);
                }
                
                // åŠ è¼‰é‡‘æ–‡å­—é«”
                try {
                    console.log('å˜—è©¦åŠ è¼‰é‡‘æ–‡å­—é«”');
                    const jinWenFont = new FontFace('JiaJin Script', `url(https://chineseclassics.github.io/files/jiajinwen.ttf)`);
                    await jinWenFont.load();
                    document.fonts.add(jinWenFont);
                    console.log('é‡‘æ–‡å­—é«”åŠ è¼‰æˆåŠŸ');
                    
                    // æ¸¬è©¦å­—é«”æ˜¯å¦çœŸæ­£å¯ç”¨
                    const testDiv = document.createElement('div');
                    testDiv.style.fontFamily = "'JiaJin Script'";
                    testDiv.style.position = 'absolute';
                    testDiv.style.visibility = 'hidden';
                    testDiv.textContent = 'æ¸¬è©¦';
                    document.body.appendChild(testDiv);
                    
                    const computedStyle = window.getComputedStyle(testDiv);
                    document.body.removeChild(testDiv);
                    
                    if (computedStyle.fontFamily.includes('JiaJin Script')) {
                        console.log('é‡‘æ–‡å­—é«”é©—è­‰æˆåŠŸ');
                    }
                } catch (error) {
                    console.warn('é‡‘æ–‡å­—é«”åŠ è¼‰å¤±æ•—:', error);
                }
                
                // é‡æ–°ç”Ÿæˆå°ç« ä»¥æ‡‰ç”¨å·²åŠ è¼‰çš„å­—é«”
                setTimeout(() => {
                    generateSeal();
                }, 300);
            }
            
            loadSealFonts();
        });
        
        // åˆå§‹åŒ–ï¼ˆå…ˆç”Ÿæˆä¸€æ¬¡ï¼Œå­—é«”åŠ è¼‰å¾Œæœƒé‡æ–°ç”Ÿæˆï¼‰
        generateSeal();
        
        // ç”Ÿæˆå°ç« 
        function generateSeal() {
            // å–æ¶ˆä»»ä½•é¸ä¸­çš„å­—ç¬¦
            unselectChar();
            
            // ç²å–ç”¨æˆ¶è¼¸å…¥çš„æ–‡å­—
            const text = nameInput.value.trim() || "å°";
            
            // æ¸…ç©ºç¾æœ‰å­—ç¬¦
            charContainer.innerHTML = '';
            charElements = [];
            
            // åˆå§‹åŒ–æˆ–é‡ç½®å­—ç¬¦å¤§å°
            resetCharSizesData(text.length);
            
            // å‰µå»ºå­—ç¬¦ä½ç½®æ•¸æ“š
            createCharPositions(text);
            
            // ç¹ªè£½å°ç« èƒŒæ™¯
            redrawSealBackground();
            
            // å‰µå»ºå¯æ‹–å‹•å­—ç¬¦
            createDraggableChars(text);
            
            // ä¿æŒç¹ªåœ–å…§å®¹
            // (ä¸æ¸…é™¤ç¹ªåœ–å…§å®¹ï¼Œé™¤éç”¨æˆ¶æ˜ç¢ºè¦æ±‚)
        }
        
        // åˆå§‹åŒ–æˆ–é‡ç½®å­—ç¬¦å¤§å°æ•¸æ“š
        function resetCharSizesData(charCount) {
            charSizes = {};
            for (let i = 0; i < charCount; i++) {
                charSizes[i] = defaultFontSize;
            }
        }
        
        // å‰µå»ºå­—ç¬¦ä½ç½®æ•¸æ“š - é»˜èªä½¿ç”¨ç”°å­—æ ¼å¸ƒå±€
        function createCharPositions(text) {
            const centerX = sealSize / 2;
            const centerY = sealSize / 2;
            
            charPositions = [];
            
            // ç”°å­—æ’åˆ—ï¼ˆå¤å°æ’ç‰ˆï¼‰- ç²¾ç¢ºçš„ç”°å­—æ ¼å±…ä¸­å¸ƒå±€
            // ä½¿ç”¨èˆ‡å°ç« èƒŒæ™¯ç›¸åŒçš„é‚Šè·ï¼Œç¢ºä¿ä¸€è‡´æ€§
            const sizeOffset = padding * 0.8; // èˆ‡èƒŒæ™¯é‚Šè·ä¸€è‡´ï¼š24px
            
            // å°ç« å…§éƒ¨å¯ç”¨å€åŸŸ
            const innerWidth = sealSize - sizeOffset * 2;  // 302px
            const innerHeight = sealSize - sizeOffset * 2; // 302px
            
            // ç”°å­—æ ¼ï¼šæ¯å€‹æ ¼å­çš„å¤§å°
            const cellWidth = innerWidth / 2;   // 151px
            const cellHeight = innerHeight / 2; // 151px
            
            // è¨ˆç®—æ¯å€‹æ ¼å­çš„ç²¾ç¢ºä¸­å¿ƒé»
            const positions = [
                // å³ä¸Šè§’ (ç¬¬ä¸€å­—)
                { 
                    x: sizeOffset + cellWidth + cellWidth / 2,    // 24 + 151 + 75.5 = 250.5
                    y: sizeOffset + cellHeight / 2                // 24 + 75.5 = 99.5
                },
                // å³ä¸‹è§’ (ç¬¬äºŒå­—)
                { 
                    x: sizeOffset + cellWidth + cellWidth / 2,    // 24 + 151 + 75.5 = 250.5
                    y: sizeOffset + cellHeight + cellHeight / 2   // 24 + 151 + 75.5 = 250.5
                },
                // å·¦ä¸Šè§’ (ç¬¬ä¸‰å­—)
                { 
                    x: sizeOffset + cellWidth / 2,                // 24 + 75.5 = 99.5
                    y: sizeOffset + cellHeight / 2                // 24 + 75.5 = 99.5
                },
                // å·¦ä¸‹è§’ (ç¬¬å››å­—)
                { 
                    x: sizeOffset + cellWidth / 2,                // 24 + 75.5 = 99.5
                    y: sizeOffset + cellHeight + cellHeight / 2   // 24 + 151 + 75.5 = 250.5
                }
            ];
            
            for (let i = 0; i < Math.min(text.length, 4); i++) {
                charPositions.push({
                    x: positions[i].x,
                    y: positions[i].y,
                    rotation: 0
                });
            }
            
            // å¦‚æœå­—æ•¸è¶…é4å€‹ï¼ŒæŒ‰é †åºæ’åˆ—åœ¨å°ç« å€åŸŸå…§
            for (let i = 4; i < text.length; i++) {
                charPositions.push({
                    x: centerX + (Math.random() - 0.5) * innerWidth * 0.6,
                    y: centerY + (Math.random() - 0.5) * innerHeight * 0.6,
                    rotation: 0
                });
            }
        }
        
        // é‡ç½®å­—ç¬¦ä½ç½®
        function resetCharPositions() {
            const text = nameInput.value.trim() || "å°";
            createCharPositions(text);
            updateCharsPosition();
        }
        
        // é‡ç½®æ‰€æœ‰å­—ç¬¦å¤§å°
        function resetAllCharSizes() {
            const text = nameInput.value.trim() || "å°";
            resetCharSizesData(text.length);
            
            // æ›´æ–°æ‰€æœ‰å­—ç¬¦çš„å¤§å°
            charElements.forEach((char, index) => {
                updateCharSize(char, defaultFontSize);
            });
            
            // å–æ¶ˆé¸ä¸­ç‹€æ…‹
            unselectChar();
        }
        
        // å‰µå»ºå¯æ‹–å‹•å­—ç¬¦
        function createDraggableChars(text) {
            const fontFamily = currentFont;
            
            for (let i = 0; i < text.length; i++) {
                const char = document.createElement('div');
                char.className = 'draggable-char';
                char.textContent = text[i];
                char.dataset.index = i;
                
                // å‰µå»ºå³ä¸‹è§’èª¿æ•´æ‰‹æŸ„
                const resizeHandleBottomRight = document.createElement('div');
                resizeHandleBottomRight.className = 'resize-handle bottom-right';
                resizeHandleBottomRight.dataset.index = i;
                
                // å‰µå»ºå·¦ä¸Šè§’èª¿æ•´æ‰‹æŸ„
                const resizeHandleTopLeft = document.createElement('div');
                resizeHandleTopLeft.className = 'resize-handle top-left';
                resizeHandleTopLeft.dataset.index = i;
                
                // æ·»åŠ èª¿æ•´æ‰‹æŸ„äº‹ä»¶
                resizeHandleBottomRight.addEventListener('mousedown', handleResizeMouseDown);
                resizeHandleBottomRight.addEventListener('touchstart', handleResizeTouchStart);
                resizeHandleTopLeft.addEventListener('mousedown', handleResizeMouseDown);
                resizeHandleTopLeft.addEventListener('touchstart', handleResizeTouchStart);
                
                // å°‡æ‰‹æŸ„æ·»åŠ åˆ°å­—ç¬¦å®¹å™¨ä¸­
                char.appendChild(resizeHandleBottomRight);
                char.appendChild(resizeHandleTopLeft);
                
                // è¨­ç½®å­—ç¬¦æ¨£å¼
                char.style.fontFamily = fontFamily;
                
                // ç«‹å³æ‡‰ç”¨ç•¶å‰åˆ»å°æ–¹å¼çš„æ¨£å¼
                char.classList.add(currentCarving);
                const color = '#d62828';
                if (currentCarving === 'intaglio') {
                    char.style.color = 'white';
                    char.style.textShadow = '0 0 2px rgba(0,0,0,0.5)';
                } else {
                    char.style.color = color;
                    char.style.textShadow = '0 0 2px rgba(255,255,255,0.5)';
                }
                char.style.webkitTextStroke = '';
                char.style.webkitTextFillColor = '';
                
                // è¨­ç½®å­—é«”å¤§å°
                updateCharSize(char, charSizes[i]);
                
                // è¨­ç½®åˆå§‹ä½ç½®
                updateCharPosition(char, i);
                
                // åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹ç¦ç”¨æ‹–å‹•
                if (isDrawingMode) {
                    char.style.pointerEvents = 'none';
                }
                
                // æ·»åŠ äº‹ä»¶ç›£è½
                char.addEventListener('mousedown', handleCharMouseDown);
                char.addEventListener('touchstart', handleCharTouchStart);
                char.addEventListener('click', selectChar);
                
                charContainer.appendChild(char);
                charElements.push(char);
            }
            
            // æ·»åŠ æ‹–å‹•äº‹ä»¶ç›£è½
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            // é»æ“Šå°ç« å®¹å™¨çš„ç©ºç™½å€åŸŸå–æ¶ˆé¸æ“‡
            sealContainer.addEventListener('click', function(e) {
                if (!isDrawingMode && (e.target === sealContainer || e.target === sealBackground)) {
                    unselectChar();
                }
            });
            
            // æ·»åŠ å…¨å±€é»æ“Šäº‹ä»¶ï¼Œåœ¨å°ç« å€åŸŸå¤–é»æ“Šä¹Ÿå¯ä»¥å–æ¶ˆé¸ä¸­
            document.addEventListener('click', function(e) {
                if (!isDrawingMode && selectedCharIndex !== null) {
                    // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨å°ç« å€åŸŸå¤–
                    const sealRect = sealContainer.getBoundingClientRect();
                    const isInsideSeal = e.clientX >= sealRect.left && 
                                       e.clientX <= sealRect.right && 
                                       e.clientY >= sealRect.top && 
                                       e.clientY <= sealRect.bottom;
                    
                    // å¦‚æœé»æ“Šåœ¨å°ç« å€åŸŸå¤–ï¼Œå–æ¶ˆé¸ä¸­
                    if (!isInsideSeal) {
                        unselectChar();
                    }
                }
            });
        }
        
        // é¸æ“‡å­—ç¬¦
        function selectChar(e) {
            e.stopPropagation();
            
            // å¦‚æœåœ¨ç¹ªåœ–æ¨¡å¼ä¸‹æˆ–æ­£åœ¨æ‹–å‹•ï¼Œä¸è™•ç†é¸æ“‡
            if (isDrawingMode || isDragging) return;
            
            // å–æ¶ˆæ‰€æœ‰å­—ç¬¦çš„é¸ä¸­ç‹€æ…‹
            charElements.forEach(char => char.classList.remove('selected'));
            
            // è¨­ç½®ç•¶å‰å­—ç¬¦ç‚ºé¸ä¸­ç‹€æ…‹
            this.classList.add('selected');
            
            // ä¿å­˜é¸ä¸­çš„å­—ç¬¦ç´¢å¼•
            selectedCharIndex = parseInt(this.dataset.index);
        }
        
        // å–æ¶ˆé¸æ“‡å­—ç¬¦
        function unselectChar() {
            // ç§»é™¤æ‰€æœ‰å­—ç¬¦çš„é¸ä¸­ç‹€æ…‹
            charElements.forEach(char => char.classList.remove('selected'));
            
            // é‡ç½®é¸ä¸­ç´¢å¼•
            selectedCharIndex = null;
        }
        
        // é¼ æ¨™æŒ‰ä¸‹äº‹ä»¶è™•ç†
        function handleCharMouseDown(e) {
            // åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹æˆ–éå·¦éµé»æ“Šæ™‚ä¸è™•ç†æ‹–å‹•
            if (isDrawingMode || e.button !== 0) return;
            
            e.preventDefault();
            startDrag(e, this);
        }
        
        // è§¸æ‘¸é–‹å§‹äº‹ä»¶è™•ç†
        function handleCharTouchStart(e) {
            // åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹ä¸è™•ç†æ‹–å‹•
            if (isDrawingMode) return;
            
            e.preventDefault();
            startDrag(e, this);
        }
        
        // æ›´æ–°å­—ç¬¦ä½ç½®
        function updateCharsPosition() {
            for (let i = 0; i < charElements.length; i++) {
                updateCharPosition(charElements[i], i);
            }
        }
        
        // æ›´æ–°å–®å€‹å­—ç¬¦ä½ç½®
        function updateCharPosition(charElement, index) {
            if (index >= charPositions.length) return;
            
            const pos = charPositions[index];
            const fontSize = charSizes[index];
            
            // å­—ç¬¦å®¹å™¨å¤§å°ï¼Œç¢ºä¿æœ‰è¶³å¤ ç©ºé–“
            const containerSize = fontSize * 1.3;
            
            // å­—ç¬¦ä¸­å¿ƒå®šä½ï¼šå®¹å™¨å·¦ä¸Šè§’ = ä¸­å¿ƒé» - å®¹å™¨å¤§å°çš„ä¸€åŠ
            const offsetX = containerSize / 2;
            const offsetY = containerSize / 2;
            
            charElement.style.left = `${pos.x - offsetX}px`;
            charElement.style.top = `${pos.y - offsetY}px`;
            charElement.style.width = `${containerSize}px`;
            charElement.style.height = `${containerSize}px`;
            charElement.style.transform = `rotate(${pos.rotation}rad)`;
        }
        
        // æ›´æ–°å­—ç¬¦å¤§å°
        function updateCharSize(charElement, fontSize) {
            charElement.style.fontSize = `${fontSize}px`;
            
            // ç²å–å­—ç¬¦ç´¢å¼•ä¸¦æ›´æ–°ä½ç½®
            const index = parseInt(charElement.dataset.index);
            updateCharPosition(charElement, index);
        }
        
        // æ›´æ–°æ‰€æœ‰å­—ç¬¦çš„æ¨£å¼
        function updateCharsStyle() {
            const color = '#d62828'; // å›ºå®šä½¿ç”¨ç´…è‰²
            
            charElements.forEach(char => {
                char.style.fontFamily = currentFont;
                
                // ç§»é™¤èˆŠçš„åˆ»å°æ–¹å¼é¡
                char.classList.remove('intaglio', 'relief');
                // æ·»åŠ ç•¶å‰åˆ»å°æ–¹å¼é¡
                char.classList.add(currentCarving);
                
                // æ ¹æ“šåˆ»å°æ–¹å¼è¨­ç½®å­—ç¬¦é¡è‰²
                if (currentCarving === 'intaglio') {
                    // é™°åˆ»ï¼šç™½è‰²å­—é«”
                    char.style.color = 'white';
                    char.style.textShadow = '0 0 2px rgba(0,0,0,0.5)';
                    char.style.webkitTextStroke = '';
                    char.style.webkitTextFillColor = '';
                } else {
                    // é™½åˆ»ï¼šç´…è‰²å­—é«”
                    char.style.color = color;
                    char.style.textShadow = '0 0 2px rgba(255,255,255,0.5)';
                    char.style.webkitTextStroke = '';
                    char.style.webkitTextFillColor = '';
                }
            });
        }
        
        // ç¹ªè£½å°ç« èƒŒæ™¯
        function redrawSealBackground() {
            const color = '#d62828'; // å›ºå®šä½¿ç”¨ç´…è‰²
            const centerX = sealSize / 2;
            const centerY = sealSize / 2;
            const sizeOffset = padding * 0.8; // èª¿æ•´é‚Šè·
            
            // è¨­ç½®èƒŒæ™¯è‰²
            sealBackground.style.background = 'transparent';
            
            // æ ¹æ“šåˆ»å°æ–¹å¼é¸æ“‡å¡«å……é¡è‰²
            const fillColor = currentCarving === 'intaglio' ? color : 'white';
            const strokeColor = currentCarving === 'intaglio' ? 'none' : color;
            const strokeWidth = currentCarving === 'intaglio' ? 0 : 10; // åŠ ç²—é™½åˆ»é‚Šæ¡†
            
            // å‰µå»ºç°¡æ½”çš„æ–¹å½¢å°ç« 
            const svgContent = `
                <svg width="${sealSize}" height="${sealSize}" viewBox="0 0 ${sealSize} ${sealSize}">
                    <rect x="${sizeOffset}" y="${sizeOffset}" 
                          width="${sealSize - sizeOffset * 2}" 
                          height="${sealSize - sizeOffset * 2}" 
                          fill="${fillColor}" 
                          stroke="${strokeColor}" 
                          stroke-width="${strokeWidth}" />
                </svg>
            `;
            
            sealBackground.innerHTML = svgContent;
        }
        
        // é–‹å§‹æ‹–å‹•
        function startDrag(e, target) {
            // åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹ä¸å•Ÿå‹•æ‹–å‹•
            if (isDrawingMode) return;
            
            const index = parseInt(target.dataset.index);
            
            // æª¢æŸ¥æ˜¯å¦æŒ‰ä½Shiftéµé€²è¡Œå¤§å°èª¿æ•´
            if (e.shiftKey && selectedCharIndex === index) {
                // é–‹å§‹å­—é«”å¤§å°èª¿æ•´
                isResizing = true;
                dragTarget = target;
                
                if (e.type === 'mousedown') {
                    resizeStartY = e.clientY;
                } else {
                    resizeStartY = e.touches[0].clientY;
                }
                
                initialFontSize = charSizes[index];
                target.style.cursor = 'ns-resize';
                
                // æ›´æ–°æç¤ºä¿¡æ¯
                document.querySelector('.drag-instructions').textContent = 'æ‹–æ‹½èª¿æ•´å­—é«”å¤§å°';
                
                return;
            }
            
            // æ™®é€šæ‹–å‹•ç§»å‹•ä½ç½®
            isDragging = true;
            dragTarget = target;
            dragTarget.classList.add('dragging');
            
            // ç²å–é¼ æ¨™/è§¸æ‘¸èµ·å§‹ä½ç½®
            if (e.type === 'mousedown') {
                dragStartX = e.clientX;
                dragStartY = e.clientY;
            } else {
                dragStartX = e.touches[0].clientX;
                dragStartY = e.touches[0].clientY;
            }
            
            // ç²å–å…ƒç´ èµ·å§‹ä½ç½®
            targetStartX = charPositions[index].x;
            targetStartY = charPositions[index].y;
            
            // é˜²æ­¢é¸æ“‡æ™‚è§¸ç™¼æ‹–å‹•
            setTimeout(() => {
                if (isDragging) {
                    // åœ¨æ‹–å‹•æ™‚å–æ¶ˆå­—ç¬¦çš„é¸ä¸­ç‹€æ…‹
                    unselectChar();
                }
            }, 200);
        }
        
        // æ‹–å‹•ç§»å‹•
        function dragMove(e) {
            if ((!isDragging && !isResizing) || !dragTarget) return;
            
            e.preventDefault();
            
            let clientX, clientY;
            if (e.type === 'mousemove') {
                clientX = e.clientX;
                clientY = e.clientY;
            } else {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }
            
            const index = parseInt(dragTarget.dataset.index);
            
            if (isResizing) {
                // å­—é«”å¤§å°èª¿æ•´æ¨¡å¼ - æ ¹æ“šæ‰‹æŸ„é¡å‹èª¿æ•´æ–¹å‘
                const deltaX = clientX - resizeStartX;
                const deltaY = clientY - resizeStartY;
                
                // è¨ˆç®—å°è§’ç·šè·é›¢è®ŠåŒ–
                const diagonalDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                let direction;
                if (resizeHandleType === 'bottom-right') {
                    // å³ä¸‹è§’æ‰‹æŸ„ï¼šå³ä¸‹ç‚ºå¢å¤§ï¼Œå·¦ä¸Šç‚ºç¸®å°
                    direction = (deltaX + deltaY) > 0 ? 1 : -1;
                } else {
                    // å·¦ä¸Šè§’æ‰‹æŸ„ï¼šå·¦ä¸Šç‚ºå¢å¤§ï¼Œå³ä¸‹ç‚ºç¸®å°ï¼ˆèˆ‡å³ä¸‹è§’ç›¸åï¼‰
                    direction = (deltaX + deltaY) < 0 ? 1 : -1;
                }
                
                const sizeChange = direction * diagonalDistance * 0.3; // èª¿æ•´æ•æ„Ÿåº¦
                const newSize = Math.max(20, Math.min(200, initialFontSize + sizeChange));
                
                // æ›´æ–°å­—ç¬¦å¤§å°
                charSizes[index] = newSize;
                updateCharSize(dragTarget, newSize);
                
            } else if (isDragging) {
                // æ™®é€šæ‹–å‹•ç§»å‹•ä½ç½®
                const deltaX = clientX - dragStartX;
                const deltaY = clientY - dragStartY;
                
                // æ›´æ–°å­—ç¬¦ä½ç½®
                charPositions[index].x = targetStartX + deltaX;
                charPositions[index].y = targetStartY + deltaY;
                
                // æ›´æ–°å…ƒç´ ä½ç½®
                updateCharPosition(dragTarget, index);
            }
        }
        
        // èª¿æ•´æ‰‹æŸ„é¼ æ¨™æŒ‰ä¸‹äº‹ä»¶
        function handleResizeMouseDown(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹ä¸è™•ç†èª¿æ•´
            if (isDrawingMode) return;
            
            isResizing = true;
            dragTarget = this.parentElement;
            resizeHandleType = this.classList.contains('top-left') ? 'top-left' : 'bottom-right';
            
            const index = parseInt(this.dataset.index);
            
            // ç²å–èµ·å§‹ä½ç½®
            resizeStartX = e.clientX;
            resizeStartY = e.clientY;
            initialFontSize = charSizes[index];
            
            // æ·»åŠ èª¿æ•´ä¸­çš„æ¨£å¼
            this.classList.add('resizing');
            
            // æ›´æ–°æç¤ºä¿¡æ¯
            document.querySelector('.drag-instructions').textContent = 'å‘å¤–æ‹–æ‹½å¢å¤§å­—é«”ï¼Œå‘å…§æ‹–æ‹½ç¸®å°å­—é«”';
        }
        
        // èª¿æ•´æ‰‹æŸ„è§¸æ‘¸é–‹å§‹äº‹ä»¶
        function handleResizeTouchStart(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹ä¸è™•ç†èª¿æ•´
            if (isDrawingMode) return;
            
            isResizing = true;
            dragTarget = this.parentElement;
            resizeHandleType = this.classList.contains('top-left') ? 'top-left' : 'bottom-right';
            
            const index = parseInt(this.dataset.index);
            
            // ç²å–èµ·å§‹ä½ç½®
            resizeStartX = e.touches[0].clientX;
            resizeStartY = e.touches[0].clientY;
            initialFontSize = charSizes[index];
            
            // æ·»åŠ èª¿æ•´ä¸­çš„æ¨£å¼
            this.classList.add('resizing');
            
            // æ›´æ–°æç¤ºä¿¡æ¯
            document.querySelector('.drag-instructions').textContent = 'å‘å¤–æ‹–æ‹½å¢å¤§å­—é«”ï¼Œå‘å…§æ‹–æ‹½ç¸®å°å­—é«”';
        }
        
        // çµæŸæ‹–å‹•
        function endDrag() {
            if (dragTarget) {
                dragTarget.classList.remove('dragging');
                
                // ç§»é™¤èª¿æ•´æ‰‹æŸ„çš„èª¿æ•´ä¸­æ¨£å¼
                const resizeHandle = dragTarget.querySelector('.resize-handle');
                if (resizeHandle) {
                    resizeHandle.classList.remove('resizing');
                }
                
                // æ¢å¾©æç¤ºä¿¡æ¯
                if (isResizing) {
                    document.querySelector('.drag-instructions').textContent = 'é»æ“Šä¸¦æ‹–å‹•å­—ç¬¦èª¿æ•´ä½ç½®ï¼Œæ‹–æ‹½å³ä¸‹è§’è—è‰²åœ“é»èª¿æ•´å¤§å°';
                }
            }
            
            isDragging = false;
            isResizing = false;
            dragTarget = null;
        }
        
        // å®Œå…¨é‡å¯«ä¸‹è¼‰å°ç« åŠŸèƒ½
        function downloadSeal() {
            try {
                // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
                loadingIndicator.classList.remove('hidden');
                downloadMessage.className = '';
                downloadMessage.textContent = '';
                
                // æº–å‚™ä¸‹è¼‰ç”¨ç•«å¸ƒ
                downloadCanvas.width = sealSize;
                downloadCanvas.height = sealSize;
                downloadCtx.clearRect(0, 0, sealSize, sealSize);
                
                // 1. é¦–å…ˆç¹ªè£½èƒŒæ™¯é¡è‰²å’Œå½¢ç‹€ï¼ˆç°¡æ½”çš„æ–¹å½¢ï¼‰
                const color = '#d62828'; // å›ºå®šä½¿ç”¨ç´…è‰²
                const centerX = sealSize / 2;
                const centerY = sealSize / 2;
                const sizeOffset = padding * 0.8;
                
                // æ ¹æ“šåˆ»å°æ–¹å¼é¸æ“‡å¡«å……é¡è‰²
                const fillColor = currentCarving === 'intaglio' ? color : 'white';
                
                downloadCtx.fillStyle = fillColor;
                
                // å‰µå»ºç°¡æ½”çš„æ–¹å½¢å°ç« 
                downloadCtx.fillRect(sizeOffset, sizeOffset, 
                                   sealSize - sizeOffset * 2, 
                                   sealSize - sizeOffset * 2);
                
                // å¦‚æœæ˜¯é™½åˆ»ï¼Œæ·»åŠ é‚Šæ¡†
                if (currentCarving === 'relief') {
                    downloadCtx.strokeStyle = color;
                    downloadCtx.lineWidth = 10; // åŠ ç²—é™½åˆ»é‚Šæ¡†
                    downloadCtx.strokeRect(sizeOffset, sizeOffset, 
                                         sealSize - sizeOffset * 2, 
                                         sealSize - sizeOffset * 2);
                }
                
                // 2. ç¹ªè£½ä½¿ç”¨è€…ç¹ªè£½çš„å…§å®¹
                if (displayCanvas) {
                    downloadCtx.drawImage(displayCanvas, 0, 0);
                }
                
                // 3. ç¹ªè£½æ–‡å­—
                const text = nameInput.value.trim() || "å°";
                const fontFamily = currentFont;
                
                // æ ¹æ“šåˆ»å°æ–¹å¼è¨­ç½®æ–‡å­—é¡è‰²
                if (currentCarving === 'intaglio') {
                    // é™°åˆ»ï¼šç™½è‰²å­—é«”
                    downloadCtx.fillStyle = 'white';
                } else {
                    // é™½åˆ»ï¼šç´…è‰²å­—é«”
                    downloadCtx.fillStyle = color;
                }
                downloadCtx.textAlign = 'center';
                downloadCtx.textBaseline = 'middle';
                
                // ç¢ºä¿ä½¿ç”¨çš„å­—é«”å·²åŠ è¼‰å®Œæˆ
                document.fonts.ready.then(() => {
                    // ç¹ªè£½æ¯å€‹å­—ç¬¦
                    for (let i = 0; i < text.length; i++) {
                        const pos = charPositions[i];
                        const fontSize = charSizes[i];
                        
                        downloadCtx.save();
                        downloadCtx.translate(pos.x, pos.y);
                        downloadCtx.rotate(pos.rotation);
                        downloadCtx.font = `bold ${fontSize}px ${fontFamily}`;
                        downloadCtx.fillText(text[i], 0, 0);
                        downloadCtx.restore();
                    }
                    
                    // å°‡ç•«å¸ƒè½‰æ›ç‚ºä¸‹è¼‰é€£çµ
                    try {
                        downloadCanvas.toBlob(function(blob) {
                            if (!blob) {
                                throw new Error('ç„¡æ³•å‰µå»ºåœ–ç‰‡æª”æ¡ˆ');
                            }
                            
                            // å‰µå»ºä¸‹è¼‰é€£çµ
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = 'å¼˜ç«‹æ›¸é™¢å°ç« .png';
                            
                            // è§¸ç™¼ä¸‹è¼‰
                            document.body.appendChild(link);
                            link.click();
                            
                            // æ¸…ç†
                            setTimeout(() => {
                                document.body.removeChild(link);
                                URL.revokeObjectURL(url);
                                
                                // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨ä¸¦é¡¯ç¤ºæˆåŠŸä¿¡æ¯
                                loadingIndicator.classList.add('hidden');
                                downloadMessage.className = 'success';
                                downloadMessage.textContent = 'å°ç« å·²æˆåŠŸä¸‹è¼‰ï¼';
                                
                                // 3ç§’å¾Œéš±è—æˆåŠŸä¿¡æ¯
                                setTimeout(() => {
                                    downloadMessage.className = '';
                                    downloadMessage.textContent = '';
                                }, 3000);
                            }, 100);
                        }, 'image/png', 1.0);
                    } catch (error) {
                        console.error('Blob å‰µå»ºå¤±æ•—:', error);
                        showDownloadError('å‰µå»ºåœ–ç‰‡æª”æ¡ˆæ™‚å‡ºéŒ¯');
                    }
                }).catch(err => {
                    console.error('å­—é«”åŠ è¼‰å¤±æ•—:', err);
                    showDownloadError('å­—é«”åŠ è¼‰å¤±æ•—ï¼Œè«‹å˜—è©¦ä½¿ç”¨æ¨™æº–å­—é«”');
                });
                
            } catch (error) {
                console.error('ä¸‹è¼‰éç¨‹éŒ¯èª¤:', error);
                showDownloadError('ä¸‹è¼‰éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
            }
        }
        
        function showDownloadError(message) {
            loadingIndicator.classList.add('hidden');
            downloadMessage.className = 'error';
            downloadMessage.textContent = message || 'ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡';
            
            // 5ç§’å¾Œéš±è—éŒ¯èª¤ä¿¡æ¯
            setTimeout(() => {
                downloadMessage.className = '';
                downloadMessage.textContent = '';
            }, 5000);
        }
        
        // SVGåå­—ä¸‹è¼‰åŠŸèƒ½ - é©åˆæ¿€å…‰åˆ‡å‰²
        function downloadSvgSeal() {
            try {
                // é¡¯ç¤ºåŠ è¼‰æŒ‡ç¤ºå™¨
                loadingIndicator.classList.remove('hidden');
                downloadMessage.className = '';
                downloadMessage.textContent = '';
                
                const text = nameInput.value.trim() || "å°";
                const sizeOffset = padding * 0.8;
                
                // ç²å–å­—é«”å®šç¾©ï¼Œä¿æŒåŸå§‹å­—é«”åç¨±æ ¼å¼
                let fontFamily = currentFont;
                let fontUrl = '';
                
                // æ ¹æ“šé¸æ“‡çš„å­—é«”ç²å–å°æ‡‰çš„URL
                if (fontFamily === "'ChongXi Seal'") {
                    fontUrl = 'https://chineseclassics.github.io/files/chongxi_seal.otf';
                } else if (fontFamily === "'ZiYue Seal'") {
                    fontUrl = 'https://chineseclassics.github.io/files/ZIYueJiuDieYinZhuan-Regular.ttf';
                } else if (fontFamily === "'HuaKang Seal'") {
                    fontUrl = 'https://chineseclassics.github.io/files/huakangxinzhuan.ttf';
                } else if (fontFamily === "'JiaJin Script'") {
                    fontUrl = 'https://chineseclassics.github.io/files/jiajinwen.ttf';
                } else if (fontFamily === "'LXGW WenKai'") {
                    fontUrl = 'https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/lxgwwenkai-regular.woff2';
                }
                
                // ç‚ºSVGæº–å‚™å­—é«”åç¨±ï¼ˆç§»é™¤å¼•è™Ÿï¼‰
                const svgFontFamily = fontFamily.replace(/'/g, '');
                
                // å‰µå»ºSVGå…§å®¹ - åå­—è¨­è¨ˆï¼Œé©åˆæ¿€å…‰åˆ‡å‰²
                let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${sealSize}" height="${sealSize}" viewBox="0 0 ${sealSize} ${sealSize}" xmlns="http://www.w3.org/2000/svg">
    <defs>`;
                
                // å¦‚æœæœ‰è‡ªå®šç¾©å­—é«”ï¼Œæ·»åŠ å­—é«”å®šç¾©
                if (fontUrl) {
                    svgContent += `
        <style>
            @font-face {
                font-family: '${svgFontFamily}';
                src: url('${fontUrl}');
                font-weight: bold;
            }
        </style>`;
                }
                
                svgContent += `
    </defs>
    
    <!-- å°ç« é‚Šæ¡† -->
    <rect x="${sizeOffset}" y="${sizeOffset}" 
          width="${sealSize - sizeOffset * 2}" 
          height="${sealSize - sizeOffset * 2}" 
          fill="black" 
          stroke="none" />
          
    <!-- åå­—æ–‡å­—ï¼ˆé¤ç©ºï¼Œç”¨æ–¼æ¿€å…‰åˆ‡å‰²ï¼‰ -->
    <g transform="scale(-1,1) translate(-${sealSize},0)">`;
                
                // æ·»åŠ æ¯å€‹å­—ç¬¦ - ä½¿ç”¨SVG transformé€²è¡Œé¡åƒ
                for (let i = 0; i < text.length; i++) {
                    const pos = charPositions[i];
                    const fontSize = charSizes[i];
                    
                    // è½‰æ›æ—‹è½‰è§’åº¦ç‚ºåº¦æ•¸
                    const rotationDeg = pos.rotation * 180 / Math.PI;
                    
                    svgContent += `
        <text x="${pos.x}" y="${pos.y}" 
              font-family="${svgFontFamily}" 
              font-size="${fontSize}" 
              font-weight="bold"
              text-anchor="middle" 
              dominant-baseline="central"
              fill="white"
              transform="rotate(${rotationDeg} ${pos.x} ${pos.y})">${text[i]}</text>`;
                }
                
                svgContent += `
    </g>`;
                
                // å¦‚æœæœ‰ç”¨æˆ¶ç¹ªåœ–ï¼Œæ·»åŠ ç¹ªåœ–è·¯å¾‘ï¼ˆä¹Ÿéœ€è¦åå‘ï¼‰
                if (displayCanvas && displayCtx) {
                    try {
                        const imageData = displayCtx.getImageData(0, 0, sealSize, sealSize);
                        if (imageData && imageData.data.some(value => value > 0)) {
                            svgContent += `
    <!-- ç”¨æˆ¶ç¹ªåœ–å…§å®¹ - å·²é¡åƒè™•ç† -->
    <g transform="scale(-1,1) translate(-${sealSize},0)">
        <!-- ç¹ªåœ–å…§å®¹è½‰æ›ç‚ºSVGéœ€è¦é¡å¤–è™•ç† -->
        <!-- å»ºè­°ï¼šåœ¨æ¿€å…‰åˆ‡å‰²å‰æ‰‹å‹•æ·»åŠ ç¹ªåœ–è·¯å¾‘ -->
    </g>`;
                        }
                    } catch (error) {
                        console.warn('ç„¡æ³•è™•ç†ç¹ªåœ–å…§å®¹:', error);
                    }
                }
                
                svgContent += `
</svg>`;
                
                // å‰µå»ºBlobä¸¦ä¸‹è¼‰
                const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'å¼˜ç«‹æ›¸é™¢å°ç« _åå­—_æ¿€å…‰åˆ‡å‰².svg';
                
                // è§¸ç™¼ä¸‹è¼‰
                document.body.appendChild(link);
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // éš±è—åŠ è¼‰æŒ‡ç¤ºå™¨ä¸¦é¡¯ç¤ºæˆåŠŸä¿¡æ¯
                    loadingIndicator.classList.add('hidden');
                    downloadMessage.className = 'success';
                    downloadMessage.textContent = 'SVGåå­—å°ç« å·²æˆåŠŸä¸‹è¼‰ï¼å­—é«”å·²é¡åƒè™•ç†ï¼Œé©åˆæ¿€å…‰åˆ‡å‰²ä½¿ç”¨ã€‚';
                    
                    // 5ç§’å¾Œéš±è—æˆåŠŸä¿¡æ¯
                    setTimeout(() => {
                        downloadMessage.className = '';
                        downloadMessage.textContent = '';
                    }, 5000);
                }, 100);
                
            } catch (error) {
                console.error('SVGä¸‹è¼‰éç¨‹éŒ¯èª¤:', error);
                showDownloadError('SVGä¸‹è¼‰éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
            }
        }
    </script>
</body>
</html>



