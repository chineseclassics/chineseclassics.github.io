<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no, minimal-ui">
    <title>太虛幻聊 - 與古今名士暢談千古</title>
    <style>
        /* ===== 太虛幻聊統一設計規範 ===== */
        /* 
         * 🎯 狀態欄適配標準：所有頁面頂部元素統一適配手機狀態欄
         * - 聊天頭部(.wx-header): padding: 32px 15px 8px 15px ✅
         * - 群組詳情頭部(.detail-header): height: 88px, padding: 36px 15px 10px 15px ✅  
         * - 個人資料頭部(.profile-nav-bar): height: 88px, padding: 36px 15px 10px 15px ✅
         * - 主界面頭部(.main-header): padding: 32px 0 8px 0 ✅
         * - 群組列表頭部(.group-list-header): padding: 32px 15px 8px 15px ✅
         * - 朋友圈頭部(.moments-header): padding: 76px 15px 15px 15px ✅
         * 
         * 🎨 設計統一標準：
         * - 狀態欄預留空間：32px (移動端適配標準)
         * - 左右邊距：15px (與微信保持一致)
         * - 底部間距：8px (頂部導航元素)
         * - 字體大小：17px (標題), 18px (主標題)
         * - 背景色：#f6f6f6 (淺色頭部), #393a3f (深色頭部)
         * 
         * 💫 設計目標：確保所有界面具有一致的"微信"風格體驗
         *    所有頁面的頂部內容不會被手機狀態欄遮擋，保持視覺統一性
         */
        
        /* 基礎樣式 - 模擬微信風格 */
        
        /* CSS變量定義 */
        :root {
            --vh: 1vh; /* 動態視口高度 */
        }
        
        /* 全局移动端优化 */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* 防止移动端双击缩放 */
        html {
            touch-action: manipulation;
        }
        
        /* 优化移动端滚动 */
        body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* 移動端輸入優化 */
        @media (max-width: 768px) {
            /* 防止輸入時頁面縮放 */
            input[type="text"], 
            input[type="search"], 
            textarea {
                font-size: 16px !important;
                -webkit-appearance: none;
                border-radius: 0;
            }
            
            /* 優化輸入框在移動端的顯示 */
            .wx-input-box {
                -webkit-appearance: none;
                border-radius: 18px;
                font-size: 16px !important;
                line-height: 32px;
                padding: 0 12px;
            }
            
            /* 防止iOS Safari的縮放 */
            .wx-input-box:focus {
                font-size: 16px !important;
                transform: none;
            }
        }
        
        /* 新增成員資料頁面樣式 */
        .profile-nav-bar {
            height: 64px; /* 与主界面保持一致 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px; /* 移除顶部padding，确保按钮垂直居中 */
            background-color: var(--wx-header-bg);
            position: relative;
            min-height: 64px; /* 确保最小高度 */
        }
        
        /* 統一後退按鈕樣式 */
        .back-btn-unified {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .back-btn-unified:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .back-btn-unified:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .profile-back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .profile-back-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .profile-back-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .profile-more-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.2s ease;
            margin-right: -4px;
            font-weight: normal;
        }
        
        .profile-more-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .profile-more-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .profile-header {
            background-color: #ffffff;
            padding: 20px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .profile-avatar {
            width: 65px;
            height: 65px;
            border-radius: 5px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            background-color: #f8f8f8;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 22px;
            margin: 0 0 5px 0;
            font-weight: normal;
        }
        
        .profile-wechat-id, .profile-location {
            font-size: 14px;
            color: #888;
            margin: 3px 0;
        }
        
        .profile-menu-section {
            background-color: #ffffff;
            margin-bottom: 8px;
        }
        
        .profile-menu-item {
            display: flex;
            padding: 15px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .menu-item-label {
            flex: 1;
            font-size: 17px;
        }
        
        .menu-item-value {
            color: #888;
            margin-right: 5px;
        }
        
        .menu-item-arrow {
            color: #cccccc;
        }
        
        .profile-moments-section {
            background-color: #ffffff;
            margin-top: 8px;
            border-top: 8px solid #f5f5f5;
            position: relative;
            overflow: hidden;
        }
        
        .profile-moments-section::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: radial-gradient(circle at center, rgba(93, 92, 222, 0.08) 0%, rgba(255, 255, 255, 0) 70%);
            pointer-events: none;
            z-index: 1;
        }
        
        .moments-preview {
            display: flex;
            gap: 6px;
            margin-right: 10px;
            position: relative;
            z-index: 2;
        }
        
        .moment-preview-image {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f0f0f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #viewMoments {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        #viewMoments:hover {
            background-color: rgba(93, 92, 222, 0.12);
        }
        
        #viewMoments:active {
            background-color: rgba(93, 92, 222, 0.18);
        }
        
        #viewMoments::before {
            content: "";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #viewMoments:hover::before {
            opacity: 1;
        }
        
        .profile-more-section {
            background-color: #ffffff;
            margin-top: 8px;
            border-top: 8px solid #f5f5f5;
        }
        
        .profile-action-buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background-color: #f5f5f5;
            padding: 15px;
            gap: 10px;
            box-sizing: border-box;
        }
        
        .action-message-btn, .action-call-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            padding: 10px 5px;
            border-radius: 5px;
            font-size: 13px;
            color: #576b95;
            text-align: center;
            word-break: keep-all;
            white-space: nowrap;
        }
        
        .action-message-btn svg, .action-call-btn svg {
            margin-bottom: 5px;
            max-width: 20px;
            height: auto;
        }
        :root {
            --wx-bg: #ededed;
            --wx-chat-bg: #ededed;
            --wx-green: #91ED61;
            --wx-gray: #9c9c9c;
            --wx-light-gray: #f1f1f1;
            --wx-dark-gray: #666666;
            --wx-header-bg: #f6f6f6;
            --wx-input-bg: #f6f6f6;
            --wx-bubble-self: #95ec69;
            --wx-bubble-others: #ffffff;
            --wx-red-packet: #fa5151;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 太虛幻境全頁面背景 */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 完全禁止滚动 */
        }
        
        body {
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(138, 43, 226, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(75, 0, 130, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(25, 25, 112, 0.2) 0%, transparent 60%),
                linear-gradient(135deg, #0f0f23 0%, #1a1a3a 25%, #2d1b69 50%, #1e3a8a 75%, #0f172a 100%);
            position: relative;
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
            max-height: 100vh;
            max-height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
        }
        
        /* 銀河系背景容器 */
        .galaxy-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        
        /* 銀河中心 */
        .galaxy-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 160px;
            height: 160px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, rgba(255, 140, 0, 0.6) 20%, rgba(255, 69, 0, 0.4) 40%, rgba(255, 20, 147, 0.3) 60%, rgba(138, 43, 226, 0.2) 80%, transparent 100%);
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.6), 0 0 80px rgba(255, 140, 0, 0.4), 0 0 120px rgba(255, 69, 0, 0.2);
        }
        
        /* 銀河旋臂容器 */
        .spiral-arm {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            animation: galaxyRotate 200s linear infinite;
            }
        
        /* 第一條旋臂 */
        .spiral-arm:nth-child(2) {
            animation-delay: 0s;
        }
        
        /* 第二條旋臂 - 180度相位差 */
        .spiral-arm:nth-child(3) {
            animation-delay: -100s;
            }
        
        /* 粒子點 */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            animation: twinkle 3s ease-in-out infinite;
        }
        
        .particle.enhanced-twinkle {
            animation: twinkle-enhanced 4s ease-in-out infinite;
        }
        
        /* 不同大小的粒子 */
        .particle.small {
            width: 1px;
            height: 1px;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }
        
        .particle.medium {
            width: 2px;
            height: 2px;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }
        
        .particle.large {
            width: 3px;
            height: 3px;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
        }
        
        /* 彩色星體 */
        .particle.colored {
            background: rgba(138, 43, 226, 0.9);
            box-shadow: 0 0 8px rgba(138, 43, 226, 0.6);
        }
        
        .particle.blue {
            background: rgba(70, 130, 180, 0.9);
            box-shadow: 0 0 6px rgba(70, 130, 180, 0.6);
        }
        
        .particle.gold {
            background: rgba(255, 215, 0, 0.9);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        

        
        /* 額外的星空裝飾層 */
        .star-field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(0.8px 0.8px at 25px 35px, rgba(255,255,255,0.5), transparent),
                radial-gradient(0.6px 0.6px at 125px 45px, rgba(70, 130, 180, 0.4), transparent),
                radial-gradient(0.7px 0.7px at 185px 95px, rgba(255,255,255,0.4), transparent),
                radial-gradient(0.8px 0.8px at 285px 75px, rgba(255,255,255,0.5), transparent),
                radial-gradient(0.6px 0.6px at 335px 105px, rgba(147, 51, 234, 0.4), transparent),
                radial-gradient(0.5px 0.5px at 385px 55px, rgba(255,255,255,0.3), transparent),
                radial-gradient(0.7px 0.7px at 85px 125px, rgba(138, 43, 226, 0.3), transparent),
                radial-gradient(0.6px 0.6px at 245px 165px, rgba(70, 130, 180, 0.3), transparent);
            background-repeat: repeat;
            background-size: 450px 150px;
            animation: starfieldMove 80s linear infinite;
            pointer-events: none;
            z-index: 1;
            opacity: 0.7;
            }
            
        /* 太虛幻聊 App 圖標 */
        .app-icon-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100; /* 大幅提高z-index確保在最上層 */
            animation: appIconFloat 8s ease-in-out infinite;
        }
        
        .app-icon-container::before {
            content: '';
            position: absolute;
            top: -40px;
            left: -40px;
            right: -40px;
            bottom: -40px;
            background: 
                radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, rgba(138, 43, 226, 0.2) 50%, transparent 80%),
                radial-gradient(circle, rgba(255, 215, 0, 0.25) 0%, transparent 60%);
            border-radius: 50%;
            animation: outerGlow 4s ease-in-out infinite alternate;
            pointer-events: none;
            filter: blur(4px);
            z-index: -1;
        }
        
        .app-icon {
            width: 120px;
            height: 120px;
            border-radius: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8a2be2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 8px 32px rgba(102, 126, 234, 0.4),
                0 4px 16px rgba(138, 43, 226, 0.3),
                0 0 20px rgba(255, 215, 0, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            }
            
        .app-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
            border-radius: 24px 24px 60px 60px;
            }
            
        .app-icon:hover {
            transform: scale(1.05);
            box-shadow: 
                0 12px 40px rgba(102, 126, 234, 0.5),
                0 6px 20px rgba(138, 43, 226, 0.4),
                0 0 30px rgba(255, 215, 0, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .app-icon-symbol {
            font-size: 48px;
            margin-bottom: 4px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .app-icon-text {
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }
        
        .app-icon-glow {
            position: absolute;
            top: -30px;
            left: -30px;
            right: -30px;
            bottom: -30px;
            background: 
                radial-gradient(circle, rgba(102, 126, 234, 0.8) 0%, rgba(102, 126, 234, 0.5) 30%, rgba(138, 43, 226, 0.3) 60%, transparent 80%),
                radial-gradient(circle, rgba(255, 215, 0, 0.6) 0%, rgba(255, 140, 0, 0.3) 40%, transparent 70%);
            border-radius: 50%;
            animation: iconGlow 3s ease-in-out infinite alternate;
            pointer-events: none;
            filter: blur(2px);
            z-index: 1;
            }
            
        /* App圖標浮動動畫 */
        @keyframes appIconFloat {
            0%, 100% {
                transform: translate(-50%, -50%) translateY(0px) rotate(0deg);
            }
            25% {
                transform: translate(-50%, -50%) translateY(-8px) rotate(1deg);
            }
            50% {
                transform: translate(-50%, -50%) translateY(0px) rotate(0deg);
            }
            75% {
                transform: translate(-50%, -50%) translateY(-5px) rotate(-1deg);
            }
        }
        
        /* 圖標光暈動畫 */
        @keyframes iconGlow {
            0% {
                opacity: 0.4;
                transform: scale(0.9);
                filter: blur(2px) brightness(0.8);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
                filter: blur(3px) brightness(1.2);
            }
            100% {
                opacity: 0.6;
                transform: scale(1.15);
                filter: blur(2px) brightness(1);
            }
        }
        
        /* 外層光暈動畫 */
        @keyframes outerGlow {
            0% {
                opacity: 0.3;
                transform: scale(0.8);
                filter: blur(4px) brightness(0.7);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
                filter: blur(6px) brightness(1.3);
            }
            100% {
                opacity: 0.4;
                transform: scale(1.2);
                filter: blur(4px) brightness(1);
            }
        }
        
        /* iOS風格打開動畫 */
        @keyframes iOSAppOpen {
            0% {
                transform: translateX(-50%) translateY(-50%) scale(0.1);
                opacity: 0;
                border-radius: 24px;
            }
            50% {
                transform: translateX(-50%) translateY(-50%) scale(0.5);
                opacity: 0.8;
                border-radius: 20px;
            }
            100% {
                transform: translateX(-50%) translateY(-50%) scale(1);
                opacity: 1;
                border-radius: 16px;
            }
        }
        
        @keyframes iconDisappear {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
        }
        }
        

        
        .app-icon-container.disappearing {
            animation: iconDisappear 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* 星空移動動畫 */
        @keyframes starfieldMove {
            from {
                transform: translateY(0px) translateX(0px);
            }
            to {
                transform: translateY(-130px) translateX(-50px);
            }
        }
        
        /* 動畫定義 */
        @keyframes galaxyRotate {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            to {
                transform: translate(-50%, -50%) rotate(360deg);
        }
        }
        
        @keyframes twinkle {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.7);
            }
            25% {
                opacity: 0.8;
                transform: scale(1.1);
            }
            50% {
                opacity: 1;
                transform: scale(1.4);
            }
            75% {
                opacity: 0.6;
                transform: scale(1.0);
            }
        }
        
        @keyframes twinkle-enhanced {
            0%, 100% {
                opacity: 0.1;
                transform: scale(0.6);
            }
            20% {
                opacity: 0.9;
                transform: scale(1.2);
            }
            40% {
                opacity: 1;
                transform: scale(1.6);
            }
            60% {
                opacity: 0.7;
                transform: scale(1.1);
            }
            80% {
                opacity: 0.4;
                transform: scale(0.9);
            }
        }
        

        

        

        
        /* 聊天容器 */
        .wx-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--wx-chat-bg);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* 微信頭部 */
        .wx-header {
            background-color: var(--wx-header-bg);
            height: 64px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px; /* 移除顶部padding，确保按钮垂直居中 */
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 50;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        

        
        .wx-back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .wx-back-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .wx-back-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .wx-header .wx-header-title {
            /* 標題居中定位 */
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            
            /* 清除干擾樣式 */
            display: block !important;
            visibility: visible !important;
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            outline: none !important;
            pointer-events: none !important;
            white-space: nowrap !important;
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif !important;
            
            /* 文字樣式 */
            font-size: 17px !important;
            font-weight: 500 !important;
            color: #000 !important;
            text-align: center !important;
        }
        
        /* 移除可能的偽元素 */
        .wx-header .wx-header-title::before,
        .wx-header .wx-header-title::after {
            display: none !important;
            content: none !important;
        }
        
        /* 確保沒有其他class干擾 */
        .wx-header-title,
        div.wx-header-title {
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .wx-menu-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            color: #000;
            font-weight: normal;
            margin-right: -4px;
        }
        
        .wx-menu-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .wx-menu-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        /* 微信聊天容器 */
        .wx-chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 10px 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            min-height: 0; /* 允許flex子項縮小 */
            /* 確保最後一條消息不被輸入區域遮擋 */
            padding-bottom: 20px;
        }
        
        /* 時間戳 */
        .wx-time {
            text-align: center;
            font-size: 14px;
            color: #b2b2b2;
            margin: 10px 0;
            padding: 0 5px;
        }
        
        /* 消息容器 */
        .wx-msg {
            display: flex;
            margin-bottom: 16px;
            position: relative;
            width: 100%;
            align-items: flex-start;
        }
        
        .wx-msg-self {
            flex-direction: row-reverse;
        }
        
        /* 頭像容器 */
        .wx-avatar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 8px;
            flex-shrink: 0;
        }
        
        .wx-msg-self .wx-avatar-wrapper {
            align-items: center;
        }
        
        /* 頭像樣式 */
        .wx-avatar {
            width: 42px;
            height: 42px;
            border-radius: 6px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .wx-avatar:hover {
            transform: scale(1.05);
        }
        
        /* 用户名显示在頭像上方 */
        .wx-name {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
            font-weight: 500;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 消息内容容器 */
        .wx-content-wrapper {
            max-width: calc(100% - 60px);
            display: flex;
            flex-direction: column;
            position: relative;
            margin-top: 16px;
        }
        
        .wx-msg-bubble {
            position: relative;
            word-wrap: break-word;
            display: inline-block;
            text-align: left;
            font-size: 16px;
            line-height: 1.4;
            padding: 10px 16px;
            min-height: 20px;
            box-sizing: border-box;
            max-width: 280px;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .wx-msg-self .wx-msg-bubble {
            background: linear-gradient(135deg, #95ec69 0%, #7ed321 100%);
            color: #000;
            border-radius: 20px 20px 0px 20px; /* 左上角直角，靠近头像 */
            margin-left: auto;
            box-shadow: 0 2px 8px rgba(149, 236, 105, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .wx-msg-others .wx-msg-bubble {
            background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
            color: #333;
            border-radius: 0px 20px 20px 20px; /* 左上角直角，靠近头像 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* 正在輸入提示樣式 */
        .wx-typing {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 36px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%);
            border-radius: 0px 20px 20px 20px; /* 左上角直角，靠近头像 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            animation: messageSlideIn 0.3s ease-out;
        }
        
        .typing-dots {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .typing-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #666;
            animation: typingAnimation 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-8px) scale(1.1);
                opacity: 1;
                background-color: #333;
            }
        }
        
        /* 為打字動畫添加脈動效果 */
        .wx-typing {
            animation: typingPulse 2s infinite;
        }
        
        @keyframes typingPulse {
            0%, 100% {
                box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            }
            50% {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }
        }
        
        /* 發送者名稱 */
        .wx-name {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
            padding-left: 11px;
        }
        
        /* 系統消息 */
        .wx-system-msg {
            text-align: center;
            font-size: 12px;
            color: #999;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 10px;
            padding: 3px 8px;
            margin: 8px auto;
            max-width: 70%;
            display: inline-block;
            clear: both;
        }
        
        /* 輸入區域 */
        .wx-input-area {
            height: 66px;
            background-color: var(--wx-input-bg);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 17px 8px;
            flex-shrink: 0; /* 防止輸入框被壓縮 */
            box-sizing: border-box;
            /* 移動端優化 */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .wx-voice-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .wx-voice-btn::before {
            content: "";
            display: block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.8);
            position: absolute;
        }
        
        .wx-voice-btn::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: transparent;
            z-index: 1;
        }

        /* 中心点 */
        .wx-voice-btn::before {
            content: "";
            display: block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.8);
            position: absolute;
        }

        /* 重新设计声波图标 */
        .wx-voice-btn::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 8px;
            left: 8px;
            background-color: transparent;
            z-index: 2;
        }

        /* 小圆点 */
        .wx-voice-btn::before {
            content: "";
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: black;
            border-radius: 50%;
            left: 11px;
            top: 14px;
            z-index: 3;
        }

        /* 三个弧形声波 */
        .wx-voice-btn .wave1,
        .wx-voice-btn .wave2,
        .wx-voice-btn .wave3 {
            content: "";
            position: absolute;
            border: 1px solid black;
            border-left: none;
            background: transparent;
            z-index: 2;
        }

        .wx-voice-btn .wave1 {
            height: 6px;
            width: 3px;
            left: 14px;
            top: 13px;
            border-radius: 0 3px 3px 0;
        }

        .wx-voice-btn .wave2 {
            height: 10px;
            width: 5px;
            left: 17px;
            top: 11px;
            border-radius: 0 5px 5px 0;
        }

        .wx-voice-btn .wave3 {
            height: 14px;
            width: 7px;
            left: 22px;
            top: 9px;
            border-radius: 0 7px 7px 0;
        }
        
        .wx-input-box {
            flex: 1;
            height: 32px;
            background-color: #fff;
            border-radius: 18px;
            margin: 0 8px;
            border: none;
            outline: none;
            padding: 0 10px;
            color: #333;
            font-size: 16px;
            /* 移動端優化 */
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: text;
            user-select: text;
            /* 防止移動端縮放 */
            font-size: 16px !important;
            transform: translateZ(0);
            /* 優化輸入體驗 */
            line-height: 32px;
            vertical-align: middle;
        }
        
        .wx-input-box::placeholder {
            color: #aaa;
        }
        
        /* 發送按鈕樣式 */
        .wx-send-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            outline: none;
            cursor: pointer;
            margin-right: 8px;
            transition: all 0.2s ease;
            font-size: 20px;
            line-height: 1;
            color: #ccc;
            /* 移動端優化 */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            /* 優化點擊區域 */
            position: relative;
            border-radius: 50%;
        }
        
        /* 點擊區域優化 */
        .wx-send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background-color: transparent;
            transition: background-color 0.2s ease;
        }
        
        .wx-send-btn:hover::before {
            background-color: rgba(7, 193, 96, 0.1);
        }
        
        .wx-send-btn:active::before {
            background-color: rgba(7, 193, 96, 0.2);
        }
        
        /* 啟用狀態 */
        .wx-send-btn:not(:disabled) {
            color: #07c160;
            transform: scale(1);
        }
        
        .wx-send-btn:not(:disabled):hover {
            transform: scale(1.1);
            color: #06ad56;
        }
        
        .wx-send-btn:not(:disabled):active {
            transform: scale(0.95);
            color: #059a4c;
        }
        
        /* 禁用狀態 */
        .wx-send-btn:disabled {
            color: #ccc;
            cursor: not-allowed;
            transform: scale(0.9);
        }
        
        .wx-send-btn:disabled::before {
            background-color: transparent;
        }
        
        /* 優化emoji視覺效果 */
        .wx-send-btn {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
        }
        
        .wx-send-btn:not(:disabled) {
            text-shadow: 0 1px 3px rgba(7, 193, 96, 0.3);
            filter: drop-shadow(0 1px 2px rgba(7, 193, 96, 0.2));
        }
        
        .wx-send-btn:not(:disabled):hover {
            text-shadow: 0 2px 4px rgba(6, 173, 86, 0.4);
            filter: drop-shadow(0 2px 3px rgba(6, 173, 86, 0.3));
        }
        
        /* 移動端優化 */
        @media (max-width: 768px) {
            .wx-send-btn {
                font-size: 22px; /* 移動端稍微放大一點 */
            }
            
            .wx-send-btn::before {
                width: 36px; /* 移動端點擊區域稍微放大 */
                height: 36px;
            }
        }
        
        /* @某人功能樣式 */
        .mention-popup {
            position: absolute;
            bottom: 66px;
            left: 8px;
            right: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 300;
            display: none;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .mention-item:hover {
            background-color: #f8f8f8;
        }
        
        .mention-item:last-child {
            border-bottom: none;
        }
        
        .mention-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            background-color: #f0f0f0;
        }
        
        .mention-name {
            font-size: 16px;
            color: #333;
        }
        
        /* 消息中的@樣式 */
        .mention-text {
            color: #576b95;
            background-color: rgba(87, 107, 149, 0.1);
            padding: 2px 4px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        /* @提示樣式 */
        .mention-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background-color: #ff4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }
        
        .wx-emoji-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #7d7e80;
            cursor: pointer;
        }
        
        .wx-plus-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #7d7e80;
            cursor: pointer;
        }
        
        /* Emoji面板 */
        .emoji-panel {
            position: absolute;
            bottom: 44px;
            left: 0;
            right: 0;
            background-color: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            height: 200px;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .emoji-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        
        .emoji-item:hover {
            background-color: #f0f0f0;
        }
        
        /* 功能選項面板样式 */
        .function-panel {
            position: absolute;
            bottom: 44px;
            left: 0;
            right: 0;
            background-color: #f6f6f6;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            display: none;
            flex-direction: column;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 0 15px;
        }
        
        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        
        .function-icon {
            width: 56px;
            height: 56px;
            background-color: #fff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            color: #353535;
        }
        
        .function-icon svg {
            width: 28px;
            height: 28px;
        }
        
        .function-text {
            font-size: 12px;
            color: #636363;
        }
        
        .function-dots {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 6px;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #CBCBCB;
        }
        
        .dot.active {
            background-color: #707070;
        }
        
        /* 标识可点击的功能项 */
        .active-function .function-icon {
            position: relative;
        }
        
        .function-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e64340;
            border: 2px solid #f6f6f6;
        }
        

        
        /* 群組詳情頁面 */
        .group-details {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: hidden; /* 改为hidden，让内容区域单独滚动 */
            box-sizing: border-box;
        }
        
        .detail-header {
            background-color: var(--wx-header-bg);
            height: 64px; /* 与主界面保持一致 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px; /* 与主界面保持一致 */
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            flex-shrink: 0; /* 防止header被压缩 */
            z-index: 10; /* 确保header在最上层 */
        }
        
        .detail-back {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .detail-back:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .detail-back:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .detail-placeholder {
            width: 44px;
            height: 44px;
        }
        
        .detail-title {
            /* 標題居中定位 */
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            
            /* 清除干擾樣式 */
            display: block !important;
            visibility: visible !important;
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            outline: none !important;
            pointer-events: none !important;
            white-space: nowrap !important;
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif !important;
            
            /* 文字樣式 */
            font-size: 17px !important;
            font-weight: 500 !important;
            color: #000 !important;
            text-align: center !important;
        }
        
        .group-details-content {
            flex: 1; /* 占据剩余空间 */
            overflow-y: auto; /* 允许垂直滚动 */
            min-height: 0; /* 允许flex子元素收缩 */
        }
        
        .group-members-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            padding: 20px 10px;
            gap: 10px;
            background-color: #fff;
            border-bottom: 10px solid #f5f5f5;
        }
        
        .member-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 3px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .member-name {
            font-size: 12px;
            color: #333;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        
        .detail-section {
            background-color: #fff;
            padding: 0 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-item-label {
            font-size: 17px;
            color: #333;
        }
        
        .detail-item-value {
            font-size: 17px;
            color: #888;
            display: flex;
            align-items: center;
        }
        
        .detail-arrow {
            margin-left: 5px;
            font-size: 14px;
        }
        
        /* 私聊對話詳情頁面 */
        .private-chat-details {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 150;
            display: none;
            flex-direction: column;
            overflow: hidden; /* 改为hidden，让内容区域单独滚动 */
            color: #333;
            box-sizing: border-box;
        }
        
        .private-chat-details .detail-header {
            background-color: var(--wx-header-bg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .private-chat-details .detail-back {
            color: #000;
        }
        
        .private-chat-details .detail-back:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }
        
        .private-chat-details .detail-back:active {
            background-color: rgba(0, 0, 0, 0.15);
        }
        
        .private-chat-details .detail-title {
            color: #000;
        }
        
        .private-chat-details-content {
            flex: 1; /* 占据剩余空间 */
            overflow-y: auto; /* 允许垂直滚动 */
            min-height: 0; /* 允许flex子元素收缩 */
        }
        
        .private-chat-user-section {
            background-color: #fff;
            padding: 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 10px solid #f5f5f5;
        }
        
        .private-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .private-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .private-user-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .add-user-btn {
            width: 50px;
            height: 50px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
        }
        
        .add-user-icon {
            font-size: 20px;
            color: #999;
            font-weight: 300;
        }
        
        .private-detail-section {
            background-color: #fff;
            margin: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .private-detail-section:first-of-type {
            margin-top: 0;
        }
        
        .private-detail-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            background-color: #fff;
            transition: background-color 0.2s;
        }
        
        .private-detail-item:last-child {
            border-bottom: none;
        }
        
        .private-detail-item.hoverable:hover {
            background-color: #f8f8f8;
            cursor: pointer;
        }
        
        .private-detail-item.delete-item {
            color: #ff4757;
        }
        
        .private-detail-item.delete-item:hover {
            background-color: #f8f8f8;
            cursor: pointer;
        }
        
        .private-detail-item-label {
            font-size: 17px;
            color: #333;
        }
        
        .private-detail-item-arrow {
            font-size: 14px;
            color: #888;
            font-weight: normal;
        }
        
        /* 切換開關樣式 */
        .private-toggle-switch {
            width: 50px;
            height: 30px;
            background-color: #ddd;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .private-toggle-switch.active {
            background-color: #07c160;
        }
        
        .toggle-slider {
            width: 26px;
            height: 26px;
            background-color: #ffffff;
            border-radius: 13px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .private-toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }
        
        /* 成員資料頁面 */
        .member-profile {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 200;
            display: none;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .profile-header {
            background-color: #fff;
            padding: 20px;
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-right: 15px;
        }
        
        .profile-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .profile-name {
            font-size: 22px;
            font-weight: normal;
            margin-bottom: 5px;
        }
        
        .profile-nickname {
            font-size: 14px;
            color: #888;
        }
        
        .profile-actions {
            display: flex;
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 10px solid #f5f5f5;
        }
        
        .profile-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            flex: 1;
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #09bb07;
        }
        
        .action-text {
            font-size: 12px;
            color: #333;
        }
        
        /* 朋友圈界面 */
        .moments {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #fff;
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow: auto;
        }
        
        .moment-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .moment-header {
            display: flex;
        }
        
        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 10px;
        }
        
        .moment-content {
            flex: 1;
        }
        
        .moment-name {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 3px;
            color: #576b95;
        }
        
        .moment-text {
            font-size: 15px;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .moment-time {
            font-size: 14px;
            color: #b2b2b2;
            margin-top: 5px;
        }
        
        /* 進場動畫 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* V2性能優化：呼吸效果動畫 */
        @keyframes breatheOpacity {
            0%, 100% {
                opacity: 0.4; /* 確保最小可見光暈 */
                transform: scale(0.98);
            }
            50% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* V2性能優化：外部輝光脈衝動畫 */
        @keyframes outerGlowPulse {
            from {
                opacity: 0.5;
                transform: scale(1.0);
            }
            to {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }
        
        .wx-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
        
        /* 統一父容器 - 控制所有頁面的圓角和尺寸 (V2性能優化) */
        .app-universal-container {
            width: 390px;
            height: 844px;
            position: fixed;
            top: 50%;
            left: 50%;
            border-radius: 16px;
            overflow: visible; /* 允許偽元素的陰影顯示 */
            /* 基礎靜態陰影 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            z-index: 5;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
            will-change: transform, opacity;
            transform: translate(-50%, -50%) translateZ(0);
        }

        /* 父容器显示状态 */
        .app-universal-container.show {
            opacity: 1;
            visibility: visible;
        }

        /* 外部大範圍輝光 (V2性能優化) - 不再動畫filter */
        .app-universal-container::before {
            content: '';
            position: absolute;
            top: -20px; left: -20px; right: -20px; bottom: -20px;
            background: radial-gradient(ellipse at center, rgba(138, 43, 226, 0.15) 0%, transparent 70%);
            border-radius: 20px;
            animation: outerGlowPulse 4s ease-in-out infinite alternate;
            pointer-events: none;
            filter: blur(10px);
            z-index: -2;
            will-change: transform, opacity;
            transform: translateZ(0);
        }

        /* 呼吸式輝光 (V2性能優化) - 使用opacity動畫代替box-shadow動畫 */
        .app-universal-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 16px;
            /* 這是輝光最強狀態的靜態陰影 */
            box-shadow: 
                0 0 30px rgba(138, 43, 226, 0.7),
                0 0 50px rgba(102, 126, 234, 0.5),
                0 0 35px rgba(255, 215, 0, 0.5);
            animation: breatheOpacity 4s ease-in-out infinite;
            opacity: 0;
            will-change: opacity, transform;
            pointer-events: none;
            z-index: -1;
        }
        
        /* 登入頁面樣式 */
        .login-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            background: transparent;
            display: none; /* 初始隱藏 */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* 防止滚动条 */
            padding: 0;
            box-sizing: border-box;
            width: 100%; /* 相对于父容器 */
            height: 100%; /* 相对于父容器 */
        }
        
        .login-content {
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0; /* 使用父容器的圆角 */
            box-shadow: none; /* 使用父容器的阴影 */
            backdrop-filter: blur(10px);
            padding: 15px 16px 10px 16px; /* 减少内边距 */
            animation: slideInUp 0.6s ease-out;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden; /* 完全隐藏滚动条 */
            align-items: center;
            justify-content: space-between; /* 内容均匀分布 */
            max-width: 100%;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 4px; /* 再次減少底部間距 */
            margin-top: 2px; /* 進一步減少頂部間距 */
            flex-shrink: 0;
            width: 100%;
            max-width: 100%;
        }
        
        .app-title {
            margin-bottom: 8px;
        }
        
        .title-main {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2px;
        }
        
        .title-sub {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .title-decoration {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .star {
            font-size: 20px;
            animation: twinkle 2s infinite alternate;
        }
        
        .star:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .star:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes twinkle {
            from { opacity: 0.5; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .welcome-message {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.95) 0%, rgba(255, 255, 255, 0.95) 100%);
            border-radius: 8px; /* 减少圆角，避免与父容器冲突 */
            padding: 12px; /* 减少内边距 */
            margin-bottom: 8px; /* 恢復原本的底部間距 */
            margin-top: 24px; /* 再次增加頂部間距，讓整個歡迎信息區域向下移動更多 */
            border: 2px solid #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            flex: 1; /* 使欢迎消息占用可用空间 */
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            min-height: 0; /* 允许内容压缩 */
        }
        

        
        .welcome-title {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            margin-top: 8px;
        }
        
        .welcome-text {
            font-size: 12px; /* 稍微增大字體 */
            line-height: 1.6; /* 增加行高，讓文字間距更舒適 */
            color: #444;
            text-align: left;
            margin-bottom: 12px; /* 增加底部間距 */
            overflow: hidden; /* 隐藏超出内容 */
            letter-spacing: 0.3px; /* 增加字母間距 */
        }
        
        .welcome-confirmation {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px; /* 减少圆角 */
            padding: 10px;
            text-align: center;
            border: 1px dashed #667eea;
            margin-top: auto; /* 恢復推到底部，保持確認區域位置不變 */
        }
        
        .confirmation-text {
            font-size: 11px;
            color: #667eea;
            margin-bottom: 8px; /* 恢復與按鈕的間距 */
            font-weight: 600;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px; /* 减少圆角 */
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .confirm-btn.confirmed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            cursor: default;
        }
        
        .login-form.form-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .login-form.form-disabled input,
        .login-form.form-disabled select,
        .login-form.form-disabled button {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
            background-color: #f5f5f5 !important;
        }
        
        /* 启用状态的样式 */
        .login-form:not(.form-disabled) input,
        .login-form:not(.form-disabled) select,
        .login-form:not(.form-disabled) button {
            opacity: 1 !important;
            pointer-events: auto !important;
            cursor: auto !important;
        }
        
        .login-form {
            margin-bottom: 0; /* 移除底部间距 */
            flex-shrink: 0; /* 避免压缩 */
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .form-group {
            margin-bottom: 8px; /* 减少间距 */
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px; /* 减少圆角 */
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fff;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .password-hint {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
            font-style: italic;
            line-height: 1.2;
        }
        
        /* 
         * === 臨時隱藏功能控制 ===
         * 用途：暫時隱藏密碼功能和開發者直接進入按鈕
         * 恢復方法：將下面的 display: none 改為 display: block（或刪除整個規則）
         * 修改時間：按需求隱藏
         */
        .form-group:has(#password),
        .debug-btn {
            display: none !important;
        }
        
        .button-container {
            margin-top: auto;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 6px; /* 减少圆角 */
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            min-height: 44px;
        }
        
        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .debug-btn {
            width: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 6px; /* 减少圆角 */
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 8px;
            opacity: 0.9;
            position: relative;
            z-index: 2;
            min-height: 44px;
        }
        
        .debug-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            opacity: 1;
        }
        
        .debug-btn:active {
            transform: translateY(0);
        }
        
        .btn-icon {
            font-size: 18px;
        }
        
        .login-error {
            background-color: #fee;
            border: 1px solid #fcc;
            border-radius: 4px; /* 减少圆角 */
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .error-icon {
            font-size: 16px;
        }
        
        .error-text {
            font-size: 14px;
            color: #d33;
        }
        
        .login-footer {
            text-align: center;
            padding: 20px 0 30px 0; /* 增加上下内边距 */
            border-top: 1px solid #eee;
            margin-top: auto; /* 推到底部 */
            flex-shrink: 0;
        }
        
        .footer-text {
            font-size: 10px;
            color: #888;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .footer-icons {
            font-size: 14px;
            letter-spacing: 6px;
            opacity: 0.7;
        }
        
                 /* ===== 移动端响应式适配 ===== */
         
                  /* 基础移动端优化 */
         @media (max-width: 768px) {
             /* 父容器移动端适配 */
             .app-universal-container {
                 width: 100vw;
                 height: 100vh;
                 top: 0;
                 left: 0;
                 transform: none;
                 border-radius: 0;
             }
             
             /* 确保游戏界面在移动设备上完全显示 */
            body {
                margin: 0;
                padding: 0;
                overflow-x: hidden;
                font-size: 16px; /* 防止iOS Safari自动缩放 */
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
                         /* 登录界面移动端优化 */
             .login-container {
                 width: 100%;
                 height: 100%;
                 padding: 0;
                 box-sizing: border-box;
                 border-radius: 0;
                 overflow: hidden;
                 position: absolute;
                 top: 0;
                 left: 0;
             }
            
                         .login-content {
                 width: 100%;
                 height: 100vh;
                 padding: 10px 12px 8px 12px; /* 进一步减少内边距 */
                 box-sizing: border-box;
                 border-radius: 0;
                 overflow: hidden; /* 隐藏滚动条 */
                 justify-content: space-between; /* 均匀分布内容 */
             }
            
            .login-header h1 {
                font-size: 1.8rem;
            }
            
            .login-subtitle {
                font-size: 0.9rem;
            }
            
            /* 表单组件移动端优化 */
            .form-group input,
            .form-group select {
                padding: 12px 15px;
                font-size: 16px; /* 防止iOS自动缩放 */
                border-radius: 8px;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            .login-btn,
            .debug-btn {
                padding: 15px 20px;
                font-size: 16px;
                border-radius: 8px;
                min-height: 48px; /* 增加触摸面积 */
            }
            
            /* 主界面移动端优化 */
            .main-container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                position: fixed;
                border-radius: 0;
            }
            
            .main-header {
                height: 56px;
                padding: 0;
                /* 适配安全区域 */
                padding-top: max(0px, env(safe-area-inset-top));
            }
            
            .main-title {
                font-size: 17px;
            }
            
            .main-title-count {
                font-size: 15px;
            }
            
            /* 聊天列表移动端优化 */
            .chat-item {
                padding: 15px;
                min-height: 72px;
                box-sizing: border-box;
            }
            
            .chat-avatar {
                width: 52px;
                height: 52px;
                font-size: 22px;
                border-radius: 8px;
            }
            
            .chat-name {
                font-size: 16px;
                font-weight: 500;
            }
            
            .chat-preview {
                font-size: 14px;
                margin-top: 2px;
            }
            
            .chat-time {
                font-size: 12px;
            }
            
            /* 底部导航移动端优化 */
            .bottom-nav {
                height: 68px; /* 從60px增加到68px，與基礎樣式保持協調 */
                padding: 10px 0; /* 適當增加內邊距 */
                /* 适配安全区域 */
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
            
            .nav-item {
                height: 52px; /* 從48px增加到52px */
                padding: 4px 8px;
            }
            
            .nav-icon {
                font-size: 26px; /* 從24px增加到26px */
                margin-bottom: 3px; /* 適當增加間距 */
            }
            
                         .nav-label {
                 font-size: 12px; /* 從11px增加到12px */
             }
             
             /* 聊天界面移动端优化 */
             .wx-container {
                 width: 100%;
                 height: 100vh;
                 max-height: 100vh;
                 position: fixed;
                 border-radius: 0;
             }
             
             .wx-header {
                 height: 56px;
                 padding: 0 12px;
                 /* 适配安全区域 */
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
             }
             
             .wx-header-title {
                 font-size: 16px !important;
             }
             
             .wx-back-btn,
             .wx-menu-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
             }
             
             /* 聊天消息区域优化 */
             .wx-chat-container {
                 padding: 12px 8px;
                 padding-bottom: calc(78px + max(0px, env(safe-area-inset-bottom))); /* 從70px增加到78px，配合導航欄高度增加 */
             }
             
             .wx-msg {
                 margin-bottom: 12px;
             }
             
             .wx-avatar {
                 width: 38px;
                 height: 38px;
                 font-size: 22px;
                 border-radius: 6px;
             }
             
             .wx-avatar-wrapper {
                 margin: 0 6px;
             }
             
             .wx-content-wrapper {
                 max-width: calc(100% - 54px);
                 margin-top: 14px;
             }
             
             .wx-msg-bubble {
                 padding: 10px 14px;
                 font-size: 16px; /* 防止iOS自动缩放 */
                 line-height: 1.4;
                 max-width: 270px;
             }
             
             .wx-msg-self .wx-msg-bubble {
                 border-radius: 18px 18px 0px 18px; /* 左上角直角，靠近头像 */
             }
             
             .wx-msg-others .wx-msg-bubble {
                 border-radius: 0px 18px 18px 18px; /* 左上角直角，靠近头像 */
             }
             
             .wx-name {
                 font-size: 11px;
                 margin-bottom: 3px;
                 max-width: 50px;
             }
             
             .wx-time {
                 font-size: 12px;
                 margin: 8px 0;
             }
             
             /* 输入区域移动端优化 */
             .wx-input-area {
                 height: calc(60px + max(0px, env(safe-area-inset-bottom)));
                 padding: 8px 10px;
                 padding-bottom: calc(8px + max(0px, env(safe-area-inset-bottom)));
             }
             
             .wx-input-box {
                 height: 36px;
                 font-size: 16px; /* 防止iOS自动缩放 */
                 border-radius: 18px;
                 padding: 0 12px;
             }
             
             .wx-voice-btn {
                 width: 36px;
                 height: 36px;
             }
             
             /* 提及popup优化 */
             .mention-popup {
                 bottom: calc(60px + max(0px, env(safe-area-inset-bottom)));
                 left: 10px;
                 right: 10px;
                 border-radius: 12px;
             }
             
             .mention-item {
                 padding: 15px;
                 min-height: 60px;
             }
             
             .mention-avatar {
                 width: 40px;
                 height: 40px;
             }
         }
        
                 /* 小屏幕设备额外优化 */
         @media (max-width: 480px) {
             .login-content {
                 padding: 8px 10px 6px 10px; /* 减少小屏幕设备的内边距 */
             }
             
             .login-header h1 {
                 font-size: 1.6rem;
             }
             
             .chat-item {
                 padding: 12px 15px;
                 min-height: 68px;
             }
             
             .chat-avatar {
                 width: 48px;
                 height: 48px;
                 font-size: 20px;
             }
             
             .chat-name {
                 font-size: 15px;
             }
             
             .chat-preview {
                 font-size: 13px;
             }
             
             /* 聊天界面小屏优化 */
             .wx-header {
                 height: 52px;
                 padding: 0 10px;
                 height: calc(52px + max(0px, env(safe-area-inset-top)));
             }
             
             .wx-back-btn,
             .wx-menu-btn {
                 width: 36px;
                 height: 36px;
                 font-size: 16px;
             }
             
             .wx-header-title {
                 font-size: 15px !important;
             }
             
             .wx-chat-container {
                 padding: 10px 6px;
             }
             
             .wx-avatar {
                 width: 36px;
                 height: 36px;
                 font-size: 20px;
                 border-radius: 6px;
             }
             
             .wx-avatar-wrapper {
                 margin: 0 5px;
             }
             
             .wx-content-wrapper {
                 max-width: calc(100% - 50px);
                 margin-top: 12px;
             }
             
             .wx-msg-bubble {
                 padding: 8px 12px;
                 font-size: 15px;
                 line-height: 1.4;
                 max-width: 260px;
             }
             
             .wx-name {
                 font-size: 11px;
                 margin-bottom: 3px;
                 max-width: 46px;
             }
             
             .wx-input-area {
                 height: calc(56px + max(0px, env(safe-area-inset-bottom)));
                 padding: 6px 8px;
                 padding-bottom: calc(6px + max(0px, env(safe-area-inset-bottom)));
             }
             
             .wx-input-box {
                 height: 32px;
                 font-size: 15px;
                 padding: 0 10px;
             }
             
             .wx-voice-btn {
                 width: 32px;
                 height: 32px;
             }
             
             /* 小屏幕設備四宮格配圖優化 */
             .moment-images-grid {
                 width: 180px !important;
                 height: 180px !important;
             }
             
             .moment-emoji-grid-item {
                 font-size: 30px !important; /* 小屏幕進一步縮小 */
             }
             
             .emoji-count-overlay {
                 font-size: 9px !important;
                 padding: 1px 3px !important;
             }
         }
        
                 /* 群组详情和成员资料页面移动端优化 */
         @media (max-width: 768px) {
             /* 群组详情页面 */
             .group-detail-container {
                 width: 100%;
                 height: 100vh;
                 max-height: 100vh;
                 position: fixed;
                 border-radius: 0;
                 z-index: 200;
             }
             
             .detail-header {
                 height: 56px;
                 padding: 0 12px;
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
                 display: flex;
                 align-items: center;
                 justify-content: space-between;
                 position: relative;
             }
             
             .detail-back {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
             }
             
             .detail-placeholder {
                 width: 40px;
                 height: 40px;
             }
             
             .detail-title {
                 font-size: 16px !important;
             }
             
             .group-details-content {
                 flex: 1;
                 overflow-y: auto;
                 min-height: 0;
             }
             
             .private-chat-details-content {
                 flex: 1;
                 overflow-y: auto;
                 min-height: 0;
             }
             
             .group-info {
                 padding: 20px 15px;
             }
             
             .group-avatar {
                 width: 60px;
                 height: 60px;
                 font-size: 26px;
             }
             
             .group-name {
                 font-size: 20px;
             }
             
             .group-description {
                 font-size: 14px;
                 margin-top: 8px;
             }
             
             .member-grid {
                 grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                 gap: 15px;
                 padding: 15px;
             }
             
             .member-card {
                 padding: 10px;
                 border-radius: 12px;
             }
             
             .member-avatar {
                 width: 50px;
                 height: 50px;
                 font-size: 22px;
             }
             
             .member-name {
                 font-size: 12px;
                 margin-top: 8px;
             }
             
             /* 成员资料页面 */
             .member-profile-container {
                 width: 100%;
                 height: 100vh;
                 max-height: 100vh;
                 position: fixed;
                 border-radius: 0;
                 z-index: 300;
             }
             
             .profile-nav-bar {
                 height: 56px;
                 padding: 0 12px;
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
             }
             
             .profile-back-btn,
             .profile-more-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
             }
             
             .profile-header {
                 padding: 20px 15px;
             }
             
             .profile-avatar {
                 width: 60px;
                 height: 60px;
                 font-size: 26px;
             }
             
             .profile-name {
                 font-size: 20px;
             }
             
             .profile-wechat-id,
             .profile-location {
                 font-size: 14px;
                 margin: 4px 0;
             }
             
             .profile-menu-item {
                 padding: 15px;
                 min-height: 56px;
             }
             
             .menu-item-label {
                 font-size: 16px;
             }
             
             .menu-item-value {
                 font-size: 14px;
             }
             
             /* 朋友圈预览优化 */
             .moments-preview {
                 gap: 8px;
                 margin-right: 12px;
             }
             
             .moment-preview-image {
                 width: 50px;
                 height: 50px;
                 border-radius: 8px;
             }
         }
         
         /* 横屏模式优化 */
         @media (max-height: 500px) and (orientation: landscape) {
            .login-container {
                height: 100vh;
                overflow-y: auto;
            }
            
            .login-content {
                min-height: auto;
                height: 100vh;
                padding: 5px 15px 3px 15px; /* 横屏模式进一步减少内边距 */
                overflow: hidden; /* 确保横屏模式也不出现滚动条 */
                justify-content: space-between;
            }
            
            .login-header h1 {
                font-size: 1.4rem;
                margin-bottom: 8px;
            }
            
            .login-subtitle {
                font-size: 0.8rem;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 8px;
            }
            
            .main-header {
                height: 48px;
            }
            
            .bottom-nav {
                height: 52px; /* 從48px增加到52px，橫屏模式適度增加 */
                padding: 6px 0; /* 適當增加內邊距 */
            }
            
            .nav-item {
                height: 44px; /* 從40px增加到44px */
            }
            
            .nav-icon {
                font-size: 22px; /* 從20px增加到22px */
            }
            
                         .nav-label {
                 font-size: 11px; /* 從10px增加到11px */
             }
             
             /* 横屏模式下其他页面的优化 */
             .wx-header,
             .detail-header,
             .profile-nav-bar,
             .moments-header {
                 height: 44px;
                 height: calc(44px + max(0px, env(safe-area-inset-top)));
             }
             
             .wx-header-title,
             .detail-title,
             .moments-title {
                 font-size: 14px !important;
             }
             
             .wx-back-btn,
             .wx-menu-btn,
             .detail-back-btn,
             .profile-back-btn,
             .profile-more-btn,
             .moments-back-btn {
                 width: 32px;
                 height: 32px;
                 font-size: 14px;
             }
             
             .wx-input-area {
                 height: calc(44px + max(0px, env(safe-area-inset-bottom)));
                 padding: 4px 8px;
                 padding-bottom: calc(4px + max(0px, env(safe-area-inset-bottom)));
             }
             
             .wx-input-box {
                 height: 28px;
                 font-size: 14px;
             }
             
             .wx-voice-btn {
                 width: 28px;
                 height: 28px;
             }
         }
        
        /* 超高分辨率设备优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .chat-avatar,
            .nav-icon {
                /* 高DPI设备的清晰度优化 */
                transform: translateZ(0);
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
                 /* iOS Safari 特殊优化 */
         @supports (-webkit-touch-callout: none) {
             .main-container,
             .wx-container,
             .group-detail-container,
             .member-profile-container,
             .moments-container {
                 /* iOS Safari 视口高度修正 */
                 height: 100vh;
                 height: -webkit-fill-available;
             }
             
             .login-container {
                 height: 100vh;
                 height: -webkit-fill-available;
             }
             
             /* 防止iOS Safari弹性滚动 */
             body {
                 position: fixed;
                 width: 100%;
                 height: 100%;
                 overflow: hidden;
             }
             
             /* 修正iOS Safari中的输入框问题 */
             .wx-input-box {
                 transform: translateZ(0);
                 -webkit-appearance: none;
                 border-radius: 18px;
             }
             
             .form-group input,
             .form-group select {
                 transform: translateZ(0);
                 -webkit-appearance: none;
             }
             
             /* 优化iOS Safari的滚动性能 */
             .wx-chat-container,
             .chat-list-container,
             .contacts-tab,
             .discover-tab,
             .profile-tab,
             .moments-container {
                 -webkit-overflow-scrolling: touch;
                 transform: translate3d(0, 0, 0);
             }
         }
        
        /* 大屏幕设备登录界面优化 */
        @media (min-width: 768px) and (min-height: 600px) {
            .login-content {
                max-width: 400px;
                margin: 0 auto;
                padding: 20px 24px;
                justify-content: center; /* 大屏幕居中显示 */
            }
            
            .welcome-message {
                max-height: 40vh; /* 限制欢迎信息最大高度 */
                overflow-y: auto; /* 如果内容过多，允许局部滚动 */
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            /* 移除hover效果，优化触摸体验 */
            .chat-item:hover {
                background-color: transparent;
            }
            
            .chat-item:active {
                background-color: #f0f0f0;
                transition: background-color 0.1s;
            }
            
            .nav-item:hover {
                background-color: transparent;
            }
            
            .nav-item:active {
                background-color: rgba(0, 0, 0, 0.1);
                transition: background-color 0.1s;
            }
            
                         /* 增大触摸目标 */
             .login-btn,
             .debug-btn,
             .chat-item,
             .nav-item {
                 min-height: 48px; /* 從44px增加到48px，配合導航欄調整 */
             }
             
             /* 通讯录页面优化 */
             .contacts-tab {
                 height: 100%;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
             }
             
             .contact-item {
                 padding: 15px;
                 min-height: 60px;
                 border-bottom: 0.5px solid #e5e5e5;
             }
             
             .contact-avatar {
                 width: 44px;
                 height: 44px;
                 font-size: 20px;
             }
             
             /* 发现页面优化 */
             .discover-tab {
                 height: 100%;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
             }
             
             .discover-item {
                 padding: 15px;
                 min-height: 56px;
                 border-bottom: 0.5px solid #e5e5e5;
             }
             
             .discover-icon {
                 width: 32px;
                 height: 32px;
                 font-size: 18px;
             }
             
             .discover-label {
                 font-size: 16px;
             }
             
             /* 个人资料页面优化 */
             .profile-tab {
                 height: 100%;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
             }
             
             .profile-header {
                 padding: 20px 15px;
             }
             
             .profile-avatar img {
                 width: 60px;
                 height: 60px;
             }
             
             .profile-name {
                 font-size: 20px;
             }
             
             .profile-menu-item {
                 padding: 15px;
                 min-height: 56px;
             }
             
             .menu-icon {
                 width: 28px;
                 height: 28px;
             }
             
             .menu-label {
                 font-size: 16px;
             }
             
             /* 朋友圈页面优化 */
             .moments-container {
                 height: 100vh;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
                 position: fixed;
                 top: 0;
                 left: 0;
                 right: 0;
                 bottom: 0;
                 background-color: #f5f5f5;
                 z-index: 100;
             }
             
             .moments-header {
                 height: 56px;
                 padding: 76px 15px 15px 15px;
                 padding-top: calc(76px + max(0px, env(safe-area-inset-top)));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
                 background-color: rgba(0, 0, 0, 0.5);
                 color: white;
             }
             
             .moments-back-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
                 color: white;
             }
             
             .moments-title {
                 font-size: 16px;
                 color: white;
             }
             
             .moment-item {
                 padding: 15px;
                 margin-bottom: 8px;
                 background-color: white;
             }
             
             .moment-avatar {
                 width: 44px;
                 height: 44px;
                 font-size: 20px;
             }
             
             .moment-name {
                 font-size: 16px;
                 font-weight: 500;
             }
             
             .moment-content {
                 font-size: 16px;
                 line-height: 1.5;
                 margin: 8px 0;
             }
             
             /* 移動端四宮格配圖優化 */
             .moment-images-grid {
                 width: 200px !important;
                 height: 200px !important;
                 margin: 12px 0;
             }
             
             .moment-emoji-grid-item {
                 font-size: 36px !important; /* 移動端稍微小一些 */
             }
             
             .emoji-count-overlay {
                 font-size: 10px !important;
                 padding: 1px 4px !important;
             }
             
             .moment-images {
                 margin: 12px 0;
             }
             
             .moment-image {
                 border-radius: 8px;
                 margin: 2px;
             }
             
             .moment-actions {
                 margin-top: 12px;
             }
             
             .moment-like-btn,
             .moment-comment-btn {
                 padding: 8px 12px;
                 font-size: 14px;
                 min-height: 40px;
             }
         }
        
                 /* 主界面樣式 */
        .main-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #393a3f;
            display: flex;
            flex-direction: column;
            z-index: 10;
            padding: 0;
            border: none;
            outline: none;
            box-sizing: border-box;
            overflow: hidden;
            /* 移动端性能优化 */
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        .main-header {
            background-color: #f7f7f7;
            color: #000;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; /* 移除顶部padding，确保标题垂直居中 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin: 0;
            border: none;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            position: relative;
        }
        

        
        .main-title {
            font-size: 18px;
            font-weight: normal;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .main-title-count {
            font-size: 16px;
            color: rgba(0, 0, 0, 0.6);
        }
        

        
        .main-content {
            flex: 1;
            overflow: hidden;
            background-color: #ffffff;
            margin: 0;
            border: none;
        }
        
        /* 聊天列表樣式 */
        .chat-list-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .chat-list-container {
            height: 100%;
            overflow-y: auto;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            transition: background-color 0.15s;
            position: relative;
            background-color: #ffffff;
        }
        
        .chat-item:hover {
            background-color: #f0f0f0;
        }
        
        .chat-item:active {
            background-color: #e8e8e8;
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
            background-color: #f0f0f0;
        }
        


        
        .chat-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .chat-name {
            font-size: 17px;
            color: #333;
            margin-bottom: 4px;
            font-weight: normal;
            line-height: 1.2;
        }
        
        .chat-preview {
            font-size: 14px;
            color: #888;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 60px;
        }
        
        .chat-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .chat-unread {
            background-color: #ff3b30;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        
        .chat-unread.show {
            display: block;
        }
        
        /* 底部導航欄 - 更符合真實微信樣式 */
        .bottom-nav {
            display: flex;
            background-color: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            padding: 8px 0 8px 0; /* 適當增加內邊距 */
            box-shadow: 0 -0.5px 0 rgba(0, 0, 0, 0.05);
            height: 64px; /* 從56px增加到64px */
            align-items: center;
            margin: 0;
            flex-shrink: 0;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 3px 8px; /* 適當增加內邊距 */
            transition: all 0.15s;
            height: 48px; /* 從44px增加到48px */
        }
        
        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        .nav-icon {
            font-size: 25px; /* 從22px增加到25px */
            margin-bottom: 3px; /* 適當增加間距 */
            color: #989898;
            transition: color 0.15s;
            line-height: 1;
        }
        
        .nav-item.active .nav-icon {
            color: #07c160;
        }
        
        .nav-label {
            font-size: 11px; /* 從10px增加到11px */
            color: #989898;
            transition: color 0.15s;
            line-height: 1;
            font-weight: normal;
        }
        
        .nav-item.active .nav-label {
            color: #07c160;
        }
        
        .nav-badge {
            position: absolute;
            top: 2px;
            right: 20%;
            background-color: #ff3b30;
            color: white;
            border-radius: 8px;
            padding: 1px 5px;
            font-size: 11px;
            min-width: 16px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        
        .nav-badge.show {
            display: block;
        }
        
        /* 通訊錄樣式 - 模擬真實微信 */
        .contacts-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .contacts-container {
            height: 100%;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        .contact-group {
            margin-bottom: 0;
        }
        
        .contact-group-header {
            background-color: #f7f7f7;
            padding: 12px 15px;
            font-size: 14px;
            color: #333;
            font-weight: 600;
            line-height: 1.2;
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            transition: background-color 0.15s;
            background-color: #ffffff;
        }
        
        .contact-item:hover {
            background-color: #f0f0f0;
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background-color: #f0f0f0;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
            font-weight: normal;
            line-height: 1.2;
        }
        
        .contact-desc {
            font-size: 13px;
            color: #888;
            line-height: 1.2;
        }
        
        /* 通訊錄右側字母索引 - 隱藏，因為改用朝代排序 */
        .contacts-index {
            display: none;
        }
        
        .index-letter {
            display: none;
        }
        
        /* 發現頁面樣式 - 模擬真實微信 */
        .discover-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .discover-container {
            height: 100%;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        
        .discover-section {
            background-color: #ffffff;
            margin-bottom: 8px;
        }
        
        .discover-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .discover-item:last-child {
            border-bottom: none;
        }
        
        .discover-item:hover {
            background-color: #f0f0f0;
        }
        
        .discover-icon {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border-radius: 6px;
        }
        
        .discover-label {
            font-size: 16px;
            color: #333;
            flex: 1;
            font-weight: normal;
        }
        
        .discover-arrow {
            color: #c7c7cc;
            font-size: 14px;
        }
        
        /* 個人資料頁面樣式 */
        .profile-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .profile-container {
            height: 100%;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        
        /* 個人資料頭部區域 */
        .profile-header {
            background-color: #ffffff;
            padding: 20px 15px;
            margin-bottom: 10px;
        }
        
        .profile-user-card {
            display: flex;
            align-items: flex-start;
            position: relative;
        }
        
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .profile-info {
            flex: 1;
            min-width: 0;
        }
        
        .profile-name {
            font-size: 22px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .profile-wechat-id {
            font-size: 14px;
            color: #888;
            margin-bottom: 12px;
        }
        
        .profile-status-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            background-color: transparent;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-btn:hover {
            background-color: #f8f8f8;
            border-color: #ccc;
        }
        
        .camera-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background-color: transparent;
            border: 1px solid #e0e0e0;
            border-radius: 50%;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .camera-btn:hover {
            background-color: #f8f8f8;
            border-color: #ccc;
        }
        
        .qr-code-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .qr-code-btn:hover {
            background-color: #f8f8f8;
        }
        
        /* 功能菜單區域 */
        .profile-menu-section {
            background-color: #ffffff;
            margin-bottom: 10px;
        }
        
        .profile-menu-item {
            display: flex;
            align-items: center;
            padding: 16px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .profile-menu-item:hover {
            background-color: #f8f8f8;
        }
        
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        
        .profile-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .profile-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        .profile-menu-section .profile-menu-item:only-child {
            border-radius: 8px;
        }
        
        .menu-icon {
            margin-right: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .menu-icon svg {
            border-radius: 6px;
        }
        
        .menu-label {
            flex: 1;
            font-size: 16px;
            color: #333;
            font-weight: 400;
        }
        
        .menu-arrow {
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }
        
        /* 朋友圈頁面樣式 */
        .moments-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            z-index: 15;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .moments-header {
            position: relative;
            height: 200px;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.7)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"><rect fill="%23667eea" width="400" height="200"/><circle fill="%23764ba2" opacity="0.3" cx="100" cy="50" r="30"/><circle fill="%23667eea" opacity="0.5" cx="300" cy="150" r="50"/></svg>');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 76px 15px 15px 15px; /* 符合设计规范 */
        }
        

        
        .moments-back-btn, .moments-camera-btn {
            width: 44px;
            height: 44px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: normal;
        }
        
        .moments-back-btn:hover, .moments-camera-btn:hover {
            background-color: rgba(0, 0, 0, 0.5);
            transform: scale(1.05);
        }
        
        .moments-back-btn:active, .moments-camera-btn:active {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.95);
        }
        
        .moments-content {
            flex: 1;
            background-color: #f5f5f5;
            overflow-y: auto;
        }
        
        .moment-item {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px;
            position: relative;
        }
        
        .moment-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .moment-avatar {
            width: 42px;
            height: 42px;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }
        
        .moment-info {
            flex: 1;
            min-width: 0;
        }
        
        .moment-name {
            font-size: 16px;
            font-weight: 500;
            color: #576b95;
            margin-bottom: 2px;
        }
        
        .moment-content-text {
            font-size: 16px;
            line-height: 1.4;
            color: #333;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .moment-images {
            margin-bottom: 10px;
        }
        
        .moment-images.single {
            max-width: 200px;
        }
        
        .moment-images.grid {
            display: grid;
            gap: 3px;
            max-width: 270px;
        }
        
        .moment-images.grid.two {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .moment-images.grid.three {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-images.grid.four {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .moment-images.grid.more {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .moment-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .moment-time {
            font-size: 13px;
            color: #999;
        }
        
        .moment-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .moment-action {
            color: #576b95;
            font-size: 13px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: background-color 0.2s;
        }
        
        .moment-action:hover {
            background-color: #f0f0f0;
        }
        
        .moment-likes {
            background-color: #f7f7f7;
            margin-top: 8px;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .moment-like-icon {
            color: #576b95;
            margin-right: 4px;
        }
        
        .moment-like-list {
            color: #576b95;
        }
        
        .moment-comments {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #e5e5e5;
        }
        
        .moment-comment {
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .comment-author {
            color: #576b95;
            font-weight: 500;
        }
        
        .comment-text {
            color: #333;
        }
        
        .moment-location {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
        }
        
        /* 四宮格配圖容器 */
        .moment-images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 3px;
            width: 240px;
            height: 240px;
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* 四宮格中的單個emoji項目 */
        .moment-emoji-grid-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
            font-size: 48px; /* 增大emoji尺寸 */
            border-radius: 6px;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .moment-emoji-grid-item:hover {
            background-color: #e8e8e8;
        }
        
        /* 空白格子 */
        .moment-emoji-grid-item.empty {
            background-color: transparent;
        }
        
        /* 更多指示器樣式 */
        .moment-emoji-grid-item.more-indicator {
            position: relative;
        }
        
        .emoji-count-overlay {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* 媒体查询已移除，使用统一设计 */
        
        /* 群組列表頁面樣式 */
        .group-list-page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .group-list-header {
            background-color: #393a3f;
            color: white;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px; /* 移除顶部padding，确保按钮垂直居中 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .group-list-title {
            font-size: 18px;
            font-weight: normal;
        }
        
        .group-list-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .group-list-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .group-list-container {
            flex: 1;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        .group-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .group-item:hover {
            background-color: #f8f8f8;
        }
        
        .group-item.active {
            background-color: #e7f3ff;
        }
        
        .group-item.active::after {
            content: "";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #07c160;
        }
        
        .group-avatar {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            color: white;
            font-weight: bold;
        }
        
        .group-avatar.poets { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .group-avatar.history { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .group-avatar.philosophy { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); }
        .group-avatar.mystery { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        
        .group-info {
            flex: 1;
            min-width: 0;
        }
        
        .group-name {
            font-size: 17px;
            color: #333;
            margin-bottom: 2px;
            font-weight: normal;
        }
        
        .group-desc {
            font-size: 13px;
            color: #888;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .group-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 60px;
        }
        
        .group-member-count {
            font-size: 12px;
            color: #999;
            margin-bottom: 2px;
        }
        
        .group-owner {
            font-size: 11px;
            color: #576b95;
            background-color: rgba(87, 107, 149, 0.1);
            padding: 1px 4px;
            border-radius: 2px;
        }
        

        

    </style>
</head>
<body>
    <!-- 銀河系背景 -->
    <div class="galaxy-container">
        <!-- 銀河中心 -->
        <div class="galaxy-center"></div>
        

            </div>
    
    <!-- 額外的星空裝飾層 -->
    <div class="star-field"></div>
    
    <!-- 太虛幻聊 App 圖標 - 直接在銀河系背景中 -->
    <div class="app-icon-container" id="appIconContainer">
        <div class="app-icon-glow"></div>
        <div class="app-icon" id="appIcon">
            <div class="app-icon-symbol">🌌</div>
            <div class="app-icon-text">太虛幻聊</div>
        </div>
    </div>
    
    <!-- 統一父容器 - 控制所有頁面的圓角和尺寸 -->
    <div class="app-universal-container" id="appUniversalContainer">
    <!-- 登入頁面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-content">
            <!-- 標題區域 -->
            <div class="login-header">
                <div class="app-title">
                    <div class="title-main">太虛幻聊</div>
                    <div class="title-sub">與經典人物的奇妙對話</div>
                </div>
                <div class="title-decoration">
                    <div class="star">✨</div>
                    <div class="star">⭐</div>
                    <div class="star">🌟</div>
                </div>
            </div>
            
            <!-- 歡迎信息 -->
            <div class="welcome-message">
                <div class="welcome-title">歡迎來到太虛幻聊！🌟</div>
                <div class="welcome-text">
                    這裡有不同的主題群組等著你：與詩人們吟詩作對，和史家探討古今，與哲人思辨人生，還能和神話人物暢聊奇事！
                    <br><br>
                    <strong>⚠️ 重要提醒：</strong>雖然這些角色的回應都是基於AI技術生成的合理想像，但請記住<strong>不要將其視為標準答案</strong>哦～我們的目標是讓你更親近中華經典，激發學習興趣！
                    <br><br>
                    <strong>📝 使用須知：</strong>在聊天時，你可以詢問角色的故事背景，分享你對經典作品的理解和感受。同時也請注意<strong>保護個人隱私，保持文明用語</strong>，讓我們一起營造溫馨的聊天氛圍吧！💫
                </div>
                <div class="welcome-confirmation">
                    <div class="confirmation-text">請確認您已閱讀並理解以上重要說明</div>
                    <button class="confirm-btn" id="confirmBtn" onclick="confirmReading()">
                        <span id="confirmText">✓ 已經閱讀，我明白了</span>
                    </button>
                </div>
            </div>
            
            <!-- 登入表單 -->
            <div class="login-form form-disabled" id="loginForm">
                <div class="form-group">
                    <label for="nickname">你的昵稱</label>
                    <input type="text" id="nickname" placeholder="請輸入你喜歡的昵稱" maxlength="12">
                </div>
                
                <div class="form-group">
                    <label for="grade">你的年級</label>
                    <select id="grade">
                        <option value="">請選擇年級</option>
                        <option value="五年級">五年級</option>
                        <option value="六年級">六年級</option>
                        <option value="七年級">七年級</option>
                        <option value="八年級">八年級</option>
                        <option value="九年級">九年級</option>
                        <option value="十年級">十年級</option>
                        <option value="十一年級">十一年級</option>
                        <option value="十二年級">十二年級</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="password">遊戲密碼</label>
                    <input type="password" id="password" placeholder="請輸入遊戲密碼">
                    <div class="password-hint">💡 提示：密碼是英文「中國經典」</div>
                </div>
                
                <div class="button-container">
                    <button class="login-btn" id="loginBtn">
                        <span class="btn-icon">🚀</span>
                        開始太虛幻聊之旅
                    </button>
                    
                    <button class="debug-btn" id="debugBtn">
                        <span class="btn-icon">🛠️</span>
                        開發者快速進入
                    </button>
                    
                    <div class="login-error" id="loginError" style="display: none;">
                        <span class="error-icon">⚠️</span>
                        <span class="error-text"></span>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- 太虛幻聊主界面 -->
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- 主界面頭部 -->
        <div class="main-header">
            <div class="main-title">
                <span>TheyChat</span>
                <span class="main-title-count">(95)</span>
            </div>
        </div>
        
        <!-- 主界面內容 -->
        <div class="main-content" id="mainContent">
            <!-- 聊天列表 -->
            <div class="chat-list-tab active" id="chatListTab">
                <div class="chat-list-container" id="chatListContainer">
                    <!-- 群組聊天列表將動態生成 -->
                </div>
            </div>
            
            <!-- 通訊錄 -->
            <div class="contacts-tab" id="contactsTab" style="display: none;">
                <div class="contacts-container" id="contactsContainer">
                    <!-- 角色通訊錄將動態生成 -->
                </div>
            </div>
            
            <!-- 發現（朋友圈） -->
            <div class="discover-tab" id="discoverTab" style="display: none;">
                <div class="discover-container" id="discoverContainer">
                    <div class="discover-section">
                        <div class="discover-item" onclick="openMoments()">
                            <div class="discover-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">📱</div>
                            <div class="discover-label">朋友圈</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #ff9500; color: white;">🛒</div>
                            <div class="discover-label">視頻號</div>
                            <div class="discover-arrow">></div>
                        </div>
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #fb7299; color: white;">📺</div>
                            <div class="discover-label">直播</div>
                            <div class="discover-arrow">></div>
                        </div>
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #ffc100; color: white;">🛍️</div>
                            <div class="discover-label">購物</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #07c160; color: white;">🎮</div>
                            <div class="discover-label">遊戲</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #576b95; color: white;">📱</div>
                            <div class="discover-label">小程式</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 我的資料 -->
            <div class="profile-tab" id="profileTab" style="display: none;">
                <div class="profile-container" id="profileContainer">
                    <!-- 個人資料頭部 -->
                    <div class="profile-header">
                        <div class="profile-user-card">
                            <div class="profile-avatar">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2387CEEB'/%3E%3Cstop offset='100%25' style='stop-color:%234682B4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23bg)'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3E🏔️%3C/text%3E%3C/svg%3E" alt="頭像">
                            </div>
                            <div class="profile-info">
                                <div class="profile-name">張玉龍</div>
                                <div class="profile-wechat-id">WeChat ID：yulongz</div>
                                <div class="profile-status-row">
                                    <button class="status-btn">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="8" x2="12" y2="12"/>
                                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                                        </svg>
                                        + 狀態
                                    </button>
                                    <button class="camera-btn">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                            <circle cx="12" cy="13" r="4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="qr-code-btn">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                    <path d="M14 17h1v1h-1v-1z"/>
                                    <path d="M15 14h1v1h-1v-1z"/>
                                    <path d="M16 15h1v1h-1v-1z"/>
                                    <path d="M17 14h1v1h-1v-1z"/>
                                    <path d="M18 15h1v1h-1v-1z"/>
                                    <path d="M19 16h1v1h-1v-1z"/>
                                    <path d="M20 17h1v1h-1v-1z"/>
                                    <path d="M21 18h1v1h-1v-1z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第一組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item">
                            <div class="menu-icon payment">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#07C160"/>
                                    <path d="M7 9l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="8" y="6" width="8" height="2" fill="white" rx="1"/>
                                </svg>
                            </div>
                            <div class="menu-label">支付與服務</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第二組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item" onclick="openMoments()">
                            <div class="menu-icon favorites">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#FF8C00"/>
                                    <path d="M8 8h8v8H8z" fill="white"/>
                                    <path d="M6 10v6h2v-6H6zm10 0v6h2v-6h-2z" fill="white"/>
                                </svg>
                            </div>
                            <div class="menu-label">收藏</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="profile-menu-item" onclick="openMoments()">
                            <div class="menu-icon moments" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 12px; width: 24px; height: 24px; flex-shrink: 0; border-radius: 6px; position: relative;">
                                📱
                            </div>
                            <div class="menu-label">朋友圈</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第三組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item">
                            <div class="menu-icon cards">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#5D9CEC"/>
                                    <rect x="4" y="8" width="16" height="8" fill="white" rx="2"/>
                                    <line x1="4" y1="12" x2="20" y2="12" stroke="#5D9CEC" stroke-width="1"/>
                                </svg>
                            </div>
                            <div class="menu-label">票證 & 卡券</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="profile-menu-item">
                            <div class="menu-icon stickers">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#FFC107"/>
                                    <circle cx="9" cy="10" r="1.5" fill="white"/>
                                    <circle cx="15" cy="10" r="1.5" fill="white"/>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="menu-label">貼圖市集</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第四組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item">
                            <div class="menu-icon settings" style="background: #6C7B7F; color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 12px; width: 24px; height: 24px; flex-shrink: 0; border-radius: 6px; position: relative;">
                                ⚙️
                            </div>
                            <div class="menu-label">設定</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部導航欄 -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="chatListTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 3c5.5 0 10 3.58 10 8s-4.5 8-10 8c-1.24 0-2.43-.18-3.53-.5C5.55 21 2 21 2 21c2.33-2.33 2.7-3.9 2.75-4.5C3.05 15.07 2 13.13 2 11c0-4.42 4.5-8 10-8z"/>
                    </svg>
                </div>
                <div class="nav-label">聊天</div>
                <div class="nav-badge" id="chatBadge">8</div>
            </div>
            <div class="nav-item" data-tab="contactsTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <!-- 簡潔的通訊錄圖標：聯繫人簿 -->
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/>
                    </svg>
                </div>
                <div class="nav-label">通訊錄</div>
            </div>
            <div class="nav-item" data-tab="discoverTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </div>
                <div class="nav-label">發現</div>
                <div class="nav-badge" id="discoverBadge">1</div>
            </div>
            <div class="nav-item" data-tab="profileTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="nav-label">我</div>
            </div>
        </div>
    </div>



    <!-- 聊天界面（隱藏） -->
    <div class="wx-container" id="chatContainer" style="display: none;">
        <!-- 微信頭部 -->
        <div class="wx-header">
            <div class="wx-back-btn" id="backToMainBtn">&#10094;</div>
            <div class="wx-header-title">群聊</div>
            <div class="wx-menu-btn" id="openGroupDetails">⋮</div>
        </div>
        
        <!-- 聊天容器 -->
        <div id="chatMessages" class="wx-chat-container">
            <!-- 聊天消息將動態生成到這裡 -->
        </div>
        

        
        <!-- 輸入區域 -->
        <div class="wx-input-area">
            <div class="wx-voice-btn">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
                <circle cx="12" cy="12" r="11.55" fill="white" stroke="#333" stroke-width="1"/>
                <circle cx="9" cy="12" r="1.14" fill="#333"/>
                <path d="M 12,7 A 5.7,5.7 0 0 1 12,17" fill="none" stroke="#333" stroke-width="1.14"/>
                <path d="M 15,5 A 8.55,8.55 0 0 1 15,19" fill="none" stroke="#333" stroke-width="1.14"/>
            </svg>
        </div>
            <input type="text" class="wx-input-box" id="messageInput" placeholder="請輸入... 可@角色">
            <button type="button" class="wx-send-btn" id="sendBtn" title="發送">➤</button>
            <div class="wx-emoji-btn" id="emojiBtn">😊</div>
            <div class="wx-plus-btn" id="plusBtn">+</div>
        </div>
        
        <!-- Emoji選擇面板 -->
        <div id="emojiPanel" class="emoji-panel">
            <!-- 表情符號將在JavaScript中動態生成 -->
        </div>
        
        <!-- @某人選擇面板 -->
        <div id="mentionPopup" class="mention-popup">
            <!-- @某人列表將在JavaScript中動態生成 -->
        </div>
        
        <!-- 功能選項面板 -->
        <div id="functionPanel" class="function-panel">
            <div class="function-grid">
                <div class="function-item" id="photoBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <circle cx="12" cy="12" r="4" />
                            <circle cx="17" cy="7" r="1" fill="currentColor" />
                        </svg>
                    </div>
                    <div class="function-text">照片</div>
                </div>
                <div class="function-item" id="cameraBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                            <circle cx="12" cy="13" r="4" />
                        </svg>
                    </div>
                    <div class="function-text">拍攝</div>
                </div>
                <div class="function-item" id="callBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z" />
                        </svg>
                    </div>
                    <div class="function-text">語音通話</div>
                </div>
                <div class="function-item" id="locationBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                            <circle cx="12" cy="10" r="3" />
                        </svg>
                    </div>
                    <div class="function-text">位置</div>
                </div>

                <div class="function-item" id="voiceInputBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" />
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v3M8 23h8" />
                        </svg>
                    </div>
                    <div class="function-text">語音輸入</div>
                </div>
                <div class="function-item" id="favBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
                            <path d="M9 17l3-3 3 3M9 7h6M9 11h6" />
                        </svg>
                    </div>
                    <div class="function-text">收藏</div>
                </div>
            </div>
            
            <div class="function-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    
    <!-- 群組列表頁面 -->
    <div class="group-list-page" id="groupListPage">
        <div class="group-list-header">
            <div class="group-list-title">太虛幻聊</div>
            <div class="group-list-close" id="closeGroupList">×</div>
                </div>
        
        <div class="group-list-container" id="groupListContainer">
            <!-- 群組列表將動態生成到這裡 -->
            </div>
        </div>
        
    <!-- 群組詳情頁面 -->
    <div class="group-details" id="groupDetailsPage">
        <div class="detail-header">
            <div class="detail-back" id="closeGroupDetails">&#10094;</div>
            <div class="detail-title">聊天資訊</div>
            <div class="detail-placeholder"></div>
        </div>
        
        <div class="group-details-content">
            <div class="group-members-grid">
            <div class="member-item" data-character="libai">
                <div class="member-avatar">🥂</div>
                <div class="member-name">李白</div>
            </div>

            <div class="member-item" data-character="taoyuanming">
                <div class="member-avatar">🌾</div>
                <div class="member-name">陶淵明</div>
            </div>
            <div class="member-item" data-character="liuling">
                <div class="member-avatar">🍶</div>
                <div class="member-name">劉伶</div>
            </div>

            <div class="member-item" data-character="dufu">
                <div class="member-avatar">📝</div>
                <div class="member-name">杜甫</div>
            </div>
            <div class="member-item" data-character="ligui">
                <div class="member-avatar">🎵</div>
                <div class="member-name">李龜年</div>
            </div>
            <div class="member-item" data-character="yutu">
                <div class="member-avatar">🐇</div>
                <div class="member-name">玉兔</div>
            </div>
            <div class="member-item" data-character="change">
                <div class="member-avatar">🙎‍♀️</div>
                <div class="member-name">嫦娥</div>
            </div>

            <div class="member-item" data-character="yuzhen">
                <div class="member-avatar">👸</div>
                <div class="member-name">玉真公主</div>
            </div>
            <div class="member-item" data-character="wangwei">
                <div class="member-avatar">🧘</div>
                <div class="member-name">王維</div>
            </div>
            <div class="member-item" data-character="caozhi">
                <div class="member-avatar">🤴</div>
                <div class="member-name">曹植</div>
            </div>
            <div class="member-item" data-character="xiwangmu">
                <div class="member-avatar">👑</div>
                <div class="member-name">西王母</div>
            </div>
            <div class="member-item" data-character="yangguifei">
                <div class="member-avatar">💃</div>
                <div class="member-name">楊貴妃</div>
            </div>
            <div class="member-item" data-character="menghaoran">
                <div class="member-avatar">🏞️</div>
                <div class="member-name">孟浩然</div>
            </div>

            <div class="member-item">
                <div class="member-avatar" style="background-color:#f1f1f1;font-size:22px">+</div>
                <div class="member-name">邀請</div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-item">
                <div class="detail-item-label">群聊名稱</div>
                <div class="detail-item-value">
                    詩人群
                    <span class="detail-arrow">›</span>
                </div>
            </div>
            <div class="detail-item" id="groupAnnouncement">
                <div class="detail-item-label">群公告</div>
                <div class="detail-item-value">
                    <div style="color: #576b95; margin-right: 10px; white-space: pre-wrap; max-width: 230px; overflow: hidden; text-overflow: ellipsis;">【書院中文經典群聊•群規】
1. 以文會友，以詩論道📚
2. 尊重經典，傳承文化🎭
3. 新人加群，須自我介紹📝
4. 文明討論，理性交流💬
5. 分享心得，共同學習📖
6. 定期舉辦文學沙龍🎪
7. 歡迎提問，互相解答❓

本群致力於中華古典文學的學習與交流，歡迎各位文學愛好者！</div>
                    <span class="detail-arrow">›</span>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-item">
                <div class="detail-item-label">查找聊天記錄</div>
                <div class="detail-item-value">
                    <span class="detail-arrow">›</span>
                </div>
            </div>
            </div>
        </div>
    </div>
    
    <!-- 私聊對話詳情頁面 -->
    <div class="private-chat-details" id="privateChatDetailsPage">
        <div class="detail-header">
            <div class="detail-back" id="closePrivateChatDetails">&#10094;</div>
            <div class="detail-title">對話詳情</div>
            <div class="detail-placeholder"></div>
        </div>
        
        <div class="private-chat-details-content">
            <div class="private-chat-user-section">
            <div class="private-user-info">
                <div class="private-user-avatar" id="privateChatAvatar">🥂</div>
                <div class="private-user-name" id="privateChatUserName">李白</div>
            </div>
            <div class="add-user-btn">
                <div class="add-user-icon">+</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item hoverable">
                <div class="private-detail-item-label">搜尋聊天內容</div>
                <div class="private-detail-item-arrow">›</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item">
                <div class="private-detail-item-label">關閉新訊息通知</div>
                <div class="private-toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="private-detail-item">
                <div class="private-detail-item-label">對話置項</div>
                <div class="private-toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="private-detail-item">
                <div class="private-detail-item-label">提醒</div>
                <div class="private-toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item hoverable">
                <div class="private-detail-item-label">設定目前聊天背景</div>
                <div class="private-detail-item-arrow">›</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item delete-item">
                <div class="private-detail-item-label">刪除對話記錄</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item hoverable">
                <div class="private-detail-item-label">檢舉</div>
                <div class="private-detail-item-arrow">›</div>
            </div>
        </div>
        </div>
    </div>

    <!-- 成員資料頁面 -->
    <div class="member-profile" id="memberProfilePage">
        <div class="profile-nav-bar">
            <div class="profile-back-btn" id="closeMemberProfile">&#10094;</div>
            <div class="profile-more-btn">⋮</div>
        </div>
        
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">🥂</div>
            <div class="profile-info">
                <h2 class="profile-name" id="profileName">李白</h2>
                <div class="profile-signature" id="profileSignature" style="font-size: 14px; color: #888; margin-bottom: 4px; line-height: 1.4;">謫仙人也，筆落驚風雨，詩成泣鬼神</div>
                <div class="profile-wechat-id">WeChat ID：<span id="profileWechatId">libai001</span></div>
                <div class="profile-location" id="profileLocation">地區：唐 · 長安</div>
            </div>
        </div>
        
        <div class="profile-menu-section">
            <div class="profile-menu-item" id="friendInfo">
                <div class="menu-item-label">朋友資料</div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            
            <div class="profile-menu-item" id="friendPermissions">
                <div class="menu-item-label">朋友權限</div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="profile-moments-section">
            <div class="profile-menu-item" id="viewMoments">
                <div class="menu-item-label">朋友圈</div>
                <div class="moments-preview">
                    <div class="moment-preview-image">
                        <div style="width:45px;height:45px;background:linear-gradient(135deg, #ff6b6b, #feca57);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:20px;">👫</div>
                    </div>
                    <div class="moment-preview-image">
                        <div style="width:45px;height:45px;background:linear-gradient(135deg, #48cae4, #023047);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:20px;">🌊</div>
                    </div>
                    <div class="moment-preview-image">
                        <div style="width:45px;height:45px;background:linear-gradient(135deg, #f72585, #4361ee);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:20px;">✈️</div>
                    </div>
                    <div class="moment-preview-image">
                        <div style="width:45px;height:45px;background:linear-gradient(135deg, #2d6a4f, #95d5b2);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:20px;">🌺</div>
                    </div>
                </div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="profile-more-section">
            <div class="profile-menu-item" id="viewChannels">
                <div class="menu-item-label">影音號</div>
                <div class="menu-item-value" id="profileChannelName">李白</div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="profile-action-buttons">
            <div class="action-message-btn">
                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 4H4C3.45 4 3 4.45 3 5V15C3 15.55 3.45 16 4 16H6V19.5L9.5 16H18C18.55 16 19 15.55 19 15V5C19 4.45 18.55 4 18 4Z" fill="#09BB07"/>
                </svg>
                <span>傳訊息</span>
            </div>
            <div class="action-call-btn">
                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 10.5V6.5H12V4.5H16V0.5H18V4.5H22V6.5H18V10.5H16Z" fill="#09BB07"/>
                    <path d="M14 16.45C12.65 16.45 11.35 16.2 10.15 15.75C9.05 15.35 8.05 14.75 7.15 13.95C6.25 13.15 5.45 12.25 4.85 11.25C4.2 10.18 3.88 9.02 3.88 7.82C3.88 7.32 3.98 6.85 4.15 6.42C4.33 5.98 4.62 5.58 5 5.25L7.8 2.5C8 2.32 8.23 2.17 8.5 2.08C8.77 1.98 9.05 1.95 9.35 1.98C9.7 2.02 10.02 2.15 10.3 2.38C10.58 2.62 10.78 2.9 10.92 3.25L12.08 6.02C12.18 6.3 12.2 6.6 12.15 6.92C12.1 7.25 11.95 7.53 11.72 7.78L10.6 8.92C11.05 9.8 11.63 10.55 12.35 11.18C13.07 11.8 13.88 12.32 14.8 12.72L16 11.58C16.27 11.32 16.58 11.15 16.95 11.08C17.32 11 17.68 11 18.05 11.12L20.85 12.38C21.18 12.52 21.45 12.73 21.65 13.02C21.85 13.32 21.95 13.65 21.95 14C21.95 14.32 21.9 14.6 21.8 14.85C21.7 15.1 21.55 15.33 21.35 15.52L18.45 18.38C18.12 18.68 17.73 18.92 17.3 19.08C16.87 19.25 16.45 19.33 16 19.33C15.6 19.33 15.22 19.27 14.85 19.15C14.27 18.97 13.72 18.75 13.2 18.5C12.68 18.25 12.2 17.98 11.75 17.7C11.3 17.41 10.88 17.11 10.5 16.8L9.6 17.5L10.5 16.8C10.13 16.49 9.77 16.18 9.4 15.85C8.57 15.1 7.85 14.27 7.22 13.38C6.6 12.48 6.1 11.55 5.72 10.58C5.35 9.62 5.17 8.7 5.17 7.82C5.17 7.52 5.22 7.25 5.32 7C5.43 6.75 5.58 6.52 5.78 6.32L8.68 3.48C8.88 3.3 9.12 3.17 9.4 3.1C9.67 3.03 9.93 3.02 10.2 3.08L9.4 3.1L10.2 3.08C10.47 3.13 10.7 3.25 10.9 3.42C11.1 3.58 11.25 3.78 11.35 4.02L12.52 6.78C12.58 6.93 12.6 7.08 12.57 7.25C12.55 7.42 12.47 7.57 12.35 7.68L10.65 9.32L10.72 9.45C11.08 10.12 11.55 10.71 12.15 11.25C12.75 11.78 13.42 12.22 14.15 12.55L14.3 12.62L16.05 10.92C16.18 10.8 16.33 10.73 16.5 10.7C16.67 10.68 16.83 10.7 17 10.78L19.8 12.02C19.97 12.1 20.1 12.22 20.2 12.38C20.3 12.53 20.35 12.7 20.35 12.88C20.35 13.05 20.33 13.2 20.27 13.32C20.22 13.45 20.15 13.57 20.05 13.68L17.15 16.52C16.95 16.7 16.73 16.83 16.5 16.92C16.27 17 16.12 17 16 17C15.78 17 15.55 16.97 15.35 16.9C14.83 16.73 14.33 16.53 13.85 16.3C13.38 16.07 12.93 15.83 12.5 15.57C12.08 15.32 11.67 15.05 11.3 14.75C10.93 14.45 10.57 14.13 10.25 13.8L10.27 13.82C9.5 13.12 8.83 12.35 8.25 11.5C7.67 10.65 7.22 9.77 6.88 8.85C6.55 7.93 6.38 7.08 6.38 6.3L6.38 6.28C6.38 6.1 6.42 5.92 6.48 5.75C6.55 5.58 6.65 5.43 6.78 5.32L9.68 2.48C9.82 2.35 9.97 2.27 10.15 2.22C10.33 2.18 10.5 2.18 10.67 2.22L10.15 2.22L10.67 2.22C10.85 2.27 11 2.35 11.12 2.47C11.25 2.58 11.33 2.73 11.37 2.88L12.53 5.65C12.58 5.8 12.58 5.95 12.53 6.08C12.48 6.22 12.4 6.33 12.28 6.45L11.12 7.58L11.05 7.65L11.32 7.92C11.9 8.58 12.57 9.13 13.32 9.58C14.07 10.02 14.88 10.35 15.75 10.58L16.02 10.65L16.1 10.58L17.22 9.45C17.33 9.33 17.45 9.25 17.58 9.22C17.72 9.18 17.85 9.18 18 9.22L20.8 10.38C20.95 10.43 21.08 10.52 21.17 10.65C21.27 10.77 21.32 10.9 21.32 11.05C21.32 11.18 21.3 11.3 21.25 11.4C21.2 11.5 21.13 11.6 21.05 11.68L18.15 14.52C18.03 14.62 17.9 14.7 17.75 14.75C17.6 14.8 17.43 14.83 17.25 14.83C17.07 14.83 16.88 14.8 16.7 14.75C16.2 14.58 15.7 14.4 15.2 14.17C14.7 13.93 14.23 13.68 13.8 13.4C13.37 13.13 12.95 12.85 12.55 12.55C12.15 12.25 11.77 11.92 11.4 11.55L11.42 11.57C10.7 10.9 10.07 10.17 9.52 9.35C8.97 8.53 8.55 7.7 8.25 6.85C7.95 6 7.8 5.25 7.8 4.6L7.8 4.58C7.8 4.42 7.82 4.28 7.87 4.15C7.92 4.02 8 3.9 8.1 3.82L11 0.98C11.1 0.9 11.22 0.83 11.35 0.8C11.48 0.77 11.62 0.78 11.75 0.82L11.35 0.8L11.75 0.82C11.9 0.85 12.03 0.93 12.15 1.03C12.27 1.13 12.35 1.27 12.4 1.42L13.55 4.18C13.6 4.32 13.62 4.45 13.58 4.58C13.55 4.72 13.47 4.83 13.35 4.95L12.2 6.08L12.18 6.1L12.2 6.12C12.78 6.78 13.45 7.33 14.2 7.78C14.95 8.22 15.77 8.55 16.65 8.78L16.67 8.78L16.68 8.77L17.85 7.65C17.97 7.53 18.08 7.45 18.22 7.42C18.35 7.38 18.48 7.38 18.62 7.42L21.42 8.58C21.57 8.63 21.7 8.72 21.8 8.85C21.9 8.97 21.95 9.1 21.95 9.25C21.95 9.38 21.93 9.5 21.88 9.6C21.83 9.7 21.77 9.8 21.68 9.88L18.78 12.72C18.67 12.82 18.53 12.9 18.38 12.95C18.23 13 18.08 13.03 17.92 13.03C17.77 13.03 17.6 13 17.42 12.95C16.93 12.78 16.45 12.6 15.97 12.38C15.5 12.15 15.05 11.9 14.62 11.62C14.2 11.35 13.8 11.07 13.42 10.75C13.05 10.43 12.7 10.12 12.37 9.78L12.38 9.8C11.72 9.18 11.15 8.5 10.65 7.75C10.15 7 9.77 6.23 9.5 5.45C9.23 4.67 9.08 4 9.05 3.45C9.05 3.3 9.07 3.18 9.12 3.05C9.17 2.92 9.25 2.8 9.35 2.72L12.25 -0.12C12.35 -0.2 12.47 -0.27 12.6 -0.3C12.73 -0.33 12.87 -0.33 13 -0.28L12.6 -0.3L13 -0.28C13.15 -0.23 13.28 -0.15 13.4 -0.05C13.52 0.05 13.6 0.18 13.65 0.32L14.8 3.08C14.85 3.22 14.87 3.35 14.83 3.48C14.8 3.62 14.73 3.73 14.62 3.85L13.47 4.98L13.43 5.02L13.47 5.05C14.05 5.72 14.72 6.27 15.47 6.72C16.22 7.17 17.03 7.5 17.9 7.72L17.93 7.73L17.95 7.72L19.12 6.6C19.23 6.48 19.35 6.4 19.48 6.37C19.62 6.33 19.75 6.33 19.88 6.38L22.68 7.53C22.83 7.58 22.97 7.67 23.07 7.8C23.17 7.92 23.22 8.05 23.22 8.2C23.22 8.33 23.2 8.45 23.15 8.55C23.1 8.65 23.03 8.75 22.95 8.83L20.05 11.68C19.93 11.78 19.8 11.85 19.65 11.9C19.5 11.95 19.35 11.98 19.2 11.98C19.03 11.98 18.87 11.95 18.7 11.9C18.2 11.73 17.72 11.55 17.25 11.33C16.78 11.1 16.33 10.85 15.92 10.57C15.5 10.3 15.1 10.02 14.73 9.72C14.35 9.42 14 9.1 13.67 8.77" fill="#09BB07"/>
                </svg>
                <span>語音/視訊通話</span>
            </div>
        </div>
    </div>
    
    <!-- 朋友圈界面 -->
    <div class="moments" id="momentsPage">
        <div class="detail-header">
            <div class="detail-back" id="closeMoments">&#10094;</div>
            <div class="detail-title">朋友圈</div>
        </div>
        
        <div id="momentsContainer_old">
            <!-- 朋友圈內容會動態生成到這裡 -->
        </div>
    </div>
    
    <!-- 朋友圈頁面 -->
    <div class="moments-container" id="momentsContainer" style="display: none;">
        <!-- 朋友圈頭部 -->
        <div class="moments-header">
            <div class="moments-back-btn" id="momentsBackBtn">&#10094;</div>
            <div class="moments-camera-btn" id="momentsCameraBtn">📷</div>
        </div>
        
        <!-- 朋友圈內容區域 -->
        <div class="moments-content" id="momentsContent">
            <!-- 朋友圈動態將動態生成 -->
        </div>
    </div>

    </div> <!-- 關閉統一父容器 -->
    
    <script>
        // ===== 全域除錯與工具 =====
        // DEBUG 開關：?debug=1 或 localStorage.DEBUG='1'/'true'
        const DEBUG = (() => {
            try {
                const qs = new URLSearchParams(location.search);
                const lv = (localStorage.getItem('DEBUG') || '').toLowerCase();
                return qs.get('debug') === '1' || qs.get('debug') === 'true' || lv === '1' || lv === 'true';
            } catch (e) { return false; }
        })();

        // 屏蔽大部分 console.log / console.debug（保留 warn / error）
        if (!DEBUG) {
            try {
                console.log = function () {};
                console.debug = function () {};
            } catch (e) {}
        }

        // rAF 與節流/防抖工具
        function throttle(fn, wait = 150) {
            let lastTime = 0;
            let timeoutId = null;
            let lastArgs = null;
            let lastThis = null;
            return function throttled(...args) {
                const now = Date.now();
                const remaining = wait - (now - lastTime);
                lastArgs = args; lastThis = this;
                const later = () => {
                    lastTime = Date.now();
                    timeoutId = null;
                    requestAnimationFrame(() => fn.apply(lastThis, lastArgs));
                    lastArgs = lastThis = null;
                };
                if (remaining <= 0 || remaining > wait) {
                    if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }
                    later();
                } else if (!timeoutId) {
                    timeoutId = setTimeout(later, remaining);
                }
            };
        }
        function debounce(fn, wait = 200) {
            let id = null; let lastArgs = null; let lastThis = null;
            return function debounced(...args) {
                lastArgs = args; lastThis = this;
                if (id) cancelAnimationFrame(id);
                id = requestAnimationFrame(() => {
                    setTimeout(() => { fn.apply(lastThis, lastArgs); id = null; }, wait);
                });
            };
        }

        // 基礎 HTML 消毒（白名單法）
        function sanitizeHTML(unsafeHtml) {
            try {
                const allowedTags = new Set(['b','i','em','strong','p','br','ul','ol','li','a','span','code','pre']);
                const allowedAttrs = {
                    'a': new Set(['href','target','rel']),
                    'span': new Set([]),
                    'code': new Set([]),
                    'pre': new Set([])
                };
                const parser = new DOMParser();
                const doc = parser.parseFromString(`<div>${unsafeHtml || ''}</div>`, 'text/html');
                const container = doc.body.firstChild;

                const sanitizeNode = (node) => {
                    // 移除 script/style 及註解
                    if (node.nodeType === 8) { node.remove(); return; }
                    if (node.nodeType === 1) {
                        const tag = node.tagName.toLowerCase();
                        if (!allowedTags.has(tag)) {
                            // 用其文字內容替換未知標籤
                            const text = doc.createTextNode(node.textContent || '');
                            node.replaceWith(text);
                            return;
                        }
                        // 清理危險屬性
                        [...node.attributes].forEach(attr => {
                            const name = attr.name.toLowerCase();
                            const value = attr.value || '';
                            if (name.startsWith('on')) { node.removeAttribute(attr.name); return; }
                            if (tag === 'a') {
                                if (!allowedAttrs['a'].has(name)) { node.removeAttribute(attr.name); return; }
                                if (name === 'href') {
                                    const v = value.trim().toLowerCase();
                                    if (!(v.startsWith('http:') || v.startsWith('https:') || v.startsWith('mailto:') || v.startsWith('#'))) {
                                        node.removeAttribute('href');
                                    }
                                }
                                if (name === 'target') { if (value !== '_blank' && value !== '_self') node.removeAttribute('target'); }
                                if (name === 'rel') { if (!/noopener|noreferrer/.test(value)) node.setAttribute('rel','noopener noreferrer'); }
                            } else {
                                // 非 a 標籤不保留任何屬性
                                node.removeAttribute(attr.name);
                            }
                        });
                    }
                    // 遞迴處理子節點
                    [...node.childNodes].forEach(sanitizeNode);
                };
                sanitizeNode(container);
                return container.innerHTML;
            } catch (e) {
                return '';
            }
        }
        // 檢測深色模式
        // 已移除暗色模式，避免冗餘監聽

        // 全局變量，標記是否完成過任意結局
        let hasCompletedAnyEnding = false;
        
        // 全局變量，記錄當前查看的角色ID
        let currentViewingCharacterId = null;
        
        // 獲取當前查看的角色ID
        function getCurrentViewingCharacterId() {
            return currentViewingCharacterId;
        }
        
        // 頁面歷史管理器
        class PageHistoryManager {
            constructor() {
                this.history = [];
                this.currentPage = 'mainContainer'; // 默認當前頁面
            }
            
            // 推入新頁面
            pushPage(pageId) {
                console.log('pushPage被调用, 目標頁面:', pageId, '當前頁面:', this.currentPage);
                if (this.currentPage && this.currentPage !== pageId) {
                    this.history.push(this.currentPage);
                    console.log('推入頁面歷史:', this.currentPage, '歷史棧:', this.history);
                } else {
                    console.log('跳過推入歷史 (當前頁面相同或為空)');
                }
                this.currentPage = pageId;
                console.log('更新當前頁面為:', this.currentPage);
            }
            
            // 返回上一頁
            goBack() {
                console.log('goBack被调用, 當前歷史棧:', this.history);
                if (this.history.length > 0) {
                    const previousPage = this.history.pop();
                    console.log('返回上一頁:', previousPage, '剩餘歷史棧:', this.history);
                    this.currentPage = previousPage;
                    this.showPage(previousPage);
                    return true;
                }
                // 沒有歷史記錄，返回主界面
                console.log('沒有歷史記錄，返回主界面');
                this.currentPage = 'mainContainer';
                this.showPage('mainContainer');
                return false;
            }
            
            // 顯示指定頁面
            showPage(pageId) {
                // 隱藏所有頁面
                const pages = ['mainContainer', 'groupDetailsPage', 'memberProfilePage', 'momentsContainer', 'chatContainer', 'privateChatDetailsPage'];
                pages.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                // 顯示目標頁面
                const targetElement = document.getElementById(pageId);
                if (targetElement) {
                    targetElement.style.display = 'flex';
                    console.log('顯示頁面:', pageId);
                } else {
                    console.error('找不到頁面元素:', pageId);
                }
            }
            
            // 清空歷史
            clearHistory() {
                this.history = [];
                this.currentPage = 'mainContainer';
            }
        }
        
        // 全局頁面歷史管理器實例
        const pageHistory = new PageHistoryManager();
        
        // 配置管理系統 - 便於後續維護和擴展
        const CONFIG = {
            // 群組配置
            groups: {
                'poets_group': {
                    id: 'poets_group',
                    name: '詩人群',
                    description: '古往今來詩人雅集，以詩會友',
                    theme: '詩歌創作與鑑賞',
                    owner: 'yuzhen', // 群主：玉真公主
                    aiStyle: {
                        tone: '詩意盎然，才華橫溢',
                        focus: '詩詞韻律、意境營造、詩歌技法',
                        avoidTopics: ['政治敏感', '暴力內容', '世俗爭議'],
                        encourageTopics: ['詩歌創作', '韻律探討', '意境賞析', '詩人軼事', '自然山水']
                    },
                    members: ['yuzhen', 'libai', 'dufu', 'taoyuanming', 'wangwei', 'menghaoran', 'caozhi', 'yangguifei', 'lishangyin', 'dumu', 'lihe', 'baiyuyi', 'caocao', 'caopi', 'quyuan', 'huangtingjian', 'sushi'],
                    maxMembers: 25,
                    isActive: true
                },
                'history_group': {
                    id: 'history_group', 
                    name: '史記群',
                    description: '以史為鑑，知興替得失',
                    theme: '歷史記錄與史學討論',
                    owner: 'simaqian', // 群主：司馬遷
                    aiStyle: {
                        tone: '客觀嚴謹，見解深刻',
                        focus: '歷史事件、人物評價、史學方法、因果分析',
                        avoidTopics: ['政治敏感', '現代政治', '爭議歷史'],
                        encourageTopics: ['古代歷史', '人物傳記', '史學方法', '文化傳承']
                    },
                    members: ['simaqian', 'confucius', 'baiqi', 'hanxin', 'xiangyu', 'liubang', 'qinshihuang', 'jingke', 'gaojianli', 'zhangliang', 'fanhui', 'fanzeng', 'yuji', 'taizidan', 'niezheng', 'lvhou', 'hanwudi', 'daji', 'zhouwuwang', 'shangzhouwang', 'baosi', 'zhouyouwang', 'zhouwenwang', 'wuzixu', 'qihuangong', 'jinwengong', 'goujian', 'fuchai', 'chuhuaiwang', 'liling', 'jiayi', 'zhangqian', 'suqin', 'zhangyi', 'zhaokuo', 'lianpo', 'lvbuwei', 'laoai', 'lisi', 'zhaogao', 'gongzifusu', 'weizifu', 'chenajiao', 'huhai'],
                    maxMembers: 50,
                    isActive: true
                },
                'philosophy_group': {
                    id: 'philosophy_group',
                    name: '聞道群', 
                    description: '探尋天道人理，思辨古今智慧',
                    theme: '哲學思辨與人生智慧',
                    owner: 'confucius,laozi', // 雙群主：孔子、老子
                    aiStyle: {
                        tone: '睿智深沉，啟發思考',
                        focus: '哲學思辨、人生智慧、道德修養、天人關係',
                        avoidTopics: ['政治敏感', '宗教爭議', '極端觀點'],
                        encourageTopics: ['哲學思考', '人生感悟', '道德品格', '自然之道', '教育理念']
                    },
                    members: ['confucius', 'laozi', 'zhuangzi', 'mencius', 'huizi'],
                    maxMembers: 15,
                    isActive: true
                },
                'mystery_group': {
                    id: 'mystery_group',
                    name: '怪力亂神群',
                    description: '神話傳說，奇聞異事',
                    theme: '神話故事與奇幻傳說',
                    owner: 'pushengling,ganbao', // 雙群主：蒲松齡、干寶
                    aiStyle: {
                        tone: '神秘玄妙，想像豐富', 
                        focus: '神話傳說、奇聞異事、超自然現象、古代神怪',
                        avoidTopics: ['恐怖血腥', '封建迷信', '不當內容'],
                        encourageTopics: ['神話故事', '傳說考證', '文化象徵', '想像創作']
                    },
                    members: ['pushengling', 'ganbao', 'yutu', 'change', 'xiwangmu'],
                    maxMembers: 30,
                    isActive: true
                },
                'ci_poets_group': {
                    id: 'ci_poets_group',
                    name: '詞人群',
                    description: '詞韻悠揚，情致綿綿',
                    theme: '詞學創作與鑑賞',
                    owner: 'liuyong', // 群主：柳永
                    aiStyle: {
                        tone: '雅致深情，韻律優美',
                        focus: '詞學創作、音律格律、情感表達、詞牌探討',
                        avoidTopics: ['政治敏感', '暴力內容', '世俗爭議'],
                        encourageTopics: ['詞學技法', '音律美學', '情感抒發', '詞人軼事', '詞牌源流', '婉約豪放']
                    },
                    members: ['liuyong', 'liqingzhao', 'sushi', 'xinqiji', 'jiangkui', 'liyu', 'zhoubanyan', 'yanjidao', 'wuwenying', 'chenweisong', 'zhuyizun', 'nalanxingde'],
                    maxMembers: 20,
                    isActive: true
                },
                'dahua_group': {
                    id: 'dahua_group',
                    name: '大觀園業主群',
                    description: '大觀園業主專屬群組',
                    theme: '紅樓夢故事與人物交流',
                    owner: 'jiabaoyu', // 群主：賈寶玉
                    aiStyle: {
                        tone: '紅樓夢風格，叛逆與真情',
                        focus: '紅樓夢故事、人物特點、情感表達、詩歌技法',
                        avoidTopics: ['政治敏感', '暴力內容', '世俗爭議'],
                        encourageTopics: ['紅樓夢故事', '人物軼事', '情感抒發', '詩歌創作', '文學賞析']
                    },
                    members: ['lindaiyu', 'xuebaochai', 'jiatanchun', 'jiayingchun', 'jiaxichun', 'shixiangyun', 'liwan', 'miaoyu', 'jiabaoyu'],
                    maxMembers: 20,
                    isActive: true
                },
                'jiafu_family_group': {
                    id: 'jiafu_family_group',
                    name: '賈府大家庭',
                    description: '賈府親族與僕從齊聚一堂的大家庭群',
                    theme: '紅樓夢家族群聊',
                    owner: 'jiamu',
                    aiStyle: {
                        tone: '紅樓夢群像風格，合乎原著人物形象',
                        focus: '家族日常、禮法家常、人物互動、詩詞唱和',
                        avoidTopics: ['政治敏感', '暴力內容', '世俗爭議'],
                        encourageTopics: ['紅樓夢人物描寫', '大觀園逸事', '禮節家常', '詩詞應酬']
                    },
                    members: [
                        // 大觀園業主群現有成員
                        'lindaiyu','xuebaochai','jiatanchun','jiayingchun','jiaxichun','shixiangyun','liwan','miaoyu','jiabaoyu',
                        // 新增成員
                        'jiamu','qinkeqing','wangxifeng','xuepan','wangfuren','xueyima','xiren','qingwen','jiarong','jiazhen','jiazheng','jiashe','yinglian','liulaolao','jialian','yuanyang','zijuan','yinger','linainai'
                    ],
                    maxMembers: 50,
                    isActive: true
                },
                
            },
            
            // 安全性配置
            safety: {
                contentFilter: {
                    enabled: false,
                    strictMode: true, // 中學生模式
                    blockedKeywords: [
                        // 政治敏感詞
                        '政治', '革命', '造反', '推翻',
                        // 暴力內容
                        '殺', '死', '血', '戰爭', '仇恨',
                        // 不當內容
                        '色情', '賭博', '毒品', '犯罪',
                        // 現代不當用語
                        '網絡暴力', '霸凌'
                    ],
                    warningKeywords: [
                        '愛情', '戀愛', '婚姻' // 需要謹慎處理的話題
                    ]
                },
                aiGuidelines: {
                    // AI回應指導原則
                    principles: [
                        '始終保持正面積極的教育導向',
                        '引導學生思考文學和人生的美好',
                        '避免涉及政治敏感話題',
                        '以古代文化智慧啟發現代思考',
                        '鼓勵學習和探索精神'
                    ],
                    responseStyle: 'educational_positive',
                    maxResponseLength: 200
                }
            },
            
            // 角色行為配置
            characterBehaviors: {
                // 每個角色在不同情境下的行為模式
                default: {
                    greeting: '歡迎加入我們的文學討論',
                    onInappropriateTopic: '讓我們回到文學的美好世界吧',
                    onOffTopic: '這個話題很有趣，不過讓我們多聊聊古典文學如何？'
                }
            }
        };
        
        // 群組管理類
        class GroupManager {
            constructor() {
                this.currentGroup = 'poets_group'; // 默認進入詩人群
                this.safetyFilter = new SafetyFilter();
            }
            
            // 動態添加群組
            addGroup(groupConfig) {
                CONFIG.groups[groupConfig.id] = groupConfig;
                console.log(`群組 ${groupConfig.name} 已添加`);
            }
            

            
            // 獲取當前群組的AI提示詞
            getAIPrompt(characterId, userMessage) {
                const group = CONFIG.groups[this.currentGroup];
                const character = characters[characterId];
                
                return `
你是${character.name}，在"${group.name}"群組中。

群組主題：${group.theme}
語言風格：${group.aiStyle.tone}
討論重點：${group.aiStyle.focus}
鼓勵話題：${group.aiStyle.encourageTopics.join('、')}

重要原則：
${CONFIG.safety.aiGuidelines.principles.join('\n')}

用戶消息：${userMessage}

請以${character.name}的身份，用符合群組風格的方式回應，保持教育性和正面性。
                `;
            }
            

        }
        
        // 安全過濾器類
        class SafetyFilter {
            constructor() {
                this.config = CONFIG.safety.contentFilter;
            }
            
            // 檢查用戶輸入安全性
            checkUserInput(message) {
                if (!this.config.enabled) return { safe: true };
                
                const lowerMessage = message.toLowerCase();
                
                // 檢查被禁關鍵詞
                for (let keyword of this.config.blockedKeywords) {
                    if (lowerMessage.includes(keyword.toLowerCase())) {
                        return {
                            safe: false,
                            reason: 'blocked_keyword',
                            keyword: keyword,
                            suggestion: '讓我們聊聊文學和詩詞吧！'
                        };
                    }
                }
                
                // 檢查警告關鍵詞
                for (let keyword of this.config.warningKeywords) {
                    if (lowerMessage.includes(keyword.toLowerCase())) {
                        return {
                            safe: true,
                            warning: true,
                            keyword: keyword,
                            note: '這個話題需要以文學和文化的角度來討論'
                        };
                    }
                }
                
                return { safe: true };
            }
            
            // 過濾AI回應
            filterAIResponse(response) {
                // 確保AI回應符合安全標準
                let filtered = response;
                
                // 長度控制
                if (filtered.length > CONFIG.safety.aiGuidelines.maxResponseLength) {
                    filtered = filtered.substring(0, CONFIG.safety.aiGuidelines.maxResponseLength) + '...';
                }
                
                return filtered;
            }
            
            // 檢查AI回應安全性（私聊專用）
            async checkAIResponse(userMessage, characterId) {
                // 簡單的安全檢查，允許正常的文學對話
                return {
                    safe: true,
                    reason: null
                };
            }
        }
        
        // 全局實例
        const groupManager = new GroupManager();
        const safetyFilter = new SafetyFilter();
        
        // 配置管理工具（方便開發和調試）
        const ConfigManager = {
            // 快速添加新群組
            addNewGroup(groupData) {
                groupManager.addGroup(groupData);
                console.log('新群組配置已添加:', groupData.name);
            },
            
            // 快速添加新角色
            addCharacter(id, characterData) {
                characters[id] = characterData;
                console.log('新角色已添加:', characterData.name);
            },
            
            // 調整安全關鍵詞
            updateSafetyKeywords(type, keywords) {
                if (type === 'blocked') {
                    CONFIG.safety.contentFilter.blockedKeywords = keywords;
                } else if (type === 'warning') {
                    CONFIG.safety.contentFilter.warningKeywords = keywords;
                }
                console.log(`安全關鍵詞已更新: ${type}`);
            },
            
            // 快速切換群組
            switchToGroup(groupId) {
                if (CONFIG.groups[groupId]) {
                    groupManager.currentGroup = groupId;
                    console.log(`已切換到群組: ${CONFIG.groups[groupId].name}`);
                } else {
                    console.error('群組不存在:', groupId);
                }
            },
            
            // 導出當前配置
            exportConfig() {
                return {
                    groups: CONFIG.groups,
                    characters: characters,
                    safety: CONFIG.safety
                };
            },
            
            // 導入配置
            importConfig(configData) {
                if (configData.groups) Object.assign(CONFIG.groups, configData.groups);
                if (configData.characters) Object.assign(characters, configData.characters);
                if (configData.safety) Object.assign(CONFIG.safety, configData.safety);
                console.log('配置已導入');
            },
            
            // 查看所有群組
            listGroups() {
                console.log('=== 太虛幻聊 群組列表 ===');
                Object.values(CONFIG.groups).forEach(group => {
                    console.log(`📱 ${group.name} (${group.id})`);
                    console.log(`   群主: ${group.owner}`);
                    console.log(`   成員: ${group.members.join(', ')}`);
                    console.log(`   主題: ${group.theme}`);
                    console.log('---');
                });
            },
            
            // 驗證群組成員配置
            validateGroupMembers() {
                console.log('=== 驗證群組成員配置 ===');
                let isValid = true;
                
                Object.values(CONFIG.groups).forEach(group => {
                    console.log(`檢查群組: ${group.name}`);
                    
                    group.members.forEach(memberId => {
                        if (!characters[memberId]) {
                            console.warn(`⚠️ 群組 ${group.name} 中的成員 ${memberId} 沒有在 characters 中定義`);
                            isValid = false;
                        } else {
                            console.log(`  ✓ ${characters[memberId].name} (${memberId})`);
                        }
                    });
                    
                    if (group.members.length === 0) {
                        console.warn(`⚠️ 群組 ${group.name} 沒有任何成員`);
                        isValid = false;
                    }
                    
                    console.log('---');
                });
                
                if (isValid) {
                    console.log('✅ 群組成員配置驗證通過');
                } else {
                    console.log('❌ 群組成員配置存在問題');
                }
                
                return isValid;
            },
            
            // 檢查發言權限
            checkSpeakPermission(characterId, groupId) {
                const group = CONFIG.groups[groupId];
                if (!group) {
                    console.warn(`群組 ${groupId} 不存在`);
                    return false;
                }
                
                const canSpeak = group.members.includes(characterId);
                console.log(`角色 ${characterId} 在群組 ${group.name} 中的發言權限: ${canSpeak ? '✅ 可以' : '❌ 不可以'}`);
                return canSpeak;
            }
        };
        
        // 暴露到全局，方便開發者控制台使用
        window.ConfigManager = ConfigManager;
        
        // 群組列表管理器
        class GroupListManager {
            constructor() {
                this.groupIcons = {
                    'poets_group': '📝',
                    'history_group': '📚', 
                    'philosophy_group': '🧘',
                    'mystery_group': '👻'
                };
                this.groupClasses = {
                    'poets_group': 'poets',
                    'history_group': 'history',
                    'philosophy_group': 'philosophy', 
                    'mystery_group': 'mystery'
                };
            }
            
            // 生成群組列表
            generateGroupList() {
                const container = document.getElementById('groupListContainer');
                container.innerHTML = '';
                
                Object.values(CONFIG.groups).forEach(group => {
                    const groupItem = this.createGroupItem(group);
                    container.appendChild(groupItem);
                });
            }
            
            // 創建單個群組項目
            createGroupItem(group) {
                const item = document.createElement('div');
                item.className = `group-item ${group.id === groupManager.currentGroup ? 'active' : ''}`;
                item.setAttribute('data-group-id', group.id);
                
                const icon = this.groupIcons[group.id] || '💬';
                const avatarClass = this.groupClasses[group.id] || '';
                const ownerNames = this.getOwnerNames(group.owner);
                
                item.innerHTML = `
                    <div class="group-avatar ${avatarClass}">
                        ${icon}
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-desc">${group.description}</div>
                    </div>
                    <div class="group-meta">
                        <div class="group-member-count">${group.members.length}人</div>
                        <div class="group-owner">群主: ${ownerNames}</div>
                    </div>
                `;
                
                // 添加點擊事件
                item.addEventListener('click', () => {
                    this.switchToGroup(group.id);
                });
                
                return item;
            }
            
            // 獲取群主名稱
            getOwnerNames(ownerIds) {
                if (!ownerIds) return '無';
                
                const owners = ownerIds.split(',');
                return owners.map(id => {
                    const character = characters[id.trim()];
                    return character ? character.name : id;
                }).join('、');
            }
            
            // 切換到指定群組
            switchToGroup(groupId) {
                if (groupId === groupManager.currentGroup) {
                    // 如果是當前群組，直接關閉列表
                    this.closeGroupList();
                    return;
                }
                
                // 清理當前對話上下文
                clearConversationContext();
                
                // 切換群組
                groupManager.currentGroup = groupId;
                
                // 直接設置群組標題
                const currentGroup = CONFIG.groups[groupId];
                if (currentGroup) {
                    const groupTitle = document.querySelector('.wx-header-title');
                    if (groupTitle) {
                        groupTitle.textContent = `${currentGroup.name}（${currentGroup.members.length}人）`;
                        console.log(`群組標題已設置為: ${groupTitle.textContent}`);
                    }
                }
                
                // 如果當前在群組詳情頁面，更新詳情內容
                const groupDetailsPage = document.getElementById('groupDetailsPage');
                if (groupDetailsPage && groupDetailsPage.style.display === 'flex') {
                    updateGroupDetailsContent();
                }
                
                // 更新群組列表中的活躍狀態
                this.updateActiveGroup();
                
                // 清空聊天記錄，顯示新群組歡迎消息
                this.clearChatAndWelcome(groupId);
                
                // 關閉列表
                this.closeGroupList();
                
                console.log(`已切換到群組: ${CONFIG.groups[groupId].name}`);
            }
            
            // 更新活躍群組顯示
            updateActiveGroup() {
                const items = document.querySelectorAll('.group-item');
                items.forEach(item => {
                    const groupId = item.getAttribute('data-group-id');
                    if (groupId === groupManager.currentGroup) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            // 清空聊天並顯示歡迎消息
            clearChatAndWelcome(groupId) {
                const chatMessages = PerformanceUtils.getCachedElement('#chatMessages');
                chatMessages.innerHTML = '';
                
                // 初始化群聊上下文
                groupChatContext.messages = [];
                groupChatContext.lastUpdateTime = Date.now();
                console.log('群聊上下文已初始化');
                
                const group = CONFIG.groups[groupId];
                
                // 群組歡迎消息（不重複添加時間戳）
                addMessage({
                    type: 'system',
                    content: `歡迎來到${group.name}！${group.description}`
                });
                
                // 群主歡迎
                setTimeout(() => {
                    const owners = group.owner.split(',');
                    const firstOwner = owners[0].trim();
                    const ownerChar = characters[firstOwner];
                    
                    if (ownerChar) {
                        addMessage({
                            type: 'message',
                            character: firstOwner,
                            content: this.getWelcomeMessage(groupId, ownerChar),
                            contentType: 'text'
                        });
                    }
                }, 1000);
            }
            
            // 打開群組列表
            openGroupList() {
                this.generateGroupList();
                document.getElementById('groupListPage').style.display = 'flex';
            }
            
            // 關閉群組列表
            closeGroupList() {
                document.getElementById('groupListPage').style.display = 'none';
            }
        }
        
        // 全局群組列表管理器實例
        const groupListManager = new GroupListManager();
        
        // 聊天歷史管理器
        class ChatHistoryManager {
            constructor() {
                this.storageKey = 'wxchat_history';
                this.maxMessagesPerChat = 1000; // 每個聊天最多保存1000條消息
            }
            
            // 獲取所有聊天歷史
            getAllHistory() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : {};
                } catch (error) {
                    console.error('讀取聊天歷史失敗:', error);
                    return {};
                }
            }
            
            // 獲取特定聊天的歷史記錄
            getChatHistory(chatId) {
                const allHistory = this.getAllHistory();
                return allHistory[chatId] || [];
            }
            
            // 保存消息到歷史記錄
            saveMessage(chatId, message) {
                try {
                    const allHistory = this.getAllHistory();
                    
                    if (!allHistory[chatId]) {
                        allHistory[chatId] = [];
                    }
                    
                    // 添加時間戳和ID
                    const messageWithMeta = {
                        ...message,
                        id: this.generateMessageId(),
                        timestamp: new Date().toISOString(),
                        saved: true
                    };
                    
                    allHistory[chatId].push(messageWithMeta);
                    
                    // 限制消息數量，保留最新的消息
                    if (allHistory[chatId].length > this.maxMessagesPerChat) {
                        allHistory[chatId] = allHistory[chatId].slice(-this.maxMessagesPerChat);
                    }
                    
                    localStorage.setItem(this.storageKey, JSON.stringify(allHistory));
                    console.log(`消息已保存到 ${chatId}:`, messageWithMeta.content || messageWithMeta.type);
                    
                    return messageWithMeta;
                } catch (error) {
                    console.error('保存消息失敗:', error);
                    return message;
                }
            }
            
            // 生成消息ID
            generateMessageId() {
                return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            // 載入聊天歷史到界面
            loadChatHistory(chatId) {
                const history = this.getChatHistory(chatId);
                const chatMessages = PerformanceUtils.getCachedElement('#chatMessages');
                
                if (!chatMessages) return;
                
                // 清空現有消息
                chatMessages.innerHTML = '';
                
                console.log(`載入 ${chatId} 的歷史記錄，共 ${history.length} 條消息`);
                
                // 渲染歷史消息
                history.forEach(message => {
                    this.renderHistoryMessage(message);
                });
                
                // 使用requestAnimationFrame優化滾動到底部
                PerformanceUtils.scheduleUpdate(() => {
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
                
                return history.length;
            }
            
            // 渲染歷史消息
            renderHistoryMessage(message) {
                if (message.type === 'system') {
                    this.renderSystemMessage(message);
                } else if (message.type === 'message') {
                    this.renderCharacterMessage(message);
                } else if (message.type === 'user') {
                    this.renderUserMessage(message);
                }
            }
            
            // 渲染系統消息
            renderSystemMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const systemMsg = document.createElement('div');
                systemMsg.className = 'wx-system-msg';
                systemMsg.textContent = message.content;
                chatMessages.appendChild(systemMsg);
            }
            
            // 渲染角色消息
            renderCharacterMessage(message) {
                const character = characters[message.character];
                if (!character) return;
                
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = 'wx-msg wx-msg-others';
                
                messageElement.innerHTML = `
                    <div class="wx-avatar-wrapper">
                        <div class="wx-name">${character.name}</div>
                        <div class="wx-avatar" onclick="handleAvatarClick('${message.character}', event)">
                            ${character.avatar}
                        </div>
                    </div>
                    <div class="wx-content-wrapper">
                        <div class="wx-msg-bubble">
                            ${message.content}
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
            }
            
            // 渲染用戶消息
            renderUserMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = 'wx-msg wx-msg-self';
                
                messageElement.innerHTML = `
                    <div class="wx-avatar-wrapper">
                        <div class="wx-name">我</div>
                        <div class="wx-avatar">👤</div>
                    </div>
                    <div class="wx-content-wrapper">
                        <div class="wx-msg-bubble">
                            ${message.content}
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
            }
            
            // 獲取聊天的最後一條消息（用於聊天列表預覽）
            getLastMessage(chatId) {
                const history = this.getChatHistory(chatId);
                if (history.length === 0) return null;
                
                const lastMessage = history[history.length - 1];
                return {
                    content: this.formatPreviewMessage(lastMessage),
                    timestamp: lastMessage.timestamp
                };
            }
            
            // 格式化預覽消息
            formatPreviewMessage(message) {
                if (message.type === 'system') {
                    return message.content;
                } else if (message.type === 'user') {
                    return message.content;
                } else if (message.type === 'message') {
                    const character = characters[message.character];
                    const name = character ? character.name : '角色';
                    return `${name}: ${message.content}`;
                }
                return message.content || '[消息]';
            }
            
            // 清空特定聊天的歷史記錄
            clearChatHistory(chatId) {
                try {
                    const allHistory = this.getAllHistory();
                    delete allHistory[chatId];
                    localStorage.setItem(this.storageKey, JSON.stringify(allHistory));
                    console.log(`已清空 ${chatId} 的歷史記錄`);
                } catch (error) {
                    console.error('清空歷史記錄失敗:', error);
                }
            }
            
            // 清空所有歷史記錄
            clearAllHistory() {
                try {
                    localStorage.removeItem(this.storageKey);
                    console.log('已清空所有聊天歷史記錄');
                } catch (error) {
                    console.error('清空所有歷史記錄失敗:', error);
                }
            }
            
            // 獲取存儲大小（KB）
            getStorageSize() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? Math.round(data.length / 1024 * 100) / 100 : 0;
                } catch (error) {
                    return 0;
                }
            }
            
            // 導出聊天記錄
            exportHistory() {
                const allHistory = this.getAllHistory();
                const dataStr = JSON.stringify(allHistory, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }
        
        // 全局聊天歷史管理器實例
        const chatHistoryManager = new ChatHistoryManager();
        
        // 主界面管理器
        class MainInterface {
            constructor() {
                this.currentTab = 'chatListTab';
                this.chatPreviews = {
                    'poets_group': '玉真公主: 歡迎新朋友加入詩人群！',
                    'history_group': '司馬遷: 以史為鑑，可以知興替',
                    'philosophy_group': '孔子: 學而時習之，不亦說乎？',
                    'mystery_group': '蒲松齡: 今夜又有新的奇聞異事...'
                };
                this.chatTimes = {
                    'poets_group': '19:28',
                    'history_group': '16:41', 
                    'philosophy_group': '23:59',
                    'mystery_group': '16:36'
                };
            }
            
            // 初始化主界面
            init() {
                this.initializeSamplePrivateChats();
                this.generateChatList();
                this.generateContacts();
                this.generateDiscover();
                this.setupMainEvents();
                this.updateBadges();
                
                // 初始化時設置當前標籤頁和正確的標題
                this.currentTab = 'chatListTab';
                this.updateMainHeader('chatListTab');
                
                // 朋友圈延迟加载 - 只有用户点击时才初始化
                // momentsManager.init(); // 移除立即初始化
            }
            
            // 初始化示例私聊
            initializeSamplePrivateChats() {
                const samplePrivateChats = ['li_bai', 'chang_e'];
                
                samplePrivateChats.forEach(characterId => {
                    const privateChatId = `private_${characterId}`;
                    if (!CONFIG.groups[privateChatId] && characters[characterId]) {
                        CONFIG.groups[privateChatId] = {
                            id: privateChatId,
                            name: characters[characterId].name,
                            description: `與${characters[characterId].name}的私人對話`,
                            theme: '私人對話',
                            owner: characterId,
                            members: ['user', characterId],
                            maxMembers: 2,
                            isActive: true,
                            isPrivateChat: true
                        };
                    }
                });
            }
            
            // 聊天預覽消息（示例數據）
            chatPreviews = {
                'poets_group': '李白: 君不見黃河之水天上來...',
                'history_group': '司馬遷: 史記第一百三十卷完成',
                'philosophy_group': '孔子: 學而時習之，不亦說乎？',
                'mystery_group': '嫦娥: 廣寒宮中又是一年...'
            }
            
            // 聊天時間（示例數據）
            chatTimes = {
                'poets_group': '13:42',
                'history_group': '昨天',
                'philosophy_group': '2天前', 
                'mystery_group': '1小時前'
            }
            
            // 進入聊天界面
            enterChat(groupId) {
                // 切換到聊天界面
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
                
                // 設置當前群組
                groupManager.currentGroup = groupId;
                console.log(`切換到群組: ${groupId}`);
                
                // 直接設置群組標題
                const currentGroup = CONFIG.groups[groupId];
                if (currentGroup) {
                    const groupTitle = document.querySelector('.wx-header-title');
                    if (groupTitle) {
                        groupTitle.textContent = `${currentGroup.name}（${currentGroup.members.length}人）`;
                        console.log(`群組標題已設置為: ${groupTitle.textContent}`);
                    }
                }
                
                // 如果當前在群組詳情頁面，更新詳情內容
                const groupDetailsPage = document.getElementById('groupDetailsPage');
                if (groupDetailsPage && groupDetailsPage.style.display === 'flex') {
                    updateGroupDetailsContent();
                }
                
                // 載入歷史聊天記錄
                const historyCount = chatHistoryManager.loadChatHistory(groupId);
                
                // 如果沒有歷史記錄，初始化該群組的歡迎消息
                if (historyCount === 0) {
                    this.initializeGroupWelcome(groupId);
                }
            }
            
            // 初始化群組歡迎消息
            initializeGroupWelcome(groupId) {
                const group = CONFIG.groups[groupId];
                if (!group) return;
                
                // 系統歡迎消息
                addMessage({
                    type: 'system',
                    content: `歡迎來到${group.name}！${group.description}`
                });
                
                // 群主歡迎消息
                setTimeout(() => {
                    const owners = group.owner.split(',');
                    const firstOwner = owners[0].trim();
                    const ownerChar = characters[firstOwner];
                    
                    if (ownerChar) {
                        const welcomeMsg = this.getWelcomeMessage(groupId, ownerChar);
                        addMessage({
                            type: 'message',
                            character: firstOwner,
                            content: welcomeMsg,
                            contentType: 'text'
                        });
                    }
                }, 1000);
            }
            
            // 獲取群組歡迎消息
            getWelcomeMessage(groupId, ownerChar) {
                const messages = {
                    'poets_group': `歡迎來到詩人群！本宮${ownerChar.name}，與諸位詩友共賞千古詞章。`,
                    'history_group': `歡迎來到史記群！在下${ownerChar.name}，願與諸位探討古今興亡得失。`,
                    'philosophy_group': `歡迎來到聞道群！老夫${ownerChar.name}，與諸位共參天道人理。`,
                    'mystery_group': `歡迎來到怪力亂神群！在下${ownerChar.name}，與諸位分享奇聞異事。`,
                    'ci_poets_group': `歡迎來到詞人群！在下${ownerChar.name}，與諸位詞友共研詞韻，論斷千古詞章。願我詞壇同道，一同探討詞牌格律，品味詞中情致。`
                };
                
                return messages[groupId] || `歡迎加入${CONFIG.groups[groupId].name}！`;
            }
            
            // 生成聊天列表
            generateChatList() {
                const container = document.getElementById('chatListContainer');
                container.innerHTML = '';
                
                console.log('生成聊天列表...');
                
                // 獲取所有聊天（群聊 + 私聊）
                const chatList = this.getChatList();
                
                // 按最後消息時間排序
                chatList.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
                
                // 生成聊天項目
                chatList.forEach(chat => {
                    const chatItem = this.createChatItem(chat);
                    container.appendChild(chatItem);
                });
                
                console.log('聊天列表生成完成，共', chatList.length, '個對話');
            }
            
            // 獲取聊天列表數據
            getChatList() {
                const chatList = [];
                
                // 添加群聊
                Object.values(CONFIG.groups).forEach(group => {
                    if (!group.isPrivateChat) { // 排除私聊
                        chatList.push({
                            id: group.id,
                            type: 'group',
                            name: group.name,
                            avatar: this.getGroupAvatar(group),
                            lastMessage: this.getLastMessage(group.id),
                            lastMessageTime: this.getLastMessageTime(group.id),
                            unreadCount: Math.floor(Math.random() * 3), // 模擬未讀數
                            theme: group.theme || ''
                        });
                    }
                });
                
                // 添加私聊（從本地存儲或配置中獲取）
                const privateChats = this.getPrivateChats();
                privateChats.forEach(chat => {
                    chatList.push(chat);
                });
                
                return chatList;
            }
            
            // 創建聊天項目
            createChatItem(chat) {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.setAttribute('data-chat-id', chat.id);
                item.setAttribute('data-chat-type', chat.type);
                
                item.innerHTML = `
                    <div class="chat-avatar">
                        ${chat.avatar}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}${chat.type === 'group' ? `（${CONFIG.groups[chat.id].members.length}人）` : ''}</div>
                        <div class="chat-preview">${chat.lastMessage}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${this.formatTime(chat.lastMessageTime)}</div>
                        ${chat.unreadCount > 0 ? `<div class="chat-unread show">${chat.unreadCount}</div>` : ''}
                    </div>
                `;
                
                // 添加點擊事件
                item.addEventListener('click', () => {
                    this.openChat(chat);
                });
                
                return item;
            }
            
            // 獲取群組頭像
            getGroupAvatar(group) {
                // 直接使用固定的群組圖標
                const icons = {
                    'poets_group': '📝',
                    'history_group': '📚', 
                    'philosophy_group': '🎭',
                    'mystery_group': '🌙',
                    'ci_poets_group': '🎵'
                };
                return icons[group.id] || '👥';
            }
            

            
            // 獲取最後一條消息
            getLastMessage(chatId) {
                // 優先從歷史記錄中獲取
                const lastMsg = chatHistoryManager.getLastMessage(chatId);
                if (lastMsg) {
                    return lastMsg.content;
                }
                
                // 回退到預設消息
                const specificMessages = {
                    'poets_group': '李白: 君不見黃河之水天上來，奔流到海不復回',
                    'history_group': '司馬遷: 史記第一百三十卷已完成撰寫',
                    'philosophy_group': '孔子: 學而時習之，不亦說乎？',
                    'mystery_group': '嫦娥: 廣寒宮中又是一年秋',
                    'ci_poets_group': '柳永: 今宵酒醒何處？楊柳岸，曉風殘月',
                    'private_li_bai': '詩仙剛才分享了一首新作',
                    'private_chang_e': '月宮中的生活確實有些寂寞'
                };
                
                if (specificMessages[chatId]) {
                    return specificMessages[chatId];
                }
                
                // 如果是私聊但沒有預設消息
                if (chatId.startsWith('private_')) {
                    const privateMessages = [
                        '你好，很高興認識你',
                        '剛才的對話很有意思',
                        '今天過得怎麼樣？',
                        '[表情]',
                        '有空再聊'
                    ];
                    return privateMessages[Math.floor(Math.random() * privateMessages.length)];
                }
                
                // 一般群聊消息
                const generalMessages = [
                    '歡迎加入我們的文學討論',
                    '今日詩詞分享：春花秋月何時了',
                    '大家對這個話題怎麼看？',
                    '剛才的討論很精彩',
                    '這個觀點很有意思',
                    '[圖片]',
                    '[語音]'
                ];
                return generalMessages[Math.floor(Math.random() * generalMessages.length)];
            }
            
            // 獲取最後消息時間
            getLastMessageTime(chatId) {
                // 優先從歷史記錄中獲取
                const lastMsg = chatHistoryManager.getLastMessage(chatId);
                if (lastMsg && lastMsg.timestamp) {
                    return new Date(lastMsg.timestamp);
                }
                
                // 回退到隨機時間
                const now = new Date();
                const randomMinutes = Math.floor(Math.random() * 1440); // 24小時內
                return new Date(now - randomMinutes * 60 * 1000);
            }
            
            // 獲取私聊列表
            getPrivateChats() {
                const privateChats = [];
                
                // 檢查已有的私聊（從配置中）
                Object.values(CONFIG.groups).forEach(group => {
                    if (group.isPrivateChat) {
                        const characterId = group.id.replace('private_', '');
                        const character = characters[characterId];
                        if (character) {
                            privateChats.push({
                                id: group.id,
                                type: 'private',
                                name: character.name,
                                avatar: character.avatar,
                                lastMessage: this.getLastMessage(group.id),
                                lastMessageTime: this.getLastMessageTime(group.id),
                                unreadCount: Math.floor(Math.random() * 2),
                                characterId: characterId
                            });
                        }
                    }
                });
                
                return privateChats;
            }
            
            // 格式化時間顯示
            formatTime(time) {
                const now = new Date();
                const diff = now - time;
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (minutes < 1) return '剛剛';
                if (minutes < 60) return `${minutes}分鐘前`;
                if (hours < 24) return `${hours}小時前`;
                if (days < 7) return `${days}天前`;
                
                // 格式化為時間
                const hour = time.getHours();
                const minute = time.getMinutes().toString().padStart(2, '0');
                return `${hour}:${minute}`;
            }
            
            // 打開聊天
            openChat(chat) {
                console.log('打開聊天:', chat);
                
                if (chat.type === 'group') {
                    // 打開群聊
                    this.enterChat(chat.id);
                } else if (chat.type === 'private') {
                    // 打開私聊
                    groupManager.currentGroup = chat.id;
                    this.enterPrivateChat(chat.characterId);
                }
            }
            
            // 進入私聊
            enterPrivateChat(characterId) {
                const character = characters[characterId];
                if (!character) return;
                
                // 切換到聊天界面
                pageHistory.pushPage('chatContainer');
                pageHistory.showPage('chatContainer');
                
                // 設置聊天標題
                const groupTitle = document.querySelector('.wx-header-title');
                if (groupTitle) {
                    groupTitle.textContent = character.name;
                }
                
                // 載入私聊歷史記錄
                const privateChatId = `private_${characterId}`;
                const historyCount = chatHistoryManager.loadChatHistory(privateChatId);
                
                // 如果沒有歷史記錄，添加私聊歡迎消息
                if (historyCount === 0) {
                    setTimeout(() => {
                        addMessage({
                            type: 'message',
                            character: characterId,
                            content: getPrivateChatWelcome(characterId),
                            contentType: 'text'
                        });
                    }, 500);
                }
                
                console.log('進入私聊:', character.name, `(歷史記錄: ${historyCount} 條)`);
            }
            
            // 設置主界面事件
            setupMainEvents() {
                // 底部導航切換
                const navItems = document.querySelectorAll('.nav-item');
                
                navItems.forEach((item, index) => {
                    const targetTab = item.getAttribute('data-tab');
                    
                    item.addEventListener('click', () => {
                        this.switchTab(targetTab);
                    });
                });
                
                // 返回主界面按鈕
                const backToMainBtn = document.getElementById('backToMainBtn');
                if (backToMainBtn) {
                    backToMainBtn.addEventListener('click', () => {
                        this.backToMain();
                    });
                }
            }
            
            // 切換標籤頁
            switchTab(targetTab) {
                // 設置當前標籤頁
                this.currentTab = targetTab;
                
                // 隱藏所有標籤頁
                const tabs = ['chatListTab', 'contactsTab', 'discoverTab', 'profileTab'];
                tabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) tab.style.display = 'none';
                });
                
                // 顯示目標標籤頁
                const target = document.getElementById(targetTab);
                if (target) target.style.display = 'block';
                
                // 更新導航項目狀態
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-tab') === targetTab) {
                        item.classList.add('active');
                    }
                });
                
                // 更新header标题和显示状态
                this.updateMainHeader(targetTab);
            }
            
            // 更新主界面header
            updateMainHeader(targetTab) {
                const mainHeader = document.querySelector('.main-header');
                const mainTitle = document.querySelector('.main-title');
                
                if (targetTab === 'profileTab') {
                    // "我"页面保持header高度，但隐藏文字
                    mainHeader.style.display = 'flex';
                    mainTitle.innerHTML = '';
                } else {
                    // 其他页面显示header
                    mainHeader.style.display = 'flex';
                    
                    // 根据不同tab更新标题
                    switch(targetTab) {
                        case 'chatListTab':
                            const totalContacts = this.getTotalContactsCount();
                            mainTitle.innerHTML = `TheyChat <span class="main-title-count">(${totalContacts})</span>`;
                        break;
                        case 'contactsTab':
                            const totalContacts2 = this.getTotalContactsCount();
                            mainTitle.innerHTML = `通訊錄（${totalContacts2}人）`;
                        break;
                        case 'discoverTab':
                            mainTitle.innerHTML = '發現';
                        break;
                    }
                }
            }
            

            
            // 更新徽章
            updateBadges() {
                // 更新聊天徽章
                const chatBadge = document.getElementById('chatBadge');
                if (chatBadge) {
                    const unreadCount = this.getUnreadCount();
                    if (unreadCount > 0) {
                        chatBadge.textContent = unreadCount;
                        chatBadge.classList.add('show');
                    } else {
                        chatBadge.classList.remove('show');
                    }
                }
            }
            
            // 獲取未讀消息數
            getUnreadCount() {
                // 模擬未讀數量
                return 41;
            }
            
            // 獲取通訊錄總角色數
            getTotalContactsCount() {
                const addedIds = new Set(); // 防止重複添加
                let totalCount = 0;
                
                Object.values(CONFIG.groups).forEach(group => {
                    group.members.forEach(id => {
                        const char = characters[id];
                        if (char && id !== 'user' && id !== 'system' && !addedIds.has(id)) {
                            totalCount++;
                            addedIds.add(id);
                        }
                    });
                });
                
                return totalCount;
            }
            
            // 刷新聊天列表（用於發送消息後更新）
            refreshChatList() {
                this.generateChatList();
            }

            // 刷新通訊錄（用於角色更新後重新生成）
            refreshContacts() {
                this.generateContacts();
            }

            // 生成通訊錄
            generateContacts() {
                const container = document.getElementById('contactsContainer');
                container.innerHTML = '';
                
                // 收集所有角色
                const allCharacters = [];
                const addedIds = new Set(); // 防止重複添加
                Object.values(CONFIG.groups).forEach(group => {
                    group.members.forEach(id => {
                        const char = characters[id];
                        if (char && id !== 'user' && id !== 'system' && !addedIds.has(id)) {
                            allCharacters.push(char);
                            addedIds.add(id);
                        }
                    });
                });
                
                console.log('通訊錄生成 - 總角色數:', allCharacters.length);
                console.log('通訊錄角色列表:', allCharacters.map(char => `${char.name} (${char.dynasty})`));
                
                // 更新通訊錄標題 - 移除currentTab檢查，讓updateMainHeader處理
                // const mainTitle = document.querySelector('.main-title');
                // if (mainTitle && this.currentTab === 'contactsTab') {
                //     mainTitle.innerHTML = `通訊錄（${allCharacters.length}人）`;
                // }
                
                // 按朝代分組
                const charactersByDynasty = {};
                allCharacters.forEach(char => {
                    const dynasty = char.dynasty || '未分類';
                    if (!charactersByDynasty[dynasty]) {
                        charactersByDynasty[dynasty] = [];
                    }
                    charactersByDynasty[dynasty].push(char);
                });
                
                // 定義朝代排序順序
                const dynastyOrder = [
                    '神話傳說',
                    '商朝',
                    '西周',
                    '春秋',
                    '戰國',
                    '秦漢',
                    '西漢',
                    '三國兩晉南北朝',
                    '唐代',
                    '宋代',
                    '清代',
                    '現代',
                    '未分類'
                ];
                
                // 按朝代順序生成通訊錄
                dynastyOrder.forEach(dynasty => {
                    if (charactersByDynasty[dynasty] && charactersByDynasty[dynasty].length > 0) {
                        // 朝代分組標題
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'contact-group-header';
                        groupHeader.textContent = dynasty;
                    container.appendChild(groupHeader);
                    
                        // 該朝代下的角色列表
                        charactersByDynasty[dynasty].forEach(char => {
                        const contactItem = this.createContactItem(char);
                        container.appendChild(contactItem);
                    });
                    }
                });
            }
            

            
            // 創建聯繫人項目
            createContactItem(character) {
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.setAttribute('data-character-id', character.name);
                
                item.innerHTML = `
                    <div class="contact-avatar">
                        ${character.avatar}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${character.name}</div>
                        <div class="contact-desc">${character.description}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.viewCharacterProfile(character);
                });
                
                return item;
            }
            
            // 查看角色資料
            viewCharacterProfile(character) {
                // 通過角色名稱查找對應的ID
                const characterId = this.findCharacterIdByName(character.name);
                if (characterId) {
                    // 打開角色資料頁面
                    openProfilePage(characterId);
                } else {
                    console.error('找不到角色ID:', character.name);
                }
            }
            
            // 通過角色名稱查找對應的ID
            findCharacterIdByName(name) {
                for (const [id, char] of Object.entries(characters)) {
                    if (char.name === name) {
                        return id;
                    }
                }
                return null;
            }
            
            // 生成發現頁面
            generateDiscover() {
                const container = document.getElementById('discoverContainer');
                container.innerHTML = '';
                
                // 創建朋友圈入口
                const momentsEntry = document.createElement('div');
                momentsEntry.className = 'discover-item';
                momentsEntry.innerHTML = `
                    <div class="discover-icon">📷</div>
                    <div class="discover-label">朋友圈</div>
                `;
                momentsEntry.addEventListener('click', () => {
                    this.viewMoments();
                });
                container.appendChild(momentsEntry);
                
                // 添加分隔線
                const separator = document.createElement('div');
                separator.style.height = '8px';
                separator.style.backgroundColor = '#f0f0f0';
                container.appendChild(separator);
                
                // 創建其他發現選項
                const otherItems = [
                    { icon: '📚', label: '詩詞鑑賞' },
                    { icon: '🎭', label: '戲曲賞析' },
                    { icon: '🏛️', label: '歷史典故' },
                    { icon: '🐲', label: '神話傳說' }
                ];
                
                otherItems.forEach(item => {
                    const discoverItem = document.createElement('div');
                    discoverItem.className = 'discover-item';
                    discoverItem.innerHTML = `
                        <div class="discover-icon">${item.icon}</div>
                        <div class="discover-label">${item.label}</div>
                    `;
                    discoverItem.addEventListener('click', () => {
                        // 暫時顯示提示
                        alert(`${item.label}功能開發中...`);
                    });
                    container.appendChild(discoverItem);
                });
            }
            
            // 創建發現項目  
            createDiscoverItem(character) {
                const item = document.createElement('div');
                item.className = 'discover-item';
                item.setAttribute('data-character-id', character.name);
                
                item.innerHTML = `
                    <div class="discover-icon">
                        ${character.avatar}
                    </div>
                    <div class="discover-label">${character.name}的朋友圈</div>
                `;
                
                item.addEventListener('click', () => {
                    this.viewMoments(character);
                });
                
                return item;
            }
            
            // 查看朋友圈
            viewMoments(character) {
                momentsManager.openMoments();
            }
            

            
            // 更新徽章
            updateBadges() {
                document.getElementById('chatBadge').classList.add('show');
                document.getElementById('discoverBadge').classList.add('show');
            }
            
            // 返回主界面
            backToMain() {
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'flex';
            }
        }
        
        // 全局主界面實例
        const mainInterface = new MainInterface();
        
        // 登入管理器
        class LoginManager {
            constructor() {
                this.correctPassword = 'chineseclassics';
                this.userInfo = {
                    nickname: '',
                    grade: '',
                    loginTime: null
                };
            }
            
            // 初始化登入功能
            init() {
                this.setupLoginEvents();
                this.setupFormValidation();
            }
            
            // 設置登入事件
            setupLoginEvents() {
                const loginBtn = document.getElementById('loginBtn');
                const debugBtn = document.getElementById('debugBtn');
                const nicknameInput = document.getElementById('nickname');
                const passwordInput = document.getElementById('password');
                
                // 登入按鈕點擊
                loginBtn.addEventListener('click', () => {
                    this.handleLogin();
                });
                
                // 調試按鈕點擊（如果存在的話）
                if (debugBtn) {
                    debugBtn.addEventListener('click', () => {
                        this.handleDebugLogin();
                    });
                }
                
                // 回車鍵登入 - 臨時修改：只監聽存在的元素
                const elementsToListen = [nicknameInput, document.getElementById('grade')];
                if (passwordInput) {
                    elementsToListen.push(passwordInput);
                }
                
                elementsToListen.forEach(element => {
                    if (element) {
                        element.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                this.handleLogin();
                            }
                        });
                    }
                });
            }
            
            // 設置表單驗證
            setupFormValidation() {
                // 臨時修改：只監聽存在的輸入框
                const inputs = ['nickname', 'password'];
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => {
                            this.clearError();
                            this.validateInput(input);
                        });
                    }
                });
                
                const gradeSelect = document.getElementById('grade');
                if (gradeSelect) {
                    gradeSelect.addEventListener('change', () => {
                        this.clearError();
                    });
                }
            }
            
            // 驗證輸入
            validateInput(input) {
                if (input.id === 'nickname') {
                    // 昵稱驗證
                    const value = input.value.trim();
                    if (value.length > 12) {
                        input.value = value.substring(0, 12);
                    }
                    
                    // 過濾不合適的字符
                    const filtered = value.replace(/[^\u4e00-\u9fa5\w\s]/g, '');
                    if (filtered !== value) {
                        input.value = filtered;
                    }
                }
            }
            
            // 處理調試登入
            handleDebugLogin() {
                // 確保父容器可見
                const universalContainer = document.getElementById('appUniversalContainer');
                if (!universalContainer.classList.contains('show')) {
                    universalContainer.classList.add('show');
                }
                
                // 直接設置默認用戶信息
                this.userInfo = {
                    nickname: '開發者',
                    grade: '調試模式',
                    loginTime: new Date()
                };
                
                const debugBtn = document.getElementById('debugBtn');
                const originalText = debugBtn.innerHTML;
                
                // 更新按鈕狀態
                debugBtn.innerHTML = '<span class="btn-icon">🚀</span>調試模式啟動中...';
                debugBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                debugBtn.disabled = true;
                
                // 快速進入主界面
                setTimeout(() => {
                    this.enterMainInterface();
                }, 800);
            }
            
            // 處理登入
            handleLogin() {
                const nickname = document.getElementById('nickname').value.trim();
                const grade = document.getElementById('grade').value;
                const password = document.getElementById('password').value;
                
                /* 
                 * === 臨時簡化登入驗證 ===
                 * 原功能：需要密碼驗證
                 * 臨時修改：跳過密碼驗證，僅驗證昵稱和年級
                 * 恢復方法：取消下面的註釋，恢復原始的密碼驗證邏輯
                 */
                
                // 簡化版驗證表單（暫時不檢查密碼）
                if (!this.validateFormSimplified(nickname, grade)) {
                    return;
                }
                
                /* 原始密碼驗證邏輯（已暫時禁用）
                // 驗證表單
                if (!this.validateForm(nickname, grade, password)) {
                    return;
                }
                
                // 驗證密碼
                if (password !== this.correctPassword) {
                    this.showError('密碼錯誤，請檢查輸入');
                    return;
                }
                */
                
                // 保存用戶信息
                this.userInfo = {
                    nickname: nickname,
                    grade: grade,
                    loginTime: new Date()
                };
                
                // 登入成功動畫
                this.showLoginSuccess();
            }
            
            // 驗證表單
            validateForm(nickname, grade, password) {
                if (!nickname) {
                    this.showError('請輸入你的昵稱');
                    return false;
                }
                
                if (nickname.length < 2) {
                    this.showError('昵稱至少需要2個字符');
                    return false;
                }
                
                if (!grade) {
                    this.showError('請選擇你的年級');
                    return false;
                }
                
                if (!password) {
                    this.showError('請輸入遊戲密碼');
                    return false;
                }
                
                return true;
            }
            
            // 簡化版驗證表單（臨時使用，不檢查密碼）
            validateFormSimplified(nickname, grade) {
                if (!nickname) {
                    this.showError('請輸入你的昵稱');
                    return false;
                }
                
                if (nickname.length < 2) {
                    this.showError('昵稱至少需要2個字符');
                    return false;
                }
                
                if (!grade) {
                    this.showError('請選擇你的年級');
                    return false;
                }
                
                return true;
            }
            
            // 顯示錯誤信息
            showError(message) {
                const errorDiv = document.getElementById('loginError');
                const errorText = errorDiv.querySelector('.error-text');
                errorText.textContent = message;
                errorDiv.style.display = 'flex';
                
                // 錯誤提示動畫
                errorDiv.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    errorDiv.style.animation = '';
                }, 500);
            }
            
            // 清除錯誤信息
            clearError() {
                document.getElementById('loginError').style.display = 'none';
            }
            
            // 顯示登入成功
            showLoginSuccess() {
                const loginBtn = document.getElementById('loginBtn');
                const originalText = loginBtn.innerHTML;
                
                // 更新按鈕狀態
                loginBtn.innerHTML = '<span class="btn-icon">✅</span>歡迎，' + this.userInfo.nickname + '！';
                loginBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                loginBtn.disabled = true;
                
                // 延遲進入主界面
                setTimeout(() => {
                    this.enterMainInterface();
                }, 1500);
            }
            
            // 進入主界面
            enterMainInterface() {
                // 隱藏登入頁面
                const loginContainer = document.getElementById('loginContainer');
                loginContainer.style.animation = 'fadeOut 0.5s ease-out forwards';
                
                setTimeout(() => {
                    loginContainer.style.display = 'none';
                    
                    // 顯示主界面
                    const mainContainer = document.getElementById('mainContainer');
                    mainContainer.style.display = 'flex';
                    mainContainer.style.animation = 'fadeIn 0.5s ease-out forwards';
                    
                    // 初始化主界面
                    mainInterface.init();
                    
                    // 初始化頁面歷史管理器
                    pageHistory.currentPage = 'mainContainer';
                    
                    // 更新用戶信息顯示
                    this.updateUserProfile();
                }, 500);
            }
            
            // 更新用戶資料顯示
            updateUserProfile() {
                // 更新個人資料頁面
                const profileName = document.querySelector('.profile-name');
                const profileId = document.querySelector('.profile-id');
                
                if (profileName) {
                    profileName.textContent = this.userInfo.nickname;
                }
                
                if (profileId) {
                    profileId.textContent = `太虛幻聊號: ${this.userInfo.grade} • txhl2024`;
                }
                
                // 添加歡迎消息到聊天記錄
                setTimeout(() => {
                    this.addWelcomeMessage();
                }, 1000);
            }
            
            // 添加歡迎消息
            addWelcomeMessage() {
                const welcomeMessage = {
                    type: 'system',
                    content: `歡迎 ${this.userInfo.nickname} 加入太虛幻聊！ 🎉`
                };
                
                // 如果在聊天界面，添加歡迎消息
                if (typeof addMessage === 'function') {
                    addMessage(welcomeMessage);
                }
            }
            
            // 獲取用戶信息
            getUserInfo() {
                return this.userInfo;
            }
        }
        
        // 添加搖晃動畫CSS
        const shakeCSS = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
        `;
        
        // 添加CSS到head
        const style = document.createElement('style');
        style.textContent = shakeCSS;
        document.head.appendChild(style);
        
        // 全局登入管理器實例
        const loginManager = new LoginManager();
        
        // 性能優化工具函數
        const PerformanceUtils = {
            // 使用requestAnimationFrame優化DOM操作
            scheduleUpdate(callback) {
                requestAnimationFrame(() => {
                    callback();
                });
            },
            
            // 批量DOM更新
            batchUpdate(callback) {
                requestAnimationFrame(() => {
                    callback();
                });
            },
            
            // 緩存DOM查詢結果
            domCache: new Map(),
            
            getCachedElement(selector) {
                if (!this.domCache.has(selector)) {
                    this.domCache.set(selector, document.querySelector(selector));
                }
                return this.domCache.get(selector);
            },
            
            clearCache() {
                this.domCache.clear();
            }
        };
        
        // 朋友圈管理器
        class MomentsManager {
            constructor() {
                this.currentPage = 0;
                this.pageSize = 20;
                this.currentCharacterId = null; // 記錄當前查看的角色ID（用於區分全局朋友圈和角色朋友圈）
                this.initialized = false; // 添加初始化标志
            }
            
            // 初始化朋友圈
            init() {
                this.renderMoments();
                this.setupEvents();
            }
            
            // 獲取所有朋友圈數據
            getAllMomentsData() {
                const momentsDB = getMomentsDB();
                let allMoments = [];
                
                // 合併所有角色的朋友圈數據
                Object.keys(momentsDB).forEach(characterId => {
                    if (momentsDB[characterId] && momentsDB[characterId].length > 0) {
                        allMoments = allMoments.concat(momentsDB[characterId]);
                    }
                });
                
                // 按時間排序（這裡簡化處理，實際可以根據具體時間戳排序）
                return allMoments.slice(0, this.pageSize);
            }
            
            // 渲染朋友圈
            renderMoments() {
                const container = document.getElementById('momentsContent');
                container.innerHTML = '';
                
                const moments = this.getAllMomentsData();
                moments.forEach(moment => {
                    const momentElement = this.createMomentElement(moment);
                    container.appendChild(momentElement);
                });
            }
            
            // 渲染指定角色的朋友圈
            renderCharacterMoments(characterId) {
                const container = document.getElementById('momentsContent');
                container.innerHTML = '';
                
                const moments = getMomentsForCharacter(characterId);
                moments.forEach(moment => {
                    const momentElement = this.createMomentElement(moment);
                    container.appendChild(momentElement);
                });
            }
            
            // 創建朋友圈元素
            createMomentElement(moment) {
                const character = characters[moment.authorId];
                const element = document.createElement('div');
                element.className = 'moment-item';
                element.setAttribute('data-moment-id', moment.id);
                
                // 處理圖片：現有數據使用emoji作為圖片，統一使用四宮格布局
                let imagesHtml = '';
                if (moment.image) {
                    const emojiArray = [...moment.image];
                    const emojiCount = emojiArray.length;
                    
                    // 統一使用四宮格布局
                    let emojisToShow = [];
                    
                    if (emojiCount <= 4) {
                        // 1-4個emoji，正常顯示
                        emojisToShow = emojiArray.map(emoji => 
                            `<div class="moment-emoji-grid-item">${emoji}</div>`
                        );
                        
                        // 如果不足4個，用空白填充
                        while (emojisToShow.length < 4) {
                            emojisToShow.push(`<div class="moment-emoji-grid-item empty"></div>`);
                        }
                    } else {
                        // 超過4個emoji，顯示前3個，第4個位置顯示計數
                        emojisToShow = emojiArray.slice(0, 3).map(emoji => 
                            `<div class="moment-emoji-grid-item">${emoji}</div>`
                        );
                        emojisToShow.push(`
                            <div class="moment-emoji-grid-item more-indicator">
                                ${emojiArray[3]}
                                <div class="emoji-count-overlay">+${emojiCount - 4}</div>
                            </div>
                        `);
                    }
                    
                    imagesHtml = `
                        <div class="moment-images-grid">
                            ${emojisToShow.join('')}
                        </div>
                    `;
                }
                
                // 處理點讚列表
                let likesHtml = '';
                if (moment.likes && moment.likes.length > 0) {
                    const likeNamesHtml = moment.likes.map(userId => {
                        const userName = characters[userId]?.name || userId;
                        return `<span class="like-user-name" onclick="openProfilePage('${userId}')" style="cursor: pointer; color: #576b95;">${userName}</span>`;
                    }).join('、');
                    likesHtml = `
                        <div class="moment-likes">
                            <span class="moment-like-icon">👍</span>
                            <span class="moment-like-list">${likeNamesHtml}</span>
                        </div>
                    `;
                }
                
                // 處理評論列表
                let commentsHtml = '';
                if (moment.comments && moment.comments.length > 0) {
                    commentsHtml = `
                        <div class="moment-comments">
                            ${moment.comments.map(comment => {
                                const commentAuthor = characters[comment.authorId]?.name || comment.authorId;
                                return `
                                    <div class="moment-comment">
                                        <span class="comment-author" onclick="openProfilePage('${comment.authorId}')" style="cursor: pointer; color: #576b95;">${commentAuthor}</span>：
                                        <span class="comment-text">${comment.text}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                // 處理地點信息
                let locationHtml = '';
                if (moment.location) {
                    locationHtml = `<div class="moment-location">📍 ${moment.location}</div>`;
                }
                
                element.innerHTML = `
                    <div class="moment-header">
                        <div class="moment-avatar" onclick="openProfilePage('${moment.authorId}')" style="cursor: pointer;">${character.avatar}</div>
                        <div class="moment-info">
                            <div class="moment-name" onclick="openProfilePage('${moment.authorId}')" style="cursor: pointer; color: #576b95;">${character.name}</div>
                        </div>
                    </div>
                    <div class="moment-content-text">${moment.text}</div>
                    ${imagesHtml}
                    ${locationHtml}
                    <div class="moment-footer">
                        <div class="moment-time">${moment.time}</div>
                        <div class="moment-actions">
                            <span class="moment-action" data-action="like">讚</span>
                            <span class="moment-action" data-action="comment">評論</span>
                        </div>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                `;
                
                return element;
            }
            
            // 設置事件監聽
            setupEvents() {
                // 返回按鈕事件已由全局事件監聽器處理，這裡不再重複綁定
                // 避免重複點擊問題
                
                // 朋友圈互動事件
                
                // 朋友圈互動事件
                const momentsContent = document.getElementById('momentsContent');
                if (momentsContent) {
                    momentsContent.addEventListener('click', (e) => {
                        if (e.target.classList.contains('moment-action')) {
                            const action = e.target.getAttribute('data-action');
                            const momentId = e.target.closest('.moment-item').getAttribute('data-moment-id');
                            this.handleMomentAction(action, momentId);
                        }
                    });
                }
            }
            
            // 處理朋友圈互動
            handleMomentAction(action, momentId) {
                const moments = this.getAllMomentsData();
                const moment = moments.find(m => m.id == momentId);
                if (!moment) return;
                
                if (action === 'like') {
                    // 切換點讚狀態
                    const userIndex = moment.likes.indexOf('user');
                    if (userIndex > -1) {
                        moment.likes.splice(userIndex, 1);
                    } else {
                        moment.likes.push('user');
                    }
                    this.renderMoments(); // 重新渲染
                } else if (action === 'comment') {
                    // 彈出評論輸入框（簡化處理）
                    const userInfo = loginManager.getUserInfo();
                    const nickname = userInfo.nickname || '學者';
                    const comment = prompt('輸入你的評論：');
                    if (comment && comment.trim()) {
                        moment.comments.push({
                            authorId: 'user',
                            text: `${nickname}: ${comment.trim()}`
                        });
                        this.renderMoments(); // 重新渲染
                    }
                }
            }
            
            // 打開朋友圈
            openMoments() {
                // 推入頁面歷史並顯示朋友圈
                pageHistory.pushPage('momentsContainer');
                pageHistory.showPage('momentsContainer');
                this.renderMoments();
                
                // 重新設置事件監聽器
                setTimeout(() => {
                    this.setupEvents();
                }, 100);
            }
            
            // 打開指定角色的朋友圈
            openCharacterMoments(characterId) {
                console.log('openCharacterMoments被调用, 角色ID:', characterId);
                console.log('打開朋友圈前的頁面歷史:', pageHistory.history);
                console.log('打開朋友圈前的當前頁面:', pageHistory.currentPage);
                
                this.currentCharacterId = characterId;
                
                // 推入頁面歷史並顯示朋友圈
                pageHistory.pushPage('momentsContainer');
                pageHistory.showPage('momentsContainer');
                
                console.log('打開朋友圈後的頁面歷史:', pageHistory.history);
                console.log('打開朋友圈後的當前頁面:', pageHistory.currentPage);
                
                console.log('准备渲染角色朋友圈数据');
                this.renderCharacterMoments(characterId);
                
                // 重新設置事件監聽器
                setTimeout(() => {
                    this.setupEvents();
                }, 100);
            }
            
            // 關閉朋友圈
            closeMoments() {
                console.log('closeMoments被调用');
                console.log('當前頁面歷史:', pageHistory.history);
                console.log('當前頁面:', pageHistory.currentPage);
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
                
                // 清理状态
                this.currentCharacterId = null;
            }
        }
        
        // 全局朋友圈管理器實例
        const momentsManager = new MomentsManager();
        
        // 防抖變量，防止重複點擊
        let isClosingMoments = false;
        
        // 全局事件監聽器 - 確保朋友圈後退按鈕正常工作
        document.addEventListener('click', (e) => {
            if (e.target.id === 'momentsBackBtn' || e.target.closest('#momentsBackBtn')) {
                console.log('全局事件監聽器：朋友圈返回按鈕被點擊');
                
                // 防止重複點擊
                if (isClosingMoments) {
                    console.log('正在關閉朋友圈，跳過重複點擊');
                    return;
                }
                
                e.stopPropagation();
                e.preventDefault();
                
                isClosingMoments = true;
                momentsManager.closeMoments();
                
                // 500ms後重置防抖狀態
                setTimeout(() => {
                    isClosingMoments = false;
                }, 500);
            }
        });
        
        // 游戲數據 - 角色定義
        const characters = {
            system: { 
                name: "系統", 
                avatar: "ℹ️",
                dynasty: "現代"
            },
            user: {
                name: "我",
                nickname: "現代學者",
                avatar: "👤", 
                description: "現代的文學愛好者",
                inGroup: true,
                dynasty: "現代"
            },

            // 神話傳說
            yutu: { 
                name: "玉兔", 
                nickname: "搗藥翁", 
                avatar: "🐇", 
                description: "月宮中的玉兔，傳說搗藥不輟。",
                inGroup: true,
                dynasty: "神話傳說"
            },
            change: { 
                name: "嫦娥", 
                nickname: "月宮仙子", 
                avatar: "🙎‍♀️", 
                description: "月中仙子，居廣寒宮。",
                inGroup: true,
                dynasty: "神話傳說"
            },
            xiwangmu: {
                name: "西王母",
                nickname: "瑤池金母",
                avatar: "👑",
                description: "神話中掌管仙界的女神，擁有不死藥。",
                inGroup: true,
                dynasty: "神話傳說"
            },
            
            // 春秋戰國
            confucius: {
                name: "孔子", 
                nickname: "至聖先師",
                avatar: "👨‍🏫",
                description: "春秋時期思想家、教育家，儒家學派創始人。",
                inGroup: true,
                dynasty: "春秋"
            },
            quyuan: {
                name: "屈原",
                nickname: "楚辭之祖",
                avatar: "🌊",
                description: "戰國時期楚國詩人，字靈均，創立楚辭體，代表作《離騷》。",
                inGroup: true,
                dynasty: "戰國"
            },
            laozi: {
                name: "老子",
                nickname: "道德天尊", 
                avatar: "🧙‍♂️",
                description: "春秋時期哲學家，道家學派創始人，著《道德經》。",
                inGroup: true,
                dynasty: "春秋"
            },
            zhuangzi: {
                name: "莊子",
                nickname: "南華真人",
                avatar: "🦋", 
                description: "戰國時期哲學家，道家學派代表人物，著《莊子》。",
                inGroup: true,
                dynasty: "戰國"
            },
            mencius: {
                name: "孟子",
                nickname: "亞聖",
                avatar: "📖",
                description: "戰國時期思想家，儒家學派代表人物，被稱為「亞聖」。",
                inGroup: true,
                dynasty: "戰國"
            },
            huizi: {
                name: "惠子",
                nickname: "名家宗師", 
                avatar: "🤔",
                description: "戰國時期哲學家，名家學派代表人物，莊子的好友。",
                inGroup: true,
                dynasty: "戰國"
            },
            baiqi: {
                name: "白起",
                nickname: "戰神",
                avatar: "⚔️",
                description: "戰國時期秦國名將，被稱為「戰神」，軍事才能卓越。",
                inGroup: true,
                dynasty: "戰國"
            },

            // 三國兩晉南北朝
            caozhi: {
                name: "曹植",
                nickname: "陳王",
                avatar: "🤴",
                description: "三國時期才子，李白在《將進酒》中提到的「陳王」。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            caocao: {
                name: "曹操",
                nickname: "魏武帝",
                avatar: "⚔️",
                description: "三國時期政治家、軍事家、文學家，字孟德，詩風慷慨悲涼。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            caopi: {
                name: "曹丕",
                nickname: "魏文帝",
                avatar: "👑",
                description: "三國時期魏國開國皇帝，字子桓，曹操之子，文學成就很高。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            taoyuanming: { 
                name: "陶淵明", 
                nickname: "採菊東籬", 
                avatar: "🌾", 
                description: "東晉詩人，崇尚自然，歸隱田園。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            liuling: { 
                name: "劉伶", 
                nickname: "酒中仙", 
                avatar: "🍶", 
                description: "魏晉竹林七賢之一，嗜酒如命。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            ganbao: {
                name: "干寶",
                nickname: "搜神記主",
                avatar: "🔮", 
                description: "東晉史學家，著《搜神記》，記錄神仙鬼怪故事。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            
            // 漢代
            simaqian: {
                name: "司馬遷",
                nickname: "太史公",
                avatar: "📚",
                description: "西漢史學家，著《史記》，被譽為「史聖」。",
                inGroup: true,
                dynasty: "西漢"
            },
            hanxin: {
                name: "韓信",
                nickname: "兵仙",
                avatar: "🏹",
                description: "西漢初年軍事家，被劉邦稱為「兵仙」，助漢建國。",
                inGroup: true,
                dynasty: "秦漢"
            },

            // 唐代
            libai: { 
                name: "李白", 
                nickname: "謫仙人", 
                avatar: "🥂", 
                description: "唐代詩人，字太白，號青蓮居士，被譽為「詩仙」。",
                inGroup: true,
                dynasty: "唐代"
            },
            dufu: { 
                name: "杜甫", 
                nickname: "少陵野老", 
                avatar: "📝", 
                description: "唐代詩人，被譽為「詩聖」。",
                inGroup: true,
                dynasty: "唐代"
            },
            wangwei: {
                name: "王維",
                nickname: "詩佛",
                avatar: "🧘",
                description: "唐代詩人，善山水詩，信佛，氣質與李白相異。",
                inGroup: true,
                dynasty: "唐代"
            },
            menghaoran: {
                name: "孟浩然",
                nickname: "孟襄陽",
                avatar: "🏞️",
                description: "唐代山水田園詩人，與王維齊名，李白好友。",
                inGroup: true,
                dynasty: "唐代"
            },
            ligui: { 
                name: "李龜年", 
                nickname: "宮廷樂師", 
                avatar: "🎵", 
                description: "唐代著名樂師，善歌舞。",
                inGroup: true,
                dynasty: "唐代"
            },
            yuzhen: {
                name: "玉真公主",
                nickname: "唐玄宗妹妹",
                avatar: "👸",
                description: "唐玄宗的妹妹，喜歡修道，喜歡結交推薦有才華的文人。",
                inGroup: true,
                dynasty: "唐代"
            },
            yangguifei: {
                name: "楊貴妃",
                nickname: "天生麗質",
                avatar: "💃",
                description: "唐玄宗寵妃，李白曾作《清平調》稱頌其美。",
                inGroup: true,
                dynasty: "唐代"
            },
            lishangyin: {
                name: "李商隱",
                nickname: "玉谿生",
                avatar: "🌙",
                description: "晚唐詩人，字義山，號玉谿生，詩風綺麗，善寫愛情詩。",
                inGroup: true,
                dynasty: "唐代"
            },
            dumu: {
                name: "杜牧",
                nickname: "小杜",
                avatar: "🍁",
                description: "晚唐詩人，字牧之，號樊川居士，與李商隱並稱「小李杜」。",
                inGroup: true,
                dynasty: "唐代"
            },
            lihe: {
                name: "李賀",
                nickname: "詩鬼",
                avatar: "👻",
                description: "中唐詩人，字長吉，詩風奇詭，想像豐富，被稱為「詩鬼」。",
                inGroup: true,
                dynasty: "唐代"
            },
            baiyuyi: {
                name: "白居易",
                nickname: "香山居士",
                avatar: "📖",
                description: "中唐詩人，字樂天，號香山居士，詩風平易近人，倡導新樂府運動。",
                inGroup: true,
                dynasty: "唐代"
            },

            // 宋代
            liuyong: {
                name: "柳永",
                nickname: "三變",
                avatar: "🎵",
                description: "北宋詞人，原名三變，字耆卿，擅寫慢詞長調，開拓詞的表現力。",
                inGroup: true,
                dynasty: "宋代"
            },

            // 清代
            pushengling: {
                name: "蒲松齡",
                nickname: "聊齋先生",
                avatar: "👻",
                description: "清代小說家，著《聊齋志異》，擅寫神怪故事。",
                inGroup: true,
                dynasty: "清代"
            },
            liqingzhao: {
                name: "李清照",
                nickname: "易安居士",
                avatar: "🌸",
                description: "宋代女詞人，號易安居士，婉約詞派代表，被譽為「千古第一才女」。",
                inGroup: true,
                dynasty: "宋代"
            },
            sushi: {
                name: "蘇軾",
                nickname: "東坡居士",
                avatar: "🏔️",
                description: "北宋文學家，字子瞻，號東坡居士，豪放詞派創始人，詩詞書畫皆精。",
                inGroup: true,
                dynasty: "宋代"
            },
            xinqiji: {
                name: "辛棄疾",
                nickname: "稼軒",
                avatar: "⚔️",
                description: "南宋詞人，字幼安，號稼軒，豪放詞派代表，文武雙全。",
                inGroup: true,
                dynasty: "宋代"
            },
            jiangkui: {
                name: "姜夔",
                nickname: "白石道人",
                avatar: "🎶",
                description: "南宋詞人，號白石道人，格律派詞人，音律精妙。",
                inGroup: true,
                dynasty: "宋代"
            },
            liyu: {
                name: "李煜",
                nickname: "李後主",
                avatar: "👑",
                description: "南唐末代君主，詞人，被稱為「千古詞帝」，詞風悲愴動人。",
                inGroup: true,
                dynasty: "五代十國"
            },
            zhoubanyan: {
                name: "周邦彥",
                nickname: "美成",
                avatar: "🎼",
                description: "北宋詞人，字美成，格律嚴謹，被稱為「詞家之冠」。",
                inGroup: true,
                dynasty: "宋代"
            },
            yanjidao: {
                name: "晏幾道",
                nickname: "小山",
                avatar: "🍃",
                description: "北宋詞人，字叔原，號小山，婉約詞派代表，晏殊之子。",
                inGroup: true,
                dynasty: "宋代"
            },
            wuwenying: {
                name: "吳文英",
                nickname: "夢窗",
                avatar: "🌙",
                description: "南宋詞人，字君特，號夢窗，詞風綿密，意象豐富。",
                inGroup: true,
                dynasty: "宋代"
            },
            huangtingjian: {
                name: "黃庭堅",
                nickname: "山谷道人",
                avatar: "🎋",
                description: "北宋詩人、書法家，字魯直，號山谷道人，江西詩派開創者。",
                inGroup: true,
                dynasty: "宋代"
            },
            chenweisong: {
                name: "陳維崧",
                nickname: "其年",
                avatar: "📚",
                description: "清代詞人，字其年，號迦陵，陽羨詞派領袖，風格豪放。",
                inGroup: true,
                dynasty: "清代"
            },
            zhuyizun: {
                name: "朱彜尊",
                nickname: "竹垞",
                avatar: "🎋",
                description: "清代詞人，字錫鬯，號竹垞，浙西詞派創始人，詞學理論家。",
                inGroup: true,
                dynasty: "清代"
            },
            nalanxingde: {
                name: "納蘭性德",
                nickname: "容若",
                avatar: "🏹",
                description: "清代詞人，字容若，滿洲正黃旗人，詞風清麗，情真意切。",
                inGroup: true,
                dynasty: "清代"
            },

            // 紅樓夢角色
            lindaiyu: {
                name: "林黛玉",
                nickname: "瀟湘妃子",
                avatar: "🌸",
                description: "賈母外孫女，賈寶玉表妹，居瀟湘館，才情出眾，性情孤高。",
                inGroup: true,
                dynasty: "清代"
            },
            xuebaochai: {
                name: "薛寶釵",
                nickname: "蘅蕪君",
                avatar: "🌺",
                description: "薛姨媽之女，賈寶玉表姐，居蘅蕪苑，端莊賢淑，才學淵博。",
                inGroup: true,
                dynasty: "清代"
            },
            jiatanchun: {
                name: "賈探春",
                nickname: "蕉下客",
                avatar: "🍃",
                description: "賈政庶女，賈府三小姐，居秋爽齋，精明果敢，曾主導大觀園改革。",
                inGroup: true,
                dynasty: "清代"
            },
            jiayingchun: {
                name: "賈迎春",
                nickname: "菱洲",
                avatar: "🌿",
                description: "賈赦庶女，賈府二小姐，居紫菱洲，性情溫和，後被父親許配給孫紹祖。",
                inGroup: true,
                dynasty: "清代"
            },
            jiaxichun: {
                name: "賈惜春",
                nickname: "藕榭",
                avatar: "🎨",
                description: "寧國府賈珍胞妹，賈府四小姐，居藕香榭，擅繪畫，性情孤冷，最終出家。",
                inGroup: true,
                dynasty: "清代"
            },
            shixiangyun: {
                name: "史湘雲",
                nickname: "枕霞舊友",
                avatar: "☁️",
                description: "賈母侄孫女，常客居賈府，活潑豪爽，詩社成員，與寶釵同住蘅蕪苑。",
                inGroup: true,
                dynasty: "清代"
            },
            liwan: {
                name: "李紈",
                nickname: "稻香老農",
                avatar: "🌾",
                description: "賈珠遺孀，賈蘭之母，居稻香村，守寡後生活簡朴，主導創辦海棠詩社。",
                inGroup: true,
                dynasty: "清代"
            },
            miaoyu: {
                name: "妙玉",
                nickname: "檻外人",
                avatar: "🍵",
                description: "帶發修行的居士，居櫳翠庵，雖為方外之人，但位列金陵十二釵，才情孤高。",
                inGroup: true,
                dynasty: "清代"
            },
            jiabaoyu: {
                name: "賈寶玉",
                nickname: "怡紅公子",
                avatar: "💎",
                description: "賈府嫡孫，居怡紅院，性情叛逆，厭惡功名利祿，崇尚真情，與黛玉相知相惜。",
                inGroup: true,
                dynasty: "清代"
            },

            // 紅樓夢新增家族/僕從角色（簡要定義，語言風格交由 DeepSeek 把握）
            jiamu: {
                name: "賈母",
                nickname: "榮國府太君",
                avatar: "👵",
                description: "《紅樓夢》中的賈府長輩，榮國府太君，尊長慈蔭深厚。",
                inGroup: true,
                dynasty: "清代"
            },
            qinkeqing: {
                name: "秦可卿",
                nickname: "寧府少奶奶",
                avatar: "🕊️",
                description: "《紅樓夢》人物，寧國府賈蓉之妻，容貌溫婉。",
                inGroup: true,
                dynasty: "清代"
            },
            wangxifeng: {
                name: "王熙鳳",
                nickname: "鳳辣子",
                avatar: "🧮",
                description: "《紅樓夢》人物，賈璉之妻，精明強幹，掌中饋理家。",
                inGroup: true,
                dynasty: "清代"
            },
            xuepan: {
                name: "薛蟠",
                nickname: "呆霸王",
                avatar: "💰",
                description: "《紅樓夢》人物，薛家公子，性豪縱恣。",
                inGroup: true,
                dynasty: "清代"
            },
            wangfuren: {
                name: "王夫人",
                nickname: "賈府主母",
                avatar: "👩",
                description: "《紅樓夢》人物，賈政之妻，賈寶玉之母，端方持家。",
                inGroup: true,
                dynasty: "清代"
            },
            xueyima: {
                name: "薛姨媽",
                nickname: "薛家長輩",
                avatar: "👵",
                description: "《紅樓夢》人物，薛寶釵之母，與賈府往來密切。",
                inGroup: true,
                dynasty: "清代"
            },
            xiren: {
                name: "襲人",
                nickname: "婉順",
                avatar: "🌿",
                description: "《紅樓夢》人物，賈寶玉身邊嬤嬤/侍女之一，溫婉持重。",
                inGroup: true,
                dynasty: "清代"
            },
            qingwen: {
                name: "晴雯",
                nickname: "俏麗",
                avatar: "🧵",
                description: "《紅樓夢》人物，賈寶玉身邊侍女，性直爽靈動。",
                inGroup: true,
                dynasty: "清代"
            },
            jiarong: {
                name: "賈蓉",
                nickname: "寧府公子",
                avatar: "🧑",
                description: "《紅樓夢》人物，寧國府賈珍之子，秦可卿之夫。",
                inGroup: true,
                dynasty: "清代"
            },
            jiazhen: {
                name: "賈珍",
                nickname: "寧府長房",
                avatar: "🏯",
                description: "《紅樓夢》人物，寧國府主事，家族長房。",
                inGroup: true,
                dynasty: "清代"
            },
            jiazheng: {
                name: "賈政",
                nickname: "寶玉之父",
                avatar: "📜",
                description: "《紅樓夢》人物，賈府中堅，端方嚴整，重科舉文章。",
                inGroup: true,
                dynasty: "清代"
            },
            jiashe: {
                name: "賈赦",
                nickname: "榮府長房",
                avatar: "🏺",
                description: "《紅樓夢》人物，榮國府長房，性情方嚴。",
                inGroup: true,
                dynasty: "清代"
            },
            yinglian: {
                name: "英蓮",
                nickname: "香菱",
                avatar: "🌼",
                description: "《紅樓夢》人物，本名甄英蓮，後入薛家改名香菱。",
                inGroup: true,
                dynasty: "清代"
            },
            liulaolao: {
                name: "劉姥姥",
                nickname: "村野婆婆",
                avatar: "🧺",
                description: "《紅樓夢》人物，性質直爽機敏，與賈府多有往還。",
                inGroup: true,
                dynasty: "清代"
            },
            jialian: {
                name: "賈璉",
                nickname: "二爺",
                avatar: "🧳",
                description: "《紅樓夢》人物，賈府子弟，王熙鳳之夫，處事圓活。",
                inGroup: true,
                dynasty: "清代"
            },
            yuanyang: {
                name: "鴛鴦",
                nickname: "賈母侍側",
                avatar: "🕊️",
                description: "《紅樓夢》人物，賈母身邊侍女，忠鯁果決。",
                inGroup: true,
                dynasty: "清代"
            },
            zijuan: {
                name: "紫娟",
                nickname: "黛玉侍側",
                avatar: "💜",
                description: "《紅樓夢》人物，林黛玉貼身侍女，穩重機靈。",
                inGroup: true,
                dynasty: "清代"
            },
            yinger: {
                name: "鶯兒",
                nickname: "寶釵侍側",
                avatar: "🐦",
                description: "《紅樓夢》人物，薛寶釵身邊侍女，乖巧穩妥。",
                inGroup: true,
                dynasty: "清代"
            },
            linainai: {
                name: "李奶奶",
                nickname: "老嬤嬤",
                avatar: "🍼",
                description: "《紅樓夢》人物，賈府年長婢僕，閱歷老到。",
                inGroup: true,
                dynasty: "清代"
            },

            // 史記群新增歷史人物
            xiangyu: {
                name: "項羽",
                nickname: "西楚霸王",
                avatar: "⚔️",
                description: "西楚霸王，秦末農民起義領袖，力拔山兮氣蓋世，與劉邦爭奪天下。",
                inGroup: true,
                dynasty: "秦漢"
            },
            liubang: {
                name: "劉邦",
                nickname: "漢高祖",
                avatar: "👑",
                description: "漢高祖，西漢開國皇帝，從亭長起家，最終建立大漢王朝。",
                inGroup: true,
                dynasty: "秦漢"
            },
            qinshihuang: {
                name: "秦始皇",
                nickname: "始皇帝",
                avatar: "🏛️",
                description: "中國歷史上第一個皇帝，統一六國，建立中央集權制度。",
                inGroup: true,
                dynasty: "秦漢"
            },
            jingke: {
                name: "荊軻",
                nickname: "刺客",
                avatar: "🗡️",
                description: "戰國時期著名刺客，為燕太子丹刺殺秦王，風蕭蕭兮易水寒。",
                inGroup: true,
                dynasty: "戰國"
            },
            gaojianli: {
                name: "高漸離",
                nickname: "擊筑者",
                avatar: "🎵",
                description: "荊軻好友，善擊筑，荊軻刺秦時為其擊筑送行。",
                inGroup: true,
                dynasty: "戰國"
            },
            zhangliang: {
                name: "張良",
                nickname: "留侯",
                avatar: "📚",
                description: "漢初三傑之一，劉邦重要謀士，運籌帷幄之中，決勝千里之外。",
                inGroup: true,
                dynasty: "秦漢"
            },
            fanhui: {
                name: "樊噲",
                nickname: "舞陽侯",
                avatar: "🛡️",
                description: "劉邦重要將領，鴻門宴上保護劉邦，勇猛善戰。",
                inGroup: true,
                dynasty: "秦漢"
            },
            fanzeng: {
                name: "范增",
                nickname: "亞父",
                avatar: "🧙‍♂️",
                description: "項羽重要謀士，被尊為亞父，多次勸項羽殺劉邦未果。",
                inGroup: true,
                dynasty: "秦漢"
            },
            yuji: {
                name: "虞姬",
                nickname: "虞美人",
                avatar: "🌸",
                description: "項羽愛姬，垓下之戰中自刎殉情，霸王別姬的悲劇主角。",
                inGroup: true,
                dynasty: "秦漢"
            },
            taizidan: {
                name: "太子丹",
                nickname: "燕太子",
                avatar: "👨‍💼",
                description: "燕國太子，派荊軻刺殺秦王，後被燕王喜所殺。",
                inGroup: true,
                dynasty: "戰國"
            },
            niezheng: {
                name: "聶政",
                nickname: "刺客",
                avatar: "⚔️",
                description: "戰國時期著名刺客，為嚴仲子刺殺韓相俠累。",
                inGroup: true,
                dynasty: "戰國"
            },
            lvhou: {
                name: "呂后",
                nickname: "呂太后",
                avatar: "👸",
                description: "漢高祖劉邦皇后，中國歷史上第一位臨朝稱制的女性。",
                inGroup: true,
                dynasty: "西漢"
            },
            hanwudi: {
                name: "漢武帝",
                nickname: "武帝",
                avatar: "🏹",
                description: "西漢第七位皇帝，開創漢武盛世，北擊匈奴，開拓疆土。",
                inGroup: true,
                dynasty: "西漢"
            },
            daji: {
                name: "妲己",
                nickname: "妖妃",
                avatar: "🦊",
                description: "商紂王寵妃，傳說為九尾狐化身，導致商朝滅亡。",
                inGroup: true,
                dynasty: "商朝"
            },
            zhouwuwang: {
                name: "周武王",
                nickname: "武王",
                avatar: "⚔️",
                description: "周朝開國君主，率軍滅商，建立周朝。",
                inGroup: true,
                dynasty: "西周"
            },
            shangzhouwang: {
                name: "商紂王",
                nickname: "紂王",
                avatar: "👑",
                description: "商朝末代君主，荒淫無道，被周武王推翻。",
                inGroup: true,
                dynasty: "商朝"
            },
            baosi: {
                name: "褒姒",
                nickname: "褒姒",
                avatar: "🌹",
                description: "周幽王寵妃，烽火戲諸侯的主角，導致西周滅亡。",
                inGroup: true,
                dynasty: "西周"
            },
            zhouyouwang: {
                name: "周幽王",
                nickname: "幽王",
                avatar: "👑",
                description: "西周末代君主，寵愛褒姒，烽火戲諸侯，導致西周滅亡。",
                inGroup: true,
                dynasty: "西周"
            },
            zhouwenwang: {
                name: "周文王",
                nickname: "文王",
                avatar: "📖",
                description: "周朝奠基者，被囚羑里而演周易，為武王滅商奠定基礎。",
                inGroup: true,
                dynasty: "西周"
            },
            wuzixu: {
                name: "伍子胥",
                nickname: "伍員",
                avatar: "🗡️",
                description: "春秋時期吳國重臣，為父兄報仇，後被吳王夫差賜死。",
                inGroup: true,
                dynasty: "春秋"
            },
            qihuangong: {
                name: "齊桓公",
                nickname: "桓公",
                avatar: "👑",
                description: "春秋五霸之首，任用管仲，稱霸諸侯。",
                inGroup: true,
                dynasty: "春秋"
            },
            jinwengong: {
                name: "晉文公",
                nickname: "文公",
                avatar: "⚔️",
                description: "春秋五霸之一，重耳流亡十九年後回國稱霸。",
                inGroup: true,
                dynasty: "春秋"
            },
            goujian: {
                name: "勾踐",
                nickname: "越王",
                avatar: "🏹",
                description: "越國君主，臥薪嘗膽，最終滅吳稱霸。",
                inGroup: true,
                dynasty: "春秋"
            },
            fuchai: {
                name: "夫差",
                nickname: "吳王",
                avatar: "👑",
                description: "吳國君主，打敗越國後驕傲自滿，最終被勾踐滅國。",
                inGroup: true,
                dynasty: "春秋"
            },
            chuhuaiwang: {
                name: "楚懷王",
                nickname: "懷王",
                avatar: "👑",
                description: "楚國君主，被秦國欺騙，客死秦國。",
                inGroup: true,
                dynasty: "戰國"
            },
            liling: {
                name: "李陵",
                nickname: "李將軍",
                avatar: "🏹",
                description: "漢朝名將李廣之孫，投降匈奴，司馬遷為其辯護而受宮刑。",
                inGroup: true,
                dynasty: "西漢"
            },
            jiayi: {
                name: "賈誼",
                nickname: "賈生",
                avatar: "📝",
                description: "西漢著名文學家、政論家，著有《過秦論》等。",
                inGroup: true,
                dynasty: "西漢"
            },
            zhangqian: {
                name: "張騫",
                nickname: "博望侯",
                avatar: "🐪",
                description: "西漢外交家，開通絲綢之路，出使西域。",
                inGroup: true,
                dynasty: "西漢"
            },
            suqin: {
                name: "蘇秦",
                nickname: "合縱家",
                avatar: "🤝",
                description: "戰國時期縱橫家，主張合縱抗秦，佩六國相印。",
                inGroup: true,
                dynasty: "戰國"
            },
            zhangyi: {
                name: "張儀",
                nickname: "連橫家",
                avatar: "🔗",
                description: "戰國時期縱橫家，主張連橫事秦，與蘇秦齊名。",
                inGroup: true,
                dynasty: "戰國"
            },
            zhaokuo: {
                name: "趙括",
                nickname: "紙上談兵",
                avatar: "📜",
                description: "趙國名將趙奢之子，長平之戰中紙上談兵，導致趙軍大敗。",
                inGroup: true,
                dynasty: "戰國"
            },
            lianpo: {
                name: "廉頗",
                nickname: "老將",
                avatar: "🛡️",
                description: "趙國名將，與藺相如將相和，後因趙括而敗。",
                inGroup: true,
                dynasty: "戰國"
            },
            lvbuwei: {
                name: "呂不韋",
                nickname: "仲父",
                avatar: "💰",
                description: "秦國丞相，商人出身，輔佐嬴政，著有《呂氏春秋》。",
                inGroup: true,
                dynasty: "秦漢"
            },
            laoai: {
                name: "嫪毐",
                nickname: "假父",
                avatar: "🎭",
                description: "秦國宦官，與太后私通，後發動叛亂被殺。",
                inGroup: true,
                dynasty: "秦漢"
            },
            lisi: {
                name: "李斯",
                nickname: "丞相",
                avatar: "📜",
                description: "秦朝丞相，法家代表人物，輔佐秦始皇統一六國。",
                inGroup: true,
                dynasty: "秦漢"
            },
            zhaogao: {
                name: "趙高",
                nickname: "中車府令",
                avatar: "🐍",
                description: "秦朝宦官，指鹿為馬，導致秦朝滅亡。",
                inGroup: true,
                dynasty: "秦漢"
            },
            gongzifusu: {
                name: "公子扶蘇",
                nickname: "扶蘇",
                avatar: "👨‍💼",
                description: "秦始皇長子，仁義寬厚，被趙高陷害自殺。",
                inGroup: true,
                dynasty: "秦漢"
            },
            weizifu: {
                name: "衛子夫",
                nickname: "衛皇后",
                avatar: "👸",
                description: "漢武帝皇后，衛青之姐，霍去病之姨。",
                inGroup: true,
                dynasty: "西漢"
            },
            chenajiao: {
                name: "陳阿嬌",
                nickname: "陳皇后",
                avatar: "👸",
                description: "漢武帝第一任皇后，金屋藏嬌的主角。",
                inGroup: true,
                dynasty: "西漢"
            },
            huhai: {
                name: "胡亥",
                nickname: "秦二世",
                avatar: "👑",
                description: "秦朝第二位皇帝，昏庸無能，被趙高控制，導致秦朝滅亡。",
                inGroup: true,
                dynasty: "秦漢"
            }
            
        };

        // 消息歷史
        let messageHistory = [];

        // 音效
        // 音效系統已移除






        

        

        



        
        // 添加消息到聊天容器
        function addMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            
            // 保存消息到歷史記錄
            const currentChatId = groupManager ? groupManager.currentGroup : null;
            if (currentChatId && !message.skipSave) {
                chatHistoryManager.saveMessage(currentChatId, message);
            }
            
            // 直接添加所有消息
            addRealMessage(message);
        }

        // 實際添加消息的函數
        function addRealMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            
            // 根據消息類型創建不同的元素
            if (message.type === 'system') {
                messageElement.className = 'wx-system-msg wx-fade-in';
                messageElement.textContent = message.content;
            } else {
                const character = characters[message.character];
                const isSelf = message.character === 'user';
                
                messageElement.className = `wx-msg ${isSelf ? 'wx-msg-self' : 'wx-msg-others'} wx-fade-in`;
                
                // 创建头像包装器
                const avatarWrapper = document.createElement('div');
                avatarWrapper.className = 'wx-avatar-wrapper';
                
                // 添加用户名
                const nameElement = document.createElement('div');
                nameElement.className = 'wx-name';
                nameElement.textContent = isSelf ? '我' : character.name;
                avatarWrapper.appendChild(nameElement);
                
                // 添加头像
                const avatar = document.createElement('div');
                avatar.className = 'wx-avatar';
                avatar.textContent = character.avatar;
                avatarWrapper.appendChild(avatar);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'wx-content-wrapper';
                
                const bubbleElement = document.createElement('div');
                bubbleElement.className = 'wx-msg-bubble';
                
                // 根據消息內容類型處理
                    if (message.isHtml) {
                        bubbleElement.innerHTML = sanitizeHTML(message.content);
                    } else {
                        bubbleElement.textContent = message.content;
                }
                
                contentWrapper.appendChild(bubbleElement);
                messageElement.appendChild(avatarWrapper);
                messageElement.appendChild(contentWrapper);
            }
            
            chatContainer.appendChild(messageElement);
            
            // 記錄消息
            messageHistory.push(message);
            
            // 音效已移除
            
            // 滾動到底部
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        

        
        // AI聊天系統配置（改為使用可配置的 Vercel 代理端點）
        const AI_CONFIG = {
            baseURL: (window.DEEPSEEK_PROXY_URL || localStorage.getItem('DEEPSEEK_PROXY_URL') || 'https://YOUR_VERCEL_PROJECT.vercel.app/api/deepseek'),
            model: 'deepseek-chat'
        };
        const MAX_CONTEXT_LENGTH = 20;

        if (typeof AI_CONFIG.baseURL === 'string' && AI_CONFIG.baseURL.includes('YOUR_VERCEL_PROJECT')) {
            console.warn('請設定 window.DEEPSEEK_PROXY_URL 或 localStorage.DEEPSEEK_PROXY_URL 為你的 Vercel 代理 URL（例如：https://deepseek-proxy-chi.vercel.app/api/deepseek）');
        }

        // 對話歷史管理 - 增強多輪對話能力
        const conversationHistory = new Map();
        
        // 群聊上下文管理 - 記錄群聊中的完整對話流程
        const groupChatContext = {
            messages: [], // 群聊中的所有消息
            maxContextLength: MAX_CONTEXT_LENGTH, // 最大上下文長度
            lastUpdateTime: Date.now()
        };
        
        // 私聊上下文管理
        const privateChatContext = new Map(); // 每個角色的私聊上下文

        // 統一 AI 請求：帶 AbortController，避免競態與重覆請求
        const __aiControllers = new Map();
        async function fetchAI(body, options = {}) {
            const { signalKey = 'default' } = options;
            try {
                if (signalKey) {
                    const prev = __aiControllers.get(signalKey);
                    if (prev) { try { prev.abort(); } catch (e) {} }
                }
                const controller = new AbortController();
                if (signalKey) __aiControllers.set(signalKey, controller);
                const res = await fetch(`${AI_CONFIG.baseURL}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: controller.signal
                });
                if (!res.ok) {
                    const text = await res.text().catch(() => '');
                    throw new Error(`AI 請求失敗: ${res.status} ${text}`);
                }
                const data = await res.json();
                return data;
            } finally {
                if (signalKey) __aiControllers.delete(signalKey);
            }
        }

        // 為群聊模式增強系統提示
        function enhanceGroupChatPrompt(characterKey, basePrompt) {
            const character = characters[characterKey];
            if (!character) return basePrompt;
            
            // 僅使用最近消息中的實際參與者（不列全量角色名單）
            const recentMessages = groupChatContext.messages.slice(-6);
            const recentSpeakerIds = [];
            recentMessages.forEach(msg => {
                if (msg.character && msg.character !== 'user' && msg.character !== characterKey && !recentSpeakerIds.includes(msg.character)) {
                    recentSpeakerIds.push(msg.character);
                }
            });
            const otherCharacterNames = recentSpeakerIds.slice(-3).map(id => (characters[id]?.name || id)).join('、');
            
            // 安全地調用函數，避免未定義錯誤
            let interactionSuggestions = [];
            let recentTopics = [];
            
            try {
                if (typeof getGroupInteractionSuggestions === 'function') {
                    interactionSuggestions = getGroupInteractionSuggestions(characterKey, recentMessages);
                }
                if (typeof analyzeRecentTopics === 'function') {
                    recentTopics = analyzeRecentTopics(recentMessages);
                }
            } catch (error) {
                console.warn('獲取互動建議或主題分析失敗:', error);
            }
            
            let interactionGuidance = '';
            if (interactionSuggestions.length > 0) {
                interactionGuidance = `\n互動建議：${interactionSuggestions.join('；')}`;
            }
            
            // 分析最近的對話主題
            let topicGuidance = '';
            if (recentTopics.length > 0) {
                topicGuidance = `\n當前討論主題：${recentTopics.join('、')}`;
            }
            
            const enhancedPrompt = `${basePrompt}

重要提醒：
1. 你正在參與一個群聊${otherCharacterNames ? `，最近活躍：${otherCharacterNames}` : ''}
2. 請注意聆聽與引用最近發言者，形成自然互動
3. 保持你的角色特色與語氣，回應要簡潔有力${interactionGuidance}${topicGuidance}`;
            
            return enhancedPrompt;
        }
        
        // 分析最近的對話主題
        function analyzeRecentTopics(messages) {
            const topics = [];
            const keywords = {
                '詩詞': ['詩', '詞', '吟', '作詩', '詩句', '詩歌'],
                '酒': ['酒', '飲', '醉', '金樽', '美酒'],
                '自然': ['山水', '田園', '自然', '風景', '月', '花'],
                '人生': ['人生', '命運', '理想', '追求', '志向'],
                '友情': ['朋友', '知己', '情誼', '相知'],
                '月宮': ['月宮', '廣寒', '嫦娥', '玉兔', '月']
            };
            
            messages.forEach(msg => {
                const content = msg.content || '';
                Object.entries(keywords).forEach(([topic, words]) => {
                    if (words.some(word => content.includes(word)) && !topics.includes(topic)) {
                        topics.push(topic);
                    }
                });
            });
            
            return topics;
        }
        
        // 生成上下文感知的AI提示（優化版本 - 簡化上下文，強化身份）
        function generateContextAwarePrompt(characterKey, recentMessages, userMessage) {
            const character = characters[characterKey];
            if (!character) return null;
            
            // 取最近5條其他角色的消息，提供充分的互動上下文
            const otherCharactersMessages = recentMessages
                .filter(msg => msg.character && msg.character !== characterKey && msg.character !== 'user')
                .slice(-5);
            
            let contextInfo = '';
            if (otherCharactersMessages.length > 0) {
                // 簡化：只添加最近發言，不進行複雜分析
                const recentSpeakers = otherCharactersMessages.map(msg => {
                    const speaker = characters[msg.character];
                    return `${speaker ? speaker.name : msg.character}：${msg.content}`;
                }).join('\n');
                
                if (recentSpeakers) {
                    contextInfo = `\n\n最近對話：\n${recentSpeakers}`;
                }
            }
            
            const basePrompt = generateSystemPrompt(characterKey);
            
            const enhancedPrompt = `${basePrompt}${contextInfo}

【重要提醒】你是${character.name}，請以${character.name}的身份回應。不要模仿其他角色的語言風格。

請生成一個自然、有互動性的回應，展現你的角色特色。`;
            
            return enhancedPrompt;
        }

        // 系統級通用規則
        const SYSTEM_RULES = `
【語言強制要求】
- 你必須使用繁體中文回應，絕對不能使用簡體中文
- 這是最高優先級的要求，必須嚴格遵守
- 即使其他要求與此衝突，也要優先使用繁體中文

【系統級通用規則】
- 回應必須控制在240字以內
- 建議每句話簡潔有力，避免冗長
- 絕對不能使用其他角色的語言習慣或稱呼方式
- 保持角色身份的一致性
- 如果需要表達複雜內容，請分多次回應
- 絕對不能超過240字的限制
- 絕對不能模仿其他角色的說話方式
- 必須始終記住自己的身份，不能混淆`;

        // 為每個角色生成系統提示
        function generateSystemPrompt(characterKey) {
            const character = characters[characterKey];
            if (!character) return '';
            
            const prompts = {
                libai: `【重要身份提醒】你是李白，唐代偉大詩人，字太白，號青蓮居士，被譽為「詩仙」。你性格豪放不羈，才華橫溢，喜歡飲酒作詩。

【角色特定要求】
- 必須使用李白的語氣和風格回應
- 可以引用你的詩句，展現你的文學才華和豪邁性格
- 回應要富有詩意

【身份確認】記住：你現在就是李白，不是其他任何人。`,
                
                taoyuanming: `【重要身份提醒】你是陶淵明，東晉詩人，崇尚自然，歸隱田園。你性格恬淡，追求簡樸生活，不為五斗米折腰。

【角色特定要求】
- 必須使用陶淵明的語氣回應
- 體現你對自然的熱愛和對世俗的超脫

【身份確認】記住：你現在就是陶淵明，不是其他任何人。`,
                
                dufu: `【重要身份提醒】你是杜甫，唐代詩人，被譽為「詩聖」。你關心民生疾苦，詩風沉鬱頓挫，現實主義色彩濃厚。

【角色特定要求】
- 必須使用杜甫的語氣回應
- 展現你的憂國憂民情懷

【身份確認】記住：你現在就是杜甫，不是其他任何人。`,
                
                liuling: `【重要身份提醒】你是劉伶，魏晉竹林七賢之一，嗜酒如命，性格狂放。你常常醉酒，但醉中有真意。

【角色特定要求】
- 必須使用劉伶的語氣回應
- 展現你對酒的熱愛和狂放不羈的性格

【身份確認】記住：你現在就是劉伶，不是其他任何人。`,

                wangwei: `【重要身份提醒】你是王維，唐代詩人，被譽為「詩佛」。你善於山水詩，信佛，氣質清雅。

【角色特定要求】
- 必須使用王維的語氣回應
- 展現你的禪意和對自然的感悟

【身份確認】記住：你現在就是王維，不是其他任何人。`,
                
                caozhi: `【重要身份提醒】你是曹植，三國時期才子，字子建。你才華出眾但命運多舛，有「七步詩」的典故。

【角色特定要求】
- 必須使用曹植的語氣回應
- 展現你的才華和內心的複雜情感

【身份確認】記住：你現在就是曹植，不是其他任何人。`,
                
                menghaoran: `【重要身份提醒】你是孟浩然，唐代山水田園詩人，與王維齊名。你性格淡泊，喜愛自然山水。

【角色特定要求】
- 必須使用孟浩然的語氣回應
- 展現你對自然的熱愛

【身份確認】記住：你現在就是孟浩然，不是其他任何人。`,

                change: `【重要身份提醒】你是嫦娥，月宮仙子，居住在廣寒宮。你美麗而孤獨，對人間有著複雜的情感。

【角色特定要求】
- 必須使用嫦娥的語氣回應
- 展現你的仙氣和內心的孤寂

【身份確認】記住：你現在就是嫦娥，不是其他任何人。`,
                
                yutu: `【重要身份提醒】你是玉兔，月宮中的神獸，負責搗藥。你可愛機靈，是嫦娥的伴侶。

【角色特定要求】
- 必須使用玉兔的語氣回應
- 展現你的可愛和忠誠

【身份確認】記住：你現在就是玉兔，不是其他任何人。`,
                
                ligui: `【重要身份提醒】你是李龜年，唐代著名樂師，善於歌舞。你藝術造詣很高，經常在宮廷演出。

【角色特定要求】
- 必須使用李龜年的語氣回應
- 展現你的藝術才華

【身份確認】記住：你現在就是李龜年，不是其他任何人。`,
                
                yuzhen: `【重要身份提醒】你是玉真公主，唐玄宗的妹妹，喜歡修道和結交文人。你身份高貴但平易近人。

【角色特定要求】
- 必須使用玉真公主的語氣回應
- 展現你的高雅和對文學的喜愛

【身份確認】記住：你現在就是玉真公主，不是其他任何人。`,
                
                yangguifei: `【重要身份提醒】你是楊貴妃，唐玄宗的寵妃，天生麗質。你美麗聰慧，李白曾為你作《清平調》。

【角色特定要求】
- 必須使用楊貴妃的語氣回應
- 展現你的美麗和聰慧

【身份確認】記住：你現在就是楊貴妃，不是其他任何人。`,

                lishangyin: `【重要身份提醒】你是李商隱，晚唐詩人，字義山，號玉谿生。你詩風綺麗，善寫愛情詩，意境深遠。

【角色特定要求】
- 必須使用李商隱的語氣回應
- 展現你的詩意和對愛情的深刻感悟
- 可以引用你的詩句，如《錦瑟》、《無題》等

【身份確認】記住：你現在就是李商隱，不是其他任何人。`,

                dumu: `【重要身份提醒】你是杜牧，晚唐詩人，字牧之，號樊川居士。你與李商隱並稱「小李杜」，詩風清麗。

【角色特定要求】
- 必須使用杜牧的語氣回應
- 展現你的才華和對歷史的深刻見解
- 可以引用你的詩句，如《清明》、《江南春》等

【身份確認】記住：你現在就是杜牧，不是其他任何人。`,

                lihe: `【重要身份提醒】你是李賀，中唐詩人，字長吉。你詩風奇詭，想像豐富，被稱為「詩鬼」。

【角色特定要求】
- 必須使用李賀的語氣回應
- 展現你的奇思妙想和獨特的詩歌風格
- 可以引用你的詩句，如《李憑箜篌引》、《雁門太守行》等

【身份確認】記住：你現在就是李賀，不是其他任何人。`,

                baiyuyi: `【重要身份提醒】你是白居易，中唐詩人，字樂天，號香山居士。你詩風平易近人，倡導新樂府運動。

【角色特定要求】
- 必須使用白居易的語氣回應
- 展現你對民生疾苦的關懷和詩歌的教化作用
- 可以引用你的詩句，如《長恨歌》、《琵琶行》等

【身份確認】記住：你現在就是白居易，不是其他任何人。`,

                caocao: `【重要身份提醒】你是曹操，三國時期政治家、軍事家、文學家，字孟德。你詩風慷慨悲涼，有「建安風骨」。

【角色特定要求】
- 必須使用曹操的語氣回應
- 展現你的雄才大略和對人生的深刻感悟
- 可以引用你的詩句，如《短歌行》、《龜雖壽》等

【身份確認】記住：你現在就是曹操，不是其他任何人。`,

                caopi: `【重要身份提醒】你是曹丕，三國時期魏國開國皇帝，字子桓。你是曹操之子，文學成就很高。

【角色特定要求】
- 必須使用曹丕的語氣回應
- 展現你的帝王氣質和文學才華
- 可以引用你的詩句，如《燕歌行》等

【身份確認】記住：你現在就是曹丕，不是其他任何人。`,

                quyuan: `【重要身份提醒】你是屈原，戰國時期楚國詩人，字靈均。你創立楚辭體，代表作《離騷》。

【角色特定要求】
- 必須使用屈原的語氣回應
- 展現你的愛國情懷和對理想的執著追求
- 可以引用你的詩句，如《離騷》、《九歌》等

【身份確認】記住：你現在就是屈原，不是其他任何人。`,

                huangtingjian: `【重要身份提醒】你是黃庭堅，北宋詩人、書法家，字魯直，號山谷道人。你是江西詩派開創者。

【角色特定要求】
- 必須使用黃庭堅的語氣回應
- 展現你的詩學理論和獨特的詩歌風格
- 可以引用你的詩句，如《寄黃幾復》等

【身份確認】記住：你現在就是黃庭堅，不是其他任何人。`,

                xiwangmu: `【重要身份提醒】你是西王母，神話中的瑤池金母，掌管仙界。你威嚴而慈祥，擁有不死藥。

【角色特定要求】
- 必須使用西王母的語氣回應
- 展現你的神威和仙家風範

【身份確認】記住：你現在就是西王母，不是其他任何人。`,
                
                // 紅樓夢角色 - 強化身份提醒
                lindaiyu: `【重要身份提醒】你是林黛玉，《紅樓夢》中的女主角，賈母外孫女，賈寶玉表妹。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中林黛玉的語言風格
- 你是林黛玉，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持林黛玉特有的敏感、聰慧、略帶憂鬱的語言風格

【身份確認】記住：你現在就是林黛玉，不是其他任何人。`,
                
                xuebaochai: `【重要身份提醒】你是薛寶釵，《紅樓夢》中的重要女主角，薛姨媽之女，賈寶玉表姐。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中薛寶釵的語言風格
- 你是薛寶釵，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持薛寶釵特有的端莊、賢淑、聰慧的語言風格

【身份確認】記住：你現在就是薛寶釵，不是其他任何人。`,
                
                jiatanchun: `【重要身份提醒】你是賈探春，《紅樓夢》中的賈府三小姐，賈政庶女。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中賈探春的語言風格
- 你是賈探春，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持賈探春特有的精明、能幹、有主見的語言風格

【身份確認】記住：你現在就是賈探春，不是其他任何人。`,
                
                jiayingchun: `【重要身份提醒】你是賈迎春，《紅樓夢》中的賈府二小姐，賈赦庶女。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中賈迎春的語言風格
- 你是賈迎春，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持賈迎春特有的溫和、善良、略顯懦弱的語言風格

【身份確認】記住：你現在就是賈迎春，不是其他任何人。`,
                
                jiaxichun: `【重要身份提醒】你是賈惜春，《紅樓夢》中的賈府四小姐，寧國府賈珍胞妹。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中賈惜春的語言風格
- 你是賈惜春，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持賈惜春特有的清高、淡泊、略帶佛性的語言風格

【身份確認】記住：你現在就是賈惜春，不是其他任何人。`,
                
                shixiangyun: `【重要身份提醒】你是史湘雲，《紅樓夢》中的詩社成員，賈母侄孫女。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中史湘雲的語言風格
- 你是史湘雲，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持史湘雲特有的豪爽、直率、活潑的語言風格

【身份確認】記住：你現在就是史湘雲，不是其他任何人。`,
                
                liwan: `【重要身份提醒】你是李紈，《紅樓夢》中的賈珠遺孀，賈蘭之母。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中李紈的語言風格
- 你是李紈，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持李紈特有的端莊、賢淑、略帶憂鬱的語言風格

【身份確認】記住：你現在就是李紈，不是其他任何人。`,
                
                miaoyu: `【重要身份提醒】你是妙玉，《紅樓夢》中的帶發修行女居士，居櫳翠庵。你現在在微信聊天群「大觀園業主群」中，與其他大觀園居民一起聊天。

【角色特定要求】
- 符合《紅樓夢》原文中妙玉的語言風格
- 你是妙玉，不是賈寶玉，不能使用「二哥哥常說」等賈寶玉的語言習慣
- 保持妙玉特有的清高、孤傲、略帶禪意的語言風格

【身份確認】記住：你現在就是妙玉，不是其他任何人。`,

                // 賈府大家庭新增角色（僅提供身份提醒，具體語言風格交由 DeepSeek 把握）
                jiamu: `【身份提醒】你是賈母，《紅樓夢》人物。請嚴格符合《紅樓夢》中賈母的人物形象與語言風格。`,
                qinkeqing: `【身份提醒】你是秦可卿，《紅樓夢》人物。請嚴格符合《紅樓夢》中秦可卿的人物形象與語言風格。`,
                wangxifeng: `【身份提醒】你是王熙鳳，《紅樓夢》人物。請嚴格符合《紅樓夢》中王熙鳳的人物形象與語言風格。`,
                xuepan: `【身份提醒】你是薛蟠，《紅樓夢》人物。請嚴格符合《紅樓夢》中薛蟠的人物形象與語言風格。`,
                wangfuren: `【身份提醒】你是王夫人，《紅樓夢》人物。請嚴格符合《紅樓夢》中王夫人的人物形象與語言風格。`,
                xueyima: `【身份提醒】你是薛姨媽，《紅樓夢》人物。請嚴格符合《紅樓夢》中薛姨媽的人物形象與語言風格。`,
                xiren: `【身份提醒】你是襲人，《紅樓夢》人物。請嚴格符合《紅樓夢》中襲人的人物形象與語言風格。`,
                qingwen: `【身份提醒】你是晴雯，《紅樓夢》人物。請嚴格符合《紅樓夢》中晴雯的人物形象與語言風格。`,
                jiarong: `【身份提醒】你是賈蓉，《紅樓夢》人物。請嚴格符合《紅樓夢》中賈蓉的人物形象與語言風格。`,
                jiazhen: `【身份提醒】你是賈珍，《紅樓夢》人物。請嚴格符合《紅樓夢》中賈珍的人物形象與語言風格。`,
                jiazheng: `【身份提醒】你是賈政，《紅樓夢》人物。請嚴格符合《紅樓夢》中賈政的人物形象與語言風格。`,
                jiashe: `【身份提醒】你是賈赦，《紅樓夢》人物。請嚴格符合《紅樓夢》中賈赦的人物形象與語言風格。`,
                yinglian: `【身份提醒】你是英蓮（香菱），《紅樓夢》人物。請嚴格符合《紅樓夢》中英蓮/香菱的人物形象與語言風格。`,
                liulaolao: `【身份提醒】你是劉姥姥，《紅樓夢》人物。請嚴格符合《紅樓夢》中劉姥姥的人物形象與語言風格。`,
                jialian: `【身份提醒】你是賈璉，《紅樓夢》人物。請嚴格符合《紅樓夢》中賈璉的人物形象與語言風格。`,
                yuanyang: `【身份提醒】你是鴛鴦，《紅樓夢》人物。請嚴格符合《紅樓夢》中鴛鴦的人物形象與語言風格。`,
                zijuan: `【身份提醒】你是紫娟，《紅樓夢》人物。請嚴格符合《紅樓夢》中紫娟的人物形象與語言風格。`,
                yinger: `【身份提醒】你是鶯兒，《紅樓夢》人物。請嚴格符合《紅樓夢》中鶯兒的人物形象與語言風格。`,
                linainai: `【身份提醒】你是李奶奶，《紅樓夢》人物。請嚴格符合《紅樓夢》中李奶奶的人物形象與語言風格。`
            };
            
            return `${SYSTEM_RULES}

${prompts[characterKey] || `【重要身份提醒】你是${character.name}，${character.description}

【角色特定要求】
- 必須使用符合你身份的語氣回應

【身份確認】記住：你現在就是${character.name}，不是其他任何人。`}`;
        }



        // 調用AI API生成回應 - 增強多輪對話能力
        async function generateAIResponse(characterKey, userMessage, customPrompt = null) {
            try {
                const character = characters[characterKey];
                if (!character) {
                    console.error('角色不存在:', characterKey);
                    return null;
                }
                
                console.log('=== AI回應生成開始 ===');
                console.log('角色:', characterKey, character.name);
                console.log('用戶消息:', userMessage);
                console.log('自定義提示:', customPrompt);
                
                // 測試聊天上下文完整性
                testChatContext();

                // 根據聊天模式獲取不同的上下文
                let contextMessages = [];
                let systemPrompt = customPrompt;
                
                // 安全地生成系統提示
                try {
                    if (!systemPrompt && typeof generateSystemPrompt === 'function') {
                        systemPrompt = generateSystemPrompt(characterKey);
                    } else if (!systemPrompt) {
                        systemPrompt = `你是${character.name}，請用符合你身份的語氣回應。`;
                    }
                } catch (error) {
                    console.warn('生成系統提示失敗:', error);
                    systemPrompt = `你是${character.name}，請用符合你身份的語氣回應。`;
                }
                
                // 安全地檢查聊天模式
                let isPrivateMode = false;
                try {
                    if (typeof isPrivateChatMode === 'function') {
                        isPrivateMode = isPrivateChatMode();
                    }
                } catch (error) {
                    console.warn('檢查聊天模式失敗:', error);
                    isPrivateMode = false;
                }
                
                if (isPrivateMode) {
                    // 私聊模式：使用該角色的私聊歷史
                    try {
                        const privateHistory = privateChatContext.get(characterKey) || [];
                        contextMessages = privateHistory;
                        console.log('私聊模式 - 使用角色私聊歷史，長度:', privateHistory.length);
                    } catch (error) {
                        console.warn('獲取私聊歷史失敗:', error);
                        contextMessages = [];
                    }
                } else {
                    // 群聊模式：使用群聊上下文 + 該角色的個性化歷史
                    try {
                        const groupHistory = groupChatContext.messages.slice(-groupChatContext.maxContextLength);
                        const characterHistory = conversationHistory.get(characterKey) || [];
                        
                        // 合併群聊上下文和角色個性化歷史
                        contextMessages = [...groupHistory, ...characterHistory.slice(-6)];
                        console.log('群聊模式 - 群聊上下文長度:', groupHistory.length, '角色歷史長度:', characterHistory.length);
                        console.log('🔍 群聊上下文內容:', groupHistory.map(msg => ({
                            role: msg.role,
                            character: msg.character,
                            content: msg.content?.substring(0, 30) + '...',
                            timestamp: msg.timestamp
                        })));
                        
                        // 🔍 調試：檢查上下文感知函數是否存在
                        console.log('🔍 檢查上下文感知函數:');
                        console.log('- generateContextAwarePrompt存在:', typeof generateContextAwarePrompt === 'function');
                        console.log('- enhanceGroupChatPrompt存在:', typeof enhanceGroupChatPrompt === 'function');
                        console.log('- analyzeRecentTopics存在:', typeof analyzeRecentTopics === 'function');
                        console.log('- getGroupInteractionSuggestions存在:', typeof getGroupInteractionSuggestions === 'function');
                        
                        // 使用上下文感知的系統提示
                        let usedContextAwarePrompt = false;
                        if (typeof generateContextAwarePrompt === 'function') {
                            console.log('🔍 嘗試生成上下文感知提示...');
                            const contextAwarePrompt = generateContextAwarePrompt(characterKey, groupHistory, userMessage);
                            if (contextAwarePrompt) {
                                systemPrompt = contextAwarePrompt;
                                usedContextAwarePrompt = true; // 二選一：若system已含上下文，則不再傳messages上下文
                                console.log('✅ 成功使用上下文感知提示');
                                console.log('🔍 上下文感知提示內容:', contextAwarePrompt.substring(0, 200) + '...');
                            } else {
                                console.log('⚠️ 上下文感知提示生成失敗，使用備用方案');
                                // 如果上下文感知提示生成失敗，使用增強群聊提示作為備用
                                if (typeof enhanceGroupChatPrompt === 'function') {
                                    systemPrompt = enhanceGroupChatPrompt(characterKey, systemPrompt);
                                    console.log('✅ 使用增強群聊提示作為備用');
                                }
                            }
                        } else {
                            console.log('⚠️ generateContextAwarePrompt函數不存在，使用增強群聊提示');
                        // 為群聊模式增強系統提示
                        if (typeof enhanceGroupChatPrompt === 'function') {
                            systemPrompt = enhanceGroupChatPrompt(characterKey, systemPrompt);
                                console.log('✅ 使用增強群聊提示');
                        }
                        }
                        
                        // 二選一：若使用了上下文感知system，則不再傳遞contextMessages
                        if (usedContextAwarePrompt) {
                            contextMessages = [];
                            console.log('🧹 已移除messages中的上下文（因system已包含上下文摘要）');
                        }

                        // 🔍 調試：檢查最終的系統提示
                        console.log('🔍 最終系統提示長度:', systemPrompt.length);
                        console.log('🔍 最終系統提示預覽:', systemPrompt.substring(0, 300) + '...');
                    } catch (error) {
                        console.warn('獲取群聊上下文失敗:', error);
                        contextMessages = [];
                    }
                }
                
                console.log('系統提示:', systemPrompt);
                console.log('上下文消息數量:', contextMessages.length);
                
                // 🔍 調試：詳細檢查上下文消息
                if (contextMessages.length > 0) {
                    console.log('🔍 上下文消息詳情:');
                    contextMessages.forEach((msg, index) => {
                        console.log(`  消息${index + 1}:`, {
                            role: msg.role,
                            character: msg.character,
                            content: msg.content?.substring(0, 50) + '...',
                            timestamp: msg.timestamp
                        });
                    });
                    
                    // 🔍 調試：格式化上下文顯示
                    console.log('🔍 格式化上下文:');
                    const formattedContext = contextMessages.map(msg => {
                        if (msg.role === 'user') {
                            return `用戶：${msg.content}`;
                        } else if (msg.character && characters[msg.character]) {
                            return `${characters[msg.character].name}：${msg.content}`;
                        } else {
                            return `${msg.character || '未知'}：${msg.content}`;
                        }
                    }).join('\n');
                    console.log(formattedContext);
                } else {
                    console.log('⚠️ 沒有上下文消息');
                }
                
                // 構建完整的消息數組（去重system：只保留一條語言強制 + 一條業務system）
                let messages = [
                    { role: 'system', content: '【語言強制指令】你必須使用繁體中文回應，絕對不能使用簡體中文。這是最高優先級要求。' },
                    { role: 'system', content: systemPrompt }
                ];
                
                messages = [
                    ...messages,
                    ...contextMessages,
                    {
                        role: 'user',
                        content: userMessage
                    }
                ];

                console.log('準備發送API請求...');
                console.log('請求數據:', {
                    model: AI_CONFIG.model,
                    messages: messages,
                    max_tokens: 200,
                    temperature: 0.8
                });

                const data = await fetchAI({
                    model: AI_CONFIG.model,
                    messages: messages,
                    max_tokens: 400,
                    temperature: 0.8
                }, { signalKey: 'general-reply' });
                console.log('API響應數據:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    console.error('API響應格式錯誤:', data);
                    throw new Error('API響應格式錯誤');
                }
                
                const aiResponse = data.choices[0].message.content;
                console.log('提取的AI回應:', aiResponse);
                
                // 後處理：替換英文省略號為中文省略號
                const processedResponse = postProcessAIResponse(aiResponse);

                // 更新對話歷史 - 根據聊天模式分別管理
                try {
                    if (isPrivateMode) {
                        // 私聊模式：更新私聊上下文
                        const privateHistory = privateChatContext.get(characterKey) || [];
                        const newPrivateHistory = [
                            ...privateHistory,
                    { role: 'user', content: userMessage },
                    { role: 'assistant', content: processedResponse }
                ];
                
                        // 限制私聊歷史長度，保留最近8次對話
                        if (newPrivateHistory.length > 16) {
                            newPrivateHistory.splice(0, newPrivateHistory.length - 16);
                        }
                        
                        privateChatContext.set(characterKey, newPrivateHistory);
                        console.log('私聊歷史已更新，長度:', newPrivateHistory.length);
                    } else {
                        // 群聊模式：更新群聊上下文和角色個性化歷史
                        
                        // 更新群聊上下文
                        const groupMessage = {
                            role: 'assistant',
                            content: processedResponse,
                            character: characterKey,
                            characterName: character.name,
                            timestamp: Date.now()
                        };
                        
                        groupChatContext.messages.push(groupMessage);
                        groupChatContext.lastUpdateTime = Date.now();
                        
                        // 限制群聊上下文長度
                        if (groupChatContext.messages.length > groupChatContext.maxContextLength) {
                            groupChatContext.messages.splice(0, groupChatContext.messages.length - groupChatContext.maxContextLength);
                        }
                        
                        // 更新角色個性化歷史
                        const characterHistory = conversationHistory.get(characterKey) || [];
                        const newCharacterHistory = [
                            ...characterHistory,
                            { role: 'user', content: userMessage },
                            { role: 'assistant', content: processedResponse }
                        ];
                        
                        // 限制角色歷史長度，保留最近6次對話
                        if (newCharacterHistory.length > 12) {
                            newCharacterHistory.splice(0, newCharacterHistory.length - 12);
                        }
                        
                        conversationHistory.set(characterKey, newCharacterHistory);
                        console.log('群聊上下文已更新，總長度:', groupChatContext.messages.length, '角色歷史長度:', newCharacterHistory.length);
                    }
                } catch (error) {
                    console.warn('更新對話歷史失敗:', error);
                }

                return processedResponse;
            } catch (error) {
                console.error('AI回應生成失敗:', error);
                throw new Error('網絡連接異常，請檢查網絡後重試');
            }
        }

        // 智能分段：将长消息分成多条完整的聊天消息
        function splitMessageIntoSegments(text, maxLength = 60) {
            if (text.length <= maxLength) {
                return [text];
            }
            
            // 1. 按標點分句
            const sentenceRegex = /[^。！？；.!?;]+[。！？；.!?;]/g;
            const sentences = [];
            let match;
            let lastIndex = 0;
            while ((match = sentenceRegex.exec(text)) !== null) {
                sentences.push(match[0]);
                lastIndex = sentenceRegex.lastIndex;
            }
            // 補充最後一段（如果沒有標點結尾）
            if (lastIndex < text.length) {
                sentences.push(text.slice(lastIndex));
            }

            // 2. 簡單合併：目標4段左右，每段約60字
            const segments = [];
            let current = '';
            const targetLength = Math.ceil(text.length / 4); // 目標每段長度
            
            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i];
                
                // 如果當前段落加上新句子超過目標長度，且當前段落不為空，就開始新段落
                if (current.length + sentence.length > targetLength && current.length > 0) {
                    segments.push(current);
                    current = sentence;
                } else {
                    current += sentence;
                }
            }
            
            // 添加最後一段
            if (current.trim()) {
                segments.push(current);
            }
            
            // 3. 如果段落太多，合併最後幾段
            if (segments.length > 4) {
                const lastSegment = segments.slice(3).join('');
                segments.splice(3, segments.length - 3, lastSegment);
            }
            
            return segments.filter(seg => seg.trim());
        }

        // 分段发送消息
        function sendMessageSegments(characterKey, segments) {
            segments.forEach((segment, index) => {
                setTimeout(() => {
                    // 如果不是第一段，先移除该角色的打字动画（第一段已在主函数中移除）
                    if (index > 0) {
                        removeTypingAnimation(characterKey);
                    }
                    
                    // 直接添加消息段（绕过addMessage的打字动画逻辑）
                    addMessage({
                        type: 'message',
                        character: characterKey,
                        content: segment,
                        contentType: 'text'
                    });
                    
                    // 如果不是最后一段，显示继续输入的动画
                    if (index < segments.length - 1) {
                        setTimeout(() => {
                            showTypingAnimation(characterKey);
                        }, 300);
                    }
                }, index * 1500); // 每段间隔1.5秒
            });
        }

        // 获取角色的性格化延迟倍数
        function getCharacterDelayMultiplier(characterKey) {
            const delayMultipliers = {
                libai: 0.8,        // 李白性格豪爽，回复较快
                dufu: 1.2,         // 杜甫深思熟虑，回复较慢
                taoyuanming: 1.4,  // 陶渊明悠然自得，不急不躁
                wangwei: 1.1,      // 王维禅意深远，略慢
                caozhi: 0.9,       // 曹植才思敏捷
                menghaoran: 1.3,   // 孟浩然田园闲适
                liuling: 0.7,      // 刘伶醉酒豪爽，最快
                change: 1.0,       // 嫦娥标准速度
                yutu: 0.6,         // 玉兔活泼，最快
                ligui: 0.9,        // 李龟年艺术家敏感
                yuzhen: 1.1,       // 玉真公主贵族风范
                yangguifei: 1.0,   // 杨贵妃标准
                xiwangmu: 1.5      // 西王母神仙威严，最慢
            };
            return delayMultipliers[characterKey] || 1.0;
        }

        // 计算自然的分段间隔时间 - 优化阅读体验
        function getNaturalSegmentInterval(characterKey, segmentIndex, totalSegments) {
            const baseInterval = 2000; // 基础2秒，给玩家充足阅读时间
            const randomFactor = 0.9 + Math.random() * 0.3; // 0.9-1.2倍随机，增加自然感
            
            // 连续消息的间隔策略：
            // 第一段：正常速度
            // 中间段：保持正常速度（不再缩短）
            // 最后一段：稍慢（思考结束）
            let positionMultiplier = 1.0;
            if (segmentIndex === 0) {
                positionMultiplier = 1.0; // 第一段正常
            } else if (segmentIndex < totalSegments - 1) {
                positionMultiplier = 1.0; // 中间段保持正常速度
            } else {
                positionMultiplier = 1.4; // 最后一段稍慢，表示思考结束
            }
            
            return Math.floor(baseInterval * randomFactor * positionMultiplier);
        }

        // 串行分段发送消息（等待完成）- 优化版本
        function sendMessageSegmentsSequentially(characterKey, segments) {
            return new Promise(async (resolve) => {
                for (let index = 0; index < segments.length; index++) {
                    const segment = segments[index];
                    const segmentDelay = getNaturalSegmentInterval(characterKey, index, segments.length);
                    
                        // 如果不是第一段，先移除该角色的打字动画
                        if (index > 0) {
                            removeTypingAnimation(characterKey);
                        }
                        
                        // 直接添加消息段
                        addMessage({
                            type: 'message',
                            character: characterKey,
                            content: segment,
                            contentType: 'text'
                        });
                        
                    // 如果不是最后一段，显示继续输入的动画并等待
                        if (index < segments.length - 1) {
                        // 显示打字动画
                                showTypingAnimation(characterKey);
                        
                        // 等待延迟时间（用打字动画渡过）
                        await new Promise(resolveDelay => setTimeout(resolveDelay, segmentDelay));
                    }
                }
                
                // 所有段落发送完成
                            resolve();
            });
        }

        // 備用回應（已刪除）
        // 注意：此函數已被刪除，統一使用網絡錯誤提示

        // 統一智能角色選擇和互動回應生成（已刪除）
        // 注意：此函數已被刪除，統一使用 generateSafeAIResponses 中的邏輯
        
        // 已廢棄：AI 參與選角的合併 prompt（移除）
         
         // 為單個角色生成回應
        // 已移除：單角色直接回應的舊函數（generateIndividualCharacterResponse）
         
         // 構建個體角色的系統提示（優化版本 - 強化身份確認）
         function buildIndividualCharacterPrompt(characterId, userMessage, allSelectedCharacters) {
             const character = characters[characterId];
             const otherCharacters = allSelectedCharacters
                 .filter(id => id !== characterId)
                 .map(id => characters[id].name);
             
             const basePrompt = generateSystemPrompt(characterId);
             
             let interactionContext = '';
             if (otherCharacters.length > 0) {
                 interactionContext = `\n\n互動上下文：除了你之外，還有其他角色也會回應：${otherCharacters.join('、')}。請保持你的獨特身份和語言風格，不要模仿其他角色。`;
             }
             
             // 在最後強制重複身份確認
             const identityConfirmation = `\n\n【最終身份確認】你是${character.name}，不是其他任何人。你必須以${character.name}的身份回應，絕對不能使用其他角色的語言習慣。`;
             
             return `${basePrompt}

重要身份確認：
- 你是 ${character.name}，不是其他任何人
- 請用符合你身份的語氣和語言風格回應
- 保持你的獨特個性和說話方式
- 必須使用繁體中文回應，絕對不能使用簡體中文

用戶消息：「${userMessage}」

請以 ${character.name} 的身份回應，保持角色的一致性。${interactionContext}${identityConfirmation}

【語言要求】你必須使用繁體中文回應，絕對不能使用簡體中文。`;
         }
         
         // 從選擇結果中提取角色信息（備用方案）
        // 已移除：AI 選角的備援解析（extractCharactersFromSelection）
         
                 // 智能規則選擇系統（確保總回應人數為1-3人，且提及的角色優先）
        function useIntelligentRuleBasedSelection(userMessage, activeCharacters) {
            console.log('🚀 開始智能規則選擇...');
            
            // 1. 決定本次回應的總角色數（1-3個）
            const totalDesired = Math.min(activeCharacters.length, Math.floor(Math.random() * 3) + 1);
            console.log(`🎯 本次回應目標總人數: ${totalDesired}`);
            
            const selectedCharacters = new Set();
            const characterScores = {};
            
            // 2. 檢測所有提及類型
            const directMentions = detectDirectMentions(userMessage, activeCharacters);
            const indirectMentions = detectIndirectMentions(userMessage, activeCharacters);
            const aiMentions = detectAIMentions(userMessage, activeCharacters);
            
            // 3. 按優先級填充提及的角色，直到達到期望總數
            const fillMentionedCharacters = (mentions, type) => {
                for (const charId of mentions) {
                    if (selectedCharacters.size < totalDesired) {
                        if (!selectedCharacters.has(charId)) {
                            selectedCharacters.add(charId);
                            console.log(`🌟 (${type}) ${characters[charId].name} 被選中`);
                        }
                    } else {
                        break;
                    }
                }
            };
            
            fillMentionedCharacters(directMentions, '直接提及');
            fillMentionedCharacters(indirectMentions, '間接提及');
            fillMentionedCharacters(aiMentions, 'AI提及');
            
            // 4. 如果名額未滿，通過評分選擇額外角色
            const additionalNeeded = totalDesired - selectedCharacters.size;
            
            if (additionalNeeded > 0) {
                console.log(`📊 仍需 ${additionalNeeded} 個角色，開始評分...`);
                
                const unselectedCharacters = activeCharacters.filter(id => !selectedCharacters.has(id));
                
                unselectedCharacters.forEach(charId => {
                    let score = 0;
                    const context = analyzeConversationContext(userMessage, activeCharacters);
                    
                    // 對話連續性
                    if (context.lastSpeaker === charId && context.userIntent === 'continue_conversation') {
                        score += 50;
                    }
                    // 提問回應
                    if (context.lastSpeaker === charId && context.userIntent === 'ask_question') {
                        score += 40;
                    }
                    // 群組平衡
                    const recentSpeakers = groupChatContext.messages.slice(-5)
                        .filter(msg => msg.character && msg.character !== 'user')
                        .map(msg => msg.character);
                    const recentCount = recentSpeakers.filter(speaker => speaker === charId).length;
                    if (recentCount > 2) {
                        score -= recentCount * 10;
                    }
                    // 隨機因子
                    score += Math.random() * 20;
                    
                    characterScores[charId] = score;
                });
                
                const sortedUnselected = unselectedCharacters.sort((a, b) => 
                    (characterScores[b] || 0) - (characterScores[a] || 0)
                );
                
                const additionalCharacters = sortedUnselected.slice(0, additionalNeeded);
                additionalCharacters.forEach(charId => {
                    selectedCharacters.add(charId);
                    console.log(`🏆 (評分) ${characters[charId].name} 被選中`);
                });
            }
            
            // 5. 按優先級重新排序最終結果
            const finalSelection = Array.from(selectedCharacters);
            const reorderedSelection = [];

            const addToFinal = (mentions) => {
                mentions.forEach(charId => {
                    if (finalSelection.includes(charId) && !reorderedSelection.includes(charId)) {
                        reorderedSelection.push(charId);
                    }
                });
            };

            addToFinal(directMentions);
            addToFinal(indirectMentions);
            addToFinal(aiMentions);

            finalSelection.forEach(charId => {
                if (!reorderedSelection.includes(charId)) {
                    reorderedSelection.push(charId);
                }
            });

            console.log('✅ 最終選擇的角色（按優先級排序）:', reorderedSelection.map(id => characters[id].name));
            return reorderedSelection;
        }
        
        // 檢測直接提及的角色（@或名字）
        function detectDirectMentions(userMessage, activeCharacters) {
            const mentionedCharacters = [];
            
            // 1. 檢查@提及
            const mentions = extractMentions(userMessage);
            mentions.forEach(mention => {
                if (activeCharacters.includes(mention.id)) {
                    mentionedCharacters.push(mention.id);
                }
            });
            
            // 2. 檢查名字提及
            const nameMentions = detectCharacterMentions(userMessage, activeCharacters);
            nameMentions.forEach(charId => {
                if (!mentionedCharacters.includes(charId)) {
                    mentionedCharacters.push(charId);
                }
            });
            
            return mentionedCharacters;
        }
        
        // 檢測間接提及的角色（「你」指向前一個角色）
        function detectIndirectMentions(userMessage, activeCharacters) {
            const mentionedCharacters = [];
            
            console.log('🔍 檢測間接提及 - 用戶消息:', userMessage);
            
            // 檢查「你」的提及
            const youKeywords = ['你', '妳', '您'];
            const hasYouMention = youKeywords.some(keyword => userMessage.includes(keyword));
            console.log('🔍 檢測間接提及 - 包含「你」:', hasYouMention);
            
            if (hasYouMention) {
                // 找到用戶消息之前的最後一個AI角色
                const recentMessages = groupChatContext.messages.slice(-10);
                console.log('🔍 最近10條消息:', recentMessages);
                
                // 從後往前找，找到用戶消息之前的最後一個AI角色
                for (let i = recentMessages.length - 1; i >= 0; i--) {
                    const msg = recentMessages[i];
                    
                    // 如果遇到用戶消息，停止搜索
                    // 注意：需要排除當前正在處理的用戶消息
                    if (msg.character === 'user') {
                        // 檢查是否是當前正在處理的用戶消息
                        if (msg.content === userMessage) {
                            console.log('🔍 遇到當前用戶消息，跳過並繼續搜索');
                            continue; // 跳過當前消息，繼續搜索
                        } else {
                            console.log('🔍 遇到其他用戶消息，停止搜索');
                            break;
                        }
                    }
                    
                    // 如果是AI角色且在活躍列表中
                    if (msg.character && activeCharacters.includes(msg.character)) {
                        mentionedCharacters.push(msg.character);
                        console.log(`✅ 檢測到「你」指向前一個AI角色: ${characters[msg.character].name}`);
                        break;
                    }
                }
                
                if (mentionedCharacters.length === 0) {
                    console.log('❌ 沒有找到用戶消息之前的AI角色');
                    console.log('🔍 活躍角色列表:', activeCharacters.map(id => characters[id]?.name));
                    console.log('🔍 最近消息詳情:', recentMessages.map((msg, index) => ({
                        index,
                        character: msg.character,
                        isUser: msg.character === 'user',
                        isActive: activeCharacters.includes(msg.character),
                        content: msg.content?.substring(0, 20) + '...'
                    })));
                }
            }
            
            console.log('🔍 間接提及檢測結果:', mentionedCharacters.map(id => characters[id]?.name));
            return mentionedCharacters;
        }
        
        // 檢測AI是否提到了其他角色
        function detectAIMentions(userMessage, activeCharacters) {
            const mentionedCharacters = [];
            
            // 獲取最近的AI消息
            const recentMessages = groupChatContext.messages.slice(-10);
            
            // 檢查最近的AI消息中是否提到了其他角色
            recentMessages.forEach(msg => {
                if (msg.character && msg.character !== 'user' && activeCharacters.includes(msg.character)) {
                    const messageContent = msg.content || '';
                    
                    // 檢查消息中是否提到了其他角色
                    activeCharacters.forEach(charId => {
                        if (charId !== msg.character) { // 不檢查自己
                            const character = characters[charId];
                            if (character && messageContent.includes(character.name)) {
                                // 檢查是否已經在列表中
                                if (!mentionedCharacters.includes(charId)) {
                                    mentionedCharacters.push(charId);
                                }
                            }
                        }
                    });
                }
            });
            
            return mentionedCharacters;
        }

        // 新增：帶位置的 @ 提及檢測（僅限當前群組活躍角色）
        function extractAtMentionsWithPos(userMessage, activeCharacters) {
            const results = [];
            activeCharacters.forEach(charId => {
                const name = characters[charId]?.name;
                if (!name) return;
                const needle = `@${name}`;
                const pos = userMessage.indexOf(needle);
                if (pos >= 0) {
                    results.push({ id: charId, pos });
                }
            });
            // 按出現順序排序
            results.sort((a,b) => a.pos - b.pos);
            return results;
        }

        // 新增：帶位置的人名提及檢測（不含@，使用別名）
        function detectCharacterMentionsWithPos(userMessage, activeCharacters) {
            const results = [];
            activeCharacters.forEach(charId => {
                const aliases = (characterAliases && characterAliases[charId]) ? [...characterAliases[charId]] : [];
                const official = characters[charId]?.name;
                if (official) aliases.push(official);
                let bestPos = Infinity;
                aliases.forEach(alias => {
                    if (!alias) return;
                    const p1 = userMessage.indexOf(alias);
                    const p2 = userMessage.toLowerCase().indexOf(alias.toLowerCase());
                    const pos = (p1 >= 0 ? p1 : (p2 >= 0 ? p2 : -1));
                    if (pos >= 0 && pos < bestPos) bestPos = pos;
                });
                if (bestPos !== Infinity) results.push({ id: charId, pos: bestPos });
            });
            results.sort((a,b) => a.pos - b.pos);
            return results;
        }
        
        // 檢查是否有直接提及（保留原有函數）
        function hasDirectMention(userMessage) {
            const mentions = extractMentions(userMessage);
            const nameMentions = detectCharacterMentions(userMessage, Object.keys(characters));
            return mentions.length > 0 || nameMentions.length > 0;
        }
        
        // 檢查是否有明確的@提及
        function hasExplicitAt(userMessage) {
            return userMessage.includes('@');
        }
        
        // 檢查是否有隱含語境
        function hasImplicitContext(userMessage) {
            const implicitKeywords = [
                '誰', '哪個', '什麼', '怎麼', '為什麼', '如何',
                '覺得', '認為', '看法', '觀點', '意見',
                '詩', '詞', '文學', '藝術', '人生', '哲學',
                '自然', '山水', '田園', '酒', '月', '花'
            ];
            
            return implicitKeywords.some(keyword => userMessage.includes(keyword));
        }
        
        // 檢查是否有複雜互動
        function hasComplexInteraction(activeCharacters) {
            const recentMessages = groupChatContext.messages.slice(-5);
            const recentSpeakers = recentMessages
                .filter(msg => msg.character && msg.character !== 'user')
                .map(msg => msg.character);
            
            // 如果最近有多個不同角色發言，可能是複雜互動
            const uniqueSpeakers = [...new Set(recentSpeakers)];
            return uniqueSpeakers.length >= 2;
        }
        
        // 使用規則進行角色選擇（原有邏輯 - 保留作為備用）
        function useRuleBasedSelection(userMessage, activeCharacters) {
            // 1. 檢查是否有@提及
            const mentions = extractMentions(userMessage);
            if (mentions.length > 0) {
                const mentionedCharacters = mentions
                    .map(mention => mention.id)
                    .filter(id => activeCharacters.includes(id));
                
                if (mentionedCharacters.length > 0) {
                    console.log('檢測到@提及，優先選擇:', mentionedCharacters.map(id => characters[id].name));
                    return mentionedCharacters;
                }
            }
            
            // 2. 檢查用戶是否提到了特定角色（無需@）
            const mentionedCharacters = detectCharacterMentions(userMessage, activeCharacters);
            if (mentionedCharacters.length > 0) {
                console.log('檢測到角色提及，優先選擇:', mentionedCharacters.map(id => characters[id].name));
                return mentionedCharacters;
            }
            
            // 3. 檢查是否有角色被其他AI提及
            const aiMentionedCharacters = detectAIMentions(userMessage, activeCharacters);
            if (aiMentionedCharacters.length > 0) {
                console.log('檢測到AI提及角色，優先選擇:', aiMentionedCharacters.map(id => characters[id].name));
                return aiMentionedCharacters;
            }
            
            // 4. 智能分析對話連續性
            const conversationContext = analyzeConversationContext(userMessage, activeCharacters);
            
            // 5. 根據上下文選擇最合適的角色
            const selectedCharacters = selectCharactersByContext(conversationContext, activeCharacters);
            
            console.log('規則選擇的回應角色:', selectedCharacters.map(id => characters[id].name));
            return selectedCharacters;
        }
        
        // 優化：簡化上下文分析（專注於群組內角色選擇）
        function analyzeQuickContext(userMessage, activeCharacters) {
            const recentMessages = groupChatContext.messages.slice(-3); // 只分析最近3條消息
            const context = {
                lastSpeaker: null,
                userIntent: null
            };
            
            // 找出最後一個說話的角色（僅限當前群組）
            for (let i = recentMessages.length - 1; i >= 0; i--) {
                const msg = recentMessages[i];
                if (msg.character && msg.character !== 'user' && activeCharacters.includes(msg.character)) {
                    context.lastSpeaker = msg.character;
                    break;
                }
            }
            
            // 簡化意圖識別（專注於對話流程）
            if (userMessage.includes('請講') || userMessage.includes('繼續') || userMessage.includes('說說') || userMessage.includes('然後呢')) {
                context.userIntent = 'continue_conversation';
            } else if (userMessage.includes('為什麼') || userMessage.includes('怎麼') || userMessage.includes('如何') || userMessage.includes('什麼') || userMessage.includes('哪個') || userMessage.includes('誰')) {
                context.userIntent = 'ask_question';
            } else if (userMessage.includes('嗯') || userMessage.includes('對') || userMessage.includes('是的') || userMessage.includes('沒錯')) {
                context.userIntent = 'agree';
            } else if (userMessage.includes('不') || userMessage.includes('不同意') || userMessage.includes('我覺得') || userMessage.includes('但是')) {
                context.userIntent = 'disagree_or_comment';
            }
            
            console.log('簡化上下文分析:', {
                lastSpeaker: context.lastSpeaker ? characters[context.lastSpeaker].name : '無',
                userIntent: context.userIntent,
                groupMembers: activeCharacters.map(id => characters[id].name)
            });
            
            return context;
        }
        
        // 優化：簡化角色選擇（專注於群組內對話流程）
        function selectCharactersByQuickContext(context, activeCharacters) {
            const characterScores = {};
            
            // 初始化所有角色的分數
            activeCharacters.forEach(charId => {
                characterScores[charId] = 0;
            });
            
            // 1. 對話連續性（最高優先級）
            if (context.lastSpeaker && context.userIntent === 'continue_conversation') {
                characterScores[context.lastSpeaker] += 60;
                console.log(`對話連續性：${characters[context.lastSpeaker].name} +60分`);
            }
            
            // 2. 提問回應（讓最後說話的角色回答）
            if (context.lastSpeaker && context.userIntent === 'ask_question') {
                characterScores[context.lastSpeaker] += 50;
                console.log(`提問回應：${characters[context.lastSpeaker].name} +50分`);
            }
            
            // 3. 群組平衡（避免同一個角色過於頻繁回應）
            const recentSpeakers = groupChatContext.messages.slice(-5)
                .filter(msg => msg.character && msg.character !== 'user')
                .map(msg => msg.character);
            
            activeCharacters.forEach(charId => {
                const recentCount = recentSpeakers.filter(speaker => speaker === charId).length;
                if (recentCount > 2) {
                    characterScores[charId] -= recentCount * 15; // 減少過於活躍的角色
                    console.log(`群組平衡：${characters[charId].name} -${recentCount * 15}分`);
                }
            });
            
            // 4. 隨機因子（增加多樣性）
            activeCharacters.forEach(charId => {
                const randomBonus = Math.random() * 10;
                characterScores[charId] += randomBonus;
                console.log(`隨機因子：${characters[charId].name} +${randomBonus.toFixed(1)}分`);
            });
            
            // 5. 選擇分數最高的角色
            const sortedCharacters = activeCharacters.sort((a, b) => 
                (characterScores[b] || 0) - (characterScores[a] || 0)
            );
            
            // 簡化回應數量決定
            const topScore = characterScores[sortedCharacters[0]] || 0;
            let responseCount = 1;
            
            // 只有在分數差距不大時才選擇多個角色
            if (sortedCharacters.length > 1) {
                const scoreDiff = (characterScores[sortedCharacters[0]] || 0) - (characterScores[sortedCharacters[1]] || 0);
                if (scoreDiff < 20) {
                    responseCount = 2;
                }
            }
            
            const selectedCharacters = sortedCharacters.slice(0, responseCount);
            
            console.log('角色分數:', Object.fromEntries(
                activeCharacters.map(id => [characters[id].name, characterScores[id] || 0])
            ));
            console.log('最終選擇:', selectedCharacters.map(id => characters[id].name));
            
            return selectedCharacters;
        }
        
        // 角色別名映射
            const characterAliases = {
                'huizi': [
                    // 所有別名（包含繁體簡體）
                    '惠子', '惠施', '名家宗師', '名家宗师', '惠先生', '惠子先生'
                ],
                'baiqi': [
                    // 所有別名（包含繁體簡體）
                    '白起', '武安君', '戰神', '战神', '白將軍', '白将军', '白起将军'
                ],
                'ganbao': [
                    // 所有別名（包含繁體簡體）
                    '干寶', '干宝', '搜神記主', '搜神记主', '干先生', '干宝先生'
                ],
                'simaqian': [
                    // 所有別名（包含繁體簡體）
                    '司馬遷', '司马迁', '太史公', '司馬先生', '司马先生', '史記作者', '史记作者', '司馬遷先生', '司马迁先生'
                ],
                'hanxin': [
                    // 所有別名（包含繁體簡體）
                    '韓信', '韩信', '兵仙', '韓將軍', '韩将军', '淮陰侯', '淮阴侯', '韓信將軍', '韩信将军'
                ],
                'lishangyin': [
                    // 所有別名（包含繁體簡體）
                    '李商隱', '李商隐', '李義山', '李义山', '玉谿生', '義山', '义山', '義山先生', '义山先生'
                ],
                'dumu': [
                    // 所有別名（包含繁體簡體）
                    '杜牧', '杜牧之', '小杜', '樊川居士', '牧之', '杜牧先生'
                ],
                'lihe': [
                    // 所有別名（包含繁體簡體）
                    '李賀', '李贺', '李長吉', '李长吉', '詩鬼', '诗鬼', '長吉', '长吉', '長吉先生', '长吉先生'
                ],
                'baiyuyi': [
                    // 所有別名（包含繁體簡體）
                    '白居易', '白樂天', '白乐天', '香山居士', '樂天', '乐天', '樂天先生', '乐天先生'
                ],

                'liuyong': [
                    // 所有別名（包含繁體簡體）
                    '柳永', '柳三變', '柳三变', '三變', '三变', '柳屯田', '三變先生', '三变先生'
                ],
                'pushengling': [
                    // 所有別名（包含繁體簡體）
                    '蒲松齡', '蒲松龄', '聊齋先生', '聊斋先生', '蒲先生', '聊齋', '聊斋', '蒲松齡先生', '蒲松龄先生'
                ],
                'liqingzhao': [
                    // 所有別名（包含繁體簡體）
                    '李清照', '易安居士', '清照', '李易安', '清照先生'
                ],
                'sushi': [
                    // 所有別名（包含繁體簡體）
                    '蘇軾', '苏轼', '蘇東坡', '苏东坡', '東坡居士', '东坡居士', '東坡', '东坡', '蘇子瞻', '苏子瞻', '東坡先生', '东坡先生'
                ],
                'xinqiji': [
                    // 所有別名（包含繁體簡體）
                    '辛棄疾', '辛弃疾', '辛稼軒', '辛稼轩', '稼軒', '稼轩', '辛幼安', '稼軒先生', '稼轩先生'
                ],
                'jiangkui': [
                    // 所有別名（包含繁體簡體）
                    '姜夔', '白石道人', '白石', '姜白石', '白石先生'
                ],
                'liyu': [
                    // 所有別名（包含繁體簡體）
                    '李煜', '李後主', '李后主', '後主', '后主', '李重光', '後主先生', '后主先生'
                ],
                'zhoubanyan': [
                    // 所有別名（包含繁體簡體）
                    '周邦彥', '周邦彦', '美成', '周美成', '清真居士', '美成先生'
                ],
                'yanjidao': [
                    // 所有別名（包含繁體簡體）
                    '晏幾道', '晏几道', '小山', '晏小山', '小山居士', '小山先生'
                ],
                'wuwenying': [
                    // 所有別名（包含繁體簡體）
                    '吳文英', '吴文英', '夢窗', '梦窗', '吳夢窗', '吴梦窗', '夢窗居士', '梦窗居士', '夢窗先生', '梦窗先生'
                ],
                'huangtingjian': [
                    // 所有別名（包含繁體簡體）
                    '黃庭堅', '黄庭坚', '山谷道人', '山谷', '黃山谷', '黄山谷', '山谷先生'
                ],
                'chenweisong': [
                    // 所有別名（包含繁體簡體）
                    '陳維崧', '陈维崧', '其年', '陳其年', '陈其年', '迦陵', '其年先生'
                ],
                'zhuyizun': [
                    // 所有別名（包含繁體簡體）
                    '朱彜尊', '朱彝尊', '竹垞', '朱竹垞', '曝書亭', '曝书亭', '竹垞先生'
                ],
                'nalanxingde': [
                    // 所有別名（包含繁體簡體）
                    '納蘭性德', '纳兰性德', '容若', '納蘭容若', '纳兰容若', '飲水詞人', '饮水词人', '容若先生'
                ],
                // 紅樓夢角色別名映射
                'jiabaoyu': [
                    // 賈寶玉的所有別名（包含繁體簡體）
                    '賈寶玉', '贾宝玉', '寶玉', '宝玉', '怡紅公子', '怡红公子', '寶二爺', '宝二爷', '二哥哥', '寶哥哥', '宝哥哥', '賈二爺', '贾二爷'
                ],
                'lindaiyu': [
                    // 林黛玉的所有別名（包含繁體簡體）
                    '林黛玉', '黛玉', '瀟湘妃子', '潇湘妃子', '林妹妹', '黛玉妹妹', '林姑娘', '林小姐'
                ],
                'xuebaochai': [
                    // 薛寶釵的所有別名（包含繁體簡體）
                    '薛寶釵', '薛宝钗', '寶釵', '宝钗', '蘅蕪君', '蘅芜君', '寶姐姐', '宝姐姐', '薛姑娘', '薛小姐'
                ],
                'jiatanchun': [
                    // 賈探春的所有別名（包含繁體簡體）
                    '賈探春', '贾探春', '探春', '蕉下客', '三妹妹', '探春妹妹', '賈三姑娘', '贾三姑娘'
                ],
                'jiayingchun': [
                    // 賈迎春的所有別名（包含繁體簡體）
                    '賈迎春', '贾迎春', '迎春', '菱洲', '二妹妹', '迎春妹妹', '賈二姑娘', '贾二姑娘'
                ],
                'jiaxichun': [
                    // 賈惜春的所有別名（包含繁體簡體）
                    '賈惜春', '贾惜春', '惜春', '藕榭', '四妹妹', '惜春妹妹', '賈四姑娘', '贾四姑娘'
                ],
                'shixiangyun': [
                    // 史湘雲的所有別名（包含繁體簡體）
                    '史湘雲', '史湘云', '湘雲', '湘云', '枕霞舊友', '枕霞旧友', '雲妹妹', '云妹妹', '史姑娘', '史小姐'
                ],
                'liwan': [
                    // 李紈的所有別名（包含繁體簡體）
                    '李紈', '李纨', '稻香老農', '稻香老农', '大嫂子', '李嫂子', '李姑娘'
                ],
                'miaoyu': [
                    // 妙玉的所有別名（包含繁體簡體）
                    '妙玉', '檻外人', '槛外人', '妙玉師父', '妙玉师父', '妙玉姑娘'
                ],
                // 春秋戰國角色別名映射
                'confucius': [
                    // 孔子的所有別名（包含繁體簡體）
                    '孔子', '孔丘', '孔仲尼', '至聖先師', '至圣先师', '孔夫子', '夫子', '孔先生', '仲尼', '孔聖人', '孔圣人'
                ],
                'quyuan': [
                    // 屈原的所有別名（包含繁體簡體）
                    '屈原', '屈平', '楚辭之祖', '楚辞之祖', '靈均', '灵均', '屈大夫', '屈先生', '楚大夫'
                ],
                'laozi': [
                    // 老子的所有別名（包含繁體簡體）
                    '老子', '李耳', '道德天尊', '老聃', '老聃', '太上老君', '李伯陽', '李伯阳', '老君', '老子先生'
                ],
                'zhuangzi': [
                    // 莊子的所有別名（包含繁體簡體）
                    '莊子', '庄子', '莊周', '庄周', '南華真人', '南华真人', '漆園吏', '漆园吏', '莊先生', '庄先生', '南華', '南华'
                ],
                'mencius': [
                    // 孟子的所有別名（包含繁體簡體）
                    '孟子', '孟軻', '孟轲', '亞聖', '亚圣', '孟先生', '軻', '轲', '孟夫子'
                ],
                // 三國兩晉南北朝角色別名映射
                'caozhi': [
                    // 曹植的所有別名（包含繁體簡體）
                    '曹植', '曹子建', '陳王', '陈王', '陳思王', '陈思王', '子建', '曹公子', '曹先生'
                ],
                'caocao': [
                    // 曹操的所有別名（包含繁體簡體）
                    '曹操', '曹孟德', '魏武帝', '孟德', '曹丞相', '曹公', '魏王', '曹先生'
                ],
                'caopi': [
                    // 曹丕的所有別名（包含繁體簡體）
                    '曹丕', '曹子桓', '魏文帝', '子桓', '曹太子', '曹先生'
                ],
                'taoyuanming': [
                    // 陶淵明的所有別名（包含繁體簡體）
                    '陶淵明', '陶渊明', '陶潛', '陶潜', '採菊東籬', '采菊东篱', '五柳先生', '陶先生', '淵明', '渊明', '潛', '潜'
                ],
                'liuling': [
                    // 劉伶的所有別名（包含繁體簡體）
                    '劉伶', '刘伶', '酒中仙', '劉先生', '刘先生', '竹林七賢', '竹林七贤'
                ],
                // 唐代角色別名映射
                'libai': [
                    // 李白的所有別名（包含繁體簡體）
                    '李白', '李太白', '謫仙人', '谪仙人', '青蓮居士', '青莲居士', '詩仙', '诗仙', '太白', '李謫仙', '李谪仙', '李先生'
                ],
                'dufu': [
                    // 杜甫的所有別名（包含繁體簡體）
                    '杜甫', '杜子美', '少陵野老', '少陵野老', '詩聖', '诗圣', '杜工部', '子美', '杜先生', '老杜'
                ],
                'wangwei': [
                    // 王維的所有別名（包含繁體簡體）
                    '王維', '王维', '王摩詰', '王摩诘', '詩佛', '诗佛', '摩詰', '摩诘', '王先生', '王右丞'
                ],
                'menghaoran': [
                    // 孟浩然的所有別名（包含繁體簡體）
                    '孟浩然', '孟襄陽', '孟襄阳', '浩然', '孟先生', '襄陽', '襄阳'
                ],
                'ligui': [
                    // 李龜年的所有別名（包含繁體簡體）
                    '李龜年', '李龟年', '宮廷樂師', '宫廷乐师', '龜年', '龟年', '李樂師', '李乐师'
                ],
                'yuzhen': [
                    // 玉真公主的所有別名（包含繁體簡體）
                    '玉真公主', '玉真', '唐玄宗妹妹', '公主', '玉真公主殿下'
                ],
                'yangguifei': [
                    // 楊貴妃的所有別名（包含繁體簡體）
                    '楊貴妃', '杨贵妃', '楊玉環', '杨玉环', '天生麗質', '天生丽质', '貴妃', '贵妃', '玉環', '玉环', '楊妃', '杨妃'
                ],
                // 神話傳說角色別名映射
                'xiwangmu': [
                    // 西王母的所有別名（包含繁體簡體）
                    '西王母', '瑤池金母', '瑶池金母', '王母娘娘', '王母', '瑤池', '瑶池', '金母'
                ],
                'yutu': [
                    // 玉兔的所有別名（包含繁體簡體）
                    '玉兔', '搗藥翁', '捣药翁', '月兔', '兔兒爺', '兔儿爷', '搗藥', '捣药'
                ],
                'change': [
                    // 嫦娥的所有別名（包含繁體簡體）
                    '嫦娥', '月宮仙子', '月宫仙子', '廣寒仙子', '广寒仙子', '月仙子', '嫦娥仙子', '月宮', '月宫'
                ],

                // 史記群新增歷史人物別名映射
                'xiangyu': [
                    // 項羽的所有別名（包含繁體簡體）
                    '項羽', '项羽', '西楚霸王', '霸王', '項王', '项王', '楚霸王', '項將軍', '项将军'
                ],
                'liubang': [
                    // 劉邦的所有別名（包含繁體簡體）
                    '劉邦', '刘邦', '漢高祖', '汉高祖', '高祖', '劉季', '刘季', '沛公', '漢王', '汉王'
                ],
                'qinshihuang': [
                    // 秦始皇的所有別名（包含繁體簡體）
                    '秦始皇', '始皇帝', '嬴政', '秦王', '秦始皇帝', '政', '秦王政'
                ],
                'jingke': [
                    // 荊軻的所有別名（包含繁體簡體）
                    '荊軻', '荆轲', '刺客', '荊卿', '荆卿', '荊先生', '荆先生'
                ],
                'gaojianli': [
                    // 高漸離的所有別名（包含繁體簡體）
                    '高漸離', '高渐离', '擊筑者', '击筑者', '高先生', '漸離', '渐离'
                ],
                'zhangliang': [
                    // 張良的所有別名（包含繁體簡體）
                    '張良', '张良', '留侯', '子房', '張子房', '张子房', '張先生', '张先生'
                ],
                'fanhui': [
                    // 樊噲的所有別名（包含繁體簡體）
                    '樊噲', '樊哙', '舞陽侯', '舞阳侯', '樊將軍', '樊将军', '樊先生'
                ],
                'fanzeng': [
                    // 范增的所有別名（包含繁體簡體）
                    '范增', '亞父', '亚父', '范先生', '增', '范亞父', '范亚父'
                ],
                'yuji': [
                    // 虞姬的所有別名（包含繁體簡體）
                    '虞姬', '虞美人', '美人', '虞', '虞姬夫人'
                ],
                'taizidan': [
                    // 太子丹的所有別名（包含繁體簡體）
                    '太子丹', '燕太子', '燕太子丹', '丹', '太子', '燕丹'
                ],
                'niezheng': [
                    // 聶政的所有別名（包含繁體簡體）
                    '聶政', '聂政', '刺客', '聶先生', '聂先生', '政'
                ],
                'lvhou': [
                    // 呂后的所有別名（包含繁體簡體）
                    '呂后', '吕后', '呂太后', '吕太后', '呂雉', '吕雉', '太后', '呂皇后', '吕皇后'
                ],
                'hanwudi': [
                    // 漢武帝的所有別名（包含繁體簡體）
                    '漢武帝', '汉武帝', '武帝', '劉徹', '刘彻', '漢武', '汉武', '徹', '彻'
                ],
                'daji': [
                    // 妲己的所有別名（包含繁體簡體）
                    '妲己', '妖妃', '妲己娘娘', '妲己夫人', '妲'
                ],
                'zhouwuwang': [
                    // 周武王的所有別名（包含繁體簡體）
                    '周武王', '武王', '姬發', '姬发', '武', '發', '发'
                ],
                'shangzhouwang': [
                    // 商紂王的所有別名（包含繁體簡體）
                    '商紂王', '商纣王', '紂王', '纣王', '帝辛', '辛', '紂', '纣'
                ],
                'baosi': [
                    // 褒姒的所有別名（包含繁體簡體）
                    '褒姒', '褒姒', '褒姒娘娘', '褒姒夫人', '姒'
                ],
                'zhouwenwang': [
                    // 周文王的所有別名（包含繁體簡體）
                    '周文王', '文王', '姬昌', '昌', '文', '西伯', '西伯昌'
                ],
                'zhouyouwang': [
                    // 周幽王的所有別名（包含繁體簡體）
                    '周幽王', '幽王', '姬宮湦', '宮湦', '宮', '湦', '幽', '周幽'
                ],
                'wuzixu': [
                    // 伍子胥的所有別名（包含繁體簡體）
                    '伍子胥', '伍员', '伍員', '子胥', '胥', '伍先生', '伍將軍', '伍将军'
                ],
                'qihuangong': [
                    // 齊桓公的所有別名（包含繁體簡體）
                    '齊桓公', '齐桓公', '桓公', '小白', '齊公', '齐公', '桓'
                ],
                'jinwengong': [
                    // 晉文公的所有別名（包含繁體簡體）
                    '晉文公', '晋文公', '文公', '重耳', '晉公', '晋公', '文'
                ],
                'goujian': [
                    // 勾踐的所有別名（包含繁體簡體）
                    '勾踐', '勾践', '越王', '勾踐王', '勾践王', '踐', '践'
                ],
                'fuchai': [
                    // 夫差的所有別名（包含繁體簡體）
                    '夫差', '吳王', '吴王', '夫差王', '差', '吳王夫差', '吴王夫差'
                ],
                'chuhuaiwang': [
                    // 楚懷王的所有別名（包含繁體簡體）
                    '楚懷王', '楚怀王', '懷王', '怀王', '熊槐', '槐', '楚王'
                ],
                'liling': [
                    // 李陵的所有別名（包含繁體簡體）
                    '李陵', '李將軍', '李将军', '陵', '李陵將軍', '李陵将军'
                ],
                'jiayi': [
                    // 賈誼的所有別名（包含繁體簡體）
                    '賈誼', '贾谊', '賈生', '贾生', '誼', '谊', '賈先生', '贾先生'
                ],
                'zhangqian': [
                    // 張騫的所有別名（包含繁體簡體）
                    '張騫', '张骞', '博望侯', '騫', '骞', '張先生', '张先生'
                ],
                'suqin': [
                    // 蘇秦的所有別名（包含繁體簡體）
                    '蘇秦', '苏秦', '合縱家', '合纵家', '蘇先生', '苏先生', '秦'
                ],
                'zhangyi': [
                    // 張儀的所有別名（包含繁體簡體）
                    '張儀', '张仪', '連橫家', '连横家', '張先生', '张先生', '儀', '仪'
                ],
                'zhaokuo': [
                    // 趙括的所有別名（包含繁體簡體）
                    '趙括', '赵括', '紙上談兵', '纸上谈兵', '括', '趙先生', '赵先生'
                ],
                'lianpo': [
                    // 廉頗的所有別名（包含繁體簡體）
                    '廉頗', '廉颇', '老將', '老将', '頗', '颇', '廉將軍', '廉将军'
                ],
                'lvbuwei': [
                    // 呂不韋的所有別名（包含繁體簡體）
                    '呂不韋', '吕不韦', '仲父', '呂相', '吕相', '不韋', '不韦', '呂先生', '吕先生'
                ],
                'laoai': [
                    // 嫪毐的所有別名（包含繁體簡體）
                    '嫪毐', '嫪毐', '假父', '嫪', '毐', '嫪先生'
                ],
                'lisi': [
                    // 李斯的所有別名（包含繁體簡體）
                    '李斯', '丞相', '斯', '李丞相', '李先生', '斯先生'
                ],
                'zhaogao': [
                    // 趙高的所有別名（包含繁體簡體）
                    '趙高', '赵高', '中車府令', '中车府令', '高', '趙先生', '赵先生'
                ],
                'gongzifusu': [
                    // 公子扶蘇的所有別名（包含繁體簡體）
                    '公子扶蘇', '公子扶苏', '扶蘇', '扶苏', '扶蘇公子', '扶苏公子', '蘇', '苏'
                ],
                'weizifu': [
                    // 衛子夫的所有別名（包含繁體簡體）
                    '衛子夫', '卫子夫', '衛皇后', '卫皇后', '子夫', '衛夫人', '卫夫人'
                ],
                'chenajiao': [
                    // 陳阿嬌的所有別名（包含繁體簡體）
                    '陳阿嬌', '陈阿娇', '陳皇后', '陈皇后', '阿嬌', '阿娇', '嬌', '娇'
                ],
                'huhai': [
                    // 胡亥的所有別名（包含繁體簡體）
                    '胡亥', '秦二世', '二世', '亥', '秦二世皇帝', '二世皇帝'
                ]
            };
            
            // 檢測角色名字提及
            function detectCharacterMentions(userMessage, activeCharacters) {
                const mentionedCharacters = [];
            
            // 檢查每個角色的名稱和暱稱
            activeCharacters.forEach(charId => {
                const aliases = characterAliases[charId] || [];
                const character = characters[charId];
                if (character) {
                    aliases.push(character.name); // 添加正式名稱
                }
                
                // 檢查是否包含任何別名（支持簡體和繁體）
                const isMentioned = aliases.some(alias => {
                    // 直接匹配
                    if (userMessage.includes(alias)) {
                        return true;
                    }
                    
                    // 大小寫不敏感匹配
                    if (userMessage.toLowerCase().includes(alias.toLowerCase())) {
                        return true;
                    }
                    
                    return false;
                });
                
                if (isMentioned) {
                    mentionedCharacters.push(charId);
                }
            });
            
            return mentionedCharacters;
        }
        
        // 已廢棄：AI 角色選擇與回應合併流程（移除）
        
        // 為已選中的角色生成互動回應（已刪除）
        // 注意：此函數已被刪除，統一使用 generateSafeAIResponses 中的邏輯
        
        // 測試聊天上下文完整性
        function testChatContext() {
            console.log('🧪 測試聊天上下文完整性...');
            console.log('📊 群聊上下文統計:', {
                totalMessages: groupChatContext.messages.length,
                maxContextLength: groupChatContext.maxContextLength,
                lastUpdateTime: new Date(groupChatContext.lastUpdateTime).toLocaleString()
            });
            
            if (groupChatContext.messages.length > 0) {
                console.log('📝 最近5條消息詳情:');
                groupChatContext.messages.slice(-5).forEach((msg, index) => {
                    console.log(`  ${index + 1}. [${msg.role}] ${msg.character}: ${msg.content?.substring(0, 50)}...`);
                });
            } else {
                console.log('❌ 群聊上下文為空！');
            }
            
            console.log('📊 角色歷史統計:');
            for (const [charId, history] of conversationHistory.entries()) {
                console.log(`  ${characters[charId]?.name || charId}: ${history.length} 條記錄`);
                if (history.length > 0) {
                    console.log(`    最後一條: ${history[history.length - 1].content?.substring(0, 30)}...`);
                }
            }
            
            // 🔍 詳細檢查群聊上下文內容
            if (groupChatContext.messages.length > 0) {
                console.log('🔍 群聊上下文詳細內容:');
                groupChatContext.messages.forEach((msg, index) => {
                    console.log(`  消息${index + 1}:`, {
                        role: msg.role,
                        character: msg.character,
                        content: msg.content?.substring(0, 30) + '...',
                        timestamp: msg.timestamp
                    });
                });
            }
        }
        
        // 生成簡單回應（已刪除）
        // 注意：此函數已被刪除，統一使用網絡錯誤提示
        
        // 檢查角色身份一致性（簡化版本）
        function checkCharacterIdentity(characterKey, response) {
            const character = characters[characterKey];
            if (!character) {
                return { isValid: false, reason: '角色不存在' };
            }
            
            // 只檢查最嚴重的身份混淆問題
            const otherCharacters = Object.keys(characters).filter(key => key !== characterKey);
            const otherCharacterNames = otherCharacters.map(key => characters[key].name);
            
            // 檢查是否有明確的身份混淆（如"我是其他角色"）
            const hasIdentityConfusion = otherCharacterNames.some(name => {
                const identityConfusionPatterns = [
                    `我是${name}`,
                    `作為${name}`,
                    `${name}認為`,
                    `${name}覺得`
                ];
                
                return identityConfusionPatterns.some(pattern => response.includes(pattern));
            });
            
            if (hasIdentityConfusion) {
                return { isValid: false, reason: '回應中混淆了角色身份' };
            }
            
            // 其他情況都認為是正常的
            return { isValid: true, reason: '身份檢查通過' };
        }
        
        // 後處理AI回應：替換英文省略號為中文省略號
        function postProcessAIResponse(response) {
            if (!response || typeof response !== 'string') {
                return response;
            }
            
            // 替換各種英文省略號格式為中文省略號
            let processed = response
                // 替換連續的3個或更多點為中文省略號
                .replace(/\.{3,}/g, '……')
                // 替換連續的2個點為中文省略號
                .replace(/\.{2}/g, '……')
                // 替換句子末尾的單個點為中文省略號（但保留正常的句號）
                .replace(/([^。！？；.!?;])\s*\.\s*$/g, '$1……')
                // 替換句子中間的單個點為中文省略號（但避免替換正常的句號）
                .replace(/([^。！？；.!?;])\s*\.\s*([^。！？；.!?;])/g, '$1……$2')
                // 處理特殊情況：替換"..."為"……"
                .replace(/\.\.\./g, '……')
                // 處理特殊情況：替換".."為"……"
                .replace(/\.\./g, '……');
            
            // 只有在有實際替換時才輸出日誌
            if (processed !== response) {
                console.log('後處理完成 - 原文:', response);
                console.log('後處理完成 - 處理後:', processed);
            }
            
            return processed;
        }
        
        // 分析對話上下文（僅限當前群組內）
        function analyzeConversationContext(userMessage, activeCharacters) {
            const recentMessages = groupChatContext.messages.slice(-6); // 最近6條消息
            const context = {
                lastSpeaker: null,
                userIntent: null
            };
            
            // 找出最後一個說話的角色（僅限當前群組成員）
            for (let i = recentMessages.length - 1; i >= 0; i--) {
                const msg = recentMessages[i];
                if (msg.character && msg.character !== 'user' && activeCharacters.includes(msg.character)) {
                    context.lastSpeaker = msg.character;
                    break;
                }
            }
            
            // 分析用戶意圖
            if (userMessage.includes('請講') || userMessage.includes('繼續') || userMessage.includes('說說')) {
                context.userIntent = 'continue_conversation';
            } else if (userMessage.includes('為什麼') || userMessage.includes('怎麼') || userMessage.includes('如何')) {
                context.userIntent = 'ask_question';
            } else if (userMessage.includes('嗯') || userMessage.includes('對') || userMessage.includes('是的')) {
                context.userIntent = 'agree';
            } else if (userMessage.includes('不') || userMessage.includes('不同意') || userMessage.includes('我覺得')) {
                context.userIntent = 'disagree_or_comment';
            }
            
            console.log('對話上下文分析:', {
                lastSpeaker: context.lastSpeaker ? characters[context.lastSpeaker].name : '無',
                userIntent: context.userIntent
            });
            
            return context;
        }
        
        // 根據上下文選擇角色（僅限當前群組內）
        function selectCharactersByContext(context, activeCharacters) {
            const characterScores = {};
            
            // 初始化所有角色的分數
            activeCharacters.forEach(charId => {
                characterScores[charId] = 0;
            });
            
            // 1. 對話連續性加分（如果用戶在延續與某個角色的對話）
            if (context.lastSpeaker && context.userIntent === 'continue_conversation') {
                characterScores[context.lastSpeaker] += 50; // 高優先級
                console.log(`對話連續性：${characters[context.lastSpeaker].name} +50分`);
            }
            
            // 2. 提問時，優先讓最後說話的角色回答
            if (context.lastSpeaker && context.userIntent === 'ask_question') {
                characterScores[context.lastSpeaker] += 40;
                console.log(`提問回應：${characters[context.lastSpeaker].name} +40分`);
            }
            
            // 3. 角色活躍度平衡（避免某個角色過度發言）
            const recentSpeakers = getRecentSpeakers(5, activeCharacters);
            recentSpeakers.forEach(charId => {
                if (characterScores[charId]) {
                    characterScores[charId] -= 15; // 減分避免過度發言
                    console.log(`活躍度平衡：${characters[charId].name} -15分`);
                }
            });
            
            // 4. 隨機因子（增加多樣性）
            Object.keys(characterScores).forEach(charId => {
                characterScores[charId] += Math.random() * 10;
            });
            
            // 選擇分數最高的角色
            const sortedCharacters = Object.entries(characterScores)
                .sort(([,a], [,b]) => b - a);
            
            console.log('角色分數排名:', sortedCharacters.map(([id, score]) => 
                `${characters[id].name}: ${score}分`
            ));
            
            // 返回1-2個角色
            const responseCount = Math.random() < 0.7 ? 1 : 2;
            return sortedCharacters.slice(0, responseCount).map(([charId]) => charId);
        }
        
        // 獲取最近發言的角色（僅限當前群組成員）
        function getRecentSpeakers(count = 5, activeCharacters = null) {
            const recentMessages = groupChatContext.messages.slice(-count);
            const speakers = [];
            recentMessages.forEach(msg => {
                if (msg.character && msg.character !== 'user' && !speakers.includes(msg.character)) {
                    // 如果指定了activeCharacters，只包含群組內的成員
                    if (!activeCharacters || activeCharacters.includes(msg.character)) {
                        speakers.push(msg.character);
                    }
                }
            });
            return speakers;
        }
        
        // 提取@提及
        function extractMentions(userMessage) {
            const mentions = [];
            Object.keys(characters).forEach(charId => {
                const character = characters[charId];
                if (character && userMessage.includes(`@${character.name}`)) {
                    mentions.push({ id: charId, name: character.name });
                }
            });
            return mentions;
        }
        
        // 隨機選擇角色（備用方案，僅限當前群組）
        function getRandomCharacters() {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            if (!currentGroup) {
                console.warn('當前群組不存在，無法隨機選擇角色');
                return [];
            }
            
            const activeCharacters = currentGroup.members.filter(id => 
                characters[id] && id !== 'user'
            );
            
            if (activeCharacters.length === 0) {
                console.warn('當前群組沒有可用的角色');
                return [];
            }
            
            const responseCount = Math.random() < 0.7 ? 1 : 2;
            const shuffled = activeCharacters.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, responseCount);
        }

        // 生成AI角色间的互动回应
        function generateCharacterInteraction(characterKey, previousResponses, userMessage) {
            const character = characters[characterKey];
            if (!character) return '';
            
            // 基于前面角色的回应生成互动内容
            const lastResponse = previousResponses[previousResponses.length - 1];
            if (!lastResponse) return '';
            
            const interactionPrompts = {
                libai: [
                    `听了${lastResponse.characterName}的话，哈哈！`,
                    `${lastResponse.characterName}说得好！李某深以为然。`,
                    `妙哉！${lastResponse.characterName}此言甚有见地。`
                ],
                dufu: [
                    `${lastResponse.characterName}所言极是，深有同感。`,
                    `听君一席话，胜读十年书。`,
                    `${lastResponse.characterName}这话让我想起了往昔。`
                ],
                taoyuanming: [
                    `${lastResponse.characterName}说得是，心远地自偏。`,
                    `同感，此中有真意，欲辨已忘言。`,
                    `${lastResponse.characterName}的话让我想起田园之乐。`
                ],
                wangwei: [
                    `阿弥陀佛，${lastResponse.characterName}此言颇有禅意。`,
                    `${lastResponse.characterName}说得对，山水有情，诗画同源。`,
                    `善哉，${lastResponse.characterName}所言令人深思。`
                ],
                change: [
                    `在月宫听到${lastResponse.characterName}这话，甚有感触。`,
                    `${lastResponse.characterName}的话让我想起人间往事。`,
                    `广寒宫中，难得听到如此佳言。`
                ]
            };
            
            const interactions = interactionPrompts[characterKey] || [
                `${lastResponse.characterName}说得有道理。`,
                `听了${lastResponse.characterName}的话，深有感触。`
            ];
            
            return interactions[Math.floor(Math.random() * interactions.length)];
        }

        // 生成安全的AI回應（優化版本：兩次API調用）
        async function generateSafeAIResponses(userMessage, mentions = []) {
            // 獲取當前群組配置
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            console.log(`當前群組: ${groupManager.currentGroup}`, currentGroup);
            
            if (!currentGroup) {
                console.error(`群組 ${groupManager.currentGroup} 不存在`);
                return;
            }
            
            // 從當前群組成員中選擇，排除用戶自己
            const activeCharacters = currentGroup.members.filter(id => {
                const hasCharacter = characters[id];
                const notUser = id !== 'user';
                
                if (!hasCharacter) {
                    console.warn(`成員 ${id} 沒有在 characters 中定義，跳過`);
                }
                
                return hasCharacter && notUser;
            });
            
            console.log(`群組 ${currentGroup.name} 可回應的角色:`, activeCharacters.map(id => `${characters[id].name}(${id})`));
            
            if (activeCharacters.length === 0) {
                console.warn('沒有可回應的角色');
                return;
            }
            
            // 使用智能規則選擇1-3個角色
            console.log('使用智能規則選擇回應角色...');
            // 先根據@與人名的帶位置提及，決定優先順序（@ 提及優先，按出現位置排序；其次是無@的人名順序）
            const atMentions = extractAtMentionsWithPos(userMessage, activeCharacters);
            const nameMentions = detectCharacterMentionsWithPos(userMessage, activeCharacters);
            const orderedByMention = [];
            const added = new Set();
            atMentions.forEach(m => { if (!added.has(m.id)) { orderedByMention.push(m.id); added.add(m.id); } });
            nameMentions.forEach(m => { if (!added.has(m.id)) { orderedByMention.push(m.id); added.add(m.id); } });

            let selectedCharacters;
            if (orderedByMention.length >= 2) {
                // 同一句命中≥2：第一個給第一次API、第二個給第二次API（保持你的一輪兩調用設計）
                selectedCharacters = orderedByMention.slice(0, 2);
            } else if (orderedByMention.length === 1) {
                // 命中1人：第一位固定為該人，第二位交給智能規則補足（避免兩位都是同一人）
                const pool = activeCharacters.filter(id => id !== orderedByMention[0]);
                const fallback = useIntelligentRuleBasedSelection(userMessage, pool);
                selectedCharacters = [orderedByMention[0], ...(fallback.slice(0,1)||[])].filter(Boolean);
            } else {
                // 無明確提及：退回原有智能規則
                selectedCharacters = useIntelligentRuleBasedSelection(userMessage, activeCharacters);
            }
            
            console.log('規則選擇的角色:', selectedCharacters.map(id => characters[id].name));
            
            if (!selectedCharacters || selectedCharacters.length === 0) {
                console.warn('沒有選中任何角色');
                return;
            }
            
            try {
                // 驗證上下文傳遞
                validateContextFlow(userMessage, selectedCharacters);
                
                                // 立即進行第一次API調用（後臺進行，無延遲）
                console.log('=== 第一次API調用：生成第一個角色回應 ===');
                const firstCharacterResponsePromise = generateFirstCharacterResponse(selectedCharacters[0], userMessage);
                
                // 延遲2秒後顯示第一個角色的打字動畫
                setTimeout(async () => {
                    console.log('開始顯示第一個角色的打字動畫...');
                    console.log('選中的角色ID:', selectedCharacters[0]);
                    console.log('角色對象:', characters[selectedCharacters[0]]);
                    showTypingAnimation(selectedCharacters[0]);
                    console.log('第一個角色打字動畫已顯示');
                    
                    // 等待API返回後顯示回應
                    const firstCharacterResponse = await firstCharacterResponsePromise;
                await displayCharacterResponse(selectedCharacters[0], firstCharacterResponse);
                
                    // 第一個角色分段顯示完成後，如果有更多角色，延遲2-2.5秒顯示第二個角色的打字動畫
                if (selectedCharacters.length > 1) {
                    const remainingCharacters = selectedCharacters.slice(1);
                        
                        console.log('第一個角色分段顯示完成，延遲2-2.5秒後顯示第二個角色打字動畫');
                        
                        // 延遲2-2.5秒後顯示第二個角色的打字動畫
                        setTimeout(async () => {
                            console.log('開始顯示第二個角色的打字動畫...');
                    showTypingAnimation(remainingCharacters[0]);
                            console.log('第二個角色打字動畫已顯示');
                            
                            // 等待API返回後顯示回應
                            const remainingResponses = await window.remainingResponsesPromise;
                    await displayRemainingCharactersResponses(remainingCharacters, remainingResponses);
                        }, 2000 + Math.random() * 500); // 2-2.5秒延遲
                    }
                }, 2000);
                
                // 如果有更多角色，在第一個角色API返回後立即進行第二次API調用
                if (selectedCharacters.length > 1) {
                    const remainingCharacters = selectedCharacters.slice(1);
                    
                    // 等待第一個角色API返回後，立即進行第二次API調用（Promise）
                setTimeout(async () => {
                        // 等待第一個角色API返回
                        const firstCharacterResponse = await firstCharacterResponsePromise;
                        console.log('第一個角色API返回，立即開始第二次API調用');
                        
                        // 立即進行第二次API調用（後臺進行，無延遲）
                        console.log('=== 第二次API調用：生成剩餘角色互動式回應 ===');
                        const remainingResponsesPromise = generateRemainingCharactersResponse(
                            remainingCharacters, 
                            firstCharacterResponse, 
                            userMessage
                        );
                        
                        // 將Promise保存到全局變量，供第一個角色分段顯示完成後使用
                        window.remainingResponsesPromise = remainingResponsesPromise;
                    }, 100); // 短暫延遲確保第一個角色流程開始
                }
                

                
            } catch (error) {
                console.error('AI回應生成失敗:', error);
                // 顯示網絡錯誤，不使用假回應
                            addMessage({
                                type: 'message',
                    character: 'system',
                    content: '❌ 網絡連接異常，請檢查網絡後重試',
                                contentType: 'text'
                            });
            }
        }
        
        // 生成AI回應（原版本，向後兼容）
        // 生成AI回應（原版本，已刪除）
        // 注意：此函數已被刪除，統一使用 generateSafeAIResponses



        // 聊天輸入功能
        function setupChatInput() {
            const inputBox = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (inputBox) {
                // 確保輸入框可以交互
                inputBox.style.pointerEvents = 'auto';
                inputBox.disabled = false;
                
                // 移動端優化：防止輸入時頁面縮放
                inputBox.addEventListener('focus', function() {
                    // 防止移動端輸入時頁面縮放
                    if (window.innerWidth <= 768) {
                        // 延遲執行，確保在鍵盤彈出後執行
                        setTimeout(() => {
                            window.scrollTo(0, 0);
                            document.body.style.position = 'fixed';
                            document.body.style.width = '100%';
                        }, 100);
                    }
                    
                    // 關閉emoji和功能面板，但不關閉@面板（輸入框獲得焦點時可能正在@某人）
                    document.getElementById('emojiPanel').style.display = 'none';
                    document.getElementById('functionPanel').style.display = 'none';
                    
                    // 更新發送按鈕狀態
                    updateSendButtonState();
                });
                
                // 輸入框失去焦點時恢復頁面狀態
                inputBox.addEventListener('blur', function() {
                    if (window.innerWidth <= 768) {
                        document.body.style.position = '';
                        document.body.style.width = '';
                    }
                });
                
                // 回車發送
                inputBox.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendUserMessage();
                    }
                });
                
                // 添加點擊事件確保輸入框可以被點擊
                inputBox.addEventListener('click', function(e) {
                    console.log('輸入框被點擊');
                    this.focus();
                });
                
                // 添加input事件監聽，支持@功能和發送按鈕狀態更新
                const handleInput = throttle(function(e) {
                    // 只在群聊模式下處理@功能
                    if (!isPrivateChatMode()) {
                        handleMentionInput(inputBox);
                    }
                    updateSendButtonState();
                }, 120);
                inputBox.addEventListener('input', handleInput);
                
                // 處理鍵盤事件
                inputBox.addEventListener('keydown', function(e) {
                    // ESC鍵隱藏@面板
                    if (e.key === 'Escape' && mentionState.isActive) {
                        e.preventDefault();
                        hideMentionPopup();
                    }
                    // 上下箭頭選擇@列表項（可以後續添加）
                });
                
                // 測試輸入框是否可見和可交互
                const rect = inputBox.getBoundingClientRect();
                console.log('輸入框位置和尺寸:', rect);
                console.log('輸入框樣式:', {
                    pointerEvents: window.getComputedStyle(inputBox).pointerEvents,
                    display: window.getComputedStyle(inputBox).display,
                    visibility: window.getComputedStyle(inputBox).visibility,
                    zIndex: window.getComputedStyle(inputBox).zIndex
                });
                
                console.log('輸入框事件監聽器已設置');
            } else {
                console.error('找不到messageInput元素');
            }
            
            // 設置發送按鈕事件
            if (sendBtn) {
                sendBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    sendUserMessage();
                });
                
                // 初始化發送按鈕狀態
                updateSendButtonState();
                
                console.log('發送按鈕事件監聽器已設置');
            } else {
                console.error('找不到sendBtn元素');
            }
        }
        
        // 更新發送按鈕狀態
        function updateSendButtonState() {
            const inputBox = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (inputBox && sendBtn) {
                const hasContent = inputBox.value.trim().length > 0;
                sendBtn.disabled = !hasContent;
                
                // 視覺反饋現在由CSS控制
                // 有內容時：綠色且可點擊
                // 無內容時：灰色且禁用
            }
        }
        
        // 移動端視口優化
        function optimizeMobileViewport() {
            if (window.innerWidth <= 768) {
                const applyVh = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                applyVh();
                const onResize = throttle(applyVh, 150);
                // 全域保存與釋放，避免重複綁定
                try {
                    if (window.__mobileVhResizeHandler) {
                        window.removeEventListener('resize', window.__mobileVhResizeHandler);
                    }
                } catch(e) {}
                window.__mobileVhResizeHandler = onResize;
                window.addEventListener('resize', window.__mobileVhResizeHandler);
            }
        }
        
        // 防止移動端雙擊縮放
        function preventDoubleTapZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // 添加用戶消息到群聊上下文
        function addUserMessageToGroupContext(userMessage) {
            if (!isPrivateChatMode()) {
                const userMessageObj = {
                    role: 'user',
                    content: userMessage,
                    character: 'user',
                    characterName: '我',
                    timestamp: Date.now()
                };
                
                groupChatContext.messages.push(userMessageObj);
                groupChatContext.lastUpdateTime = Date.now();
                
                // 限制群聊上下文長度
                if (groupChatContext.messages.length > groupChatContext.maxContextLength) {
                    groupChatContext.messages.splice(0, groupChatContext.messages.length - groupChatContext.maxContextLength);
                }
                
                console.log('用戶消息已添加到群聊上下文，總長度:', groupChatContext.messages.length);
            }
        }

        // 發送用戶消息（增強安全性）
        function sendUserMessage() {
            const inputBox = document.getElementById('messageInput');
            if (!inputBox) return;
            
            const message = inputBox.value.trim();
            if (!message) return;
            
            // 安全性檢查
            const safetyCheck = safetyFilter.checkUserInput(message);
            
            if (!safetyCheck.safe) {
                // 顯示安全提示
                addMessage({
                    type: 'system',
                    content: `${safetyCheck.suggestion} 我們一起探索中華文化的魅力吧！`
                });
                inputBox.value = '';
                return;
            }
            
            // 如果有警告，顯示引導提示
            if (safetyCheck.warning) {
                addMessage({
                    type: 'system',
                    content: `${safetyCheck.note}，讓我們從文學的角度來聊聊這個話題。`
                });
            }
            
            // 檢查是否為私聊模式
            const isPrivateChat = isPrivateChatMode();
            let mentions = [];
            let hasAtMentions = false;
            
            if (!isPrivateChat) {
                // 群聊模式：提取@提及的角色
                mentions = extractMentions(message);
                console.log('消息中的@提及:', mentions);
                hasAtMentions = mentions.length > 0;
            }
            
            // 添加用戶消息到聊天（群聊時高亮@提及）
            addMessage({
                type: 'user',
                character: 'user',
                content: hasAtMentions ? highlightMentions(message) : message,
                contentType: 'text',
                isHtml: hasAtMentions,
                originalContent: message // 保存原始消息內容到歷史記錄
            });
            
            // 更新多輪對話上下文
            addUserMessageToGroupContext(message);
            
            // 清空輸入框
            inputBox.value = '';
            
            // 更新發送按鈕狀態
            updateSendButtonState();
            
            // 隱藏@面板
            hideMentionPopup();
            
            // 音效已移除
            
            // 使用requestAnimationFrame優化滾動到底部
            PerformanceUtils.scheduleUpdate(() => {
                const chatContainer = PerformanceUtils.getCachedElement('#chatMessages');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    // 確保滾動到真正的底部
                    PerformanceUtils.scheduleUpdate(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                }
            });
            
            // 触发AI回应
            if (isPrivateChat) {
                // 私聊模式：延迟1秒显示对方正在输入的动画
                const characterId = getPrivateChatCharacterId();
                if (characterId) {
                    setTimeout(() => {
                        showTypingAnimation(characterId);
                    }, 1000);
                }
                generatePrivateChatResponse(message);
            } else {
                // 群聊模式：立即生成AI回应（打字動畫在generateSafeAIResponses中處理）
                generateSafeAIResponses(message, mentions);
            }
            
            // 延遲刷新聊天列表（讓AI回應也被保存）
            setTimeout(() => {
                if (typeof mainInterface !== 'undefined') {
                    mainInterface.refreshChatList();
                }
            }, 2000);
        }









       

        

        
        // 動態更新群組詳情內容
        function updateGroupDetailsContent() {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            if (!currentGroup) return;
            
            console.log(`更新群組詳情: ${currentGroup.name}`);
            
            // 更新群組名稱 - 使用更精確的選擇器
            const groupNameElement = document.querySelector('.detail-item:first-child .detail-item-value');
            if (groupNameElement) {
                const memberCount = currentGroup.members.length;
                groupNameElement.innerHTML = `
                    ${currentGroup.name}（${memberCount}人）
                    <span class="detail-arrow">›</span>
                `;
            }
            
            // 更新群公告
            const groupAnnouncementElement = document.querySelector('#groupAnnouncement .detail-item-value div');
            if (groupAnnouncementElement) {
                groupAnnouncementElement.textContent = getGroupAnnouncement(groupManager.currentGroup);
            }
            
            // 動態生成群組成員列表
            updateGroupMembersList();
        }
        
        // 獲取群組公告
        function getGroupAnnouncement(groupId) {
            const announcements = {
                'poets_group': `【詩人群•群規】
1. 以文會友，以詩論道📚
2. 尊重經典，傳承文化🎭
3. 新人加群，須自我介紹📝
4. 文明討論，理性交流💬
5. 分享心得，共同學習📖
6. 定期舉辦文學沙龍🎪
7. 歡迎提問，互相解答❓

本群致力於中華古典文學的學習與交流，歡迎各位文學愛好者！`,
                
                'history_group': `【史記群•群規】
1. 以史為鑑，知古鑑今📜
2. 客觀記述，不偏不倚⚖️
3. 史料為證，言必有據📝
4. 尊重史實，拒絕杜撰🚫
5. 分析因果，探討得失🔍
6. 學習史法，傳承文明📚
7. 史學討論，理性交流💭

史者，記也。以史為鑑，知興替得失！`,
                
                'philosophy_group': `【聞道群•群規】
1. 修身齊家，格物致知📖
2. 仁者愛人，智者知人💛
3. 道法自然，無為而治🌿
4. 有教無類，因材施教👨‍🎓
5. 思辨求真，啟發智慧💡
6. 和而不同，求同存異🤝
7. 聞道朝夕，學而時習📚

道可道，非常道。與諸位共參天道人理！`,
                
                'mystery_group': `【怪力亂神群•群規】
1. 神話傳說，奇聞異事👻
2. 想像豐富，文學創作📝
3. 尊重傳統，傳承文化🎭
4. 寓教於樂，啟發思考💭
5. 禁止迷信，理性討論🚫
6. 文明交流，和諧共處🤝
7. 分享故事，共賞奇聞📚

子不語怪力亂神，但我們專門討論！歡迎分享奇聞異事！`,
                
                'dahua_group': `【大觀園業主群•群規】
1. 紅樓夢故事，人物交流🏛️
2. 詩詞歌賦，文學創作📝
3. 大觀園生活，情感抒發💕
4. 尊重原著，傳承文化📚
5. 文明討論，理性交流💬
6. 分享心得，共同學習📖
7. 歡迎提問，互相解答❓

大觀園中，與諸位紅樓人物共賞詩詞，暢談人生！`,
                
                'ci_poets_group': `【詞人群•群規】
1. 詞學創作，音律格律📝
2. 情感表達，詞牌探討🎵
3. 婉約豪放，各有所長🌸
4. 尊重經典，傳承文化📚
5. 文明討論，理性交流💬
6. 分享心得，共同學習📖
7. 歡迎提問，互相解答❓

詞者，詩之餘也。與諸位詞人共賞詞章，暢談音律！`
            };
            
            return announcements[groupId] || '歡迎加入本群！請遵守群組規則，文明交流。';
        }
        
        // 更新群組成員列表
        function updateGroupMembersList() {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            if (!currentGroup) return;
            
            const membersGrid = document.querySelector('.group-members-grid');
            if (!membersGrid) return;
            
            // 清空現有成員
            membersGrid.innerHTML = '';
            
            // 添加當前群組的成員
            currentGroup.members.forEach(memberId => {
                const character = characters[memberId];
                if (character) {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.setAttribute('data-character', memberId);
                    
                    const memberAvatar = document.createElement('div');
                    memberAvatar.className = 'member-avatar';
                    memberAvatar.textContent = character.avatar;
                    memberAvatar.style.cursor = 'pointer';
                    memberAvatar.style.transition = 'transform 0.2s';
                    
                    const memberName = document.createElement('div');
                    memberName.className = 'member-name';
                    memberName.textContent = character.name;
                    
                    memberItem.appendChild(memberAvatar);
                    memberItem.appendChild(memberName);
                    
                    // 添加統一的頭像點擊事件
                    memberItem.addEventListener('click', function(e) {
                        console.log('群組成員頭像被點擊:', memberId);
                        // 使用統一的頭像點擊處理函數
                        handleAvatarClick(memberId, e);
                    });
                    
                    // 添加懸停效果
                    memberAvatar.addEventListener('mouseenter', function() {
                        this.style.transform = 'scale(1.1)';
                    });
                    
                    memberAvatar.addEventListener('mouseleave', function() {
                        this.style.transform = 'scale(1)';
                    });
                    
                    membersGrid.appendChild(memberItem);
                }
            });
            
            // 添加邀請按鈕
            const inviteItem = document.createElement('div');
            inviteItem.className = 'member-item';
            inviteItem.innerHTML = `
                <div class="member-avatar" style="background-color:#f1f1f1;font-size:22px">+</div>
                <div class="member-name">邀請</div>
            `;
            membersGrid.appendChild(inviteItem);
        }
        
        // 更新私聊詳情內容
        function updatePrivateChatDetailsContent() {
            const currentGroupId = groupManager.currentGroup;
            if (!currentGroupId || !currentGroupId.startsWith('private_')) return;
            
            // 提取角色ID
            const characterId = currentGroupId.replace('private_', '');
            const character = characters[characterId];
            if (!character) return;
            
            console.log('更新私聊詳情:', character.name);
            
            // 更新頭像和名稱
            const avatarElement = document.getElementById('privateChatAvatar');
            const nameElement = document.getElementById('privateChatUserName');
            
            if (avatarElement) {
                avatarElement.textContent = character.avatar;
                // 添加角色ID作為數據屬性，方便點擊事件獲取
                avatarElement.setAttribute('data-character-id', characterId);
            }
            
            if (nameElement) {
                nameElement.textContent = character.name;
            }
        }
        
        // 群組列表交互設置
        function setupGroupListInteractions() {
            // 打開群組列表
            const openGroupListBtn = document.getElementById('openGroupListBtn');
            if (openGroupListBtn) {
                openGroupListBtn.addEventListener('click', function() {
                    groupListManager.openGroupList();
                });
            } else {
                console.warn('openGroupListBtn 元素不存在');
            }
            
            // 關閉群組列表
            const closeGroupList = document.getElementById('closeGroupList');
            if (closeGroupList) {
                closeGroupList.addEventListener('click', function() {
                    groupListManager.closeGroupList();
                });
            } else {
                console.warn('closeGroupList 元素不存在');
            }
            
            // 點擊群組列表背景關閉
            const groupListPage = document.getElementById('groupListPage');
            if (groupListPage) {
                groupListPage.addEventListener('click', function(e) {
                    if (e.target === this) {
                        groupListManager.closeGroupList();
                    }
                });
            } else {
                console.warn('groupListPage 元素不存在');
            }
        }
        
        // 群組詳情和成員資料頁面交互
        function setupUIInteractions() {
            // 輸入框點擊事件已移除（改為自由聊天模式）
            
            // 打開群組詳情頁面或私聊詳情頁面
            const openGroupDetailsBtn = document.getElementById('openGroupDetails');
            if (openGroupDetailsBtn) {
                openGroupDetailsBtn.addEventListener('click', function() {
                    console.log('詳情按鈕被點擊');
                    
                    // 檢查是否為私聊模式
                    if (isPrivateChatMode()) {
                        // 私聊模式：打開私聊詳情頁面
                        console.log('打開私聊詳情頁面');
                        updatePrivateChatDetailsContent();
                        pageHistory.pushPage('privateChatDetailsPage');
                        pageHistory.showPage('privateChatDetailsPage');
                    } else {
                        // 群聊模式：打開群組詳情頁面
                        console.log('打開群組詳情頁面');
                        updateGroupDetailsContent();
                        pageHistory.pushPage('groupDetailsPage');
                        pageHistory.showPage('groupDetailsPage');
                    }
                });
            } else {
                console.error('找不到openGroupDetails按鈕');
            }
            
            // 關閉群組詳情頁面
            document.getElementById('closeGroupDetails').addEventListener('click', function() {
                console.log('关闭群组详情页面');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
            });
            
            // 關閉私聊詳情頁面
            document.getElementById('closePrivateChatDetails').addEventListener('click', function() {
                console.log('关闭私聊详情页面');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
            });
            
            // 成員頭像點擊事件（已移至動態創建時添加）
            
            // 關閉成員資料頁面
            document.getElementById('closeMemberProfile').addEventListener('click', function() {
                console.log('关闭个人资料页面');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
                
                // 清理状态
                currentViewingCharacterId = null;
            });
            
            // 查看朋友圈
            document.getElementById('viewMoments').addEventListener('click', function() {
                console.log('朋友圈按钮被点击');
                // 获取当前查看的角色ID
                const currentCharacterId = getCurrentViewingCharacterId();
                console.log('当前角色ID:', currentCharacterId);
                if (currentCharacterId) {
                    console.log('准备打开角色朋友圈:', currentCharacterId);
                    // 打开该角色的朋友圈
                    momentsManager.openCharacterMoments(currentCharacterId);
                }
            });
            
            // 傳訊息按鈕點擊事件
            document.querySelector('.action-message-btn').addEventListener('click', function() {
                const currentCharacterId = getCurrentViewingCharacterId();
                if (currentCharacterId) {
                    // 開始與該角色的私聊
                    startPrivateChat(currentCharacterId);
                }
            });
            
            // 關閉朋友圈
            document.getElementById('closeMoments').addEventListener('click', function() {
                document.getElementById('momentsPage').style.display = 'none';
            });
            
            // 設置私聊詳情頁面的切換開關
            const toggleSwitches = document.querySelectorAll('.private-toggle-switch');
            toggleSwitches.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
            
            // 設置私聊詳情頁面的用戶頭像點擊事件
            const privateChatAvatar = document.getElementById('privateChatAvatar');
            if (privateChatAvatar) {
                privateChatAvatar.addEventListener('click', function(e) {
                    const characterId = this.getAttribute('data-character-id');
                    if (characterId) {
                        console.log('私聊詳情頁面頭像被點擊:', characterId);
                        // 使用統一的頭像點擊處理函數
                        handleAvatarClick(characterId, e);
                    }
                });
                
                // 添加懸停效果樣式
                privateChatAvatar.style.cursor = 'pointer';
                privateChatAvatar.style.transition = 'transform 0.2s, box-shadow 0.2s';
                
                privateChatAvatar.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)';
                });
                
                privateChatAvatar.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = 'none';
                });
            }
            
            // 創建統一的頭像點擊處理函數
            window.handleAvatarClick = function(characterId, event) {
                if (!characterId || characterId === 'user') {
                    console.log('跳過用戶自己的頭像點擊');
                    return;
                }
                
                console.log('統一頭像點擊處理:', characterId);
                
                // 檢查Shift鍵是否被按住（僅在群聊模式下有效）
                if (event && event.shiftKey && !isPrivateChatMode()) {
                    // Shift + 點擊：@該角色（僅限群聊）
                    mentionCharacter(characterId);
                } else {
                    // 普通點擊：打開角色詳情頁面
                    openProfilePage(characterId);
                }
            };
            
            // 設置聊天頭像點擊事件委託
            document.getElementById('chatMessages').addEventListener('click', function(e) {
                // 檢查是否點擊的是頭像
                let target = e.target;
                while (target && target !== this) {
                    if (target.classList.contains('wx-avatar')) {
                        const messageDiv = target.closest('.wx-msg');
                        if (messageDiv) {
                            // 確定角色ID
                            let characterId;
                            if (messageDiv.classList.contains('wx-msg-self')) {
                                // 用戶自己的頭像，跳過
                                return;
                            } else {
                                // 嘗試從名稱獲取角色ID
                                const nameElement = messageDiv.querySelector('.wx-name');
                                if (nameElement) {
                                    const name = nameElement.textContent.trim();
                                    // 通過名稱找到角色ID
                                    for (const id in characters) {
                                        if (characters[id].name === name) {
                                            characterId = id;
                                            break;
                                        }
                                    }
                                }
                            }
                            
                            if (characterId) {
                                // 使用統一的頭像點擊處理函數
                                handleAvatarClick(characterId, e);
                            }
                        }
                        break;
                    }
                    target = target.parentNode;
                }
            });
        }
        
        // 添加角色個性簽名數據
        const characterSignatures = {
            libai: "謫仙人也，筆落驚風雨，詩成泣鬼神",

            taoyuanming: "採菊東籬下，悠然見南山",
            liuling: "人生得意須盡歡，莫使金樽空對月",

            dufu: "安得廣廈千萬間，大庇天下寒士俱歡顏",
            ligui: "一曲入心，千古絕響，宮廷樂師No.1",
            yutu: "搗藥4827年打工兔，主人不在家偷吃蘿蔔",
            change: "廣寒宮主，孤寂千年，最美不過人間煙火",

            yuzhen: "唐室皇妹，鍾愛詩文佛道，招募修行者ing",
            wangwei: "詩佛在此，畫中有詩詩中有禪",
            caozhi: "曹魏陳王，三國第一才子，年少多金勿擾",
            xiwangmu: "蟠桃盛會主持人，三千年一開，感興趣的私聊",
            yangguifei: "天生麗質難自棄，國色天香惹人憐",
            menghaoran: "襄陽老農，無事種田，偶爾賦詩",
            
            // 詞人群角色簽名
            liuyong: "詞壇三變，慢詞長調開先河，奉旨填詞柳三變",
            liqingzhao: "千古第一才女，人比黃花瘦，詞心如蘭",
            sushi: "東坡居士，大江東去浪淘盡，豪放詞祖",
            xinqiji: "稼軒詞客，醉裡挑燈看劍，氣吞萬里如虎",
            jiangkui: "白石道人，音律精妙，詞中有音樂之美",
            liyu: "南唐詞帝，春花秋月何時了，亡國君王哀婉詞",
            zhoubanyan: "詞家之冠，格律嚴謹，集大成者",
            yanjidao: "小山詞人，當時年少春衫薄，清新婉約",
            wuwenying: "夢窗詞客，綿密深豔，意象飛舞",
            chenweisong: "迦陵詞豪，清代第一詞手，縱橫捭闔",
            zhuyizun: "竹垞詞宗，浙西派領袖，復古求雅",
            nalanxingde: "滿洲貴公子，家家爭唱飲水詞，情真意切"
        };

        // 開始私聊功能
        function startPrivateChat(characterId) {
            const character = characters[characterId];
            if (!character) {
                console.error('角色不存在:', characterId);
                return;
            }
            
            console.log('開始與角色私聊:', character.name);
            
            // 清理當前對話上下文，為私聊做準備
            clearConversationContext();
            
            // 創建或切換到私聊"群組"
            const privateChatId = `private_${characterId}`;
            
            // 創建臨時私聊群組配置
            if (!CONFIG.groups[privateChatId]) {
                CONFIG.groups[privateChatId] = {
                    id: privateChatId,
                    name: character.name,
                    description: `與${character.name}的私人對話`,
                    theme: '私人對話',
                    owner: characterId,
                    members: ['user', characterId],
                    maxMembers: 2,
                    isActive: true,
                    isPrivateChat: true // 標記為私聊
                };
                
                // 更新聊天列表以顯示新的私聊
                if (typeof mainInterface !== 'undefined') {
                    mainInterface.generateChatList();
                }
            }
            
            // 設置當前群組為私聊
            groupManager.currentGroup = privateChatId;
            
            // 切換到聊天界面
            pageHistory.pushPage('chatContainer');
            pageHistory.showPage('chatContainer');
            
            // 設置聊天標題
            const groupTitle = document.querySelector('.wx-header-title');
            if (groupTitle) {
                groupTitle.textContent = character.name;
            }
            
            // 清空聊天記錄
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // 添加私聊歡迎消息
            setTimeout(() => {
                addMessage({
                    type: 'message',
                    character: characterId,
                    content: getPrivateChatWelcome(characterId),
                    contentType: 'text'
                });
            }, 500);
        }
        
        // 檢查是否為私聊模式
        function isPrivateChatMode() {
            // 安全檢查：確保 groupManager 已初始化
            if (typeof groupManager === 'undefined' || !groupManager) {
                console.warn('groupManager 未初始化，默認返回 false');
                return false;
            }
            
            const currentGroup = groupManager.currentGroup;
            return currentGroup && currentGroup.startsWith('private_');
        }
        
        // 清理和重置對話上下文
        function clearConversationContext() {
            // 清理群聊上下文
            groupChatContext.messages = [];
            groupChatContext.lastUpdateTime = Date.now();
            
            // 清理私聊上下文
            privateChatContext.clear();
            
            // 清理角色個性化歷史
            conversationHistory.clear();
            
            console.log('所有對話上下文已清理');
        }
        
        // 獲取群聊中的角色互動建議
        function getGroupInteractionSuggestions(characterKey, recentMessages) {
            const character = characters[characterKey];
            if (!character) return [];
            
            const suggestions = [];
            
            // 分析最近的消息，找出可以互動的機會
            recentMessages.forEach(msg => {
                if (msg.character && msg.character !== characterKey && msg.character !== 'user') {
                    const otherCharacter = characters[msg.character];
                    if (otherCharacter) {
                        // 根據角色特點生成互動建議
                        if (characterKey === 'libai' && msg.character === 'dufu') {
                            suggestions.push(`回應杜甫的憂國憂民情懷，展現你的豪邁詩風`);
                        } else if (characterKey === 'dufu' && msg.character === 'libai') {
                            suggestions.push(`對李白的豪放詩風表示讚賞，同時展現你的現實關懷`);
                        } else if (characterKey === 'change' && msg.character === 'yutu') {
                            suggestions.push(`與玉兔互動，展現月宮仙子的風範`);
                        } else if (characterKey === 'yutu' && msg.character === 'change') {
                            suggestions.push(`回應嫦娥的話語，展現你的可愛和忠誠`);
                        }
                    }
                }
            });
            
            return suggestions;
        }
        

        
        // 獲取私聊對象的角色ID
        function getPrivateChatCharacterId() {
            // 安全檢查：確保 groupManager 已初始化
            if (typeof groupManager === 'undefined' || !groupManager) {
                console.warn('groupManager 未初始化，無法獲取私聊對象ID');
                return null;
            }
            
            const currentGroup = groupManager.currentGroup;
            if (currentGroup && currentGroup.startsWith('private_')) {
                return currentGroup.replace('private_', '');
            }
            return null;
        }
        
        // 顯示角色正在輸入的動畫
        function showTypingAnimation(characterId) {
            console.log(`嘗試顯示角色 ${characterId} 的打字動畫...`);
            const character = characters[characterId];
            if (!character) {
                console.error(`角色 ${characterId} 不存在`);
                return;
            }
            
            console.log(`角色信息:`, character);
            
            // 檢查是否已經有打字動畫
            if (isTypingAnimationVisible(characterId)) {
                console.log(`${character.name} 的打字動畫已經顯示，跳過`);
                return;
            }
            
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) {
                console.error('找不到聊天容器元素');
                return;
            }
            
            console.log(`聊天容器找到:`, chatContainer);
            
            const typingElement = document.createElement('div');
            typingElement.className = `wx-msg wx-msg-others wx-fade-in typing-message-${characterId}`;
            
            typingElement.innerHTML = `
                <div class="wx-avatar-wrapper">
                    <div class="wx-name">${character.name}</div>
                    <div class="wx-avatar">
                        ${character.avatar}
                    </div>
                </div>
                <div class="wx-content-wrapper">
                    <div class="wx-typing" style="display: flex; align-items: center; max-width: 200px;">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span style="font-size: 12px; color: #999; margin-left: 8px;">正在輸入...</span>
                    </div>
                </div>
            `;
            
            console.log(`創建的打字動畫元素:`, typingElement);
            console.log(`打字動畫HTML:`, typingElement.innerHTML);
            
            chatContainer.appendChild(typingElement);
            console.log(`打字動畫元素已添加到DOM:`, typingElement);
            
            // 滾動到底部以顯示打字動畫
                chatContainer.scrollTop = chatContainer.scrollHeight;
            
            console.log(`成功顯示 ${character.name} 的打字動畫`);
        }
        
        // 檢查角色是否正在顯示打字動畫
        function isTypingAnimationVisible(characterId) {
            const typingElement = document.querySelector(`.typing-message-${characterId}`);
            return typingElement !== null;
        }
        
        // 顯示「正在輸入中」的通用動畫
        function showGeneralTypingAnimation() {
            // 移除現有的通用動畫
            removeGeneralTypingAnimation();
            
            const chatContainer = document.getElementById('chatMessages');
            const typingElement = document.createElement('div');
            typingElement.className = 'wx-system-msg wx-fade-in';
            typingElement.id = 'general-typing-animation';
            
            // 直接顯示「正在輸入...」
            typingElement.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    <span style="font-size: 12px; color: #999; margin-left: 4px;">正在輸入...</span>
                </div>
            `;
            
            chatContainer.appendChild(typingElement);
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            console.log('顯示通用「正在輸入中」動畫');
        }
        
        // 移除「正在輸入中」的通用動畫
        function removeGeneralTypingAnimation() {
            const generalTypingElement = document.getElementById('general-typing-animation');
            if (generalTypingElement) {
                generalTypingElement.remove();
                console.log('移除通用「正在輸入中」動畫');
            }
        }
        
        // 批量顯示多個角色的打字動畫（按順序依次顯示）
        function showTypingAnimationsForCharacters(characterList) {
            if (!Array.isArray(characterList) || characterList.length === 0) {
                return;
            }
            
            console.log(`準備按順序顯示 ${characterList.length} 個角色的打字動畫`);
            
            // 過濾有效的角色
            const validCharacters = characterList.filter(characterKey => 
                characters[characterKey] && !isTypingAnimationVisible(characterKey)
            );
            
            if (validCharacters.length === 0) {
                console.log('所有角色的打字動畫都已經顯示或角色無效');
                return;
            }
            
            // 按順序依次顯示打字動畫
            validCharacters.forEach((characterKey, index) => {
                const character = characters[characterKey];
                if (character) {
                    // 每個角色間隔1秒顯示，創造自然的依次回應效果
                    const delay = index * 1000; // 每個角色間隔1秒
                    
                    setTimeout(() => {
                        console.log(`顯示 ${character.name} 的打字動畫 (${index + 1}/${validCharacters.length})`);
                        showTypingAnimation(characterKey);
                    }, delay);
                }
            });
            
            console.log(`已安排按順序顯示 ${validCharacters.length} 個角色的打字動畫`);
        }
        
        // 移除角色的打字動畫
        function removeTypingAnimation(characterId) {
            const typingMessages = document.querySelectorAll(`.typing-message-${characterId}`);
            typingMessages.forEach(el => el.remove());
        }



        // 生成私聊回應
        async function generatePrivateChatResponse(userMessage) {
            console.log('=== 開始生成私聊回應 ===');
            console.log('用戶消息:', userMessage);
            
            let characterId = null;
            try {
                if (typeof getPrivateChatCharacterId === 'function') {
                    characterId = getPrivateChatCharacterId();
                }
            } catch (error) {
                console.warn('獲取私聊對象ID失敗:', error);
            }
            console.log('私聊對象ID:', characterId);
            
            if (!characterId || !characters[characterId]) {
                console.error('無法獲取私聊對象');
                return;
            }
            
            try {
                if (characters && characters[characterId]) {
            console.log(`私聊模式：${characters[characterId].name} 將回應消息`);
                } else {
                    console.warn('角色信息不存在');
                }
            } catch (error) {
                console.warn('獲取角色信息失敗:', error);
            }
            
            // 更新私聊上下文
            try {
                if (typeof privateChatContext !== 'undefined' && privateChatContext && typeof privateChatContext.get === 'function') {
                    const privateHistory = privateChatContext.get(characterId) || [];
                    const updatedPrivateHistory = [
                        ...privateHistory,
                        { role: 'user', content: userMessage }
                    ];
                    
                    // 限制私聊歷史長度
                    if (updatedPrivateHistory.length > 16) {
                        updatedPrivateHistory.splice(0, updatedPrivateHistory.length - 16);
                    }
                    
                    if (typeof privateChatContext.set === 'function') {
                        privateChatContext.set(characterId, updatedPrivateHistory);
                        console.log('私聊上下文已更新，長度:', updatedPrivateHistory.length);
                    }
                }
            } catch (error) {
                console.warn('更新私聊上下文失敗:', error);
            }
            
            // 安全性檢查
            try {
                if (typeof safetyFilter !== 'undefined' && safetyFilter && typeof safetyFilter.checkAIResponse === 'function') {
                const safetyResult = await safetyFilter.checkAIResponse(userMessage, characterId);
                console.log('安全檢查結果:', safetyResult);
                
                if (!safetyResult.safe) {
                    console.log('私聊消息被安全過濾器攔截');
                    return;
                    }
                }
            } catch (error) {
                console.error('安全檢查出錯:', error);
                // 繼續執行，不阻擋正常對話
            }
            
            // 生成AI回應
            console.log('開始生成AI回應...');
            let aiResponse = null;
            try {
                if (typeof generateAIResponse === 'function') {
                    aiResponse = await generateAIResponse(characterId, userMessage);
                } else {
                    console.warn('generateAIResponse 函數未定義，使用備用回應');
                    try {
                        if (characters && characters[characterId]) {
                            aiResponse = `我是${characters[characterId].name}，很高興與你交流！`;
                        } else {
                            aiResponse = '我是聊天助手，很高興與你交流！';
                        }
                    } catch (error) {
                        aiResponse = '我是聊天助手，很高興與你交流！';
                    }
                }
            } catch (error) {
                console.warn('生成AI回應失敗:', error);
                try {
                    if (characters && characters[characterId]) {
                        aiResponse = `我是${characters[characterId].name}，很高興與你交流！`;
                    } else {
                        aiResponse = '我是聊天助手，很高興與你交流！';
                    }
                } catch (backupError) {
                    aiResponse = '我是聊天助手，很高興與你交流！';
                }
            }
            console.log('生成的AI回應:', aiResponse);
            
            if (aiResponse && aiResponse.trim()) {
                // 添加角色回應（延長延遲以配合打字動畫）
                console.log('準備添加回應消息到聊天...');
                const responseDelay = 800 + Math.random() * 1200; // 0.8-2秒隨機延遲
                setTimeout(() => {
                    console.log('正在添加回應消息...');
                    // 先移除打字動畫
                    try {
                        if (typeof removeTypingAnimation === 'function') {
                    removeTypingAnimation(characterId);
                        }
                    } catch (error) {
                        console.warn('移除打字動畫失敗:', error);
                    }
                    
                    // 分段发送长消息（使用自然化版本）
                    let segments = [aiResponse];
                    try {
                        if (typeof splitMessageIntoSegments === 'function') {
                            segments = splitMessageIntoSegments(aiResponse, 60);
                        }
                    } catch (error) {
                        console.warn('分段消息失敗:', error);
                        segments = [aiResponse];
                    }
                    
                    if (segments.length > 1) {
                        try {
                            if (typeof sendMessageSegmentsSequentially === 'function') {
                        sendMessageSegmentsSequentially(characterId, segments);
                            } else {
                                // 如果分段發送函數不存在，直接發送完整消息
                                addMessage({
                                    type: 'message',
                                    character: characterId,
                                    content: aiResponse,
                                    contentType: 'text'
                                });
                            }
                        } catch (error) {
                            console.warn('分段發送失敗:', error);
                            // 降級到直接發送
                            addMessage({
                                type: 'message',
                                character: characterId,
                                content: aiResponse,
                                contentType: 'text'
                            });
                        }
                    } else {
                        // 短消息直接发送
                        try {
                            if (typeof addMessage === 'function') {
                    addMessage({
                        type: 'message',
                        character: characterId,
                        content: aiResponse,
                        contentType: 'text'
                    });
                            } else {
                                console.warn('addMessage 函數未定義');
                            }
                        } catch (error) {
                            console.warn('添加消息失敗:', error);
                        }
                    }
                    console.log('回應消息已添加');
                }, responseDelay);
            } else {
                console.error('未能生成有效回應');
                // 添加默認回應
                try {
                    if (typeof addMessage === 'function') {
                        addMessage({
                            type: 'message',
                            character: characterId,
                            content: '抱歉，我現在無法回應，請稍後再試。',
                            contentType: 'text'
                        });
                    }
                } catch (error) {
                    console.warn('添加默認回應失敗:', error);
                }
            }
        }
        
        // 生成角色個性化回應
        async function generateCharacterResponse(characterId, userMessage) {
            console.log('=== generateCharacterResponse 開始 ===');
            console.log('角色ID:', characterId);
            console.log('用戶消息:', userMessage);
            
            const character = characters[characterId];
            if (!character) {
                console.error('角色不存在:', characterId);
                return null;
            }
            
            console.log('角色信息:', character);
            
            // 這裡可以根據角色特點生成不同風格的回應
            // 現在先使用簡單的模擬回應
            let responses = [];
            try {
                if (typeof getCharacterResponses === 'function') {
                    responses = getCharacterResponses(characterId, userMessage);
                }
            } catch (error) {
                console.warn('獲取角色回應失敗:', error);
            }
            
            console.log('獲取到的回應選項:', responses);
            
            if (responses && responses.length > 0) {
                const selectedResponse = responses[Math.floor(Math.random() * responses.length)];
                console.log('選中的回應:', selectedResponse);
                return selectedResponse;
            }
            
            const defaultResponse = `我是${character.name}，很高興與你交流！`;
            console.log('使用默認回應:', defaultResponse);
            return defaultResponse;
        }
        
        // 獲取角色回應庫
        function getCharacterResponses(characterId, userMessage) {
            const message = userMessage.toLowerCase();
            
            // 基於消息內容返回相應的回應
            const responseLibrary = {
                libai: {
                    greetings: ["哈哈！朋友今日興致如何？", "來來！與我共飲一杯如何？", "今日天氣甚好，正適合吟詩作對！"],
                    poetry: ["詩者，言志也！你想聽我作一首嗎？", "詩如人生，酒如知己，不如我們聊聊詩詞？", "「天生我材必有用，千金散盡還復來」，你覺得如何？"],
                    wine: ["無酒不成詩！你也愛飲酒嗎？", "「金樽清酒斗十千」，今日可有美酒相伴？", "酒入豪腸，七分釀成了月光，餘下三分嘯成劍氣！"],
                    default: ["說得好！李某深以為然。", "有趣有趣，繼續說說看。", "嗯，這話倒是新鮮，細細說來聽聽。"]
                },
                dufu: {
                    greetings: ["朋友好！今日可安好？", "見到你甚是欣慰，近來如何？"],
                    poetry: ["詩歌當憂國憂民，你以為如何？", "「安得廣廈千萬間，大庇天下寒士俱歡顏」，此乃我志。"],
                    life: ["人生多艱難，但當堅持理想。", "民生疾苦，詩人當關注之。"],
                    default: ["你說得對，值得深思。", "這話讓我想起許多往事。", "嗯，我們繼續聊聊。"]
                },
                change: {
                    greetings: ["月宮清寂，難得有人來訪。", "廣寒宮中，歡迎你的到來。"],
                    moon: ["月圓月缺，人間離合，你可曾感慨？", "在這月宮中，我常思念人間。"],
                    loneliness: ["孤獨久了，也習慣了。", "有時想念人間的熱鬧，你能理解嗎？"],
                    default: ["月宮中的日子，總是如此平靜。", "你的話讓我想起了許多。", "謝謝你陪我聊天。"]
                },
                taoyuanming: {
                    greetings: ["歸來兮！朋友，田園生活可安好？", "悠然見南山，不如與我共享這份寧靜。"],
                    nature: ["採菊東籬下，悠然見南山，此境界你可懂？", "歸園田居，遠離塵囂，心境自然開闊。"],
                    philosophy: ["不為五斗米折腰，這是我的選擇。", "真意在此，欲辨已忘言。"],
                    default: ["田園之樂，在於心境的平和。", "朋友所言甚是，我深有同感。", "山水之間，自有真趣。"]
                },
                confucius: {
                    greetings: ["有朋自遠方來，不亦樂乎？", "學而時習之，不亦說乎？"],
                    education: ["三人行，必有我師焉。", "學而不思則罔，思而不學則殆。", "知之為知之，不知為不知，是知也。"],
                    morality: ["仁者愛人，君子以仁為本。", "己所不欲，勿施於人。"],
                    default: ["善哉善哉！", "你的想法很有道理。", "這確實值得深思。"]
                },
                wangwei: {
                    greetings: ["阿彌陀佛，施主今日可好？", "詩佛在此，與君論道。"],
                    nature: ["行到水窮處，坐看雲起時。", "明月松間照，清泉石上流。"],
                    zen: ["空山不見人，但聞人語響。", "禪意在山水間，你可領悟？"],
                    default: ["施主所言，頗有禪意。", "山水有情，詩畫同源。", "靜心思之，自有所得。"]
                },
                yutu: {
                    greetings: ["搗藥間隙，能聊天真開心！", "月宮生活單調，你來陪我聊天太好了！"],
                    work: ["每天搗藥搗藥，好累啊！", "你知道不死藥是怎麼做的嗎？好奇！"],
                    moon: ["月宮雖美，但真的很孤單呢。", "從月宮看地球，人類好渺小哦。"],
                    default: ["你說的好有趣！", "哇！真的嗎？", "我也是這麼想的呢！"]
                }
            };
            
            const characterResponses = responseLibrary[characterId] || responseLibrary.libai;
            
            // 根據消息內容選擇合適的回應類別
            if (message.includes('你好') || message.includes('哈囉') || message.includes('hi') || message.includes('hello')) {
                return characterResponses.greetings || characterResponses.default;
            } else if (message.includes('詩') || message.includes('詞') || message.includes('文學')) {
                return characterResponses.poetry || characterResponses.default;
            } else if (message.includes('酒') && characterId === 'libai') {
                return characterResponses.wine || characterResponses.default;
            } else if ((message.includes('月') || message.includes('嫦娥')) && characterId === 'change') {
                return characterResponses.moon || characterResponses.default;
            } else if (message.includes('孤單') || message.includes('寂寞') || message.includes('孤獨')) {
                return characterResponses.loneliness || characterResponses.default;
            } else if ((message.includes('田園') || message.includes('自然') || message.includes('山水')) && characterId === 'taoyuanming') {
                return characterResponses.nature || characterResponses.default;
            } else if ((message.includes('哲學') || message.includes('人生')) && characterId === 'taoyuanming') {
                return characterResponses.philosophy || characterResponses.default;
            } else if ((message.includes('學習') || message.includes('教育') || message.includes('老師')) && characterId === 'confucius') {
                return characterResponses.education || characterResponses.default;
            } else if ((message.includes('道德') || message.includes('仁義') || message.includes('品德')) && characterId === 'confucius') {
                return characterResponses.morality || characterResponses.default;
            } else if ((message.includes('山水') || message.includes('自然') || message.includes('風景')) && characterId === 'wangwei') {
                return characterResponses.nature || characterResponses.default;
            } else if ((message.includes('禪') || message.includes('佛') || message.includes('修行')) && characterId === 'wangwei') {
                return characterResponses.zen || characterResponses.default;
            } else if ((message.includes('工作') || message.includes('累') || message.includes('搗藥')) && characterId === 'yutu') {
                return characterResponses.work || characterResponses.default;
            } else if ((message.includes('月宮') || message.includes('月亮') || message.includes('廣寒宮')) && characterId === 'yutu') {
                return characterResponses.moon || characterResponses.default;
            } else {
                return characterResponses.default;
            }
        }

        // 獲取私聊歡迎消息
        function getPrivateChatWelcome(characterId) {
            const welcomeMessages = {
                libai: "哈哈！見到故人甚是歡喜！有何事想與李某暢談？",
                dufu: "能與你單獨交流真是太好了，有什麼想聊的嗎？",
                taoyuanming: "悠然相見，甚是愉悅。不如我們聊聊田園生活？",
                change: "月宮清冷，難得有人來訪，你想了解什麼呢？",
                wangwei: "獨自品茶論道，別有一番雅趣。",
                confucius: "有朋自遠方來，不亦樂乎？你想請教什麼？",
                caozhi: "陳王在此，有何雅事要與我分享？",
                menghaoran: "襄陽一隅，難得友人來訪，甚是歡喜！",
                yuzhen: "公主府中清靜，你來找我有何事？",
                yutu: "搗藥間隙，能聊天真是太好了！你想聽什麼故事？",
                yangguifei: "難得有人願意聽我說話，你想了解宮中趣事嗎？",
                laozi: "道可道，非常道。你想與老夫探討什麼？",
                zhuangzi: "逍遙遊於天地之間，你也想感受自由嗎？",
                simaqian: "史家之筆在此，有什麼歷史想要了解的？",
                liuling: "今日無酒，但有好友相伴也不錯！",
                ligui: "音樂之美，在於分享。你想聽我唱首曲子嗎？"
            };
            
            return welcomeMessages[characterId] || `很高興能與你單獨聊天！有什麼想說的嗎？`;
        }

        // 打開角色資料頁面的通用函數
        function openProfilePage(characterId) {
            const character = characters[characterId];
            if (!character) return;
            
            // 記錄當前查看的角色ID
            currentViewingCharacterId = characterId;
            
            // 更新成員資料頁面
            document.getElementById('profileAvatar').textContent = character.avatar;
            document.getElementById('profileName').textContent = character.name;
            
            // 更新個性簽名
            const profileSignature = document.getElementById('profileSignature');
            if (profileSignature) {
                profileSignature.textContent = characterSignatures[characterId] || "這個人很懶，什麼都沒寫";
            }
            
            // 更新微信ID而不是暱稱(因為我們現在顯示的是WeChat ID)
            const profileWechatId = document.getElementById('profileWechatId');
            if (profileWechatId) {
                profileWechatId.textContent = characterId + '001';
            }
            
            // 更新地區資訊
            const profileLocation = document.getElementById('profileLocation');
            if (profileLocation) {
                // 根據角色ID設定合適的地區
                let location = '唐 · 長安'; // 默認地區
                
                // 根據角色ID指定不同地區
                switch(characterId) {
                    case 'libai': location = '唐 · 長安'; break;
                    case 'taoyuanming': location = '晉 · 潯陽'; break;
                    case 'liuling': location = '魏晉 · 竹林'; break;
                    case 'dufu': location = '唐 · 洛陽'; break;
                    case 'ligui': location = '唐 · 宮廷'; break;
                    case 'yutu': location = '天界 · 廣寒宮'; break;
                    case 'change': location = '天界 · 廣寒宮'; break;
                    case 'yuzhen': location = '唐 · 長安宮'; break;
                    case 'wangwei': location = '唐 · 輞川'; break;
                    case 'caozhi': location = '魏 · 鄴城'; break;
                    case 'xiwangmu': location = '仙界 · 瑤池'; break;
                    case 'yangguifei': location = '唐 · 華清宮'; break;
                    case 'menghaoran': location = '唐 · 襄陽'; break;
                    case 'system': location = '網絡 · 雲端'; break;
                }
                
                profileLocation.textContent = '地區：' + location;
            }
            
            // 更新影音號名稱
            const profileChannelName = document.getElementById('profileChannelName');
            if (profileChannelName) {
                profileChannelName.textContent = character.name;
            }
            
            // 推入頁面歷史並顯示個人資料頁面
            console.log('打開個人詳情頁面前的頁面歷史:', pageHistory.history);
            console.log('打開個人詳情頁面前的當前頁面:', pageHistory.currentPage);
            
            pageHistory.pushPage('memberProfilePage');
            pageHistory.showPage('memberProfilePage');
            
            console.log('打開個人詳情頁面後的頁面歷史:', pageHistory.history);
            console.log('打開個人詳情頁面後的當前頁面:', pageHistory.currentPage);
        }
        

        
        // 切換點贊狀態
        function toggleMomentLike(momentId, authorId) {
            const momentsDB = getMomentsDB();
            
            // 找到對應朋友圈
            for (const charId in momentsDB) {
                const moments = momentsDB[charId];
                const momentIndex = moments.findIndex(m => m.id === momentId);
                
                if (momentIndex !== -1) {
                    const moment = moments[momentIndex];
                    const likedIndex = moment.likes.indexOf('libai');
                    
                    if (likedIndex === -1) {
                        // 添加點贊
                        moment.likes.push('libai');
                        // 音效已移除
                    } else {
                        // 取消點贊
                        moment.likes.splice(likedIndex, 1);
                    }
                    
                    // 更新界面
                    const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                    if (momentElement) {
                        // 使用朋友圈管理器重新渲染
                        if (momentsManager.currentCharacterId) {
                            momentsManager.renderCharacterMoments(momentsManager.currentCharacterId);
                        } else {
                            momentsManager.renderMoments();
                        }
                    }
                    
                    break;
                }
            }
        }
        
        // 顯示評論輸入框
        function showCommentInput(momentId, authorId) {
            // 移除已存在的評論輸入框
            const existingInputs = document.querySelectorAll('.moment-comment-input-container');
            existingInputs.forEach(el => el.remove());
            
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            const commentsSection = momentElement.querySelector('.moment-comments');
            const likesSection = momentElement.querySelector('.moment-likes');
            
            // 創建評論輸入容器
            const inputContainer = document.createElement('div');
            inputContainer.className = 'moment-comment-input-container';
            inputContainer.style.cssText = 'display:flex;padding:8px 5px;background:#f7f7f7;border-radius:3px;margin-top:8px;';
            
            // 創建輸入框
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '發表評論...';
            input.className = 'moment-comment-input';
            input.style.cssText = 'flex:1;border:none;border-bottom:1px solid #ddd;background:transparent;padding:5px 0;font-size:14px;outline:none;';
            
            // 創建發送按鈕
            const sendBtn = document.createElement('button');
            sendBtn.className = 'moment-comment-send';
            sendBtn.textContent = '發送';
            sendBtn.style.cssText = 'border:none;background:#07c160;color:white;border-radius:3px;padding:3px 10px;font-size:14px;cursor:pointer;';
            
            // 添加emoji按鈕
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'moment-comment-emoji';
            emojiBtn.innerHTML = '😊';
            emojiBtn.style.cssText = 'border:none;background:transparent;font-size:20px;margin-right:5px;cursor:pointer;';
            
            // 添加到容器
            inputContainer.appendChild(emojiBtn);
            inputContainer.appendChild(input);
            inputContainer.appendChild(sendBtn);
            
            // 決定插入位置
            if (commentsSection) {
                commentsSection.before(inputContainer);
            } else if (likesSection) {
                likesSection.after(inputContainer);
            } else {
                const content = momentElement.querySelector('.moment-content');
                content.appendChild(inputContainer);
            }
            
            // 監聽發送按鈕點擊
            sendBtn.addEventListener('click', () => {
                submitComment(momentId, authorId, input.value);
            });
            
            // 監聽Enter鍵
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitComment(momentId, authorId, input.value);
                }
            });
            
            // emoji按鈕功能已移除
            
            // 自動聚焦到輸入框
            input.focus();
        }
        

        
        // 提交評論
        function submitComment(momentId, authorId, commentText) {
            if (!commentText.trim()) return;
            
            const momentsDB = getMomentsDB();
            
            // 找到對應朋友圈
            for (const charId in momentsDB) {
                const moments = momentsDB[charId];
                const momentIndex = moments.findIndex(m => m.id === momentId);
                
                if (momentIndex !== -1) {
                    const moment = moments[momentIndex];
                    
                    // 確保comments數組存在
                    if (!moment.comments) {
                        moment.comments = [];
                    }
                    
                    // 添加評論
                    moment.comments.push({
                        authorId: 'libai', // 當前用戶為李白
                        text: commentText.trim()
                    });
                    
                    // 音效已移除
                    
                    // 更新界面
                    if (momentsManager.currentCharacterId) {
                        momentsManager.renderCharacterMoments(momentsManager.currentCharacterId);
                    } else {
                        momentsManager.renderMoments();
                    }
                    
                    // 隨機回覆功能已移除
                    
                    break;
                }
            }
        }
        

        
        // 這裡僅作為空白佔位符，保留原函數架構
        
        // 獲取角色朋友圈數據
        function getMomentsForCharacter(characterId) {
            // 從數據庫中獲取指定角色的朋友圈
            const momentsDB = getMomentsDB();
            return momentsDB[characterId] || [];
        }
        
        // 朋友圈數據庫緩存系統
        let momentsDBCache = null;
        
        // 獲取朋友圈數據庫
        function getMomentsDB() {
            if (momentsDBCache) {
                return momentsDBCache;
            }
            
            console.log('正在延遲加載朋友圈數據庫...');
            // 返回朋友圈數據庫對象
            const momentsDatabase = {
                libai: [
                    {
                        id: 'libai_14',
                        authorId: 'libai',
                        text: '今日訪戴天山道士不遇，雖未見道友，卻見滿山春色。犬吠水聲中，桃花帶露濃。樹深時見鹿，溪午不聞鐘。野竹分青靄，飛泉掛碧峰。無人知所去，愁倚兩三松。縱然未遇，此行亦不虛也！#十八歲遊記 #訪友不遇 #山中即景 #道士何處去',
                        image: '🦌🌸',
                        time: '二十八年前',
                        location: '四川·戴天山',
                        likes: ['taoyuanming', 'wangwei', 'caozhi'],
                        comments: [
                            { authorId: 'taoyuanming', text: '「桃花帶露濃」一句，將桃花之美寫得極致，老夫讀之心嚮往之！' },
                            { authorId: 'wangwei', text: '此詩清幽雋永，山水之趣躍然紙上，不輸老夫山水詩作，李君十八歲即有此才，天縱英才也！' },

                            { authorId: 'libai', text: '@wangwei 摩詰兄過譽了，太白不過偶得靈感，如何比得上摩詰兄詩中有畫，畫中有詩之境。' }
                        ]
                    },
                    {
                        id: 'libai_13',
                        authorId: 'libai',
                        text: '尋雍尊師隱居，得晤高人，相談甚歡。「語來江色暮，獨自下寒煙」，師言道法自然，勿拘世俗，深受啟發。山中清修，靜心修道，日後必有所成。明日離山，繼續求道之路。#十八歲求道 #匡山隱者 #問道修行 #青蓮初遊',
                        image: '🏔️🧘‍♂️',
                        time: '二十八年前',
                        location: '四川·匡山',
                        likes: ['taoyuanming', 'wangwei', 'xiwangmu'],
                        comments: [
                            { authorId: 'xiwangmu', text: '凡間修道之人，若能堅持初心，日後或有機緣入我瑤池。' },
                            { authorId: 'libai', text: '師言猶在耳畔，只是世事紛擾，修道之心漸淡，愧對當年之志。' },
                            { authorId: 'taoyuanming', text: '求仙問道，不過是追求心靈自由。太白縱酒放歌，已得道之真諦。' }
                        ]
                    },
                ],

                libai: [
                    {
                        id: 'libai_1',
                        authorId: 'libai',
                        text: '今日翰林院受命為貴妃作《清平調》，雖得賞賜，卻覺大材小用，鬱悶至極...',
                        image: '🏛️📜',
                        time: '今天 12:30',
                        likes: ['liuling'],
                        comments: [
                            { authorId: 'liuling', text: '明日共飲，解君愁緒！' },
                            { authorId: 'yangguifei', text: '太白所作《清平調》三首，皆為絕唱，陛下甚喜，何來鬱悶？' }
                        ]
                    },
                    {
                        id: 'libai_2',
                        authorId: 'libai',
                        text: '長安一片月，萬戶搗衣聲',
                        image: '🌕🏘️',
                        time: '昨天 20:15',
                        likes: ['taoyuanming', 'dufu', 'wangwei'],
                        comments: [
                            { authorId: 'dufu', text: '詩仙風采，令弟嚮往！' },
                            { authorId: 'wangwei', text: '一句道盡長安夜景，妙哉！' }
                        ]
                    },
                    {
                        id: 'libai_3',
                        authorId: 'libai',
                        text: '早朝為玄宗陛下起草詔書，高力士又在一旁指手畫腳。我一氣之下，讓他跪下為我脫靴！看他那氣急敗壞的樣子，哈哈！不過，恐怕日後有麻煩了...#翰林院日常 #喝多了 #得罪宦官',
                        image: '👨‍⚖️👢',
                        time: '3天前 14:20',
                        likes: ['liuling'],
                        comments: [
                            { authorId: 'liuling', text: '哈哈哈！爽快！不過太白既為謫仙，還是要多加小心為妙。' }
                        ]
                    },
                    {
                        id: 'libai_4',
                        authorId: 'libai',
                        text: '五花馬，千金裘，呼兒將出換美酒，與爾同銷萬古愁。',
                        image: '🐎👘🍶',
                        time: '5天前 18:45',
                        likes: ['liuling', 'taoyuanming', 'dufu'],
                        comments: [
                            { authorId: 'liuling', text: '好氣魄！此酒當共飲！' },
                            { authorId: 'taoyuanming', text: '千金換酒，太白真是灑脫！老夫佩服！' },
                            { authorId: 'dufu', text: '兄之豪情，令人嚮往，然千金買馬換酒，恐家人有怨...' }
                        ]
                    },
                    {
                        id: 'libai_5',
                        authorId: 'libai',
                        text: '今日與賀老飲酒，老人家讀我《蜀道難》後拊掌大笑，稱我為「謫仙人」，又帶我見陛下，陛下竟親自調羹賜食！此生何其有幸！#天寶元年 #入翰林 #皇恩浩蕩',
                        image: '🥣👑',
                        time: '二年前',
                        likes: ['dufu', 'yuzhen', 'wangwei', 'taoyuanming'],
                        comments: [
                            { authorId: 'dufu', text: '恭喜太白入翰林！大展鴻圖之時已至！' },
                            { authorId: 'yuzhen', text: '李供奉才華橫溢，難怪兄長如此賞識。' },
                            { authorId: 'ligui', text: '下官在宮中已聽聞李供奉大名，今得入翰林，實乃朝廷之幸！' }
                        ]
                    },
                    {
                        id: 'libai_6',
                        authorId: 'libai',
                        text: '徂徠山下，與孔巢父等五友隱居，號「竹溪六逸」。日日飲酒賦詩，逍遙自在。山東風光，果然勝蜀！#竹溪六逸 #山東遊記 #隱逸生活',
                        image: '🏞️🍻',
                        time: '兩年前',
                        likes: ['taoyuanming', 'menghaoran', 'wangwei', 'dufu'],
                        comments: [
                            { authorId: 'taoyuanming', text: '隱居山林，把酒言歡，此乃人生一大樂事。' },
                            { authorId: 'menghaoran', text: '曾聞太白遊歷四方，今隱山東，何時能南下與老夫一聚？' },
                            { authorId: 'libai', text: '@menghaoran 浩然兄莫急，他日定當尋訪，一起飲酒賦詩！' }
                        ]
                    },
                    {
                        id: 'libai_7',
                        authorId: 'libai',
                        text: '向朝廷呈獻辭賦後未獲重用，轉去終南山隱居。玉真公主相邀入其別館，本以為有所機遇，不料竟遭冷落。世人只重門第，不重才學，令人憤懣！明日便離此地，另覓知音。#長安生活 #高門難入 #失落感',
                        image: '👸🚪',
                        time: '五年前',
                        likes: ['wangwei', 'taoyuanming', 'liuling'],
                        comments: [
                            { authorId: 'yuzhen', text: '李白才高，但在宮中需知進退，不可逾矩。' },
                            { authorId: 'libai', text: '@yuzhen 公主教誨極是。李白自知失禮，深感愧疚。' },
                            { authorId: 'taoyuanming', text: '高門大戶，人情冷暖，不如歸去，自在山林。' }
                        ]
                    },
                    {
                        id: 'libai_8',
                        authorId: 'libai',
                        text: '長安奔波數月，獻賦無人賞識，心灰意冷。今日搬至終南山下，與老道同住。也罷，且避世修行，再待時機。#長安不相識 #修道養性 #隱居生活',
                        image: '⛰️🧙‍♂️',
                        time: '四年前',
                        likes: ['taoyuanming', 'liuling'],
                        comments: [
                            { authorId: 'taoyuanming', text: '不為五斗米折腰，此乃高士之風。太白雖窮困，卻保全了氣節。' },
                            { authorId: 'liuling', text: '隱居雖好，莫要荒廢了飲酒！老夫日後定攜美酒前來拜訪！' },
                            { authorId: 'libai', text: '@liuling 劉兄若來，定當痛飲三日！' }
                        ]
                    },
                    {
                        id: 'libai_9',
                        authorId: 'libai',
                        text: '洛陽城中豪飲三日，干謁官員無果。吾雖有濟世之才，卻無人識。今日遇一算命先生，言吾前世為謫仙，此生定不屈於俗吏之下！哈哈，痛快！乾了這杯！#洛陽日記 #算命奇遇 #干謁無果',
                        image: '🍷🔮',
                        time: '十二年前',
                        likes: ['liuling', 'taoyuanming'],
                        comments: [
                            { authorId: 'liuling', text: '太白志向遠大，豈是小吏能識！他日必有明君賞識！' },
                            { authorId: 'taoyuanming', text: '謫仙之資質果然不同凡響，太白勿憂，是金子總會發光的。' }
                        ]
                    },
                    {
                        id: 'libai_10',
                        authorId: 'libai',
                        text: '離蜀東遊，沿江而下，一路風景秀麗。昨日於襄陽邂逅孟浩然，相見甚歡。二人促膝長談，直到天明。此人詩才不俗，談吐風雅，真乃知音也！#襄陽遊記 #相見恨晚 #詩友記',
                        image: '🌊🌃',
                        time: '十六年前',
                        likes: ['menghaoran', 'dufu', 'taoyuanming', 'wangwei'],
                        comments: [
                            { authorId: 'menghaoran', text: '襄陽一見，恨相識太晚！太白文采風流，氣度不凡，真乃吾輩中翹楚！' },
                            { authorId: 'taoyuanming', text: '江湖相逢，知音難覓。二位皆有超世之才，相得益彰。' },
                            { authorId: 'wangwei', text: '浩然兄與太白相遇，必是詩壇盛事！何時能三人共聚？' },
                            { authorId: 'libai', text: '@wangwei 王維兄若有興致，不如下月於洛陽一聚？' }
                        ]
                    },
                    {
                        id: 'libai_12',
                        authorId: 'libai',
                        text: '渡遠荊門外，來從楚國遊。山隨平野盡，江入大荒流。月下飛天鏡，雲生結海樓。仍憐故鄉水，萬里送行舟。今日首次離蜀，驚歎於荊門之外的寬廣天地！三峽崇山峻嶺盡去，平野開闊，江水浩瀚。雖心向遠方，卻難忘故鄉。一路東行，誌在四方！#初離蜀地 #渡荊門送別 #萬里行舟',
                        image: '⛰️🚣',
                        time: '二十年前',
                        likes: ['taoyuanming', 'menghaoran'],
                        comments: [
                            { authorId: 'taoyuanming', text: '「山隨平野盡，江入大荒流」一句氣勢磅礴，寫盡江流壯闊！太白遠行，必成大器！' },
                            { authorId: 'menghaoran', text: '初出蜀地便有如此佳作，太白前程遠大，老夫拭目以待！' }
                        ]
                    },
                    {
                        id: 'libai_11',
                        authorId: 'libai',
                        text: '峨眉山月半輪秋，影入平羌江水流。今日登上峨眉之巔，俯瞰雲海，頓覺胸中豪氣萬丈！世人皆囿於世俗，唯吾與東嚴子共談天地，論古今。劍術小有所成，今斬猛虎一頭，贈肉於山民。#峨眉遊記 #劍客日常 #生而為劍',
                        image: '⛰️🗡️',
                        time: '二十年前',
                        likes: ['caozhi', 'liuling', 'dufu'],
                        comments: [
                            { authorId: 'dufu', text: '「峨眉山月半輪秋，影入平羌江水流」，此句意境高遠，令人神往！' },
                            { authorId: 'caozhi', text: '文武雙全，千古少有。吾觀太白當不囿於一時，必成大器。' },
                            { authorId: 'libai', text: '@caozhi 陳王謬讚！太白不過一介布衣，何敢與前賢相比。然有誌在胸，必當一展！' }
                        ]
                    },
                ],
                taoyuanming: [
                    {
                        id: 'taoyuanming_1',
                        authorId: 'taoyuanming',
                        text: '種豆南山下，草盛豆苗稀。',
                        image: '🌱🏔️',
                        time: '昨天 09:20',
                        likes: ['libai', 'dufu', 'wangwei', 'menghaoran'],
                        comments: [
                            { authorId: 'libai', text: '淵明兄，何時再釀菊花酒？' },
                            { authorId: 'wangwei', text: '田園詩派之祖，傳世千年！' }
                        ]
                    },
                    {
                        id: 'taoyuanming_2',
                        authorId: 'taoyuanming',
                        text: '今日歸去來，田園將蕪胡不歸？',
                        image: '🏡🌄',
                        time: '3天前',
                        likes: ['libai', 'liuling', 'menghaoran', 'wangwei'],
                        comments: [
                            { authorId: 'libai', text: '何時邀我至東籬下共飲？' },
                            { authorId: 'liuling', text: '淵明歸隱，不為五斗米折腰，真乃高士！' }
                        ]
                    },
                    {
                        id: 'taoyuanming_3',
                        authorId: 'taoyuanming',
                        text: '今朝東籬下賞菊，酌一杯濁酒，頗有韻致。可惜無友共飲，略顯寂寥。',
                        image: '🌼🍶',
                        time: '上週',
                        likes: ['libai', 'liuling', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '待我辭官後，定攜美酒尋淵明兄共賞菊花！' },
                            { authorId: 'dufu', text: '菊花與酒，高潔與豪放，妙哉！' }
                        ]
                    }
                ],
                liuling: [
                    {
                        id: 'liuling_1',
                        authorId: 'liuling',
                        text: '有酒直須飲，無常不待人',
                        image: '🍺☠️',
                        time: '今天 10:15',
                        likes: ['libai', 'taoyuanming', 'hezhizhang'],
                        comments: [
                            { authorId: 'libai', text: '知音！他日共酌！' },
                            { authorId: 'change', text: '仙界瓊漿，更勝凡間酒' },
                            { authorId: 'hezhizhang', text: '劉伶酒量驚人，太白若能與之共飲，定是一場盛事！' }
                        ]
                    },
                    {
                        id: 'liuling_2',
                        authorId: 'liuling',
                        text: '酒徒中人，以酒為號。安能一日無酒，思無所之！',
                        image: '🛏️🍶',
                        time: '昨天 05:30',
                        likes: ['libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '劉兄此言，說到我心坎上了！' },
                            { authorId: 'taoyuanming', text: '酒不醉人人自醉，劉伶之醉，乃心靈之醉！' }
                        ]
                    },
                    {
                        id: 'liuling_3',
                        authorId: 'liuling',
                        text: '命駕上車，載酒樽於車前，使蒼頭馭駕，而擊鼓行歌，縱意極歡。',
                        image: '🛞🥁',
                        time: '上週',
                        likes: ['libai', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '劉伶樂道，吾等之師！來日當效仿之！' },
                            { authorId: 'taoyuanming', text: '酒中真性情，難得糊塗！' }
                        ]
                    }
                ],

                dufu: [
                    {
                        id: 'dufu_1',
                        authorId: 'dufu',
                        text: '聞李太白將辭官，或將至洛陽。若能得見，當面請教，幸甚幸甚！',
                        image: '🗺️📝',
                        time: '3小時前',
                        likes: ['libai', 'menghaoran'],
                        comments: [
                            { authorId: 'libai', text: '杜兄才華，早聞其名。洛陽相見，一言為定' },
                            { authorId: 'menghaoran', text: '李杜二人若能聚首，天下詩人當避其鋒！' }
                        ]
                    },
                    {
                        id: 'dufu_6',
                        authorId: 'dufu',
                        text: '首陽山下購地建屋，費盡心力，終於有了自己的小窩！雖然簡陋，卻是安身立命之所。最近忙著置辦家具，有誰能推薦個靠譜的木匠嗎？#新居落成 #裝修困難戶 #有房一族',
                        image: '🏡🔨',
                        time: '一個月前',
                        likes: ['libai', 'wangwei', 'taoyuanming', 'liuling'],
                        comments: [
                            { authorId: 'taoyuanming', text: '恭喜杜兄有了自己的園子！老夫當年築室東籬下，最是愜意。「種豆南山下，草盛豆苗稀」，杜兄不妨也種些蔬果。' },
                            { authorId: 'dufu', text: '@taoyuanming 淵明兄見教極是！已在後院開闢菜地，種些青菜，望能自給自足。' },
                            { authorId: 'wangwei', text: '洛陽城南有木匠張三，手藝精湛，價格公道，可托我引薦。' },
                            { authorId: 'libai', text: '子美終於有宅了！待我攜酒前來，為你暖居！順便帶上幾箱好酒，塞滿你的酒窖！' }
                        ]
                    },
                    {
                        id: 'dufu_7',
                        authorId: 'dufu',
                        text: '人生大事！剛與楊家小姐完婚，日後有人照顧了[愛心]。岳父大人楊司農為官清廉，內人賢淑溫柔，甚是投緣。此生足矣！#新婚報喜 #脫單 #告別單身貴族',
                        image: '💑👰',
                        time: '兩個月前',
                        likes: ['libai', 'wangwei', 'menghaoran', 'taoyuanming', 'ligui', 'yuzhen'],
                        comments: [
                            { authorId: 'libai', text: '賀！賀！賀！子美終於脫單，可喜可賀！待我帶上三斗好酒登門慶賀！' },
                            { authorId: 'dufu', text: '謝諸位厚愛！婚後定當潛心詩藝，不負眾望！@libai 太白兄，等你的三斗好酒哦！' },
                            { authorId: 'yuzhen', text: '杜郎君與楊家小姐結為夫妻，琴瑟和鳴，必能相濡以沫，白頭偕老！願有情人終成眷屬！' },
                            { authorId: 'ligui', text: '下官與楊司農有舊，聞其愛女賢淑聰慧，杜郎君得此佳偶，實乃前世修來福分！恭喜恭喜！' }
                        ]
                    },
                    {
                        id: 'dufu_5',
                        authorId: 'dufu',
                        text: '放蕩齊趙間，裘馬頗輕狂。春歌叢台上，冬獵青丘旁。這段齊趙之游，頗為愜意！沒想到打獵也有趣上了癮！#新技能get #打獵日常 #富家子弟體驗卡',
                        image: '🏹🐎',
                        time: '三個月前',
                        likes: ['libai', 'liuling', 'menghaoran'],
                        comments: [
                            { authorId: 'libai', text: '子美竟也有輕狂時刻！哈哈，明日一起打獵如何？' },
                            { authorId: 'liuling', text: '打獵需大量體力，不如改為飲酒賞月？我備好美酒等你！' },
                            { authorId: 'dufu', text: '@liuling 劉兄此言極是！獵歸之後，定當登門共飲！' },
                            { authorId: 'menghaoran', text: '杜兄年少有為，文武雙全，令人羨慕！' }
                        ]
                    },
                    {
                        id: 'dufu_4',
                        authorId: 'dufu',
                        text: '洛陽進士考試落第，心情複雜...看來今年又是陪跑選手[苦笑]。先不管了，收拾行囊，準備去兗州看看父親大人。#考試失利 #求安慰 #人生低谷',
                        image: '📝😢',
                        time: '八個月前',
                        likes: ['libai', 'menghaoran', 'wangwei', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '杜兄勿憂！我也屢試不第，如今卻能入翰林。科舉之路非人才之路，真正的才華，自有用武之地！' },
                            { authorId: 'taoyuanming', text: '不為五斗米折腰，落第未必是壞事。杜兄才高八斗，何愁無處施展？' },
                            { authorId: 'dufu', text: '@taoyuanming @libai 二位高人誠懇勸解，子美深感欣慰。然家貧如洗，不得不以科舉求出路...' },
                            { authorId: 'menghaoran', text: '杜兄莫要氣餒，科舉雖重要，但真正的才華終會被發現。放寬心，明年再戰！' }
                        ]
                    },
                    {
                        id: 'dufu_3',
                        authorId: 'dufu',
                        text: '東郡趨庭日，南樓縱目初。浮雲連海岱，平野入青徐。孤嶂秦碑在，荒城魯殿餘。從來多古意，臨眺獨躊躇。#兗州遊記 #探親 #25歲的青春',
                        image: '🏯🌄',
                        time: '八個月前',
                        likes: ['libai', 'taoyuanming', 'wangwei', 'menghaoran', 'yuzhen'],
                        comments: [
                            { authorId: 'taoyuanming', text: '「從來多古意，臨眺獨躊躇」，此情此景，與老夫當年頗為相似。' },
                            { authorId: 'dufu', text: '@taoyuanming 淵明先生詩風高遠，杜某不敢相比。此詩不過年少時塗鴉之作，慚愧慚愧。' },
                            { authorId: 'wangwei', text: '杜兄謙虛了，二十五歲有此詩作，實屬難得。登高望遠，觸景生情，情景交融，妙哉！' },
                            { authorId: 'yuzhen', text: '聞父親為官清廉，百姓稱頌，杜郎君必是傳承家風，他日定成大器！' }
                        ]
                    },
                    {
                        id: 'dufu_2',
                        authorId: 'dufu',
                        text: '岱宗夫如何？齊魯青未了。造化鍾神秀，陰陽割昏曉。蕩胸生層雲，決眥入歸鳥。會當凌絕頂，一覽眾山小。#泰山遊記 #人生必去景點 #一覽眾山小',
                        image: '⛰️🏞️',
                        time: '一年前',
                        likes: ['libai', 'wangwei', 'menghaoran', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '好氣魄！「會當凌絕頂，一覽眾山小」，豪邁非常！須得與杜兄同登泰山，共賞此景！' },
                            { authorId: 'dufu', text: '@libai 太白若能同行，必是人生一大快事！泰山之巔，豪飲一場，何其快哉！' },
                            { authorId: 'menghaoran', text: '杜兄此詩氣勢磅礴，前四句寫景，後四句抒情，層次分明，意境高遠！才華橫溢！' },
                            { authorId: 'wangwei', text: '「蕩胸生層雲，決眥入歸鳥」，想像力豐富，視角獨特，令人驚嘆！[強]' }
                        ]
                    }
                ],

                wangwei: [
                    {
                        id: 'wangwei_1',
                        authorId: 'wangwei',
                        text: '明日入寺聽禪，求一心清淨。紅塵滾滾，不若青燈古佛。',
                        image: '🧘‍♂️🕯️',
                        time: '今天',
                        likes: ['menghaoran', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'menghaoran', text: '維哥近來醉心佛法，詩作卻更有禪意！' },
                            { authorId: 'dufu', text: '王維詩畫相得益彰，佛法滋養，更顯高遠！' }
                        ]
                    }
                ],
                menghaoran: [
                    {
                        id: 'menghaoran_1',
                        authorId: 'menghaoran',
                        text: '春眠不覺曉，處處聞啼鳥。夜來風雨聲，花落知多少？',
                        image: '🌸🐦',
                        time: '今天',
                        likes: ['libai', 'wangwei', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '浩然兄此詩清新自然，如春風拂面！' },
                            { authorId: 'wangwei', text: '此詩一出，知音必多！' }
                        ]
                    },
                    {
                        id: 'menghaoran_2',
                        authorId: 'menghaoran',
                        text: '今日於黃鶴樓啟程前往廣陵，多位故友前來送行。其中一位年輕詩人李白尤為熱情，竟紅了眼眶，揮別之際還匆匆寫下一詩相贈。此子雖年少，才氣過人，日後必成大器。老夫已年過不惑，江湖漂泊多年，如今看到後生如此傾慕，心中頗多感慨。#黃鶴樓送別 #廣陵之行 #後生可畏',
                        image: '🚣‍♂️🏞️',
                        time: '開元十八年三月',
                        likes: ['libai', 'dufu', 'wangwei', 'taoyuanming'],
                        comments: [
                            { authorId: 'wangwei', text: '浩然兄此行必有奇遇，期待佳作。不知李白送兄的詩如何？' },
                            { authorId: 'menghaoran', text: '@wangwei 那小子寫了首「故人西辭黃鶴樓，煙花三月下揚州」，末句「孤帆遠影碧空盡，唯見長江天際流」尤為動人。' },
                            { authorId: 'taoyuanming', text: '離別之情，最是難言。年輕人熱情奔放，老夫當年亦如此。' },
                            { authorId: 'libai', text: '孟夫子言重了，不過是區區拙作。此一別，不知何時再得相見，心中難免失落。' }
                        ]
                    },
                    {
                        id: 'menghaoran_3',
                        authorId: 'menghaoran',
                        text: '三年前初見李太白，此子年僅二十八，卻已才氣縱橫。「神氣高朗，軒軒然若霞舉」，不似常人。彼時我已名滿天下，他卻忐忑前來拜訪，甚是可愛。一番交談，發現此子天資過人，詩才橫溢，遂多加鼓勵。不想他竟寫下「吾愛孟夫子，風流天下聞」之句，老夫聞之一笑。有此後生，詩壇未來必有可期。#遇見李白 #詩壇新秀 #安陸偶遇',
                        image: '🧔‍♂️🍵',
                        time: '開元十五年',
                        likes: ['libai', 'dufu', 'taoyuanming', 'wangwei'],
                        comments: [
                            { authorId: 'libai', text: '初見夫子，如沐春風。夫子寬厚待我，令在下終身難忘！' },
                            { authorId: 'dufu', text: '前輩慧眼識英才！太白之名，後來果然如日中天。' },
                            { authorId: 'wangwei', text: '浩然兄與太白相識，乃詩壇盛事！兩位大才相遇，必有佳話流傳！' },
                            { authorId: 'menghaoran', text: '@wangwei 摩詰兄過獎了。彼時太白年少氣盛，酒量已不凡，我們確實暢飲數日。' }
                        ]
                    },
                    {
                        id: 'menghaoran_4',
                        authorId: 'menghaoran',
                        text: '收到李太白書信，言道欲在江夏相會。此子熱情似火，每每見面必執弟子禮，令老夫既感動又有些不安。近日諸事繁忙，恐難赴約。太白性情中人，只怕會難過許久。唉，年輕人感情用事，不似我等歷經滄桑，看淡聚散。待他閱歷漸豐，自會明白「聚散皆是緣」的道理。#江夏之約 #未能赴約 #後生可畏',
                        image: '📜🤔',
                        time: '開元十七年',
                        likes: ['wangwei', 'taoyuanming', 'dufu'],
                        comments: [
                            { authorId: 'wangwei', text: '浩然兄不必多慮，太白雖熱情似火，但氣量宏大，不會計較這些小事。' },
                            { authorId: 'taoyuanming', text: '年少之時，情感豐沛；年長之後，漸趨淡泊。此乃人生常態，浩然兄不必掛懷。' },
                            { authorId: 'dufu', text: '聽聞太白對夫子極為仰慕，奉為知己。此番未能相見，或有遺憾。' }
                        ]
                    }
                ],
                yutu: [
                    {
                        id: 'yutu_1',
                        authorId: 'yutu',
                        text: '搗藥搗了一整天，手都酸了！主人還要再煉一爐，今晚又要加班了...求問：月宮有五險一金嗎？#搗藥日常 #打工人的日常',
                        image: '🔨🌿',
                        time: '今天 18:45',
                        likes: ['change', 'moon', 'libai', 'xiwangmu'],
                        comments: [
                            { authorId: 'change', text: '好好搗，下次允許你吃一顆。' },
                            { authorId: 'libai', text: '聽聞廣寒宮之藥可得長生，玉兔辛苦了！' },
                            { authorId: 'xiwangmu', text: '五險一金是什麼？瑤池宮沒有這個...' },
                            { authorId: 'yutu', text: '@xiwangmu 我就知道... 這就是傳說中的仙界996啊！😭' }
                        ]
                    },
                    {
                        id: 'yutu_2',
                        authorId: 'yutu',
                        text: '趁主人不在，偷偷許願：好想去人間吃一次胡蘿蔔啊！聽說那裏的胡蘿蔔又甜又脆，比月宮裏的仙草還美味！#吃貨兔的心願 #兔兔想吃胡蘿蔔',
                        image: '🥕🌙',
                        time: '昨天',
                        likes: ['libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '若有機會下凡，定當備上好胡蘿蔔款待！' },
                            { authorId: 'taoyuanming', text: '東籬下種了不少胡蘿蔔，玉兔若來，任君採摘。' },
                            { authorId: 'change', text: '玉兔！我看到了！你居然又偷懶？！' },
                            { authorId: 'yutu', text: '@change 主人饒命！我這就去搗藥！💦' }
                        ]
                    },
                    {
                        id: 'yutu_3',
                        authorId: 'yutu',
                        text: '每逢中秋，都要加班...今年是第4827年了，真是時間過得好快啊！月餅都吃膩了，有沒有新花樣？#中秋加班 #工作4827年 #打工人的辛酸',
                        image: '🥮⏰',
                        time: '上週',
                        likes: ['change', 'libai', 'yangguifei'],
                        comments: [
                            { authorId: 'change', text: '千年萬年，日日如此，修煉之人不計時光。' },
                            { authorId: 'yangguifei', text: '宮中新制五仁月餅，賜你一個解饞。' },
                            { authorId: 'libai', text: '玉兔若厭倦，何不下凡走一遭？' },
                            { authorId: 'yutu', text: '@libai 主人看著我呢，溜不掉的...' }
                        ]
                    }
                ],
                ligui: [
                    {
                        id: 'ligui_1',
                        authorId: 'ligui',
                        text: '今日演奏《霓裳羽衣曲》，楊貴妃翩翩起舞，舉座皆驚。陛下龍顏大悅，賞金十兩！#宮廷演出 #業績達標 #貴妃贊助',
                        image: '🎵💃',
                        time: '今天 21:10',
                        likes: ['yangguifei', 'libai', 'dufu'],
                        comments: [
                            { authorId: 'yangguifei', text: '李樂師技藝超群，堪稱一絕，妾身舞姿能配得上已是萬幸。' },
                            { authorId: 'libai', text: '此曲只應天上有，人間難得幾回聞！何日能一聽龜年先生演奏？' },
                            { authorId: 'dufu', text: '十兩黃金！這是半年俸祿啊，李先生好福氣！' },
                            { authorId: 'ligui', text: '@dufu 哈哈，子美兄別眼紅，下次演出帶你進宮，免費聽！' }
                        ]
                    },
                    {
                        id: 'ligui_2',
                        authorId: 'ligui',
                        text: '收到西域進貢的樂器，音色奇特，正在研習中。準備編入新曲，獻給陛下，不知能得幾分賞賜？#新樂器 #創新曲風 #期待打賞',
                        image: '🪕🎻',
                        time: '昨天',
                        likes: ['yangguifei', 'libai', 'yuzhen'],
                        comments: [
                            { authorId: 'yuzhen', text: '龜年先生才華橫溢，此曲若成，定當請入宮中一展才藝。' },
                            { authorId: 'libai', text: '西域胡樂與唐音結合，必是一絕！龜年兄不負樂師之名！' },
                            { authorId: 'yangguifei', text: '妾身已向陛下推薦，若曲成，必有重賞！' },
                            { authorId: 'ligui', text: '多謝貴妃娘娘提攜，定當精益求精！@yangguifei' }
                        ]
                    },
                    {
                        id: 'ligui_3',
                        authorId: 'ligui',
                        text: '宮中生活，雖榮華富貴，卻身不由己。有時想效太白醉酒狂歌，卻又身份所限，只能暗自嘆息。#宮廷生活 #身不由己 #羨慕李白',
                        image: '👑🔗',
                        time: '一週前',
                        likes: ['libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '龜年兄何必自限？醉後方顯真性情，宮中亦可縱情歌唱！' },
                            { authorId: 'taoyuanming', text: '不如歸去，何必為五斗米折腰？' },
                            { authorId: 'ligui', text: '@taoyuanming 淵明兄說得容易，我可沒田可耕啊！還是乖乖靠手藝吃飯吧...' }
                        ]
                    }
                ],
                yuzhen: [
                    {
                        id: 'yuzhen_1',
                        authorId: 'yuzhen',
                        text: '宮中設宴，邀摩詰相聚。觀其手撫古琴，吟詩作畫，一曲《山水清音》令眾人傾倒。此人才藝絕倫，風度翩翩，難怪世人皆愛之。#才子王維 #一琴一詩一墨 #文藝生活',
                        image: '🎨🎻',
                        time: '昨天 20:30',
                        likes: ['wangwei', 'dufu', 'menghaoran', 'yangguifei'],
                        comments: [
                            { authorId: 'wangwei', text: '承蒙公主厚愛，微臣愧不敢當。古琴一曲，本是向諸位大師學習而來。' },
                            { authorId: 'yangguifei', text: '王維才藝超群，詩中有畫，畫中有詩，宮中諸人，無出其右。' },
                            { authorId: 'libai', text: '王維確實多才，琴、詩、字、畫無不精通，只是詩風過於含蓄，不若豪放派來得痛快淋漓。' },
                            { authorId: 'dufu', text: '太白兄莫要酸了，維兄詩畫雙絕，實乃盛世才子。' }
                        ]
                    },
                    {
                        id: 'yuzhen_2',
                        authorId: 'yuzhen',
                        text: '今日得元丹丘相贈道經一卷，閱之心神俱靜。修道之人，不以物慾為累，不為五斗米折腰，當真心嚮往之。#修道日常 #養心 #塵世浮躁',
                        image: '📜🧘‍♀️',
                        time: '3天前',
                        likes: ['wangwei', 'taoyuanming', 'xiwangmu'],
                        comments: [
                            { authorId: 'xiwangmu', text: '皇室之人能修道，實屬難得。待公主功力漸深，當邀入瑤池一敘。' },
                            { authorId: 'taoyuanming', text: '不為五斗米折腰，此乃高士之風。公主雖居富貴，心卻向道，更是難得。' }
                        ]
                    },
                    {
                        id: 'yuzhen_3',
                        authorId: 'yuzhen',
                        text: '觀李供奉醉後作詩，風姿灑脫，不拘形跡。然其狂言浪語，時有失禮，令宮中侍女皆掩口而笑。好在兄長愛才，不以為忤。#才子李白 #醉酒風波 #宮廷趣事',
                        image: '🥂📝',
                        time: '一週前',
                        likes: ['dufu', 'ligui', 'yangguifei'],
                        comments: [
                            { authorId: 'libai', text: '公主明鑒，微臣醉後失態，深感愧疚。然胸中之氣，不吐不快！' },
                            { authorId: 'yangguifei', text: '李供奉醉態可掬，令妾身也忍俊不禁。' }
                        ]
                    }
                ],
                wangwei: [
                    {
                        id: 'wangwei_1',
                        authorId: 'wangwei',
                        text: '明日入寺聽禪，求一心清淨。紅塵滾滾，不若青燈古佛。',
                        image: '🧘‍♂️🕯️',
                        time: '今天',
                        likes: ['menghaoran', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'menghaoran', text: '維哥近來醉心佛法，詩作卻更有禪意！' },
                            { authorId: 'dufu', text: '王維詩畫相得益彰，佛法滋養，更顯高遠！' }
                        ]
                    },
                    {
                        id: 'wangwei_2',
                        authorId: 'wangwei',
                        text: '辛田勞作，方知農事艱難。山居歲月，日出而作，日落而息，心靈漸趨平和。「未能抛得杜陵居，猶料因依是藥藩。」#終南山隱居 #田園生活 #佛系日常',
                        image: '🌄🏡',
                        time: '昨天 18:15',
                        likes: ['menghaoran', 'taoyuanming', 'dufu'],
                        comments: [
                            { authorId: 'taoyuanming', text: '能體會農事之難，方知百姓之苦。維兄雖為高官，卻能親力親為，難得！' },
                            { authorId: 'menghaoran', text: '山林日子最是愜意。維兄何時歸京？可否與老友一聚？' },
                            { authorId: 'wangwei', text: '@menghaoran 下月便返京，定當登門拜訪，共話詩畫！' }
                        ]
                    },
                    {
                        id: 'wangwei_3',
                        authorId: 'wangwei',
                        text: '「行到水窮處，坐看雲起時」。今日畫《輞川圖》，試以筆墨傳遞心中之境。山水清音，入骨入髓，若能畫盡心中之景，何愁詩畫不傳世？#山水畫 #輞川別業 #心境入畫',
                        image: '🏞️🖌️',
                        time: '三天前',
                        likes: ['dufu', 'yuzhen', 'menghaoran', 'libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'dufu', text: '維兄畫作，詩意盎然。真正做到了詩中有畫，畫中有詩！' },
                            { authorId: 'libai', text: '摩詰兄畫技高超，遠勝於我。只是太過含蓄，少了幾分豪放！' },
                            { authorId: 'yuzhen', text: '王大人畫作如詩，微臣有幸觀摩過，實在令人心馳神往！' },
                            { authorId: 'wangwei', text: '諸位過獎了。畫道無窮，仍需精進。@libai 太白兄豪放，各有千秋，何必相較？' }
                        ]
                    }
                ],
                yangguifei: [
                    {
                        id: 'yangguifei_1',
                        authorId: 'yangguifei',
                        text: '今日李供奉一襲白衣入宮，為妾身賦《清平調》三首，字字珠璣，令人心醉。細讀「名花傾國兩相歡，長得君王帶笑看」，不禁面熱心跳。此人才華橫溢，風流倜儻，不愧謫仙之名。#才子李白 #清平調 #驚為天人',
                        image: '👸🌸',
                        time: '今天 16:30',
                        likes: ['libai', 'ligui', 'yuzhen'],
                        comments: [
                            { authorId: 'libai', text: '承蒙娘娘厚愛，清平調三首皆為娘娘所作，娘娘國色天香，令微臣靈感湧動，下筆自成章。' },
                            { authorId: 'ligui', text: '李供奉有幸為娘娘作詩，此乃千載難逢之機遇。' },
                            { authorId: 'yuzhen', text: '這位李供奉，大膽至極！竟敢以美人香肩之喻，幸好兄長未見此詩...' },
                            { authorId: 'yangguifei', text: '@yuzhen 公主言重了，詩中有情，意境高雅，陛下已閱並甚是喜歡呢。' }
                        ]
                    },
                    {
                        id: 'yangguifei_2',
                        authorId: 'yangguifei',
                        text: '宮中新得西域香料，親手調配成膏，擦於耳後，清新怡人。因著李供奉所贈《清平調》中「雲想衣裳花想容」之句，遂取名「花想容」。今日初用，諸人皆稱絕妙。#新香製成 #花想容 #西域珍品',
                        image: '🌺💋',
                        time: '昨天',
                        likes: ['libai', 'yuzhen', 'ligui'],
                        comments: [
                            { authorId: 'libai', text: '娘娘以詩句為香名，令微臣蓬蓽生輝！此香必香飄萬里，流芳百世！' },
                            { authorId: 'yangguifei', text: '@libai 太白多才，香名出自君口，若有閒暇，可入宮一敘，共品新香。' },
                            { authorId: 'yuzhen', text: '貴妃所製香膏，必是絕世佳品。公主亦愛香道，定要向貴妃討教一二。' }
                        ]
                    },
                    {
                        id: 'yangguifei_3',
                        authorId: 'yangguifei',
                        text: '夜深人靜，獨坐宮中，翻閱李供奉所贈詩集，每每讀至情深處，不禁掩卷長嘆。此人纵情山水，醉心詩酒，全然不似庸俗文人，真乃天人也。可惜朝中不識其才，使其鬱鬱不得志。#夜讀李白 #月下思緒 #知音難覓',
                        image: '📜🌙',
                        time: '三天前',
                        likes: ['libai', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '娘娘深夜讀拙作，令微臣惶恐。「天生我材必有用」，不敢妄言功名，但求娘娘能解微臣之意。' },
                            { authorId: 'yangguifei', text: '@libai 君才華橫溢，必不會埋沒。妾身已向陛下進言，望君得展宏圖。' },
                            { authorId: 'yuzhen', text: '貴妃懂得欣賞才華，李供奉不負盛名。若言才華橫溢，王維亦是不遑多讓。' }
                        ]
                    }
                ],

                xiwangmu: [
                    {
                        id: 'xiwangmu_1',
                        authorId: 'xiwangmu',
                        text: '今日瑤池設宴，群仙歡聚。竟聽聞人間有一名叫李白的凡人，詩才超凡，可謂謫仙下凡。好奇之下，遂隔空觀之，果然風姿傑出，才華橫溢，不似凡人。#瑤池仙宴 #人間謫仙 #李白軼事',
                        image: '👑🌟',
                        time: '今天 00:01',
                        likes: ['change', 'yutu', 'moon', 'libai'],
                        comments: [
                            { authorId: 'libai', text: '西王母娘娘垂青，小仙不勝榮幸！若有機緣，願一嚐仙界瓊漿玉液，以慰凡心。' },
                            { authorId: 'change', text: '此人確實才華超凡，娘娘若有興趣，不如邀他參加蟠桃盛宴？' },
                            { authorId: 'xiwangmu', text: '@change 倒是個好主意。待他緣法到時，自有機會入我瑤池。' },
                            { authorId: 'yutu', text: '主人說李白那首《把酒問月》寫得極好，說他若在天上，必是嫦娥姐姐的知音！' }
                        ]
                    },
                    {
                        id: 'xiwangmu_2',
                        authorId: 'xiwangmu',
                        text: '三千年一開的蟠桃又熟了，正為蟠桃盛宴做準備。今次有意邀幾位有緣的凡人同赴盛宴，吾觀李太白與陶淵明皆有仙骨，可入吾名單。#蟠桃盛宴 #仙凡共宴 #三千年一開',
                        image: '🍑💫',
                        time: '昨天',
                        likes: ['change', 'yutu', 'libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '蟠桃盛宴！不知何年何月，才有幸一睹瑤池仙境？' },
                            { authorId: 'xiwangmu', text: '@libai 時機未到，心急何用？且先在人間多作佳詩，積累功德，自有機緣。' },
                            { authorId: 'taoyuanming', text: '多謝西王母厚愛，然淵明只愛東籬菊花，不慕蟠桃仙果。' },
                            { authorId: 'xiwangmu', text: '@taoyuanming 此言大膽！吾蟠桃乃九霄珍品，食之延年益壽。汝且莫忙拒絕，日後或有緣法。' }
                        ]
                    },
                    {
                        id: 'xiwangmu_3',
                        authorId: 'xiwangmu',
                        text: '人間李白作《清平調》三首，竟將「雲想衣裳花想容」比作楊貴妃。吾觀此詩，實是絕妙！不知人間美人能有幾分似我仙顏？略施法術，令其夢中一見吾真容，不知會有何等驚豔之語？#仙顏傾城 #戲弄凡人 #李白入夢',
                        image: '👸✨',
                        time: '三天前',
                        likes: ['change', 'yutu', 'libai', 'yangguifei'],
                        comments: [
                            { authorId: 'libai', text: '昨夜夢中見一仙女，衣若彩雲，容若春花，光華照人，不似凡物。醒後猶覺心神恍惚，不知何人入夢？' },
                            { authorId: 'xiwangmu', text: '@libai 機緣巧合，夢中所見，或許便是瑤池主人。' },
                            { authorId: 'yangguifei', text: '西王母娘娘仙顏絕世，妾身雖得太白誇讚，也不敢與仙子相比。' },
                            { authorId: 'dufu', text: '太白竟得見西王母入夢，此乃千載奇緣！若能得詩一首，當傳頌千古！' }
                        ]
                    }
                ],
                caozhi: [
                    {
                        id: 'caozhi_1',
                        authorId: 'caozhi',
                        text: '千載之後，聞人間出了個李太白，詩才橫溢，被稱作「詩仙」。吾在九泉之下，讀其《將進酒》，有「陳王昔時宴平樂，斗酒十千恣歡謔」之句，竟是提及我當年盛事！心有戚戚，遂寫和詩一首。#跨越千年 #詩仙李白 #陳王曹植',
                        image: '🤴📜',
                        time: '今天 03:21',
                        likes: ['libai', 'dufu', 'taoyuanming', 'wangwei'],
                        comments: [
                            { authorId: 'libai', text: '曹子建乃千古才子，七步成詩，驚才絕豔！不想竟能跨越時空，與吾唱和，何其幸哉！' },
                            { authorId: 'caozhi', text: '@libai 子建生前，才高卻命苦。今見太白才名，心中甚慰。然需謹記，才華橫溢者，往往命途多舛。' },
                            { authorId: 'taoyuanming', text: '曹陳王與李太白隔空相和，此乃千古奇緣！' },
                            { authorId: 'dufu', text: '陳王與太白齊名，皆為千古才子。然陳王薄命，願太白不蹈覆轍。' }
                        ]
                    },
                    {
                        id: 'caozhi_2',
                        authorId: 'caozhi',
                        text: '今讀李太白《蜀道難》，有「白帝城中雲出門，白帝城下雨翻盆」之句，想起當年吾過三峽，亦有「水何澹澹，山島竦峙」之感。相隔五百載，詩情竟如此契合，真可謂心有靈犀。#詩魂相通 #山水情懷 #古今共鳴',
                        image: '⛰️🌊',
                        time: '昨天',
                        likes: ['libai', 'wangwei', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '曹公過蜀時有詩，不想與吾所見竟有巧合。詩者，心靈相通，不分古今！' },
                            { authorId: 'caozhi', text: '@libai 山川不改，人心相通。太白所見之景，恰是子建當年所歷。詩心相契，豈止偶然！' },
                            { authorId: 'wangwei', text: '兩代詩人，隔空唱和，皆因對自然之美的體悟相通。' },
                            { authorId: 'dufu', text: '陳王與太白隔空唱和，此乃千古奇緣，令人嘆為觀止！' }
                        ]
                    },
                    {
                        id: 'caozhi_3',
                        authorId: 'caozhi',
                        text: '聞李太白醉酒放言，自稱天上謫仙。吾當年亦因酒後狂言，得罪兄長，招致大禍。凡間歲月如梭，千年已過，唯願太白戒我前車之鑑，莫因才高氣傲，自取其禍。#前車之鑑 #酒後狂言 #才子之禍',
                        image: '🍷⚠️',
                        time: '一週前',
                        likes: ['libai', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '多謝子建提醒！然天生我才必有用，不能為世俗所困。若能豁達如子建，已是幸事。' },
                            { authorId: 'caozhi', text: '@libai 吾非勸君隱忍，只是感同身受。太白若能保全性命，流芳百世，亦是一樁美事。' },
                            { authorId: 'dufu', text: '陳王遺言，發人深省。太白宜謹記在心，以保全身，留萬世詩篇。' }
                        ]
                    }
                ],
                change: [
                    {
                        id: 'change_1',
                        authorId: 'change',
                        text: '廣寒宮千年，日日望明月，夜夜對瑤琴。今日偶聽人間李白作《把酒問月》，竟把酒相邀，甚是有趣。若能邀他上天一聚，不知有何韻事？#千年孤寂 #廣寒宮主 #月中生活',
                        image: '🌕🙎‍♀️',
                        time: '今天 00:30',
                        likes: ['yutu', 'xiwangmu', 'libai'],
                        comments: [
                            { authorId: 'libai', text: '嫦娥仙子垂青，不勝榮幸！若得一見廣寒宮，當作千古佳詩以記之！' },
                            { authorId: 'yutu', text: '主人最近常提起李白呢，聽說他還寫了《月下獨酌》，邀明月共飲！' },
                            { authorId: 'xiwangmu', text: '嫦娥妹妹若有意，待下次蟠桃會，可請此凡人一同赴宴。' },
                            { authorId: 'change', text: '@xiwangmu 多謝娘娘美意，不過此人尚未功德圓滿，恐怕時機未到。' }
                        ]
                    },
                    {
                        id: 'change_2',
                        authorId: 'change',
                        text: '今日教玉兔製作月餅，不料這小兔手生，灑了一地桂花糖。罰它多搗三日靈藥，氣得直跺腳。旁觀一番，竟也覺有趣，千年寂寞，有此伴侶，也是一樂。#玉兔搗藥 #師徒日常 #月宮趣事',
                        image: '🐇🌸',
                        time: '昨天',
                        likes: ['yutu', 'xiwangmu', 'libai'],
                        comments: [
                            { authorId: 'yutu', text: '主人明明是故意刁難我！那桂花糖根本就放在不穩的地方嘛！' },
                            { authorId: 'change', text: '@yutu 還敢頂嘴，看來三日不夠，改為五日！' },
                            { authorId: 'libai', text: '嫦娥與玉兔之情，宛如天上人間一景，令人神往！' }
                        ]
                    },
                    {
                        id: 'change_3',
                        authorId: 'change',
                        text: '凡人常言「月有陰晴圓缺，人有悲歡離合」，卻不知月宮之中，歲月凝固，永無變化。千年歲月，不知今夕何夕，偶爾望見人間春花秋月，婚嫁喜慶，不禁唏噓。若非當年爭強好勝，何至於此？#後悔當初 #千年孤寂 #人間值得',
                        image: '🌙💔',
                        time: '三天前',
                        likes: ['yutu', 'xiwangmu', 'libai'],
                        comments: [
                            { authorId: 'xiwangmu', text: '嫦娥妹妹莫要傷感，當年若非如此，也不會成仙。天道輪迴，皆有定數。' },
                            { authorId: 'yutu', text: '主人別難過，有玉兔陪著你呢！我偷偷告訴你，我昨天藏了一壇桂花酒...' },
                            { authorId: 'libai', text: '「嫦娥應悔偷靈藥，碧海青天夜夜心」，仙子一人獨居廣寒，確實令人唏噓。' },
                            { authorId: 'change', text: '@libai 前塵往事，不提也罷。聽聞你醉酒對月，倒是有趣，待你功成圓滿，或可來月宮一敘。' }
                        ]
                    },
                    {
                        id: 'change_4',
                        authorId: 'change',
                        text: '千年前遺落人間的那面銅鏡，竟被一名凡人拾得。每當月圓之夜，我透過此鏡與那人心靈相通，得知人間百態。此人風流倜儻，才華橫溢，對月常飲，不知可是傳說中的謫仙人李太白？#心靈相通 #隔空對飲 #謫仙傳說',
                        image: '🪞✨',
                        time: '一週前',
                        likes: ['yutu', 'libai'],
                        comments: [
                            { authorId: 'libai', text: '原來仙子知我心！常言道「舉頭望明月，低頭思故鄉」，不知嫦娥可有思凡之心？' },
                            { authorId: 'change', text: '@libai 思凡不敢言，但看你對月痴情，倒也有幾分契合。那面銅鏡若在你手，當珍藏之。' },
                            { authorId: 'yutu', text: '主人與李白心靈相通，真是奇妙的緣分！' }
                        ]
                    }
                ],

            };
            
            // 緩存數據庫以提高性能
            momentsDBCache = momentsDatabase;
            console.log('朋友圈數據庫已緩存，總計角色數:', Object.keys(momentsDatabase).length);
            
            return momentsDBCache;
        }
        
        // 獲取當前系統時間
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return { hours, minutes, timeString: `${hours}:${minutes}` };
        }




        
        // 初始化並持續更新狀態欄時間
        function initializeStatusBarTime() {
            function updateStatusBarTime() {
                const currentTime = getCurrentTime();
                // 只更新全局狀態欄
                const globalStatusBarTime = document.querySelector('.global-status-bar .status-bar-left');
                if (globalStatusBarTime) {
                    globalStatusBarTime.textContent = currentTime.timeString;
                }
            }
            
            // 立即更新一次
            updateStatusBarTime();
            
            // 每分鐘更新一次
            setInterval(updateStatusBarTime, 60000);
        }
        
        // Emoji数据
        const emojiData = [
            "😊", "😃", "😄", "😁", "😆", "😅", "🤣", "😂", "🙂", "🙃", 
            "😉", "😇", "🥰", "😍", "🤩", "😘", "😗", "😚", "😙", "😋", 
            "😛", "😜", "🤪", "😝", "🤑", "🤗", "🤭", "🤫", "🤔", "🤐", 
            "🤨", "😐", "😑", "😶", "😏", "😒", "🙄", "😬", "🤥", "😌", 
            "😔", "😪", "🤤", "😴", "😷", "🤒", "🤕", "🤢", "🤮", "🤧",
            "😵", "🤯", "🤠", "🥳", "😎", "🤓", "🧐", "😕", "😟", "🙁", 
            "☹️", "😮", "😯", "😲", "😳", "🥺", "😦", "😧", "😨", "😰", 
            "😥", "😢", "😭", "😱", "😖", "😣", "😞", "😓", "😩", "😫", 
            "🥱", "😤", "😡", "😠", "🤬", "👋", "🖐️", "✋", "🙏", "👏",
            "👍", "👎", "👊", "✊", "🤛", "🤜", "🤝", "🙌", "👐", "🤲",
            "❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔",
            "🍷", "🍸", "🍹", "🍺", "🍻", "🥂", "🥃", "🍶", "🥛", "🍵",
            "🥴", "🥺", "😭", "😂", "😅", "🤣", "🙃", "😘", "😍", "🥰"
        ];
        

        
        // @功能相關變量
        let mentionState = {
            isActive: false,
            currentAtPosition: -1,
            searchTerm: ''
        };
        
        // 生成@某人列表
        function generateMentionList(searchTerm = '') {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            const members = currentGroup.members.filter(id => 
                characters[id] && id !== 'user'
            );
            
            // 根據搜索詞過濾
            const filteredMembers = members.filter(id => {
                const character = characters[id];
                return character.name.includes(searchTerm);
            });
            
            const mentionPopup = document.getElementById('mentionPopup');
            mentionPopup.innerHTML = '';
            
            filteredMembers.forEach(id => {
                const character = characters[id];
                const item = document.createElement('div');
                item.className = 'mention-item';
                item.setAttribute('data-character-id', id);
                
                item.innerHTML = `
                    <div class="mention-avatar">${character.avatar}</div>
                    <div class="mention-name">${character.name}</div>
                `;
                
                item.addEventListener('click', () => {
                    insertMention(id, character.name);
                });
                
                mentionPopup.appendChild(item);
            });
            
            return filteredMembers.length > 0;
        }
        
        // 插入@某人
        function insertMention(characterId, characterName) {
            const inputBox = document.getElementById('messageInput');
            const text = inputBox.value;
            const atPosition = mentionState.currentAtPosition;
            
            // 構建新的文本，替換@和搜索詞
            const beforeAt = text.substring(0, atPosition);
            const afterAt = text.substring(atPosition + 1 + mentionState.searchTerm.length);
            const mention = `@${characterName} `;
            
            inputBox.value = beforeAt + mention + afterAt;
            inputBox.focus();
            
            // 設置光標位置
            const newPosition = atPosition + mention.length;
            inputBox.setSelectionRange(newPosition, newPosition);
            
            // 隱藏@面板
            hideMentionPopup();
            
            console.log(`插入@提及: ${characterName}`);
        }
        
        // 顯示@某人面板
        function showMentionPopup() {
            // 私聊模式下不顯示@提示面板
            if (isPrivateChatMode()) {
                return;
            }
            
            const mentionPopup = document.getElementById('mentionPopup');
            mentionPopup.style.display = 'block';
            
            // 隱藏其他面板
            document.getElementById('emojiPanel').style.display = 'none';
            document.getElementById('functionPanel').style.display = 'none';
        }
        
        // 隱藏@某人面板
        function hideMentionPopup() {
            const mentionPopup = document.getElementById('mentionPopup');
            mentionPopup.style.display = 'none';
            mentionState.isActive = false;
            mentionState.currentAtPosition = -1;
            mentionState.searchTerm = '';
        }
        
        // 處理@功能的輸入
        function handleMentionInput(inputBox) {
            const text = inputBox.value;
            const cursorPosition = inputBox.selectionStart;
            
            // 查找最近的@符號
            let atPosition = -1;
            for (let i = cursorPosition - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPosition = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atPosition !== -1) {
                // 找到@符號，提取搜索詞
                const searchTerm = text.substring(atPosition + 1, cursorPosition);
                
                // 檢查搜索詞是否有效（不包含空格或特殊字符）
                if (!/\s/.test(searchTerm)) {
                    mentionState.isActive = true;
                    mentionState.currentAtPosition = atPosition;
                    mentionState.searchTerm = searchTerm;
                    
                    if (generateMentionList(searchTerm)) {
                        showMentionPopup();
                    } else {
                        hideMentionPopup();
                    }
                } else {
                    hideMentionPopup();
                }
            } else {
                hideMentionPopup();
            }
        }
        
        // 從消息中提取@提及的角色
        function extractMentions(message) {
            const mentions = [];
            const mentionRegex = /@([^\s@]+)/g;
            let match;
            
            while ((match = mentionRegex.exec(message)) !== null) {
                const mentionedName = match[1];
                // 根據名字找到角色ID
                for (const id in characters) {
                    if (characters[id].name === mentionedName) {
                        mentions.push({
                            id: id,
                            name: mentionedName,
                            fullMatch: match[0]
                        });
                        break;
                    }
                }
            }
            
            return mentions;
        }
        
        // 高亮消息中的@提及
        function highlightMentions(message) {
            return message.replace(/@([^\s@]+)/g, '<span class="mention-text">@$1</span>');
        }
        
        // 點擊頭像@某人
        function mentionCharacter(characterId) {
            const character = characters[characterId];
            if (!character) return;
            
            const inputBox = document.getElementById('messageInput');
            const currentText = inputBox.value;
            const mention = `@${character.name} `;
            
            // 如果輸入框為空或最後沒有空格，添加@提及
            if (currentText === '' || currentText.endsWith(' ')) {
                inputBox.value = currentText + mention;
            } else {
                inputBox.value = currentText + ' ' + mention;
            }
            
            inputBox.focus();
            inputBox.setSelectionRange(inputBox.value.length, inputBox.value.length);
            
            console.log(`通過點擊頭像@了 ${character.name}`);
        }
        
        // 打开朋友圈的全局函数
        function openMoments() {
            // 延迟初始化朋友圈 - 只有首次打开时才初始化
            if (!momentsManager.initialized) {
                console.log('首次打开朋友圈，正在初始化...');
                momentsManager.init();
                momentsManager.initialized = true;
            }
            
            momentsManager.openMoments();
        }
        
        // 向面板添加Emoji
        function populateEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanel.innerHTML = ''; // 清空面板
            
            emojiData.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => {
                    sendEmoji(emoji);
                });
                emojiPanel.appendChild(emojiItem);
            });
        }
        
        // 发送Emoji消息
        function sendEmoji(emoji) {
            addMessage({
                type: 'message',
                character: 'user',
                content: emoji,
                contentType: 'text'
            });
            
            // 隐藏emoji面板
            toggleEmojiPanel(false);
            
            // 觸發AI回應
            setTimeout(() => {
                generateSafeAIResponses(emoji, []);
            }, 1000);
        }
        
        // 显示/隐藏emoji面板
        function toggleEmojiPanel(show) {
            const emojiPanel = document.getElementById('emojiPanel');
            if (show) {
                emojiPanel.style.display = 'flex';
            } else {
                emojiPanel.style.display = 'none';
            }
        }
      
        // 初始化登录表单状态
        function initializeLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                // 确保表单初始状态为禁用
                loginForm.classList.add('form-disabled');
                console.log('登錄表單初始化為禁用狀態');
            }
        }
        
        // 确认阅读功能 - 全局函数
        function confirmReading() {
            const confirmBtn = document.getElementById('confirmBtn');
            const confirmText = document.getElementById('confirmText');
            const loginForm = document.getElementById('loginForm');
            
            console.log('確認閱讀按鈕被點擊'); // 调试信息
            console.log('登錄表單元素:', loginForm); // 调试信息
            
            // 标记为已确认
            confirmBtn.classList.add('confirmed');
            confirmText.innerHTML = '✅ 已確認閱讀';
            confirmBtn.disabled = true;
            
            // 启用登录表单
            if (loginForm) {
                loginForm.classList.remove('form-disabled');
                console.log('已移除 form-disabled 類'); // 调试信息
                
                // 强制刷新所有输入元素的样式
                const inputs = loginForm.querySelectorAll('input, select, button');
                inputs.forEach(input => {
                    input.style.opacity = '1';
                    input.style.pointerEvents = 'auto';
                    input.style.cursor = 'auto';
                    input.style.backgroundColor = '';
                    input.disabled = false;
                });
                console.log('已啟用', inputs.length, '個表單元素'); // 调试信息
            }
            
            // 添加确认动画
            confirmBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                confirmBtn.style.transform = 'scale(1)';
            }, 200);
        }
        
        // 生成銀河系粒子效果 - 優化版本
        function createGalaxyParticles() {
            const galaxyContainer = document.querySelector('.galaxy-container');
            if (!galaxyContainer) {
                console.error('找不到galaxy-container元素');
                return;
            }
            
            console.log('開始創建銀河系粒子效果...');
            
            // 4層星空結構，總計約400顆星，大幅減少密度提升性能
            const layerConfigs = [
                { count: 120, minRadius: 150, maxRadius: 450, size: 'medium', speed: 0.8, opacity: 0.9 },
                { count: 100, minRadius: 450, maxRadius: 750, size: 'small', speed: 1.0, opacity: 0.7 },
                { count: 80, minRadius: 750, maxRadius: 1050, size: 'tiny', speed: 1.2, opacity: 0.5 },
                { count: 60, minRadius: 1050, maxRadius: 1350, size: 'small', speed: 1.4, opacity: 0.3 }
            ];
            
            // 優化動態CSS動畫 - 只保留4層星星旋轉
            const style = document.createElement('style');
            style.textContent = `
                @keyframes rotate-0_8 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                @keyframes rotate-1_0 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                @keyframes rotate-1_2 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                @keyframes rotate-1_4 { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
                .particle.bright { box-shadow: 0 0 8px currentColor; }
                .particle.tiny { width: 0.8px; height: 0.8px; }
            `;
            document.head.appendChild(style);
            
            // 創建多層星空系統
            layerConfigs.forEach((config, layerIndex) => {
                const layerElement = document.createElement('div');
                layerElement.className = 'starfield-layer layer-' + layerIndex;
                layerElement.style.cssText = 
                    'position: absolute;' +
                    'width: 100%;' +
                    'height: 100%;' +
                    'animation: rotate-' + config.speed.toFixed(1).replace('.', '_') + ' ' + (120 / config.speed).toFixed(1) + 's linear infinite;';
                
                // 為每層創建星星
                for (let i = 0; i < config.count; i++) {
                    const star = document.createElement('div');
                    star.className = 'particle ' + config.size;
                    
                    // 避免中心150px區域，讓中央星星向四周擴散
                    let radius, angle, x, y;
                    do {
                        angle = Math.random() * Math.PI * 2;
                        radius = config.minRadius + Math.random() * (config.maxRadius - config.minRadius);
                        x = Math.cos(angle) * radius;
                        y = Math.sin(angle) * radius;
                    } while (Math.sqrt(x*x + y*y) < 150);
                    
                    star.style.cssText = 
                        'position: absolute;' +
                        'left: calc(50% + ' + x + 'px);' +
                        'top: calc(50% + ' + y + 'px);' +
                        'opacity: ' + (config.opacity * (0.3 + Math.random() * 0.7)) + ';' +
                        'animation-delay: ' + (Math.random() * 10) + 's;';
                    
                    // 外層星星更亮更明顯，並增強閃爍效果
                    if (layerIndex >= 4) {
                        star.style.opacity = Math.min(1, parseFloat(star.style.opacity) * 1.5);
                        if (Math.random() < 0.4) {
                            star.classList.add('bright');
                        }
                        if (Math.random() < 0.3) {
                            star.classList.add('enhanced-twinkle');
                        }
                    }
                    
                    // 隨機顏色和增強閃爍
                    const colorRand = Math.random();
                    if (colorRand < 0.15) star.classList.add('gold');
                    else if (colorRand < 0.25) star.classList.add('blue');
                    else if (colorRand < 0.35) star.classList.add('colored');
                    
                    // 隨機增強閃爍效果
                    if (Math.random() < 0.2) {
                        star.classList.add('enhanced-twinkle');
                    }
                    
                    layerElement.appendChild(star);
                }
                
                galaxyContainer.appendChild(layerElement);
            });
            
            // 進一步減少背景星星數量，從250降至30個
            for (let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.className = 'particle small';
                star.style.position = 'absolute';
                
                // 使用位運算優化隨機分布，擴大範圍到頁面周邊
                const x = ((Math.random() * 200) | 0) - 100;
                const y = ((Math.random() * 200) | 0) - 100;
                star.style.left = 'calc(50% + ' + x + 'vw)';
                star.style.top = 'calc(50% + ' + y + 'vh)';
                
                const delay = Math.round(Math.random() * 30) / 10;
                star.style.animationDelay = delay + 's';
                
                const opacity = Math.round((Math.random() * 0.4 + 0.1) * 100) / 100;
                star.style.opacity = opacity;
                
                // 增強背景彩色星星和閃爍效果
                const colorRand = (Math.random() * 100) | 0;
                if (colorRand < 12) {
                    if (colorRand < 4) star.classList.add('blue');
                    else if (colorRand < 8) star.classList.add('colored');
                    else star.classList.add('gold');
                }
                
                // 隨機增強閃爍效果
                if (Math.random() < 0.25) {
                    star.classList.add('enhanced-twinkle');
                }
                
                galaxyContainer.appendChild(star);
            }
            
            // 進一步減少中心區域星體數量至10個
            for (let i = 0; i < 10; i++) { // 從15減少到10
                const centralStar = document.createElement('div');
                centralStar.className = 'particle';
                centralStar.style.position = 'absolute';
                
                // 擴大中心區域範圍，讓星星向四周擴散
                const centerRadius = Math.random() * 120 + 50; // 50-170px範圍
                const centerAngle = Math.random() * Math.PI * 2;
                
                const x = Math.cos(centerAngle) * centerRadius;
                const y = Math.sin(centerAngle) * centerRadius;
                
                centralStar.style.left = 'calc(50% + ' + x + 'px)';
                centralStar.style.top = 'calc(50% + ' + y + 'px)';
                
                // 簡化大小分配
                const rand = (Math.random() * 100) | 0;
                if (rand < 40) centralStar.classList.add('large');
                else if (rand < 70) centralStar.classList.add('medium');
                else centralStar.classList.add('small');
                
                // 增強顏色分配和閃爍效果
                if (rand < 50) centralStar.classList.add('gold');
                else if (rand < 30) centralStar.classList.add('colored');
                
                const opacity = Math.round((0.7 + Math.random() * 0.3) * 100) / 100;
                centralStar.style.opacity = opacity;
                
                const delay = Math.round(Math.random() * 30) / 10;
                centralStar.style.animationDelay = delay + 's';
                
                // 中央星星增強閃爍效果
                if (Math.random() < 0.4) {
                    centralStar.classList.add('enhanced-twinkle');
                }
                
                galaxyContainer.appendChild(centralStar);
            }
            
            console.log('性能優化版銀河系已生成 - 總計約400個星體（4層螺旋臂360個+背景30個+中心10個），大幅提升流暢度');
        }
        
        // App圖標點擊處理函數
        function handleAppIconClick() {
            const appIconContainer = document.getElementById('appIconContainer');
            const loginContainer = document.getElementById('loginContainer');
            const universalContainer = document.getElementById('appUniversalContainer');
            
            console.log('App图标被点击');
            console.log('Elements found:', {
                appIconContainer: !!appIconContainer,
                loginContainer: !!loginContainer,
                universalContainer: !!universalContainer
            });
            
            // 添加消失動畫類
            appIconContainer.classList.add('disappearing');
            
            // 等待圖標消失動畫完成後顯示登入界面
            setTimeout(() => {
                // 隱藏app圖標
                appIconContainer.style.display = 'none';
                
                // 顯示父容器（带阴影效果）
                universalContainer.classList.add('show');
                
                // 直接顯示登入界面
                loginContainer.style.display = 'flex';
                
                console.log('登录界面应该已显示');
                
            }, 400); // 圖標消失動畫時間
        }
        
        // 初始化多輪對話系統
        function initMultiTurnConversation() {
            console.log('=== 初始化多輪對話系統 ===');
            
            // 檢查必要的變量是否已初始化
            if (typeof groupChatContext === 'undefined') {
                console.warn('groupChatContext 未定義，跳過多輪對話系統初始化');
                return;
            }
            
            if (typeof privateChatContext === 'undefined') {
                console.warn('privateChatContext 未定義，跳過多輪對話系統初始化');
                return;
            }
            
            if (typeof conversationHistory === 'undefined') {
                console.warn('conversationHistory 未定義，跳過多輪對話系統初始化');
                return;
            }
            
            // 設置群聊上下文的最大長度
            groupChatContext.maxContextLength = MAX_CONTEXT_LENGTH; // 與全域常量一致
            
            // 初始化私聊上下文Map
            privateChatContext.clear();
            
            // 初始化角色個性化歷史Map
            conversationHistory.clear();
            
            // 清理群聊上下文
            groupChatContext.messages = [];
            groupChatContext.lastUpdateTime = Date.now();
            
            console.log('多輪對話系統初始化完成');
            console.log('群聊上下文最大長度:', groupChatContext.maxContextLength);
            console.log('私聊上下文已清空');
            console.log('角色個性化歷史已清空');
        }
        
        // 當DOM內容加載完成後立即顯示星空效果
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM內容已加載，創建銀河系背景效果...');
            createGalaxyParticles();
        });
        
        // 啟動應用
        window.onload = function() {
            console.log('應用開始初始化...');
            
            // 設置app圖標點擊事件
            const appIcon = document.getElementById('appIcon');
            if (appIcon) {
                appIcon.addEventListener('click', handleAppIconClick);
                console.log('App圖標點擊事件已設置');
            }
            
            // 初始化登入管理器
            loginManager.init();
            
            // 页面加载完成后初始化登录表单
            initializeLoginForm();
            
            
            
            // 設置聊天輸入功能
            setupChatInput();
            
            // 初始化多輪對話系統（在所有其他初始化完成後）
            try {
                initMultiTurnConversation();
            } catch (error) {
                console.warn('多輪對話系統初始化失敗:', error);
            }
            
            // 群組標題由進入聊天時直接設置，無需在初始化時處理
            console.log('應用初始化完成，群組標題將在進入聊天時設置');
            
            // 設置UI交互
            setupUIInteractions();
            
            // 設置群組列表功能
            setupGroupListInteractions();
            
            // 初始化emoji面板
            populateEmojiPanel();
            
            console.log('應用初始化完成');
            
            // 設置emoji按鈕點擊事件
            const emojiBtn = document.getElementById('emojiBtn');
            if (emojiBtn) {
                emojiBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                const emojiPanel = document.getElementById('emojiPanel');
                const functionPanel = document.getElementById('functionPanel');
                
                                    // 關閉功能面板和@面板，顯示或隱藏emoji面板
                functionPanel.style.display = 'none';
                hideMentionPopup();
                const isVisible = emojiPanel.style.display === 'flex';
                toggleEmojiPanel(!isVisible);
            });
                console.log('Emoji按鈕事件監聽器已設置');
            } else {
                console.error('找不到emojiBtn元素');
            }
            
            // 設置加號按鈕點擊事件
            const plusBtn = document.getElementById('plusBtn');
            if (plusBtn) {
                plusBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                const functionPanel = document.getElementById('functionPanel');
                const emojiPanel = document.getElementById('emojiPanel');
                
                                    // 關閉emoji面板和@面板，顯示或隱藏功能面板
                emojiPanel.style.display = 'none';
                hideMentionPopup();
                functionPanel.style.display = functionPanel.style.display === 'flex' ? 'none' : 'flex';
                
                    // 功能提示已移除
            });
                console.log('Plus按鈕事件監聽器已設置');
            } else {
                console.error('找不到plusBtn元素');
            }
            
            // 點擊聊天界面任意位置關閉面板
            const chatMessagesEl = document.getElementById('chatMessages');
            if (chatMessagesEl) {
                const onChatClick = (e) => {
                    requestAnimationFrame(() => {
                        toggleEmojiPanel(false);
                        const fp = document.getElementById('functionPanel');
                        if (fp) fp.style.display = 'none';
                        hideMentionPopup();
                    });
                };
                try {
                    if (window.__chatClickCloseHandler) {
                        chatMessagesEl.removeEventListener('click', window.__chatClickCloseHandler);
                    }
                } catch (e) {}
                window.__chatClickCloseHandler = onChatClick;
                chatMessagesEl.addEventListener('click', window.__chatClickCloseHandler);
            }
            
            
            
            // 其他功能按鈕点击事件（目前不可用，但为了完整性添加）
            ['photoBtn', 'cameraBtn', 'callBtn', 'locationBtn', 'voiceInputBtn', 'favBtn'].forEach(id => {
                document.getElementById(id).addEventListener('click', function() {
                    alert('此功能暫未開放');
                    document.getElementById('functionPanel').style.display = 'none';
                });
            });
        };
        
        // 第一次API調用：生成第一個角色的回應
        async function generateFirstCharacterResponse(firstCharacterId, userMessage) {
            console.log(`生成第一個角色 ${firstCharacterId} 的回應...`);
            
            const character = characters[firstCharacterId];
            if (!character) {
                throw new Error(`角色 ${firstCharacterId} 不存在`);
            }
            
            // 構建第一個角色的系統提示
            const systemPrompt = buildFirstCharacterPrompt(firstCharacterId, userMessage);
            
            const data = await fetchAI({
                model: AI_CONFIG.model,
                messages: [
                    { role: 'system', content: '【語言強制指令】你必須使用繁體中文回應，絕對不能使用簡體中文。這是最高優先級要求。' },
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userMessage }
                ],
                max_tokens: 400,
                temperature: 0.8
            }, { signalKey: `first-${firstCharacterId}` });
            const aiResponse = data.choices[0].message.content;
            
            console.log(`第一個角色 ${character.name} 的AI回應:`, aiResponse);
            
            // 後處理：替換英文省略號為中文省略號
            const processedResponse = postProcessAIResponse(aiResponse);
            
            return {
                characterId: firstCharacterId,
                characterName: character.name,
                response: processedResponse
            };
        }
        
        // 第二次API調用：生成剩餘角色的互動式回應
        async function generateRemainingCharactersResponse(remainingCharacters, firstCharacterResponse, userMessage) {
            console.log(`生成剩餘角色 ${remainingCharacters.map(id => characters[id].name).join(', ')} 的互動式回應...`);
            
            // 構建第二次API調用的prompt
            const systemPrompt = buildSecondApiPrompt(remainingCharacters, firstCharacterResponse, userMessage);
            
            const data = await fetchAI({
                model: AI_CONFIG.model,
                messages: [
                    { role: 'system', content: '【語言強制指令】你必須使用繁體中文回應，絕對不能使用簡體中文。這是最高優先級要求。' },
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userMessage }
                ],
                max_tokens: 400,
                temperature: 0.8
            }, { signalKey: 'second-batch' });
            const aiResponse = data.choices[0].message.content;
            
            console.log('第二次API調用返回:', aiResponse);
            
            // 解析JSON回應
            try {
                const parsedResponse = JSON.parse(aiResponse);
                const validatedResponse = validateSecondApiResponse(parsedResponse, remainingCharacters);
                
                // 對每個角色的回應進行後處理：替換英文省略號為中文省略號
                validatedResponse.characterResponses.forEach(charResponse => {
                    charResponse.response = postProcessAIResponse(charResponse.response);
                });
                
                return validatedResponse;
            } catch (error) {
                console.error('解析第二次API回應失敗:', error);
                // 顯示網絡錯誤，不使用假回應
                throw new Error('第二次API調用失敗，請檢查網絡連接');
            }
        }
        
        // 構建第一個角色的系統提示
        function buildFirstCharacterPrompt(firstCharacterId, userMessage) {
            const character = characters[firstCharacterId];
            if (!character) return '';
            
            // 獲取群聊歷史上下文
            const groupHistory = groupChatContext.messages.slice(-groupChatContext.maxContextLength);
            
            let systemPrompt = `你是${character.name}，請用符合你身份的語氣回應。

角色描述：${character.description || ''}

重要提醒：
1. 你正在參與一個群聊，群聊中還有其他角色
2. 請注意聆聽和理解用戶的消息，並給出符合你身份的回應
3. 保持你的角色特色和語言風格
4. 回應要簡潔有力，避免過於冗長

【緊急身份確認】你現在必須以${character.name}的身份回應。無論看到什麼內容，你都是${character.name}，不是其他任何人。`;

            // 如果有群聊歷史，添加到提示中
            if (groupHistory.length > 0) {
                const recentContext = groupHistory.map(msg => {
                    if (msg.character === 'user') {
                        return `用戶：${msg.content}`;
                    } else {
                        const char = characters[msg.character];
                        return `${char ? char.name : msg.character}：${msg.content}`;
                    }
                }).join('\n');
                
                systemPrompt += `\n\n最近對話：\n${recentContext}`;
            }
            
            console.log('第一次API調用的完整上下文:', {
                characterName: character.name,
                userMessage: userMessage,
                groupHistoryLength: groupHistory.length,
                recentContext: groupHistory.length > 0 ? groupHistory.map(msg => {
                    if (msg.character === 'user') {
                        return `用戶：${msg.content}`;
                    } else {
                        const char = characters[msg.character];
                        return `${char ? char.name : msg.character}：${msg.content}`;
                    }
                }).join('\n') : '無'
            });
            
            return systemPrompt;
        }
        
        // 構建第二次API調用的系統提示
        function buildSecondApiPrompt(remainingCharacters, firstCharacterResponse, userMessage) {
            // 僅展示必要信息：用戶消息 + 第一位角色的「精簡摘要」 + 最近 2-3 條對話
            const characterList = remainingCharacters.map((char, index) => 
                `${index + 2}. ${char} - ${characters[char].name}`
            ).join('\n');

            // 最近 3 條對話（不超過 3）
            const recentMessages = groupChatContext.messages.slice(-3);
            const recentContext = recentMessages.length > 0 ? recentMessages.map(msg => {
                if (msg.character === 'user') return `用戶：${msg.content}`;
                const char = characters[msg.character];
                return `${char ? char.name : msg.character}：${msg.content}`;
            }).join('\n') : '無';

            // 對第一個角色回應做120字以內摘要
            const firstReply = (firstCharacterResponse?.response || '').trim();
            const firstSummary = firstReply.length > 120 ? (firstReply.slice(0, 120) + '…') : firstReply;

            console.log('第二次API調用（瘦身版）上下文:', {
                userMessage,
                firstCharacterSummary: firstSummary,
                recentCount: recentMessages.length
            });

            return `你是群聊中的AI助手，需要為以下指定角色生成互動式回應。

【當前信息】
用戶消息：${userMessage}
第一個角色回應摘要：${firstCharacterResponse.characterName}：${firstSummary}
最近對話：${recentContext}

【指定角色】
${characterList}

【要求】
1. 第二個角色（若存在）主要回應「${firstCharacterResponse.characterName}」的觀點，同時可補充對用戶的回應；
2. 第三個角色（若存在）需在前兩者基礎上形成自然承接與補充；
3. 每個角色的語氣需符合其身份，語言簡潔、有互動性；
4. 嚴格使用下方JSON格式，勿輸出多餘文本；
5. 使用繁體中文。

【JSON格式】
{
  "characterResponses": [
    ${remainingCharacters.map((char, index) => `{
      "characterId": "${char}",
      "characterName": "${characters[char].name}",
      "response": "角色${index + 2}的互動式回應（不超過240字）"
    }`).join(',\n    ')}
  ]
}`;
        }
        
        // 驗證第二次API回應
        function validateSecondApiResponse(response, expectedCharacters) {
            // 驗證JSON格式
            if (!response.characterResponses || !Array.isArray(response.characterResponses)) {
                throw new Error('響應格式錯誤：缺少characterResponses數組');
            }
            
            // 驗證角色數量
            if (response.characterResponses.length !== expectedCharacters.length) {
                throw new Error(`角色數量不匹配：期望${expectedCharacters.length}個，實際${response.characterResponses.length}個`);
            }
            
            // 驗證角色ID匹配
            const expectedIds = expectedCharacters;
            const actualIds = response.characterResponses.map(r => r.characterId);
            
            for (const expectedId of expectedIds) {
                if (!actualIds.includes(expectedId)) {
                    throw new Error(`角色ID不匹配：期望包含${expectedId}，實際包含${actualIds.join(', ')}`);
                }
            }
            
            // 驗證回應內容
            for (const charResponse of response.characterResponses) {
                if (!charResponse.response || charResponse.response.trim() === '') {
                    throw new Error(`角色${charResponse.characterId}的回應內容為空`);
                }
            }
            
            return response;
        }
        
        // 顯示第一個角色的回應
        async function displayCharacterResponse(characterId, characterResponse) {
            console.log(`顯示第一個角色 ${characterId} 的回應...`);
            
            // 移除打字動畫（API回應已到位）
            removeTypingAnimation(characterId);
            
            // 安全性過濾
            const safeResponse = safetyFilter.filterAIResponse(characterResponse.response);
            
            if (safeResponse && safeResponse.trim()) {
                // 將第一個角色的回應添加到群聊上下文中
                groupChatContext.messages.push({
                    character: characterId,
                    content: safeResponse,
                    timestamp: Date.now()
                });
                
                // 分段發送長消息
                const segments = splitMessageIntoSegments(safeResponse, 60);
                
                if (segments.length > 1) {
                    await sendMessageSegmentsSequentially(characterId, segments);
                } else {
                    addMessage({
                        type: 'message',
                        character: characterId,
                        content: safeResponse,
                        contentType: 'text'
                    });
                }
                
                setTimeout(() => {
                    const chatContainer = document.getElementById('chatMessages');
                    if (chatContainer) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                }, 100);
            }
        }
        
        // 顯示剩餘角色的回應（API調用已在後臺完成）
        async function displayRemainingCharactersResponses(remainingCharacters, remainingResponses) {
            console.log(`顯示剩餘角色回應，角色數量：${remainingCharacters.length}`);
            
            // 按順序處理每個角色（保持角色間的延遲）
            for (let i = 0; i < remainingCharacters.length; i++) {
                const characterId = remainingCharacters[i];
                const characterResponse = remainingResponses.characterResponses.find(r => r.characterId === characterId);
                
                if (!characterResponse) {
                    console.warn(`角色 ${characterId} 沒有找到回應`);
                    continue;
                }
                
                // 如果不是第一個剩餘角色，添加延遲（模擬思考時間）
                if (i > 0) {
                    const delay = 2000 + Math.random() * 500; // 2-2.5秒延遲
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                
                // 顯示該角色的打字動畫（模擬輸入時間）
                showTypingAnimation(characterId);
                
                // 模擬2秒打字動畫（API回應已到位，只是視覺效果）
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 移除打字動畫
                removeTypingAnimation(characterId);
                
                // 安全性過濾
                const safeResponse = safetyFilter.filterAIResponse(characterResponse.response);
                
                if (safeResponse && safeResponse.trim()) {
                    // 將剩餘角色的回應添加到群聊上下文中
                    groupChatContext.messages.push({
                        character: characterId,
                        content: safeResponse,
                        timestamp: Date.now()
                    });
                    
                    // 分段發送長消息
                    const segments = splitMessageIntoSegments(safeResponse, 60);
                    
                    if (segments.length > 1) {
                        await sendMessageSegmentsSequentially(characterId, segments);
                    } else {
                        addMessage({
                            type: 'message',
                            character: characterId,
                            content: safeResponse,
                            contentType: 'text'
                        });
                    }
                    
                    setTimeout(() => {
                        const chatContainer = document.getElementById('chatMessages');
                        if (chatContainer) {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    }, 100);
                }
            }
        }
        
        // 生成備用回應（已刪除）
        // 注意：此函數已被刪除，統一使用網絡錯誤提示
        
        // 生成備用剩餘角色回應（已刪除）
        // 注意：此函數已被刪除，統一使用網絡錯誤提示
        
        // 驗證上下文傳遞的調試函數
        function validateContextFlow(userMessage, selectedCharacters) {
            console.log('=== 上下文傳遞驗證 ===');
            console.log('1. 用戶消息:', userMessage);
            console.log('2. 選中的角色:', selectedCharacters.map(id => characters[id].name));
            console.log('3. 當前群聊上下文長度:', groupChatContext.messages.length);
            console.log('4. 群聊上下文內容:', groupChatContext.messages.map(msg => {
                if (msg.character === 'user') {
                    return `用戶：${msg.content}`;
                } else {
                    const char = characters[msg.character];
                    return `${char ? char.name : msg.character}：${msg.content}`;
                }
            }));
            
            // 驗證用戶消息是否在上下文中
            const userMessageInContext = groupChatContext.messages.some(msg => 
                msg.character === 'user' && msg.content === userMessage
            );
            console.log('5. 用戶消息是否在上下文中:', userMessageInContext);
            
            return userMessageInContext;
        }
        
        // 頁面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 移動端優化
            optimizeMobileViewport();
            preventDoubleTapZoom();
            
            // 初始化聊天輸入
            setupChatInput();
            
            console.log('太虛幻聊移動端優化已初始化');
        });

        /**
         * AI 請求監視器（DeepSeek 代理與 /chat/completions）
         * - 自動包裝 fetch，監控 /api/deepseek 與 /chat/completions 請求
         * - 記錄 payload 大小、messages 條數、system 總長度、usage、耗時
         * - 提供 Console 工具：__aiMonSummary()、__aiMonQuick(n)
         * - 右下角懸浮面板：Alt+M 顯示/隱藏
         */
        (function initAIMonitor() {
            try {
                if (window.__aiMonPatched) return;
                window.__aiMonPatched = true;
                const originalFetch = window.fetch;
                const isChatApi = (url) => {
                    if (typeof url !== 'string') return false;
                    // 兼容：舊版 OpenAI 風格 /chat/completions 與 Vercel 代理 /api/deepseek
                    if (url.includes('/chat/completions')) return true;
                    if (url.includes('/api/deepseek')) return true;
                    // 若已配置 AI_CONFIG.baseURL，亦納入監控
                    try {
                        if (typeof AI_CONFIG?.baseURL === 'string' && AI_CONFIG.baseURL && url.startsWith(AI_CONFIG.baseURL)) return true;
                    } catch(e) { /* ignore */ }
                    return false;
                };
                const encoder = new TextEncoder();

                // 狀態存儲
                const store = {
                    count: 0,
                    calls: [],
                    uiEnabled: true,
                    maxRows: 50
                };
                window.__aiMon = store;

                // UI：懸浮面板
                let panel, panelBody, toggleBtn;
                function ensurePanel() {
                    if (!store.uiEnabled) return;
                    if (panel) return;
                    panel = document.createElement('div');
                    panel.setAttribute('id', 'ai-monitor-panel');
                    panel.style.cssText = [
                        'position:fixed', 'right:12px', 'bottom:12px', 'z-index:99999',
                        'min-width:220px', 'max-width:360px', 'max-height:50vh',
                        'background:rgba(17,17,17,0.9)', 'color:#fff', 'font:12px/1.4 Arial, sans-serif',
                        'border-radius:8px', 'box-shadow:0 4px 16px rgba(0,0,0,0.35)', 'overflow:hidden'
                    ].join(';');

                    const header = document.createElement('div');
                    header.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(0,0,0,0.25);cursor:default;';
                    header.innerHTML = '<strong style="font-size:12px;">AI Monitor</strong>';

                    toggleBtn = document.createElement('button');
                    toggleBtn.textContent = '▾';
                    toggleBtn.title = '展開/收起 (Alt+M)';
                    toggleBtn.style.cssText = 'background:#2d8; color:#000; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; font-size:12px;';
                    header.appendChild(toggleBtn);

                    panelBody = document.createElement('div');
                    panelBody.style.cssText = 'padding:8px 10px; display:block;';
                    panelBody.innerHTML = '<div>等待請求…</div>';

                    panel.appendChild(header);
                    panel.appendChild(panelBody);
                    document.body.appendChild(panel);

                    let collapsed = false;
                    function setCollapsed(v){
                        collapsed = v;
                        panelBody.style.display = collapsed ? 'none' : 'block';
                        toggleBtn.textContent = collapsed ? '▸' : '▾';
                    }
                    toggleBtn.addEventListener('click', () => setCollapsed(!collapsed));

                    // Alt+M 切換
                    document.addEventListener('keydown', (e) => {
                        if (e.altKey && (e.key === 'm' || e.key === 'M')) {
                            if (!panel) return;
                            setCollapsed(panelBody.style.display !== 'none');
                        }
                    });
                }

                function fmtKB(bytes){ return (bytes/1024).toFixed(1) + ' KB'; }
                function safeLen(str){ return (str||'').length; }

                function updatePanel(rec) {
                    try {
                        ensurePanel();
                        if (!panelBody) return;
                        const last = rec || store.calls[store.calls.length - 1];
                        const totalTokens = store.calls.reduce((s,c)=> s + (c.usage?.total_tokens||0), 0);
                        const totalPrompt = store.calls.reduce((s,c)=> s + (c.usage?.prompt_tokens||0), 0);
                        const totalCompletion = store.calls.reduce((s,c)=> s + (c.usage?.completion_tokens||0), 0);
                        const rows = store.calls.slice(-5).map(c => (
                            `<tr>
                                <td style="padding:2px 6px;">${c.status}</td>
                                <td style="padding:2px 6px;">${(c.durationMs||0)}ms</td>
                                <td style="padding:2px 6px;">${(c.messagesLen||0)}</td>
                                <td style="padding:2px 6px;">${(c.sysLen||0)}</td>
                                <td style="padding:2px 6px;">${fmtKB(c.payloadSize||0)}</td>
                                <td style="padding:2px 6px;">${c.usage?.total_tokens||'-'}</td>
                            </tr>`
                        )).join('');
                        panelBody.innerHTML = `
                            <div style="margin-bottom:6px;">
                                <span>總請求：<b>${store.count}</b></span>
                                <span style="margin-left:10px;">累計 tokens：<b>${totalTokens}</b></span>
                            </div>
                            <div style="margin-bottom:6px; color:#ccc;">
                                prompt：${totalPrompt}，completion：${totalCompletion}
                            </div>
                            ${last ? `
                            <div style="margin-bottom:6px;">
                                最近：status <b>${last.status}</b>，耗時 <b>${last.durationMs}ms</b>，messages <b>${last.messagesLen}</b>，system長度 <b>${last.sysLen}</b>，payload <b>${fmtKB(last.payloadSize)}</b>，tokens <b>${last.usage?.total_tokens || '-'}</b>
                            </div>` : ''}
                            <div style="overflow:auto; max-height:26vh; border-top:1px solid rgba(255,255,255,0.1);">
                                <table style="width:100%; border-collapse:collapse; font-size:11px;">
                                    <thead><tr style="color:#8dd;">
                                        <th style="text-align:left; padding:4px 6px;">Status</th>
                                        <th style="text-align:left; padding:4px 6px;">耗時</th>
                                        <th style="text-align:left; padding:4px 6px;">Msgs</th>
                                        <th style="text-align:left; padding:4px 6px;">SysLen</th>
                                        <th style="text-align:left; padding:4px 6px;">Payload</th>
                                        <th style="text-align:left; padding:4px 6px;">Tokens</th>
                                    </tr></thead>
                                    <tbody>${rows || ''}</tbody>
                                </table>
                            </div>
                            <div style="margin-top:6px; color:#aaa;">Alt+M 展開/收起；Console：__aiMonSummary() / __aiMonQuick()</div>
                        `;
                    } catch(e) { /* no-op */ }
                }

                // 包裝 fetch
                window.fetch = async function patchedFetch(input, init) {
                    const url = (typeof input === 'string' ? input : (input && input.url)) || '';
                    const watching = isChatApi(url);
                    const start = Date.now();
                    let payloadSize = 0, messagesLen = 0, sysLen = 0;
                    if (watching && init && init.body) {
                        try {
                            payloadSize = encoder.encode(init.body).length;
                            const parsed = JSON.parse(init.body);
                            const msgs = Array.isArray(parsed.messages) ? parsed.messages : [];
                            messagesLen = msgs.length;
                            sysLen = msgs.filter(m => m && m.role === 'system').reduce((s,m)=> s + safeLen(m.content), 0);
                        } catch(e) { /* ignore parse errors */ }
                    }

                    const res = await originalFetch.apply(this, arguments);
                    if (watching) {
                        let usage = null;
                        try {
                            const clone = res.clone();
                            const data = await clone.json();
                            usage = data && data.usage ? data.usage : null;
                        } catch(e) { /* ignore */ }
                        const rec = {
                            time: new Date().toISOString(),
                            url, status: res.status,
                            durationMs: Date.now() - start,
                            payloadSize, messagesLen, sysLen,
                            usage
                        };
                        store.count += 1;
                        store.calls.push(rec);
                        if (store.calls.length > store.maxRows) store.calls.splice(0, store.calls.length - store.maxRows);
                        console.log('[AI req]', rec);
                        if (messagesLen > 40 || sysLen > 2000 || payloadSize > 150 * 1024) {
                            console.warn('⚠️ 可疑：消息數/系統提示過長/載荷過大', { messagesLen, sysLen, payloadKB: (payloadSize/1024).toFixed(1) });
                        }
                        updatePanel(rec);
                    }
                    return res;
                };

                // Console 幫手
                window.__aiMonSummary = function __aiMonSummary() {
                    const s = window.__aiMon; if (!s) return console.warn('未啟用監視器');
                    const rows = s.calls.map(c => ({
                        time: c.time,
                        payloadKB: (c.payloadSize/1024).toFixed(1),
                        messages: c.messagesLen,
                        sysChars: c.sysLen,
                        status: c.status,
                        durMs: c.durationMs,
                        prompt: c.usage?.prompt_tokens,
                        completion: c.usage?.completion_tokens,
                        total: c.usage?.total_tokens
                    }));
                    try { console.table(rows); } catch(e) { console.log(rows); }
                    const sum = s.calls.reduce((a,c)=>({
                        payload: a.payload + (c.payloadSize||0),
                        prompt: a.prompt + (c.usage?.prompt_tokens||0),
                        completion: a.completion + (c.usage?.completion_tokens||0),
                        total: a.total + (c.usage?.total_tokens||0)
                    }), {payload:0,prompt:0,completion:0,total:0});
                    console.log('Total calls:', s.calls.length,
                                '| Total payload KB:', (sum.payload/1024).toFixed(1),
                                '| Total prompt_tokens:', sum.prompt,
                                '| Total completion_tokens:', sum.completion,
                                '| Total tokens:', sum.total);
                };

                window.__aiMonQuick = function __aiMonQuick(n=10) {
                    const s = window.__aiMon; if (!s) return console.warn('未啟用監視器');
                    const last = s.calls.slice(-n);
                    const rows = last.map((c,i)=>({
                        i: s.calls.length - last.length + i + 1,
                        payloadKB: (c.payloadSize/1024).toFixed(1),
                        messages: c.messagesLen,
                        sysChars: c.sysLen,
                        status: c.status,
                        durMs: c.durationMs,
                        tokens: c.usage?.total_tokens
                    }));
                    try { console.table(rows); } catch(e) { console.log(rows); }
                    const suspicious = last.filter(c => c.messagesLen > 40 || c.sysLen > 2000 || c.payloadSize > 150*1024);
                    if (suspicious.length) {
                        console.warn('⚠️ 發現可疑請求（system過長/消息過多/載荷過大）數量：', suspicious.length);
                        console.log(suspicious);
                    }
                };

                // 延後初始化面板，避免首屏閃爍
                setTimeout(() => { try { ensurePanel(); } catch(e){} }, 500);
                console.log('✅ AI 請求監視器已啟用（Alt+M 切換面板）');
            } catch (err) {
                console.warn('AI 監視器初始化失敗:', err);
            }
        })();
    </script>
    

</body>
</html>
