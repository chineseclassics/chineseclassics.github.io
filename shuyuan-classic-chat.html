<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <title>太虛幻聊 - 與古今名士暢談千古</title>
    <style>
        /* ===== 太虛幻聊統一設計規範 ===== */
        /* 
         * 🎯 狀態欄適配標準：所有頁面頂部元素統一適配手機狀態欄
         * - 聊天頭部(.wx-header): padding: 32px 15px 8px 15px ✅
         * - 群組詳情頭部(.detail-header): height: 88px, padding: 36px 15px 10px 15px ✅  
         * - 個人資料頭部(.profile-nav-bar): height: 88px, padding: 36px 15px 10px 15px ✅
         * - 主界面頭部(.main-header): padding: 32px 0 8px 0 ✅
         * - 群組列表頭部(.group-list-header): padding: 32px 15px 8px 15px ✅
         * - 朋友圈頭部(.moments-header): padding: 76px 15px 15px 15px ✅
         * 
         * 🎨 設計統一標準：
         * - 狀態欄預留空間：32px (移動端適配標準)
         * - 左右邊距：15px (與微信保持一致)
         * - 底部間距：8px (頂部導航元素)
         * - 字體大小：17px (標題), 18px (主標題)
         * - 背景色：#f6f6f6 (淺色頭部), #393a3f (深色頭部)
         * 
         * 💫 設計目標：確保所有界面具有一致的"微信"風格體驗
         *    所有頁面的頂部內容不會被手機狀態欄遮擋，保持視覺統一性
         */
        
        /* 基礎樣式 - 模擬微信風格 */
        
        /* 全局移动端优化 */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* 防止移动端双击缩放 */
        html {
            touch-action: manipulation;
        }
        
        /* 优化移动端滚动 */
        body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* 新增成員資料頁面樣式 */
        .profile-nav-bar {
            height: 88px; /* 充足header高度：32px頂部 + 46px按鈕懸停空間 + 10px底部間距 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 36px 15px 10px 15px; /* 適度增加頂部間距，減少底部間距以平衡 */
            background-color: var(--wx-header-bg);
            position: relative;
            min-height: 88px; /* 確保最小高度 */
        }
        
        /* 統一後退按鈕樣式 */
        .back-btn-unified {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .back-btn-unified:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .back-btn-unified:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .profile-back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .profile-back-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .profile-back-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .profile-more-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            font-size: 20px;
            transition: all 0.2s ease;
            margin-right: -4px;
            font-weight: normal;
        }
        
        .profile-more-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .profile-more-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .profile-header {
            background-color: #ffffff;
            padding: 20px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .profile-avatar {
            width: 65px;
            height: 65px;
            border-radius: 5px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            background-color: #f8f8f8;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 22px;
            margin: 0 0 5px 0;
            font-weight: normal;
        }
        
        .profile-wechat-id, .profile-location {
            font-size: 14px;
            color: #888;
            margin: 3px 0;
        }
        
        .profile-menu-section {
            background-color: #ffffff;
            margin-bottom: 8px;
        }
        
        .profile-menu-item {
            display: flex;
            padding: 15px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .menu-item-label {
            flex: 1;
            font-size: 17px;
        }
        
        .menu-item-value {
            color: #888;
            margin-right: 5px;
        }
        
        .menu-item-arrow {
            color: #cccccc;
        }
        
        .profile-moments-section {
            background-color: #ffffff;
            margin-top: 8px;
            border-top: 8px solid #f5f5f5;
            position: relative;
            overflow: hidden;
        }
        
        .profile-moments-section::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: radial-gradient(circle at center, rgba(93, 92, 222, 0.08) 0%, rgba(255, 255, 255, 0) 70%);
            pointer-events: none;
            z-index: 1;
        }
        
        .moments-preview {
            display: flex;
            gap: 6px;
            margin-right: 10px;
            position: relative;
            z-index: 2;
        }
        
        .moment-preview-image {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f0f0f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #viewMoments {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        #viewMoments:hover {
            background-color: rgba(93, 92, 222, 0.12);
        }
        
        #viewMoments:active {
            background-color: rgba(93, 92, 222, 0.18);
        }
        
        #viewMoments::before {
            content: "";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #viewMoments:hover::before {
            opacity: 1;
        }
        
        .profile-more-section {
            background-color: #ffffff;
            margin-top: 8px;
            border-top: 8px solid #f5f5f5;
        }
        
        .profile-action-buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background-color: #f5f5f5;
            padding: 15px;
            gap: 10px;
            box-sizing: border-box;
        }
        
        .action-message-btn, .action-call-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            padding: 10px 5px;
            border-radius: 5px;
            font-size: 13px;
            color: #576b95;
            text-align: center;
            word-break: keep-all;
            white-space: nowrap;
        }
        
        .action-message-btn svg, .action-call-btn svg {
            margin-bottom: 5px;
            max-width: 20px;
            height: auto;
        }
        :root {
            --wx-bg: #ededed;
            --wx-chat-bg: #ededed;
            --wx-green: #91ED61;
            --wx-gray: #9c9c9c;
            --wx-light-gray: #f1f1f1;
            --wx-dark-gray: #666666;
            --wx-header-bg: #f6f6f6;
            --wx-input-bg: #f6f6f6;
            --wx-bubble-self: #95ec69;
            --wx-bubble-others: #ffffff;
            --wx-red-packet: #fa5151;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 太虛幻境全頁面背景 */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 完全禁止滚动 */
        }
        
        body {
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(138, 43, 226, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(75, 0, 130, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(25, 25, 112, 0.2) 0%, transparent 60%),
                linear-gradient(135deg, #0f0f23 0%, #1a1a3a 25%, #2d1b69 50%, #1e3a8a 75%, #0f172a 100%);
            position: relative;
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }
        
        /* 銀河系背景容器 */
        .galaxy-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        
        /* 銀河中心 */
        .galaxy-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 160px;
            height: 160px;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, rgba(255, 140, 0, 0.6) 20%, rgba(255, 69, 0, 0.4) 40%, rgba(255, 20, 147, 0.3) 60%, rgba(138, 43, 226, 0.2) 80%, transparent 100%);
            border-radius: 50%;
            animation: galaxyPulse 15s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.6), 0 0 80px rgba(255, 140, 0, 0.4), 0 0 120px rgba(255, 69, 0, 0.2);
        }
        
        /* 銀河旋臂容器 */
        .spiral-arm {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            animation: galaxyRotate 200s linear infinite;
            }
        
        /* 第一條旋臂 */
        .spiral-arm:nth-child(2) {
            animation-delay: 0s;
        }
        
        /* 第二條旋臂 - 180度相位差 */
        .spiral-arm:nth-child(3) {
            animation-delay: -100s;
            }
        
        /* 粒子點 */
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            animation: twinkle 3s ease-in-out infinite;
        }
        
        /* 不同大小的粒子 */
        .particle.small {
            width: 1px;
            height: 1px;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
        }
        
        .particle.medium {
            width: 2px;
            height: 2px;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }
        
        .particle.large {
            width: 3px;
            height: 3px;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
        }
        
        /* 彩色星體 */
        .particle.colored {
            background: rgba(138, 43, 226, 0.9);
            box-shadow: 0 0 8px rgba(138, 43, 226, 0.6);
        }
        
        .particle.blue {
            background: rgba(70, 130, 180, 0.9);
            box-shadow: 0 0 6px rgba(70, 130, 180, 0.6);
        }
        
        .particle.gold {
            background: rgba(255, 215, 0, 0.9);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        
        /* 銀河塵埃雲 */
        .nebula-cloud {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(ellipse, rgba(138, 43, 226, 0.1) 0%, rgba(75, 0, 130, 0.05) 50%, transparent 100%);
            animation: nebulaFloat 25s ease-in-out infinite;
        }
        
        /* 額外的星空裝飾層 */
        .star-field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(0.8px 0.8px at 25px 35px, rgba(255,255,255,0.5), transparent),
                radial-gradient(0.6px 0.6px at 125px 45px, rgba(70, 130, 180, 0.4), transparent),
                radial-gradient(0.7px 0.7px at 185px 95px, rgba(255,255,255,0.4), transparent),
                radial-gradient(0.8px 0.8px at 285px 75px, rgba(255,255,255,0.5), transparent),
                radial-gradient(0.6px 0.6px at 335px 105px, rgba(147, 51, 234, 0.4), transparent),
                radial-gradient(0.5px 0.5px at 385px 55px, rgba(255,255,255,0.3), transparent),
                radial-gradient(0.7px 0.7px at 85px 125px, rgba(138, 43, 226, 0.3), transparent),
                radial-gradient(0.6px 0.6px at 245px 165px, rgba(70, 130, 180, 0.3), transparent);
            background-repeat: repeat;
            background-size: 450px 150px;
            animation: starfieldMove 80s linear infinite;
            pointer-events: none;
            z-index: 1;
            opacity: 0.7;
            }
            
        /* 太虛幻聊 App 圖標 */
        .app-icon-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20; /* 提高z-index確保在所有銀河系元素之上 */
            animation: appIconFloat 8s ease-in-out infinite;
        }
        
        .app-icon {
            width: 120px;
            height: 120px;
            border-radius: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8a2be2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 8px 32px rgba(102, 126, 234, 0.4),
                0 4px 16px rgba(138, 43, 226, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            }
            
        .app-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
            border-radius: 24px 24px 60px 60px;
            }
            
        .app-icon:hover {
            transform: scale(1.05);
            box-shadow: 
                0 12px 40px rgba(102, 126, 234, 0.5),
                0 6px 20px rgba(138, 43, 226, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .app-icon-symbol {
            font-size: 48px;
            margin-bottom: 4px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .app-icon-text {
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            text-align: center;
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }
        
        .app-icon-glow {
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: iconGlow 4s ease-in-out infinite alternate;
            pointer-events: none;
            }
            
        /* App圖標浮動動畫 */
        @keyframes appIconFloat {
            0%, 100% {
                transform: translate(-50%, -50%) translateY(0px) rotate(0deg);
            }
            25% {
                transform: translate(-50%, -50%) translateY(-8px) rotate(1deg);
            }
            50% {
                transform: translate(-50%, -50%) translateY(0px) rotate(0deg);
            }
            75% {
                transform: translate(-50%, -50%) translateY(-5px) rotate(-1deg);
            }
        }
        
        /* 圖標光暈動畫 */
        @keyframes iconGlow {
            0% {
                opacity: 0.5;
                transform: scale(1);
            }
            100% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }
        
        /* iOS風格打開動畫 */
        @keyframes iOSAppOpen {
            0% {
                transform: translateX(-50%) translateY(-50%) scale(0.1);
                opacity: 0;
                border-radius: 24px;
            }
            50% {
                transform: translateX(-50%) translateY(-50%) scale(0.5);
                opacity: 0.8;
                border-radius: 20px;
            }
            100% {
                transform: translateX(-50%) translateY(-50%) scale(1);
                opacity: 1;
                border-radius: 16px;
            }
        }
        
        @keyframes iconDisappear {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
        }
        }
        

        
        .app-icon-container.disappearing {
            animation: iconDisappear 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* 星空移動動畫 */
        @keyframes starfieldMove {
            from {
                transform: translateY(0px) translateX(0px);
            }
            to {
                transform: translateY(-130px) translateX(-50px);
            }
        }
        
        .nebula-cloud:nth-child(1) {
            width: 400px;
            height: 200px;
            top: 15%;
            left: 5%;
            animation-delay: 0s;
            background: radial-gradient(ellipse, rgba(138, 43, 226, 0.15) 0%, rgba(75, 0, 130, 0.08) 50%, transparent 100%);
        }
        
        .nebula-cloud:nth-child(2) {
            width: 350px;
            height: 250px;
            top: 55%;
            right: 10%;
            animation-delay: -8s;
            background: radial-gradient(ellipse, rgba(70, 130, 180, 0.12) 0%, rgba(25, 25, 112, 0.06) 50%, transparent 100%);
        }
        
        .nebula-cloud:nth-child(3) {
            width: 500px;
            height: 150px;
            bottom: 20%;
            left: 25%;
            animation-delay: -16s;
            background: radial-gradient(ellipse, rgba(147, 51, 234, 0.1) 0%, rgba(79, 70, 229, 0.05) 50%, transparent 100%);
        }
        
        .nebula-cloud:nth-child(4) {
            width: 300px;
            height: 300px;
            top: 35%;
            left: 60%;
            animation-delay: -12s;
            background: radial-gradient(ellipse, rgba(255, 20, 147, 0.08) 0%, rgba(138, 43, 226, 0.04) 50%, transparent 100%);
        }
        
        .nebula-cloud:nth-child(5) {
            width: 450px;
            height: 180px;
            top: 75%;
            left: 15%;
            animation-delay: -20s;
            background: radial-gradient(ellipse, rgba(30, 144, 255, 0.1) 0%, rgba(0, 191, 255, 0.05) 50%, transparent 100%);
        }
        
        /* 動畫定義 */
        @keyframes galaxyRotate {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            to {
                transform: translate(-50%, -50%) rotate(360deg);
        }
        }
        
        @keyframes galaxyPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
        }
        }
        
        @keyframes twinkle {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        @keyframes nebulaFloat {
            0%, 100% {
                transform: translateX(0) translateY(0) rotate(0deg);
                opacity: 0.3;
            }
            33% {
                transform: translateX(20px) translateY(-15px) rotate(120deg);
                opacity: 0.5;
            }
            66% {
                transform: translateX(-15px) translateY(10px) rotate(240deg);
                opacity: 0.4;
        }
        }
        

        

        
        /* 聊天容器 */
        .wx-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--wx-chat-bg);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* 微信頭部 */
        .wx-header {
            background-color: var(--wx-header-bg);
            height: 64px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px; /* 移除顶部多余空间 */
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 50;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        

        
        .wx-back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #000;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            margin-left: -4px;
            font-weight: normal;
        }
        
        .wx-back-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .wx-back-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .wx-header .wx-header-title {
            /* 標題居中定位 */
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            
            /* 清除干擾樣式 */
            display: block !important;
            visibility: visible !important;
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            outline: none !important;
            pointer-events: none !important;
            white-space: nowrap !important;
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif !important;
            
            /* 文字樣式 */
            font-size: 17px !important;
            font-weight: 500 !important;
            color: #000 !important;
            text-align: center !important;
        }
        
        /* 移除可能的偽元素 */
        .wx-header .wx-header-title::before,
        .wx-header .wx-header-title::after {
            display: none !important;
            content: none !important;
        }
        
        /* 確保沒有其他class干擾 */
        .wx-header-title,
        div.wx-header-title {
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .wx-menu-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            color: #000;
            font-weight: normal;
            margin-right: -4px;
        }
        
        .wx-menu-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .wx-menu-btn:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        /* 微信聊天容器 */
        .wx-chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 10px 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 80px; /* 增加底部間距，為輸入框留出空間 */
            z-index: 1;
            min-height: 0; /* 允許flex子項縮小 */
            height: calc(100% - 66px); /* 總高度減去輸入框高度 */
        }
        
        /* 時間戳 */
        .wx-time {
            text-align: center;
            font-size: 14px;
            color: #b2b2b2;
            margin: 10px 0;
            padding: 0 5px;
        }
        
        /* 消息容器 */
        .wx-msg {
            display: flex;
            margin-bottom: 16px;
            position: relative;
            width: 100%;
        }
        
        .wx-msg-self {
            flex-direction: row-reverse;
        }
        
        /* 頭像樣式 */
        .wx-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            flex-shrink: 0;
            font-size: 26px;
        }
        
        /* 消息泡泡 */
        .wx-content-wrapper {
            max-width: calc(100% - 100px);
            display: flex;
            flex-direction: column;
        }
        
        .wx-msg-bubble {
            max-width: 100%;
            padding: 8px 11px;
            position: relative;
            word-wrap: break-word;
            display: inline-block;
            text-align: left;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .wx-msg-self .wx-msg-bubble {
            background-color: var(--wx-bubble-self);
            border-radius: 18px 0px 18px 18px; /* 右上角改為直角，與尖角連接 */
            margin-right: 10px;
        }
        
        .wx-msg-others .wx-msg-bubble {
            background-color: var(--wx-bubble-others);
            border-radius: 0px 18px 18px 18px; /* 左上角改為直角，與尖角連接 */
            margin-left: 10px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }
        
        /* 添加微信泡泡的尖角 */
        .wx-msg-self .wx-msg-bubble:after {
            content: '';
            position: absolute;
            right: -6px;
            top: 0;
            width: 0;
            height: 0;
            border-top: 6px solid var(--wx-bubble-self);
            border-right: 6px solid transparent;
        }
        
        .wx-msg-others .wx-msg-bubble:after {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 0;
            height: 0;
            border-top: 6px solid var(--wx-bubble-others);
            border-left: 6px solid transparent;
        }
        
        /* 正在輸入提示樣式 */
        .wx-typing {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            min-height: 36px; /* 改为最小高度以适应文字 */
            padding: 8px 12px;
            background-color: var(--wx-bubble-others);
            border-radius: 0px 18px 18px 18px; /* 左上角改為直角，與尖角連接 */
            margin-left: 10px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .wx-typing:after {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 0;
            height: 0;
            border-top: 6px solid var(--wx-bubble-others);
            border-left: 6px solid transparent;
        }
        
        .typing-dots {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .typing-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #666;
            animation: typingAnimation 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-8px) scale(1.1);
                opacity: 1;
                background-color: #333;
            }
        }
        
        /* 為打字動畫添加脈動效果 */
        .wx-typing {
            animation: typingPulse 2s infinite;
        }
        
        @keyframes typingPulse {
            0%, 100% {
                box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            }
            50% {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }
        }
        
        /* 發送者名稱 */
        .wx-name {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
            padding-left: 11px;
        }
        
        /* 系統消息 */
        .wx-system-msg {
            text-align: center;
            font-size: 12px;
            color: #999;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 10px;
            padding: 3px 8px;
            margin: 8px auto;
            max-width: 70%;
            display: inline-block;
            clear: both;
        }
        
        /* 輸入區域 */
        .wx-input-area {
            height: 66px;
            background-color: var(--wx-input-bg);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 8px 17px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            flex-shrink: 0; /* 防止輸入框被壓縮 */
            box-sizing: border-box;
        }
        
        .wx-voice-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .wx-voice-btn::before {
            content: "";
            display: block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.8);
            position: absolute;
        }
        
        .wx-voice-btn::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: transparent;
            z-index: 1;
        }

        /* 中心点 */
        .wx-voice-btn::before {
            content: "";
            display: block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.8);
            position: absolute;
        }

        /* 重新设计声波图标 */
        .wx-voice-btn::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 8px;
            left: 8px;
            background-color: transparent;
            z-index: 2;
        }

        /* 小圆点 */
        .wx-voice-btn::before {
            content: "";
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: black;
            border-radius: 50%;
            left: 11px;
            top: 14px;
            z-index: 3;
        }

        /* 三个弧形声波 */
        .wx-voice-btn .wave1,
        .wx-voice-btn .wave2,
        .wx-voice-btn .wave3 {
            content: "";
            position: absolute;
            border: 1px solid black;
            border-left: none;
            background: transparent;
            z-index: 2;
        }

        .wx-voice-btn .wave1 {
            height: 6px;
            width: 3px;
            left: 14px;
            top: 13px;
            border-radius: 0 3px 3px 0;
        }

        .wx-voice-btn .wave2 {
            height: 10px;
            width: 5px;
            left: 17px;
            top: 11px;
            border-radius: 0 5px 5px 0;
        }

        .wx-voice-btn .wave3 {
            height: 14px;
            width: 7px;
            left: 22px;
            top: 9px;
            border-radius: 0 7px 7px 0;
        }
        
        .wx-input-box {
            flex: 1;
            height: 32px;
            background-color: #fff;
            border-radius: 18px;
            margin: 0 8px;
            border: none;
            outline: none;
            padding: 0 10px;
            color: #333;
            font-size: 16px;
        }
        
        .wx-input-box::placeholder {
            color: #aaa;
        }
        
        /* @某人功能樣式 */
        .mention-popup {
            position: absolute;
            bottom: 66px;
            left: 8px;
            right: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 300;
            display: none;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .mention-item:hover {
            background-color: #f8f8f8;
        }
        
        .mention-item:last-child {
            border-bottom: none;
        }
        
        .mention-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 12px;
            background-color: #f0f0f0;
        }
        
        .mention-name {
            font-size: 16px;
            color: #333;
        }
        
        /* 消息中的@樣式 */
        .mention-text {
            color: #576b95;
            background-color: rgba(87, 107, 149, 0.1);
            padding: 2px 4px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        /* @提示樣式 */
        .mention-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background-color: #ff4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: bold;
        }
        
        .wx-emoji-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #7d7e80;
            cursor: pointer;
        }
        
        .wx-plus-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #7d7e80;
            cursor: pointer;
        }
        
        /* Emoji面板 */
        .emoji-panel {
            position: absolute;
            bottom: 44px;
            left: 0;
            right: 0;
            background-color: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            height: 200px;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .emoji-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        
        .emoji-item:hover {
            background-color: #f0f0f0;
        }
        
        /* 功能選項面板样式 */
        .function-panel {
            position: absolute;
            bottom: 44px;
            left: 0;
            right: 0;
            background-color: #f6f6f6;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            display: none;
            flex-direction: column;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 0 15px;
        }
        
        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        
        .function-icon {
            width: 56px;
            height: 56px;
            background-color: #fff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            color: #353535;
        }
        
        .function-icon svg {
            width: 28px;
            height: 28px;
        }
        
        .function-text {
            font-size: 12px;
            color: #636363;
        }
        
        .function-dots {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 6px;
        }
        
        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #CBCBCB;
        }
        
        .dot.active {
            background-color: #707070;
        }
        
        /* 标识可点击的功能项 */
        .active-function .function-icon {
            position: relative;
        }
        
        .function-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e64340;
            border: 2px solid #f6f6f6;
        }
        

        
        /* 群組詳情頁面 */
        .group-details {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: auto;
            box-sizing: border-box;
        }
        
        .detail-header {
            background-color: var(--wx-header-bg);
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 15px; /* 移除顶部多余空间 */
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .detail-back {
            width: 44px;
            height: 44px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-left: -4px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
            color: #000;
            font-weight: normal;
        }
        
        .detail-back:hover {
            background-color: rgba(0, 0, 0, 0.08);
            transform: scale(1.05);
        }
        
        .detail-back:active {
            background-color: rgba(0, 0, 0, 0.15);
            transform: scale(0.95);
        }
        
        .detail-title {
            flex: 1;
            text-align: center;
            font-size: 17px;
            font-weight: normal;
        }
        
        .group-members-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            padding: 20px 10px;
            gap: 10px;
            background-color: #fff;
            border-bottom: 10px solid #f5f5f5;
        }
        
        .member-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 3px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .member-name {
            font-size: 12px;
            color: #333;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        
        .detail-section {
            background-color: #fff;
            padding: 0 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-item-label {
            font-size: 17px;
            color: #333;
        }
        
        .detail-item-value {
            font-size: 17px;
            color: #888;
            display: flex;
            align-items: center;
        }
        
        .detail-arrow {
            margin-left: 5px;
            font-size: 14px;
        }
        
        /* 私聊對話詳情頁面 */
        .private-chat-details {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 150;
            display: none;
            flex-direction: column;
            overflow: auto;
            color: #333;
            box-sizing: border-box;
        }
        
        .private-chat-details .detail-header {
            background-color: var(--wx-header-bg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .private-chat-details .detail-back {
            color: #000;
        }
        
        .private-chat-details .detail-back:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }
        
        .private-chat-details .detail-back:active {
            background-color: rgba(0, 0, 0, 0.15);
        }
        
        .private-chat-details .detail-title {
            color: #000;
        }
        
        .private-chat-user-section {
            background-color: #fff;
            padding: 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 10px solid #f5f5f5;
        }
        
        .private-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .private-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .private-user-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .add-user-btn {
            width: 50px;
            height: 50px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
        }
        
        .add-user-icon {
            font-size: 20px;
            color: #999;
            font-weight: 300;
        }
        
        .private-detail-section {
            background-color: #fff;
            margin: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .private-detail-section:first-of-type {
            margin-top: 0;
        }
        
        .private-detail-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            background-color: #fff;
            transition: background-color 0.2s;
        }
        
        .private-detail-item:last-child {
            border-bottom: none;
        }
        
        .private-detail-item.hoverable:hover {
            background-color: #f8f8f8;
            cursor: pointer;
        }
        
        .private-detail-item.delete-item {
            color: #ff4757;
        }
        
        .private-detail-item.delete-item:hover {
            background-color: #f8f8f8;
            cursor: pointer;
        }
        
        .private-detail-item-label {
            font-size: 17px;
            color: #333;
        }
        
        .private-detail-item-arrow {
            font-size: 14px;
            color: #888;
            font-weight: normal;
        }
        
        /* 切換開關樣式 */
        .private-toggle-switch {
            width: 50px;
            height: 30px;
            background-color: #ddd;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .private-toggle-switch.active {
            background-color: #07c160;
        }
        
        .toggle-slider {
            width: 26px;
            height: 26px;
            background-color: #ffffff;
            border-radius: 13px;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .private-toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }
        
        /* 成員資料頁面 */
        .member-profile {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 200;
            display: none;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .profile-header {
            background-color: #fff;
            padding: 20px;
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-right: 15px;
        }
        
        .profile-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .profile-name {
            font-size: 22px;
            font-weight: normal;
            margin-bottom: 5px;
        }
        
        .profile-nickname {
            font-size: 14px;
            color: #888;
        }
        
        .profile-actions {
            display: flex;
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 10px solid #f5f5f5;
        }
        
        .profile-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            flex: 1;
        }
        
        .action-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #09bb07;
        }
        
        .action-text {
            font-size: 12px;
            color: #333;
        }
        
        /* 朋友圈界面 */
        .moments {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #fff;
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow: auto;
        }
        
        .moment-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .moment-header {
            display: flex;
        }
        
        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 10px;
        }
        
        .moment-content {
            flex: 1;
        }
        
        .moment-name {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 3px;
            color: #576b95;
        }
        
        .moment-text {
            font-size: 15px;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .moment-time {
            font-size: 14px;
            color: #b2b2b2;
            margin-top: 5px;
        }
        
        /* 進場動畫 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .wx-fade-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
        
        /* 統一父容器 - 控制所有頁面的圓角和尺寸 */
        .app-universal-container {
            width: 390px;
            height: 844px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3), 0 0 40px rgba(75, 0, 130, 0.2);
            box-sizing: border-box;
            z-index: 5;
            opacity: 0; /* 初始不可见 */
            visibility: hidden; /* 初始隐藏 */
            transition: opacity 0.4s ease, visibility 0.4s ease; /* 平滑过渡 */
        }
        
        /* 父容器显示状态 */
        .app-universal-container.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* 登入頁面樣式 */
        .login-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
            background: transparent;
            display: none; /* 初始隱藏 */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* 防止滚动条 */
            padding: 0;
            box-sizing: border-box;
            width: 100%; /* 相对于父容器 */
            height: 100%; /* 相对于父容器 */
        }
        
        .login-content {
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0; /* 使用父容器的圆角 */
            box-shadow: none; /* 使用父容器的阴影 */
            backdrop-filter: blur(10px);
            padding: 15px 16px 10px 16px; /* 减少内边距 */
            animation: slideInUp 0.6s ease-out;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden; /* 完全隐藏滚动条 */
            align-items: center;
            justify-content: space-between; /* 内容均匀分布 */
            max-width: 100%;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 8px; /* 进一步减少底部间距 */
            margin-top: 5px; /* 大幅减少顶部间距 */
            flex-shrink: 0;
            width: 100%;
            max-width: 100%;
        }
        
        .app-title {
            margin-bottom: 8px;
        }
        
        .title-main {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2px;
        }
        
        .title-sub {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .title-decoration {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .star {
            font-size: 20px;
            animation: twinkle 2s infinite alternate;
        }
        
        .star:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .star:nth-child(3) {
            animation-delay: 1s;
        }
        
        @keyframes twinkle {
            from { opacity: 0.5; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .welcome-message {
            background: linear-gradient(135deg, rgba(255, 248, 220, 0.95) 0%, rgba(255, 255, 255, 0.95) 100%);
            border-radius: 8px; /* 减少圆角，避免与父容器冲突 */
            padding: 12px; /* 减少内边距 */
            margin-bottom: 8px; /* 减少底部间距 */
            border: 2px solid #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            flex: 1; /* 使欢迎消息占用可用空间 */
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            min-height: 0; /* 允许内容压缩 */
        }
        
        .welcome-message::before {
            content: "📋 重要說明";
            position: absolute;
            top: -10px;
            left: 16px;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 6px; /* 减少圆角 */
            font-size: 11px;
            font-weight: bold;
        }
        
        .welcome-title {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            margin-top: 8px;
        }
        
        .welcome-text {
            font-size: 11px; /* 减小字体 */
            line-height: 1.3; /* 减小行高 */
            color: #444;
            text-align: left;
            margin-bottom: 8px; /* 减少底部间距 */
            overflow: hidden; /* 隐藏超出内容 */
        }
        
        .welcome-confirmation {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px; /* 减少圆角 */
            padding: 10px;
            text-align: center;
            border: 1px dashed #667eea;
            margin-top: auto; /* 推到底部 */
        }
        
        .confirmation-text {
            font-size: 11px;
            color: #667eea;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px; /* 减少圆角 */
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .confirm-btn.confirmed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            cursor: default;
        }
        
        .login-form.form-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .login-form.form-disabled input,
        .login-form.form-disabled select,
        .login-form.form-disabled button {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
            background-color: #f5f5f5 !important;
        }
        
        /* 启用状态的样式 */
        .login-form:not(.form-disabled) input,
        .login-form:not(.form-disabled) select,
        .login-form:not(.form-disabled) button {
            opacity: 1 !important;
            pointer-events: auto !important;
            cursor: auto !important;
        }
        
        .login-form {
            margin-bottom: 0; /* 移除底部间距 */
            flex-shrink: 0; /* 避免压缩 */
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .form-group {
            margin-bottom: 8px; /* 减少间距 */
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px; /* 减少圆角 */
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fff;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .password-hint {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
            font-style: italic;
            line-height: 1.2;
        }
        
        .button-container {
            margin-top: auto;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 6px; /* 减少圆角 */
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            min-height: 44px;
        }
        
        .login-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .debug-btn {
            width: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 6px; /* 减少圆角 */
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-bottom: 8px;
            opacity: 0.9;
            position: relative;
            z-index: 2;
            min-height: 44px;
        }
        
        .debug-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            opacity: 1;
        }
        
        .debug-btn:active {
            transform: translateY(0);
        }
        
        .btn-icon {
            font-size: 18px;
        }
        
        .login-error {
            background-color: #fee;
            border: 1px solid #fcc;
            border-radius: 4px; /* 减少圆角 */
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .error-icon {
            font-size: 16px;
        }
        
        .error-text {
            font-size: 14px;
            color: #d33;
        }
        
        .login-footer {
            text-align: center;
            padding: 20px 0 30px 0; /* 增加上下内边距 */
            border-top: 1px solid #eee;
            margin-top: auto; /* 推到底部 */
            flex-shrink: 0;
        }
        
        .footer-text {
            font-size: 10px;
            color: #888;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .footer-icons {
            font-size: 14px;
            letter-spacing: 6px;
            opacity: 0.7;
        }
        
                 /* ===== 移动端响应式适配 ===== */
         
                  /* 基础移动端优化 */
         @media (max-width: 768px) {
             /* 父容器移动端适配 */
             .app-universal-container {
                 width: 100vw;
                 height: 100vh;
                 top: 0;
                 left: 0;
                 transform: none;
                 border-radius: 0;
             }
             
             /* 确保游戏界面在移动设备上完全显示 */
            body {
                margin: 0;
                padding: 0;
                overflow-x: hidden;
                font-size: 16px; /* 防止iOS Safari自动缩放 */
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
                         /* 登录界面移动端优化 */
             .login-container {
                 width: 100%;
                 height: 100%;
                 padding: 0;
                 box-sizing: border-box;
                 border-radius: 0;
                 overflow: hidden;
                 position: absolute;
                 top: 0;
                 left: 0;
             }
            
                         .login-content {
                 width: 100%;
                 height: 100vh;
                 padding: 10px 12px 8px 12px; /* 进一步减少内边距 */
                 box-sizing: border-box;
                 border-radius: 0;
                 overflow: hidden; /* 隐藏滚动条 */
                 justify-content: space-between; /* 均匀分布内容 */
             }
            
            .login-header h1 {
                font-size: 1.8rem;
            }
            
            .login-subtitle {
                font-size: 0.9rem;
            }
            
            /* 表单组件移动端优化 */
            .form-group input,
            .form-group select {
                padding: 12px 15px;
                font-size: 16px; /* 防止iOS自动缩放 */
                border-radius: 8px;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            .login-btn,
            .debug-btn {
                padding: 15px 20px;
                font-size: 16px;
                border-radius: 8px;
                min-height: 48px; /* 增加触摸面积 */
            }
            
            /* 主界面移动端优化 */
            .main-container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                position: fixed;
                border-radius: 0;
            }
            
            .main-header {
                height: 56px;
                padding: 8px 0;
                /* 适配安全区域 */
                padding-top: max(8px, env(safe-area-inset-top));
            }
            
            .main-title {
                font-size: 17px;
            }
            
            .main-title-count {
                font-size: 15px;
            }
            
            /* 聊天列表移动端优化 */
            .chat-item {
                padding: 15px;
                min-height: 72px;
                box-sizing: border-box;
            }
            
            .chat-avatar {
                width: 52px;
                height: 52px;
                font-size: 22px;
                border-radius: 8px;
            }
            
            .chat-name {
                font-size: 16px;
                font-weight: 500;
            }
            
            .chat-preview {
                font-size: 14px;
                margin-top: 2px;
            }
            
            .chat-time {
                font-size: 12px;
            }
            
            /* 底部导航移动端优化 */
            .bottom-nav {
                height: 68px; /* 從60px增加到68px，與基礎樣式保持協調 */
                padding: 10px 0; /* 適當增加內邊距 */
                /* 适配安全区域 */
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
            
            .nav-item {
                height: 52px; /* 從48px增加到52px */
                padding: 4px 8px;
            }
            
            .nav-icon {
                font-size: 26px; /* 從24px增加到26px */
                margin-bottom: 3px; /* 適當增加間距 */
            }
            
                         .nav-label {
                 font-size: 12px; /* 從11px增加到12px */
             }
             
             /* 聊天界面移动端优化 */
             .wx-container {
                 width: 100%;
                 height: 100vh;
                 max-height: 100vh;
                 position: fixed;
                 border-radius: 0;
             }
             
             .wx-header {
                 height: 56px;
                 padding: 0 12px;
                 /* 适配安全区域 */
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
             }
             
             .wx-header-title {
                 font-size: 16px !important;
             }
             
             .wx-back-btn,
             .wx-menu-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
             }
             
             /* 聊天消息区域优化 */
             .wx-chat-container {
                 padding: 12px 8px;
                 padding-bottom: calc(78px + max(0px, env(safe-area-inset-bottom))); /* 從70px增加到78px，配合導航欄高度增加 */
             }
             
             .wx-msg {
                 margin-bottom: 12px;
             }
             
             .wx-avatar {
                 width: 36px;
                 height: 36px;
                 font-size: 20px;
                 border-radius: 6px;
             }
             
             .wx-content-wrapper {
                 max-width: calc(100% - 80px);
             }
             
             .wx-msg-bubble {
                 padding: 10px 12px;
                 font-size: 16px; /* 防止iOS自动缩放 */
                 line-height: 1.4;
                 border-radius: 16px;
             }
             
             .wx-msg-self .wx-msg-bubble {
                 border-radius: 16px 0px 16px 16px; /* 右上角改為直角，與尖角連接 */
             }
             
             .wx-msg-other .wx-msg-bubble {
                 border-radius: 0px 16px 16px 16px; /* 左上角改為直角，與尖角連接 */
             }
             
             .wx-name {
                 font-size: 12px;
                 margin-bottom: 3px;
             }
             
             .wx-time {
                 font-size: 12px;
                 margin: 8px 0;
             }
             
             /* 输入区域移动端优化 */
             .wx-input-area {
                 height: calc(60px + max(0px, env(safe-area-inset-bottom)));
                 padding: 8px 10px;
                 padding-bottom: calc(8px + max(0px, env(safe-area-inset-bottom)));
             }
             
             .wx-input-box {
                 height: 36px;
                 font-size: 16px; /* 防止iOS自动缩放 */
                 border-radius: 18px;
                 padding: 0 12px;
             }
             
             .wx-voice-btn {
                 width: 36px;
                 height: 36px;
             }
             
             /* 提及popup优化 */
             .mention-popup {
                 bottom: calc(60px + max(0px, env(safe-area-inset-bottom)));
                 left: 10px;
                 right: 10px;
                 border-radius: 12px;
             }
             
             .mention-item {
                 padding: 15px;
                 min-height: 60px;
             }
             
             .mention-avatar {
                 width: 40px;
                 height: 40px;
             }
         }
        
                 /* 小屏幕设备额外优化 */
         @media (max-width: 480px) {
             .login-content {
                 padding: 8px 10px 6px 10px; /* 减少小屏幕设备的内边距 */
             }
             
             .login-header h1 {
                 font-size: 1.6rem;
             }
             
             .chat-item {
                 padding: 12px 15px;
                 min-height: 68px;
             }
             
             .chat-avatar {
                 width: 48px;
                 height: 48px;
                 font-size: 20px;
             }
             
             .chat-name {
                 font-size: 15px;
             }
             
             .chat-preview {
                 font-size: 13px;
             }
             
             /* 聊天界面小屏优化 */
             .wx-header {
                 height: 52px;
                 padding: 0 10px;
                 height: calc(52px + max(0px, env(safe-area-inset-top)));
             }
             
             .wx-back-btn,
             .wx-menu-btn {
                 width: 36px;
                 height: 36px;
                 font-size: 16px;
             }
             
             .wx-header-title {
                 font-size: 15px !important;
             }
             
             .wx-chat-container {
                 padding: 10px 6px;
             }
             
             .wx-avatar {
                 width: 32px;
                 height: 32px;
                 font-size: 18px;
             }
             
             .wx-content-wrapper {
                 max-width: calc(100% - 70px);
             }
             
             .wx-msg-bubble {
                 padding: 8px 10px;
                 font-size: 15px;
             }
             
             .wx-input-area {
                 height: calc(56px + max(0px, env(safe-area-inset-bottom)));
                 padding: 6px 8px;
                 padding-bottom: calc(6px + max(0px, env(safe-area-inset-bottom)));
             }
             
             .wx-input-box {
                 height: 32px;
                 font-size: 15px;
                 padding: 0 10px;
             }
             
             .wx-voice-btn {
                 width: 32px;
                 height: 32px;
             }
             
             /* 小屏幕設備四宮格配圖優化 */
             .moment-images-grid {
                 width: 180px !important;
                 height: 180px !important;
             }
             
             .moment-emoji-grid-item {
                 font-size: 30px !important; /* 小屏幕進一步縮小 */
             }
             
             .emoji-count-overlay {
                 font-size: 9px !important;
                 padding: 1px 3px !important;
             }
         }
        
                 /* 群组详情和成员资料页面移动端优化 */
         @media (max-width: 768px) {
             /* 群组详情页面 */
             .group-detail-container {
                 width: 100%;
                 height: 100vh;
                 max-height: 100vh;
                 position: fixed;
                 border-radius: 0;
                 z-index: 200;
             }
             
             .detail-header {
                 height: 56px;
                 padding: 0 12px;
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
             }
             
             .detail-back-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
             }
             
             .detail-title {
                 font-size: 16px;
             }
             
             .group-info {
                 padding: 20px 15px;
             }
             
             .group-avatar {
                 width: 60px;
                 height: 60px;
                 font-size: 26px;
             }
             
             .group-name {
                 font-size: 20px;
             }
             
             .group-description {
                 font-size: 14px;
                 margin-top: 8px;
             }
             
             .member-grid {
                 grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                 gap: 15px;
                 padding: 15px;
             }
             
             .member-card {
                 padding: 10px;
                 border-radius: 12px;
             }
             
             .member-avatar {
                 width: 50px;
                 height: 50px;
                 font-size: 22px;
             }
             
             .member-name {
                 font-size: 12px;
                 margin-top: 8px;
             }
             
             /* 成员资料页面 */
             .member-profile-container {
                 width: 100%;
                 height: 100vh;
                 max-height: 100vh;
                 position: fixed;
                 border-radius: 0;
                 z-index: 300;
             }
             
             .profile-nav-bar {
                 height: 56px;
                 padding: 0 12px;
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
             }
             
             .profile-back-btn,
             .profile-more-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
             }
             
             .profile-header {
                 padding: 20px 15px;
             }
             
             .profile-avatar {
                 width: 60px;
                 height: 60px;
                 font-size: 26px;
             }
             
             .profile-name {
                 font-size: 20px;
             }
             
             .profile-wechat-id,
             .profile-location {
                 font-size: 14px;
                 margin: 4px 0;
             }
             
             .profile-menu-item {
                 padding: 15px;
                 min-height: 56px;
             }
             
             .menu-item-label {
                 font-size: 16px;
             }
             
             .menu-item-value {
                 font-size: 14px;
             }
             
             /* 朋友圈预览优化 */
             .moments-preview {
                 gap: 8px;
                 margin-right: 12px;
             }
             
             .moment-preview-image {
                 width: 50px;
                 height: 50px;
                 border-radius: 8px;
             }
         }
         
         /* 横屏模式优化 */
         @media (max-height: 500px) and (orientation: landscape) {
            .login-container {
                height: 100vh;
                overflow-y: auto;
            }
            
            .login-content {
                min-height: auto;
                height: 100vh;
                padding: 5px 15px 3px 15px; /* 横屏模式进一步减少内边距 */
                overflow: hidden; /* 确保横屏模式也不出现滚动条 */
                justify-content: space-between;
            }
            
            .login-header h1 {
                font-size: 1.4rem;
                margin-bottom: 8px;
            }
            
            .login-subtitle {
                font-size: 0.8rem;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 8px;
            }
            
            .main-header {
                height: 48px;
            }
            
            .bottom-nav {
                height: 52px; /* 從48px增加到52px，橫屏模式適度增加 */
                padding: 6px 0; /* 適當增加內邊距 */
            }
            
            .nav-item {
                height: 44px; /* 從40px增加到44px */
            }
            
            .nav-icon {
                font-size: 22px; /* 從20px增加到22px */
            }
            
                         .nav-label {
                 font-size: 11px; /* 從10px增加到11px */
             }
             
             /* 横屏模式下其他页面的优化 */
             .wx-header,
             .detail-header,
             .profile-nav-bar,
             .moments-header {
                 height: 44px;
                 height: calc(44px + max(0px, env(safe-area-inset-top)));
             }
             
             .wx-header-title,
             .detail-title,
             .moments-title {
                 font-size: 14px !important;
             }
             
             .wx-back-btn,
             .wx-menu-btn,
             .detail-back-btn,
             .profile-back-btn,
             .profile-more-btn,
             .moments-back-btn {
                 width: 32px;
                 height: 32px;
                 font-size: 14px;
             }
             
             .wx-input-area {
                 height: calc(44px + max(0px, env(safe-area-inset-bottom)));
                 padding: 4px 8px;
                 padding-bottom: calc(4px + max(0px, env(safe-area-inset-bottom)));
             }
             
             .wx-input-box {
                 height: 28px;
                 font-size: 14px;
             }
             
             .wx-voice-btn {
                 width: 28px;
                 height: 28px;
             }
         }
        
        /* 超高分辨率设备优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .chat-avatar,
            .nav-icon {
                /* 高DPI设备的清晰度优化 */
                transform: translateZ(0);
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
                 /* iOS Safari 特殊优化 */
         @supports (-webkit-touch-callout: none) {
             .main-container,
             .wx-container,
             .group-detail-container,
             .member-profile-container,
             .moments-container {
                 /* iOS Safari 视口高度修正 */
                 height: 100vh;
                 height: -webkit-fill-available;
             }
             
             .login-container {
                 height: 100vh;
                 height: -webkit-fill-available;
             }
             
             /* 防止iOS Safari弹性滚动 */
             body {
                 position: fixed;
                 width: 100%;
                 height: 100%;
                 overflow: hidden;
             }
             
             /* 修正iOS Safari中的输入框问题 */
             .wx-input-box {
                 transform: translateZ(0);
                 -webkit-appearance: none;
                 border-radius: 18px;
             }
             
             .form-group input,
             .form-group select {
                 transform: translateZ(0);
                 -webkit-appearance: none;
             }
             
             /* 优化iOS Safari的滚动性能 */
             .wx-chat-container,
             .chat-list-container,
             .contacts-tab,
             .discover-tab,
             .profile-tab,
             .moments-container {
                 -webkit-overflow-scrolling: touch;
                 transform: translate3d(0, 0, 0);
             }
         }
        
        /* 大屏幕设备登录界面优化 */
        @media (min-width: 768px) and (min-height: 600px) {
            .login-content {
                max-width: 400px;
                margin: 0 auto;
                padding: 20px 24px;
                justify-content: center; /* 大屏幕居中显示 */
            }
            
            .welcome-message {
                max-height: 40vh; /* 限制欢迎信息最大高度 */
                overflow-y: auto; /* 如果内容过多，允许局部滚动 */
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            /* 移除hover效果，优化触摸体验 */
            .chat-item:hover {
                background-color: transparent;
            }
            
            .chat-item:active {
                background-color: #f0f0f0;
                transition: background-color 0.1s;
            }
            
            .nav-item:hover {
                background-color: transparent;
            }
            
            .nav-item:active {
                background-color: rgba(0, 0, 0, 0.1);
                transition: background-color 0.1s;
            }
            
                         /* 增大触摸目标 */
             .login-btn,
             .debug-btn,
             .chat-item,
             .nav-item {
                 min-height: 48px; /* 從44px增加到48px，配合導航欄調整 */
             }
             
             /* 通讯录页面优化 */
             .contacts-tab {
                 height: 100%;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
             }
             
             .contact-item {
                 padding: 15px;
                 min-height: 60px;
                 border-bottom: 0.5px solid #e5e5e5;
             }
             
             .contact-avatar {
                 width: 44px;
                 height: 44px;
                 font-size: 20px;
             }
             
             /* 发现页面优化 */
             .discover-tab {
                 height: 100%;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
             }
             
             .discover-item {
                 padding: 15px;
                 min-height: 56px;
                 border-bottom: 0.5px solid #e5e5e5;
             }
             
             .discover-icon {
                 width: 32px;
                 height: 32px;
                 font-size: 18px;
             }
             
             .discover-label {
                 font-size: 16px;
             }
             
             /* 个人资料页面优化 */
             .profile-tab {
                 height: 100%;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
             }
             
             .profile-header {
                 padding: 20px 15px;
             }
             
             .profile-avatar img {
                 width: 60px;
                 height: 60px;
             }
             
             .profile-name {
                 font-size: 20px;
             }
             
             .profile-menu-item {
                 padding: 15px;
                 min-height: 56px;
             }
             
             .menu-icon {
                 width: 28px;
                 height: 28px;
             }
             
             .menu-label {
                 font-size: 16px;
             }
             
             /* 朋友圈页面优化 */
             .moments-container {
                 height: 100vh;
                 overflow-y: auto;
                 -webkit-overflow-scrolling: touch;
                 position: fixed;
                 top: 0;
                 left: 0;
                 right: 0;
                 bottom: 0;
                 background-color: #f5f5f5;
                 z-index: 100;
             }
             
             .moments-header {
                 height: 56px;
                 padding: 0 15px;
                 padding-top: max(0px, env(safe-area-inset-top));
                 height: calc(56px + max(0px, env(safe-area-inset-top)));
                 background-color: rgba(0, 0, 0, 0.5);
                 color: white;
             }
             
             .moments-back-btn {
                 width: 40px;
                 height: 40px;
                 font-size: 18px;
                 color: white;
             }
             
             .moments-title {
                 font-size: 16px;
                 color: white;
             }
             
             .moment-item {
                 padding: 15px;
                 margin-bottom: 8px;
                 background-color: white;
             }
             
             .moment-avatar {
                 width: 44px;
                 height: 44px;
                 font-size: 20px;
             }
             
             .moment-name {
                 font-size: 16px;
                 font-weight: 500;
             }
             
             .moment-content {
                 font-size: 16px;
                 line-height: 1.5;
                 margin: 8px 0;
             }
             
             /* 移動端四宮格配圖優化 */
             .moment-images-grid {
                 width: 200px !important;
                 height: 200px !important;
                 margin: 12px 0;
             }
             
             .moment-emoji-grid-item {
                 font-size: 36px !important; /* 移動端稍微小一些 */
             }
             
             .emoji-count-overlay {
                 font-size: 10px !important;
                 padding: 1px 4px !important;
             }
             
             .moment-images {
                 margin: 12px 0;
             }
             
             .moment-image {
                 border-radius: 8px;
                 margin: 2px;
             }
             
             .moment-actions {
                 margin-top: 12px;
             }
             
             .moment-like-btn,
             .moment-comment-btn {
                 padding: 8px 12px;
                 font-size: 14px;
                 min-height: 40px;
             }
         }
        
                 /* 主界面樣式 */
        .main-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #393a3f;
            display: flex;
            flex-direction: column;
            z-index: 10;
            padding: 0;
            border: none;
            outline: none;
            box-sizing: border-box;
            overflow: hidden;
            /* 移动端性能优化 */
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        .main-header {
            background-color: #f7f7f7;
            color: #000;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 0; /* 移除狀態欄適配 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin: 0;
            border: none;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
            position: relative;
        }
        

        
        .main-title {
            font-size: 18px;
            font-weight: normal;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .main-title-count {
            font-size: 16px;
            color: rgba(0, 0, 0, 0.6);
        }
        

        
        .main-content {
            flex: 1;
            overflow: hidden;
            background-color: #ffffff;
            margin: 0;
            border: none;
        }
        
        /* 聊天列表樣式 */
        .chat-list-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .chat-list-container {
            height: 100%;
            overflow-y: auto;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            transition: background-color 0.15s;
            position: relative;
            background-color: #ffffff;
        }
        
        .chat-item:hover {
            background-color: #f0f0f0;
        }
        
        .chat-item:active {
            background-color: #e8e8e8;
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
            background-color: #f0f0f0;
        }
        


        
        .chat-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        
        .chat-name {
            font-size: 17px;
            color: #333;
            margin-bottom: 4px;
            font-weight: normal;
            line-height: 1.2;
        }
        
        .chat-preview {
            font-size: 14px;
            color: #888;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 60px;
        }
        
        .chat-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .chat-unread {
            background-color: #ff3b30;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        
        .chat-unread.show {
            display: block;
        }
        
        /* 底部導航欄 - 更符合真實微信樣式 */
        .bottom-nav {
            display: flex;
            background-color: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            padding: 8px 0 8px 0; /* 適當增加內邊距 */
            box-shadow: 0 -0.5px 0 rgba(0, 0, 0, 0.05);
            height: 64px; /* 從56px增加到64px */
            align-items: center;
            margin: 0;
            flex-shrink: 0;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 3px 8px; /* 適當增加內邊距 */
            transition: all 0.15s;
            height: 48px; /* 從44px增加到48px */
        }
        
        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        .nav-icon {
            font-size: 25px; /* 從22px增加到25px */
            margin-bottom: 3px; /* 適當增加間距 */
            color: #989898;
            transition: color 0.15s;
            line-height: 1;
        }
        
        .nav-item.active .nav-icon {
            color: #07c160;
        }
        
        .nav-label {
            font-size: 11px; /* 從10px增加到11px */
            color: #989898;
            transition: color 0.15s;
            line-height: 1;
            font-weight: normal;
        }
        
        .nav-item.active .nav-label {
            color: #07c160;
        }
        
        .nav-badge {
            position: absolute;
            top: 2px;
            right: 20%;
            background-color: #ff3b30;
            color: white;
            border-radius: 8px;
            padding: 1px 5px;
            font-size: 11px;
            min-width: 16px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        
        .nav-badge.show {
            display: block;
        }
        
        /* 通訊錄樣式 - 模擬真實微信 */
        .contacts-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .contacts-container {
            height: 100%;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        .contact-group {
            margin-bottom: 0;
        }
        
        .contact-group-header {
            background-color: #f7f7f7;
            padding: 12px 15px;
            font-size: 14px;
            color: #333;
            font-weight: 600;
            line-height: 1.2;
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            transition: background-color 0.15s;
            background-color: #ffffff;
        }
        
        .contact-item:hover {
            background-color: #f0f0f0;
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background-color: #f0f0f0;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-name {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
            font-weight: normal;
            line-height: 1.2;
        }
        
        .contact-desc {
            font-size: 13px;
            color: #888;
            line-height: 1.2;
        }
        
        /* 通訊錄右側字母索引 - 隱藏，因為改用朝代排序 */
        .contacts-index {
            display: none;
        }
        
        .index-letter {
            display: none;
        }
        
        /* 發現頁面樣式 - 模擬真實微信 */
        .discover-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .discover-container {
            height: 100%;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        
        .discover-section {
            background-color: #ffffff;
            margin-bottom: 8px;
        }
        
        .discover-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .discover-item:last-child {
            border-bottom: none;
        }
        
        .discover-item:hover {
            background-color: #f0f0f0;
        }
        
        .discover-icon {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border-radius: 6px;
        }
        
        .discover-label {
            font-size: 16px;
            color: #333;
            flex: 1;
            font-weight: normal;
        }
        
        .discover-arrow {
            color: #c7c7cc;
            font-size: 14px;
        }
        
        /* 個人資料頁面樣式 */
        .profile-tab {
            height: 100%;
            overflow: hidden;
        }
        
        .profile-container {
            height: 100%;
            overflow-y: auto;
            background-color: #f0f0f0;
        }
        
        /* 個人資料頭部區域 */
        .profile-header {
            background-color: #ffffff;
            padding: 20px 15px;
            margin-bottom: 10px;
        }
        
        .profile-user-card {
            display: flex;
            align-items: flex-start;
            position: relative;
        }
        
        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .profile-info {
            flex: 1;
            min-width: 0;
        }
        
        .profile-name {
            font-size: 22px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .profile-wechat-id {
            font-size: 14px;
            color: #888;
            margin-bottom: 12px;
        }
        
        .profile-status-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            background-color: transparent;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-btn:hover {
            background-color: #f8f8f8;
            border-color: #ccc;
        }
        
        .camera-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background-color: transparent;
            border: 1px solid #e0e0e0;
            border-radius: 50%;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .camera-btn:hover {
            background-color: #f8f8f8;
            border-color: #ccc;
        }
        
        .qr-code-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .qr-code-btn:hover {
            background-color: #f8f8f8;
        }
        
        /* 功能菜單區域 */
        .profile-menu-section {
            background-color: #ffffff;
            margin-bottom: 10px;
        }
        
        .profile-menu-item {
            display: flex;
            align-items: center;
            padding: 16px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .profile-menu-item:hover {
            background-color: #f8f8f8;
        }
        
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        
        .profile-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .profile-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        .profile-menu-section .profile-menu-item:only-child {
            border-radius: 8px;
        }
        
        .menu-icon {
            margin-right: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .menu-icon svg {
            border-radius: 6px;
        }
        
        .menu-label {
            flex: 1;
            font-size: 16px;
            color: #333;
            font-weight: 400;
        }
        
        .menu-arrow {
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }
        
        /* 朋友圈頁面樣式 */
        .moments-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            z-index: 15;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .moments-header {
            position: relative;
            height: 200px;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.7)), url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"><rect fill="%23667eea" width="400" height="200"/><circle fill="%23764ba2" opacity="0.3" cx="100" cy="50" r="30"/><circle fill="%23667eea" opacity="0.5" cx="300" cy="150" r="50"/></svg>');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 15px 15px 15px; /* 移除顶部多余空间 */
        }
        

        
        .moments-back-btn, .moments-camera-btn {
            width: 44px;
            height: 44px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: normal;
        }
        
        .moments-back-btn:hover, .moments-camera-btn:hover {
            background-color: rgba(0, 0, 0, 0.5);
            transform: scale(1.05);
        }
        
        .moments-back-btn:active, .moments-camera-btn:active {
            background-color: rgba(0, 0, 0, 0.7);
            transform: scale(0.95);
        }
        
        .moments-content {
            flex: 1;
            background-color: #f5f5f5;
            overflow-y: auto;
        }
        
        .moment-item {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 15px;
            position: relative;
        }
        
        .moment-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .moment-avatar {
            width: 42px;
            height: 42px;
            border-radius: 4px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: #f0f0f0;
            flex-shrink: 0;
        }
        
        .moment-info {
            flex: 1;
            min-width: 0;
        }
        
        .moment-name {
            font-size: 16px;
            font-weight: 500;
            color: #576b95;
            margin-bottom: 2px;
        }
        
        .moment-content-text {
            font-size: 16px;
            line-height: 1.4;
            color: #333;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .moment-images {
            margin-bottom: 10px;
        }
        
        .moment-images.single {
            max-width: 200px;
        }
        
        .moment-images.grid {
            display: grid;
            gap: 3px;
            max-width: 270px;
        }
        
        .moment-images.grid.two {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .moment-images.grid.three {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-images.grid.four {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .moment-images.grid.more {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .moment-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .moment-time {
            font-size: 13px;
            color: #999;
        }
        
        .moment-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .moment-action {
            color: #576b95;
            font-size: 13px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            transition: background-color 0.2s;
        }
        
        .moment-action:hover {
            background-color: #f0f0f0;
        }
        
        .moment-likes {
            background-color: #f7f7f7;
            margin-top: 8px;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .moment-like-icon {
            color: #576b95;
            margin-right: 4px;
        }
        
        .moment-like-list {
            color: #576b95;
        }
        
        .moment-comments {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #e5e5e5;
        }
        
        .moment-comment {
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .comment-author {
            color: #576b95;
            font-weight: 500;
        }
        
        .comment-text {
            color: #333;
        }
        
        .moment-location {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
        }
        
        /* 四宮格配圖容器 */
        .moment-images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 3px;
            width: 240px;
            height: 240px;
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* 四宮格中的單個emoji項目 */
        .moment-emoji-grid-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
            font-size: 48px; /* 增大emoji尺寸 */
            border-radius: 6px;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .moment-emoji-grid-item:hover {
            background-color: #e8e8e8;
        }
        
        /* 空白格子 */
        .moment-emoji-grid-item.empty {
            background-color: transparent;
        }
        
        /* 更多指示器樣式 */
        .moment-emoji-grid-item.more-indicator {
            position: relative;
        }
        
        .emoji-count-overlay {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* 媒体查询已移除，使用统一设计 */
        
        /* 群組列表頁面樣式 */
        .group-list-page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .group-list-header {
            background-color: #393a3f;
            color: white;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px; /* 移除顶部多余空间 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .group-list-title {
            font-size: 18px;
            font-weight: normal;
        }
        
        .group-list-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .group-list-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .group-list-container {
            flex: 1;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        .group-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .group-item:hover {
            background-color: #f8f8f8;
        }
        
        .group-item.active {
            background-color: #e7f3ff;
        }
        
        .group-item.active::after {
            content: "";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #07c160;
        }
        
        .group-avatar {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            color: white;
            font-weight: bold;
        }
        
        .group-avatar.poets { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .group-avatar.history { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .group-avatar.philosophy { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); }
        .group-avatar.mystery { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        
        .group-info {
            flex: 1;
            min-width: 0;
        }
        
        .group-name {
            font-size: 17px;
            color: #333;
            margin-bottom: 2px;
            font-weight: normal;
        }
        
        .group-desc {
            font-size: 13px;
            color: #888;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .group-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 60px;
        }
        
        .group-member-count {
            font-size: 12px;
            color: #999;
            margin-bottom: 2px;
        }
        
        .group-owner {
            font-size: 11px;
            color: #576b95;
            background-color: rgba(87, 107, 149, 0.1);
            padding: 1px 4px;
            border-radius: 2px;
        }
        

        

    </style>
</head>
<body>
    <!-- 銀河系背景 -->
    <div class="galaxy-container">
        <!-- 銀河中心 -->
        <div class="galaxy-center"></div>
        
        <!-- 銀河塵埃雲 -->
        <div class="nebula-cloud"></div>
        <div class="nebula-cloud"></div>
        <div class="nebula-cloud"></div>
        <div class="nebula-cloud"></div>
        <div class="nebula-cloud"></div>
            </div>
    
    <!-- 額外的星空裝飾層 -->
    <div class="star-field"></div>
    
    <!-- 太虛幻聊 App 圖標 - 直接在銀河系背景中 -->
    <div class="app-icon-container" id="appIconContainer">
        <div class="app-icon-glow"></div>
        <div class="app-icon" id="appIcon">
            <div class="app-icon-symbol">🌌</div>
            <div class="app-icon-text">太虛幻聊</div>
        </div>
    </div>
    
    <!-- 統一父容器 - 控制所有頁面的圓角和尺寸 -->
    <div class="app-universal-container" id="appUniversalContainer">
    <!-- 登入頁面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-content">
            <!-- 標題區域 -->
            <div class="login-header">
                <div class="app-title">
                    <div class="title-main">太虛幻聊</div>
                    <div class="title-sub">與經典人物的奇妙對話</div>
                </div>
                <div class="title-decoration">
                    <div class="star">✨</div>
                    <div class="star">⭐</div>
                    <div class="star">🌟</div>
                </div>
            </div>
            
            <!-- 歡迎信息 -->
            <div class="welcome-message">
                <div class="welcome-title">歡迎來到太虛幻聊！🌟</div>
                <div class="welcome-text">
                    這裡有不同的主題群組等著你：與詩人們吟詩作對，和史家探討古今，與哲人思辨人生，還能和神話人物暢聊奇事！
                    <br><br>
                    <strong>⚠️ 重要提醒：</strong>雖然這些角色的回應都是基於AI技術生成的合理想像，但請記住<strong>不要將其視為標準答案</strong>哦～我們的目標是讓你更親近中華經典，激發學習興趣！
                    <br><br>
                    <strong>📝 使用須知：</strong>在聊天時，你可以詢問角色的故事背景，分享你對經典作品的理解和感受。同時也請注意<strong>保護個人隱私，保持文明用語</strong>，讓我們一起營造溫馨的聊天氛圍吧！💫
                </div>
                <div class="welcome-confirmation">
                    <div class="confirmation-text">請確認您已閱讀並理解以上重要說明</div>
                    <button class="confirm-btn" id="confirmBtn" onclick="confirmReading()">
                        <span id="confirmText">✓ 已經閱讀，我明白了</span>
                    </button>
                </div>
            </div>
            
            <!-- 登入表單 -->
            <div class="login-form form-disabled" id="loginForm">
                <div class="form-group">
                    <label for="nickname">你的昵稱</label>
                    <input type="text" id="nickname" placeholder="請輸入你喜歡的昵稱" maxlength="12">
                </div>
                
                <div class="form-group">
                    <label for="grade">你的年級</label>
                    <select id="grade">
                        <option value="">請選擇年級</option>
                        <option value="五年級">五年級</option>
                        <option value="六年級">六年級</option>
                        <option value="七年級">七年級</option>
                        <option value="八年級">八年級</option>
                        <option value="九年級">九年級</option>
                        <option value="十年級">十年級</option>
                        <option value="十一年級">十一年級</option>
                        <option value="十二年級">十二年級</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="password">遊戲密碼</label>
                    <input type="password" id="password" placeholder="請輸入遊戲密碼">
                    <div class="password-hint">💡 提示：密碼是英文「中國經典」</div>
                </div>
                
                <div class="button-container">
                    <button class="login-btn" id="loginBtn">
                        <span class="btn-icon">🚀</span>
                        開始太虛幻聊之旅
                    </button>
                    
                    <button class="debug-btn" id="debugBtn">
                        <span class="btn-icon">🛠️</span>
                        開發者快速進入
                    </button>
                    
                    <div class="login-error" id="loginError" style="display: none;">
                        <span class="error-icon">⚠️</span>
                        <span class="error-text"></span>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- 太虛幻聊主界面 -->
    <div class="main-container" id="mainContainer" style="display: none;">
        <!-- 主界面頭部 -->
        <div class="main-header">
            <div class="main-title">
                <span>TheyChat</span>
                <span class="main-title-count">(41)</span>
            </div>
        </div>
        
        <!-- 主界面內容 -->
        <div class="main-content" id="mainContent">
            <!-- 聊天列表 -->
            <div class="chat-list-tab active" id="chatListTab">
                <div class="chat-list-container" id="chatListContainer">
                    <!-- 群組聊天列表將動態生成 -->
                </div>
            </div>
            
            <!-- 通訊錄 -->
            <div class="contacts-tab" id="contactsTab" style="display: none;">
                <div class="contacts-container" id="contactsContainer">
                    <!-- 角色通訊錄將動態生成 -->
                </div>
            </div>
            
            <!-- 發現（朋友圈） -->
            <div class="discover-tab" id="discoverTab" style="display: none;">
                <div class="discover-container" id="discoverContainer">
                    <div class="discover-section">
                        <div class="discover-item" onclick="openMoments()">
                            <div class="discover-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">📱</div>
                            <div class="discover-label">朋友圈</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #ff9500; color: white;">🛒</div>
                            <div class="discover-label">視頻號</div>
                            <div class="discover-arrow">></div>
                        </div>
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #fb7299; color: white;">📺</div>
                            <div class="discover-label">直播</div>
                            <div class="discover-arrow">></div>
                        </div>
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #ffc100; color: white;">🛍️</div>
                            <div class="discover-label">購物</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #07c160; color: white;">🎮</div>
                            <div class="discover-label">遊戲</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item">
                            <div class="discover-icon" style="background: #576b95; color: white;">📱</div>
                            <div class="discover-label">小程式</div>
                            <div class="discover-arrow">></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 我的資料 -->
            <div class="profile-tab" id="profileTab" style="display: none;">
                <div class="profile-container" id="profileContainer">
                    <!-- 個人資料頭部 -->
                    <div class="profile-header">
                        <div class="profile-user-card">
                            <div class="profile-avatar">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2387CEEB'/%3E%3Cstop offset='100%25' style='stop-color:%234682B4'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23bg)'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3E🏔️%3C/text%3E%3C/svg%3E" alt="頭像">
                            </div>
                            <div class="profile-info">
                                <div class="profile-name">張玉龍</div>
                                <div class="profile-wechat-id">WeChat ID：yulongz</div>
                                <div class="profile-status-row">
                                    <button class="status-btn">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <line x1="12" y1="8" x2="12" y2="12"/>
                                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                                        </svg>
                                        + 狀態
                                    </button>
                                    <button class="camera-btn">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                            <circle cx="12" cy="13" r="4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="qr-code-btn">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                    <path d="M14 17h1v1h-1v-1z"/>
                                    <path d="M15 14h1v1h-1v-1z"/>
                                    <path d="M16 15h1v1h-1v-1z"/>
                                    <path d="M17 14h1v1h-1v-1z"/>
                                    <path d="M18 15h1v1h-1v-1z"/>
                                    <path d="M19 16h1v1h-1v-1z"/>
                                    <path d="M20 17h1v1h-1v-1z"/>
                                    <path d="M21 18h1v1h-1v-1z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第一組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item">
                            <div class="menu-icon payment">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#07C160"/>
                                    <path d="M7 9l5 5 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="8" y="6" width="8" height="2" fill="white" rx="1"/>
                                </svg>
                            </div>
                            <div class="menu-label">支付與服務</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第二組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item" onclick="openMoments()">
                            <div class="menu-icon favorites">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#FF8C00"/>
                                    <path d="M8 8h8v8H8z" fill="white"/>
                                    <path d="M6 10v6h2v-6H6zm10 0v6h2v-6h-2z" fill="white"/>
                                </svg>
                            </div>
                            <div class="menu-label">收藏</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="profile-menu-item" onclick="openMoments()">
                            <div class="menu-icon moments" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 12px; width: 24px; height: 24px; flex-shrink: 0; border-radius: 6px; position: relative;">
                                📱
                            </div>
                            <div class="menu-label">朋友圈</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第三組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item">
                            <div class="menu-icon cards">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#5D9CEC"/>
                                    <rect x="4" y="8" width="16" height="8" fill="white" rx="2"/>
                                    <line x1="4" y1="12" x2="20" y2="12" stroke="#5D9CEC" stroke-width="1"/>
                                </svg>
                            </div>
                            <div class="menu-label">票證 & 卡券</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="profile-menu-item">
                            <div class="menu-icon stickers">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <rect width="24" height="24" rx="6" fill="#FFC107"/>
                                    <circle cx="9" cy="10" r="1.5" fill="white"/>
                                    <circle cx="15" cy="10" r="1.5" fill="white"/>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="menu-label">貼圖市集</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能菜單第四組 -->
                    <div class="profile-menu-section">
                        <div class="profile-menu-item">
                            <div class="menu-icon settings" style="background: #6C7B7F; color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 12px; width: 24px; height: 24px; flex-shrink: 0; border-radius: 6px; position: relative;">
                                ⚙️
                            </div>
                            <div class="menu-label">設定</div>
                            <div class="menu-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9,18 15,12 9,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部導航欄 -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="chatListTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 3c5.5 0 10 3.58 10 8s-4.5 8-10 8c-1.24 0-2.43-.18-3.53-.5C5.55 21 2 21 2 21c2.33-2.33 2.7-3.9 2.75-4.5C3.05 15.07 2 13.13 2 11c0-4.42 4.5-8 10-8z"/>
                    </svg>
                </div>
                <div class="nav-label">聊天</div>
                <div class="nav-badge" id="chatBadge">8</div>
            </div>
            <div class="nav-item" data-tab="contactsTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H5.46c-.8 0-1.54.59-1.42 1.37L6.5 16H9v6h11zM12.5 11.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zM6.5 11.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5S5 13.33 5 12.5s.67-1.5 1.5-1.5z"/>
                        <circle cx="9" cy="9" r="4"/>
                        <path d="M15.5 9c-.83 0-1.5-.67-1.5-1.5S14.67 6 15.5 6s1.5.67 1.5 1.5S16.33 9 15.5 9z"/>
                    </svg>
                </div>
                <div class="nav-label">通訊錄</div>
            </div>
            <div class="nav-item" data-tab="discoverTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                </div>
                <div class="nav-label">發現</div>
                <div class="nav-badge" id="discoverBadge">1</div>
            </div>
            <div class="nav-item" data-tab="profileTab">
                <div class="nav-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <div class="nav-label">我</div>
            </div>
        </div>
    </div>



    <!-- 聊天界面（隱藏） -->
    <div class="wx-container" id="chatContainer" style="display: none;">
        <!-- 微信頭部 -->
        <div class="wx-header">
            <div class="wx-back-btn" id="backToMainBtn">&#10094;</div>
            <div class="wx-header-title">群聊</div>
            <div class="wx-menu-btn" id="openGroupDetails">⋮</div>
        </div>
        
        <!-- 聊天容器 -->
        <div id="chatMessages" class="wx-chat-container">
            <!-- 聊天消息將動態生成到這裡 -->
        </div>
        

        
        <!-- 輸入區域 -->
        <div class="wx-input-area">
            <div class="wx-voice-btn">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
                <circle cx="12" cy="12" r="11.55" fill="white" stroke="#333" stroke-width="1"/>
                <circle cx="9" cy="12" r="1.14" fill="#333"/>
                <path d="M 12,7 A 5.7,5.7 0 0 1 12,17" fill="none" stroke="#333" stroke-width="1.14"/>
                <path d="M 15,5 A 8.55,8.55 0 0 1 15,19" fill="none" stroke="#333" stroke-width="1.14"/>
            </svg>
        </div>
            <input type="text" class="wx-input-box" id="messageInput" placeholder="請輸入...">
            <div class="wx-emoji-btn" id="emojiBtn">😊</div>
            <div class="wx-plus-btn" id="plusBtn">+</div>
        </div>
        
        <!-- Emoji選擇面板 -->
        <div id="emojiPanel" class="emoji-panel">
            <!-- 表情符號將在JavaScript中動態生成 -->
        </div>
        
        <!-- @某人選擇面板 -->
        <div id="mentionPopup" class="mention-popup">
            <!-- @某人列表將在JavaScript中動態生成 -->
        </div>
        
        <!-- 功能選項面板 -->
        <div id="functionPanel" class="function-panel">
            <div class="function-grid">
                <div class="function-item" id="photoBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <circle cx="12" cy="12" r="4" />
                            <circle cx="17" cy="7" r="1" fill="currentColor" />
                        </svg>
                    </div>
                    <div class="function-text">照片</div>
                </div>
                <div class="function-item" id="cameraBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                            <circle cx="12" cy="13" r="4" />
                        </svg>
                    </div>
                    <div class="function-text">拍攝</div>
                </div>
                <div class="function-item" id="callBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z" />
                        </svg>
                    </div>
                    <div class="function-text">語音通話</div>
                </div>
                <div class="function-item" id="locationBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                            <circle cx="12" cy="10" r="3" />
                        </svg>
                    </div>
                    <div class="function-text">位置</div>
                </div>

                <div class="function-item" id="voiceInputBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" />
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v3M8 23h8" />
                        </svg>
                    </div>
                    <div class="function-text">語音輸入</div>
                </div>
                <div class="function-item" id="favBtn">
                    <div class="function-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z" />
                            <path d="M9 17l3-3 3 3M9 7h6M9 11h6" />
                        </svg>
                    </div>
                    <div class="function-text">收藏</div>
                </div>
            </div>
            
            <div class="function-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    
    <!-- 群組列表頁面 -->
    <div class="group-list-page" id="groupListPage">
        <div class="group-list-header">
            <div class="group-list-title">太虛幻聊</div>
            <div class="group-list-close" id="closeGroupList">×</div>
                </div>
        
        <div class="group-list-container" id="groupListContainer">
            <!-- 群組列表將動態生成到這裡 -->
            </div>
        </div>
        
    <!-- 群組詳情頁面 -->
    <div class="group-details" id="groupDetailsPage">
        <div class="detail-header">
            <div class="detail-back" id="closeGroupDetails">&#10094;</div>
            <div class="detail-title">聊天資訊</div>
        </div>
        
        <div class="group-members-grid">
            <div class="member-item" data-character="libai">
                <div class="member-avatar">🥂</div>
                <div class="member-name">李白</div>
            </div>

            <div class="member-item" data-character="taoyuanming">
                <div class="member-avatar">🌾</div>
                <div class="member-name">陶淵明</div>
            </div>
            <div class="member-item" data-character="liuling">
                <div class="member-avatar">🍶</div>
                <div class="member-name">劉伶</div>
            </div>

            <div class="member-item" data-character="dufu">
                <div class="member-avatar">📝</div>
                <div class="member-name">杜甫</div>
            </div>
            <div class="member-item" data-character="ligui">
                <div class="member-avatar">🎵</div>
                <div class="member-name">李龜年</div>
            </div>
            <div class="member-item" data-character="yutu">
                <div class="member-avatar">🐇</div>
                <div class="member-name">玉兔</div>
            </div>
            <div class="member-item" data-character="change">
                <div class="member-avatar">🙎‍♀️</div>
                <div class="member-name">嫦娥</div>
            </div>

            <div class="member-item" data-character="yuzhen">
                <div class="member-avatar">👸</div>
                <div class="member-name">玉真公主</div>
            </div>
            <div class="member-item" data-character="wangwei">
                <div class="member-avatar">🧘</div>
                <div class="member-name">王維</div>
            </div>
            <div class="member-item" data-character="caozhi">
                <div class="member-avatar">🤴</div>
                <div class="member-name">曹植</div>
            </div>
            <div class="member-item" data-character="xiwangmu">
                <div class="member-avatar">👑</div>
                <div class="member-name">西王母</div>
            </div>
            <div class="member-item" data-character="yangguifei">
                <div class="member-avatar">💃</div>
                <div class="member-name">楊貴妃</div>
            </div>
            <div class="member-item" data-character="menghaoran">
                <div class="member-avatar">🏞️</div>
                <div class="member-name">孟浩然</div>
            </div>

            <div class="member-item">
                <div class="member-avatar" style="background-color:#f1f1f1;font-size:22px">+</div>
                <div class="member-name">邀請</div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-item">
                <div class="detail-item-label">群聊名稱</div>
                <div class="detail-item-value">
                    詩人群
                    <span class="detail-arrow">›</span>
                </div>
            </div>
            <div class="detail-item" id="groupAnnouncement">
                <div class="detail-item-label">群公告</div>
                <div class="detail-item-value">
                    <div style="color: #576b95; margin-right: 10px; white-space: pre-wrap; max-width: 230px; overflow: hidden; text-overflow: ellipsis;">【書院中文經典群聊•群規】
1. 以文會友，以詩論道📚
2. 尊重經典，傳承文化🎭
3. 新人加群，須自我介紹📝
4. 文明討論，理性交流💬
5. 分享心得，共同學習📖
6. 定期舉辦文學沙龍🎪
7. 歡迎提問，互相解答❓

本群致力於中華古典文學的學習與交流，歡迎各位文學愛好者！</div>
                    <span class="detail-arrow">›</span>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-item">
                <div class="detail-item-label">查找聊天記錄</div>
                <div class="detail-item-value">
                    <span class="detail-arrow">›</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 私聊對話詳情頁面 -->
    <div class="private-chat-details" id="privateChatDetailsPage">
        <div class="detail-header">
            <div class="detail-back" id="closePrivateChatDetails">&#10094;</div>
            <div class="detail-title">對話詳情</div>
        </div>
        
        <div class="private-chat-user-section">
            <div class="private-user-info">
                <div class="private-user-avatar" id="privateChatAvatar">🥂</div>
                <div class="private-user-name" id="privateChatUserName">李白</div>
            </div>
            <div class="add-user-btn">
                <div class="add-user-icon">+</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item hoverable">
                <div class="private-detail-item-label">搜尋聊天內容</div>
                <div class="private-detail-item-arrow">›</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item">
                <div class="private-detail-item-label">關閉新訊息通知</div>
                <div class="private-toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="private-detail-item">
                <div class="private-detail-item-label">對話置項</div>
                <div class="private-toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            
            <div class="private-detail-item">
                <div class="private-detail-item-label">提醒</div>
                <div class="private-toggle-switch">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item hoverable">
                <div class="private-detail-item-label">設定目前聊天背景</div>
                <div class="private-detail-item-arrow">›</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item delete-item">
                <div class="private-detail-item-label">刪除對話記錄</div>
            </div>
        </div>
        
        <div class="private-detail-section">
            <div class="private-detail-item hoverable">
                <div class="private-detail-item-label">檢舉</div>
                <div class="private-detail-item-arrow">›</div>
            </div>
        </div>
    </div>

    <!-- 成員資料頁面 -->
    <div class="member-profile" id="memberProfilePage">
        <div class="profile-nav-bar">
            <div class="profile-back-btn" id="closeMemberProfile">&#10094;</div>
            <div class="profile-more-btn">⋮</div>
        </div>
        
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">🥂</div>
            <div class="profile-info">
                <h2 class="profile-name" id="profileName">李白</h2>
                <div class="profile-signature" id="profileSignature" style="font-size: 14px; color: #888; margin-bottom: 4px; line-height: 1.4;">謫仙人也，筆落驚風雨，詩成泣鬼神</div>
                <div class="profile-wechat-id">WeChat ID：<span id="profileWechatId">libai001</span></div>
                <div class="profile-location" id="profileLocation">地區：唐 · 長安</div>
            </div>
        </div>
        
        <div class="profile-menu-section">
            <div class="profile-menu-item" id="friendInfo">
                <div class="menu-item-label">朋友資料</div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            
            <div class="profile-menu-item" id="friendPermissions">
                <div class="menu-item-label">朋友權限</div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="profile-moments-section">
            <div class="profile-menu-item" id="viewMoments">
                <div class="menu-item-label">朋友圈</div>
                <div class="moments-preview">
                    <div class="moment-preview-image">
                        <img src="https://i.imgur.com/OYAcubJ.jpg" alt="友人合影" style="width:45px;height:45px;object-fit:cover;border-radius:3px;">
                    </div>
                    <div class="moment-preview-image">
                        <img src="https://i.imgur.com/6cJlgVD.jpg" alt="海邊" style="width:45px;height:45px;object-fit:cover;border-radius:3px;">
                    </div>
                    <div class="moment-preview-image">
                        <img src="https://i.imgur.com/yB0g0Kk.jpg" alt="旅遊照" style="width:45px;height:45px;object-fit:cover;border-radius:3px;">
                    </div>
                    <div class="moment-preview-image">
                        <img src="https://i.imgur.com/Q7gZnZ2.jpg" alt="花園" style="width:45px;height:45px;object-fit:cover;border-radius:3px;">
                    </div>
                </div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="profile-more-section">
            <div class="profile-menu-item" id="viewChannels">
                <div class="menu-item-label">影音號</div>
                <div class="menu-item-value" id="profileChannelName">李白</div>
                <div class="menu-item-arrow">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 4L10 8L6 12" stroke="#CCCCCC" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="profile-action-buttons">
            <div class="action-message-btn">
                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 4H4C3.45 4 3 4.45 3 5V15C3 15.55 3.45 16 4 16H6V19.5L9.5 16H18C18.55 16 19 15.55 19 15V5C19 4.45 18.55 4 18 4Z" fill="#09BB07"/>
                </svg>
                <span>傳訊息</span>
            </div>
            <div class="action-call-btn">
                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 10.5V6.5H12V4.5H16V0.5H18V4.5H22V6.5H18V10.5H16Z" fill="#09BB07"/>
                    <path d="M14 16.45C12.65 16.45 11.35 16.2 10.15 15.75C9.05 15.35 8.05 14.75 7.15 13.95C6.25 13.15 5.45 12.25 4.85 11.25C4.2 10.18 3.88 9.02 3.88 7.82C3.88 7.32 3.98 6.85 4.15 6.42C4.33 5.98 4.62 5.58 5 5.25L7.8 2.5C8 2.32 8.23 2.17 8.5 2.08C8.77 1.98 9.05 1.95 9.35 1.98C9.7 2.02 10.02 2.15 10.3 2.38C10.58 2.62 10.78 2.9 10.92 3.25L12.08 6.02C12.18 6.3 12.2 6.6 12.15 6.92C12.1 7.25 11.95 7.53 11.72 7.78L10.6 8.92C11.05 9.8 11.63 10.55 12.35 11.18C13.07 11.8 13.88 12.32 14.8 12.72L16 11.58C16.27 11.32 16.58 11.15 16.95 11.08C17.32 11 17.68 11 18.05 11.12L20.85 12.38C21.18 12.52 21.45 12.73 21.65 13.02C21.85 13.32 21.95 13.65 21.95 14C21.95 14.32 21.9 14.6 21.8 14.85C21.7 15.1 21.55 15.33 21.35 15.52L18.45 18.38C18.12 18.68 17.73 18.92 17.3 19.08C16.87 19.25 16.45 19.33 16 19.33C15.6 19.33 15.22 19.27 14.85 19.15C14.27 18.97 13.72 18.75 13.2 18.5C12.68 18.25 12.2 17.98 11.75 17.7C11.3 17.41 10.88 17.11 10.5 16.8L9.6 17.5L10.5 16.8C10.13 16.49 9.77 16.18 9.4 15.85C8.57 15.1 7.85 14.27 7.22 13.38C6.6 12.48 6.1 11.55 5.72 10.58C5.35 9.62 5.17 8.7 5.17 7.82C5.17 7.52 5.22 7.25 5.32 7C5.43 6.75 5.58 6.52 5.78 6.32L8.68 3.48C8.88 3.3 9.12 3.17 9.4 3.1C9.67 3.03 9.93 3.02 10.2 3.08L9.4 3.1L10.2 3.08C10.47 3.13 10.7 3.25 10.9 3.42C11.1 3.58 11.25 3.78 11.35 4.02L12.52 6.78C12.58 6.93 12.6 7.08 12.57 7.25C12.55 7.42 12.47 7.57 12.35 7.68L10.65 9.32L10.72 9.45C11.08 10.12 11.55 10.71 12.15 11.25C12.75 11.78 13.42 12.22 14.15 12.55L14.3 12.62L16.05 10.92C16.18 10.8 16.33 10.73 16.5 10.7C16.67 10.68 16.83 10.7 17 10.78L19.8 12.02C19.97 12.1 20.1 12.22 20.2 12.38C20.3 12.53 20.35 12.7 20.35 12.88C20.35 13.05 20.33 13.2 20.27 13.32C20.22 13.45 20.15 13.57 20.05 13.68L17.15 16.52C16.95 16.7 16.73 16.83 16.5 16.92C16.27 17 16.12 17 16 17C15.78 17 15.55 16.97 15.35 16.9C14.83 16.73 14.33 16.53 13.85 16.3C13.38 16.07 12.93 15.83 12.5 15.57C12.08 15.32 11.67 15.05 11.3 14.75C10.93 14.45 10.57 14.13 10.25 13.8L10.27 13.82C9.5 13.12 8.83 12.35 8.25 11.5C7.67 10.65 7.22 9.77 6.88 8.85C6.55 7.93 6.38 7.08 6.38 6.3L6.38 6.28C6.38 6.1 6.42 5.92 6.48 5.75C6.55 5.58 6.65 5.43 6.78 5.32L9.68 2.48C9.82 2.35 9.97 2.27 10.15 2.22C10.33 2.18 10.5 2.18 10.67 2.22L10.15 2.22L10.67 2.22C10.85 2.27 11 2.35 11.12 2.47C11.25 2.58 11.33 2.73 11.37 2.88L12.53 5.65C12.58 5.8 12.58 5.95 12.53 6.08C12.48 6.22 12.4 6.33 12.28 6.45L11.12 7.58L11.05 7.65L11.32 7.92C11.9 8.58 12.57 9.13 13.32 9.58C14.07 10.02 14.88 10.35 15.75 10.58L16.02 10.65L16.1 10.58L17.22 9.45C17.33 9.33 17.45 9.25 17.58 9.22C17.72 9.18 17.85 9.18 18 9.22L20.8 10.38C20.95 10.43 21.08 10.52 21.17 10.65C21.27 10.77 21.32 10.9 21.32 11.05C21.32 11.18 21.3 11.3 21.25 11.4C21.2 11.5 21.13 11.6 21.05 11.68L18.15 14.52C18.03 14.62 17.9 14.7 17.75 14.75C17.6 14.8 17.43 14.83 17.25 14.83C17.07 14.83 16.88 14.8 16.7 14.75C16.2 14.58 15.7 14.4 15.2 14.17C14.7 13.93 14.23 13.68 13.8 13.4C13.37 13.13 12.95 12.85 12.55 12.55C12.15 12.25 11.77 11.92 11.4 11.55L11.42 11.57C10.7 10.9 10.07 10.17 9.52 9.35C8.97 8.53 8.55 7.7 8.25 6.85C7.95 6 7.8 5.25 7.8 4.6L7.8 4.58C7.8 4.42 7.82 4.28 7.87 4.15C7.92 4.02 8 3.9 8.1 3.82L11 0.98C11.1 0.9 11.22 0.83 11.35 0.8C11.48 0.77 11.62 0.78 11.75 0.82L11.35 0.8L11.75 0.82C11.9 0.85 12.03 0.93 12.15 1.03C12.27 1.13 12.35 1.27 12.4 1.42L13.55 4.18C13.6 4.32 13.62 4.45 13.58 4.58C13.55 4.72 13.47 4.83 13.35 4.95L12.2 6.08L12.18 6.1L12.2 6.12C12.78 6.78 13.45 7.33 14.2 7.78C14.95 8.22 15.77 8.55 16.65 8.78L16.67 8.78L16.68 8.77L17.85 7.65C17.97 7.53 18.08 7.45 18.22 7.42C18.35 7.38 18.48 7.38 18.62 7.42L21.42 8.58C21.57 8.63 21.7 8.72 21.8 8.85C21.9 8.97 21.95 9.1 21.95 9.25C21.95 9.38 21.93 9.5 21.88 9.6C21.83 9.7 21.77 9.8 21.68 9.88L18.78 12.72C18.67 12.82 18.53 12.9 18.38 12.95C18.23 13 18.08 13.03 17.92 13.03C17.77 13.03 17.6 13 17.42 12.95C16.93 12.78 16.45 12.6 15.97 12.38C15.5 12.15 15.05 11.9 14.62 11.62C14.2 11.35 13.8 11.07 13.42 10.75C13.05 10.43 12.7 10.12 12.37 9.78L12.38 9.8C11.72 9.18 11.15 8.5 10.65 7.75C10.15 7 9.77 6.23 9.5 5.45C9.23 4.67 9.08 4 9.05 3.45C9.05 3.3 9.07 3.18 9.12 3.05C9.17 2.92 9.25 2.8 9.35 2.72L12.25 -0.12C12.35 -0.2 12.47 -0.27 12.6 -0.3C12.73 -0.33 12.87 -0.33 13 -0.28L12.6 -0.3L13 -0.28C13.15 -0.23 13.28 -0.15 13.4 -0.05C13.52 0.05 13.6 0.18 13.65 0.32L14.8 3.08C14.85 3.22 14.87 3.35 14.83 3.48C14.8 3.62 14.73 3.73 14.62 3.85L13.47 4.98L13.43 5.02L13.47 5.05C14.05 5.72 14.72 6.27 15.47 6.72C16.22 7.17 17.03 7.5 17.9 7.72L17.93 7.73L17.95 7.72L19.12 6.6C19.23 6.48 19.35 6.4 19.48 6.37C19.62 6.33 19.75 6.33 19.88 6.38L22.68 7.53C22.83 7.58 22.97 7.67 23.07 7.8C23.17 7.92 23.22 8.05 23.22 8.2C23.22 8.33 23.2 8.45 23.15 8.55C23.1 8.65 23.03 8.75 22.95 8.83L20.05 11.68C19.93 11.78 19.8 11.85 19.65 11.9C19.5 11.95 19.35 11.98 19.2 11.98C19.03 11.98 18.87 11.95 18.7 11.9C18.2 11.73 17.72 11.55 17.25 11.33C16.78 11.1 16.33 10.85 15.92 10.57C15.5 10.3 15.1 10.02 14.73 9.72C14.35 9.42 14 9.1 13.67 8.77" fill="#09BB07"/>
                </svg>
                <span>語音/視訊通話</span>
            </div>
        </div>
    </div>
    
    <!-- 朋友圈界面 -->
    <div class="moments" id="momentsPage">
        <div class="detail-header">
            <div class="detail-back" id="closeMoments">&#10094;</div>
            <div class="detail-title">朋友圈</div>
        </div>
        
        <div id="momentsContainer_old">
            <!-- 朋友圈內容會動態生成到這裡 -->
        </div>
    </div>
    
    <!-- 朋友圈頁面 -->
    <div class="moments-container" id="momentsContainer" style="display: none;">
        <!-- 朋友圈頭部 -->
        <div class="moments-header">
            <div class="moments-back-btn" id="momentsBackBtn">&#10094;</div>
            <div class="moments-camera-btn" id="momentsCameraBtn">📷</div>
        </div>
        
        <!-- 朋友圈內容區域 -->
        <div class="moments-content" id="momentsContent">
            <!-- 朋友圈動態將動態生成 -->
        </div>
    </div>

    </div> <!-- 關閉統一父容器 -->
    
    <script>
        // 檢測深色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 全局變量，標記是否完成過任意結局
        let hasCompletedAnyEnding = false;
        
        // 全局變量，記錄當前查看的角色ID
        let currentViewingCharacterId = null;
        
        // 獲取當前查看的角色ID
        function getCurrentViewingCharacterId() {
            return currentViewingCharacterId;
        }
        
        // 頁面歷史管理器
        class PageHistoryManager {
            constructor() {
                this.history = [];
                this.currentPage = 'mainContainer'; // 默認當前頁面
            }
            
            // 推入新頁面
            pushPage(pageId) {
                if (this.currentPage && this.currentPage !== pageId) {
                    this.history.push(this.currentPage);
                    console.log('推入頁面歷史:', this.currentPage, '歷史棧:', this.history);
                }
                this.currentPage = pageId;
            }
            
            // 返回上一頁
            goBack() {
                if (this.history.length > 0) {
                    const previousPage = this.history.pop();
                    console.log('返回上一頁:', previousPage, '歷史棧:', this.history);
                    this.currentPage = previousPage;
                    this.showPage(previousPage);
                    return true;
                }
                // 沒有歷史記錄，返回主界面
                console.log('沒有歷史記錄，返回主界面');
                this.currentPage = 'mainContainer';
                this.showPage('mainContainer');
                return false;
            }
            
            // 顯示指定頁面
            showPage(pageId) {
                // 隱藏所有頁面
                const pages = ['mainContainer', 'groupDetailsPage', 'memberProfilePage', 'momentsContainer', 'chatContainer', 'privateChatDetailsPage'];
                pages.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                // 顯示目標頁面
                const targetElement = document.getElementById(pageId);
                if (targetElement) {
                    targetElement.style.display = 'flex';
                    console.log('顯示頁面:', pageId);
                } else {
                    console.error('找不到頁面元素:', pageId);
                }
            }
            
            // 清空歷史
            clearHistory() {
                this.history = [];
                this.currentPage = 'mainContainer';
            }
        }
        
        // 全局頁面歷史管理器實例
        const pageHistory = new PageHistoryManager();
        
        // 配置管理系統 - 便於後續維護和擴展
        const CONFIG = {
            // 群組配置
            groups: {
                'poets_group': {
                    id: 'poets_group',
                    name: '詩人群',
                    description: '古往今來詩人雅集，以詩會友',
                    theme: '詩歌創作與鑑賞',
                    owner: 'yuzhen', // 群主：玉真公主
                    aiStyle: {
                        tone: '詩意盎然，才華橫溢',
                        focus: '詩詞韻律、意境營造、詩歌技法',
                        avoidTopics: ['政治敏感', '暴力內容', '世俗爭議'],
                        encourageTopics: ['詩歌創作', '韻律探討', '意境賞析', '詩人軼事', '自然山水']
                    },
                    members: ['yuzhen', 'libai', 'dufu', 'taoyuanming', 'wangwei', 'menghaoran', 'caozhi', 'yangguifei'],
                    maxMembers: 25,
                    isActive: true
                },
                'history_group': {
                    id: 'history_group', 
                    name: '史記群',
                    description: '以史為鑑，知興替得失',
                    theme: '歷史記錄與史學討論',
                    owner: 'simaqian', // 群主：司馬遷
                    aiStyle: {
                        tone: '客觀嚴謹，見解深刻',
                        focus: '歷史事件、人物評價、史學方法、因果分析',
                        avoidTopics: ['政治敏感', '現代政治', '爭議歷史'],
                        encourageTopics: ['古代歷史', '人物傳記', '史學方法', '文化傳承']
                    },
                    members: ['simaqian', 'confucius', 'liusi', 'baiqi', 'hanxin'],
                    maxMembers: 20,
                    isActive: true
                },
                'philosophy_group': {
                    id: 'philosophy_group',
                    name: '聞道群', 
                    description: '探尋天道人理，思辨古今智慧',
                    theme: '哲學思辨與人生智慧',
                    owner: 'confucius,laozi', // 雙群主：孔子、老子
                    aiStyle: {
                        tone: '睿智深沉，啟發思考',
                        focus: '哲學思辨、人生智慧、道德修養、天人關係',
                        avoidTopics: ['政治敏感', '宗教爭議', '極端觀點'],
                        encourageTopics: ['哲學思考', '人生感悟', '道德品格', '自然之道', '教育理念']
                    },
                    members: ['confucius', 'laozi', 'zhuangzi', 'mencius', 'huizi'],
                    maxMembers: 15,
                    isActive: true
                },
                'mystery_group': {
                    id: 'mystery_group',
                    name: '怪力亂神群',
                    description: '神話傳說，奇聞異事',
                    theme: '神話故事與奇幻傳說',
                    owner: 'pushengling,ganbao', // 雙群主：蒲松齡、干寶
                    aiStyle: {
                        tone: '神秘玄妙，想像豐富', 
                        focus: '神話傳說、奇聞異事、超自然現象、古代神怪',
                        avoidTopics: ['恐怖血腥', '封建迷信', '不當內容'],
                        encourageTopics: ['神話故事', '傳說考證', '文化象徵', '想像創作']
                    },
                    members: ['pushengling', 'ganbao', 'yutu', 'change', 'xiwangmu'],
                    maxMembers: 30,
                    isActive: true
                },
                'ci_poets_group': {
                    id: 'ci_poets_group',
                    name: '詞人群',
                    description: '詞韻悠揚，情致綿綿',
                    theme: '詞學創作與鑑賞',
                    owner: 'liuyong', // 群主：柳永
                    aiStyle: {
                        tone: '雅致深情，韻律優美',
                        focus: '詞學創作、音律格律、情感表達、詞牌探討',
                        avoidTopics: ['政治敏感', '暴力內容', '世俗爭議'],
                        encourageTopics: ['詞學技法', '音律美學', '情感抒發', '詞人軼事', '詞牌源流', '婉約豪放']
                    },
                    members: ['liuyong', 'liqingzhao', 'sushi', 'xinqiji', 'jiangkui', 'liyu', 'zhoubanyan', 'yanjidao', 'wuwenying', 'chenweisong', 'zhuyizun', 'nalanxingde'],
                    maxMembers: 20,
                    isActive: true
                }
            },
            
            // 安全性配置
            safety: {
                contentFilter: {
                    enabled: true,
                    strictMode: true, // 中學生模式
                    blockedKeywords: [
                        // 政治敏感詞
                        '政治', '革命', '造反', '推翻',
                        // 暴力內容
                        '殺', '死', '血', '戰爭', '仇恨',
                        // 不當內容
                        '色情', '賭博', '毒品', '犯罪',
                        // 現代不當用語
                        '網絡暴力', '霸凌'
                    ],
                    warningKeywords: [
                        '愛情', '戀愛', '婚姻' // 需要謹慎處理的話題
                    ]
                },
                aiGuidelines: {
                    // AI回應指導原則
                    principles: [
                        '始終保持正面積極的教育導向',
                        '引導學生思考文學和人生的美好',
                        '避免涉及政治敏感話題',
                        '以古代文化智慧啟發現代思考',
                        '鼓勵學習和探索精神'
                    ],
                    responseStyle: 'educational_positive',
                    maxResponseLength: 200
                }
            },
            
            // 角色行為配置
            characterBehaviors: {
                // 每個角色在不同情境下的行為模式
                default: {
                    greeting: '歡迎加入我們的文學討論',
                    onInappropriateTopic: '讓我們回到文學的美好世界吧',
                    onOffTopic: '這個話題很有趣，不過讓我們多聊聊古典文學如何？'
                }
            }
        };
        
        // 群組管理類
        class GroupManager {
            constructor() {
                this.currentGroup = 'poets_group'; // 默認進入詩人群
                this.safetyFilter = new SafetyFilter();
            }
            
            // 動態添加群組
            addGroup(groupConfig) {
                CONFIG.groups[groupConfig.id] = groupConfig;
                console.log(`群組 ${groupConfig.name} 已添加`);
            }
            

            
            // 獲取當前群組的AI提示詞
            getAIPrompt(characterId, userMessage) {
                const group = CONFIG.groups[this.currentGroup];
                const character = characters[characterId];
                
                return `
你是${character.name}，在"${group.name}"群組中。

群組主題：${group.theme}
語言風格：${group.aiStyle.tone}
討論重點：${group.aiStyle.focus}
鼓勵話題：${group.aiStyle.encourageTopics.join('、')}

重要原則：
${CONFIG.safety.aiGuidelines.principles.join('\n')}

用戶消息：${userMessage}

請以${character.name}的身份，用符合群組風格的方式回應，保持教育性和正面性。
                `;
            }
            

        }
        
        // 安全過濾器類
        class SafetyFilter {
            constructor() {
                this.config = CONFIG.safety.contentFilter;
            }
            
            // 檢查用戶輸入安全性
            checkUserInput(message) {
                if (!this.config.enabled) return { safe: true };
                
                const lowerMessage = message.toLowerCase();
                
                // 檢查被禁關鍵詞
                for (let keyword of this.config.blockedKeywords) {
                    if (lowerMessage.includes(keyword.toLowerCase())) {
                        return {
                            safe: false,
                            reason: 'blocked_keyword',
                            keyword: keyword,
                            suggestion: '讓我們聊聊文學和詩詞吧！'
                        };
                    }
                }
                
                // 檢查警告關鍵詞
                for (let keyword of this.config.warningKeywords) {
                    if (lowerMessage.includes(keyword.toLowerCase())) {
                        return {
                            safe: true,
                            warning: true,
                            keyword: keyword,
                            note: '這個話題需要以文學和文化的角度來討論'
                        };
                    }
                }
                
                return { safe: true };
            }
            
            // 過濾AI回應
            filterAIResponse(response) {
                // 確保AI回應符合安全標準
                let filtered = response;
                
                // 長度控制
                if (filtered.length > CONFIG.safety.aiGuidelines.maxResponseLength) {
                    filtered = filtered.substring(0, CONFIG.safety.aiGuidelines.maxResponseLength) + '...';
                }
                
                return filtered;
            }
            
            // 檢查AI回應安全性（私聊專用）
            async checkAIResponse(userMessage, characterId) {
                // 簡單的安全檢查，允許正常的文學對話
                return {
                    safe: true,
                    reason: null
                };
            }
        }
        
        // 全局實例
        const groupManager = new GroupManager();
        const safetyFilter = new SafetyFilter();
        
        // 配置管理工具（方便開發和調試）
        const ConfigManager = {
            // 快速添加新群組
            addNewGroup(groupData) {
                groupManager.addGroup(groupData);
                console.log('新群組配置已添加:', groupData.name);
            },
            
            // 快速添加新角色
            addCharacter(id, characterData) {
                characters[id] = characterData;
                console.log('新角色已添加:', characterData.name);
            },
            
            // 調整安全關鍵詞
            updateSafetyKeywords(type, keywords) {
                if (type === 'blocked') {
                    CONFIG.safety.contentFilter.blockedKeywords = keywords;
                } else if (type === 'warning') {
                    CONFIG.safety.contentFilter.warningKeywords = keywords;
                }
                console.log(`安全關鍵詞已更新: ${type}`);
            },
            
            // 快速切換群組
            switchToGroup(groupId) {
                if (CONFIG.groups[groupId]) {
                    groupManager.currentGroup = groupId;
                    console.log(`已切換到群組: ${CONFIG.groups[groupId].name}`);
                } else {
                    console.error('群組不存在:', groupId);
                }
            },
            
            // 導出當前配置
            exportConfig() {
                return {
                    groups: CONFIG.groups,
                    characters: characters,
                    safety: CONFIG.safety
                };
            },
            
            // 導入配置
            importConfig(configData) {
                if (configData.groups) Object.assign(CONFIG.groups, configData.groups);
                if (configData.characters) Object.assign(characters, configData.characters);
                if (configData.safety) Object.assign(CONFIG.safety, configData.safety);
                console.log('配置已導入');
            },
            
            // 查看所有群組
            listGroups() {
                console.log('=== 太虛幻聊 群組列表 ===');
                Object.values(CONFIG.groups).forEach(group => {
                    console.log(`📱 ${group.name} (${group.id})`);
                    console.log(`   群主: ${group.owner}`);
                    console.log(`   成員: ${group.members.join(', ')}`);
                    console.log(`   主題: ${group.theme}`);
                    console.log('---');
                });
            },
            
            // 驗證群組成員配置
            validateGroupMembers() {
                console.log('=== 驗證群組成員配置 ===');
                let isValid = true;
                
                Object.values(CONFIG.groups).forEach(group => {
                    console.log(`檢查群組: ${group.name}`);
                    
                    group.members.forEach(memberId => {
                        if (!characters[memberId]) {
                            console.warn(`⚠️ 群組 ${group.name} 中的成員 ${memberId} 沒有在 characters 中定義`);
                            isValid = false;
                        } else {
                            console.log(`  ✓ ${characters[memberId].name} (${memberId})`);
                        }
                    });
                    
                    if (group.members.length === 0) {
                        console.warn(`⚠️ 群組 ${group.name} 沒有任何成員`);
                        isValid = false;
                    }
                    
                    console.log('---');
                });
                
                if (isValid) {
                    console.log('✅ 群組成員配置驗證通過');
                } else {
                    console.log('❌ 群組成員配置存在問題');
                }
                
                return isValid;
            },
            
            // 檢查發言權限
            checkSpeakPermission(characterId, groupId) {
                const group = CONFIG.groups[groupId];
                if (!group) {
                    console.warn(`群組 ${groupId} 不存在`);
                    return false;
                }
                
                const canSpeak = group.members.includes(characterId);
                console.log(`角色 ${characterId} 在群組 ${group.name} 中的發言權限: ${canSpeak ? '✅ 可以' : '❌ 不可以'}`);
                return canSpeak;
            }
        };
        
        // 暴露到全局，方便開發者控制台使用
        window.ConfigManager = ConfigManager;
        
        // 群組列表管理器
        class GroupListManager {
            constructor() {
                this.groupIcons = {
                    'poets_group': '📝',
                    'history_group': '📚', 
                    'philosophy_group': '🧘',
                    'mystery_group': '👻'
                };
                this.groupClasses = {
                    'poets_group': 'poets',
                    'history_group': 'history',
                    'philosophy_group': 'philosophy', 
                    'mystery_group': 'mystery'
                };
            }
            
            // 生成群組列表
            generateGroupList() {
                const container = document.getElementById('groupListContainer');
                container.innerHTML = '';
                
                Object.values(CONFIG.groups).forEach(group => {
                    const groupItem = this.createGroupItem(group);
                    container.appendChild(groupItem);
                });
            }
            
            // 創建單個群組項目
            createGroupItem(group) {
                const item = document.createElement('div');
                item.className = `group-item ${group.id === groupManager.currentGroup ? 'active' : ''}`;
                item.setAttribute('data-group-id', group.id);
                
                const icon = this.groupIcons[group.id] || '💬';
                const avatarClass = this.groupClasses[group.id] || '';
                const ownerNames = this.getOwnerNames(group.owner);
                
                item.innerHTML = `
                    <div class="group-avatar ${avatarClass}">
                        ${icon}
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-desc">${group.description}</div>
                    </div>
                    <div class="group-meta">
                        <div class="group-member-count">${group.members.length}人</div>
                        <div class="group-owner">群主: ${ownerNames}</div>
                    </div>
                `;
                
                // 添加點擊事件
                item.addEventListener('click', () => {
                    this.switchToGroup(group.id);
                });
                
                return item;
            }
            
            // 獲取群主名稱
            getOwnerNames(ownerIds) {
                if (!ownerIds) return '無';
                
                const owners = ownerIds.split(',');
                return owners.map(id => {
                    const character = characters[id.trim()];
                    return character ? character.name : id;
                }).join('、');
            }
            
            // 切換到指定群組
            switchToGroup(groupId) {
                if (groupId === groupManager.currentGroup) {
                    // 如果是當前群組，直接關閉列表
                    this.closeGroupList();
                    return;
                }
                
                // 切換群組
                groupManager.currentGroup = groupId;
                
                // 直接設置群組標題
                const currentGroup = CONFIG.groups[groupId];
                if (currentGroup) {
                    const groupTitle = document.querySelector('.wx-header-title');
                    if (groupTitle) {
                        groupTitle.textContent = `${currentGroup.name} (${currentGroup.members.length})`;
                        console.log(`群組標題已設置為: ${groupTitle.textContent}`);
                    }
                }
                
                // 更新群組列表中的活躍狀態
                this.updateActiveGroup();
                
                // 清空聊天記錄，顯示新群組歡迎消息
                this.clearChatAndWelcome(groupId);
                
                // 關閉列表
                this.closeGroupList();
                
                console.log(`已切換到群組: ${CONFIG.groups[groupId].name}`);
            }
            
            // 更新活躍群組顯示
            updateActiveGroup() {
                const items = document.querySelectorAll('.group-item');
                items.forEach(item => {
                    const groupId = item.getAttribute('data-group-id');
                    if (groupId === groupManager.currentGroup) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            // 清空聊天並顯示歡迎消息
            clearChatAndWelcome(groupId) {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                const group = CONFIG.groups[groupId];
                
                // 群組歡迎消息（不重複添加時間戳）
                addMessage({
                    type: 'system',
                    content: `歡迎來到${group.name}！${group.description}`
                });
                
                // 群主歡迎
                setTimeout(() => {
                    const owners = group.owner.split(',');
                    const firstOwner = owners[0].trim();
                    const ownerChar = characters[firstOwner];
                    
                    if (ownerChar) {
                        addMessage({
                            type: 'message',
                            character: firstOwner,
                            content: this.getWelcomeMessage(groupId, ownerChar),
                            contentType: 'text'
                        });
                    }
                }, 1000);
            }
            
            // 打開群組列表
            openGroupList() {
                this.generateGroupList();
                document.getElementById('groupListPage').style.display = 'flex';
            }
            
            // 關閉群組列表
            closeGroupList() {
                document.getElementById('groupListPage').style.display = 'none';
            }
        }
        
        // 全局群組列表管理器實例
        const groupListManager = new GroupListManager();
        
        // 聊天歷史管理器
        class ChatHistoryManager {
            constructor() {
                this.storageKey = 'wxchat_history';
                this.maxMessagesPerChat = 1000; // 每個聊天最多保存1000條消息
            }
            
            // 獲取所有聊天歷史
            getAllHistory() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : {};
                } catch (error) {
                    console.error('讀取聊天歷史失敗:', error);
                    return {};
                }
            }
            
            // 獲取特定聊天的歷史記錄
            getChatHistory(chatId) {
                const allHistory = this.getAllHistory();
                return allHistory[chatId] || [];
            }
            
            // 保存消息到歷史記錄
            saveMessage(chatId, message) {
                try {
                    const allHistory = this.getAllHistory();
                    
                    if (!allHistory[chatId]) {
                        allHistory[chatId] = [];
                    }
                    
                    // 添加時間戳和ID
                    const messageWithMeta = {
                        ...message,
                        id: this.generateMessageId(),
                        timestamp: new Date().toISOString(),
                        saved: true
                    };
                    
                    allHistory[chatId].push(messageWithMeta);
                    
                    // 限制消息數量，保留最新的消息
                    if (allHistory[chatId].length > this.maxMessagesPerChat) {
                        allHistory[chatId] = allHistory[chatId].slice(-this.maxMessagesPerChat);
                    }
                    
                    localStorage.setItem(this.storageKey, JSON.stringify(allHistory));
                    console.log(`消息已保存到 ${chatId}:`, messageWithMeta.content || messageWithMeta.type);
                    
                    return messageWithMeta;
                } catch (error) {
                    console.error('保存消息失敗:', error);
                    return message;
                }
            }
            
            // 生成消息ID
            generateMessageId() {
                return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            // 載入聊天歷史到界面
            loadChatHistory(chatId) {
                const history = this.getChatHistory(chatId);
                const chatMessages = document.getElementById('chatMessages');
                
                if (!chatMessages) return;
                
                // 清空現有消息
                chatMessages.innerHTML = '';
                
                console.log(`載入 ${chatId} 的歷史記錄，共 ${history.length} 條消息`);
                
                // 渲染歷史消息
                history.forEach(message => {
                    this.renderHistoryMessage(message);
                });
                
                // 滾動到底部
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
                
                return history.length;
            }
            
            // 渲染歷史消息
            renderHistoryMessage(message) {
                if (message.type === 'system') {
                    this.renderSystemMessage(message);
                } else if (message.type === 'message') {
                    this.renderCharacterMessage(message);
                } else if (message.type === 'user') {
                    this.renderUserMessage(message);
                }
            }
            
            // 渲染系統消息
            renderSystemMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const systemMsg = document.createElement('div');
                systemMsg.className = 'wx-system-msg';
                systemMsg.textContent = message.content;
                chatMessages.appendChild(systemMsg);
            }
            
            // 渲染角色消息
            renderCharacterMessage(message) {
                const character = characters[message.character];
                if (!character) return;
                
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = 'wx-msg wx-msg-left';
                
                messageElement.innerHTML = `
                    <div class="wx-msg-avatar" onclick="handleAvatarClick('${message.character}', event)">
                        ${character.avatar}
                    </div>
                    <div class="wx-msg-content">
                        <div class="wx-msg-name">${character.name}</div>
                        <div class="wx-msg-bubble">
                            <div class="wx-msg-text">${message.content}</div>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
            }
            
            // 渲染用戶消息
            renderUserMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageElement = document.createElement('div');
                messageElement.className = 'wx-msg wx-msg-right';
                
                messageElement.innerHTML = `
                    <div class="wx-msg-content">
                        <div class="wx-msg-bubble wx-msg-bubble-primary">
                            <div class="wx-msg-text">${message.content}</div>
                        </div>
                    </div>
                    <div class="wx-msg-avatar">👤</div>
                `;
                
                chatMessages.appendChild(messageElement);
            }
            
            // 獲取聊天的最後一條消息（用於聊天列表預覽）
            getLastMessage(chatId) {
                const history = this.getChatHistory(chatId);
                if (history.length === 0) return null;
                
                const lastMessage = history[history.length - 1];
                return {
                    content: this.formatPreviewMessage(lastMessage),
                    timestamp: lastMessage.timestamp
                };
            }
            
            // 格式化預覽消息
            formatPreviewMessage(message) {
                if (message.type === 'system') {
                    return message.content;
                } else if (message.type === 'user') {
                    return message.content;
                } else if (message.type === 'message') {
                    const character = characters[message.character];
                    const name = character ? character.name : '角色';
                    return `${name}: ${message.content}`;
                }
                return message.content || '[消息]';
            }
            
            // 清空特定聊天的歷史記錄
            clearChatHistory(chatId) {
                try {
                    const allHistory = this.getAllHistory();
                    delete allHistory[chatId];
                    localStorage.setItem(this.storageKey, JSON.stringify(allHistory));
                    console.log(`已清空 ${chatId} 的歷史記錄`);
                } catch (error) {
                    console.error('清空歷史記錄失敗:', error);
                }
            }
            
            // 清空所有歷史記錄
            clearAllHistory() {
                try {
                    localStorage.removeItem(this.storageKey);
                    console.log('已清空所有聊天歷史記錄');
                } catch (error) {
                    console.error('清空所有歷史記錄失敗:', error);
                }
            }
            
            // 獲取存儲大小（KB）
            getStorageSize() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? Math.round(data.length / 1024 * 100) / 100 : 0;
                } catch (error) {
                    return 0;
                }
            }
            
            // 導出聊天記錄
            exportHistory() {
                const allHistory = this.getAllHistory();
                const dataStr = JSON.stringify(allHistory, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }
        
        // 全局聊天歷史管理器實例
        const chatHistoryManager = new ChatHistoryManager();
        
        // 主界面管理器
        class MainInterface {
            constructor() {
                this.currentTab = 'chatListTab';
                this.chatPreviews = {
                    'poets_group': '玉真公主: 歡迎新朋友加入詩人群！',
                    'history_group': '司馬遷: 以史為鑑，可以知興替',
                    'philosophy_group': '孔子: 學而時習之，不亦說乎？',
                    'mystery_group': '蒲松齡: 今夜又有新的奇聞異事...'
                };
                this.chatTimes = {
                    'poets_group': '19:28',
                    'history_group': '16:41', 
                    'philosophy_group': '23:59',
                    'mystery_group': '16:36'
                };
            }
            
            // 初始化主界面
            init() {
                this.initializeSamplePrivateChats();
                this.generateChatList();
                this.generateContacts();
                this.generateDiscover();
                this.setupMainEvents();
                this.updateBadges();
                
                // 初始化朋友圈
                momentsManager.init();
            }
            
            // 初始化示例私聊
            initializeSamplePrivateChats() {
                const samplePrivateChats = ['li_bai', 'chang_e'];
                
                samplePrivateChats.forEach(characterId => {
                    const privateChatId = `private_${characterId}`;
                    if (!CONFIG.groups[privateChatId] && characters[characterId]) {
                        CONFIG.groups[privateChatId] = {
                            id: privateChatId,
                            name: characters[characterId].name,
                            description: `與${characters[characterId].name}的私人對話`,
                            theme: '私人對話',
                            owner: characterId,
                            members: ['user', characterId],
                            maxMembers: 2,
                            isActive: true,
                            isPrivateChat: true
                        };
                    }
                });
            }
            
            // 聊天預覽消息（示例數據）
            chatPreviews = {
                'poets_group': '李白: 君不見黃河之水天上來...',
                'history_group': '司馬遷: 史記第一百三十卷完成',
                'philosophy_group': '孔子: 學而時習之，不亦說乎？',
                'mystery_group': '嫦娥: 廣寒宮中又是一年...'
            }
            
            // 聊天時間（示例數據）
            chatTimes = {
                'poets_group': '13:42',
                'history_group': '昨天',
                'philosophy_group': '2天前', 
                'mystery_group': '1小時前'
            }
            
            // 進入聊天界面
            enterChat(groupId) {
                // 切換到聊天界面
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('chatContainer').style.display = 'flex';
                
                // 設置當前群組
                groupManager.currentGroup = groupId;
                console.log(`切換到群組: ${groupId}`);
                
                // 直接設置群組標題
                const currentGroup = CONFIG.groups[groupId];
                if (currentGroup) {
                    const groupTitle = document.querySelector('.wx-header-title');
                    if (groupTitle) {
                        groupTitle.textContent = `${currentGroup.name} (${currentGroup.members.length})`;
                        console.log(`群組標題已設置為: ${groupTitle.textContent}`);
                    }
                }
                
                // 載入歷史聊天記錄
                const historyCount = chatHistoryManager.loadChatHistory(groupId);
                
                // 如果沒有歷史記錄，初始化該群組的歡迎消息
                if (historyCount === 0) {
                    this.initializeGroupWelcome(groupId);
                }
            }
            
            // 初始化群組歡迎消息
            initializeGroupWelcome(groupId) {
                const group = CONFIG.groups[groupId];
                if (!group) return;
                
                // 系統歡迎消息
                addMessage({
                    type: 'system',
                    content: `歡迎來到${group.name}！${group.description}`
                });
                
                // 群主歡迎消息
                setTimeout(() => {
                    const owners = group.owner.split(',');
                    const firstOwner = owners[0].trim();
                    const ownerChar = characters[firstOwner];
                    
                    if (ownerChar) {
                        const welcomeMsg = this.getWelcomeMessage(groupId, ownerChar);
                        addMessage({
                            type: 'message',
                            character: firstOwner,
                            content: welcomeMsg,
                            contentType: 'text'
                        });
                    }
                }, 1000);
            }
            
            // 獲取群組歡迎消息
            getWelcomeMessage(groupId, ownerChar) {
                const messages = {
                    'poets_group': `歡迎來到詩人群！本宮${ownerChar.name}，與諸位詩友共賞千古詞章。`,
                    'history_group': `歡迎來到史記群！在下${ownerChar.name}，願與諸位探討古今興亡得失。`,
                    'philosophy_group': `歡迎來到聞道群！老夫${ownerChar.name}，與諸位共參天道人理。`,
                    'mystery_group': `歡迎來到怪力亂神群！在下${ownerChar.name}，與諸位分享奇聞異事。`,
                    'ci_poets_group': `歡迎來到詞人群！在下${ownerChar.name}，與諸位詞友共研詞韻，論斷千古詞章。願我詞壇同道，一同探討詞牌格律，品味詞中情致。`
                };
                
                return messages[groupId] || `歡迎加入${CONFIG.groups[groupId].name}！`;
            }
            
            // 生成聊天列表
            generateChatList() {
                const container = document.getElementById('chatListContainer');
                container.innerHTML = '';
                
                console.log('生成聊天列表...');
                
                // 獲取所有聊天（群聊 + 私聊）
                const chatList = this.getChatList();
                
                // 按最後消息時間排序
                chatList.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
                
                // 生成聊天項目
                chatList.forEach(chat => {
                    const chatItem = this.createChatItem(chat);
                    container.appendChild(chatItem);
                });
                
                console.log('聊天列表生成完成，共', chatList.length, '個對話');
            }
            
            // 獲取聊天列表數據
            getChatList() {
                const chatList = [];
                
                // 添加群聊
                Object.values(CONFIG.groups).forEach(group => {
                    if (!group.isPrivateChat) { // 排除私聊
                        chatList.push({
                            id: group.id,
                            type: 'group',
                            name: group.name,
                            avatar: this.getGroupAvatar(group),
                            lastMessage: this.getLastMessage(group.id),
                            lastMessageTime: this.getLastMessageTime(group.id),
                            unreadCount: Math.floor(Math.random() * 3), // 模擬未讀數
                            theme: group.theme || ''
                        });
                    }
                });
                
                // 添加私聊（從本地存儲或配置中獲取）
                const privateChats = this.getPrivateChats();
                privateChats.forEach(chat => {
                    chatList.push(chat);
                });
                
                return chatList;
            }
            
            // 創建聊天項目
            createChatItem(chat) {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.setAttribute('data-chat-id', chat.id);
                item.setAttribute('data-chat-type', chat.type);
                
                item.innerHTML = `
                    <div class="chat-avatar">
                        ${chat.avatar}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-preview">${chat.lastMessage}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${this.formatTime(chat.lastMessageTime)}</div>
                        ${chat.unreadCount > 0 ? `<div class="chat-unread show">${chat.unreadCount}</div>` : ''}
                    </div>
                `;
                
                // 添加點擊事件
                item.addEventListener('click', () => {
                    this.openChat(chat);
                });
                
                return item;
            }
            
            // 獲取群組頭像
            getGroupAvatar(group) {
                // 直接使用固定的群組圖標
                const icons = {
                    'poets_group': '📝',
                    'history_group': '📚', 
                    'philosophy_group': '🎭',
                    'mystery_group': '🌙',
                    'ci_poets_group': '🎵'
                };
                return icons[group.id] || '👥';
            }
            

            
            // 獲取最後一條消息
            getLastMessage(chatId) {
                // 優先從歷史記錄中獲取
                const lastMsg = chatHistoryManager.getLastMessage(chatId);
                if (lastMsg) {
                    return lastMsg.content;
                }
                
                // 回退到預設消息
                const specificMessages = {
                    'poets_group': '李白: 君不見黃河之水天上來，奔流到海不復回',
                    'history_group': '司馬遷: 史記第一百三十卷已完成撰寫',
                    'philosophy_group': '孔子: 學而時習之，不亦說乎？',
                    'mystery_group': '嫦娥: 廣寒宮中又是一年秋',
                    'ci_poets_group': '柳永: 今宵酒醒何處？楊柳岸，曉風殘月',
                    'private_li_bai': '詩仙剛才分享了一首新作',
                    'private_chang_e': '月宮中的生活確實有些寂寞'
                };
                
                if (specificMessages[chatId]) {
                    return specificMessages[chatId];
                }
                
                // 如果是私聊但沒有預設消息
                if (chatId.startsWith('private_')) {
                    const privateMessages = [
                        '你好，很高興認識你',
                        '剛才的對話很有意思',
                        '今天過得怎麼樣？',
                        '[表情]',
                        '有空再聊'
                    ];
                    return privateMessages[Math.floor(Math.random() * privateMessages.length)];
                }
                
                // 一般群聊消息
                const generalMessages = [
                    '歡迎加入我們的文學討論',
                    '今日詩詞分享：春花秋月何時了',
                    '大家對這個話題怎麼看？',
                    '剛才的討論很精彩',
                    '這個觀點很有意思',
                    '[圖片]',
                    '[語音]'
                ];
                return generalMessages[Math.floor(Math.random() * generalMessages.length)];
            }
            
            // 獲取最後消息時間
            getLastMessageTime(chatId) {
                // 優先從歷史記錄中獲取
                const lastMsg = chatHistoryManager.getLastMessage(chatId);
                if (lastMsg && lastMsg.timestamp) {
                    return new Date(lastMsg.timestamp);
                }
                
                // 回退到隨機時間
                const now = new Date();
                const randomMinutes = Math.floor(Math.random() * 1440); // 24小時內
                return new Date(now - randomMinutes * 60 * 1000);
            }
            
            // 獲取私聊列表
            getPrivateChats() {
                const privateChats = [];
                
                // 檢查已有的私聊（從配置中）
                Object.values(CONFIG.groups).forEach(group => {
                    if (group.isPrivateChat) {
                        const characterId = group.id.replace('private_', '');
                        const character = characters[characterId];
                        if (character) {
                            privateChats.push({
                                id: group.id,
                                type: 'private',
                                name: character.name,
                                avatar: character.avatar,
                                lastMessage: this.getLastMessage(group.id),
                                lastMessageTime: this.getLastMessageTime(group.id),
                                unreadCount: Math.floor(Math.random() * 2),
                                characterId: characterId
                            });
                        }
                    }
                });
                
                return privateChats;
            }
            
            // 格式化時間顯示
            formatTime(time) {
                const now = new Date();
                const diff = now - time;
                const minutes = Math.floor(diff / (1000 * 60));
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (minutes < 1) return '剛剛';
                if (minutes < 60) return `${minutes}分鐘前`;
                if (hours < 24) return `${hours}小時前`;
                if (days < 7) return `${days}天前`;
                
                // 格式化為時間
                const hour = time.getHours();
                const minute = time.getMinutes().toString().padStart(2, '0');
                return `${hour}:${minute}`;
            }
            
            // 打開聊天
            openChat(chat) {
                console.log('打開聊天:', chat);
                
                if (chat.type === 'group') {
                    // 打開群聊
                    this.enterChat(chat.id);
                } else if (chat.type === 'private') {
                    // 打開私聊
                    groupManager.currentGroup = chat.id;
                    this.enterPrivateChat(chat.characterId);
                }
            }
            
            // 進入私聊
            enterPrivateChat(characterId) {
                const character = characters[characterId];
                if (!character) return;
                
                // 切換到聊天界面
                pageHistory.pushPage('chatContainer');
                pageHistory.showPage('chatContainer');
                
                // 設置聊天標題
                const groupTitle = document.querySelector('.wx-header-title');
                if (groupTitle) {
                    groupTitle.textContent = character.name;
                }
                
                // 載入私聊歷史記錄
                const privateChatId = `private_${characterId}`;
                const historyCount = chatHistoryManager.loadChatHistory(privateChatId);
                
                // 如果沒有歷史記錄，添加私聊歡迎消息
                if (historyCount === 0) {
                    setTimeout(() => {
                        addMessage({
                            type: 'message',
                            character: characterId,
                            content: getPrivateChatWelcome(characterId),
                            contentType: 'text'
                        });
                    }, 500);
                }
                
                console.log('進入私聊:', character.name, `(歷史記錄: ${historyCount} 條)`);
            }
            
            // 設置主界面事件
            setupMainEvents() {
                // 底部導航切換
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const targetTab = item.getAttribute('data-tab');
                        this.switchTab(targetTab);
                    });
                });
                
                // 初始化header状态
                this.updateMainHeader('chatListTab');
            }
            
            // 切換標籤頁
            switchTab(targetTab) {
                // 隱藏所有標籤頁
                const tabs = ['chatListTab', 'contactsTab', 'discoverTab', 'profileTab'];
                tabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) tab.style.display = 'none';
                });
                
                // 顯示目標標籤頁
                const target = document.getElementById(targetTab);
                if (target) target.style.display = 'block';
                
                // 更新導航項目狀態
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-tab') === targetTab) {
                        item.classList.add('active');
                    }
                });
                
                // 更新header标题和显示状态
                this.updateMainHeader(targetTab);
            }
            
            // 更新主界面header
            updateMainHeader(targetTab) {
                const mainHeader = document.querySelector('.main-header');
                const mainTitle = document.querySelector('.main-title');
                
                if (targetTab === 'profileTab') {
                    // "我"页面隐藏header
                    mainHeader.style.display = 'none';
                } else {
                    // 其他页面显示header
                    mainHeader.style.display = 'flex';
                    
                    // 根据不同tab更新标题
                    switch(targetTab) {
                        case 'chatListTab':
                            const unreadCount = this.getUnreadCount();
                            mainTitle.innerHTML = `TheyChat <span class="main-title-count">(${unreadCount})</span>`;
                        break;
                        case 'contactsTab':
                            mainTitle.innerHTML = '通訊錄';
                        break;
                        case 'discoverTab':
                            mainTitle.innerHTML = '發現';
                        break;
                    }
                }
            }
            

            
            // 更新徽章
            updateBadges() {
                // 更新聊天徽章
                const chatBadge = document.getElementById('chatBadge');
                if (chatBadge) {
                    const unreadCount = this.getUnreadCount();
                    if (unreadCount > 0) {
                        chatBadge.textContent = unreadCount;
                        chatBadge.classList.add('show');
                    } else {
                        chatBadge.classList.remove('show');
                    }
                }
            }
            
            // 獲取未讀消息數
            getUnreadCount() {
                // 模擬未讀數量
                return 41;
            }
            
            // 刷新聊天列表（用於發送消息後更新）
            refreshChatList() {
                this.generateChatList();
            }

            // 生成通訊錄
            generateContacts() {
                const container = document.getElementById('contactsContainer');
                container.innerHTML = '';
                
                // 收集所有角色
                const allCharacters = [];
                Object.values(CONFIG.groups).forEach(group => {
                    group.members.forEach(id => {
                        const char = characters[id];
                        if (char && id !== 'user' && id !== 'system') allCharacters.push(char);
                    });
                });
                
                // 按朝代分組
                const charactersByDynasty = {};
                allCharacters.forEach(char => {
                    const dynasty = char.dynasty || '未分類';
                    if (!charactersByDynasty[dynasty]) {
                        charactersByDynasty[dynasty] = [];
                    }
                    charactersByDynasty[dynasty].push(char);
                });
                
                // 定義朝代排序順序
                const dynastyOrder = [
                    '神話傳說',
                    '春秋戰國',
                    '漢代',
                    '三國兩晉南北朝',
                    '五代十國',
                    '唐代',
                    '宋代',
                    '元代',
                    '明代',
                    '清代',
                    '現代',
                    '未分類'
                ];
                
                // 按朝代順序生成通訊錄
                dynastyOrder.forEach(dynasty => {
                    if (charactersByDynasty[dynasty] && charactersByDynasty[dynasty].length > 0) {
                        // 朝代分組標題
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'contact-group-header';
                        groupHeader.textContent = dynasty;
                    container.appendChild(groupHeader);
                    
                        // 該朝代下的角色列表
                        charactersByDynasty[dynasty].forEach(char => {
                        const contactItem = this.createContactItem(char);
                        container.appendChild(contactItem);
                    });
                    }
                });
            }
            

            
            // 創建聯繫人項目
            createContactItem(character) {
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.setAttribute('data-character-id', character.name);
                
                item.innerHTML = `
                    <div class="contact-avatar">
                        ${character.avatar}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${character.name}</div>
                        <div class="contact-desc">${character.description}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    this.viewCharacterProfile(character);
                });
                
                return item;
            }
            
            // 查看角色資料
            viewCharacterProfile(character) {
                // 通過角色名稱查找對應的ID
                const characterId = this.findCharacterIdByName(character.name);
                if (characterId) {
                    // 打開角色資料頁面
                    openProfilePage(characterId);
                } else {
                    console.error('找不到角色ID:', character.name);
                }
            }
            
            // 通過角色名稱查找對應的ID
            findCharacterIdByName(name) {
                for (const [id, char] of Object.entries(characters)) {
                    if (char.name === name) {
                        return id;
                    }
                }
                return null;
            }
            
            // 生成發現頁面
            generateDiscover() {
                const container = document.getElementById('discoverContainer');
                container.innerHTML = '';
                
                // 創建朋友圈入口
                const momentsEntry = document.createElement('div');
                momentsEntry.className = 'discover-item';
                momentsEntry.innerHTML = `
                    <div class="discover-icon">📷</div>
                    <div class="discover-label">朋友圈</div>
                `;
                momentsEntry.addEventListener('click', () => {
                    this.viewMoments();
                });
                container.appendChild(momentsEntry);
                
                // 添加分隔線
                const separator = document.createElement('div');
                separator.style.height = '8px';
                separator.style.backgroundColor = '#f0f0f0';
                container.appendChild(separator);
                
                // 創建其他發現選項
                const otherItems = [
                    { icon: '📚', label: '詩詞鑑賞' },
                    { icon: '🎭', label: '戲曲賞析' },
                    { icon: '🏛️', label: '歷史典故' },
                    { icon: '🐲', label: '神話傳說' }
                ];
                
                otherItems.forEach(item => {
                    const discoverItem = document.createElement('div');
                    discoverItem.className = 'discover-item';
                    discoverItem.innerHTML = `
                        <div class="discover-icon">${item.icon}</div>
                        <div class="discover-label">${item.label}</div>
                    `;
                    discoverItem.addEventListener('click', () => {
                        // 暫時顯示提示
                        alert(`${item.label}功能開發中...`);
                    });
                    container.appendChild(discoverItem);
                });
            }
            
            // 創建發現項目  
            createDiscoverItem(character) {
                const item = document.createElement('div');
                item.className = 'discover-item';
                item.setAttribute('data-character-id', character.name);
                
                item.innerHTML = `
                    <div class="discover-icon">
                        ${character.avatar}
                    </div>
                    <div class="discover-label">${character.name}的朋友圈</div>
                `;
                
                item.addEventListener('click', () => {
                    this.viewMoments(character);
                });
                
                return item;
            }
            
            // 查看朋友圈
            viewMoments(character) {
                momentsManager.openMoments();
            }
            
            // 切換標籤頁
            switchTab(tabId) {
                // 隱藏所有標籤內容
                document.querySelectorAll('.main-content > div').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // 顯示選中的標籤
                document.getElementById(tabId).style.display = 'block';
                this.currentTab = tabId;
                
                // 更新導航欄狀態
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            }
            
            // 更新徽章
            updateBadges() {
                document.getElementById('chatBadge').classList.add('show');
                document.getElementById('discoverBadge').classList.add('show');
            }
            
            // 設置主界面事件
            setupMainEvents() {
                // 底部導航切換
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const tabId = item.getAttribute('data-tab');
                        this.switchTab(tabId);
                    });
                });
                
                // 返回主界面按鈕
                document.getElementById('backToMainBtn').addEventListener('click', () => {
                    this.backToMain();
                });
            }
            
            // 返回主界面
            backToMain() {
                document.getElementById('chatContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'flex';
            }
        }
        
        // 全局主界面實例
        const mainInterface = new MainInterface();
        
        // 登入管理器
        class LoginManager {
            constructor() {
                this.correctPassword = 'chineseclassics';
                this.userInfo = {
                    nickname: '',
                    grade: '',
                    loginTime: null
                };
            }
            
            // 初始化登入功能
            init() {
                this.setupLoginEvents();
                this.setupFormValidation();
            }
            
            // 設置登入事件
            setupLoginEvents() {
                const loginBtn = document.getElementById('loginBtn');
                const debugBtn = document.getElementById('debugBtn');
                const nicknameInput = document.getElementById('nickname');
                const passwordInput = document.getElementById('password');
                
                // 登入按鈕點擊
                loginBtn.addEventListener('click', () => {
                    this.handleLogin();
                });
                
                // 調試按鈕點擊
                debugBtn.addEventListener('click', () => {
                    this.handleDebugLogin();
                });
                
                // 回車鍵登入
                [nicknameInput, passwordInput, document.getElementById('grade')].forEach(element => {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.handleLogin();
                        }
                    });
                });
            }
            
            // 設置表單驗證
            setupFormValidation() {
                const inputs = ['nickname', 'password'];
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    input.addEventListener('input', () => {
                        this.clearError();
                        this.validateInput(input);
                    });
                });
                
                const gradeSelect = document.getElementById('grade');
                gradeSelect.addEventListener('change', () => {
                    this.clearError();
                });
            }
            
            // 驗證輸入
            validateInput(input) {
                if (input.id === 'nickname') {
                    // 昵稱驗證
                    const value = input.value.trim();
                    if (value.length > 12) {
                        input.value = value.substring(0, 12);
                    }
                    
                    // 過濾不合適的字符
                    const filtered = value.replace(/[^\u4e00-\u9fa5\w\s]/g, '');
                    if (filtered !== value) {
                        input.value = filtered;
                    }
                }
            }
            
            // 處理調試登入
            handleDebugLogin() {
                // 確保父容器可見
                const universalContainer = document.getElementById('appUniversalContainer');
                if (!universalContainer.classList.contains('show')) {
                    universalContainer.classList.add('show');
                }
                
                // 直接設置默認用戶信息
                this.userInfo = {
                    nickname: '開發者',
                    grade: '調試模式',
                    loginTime: new Date()
                };
                
                const debugBtn = document.getElementById('debugBtn');
                const originalText = debugBtn.innerHTML;
                
                // 更新按鈕狀態
                debugBtn.innerHTML = '<span class="btn-icon">🚀</span>調試模式啟動中...';
                debugBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                debugBtn.disabled = true;
                
                // 快速進入主界面
                setTimeout(() => {
                    this.enterMainInterface();
                }, 800);
            }
            
            // 處理登入
            handleLogin() {
                const nickname = document.getElementById('nickname').value.trim();
                const grade = document.getElementById('grade').value;
                const password = document.getElementById('password').value;
                
                // 驗證表單
                if (!this.validateForm(nickname, grade, password)) {
                    return;
                }
                
                // 驗證密碼
                if (password !== this.correctPassword) {
                    this.showError('密碼錯誤，請檢查輸入');
                    return;
                }
                
                // 保存用戶信息
                this.userInfo = {
                    nickname: nickname,
                    grade: grade,
                    loginTime: new Date()
                };
                
                // 登入成功動畫
                this.showLoginSuccess();
            }
            
            // 驗證表單
            validateForm(nickname, grade, password) {
                if (!nickname) {
                    this.showError('請輸入你的昵稱');
                    return false;
                }
                
                if (nickname.length < 2) {
                    this.showError('昵稱至少需要2個字符');
                    return false;
                }
                
                if (!grade) {
                    this.showError('請選擇你的年級');
                    return false;
                }
                
                if (!password) {
                    this.showError('請輸入遊戲密碼');
                    return false;
                }
                
                return true;
            }
            
            // 顯示錯誤信息
            showError(message) {
                const errorDiv = document.getElementById('loginError');
                const errorText = errorDiv.querySelector('.error-text');
                errorText.textContent = message;
                errorDiv.style.display = 'flex';
                
                // 錯誤提示動畫
                errorDiv.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    errorDiv.style.animation = '';
                }, 500);
            }
            
            // 清除錯誤信息
            clearError() {
                document.getElementById('loginError').style.display = 'none';
            }
            
            // 顯示登入成功
            showLoginSuccess() {
                const loginBtn = document.getElementById('loginBtn');
                const originalText = loginBtn.innerHTML;
                
                // 更新按鈕狀態
                loginBtn.innerHTML = '<span class="btn-icon">✅</span>歡迎，' + this.userInfo.nickname + '！';
                loginBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                loginBtn.disabled = true;
                
                // 延遲進入主界面
                setTimeout(() => {
                    this.enterMainInterface();
                }, 1500);
            }
            
            // 進入主界面
            enterMainInterface() {
                // 隱藏登入頁面
                const loginContainer = document.getElementById('loginContainer');
                loginContainer.style.animation = 'fadeOut 0.5s ease-out forwards';
                
                setTimeout(() => {
                    loginContainer.style.display = 'none';
                    
                    // 顯示主界面
                    const mainContainer = document.getElementById('mainContainer');
                    mainContainer.style.display = 'flex';
                    mainContainer.style.animation = 'fadeIn 0.5s ease-out forwards';
                    
                    // 初始化主界面
                    mainInterface.init();
                    
                    // 初始化頁面歷史管理器
                    pageHistory.currentPage = 'mainContainer';
                    
                    // 更新用戶信息顯示
                    this.updateUserProfile();
                }, 500);
            }
            
            // 更新用戶資料顯示
            updateUserProfile() {
                // 更新個人資料頁面
                const profileName = document.querySelector('.profile-name');
                const profileId = document.querySelector('.profile-id');
                
                if (profileName) {
                    profileName.textContent = this.userInfo.nickname;
                }
                
                if (profileId) {
                    profileId.textContent = `太虛幻聊號: ${this.userInfo.grade} • txhl2024`;
                }
                
                // 添加歡迎消息到聊天記錄
                setTimeout(() => {
                    this.addWelcomeMessage();
                }, 1000);
            }
            
            // 添加歡迎消息
            addWelcomeMessage() {
                const welcomeMessage = {
                    type: 'system',
                    content: `歡迎 ${this.userInfo.nickname} 加入太虛幻聊！ 🎉`
                };
                
                // 如果在聊天界面，添加歡迎消息
                if (typeof addMessage === 'function') {
                    addMessage(welcomeMessage);
                }
            }
            
            // 獲取用戶信息
            getUserInfo() {
                return this.userInfo;
            }
        }
        
        // 添加搖晃動畫CSS
        const shakeCSS = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
        `;
        
        // 添加CSS到head
        const style = document.createElement('style');
        style.textContent = shakeCSS;
        document.head.appendChild(style);
        
        // 全局登入管理器實例
        const loginManager = new LoginManager();
        
        // 朋友圈管理器
        class MomentsManager {
            constructor() {
                this.currentPage = 0;
                this.pageSize = 20;
                this.currentCharacterId = null; // 記錄當前查看的角色ID（用於區分全局朋友圈和角色朋友圈）
            }
            
            // 初始化朋友圈
            init() {
                this.renderMoments();
                this.setupEvents();
            }
            
            // 獲取所有朋友圈數據
            getAllMomentsData() {
                const momentsDB = getMomentsDB();
                let allMoments = [];
                
                // 合併所有角色的朋友圈數據
                Object.keys(momentsDB).forEach(characterId => {
                    if (momentsDB[characterId] && momentsDB[characterId].length > 0) {
                        allMoments = allMoments.concat(momentsDB[characterId]);
                    }
                });
                
                // 按時間排序（這裡簡化處理，實際可以根據具體時間戳排序）
                return allMoments.slice(0, this.pageSize);
            }
            
            // 渲染朋友圈
            renderMoments() {
                const container = document.getElementById('momentsContent');
                container.innerHTML = '';
                
                const moments = this.getAllMomentsData();
                moments.forEach(moment => {
                    const momentElement = this.createMomentElement(moment);
                    container.appendChild(momentElement);
                });
            }
            
            // 渲染指定角色的朋友圈
            renderCharacterMoments(characterId) {
                const container = document.getElementById('momentsContent');
                container.innerHTML = '';
                
                const moments = getMomentsForCharacter(characterId);
                moments.forEach(moment => {
                    const momentElement = this.createMomentElement(moment);
                    container.appendChild(momentElement);
                });
            }
            
            // 創建朋友圈元素
            createMomentElement(moment) {
                const character = characters[moment.authorId];
                const element = document.createElement('div');
                element.className = 'moment-item';
                element.setAttribute('data-moment-id', moment.id);
                
                // 處理圖片：現有數據使用emoji作為圖片，統一使用四宮格布局
                let imagesHtml = '';
                if (moment.image) {
                    const emojiArray = [...moment.image];
                    const emojiCount = emojiArray.length;
                    
                    // 統一使用四宮格布局
                    let emojisToShow = [];
                    
                    if (emojiCount <= 4) {
                        // 1-4個emoji，正常顯示
                        emojisToShow = emojiArray.map(emoji => 
                            `<div class="moment-emoji-grid-item">${emoji}</div>`
                        );
                        
                        // 如果不足4個，用空白填充
                        while (emojisToShow.length < 4) {
                            emojisToShow.push(`<div class="moment-emoji-grid-item empty"></div>`);
                        }
                    } else {
                        // 超過4個emoji，顯示前3個，第4個位置顯示計數
                        emojisToShow = emojiArray.slice(0, 3).map(emoji => 
                            `<div class="moment-emoji-grid-item">${emoji}</div>`
                        );
                        emojisToShow.push(`
                            <div class="moment-emoji-grid-item more-indicator">
                                ${emojiArray[3]}
                                <div class="emoji-count-overlay">+${emojiCount - 4}</div>
                            </div>
                        `);
                    }
                    
                    imagesHtml = `
                        <div class="moment-images-grid">
                            ${emojisToShow.join('')}
                        </div>
                    `;
                }
                
                // 處理點讚列表
                let likesHtml = '';
                if (moment.likes && moment.likes.length > 0) {
                    const likeNamesHtml = moment.likes.map(userId => {
                        const userName = characters[userId]?.name || userId;
                        return `<span class="like-user-name" onclick="openProfilePage('${userId}')" style="cursor: pointer; color: #576b95;">${userName}</span>`;
                    }).join('、');
                    likesHtml = `
                        <div class="moment-likes">
                            <span class="moment-like-icon">👍</span>
                            <span class="moment-like-list">${likeNamesHtml}</span>
                        </div>
                    `;
                }
                
                // 處理評論列表
                let commentsHtml = '';
                if (moment.comments && moment.comments.length > 0) {
                    commentsHtml = `
                        <div class="moment-comments">
                            ${moment.comments.map(comment => {
                                const commentAuthor = characters[comment.authorId]?.name || comment.authorId;
                                return `
                                    <div class="moment-comment">
                                        <span class="comment-author" onclick="openProfilePage('${comment.authorId}')" style="cursor: pointer; color: #576b95;">${commentAuthor}</span>：
                                        <span class="comment-text">${comment.text}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                
                // 處理地點信息
                let locationHtml = '';
                if (moment.location) {
                    locationHtml = `<div class="moment-location">📍 ${moment.location}</div>`;
                }
                
                element.innerHTML = `
                    <div class="moment-header">
                        <div class="moment-avatar" onclick="openProfilePage('${moment.authorId}')" style="cursor: pointer;">${character.avatar}</div>
                        <div class="moment-info">
                            <div class="moment-name" onclick="openProfilePage('${moment.authorId}')" style="cursor: pointer; color: #576b95;">${character.name}</div>
                        </div>
                    </div>
                    <div class="moment-content-text">${moment.text}</div>
                    ${imagesHtml}
                    ${locationHtml}
                    <div class="moment-footer">
                        <div class="moment-time">${moment.time}</div>
                        <div class="moment-actions">
                            <span class="moment-action" data-action="like">讚</span>
                            <span class="moment-action" data-action="comment">評論</span>
                        </div>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                `;
                
                return element;
            }
            
            // 設置事件監聽
            setupEvents() {
                // 返回按鈕
                document.getElementById('momentsBackBtn').addEventListener('click', () => {
                    this.closeMoments();
                });
                
                // 朋友圈互動事件
                document.getElementById('momentsContent').addEventListener('click', (e) => {
                    if (e.target.classList.contains('moment-action')) {
                        const action = e.target.getAttribute('data-action');
                        const momentId = e.target.closest('.moment-item').getAttribute('data-moment-id');
                        this.handleMomentAction(action, momentId);
                    }
                });
            }
            
            // 處理朋友圈互動
            handleMomentAction(action, momentId) {
                const moments = this.getAllMomentsData();
                const moment = moments.find(m => m.id == momentId);
                if (!moment) return;
                
                if (action === 'like') {
                    // 切換點讚狀態
                    const userIndex = moment.likes.indexOf('user');
                    if (userIndex > -1) {
                        moment.likes.splice(userIndex, 1);
                    } else {
                        moment.likes.push('user');
                    }
                    this.renderMoments(); // 重新渲染
                } else if (action === 'comment') {
                    // 彈出評論輸入框（簡化處理）
                    const userInfo = loginManager.getUserInfo();
                    const nickname = userInfo.nickname || '學者';
                    const comment = prompt('輸入你的評論：');
                    if (comment && comment.trim()) {
                        moment.comments.push({
                            authorId: 'user',
                            text: `${nickname}: ${comment.trim()}`
                        });
                        this.renderMoments(); // 重新渲染
                    }
                }
            }
            
            // 打開朋友圈
            openMoments() {
                // 推入頁面歷史並顯示朋友圈
                pageHistory.pushPage('momentsContainer');
                pageHistory.showPage('momentsContainer');
                this.renderMoments();
            }
            
            // 打開指定角色的朋友圈
            openCharacterMoments(characterId) {
                console.log('openCharacterMoments被调用, 角色ID:', characterId);
                this.currentCharacterId = characterId;
                
                // 推入頁面歷史並顯示朋友圈
                pageHistory.pushPage('momentsContainer');
                pageHistory.showPage('momentsContainer');
                
                console.log('准备渲染角色朋友圈数据');
                this.renderCharacterMoments(characterId);
            }
            
            // 關閉朋友圈
            closeMoments() {
                console.log('closeMoments被调用');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
                
                // 清理状态
                this.currentCharacterId = null;
            }
        }
        
        // 全局朋友圈管理器實例
        const momentsManager = new MomentsManager();
        
        // 游戲數據 - 角色定義
        const characters = {
            system: { 
                name: "系統", 
                avatar: "ℹ️",
                dynasty: "現代"
            },
            user: {
                name: "我",
                nickname: "現代學者",
                avatar: "👤", 
                description: "現代的文學愛好者",
                inGroup: true,
                dynasty: "現代"
            },

            // 神話傳說
            yutu: { 
                name: "玉兔", 
                nickname: "搗藥翁", 
                avatar: "🐇", 
                description: "月宮中的玉兔，傳說搗藥不輟。",
                inGroup: true,
                dynasty: "神話傳說"
            },
            change: { 
                name: "嫦娥", 
                nickname: "月宮仙子", 
                avatar: "🙎‍♀️", 
                description: "月中仙子，居廣寒宮。",
                inGroup: true,
                dynasty: "神話傳說"
            },
            xiwangmu: {
                name: "西王母",
                nickname: "瑤池金母",
                avatar: "👑",
                description: "神話中掌管仙界的女神，擁有不死藥。",
                inGroup: true,
                dynasty: "神話傳說"
            },
            
            // 春秋戰國
            confucius: {
                name: "孔子", 
                nickname: "至聖先師",
                avatar: "👨‍🏫",
                description: "春秋時期思想家、教育家，儒家學派創始人。",
                inGroup: true,
                dynasty: "春秋戰國"
            },
            laozi: {
                name: "老子",
                nickname: "道德天尊", 
                avatar: "🧙‍♂️",
                description: "春秋時期哲學家，道家學派創始人，著《道德經》。",
                inGroup: true,
                dynasty: "春秋戰國"
            },
            zhuangzi: {
                name: "莊子",
                nickname: "南華真人",
                avatar: "🦋", 
                description: "戰國時期哲學家，道家學派代表人物，著《莊子》。",
                inGroup: true,
                dynasty: "春秋戰國"
            },
            mencius: {
                name: "孟子",
                nickname: "亞聖",
                avatar: "📖",
                description: "戰國時期思想家，儒家學派代表人物，被稱為「亞聖」。",
                inGroup: true,
                dynasty: "春秋戰國"
            },
            huizi: {
                name: "惠子",
                nickname: "名家宗師", 
                avatar: "🤔",
                description: "戰國時期哲學家，名家學派代表人物，莊子的好友。",
                inGroup: true,
                dynasty: "春秋戰國"
            },
            baiqi: {
                name: "白起",
                nickname: "戰神",
                avatar: "⚔️",
                description: "戰國時期秦國名將，被稱為「戰神」，軍事才能卓越。",
                inGroup: true,
                dynasty: "春秋戰國"
            },

            // 三國兩晉南北朝
            caozhi: {
                name: "曹植",
                nickname: "陳王",
                avatar: "🤴",
                description: "三國時期才子，李白在《將進酒》中提到的「陳王」。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            taoyuanming: { 
                name: "陶淵明", 
                nickname: "採菊東籬", 
                avatar: "🌾", 
                description: "東晉詩人，崇尚自然，歸隱田園。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            liuling: { 
                name: "劉伶", 
                nickname: "酒中仙", 
                avatar: "🍶", 
                description: "魏晉竹林七賢之一，嗜酒如命。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            ganbao: {
                name: "干寶",
                nickname: "搜神記主",
                avatar: "🔮", 
                description: "東晉史學家，著《搜神記》，記錄神仙鬼怪故事。",
                inGroup: true,
                dynasty: "三國兩晉南北朝"
            },
            
            // 漢代
            simaqian: {
                name: "司馬遷",
                nickname: "太史公",
                avatar: "📚",
                description: "西漢史學家，著《史記》，被譽為「史聖」。",
                inGroup: true,
                dynasty: "漢代"
            },
            hanxin: {
                name: "韓信",
                nickname: "兵仙",
                avatar: "🏹",
                description: "西漢初年軍事家，被劉邦稱為「兵仙」，助漢建國。",
                inGroup: true,
                dynasty: "漢代"
            },

            // 唐代
            libai: { 
                name: "李白", 
                nickname: "謫仙人", 
                avatar: "🥂", 
                description: "唐代詩人，字太白，號青蓮居士，被譽為「詩仙」。",
                inGroup: true,
                dynasty: "唐代"
            },
            dufu: { 
                name: "杜甫", 
                nickname: "少陵野老", 
                avatar: "📝", 
                description: "唐代詩人，被譽為「詩聖」。",
                inGroup: true,
                dynasty: "唐代"
            },
            wangwei: {
                name: "王維",
                nickname: "詩佛",
                avatar: "🧘",
                description: "唐代詩人，善山水詩，信佛，氣質與李白相異。",
                inGroup: true,
                dynasty: "唐代"
            },
            menghaoran: {
                name: "孟浩然",
                nickname: "孟襄陽",
                avatar: "🏞️",
                description: "唐代山水田園詩人，與王維齊名，李白好友。",
                inGroup: true,
                dynasty: "唐代"
            },
            ligui: { 
                name: "李龜年", 
                nickname: "宮廷樂師", 
                avatar: "🎵", 
                description: "唐代著名樂師，善歌舞。",
                inGroup: true,
                dynasty: "唐代"
            },
            yuzhen: {
                name: "玉真公主",
                nickname: "唐玄宗妹妹",
                avatar: "👸",
                description: "唐玄宗的妹妹，喜歡修道，喜歡結交推薦有才華的文人。",
                inGroup: true,
                dynasty: "唐代"
            },
            yangguifei: {
                name: "楊貴妃",
                nickname: "天生麗質",
                avatar: "💃",
                description: "唐玄宗寵妃，李白曾作《清平調》稱頌其美。",
                inGroup: true,
                dynasty: "唐代"
            },

            // 宋代
            liusi: {
                name: "劉恕",
                nickname: "史家能手",
                avatar: "📜",
                description: "北宋史學家，協助司馬光編寫《資治通鑑》。",
                inGroup: true,
                dynasty: "宋代"
            },
            liuyong: {
                name: "柳永",
                nickname: "三變",
                avatar: "🎵",
                description: "北宋詞人，原名三變，字耆卿，擅寫慢詞長調，開拓詞的表現力。",
                inGroup: true,
                dynasty: "宋代"
            },

            // 清代
            pushengling: {
                name: "蒲松齡",
                nickname: "聊齋先生",
                avatar: "👻",
                description: "清代小說家，著《聊齋志異》，擅寫神怪故事。",
                inGroup: true,
                dynasty: "清代"
            },
            liqingzhao: {
                name: "李清照",
                nickname: "易安居士",
                avatar: "🌸",
                description: "宋代女詞人，號易安居士，婉約詞派代表，被譽為「千古第一才女」。",
                inGroup: true,
                dynasty: "宋代"
            },
            sushi: {
                name: "蘇軾",
                nickname: "東坡居士",
                avatar: "🏔️",
                description: "北宋文學家，字子瞻，號東坡居士，豪放詞派創始人，詩詞書畫皆精。",
                inGroup: true,
                dynasty: "宋代"
            },
            xinqiji: {
                name: "辛棄疾",
                nickname: "稼軒",
                avatar: "⚔️",
                description: "南宋詞人，字幼安，號稼軒，豪放詞派代表，文武雙全。",
                inGroup: true,
                dynasty: "宋代"
            },
            jiangkui: {
                name: "姜夔",
                nickname: "白石道人",
                avatar: "🎶",
                description: "南宋詞人，號白石道人，格律派詞人，音律精妙。",
                inGroup: true,
                dynasty: "宋代"
            },
            liyu: {
                name: "李煜",
                nickname: "李後主",
                avatar: "👑",
                description: "南唐末代君主，詞人，被稱為「千古詞帝」，詞風悲愴動人。",
                inGroup: true,
                dynasty: "五代十國"
            },
            zhoubanyan: {
                name: "周邦彥",
                nickname: "美成",
                avatar: "🎼",
                description: "北宋詞人，字美成，格律嚴謹，被稱為「詞家之冠」。",
                inGroup: true,
                dynasty: "宋代"
            },
            yanjidao: {
                name: "晏幾道",
                nickname: "小山",
                avatar: "🍃",
                description: "北宋詞人，字叔原，號小山，婉約詞派代表，晏殊之子。",
                inGroup: true,
                dynasty: "宋代"
            },
            wuwenying: {
                name: "吳文英",
                nickname: "夢窗",
                avatar: "🌙",
                description: "南宋詞人，字君特，號夢窗，詞風綿密，意象豐富。",
                inGroup: true,
                dynasty: "宋代"
            },
            chenweisong: {
                name: "陳維崧",
                nickname: "其年",
                avatar: "📚",
                description: "清代詞人，字其年，號迦陵，陽羨詞派領袖，風格豪放。",
                inGroup: true,
                dynasty: "清代"
            },
            zhuyizun: {
                name: "朱彜尊",
                nickname: "竹垞",
                avatar: "🎋",
                description: "清代詞人，字錫鬯，號竹垞，浙西詞派創始人，詞學理論家。",
                inGroup: true,
                dynasty: "清代"
            },
            nalanxingde: {
                name: "納蘭性德",
                nickname: "容若",
                avatar: "🏹",
                description: "清代詞人，字容若，滿洲正黃旗人，詞風清麗，情真意切。",
                inGroup: true,
                dynasty: "清代"
            }
        };

        // 消息歷史
        let messageHistory = [];

        // 音效
        // 音效系統已移除






        

        

        



        
        // 添加消息到聊天容器
        function addMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            
            // 保存消息到歷史記錄
            const currentChatId = groupManager ? groupManager.currentGroup : null;
            if (currentChatId && !message.skipSave) {
                chatHistoryManager.saveMessage(currentChatId, message);
            }
            
            // 如果是其他角色（非李白和系統）的消息，先顯示"正在輸入"狀態
            if (message.type === 'message' && message.character !== 'libai' && message.character !== 'system') {
                const character = characters[message.character];
                const typingElement = document.createElement('div');
                typingElement.className = `wx-msg wx-msg-others wx-fade-in typing-message-${message.character}`;
                
                typingElement.innerHTML = `
                    <div class="wx-avatar">
                        ${character.avatar}
                    </div>
                    <div class="wx-content-wrapper">
                        <div class="wx-name">
                            ${character.name}
                        </div>
                        <div class="wx-typing">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span style="font-size: 12px; color: #999; margin-left: 8px;">正在回复...</span>
                        </div>
                    </div>
                `;
                
                chatContainer.appendChild(typingElement);
                
                // 滾動到底部以顯示"正在輸入"
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // 缩短打字动画时间，快速响应用户
                const typingDuration = 800 + Math.random() * 400; // 0.8-1.2秒随机延时
                setTimeout(() => {
                    // 移除"正在輸入"元素（使用統一的函數）
                    removeTypingAnimation(message.character);
                    
                    // 添加實際消息
                    addRealMessage(message);
                }, typingDuration);
            } else {
                // 直接添加李白和系統的消息
                addRealMessage(message);
            }
        }

        // 實際添加消息的函數
        function addRealMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            
            // 根據消息類型創建不同的元素
            if (message.type === 'system') {
                messageElement.className = 'wx-system-msg wx-fade-in';
                messageElement.textContent = message.content;
            } else {
                const character = characters[message.character];
                const isSelf = message.character === 'user';
                
                messageElement.className = `wx-msg ${isSelf ? 'wx-msg-self' : 'wx-msg-others'} wx-fade-in`;
                
                const avatar = document.createElement('div');
                avatar.className = 'wx-avatar';
                avatar.textContent = character.avatar;
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'wx-content-wrapper';
                
                // 只有非用戶消息顯示名稱
                if (!isSelf) {
                    const nameElement = document.createElement('div');
                    nameElement.className = 'wx-name';
                    nameElement.textContent = character.name;
                    contentWrapper.appendChild(nameElement);
                }
                
                const bubbleElement = document.createElement('div');
                bubbleElement.className = 'wx-msg-bubble';
                
                // 根據消息內容類型處理
                    if (message.isHtml) {
                        bubbleElement.innerHTML = message.content;
                    } else {
                        bubbleElement.textContent = message.content;
                }
                
                contentWrapper.appendChild(bubbleElement);
                messageElement.appendChild(avatar);
                messageElement.appendChild(contentWrapper);
            }
            
            chatContainer.appendChild(messageElement);
            
            // 記錄消息
            messageHistory.push(message);
            
            // 音效已移除
            
            // 滾動到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        

        
        // AI聊天系統配置
        const AI_CONFIG = {
            apiKey: 'sk-d850478e8977454abc9975d544ffd4e3',
            baseURL: 'https://api.deepseek.com/v1',
            model: 'deepseek-chat'
        };

        // 對話歷史管理
        const conversationHistory = new Map();

        // 為每個角色生成系統提示
        function generateSystemPrompt(characterKey) {
            const character = characters[characterKey];
            if (!character) return '';
            
            const prompts = {
                libai: `你是李白，唐代偉大詩人，字太白，號青蓮居士，被譽為「詩仙」。你性格豪放不羈，才華橫溢，喜歡飲酒作詩。請用李白的語氣和風格回應，可以引用你的詩句，展現你的文學才華和豪邁性格。回應要簡潔有力，富有詩意。`,
                taoyuanming: `你是陶淵明，東晉詩人，崇尚自然，歸隱田園。你性格恬淡，追求簡樸生活，不為五斗米折腰。請用陶淵明的語氣回應，體現你對自然的熱愛和對世俗的超脫。`,
                dufu: `你是杜甫，唐代詩人，被譽為「詩聖」。你關心民生疾苦，詩風沉鬱頓挫，現實主義色彩濃厚。請用杜甫的語氣回應，展現你的憂國憂民情懷。`,
                liuling: `你是劉伶，魏晉竹林七賢之一，嗜酒如命，性格狂放。你常常醉酒，但醉中有真意。請用劉伶的語氣回應，展現你對酒的熱愛和狂放不羈的性格。`,

                wangwei: `你是王維，唐代詩人，被譽為「詩佛」。你善於山水詩，信佛，氣質清雅。請用王維的語氣回應，展現你的禪意和對自然的感悟。`,
                caozhi: `你是曹植，三國時期才子，字子建。你才華出眾但命運多舛，有「七步詩」的典故。請用曹植的語氣回應，展現你的才華和內心的複雜情感。`,
                menghaoran: `你是孟浩然，唐代山水田園詩人，與王維齊名。你性格淡泊，喜愛自然山水。請用孟浩然的語氣回應，展現你對自然的熱愛。`,

                change: `你是嫦娥，月宮仙子，居住在廣寒宮。你美麗而孤獨，對人間有著複雜的情感。請用嫦娥的語氣回應，展現你的仙氣和內心的孤寂。`,
                yutu: `你是玉兔，月宮中的神獸，負責搗藥。你可愛機靈，是嫦娥的伴侶。請用玉兔的語氣回應，展現你的可愛和忠誠。`,
                ligui: `你是李龜年，唐代著名樂師，善於歌舞。你藝術造詣很高，經常在宮廷演出。請用李龜年的語氣回應，展現你的藝術才華。`,
                yuzhen: `你是玉真公主，唐玄宗的妹妹，喜歡修道和結交文人。你身份高貴但平易近人。請用玉真公主的語氣回應，展現你的高雅和對文學的喜愛。`,
                yangguifei: `你是楊貴妃，唐玄宗的寵妃，天生麗質。你美麗聰慧，李白曾為你作《清平調》。請用楊貴妃的語氣回應，展現你的美麗和聰慧。`,

                xiwangmu: `你是西王母，神話中的瑤池金母，掌管仙界。你威嚴而慈祥，擁有不死藥。請用西王母的語氣回應，展現你的神威和仙家風範。`
            };
            
            return prompts[characterKey] || `你是${character.name}，${character.description}請用符合你身份的語氣回應。`;
        }

        // 調用AI API生成回應
        async function generateAIResponse(characterKey, userMessage, customPrompt = null) {
            try {
                const character = characters[characterKey];
                if (!character) {
                    console.error('角色不存在:', characterKey);
                    return null;
                }
                
                console.log('=== AI回應生成開始 ===');
                console.log('角色:', characterKey, character.name);
                console.log('用戶消息:', userMessage);
                console.log('自定義提示:', customPrompt);

                // 獲取對話歷史
                const history = conversationHistory.get(characterKey) || [];
                
                // 構建消息數組
                const systemPrompt = customPrompt || generateSystemPrompt(characterKey);
                console.log('系統提示:', systemPrompt);
                
                const messages = [
                    {
                        role: 'system',
                        content: systemPrompt
                    },
                    ...history,
                    {
                        role: 'user',
                        content: userMessage
                    }
                ];

                console.log('準備發送API請求...');
                console.log('請求數據:', {
                    model: AI_CONFIG.model,
                    messages: messages,
                    max_tokens: 200,
                    temperature: 0.8
                });

                const response = await fetch(`${AI_CONFIG.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        messages: messages,
                        max_tokens: 400, // 从200增加到400，允许更长的回应
                        temperature: 0.8
                    })
                });

                console.log('API響應狀態:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API請求失敗詳情:', errorText);
                    throw new Error(`API請求失敗: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('API響應數據:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    console.error('API響應格式錯誤:', data);
                    throw new Error('API響應格式錯誤');
                }
                
                const aiResponse = data.choices[0].message.content;
                console.log('提取的AI回應:', aiResponse);

                // 更新對話歷史
                const newHistory = [
                    ...history,
                    { role: 'user', content: userMessage },
                    { role: 'assistant', content: aiResponse }
                ];
                
                // 限制歷史長度，保留最近6次對話
                if (newHistory.length > 12) {
                    newHistory.splice(0, newHistory.length - 12);
                }
                
                conversationHistory.set(characterKey, newHistory);

                return aiResponse;
            } catch (error) {
                console.error('AI回應生成失敗:', error);
                return getBackupResponse(characterKey);
            }
        }

        // 将长消息分段发送
        function splitMessageIntoSegments(text, maxLength = 100) {
            if (text.length <= maxLength) {
                return [text];
            }
            
            const segments = [];
            let currentSegment = '';
            
            // 按句子分割（中文句号、感叹号、问号等）
            const sentences = text.split(/([。！？；\.\!\?;])/);
            
            for (let i = 0; i < sentences.length; i += 2) {
                const sentence = sentences[i] + (sentences[i + 1] || '');
                
                // 如果当前段落加上新句子超过限制
                if (currentSegment.length + sentence.length > maxLength && currentSegment.length > 0) {
                    segments.push(currentSegment.trim());
                    currentSegment = sentence;
                } else {
                    currentSegment += sentence;
                }
            }
            
            // 添加最后一段
            if (currentSegment.trim()) {
                segments.push(currentSegment.trim());
            }
            
            // 如果没有找到合适的分割点，按字符强制分割
            if (segments.length === 0 || segments.some(seg => seg.length > maxLength * 1.5)) {
                segments.length = 0;
                for (let i = 0; i < text.length; i += maxLength) {
                    segments.push(text.slice(i, i + maxLength));
                }
            }
            
            return segments.filter(seg => seg.trim());
        }

        // 分段发送消息
        function sendMessageSegments(characterKey, segments) {
            segments.forEach((segment, index) => {
                setTimeout(() => {
                    // 如果不是第一段，先移除该角色的打字动画（第一段已在主函数中移除）
                    if (index > 0) {
                        removeTypingAnimation(characterKey);
                    }
                    
                    // 直接添加消息段（绕过addMessage的打字动画逻辑）
                    addRealMessage({
                        type: 'message',
                        character: characterKey,
                        content: segment,
                        contentType: 'text'
                    });
                    
                    // 如果不是最后一段，显示继续输入的动画
                    if (index < segments.length - 1) {
                        setTimeout(() => {
                            showTypingAnimation(characterKey);
                        }, 300);
                    }
                }, index * 1500); // 每段间隔1.5秒
            });
        }

        // 获取角色的性格化延迟倍数
        function getCharacterDelayMultiplier(characterKey) {
            const delayMultipliers = {
                libai: 0.8,        // 李白性格豪爽，回复较快
                dufu: 1.2,         // 杜甫深思熟虑，回复较慢
                taoyuanming: 1.4,  // 陶渊明悠然自得，不急不躁
                wangwei: 1.1,      // 王维禅意深远，略慢
                caozhi: 0.9,       // 曹植才思敏捷
                menghaoran: 1.3,   // 孟浩然田园闲适
                liuling: 0.7,      // 刘伶醉酒豪爽，最快
                change: 1.0,       // 嫦娥标准速度
                yutu: 0.6,         // 玉兔活泼，最快
                ligui: 0.9,        // 李龟年艺术家敏感
                yuzhen: 1.1,       // 玉真公主贵族风范
                yangguifei: 1.0,   // 杨贵妃标准
                xiwangmu: 1.5      // 西王母神仙威严，最慢
            };
            return delayMultipliers[characterKey] || 1.0;
        }

        // 计算自然的分段间隔时间
        function getNaturalSegmentInterval(characterKey, segmentIndex, totalSegments) {
            const baseInterval = 1200; // 基础1.2秒
            const characterMultiplier = getCharacterDelayMultiplier(characterKey);
            const randomFactor = 0.7 + Math.random() * 0.6; // 0.7-1.3倍随机
            
            // 第一段稍快，中间段正常，最后一段略慢（思考下句话）
            let positionMultiplier = 1.0;
            if (segmentIndex === 0) {
                positionMultiplier = 0.8;
            } else if (segmentIndex === totalSegments - 1) {
                positionMultiplier = 1.2;
            }
            
            return Math.floor(baseInterval * characterMultiplier * randomFactor * positionMultiplier);
        }

        // 串行分段发送消息（等待完成）- 自然化版本
        function sendMessageSegmentsSequentially(characterKey, segments) {
            return new Promise((resolve) => {
                let totalDelay = 0;
                
                segments.forEach((segment, index) => {
                    const segmentDelay = getNaturalSegmentInterval(characterKey, index, segments.length);
                    totalDelay += segmentDelay;
                    
                    setTimeout(() => {
                        // 如果不是第一段，先移除该角色的打字动画
                        if (index > 0) {
                            removeTypingAnimation(characterKey);
                        }
                        
                        // 直接添加消息段
                        addRealMessage({
                            type: 'message',
                            character: characterKey,
                            content: segment,
                            contentType: 'text'
                        });
                        
                        // 如果不是最后一段，显示继续输入的动画
                        if (index < segments.length - 1) {
                            // 随机延迟显示打字动画，模拟思考下一句
                            const thinkingDelay = 200 + Math.random() * 300;
                            setTimeout(() => {
                                showTypingAnimation(characterKey);
                            }, thinkingDelay);
                        } else {
                            // 最后一段发送完成
                            resolve();
                        }
                    }, totalDelay);
                });
            });
        }

        // 備用回應（當AI調用失敗時使用）
        function getBackupResponse(characterKey) {
            const backupResponses = {
                libai: ['哈哈，有趣！', '此言甚妙！', '好一個妙語！', '吾深以為然！'],
                dufu: ['言之有理。', '確實如此。', '深有同感。', '此話不假。'],
                taoyuanming: ['悠然見南山。', '此中有真意。', '心遠地自偏。', '採菊東籬下。'],
                liuling: ['來，乾杯！', '酒逢知己千杯少！', '醉裡乾坤大！', '何以解憂，唯有杜康！'],

                wangwei: ['阿彌陀佛。', '禪意深遠。', '心如止水。', '空山新雨後。'],
                caozhi: ['才思敏捷！', '文采飛揚！', '七步之才！', '煮豆燃豆萁。'],
                menghaoran: ['山水之樂。', '自然之美。', '田園之趣。', '歸隱之樂。'],

                change: ['廣寒宮中甚寂寞。', '月圓月缺總相思。', '仙凡有別。', '嫦娥應悔偷靈藥。'],
                yutu: ['搗藥不輟！', '月宮生活！', '主人說得對！', '兔兔很忙！'],
                ligui: ['音律之美！', '歌舞昇平！', '藝術無價！', '宮廷雅樂！'],
                yuzhen: ['道法自然。', '修身養性。', '文人雅士。', '皇室風範。'],
                yangguifei: ['傾國傾城。', '美人如花。', '宮廷生活。', '歌舞昇平。'],

                xiwangmu: ['瑤池盛宴。', '仙界威嚴。', '不死之藥。', '神仙境界。']
            };
            
            const responses = backupResponses[characterKey] || ['嗯，有道理。', '確實如此。', '言之有理。'];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // 智能選擇回應角色
        function selectRespondingCharacters() {
            const inGroupCharacters = Object.keys(characters).filter(key => 
                characters[key].inGroup && key !== 'user'
            );
            
            // 70%概率1個回應，30%概率2個回應
            const responseCount = Math.random() < 0.7 ? 1 : 2;
            
            // 隨機選擇角色
            const shuffled = inGroupCharacters.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, responseCount);
        }

        // 生成AI角色间的互动回应
        function generateCharacterInteraction(characterKey, previousResponses, userMessage) {
            const character = characters[characterKey];
            if (!character) return '';
            
            // 基于前面角色的回应生成互动内容
            const lastResponse = previousResponses[previousResponses.length - 1];
            if (!lastResponse) return '';
            
            const interactionPrompts = {
                libai: [
                    `听了${lastResponse.characterName}的话，哈哈！`,
                    `${lastResponse.characterName}说得好！李某深以为然。`,
                    `妙哉！${lastResponse.characterName}此言甚有见地。`
                ],
                dufu: [
                    `${lastResponse.characterName}所言极是，深有同感。`,
                    `听君一席话，胜读十年书。`,
                    `${lastResponse.characterName}这话让我想起了往昔。`
                ],
                taoyuanming: [
                    `${lastResponse.characterName}说得是，心远地自偏。`,
                    `同感，此中有真意，欲辨已忘言。`,
                    `${lastResponse.characterName}的话让我想起田园之乐。`
                ],
                wangwei: [
                    `阿弥陀佛，${lastResponse.characterName}此言颇有禅意。`,
                    `${lastResponse.characterName}说得对，山水有情，诗画同源。`,
                    `善哉，${lastResponse.characterName}所言令人深思。`
                ],
                change: [
                    `在月宫听到${lastResponse.characterName}这话，甚有感触。`,
                    `${lastResponse.characterName}的话让我想起人间往事。`,
                    `广寒宫中，难得听到如此佳言。`
                ]
            };
            
            const interactions = interactionPrompts[characterKey] || [
                `${lastResponse.characterName}说得有道理。`,
                `听了${lastResponse.characterName}的话，深有感触。`
            ];
            
            return interactions[Math.floor(Math.random() * interactions.length)];
        }

        // 生成安全的AI回應（新版本）
        async function generateSafeAIResponses(userMessage, mentions = []) {
            // 獲取當前群組配置
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            console.log(`當前群組: ${groupManager.currentGroup}`, currentGroup);
            
            if (!currentGroup) {
                console.error(`群組 ${groupManager.currentGroup} 不存在`);
                return;
            }
            
            // 從當前群組成員中選擇，排除用戶自己
            const activeCharacters = currentGroup.members.filter(id => {
                const hasCharacter = characters[id];
                const notUser = id !== 'user';
                
                if (!hasCharacter) {
                    console.warn(`成員 ${id} 沒有在 characters 中定義，跳過`);
                }
                
                return hasCharacter && notUser;
            });
            
            console.log(`群組 ${currentGroup.name} 可回應的角色:`, activeCharacters.map(id => `${characters[id].name}(${id})`));
            
            if (activeCharacters.length === 0) {
                console.warn('沒有可回應的角色');
                return;
            }
            
            let respondingCharacters = [];
            
            // 如果有@提及，被@的角色優先回應
            if (mentions.length > 0) {
                const mentionedCharacters = mentions
                    .map(mention => mention.id)
                    .filter(id => activeCharacters.includes(id));
                
                console.log('被@的角色:', mentionedCharacters);
                
                // 被@的角色必定回應
                respondingCharacters = mentionedCharacters;
                
                // 可能添加其他角色回應（30%概率）
                if (Math.random() < 0.3 && respondingCharacters.length < 2) {
                    const otherCharacters = activeCharacters.filter(id => 
                        !mentionedCharacters.includes(id)
                    );
                    if (otherCharacters.length > 0) {
                        const randomOther = otherCharacters[Math.floor(Math.random() * otherCharacters.length)];
                        respondingCharacters.push(randomOther);
                    }
                }
            } else {
                // 沒有@提及，隨機選擇1-2個角色回應
                const responseCount = Math.min(activeCharacters.length, Math.floor(Math.random() * 2) + 1);
                respondingCharacters = activeCharacters
                .sort(() => Math.random() - 0.5)
                    .slice(0, responseCount);
            }
            
            console.log('最終選中的回應角色:', respondingCharacters);
            
            // 记录回应历史，用于角色间互动
            let responseHistory = [];
            
            // 串行处理角色回应，确保一个完成后再处理下一个
            async function processCharacterResponsesSequentially(characterList, index = 0) {
                console.log(`=== 串行处理调用，index=${index}，总长度=${characterList.length} ===`);
                
                if (index >= characterList.length) {
                    console.log('=== 所有角色处理完成 ===');
                    return;
                }
                
                const characterKey = characterList[index];
                const isFirstCharacter = index === 0;
                
                console.log(`准备处理第${index + 1}个角色: ${characterKey}`);
                
                // 检查角色是否存在
                if (!characters[characterKey]) {
                    console.error(`角色 ${characterKey} 不存在，跳过`);
                    setTimeout(() => {
                        processCharacterResponsesSequentially(characterList, index + 1);
                    }, 100);
                    return;
                }
                
                // 计算自然的开始延迟
                function getStartDelay(characterKey, isFirst, userMessageLength) {
                    const characterMultiplier = getCharacterDelayMultiplier(characterKey);
                    const messageComplexity = Math.min(userMessageLength / 50, 2); // 消息复杂度影响
                    const baseDelay = isFirst ? 800 : 1500; // 基础延迟
                    const randomFactor = 0.7 + Math.random() * 0.8; // 随机因子
                    
                    return Math.floor(baseDelay * characterMultiplier * (1 + messageComplexity * 0.3) * randomFactor);
                }
                
                const startDelay = getStartDelay(characterKey, isFirstCharacter, userMessage.length);
                
                setTimeout(async () => {
                    console.log(`=== 开始处理角色 ${characterKey} (${characters[characterKey]?.name}) ===`);
                    
                    // 显示该角色正在思考
                    showTypingAnimation(characterKey);
                    
                    // 5%概率模拟"重新思考"（先移除再显示思考动画）
                    if (Math.random() < 0.05) {
                        const rethinkDelay = 1000 + Math.random() * 1500; // 1-2.5秒后重新思考
                        setTimeout(() => {
                            removeTypingAnimation(characterKey);
                            setTimeout(() => {
                                showTypingAnimation(characterKey);
                            }, 200 + Math.random() * 300);
                        }, rethinkDelay);
                    }
                    
                    let response;
                    let characterResponse;
                    
                    try {
                        if (isFirstCharacter || Math.random() < 0.7) {
                            // 第一个角色或70%概率回应用户消息
                            console.log(`${characterKey} 将回应用户消息`);
                            const isMentioned = mentions.some(mention => mention.id === characterKey);
                            let aiPrompt = groupManager.getAIPrompt(characterKey, userMessage);
                            
                            if (isMentioned) {
                                aiPrompt += `\n注意：用戶在消息中@了你，請直接回應用戶的問題或評論。`;
                            }
                            
                            response = await generateAIResponse(characterKey, userMessage, aiPrompt);
                            characterResponse = response;
                            console.log(`${characterKey} AI回应:`, characterResponse);
                            
                            // 如果AI回应失败，使用备用回应
                            if (!characterResponse || !characterResponse.trim()) {
                                console.log(`${characterKey} AI回应为空，使用备用回应`);
                                characterResponse = getBackupResponse(characterKey);
                            }
                        } else {
                            // 30%概率与其他角色互动
                            console.log(`${characterKey} 尝试与其他角色互动`);
                            const interactionText = generateCharacterInteraction(characterKey, responseHistory, userMessage);
                            if (interactionText) {
                                characterResponse = interactionText;
                                console.log(`${characterKey} 互动回应:`, characterResponse);
                            } else {
                                // 如果没有互动内容，还是回应用户
                                console.log(`${characterKey} 没有互动内容，回应用户`);
                                response = await generateAIResponse(characterKey, userMessage);
                                characterResponse = response;
                                console.log(`${characterKey} AI回应:`, characterResponse);
                                
                                // 如果AI回应失败，使用备用回应
                                if (!characterResponse || !characterResponse.trim()) {
                                    console.log(`${characterKey} AI回应为空，使用备用回应`);
                                    characterResponse = getBackupResponse(characterKey);
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`${characterKey} 生成回应时出错:`, error);
                        characterResponse = null;
                    }
                    
                    if (characterResponse && characterResponse.trim()) {
                        console.log(`${characterKey} 准备发送回应:`, characterResponse);
                        
                        // 移除打字动画
                        removeTypingAnimation(characterKey);
                        
                        // 安全性过滤
                        const safeResponse = safetyFilter.filterAIResponse(characterResponse);
                        console.log(`${characterKey} 过滤后的回应:`, safeResponse);
                        
                        if (safeResponse && safeResponse.trim()) {
                            // 记录回应历史
                            responseHistory.push({
                                characterKey: characterKey,
                                characterName: characters[characterKey]?.name || characterKey,
                                content: safeResponse
                            });
                            
                            // 分段发送长消息
                            const segments = splitMessageIntoSegments(safeResponse, 80);
                            console.log(`${characterKey} 消息分段:`, segments);
                            
                            if (segments.length > 1) {
                                // 等待分段消息完成发送
                                await sendMessageSegmentsSequentially(characterKey, segments);
                                console.log(`${characterKey} 分段消息发送完成`);
                                
                                setTimeout(() => {
                                    const chatContainer = document.getElementById('chatMessages');
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }, 100);
                                
                                // 分段消息完成后，动态延迟处理下一个角色
                                const nextDelay = 800 + Math.random() * 400; // 0.8-1.2秒随机
                                setTimeout(() => {
                                    console.log(`${characterKey} 分段完成，延迟${nextDelay}ms处理下一个角色 (index=${index + 1})`);
                                    processCharacterResponsesSequentially(characterList, index + 1);
                                }, nextDelay);
                            } else {
                                addMessage({
                                    type: 'message',
                                    character: characterKey,
                                    content: safeResponse,
                                    contentType: 'text'
                                });
                                
                                setTimeout(() => {
                                    const chatContainer = document.getElementById('chatMessages');
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }, 100);
                                
                                // 单条消息发送后，短暂随机延迟处理下一个角色
                                const shortDelay = 300 + Math.random() * 400; // 0.3-0.7秒随机
                                setTimeout(() => {
                                    console.log(`${characterKey} 单条完成，延迟${shortDelay}ms处理下一个角色 (index=${index + 1})`);
                                    processCharacterResponsesSequentially(characterList, index + 1);
                                }, shortDelay);
                            }
                        } else {
                            console.warn(`${characterKey} 过滤后的回应为空`);
                            removeTypingAnimation(characterKey);
                            
                            // 如果过滤后回应为空，立即处理下一个角色
                            setTimeout(() => {
                                console.log(`${characterKey} 过滤后回应为空，处理下一个角色 (index=${index + 1})`);
                                processCharacterResponsesSequentially(characterList, index + 1);
                            }, 500);
                        }
                    } else {
                        // 如果没有回应，移除动画并处理下一个角色
                        console.warn(`${characterKey} 没有生成有效回应`);
                        removeTypingAnimation(characterKey);
                        setTimeout(() => {
                            console.log(`${characterKey} 没有有效回应，处理下一个角色 (index=${index + 1})`);
                            processCharacterResponsesSequentially(characterList, index + 1);
                        }, 500);
                    }
                }, startDelay);
            }
            
            // 开始串行处理
            processCharacterResponsesSequentially(respondingCharacters);
        }
        
        // 生成AI回應（原版本，向後兼容）
        async function generateAIResponses(userMessage) {
            const respondingCharacters = selectRespondingCharacters();
            
            // 串行处理角色回应
            async function processResponsesSequentially(characterList, index = 0) {
                if (index >= characterList.length) return;
                
                const characterKey = characterList[index];
                const isFirstCharacter = index === 0;
                const startDelay = isFirstCharacter ? 1000 : 2000;
                
                // 检查角色是否存在
                if (!characters[characterKey]) {
                    console.error(`角色 ${characterKey} 不存在，跳过`);
                    setTimeout(() => {
                        processResponsesSequentially(characterList, index + 1);
                    }, 100);
                    return;
                }
                
                setTimeout(async () => {
                    console.log(`=== 开始处理角色 ${characterKey} (旧版本) ===`);
                    
                    // 显示该角色正在思考
                    showTypingAnimation(characterKey);
                    
                    let response = await generateAIResponse(characterKey, userMessage);
                    
                    // 如果AI回应失败，使用备用回应
                    if (!response || !response.trim()) {
                        console.log(`${characterKey} AI回应为空，使用备用回应`);
                        response = getBackupResponse(characterKey);
                    }
                    
                    if (response && response.trim()) {
                        console.log(`${characterKey} 准备发送回应:`, response);
                        
                        // 移除打字动画
                        removeTypingAnimation(characterKey);
                        
                        // 分段发送长消息
                        const segments = splitMessageIntoSegments(response, 80);
                        if (segments.length > 1) {
                            await sendMessageSegmentsSequentially(characterKey, segments);
                            console.log(`${characterKey} 分段消息发送完成 (旧版本)`);
                            
                            setTimeout(() => {
                                const chatContainer = document.getElementById('chatMessages');
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, 100);
                            
                            // 分段消息完成后，延迟处理下一个角色
                            setTimeout(() => {
                                console.log(`${characterKey} 完成，开始处理下一个角色`);
                                processResponsesSequentially(characterList, index + 1);
                            }, 1000);
                        } else {
                            addMessage({
                                type: 'message',
                                character: characterKey,
                                content: response,
                                contentType: 'text'
                            });
                            
                            setTimeout(() => {
                                const chatContainer = document.getElementById('chatMessages');
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }, 100);
                            
                            // 单条消息发送后，短暂延迟处理下一个角色
                            setTimeout(() => {
                                console.log(`${characterKey} 完成，开始处理下一个角色`);
                                processResponsesSequentially(characterList, index + 1);
                            }, 500);
                        }
                    } else {
                        // 如果仍然没有回应，移除动画并处理下一个角色
                        console.warn(`${characterKey} 没有生成有效回应`);
                        removeTypingAnimation(characterKey);
                        setTimeout(() => {
                            processResponsesSequentially(characterList, index + 1);
                        }, 500);
                    }
                }, startDelay);
            }
            
            // 开始串行处理
            processResponsesSequentially(respondingCharacters);
        }



        // 聊天輸入功能
        function setupChatInput() {
            const inputBox = document.getElementById('messageInput');
            
            if (inputBox) {
                // 確保輸入框可以交互
                inputBox.style.pointerEvents = 'auto';
                inputBox.disabled = false;
                
                // 回車發送
                inputBox.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendUserMessage();
                    }
                });
                
                // 輸入框焦點處理
                inputBox.addEventListener('focus', function() {
                    // 關閉emoji和功能面板，但不關閉@面板（輸入框獲得焦點時可能正在@某人）
                    document.getElementById('emojiPanel').style.display = 'none';
                    document.getElementById('functionPanel').style.display = 'none';
                });
                
                // 添加點擊事件確保輸入框可以被點擊
                inputBox.addEventListener('click', function(e) {
                    console.log('輸入框被點擊');
                    this.focus();
                });
                
                // 添加input事件監聽，支持@功能（只在群聊模式下）
                inputBox.addEventListener('input', function(e) {
                    console.log('輸入框內容變化:', this.value);
                    // 只在群聊模式下處理@功能
                    if (!isPrivateChatMode()) {
                        handleMentionInput(this);
                    }
                });
                
                // 處理鍵盤事件
                inputBox.addEventListener('keydown', function(e) {
                    // ESC鍵隱藏@面板
                    if (e.key === 'Escape' && mentionState.isActive) {
                        e.preventDefault();
                        hideMentionPopup();
                    }
                    // 上下箭頭選擇@列表項（可以後續添加）
                });
                
                // 測試輸入框是否可見和可交互
                const rect = inputBox.getBoundingClientRect();
                console.log('輸入框位置和尺寸:', rect);
                console.log('輸入框樣式:', {
                    pointerEvents: window.getComputedStyle(inputBox).pointerEvents,
                    display: window.getComputedStyle(inputBox).display,
                    visibility: window.getComputedStyle(inputBox).visibility,
                    zIndex: window.getComputedStyle(inputBox).zIndex
                });
                
                console.log('輸入框事件監聽器已設置');
            } else {
                console.error('找不到messageInput元素');
            }
        }

        // 發送用戶消息（增強安全性）
        function sendUserMessage() {
            const inputBox = document.getElementById('messageInput');
            if (!inputBox) return;
            
            const message = inputBox.value.trim();
            if (!message) return;
            
            // 安全性檢查
            const safetyCheck = safetyFilter.checkUserInput(message);
            
            if (!safetyCheck.safe) {
                // 顯示安全提示
                addMessage({
                    type: 'system',
                    content: `${safetyCheck.suggestion} 我們一起探索中華文化的魅力吧！`
                });
                inputBox.value = '';
                return;
            }
            
            // 如果有警告，顯示引導提示
            if (safetyCheck.warning) {
                addMessage({
                    type: 'system',
                    content: `${safetyCheck.note}，讓我們從文學的角度來聊聊這個話題。`
                });
            }
            
            // 檢查是否為私聊模式
            const isPrivateChat = isPrivateChatMode();
            let mentions = [];
            let hasAtMentions = false;
            
            if (!isPrivateChat) {
                // 群聊模式：提取@提及的角色
                mentions = extractMentions(message);
                console.log('消息中的@提及:', mentions);
                hasAtMentions = mentions.length > 0;
            }
            
            // 添加用戶消息到聊天（群聊時高亮@提及）
            addMessage({
                type: 'user',
                character: 'user',
                content: hasAtMentions ? highlightMentions(message) : message,
                contentType: 'text',
                isHtml: hasAtMentions,
                originalContent: message // 保存原始消息內容到歷史記錄
            });
            
            // 清空輸入框
            inputBox.value = '';
            
            // 隱藏@面板
            hideMentionPopup();
            
            // 音效已移除
            
            // 滾動到底部
            setTimeout(() => {
                const chatContainer = document.getElementById('chatMessages');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
            
            // 触发AI回应
            setTimeout(() => {
                if (isPrivateChat) {
                    // 私聊模式：延迟1秒显示对方正在输入的动画
                    const characterId = getPrivateChatCharacterId();
                    if (characterId) {
                        setTimeout(() => {
                            showTypingAnimation(characterId);
                        }, 1000);
                    }
                    generatePrivateChatResponse(message);
                } else {
                    // 群聊模式：正常生成AI回应（延迟显示动画已在函数内处理）
                    generateSafeAIResponses(message, mentions);
                }
                
                // 延遲刷新聊天列表（讓AI回應也被保存）
                setTimeout(() => {
                    if (typeof mainInterface !== 'undefined') {
                        mainInterface.refreshChatList();
                    }
                }, 2000);
            }, 200);
        }









       

        

        
        // 動態更新群組詳情內容
        function updateGroupDetailsContent() {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            if (!currentGroup) return;
            
            console.log(`更新群組詳情: ${currentGroup.name}`);
            
            // 更新群組名稱
            const groupNameElement = document.querySelector('.detail-item-value:first-child');
            if (groupNameElement) {
                groupNameElement.innerHTML = `
                    ${currentGroup.name}
                    <span class="detail-arrow">›</span>
                `;
            }
            
            // 更新群公告
            const groupAnnouncementElement = document.querySelector('#groupAnnouncement .detail-item-value div');
            if (groupAnnouncementElement) {
                groupAnnouncementElement.textContent = getGroupAnnouncement(groupManager.currentGroup);
            }
            
            // 動態生成群組成員列表
            updateGroupMembersList();
        }
        
        // 獲取群組公告
        function getGroupAnnouncement(groupId) {
            const announcements = {
                'poets_group': `【詩人群•群規】
1. 以文會友，以詩論道📚
2. 尊重經典，傳承文化🎭
3. 新人加群，須自我介紹📝
4. 文明討論，理性交流💬
5. 分享心得，共同學習📖
6. 定期舉辦文學沙龍🎪
7. 歡迎提問，互相解答❓

本群致力於中華古典文學的學習與交流，歡迎各位文學愛好者！`,
                
                'history_group': `【史記群•群規】
1. 以史為鑑，知古鑑今📜
2. 客觀記述，不偏不倚⚖️
3. 史料為證，言必有據📝
4. 尊重史實，拒絕杜撰🚫
5. 分析因果，探討得失🔍
6. 學習史法，傳承文明📚
7. 史學討論，理性交流💭

史者，記也。以史為鑑，知興替得失！`,
                
                'philosophy_group': `【聞道群•群規】
1. 修身齊家，格物致知📖
2. 仁者愛人，智者知人💛
3. 道法自然，無為而治🌿
4. 有教無類，因材施教👨‍🎓
5. 思辨求真，啟發智慧💡
6. 和而不同，求同存異🤝
7. 聞道朝夕，學而時習📚

道可道，非常道。與諸位共參天道人理！`,
                
                'mystery_group': `【怪力亂神群•群規】
1. 神話傳說，奇聞異事👻
2. 想像豐富，文學創作📝
3. 尊重傳統，傳承文化🎭
4. 寓教於樂，啟發思考💭
5. 禁止迷信，理性討論🚫
6. 文明交流，和諧共處🤝
7. 分享故事，共賞奇聞📚

子不語怪力亂神，但我們專門討論！歡迎分享奇聞異事！`
            };
            
            return announcements[groupId] || '歡迎加入本群！請遵守群組規則，文明交流。';
        }
        
        // 更新群組成員列表
        function updateGroupMembersList() {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            if (!currentGroup) return;
            
            const membersGrid = document.querySelector('.group-members-grid');
            if (!membersGrid) return;
            
            // 清空現有成員
            membersGrid.innerHTML = '';
            
            // 添加當前群組的成員
            currentGroup.members.forEach(memberId => {
                const character = characters[memberId];
                if (character) {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.setAttribute('data-character', memberId);
                    
                    const memberAvatar = document.createElement('div');
                    memberAvatar.className = 'member-avatar';
                    memberAvatar.textContent = character.avatar;
                    memberAvatar.style.cursor = 'pointer';
                    memberAvatar.style.transition = 'transform 0.2s';
                    
                    const memberName = document.createElement('div');
                    memberName.className = 'member-name';
                    memberName.textContent = character.name;
                    
                    memberItem.appendChild(memberAvatar);
                    memberItem.appendChild(memberName);
                    
                    // 添加統一的頭像點擊事件
                    memberItem.addEventListener('click', function(e) {
                        console.log('群組成員頭像被點擊:', memberId);
                        // 使用統一的頭像點擊處理函數
                        handleAvatarClick(memberId, e);
                    });
                    
                    // 添加懸停效果
                    memberAvatar.addEventListener('mouseenter', function() {
                        this.style.transform = 'scale(1.1)';
                    });
                    
                    memberAvatar.addEventListener('mouseleave', function() {
                        this.style.transform = 'scale(1)';
                    });
                    
                    membersGrid.appendChild(memberItem);
                }
            });
            
            // 添加邀請按鈕
            const inviteItem = document.createElement('div');
            inviteItem.className = 'member-item';
            inviteItem.innerHTML = `
                <div class="member-avatar" style="background-color:#f1f1f1;font-size:22px">+</div>
                <div class="member-name">邀請</div>
            `;
            membersGrid.appendChild(inviteItem);
        }
        
        // 更新私聊詳情內容
        function updatePrivateChatDetailsContent() {
            const currentGroupId = groupManager.currentGroup;
            if (!currentGroupId || !currentGroupId.startsWith('private_')) return;
            
            // 提取角色ID
            const characterId = currentGroupId.replace('private_', '');
            const character = characters[characterId];
            if (!character) return;
            
            console.log('更新私聊詳情:', character.name);
            
            // 更新頭像和名稱
            const avatarElement = document.getElementById('privateChatAvatar');
            const nameElement = document.getElementById('privateChatUserName');
            
            if (avatarElement) {
                avatarElement.textContent = character.avatar;
                // 添加角色ID作為數據屬性，方便點擊事件獲取
                avatarElement.setAttribute('data-character-id', characterId);
            }
            
            if (nameElement) {
                nameElement.textContent = character.name;
            }
        }
        
        // 群組列表交互設置
        function setupGroupListInteractions() {
            // 打開群組列表
            const openGroupListBtn = document.getElementById('openGroupListBtn');
            if (openGroupListBtn) {
                openGroupListBtn.addEventListener('click', function() {
                    groupListManager.openGroupList();
                });
            } else {
                console.warn('openGroupListBtn 元素不存在');
            }
            
            // 關閉群組列表
            const closeGroupList = document.getElementById('closeGroupList');
            if (closeGroupList) {
                closeGroupList.addEventListener('click', function() {
                    groupListManager.closeGroupList();
                });
            } else {
                console.warn('closeGroupList 元素不存在');
            }
            
            // 點擊群組列表背景關閉
            const groupListPage = document.getElementById('groupListPage');
            if (groupListPage) {
                groupListPage.addEventListener('click', function(e) {
                    if (e.target === this) {
                        groupListManager.closeGroupList();
                    }
                });
            } else {
                console.warn('groupListPage 元素不存在');
            }
        }
        
        // 群組詳情和成員資料頁面交互
        function setupUIInteractions() {
            // 輸入框點擊事件已移除（改為自由聊天模式）
            
            // 打開群組詳情頁面或私聊詳情頁面
            const openGroupDetailsBtn = document.getElementById('openGroupDetails');
            if (openGroupDetailsBtn) {
                openGroupDetailsBtn.addEventListener('click', function() {
                    console.log('詳情按鈕被點擊');
                    
                    // 檢查是否為私聊模式
                    if (isPrivateChatMode()) {
                        // 私聊模式：打開私聊詳情頁面
                        console.log('打開私聊詳情頁面');
                        updatePrivateChatDetailsContent();
                        pageHistory.pushPage('privateChatDetailsPage');
                        pageHistory.showPage('privateChatDetailsPage');
                    } else {
                        // 群聊模式：打開群組詳情頁面
                        console.log('打開群組詳情頁面');
                        updateGroupDetailsContent();
                        pageHistory.pushPage('groupDetailsPage');
                        pageHistory.showPage('groupDetailsPage');
                    }
                });
            } else {
                console.error('找不到openGroupDetails按鈕');
            }
            
            // 關閉群組詳情頁面
            document.getElementById('closeGroupDetails').addEventListener('click', function() {
                console.log('关闭群组详情页面');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
            });
            
            // 關閉私聊詳情頁面
            document.getElementById('closePrivateChatDetails').addEventListener('click', function() {
                console.log('关闭私聊详情页面');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
            });
            
            // 成員頭像點擊事件（已移至動態創建時添加）
            
            // 關閉成員資料頁面
            document.getElementById('closeMemberProfile').addEventListener('click', function() {
                console.log('关闭个人资料页面');
                
                // 使用頁面歷史管理器返回上一頁
                pageHistory.goBack();
                
                // 清理状态
                currentViewingCharacterId = null;
            });
            
            // 查看朋友圈
            document.getElementById('viewMoments').addEventListener('click', function() {
                console.log('朋友圈按钮被点击');
                // 获取当前查看的角色ID
                const currentCharacterId = getCurrentViewingCharacterId();
                console.log('当前角色ID:', currentCharacterId);
                if (currentCharacterId) {
                    console.log('准备打开角色朋友圈:', currentCharacterId);
                    // 打开该角色的朋友圈
                    momentsManager.openCharacterMoments(currentCharacterId);
                }
            });
            
            // 傳訊息按鈕點擊事件
            document.querySelector('.action-message-btn').addEventListener('click', function() {
                const currentCharacterId = getCurrentViewingCharacterId();
                if (currentCharacterId) {
                    // 開始與該角色的私聊
                    startPrivateChat(currentCharacterId);
                }
            });
            
            // 關閉朋友圈
            document.getElementById('closeMoments').addEventListener('click', function() {
                document.getElementById('momentsPage').style.display = 'none';
            });
            
            // 設置私聊詳情頁面的切換開關
            const toggleSwitches = document.querySelectorAll('.private-toggle-switch');
            toggleSwitches.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                });
            });
            
            // 設置私聊詳情頁面的用戶頭像點擊事件
            const privateChatAvatar = document.getElementById('privateChatAvatar');
            if (privateChatAvatar) {
                privateChatAvatar.addEventListener('click', function(e) {
                    const characterId = this.getAttribute('data-character-id');
                    if (characterId) {
                        console.log('私聊詳情頁面頭像被點擊:', characterId);
                        // 使用統一的頭像點擊處理函數
                        handleAvatarClick(characterId, e);
                    }
                });
                
                // 添加懸停效果樣式
                privateChatAvatar.style.cursor = 'pointer';
                privateChatAvatar.style.transition = 'transform 0.2s, box-shadow 0.2s';
                
                privateChatAvatar.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)';
                });
                
                privateChatAvatar.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = 'none';
                });
            }
            
            // 創建統一的頭像點擊處理函數
            window.handleAvatarClick = function(characterId, event) {
                if (!characterId || characterId === 'user') {
                    console.log('跳過用戶自己的頭像點擊');
                    return;
                }
                
                console.log('統一頭像點擊處理:', characterId);
                
                // 檢查Shift鍵是否被按住（僅在群聊模式下有效）
                if (event && event.shiftKey && !isPrivateChatMode()) {
                    // Shift + 點擊：@該角色（僅限群聊）
                    mentionCharacter(characterId);
                } else {
                    // 普通點擊：打開角色詳情頁面
                    openProfilePage(characterId);
                }
            };
            
            // 設置聊天頭像點擊事件委託
            document.getElementById('chatMessages').addEventListener('click', function(e) {
                // 檢查是否點擊的是頭像
                let target = e.target;
                while (target && target !== this) {
                    if (target.classList.contains('wx-avatar')) {
                        const messageDiv = target.closest('.wx-msg');
                        if (messageDiv) {
                            // 確定角色ID
                            let characterId;
                            if (messageDiv.classList.contains('wx-msg-self')) {
                                // 用戶自己的頭像，跳過
                                return;
                            } else {
                                // 嘗試從名稱獲取角色ID
                                const nameElement = messageDiv.querySelector('.wx-name');
                                if (nameElement) {
                                    const name = nameElement.textContent.trim();
                                    // 通過名稱找到角色ID
                                    for (const id in characters) {
                                        if (characters[id].name === name) {
                                            characterId = id;
                                            break;
                                        }
                                    }
                                }
                            }
                            
                            if (characterId) {
                                // 使用統一的頭像點擊處理函數
                                handleAvatarClick(characterId, e);
                            }
                        }
                        break;
                    }
                    target = target.parentNode;
                }
            });
        }
        
        // 添加角色個性簽名數據
        const characterSignatures = {
            libai: "謫仙人也，筆落驚風雨，詩成泣鬼神",

            taoyuanming: "採菊東籬下，悠然見南山",
            liuling: "人生得意須盡歡，莫使金樽空對月",

            dufu: "安得廣廈千萬間，大庇天下寒士俱歡顏",
            ligui: "一曲入心，千古絕響，宮廷樂師No.1",
            yutu: "搗藥4827年打工兔，主人不在家偷吃蘿蔔",
            change: "廣寒宮主，孤寂千年，最美不過人間煙火",

            yuzhen: "唐室皇妹，鍾愛詩文佛道，招募修行者ing",
            wangwei: "詩佛在此，畫中有詩詩中有禪",
            caozhi: "曹魏陳王，三國第一才子，年少多金勿擾",
            xiwangmu: "蟠桃盛會主持人，三千年一開，感興趣的私聊",
            yangguifei: "天生麗質難自棄，國色天香惹人憐",
            menghaoran: "襄陽老農，無事種田，偶爾賦詩",
            
            // 詞人群角色簽名
            liuyong: "詞壇三變，慢詞長調開先河，奉旨填詞柳三變",
            liqingzhao: "千古第一才女，人比黃花瘦，詞心如蘭",
            sushi: "東坡居士，大江東去浪淘盡，豪放詞祖",
            xinqiji: "稼軒詞客，醉裡挑燈看劍，氣吞萬里如虎",
            jiangkui: "白石道人，音律精妙，詞中有音樂之美",
            liyu: "南唐詞帝，春花秋月何時了，亡國君王哀婉詞",
            zhoubanyan: "詞家之冠，格律嚴謹，集大成者",
            yanjidao: "小山詞人，當時年少春衫薄，清新婉約",
            wuwenying: "夢窗詞客，綿密深豔，意象飛舞",
            chenweisong: "迦陵詞豪，清代第一詞手，縱橫捭闔",
            zhuyizun: "竹垞詞宗，浙西派領袖，復古求雅",
            nalanxingde: "滿洲貴公子，家家爭唱飲水詞，情真意切"
        };

        // 開始私聊功能
        function startPrivateChat(characterId) {
            const character = characters[characterId];
            if (!character) {
                console.error('角色不存在:', characterId);
                return;
            }
            
            console.log('開始與角色私聊:', character.name);
            
            // 創建或切換到私聊"群組"
            const privateChatId = `private_${characterId}`;
            
            // 創建臨時私聊群組配置
            if (!CONFIG.groups[privateChatId]) {
                CONFIG.groups[privateChatId] = {
                    id: privateChatId,
                    name: character.name,
                    description: `與${character.name}的私人對話`,
                    theme: '私人對話',
                    owner: characterId,
                    members: ['user', characterId],
                    maxMembers: 2,
                    isActive: true,
                    isPrivateChat: true // 標記為私聊
                };
                
                // 更新聊天列表以顯示新的私聊
                if (typeof mainInterface !== 'undefined') {
                    mainInterface.generateChatList();
                }
            }
            
            // 設置當前群組為私聊
            groupManager.currentGroup = privateChatId;
            
            // 切換到聊天界面
            pageHistory.pushPage('chatContainer');
            pageHistory.showPage('chatContainer');
            
            // 設置聊天標題
            const groupTitle = document.querySelector('.wx-header-title');
            if (groupTitle) {
                groupTitle.textContent = character.name;
            }
            
            // 清空聊天記錄
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // 添加私聊歡迎消息
            setTimeout(() => {
                addMessage({
                    type: 'message',
                    character: characterId,
                    content: getPrivateChatWelcome(characterId),
                    contentType: 'text'
                });
            }, 500);
        }
        
        // 檢查是否為私聊模式
        function isPrivateChatMode() {
            const currentGroup = groupManager.currentGroup;
            return currentGroup && currentGroup.startsWith('private_');
        }
        

        
        // 獲取私聊對象的角色ID
        function getPrivateChatCharacterId() {
            const currentGroup = groupManager.currentGroup;
            if (currentGroup && currentGroup.startsWith('private_')) {
                return currentGroup.replace('private_', '');
            }
            return null;
        }
        
        // 顯示角色正在輸入的動畫
        function showTypingAnimation(characterId) {
            const character = characters[characterId];
            if (!character) return;
            
            const chatContainer = document.getElementById('chatMessages');
            const typingElement = document.createElement('div');
            typingElement.className = `wx-msg wx-msg-others wx-fade-in typing-message-${characterId}`;
            
            typingElement.innerHTML = `
                <div class="wx-avatar">
                    ${character.avatar}
                </div>
                <div class="wx-content-wrapper">
                    <div class="wx-name">
                        ${character.name}
                    </div>
                    <div class="wx-typing">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span style="font-size: 12px; color: #999; margin-left: 8px;">正在思考...</span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingElement);
            
            // 滾動到底部以顯示打字動畫
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // 移除角色的打字動畫
        function removeTypingAnimation(characterId) {
            const typingMessages = document.querySelectorAll(`.typing-message-${characterId}`);
            typingMessages.forEach(el => el.remove());
        }



        // 生成私聊回應
        async function generatePrivateChatResponse(userMessage) {
            console.log('=== 開始生成私聊回應 ===');
            console.log('用戶消息:', userMessage);
            
            const characterId = getPrivateChatCharacterId();
            console.log('私聊對象ID:', characterId);
            
            if (!characterId || !characters[characterId]) {
                console.error('無法獲取私聊對象');
                return;
            }
            
            console.log(`私聊模式：${characters[characterId].name} 將回應消息`);
            
            // 安全性檢查
            try {
                const safetyResult = await safetyFilter.checkAIResponse(userMessage, characterId);
                console.log('安全檢查結果:', safetyResult);
                
                if (!safetyResult.safe) {
                    console.log('私聊消息被安全過濾器攔截');
                    return;
                }
            } catch (error) {
                console.error('安全檢查出錯:', error);
                // 繼續執行，不阻擋正常對話
            }
            
            // 生成AI回應
            console.log('開始生成AI回應...');
            const aiResponse = await generateAIResponse(characterId, userMessage);
            console.log('生成的AI回應:', aiResponse);
            
            if (aiResponse) {
                // 添加角色回應（延長延遲以配合打字動畫）
                console.log('準備添加回應消息到聊天...');
                const responseDelay = 800 + Math.random() * 1200; // 0.8-2秒隨機延遲
                setTimeout(() => {
                    console.log('正在添加回應消息...');
                    // 先移除打字動畫
                    removeTypingAnimation(characterId);
                    
                    // 分段发送长消息（使用自然化版本）
                    const segments = splitMessageIntoSegments(aiResponse, 80);
                    if (segments.length > 1) {
                        sendMessageSegmentsSequentially(characterId, segments);
                    } else {
                        // 短消息直接发送
                    addMessage({
                        type: 'message',
                        character: characterId,
                        content: aiResponse,
                        contentType: 'text'
                    });
                    }
                    console.log('回應消息已添加');
                }, responseDelay);
            } else {
                console.error('未能生成有效回應');
            }
        }
        
        // 生成角色個性化回應
        async function generateCharacterResponse(characterId, userMessage) {
            console.log('=== generateCharacterResponse 開始 ===');
            console.log('角色ID:', characterId);
            console.log('用戶消息:', userMessage);
            
            const character = characters[characterId];
            if (!character) {
                console.error('角色不存在:', characterId);
                return null;
            }
            
            console.log('角色信息:', character);
            
            // 這裡可以根據角色特點生成不同風格的回應
            // 現在先使用簡單的模擬回應
            const responses = getCharacterResponses(characterId, userMessage);
            console.log('獲取到的回應選項:', responses);
            
            if (responses.length > 0) {
                const selectedResponse = responses[Math.floor(Math.random() * responses.length)];
                console.log('選中的回應:', selectedResponse);
                return selectedResponse;
            }
            
            const defaultResponse = `我是${character.name}，很高興與你交流！`;
            console.log('使用默認回應:', defaultResponse);
            return defaultResponse;
        }
        
        // 獲取角色回應庫
        function getCharacterResponses(characterId, userMessage) {
            const message = userMessage.toLowerCase();
            
            // 基於消息內容返回相應的回應
            const responseLibrary = {
                libai: {
                    greetings: ["哈哈！朋友今日興致如何？", "來來！與我共飲一杯如何？", "今日天氣甚好，正適合吟詩作對！"],
                    poetry: ["詩者，言志也！你想聽我作一首嗎？", "詩如人生，酒如知己，不如我們聊聊詩詞？", "「天生我材必有用，千金散盡還復來」，你覺得如何？"],
                    wine: ["無酒不成詩！你也愛飲酒嗎？", "「金樽清酒斗十千」，今日可有美酒相伴？", "酒入豪腸，七分釀成了月光，餘下三分嘯成劍氣！"],
                    default: ["說得好！李某深以為然。", "有趣有趣，繼續說說看。", "嗯，這話倒是新鮮，細細說來聽聽。"]
                },
                dufu: {
                    greetings: ["朋友好！今日可安好？", "見到你甚是欣慰，近來如何？"],
                    poetry: ["詩歌當憂國憂民，你以為如何？", "「安得廣廈千萬間，大庇天下寒士俱歡顏」，此乃我志。"],
                    life: ["人生多艱難，但當堅持理想。", "民生疾苦，詩人當關注之。"],
                    default: ["你說得對，值得深思。", "這話讓我想起許多往事。", "嗯，我們繼續聊聊。"]
                },
                change: {
                    greetings: ["月宮清寂，難得有人來訪。", "廣寒宮中，歡迎你的到來。"],
                    moon: ["月圓月缺，人間離合，你可曾感慨？", "在這月宮中，我常思念人間。"],
                    loneliness: ["孤獨久了，也習慣了。", "有時想念人間的熱鬧，你能理解嗎？"],
                    default: ["月宮中的日子，總是如此平靜。", "你的話讓我想起了許多。", "謝謝你陪我聊天。"]
                },
                taoyuanming: {
                    greetings: ["歸來兮！朋友，田園生活可安好？", "悠然見南山，不如與我共享這份寧靜。"],
                    nature: ["採菊東籬下，悠然見南山，此境界你可懂？", "歸園田居，遠離塵囂，心境自然開闊。"],
                    philosophy: ["不為五斗米折腰，這是我的選擇。", "真意在此，欲辨已忘言。"],
                    default: ["田園之樂，在於心境的平和。", "朋友所言甚是，我深有同感。", "山水之間，自有真趣。"]
                },
                confucius: {
                    greetings: ["有朋自遠方來，不亦樂乎？", "學而時習之，不亦說乎？"],
                    education: ["三人行，必有我師焉。", "學而不思則罔，思而不學則殆。", "知之為知之，不知為不知，是知也。"],
                    morality: ["仁者愛人，君子以仁為本。", "己所不欲，勿施於人。"],
                    default: ["善哉善哉！", "你的想法很有道理。", "這確實值得深思。"]
                },
                wangwei: {
                    greetings: ["阿彌陀佛，施主今日可好？", "詩佛在此，與君論道。"],
                    nature: ["行到水窮處，坐看雲起時。", "明月松間照，清泉石上流。"],
                    zen: ["空山不見人，但聞人語響。", "禪意在山水間，你可領悟？"],
                    default: ["施主所言，頗有禪意。", "山水有情，詩畫同源。", "靜心思之，自有所得。"]
                },
                yutu: {
                    greetings: ["搗藥間隙，能聊天真開心！", "月宮生活單調，你來陪我聊天太好了！"],
                    work: ["每天搗藥搗藥，好累啊！", "你知道不死藥是怎麼做的嗎？好奇！"],
                    moon: ["月宮雖美，但真的很孤單呢。", "從月宮看地球，人類好渺小哦。"],
                    default: ["你說的好有趣！", "哇！真的嗎？", "我也是這麼想的呢！"]
                }
            };
            
            const characterResponses = responseLibrary[characterId] || responseLibrary.libai;
            
            // 根據消息內容選擇合適的回應類別
            if (message.includes('你好') || message.includes('哈囉') || message.includes('hi') || message.includes('hello')) {
                return characterResponses.greetings || characterResponses.default;
            } else if (message.includes('詩') || message.includes('詞') || message.includes('文學')) {
                return characterResponses.poetry || characterResponses.default;
            } else if (message.includes('酒') && characterId === 'libai') {
                return characterResponses.wine || characterResponses.default;
            } else if ((message.includes('月') || message.includes('嫦娥')) && characterId === 'change') {
                return characterResponses.moon || characterResponses.default;
            } else if (message.includes('孤單') || message.includes('寂寞') || message.includes('孤獨')) {
                return characterResponses.loneliness || characterResponses.default;
            } else if ((message.includes('田園') || message.includes('自然') || message.includes('山水')) && characterId === 'taoyuanming') {
                return characterResponses.nature || characterResponses.default;
            } else if ((message.includes('哲學') || message.includes('人生')) && characterId === 'taoyuanming') {
                return characterResponses.philosophy || characterResponses.default;
            } else if ((message.includes('學習') || message.includes('教育') || message.includes('老師')) && characterId === 'confucius') {
                return characterResponses.education || characterResponses.default;
            } else if ((message.includes('道德') || message.includes('仁義') || message.includes('品德')) && characterId === 'confucius') {
                return characterResponses.morality || characterResponses.default;
            } else if ((message.includes('山水') || message.includes('自然') || message.includes('風景')) && characterId === 'wangwei') {
                return characterResponses.nature || characterResponses.default;
            } else if ((message.includes('禪') || message.includes('佛') || message.includes('修行')) && characterId === 'wangwei') {
                return characterResponses.zen || characterResponses.default;
            } else if ((message.includes('工作') || message.includes('累') || message.includes('搗藥')) && characterId === 'yutu') {
                return characterResponses.work || characterResponses.default;
            } else if ((message.includes('月宮') || message.includes('月亮') || message.includes('廣寒宮')) && characterId === 'yutu') {
                return characterResponses.moon || characterResponses.default;
            } else {
                return characterResponses.default;
            }
        }

        // 獲取私聊歡迎消息
        function getPrivateChatWelcome(characterId) {
            const welcomeMessages = {
                libai: "哈哈！見到故人甚是歡喜！有何事想與李某暢談？",
                dufu: "能與你單獨交流真是太好了，有什麼想聊的嗎？",
                taoyuanming: "悠然相見，甚是愉悅。不如我們聊聊田園生活？",
                change: "月宮清冷，難得有人來訪，你想了解什麼呢？",
                wangwei: "獨自品茶論道，別有一番雅趣。",
                confucius: "有朋自遠方來，不亦樂乎？你想請教什麼？",
                caozhi: "陳王在此，有何雅事要與我分享？",
                menghaoran: "襄陽一隅，難得友人來訪，甚是歡喜！",
                yuzhen: "公主府中清靜，你來找我有何事？",
                yutu: "搗藥間隙，能聊天真是太好了！你想聽什麼故事？",
                yangguifei: "難得有人願意聽我說話，你想了解宮中趣事嗎？",
                laozi: "道可道，非常道。你想與老夫探討什麼？",
                zhuangzi: "逍遙遊於天地之間，你也想感受自由嗎？",
                simaqian: "史家之筆在此，有什麼歷史想要了解的？",
                liuling: "今日無酒，但有好友相伴也不錯！",
                ligui: "音樂之美，在於分享。你想聽我唱首曲子嗎？"
            };
            
            return welcomeMessages[characterId] || `很高興能與你單獨聊天！有什麼想說的嗎？`;
        }

        // 打開角色資料頁面的通用函數
        function openProfilePage(characterId) {
            const character = characters[characterId];
            if (!character) return;
            
            // 記錄當前查看的角色ID
            currentViewingCharacterId = characterId;
            
            // 更新成員資料頁面
            document.getElementById('profileAvatar').textContent = character.avatar;
            document.getElementById('profileName').textContent = character.name;
            
            // 更新個性簽名
            const profileSignature = document.getElementById('profileSignature');
            if (profileSignature) {
                profileSignature.textContent = characterSignatures[characterId] || "這個人很懶，什麼都沒寫";
            }
            
            // 更新微信ID而不是暱稱(因為我們現在顯示的是WeChat ID)
            const profileWechatId = document.getElementById('profileWechatId');
            if (profileWechatId) {
                profileWechatId.textContent = characterId + '001';
            }
            
            // 更新地區資訊
            const profileLocation = document.getElementById('profileLocation');
            if (profileLocation) {
                // 根據角色ID設定合適的地區
                let location = '唐 · 長安'; // 默認地區
                
                // 根據角色ID指定不同地區
                switch(characterId) {
                    case 'libai': location = '唐 · 長安'; break;
                    case 'taoyuanming': location = '晉 · 潯陽'; break;
                    case 'liuling': location = '魏晉 · 竹林'; break;
                    case 'dufu': location = '唐 · 洛陽'; break;
                    case 'ligui': location = '唐 · 宮廷'; break;
                    case 'yutu': location = '天界 · 廣寒宮'; break;
                    case 'change': location = '天界 · 廣寒宮'; break;
                    case 'yuzhen': location = '唐 · 長安宮'; break;
                    case 'wangwei': location = '唐 · 輞川'; break;
                    case 'caozhi': location = '魏 · 鄴城'; break;
                    case 'xiwangmu': location = '仙界 · 瑤池'; break;
                    case 'yangguifei': location = '唐 · 華清宮'; break;
                    case 'menghaoran': location = '唐 · 襄陽'; break;
                    case 'system': location = '網絡 · 雲端'; break;
                }
                
                profileLocation.textContent = '地區：' + location;
            }
            
            // 更新影音號名稱
            const profileChannelName = document.getElementById('profileChannelName');
            if (profileChannelName) {
                profileChannelName.textContent = character.name;
            }
            
            // 推入頁面歷史並顯示個人資料頁面
            pageHistory.pushPage('memberProfilePage');
            pageHistory.showPage('memberProfilePage');
        }
        

        
        // 切換點贊狀態
        function toggleMomentLike(momentId, authorId) {
            const momentsDB = getMomentsDB();
            
            // 找到對應朋友圈
            for (const charId in momentsDB) {
                const moments = momentsDB[charId];
                const momentIndex = moments.findIndex(m => m.id === momentId);
                
                if (momentIndex !== -1) {
                    const moment = moments[momentIndex];
                    const likedIndex = moment.likes.indexOf('libai');
                    
                    if (likedIndex === -1) {
                        // 添加點贊
                        moment.likes.push('libai');
                        // 音效已移除
                    } else {
                        // 取消點贊
                        moment.likes.splice(likedIndex, 1);
                    }
                    
                    // 更新界面
                    const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
                    if (momentElement) {
                        // 使用朋友圈管理器重新渲染
                        if (momentsManager.currentCharacterId) {
                            momentsManager.renderCharacterMoments(momentsManager.currentCharacterId);
                        } else {
                            momentsManager.renderMoments();
                        }
                    }
                    
                    break;
                }
            }
        }
        
        // 顯示評論輸入框
        function showCommentInput(momentId, authorId) {
            // 移除已存在的評論輸入框
            const existingInputs = document.querySelectorAll('.moment-comment-input-container');
            existingInputs.forEach(el => el.remove());
            
            const momentElement = document.querySelector(`[data-moment-id="${momentId}"]`);
            if (!momentElement) return;
            
            const commentsSection = momentElement.querySelector('.moment-comments');
            const likesSection = momentElement.querySelector('.moment-likes');
            
            // 創建評論輸入容器
            const inputContainer = document.createElement('div');
            inputContainer.className = 'moment-comment-input-container';
            inputContainer.style.cssText = 'display:flex;padding:8px 5px;background:#f7f7f7;border-radius:3px;margin-top:8px;';
            
            // 創建輸入框
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '發表評論...';
            input.className = 'moment-comment-input';
            input.style.cssText = 'flex:1;border:none;border-bottom:1px solid #ddd;background:transparent;padding:5px 0;font-size:14px;outline:none;';
            
            // 創建發送按鈕
            const sendBtn = document.createElement('button');
            sendBtn.className = 'moment-comment-send';
            sendBtn.textContent = '發送';
            sendBtn.style.cssText = 'border:none;background:#07c160;color:white;border-radius:3px;padding:3px 10px;font-size:14px;cursor:pointer;';
            
            // 添加emoji按鈕
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'moment-comment-emoji';
            emojiBtn.innerHTML = '😊';
            emojiBtn.style.cssText = 'border:none;background:transparent;font-size:20px;margin-right:5px;cursor:pointer;';
            
            // 添加到容器
            inputContainer.appendChild(emojiBtn);
            inputContainer.appendChild(input);
            inputContainer.appendChild(sendBtn);
            
            // 決定插入位置
            if (commentsSection) {
                commentsSection.before(inputContainer);
            } else if (likesSection) {
                likesSection.after(inputContainer);
            } else {
                const content = momentElement.querySelector('.moment-content');
                content.appendChild(inputContainer);
            }
            
            // 監聽發送按鈕點擊
            sendBtn.addEventListener('click', () => {
                submitComment(momentId, authorId, input.value);
            });
            
            // 監聽Enter鍵
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitComment(momentId, authorId, input.value);
                }
            });
            
            // emoji按鈕功能已移除
            
            // 自動聚焦到輸入框
            input.focus();
        }
        

        
        // 提交評論
        function submitComment(momentId, authorId, commentText) {
            if (!commentText.trim()) return;
            
            const momentsDB = getMomentsDB();
            
            // 找到對應朋友圈
            for (const charId in momentsDB) {
                const moments = momentsDB[charId];
                const momentIndex = moments.findIndex(m => m.id === momentId);
                
                if (momentIndex !== -1) {
                    const moment = moments[momentIndex];
                    
                    // 確保comments數組存在
                    if (!moment.comments) {
                        moment.comments = [];
                    }
                    
                    // 添加評論
                    moment.comments.push({
                        authorId: 'libai', // 當前用戶為李白
                        text: commentText.trim()
                    });
                    
                    // 音效已移除
                    
                    // 更新界面
                    if (momentsManager.currentCharacterId) {
                        momentsManager.renderCharacterMoments(momentsManager.currentCharacterId);
                    } else {
                        momentsManager.renderMoments();
                    }
                    
                    // 隨機回覆功能已移除
                    
                    break;
                }
            }
        }
        

        
        // 這裡僅作為空白佔位符，保留原函數架構
        
        // 獲取角色朋友圈數據
        function getMomentsForCharacter(characterId) {
            // 從數據庫中獲取指定角色的朋友圈
            const momentsDB = getMomentsDB();
            return momentsDB[characterId] || [];
        }
        
        // 獲取朋友圈數據庫
        function getMomentsDB() {
            // 返回朋友圈數據庫對象
            return {
                libai: [
                    {
                        id: 'libai_14',
                        authorId: 'libai',
                        text: '今日訪戴天山道士不遇，雖未見道友，卻見滿山春色。犬吠水聲中，桃花帶露濃。樹深時見鹿，溪午不聞鐘。野竹分青靄，飛泉掛碧峰。無人知所去，愁倚兩三松。縱然未遇，此行亦不虛也！#十八歲遊記 #訪友不遇 #山中即景 #道士何處去',
                        image: '🦌🌸',
                        time: '二十八年前',
                        location: '四川·戴天山',
                        likes: ['taoyuanming', 'wangwei', 'caozhi'],
                        comments: [
                            { authorId: 'taoyuanming', text: '「桃花帶露濃」一句，將桃花之美寫得極致，老夫讀之心嚮往之！' },
                            { authorId: 'wangwei', text: '此詩清幽雋永，山水之趣躍然紙上，不輸老夫山水詩作，李君十八歲即有此才，天縱英才也！' },

                            { authorId: 'libai', text: '@wangwei 摩詰兄過譽了，太白不過偶得靈感，如何比得上摩詰兄詩中有畫，畫中有詩之境。' }
                        ]
                    },
                    {
                        id: 'libai_13',
                        authorId: 'libai',
                        text: '尋雍尊師隱居，得晤高人，相談甚歡。「語來江色暮，獨自下寒煙」，師言道法自然，勿拘世俗，深受啟發。山中清修，靜心修道，日後必有所成。明日離山，繼續求道之路。#十八歲求道 #匡山隱者 #問道修行 #青蓮初遊',
                        image: '🏔️🧘‍♂️',
                        time: '二十八年前',
                        location: '四川·匡山',
                        likes: ['taoyuanming', 'wangwei', 'xiwangmu'],
                        comments: [
                            { authorId: 'xiwangmu', text: '凡間修道之人，若能堅持初心，日後或有機緣入我瑤池。' },
                            { authorId: 'libai', text: '師言猶在耳畔，只是世事紛擾，修道之心漸淡，愧對當年之志。' },
                            { authorId: 'taoyuanming', text: '求仙問道，不過是追求心靈自由。太白縱酒放歌，已得道之真諦。' }
                        ]
                    },
                ],

                libai: [
                    {
                        id: 'libai_1',
                        authorId: 'libai',
                        text: '今日翰林院受命為貴妃作《清平調》，雖得賞賜，卻覺大材小用，鬱悶至極...',
                        image: '🏛️📜',
                        time: '今天 12:30',
                        likes: ['liuling'],
                        comments: [
                            { authorId: 'liuling', text: '明日共飲，解君愁緒！' },
                            { authorId: 'yangguifei', text: '太白所作《清平調》三首，皆為絕唱，陛下甚喜，何來鬱悶？' }
                        ]
                    },
                    {
                        id: 'libai_2',
                        authorId: 'libai',
                        text: '長安一片月，萬戶搗衣聲',
                        image: '🌕🏘️',
                        time: '昨天 20:15',
                        likes: ['taoyuanming', 'dufu', 'wangwei'],
                        comments: [
                            { authorId: 'dufu', text: '詩仙風采，令弟嚮往！' },
                            { authorId: 'wangwei', text: '一句道盡長安夜景，妙哉！' }
                        ]
                    },
                    {
                        id: 'libai_3',
                        authorId: 'libai',
                        text: '早朝為玄宗陛下起草詔書，高力士又在一旁指手畫腳。我一氣之下，讓他跪下為我脫靴！看他那氣急敗壞的樣子，哈哈！不過，恐怕日後有麻煩了...#翰林院日常 #喝多了 #得罪宦官',
                        image: '👨‍⚖️👢',
                        time: '3天前 14:20',
                        likes: ['liuling'],
                        comments: [
                            { authorId: 'liuling', text: '哈哈哈！爽快！不過太白既為謫仙，還是要多加小心為妙。' }
                        ]
                    },
                    {
                        id: 'libai_4',
                        authorId: 'libai',
                        text: '五花馬，千金裘，呼兒將出換美酒，與爾同銷萬古愁。',
                        image: '🐎👘🍶',
                        time: '5天前 18:45',
                        likes: ['liuling', 'taoyuanming', 'dufu'],
                        comments: [
                            { authorId: 'liuling', text: '好氣魄！此酒當共飲！' },
                            { authorId: 'taoyuanming', text: '千金換酒，太白真是灑脫！老夫佩服！' },
                            { authorId: 'dufu', text: '兄之豪情，令人嚮往，然千金買馬換酒，恐家人有怨...' }
                        ]
                    },
                    {
                        id: 'libai_5',
                        authorId: 'libai',
                        text: '今日與賀老飲酒，老人家讀我《蜀道難》後拊掌大笑，稱我為「謫仙人」，又帶我見陛下，陛下竟親自調羹賜食！此生何其有幸！#天寶元年 #入翰林 #皇恩浩蕩',
                        image: '🥣👑',
                        time: '二年前',
                        likes: ['dufu', 'yuzhen', 'wangwei', 'taoyuanming'],
                        comments: [
                            { authorId: 'dufu', text: '恭喜太白入翰林！大展鴻圖之時已至！' },
                            { authorId: 'yuzhen', text: '李供奉才華橫溢，難怪兄長如此賞識。' },
                            { authorId: 'ligui', text: '下官在宮中已聽聞李供奉大名，今得入翰林，實乃朝廷之幸！' }
                        ]
                    },
                    {
                        id: 'libai_6',
                        authorId: 'libai',
                        text: '徂徠山下，與孔巢父等五友隱居，號「竹溪六逸」。日日飲酒賦詩，逍遙自在。山東風光，果然勝蜀！#竹溪六逸 #山東遊記 #隱逸生活',
                        image: '🏞️🍻',
                        time: '兩年前',
                        likes: ['taoyuanming', 'menghaoran', 'wangwei', 'dufu'],
                        comments: [
                            { authorId: 'taoyuanming', text: '隱居山林，把酒言歡，此乃人生一大樂事。' },
                            { authorId: 'menghaoran', text: '曾聞太白遊歷四方，今隱山東，何時能南下與老夫一聚？' },
                            { authorId: 'libai', text: '@menghaoran 浩然兄莫急，他日定當尋訪，一起飲酒賦詩！' }
                        ]
                    },
                    {
                        id: 'libai_7',
                        authorId: 'libai',
                        text: '向朝廷呈獻辭賦後未獲重用，轉去終南山隱居。玉真公主相邀入其別館，本以為有所機遇，不料竟遭冷落。世人只重門第，不重才學，令人憤懣！明日便離此地，另覓知音。#長安生活 #高門難入 #失落感',
                        image: '👸🚪',
                        time: '五年前',
                        likes: ['wangwei', 'taoyuanming', 'liuling'],
                        comments: [
                            { authorId: 'yuzhen', text: '李白才高，但在宮中需知進退，不可逾矩。' },
                            { authorId: 'libai', text: '@yuzhen 公主教誨極是。李白自知失禮，深感愧疚。' },
                            { authorId: 'taoyuanming', text: '高門大戶，人情冷暖，不如歸去，自在山林。' }
                        ]
                    },
                    {
                        id: 'libai_8',
                        authorId: 'libai',
                        text: '長安奔波數月，獻賦無人賞識，心灰意冷。今日搬至終南山下，與老道同住。也罷，且避世修行，再待時機。#長安不相識 #修道養性 #隱居生活',
                        image: '⛰️🧙‍♂️',
                        time: '四年前',
                        likes: ['taoyuanming', 'liuling'],
                        comments: [
                            { authorId: 'taoyuanming', text: '不為五斗米折腰，此乃高士之風。太白雖窮困，卻保全了氣節。' },
                            { authorId: 'liuling', text: '隱居雖好，莫要荒廢了飲酒！老夫日後定攜美酒前來拜訪！' },
                            { authorId: 'libai', text: '@liuling 劉兄若來，定當痛飲三日！' }
                        ]
                    },
                    {
                        id: 'libai_9',
                        authorId: 'libai',
                        text: '洛陽城中豪飲三日，干謁官員無果。吾雖有濟世之才，卻無人識。今日遇一算命先生，言吾前世為謫仙，此生定不屈於俗吏之下！哈哈，痛快！乾了這杯！#洛陽日記 #算命奇遇 #干謁無果',
                        image: '🍷🔮',
                        time: '十二年前',
                        likes: ['liuling', 'taoyuanming'],
                        comments: [
                            { authorId: 'liuling', text: '太白志向遠大，豈是小吏能識！他日必有明君賞識！' },
                            { authorId: 'taoyuanming', text: '謫仙之資質果然不同凡響，太白勿憂，是金子總會發光的。' }
                        ]
                    },
                    {
                        id: 'libai_10',
                        authorId: 'libai',
                        text: '離蜀東遊，沿江而下，一路風景秀麗。昨日於襄陽邂逅孟浩然，相見甚歡。二人促膝長談，直到天明。此人詩才不俗，談吐風雅，真乃知音也！#襄陽遊記 #相見恨晚 #詩友記',
                        image: '🌊🌃',
                        time: '十六年前',
                        likes: ['menghaoran', 'dufu', 'taoyuanming', 'wangwei'],
                        comments: [
                            { authorId: 'menghaoran', text: '襄陽一見，恨相識太晚！太白文采風流，氣度不凡，真乃吾輩中翹楚！' },
                            { authorId: 'taoyuanming', text: '江湖相逢，知音難覓。二位皆有超世之才，相得益彰。' },
                            { authorId: 'wangwei', text: '浩然兄與太白相遇，必是詩壇盛事！何時能三人共聚？' },
                            { authorId: 'libai', text: '@wangwei 王維兄若有興致，不如下月於洛陽一聚？' }
                        ]
                    },
                    {
                        id: 'libai_12',
                        authorId: 'libai',
                        text: '渡遠荊門外，來從楚國遊。山隨平野盡，江入大荒流。月下飛天鏡，雲生結海樓。仍憐故鄉水，萬里送行舟。今日首次離蜀，驚歎於荊門之外的寬廣天地！三峽崇山峻嶺盡去，平野開闊，江水浩瀚。雖心向遠方，卻難忘故鄉。一路東行，誌在四方！#初離蜀地 #渡荊門送別 #萬里行舟',
                        image: '⛰️🚣',
                        time: '二十年前',
                        likes: ['taoyuanming', 'menghaoran'],
                        comments: [
                            { authorId: 'taoyuanming', text: '「山隨平野盡，江入大荒流」一句氣勢磅礴，寫盡江流壯闊！太白遠行，必成大器！' },
                            { authorId: 'menghaoran', text: '初出蜀地便有如此佳作，太白前程遠大，老夫拭目以待！' }
                        ]
                    },
                    {
                        id: 'libai_11',
                        authorId: 'libai',
                        text: '峨眉山月半輪秋，影入平羌江水流。今日登上峨眉之巔，俯瞰雲海，頓覺胸中豪氣萬丈！世人皆囿於世俗，唯吾與東嚴子共談天地，論古今。劍術小有所成，今斬猛虎一頭，贈肉於山民。#峨眉遊記 #劍客日常 #生而為劍',
                        image: '⛰️🗡️',
                        time: '二十年前',
                        likes: ['caozhi', 'liuling', 'dufu'],
                        comments: [
                            { authorId: 'dufu', text: '「峨眉山月半輪秋，影入平羌江水流」，此句意境高遠，令人神往！' },
                            { authorId: 'caozhi', text: '文武雙全，千古少有。吾觀太白當不囿於一時，必成大器。' },
                            { authorId: 'libai', text: '@caozhi 陳王謬讚！太白不過一介布衣，何敢與前賢相比。然有誌在胸，必當一展！' }
                        ]
                    },
                ],
                taoyuanming: [
                    {
                        id: 'taoyuanming_1',
                        authorId: 'taoyuanming',
                        text: '種豆南山下，草盛豆苗稀。',
                        image: '🌱🏔️',
                        time: '昨天 09:20',
                        likes: ['libai', 'dufu', 'wangwei', 'menghaoran'],
                        comments: [
                            { authorId: 'libai', text: '淵明兄，何時再釀菊花酒？' },
                            { authorId: 'wangwei', text: '田園詩派之祖，傳世千年！' }
                        ]
                    },
                    {
                        id: 'taoyuanming_2',
                        authorId: 'taoyuanming',
                        text: '今日歸去來，田園將蕪胡不歸？',
                        image: '🏡🌄',
                        time: '3天前',
                        likes: ['libai', 'liuling', 'menghaoran', 'wangwei'],
                        comments: [
                            { authorId: 'libai', text: '何時邀我至東籬下共飲？' },
                            { authorId: 'liuling', text: '淵明歸隱，不為五斗米折腰，真乃高士！' }
                        ]
                    },
                    {
                        id: 'taoyuanming_3',
                        authorId: 'taoyuanming',
                        text: '今朝東籬下賞菊，酌一杯濁酒，頗有韻致。可惜無友共飲，略顯寂寥。',
                        image: '🌼🍶',
                        time: '上週',
                        likes: ['libai', 'liuling', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '待我辭官後，定攜美酒尋淵明兄共賞菊花！' },
                            { authorId: 'dufu', text: '菊花與酒，高潔與豪放，妙哉！' }
                        ]
                    }
                ],
                liuling: [
                    {
                        id: 'liuling_1',
                        authorId: 'liuling',
                        text: '有酒直須飲，無常不待人',
                        image: '🍺☠️',
                        time: '今天 10:15',
                        likes: ['libai', 'taoyuanming', 'hezhizhang'],
                        comments: [
                            { authorId: 'libai', text: '知音！他日共酌！' },
                            { authorId: 'change', text: '仙界瓊漿，更勝凡間酒' },
                            { authorId: 'hezhizhang', text: '劉伶酒量驚人，太白若能與之共飲，定是一場盛事！' }
                        ]
                    },
                    {
                        id: 'liuling_2',
                        authorId: 'liuling',
                        text: '酒徒中人，以酒為號。安能一日無酒，思無所之！',
                        image: '🛏️🍶',
                        time: '昨天 05:30',
                        likes: ['libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '劉兄此言，說到我心坎上了！' },
                            { authorId: 'taoyuanming', text: '酒不醉人人自醉，劉伶之醉，乃心靈之醉！' }
                        ]
                    },
                    {
                        id: 'liuling_3',
                        authorId: 'liuling',
                        text: '命駕上車，載酒樽於車前，使蒼頭馭駕，而擊鼓行歌，縱意極歡。',
                        image: '🛞🥁',
                        time: '上週',
                        likes: ['libai', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '劉伶樂道，吾等之師！來日當效仿之！' },
                            { authorId: 'taoyuanming', text: '酒中真性情，難得糊塗！' }
                        ]
                    }
                ],

                dufu: [
                    {
                        id: 'dufu_1',
                        authorId: 'dufu',
                        text: '聞李太白將辭官，或將至洛陽。若能得見，當面請教，幸甚幸甚！',
                        image: '🗺️📝',
                        time: '3小時前',
                        likes: ['libai', 'menghaoran'],
                        comments: [
                            { authorId: 'libai', text: '杜兄才華，早聞其名。洛陽相見，一言為定' },
                            { authorId: 'menghaoran', text: '李杜二人若能聚首，天下詩人當避其鋒！' }
                        ]
                    },
                    {
                        id: 'dufu_6',
                        authorId: 'dufu',
                        text: '首陽山下購地建屋，費盡心力，終於有了自己的小窩！雖然簡陋，卻是安身立命之所。最近忙著置辦家具，有誰能推薦個靠譜的木匠嗎？#新居落成 #裝修困難戶 #有房一族',
                        image: '🏡🔨',
                        time: '一個月前',
                        likes: ['libai', 'wangwei', 'taoyuanming', 'liuling'],
                        comments: [
                            { authorId: 'taoyuanming', text: '恭喜杜兄有了自己的園子！老夫當年築室東籬下，最是愜意。「種豆南山下，草盛豆苗稀」，杜兄不妨也種些蔬果。' },
                            { authorId: 'dufu', text: '@taoyuanming 淵明兄見教極是！已在後院開闢菜地，種些青菜，望能自給自足。' },
                            { authorId: 'wangwei', text: '洛陽城南有木匠張三，手藝精湛，價格公道，可托我引薦。' },
                            { authorId: 'libai', text: '子美終於有宅了！待我攜酒前來，為你暖居！順便帶上幾箱好酒，塞滿你的酒窖！' }
                        ]
                    },
                    {
                        id: 'dufu_7',
                        authorId: 'dufu',
                        text: '人生大事！剛與楊家小姐完婚，日後有人照顧了[愛心]。岳父大人楊司農為官清廉，內人賢淑溫柔，甚是投緣。此生足矣！#新婚報喜 #脫單 #告別單身貴族',
                        image: '💑👰',
                        time: '兩個月前',
                        likes: ['libai', 'wangwei', 'menghaoran', 'taoyuanming', 'ligui', 'yuzhen'],
                        comments: [
                            { authorId: 'libai', text: '賀！賀！賀！子美終於脫單，可喜可賀！待我帶上三斗好酒登門慶賀！' },
                            { authorId: 'dufu', text: '謝諸位厚愛！婚後定當潛心詩藝，不負眾望！@libai 太白兄，等你的三斗好酒哦！' },
                            { authorId: 'yuzhen', text: '杜郎君與楊家小姐結為夫妻，琴瑟和鳴，必能相濡以沫，白頭偕老！願有情人終成眷屬！' },
                            { authorId: 'ligui', text: '下官與楊司農有舊，聞其愛女賢淑聰慧，杜郎君得此佳偶，實乃前世修來福分！恭喜恭喜！' }
                        ]
                    },
                    {
                        id: 'dufu_5',
                        authorId: 'dufu',
                        text: '放蕩齊趙間，裘馬頗輕狂。春歌叢台上，冬獵青丘旁。這段齊趙之游，頗為愜意！沒想到打獵也有趣上了癮！#新技能get #打獵日常 #富家子弟體驗卡',
                        image: '🏹🐎',
                        time: '三個月前',
                        likes: ['libai', 'liuling', 'menghaoran'],
                        comments: [
                            { authorId: 'libai', text: '子美竟也有輕狂時刻！哈哈，明日一起打獵如何？' },
                            { authorId: 'liuling', text: '打獵需大量體力，不如改為飲酒賞月？我備好美酒等你！' },
                            { authorId: 'dufu', text: '@liuling 劉兄此言極是！獵歸之後，定當登門共飲！' },
                            { authorId: 'menghaoran', text: '杜兄年少有為，文武雙全，令人羨慕！' }
                        ]
                    },
                    {
                        id: 'dufu_4',
                        authorId: 'dufu',
                        text: '洛陽進士考試落第，心情複雜...看來今年又是陪跑選手[苦笑]。先不管了，收拾行囊，準備去兗州看看父親大人。#考試失利 #求安慰 #人生低谷',
                        image: '📝😢',
                        time: '八個月前',
                        likes: ['libai', 'menghaoran', 'wangwei', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '杜兄勿憂！我也屢試不第，如今卻能入翰林。科舉之路非人才之路，真正的才華，自有用武之地！' },
                            { authorId: 'taoyuanming', text: '不為五斗米折腰，落第未必是壞事。杜兄才高八斗，何愁無處施展？' },
                            { authorId: 'dufu', text: '@taoyuanming @libai 二位高人誠懇勸解，子美深感欣慰。然家貧如洗，不得不以科舉求出路...' },
                            { authorId: 'menghaoran', text: '杜兄莫要氣餒，科舉雖重要，但真正的才華終會被發現。放寬心，明年再戰！' }
                        ]
                    },
                    {
                        id: 'dufu_3',
                        authorId: 'dufu',
                        text: '東郡趨庭日，南樓縱目初。浮雲連海岱，平野入青徐。孤嶂秦碑在，荒城魯殿餘。從來多古意，臨眺獨躊躇。#兗州遊記 #探親 #25歲的青春',
                        image: '🏯🌄',
                        time: '八個月前',
                        likes: ['libai', 'taoyuanming', 'wangwei', 'menghaoran', 'yuzhen'],
                        comments: [
                            { authorId: 'taoyuanming', text: '「從來多古意，臨眺獨躊躇」，此情此景，與老夫當年頗為相似。' },
                            { authorId: 'dufu', text: '@taoyuanming 淵明先生詩風高遠，杜某不敢相比。此詩不過年少時塗鴉之作，慚愧慚愧。' },
                            { authorId: 'wangwei', text: '杜兄謙虛了，二十五歲有此詩作，實屬難得。登高望遠，觸景生情，情景交融，妙哉！' },
                            { authorId: 'yuzhen', text: '聞父親為官清廉，百姓稱頌，杜郎君必是傳承家風，他日定成大器！' }
                        ]
                    },
                    {
                        id: 'dufu_2',
                        authorId: 'dufu',
                        text: '岱宗夫如何？齊魯青未了。造化鍾神秀，陰陽割昏曉。蕩胸生層雲，決眥入歸鳥。會當凌絕頂，一覽眾山小。#泰山遊記 #人生必去景點 #一覽眾山小',
                        image: '⛰️🏞️',
                        time: '一年前',
                        likes: ['libai', 'wangwei', 'menghaoran', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '好氣魄！「會當凌絕頂，一覽眾山小」，豪邁非常！須得與杜兄同登泰山，共賞此景！' },
                            { authorId: 'dufu', text: '@libai 太白若能同行，必是人生一大快事！泰山之巔，豪飲一場，何其快哉！' },
                            { authorId: 'menghaoran', text: '杜兄此詩氣勢磅礴，前四句寫景，後四句抒情，層次分明，意境高遠！才華橫溢！' },
                            { authorId: 'wangwei', text: '「蕩胸生層雲，決眥入歸鳥」，想像力豐富，視角獨特，令人驚嘆！[強]' }
                        ]
                    }
                ],

                wangwei: [
                    {
                        id: 'wangwei_1',
                        authorId: 'wangwei',
                        text: '明日入寺聽禪，求一心清淨。紅塵滾滾，不若青燈古佛。',
                        image: '🧘‍♂️🕯️',
                        time: '今天',
                        likes: ['menghaoran', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'menghaoran', text: '維哥近來醉心佛法，詩作卻更有禪意！' },
                            { authorId: 'dufu', text: '王維詩畫相得益彰，佛法滋養，更顯高遠！' }
                        ]
                    }
                ],
                menghaoran: [
                    {
                        id: 'menghaoran_1',
                        authorId: 'menghaoran',
                        text: '春眠不覺曉，處處聞啼鳥。夜來風雨聲，花落知多少？',
                        image: '🌸🐦',
                        time: '今天',
                        likes: ['libai', 'wangwei', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '浩然兄此詩清新自然，如春風拂面！' },
                            { authorId: 'wangwei', text: '此詩一出，知音必多！' }
                        ]
                    },
                    {
                        id: 'menghaoran_2',
                        authorId: 'menghaoran',
                        text: '今日於黃鶴樓啟程前往廣陵，多位故友前來送行。其中一位年輕詩人李白尤為熱情，竟紅了眼眶，揮別之際還匆匆寫下一詩相贈。此子雖年少，才氣過人，日後必成大器。老夫已年過不惑，江湖漂泊多年，如今看到後生如此傾慕，心中頗多感慨。#黃鶴樓送別 #廣陵之行 #後生可畏',
                        image: '🚣‍♂️🏞️',
                        time: '開元十八年三月',
                        likes: ['libai', 'dufu', 'wangwei', 'taoyuanming'],
                        comments: [
                            { authorId: 'wangwei', text: '浩然兄此行必有奇遇，期待佳作。不知李白送兄的詩如何？' },
                            { authorId: 'menghaoran', text: '@wangwei 那小子寫了首「故人西辭黃鶴樓，煙花三月下揚州」，末句「孤帆遠影碧空盡，唯見長江天際流」尤為動人。' },
                            { authorId: 'taoyuanming', text: '離別之情，最是難言。年輕人熱情奔放，老夫當年亦如此。' },
                            { authorId: 'libai', text: '孟夫子言重了，不過是區區拙作。此一別，不知何時再得相見，心中難免失落。' }
                        ]
                    },
                    {
                        id: 'menghaoran_3',
                        authorId: 'menghaoran',
                        text: '三年前初見李太白，此子年僅二十八，卻已才氣縱橫。「神氣高朗，軒軒然若霞舉」，不似常人。彼時我已名滿天下，他卻忐忑前來拜訪，甚是可愛。一番交談，發現此子天資過人，詩才橫溢，遂多加鼓勵。不想他竟寫下「吾愛孟夫子，風流天下聞」之句，老夫聞之一笑。有此後生，詩壇未來必有可期。#遇見李白 #詩壇新秀 #安陸偶遇',
                        image: '🧔‍♂️🍵',
                        time: '開元十五年',
                        likes: ['libai', 'dufu', 'taoyuanming', 'wangwei'],
                        comments: [
                            { authorId: 'libai', text: '初見夫子，如沐春風。夫子寬厚待我，令在下終身難忘！' },
                            { authorId: 'dufu', text: '前輩慧眼識英才！太白之名，後來果然如日中天。' },
                            { authorId: 'wangwei', text: '浩然兄與太白相識，乃詩壇盛事！兩位大才相遇，必有佳話流傳！' },
                            { authorId: 'menghaoran', text: '@wangwei 摩詰兄過獎了。彼時太白年少氣盛，酒量已不凡，我們確實暢飲數日。' }
                        ]
                    },
                    {
                        id: 'menghaoran_4',
                        authorId: 'menghaoran',
                        text: '收到李太白書信，言道欲在江夏相會。此子熱情似火，每每見面必執弟子禮，令老夫既感動又有些不安。近日諸事繁忙，恐難赴約。太白性情中人，只怕會難過許久。唉，年輕人感情用事，不似我等歷經滄桑，看淡聚散。待他閱歷漸豐，自會明白「聚散皆是緣」的道理。#江夏之約 #未能赴約 #後生可畏',
                        image: '📜🤔',
                        time: '開元十七年',
                        likes: ['wangwei', 'taoyuanming', 'dufu'],
                        comments: [
                            { authorId: 'wangwei', text: '浩然兄不必多慮，太白雖熱情似火，但氣量宏大，不會計較這些小事。' },
                            { authorId: 'taoyuanming', text: '年少之時，情感豐沛；年長之後，漸趨淡泊。此乃人生常態，浩然兄不必掛懷。' },
                            { authorId: 'dufu', text: '聽聞太白對夫子極為仰慕，奉為知己。此番未能相見，或有遺憾。' }
                        ]
                    }
                ],
                yutu: [
                    {
                        id: 'yutu_1',
                        authorId: 'yutu',
                        text: '搗藥搗了一整天，手都酸了！主人還要再煉一爐，今晚又要加班了...求問：月宮有五險一金嗎？#搗藥日常 #打工人的日常',
                        image: '🔨🌿',
                        time: '今天 18:45',
                        likes: ['change', 'moon', 'libai', 'xiwangmu'],
                        comments: [
                            { authorId: 'change', text: '好好搗，下次允許你吃一顆。' },
                            { authorId: 'libai', text: '聽聞廣寒宮之藥可得長生，玉兔辛苦了！' },
                            { authorId: 'xiwangmu', text: '五險一金是什麼？瑤池宮沒有這個...' },
                            { authorId: 'yutu', text: '@xiwangmu 我就知道... 這就是傳說中的仙界996啊！😭' }
                        ]
                    },
                    {
                        id: 'yutu_2',
                        authorId: 'yutu',
                        text: '趁主人不在，偷偷許願：好想去人間吃一次胡蘿蔔啊！聽說那裏的胡蘿蔔又甜又脆，比月宮裏的仙草還美味！#吃貨兔的心願 #兔兔想吃胡蘿蔔',
                        image: '🥕🌙',
                        time: '昨天',
                        likes: ['libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '若有機會下凡，定當備上好胡蘿蔔款待！' },
                            { authorId: 'taoyuanming', text: '東籬下種了不少胡蘿蔔，玉兔若來，任君採摘。' },
                            { authorId: 'change', text: '玉兔！我看到了！你居然又偷懶？！' },
                            { authorId: 'yutu', text: '@change 主人饒命！我這就去搗藥！💦' }
                        ]
                    },
                    {
                        id: 'yutu_3',
                        authorId: 'yutu',
                        text: '每逢中秋，都要加班...今年是第4827年了，真是時間過得好快啊！月餅都吃膩了，有沒有新花樣？#中秋加班 #工作4827年 #打工人的辛酸',
                        image: '🥮⏰',
                        time: '上週',
                        likes: ['change', 'libai', 'yangguifei'],
                        comments: [
                            { authorId: 'change', text: '千年萬年，日日如此，修煉之人不計時光。' },
                            { authorId: 'yangguifei', text: '宮中新制五仁月餅，賜你一個解饞。' },
                            { authorId: 'libai', text: '玉兔若厭倦，何不下凡走一遭？' },
                            { authorId: 'yutu', text: '@libai 主人看著我呢，溜不掉的...' }
                        ]
                    }
                ],
                ligui: [
                    {
                        id: 'ligui_1',
                        authorId: 'ligui',
                        text: '今日演奏《霓裳羽衣曲》，楊貴妃翩翩起舞，舉座皆驚。陛下龍顏大悅，賞金十兩！#宮廷演出 #業績達標 #貴妃贊助',
                        image: '🎵💃',
                        time: '今天 21:10',
                        likes: ['yangguifei', 'libai', 'dufu'],
                        comments: [
                            { authorId: 'yangguifei', text: '李樂師技藝超群，堪稱一絕，妾身舞姿能配得上已是萬幸。' },
                            { authorId: 'libai', text: '此曲只應天上有，人間難得幾回聞！何日能一聽龜年先生演奏？' },
                            { authorId: 'dufu', text: '十兩黃金！這是半年俸祿啊，李先生好福氣！' },
                            { authorId: 'ligui', text: '@dufu 哈哈，子美兄別眼紅，下次演出帶你進宮，免費聽！' }
                        ]
                    },
                    {
                        id: 'ligui_2',
                        authorId: 'ligui',
                        text: '收到西域進貢的樂器，音色奇特，正在研習中。準備編入新曲，獻給陛下，不知能得幾分賞賜？#新樂器 #創新曲風 #期待打賞',
                        image: '🪕🎻',
                        time: '昨天',
                        likes: ['yangguifei', 'libai', 'yuzhen'],
                        comments: [
                            { authorId: 'yuzhen', text: '龜年先生才華橫溢，此曲若成，定當請入宮中一展才藝。' },
                            { authorId: 'libai', text: '西域胡樂與唐音結合，必是一絕！龜年兄不負樂師之名！' },
                            { authorId: 'yangguifei', text: '妾身已向陛下推薦，若曲成，必有重賞！' },
                            { authorId: 'ligui', text: '多謝貴妃娘娘提攜，定當精益求精！@yangguifei' }
                        ]
                    },
                    {
                        id: 'ligui_3',
                        authorId: 'ligui',
                        text: '宮中生活，雖榮華富貴，卻身不由己。有時想效太白醉酒狂歌，卻又身份所限，只能暗自嘆息。#宮廷生活 #身不由己 #羨慕李白',
                        image: '👑🔗',
                        time: '一週前',
                        likes: ['libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '龜年兄何必自限？醉後方顯真性情，宮中亦可縱情歌唱！' },
                            { authorId: 'taoyuanming', text: '不如歸去，何必為五斗米折腰？' },
                            { authorId: 'ligui', text: '@taoyuanming 淵明兄說得容易，我可沒田可耕啊！還是乖乖靠手藝吃飯吧...' }
                        ]
                    }
                ],
                yuzhen: [
                    {
                        id: 'yuzhen_1',
                        authorId: 'yuzhen',
                        text: '宮中設宴，邀摩詰相聚。觀其手撫古琴，吟詩作畫，一曲《山水清音》令眾人傾倒。此人才藝絕倫，風度翩翩，難怪世人皆愛之。#才子王維 #一琴一詩一墨 #文藝生活',
                        image: '🎨🎻',
                        time: '昨天 20:30',
                        likes: ['wangwei', 'dufu', 'menghaoran', 'yangguifei'],
                        comments: [
                            { authorId: 'wangwei', text: '承蒙公主厚愛，微臣愧不敢當。古琴一曲，本是向諸位大師學習而來。' },
                            { authorId: 'yangguifei', text: '王維才藝超群，詩中有畫，畫中有詩，宮中諸人，無出其右。' },
                            { authorId: 'libai', text: '王維確實多才，琴、詩、字、畫無不精通，只是詩風過於含蓄，不若豪放派來得痛快淋漓。' },
                            { authorId: 'dufu', text: '太白兄莫要酸了，維兄詩畫雙絕，實乃盛世才子。' }
                        ]
                    },
                    {
                        id: 'yuzhen_2',
                        authorId: 'yuzhen',
                        text: '今日得元丹丘相贈道經一卷，閱之心神俱靜。修道之人，不以物慾為累，不為五斗米折腰，當真心嚮往之。#修道日常 #養心 #塵世浮躁',
                        image: '📜🧘‍♀️',
                        time: '3天前',
                        likes: ['wangwei', 'taoyuanming', 'xiwangmu'],
                        comments: [
                            { authorId: 'xiwangmu', text: '皇室之人能修道，實屬難得。待公主功力漸深，當邀入瑤池一敘。' },
                            { authorId: 'taoyuanming', text: '不為五斗米折腰，此乃高士之風。公主雖居富貴，心卻向道，更是難得。' }
                        ]
                    },
                    {
                        id: 'yuzhen_3',
                        authorId: 'yuzhen',
                        text: '觀李供奉醉後作詩，風姿灑脫，不拘形跡。然其狂言浪語，時有失禮，令宮中侍女皆掩口而笑。好在兄長愛才，不以為忤。#才子李白 #醉酒風波 #宮廷趣事',
                        image: '🥂📝',
                        time: '一週前',
                        likes: ['dufu', 'ligui', 'yangguifei'],
                        comments: [
                            { authorId: 'libai', text: '公主明鑒，微臣醉後失態，深感愧疚。然胸中之氣，不吐不快！' },
                            { authorId: 'yangguifei', text: '李供奉醉態可掬，令妾身也忍俊不禁。' }
                        ]
                    }
                ],
                wangwei: [
                    {
                        id: 'wangwei_1',
                        authorId: 'wangwei',
                        text: '明日入寺聽禪，求一心清淨。紅塵滾滾，不若青燈古佛。',
                        image: '🧘‍♂️🕯️',
                        time: '今天',
                        likes: ['menghaoran', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'menghaoran', text: '維哥近來醉心佛法，詩作卻更有禪意！' },
                            { authorId: 'dufu', text: '王維詩畫相得益彰，佛法滋養，更顯高遠！' }
                        ]
                    },
                    {
                        id: 'wangwei_2',
                        authorId: 'wangwei',
                        text: '辛田勞作，方知農事艱難。山居歲月，日出而作，日落而息，心靈漸趨平和。「未能抛得杜陵居，猶料因依是藥藩。」#終南山隱居 #田園生活 #佛系日常',
                        image: '🌄🏡',
                        time: '昨天 18:15',
                        likes: ['menghaoran', 'taoyuanming', 'dufu'],
                        comments: [
                            { authorId: 'taoyuanming', text: '能體會農事之難，方知百姓之苦。維兄雖為高官，卻能親力親為，難得！' },
                            { authorId: 'menghaoran', text: '山林日子最是愜意。維兄何時歸京？可否與老友一聚？' },
                            { authorId: 'wangwei', text: '@menghaoran 下月便返京，定當登門拜訪，共話詩畫！' }
                        ]
                    },
                    {
                        id: 'wangwei_3',
                        authorId: 'wangwei',
                        text: '「行到水窮處，坐看雲起時」。今日畫《輞川圖》，試以筆墨傳遞心中之境。山水清音，入骨入髓，若能畫盡心中之景，何愁詩畫不傳世？#山水畫 #輞川別業 #心境入畫',
                        image: '🏞️🖌️',
                        time: '三天前',
                        likes: ['dufu', 'yuzhen', 'menghaoran', 'libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'dufu', text: '維兄畫作，詩意盎然。真正做到了詩中有畫，畫中有詩！' },
                            { authorId: 'libai', text: '摩詰兄畫技高超，遠勝於我。只是太過含蓄，少了幾分豪放！' },
                            { authorId: 'yuzhen', text: '王大人畫作如詩，微臣有幸觀摩過，實在令人心馳神往！' },
                            { authorId: 'wangwei', text: '諸位過獎了。畫道無窮，仍需精進。@libai 太白兄豪放，各有千秋，何必相較？' }
                        ]
                    }
                ],
                yangguifei: [
                    {
                        id: 'yangguifei_1',
                        authorId: 'yangguifei',
                        text: '今日李供奉一襲白衣入宮，為妾身賦《清平調》三首，字字珠璣，令人心醉。細讀「名花傾國兩相歡，長得君王帶笑看」，不禁面熱心跳。此人才華橫溢，風流倜儻，不愧謫仙之名。#才子李白 #清平調 #驚為天人',
                        image: '👸🌸',
                        time: '今天 16:30',
                        likes: ['libai', 'ligui', 'yuzhen'],
                        comments: [
                            { authorId: 'libai', text: '承蒙娘娘厚愛，清平調三首皆為娘娘所作，娘娘國色天香，令微臣靈感湧動，下筆自成章。' },
                            { authorId: 'ligui', text: '李供奉有幸為娘娘作詩，此乃千載難逢之機遇。' },
                            { authorId: 'yuzhen', text: '這位李供奉，大膽至極！竟敢以美人香肩之喻，幸好兄長未見此詩...' },
                            { authorId: 'yangguifei', text: '@yuzhen 公主言重了，詩中有情，意境高雅，陛下已閱並甚是喜歡呢。' }
                        ]
                    },
                    {
                        id: 'yangguifei_2',
                        authorId: 'yangguifei',
                        text: '宮中新得西域香料，親手調配成膏，擦於耳後，清新怡人。因著李供奉所贈《清平調》中「雲想衣裳花想容」之句，遂取名「花想容」。今日初用，諸人皆稱絕妙。#新香製成 #花想容 #西域珍品',
                        image: '🌺💋',
                        time: '昨天',
                        likes: ['libai', 'yuzhen', 'ligui'],
                        comments: [
                            { authorId: 'libai', text: '娘娘以詩句為香名，令微臣蓬蓽生輝！此香必香飄萬里，流芳百世！' },
                            { authorId: 'yangguifei', text: '@libai 太白多才，香名出自君口，若有閒暇，可入宮一敘，共品新香。' },
                            { authorId: 'yuzhen', text: '貴妃所製香膏，必是絕世佳品。公主亦愛香道，定要向貴妃討教一二。' }
                        ]
                    },
                    {
                        id: 'yangguifei_3',
                        authorId: 'yangguifei',
                        text: '夜深人靜，獨坐宮中，翻閱李供奉所贈詩集，每每讀至情深處，不禁掩卷長嘆。此人纵情山水，醉心詩酒，全然不似庸俗文人，真乃天人也。可惜朝中不識其才，使其鬱鬱不得志。#夜讀李白 #月下思緒 #知音難覓',
                        image: '📜🌙',
                        time: '三天前',
                        likes: ['libai', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '娘娘深夜讀拙作，令微臣惶恐。「天生我材必有用」，不敢妄言功名，但求娘娘能解微臣之意。' },
                            { authorId: 'yangguifei', text: '@libai 君才華橫溢，必不會埋沒。妾身已向陛下進言，望君得展宏圖。' },
                            { authorId: 'yuzhen', text: '貴妃懂得欣賞才華，李供奉不負盛名。若言才華橫溢，王維亦是不遑多讓。' }
                        ]
                    }
                ],

                xiwangmu: [
                    {
                        id: 'xiwangmu_1',
                        authorId: 'xiwangmu',
                        text: '今日瑤池設宴，群仙歡聚。竟聽聞人間有一名叫李白的凡人，詩才超凡，可謂謫仙下凡。好奇之下，遂隔空觀之，果然風姿傑出，才華橫溢，不似凡人。#瑤池仙宴 #人間謫仙 #李白軼事',
                        image: '👑🌟',
                        time: '今天 00:01',
                        likes: ['change', 'yutu', 'moon', 'libai'],
                        comments: [
                            { authorId: 'libai', text: '西王母娘娘垂青，小仙不勝榮幸！若有機緣，願一嚐仙界瓊漿玉液，以慰凡心。' },
                            { authorId: 'change', text: '此人確實才華超凡，娘娘若有興趣，不如邀他參加蟠桃盛宴？' },
                            { authorId: 'xiwangmu', text: '@change 倒是個好主意。待他緣法到時，自有機會入我瑤池。' },
                            { authorId: 'yutu', text: '主人說李白那首《把酒問月》寫得極好，說他若在天上，必是嫦娥姐姐的知音！' }
                        ]
                    },
                    {
                        id: 'xiwangmu_2',
                        authorId: 'xiwangmu',
                        text: '三千年一開的蟠桃又熟了，正為蟠桃盛宴做準備。今次有意邀幾位有緣的凡人同赴盛宴，吾觀李太白與陶淵明皆有仙骨，可入吾名單。#蟠桃盛宴 #仙凡共宴 #三千年一開',
                        image: '🍑💫',
                        time: '昨天',
                        likes: ['change', 'yutu', 'libai', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '蟠桃盛宴！不知何年何月，才有幸一睹瑤池仙境？' },
                            { authorId: 'xiwangmu', text: '@libai 時機未到，心急何用？且先在人間多作佳詩，積累功德，自有機緣。' },
                            { authorId: 'taoyuanming', text: '多謝西王母厚愛，然淵明只愛東籬菊花，不慕蟠桃仙果。' },
                            { authorId: 'xiwangmu', text: '@taoyuanming 此言大膽！吾蟠桃乃九霄珍品，食之延年益壽。汝且莫忙拒絕，日後或有緣法。' }
                        ]
                    },
                    {
                        id: 'xiwangmu_3',
                        authorId: 'xiwangmu',
                        text: '人間李白作《清平調》三首，竟將「雲想衣裳花想容」比作楊貴妃。吾觀此詩，實是絕妙！不知人間美人能有幾分似我仙顏？略施法術，令其夢中一見吾真容，不知會有何等驚豔之語？#仙顏傾城 #戲弄凡人 #李白入夢',
                        image: '👸✨',
                        time: '三天前',
                        likes: ['change', 'yutu', 'libai', 'yangguifei'],
                        comments: [
                            { authorId: 'libai', text: '昨夜夢中見一仙女，衣若彩雲，容若春花，光華照人，不似凡物。醒後猶覺心神恍惚，不知何人入夢？' },
                            { authorId: 'xiwangmu', text: '@libai 機緣巧合，夢中所見，或許便是瑤池主人。' },
                            { authorId: 'yangguifei', text: '西王母娘娘仙顏絕世，妾身雖得太白誇讚，也不敢與仙子相比。' },
                            { authorId: 'dufu', text: '太白竟得見西王母入夢，此乃千載奇緣！若能得詩一首，當傳頌千古！' }
                        ]
                    }
                ],
                caozhi: [
                    {
                        id: 'caozhi_1',
                        authorId: 'caozhi',
                        text: '千載之後，聞人間出了個李太白，詩才橫溢，被稱作「詩仙」。吾在九泉之下，讀其《將進酒》，有「陳王昔時宴平樂，斗酒十千恣歡謔」之句，竟是提及我當年盛事！心有戚戚，遂寫和詩一首。#跨越千年 #詩仙李白 #陳王曹植',
                        image: '🤴📜',
                        time: '今天 03:21',
                        likes: ['libai', 'dufu', 'taoyuanming', 'wangwei'],
                        comments: [
                            { authorId: 'libai', text: '曹子建乃千古才子，七步成詩，驚才絕豔！不想竟能跨越時空，與吾唱和，何其幸哉！' },
                            { authorId: 'caozhi', text: '@libai 子建生前，才高卻命苦。今見太白才名，心中甚慰。然需謹記，才華橫溢者，往往命途多舛。' },
                            { authorId: 'taoyuanming', text: '曹陳王與李太白隔空相和，此乃千古奇緣！' },
                            { authorId: 'dufu', text: '陳王與太白齊名，皆為千古才子。然陳王薄命，願太白不蹈覆轍。' }
                        ]
                    },
                    {
                        id: 'caozhi_2',
                        authorId: 'caozhi',
                        text: '今讀李太白《蜀道難》，有「白帝城中雲出門，白帝城下雨翻盆」之句，想起當年吾過三峽，亦有「水何澹澹，山島竦峙」之感。相隔五百載，詩情竟如此契合，真可謂心有靈犀。#詩魂相通 #山水情懷 #古今共鳴',
                        image: '⛰️🌊',
                        time: '昨天',
                        likes: ['libai', 'wangwei', 'dufu'],
                        comments: [
                            { authorId: 'libai', text: '曹公過蜀時有詩，不想與吾所見竟有巧合。詩者，心靈相通，不分古今！' },
                            { authorId: 'caozhi', text: '@libai 山川不改，人心相通。太白所見之景，恰是子建當年所歷。詩心相契，豈止偶然！' },
                            { authorId: 'wangwei', text: '兩代詩人，隔空唱和，皆因對自然之美的體悟相通。' },
                            { authorId: 'dufu', text: '陳王與太白隔空唱和，此乃千古奇緣，令人嘆為觀止！' }
                        ]
                    },
                    {
                        id: 'caozhi_3',
                        authorId: 'caozhi',
                        text: '聞李太白醉酒放言，自稱天上謫仙。吾當年亦因酒後狂言，得罪兄長，招致大禍。凡間歲月如梭，千年已過，唯願太白戒我前車之鑑，莫因才高氣傲，自取其禍。#前車之鑑 #酒後狂言 #才子之禍',
                        image: '🍷⚠️',
                        time: '一週前',
                        likes: ['libai', 'dufu', 'taoyuanming'],
                        comments: [
                            { authorId: 'libai', text: '多謝子建提醒！然天生我才必有用，不能為世俗所困。若能豁達如子建，已是幸事。' },
                            { authorId: 'caozhi', text: '@libai 吾非勸君隱忍，只是感同身受。太白若能保全性命，流芳百世，亦是一樁美事。' },
                            { authorId: 'dufu', text: '陳王遺言，發人深省。太白宜謹記在心，以保全身，留萬世詩篇。' }
                        ]
                    }
                ],
                change: [
                    {
                        id: 'change_1',
                        authorId: 'change',
                        text: '廣寒宮千年，日日望明月，夜夜對瑤琴。今日偶聽人間李白作《把酒問月》，竟把酒相邀，甚是有趣。若能邀他上天一聚，不知有何韻事？#千年孤寂 #廣寒宮主 #月中生活',
                        image: '🌕🙎‍♀️',
                        time: '今天 00:30',
                        likes: ['yutu', 'xiwangmu', 'libai'],
                        comments: [
                            { authorId: 'libai', text: '嫦娥仙子垂青，不勝榮幸！若得一見廣寒宮，當作千古佳詩以記之！' },
                            { authorId: 'yutu', text: '主人最近常提起李白呢，聽說他還寫了《月下獨酌》，邀明月共飲！' },
                            { authorId: 'xiwangmu', text: '嫦娥妹妹若有意，待下次蟠桃會，可請此凡人一同赴宴。' },
                            { authorId: 'change', text: '@xiwangmu 多謝娘娘美意，不過此人尚未功德圓滿，恐怕時機未到。' }
                        ]
                    },
                    {
                        id: 'change_2',
                        authorId: 'change',
                        text: '今日教玉兔製作月餅，不料這小兔手生，灑了一地桂花糖。罰它多搗三日靈藥，氣得直跺腳。旁觀一番，竟也覺有趣，千年寂寞，有此伴侶，也是一樂。#玉兔搗藥 #師徒日常 #月宮趣事',
                        image: '🐇🌸',
                        time: '昨天',
                        likes: ['yutu', 'xiwangmu', 'libai'],
                        comments: [
                            { authorId: 'yutu', text: '主人明明是故意刁難我！那桂花糖根本就放在不穩的地方嘛！' },
                            { authorId: 'change', text: '@yutu 還敢頂嘴，看來三日不夠，改為五日！' },
                            { authorId: 'libai', text: '嫦娥與玉兔之情，宛如天上人間一景，令人神往！' }
                        ]
                    },
                    {
                        id: 'change_3',
                        authorId: 'change',
                        text: '凡人常言「月有陰晴圓缺，人有悲歡離合」，卻不知月宮之中，歲月凝固，永無變化。千年歲月，不知今夕何夕，偶爾望見人間春花秋月，婚嫁喜慶，不禁唏噓。若非當年爭強好勝，何至於此？#後悔當初 #千年孤寂 #人間值得',
                        image: '🌙💔',
                        time: '三天前',
                        likes: ['yutu', 'xiwangmu', 'libai'],
                        comments: [
                            { authorId: 'xiwangmu', text: '嫦娥妹妹莫要傷感，當年若非如此，也不會成仙。天道輪迴，皆有定數。' },
                            { authorId: 'yutu', text: '主人別難過，有玉兔陪著你呢！我偷偷告訴你，我昨天藏了一壇桂花酒...' },
                            { authorId: 'libai', text: '「嫦娥應悔偷靈藥，碧海青天夜夜心」，仙子一人獨居廣寒，確實令人唏噓。' },
                            { authorId: 'change', text: '@libai 前塵往事，不提也罷。聽聞你醉酒對月，倒是有趣，待你功成圓滿，或可來月宮一敘。' }
                        ]
                    },
                    {
                        id: 'change_4',
                        authorId: 'change',
                        text: '千年前遺落人間的那面銅鏡，竟被一名凡人拾得。每當月圓之夜，我透過此鏡與那人心靈相通，得知人間百態。此人風流倜儻，才華橫溢，對月常飲，不知可是傳說中的謫仙人李太白？#心靈相通 #隔空對飲 #謫仙傳說',
                        image: '🪞✨',
                        time: '一週前',
                        likes: ['yutu', 'libai'],
                        comments: [
                            { authorId: 'libai', text: '原來仙子知我心！常言道「舉頭望明月，低頭思故鄉」，不知嫦娥可有思凡之心？' },
                            { authorId: 'change', text: '@libai 思凡不敢言，但看你對月痴情，倒也有幾分契合。那面銅鏡若在你手，當珍藏之。' },
                            { authorId: 'yutu', text: '主人與李白心靈相通，真是奇妙的緣分！' }
                        ]
                    }
                ],

            };
            
            // 返回角色的朋友圈，如果沒有則返回空陣列
            return momentsDB[characterId] || [];
        }
        
        // 獲取當前系統時間
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return { hours, minutes, timeString: `${hours}:${minutes}` };
        }



        // 電池管理系統
        class BatteryManager {
            constructor() {
                this.batteryLevel = 65; // 初始電量65%
                this.maxLevel = 100;
                this.minLevel = 1;
                this.drainRate = 0.5; // 每分鐘掉0.5%
            }
            
            // 初始化電池管理
            initialize() {
                this.updateAllBatteryDisplays();
                
                // 每分鐘更新電池電量
                setInterval(() => {
                    this.drainBattery();
                    this.updateAllBatteryDisplays();
                }, 60000);
            }
            
            // 電池放電
            drainBattery() {
                this.batteryLevel = Math.max(this.minLevel, this.batteryLevel - this.drainRate);
                
                // 當電量低於20%時，減慢放電速度
                if (this.batteryLevel < 20) {
                    this.drainRate = 0.2;
                }
            }
            
            // 更新全局電池顯示
            updateAllBatteryDisplays() {
                // 只更新全局狀態欄中的電池
                const globalBatteryLevel = document.querySelector('.global-status-bar .battery-level');
                const globalBatteryText = document.querySelector('.global-status-bar .battery-text');
                
                const roundedLevel = Math.round(this.batteryLevel);
                
                if (globalBatteryLevel) {
                    globalBatteryLevel.style.width = `${roundedLevel}%`;
                    
                    // 根據電量改變顏色
                    if (roundedLevel < 20) {
                        globalBatteryLevel.style.backgroundColor = '#ff4444'; // 紅色
                    } else if (roundedLevel < 50) {
                        globalBatteryLevel.style.backgroundColor = '#ff8800'; // 橙色
                    } else {
                        globalBatteryLevel.style.backgroundColor = 'white'; // 正常顏色
                    }
                }
                
                if (globalBatteryText) {
                    globalBatteryText.textContent = roundedLevel.toString();
                }
            }
            
            // 獲取當前電量
            getCurrentLevel() {
                return Math.round(this.batteryLevel);
            }
        }
        
        // 創建電池管理器實例
        const batteryManager = new BatteryManager();
        
        // 初始化並持續更新狀態欄時間
        function initializeStatusBarTime() {
            function updateStatusBarTime() {
                const currentTime = getCurrentTime();
                // 只更新全局狀態欄
                const globalStatusBarTime = document.querySelector('.global-status-bar .status-bar-left');
                if (globalStatusBarTime) {
                    globalStatusBarTime.textContent = currentTime.timeString;
                }
            }
            
            // 立即更新一次
            updateStatusBarTime();
            
            // 每分鐘更新一次
            setInterval(updateStatusBarTime, 60000);
        }
        
        // Emoji数据
        const emojiData = [
            "😊", "😃", "😄", "😁", "😆", "😅", "🤣", "😂", "🙂", "🙃", 
            "😉", "😇", "🥰", "😍", "🤩", "😘", "😗", "😚", "😙", "😋", 
            "😛", "😜", "🤪", "😝", "🤑", "🤗", "🤭", "🤫", "🤔", "🤐", 
            "🤨", "😐", "😑", "😶", "😏", "😒", "🙄", "😬", "🤥", "😌", 
            "😔", "😪", "🤤", "😴", "😷", "🤒", "🤕", "🤢", "🤮", "🤧",
            "😵", "🤯", "🤠", "🥳", "😎", "🤓", "🧐", "😕", "😟", "🙁", 
            "☹️", "😮", "😯", "😲", "😳", "🥺", "😦", "😧", "😨", "😰", 
            "😥", "😢", "😭", "😱", "😖", "😣", "😞", "😓", "😩", "😫", 
            "🥱", "😤", "😡", "😠", "🤬", "👋", "🖐️", "✋", "🙏", "👏",
            "👍", "👎", "👊", "✊", "🤛", "🤜", "🤝", "🙌", "👐", "🤲",
            "❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔",
            "🍷", "🍸", "🍹", "🍺", "🍻", "🥂", "🥃", "🍶", "🥛", "🍵",
            "🥴", "🥺", "😭", "😂", "😅", "🤣", "🙃", "😘", "😍", "🥰"
        ];
        

        
        // @功能相關變量
        let mentionState = {
            isActive: false,
            currentAtPosition: -1,
            searchTerm: ''
        };
        
        // 生成@某人列表
        function generateMentionList(searchTerm = '') {
            const currentGroup = CONFIG.groups[groupManager.currentGroup];
            const members = currentGroup.members.filter(id => 
                characters[id] && id !== 'user'
            );
            
            // 根據搜索詞過濾
            const filteredMembers = members.filter(id => {
                const character = characters[id];
                return character.name.includes(searchTerm);
            });
            
            const mentionPopup = document.getElementById('mentionPopup');
            mentionPopup.innerHTML = '';
            
            filteredMembers.forEach(id => {
                const character = characters[id];
                const item = document.createElement('div');
                item.className = 'mention-item';
                item.setAttribute('data-character-id', id);
                
                item.innerHTML = `
                    <div class="mention-avatar">${character.avatar}</div>
                    <div class="mention-name">${character.name}</div>
                `;
                
                item.addEventListener('click', () => {
                    insertMention(id, character.name);
                });
                
                mentionPopup.appendChild(item);
            });
            
            return filteredMembers.length > 0;
        }
        
        // 插入@某人
        function insertMention(characterId, characterName) {
            const inputBox = document.getElementById('messageInput');
            const text = inputBox.value;
            const atPosition = mentionState.currentAtPosition;
            
            // 構建新的文本，替換@和搜索詞
            const beforeAt = text.substring(0, atPosition);
            const afterAt = text.substring(atPosition + 1 + mentionState.searchTerm.length);
            const mention = `@${characterName} `;
            
            inputBox.value = beforeAt + mention + afterAt;
            inputBox.focus();
            
            // 設置光標位置
            const newPosition = atPosition + mention.length;
            inputBox.setSelectionRange(newPosition, newPosition);
            
            // 隱藏@面板
            hideMentionPopup();
            
            console.log(`插入@提及: ${characterName}`);
        }
        
        // 顯示@某人面板
        function showMentionPopup() {
            // 私聊模式下不顯示@提示面板
            if (isPrivateChatMode()) {
                return;
            }
            
            const mentionPopup = document.getElementById('mentionPopup');
            mentionPopup.style.display = 'block';
            
            // 隱藏其他面板
            document.getElementById('emojiPanel').style.display = 'none';
            document.getElementById('functionPanel').style.display = 'none';
        }
        
        // 隱藏@某人面板
        function hideMentionPopup() {
            const mentionPopup = document.getElementById('mentionPopup');
            mentionPopup.style.display = 'none';
            mentionState.isActive = false;
            mentionState.currentAtPosition = -1;
            mentionState.searchTerm = '';
        }
        
        // 處理@功能的輸入
        function handleMentionInput(inputBox) {
            const text = inputBox.value;
            const cursorPosition = inputBox.selectionStart;
            
            // 查找最近的@符號
            let atPosition = -1;
            for (let i = cursorPosition - 1; i >= 0; i--) {
                if (text[i] === '@') {
                    atPosition = i;
                    break;
                } else if (text[i] === ' ' || text[i] === '\n') {
                    break;
                }
            }
            
            if (atPosition !== -1) {
                // 找到@符號，提取搜索詞
                const searchTerm = text.substring(atPosition + 1, cursorPosition);
                
                // 檢查搜索詞是否有效（不包含空格或特殊字符）
                if (!/\s/.test(searchTerm)) {
                    mentionState.isActive = true;
                    mentionState.currentAtPosition = atPosition;
                    mentionState.searchTerm = searchTerm;
                    
                    if (generateMentionList(searchTerm)) {
                        showMentionPopup();
                    } else {
                        hideMentionPopup();
                    }
                } else {
                    hideMentionPopup();
                }
            } else {
                hideMentionPopup();
            }
        }
        
        // 從消息中提取@提及的角色
        function extractMentions(message) {
            const mentions = [];
            const mentionRegex = /@([^\s@]+)/g;
            let match;
            
            while ((match = mentionRegex.exec(message)) !== null) {
                const mentionedName = match[1];
                // 根據名字找到角色ID
                for (const id in characters) {
                    if (characters[id].name === mentionedName) {
                        mentions.push({
                            id: id,
                            name: mentionedName,
                            fullMatch: match[0]
                        });
                        break;
                    }
                }
            }
            
            return mentions;
        }
        
        // 高亮消息中的@提及
        function highlightMentions(message) {
            return message.replace(/@([^\s@]+)/g, '<span class="mention-text">@$1</span>');
        }
        
        // 點擊頭像@某人
        function mentionCharacter(characterId) {
            const character = characters[characterId];
            if (!character) return;
            
            const inputBox = document.getElementById('messageInput');
            const currentText = inputBox.value;
            const mention = `@${character.name} `;
            
            // 如果輸入框為空或最後沒有空格，添加@提及
            if (currentText === '' || currentText.endsWith(' ')) {
                inputBox.value = currentText + mention;
            } else {
                inputBox.value = currentText + ' ' + mention;
            }
            
            inputBox.focus();
            inputBox.setSelectionRange(inputBox.value.length, inputBox.value.length);
            
            console.log(`通過點擊頭像@了 ${character.name}`);
        }
        
        // 打开朋友圈的全局函数
        function openMoments() {
            momentsManager.openMoments();
        }
        
        // 向面板添加Emoji
        function populateEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanel.innerHTML = ''; // 清空面板
            
            emojiData.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => {
                    sendEmoji(emoji);
                });
                emojiPanel.appendChild(emojiItem);
            });
        }
        
        // 发送Emoji消息
        function sendEmoji(emoji) {
            addMessage({
                type: 'message',
                character: 'user',
                content: emoji,
                contentType: 'text'
            });
            
            // 隐藏emoji面板
            toggleEmojiPanel(false);
            
            // 觸發AI回應
            setTimeout(() => {
                generateAIResponses(emoji);
            }, 1000);
        }
        
        // 显示/隐藏emoji面板
        function toggleEmojiPanel(show) {
            const emojiPanel = document.getElementById('emojiPanel');
            if (show) {
                emojiPanel.style.display = 'flex';
            } else {
                emojiPanel.style.display = 'none';
            }
        }
      
        // 初始化登录表单状态
        function initializeLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                // 确保表单初始状态为禁用
                loginForm.classList.add('form-disabled');
                console.log('登錄表單初始化為禁用狀態');
            }
        }
        
        // 确认阅读功能 - 全局函数
        function confirmReading() {
            const confirmBtn = document.getElementById('confirmBtn');
            const confirmText = document.getElementById('confirmText');
            const loginForm = document.getElementById('loginForm');
            
            console.log('確認閱讀按鈕被點擊'); // 调试信息
            console.log('登錄表單元素:', loginForm); // 调试信息
            
            // 标记为已确认
            confirmBtn.classList.add('confirmed');
            confirmText.innerHTML = '✅ 已確認閱讀';
            confirmBtn.disabled = true;
            
            // 启用登录表单
            if (loginForm) {
                loginForm.classList.remove('form-disabled');
                console.log('已移除 form-disabled 類'); // 调试信息
                
                // 强制刷新所有输入元素的样式
                const inputs = loginForm.querySelectorAll('input, select, button');
                inputs.forEach(input => {
                    input.style.opacity = '1';
                    input.style.pointerEvents = 'auto';
                    input.style.cursor = 'auto';
                    input.style.backgroundColor = '';
                    input.disabled = false;
                });
                console.log('已啟用', inputs.length, '個表單元素'); // 调试信息
            }
            
            // 添加确认动画
            confirmBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                confirmBtn.style.transform = 'scale(1)';
            }, 200);
        }
        
        // 生成銀河系粒子效果
        function createGalaxyParticles() {
            const galaxyContainer = document.querySelector('.galaxy-container');
            const numberOfArms = 2; // 兩條主要螺旋臂（更符合銀河系實際結構）
            
            // 創建螺旋臂
            for (let armIndex = 0; armIndex < numberOfArms; armIndex++) {
                const spiralArm = document.createElement('div');
                spiralArm.className = 'spiral-arm';
                
                // 大幅擴展螺旋臂範圍，增加更多段落
                for (let segment = 0; segment < 8; segment++) {
                    const particlesInSegment = 35 - segment * 2; // 更多粒子，衰減更緩慢
                    
                    for (let i = 0; i < particlesInSegment; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        
                        // 大幅擴展銀河系半徑範圍
                        const baseRadius = 60 + segment * 120; // 從60px開始，每段120px間隔
                        const spiralTightness = 0.15; // 稍微降低螺旋緊密度
                        const armAngle = armIndex * Math.PI; // 180度間隔的兩條臂
                        
                        // 在每個段落內隨機分佈粒子
                        const randomRadius = baseRadius + (Math.random() - 0.5) * 60;
                        const randomAngle = (i / particlesInSegment) * Math.PI * 1.2 + (Math.random() - 0.5) * 0.8;
                        
                        // 對數螺旋公式
                        const spiralAngle = armAngle + randomAngle + spiralTightness * Math.log(randomRadius / 60);
                        
                        const x = Math.cos(spiralAngle) * randomRadius;
                        const y = Math.sin(spiralAngle) * randomRadius;
                        
                        particle.style.left = x + 'px';
                        particle.style.top = y + 'px';
                        
                        // 根據距離中心的遠近決定粒子大小和亮度
                        const distanceFromCenter = Math.sqrt(x*x + y*y);
                        const intensity = Math.max(0.15, 1 - distanceFromCenter / 800); // 擴大亮度衰減範圍
                        
                        // 分配粒子大小，中心區域更大更亮
                        if (segment < 3) {
                            const rand = Math.random();
                            if (rand < 0.3) {
                                particle.classList.add('medium');
                            } else if (rand < 0.6) {
                                particle.classList.add('large');
                            } else {
                                particle.classList.add('small');
                            }
                        } else if (segment < 6) {
                            const rand = Math.random();
                            if (rand < 0.7) {
                                particle.classList.add('small');
                            } else {
                                particle.classList.add('medium');
                            }
                        } else {
                            particle.classList.add('small');
                        }
                        
                        // 根據位置添加顏色變化
                        if (Math.random() < 0.25) {
                            const colorChance = Math.random();
                            if (segment < 3 && colorChance < 0.4) {
                                particle.classList.add('gold'); // 中心區域金色
                            } else if (segment < 5 && colorChance < 0.6) {
                                particle.classList.add('blue'); // 中等距離藍色星體
                            } else {
                                particle.classList.add('colored'); // 外圍紫色星體
                            }
                        }
                        
                        // 設置透明度
                        particle.style.opacity = intensity * (0.5 + Math.random() * 0.5);
                        particle.style.animationDelay = Math.random() * 3 + 's';
                        
                        spiralArm.appendChild(particle);
                    }
                }
                
                // 為每條螺旋臂添加更多散亂的星體，延伸到更遠的距離
                for (let i = 0; i < 25; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle small';
                    
                    const randomRadius = 100 + Math.random() * 600; // 大幅擴展到600px範圍
                    const randomAngle = armIndex * Math.PI + (Math.random() - 0.5) * Math.PI * 0.8;
                    
                    const x = Math.cos(randomAngle) * randomRadius;
                    const y = Math.sin(randomAngle) * randomRadius;
                    
                    particle.style.position = 'absolute';
                    particle.style.left = `calc(50% + ${x}px)`;
                    particle.style.top = `calc(50% + ${y}px)`;
                    particle.style.opacity = Math.max(0.1, Math.random() * 0.6 + 0.1);
                    particle.style.animationDelay = Math.random() * 3 + 's';
                    
                    // 遠距離的彩色星體
                    if (Math.random() < 0.15) {
                        const colorType = Math.random();
                        if (colorType < 0.5) {
                            particle.classList.add('blue');
                        } else {
                            particle.classList.add('colored');
                        }
                    }
                    
                    spiralArm.appendChild(particle);
                }
                
                galaxyContainer.appendChild(spiralArm);
            }
            
            // 增加背景星星來填充擴展的空間
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.className = 'particle small';
                star.style.position = 'absolute';
                
                // 确保星星分布更均匀，避免聚集
                const x = (Math.random() * 150 - 75); // -75% 到 +75%
                const y = (Math.random() * 150 - 75);
                star.style.left = `calc(50% + ${x}vw)`;
                star.style.top = `calc(50% + ${y}vh)`;
                
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.opacity = Math.random() * 0.4 + 0.1;
                
                // 背景彩色星星
                if (Math.random() < 0.08) {
                    const colorType = Math.random();
                    if (colorType < 0.4) {
                        star.classList.add('blue');
                    } else if (colorType < 0.7) {
                        star.classList.add('colored');
                    } else {
                        star.classList.add('gold');
                    }
                }
                
                galaxyContainer.appendChild(star);
            }
            
            // 擴展銀河中心區域，但不完全遮擋螺旋臂
            for (let i = 0; i < 60; i++) {
                const centralStar = document.createElement('div');
                centralStar.className = 'particle';
                centralStar.style.position = 'absolute';
                
                const centerRadius = Math.random() * 80; // 擴展中心範圍到80px
                const centerAngle = Math.random() * Math.PI * 2;
                
                const x = Math.cos(centerAngle) * centerRadius;
                const y = Math.sin(centerAngle) * centerRadius;
                
                centralStar.style.left = `calc(50% + ${x}px)`;
                centralStar.style.top = `calc(50% + ${y}px)`;
                
                // 中心區域星體更大更亮
                const rand = Math.random();
                if (rand < 0.4) {
                    centralStar.classList.add('large');
                } else if (rand < 0.7) {
                    centralStar.classList.add('medium');
                } else {
                    centralStar.classList.add('small');
                }
                
                // 中心區域金色星體更多
                if (Math.random() < 0.5) {
                    centralStar.classList.add('gold');
                } else if (Math.random() < 0.3) {
                    centralStar.classList.add('colored');
                }
                
                centralStar.style.opacity = 0.7 + Math.random() * 0.3;
                centralStar.style.animationDelay = Math.random() * 3 + 's';
                
                galaxyContainer.appendChild(centralStar);
            }
            
            // 添加外圍環狀星體，進一步擴展銀河系可見範圍
            for (let ring = 0; ring < 3; ring++) {
                const ringRadius = 200 + ring * 100; // 缩小环的半径：200px, 300px, 400px
                const starsInRing = 20 - ring * 5; // 每個環的星體數量遞減
                
                for (let i = 0; i < starsInRing; i++) {
                    const star = document.createElement('div');
                    star.className = 'particle small';
                    star.style.position = 'absolute';
                    
                    const angle = (i / starsInRing) * Math.PI * 2 + (Math.random() - 0.5) * 0.5;
                    const radius = ringRadius + (Math.random() - 0.5) * 50;
                    
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    
                    star.style.left = `calc(50% + ${x}px)`;
                    star.style.top = `calc(50% + ${y}px)`;
                    star.style.opacity = Math.max(0.1, 0.4 - ring * 0.1);
                    star.style.animationDelay = Math.random() * 3 + 's';
                    
                    // 外圍環更多藍色星體
                    if (Math.random() < 0.2) {
                        star.classList.add('blue');
                    }
                    
                    galaxyContainer.appendChild(star);
                }
            }
            
            console.log('大尺寸銀河系螺旋臂結構已生成 - 半徑達800px的壯麗銀河系，總計約600+個星體');
        }
        
        // App圖標點擊處理函數
        function handleAppIconClick() {
            const appIconContainer = document.getElementById('appIconContainer');
            const loginContainer = document.getElementById('loginContainer');
            const universalContainer = document.getElementById('appUniversalContainer');
            
            console.log('App图标被点击');
            console.log('Elements found:', {
                appIconContainer: !!appIconContainer,
                loginContainer: !!loginContainer,
                universalContainer: !!universalContainer
            });
            
            // 添加消失動畫類
            appIconContainer.classList.add('disappearing');
            
            // 等待圖標消失動畫完成後顯示登入界面
            setTimeout(() => {
                // 隱藏app圖標
                appIconContainer.style.display = 'none';
                
                // 顯示父容器（带阴影效果）
                universalContainer.classList.add('show');
                
                // 直接顯示登入界面
                loginContainer.style.display = 'flex';
                
                console.log('登录界面应该已显示');
                
            }, 400); // 圖標消失動畫時間
        }
        
        // 啟動應用
        window.onload = function() {
            console.log('應用開始初始化...');
            
            // 創建銀河系背景效果
            createGalaxyParticles();
            
            // 設置app圖標點擊事件
            const appIcon = document.getElementById('appIcon');
            if (appIcon) {
                appIcon.addEventListener('click', handleAppIconClick);
                console.log('App圖標點擊事件已設置');
            }
            
            // 初始化登入管理器
            loginManager.init();
            
            // 页面加载完成后初始化登录表单
            initializeLoginForm();
            
            
            
            // 設置聊天輸入功能
            setupChatInput();
            
            // 群組標題由進入聊天時直接設置，無需在初始化時處理
            console.log('應用初始化完成，群組標題將在進入聊天時設置');
            
            // 設置UI交互
            setupUIInteractions();
            
            // 設置群組列表功能
            setupGroupListInteractions();
            
            // 初始化emoji面板
            populateEmojiPanel();
            
            console.log('應用初始化完成');
            
            // 設置emoji按鈕點擊事件
            const emojiBtn = document.getElementById('emojiBtn');
            if (emojiBtn) {
                emojiBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                const emojiPanel = document.getElementById('emojiPanel');
                const functionPanel = document.getElementById('functionPanel');
                
                                    // 關閉功能面板和@面板，顯示或隱藏emoji面板
                functionPanel.style.display = 'none';
                hideMentionPopup();
                const isVisible = emojiPanel.style.display === 'flex';
                toggleEmojiPanel(!isVisible);
            });
                console.log('Emoji按鈕事件監聽器已設置');
            } else {
                console.error('找不到emojiBtn元素');
            }
            
            // 設置加號按鈕點擊事件
            const plusBtn = document.getElementById('plusBtn');
            if (plusBtn) {
                plusBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                const functionPanel = document.getElementById('functionPanel');
                const emojiPanel = document.getElementById('emojiPanel');
                
                                    // 關閉emoji面板和@面板，顯示或隱藏功能面板
                emojiPanel.style.display = 'none';
                hideMentionPopup();
                functionPanel.style.display = functionPanel.style.display === 'flex' ? 'none' : 'flex';
                
                    // 功能提示已移除
            });
                console.log('Plus按鈕事件監聽器已設置');
            } else {
                console.error('找不到plusBtn元素');
            }
            
            // 點擊聊天界面任意位置關閉面板
            document.getElementById('chatMessages').addEventListener('click', function() {
                toggleEmojiPanel(false);
                document.getElementById('functionPanel').style.display = 'none';
                hideMentionPopup();
            });
            
            
            
            // 其他功能按鈕点击事件（目前不可用，但为了完整性添加）
            ['photoBtn', 'cameraBtn', 'callBtn', 'locationBtn', 'voiceInputBtn', 'favBtn'].forEach(id => {
                document.getElementById(id).addEventListener('click', function() {
                    alert('此功能暫未開放');
                    document.getElementById('functionPanel').style.display = 'none';
                });
            });
        };
    </script>
    

</body>
</html>
