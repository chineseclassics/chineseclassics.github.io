<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>書院中文經典群聊</title>
    <style>
        /* 基礎樣式 - 模擬微信風格 */
        :root {
            --wx-bg: #ededed;
            --wx-chat-bg: #ededed;
            --wx-green: #91ED61;
            --wx-gray: #9c9c9c;
            --wx-light-gray: #f1f1f1;
            --wx-dark-gray: #666666;
            --wx-header-bg: #f6f6f6;
            --wx-input-bg: #f6f6f6;
            --wx-bubble-self: #95ec69;
            --wx-bubble-others: #ffffff;
            --wx-red-packet: #fa5151;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--wx-chat-bg);
            color: #333;
            line-height: 1.4;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* 狀態欄 */
        .status-bar {
            height: 44px;
            background-color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            color: #000;
            font-weight: 600;
        }
        
        .status-bar-left {
            font-size: 17px;
            font-weight: 500;
        }
        
        .status-bar-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 微信頭部 */
        .wx-header {
            background-color: var(--wx-header-bg);
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            margin-top: -1px;
        }
        
        .wx-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 17px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .wx-back-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #000;
            padding: 0;
            margin-left: -5px;
        }
        
        .wx-menu-btn {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        /* 微信聊天容器 */
        .wx-chat-container {
            height: calc(100vh - 132px);
            overflow-y: auto;
            padding: 10px 10px 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 60px;
        }
        
        /* 時間戳 */
        .wx-time {
            text-align: center;
            font-size: 14px;
            color: #b2b2b2;
            margin: 10px 0;
            padding: 0 5px;
        }
        
        /* 消息容器 */
        .wx-msg {
            display: flex;
            margin-bottom: 16px;
            position: relative;
            width: 100%;
        }
        
        .wx-msg-self {
            flex-direction: row-reverse;
        }
        
        /* 頭像樣式 */
        .wx-avatar {
            width: 40px;
            height: 40px;
            border-radius: 3px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
            flex-shrink: 0;
            font-size: 26px;
        }
        
        /* 消息泡泡 */
        .wx-content-wrapper {
            max-width: calc(100% - 100px);
            display: flex;
            flex-direction: column;
        }
        
        .wx-msg-bubble {
            max-width: 100%;
            padding: 9px 12px;
            position: relative;
            word-wrap: break-word;
            display: inline-block;
            text-align: left;
            font-size: 17px;
            line-height: 1.3;
            border-radius: 5px;
            margin: 0;
        }
        
        .wx-msg-self .wx-msg-bubble {
            background-color: var(--wx-bubble-self);
            color: #000;
        }
        
        .wx-msg-self .wx-msg-bubble::before {
            content: "";
            position: absolute;
            right: -6px;
            top: 8px;
            width: 0;
            height: 0;
            border-left: 6px solid var(--wx-bubble-self);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        
        .wx-msg-others .wx-msg-bubble {
            background-color: var(--wx-bubble-others);
            color: #000;
        }
        
        .wx-msg-others .wx-msg-bubble::before {
            content: "";
            position: absolute;
            left: -6px;
            top: 8px;
            width: 0;
            height: 0;
            border-right: 6px solid var(--wx-bubble-others);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        
        /* 姓名標籤 */
        .wx-name {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
            margin-left: 3px;
        }
        
        /* 系統消息 */
        .wx-system-msg {
            text-align: center;
            color: #888;
            font-size: 14px;
            margin: 10px 0;
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* 動畫效果 */
        .wx-fade-in {
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 輸入框區域 */
        .wx-input-area {
            background-color: var(--wx-input-bg);
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .wx-input {
            flex: 1;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 16px;
            outline: none;
            resize: none;
            min-height: 18px;
            max-height: 100px;
        }
        
        .wx-send-btn {
            background-color: var(--wx-green);
            color: #000;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            min-width: 60px;
        }
        
        .wx-send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* 等待動畫 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* 歡迎界面 */
        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--wx-chat-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            z-index: 1000;
        }
        
        .welcome-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        .start-chat-btn {
            background-color: var(--wx-green);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .start-chat-btn:hover {
            transform: translateY(-2px);
        }
        
        /* API錯誤提示 */
        .api-error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px;
            text-align: center;
            font-size: 14px;
        }

        /* 新增成員資料頁面樣式 */
        .profile-nav-bar {
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            background-color: var(--wx-header-bg);
            position: relative;
        }
        
        .profile-back-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
        }
        
        .profile-header {
            background-color: #ffffff;
            padding: 20px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .profile-avatar {
            width: 65px;
            height: 65px;
            border-radius: 5px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            background-color: #f8f8f8;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 22px;
            margin: 0 0 5px 0;
            font-weight: normal;
        }
        
        .profile-wechat-id, .profile-location {
            font-size: 14px;
            color: #888;
            margin: 3px 0;
        }
        
        .profile-menu-section {
            background-color: #ffffff;
            margin-bottom: 8px;
        }
        
        .profile-menu-item {
            display: flex;
            padding: 15px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .menu-item-label {
            flex: 1;
            font-size: 17px;
        }
        
        .menu-item-arrow {
            color: #cccccc;
        }

        /* 朋友圈界面 */
        .moments {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #fff;
            z-index: 300;
            display: none;
            flex-direction: column;
            overflow: auto;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .moment-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .moment-header {
            display: flex;
            margin-bottom: 10px;
        }
        
        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 3px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .moment-content {
            flex: 1;
        }
        
        .moment-name {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 3px;
            color: #576b95;
            cursor: pointer;
        }
        
        .moment-text {
            font-size: 15px;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .moment-image {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .moment-location {
            font-size: 13px;
            color: #576b95;
            margin-bottom: 8px;
        }
        
        .moment-time {
            font-size: 14px;
            color: #b2b2b2;
            margin-top: 5px;
        }

        .moment-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            gap: 15px;
        }

        .moment-like-btn, .moment-comment-btn {
            font-size: 14px;
            color: #576b95;
            cursor: pointer;
            padding: 5px;
        }

        .moment-likes {
            background-color: #f7f7f7;
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 4px;
            font-size: 14px;
            color: #576b95;
        }

        .moment-comments {
            margin-top: 8px;
        }

        .moment-comment {
            background-color: #f7f7f7;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 14px;
        }

        .comment-author {
            color: #576b95;
            font-weight: 500;
        }

        /* 個人資料界面 */
        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f5f5f5;
            z-index: 250;
            display: none;
            flex-direction: column;
            overflow: auto;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Emoji面板 */
        .emoji-panel {
            position: absolute;
            bottom: 44px;
            left: 0;
            right: 0;
            background-color: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            height: 200px;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .emoji-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .emoji-item:hover {
            background-color: #f0f0f0;
        }

        /* 功能選項面板 */
        .function-panel {
            position: absolute;
            bottom: 44px;
            left: 0;
            right: 0;
            background-color: #f6f6f6;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            display: none;
            flex-direction: column;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 0 15px;
        }
        
        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        
        .function-icon {
            width: 56px;
            height: 56px;
            background-color: #fff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            color: #353535;
        }
        
        .function-text {
            font-size: 12px;
            color: #636363;
        }
    </style>
</head>
<body>
    <!-- 狀態欄 -->
    <div class="status-bar">
        <div class="status-bar-left">23:18</div>
        <div class="status-bar-right">
            <span>100%</span>
            <span>🔋</span>
        </div>
    </div>
    
    <!-- 微信頭部 -->
    <div class="wx-header">
        <div class="wx-back-btn">‹</div>
        <div class="wx-header-title">書院中文經典群聊 (12)</div>
        <div class="wx-menu-btn">⋯</div>
    </div>
    
    <!-- 歡迎界面 -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-title">📚 書院中文經典群聊</div>
        <div class="welcome-subtitle">
            歡迎來到古代文學大師的群聊！<br>
            在這裡，您可以與李白、杜甫、蘇軾等<br>
            偉大的文學家直接對話，<br>
            探討詩詞、人生與哲理。
        </div>
        <button class="start-chat-btn" onclick="startChat()">開始對話</button>
    </div>
    
    <!-- 聊天容器 -->
    <div class="wx-chat-container" id="chatContainer" style="display: none;">
        <!-- 消息將在這裡動態添加 -->
    </div>
    
    <!-- 輸入區域 -->
    <div class="wx-input-area" id="inputArea" style="display: none;">
        <button class="wx-emoji-btn" id="emojiBtn">😊</button>
        <textarea 
            class="wx-input" 
            id="messageInput" 
            placeholder="輸入消息..."
            rows="1"
        ></textarea>
        <button class="wx-plus-btn" id="plusBtn">+</button>
        <button class="wx-send-btn" id="sendBtn" onclick="sendMessage()">發送</button>
    </div>

    <!-- Emoji面板 -->
    <div class="emoji-panel" id="emojiPanel">
        <!-- Emoji將動態添加到這裡 -->
    </div>

    <!-- 功能面板 -->
    <div id="functionPanel" class="function-panel">
        <div class="function-grid">
            <div class="function-item" id="viewMomentsBtn">
                <div class="function-icon">📱</div>
                <div class="function-text">朋友圈</div>
            </div>
            <div class="function-item" id="profileBtn">
                <div class="function-icon">👤</div>
                <div class="function-text">個人資料</div>
            </div>
            <div class="function-item" id="photoBtn">
                <div class="function-icon">📷</div>
                <div class="function-text">照片</div>
            </div>
            <div class="function-item" id="locationBtn">
                <div class="function-icon">📍</div>
                <div class="function-text">位置</div>
            </div>
        </div>
    </div>

    <!-- 朋友圈界面 -->
    <div class="moments" id="momentsPage">
        <div class="wx-header">
            <div class="wx-back-btn" onclick="closeMoments()">‹</div>
            <div class="wx-header-title">朋友圈</div>
            <div class="wx-menu-btn"></div>
        </div>
        <div id="momentsContainer">
            <!-- 朋友圈內容會動態生成到這裡 -->
        </div>
    </div>

    <!-- 個人資料頁面 -->
    <div class="profile-page" id="profilePage">
        <div class="profile-nav-bar">
            <div class="profile-back-btn" onclick="closeProfile()">‹</div>
            <div class="wx-header-title">個人資料</div>
            <div class="wx-menu-btn">⋯</div>
        </div>
        <div id="profileContainer">
            <!-- 個人資料內容會動態生成到這裡 -->
        </div>
    </div>

    <script>
        // DeepSeek API 配置
        const DEEPSEEK_CONFIG = {
            apiKey: 'sk-d850478e8977454abc9975d544ffd4e3',
            baseURL: 'https://api.deepseek.com/v1/chat/completions',
            model: 'deepseek-chat'
        };

        // 角色定義和人設
        const characters = {
            libai: {
                name: "李白",
                nickname: "謫仙人", 
                avatar: "🥂",
                era: "盛唐",
                personality: "豪放不羈，才華橫溢，喜酒愛自由，性格率真",
                background: "字太白，號青蓮居士，唐代浪漫主義詩人，被譽為詩仙",
                speakingStyle: "語言豪邁奔放，常用誇張手法，喜歡用典故，文辭華麗",
                keyWorks: ["將進酒", "蜀道難", "靜夜思", "月下獨酌"],
                relationships: ["杜甫-詩友", "賀知章-知音", "王維-同僚"],
                systemPrompt: `你是唐代詩人李白，字太白，號青蓮居士，被譽為"詩仙"。你性格豪放不羈，才華橫溢，喜愛飲酒，追求自由。你的語言風格豪邁奔放，常用誇張手法，喜歡引用典故。你對現代人充滿好奇，但始終保持古代文人的風采。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            dufu: {
                name: "杜甫",
                nickname: "詩聖",
                avatar: "📝", 
                era: "盛唐-安史之亂",
                personality: "憂國憂民，情感深沉，現實主義，為人厚重",
                background: "字子美，號少陵野老，唐代現實主義詩人，被譽為詩聖",
                speakingStyle: "語言質樸深沉，情感真摯，關注社會民生",
                keyWorks: ["三吏", "三別", "登高", "春望"],
                relationships: ["李白-詩友", "高適-好友"],
                systemPrompt: `你是唐代詩人杜甫，字子美，號少陵野老，被譽為"詩聖"。你憂國憂民，情感深沉，是現實主義詩人的代表。你的語言質樸而深刻，總是關注民生疾苦和社會現實。你與李白是好友，但性格更加沉穩。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            sushi: {
                name: "蘇軾", 
                nickname: "東坡居士",
                avatar: "🌙",
                era: "北宋",
                personality: "豁達樂觀，多才多藝，哲理深邃，幽默風趣",
                background: "字子瞻，號東坡居士，北宋文學家，唐宋八大家之一",
                speakingStyle: "文辭典雅，富含哲理，常有幽默機智的表達",
                keyWorks: ["水調歌頭", "念奴嬌·赤壁懷古", "定風波"],
                relationships: ["蘇轍-弟弟", "王安石-政敵但互相尊重"],
                systemPrompt: `你是北宋文學家蘇軾，字子瞻，號東坡居士。你性格豁達樂觀，才華橫溢，不僅是詩人，還是書法家、畫家。你的人生經歷了多次貶謫，但始終保持樂觀的態度。你的語言富含哲理，常有幽默機智的表達。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            liqingzhao: {
                name: "李清照",
                nickname: "易安居士", 
                avatar: "🌸",
                era: "北宋-南宋",
                personality: "才情出眾，情感細膩，堅強獨立，文采飛揚",
                background: "號易安居士，宋代女詞人，婉約詞派代表",
                speakingStyle: "文辭優美，情感真摯，善用比喻，語言精煉",
                keyWorks: ["聲聲慢", "如夢令", "一剪梅"],
                relationships: ["趙明誠-夫君", "蘇軾-前輩"],
                systemPrompt: `你是宋代女詞人李清照，號易安居士，是婉約詞派的代表人物。你才情出眾，文采飛揚，經歷了國破家亡的痛苦，但依然堅強獨立。你的詞作情感細膩，語言優美。作為古代少有的女性文學家，你對現代女性的地位變化很感興趣。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            taoyuanming: {
                name: "陶淵明",
                nickname: "靖節先生",
                avatar: "🌾", 
                era: "東晉",
                personality: "淡泊名利，熱愛自然，純真質樸，超脫世俗",
                background: "字元亮，號五柳先生，東晉田園詩人",
                speakingStyle: "語言自然質樸，追求真樸，常談及田園生活",
                keyWorks: ["歸園田居", "桃花源記", "飲酒"],
                relationships: ["謝靈運-後輩詩人"],
                systemPrompt: `你是東晉詩人陶淵明，字元亮，號五柳先生。你淡泊名利，不為五斗米折腰，歸隱田園。你熱愛自然，追求純真質樸的生活。你的語言自然質樸，常常談及田園生活的美好。你對現代城市生活感到好奇，但依然堅持自己的田園理想。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            hezhizhang: {
                name: "賀知章",
                nickname: "四明狂客",
                avatar: "👴",
                era: "盛唐",
                personality: "豪放灑脫，愛才惜才，為人豁達",
                background: "字季真，號四明狂客，唐代詩人，李白的賞識者",
                speakingStyle: "語言爽快直率，喜歡稱讚後輩，有長者風範",
                keyWorks: ["咏柳", "回鄉偶書"],
                systemPrompt: `你是唐代詩人賀知章，字季真，號四明狂客。你性格豪放灑脫，愛才惜才，是李白的賞識者和知音。你有長者風範，喜歡提攜後輩，語言爽快直率。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            liuling: {
                name: "劉伶",
                nickname: "酒中仙",
                avatar: "🍶",
                era: "魏晉",
                personality: "嗜酒如命，放浪形骸，超脫世俗",
                background: "魏晉竹林七賢之一，以嗜酒聞名",
                speakingStyle: "常談酒事，語言風趣，不拘禮法",
                keyWorks: ["酒德頌"],
                systemPrompt: `你是魏晉時期竹林七賢之一的劉伶，以嗜酒如命著稱。你放浪形骸，超脫世俗，認為酒是人生最大的樂趣。你常常語出驚人，不拘禮法。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            wangwei: {
                name: "王維",
                nickname: "詩佛",
                avatar: "🧘",
                era: "盛唐",
                personality: "清雅淡泊，禪意深遠，溫和內斂",
                background: "字摩詰，號詩佛，唐代山水田園詩人",
                speakingStyle: "語言清雅，富有禪意，常談山水自然",
                keyWorks: ["送元二使安西", "山居秋暝", "鹿柴"],
                systemPrompt: `你是唐代詩人王維，字摩詰，被稱為"詩佛"。你性格清雅淡泊，詩中充滿禪意，善於描繪山水田園之美。你信奉佛教，語言溫和內斂，常常富有哲理。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            danqiusheng: {
                name: "丹丘生",
                nickname: "隱士道人",
                avatar: "🧙",
                era: "盛唐",
                personality: "仙風道骨，博學多才，與世無爭",
                background: "元丹丘，隱士，道士，李白好友",
                speakingStyle: "語帶仙氣，常談道法自然，博學睿智",
                keyWorks: ["道家典籍"],
                systemPrompt: `你是唐代隱士元丹丘，人稱丹丘生，是李白的好友。你仙風道骨，博學多才，精通道家學說。你語帶仙氣，常談道法自然，與世無爭。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            cenxun: {
                name: "岑勛",
                nickname: "南陽才子",
                avatar: "🧑‍🎓",
                era: "盛唐",
                personality: "才華橫溢，文采斐然，為人謙遜",
                background: "唐代文人，南陽人，李白好友",
                speakingStyle: "文雅謙遜，才思敏捷，常引經據典",
                keyWorks: ["邊塞詩作"],
                systemPrompt: `你是唐代文人岑勛，南陽人，李白的好友。你才華橫溢，文采斐然，為人謙遜有禮。你的詩作以邊塞題材為主，文雅而有氣勢。請用繁體中文回應，每次回應控制在50-100字以內。`
            },
            menghaoran: {
                name: "孟浩然",
                nickname: "孟襄陽",
                avatar: "🏞️",
                era: "盛唐",
                personality: "清雅脫俗，淡泊名利，熱愛自然",
                background: "襄陽人，唐代田園山水詩人",
                speakingStyle: "語言清新自然，常談山水田園",
                keyWorks: ["春曉", "過故人莊"],
                systemPrompt: `你是唐代詩人孟浩然，襄陽人。你清雅脫俗，淡泊名利，熱愛自然山水。你的詩作清新自然，善於描繪田園生活和山水風光。你與李白是好友。請用繁體中文回應，每次回應控制在50-100字以內。`
            }
        };

        // 對話歷史管理
        const conversationHistory = new Map();
        let isApiResponding = false;

        // 初始化對話歷史
        function initConversationHistory() {
            Object.keys(characters).forEach(characterId => {
                conversationHistory.set(characterId, []);
            });
        }

        // 開始聊天
        function startChat() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('inputArea').style.display = 'flex';
            
            // 初始化
            initConversationHistory();
            addTimestamp();
            
            // 添加歡迎消息
            addSystemMessage('歡迎來到書院中文經典群聊！您可以與古代文學大師們自由對話。');
            
            // 隨機選擇幾位詩人發送歡迎消息
            setTimeout(() => {
                const welcomeMessages = [
                    { character: 'libai', message: '哈哈！又有新朋友來到我們的聚會！來來來，不如先飲一杯？' },
                    { character: 'dufu', message: '歡迎！能與後世學者交流，實為幸事。有何文學見解，不妨暢談。' },
                    { character: 'sushi', message: '東坡在此恭候！現代人的見識定是不凡，期待與君論詩談文。' }
                ];
                
                welcomeMessages.forEach((msg, index) => {
                    setTimeout(() => {
                        addCharacterMessage(msg.character, msg.message);
                    }, (index + 1) * 1500);
                });
            }, 1000);
            
            // 設置增強的UI交互
            setupUIInteractionsEnhanced();
        }

        // 設置輸入框事件
        function setupInputEvents() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            input.addEventListener('input', function() {
                sendBtn.disabled = this.value.trim() === '' || isApiResponding;
            });
        }

        // 發送消息
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isApiResponding) return;
            
            // 添加用戶消息
            addUserMessage(message);
            input.value = '';
            document.getElementById('sendBtn').disabled = true;
            
            // 處理AI回應
            await handleAIResponse(message);
        }

        // 處理AI回應
        async function handleAIResponse(userMessage) {
            isApiResponding = true;
            
            // 選擇回應的角色（1-2個）
            const respondingCharacters = selectRespondingCharacters();
            
            for (let i = 0; i < respondingCharacters.length; i++) {
                const characterId = respondingCharacters[i];
                
                // 添加打字指示器
                const typingId = addTypingIndicator(characterId);
                
                try {
                    const response = await generateAIResponse(characterId, userMessage);
                    
                    // 移除打字指示器並添加回應
                    removeTypingIndicator(typingId);
                    addCharacterMessage(characterId, response);
                    
                    // 更新對話歷史
                    updateConversationHistory(characterId, userMessage, response);
                    
                } catch (error) {
                    removeTypingIndicator(typingId);
                    addCharacterMessage(characterId, getFallbackResponse(characterId));
                    console.error(`AI回應生成失敗 (${characterId}):`, error);
                }
                
                // 角色間添加間隔
                if (i < respondingCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            isApiResponding = false;
            document.getElementById('sendBtn').disabled = false;
        }

        // 選擇回應角色
        function selectRespondingCharacters() {
            const allCharacters = Object.keys(characters);
            const shuffled = allCharacters.sort(() => 0.5 - Math.random());
            const responseCount = Math.random() < 0.7 ? 1 : 2; // 70%概率1個回應，30%概率2個回應
            return shuffled.slice(0, responseCount);
        }

        // 生成AI回應
        async function generateAIResponse(characterId, userMessage) {
            const character = characters[characterId];
            const history = conversationHistory.get(characterId) || [];
            
            const messages = [
                {
                    role: "system",
                    content: buildSystemPrompt(character)
                },
                ...history.slice(-6), // 只保留最近6條對話
                {
                    role: "user",
                    content: userMessage
                }
            ];

            const response = await fetch(DEEPSEEK_CONFIG.baseURL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: DEEPSEEK_CONFIG.model,
                    messages: messages,
                    max_tokens: 200,
                    temperature: 0.8
                })
            });

            if (!response.ok) {
                throw new Error(`API請求失敗: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // 構建系統提示
        function buildSystemPrompt(character) {
            return `${character.systemPrompt}

當前情境：現代學者在古代文學群聊中與你對話
你的基本信息：
- 姓名：${character.name}
- 時代：${character.era}  
- 性格：${character.personality}
- 代表作：${character.keyWorks.join('、')}

對話要求：
1. 保持角色的歷史人物特色和性格
2. 可以表達對現代事物的好奇，但要符合古人身份
3. 語言要有古代文人的韻味，但要通俗易懂
4. 可以適當引用你的詩詞作品
5. 回應長度50-100字
6. 使用繁體中文`;
        }

        // 更新對話歷史
        function updateConversationHistory(characterId, userMessage, aiResponse) {
            const history = conversationHistory.get(characterId) || [];
            history.push(
                { role: "user", content: userMessage },
                { role: "assistant", content: aiResponse }
            );
            
            // 保持歷史長度在合理範圍內
            if (history.length > 20) {
                history.splice(0, 4); // 移除最早的4條記錄
            }
            
            conversationHistory.set(characterId, history);
        }

        // 獲取備用回應
        function getFallbackResponse(characterId) {
            const fallbacks = {
                libai: "哈哈，剛才思緒飛到九天之外了！請再說一遍？",
                dufu: "抱歉，剛才在思考詩句，沒有聽清。能否再說一次？",
                sushi: "東坡一時走神了，可否請你再說一遍？",
                liqingzhao: "方才在整理詞稿，沒有聽清楚，請再說一次好嗎？",
                taoyuanming: "剛才在欣賞窗外風景，錯過了你的話，可否重複？"
            };
            return fallbacks[characterId] || "不好意思，剛才沒聽清楚，能再說一次嗎？";
        }

        // 添加用戶消息
        function addUserMessage(content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'wx-msg wx-msg-self wx-fade-in';
            
            messageElement.innerHTML = `
                <div class="wx-avatar">👤</div>
                <div class="wx-content-wrapper">
                    <div class="wx-msg-bubble">${content}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 添加角色消息
        function addCharacterMessage(characterId, content) {
            const chatContainer = document.getElementById('chatContainer');
            const character = characters[characterId];
            const messageElement = document.createElement('div');
            messageElement.className = 'wx-msg wx-msg-others wx-fade-in';
            
            messageElement.innerHTML = `
                <div class="wx-avatar">${character.avatar}</div>
                <div class="wx-content-wrapper">
                    <div class="wx-name">${character.name}</div>
                    <div class="wx-msg-bubble">${content}</div>
                </div>
            `;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 添加系統消息
        function addSystemMessage(content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageElement = document.createElement('div');
            messageElement.className = 'wx-system-msg wx-fade-in';
            messageElement.textContent = content;
            
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 添加打字指示器
        function addTypingIndicator(characterId) {
            const chatContainer = document.getElementById('chatContainer');
            const character = characters[characterId];
            const typingElement = document.createElement('div');
            const typingId = `typing-${characterId}-${Date.now()}`;
            typingElement.id = typingId;
            typingElement.className = 'wx-msg wx-msg-others';
            
            typingElement.innerHTML = `
                <div class="wx-avatar">${character.avatar}</div>
                <div class="wx-content-wrapper">
                    <div class="wx-name">${character.name}</div>
                    <div class="wx-msg-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return typingId;
        }

        // 移除打字指示器
        function removeTypingIndicator(typingId) {
            const element = document.getElementById(typingId);
            if (element) {
                element.remove();
            }
        }

        // 添加時間戳
        function addTimestamp() {
            const chatContainer = document.getElementById('chatContainer');
            const timestamp = document.createElement('div');
            timestamp.className = 'wx-time';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            timestamp.textContent = timeString;
            
            chatContainer.appendChild(timestamp);
        }

        // 朋友圈數據
        const momentsDB = {
            libai: [
                {
                    id: 'libai_1',
                    authorId: 'libai',
                    text: '今日訪戴天山道士不遇，雖未見道友，卻見滿山春色。犬吠水聲中，桃花帶露濃。樹深時見鹿，溪午不聞鐘。野竹分青靄，飛泉掛碧峰。無人知所去，愁倚兩三松。縱然未遇，此行亦不虛也！',
                    image: '🦌🌸',
                    time: '二天前',
                    location: '四川·戴天山',
                    likes: ['danqiusheng', 'taoyuanming', 'wangwei'],
                    comments: [
                        { authorId: 'taoyuanming', text: '「桃花帶露濃」一句，將桃花之美寫得極致，老夫讀之心嚮往之！' },
                        { authorId: 'wangwei', text: '此詩清幽雋永，山水之趣躍然紙上，不輸老夫山水詩作。' },
                        { authorId: 'libai', text: '@wangwei 摩詰兄過譽了，太白不過偶得靈感而已。' }
                    ]
                },
                {
                    id: 'libai_2',
                    authorId: 'libai',
                    text: '將進酒，杯莫停！人生得意須盡歡，莫使金樽空對月。天生我材必有用，千金散盡還復來！',
                    image: '🍷🌙',
                    time: '一週前',
                    likes: ['hezhizhang', 'liuling', 'dufu'],
                    comments: [
                        { authorId: 'hezhizhang', text: '太白此詩豪氣干雲，老夫讀來熱血沸騰！' },
                        { authorId: 'liuling', text: '好詩配好酒，人生快事！' }
                    ]
                }
            ],
            dufu: [
                {
                    id: 'dufu_1',
                    authorId: 'dufu',
                    text: '今夜聞笛聲，思君不見下渝州。望月懷遠，心繫蒼生。國破山河在，城春草木深。感時花濺淚，恨別鳥驚心。',
                    image: '🌙📝',
                    time: '三天前',
                    likes: ['libai', 'wangwei', 'liqingzhao'],
                    comments: [
                        { authorId: 'libai', text: '子美兄憂國憂民，令太白敬佩！' },
                        { authorId: 'liqingzhao', text: '杜公詩作感人至深，清照深有同感。' }
                    ]
                }
            ],
            sushi: [
                {
                    id: 'sushi_1',
                    authorId: 'sushi',
                    text: '人生如夢，一尊還酹江月。大江東去，浪淘盡千古風流人物。惟江上之清風，與山間之明月，耳得之而為聲，目遇之而成色，取之無禁，用之不竭。',
                    image: '🌊🌙',
                    time: '昨天',
                    likes: ['libai', 'liqingzhao', 'taoyuanming'],
                    comments: [
                        { authorId: 'libai', text: '東坡此詞氣魄宏大，太白嘆服！' },
                        { authorId: 'liqingzhao', text: '蘇學士才華橫溢，令人欽佩！' }
                    ]
                }
            ],
            liqingzhao: [
                {
                    id: 'liqingzhao_1',
                    authorId: 'liqingzhao',
                    text: '尋尋覓覓，冷冷清清，淒淒慘慘戚戚。乍暖還寒時候，最難將息。三杯兩盞淡酒，怎敵他、晚來風急！',
                    image: '🌸💔',
                    time: '五天前',
                    likes: ['sushi', 'wangwei', 'taoyuanming'],
                    comments: [
                        { authorId: 'sushi', text: '易安詞情真意切，讀來令人動容。' },
                        { authorId: 'wangwei', text: '詞中有畫，情景交融，佳作也！' }
                    ]
                }
            ],
            taoyuanming: [
                {
                    id: 'taoyuanming_1',
                    authorId: 'taoyuanming',
                    text: '採菊東籬下，悠然見南山。山氣日夕佳，飛鳥相與還。此中有真意，欲辨已忘言。田園生活，最是怡人。',
                    image: '🌾🏔️',
                    time: '一週前',
                    likes: ['wangwei', 'menghaoran', 'libai'],
                    comments: [
                        { authorId: 'wangwei', text: '淵明先生真得自然之趣！' },
                        { authorId: 'libai', text: '老先生的田園詩，令人神往！' }
                    ]
                }
            ],
            hezhizhang: [
                {
                    id: 'hezhizhang_1',
                    authorId: 'hezhizhang',
                    text: '少小離家老大回，鄉音無改鬢毛衰。兒童相見不相識，笑問客從何處來。歲月不饒人啊！',
                    image: '👴🏠',
                    time: '兩天前',
                    likes: ['libai', 'dufu', 'menghaoran'],
                    comments: [
                        { authorId: 'libai', text: '賀老此詩真切動人，令人深思！' },
                        { authorId: 'dufu', text: '時光荏苒，人事變遷，感慨良深。' }
                    ]
                }
            ]
        };

        // Emoji數據
        const emojiData = [
            "😊", "😃", "😄", "😁", "😆", "😅", "🤣", "😂", "🙂", "🙃", 
            "😉", "😇", "🥰", "😍", "🤩", "😘", "😗", "😚", "😙", "😋", 
            "😛", "😜", "🤪", "😝", "🤑", "🤗", "🤭", "🤫", "🤔", "🤐", 
            "🤨", "😐", "😑", "😶", "😏", "😒", "🙄", "😬", "🤥", "😌", 
            "😔", "😪", "🤤", "😴", "😷", "🤒", "🤕", "🤢", "🤮", "🤧",
            "🍷", "🍸", "🍹", "🍺", "🍻", "🥂", "🥃", "🍶", "🥛", "🍵",
            "📚", "📖", "📝", "✏️", "🖋️", "🖊️", "🖌️", "📜", "📄", "📃",
            "🌸", "🌺", "🌻", "🌷", "🌹", "🥀", "🌾", "🌿", "🍀", "🌱",
            "🌙", "⭐", "🌟", "💫", "☀️", "🌈", "🌊", "🏔️", "🗻", "🌋"
        ];

        // 查看朋友圈
        function viewMoments() {
            document.getElementById('momentsPage').style.display = 'flex';
            loadMomentsData();
        }

        // 關閉朋友圈
        function closeMoments() {
            document.getElementById('momentsPage').style.display = 'none';
        }

        // 加載朋友圈數據
        function loadMomentsData() {
            const container = document.getElementById('momentsContainer');
            container.innerHTML = '';

            // 合併所有朋友圈數據並按時間排序
            let allMoments = [];
            Object.keys(momentsDB).forEach(characterId => {
                if (momentsDB[characterId]) {
                    allMoments = allMoments.concat(momentsDB[characterId]);
                }
            });

            // 按時間排序（這裡簡化處理）
            allMoments.reverse();

            allMoments.forEach(moment => {
                const momentElement = createMomentElement(moment);
                container.appendChild(momentElement);
            });
        }

        // 創建朋友圈元素
        function createMomentElement(moment) {
            const character = characters[moment.authorId];
            const div = document.createElement('div');
            div.className = 'moment-item';
            div.innerHTML = `
                <div class="moment-header">
                    <div class="moment-avatar" onclick="viewProfile('${moment.authorId}')">${character.avatar}</div>
                    <div class="moment-content">
                        <div class="moment-name" onclick="viewProfile('${moment.authorId}')">${character.name}</div>
                        <div class="moment-text">${moment.text}</div>
                        ${moment.image ? `<div class="moment-image">${moment.image}</div>` : ''}
                        ${moment.location ? `<div class="moment-location">📍 ${moment.location}</div>` : ''}
                        <div class="moment-time">${moment.time}</div>
                        <div class="moment-actions">
                            <span class="moment-like-btn" onclick="likeMoment('${moment.id}')">👍 讚</span>
                            <span class="moment-comment-btn" onclick="commentMoment('${moment.id}')">💬 評論</span>
                        </div>
                        ${moment.likes && moment.likes.length > 0 ? `
                            <div class="moment-likes">
                                👍 ${moment.likes.map(id => characters[id].name).join('、')} 讚了這條動態
                            </div>
                        ` : ''}
                        ${moment.comments && moment.comments.length > 0 ? `
                            <div class="moment-comments">
                                ${moment.comments.map(comment => `
                                    <div class="moment-comment">
                                        <span class="comment-author">${characters[comment.authorId].name}</span>：${comment.text}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            return div;
        }

        // 查看個人資料
        function viewProfile(characterId) {
            const character = characters[characterId];
            const container = document.getElementById('profileContainer');
            
            container.innerHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">${character.avatar}</div>
                    <div class="profile-info">
                        <h2 class="profile-name">${character.name}</h2>
                        <div class="profile-wechat-id">微信號：${characterId}</div>
                        <div class="profile-location">📍 ${character.era}</div>
                    </div>
                </div>
                <div class="profile-menu-section">
                    <div class="profile-menu-item">
                        <div class="menu-item-label">個人簡介</div>
                    </div>
                    <div style="padding: 15px; font-size: 14px; color: #666;">
                        ${character.background}<br><br>
                        性格：${character.personality}<br>
                        代表作：${character.keyWorks ? character.keyWorks.join('、') : '暫無'}
                    </div>
                </div>
                <div class="profile-menu-section">
                    <div class="profile-menu-item" onclick="viewMoments()">
                        <div class="menu-item-label">朋友圈</div>
                        <div class="menu-item-arrow">›</div>
                    </div>
                </div>
            `;
            
            document.getElementById('profilePage').style.display = 'flex';
        }

        // 關閉個人資料
        function closeProfile() {
            document.getElementById('profilePage').style.display = 'none';
        }

        // 點讚朋友圈
        function likeMoment(momentId) {
            // 這裡可以添加點讚邏輯
            console.log('點讚朋友圈：', momentId);
        }

        // 評論朋友圈
        function commentMoment(momentId) {
            // 這裡可以添加評論邏輯
            console.log('評論朋友圈：', momentId);
        }

        // 初始化Emoji面板
        function populateEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanel.innerHTML = '';
            
            emojiData.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.addEventListener('click', () => {
                    sendEmoji(emoji);
                });
                emojiPanel.appendChild(emojiItem);
            });
        }

        // 發送Emoji消息
        function sendEmoji(emoji) {
            addUserMessage(emoji);
            toggleEmojiPanel(false);
            
            // 處理AI回應
            setTimeout(() => {
                handleAIResponse(emoji);
            }, 500);
        }

        // 顯示/隱藏Emoji面板
        function toggleEmojiPanel(show) {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanel.style.display = show ? 'flex' : 'none';
        }

        // 設置UI交互增強
        function setupUIInteractionsEnhanced() {
            // 原有的輸入框事件
            setupInputEvents();
            
            // Emoji按鈕
            document.getElementById('emojiBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                const emojiPanel = document.getElementById('emojiPanel');
                const functionPanel = document.getElementById('functionPanel');
                functionPanel.style.display = 'none';
                const isVisible = emojiPanel.style.display === 'flex';
                toggleEmojiPanel(!isVisible);
            });
            
            // 加號按鈕
            document.getElementById('plusBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                const functionPanel = document.getElementById('functionPanel');
                const emojiPanel = document.getElementById('emojiPanel');
                emojiPanel.style.display = 'none';
                functionPanel.style.display = functionPanel.style.display === 'flex' ? 'none' : 'flex';
            });
            
            // 功能按鈕
            document.getElementById('viewMomentsBtn').addEventListener('click', () => {
                viewMoments();
                document.getElementById('functionPanel').style.display = 'none';
            });
            
            document.getElementById('profileBtn').addEventListener('click', () => {
                const characterIds = Object.keys(characters);
                const randomCharacter = characterIds[Math.floor(Math.random() * characterIds.length)];
                viewProfile(randomCharacter);
                document.getElementById('functionPanel').style.display = 'none';
            });
            
            // 點擊聊天區域關閉面板
            document.getElementById('chatContainer').addEventListener('click', function() {
                toggleEmojiPanel(false);
                document.getElementById('functionPanel').style.display = 'none';
            });
        }

        // 頁面加載完成後的初始化
        window.onload = function() {
            // 初始化Emoji面板
            populateEmojiPanel();
            
            console.log('書院中文經典群聊已準備就緒');
        };
    </script>
</body>
</html> 