<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊòìÁ∂ìÂç†Âçú - Êô∫ÊÖßÊ±∫Á≠ñÂä©Êâã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(135deg, #8B7355 0%, #D4A574 25%, #C19A6B 50%, #A67B5B 75%, #8B6F47 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(218, 165, 32, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 115, 85, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 248, 240, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            text-align: center;
            color: #654321;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #8B6F47;
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .step {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        .step.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .question-input {
            width: 100%;
            padding: 20px;
            font-size: 1.1em;
            border: 3px solid #D4A574;
            border-radius: 15px;
            background: white;
            color: #654321;
            font-family: inherit;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .question-input:focus {
            outline: none;
            border-color: #8B6F47;
            box-shadow: 0 0 20px rgba(212, 165, 116, 0.3);
        }

        .button {
            background: linear-gradient(135deg, #A67B5B 0%, #8B6F47 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-family: inherit;
            font-weight: bold;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #8B6F47 0%, #A67B5B 100%);
        }

        .button:active {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .coin-throwing {
            text-align: center;
            padding: 30px;
        }

        .coin-instruction {
            font-size: 1.2em;
            color: #654321;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .coin-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .coin {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #654321;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 4px solid #8B6F47;
        }

        .coin:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .coin.flipping {
            animation: coinFlip 0.6s ease-in-out;
        }

        @keyframes coinFlip {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .coin.heads {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .coin.tails {
            background: linear-gradient(135deg, #CD853F 0%, #8B4513 100%);
        }

        .yao-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px auto;
            gap: 15px;
            width: 100%;
            max-width: 350px;
        }

        .yao-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 24px;
        }

        .yao {
            width: 100%;
            max-width: 280px;
            height: 20px;
            background: #654321;
            border-radius: 5px;
            position: relative;
            animation: yaoAppear 0.5s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        @keyframes yaoAppear {
            from {
                opacity: 0;
                transform: scaleX(0);
            }
            to {
                opacity: 1;
                transform: scaleX(1);
            }
        }

        .yao.broken {
            display: flex;
            gap: 20px;
            background: transparent;
            box-shadow: none;
        }

        .yao.broken::before,
        .yao.broken::after {
            content: '';
            flex: 1;
            height: 20px;
            background: #654321;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .yao.changing::before,
        .yao.changing::after {
            background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
        }

        .yao.changing {
            background: linear-gradient(135deg, #DAA520 0%, #B8860B 100%);
        }

        .yao.changing:not(.broken) {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(0.98);
            }
        }

        .yao.changing.broken::before,
        .yao.changing.broken::after {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .yao-number {
            width: 50px;
            text-align: center;
            color: #654321;
            font-weight: bold;
            font-size: 0.95em;
            flex-shrink: 0;
        }

        .hexagram-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(139, 111, 71, 0.1) 100%);
            border-radius: 20px;
            margin: 20px 0;
        }

        .hexagram-comparison {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .hexagram-single {
            flex: 1;
            min-width: 200px;
            max-width: 350px;
        }

        .hexagram-label {
            font-size: 1.2em;
            color: #8B6F47;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .hexagram-arrow {
            font-size: 2em;
            color: #D4A574;
            align-self: center;
        }

        .hexagram-name {
            font-size: 2em;
            color: #654321;
            margin: 20px 0;
            font-weight: bold;
        }

        .hexagram-info {
            color: #8B6F47;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .original-text {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: left;
        }

        .original-text h3 {
            color: #654321;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #D4A574;
            padding-bottom: 10px;
        }

        .original-text .text-content {
            color: #654321;
            line-height: 2;
            font-size: 1.05em;
            margin: 10px 0;
        }

        .original-text .changing-yao-text {
            background: rgba(218, 165, 32, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 3px solid #DAA520;
        }

        .interpretation {
            background: white;
            padding: 35px;
            border-radius: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            line-height: 2;
            color: #654321;
        }

        .interpretation h3 {
            color: #654321;
            margin-bottom: 20px;
            margin-top: 25px;
            font-size: 1.4em;
            border-bottom: 3px solid #D4A574;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .interpretation h3:first-child {
            margin-top: 0;
        }

        .interpretation-section {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.08) 0%, rgba(139, 111, 71, 0.05) 100%);
            border-radius: 12px;
            border-left: 5px solid #D4A574;
            font-size: 1.05em;
        }

        .interpretation p {
            margin: 15px 0;
        }

        .interpretation .section-title {
            color: #654321;
            font-size: 1.25em;
            font-weight: bold;
            margin: 25px 0 15px 0;
            padding-left: 15px;
            border-left: 5px solid #D4A574;
            background: linear-gradient(90deg, rgba(212, 165, 116, 0.15) 0%, transparent 100%);
            padding: 12px 15px;
            border-radius: 5px;
        }

        .question-display {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15) 0%, rgba(139, 111, 71, 0.1) 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid rgba(212, 165, 116, 0.3);
        }

        .question-display h4 {
            color: #8B6F47;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .question-display p {
            color: #654321;
            font-size: 1.15em;
            font-weight: 500;
            margin: 0;
            text-indent: 0;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-hexagram {
            margin: 30px auto;
            max-width: 350px;
        }

        .loading-yao-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px auto;
            gap: 15px;
            width: 100%;
        }

        .loading-yao {
            width: 100%;
            max-width: 280px;
            height: 20px;
            background: linear-gradient(90deg, #654321 0%, #8B6F47 50%, #654321 100%);
            background-size: 200% 100%;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .loading-yao.broken {
            display: flex;
            gap: 20px;
            background: transparent;
            box-shadow: none;
        }

        .loading-yao.broken::before,
        .loading-yao.broken::after {
            content: '';
            flex: 1;
            height: 20px;
            background: linear-gradient(90deg, #654321 0%, #8B6F47 50%, #654321 100%);
            background-size: 200% 100%;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: shimmer 2s ease-in-out infinite;
        }

        .loading-yao.changing {
            background: linear-gradient(90deg, #DAA520 0%, #FFD700 25%, #B8860B 50%, #FFD700 75%, #DAA520 100%);
            background-size: 200% 100%;
        }

        .loading-yao.changing.broken::before,
        .loading-yao.changing.broken::after {
            background: linear-gradient(90deg, #DAA520 0%, #FFD700 25%, #B8860B 50%, #FFD700 75%, #DAA520 100%);
            background-size: 200% 100%;
        }

        /* Á¥ØÁ©çÈ°ØÁèæÂãïÁï´ - ÂæûÂàùÁàªÂà∞‰∏äÁàª */
        .loading-yao-line {
            opacity: 0;
            animation: yaoAccumulate 3s ease-in-out infinite;
        }

        .loading-yao-line:nth-child(1) { animation-delay: 0s; }
        .loading-yao-line:nth-child(2) { animation-delay: 0.4s; }
        .loading-yao-line:nth-child(3) { animation-delay: 0.8s; }
        .loading-yao-line:nth-child(4) { animation-delay: 1.2s; }
        .loading-yao-line:nth-child(5) { animation-delay: 1.6s; }
        .loading-yao-line:nth-child(6) { animation-delay: 2s; }

        @keyframes yaoAccumulate {
            0% { opacity: 0; transform: translateY(10px) scale(0.8); }
            15% { opacity: 1; transform: translateY(0) scale(1); }
            85% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-10px) scale(0.8); }
        }

        .loading-text {
            margin-top: 30px;
            color: #8B6F47;
            font-size: 1.2em;
            font-weight: 500;
        }

        .loading-subtext {
            margin-top: 10px;
            color: #A67B5B;
            font-size: 0.95em;
            opacity: 0.8;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }

        .progress-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(212, 165, 116, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8B6F47;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #A67B5B 0%, #8B6F47 100%);
            color: white;
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: #8B6F47;
            color: white;
        }

        .throw-count {
            text-align: center;
            font-size: 1.5em;
            color: #654321;
            margin: 20px 0;
            font-weight: bold;
        }

        .coin-result {
            text-align: center;
            font-size: 1.2em;
            color: #8B6F47;
            margin: 15px 0;
            min-height: 30px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 1.8em;
            }

            .coin {
                width: 60px;
                height: 60px;
                font-size: 1.2em;
            }

            .yao {
                width: 150px;
            }

            .yao.broken {
                width: 70px;
            }

            .yao.broken::after {
                left: 80px;
                width: 70px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìø ÊòìÁ∂ìÂç†Âçú</h1>
        <p class="subtitle">‰ª•Âè§ËÄÅÊô∫ÊÖßÔºåÁÖß‰∫ÆÊ±∫Á≠ñ‰πãË∑Ø</p>

        <!-- Ê≠•È©ü1: Ëº∏ÂÖ•ÂïèÈ°å -->
        <div class="step active" id="step1">
            <h2 style="color: #654321; margin-bottom: 20px;">Ë´ãËº∏ÂÖ•‰Ω†ÊÉ≥Âç†ÂçúÁöÑ‰∫ãÈ†Ö</h2>
            <textarea 
                class="question-input" 
                id="question" 
                rows="4" 
                placeholder="‰æãÂ¶ÇÔºöÊàëÊáâË©≤Êé•ÂèóÊñ∞Â∑•‰ΩúÁöÑÈÇÄË´ãÂóéÔºü&#10;Ë´ã‰ª•Ë™†ÂøÉË™†ÊÑèÁöÑÊÖãÂ∫¶ÊèêÂá∫‰Ω†ÁöÑÂïèÈ°å..."
            ></textarea>
            <div class="button-container">
                <button class="button" onclick="startDivination()">ÈñãÂßãÂç†Âçú</button>
            </div>
        </div>

        <!-- Ê≠•È©ü2: Êì≤Á°¨Âπ£ -->
        <div class="step" id="step2">
            <div class="coin-throwing">
                <div class="throw-count" id="throwCount">Á¨¨ 1 Áàª / ÂÖ± 6 Áàª</div>
                <p class="coin-instruction">Ë´ãÈªûÊìä‰∏ãÊñπ‰∏âÊûöÁ°¨Âπ£ÈÄ≤Ë°åÂç†Âçú</p>
                <p style="color: #8B6F47; margin-bottom: 20px;">ÔºàÊ®°Êì¨ÂêåÊôÇÊì≤Âá∫‰∏âÊûöÁ°¨Âπ£Ôºâ</p>
                
                <div class="coin-container" id="coinContainer">
                    <div class="coin" onclick="throwCoins()">
                        <span>Á°¨Âπ£</span>
                    </div>
                    <div class="coin" onclick="throwCoins()">
                        <span>Á°¨Âπ£</span>
                    </div>
                    <div class="coin" onclick="throwCoins()">
                        <span>Á°¨Âπ£</span>
                    </div>
                </div>

                <div class="coin-result" id="coinResult"></div>

                <div class="hexagram-display">
                    <div id="yaoDisplay"></div>
                </div>

                <div class="progress-indicator">
                    <div class="progress-dot active" id="dot1">1</div>
                    <div class="progress-dot" id="dot2">2</div>
                    <div class="progress-dot" id="dot3">3</div>
                    <div class="progress-dot" id="dot4">4</div>
                    <div class="progress-dot" id="dot5">5</div>
                    <div class="progress-dot" id="dot6">6</div>
                </div>
            </div>
        </div>

        <!-- Ê≠•È©ü3: È°ØÁ§∫ÁµêÊûú -->
        <div class="step" id="step3">
            <div class="loading" id="loading">
                <div class="loading-hexagram" id="loadingHexagram"></div>
                <p class="loading-text">Ê≠£Âú®Ëß£ËÆÄÂç¶Ë±°ÔºåË´ãÁ®çÂÄô...</p>
                <p class="loading-subtext">Ë™†ÂøÉÊÑüÊáâÂ§©Âú∞ÔºåÊô∫ÊÖßÂç≥Â∞áÈ°ØÁèæ</p>
            </div>
            
            <div id="result" style="display: none;">
                <div class="question-display">
                    <h4>üìø Âç†ÂçúÂïèÈ°å</h4>
                    <p id="questionDisplay"></p>
                </div>

                <div class="hexagram-display">
                    <div id="finalHexagram"></div>
                    <div class="hexagram-name" id="hexagramName"></div>
                    <div class="hexagram-info" id="hexagramInfo"></div>
                </div>

                <div class="original-text" id="originalText"></div>

                <div class="button-container" style="margin-top: 20px;" id="interpretButton">
                    <button class="button" onclick="startInterpretation()">üîÆ Âç¶Ë±°Ëß£ËÆÄ</button>
                </div>

                <div id="interpretationSection" style="display: none;">
                    <div class="loading" id="aiLoading">
                        <div class="loading-hexagram" id="aiLoadingHexagram"></div>
                        <p class="loading-text">Ê≠£Âú®Ëß£ËÆÄÂç¶Ë±°ÔºåË´ãÁ®çÂÄô...</p>
                        <p class="loading-subtext">Ë™†ÂøÉÊÑüÊáâÂ§©Âú∞ÔºåÊô∫ÊÖßÂç≥Â∞áÈ°ØÁèæ</p>
                    </div>
                    
                    <div id="aiResult" style="display: none;">
                        <div class="interpretation" id="interpretation"></div>
                    </div>
                </div>

                <div class="button-container" style="margin-top: 30px;" id="actionButtons">
                    <button class="button" onclick="downloadAsImage()" id="downloadBtn" style="display: none;">üì• ‰∏ãËºâËß£ËÆÄÂ†±Âëä</button>
                    <button class="button" onclick="restart()">üîÑ ÈáçÊñ∞Âç†Âçú</button>
                </div>
            </div>
        </div>
    </div>

    <!-- html2canvas Áî®Êñº‰∏ãËºâÂúñÁâá -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        // ÂÖ≠ÂçÅÂõõÂç¶Êï∏Êìö
        const HEXAGRAMS = {
            '111111': { number: 1, name: '‰πæ', description: '‰πæÁÇ∫Â§©', upper: '‰πæ', lower: '‰πæ' },
            '000000': { number: 2, name: 'Âù§', description: 'Âù§ÁÇ∫Âú∞', upper: 'Âù§', lower: 'Âù§' },
            '010001': { number: 3, name: 'Â±Ø', description: 'Ê∞¥Èõ∑Â±Ø', upper: 'Âùé', lower: 'Èúá' },
            '100010': { number: 4, name: 'Ëíô', description: 'Â±±Ê∞¥Ëíô', upper: 'ËâÆ', lower: 'Âùé' },
            '010111': { number: 5, name: 'ÈúÄ', description: 'Ê∞¥Â§©ÈúÄ', upper: 'Âùé', lower: '‰πæ' },
            '111010': { number: 6, name: 'Ë®ü', description: 'Â§©Ê∞¥Ë®ü', upper: '‰πæ', lower: 'Âùé' },
            '000010': { number: 7, name: 'Â∏´', description: 'Âú∞Ê∞¥Â∏´', upper: 'Âù§', lower: 'Âùé' },
            '010000': { number: 8, name: 'ÊØî', description: 'Ê∞¥Âú∞ÊØî', upper: 'Âùé', lower: 'Âù§' },
            '110111': { number: 9, name: 'Â∞èÁïú', description: 'È¢®Â§©Â∞èÁïú', upper: 'Â∑Ω', lower: '‰πæ' },
            '111011': { number: 10, name: 'Â±•', description: 'Â§©Êæ§Â±•', upper: '‰πæ', lower: 'ÂÖå' },
            '000111': { number: 11, name: 'Ê≥∞', description: 'Âú∞Â§©Ê≥∞', upper: 'Âù§', lower: '‰πæ' },
            '111000': { number: 12, name: 'Âê¶', description: 'Â§©Âú∞Âê¶', upper: '‰πæ', lower: 'Âù§' },
            '111101': { number: 13, name: 'Âêå‰∫∫', description: 'Â§©ÁÅ´Âêå‰∫∫', upper: '‰πæ', lower: 'Èõ¢' },
            '101111': { number: 14, name: 'Â§ßÊúâ', description: 'ÁÅ´Â§©Â§ßÊúâ', upper: 'Èõ¢', lower: '‰πæ' },
            '000100': { number: 15, name: 'Ë¨ô', description: 'Âú∞Â±±Ë¨ô', upper: 'Âù§', lower: 'ËâÆ' },
            '001000': { number: 16, name: 'Ë±´', description: 'Èõ∑Âú∞Ë±´', upper: 'Èúá', lower: 'Âù§' },
            '011001': { number: 17, name: 'Èö®', description: 'Êæ§Èõ∑Èö®', upper: 'ÂÖå', lower: 'Èúá' },
            '100110': { number: 18, name: 'Ë†±', description: 'Â±±È¢®Ë†±', upper: 'ËâÆ', lower: 'Â∑Ω' },
            '000011': { number: 19, name: 'Ëá®', description: 'Âú∞Êæ§Ëá®', upper: 'Âù§', lower: 'ÂÖå' },
            '110000': { number: 20, name: 'ËßÄ', description: 'È¢®Âú∞ËßÄ', upper: 'Â∑Ω', lower: 'Âù§' },
            '101001': { number: 21, name: 'Âô¨Âóë', description: 'ÁÅ´Èõ∑Âô¨Âóë', upper: 'Èõ¢', lower: 'Èúá' },
            '100101': { number: 22, name: 'Ë≥Å', description: 'Â±±ÁÅ´Ë≥Å', upper: 'ËâÆ', lower: 'Èõ¢' },
            '100000': { number: 23, name: 'Ââù', description: 'Â±±Âú∞Ââù', upper: 'ËâÆ', lower: 'Âù§' },
            '000001': { number: 24, name: 'Âæ©', description: 'Âú∞Èõ∑Âæ©', upper: 'Âù§', lower: 'Èúá' },
            '111001': { number: 25, name: 'ÁÑ°Â¶Ñ', description: 'Â§©Èõ∑ÁÑ°Â¶Ñ', upper: '‰πæ', lower: 'Èúá' },
            '100111': { number: 26, name: 'Â§ßÁïú', description: 'Â±±Â§©Â§ßÁïú', upper: 'ËâÆ', lower: '‰πæ' },
            '100001': { number: 27, name: 'È†§', description: 'Â±±Èõ∑È†§', upper: 'ËâÆ', lower: 'Èúá' },
            '011110': { number: 28, name: 'Â§ßÈÅé', description: 'Êæ§È¢®Â§ßÈÅé', upper: 'ÂÖå', lower: 'Â∑Ω' },
            '010010': { number: 29, name: 'Âùé', description: 'ÂùéÁÇ∫Ê∞¥', upper: 'Âùé', lower: 'Âùé' },
            '101101': { number: 30, name: 'Èõ¢', description: 'Èõ¢ÁÇ∫ÁÅ´', upper: 'Èõ¢', lower: 'Èõ¢' },
            '011100': { number: 31, name: 'Âí∏', description: 'Êæ§Â±±Âí∏', upper: 'ÂÖå', lower: 'ËâÆ' },
            '001110': { number: 32, name: 'ÊÅÜ', description: 'Èõ∑È¢®ÊÅÜ', upper: 'Èúá', lower: 'Â∑Ω' },
            '111100': { number: 33, name: 'ÈÅØ', description: 'Â§©Â±±ÈÅØ', upper: '‰πæ', lower: 'ËâÆ' },
            '001111': { number: 34, name: 'Â§ßÂ£Ø', description: 'Èõ∑Â§©Â§ßÂ£Ø', upper: 'Èúá', lower: '‰πæ' },
            '101000': { number: 35, name: 'Êôâ', description: 'ÁÅ´Âú∞Êôâ', upper: 'Èõ¢', lower: 'Âù§' },
            '000101': { number: 36, name: 'ÊòéÂ§∑', description: 'Âú∞ÁÅ´ÊòéÂ§∑', upper: 'Âù§', lower: 'Èõ¢' },
            '110101': { number: 37, name: 'ÂÆ∂‰∫∫', description: 'È¢®ÁÅ´ÂÆ∂‰∫∫', upper: 'Â∑Ω', lower: 'Èõ¢' },
            '101011': { number: 38, name: 'ÁùΩ', description: 'ÁÅ´Êæ§ÁùΩ', upper: 'Èõ¢', lower: 'ÂÖå' },
            '010100': { number: 39, name: 'Ëπá', description: 'Ê∞¥Â±±Ëπá', upper: 'Âùé', lower: 'ËâÆ' },
            '001010': { number: 40, name: 'Ëß£', description: 'Èõ∑Ê∞¥Ëß£', upper: 'Èúá', lower: 'Âùé' },
            '100011': { number: 41, name: 'Êêç', description: 'Â±±Êæ§Êêç', upper: 'ËâÆ', lower: 'ÂÖå' },
            '110001': { number: 42, name: 'Áõä', description: 'È¢®Èõ∑Áõä', upper: 'Â∑Ω', lower: 'Èúá' },
            '011111': { number: 43, name: 'Â§¨', description: 'Êæ§Â§©Â§¨', upper: 'ÂÖå', lower: '‰πæ' },
            '111110': { number: 44, name: 'Âß§', description: 'Â§©È¢®Âß§', upper: '‰πæ', lower: 'Â∑Ω' },
            '011000': { number: 45, name: 'ËêÉ', description: 'Êæ§Âú∞ËêÉ', upper: 'ÂÖå', lower: 'Âù§' },
            '000110': { number: 46, name: 'Âçá', description: 'Âú∞È¢®Âçá', upper: 'Âù§', lower: 'Â∑Ω' },
            '011010': { number: 47, name: 'Âõ∞', description: 'Êæ§Ê∞¥Âõ∞', upper: 'ÂÖå', lower: 'Âùé' },
            '010110': { number: 48, name: '‰∫ï', description: 'Ê∞¥È¢®‰∫ï', upper: 'Âùé', lower: 'Â∑Ω' },
            '011101': { number: 49, name: 'Èù©', description: 'Êæ§ÁÅ´Èù©', upper: 'ÂÖå', lower: 'Èõ¢' },
            '101110': { number: 50, name: 'Èºé', description: 'ÁÅ´È¢®Èºé', upper: 'Èõ¢', lower: 'Â∑Ω' },
            '001001': { number: 51, name: 'Èúá', description: 'ÈúáÁÇ∫Èõ∑', upper: 'Èúá', lower: 'Èúá' },
            '100100': { number: 52, name: 'ËâÆ', description: 'ËâÆÁÇ∫Â±±', upper: 'ËâÆ', lower: 'ËâÆ' },
            '110100': { number: 53, name: 'Êº∏', description: 'È¢®Â±±Êº∏', upper: 'Â∑Ω', lower: 'ËâÆ' },
            '001011': { number: 54, name: 'Ê≠∏Â¶π', description: 'Èõ∑Êæ§Ê≠∏Â¶π', upper: 'Èúá', lower: 'ÂÖå' },
            '001101': { number: 55, name: 'Ë±ê', description: 'Èõ∑ÁÅ´Ë±ê', upper: 'Èúá', lower: 'Èõ¢' },
            '101100': { number: 56, name: 'ÊóÖ', description: 'ÁÅ´Â±±ÊóÖ', upper: 'Èõ¢', lower: 'ËâÆ' },
            '110110': { number: 57, name: 'Â∑Ω', description: 'Â∑ΩÁÇ∫È¢®', upper: 'Â∑Ω', lower: 'Â∑Ω' },
            '011011': { number: 58, name: 'ÂÖå', description: 'ÂÖåÁÇ∫Êæ§', upper: 'ÂÖå', lower: 'ÂÖå' },
            '110010': { number: 59, name: 'Ê∏ô', description: 'È¢®Ê∞¥Ê∏ô', upper: 'Â∑Ω', lower: 'Âùé' },
            '010011': { number: 60, name: 'ÁØÄ', description: 'Ê∞¥Êæ§ÁØÄ', upper: 'Âùé', lower: 'ÂÖå' },
            '110011': { number: 61, name: '‰∏≠Â≠ö', description: 'È¢®Êæ§‰∏≠Â≠ö', upper: 'Â∑Ω', lower: 'ÂÖå' },
            '001100': { number: 62, name: 'Â∞èÈÅé', description: 'Èõ∑Â±±Â∞èÈÅé', upper: 'Èúá', lower: 'ËâÆ' },
            '010101': { number: 63, name: 'Êó¢Êøü', description: 'Ê∞¥ÁÅ´Êó¢Êøü', upper: 'Âùé', lower: 'Èõ¢' },
            '101010': { number: 64, name: 'Êú™Êøü', description: 'ÁÅ´Ê∞¥Êú™Êøü', upper: 'Èõ¢', lower: 'Âùé' }
        };

        // Âç¶Ëæ≠Êï∏ÊìöÔºàÁ∞°ÂåñÁâàÔºâ
        const HEXAGRAM_TEXTS = {
            1: { 
                gua: '‰πæÔºöÂÖÉ‰∫®Âà©Ë≤û„ÄÇ', 
                yong: 'Áî®‰πùÔºöË¶ãÁæ§ÈæçÁÑ°È¶ñÔºåÂêâ„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÊΩõÈæçÂãøÁî®„ÄÇ',
                    '‰πù‰∫åÔºöË¶ãÈæçÂú®Áî∞ÔºåÂà©Ë¶ãÂ§ß‰∫∫„ÄÇ',
                    '‰πù‰∏âÔºöÂêõÂ≠êÁµÇÊó•‰πæ‰πæÔºåÂ§ïÊÉïËã•Âé≤ÔºåÁÑ°Âíé„ÄÇ',
                    '‰πùÂõõÔºöÊàñË∫çÂú®Ê∑µÔºåÁÑ°Âíé„ÄÇ',
                    '‰πù‰∫îÔºöÈ£õÈæçÂú®Â§©ÔºåÂà©Ë¶ãÂ§ß‰∫∫„ÄÇ',
                    '‰∏ä‰πùÔºö‰∫¢ÈæçÊúâÊÇî„ÄÇ'
                ]
            },
            2: { 
                gua: 'Âù§ÔºöÂÖÉ‰∫®ÔºåÂà©ÁâùÈ¶¨‰πãË≤û„ÄÇÂêõÂ≠êÊúâÊî∏ÂæÄÔºåÂÖàËø∑ÂæåÂæó‰∏ªÔºåÂà©Ë•øÂçóÂæóÊúãÔºåÊù±ÂåóÂñ™Êúã„ÄÇÂÆâË≤ûÔºåÂêâ„ÄÇ', 
                yong: 'Áî®ÂÖ≠ÔºöÂà©Ê∞∏Ë≤û„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÂ±•ÈúúÔºåÂ†ÖÂÜ∞Ëá≥„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÁõ¥ÊñπÂ§ßÔºå‰∏çÁøíÊó†‰∏çÂà©„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÂê´Á´†ÂèØË≤û„ÄÇÊàñÂæûÁéã‰∫ãÔºåÊó†ÊàêÊúâÁµÇ„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÊã¨ÂõäÔºõÊó†ÂíéÔºåÊó†Ë≠Ω„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÈªÉË£≥ÔºåÂÖÉÂêâ„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÈæçÊà∞ÊñºÈáéÔºåÂÖ∂Ë°ÄÁéÑÈªÉ„ÄÇ'
                ]
            },
            3: {
                gua: 'Â±ØÔºöÂÖÉ‰∫®Âà©Ë≤ûÔºåÂãøÁî®ÔºåÊúâÊî∏ÂæÄÔºåÂà©Âª∫‰æØ„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÁ£êÊ°ìÔºõÂà©Â±ÖË≤ûÔºåÂà©Âª∫‰æØ„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÂ±ØÂ¶ÇÈÇÖÂ¶ÇÔºå‰πòÈ¶¨Áè≠Â¶Ç„ÄÇÂå™ÂØáÂ©öÂ™æÔºåÂ•≥Â≠êË≤û‰∏çÂ≠óÔºåÂçÅÂπ¥‰πÉÂ≠ó„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÂç≥ÈπøÊó†ËôûÔºåÊÉüÂÖ•ÊñºÊûó‰∏≠ÔºåÂêõÂ≠êÂπæ‰∏çÂ¶ÇËàçÔºåÂæÄÂêù„ÄÇ',
                    'ÂÖ≠ÂõõÔºö‰πòÈ¶¨Áè≠Â¶ÇÔºåÊ±ÇÂ©öÂ™æÔºåÂæÄÂêâÔºåÊó†‰∏çÂà©„ÄÇ',
                    '‰πù‰∫îÔºöÂ±ØÂÖ∂ËÜèÔºåÂ∞èË≤ûÂêâÔºåÂ§ßË≤ûÂá∂„ÄÇ',
                    '‰∏äÂÖ≠Ôºö‰πòÈ¶¨Áè≠Â¶ÇÔºåÊ≥£Ë°ÄÊº£Â¶Ç„ÄÇ'
                ]
            },
            4: {
                gua: 'ËíôÔºö‰∫®„ÄÇÂå™ÊàëÊ±ÇÁ´•ËíôÔºåÁ´•ËíôÊ±ÇÊàë„ÄÇÂàùÁ≠ÆÂëäÔºåÂÜç‰∏âÁÄÜÔºåÁÄÜÂâá‰∏çÂëä„ÄÇÂà©Ë≤û„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÁôºËíôÔºåÂà©Áî®Âàë‰∫∫ÔºåÁî®Ë™™Ê°éÊ¢èÔºå‰ª•ÂæÄÂêù„ÄÇ',
                    '‰πù‰∫åÔºöÂåÖËíôÂêâÔºõÁ¥çÂ©¶ÂêâÔºõÂ≠êÂÖãÂÆ∂„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÂãøÁî®Â®∂Â•≥ÔºõË¶ãÈáëÂ§´Ôºå‰∏çÊúâË∫¨ÔºåÊó†Êî∏Âà©„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÂõ∞ËíôÔºåÂêù„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÁ´•ËíôÔºåÂêâ„ÄÇ',
                    '‰∏ä‰πùÔºöÊìäËíôÔºõ‰∏çÂà©ÁÇ∫ÂØáÔºåÂà©Á¶¶ÂØá„ÄÇ'
                ]
            },
            5: {
                gua: 'ÈúÄÔºöÊúâÂ≠öÔºåÂÖâ‰∫®ÔºåË≤ûÂêâ„ÄÇÂà©Ê∂âÂ§ßÂ∑ù„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÈúÄ‰∫éÈÉä„ÄÇÂà©Áî®ÊÅÜÔºåÊó†Âíé„ÄÇ',
                    '‰πù‰∫åÔºöÈúÄ‰∫éÊ≤ô„ÄÇÂ∞èÊúâË®ÄÔºåÁµÇÂêâ„ÄÇ',
                    '‰πù‰∏âÔºöÈúÄ‰∫éÊ≥•ÔºåËá¥ÂØáËá≥„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÈúÄ‰∫éË°ÄÔºåÂá∫Ëá™Á©¥„ÄÇ',
                    '‰πù‰∫îÔºöÈúÄ‰∫éÈÖíÈ£üÔºåË≤ûÂêâ„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÂÖ•‰∫éÁ©¥ÔºåÊúâ‰∏çÈÄü‰πãÂÆ¢‰∏â‰∫∫‰æÜÔºåÊï¨‰πãÁµÇÂêâ„ÄÇ'
                ]
            },
            6: {
                gua: 'Ë®üÔºöÊúâÂ≠öÔºåÁ™í„ÄÇÊÉï‰∏≠Âêâ„ÄÇÁµÇÂá∂„ÄÇÂà©Ë¶ãÂ§ß‰∫∫Ôºå‰∏çÂà©Ê∂âÂ§ßÂ∑ù„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠Ôºö‰∏çÊ∞∏ÊâÄ‰∫ãÔºåÂ∞èÊúâË®ÄÔºåÁµÇÂêâ„ÄÇ',
                    '‰πù‰∫åÔºö‰∏çÂÖãË®üÔºåÊ≠∏ËÄåÈÄãÔºåÂÖ∂ÈÇë‰∫∫‰∏âÁôæÊà∂ÔºåÊó†Áúö„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÈ£üËàäÂæ∑ÔºåË≤ûÂé≤ÔºåÁµÇÂêâÔºåÊàñÂæûÁéã‰∫ãÔºåÊó†Êàê„ÄÇ',
                    '‰πùÂõõÔºö‰∏çÂÖãË®üÔºåÂæ©Âç≥ÂëΩÔºåÊ∏ùÂÆâË≤ûÔºåÂêâ„ÄÇ',
                    '‰πù‰∫îÔºöË®üÂÖÉÂêâ„ÄÇ',
                    '‰∏ä‰πùÔºöÊàñÈå´‰πãÈû∂Â∏∂ÔºåÁµÇÊúù‰∏âË§´‰πã„ÄÇ'
                ]
            },
            7: {
                gua: 'Â∏´ÔºöË≤ûÔºå‰∏à‰∫∫ÔºåÂêâÊó†Âíé„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÂ∏´Âá∫‰ª•ÂæãÔºåÂê¶ËáßÂá∂„ÄÇ',
                    '‰πù‰∫åÔºöÂú®Â∏´‰∏≠ÔºåÂêâÊó†ÂíéÔºåÁéã‰∏âÈå´ÂëΩ„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÂ∏´ÊàñËºøÂ∞∏ÔºåÂá∂„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÂ∏´Â∑¶Ê¨°ÔºåÊó†Âíé„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÁî∞ÊúâÁ¶ΩÔºåÂà©Âü∑Ë®ÄÔºåÊó†Âíé„ÄÇÈï∑Â≠êÂ∏•Â∏´ÔºåÂºüÂ≠êËºøÂ∞∏ÔºåË≤ûÂá∂„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÂ§ßÂêõÊúâÂëΩÔºåÈñãÂúãÊâøÂÆ∂ÔºåÂ∞è‰∫∫ÂãøÁî®„ÄÇ'
                ]
            },
            8: {
                gua: 'ÊØîÔºöÂêâ„ÄÇÂéüÁ≠ÆÂÖÉÊ∞∏Ë≤ûÔºåÊó†Âíé„ÄÇ‰∏çÂØßÊñπ‰æÜÔºåÂæåÂ§´Âá∂„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÊúâÂ≠öÊØî‰πãÔºåÊó†Âíé„ÄÇÊúâÂ≠öÁõàÁº∂ÔºåÁµÇ‰æÜÊúâÂÆÉÂêâ„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÊØî‰πãËá™ÂÖßÔºåË≤ûÂêâ„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÊØî‰πãÂå™‰∫∫„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÂ§ñÊØî‰πãÔºåË≤ûÂêâ„ÄÇ',
                    '‰πù‰∫îÔºöÈ°ØÊØîÔºåÁéãÁî®‰∏âÈ©ÖÔºåÂ§±ÂâçÁ¶Ω„ÄÇÈÇë‰∫∫‰∏çË™°ÔºåÂêâ„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÊØî‰πãÊó†È¶ñÔºåÂá∂„ÄÇ'
                ]
            },
            11: {
                gua: 'Ê≥∞ÔºöÂ∞èÂæÄÂ§ß‰æÜÔºåÂêâ‰∫®„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÊãîËåÖËåπÔºå‰ª•ÂÖ∂ÂΩôÔºåÂæÅÂêâ„ÄÇ',
                    '‰πù‰∫åÔºöÂåÖËçíÔºåÁî®È¶ÆÊ≤≥Ôºå‰∏çÈÅêÈÅ∫ÔºåÊúã‰∫°ÔºåÂæóÂ∞ö‰∫é‰∏≠Ë°å„ÄÇ',
                    '‰πù‰∏âÔºöÊó†Âπ≥‰∏çÈôÇÔºåÊó†ÂæÄ‰∏çÂæ©ÔºåËâ±Ë≤ûÊó†Âíé„ÄÇÂãøÊÅ§ÂÖ∂Â≠öÔºå‰∫éÈ£üÊúâÁ¶è„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÁø©Áø©‰∏çÂØåÔºå‰ª•ÂÖ∂ÈÑ∞Ôºå‰∏çÊàí‰ª•Â≠ö„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÂ∏ù‰πôÊ≠∏Â¶πÔºå‰ª•Á•âÂÖÉÂêâ„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÂüéÂæ©‰∫éÈöçÔºåÂãøÁî®Â∏´„ÄÇËá™ÈÇëÂëäÂëΩÔºåË≤ûÂêù„ÄÇ'
                ]
            },
            12: {
                gua: 'Âê¶ÔºöÂê¶‰πãÂå™‰∫∫Ôºå‰∏çÂà©ÂêõÂ≠êË≤ûÔºåÂ§ßÂæÄÂ∞è‰æÜ„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÊãîËåÖËåπÔºå‰ª•ÂÖ∂ÂΩôÔºåË≤ûÂêâ‰∫®„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÂåÖÊâø„ÄÇÂ∞è‰∫∫ÂêâÔºåÂ§ß‰∫∫Âê¶‰∫®„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÂåÖÁæû„ÄÇ',
                    '‰πùÂõõÔºöÊúâÂëΩÊó†ÂíéÔºåÁñáÈõ¢Á•â„ÄÇ',
                    '‰πù‰∫îÔºö‰ºëÂê¶ÔºåÂ§ß‰∫∫Âêâ„ÄÇÂÖ∂‰∫°ÂÖ∂‰∫°ÔºåÁπ´‰∫éËãûÊ°ë„ÄÇ',
                    '‰∏ä‰πùÔºöÂÇæÂê¶ÔºåÂÖàÂê¶ÂæåÂñú„ÄÇ'
                ]
            },
            13: {
                gua: 'Âêå‰∫∫ÔºöÂêå‰∫∫‰∫éÈáéÔºå‰∫®„ÄÇÂà©Ê∂âÂ§ßÂ∑ùÔºåÂà©ÂêõÂ≠êË≤û„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÂêå‰∫∫‰∫éÈñÄÔºåÊó†Âíé„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÂêå‰∫∫‰∫éÂÆóÔºåÂêù„ÄÇ',
                    '‰πù‰∏âÔºö‰ºèÊàé‰∫éËéΩÔºåÂçáÂÖ∂È´òÈôµÔºå‰∏âÊ≠≤‰∏çËàà„ÄÇ',
                    '‰πùÂõõÔºö‰πòÂÖ∂Â¢âÔºåÂºóÂÖãÊîªÔºåÂêâ„ÄÇ',
                    '‰πù‰∫îÔºöÂêå‰∫∫ÔºåÂÖàËôüÂí∑ËÄåÂæåÁ¨ë„ÄÇÂ§ßÂ∏´ÂÖãÁõ∏ÈÅá„ÄÇ',
                    '‰∏ä‰πùÔºöÂêå‰∫∫‰∫éÈÉäÔºåÊó†ÊÇî„ÄÇ'
                ]
            },
            14: {
                gua: 'Â§ßÊúâÔºöÂÖÉ‰∫®„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÊó†‰∫§ÂÆ≥ÔºåÂå™ÂíéÔºåËâ±ÂâáÊó†Âíé„ÄÇ',
                    '‰πù‰∫åÔºöÂ§ßËªä‰ª•ËºâÔºåÊúâÊî∏ÂæÄÔºåÊó†Âíé„ÄÇ',
                    '‰πù‰∏âÔºöÂÖ¨Áî®‰∫®‰∫éÂ§©Â≠êÔºåÂ∞è‰∫∫ÂºóÂÖã„ÄÇ',
                    '‰πùÂõõÔºöÂå™ÂÖ∂ÂΩ≠ÔºåÊó†Âíé„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÂé•Â≠ö‰∫§Â¶ÇÔºåÂ®ÅÂ¶ÇÔºõÂêâ„ÄÇ',
                    '‰∏ä‰πùÔºöËá™Â§©Á•ê‰πãÔºåÂêâÊó†‰∏çÂà©„ÄÇ'
                ]
            },
            15: {
                gua: 'Ë¨ôÔºö‰∫®ÔºåÂêõÂ≠êÊúâÁµÇ„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöË¨ôË¨ôÂêõÂ≠êÔºåÁî®Ê∂âÂ§ßÂ∑ùÔºåÂêâ„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÈ≥¥Ë¨ôÔºåË≤ûÂêâ„ÄÇ',
                    '‰πù‰∏âÔºöÂãûË¨ôÂêõÂ≠êÔºåÊúâÁµÇÂêâ„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÊó†‰∏çÂà©ÔºåÊíùË¨ô„ÄÇ',
                    'ÂÖ≠‰∫îÔºö‰∏çÂØå‰ª•ÂÖ∂ÈÑ∞ÔºåÂà©Áî®‰æµ‰ºêÔºåÊó†‰∏çÂà©„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÈ≥¥Ë¨ôÔºåÂà©Áî®Ë°åÂ∏´ÔºåÂæÅÈÇëÂúã„ÄÇ'
                ]
            },
            16: {
                gua: 'Ë±´ÔºöÂà©Âª∫‰æØË°åÂ∏´„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÈ≥¥Ë±´ÔºåÂá∂„ÄÇ',
                    'ÂÖ≠‰∫åÔºö‰ªã‰∫éÁü≥Ôºå‰∏çÁµÇÊó•ÔºåË≤ûÂêâ„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÁõ±Ë±´ÔºåÊÇî„ÄÇÈÅ≤ÊúâÊÇî„ÄÇ',
                    '‰πùÂõõÔºöÁî±Ë±´ÔºåÂ§ßÊúâÂæó„ÄÇÂãøÁñë„ÄÇÊúãÁõçÁ∞™„ÄÇ',
                    'ÂÖ≠‰∫îÔºöË≤ûÁñæÔºåÊÅÜ‰∏çÊ≠ª„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÂÜ•Ë±´ÔºåÊàêÊúâÊ∏ùÔºåÊó†Âíé„ÄÇ'
                ]
            },
            24: {
                gua: 'Âæ©Ôºö‰∫®„ÄÇÂá∫ÂÖ•Êó†ÁñæÔºåÊúã‰æÜÊó†Âíé„ÄÇÂèçÂæ©ÂÖ∂ÈÅìÔºå‰∏ÉÊó•‰æÜÂæ©ÔºåÂà©ÊúâÊî∏ÂæÄ„ÄÇ',
                yao: [
                    'Âàù‰πùÔºö‰∏çÈÅ†Âæ©ÔºåÊó†Á•óÊÇîÔºåÂÖÉÂêâ„ÄÇ',
                    'ÂÖ≠‰∫åÔºö‰ºëÂæ©ÔºåÂêâ„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÈ†ªÂæ©ÔºåÂé≤Êó†Âíé„ÄÇ',
                    'ÂÖ≠ÂõõÔºö‰∏≠Ë°åÁç®Âæ©„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÊï¶Âæ©ÔºåÊó†ÊÇî„ÄÇ',
                    '‰∏äÂÖ≠ÔºöËø∑Âæ©ÔºåÂá∂ÔºåÊúâÁÅΩÁúö„ÄÇÁî®Ë°åÂ∏´ÔºåÁµÇÊúâÂ§ßÊïóÔºå‰ª•ÂÖ∂ÂúãÂêõÂá∂ÔºåËá≥‰∫éÂçÅÂπ¥‰∏çÂÖãÂæÅ„ÄÇ'
                ]
            },
            29: {
                gua: 'ÂùéÔºöÁøíÂùéÔºåÊúâÂ≠öÔºåÁ∂≠ÂøÉ‰∫®ÔºåË°åÊúâÂ∞ö„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÁøíÂùéÔºåÂÖ•‰∫éÂùéÁ™ûÔºåÂá∂„ÄÇ',
                    '‰πù‰∫åÔºöÂùéÊúâÈö™ÔºåÊ±ÇÂ∞èÂæó„ÄÇ',
                    'ÂÖ≠‰∏âÔºö‰æÜ‰πãÂùéÂùéÔºåÈö™‰∏îÊûïÔºåÂÖ•‰∫éÂùéÁ™ûÔºåÂãøÁî®„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÊ®ΩÈÖíÁ∞ãË≤≥ÔºåÁî®Áº∂ÔºåÁ¥çÁ¥ÑËá™ÁâñÔºåÁµÇÊó†Âíé„ÄÇ',
                    '‰πù‰∫îÔºöÂùé‰∏çÁõàÔºåÁ•óÊó¢Âπ≥ÔºåÊó†Âíé„ÄÇ',
                    '‰∏äÂÖ≠Ôºö‰øÇÁî®ÂæΩÁ∫ÜÔºåÂØò‰∫éÂè¢Ê£òÔºå‰∏âÊ≠≤‰∏çÂæóÔºåÂá∂„ÄÇ'
                ]
            },
            30: {
                gua: 'Èõ¢ÔºöÂà©Ë≤ûÔºå‰∫®„ÄÇÁïúÁâùÁâõÔºåÂêâ„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÂ±•ÈåØÁÑ∂ÔºåÊï¨‰πãÊó†Âíé„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÈªÉÈõ¢ÔºåÂÖÉÂêâ„ÄÇ',
                    '‰πù‰∏âÔºöÊó•ÊòÉ‰πãÈõ¢Ôºå‰∏çÈºìÁº∂ËÄåÊ≠åÔºåÂâáÂ§ßËÄã‰πãÂóüÔºåÂá∂„ÄÇ',
                    '‰πùÂõõÔºöÁ™ÅÂ¶ÇÂÖ∂‰æÜÂ¶ÇÔºåÁÑöÂ¶ÇÔºåÊ≠ªÂ¶ÇÔºåÊ£ÑÂ¶Ç„ÄÇ',
                    'ÂÖ≠‰∫îÔºöÂá∫Ê∂ïÊ≤±Ëã•ÔºåÊàöÂóüËã•ÔºåÂêâ„ÄÇ',
                    '‰∏ä‰πùÔºöÁéãÁî®Âá∫ÂæÅÔºåÊúâÂòâÊäòÈ¶ñÔºåÁç≤Âå™ÂÖ∂ÈÜúÔºåÊó†Âíé„ÄÇ'
                ]
            },
            63: {
                gua: 'Êó¢ÊøüÔºö‰∫®ÔºåÂ∞èÂà©Ë≤ûÔºåÂàùÂêâÁµÇ‰∫Ç„ÄÇ',
                yao: [
                    'Âàù‰πùÔºöÊõ≥ÂÖ∂Ëº™ÔºåÊø°ÂÖ∂Â∞æÔºåÊó†Âíé„ÄÇ',
                    'ÂÖ≠‰∫åÔºöÂ©¶Âñ™ÂÖ∂ËåÄÔºåÂãøÈÄêÔºå‰∏ÉÊó•Âæó„ÄÇ',
                    '‰πù‰∏âÔºöÈ´òÂÆó‰ºêÈ¨ºÊñπÔºå‰∏âÂπ¥ÂÖã‰πãÔºåÂ∞è‰∫∫ÂãøÁî®„ÄÇ',
                    'ÂÖ≠ÂõõÔºöÁπªÊúâË°£Ë¢ΩÔºåÁµÇÊó•Êàí„ÄÇ',
                    '‰πù‰∫îÔºöÊù±ÈÑ∞ÊÆ∫ÁâõÔºå‰∏çÂ¶ÇË•øÈÑ∞‰πãÁ¶¥Á•≠ÔºåÂØ¶ÂèóÂÖ∂Á¶è„ÄÇ',
                    '‰∏äÂÖ≠ÔºöÊø°ÂÖ∂È¶ñÔºåÂé≤„ÄÇ'
                ]
            },
            64: {
                gua: 'Êú™ÊøüÔºö‰∫®ÔºåÂ∞èÁãêÊ±îÊøüÔºåÊø°ÂÖ∂Â∞æÔºåÊó†Êî∏Âà©„ÄÇ',
                yao: [
                    'ÂàùÂÖ≠ÔºöÊø°ÂÖ∂Â∞æÔºåÂêù„ÄÇ',
                    '‰πù‰∫åÔºöÊõ≥ÂÖ∂Ëº™ÔºåË≤ûÂêâ„ÄÇ',
                    'ÂÖ≠‰∏âÔºöÊú™ÊøüÔºåÂæÅÂá∂ÔºåÂà©Ê∂âÂ§ßÂ∑ù„ÄÇ',
                    '‰πùÂõõÔºöË≤ûÂêâÔºåÊÇî‰∫°ÔºåÈúáÁî®‰ºêÈ¨ºÊñπÔºå‰∏âÂπ¥ÊúâË≥û‰∫éÂ§ßÂúã„ÄÇ',
                    'ÂÖ≠‰∫îÔºöË≤ûÂêâÔºåÊó†ÊÇîÔºåÂêõÂ≠ê‰πãÂÖâÔºåÊúâÂ≠öÔºåÂêâ„ÄÇ',
                    '‰∏ä‰πùÔºöÊúâÂ≠ö‰∫éÈ£≤ÈÖíÔºåÊó†ÂíéÔºåÊø°ÂÖ∂È¶ñÔºåÊúâÂ≠öÂ§±ÊòØ„ÄÇ'
                ]
            }
        };

        // ÈÅäÊà≤ÁãÄÊÖã
        let gameState = {
            question: '',
            currentThrow: 0,
            yaos: [], // Â≠òÂÑ≤6ÂÄãÁàªÔºåÊØèÂÄãÁàªÊòØ6,7,8,9‰∏≠ÁöÑ‰∏ÄÂÄã
            changingYaos: [] // ËÆäÁàª‰ΩçÁΩÆ
        };

        function startDivination() {
            const question = document.getElementById('question').value.trim();
            if (!question) {
                alert('Ë´ãËº∏ÂÖ•‰Ω†ÊÉ≥Âç†ÂçúÁöÑ‰∫ãÈ†Ö');
                return;
            }
            
            gameState.question = question;
            gameState.currentThrow = 0;
            gameState.yaos = [];
            gameState.changingYaos = [];
            
            showStep(2);
            updateThrowDisplay();
        }

        function throwCoins() {
            if (gameState.currentThrow >= 6) return;

            const coins = document.querySelectorAll('.coin');
            coins.forEach(coin => coin.classList.add('flipping'));

            setTimeout(() => {
                // Ê®°Êì¨Êì≤‰∏âÂÄãÁ°¨Âπ£
                const results = [
                    Math.random() > 0.5 ? 3 : 2, // Ê≠£Èù¢3ÂàÜÔºåÂèçÈù¢2ÂàÜ
                    Math.random() > 0.5 ? 3 : 2,
                    Math.random() > 0.5 ? 3 : 2
                ];
                
                const sum = results.reduce((a, b) => a + b, 0);
                
                // È°ØÁ§∫Á°¨Âπ£ÁµêÊûú
                coins.forEach((coin, idx) => {
                    coin.classList.remove('flipping');
                    if (results[idx] === 3) {
                        coin.classList.add('heads');
                        coin.innerHTML = '<span>Ê≠£</span>';
                    } else {
                        coin.classList.add('tails');
                        coin.innerHTML = '<span>Âèç</span>';
                    }
                });

                // Ê†πÊìöÁ∏ΩÂàÜÁ¢∫ÂÆöÁàªÁöÑÈ°ûÂûã
                // 6 = ËÄÅÈô∞ÔºàËÆäÁàªÔºåÈô∞ËÆäÈôΩÔºâ
                // 7 = Â∞ëÈôΩÔºà‰∏çËÆäÔºâ
                // 8 = Â∞ëÈô∞Ôºà‰∏çËÆäÔºâ
                // 9 = ËÄÅÈôΩÔºàËÆäÁàªÔºåÈôΩËÆäÈô∞Ôºâ
                gameState.yaos.push(sum);
                
                if (sum === 6 || sum === 9) {
                    gameState.changingYaos.push(gameState.currentThrow);
                }

                // È°ØÁ§∫ÁµêÊûúÊñáÂ≠ó
                const resultText = {
                    6: 'ËÄÅÈô∞Ôºà‚Äî ‚ÄîÔºâËÆäÁàª',
                    7: 'Â∞ëÈôΩÔºà‚Äî‚Äî‚ÄîÔºâ',
                    8: 'Â∞ëÈô∞Ôºà‚Äî ‚ÄîÔºâ',
                    9: 'ËÄÅÈôΩÔºà‚Äî‚Äî‚ÄîÔºâËÆäÁàª'
                };
                document.getElementById('coinResult').textContent = resultText[sum];

                gameState.currentThrow++;
                updateThrowDisplay();
                updateYaoDisplay();

                if (gameState.currentThrow >= 6) {
                    setTimeout(() => {
                        calculateResult();
                    }, 1500);
                } else {
                    // ÈáçÁΩÆÁ°¨Âπ£Ê∫ñÂÇô‰∏ã‰∏ÄÊ¨°
                    setTimeout(() => {
                        coins.forEach(coin => {
                            coin.classList.remove('heads', 'tails');
                            coin.innerHTML = '<span>Á°¨Âπ£</span>';
                        });
                        document.getElementById('coinResult').textContent = '';
                    }, 1500);
                }
            }, 600);
        }

        function updateThrowDisplay() {
            document.getElementById('throwCount').textContent = 
                `Á¨¨ ${gameState.currentThrow + 1} Áàª / ÂÖ± 6 Áàª`;
            
            // Êõ¥Êñ∞ÈÄ≤Â∫¶Èªû
            for (let i = 1; i <= 6; i++) {
                const dot = document.getElementById(`dot${i}`);
                dot.classList.remove('active', 'completed');
                if (i - 1 < gameState.currentThrow) {
                    dot.classList.add('completed');
                } else if (i - 1 === gameState.currentThrow) {
                    dot.classList.add('active');
                }
            }
        }

        function updateYaoDisplay() {
            const display = document.getElementById('yaoDisplay');
            let html = '';
            
            // Âæû‰∏ãÂæÄ‰∏äÈ°ØÁ§∫ÔºàÁ¨¨‰∏ÄÁàªÂú®ÊúÄ‰∏ãÊñπÔºâ
            for (let i = gameState.yaos.length - 1; i >= 0; i--) {
                const yao = gameState.yaos[i];
                const isYang = (yao === 7 || yao === 9);
                const isChanging = (yao === 6 || yao === 9);
                
                html += `<div class="yao-line">
                    <span class="yao-number">${getYaoName(i)}</span>
                    <div class="yao-container">
                        <div class="yao ${!isYang ? 'broken' : ''} ${isChanging ? 'changing' : ''}"></div>
                    </div>
                </div>`;
            }
            
            display.innerHTML = html;
        }

        function getYaoName(index) {
            if (index === 0) return 'Âàù';
            if (index === 5) return '‰∏ä';
            return numberToChinese(index + 1);
        }

        function numberToChinese(num) {
            const chars = ['', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            return chars[num];
        }

        async function calculateResult() {
            showStep(3);
            
            // ÊßãÂª∫Êú¨Âç¶
            const originalHexagram = gameState.yaos.map(y => 
                (y === 7 || y === 9) ? '1' : '0'
            ).join('');
            
            // ÊßãÂª∫ËÆäÂç¶
            const changedHexagram = gameState.yaos.map(y => {
                if (y === 6) return '1'; // ËÄÅÈô∞ËÆäÈôΩ
                if (y === 9) return '0'; // ËÄÅÈôΩËÆäÈô∞
                return (y === 7) ? '1' : '0';
            }).join('');
            
            const originalGua = HEXAGRAMS[originalHexagram];
            const changedGua = HEXAGRAMS[changedHexagram];
            
            // Ê†πÊìöËÆäÁàªÊï∏ÈáèÁ¢∫ÂÆöËß£Âç¶ÊñπÊ≥ï
            gameState.interpretation = determineInterpretation(
                originalGua, 
                changedGua, 
                gameState.changingYaos,
                gameState.yaos
            );
            
            // È°ØÁ§∫Âç¶Ë±°ÂíåÂéüÊñá
            displayHexagramAndOriginalText(gameState.interpretation);
        }

        function displayHexagramAndOriginalText(interpretation) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            
            displayHexagramInfo(interpretation);
            displayOriginalText(interpretation);
        }

        async function startInterpretation() {
            // Èö±ËóèËß£ËÆÄÊåâÈàï
            document.getElementById('interpretButton').style.display = 'none';
            
            // È°ØÁ§∫Ëß£ËÆÄÂçÄÂüüÂíåÁ≠âÂæÖÂãïÁï´
            document.getElementById('interpretationSection').style.display = 'block';
            showLoadingHexagram();
            
            // Ë™øÁî®AIÁîüÊàêËß£ËÆÄ
            await generateAIInterpretation(gameState.interpretation);
            
            // È°ØÁ§∫‰∏ãËºâÊåâÈàï
            document.getElementById('downloadBtn').style.display = 'inline-block';
        }

        function showLoadingHexagram() {
            const loadingDisplay = document.getElementById('aiLoadingHexagram');
            let html = '';
            
            // Âæû‰∏ãÂæÄ‰∏äÈ°ØÁ§∫ÔºàÁ¨¨‰∏ÄÁàªÂú®ÊúÄ‰∏ãÊñπÔºâ
            for (let i = gameState.yaos.length - 1; i >= 0; i--) {
                const yao = gameState.yaos[i];
                const isYang = (yao === 7 || yao === 9);
                const isChanging = (yao === 6 || yao === 9);
                
                html += `<div class="loading-yao-line">
                    <span class="yao-number">${getYaoName(i)}</span>
                    <div class="yao-container">
                        <div class="loading-yao ${!isYang ? 'broken' : ''} ${isChanging ? 'changing' : ''}"></div>
                    </div>
                </div>`;
            }
            
            loadingDisplay.innerHTML = html;
        }

        function determineInterpretation(originalGua, changedGua, changingYaos, yaos) {
            const numChanging = changingYaos.length;
            let method = '';
            let textToUse = '';
            let yaoPositions = [];

            const originalTexts = HEXAGRAM_TEXTS[originalGua.number] || { gua: 'Âç¶Ëæ≠Êö´Áº∫', yao: [] };
            const changedTexts = HEXAGRAM_TEXTS[changedGua.number] || { gua: 'Âç¶Ëæ≠Êö´Áº∫', yao: [] };

            if (numChanging === 0) {
                method = 'ÂÖ≠ÁàªÁöÜ‰∏çËÆäÔºå‰ª•Êú¨Âç¶Âç¶Ëæ≠Êñ∑‰πã';
                textToUse = originalTexts.gua;
            } else if (numChanging === 1) {
                const pos = changingYaos[0];
                method = `‰∏ÄÁàªËÆäÔºå‰ª•Êú¨Âç¶Á¨¨${pos + 1}ÁàªÁàªËæ≠Êñ∑‰πã`;
                textToUse = originalTexts.yao[pos] || 'ÁàªËæ≠Êö´Áº∫';
                yaoPositions = [pos];
            } else if (numChanging === 2) {
                // ÂèñÈô∞ÁàªÔºåÂ¶ÇÈÉΩÊòØÈôΩÁàªÊàñÈô∞ÁàªÂâáÂèñ‰∏äÁàª
                const yao1 = yaos[changingYaos[0]];
                const yao2 = yaos[changingYaos[1]];
                const isYin1 = (yao1 === 6);
                const isYin2 = (yao2 === 6);
                
                let mainPos;
                if (isYin1 && !isYin2) {
                    mainPos = changingYaos[0];
                } else if (!isYin1 && isYin2) {
                    mainPos = changingYaos[1];
                } else {
                    mainPos = Math.max(...changingYaos);
                }
                
                method = `‰∫åÁàªËÆäÔºå‰ª•Êú¨Âç¶Á¨¨${mainPos + 1}ÁàªÁàªËæ≠ÁÇ∫‰∏ªÊñ∑`;
                textToUse = originalTexts.yao[mainPos] || 'ÁàªËæ≠Êö´Áº∫';
                yaoPositions = changingYaos;
            } else if (numChanging === 3) {
                method = '‰∏âÁàªËÆäÔºå‰ª•ËÆäÂç¶Âç¶Ëæ≠Êñ∑‰πãÔºõÊú¨Âç¶Âç¶Ëæ≠ÂèØ‰ΩúÂèÉËÄÉ';
                textToUse = changedTexts.gua;
            } else if (numChanging === 4) {
                const unchangedYaos = [0, 1, 2, 3, 4, 5].filter(i => !changingYaos.includes(i));
                const mainPos = Math.min(...unchangedYaos);
                method = `ÂõõÁàªËÆäÔºå‰ª•ËÆäÂç¶‰∏çËÆäÁöÑÁ¨¨${mainPos + 1}ÁàªÁàªËæ≠Êñ∑‰πã`;
                textToUse = changedTexts.yao[mainPos] || 'ÁàªËæ≠Êö´Áº∫';
                yaoPositions = unchangedYaos;
            } else if (numChanging === 5) {
                const unchangedYao = [0, 1, 2, 3, 4, 5].find(i => !changingYaos.includes(i));
                method = `‰∫îÁàªËÆäÔºå‰ª•ËÆäÂç¶‰∏çËÆäÁöÑÁ¨¨${unchangedYao + 1}ÁàªÁàªËæ≠Êñ∑‰πã`;
                textToUse = changedTexts.yao[unchangedYao] || 'ÁàªËæ≠Êö´Áº∫';
                yaoPositions = [unchangedYao];
            } else if (numChanging === 6) {
                if (originalGua.number === 1) {
                    method = 'ÂÖ≠ÁàªÁöÜËÆäÔºå‰πæÂç¶Áî®‰πù';
                    textToUse = originalTexts.yong || 'Áî®‰πùÔºöË¶ãÁæ§ÈæçÁÑ°È¶ñÔºåÂêâ„ÄÇ';
                } else if (originalGua.number === 2) {
                    method = 'ÂÖ≠ÁàªÁöÜËÆäÔºåÂù§Âç¶Áî®ÂÖ≠';
                    textToUse = originalTexts.yong || 'Áî®ÂÖ≠ÔºöÂà©Ê∞∏Ë≤û„ÄÇ';
                } else {
                    method = 'ÂÖ≠ÁàªÁöÜËÆäÔºå‰ª•ËÆäÂç¶Âç¶Ëæ≠Êñ∑‰πã';
                    textToUse = changedTexts.gua;
                }
            }

            return {
                originalGua,
                changedGua,
                method,
                textToUse,
                originalTexts,
                changedTexts,
                numChanging,
                changingYaos,
                yaoPositions
            };
        }

        async function generateAIInterpretation(interpretation) {
            const { originalGua, changedGua, method, textToUse, numChanging } = interpretation;

            // È°ØÁ§∫Âü∫Êú¨‰ø°ÊÅØ
            displayHexagramInfo(interpretation);

            // ÊßãÂª∫AIÊèêÁ§∫
            const prompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÁ≤æÈÄöÊòìÁ∂ìÁöÑÂç†ÂçúÂ∏´„ÄÇÁèæÊúâ‰∏Ä‰ΩçÊ±ÇÂç¶ËÄÖÂïèÔºö„Äå${gameState.question}„Äç

Âç†ÂçúÁµêÊûúÔºö
- Êú¨Âç¶Ôºö${originalGua.description}ÔºàÁ¨¨${originalGua.number}Âç¶Ôºâ
- ËÆäÂç¶Ôºö${changedGua.description}ÔºàÁ¨¨${changedGua.number}Âç¶Ôºâ
- ËÆäÁàªÊï∏ÈáèÔºö${numChanging}
- Êñ∑Âç¶ÊñπÊ≥ïÔºö${method}
- ‰æùÊìöÁ∂ìÊñáÔºö${textToUse}

Ë´ãÊ†πÊìö‰ª•‰∏äÂç¶Ë±°ÔºåÁµêÂêàÊ±ÇÂç¶ËÄÖÁöÑÂïèÈ°åÔºåÁµ¶Âá∫‰∏ÄÂÄãÊ∑±ÂÖ•„ÄÅÂÖ∑È´î„ÄÅÊúâË™™ÊúçÂäõÁöÑËß£ËÆÄ„ÄÇ‰Ω†ÁöÑËß£ËÆÄÊáâË©≤ÂåÖÊã¨Ôºö

**Âç¶Ë±°Á∏ΩËø∞**
Á∞°Ë¶ÅË™™ÊòéÈÄôÂÄãÂç¶Ë±°ÁöÑÊï¥È´îÂê´Áæ©ÂíåË±°Âæµ

**ÈáùÂ∞çÂïèÈ°åÁöÑÂàÜÊûê**
Â∞áÂç¶Ë±°ËàáÊ±ÇÂç¶ËÄÖÁöÑÂÖ∑È´îÂïèÈ°åÁµêÂêàÔºåÁµ¶Âá∫ÊòéÁ¢∫ÁöÑÊåáÂºï

**Ë°åÂãïÂª∫Ë≠∞**
Êèê‰æõÂÖ∑È´îÂèØË°åÁöÑÂª∫Ë≠∞ÔºåÂπ´Âä©Ê±ÇÂç¶ËÄÖÂÅöÂá∫Ê±∫Á≠ñ

**Ê≥®ÊÑè‰∫ãÈ†Ö**
ÊèêÈÜíÊ±ÇÂç¶ËÄÖÈúÄË¶ÅÊ≥®ÊÑèÁöÑÈ¢®Èö™ÊàñÊ©üÊúÉ

Ë´ãÁî®Ê∫´Âíå„ÄÅÊô∫ÊÖß„ÄÅÂÖÖÊªøÊ¥ûÂØüÂäõÁöÑË™ûÊ∞£ÔºåÂπ´Âä©Ê±ÇÂç¶ËÄÖÁêÜËß£Âç¶Ë±°ÁöÑÊ∑±ÊÑè„ÄÇÂÖßÂÆπÂú®500-700Â≠ó‰πãÈñìÂç≥ÂèØÔºå‰∏çÈúÄË¶ÅÁµ±Ë®àÂ≠óÊï∏„ÄÇ`;

            try {
                const response = await callDeepSeek([
                    { role: 'user', content: prompt }
                ]);

                displayInterpretation(response);
            } catch (error) {
                console.error('AIËß£ËÆÄÂ§±ÊïóÔºö', error);
                displayInterpretation(`
                    <div class="interpretation-section">
                        <h3>üìñ Á∂ìÊñá‰æùÊìö</h3>
                        <p>${textToUse}</p>
                    </div>
                    <div class="interpretation-section">
                        <h3>üîç Êñ∑Âç¶ÊñπÊ≥ï</h3>
                        <p>${method}</p>
                    </div>
                    <div class="interpretation-section">
                        <h3>üí° Á∞°Ë¶ÅËß£ËÆÄ</h3>
                        <p>Êú¨Ê¨°Âç†ÂçúÂæóÂà∞${originalGua.description}Ôºå${numChanging > 0 ? `Êúâ${numChanging}ÂÄãËÆäÁàªÔºåËÆäÁÇ∫${changedGua.description}„ÄÇ` : 'ÂÖ≠ÁàªÂÆâÂÆö„ÄÇ'}Ë´ãÁµêÂêàÂç¶Ëæ≠ÁàªËæ≠ÔºåÈùúÂøÉÊÄùËÄÉÂÖ∂‰∏≠Ê∑±ÊÑè„ÄÇ</p>
                    </div>
                `);
            }
        }

        function displayHexagramInfo(interpretation) {
            const { originalGua, changedGua, numChanging } = interpretation;
            
            // È°ØÁ§∫ÂïèÈ°å
            document.getElementById('questionDisplay').textContent = gameState.question;
            
            let hexagramHtml = '';
            
            if (numChanging > 0) {
                // ÊúâËÆäÁàªÔºöÂ∑¶Âè≥‰∏¶ÊéíÈ°ØÁ§∫Êú¨Âç¶ÂíåËÆäÂç¶
                hexagramHtml = '<div class="hexagram-comparison">';
                
                // Êú¨Âç¶ÔºàÂ∑¶ÂÅ¥Ôºâ
                hexagramHtml += '<div class="hexagram-single">';
                hexagramHtml += '<div class="hexagram-label">Êú¨Âç¶</div>';
                for (let i = gameState.yaos.length - 1; i >= 0; i--) {
                    const yao = gameState.yaos[i];
                    const isYang = (yao === 7 || yao === 9);
                    const isChanging = (yao === 6 || yao === 9);
                    
                    hexagramHtml += `<div class="yao-line">
                        <span class="yao-number">${getYaoName(i)}</span>
                        <div class="yao-container">
                            <div class="yao ${!isYang ? 'broken' : ''} ${isChanging ? 'changing' : ''}"></div>
                        </div>
                    </div>`;
                }
                hexagramHtml += '</div>';
                
                // ÁÆ≠È†≠
                hexagramHtml += '<div class="hexagram-arrow">‚Üí</div>';
                
                // ËÆäÂç¶ÔºàÂè≥ÂÅ¥Ôºâ
                hexagramHtml += '<div class="hexagram-single">';
                hexagramHtml += '<div class="hexagram-label">ËÆäÂç¶</div>';
                for (let i = gameState.yaos.length - 1; i >= 0; i--) {
                    const yao = gameState.yaos[i];
                    const wasChanging = (yao === 6 || yao === 9);
                    let newIsYang;
                    if (yao === 6) newIsYang = true;  // ËÄÅÈô∞ËÆäÈôΩ
                    else if (yao === 9) newIsYang = false; // ËÄÅÈôΩËÆäÈô∞
                    else newIsYang = (yao === 7 || yao === 9);
                    
                    hexagramHtml += `<div class="yao-line">
                        <span class="yao-number">${getYaoName(i)}</span>
                        <div class="yao-container">
                            <div class="yao ${!newIsYang ? 'broken' : ''} ${wasChanging ? 'changing' : ''}"></div>
                        </div>
                    </div>`;
                }
                hexagramHtml += '</div>';
                
                hexagramHtml += '</div>';
            } else {
                // ÁÑ°ËÆäÁàªÔºöÂñÆÁç®È°ØÁ§∫
                hexagramHtml = '<div>';
                for (let i = gameState.yaos.length - 1; i >= 0; i--) {
                    const yao = gameState.yaos[i];
                    const isYang = (yao === 7 || yao === 9);
                    
                    hexagramHtml += `<div class="yao-line">
                        <span class="yao-number">${getYaoName(i)}</span>
                        <div class="yao-container">
                            <div class="yao ${!isYang ? 'broken' : ''}"></div>
                        </div>
                    </div>`;
                }
                hexagramHtml += '</div>';
            }
            
            document.getElementById('finalHexagram').innerHTML = hexagramHtml;
            document.getElementById('hexagramName').textContent = 
                `${originalGua.description}${numChanging > 0 ? ' ‰πã ' + changedGua.description : ''}`;
            document.getElementById('hexagramInfo').textContent = 
                `Êú¨Âç¶ÔºöÁ¨¨${originalGua.number}Âç¶ ${originalGua.name}${numChanging > 0 ? `„ÄÄÔΩú„ÄÄËÆäÂç¶ÔºöÁ¨¨${changedGua.number}Âç¶ ${changedGua.name}` : ''}`;
        }

        function displayOriginalText(interpretation) {
            const { originalGua, changedGua, method, textToUse, originalTexts, changedTexts, numChanging, changingYaos } = interpretation;
            
            let html = '<h3>üìú Âë®ÊòìÂéüÊñá</h3>';
            html += `<div class="text-content"><strong>Âç¶Ëæ≠Ôºö</strong>${originalTexts.gua}</div>`;
            
            if (numChanging > 0 && changingYaos.length > 0) {
                html += '<div class="text-content" style="margin-top: 15px;"><strong>ËÆäÁàªÔºö</strong></div>';
                changingYaos.forEach(pos => {
                    html += `<div class="changing-yao-text">${originalTexts.yao[pos] || 'ÁàªËæ≠Êö´Áº∫'}</div>`;
                });
            }
            
            if (numChanging === 6 && originalTexts.yong) {
                html += `<div class="text-content" style="margin-top: 15px;"><strong>Áî®Ëæ≠Ôºö</strong>${originalTexts.yong}</div>`;
            }
            
            if (numChanging >= 3) {
                html += `<div class="text-content" style="margin-top: 15px;"><strong>ËÆäÂç¶Âç¶Ëæ≠Ôºö</strong>${changedTexts.gua}</div>`;
            }
            
            html += `<div class="text-content" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #D4A574;"><strong>Êñ∑Âç¶ÊñπÊ≥ïÔºö</strong>${method}</div>`;
            html += `<div class="text-content"><strong>‰æùÊìöÁ∂ìÊñáÔºö</strong>${textToUse}</div>`;
            
            document.getElementById('originalText').innerHTML = html;
        }

        function displayInterpretation(text) {
            document.getElementById('aiLoading').style.display = 'none';
            document.getElementById('aiResult').style.display = 'block';
            
            const interpretationDiv = document.getElementById('interpretation');
            
            // ËôïÁêÜÊñáÊú¨ÔºåÂ∞á **Ê®ôÈ°å** ËΩâÊèõÁÇ∫Ê®£ÂºèÂåñÁöÑÊ®ôÈ°å
            let processedText = text
                .replace(/\*\*([^*]+)\*\*/g, '<div class="section-title">$1</div>')
                .replace(/Â≠óÊï∏[Áµ±Áªü]Ë®à.*$/gm, ''); // ÁßªÈô§Â≠óÊï∏Áµ±Ë®à
            
            // Â¶ÇÊûúÂ∑≤Á∂ìÂåÖÂê´HTMLÊ®ôÁ±§ÔºåÁõ¥Êé•‰ΩøÁî®
            if (processedText.includes('<div')) {
                interpretationDiv.innerHTML = '<h3>üîÆ Âç¶Ë±°Ëß£ËÆÄ</h3>' + processedText;
            } else {
                // Âê¶ÂâáÈÄ≤Ë°åÊÆµËêΩÂàÜÂâ≤
                const paragraphs = processedText.split('\n\n').filter(p => p.trim());
                let html = '<h3>üîÆ Âç¶Ë±°Ëß£ËÆÄ</h3>';
                paragraphs.forEach(p => {
                    const trimmed = p.trim();
                    if (trimmed) {
                        // Â¶ÇÊûúÊÆµËêΩÂ∑≤Á∂ìÊòØÊ®ôÈ°åÔºåÁõ¥Êé•‰ΩøÁî®
                        if (trimmed.startsWith('<div class="section-title">')) {
                            html += trimmed;
                        } else {
                            html += `<p>${trimmed}</p>`;
                        }
                    }
                });
                interpretationDiv.innerHTML = html;
            }
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(`step${stepNumber}`).classList.add('active');
        }

        function restart() {
            gameState = {
                question: '',
                currentThrow: 0,
                yaos: [],
                changingYaos: []
            };
            document.getElementById('question').value = '';
            showStep(1);
        }

        async function downloadAsImage() {
            const button = event.target;
            
            // Á¶ÅÁî®ÊåâÈàï‰∏¶È°ØÁ§∫ËôïÁêÜ‰∏≠
            button.disabled = true;
            button.textContent = '‚è≥ ÁîüÊàê‰∏≠...';
            
            try {
                // ÂâµÂª∫‰∏ÄÂÄãÂåÖÂê´ÊâÄÊúâÂÖßÂÆπÁöÑÂÆπÂô®
                const downloadContainer = document.createElement('div');
                downloadContainer.style.padding = '40px';
                downloadContainer.style.backgroundColor = '#FFF8F0';
                downloadContainer.style.maxWidth = '900px';
                downloadContainer.style.margin = '0 auto';
                
                // Ë§áË£ΩÂïèÈ°å
                const questionClone = document.querySelector('.question-display').cloneNode(true);
                downloadContainer.appendChild(questionClone);
                
                // Ë§áË£ΩÂç¶Ë±°
                const hexagramClone = document.querySelector('.hexagram-display').cloneNode(true);
                downloadContainer.appendChild(hexagramClone);
                
                // Ë§áË£ΩÂéüÊñá
                const originalTextClone = document.getElementById('originalText').cloneNode(true);
                downloadContainer.appendChild(originalTextClone);
                
                // Ë§áË£ΩËß£ËÆÄÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                const interpretationElem = document.getElementById('interpretation');
                if (interpretationElem && interpretationElem.innerHTML.trim()) {
                    const interpretationClone = document.createElement('div');
                    interpretationClone.className = 'interpretation';
                    interpretationClone.innerHTML = interpretationElem.innerHTML;
                    downloadContainer.appendChild(interpretationClone);
                }
                
                // Êö´ÊôÇÊ∑ªÂä†Âà∞body
                downloadContainer.style.position = 'absolute';
                downloadContainer.style.left = '-9999px';
                document.body.appendChild(downloadContainer);
                
                // Êö´ÊôÇÈö±ËóèËÆäÁàªÂãïÁï´‰ª•‰æøÊà™Âúñ
                const changingYaos = downloadContainer.querySelectorAll('.yao.changing');
                changingYaos.forEach(yao => {
                    yao.style.animation = 'none';
                });
                
                // ‰ΩøÁî® html2canvas ÁîüÊàêÂúñÁâá
                const canvas = await html2canvas(downloadContainer, {
                    backgroundColor: '#FFF8F0',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });
                
                // ÁßªÈô§Ëá®ÊôÇÂÆπÂô®
                document.body.removeChild(downloadContainer);
                
                // ËΩâÊèõÁÇ∫ÂúñÁâá‰∏¶‰∏ãËºâ
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const date = new Date().toISOString().slice(0, 10);
                    link.download = `ÊòìÁ∂ìÂç†ÂçúËß£ËÆÄ_${date}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    // ÊÅ¢Âæ©ÊåâÈàï
                    button.disabled = false;
                    button.textContent = 'üì• ‰∏ãËºâËß£ËÆÄÂ†±Âëä';
                });
                
            } catch (error) {
                console.error('ÁîüÊàêÂúñÁâáÂ§±ÊïóÔºö', error);
                alert('‰∏ãËºâÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                button.disabled = false;
                button.textContent = 'üì• ‰∏ãËºâËß£ËÆÄÂ†±Âëä';
            }
        }

        // DeepSeek API Ë™øÁî®
        async function callDeepSeek(messages) {
            const DEEPSEEK_PROXY_URL = window.DEEPSEEK_PROXY_URL || 
                                      localStorage.getItem('DEEPSEEK_PROXY_URL') || 
                                      'https://deepseek-proxy-chi.vercel.app/api/deepseek';
            
            const response = await fetch(DEEPSEEK_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages,
                    temperature: 0.8,
                    max_tokens: 1500
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            return data.choices?.[0]?.message?.content || '';
        }
    </script>
</body>
</html>

