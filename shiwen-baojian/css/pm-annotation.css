/* ============= PM 批註系統（師生端共用樣式） ============= */
/* 擴寬頁面容器，減少右側無效留白 */
#teacher-dashboard .max-w-7xl,
#student-dashboard .max-w-7xl { max-width: 1600px; }

/* 中欄最小寬度，避免正文被擠壓過小 */
#teacher-dashboard .main-content-area { min-width: 640px; }
#student-dashboard .main-content-area { min-width: 640px; }
/* 由 student-annotation-system.css 重命名整合為單一共用樣式 */

/* 論文模式（PM 文檔）視覺優化 */
.pm-essay.pm-essay-structured { counter-reset: pm-para; }
.pm-essay.pm-essay-structured p { position: relative; padding-left: 2.25rem; margin: 0.45rem 0 0.75rem; line-height: 1.9; }
.pm-essay.pm-essay-structured p::before { content: '段落 ' counter(pm-para); counter-increment: pm-para; position: absolute; top: -0.4rem; left: 0; color: #9ca3af; font-size: 0.72rem; }
.pm-essay.pm-essay-structured p:hover { background: #fafaf9; }

/* 右欄改為固定側欄（#ann-sidebar），不再使用 padding 預留空間 */
/* #teacher-dashboard .essay-viewer { position: relative; } */
/* #student-dashboard #essay-editor { } */

/* PM 裝飾：批註高亮（設計令牌 + 後備色） */
.pm-annotation { background: var(--warning-100, rgba(251,191,36,0.22)); box-shadow: inset 0 -2px 0 var(--warning-600, rgba(245,158,11,0.55)); border-radius: 2px; transition: background-color .15s ease, box-shadow .15s ease; cursor: pointer; }
.pm-annotation:hover { background: var(--warning-200, rgba(251,191,36,0.32)); }
.pm-annotation:focus-visible { outline: 2px solid var(--primary-600, #2563eb); outline-offset: 1px; }
.pm-annotation-active {
  background: rgba(250, 204, 21, 0.32);
  box-shadow: 0 0 0 2px rgba(59,130,246,.45), inset 0 -2px 0 var(--warning-700, rgba(245,158,11,0.75));
  animation: pmPulseActive 1.8s ease-out infinite; /* 持續脈衝直到取消 active */
}
.pm-annotation-pulse { animation: pmPulse 900ms ease-out 1; }
@keyframes pmPulse { 0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.35), inset 0 -2px 0 var(--warning-600, rgba(245,158,11,0.55)); } 60% { box-shadow: 0 0 0 8px rgba(59,130,246,0.0), inset 0 -2px 0 var(--warning, rgba(245,158,11,0.55)); } 100% { box-shadow: inset 0 -2px 0 var(--warning-600, rgba(245,158,11,0.55)); } }
@keyframes pmPulseActive { 0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.35), inset 0 -2px 0 var(--warning-700, rgba(245,158,11,0.75)); } 70% { box-shadow: 0 0 0 10px rgba(59,130,246,0.0), inset 0 -2px 0 var(--warning-700, rgba(245,158,11,0.75)); } 100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.0), inset 0 -2px 0 var(--warning-700, rgba(245,158,11,0.75)); } }
.pm-annotation-approx { background: var(--warning-50, rgba(253,230,138,0.25)); box-shadow: inset 0 -2px 0 rgba(245, 158, 11, 0.35); }
.pm-annotation-orphan { background: rgba(156,163,175,0.18); box-shadow: inset 0 -2px 0 rgba(107,114,128,0.4); border-bottom: 1px dashed #9ca3af; }

/* 學生端批註側欄（通用卡片樣式） */
#student-ann-sidebar .student-ann-header { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #374151; }
#student-ann-sidebar .student-ann-list { padding: 8px; }
#student-ann-sidebar .student-ann-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 10px; margin-bottom: 8px; cursor: pointer; background: #fff; }
#student-ann-sidebar .student-ann-card:hover { background: #f9fafb; }
#student-ann-sidebar .student-ann-card.active { outline: 2px solid #60a5fa; outline-offset: 2px; }

/* ProseMirror 基礎樣式（必要） */
.ProseMirror { white-space: pre-wrap; word-wrap: break-word; outline: none; min-height: 240px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; }
.ProseMirror p { margin: 0 0 0.75rem 0; }
.ProseMirror-focused { outline: none; }

/* 中欄（正文）建議寬度，避免行寬過長（師生一致） */
.pm-viewer { width: 100%; max-width: none; }
#essay-editor .ProseMirror { width: 100%; max-width: none; }

/* 老師端：批註工具列按鈕（與設計令牌對齊） */
.btn-annotation-add { display: inline-flex; align-items: center; gap: 6px; background: var(--primary-600, #2563eb); color: var(--text-inverse, #fff); border: none; border-radius: 8px; padding: 8px 12px; box-shadow: 0 2px 6px rgba(37,99,235,0.25); transition: transform .08s ease, box-shadow .15s ease, background .15s ease; }
.btn-annotation-add:hover { background: var(--primary-700, #1d4ed8); box-shadow: 0 6px 12px rgba(29,78,216,0.25); }
.btn-annotation-add:active { transform: translateY(1px); }
.btn-annotation-stats { display: inline-flex; align-items: center; gap: 6px; background: var(--neutral-100, #f3f4f6); color: var(--neutral-700, #374151); border: 1px solid var(--neutral-200, #e5e7eb); border-radius: 8px; padding: 8px 12px; }
.btn-annotation-stats:hover { background: var(--neutral-200, #e5e7eb); }

/* 響應式調整（學生端容器寬度） */
#student-dashboard .main-content-area { max-width: none; position: relative; overflow: visible; }
#student-dashboard { max-width: 1800px; margin: 0 auto; }
#student-dashboard .grading-content-wrapper { overflow: visible; max-height: none; }

/* 老師端覆蓋：移除舊 78% 佈局與內邊距，讓中欄完全佔滿 grid 中列 */
#teacher-dashboard .main-content-area { max-width: none; width: 100%; position: relative; overflow: visible; }

/* 師生端統一：取消舊容器 padding，三欄間距僅由 column-gap 控制 */
#teacher-dashboard .grading-content-wrapper,
#student-dashboard .grading-content-wrapper { padding: 0; }

@media (max-width: 1024px) {
  #student-dashboard .flex { flex-direction: column; }
  #student-dashboard aside { position: relative !important; width: 100% !important; max-height: none !important; margin-bottom: 1rem; }
  #student-dashboard .main-content-area { max-width: 100%; }
}

@media (max-width: 768px) {
  #student-dashboard .main-content-area { max-width: 100%; }
}

/* ============= 右側批註疊加層（Google Docs 風格） ============= */
.pm-ann-overlay { position: absolute; top: 0; left: 0; right: 0; width: 100%; pointer-events: none; }
.pm-ann-card { position: absolute; right: 0; width: 100%; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,.06); padding: 10px 12px; pointer-events: auto; }
.pm-ann-card:hover { box-shadow: 0 10px 36px rgba(0,0,0,.08); }
.pm-ann-card .pm-ann-meta { font-size: 12px; color: #6b7280; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.pm-ann-card .pm-ann-text { font-size: 14px; color: #374151; line-height: 1.5; }
.pm-ann-card.active { outline: 2px solid #60a5fa; outline-offset: 2px; }

/* 回覆數徽章（置於卡片 meta 最右側） */
.pm-ann-card .pm-ann-meta { position: relative; }
.pm-ann-card .pm-ann-reply-count { margin-left: auto; display: inline-flex; align-items: center; justify-content: center; min-width: 18px; height: 18px; padding: 0 6px; border-radius: 9px; background: #eef2ff; color: #374151; font-weight: 600; font-size: 12px; border: 1px solid #e5e7eb; }

/* 卡片動作列：預留高度避免 hover 抖動，僅改變透明度與可點擊性 */
.pm-ann-card .pm-ann-actions { display: flex; gap: 8px; margin-top: 8px; min-height: 28px; opacity: 0; pointer-events: none; transition: opacity .15s ease; }
.pm-ann-card:hover .pm-ann-actions,
.pm-ann-card.active .pm-ann-actions { opacity: 1; pointer-events: auto; }
.pm-ann-card .pm-ann-actions .pm-ann-btn-reply,
.pm-ann-card .pm-ann-actions .pm-ann-btn-delete { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 6px; border: 1px solid #e5e7eb; background: #f9fafb; color: #374151; cursor: pointer; font-size: 12px; }
.pm-ann-card .pm-ann-actions .pm-ann-btn-reply:hover { background: #eef2ff; border-color: #c7d2fe; color: #1f2937; }
.pm-ann-card .pm-ann-actions .pm-ann-btn-delete { color: #b91c1c; background: #fff1f2; border-color: #fecdd3; }
.pm-ann-card .pm-ann-actions .pm-ann-btn-delete:hover { background: #ffe4e6; }

/* 回覆列表樣式 */
.pm-ann-card .pm-ann-replies { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e5e7eb; }
.pm-ann-card .pm-ann-reply { margin-bottom: 6px; }
.pm-ann-card .pm-ann-reply-meta { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #6b7280; }
.pm-ann-card .pm-ann-reply-meta .pm-ann-reply-del { margin-left: auto; border: none; background: transparent; color: #9ca3af; cursor: pointer; padding: 2px; border-radius: 4px; }
.pm-ann-card .pm-ann-reply-meta .pm-ann-reply-del:hover { color: #ef4444; background: #fee2e2; }
.pm-ann-card .pm-ann-reply-text { font-size: 13px; color: #374151; margin-top: 2px; line-height: 1.5; }
.pm-ann-card .pm-ann-replies-toggle { margin-top: 6px; }
.pm-ann-card .pm-ann-replies-toggle button { font-size: 12px; color: #2563eb; background: transparent; border: none; cursor: pointer; padding: 0; }
.pm-ann-card .pm-ann-replies-toggle button:hover { text-decoration: underline; }

/* 暫存回覆（樂觀更新） */
.pm-ann-card .pm-ann-reply.is-pending { opacity: 0.7; font-style: italic; }

/* 添加批註浮動輸入框（選區附近） */
.pm-ann-composer { position: absolute; z-index: 1101; width: 100%; max-width: none; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 12px 32px rgba(0,0,0,.14); padding: 10px; }
.pm-ann-composer textarea { width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; resize: vertical; min-height: 72px; font-family: inherit; font-size: 14px; }
.pm-ann-composer .actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
.pm-ann-composer .btn { border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
.pm-ann-composer .btn-primary { background: var(--primary-600, #2563eb); color: #fff; }
.pm-ann-composer .btn-primary:hover { background: var(--primary-700, #1d4ed8); }
.pm-ann-composer .btn-ghost { background: #f3f4f6; color: #374151; }
.pm-ann-composer .btn-ghost:hover { background: #e5e7eb; }

/* 三欄固定佈局：左欄（w-72）+ 中欄（1fr）+ 右欄（w-72）且列距一致 */
@media (min-width: 1024px) {
  .layout-3col { display: grid !important; grid-template-columns: 18rem 1fr 18rem; column-gap: 1.5rem; align-items: start; }
}


