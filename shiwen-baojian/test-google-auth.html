<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时文宝鉴 - Google OAuth 测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    
    <div class="max-w-2xl w-full bg-white rounded-lg shadow-lg p-8">
        <!-- 标题 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">时文宝鉴</h1>
            <p class="text-gray-600">Google OAuth 登录测试</p>
        </div>

        <!-- 登录区域 -->
        <div id="loginArea" class="space-y-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-blue-800">
                    <strong>测试说明：</strong><br>
                    1. 点击下方按钮使用 Google 账号登录<br>
                    2. 系统会自动识别你的角色（老师/学生）<br>
                    3. 查看登录结果确认配置是否正确
                </p>
            </div>

            <!-- Google 登录按钮 -->
            <button 
                id="googleLoginBtn"
                class="w-full bg-white border-2 border-gray-300 hover:border-blue-500 text-gray-700 font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-3 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>使用 Google 账号登录</span>
            </button>

            <!-- 匿名登录按钮（测试用） -->
            <button 
                id="anonymousLoginBtn"
                class="w-full bg-gray-100 border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-all">
                匿名登录（测试用）
            </button>
        </div>

        <!-- 用户信息区域（登录后显示） -->
        <div id="userInfo" class="hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-green-800 mb-3">✅ 登录成功！</h3>
                
                <div class="space-y-2 text-sm">
                    <div class="flex">
                        <span class="font-semibold text-gray-700 w-24">邮箱：</span>
                        <span id="userEmail" class="text-gray-900"></span>
                    </div>
                    <div class="flex">
                        <span class="font-semibold text-gray-700 w-24">姓名：</span>
                        <span id="userName" class="text-gray-900"></span>
                    </div>
                    <div class="flex">
                        <span class="font-semibold text-gray-700 w-24">用户 ID：</span>
                        <span id="userId" class="text-gray-900 text-xs"></span>
                    </div>
                    <div class="flex">
                        <span class="font-semibold text-gray-700 w-24">识别角色：</span>
                        <span id="userRole" class="font-bold"></span>
                    </div>
                    <div class="flex">
                        <span class="font-semibold text-gray-700 w-24">登录方式：</span>
                        <span id="loginProvider" class="text-gray-900"></span>
                    </div>
                </div>
            </div>

            <!-- 测试结果 -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-blue-800 mb-2">测试结果：</h4>
                <ul class="text-sm space-y-1 text-blue-900">
                    <li id="testResult1">⏳ 检查中...</li>
                    <li id="testResult2">⏳ 检查中...</li>
                    <li id="testResult3">⏳ 检查中...</li>
                </ul>
            </div>

            <!-- 登出按钮 -->
            <button 
                id="logoutBtn"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                登出
            </button>
        </div>

        <!-- 错误信息区域 -->
        <div id="errorArea" class="hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-red-800 mb-2">❌ 登录失败</h3>
                <p id="errorMessage" class="text-sm text-red-700"></p>
                <button 
                    onclick="location.reload()"
                    class="mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded">
                    重新尝试
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Supabase 配置
        const SUPABASE_URL = 'https://ohseemszgahvojgocjqq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oc2VlbXN6Z2Fodm9qZ29janFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTAyMDIsImV4cCI6MjA3NjM2NjIwMn0.Q79ML8tgC4CJ0Nf9PHZy4DzUMd4ApBBF9lMWKB1MYi8';

        // 创建 Supabase 客户端
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 角色识别函数
        function detectRole(email) {
            if (!email) return 'anonymous';
            if (email.endsWith('@isf.edu.hk')) return 'teacher';
            if (email.endsWith('@student.isf.edu.hk')) return 'student';
            return 'unknown';
        }

        // Google 登录
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.href
                    }
                });

                if (error) throw error;
                
                // OAuth 会重定向，等待回调
            } catch (error) {
                console.error('Google 登录错误:', error);
                showError(error.message);
            }
        });

        // 匿名登录
        document.getElementById('anonymousLoginBtn').addEventListener('click', async () => {
            try {
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) throw error;
                
                console.log('匿名登录成功:', data);
                await handleAuthSuccess(data);
            } catch (error) {
                console.error('匿名登录错误:', error);
                showError(error.message);
            }
        });

        // 登出
        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
            await supabase.auth.signOut();
            location.reload();
        });

        // 处理登录成功
        async function handleAuthSuccess(data) {
            const user = data.user;
            
            // 显示用户信息
            document.getElementById('loginArea').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            
            const email = user.email || '（匿名用户）';
            const displayName = user.user_metadata?.name || user.user_metadata?.full_name || '匿名用户';
            const role = detectRole(email);
            const provider = user.app_metadata?.provider || 'anonymous';

            document.getElementById('userEmail').textContent = email;
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userId').textContent = user.id;
            document.getElementById('userRole').textContent = role;
            document.getElementById('userRole').className = 
                role === 'teacher' ? 'font-bold text-blue-600' : 
                role === 'student' ? 'font-bold text-green-600' : 
                'font-bold text-gray-600';
            document.getElementById('loginProvider').textContent = 
                provider === 'google' ? 'Google OAuth' : '匿名登录';

            // 运行测试
            runTests(user, role);
        }

        // 运行测试
        function runTests(user, role) {
            const results = {
                result1: '❌ 未测试',
                result2: '❌ 未测试',
                result3: '❌ 未测试'
            };

            // 测试 1：OAuth 提供商
            if (user.app_metadata?.provider === 'google') {
                results.result1 = '✅ Google OAuth 配置正确';
            } else if (user.app_metadata?.provider === 'anonymous') {
                results.result1 = '✅ 匿名登录正常工作';
            } else {
                results.result1 = '⚠️ 未知的登录提供商';
            }

            // 测试 2：角色识别
            if (role === 'teacher') {
                results.result2 = '✅ 老师角色识别成功（邮箱格式正确）';
            } else if (role === 'student') {
                results.result2 = '✅ 学生角色识别成功（邮箱格式正确）';
            } else if (role === 'anonymous') {
                results.result2 = '✅ 匿名用户识别成功';
            } else {
                results.result2 = '⚠️ 角色识别失败 - 邮箱格式不匹配 ISF 域名';
            }

            // 测试 3：Session 持久化
            if (user.aud === 'authenticated') {
                results.result3 = '✅ 会话已创建，刷新页面后会保持登录';
            } else {
                results.result3 = '⚠️ 会话状态异常';
            }

            // 显示结果
            document.getElementById('testResult1').textContent = results.result1;
            document.getElementById('testResult2').textContent = results.result2;
            document.getElementById('testResult3').textContent = results.result3;
        }

        // 显示错误
        function showError(message) {
            document.getElementById('loginArea').classList.add('hidden');
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // 检查是否已登录（页面加载时）
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth 状态变化:', event, session);
            
            if (event === 'SIGNED_IN' && session) {
                handleAuthSuccess({ user: session.user });
            } else if (event === 'SIGNED_OUT') {
                document.getElementById('loginArea').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
            }
        });

        // 页面加载时检查当前会话
        (async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                handleAuthSuccess({ user: session.user });
            }
        })();
    </script>

    <!-- 底部说明 -->
    <div class="fixed bottom-4 left-4 right-4 text-center">
        <p class="text-xs text-gray-500">
            测试页面 - 用于验证 Google OAuth 配置 | 
            <a href="https://supabase.com/dashboard/project/ohseemszgahvojgocjqq" 
               target="_blank" 
               class="text-blue-500 hover:underline">
                Supabase Dashboard
            </a>
        </p>
    </div>
</body>
</html>

