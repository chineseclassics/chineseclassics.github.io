# 时文宝鉴 MVP 实施任务清单（阶段式）

## 📋 实施策略

**分 4 个会话完成，每个会话一个阶段。每个阶段都交付可测试的功能增量。**

---

## 🏗️ 阶段 1：核心基础 ✅ **已完成（2025-10-19）**

**目标**：学生能登录、写作、自动保存  
**任务数**：38/38 (100%)
**会话**：第一次会话

### 1.1 数据库和 Supabase 配置 ✅ 已完成
- [x] 1.1.1 创建 Supabase 项目
- [x] 1.1.2 创建 config.toml 配置文件
- [x] 1.1.3 创建数据库迁移文件（001-007）
- [x] 1.1.4 在 Dashboard 执行迁移（001-005）
- [x] 1.1.5 验证表结构完整性
- [x] 1.1.6 修复视图 RLS 安全问题（006）
- [x] 1.1.7 启用匿名登录（测试用，007）
- [x] 1.1.8 更新前端 Supabase 配置

### 1.2 应用基础结构 ✅ 已完成
- [x] 1.2.1 创建 index.html 主入口
- [x] 1.2.2 创建基础 HTML 结构
- [x] 1.2.3 引入 Tailwind CSS（CDN）
- [x] 1.2.4 引入 Quill.js（CDN）
- [x] 1.2.5 引入 Supabase JS SDK（CDN）
- [x] 1.2.6 创建 app.js 主应用文件
- [x] 1.2.7 创建基础 CSS 文件结构

### 1.3 用户认证系统 ✅ 已完成
- [x] 1.3.1 创建登录页面 UI
- [x] 1.3.2 实现 Google OAuth 登录按钮
- [x] 1.3.3 实现匿名登录按钮（"匿名测试"）
- [x] 1.3.4 实现角色自动识别（基于邮箱格式）
- [x] 1.3.5 创建会话管理模块（js/auth/session-manager.js）
- [x] 1.3.6 实现双模式检测（独立/平台）
- [x] 1.3.7 实现登出功能
- [x] 1.3.8 创建用户资料显示组件
- [x] 1.3.9 测试认证流程（Google + 匿名）

### 1.4 路由和导航 ✅ 已完成
- [x] 1.4.1 实现简单的前端路由（hash-based）
- [x] 1.4.2 创建老师仪表板页面框架
- [x] 1.4.3 创建学生仪表板页面框架
- [x] 1.4.4 实现角色基础的自动跳转
- [x] 1.4.5 创建顶部导航栏组件

### 1.5 分层段落编辑器（核心）✅ 已完成
- [x] 1.5.1 编写 RichTextEditor 类（`js/editor/rich-text-editor.js`）
- [x] 1.5.2 在 HTML 中添加编辑器容器
- [x] 1.5.3 实现引言段编辑器界面
- [x] 1.5.4 实现分论点容器创建界面
- [x] 1.5.5 实现分论点标题编辑界面
- [x] 1.5.6 实现分论点下的段落编辑器界面
- [x] 1.5.7 实现结论段编辑器界面
- [x] 1.5.8 实现"添加分论点"按钮和功能
- [x] 1.5.9 实现"添加段落"按钮和功能（分论点内）
- [x] 1.5.10 集成编辑器到学生仪表板
- [x] 1.5.11 实现字数实时统计显示
- [x] 1.5.12 测试编辑器基本功能

### 1.6 自动保存与版本管理 ✅ 已完成
- [x] 1.6.1 编写 AutoSave 类（`js/editor/auto-save.js`）
- [x] 1.6.2 集成自动保存到编辑器（3秒防抖）
- [x] 1.6.3 创建保存状态指示器界面
- [x] 1.6.4 实现版本快照创建（paragraph_versions 表）
- [x] 1.6.5 实现离线缓存（localStorage）
- [x] 1.6.6 实现网络恢复后同步
- [x] 1.6.7 实现保存到 Supabase 数据库（essays, sub_arguments, paragraphs 表）

**阶段 1 交付成果**：
- ✅ 学生能用匿名账号登录
- ✅ 能看到完整的编辑器界面
- ✅ 能创建分论点和段落
- ✅ 内容自动保存到 localStorage（每 3 秒）
- ✅ 内容自动保存到 Supabase 数据库（essays, sub_arguments, paragraphs 表）
- ✅ 支持版本快照创建（paragraph_versions 表）
- ✅ 支持离线/在线同步

---

## 🤖 阶段 2：AI 反馈系统 ✅ **已完成（2025-10-19）**

**目标**：学生能获得 AI 段落反馈  
**任务数**：28/28 (100%)
**会话**：第二次会话
**前置条件**：✅ 阶段 1 已完成

### 2.1 AI 反馈 Edge Function ✅ 已完成
- [x] 2.1.1 完善 Edge Function 代码结构
- [x] 2.1.2 实现格式规范 JSON 加载
- [x] 2.1.3 实现段落类型识别
- [x] 2.1.4 实现结构完整性检查
- [x] 2.1.5 实现句子级分析逻辑
- [x] 2.1.6 集成 DeepSeek API
- [x] 2.1.7 实现常见错误检测
- [x] 2.1.8 实现反馈生成（不含示例）
- [x] 2.1.9 实现 AI 评分预估
- [x] 2.1.10 配置环境变量（DEEPSEEK_API_KEY）
- [x] 2.1.11 部署 Edge Function
- [x] 2.1.12 测试 Edge Function 响应

### 2.2 学生端 - AI 反馈界面 ✅ 已完成
- [x] 2.2.1 创建"提交段落"按钮（引言、正文、结论）
- [x] 2.2.2 实现反馈请求逻辑（feedback-requester.js）
- [x] 2.2.3 实现加载状态动画
- [x] 2.2.4 创建反馈展示容器（自适应桌面/移动端）
- [x] 2.2.5 创建反馈渲染器（feedback-renderer.js）
- [x] 2.2.6 实现句子级问题显示（预留高亮接口）
- [x] 2.2.7 实现反馈历史查看（getHistoricalFeedback）
- [x] 2.2.8 测试 AI 反馈完整流程

### 2.3 防作弊系统 ✅ 已完成
- [x] 2.3.1 实现粘贴事件监听
- [x] 2.3.2 实现粘贴内容记录
- [x] 2.3.3 实现大量粘贴警告
- [x] 2.3.4 实现打字速度监测
- [x] 2.3.5 实现停顿时间记录
- [x] 2.3.6 实现写作模式分析
- [x] 2.3.7 实现诚信报告生成
- [x] 2.3.8 测试防作弊不影响正常使用

**阶段 2 交付成果**：

### 核心功能（原计划 28 个任务）
- ✅ **Edge Function 完整实现**：
  - 格式规范 JSON 加载和解析
  - 段落类型自动识别（引言/正文/结论）
  - 结构完整性检查（缺失元素检测）
  - DeepSeek API 集成（内容分析）
  - 句子级问题定位
  - 改进建议生成（不含修改示例）
  - AI 评分预估（仅供老师参考）

- ✅ **学生端 AI 反馈界面**：
  - 三类段落的"雨村評點"按钮（引言、正文、结论）
  - 反馈请求模块（feedback-requester.js）
  - 加载状态动画
  - 反馈渲染器（feedback-renderer.js）
  - 句子级问题显示（含严重程度标记）
  - 反馈历史查看功能

- ✅ **防作弊系统**：
  - 粘贴事件全局监听和记录
  - 大量粘贴警告（>200 字符）
  - 频繁粘贴警告（>5 次）
  - 打字速度监测（字符/分钟）
  - 停顿时间记录
  - 写作模式分析
  - 诚信报告生成（风险等级评估）

### 额外增强功能（超出原计划）
- ✅ **格式规范系统架构**：
  - 两层架构设计（系统内置 + 老师自定义）
  - 完全基于 JSON 的 analysis_dimensions
  - 格式规范加载器（format-spec-loader.js）
  - OpenSpec 完整文档（spec.md + design.md）

- ✅ **响应式 UI 布局**：
  - 桌面端：固定侧边栏（65%-35% 分栏）
  - 移动端：内联展开反馈
  - 段落高亮（蓝色边框 + 背景）
  - 问题数量徽章

- ✅ **句子级联动功能**：
  - 点击问题 → 定位原句
  - 句子提示条（黄色，页面顶部）
  - 句子高亮（编辑器内黄色背景，3秒）
  - 双向定位（问题 ↔ 原句）
  - 句子高亮器模块（sentence-highlighter.js）

- ✅ **文化主题包装**：
  - AI 助手命名为"賈雨村"
  - 按钮改为"雨村評點"
  - 毛笔图标（fa-pen-fancy）
  - 侧边栏浅黄色标题

### 数据库 Migrations
- ✅ 012_create_ai_feedback_table.sql
- ✅ 013_create_format_specifications_table.sql
- ✅ 014_create_anti_cheat_tables.sql

### 文档
- ✅ PHASE_2_DEPLOYMENT_GUIDE.md
- ✅ FORMAT_SPEC_ARCHITECTURE.md
- ✅ AI_FEEDBACK_UI_DESIGN.md
- ✅ SENTENCE_HIGHLIGHTING_GUIDE.md

---

## 👨‍🏫 阶段 3：老师端完整功能（第三次会话）

**目标**：老师能创建任务、管理班级、批改论文  
**预计任务数**：34 个

### 3.1 老师端 - 班级管理
- [ ] 3.1.1 创建班级管理页面
- [ ] 3.1.2 实现创建班级表单
- [ ] 3.1.3 实现批量添加学生（邮箱列表）
- [ ] 3.1.4 实现学生列表展示
- [ ] 3.1.5 实现学生移除功能
- [ ] 3.1.6 实现班级统计数据
- [ ] 3.1.7 测试班级管理功能

### 3.2 老师端 - 任务管理
- [ ] 3.2.1 创建任务创建页面
- [ ] 3.2.2 实现模板选择器（红楼梦/议论文）
- [ ] 3.2.3 加载内置格式规范（honglou-essay-format.json）
- [ ] 3.2.4 实现格式要求编辑器
- [ ] 3.2.5 实现评分标准编辑器（IB MYP/DP）
- [ ] 3.2.6 实现任务基本信息表单
- [ ] 3.2.7 实现保存草稿功能
- [ ] 3.2.8 实现发布任务功能
- [ ] 3.2.9 创建任务列表页面
- [ ] 3.2.10 实现任务编辑功能
- [ ] 3.2.11 实现任务删除功能
- [ ] 3.2.12 测试任务创建和管理

### 3.3 学生端 - 任务列表
- [ ] 3.3.1 创建学生任务列表页面
- [ ] 3.3.2 实现任务卡片展示
- [ ] 3.3.3 实现状态指示器
- [ ] 3.3.4 实现截止日期倒计时
- [ ] 3.3.5 实现任务详情查看
- [ ] 3.3.6 实现"开始写作"功能
- [ ] 3.3.7 实现论文提交功能
- [ ] 3.3.8 测试学生任务流程

### 3.4 老师端 - 批改功能
- [ ] 3.4.1 创建学生论文查看页面
- [ ] 3.4.2 实现论文列表（按班级和任务）
- [ ] 3.4.3 实现论文内容只读展示
- [ ] 3.4.4 实现段落批注功能
- [ ] 3.4.5 实现修改历史时间线
- [ ] 3.4.6 实现 AI 反馈历史查看
- [ ] 3.4.7 实现写作诚信报告展示
- [ ] 3.4.8 实现 AI 评分预估显示
- [ ] 3.4.9 创建评分界面（四个标准）
- [ ] 3.4.10 实现评语输入
- [ ] 3.4.11 实现批改提交
- [ ] 3.4.12 测试完整批改流程

**阶段 3 交付成果**：
- ✅ 老师能创建班级和任务
- ✅ 学生能看到任务并开始写作
- ✅ 老师能批改和评分

---

## 🎨 阶段 4：优化和部署（第四次会话）

**目标**：应用优化、太虚幻境集成、生产部署  
**预计任务数**：20 个

### 4.1 UI/UX 优化
- [ ] 4.1.1 优化响应式布局（移动端适配）
- [ ] 4.1.2 优化加载状态和进度指示
- [ ] 4.1.3 优化错误提示界面
- [ ] 4.1.4 优化编辑器性能
- [ ] 4.1.5 添加键盘快捷键
- [ ] 4.1.6 测试跨浏览器兼容性

### 4.2 太虚幻境集成
- [ ] 4.2.1 引入 taixu-app-switcher.js
- [ ] 4.2.2 在太虚幻境主页注册应用
- [ ] 4.2.3 配置应用图标和描述
- [ ] 4.2.4 测试从太虚幻境启动
- [ ] 4.2.5 测试应用切换器导航

### 4.3 测试与部署
- [ ] 4.3.1 端到端测试（完整流程）
- [ ] 4.3.2 性能测试
- [ ] 4.3.3 安全测试
- [ ] 4.3.4 部署到 GitHub Pages
- [ ] 4.3.5 配置 Cloudflare Pages 镜像
- [ ] 4.3.6 生产环境验证

### 4.4 文档
- [ ] 4.4.1 编写教师使用指南
- [ ] 4.4.2 编写学生使用指南
- [ ] 4.4.3 更新项目 README.md

**阶段 4 交付成果**：
- ✅ 应用完全优化
- ✅ 集成到太虚幻境
- ✅ 生产环境可用

---

## 📊 总任务统计

- 阶段 1：38 个任务 ← **✅ 已完成 38/38（100%）**
- 阶段 2：28 个任务 ← **✅ 已完成 28/28（100%）**
- 阶段 3：34 个任务
- 阶段 4：20 个任务
- **总计**：120 个任务
- **已完成**：66/120（55%）

---

## 🎯 当前阶段：阶段 2 ✅ **已完成 100%**

**目标**：学生能获得 AI 段落反馈 ← **完全实现**

**已完成**（28/28）：
- ✅ AI 反馈 Edge Function（12/12）
- ✅ 学生端 AI 反馈界面（8/8）
- ✅ 防作弊系统（8/8）

**阶段 2 完整功能**：
- ✅ **Edge Function 完整实现**：
  - 格式规范 JSON 加载和解析
  - 段落类型自动识别（引言/正文/结论）
  - 结构完整性检查（缺失元素检测）
  - DeepSeek API 集成（内容分析）
  - 句子级问题定位
  - 改进建议生成（不含修改示例）
  - AI 评分预估（仅供老师参考）

- ✅ **学生端 AI 反馈界面**：
  - 三类段落的 AI 反馈按钮（引言、正文、结论）
  - 反馈请求模块（feedback-requester.js）
  - 加载状态动画
  - 反馈渲染器（feedback-renderer.js）
  - 句子级问题显示（含严重程度标记）
  - 反馈历史查看功能
  - 响应式布局（桌面/移动端自适应）

- ✅ **防作弊系统**：
  - 粘贴事件全局监听和记录
  - 大量粘贴警告（>200 字符）
  - 频繁粘贴警告（>5 次）
  - 打字速度监测（字符/分钟）
  - 停顿时间记录
  - 写作模式分析
  - 诚信报告生成（风险等级评估）
  - 自动数据保存（每分钟）

**下一步**：进入阶段 3 - 老师端完整功能

---

## 🔄 阶段间依赖关系

```
阶段 1 (认证 + 编辑器)
    ↓ 必须完成
阶段 2 (AI 反馈)
    ↓ 必须完成
阶段 3 (老师端)
    ↓ 可选
阶段 4 (优化部署)
```
