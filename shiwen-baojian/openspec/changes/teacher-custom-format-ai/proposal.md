# è€å¸ˆè‡ªå®šä¹‰æ ¼å¼ + AI è¾…åŠ©ç”Ÿæˆ

## Why

### å½“å‰ç—›ç‚¹

è€å¸ˆåœ¨åˆ›å»ºå†™ä½œä»»åŠ¡æ—¶é¢ä¸´ä¸¤éš¾é€‰æ‹©ï¼š

1. **ä½¿ç”¨ç³»ç»Ÿæ¨¡æ¿**ï¼šæ ¼å¼æ ‡å‡†åŒ–ï¼Œä½†æ— æ³•ä½“ç°å…·ä½“ä»»åŠ¡çš„å†…å®¹è¦æ±‚
   - ä¾‹å¦‚ï¼šçº¢æ¥¼æ¢¦è®ºæ–‡æ¨¡æ¿åªå®šä¹‰ç»“æ„ï¼Œä½†è€å¸ˆæƒ³è¦æ±‚"è¯¦ç»†åˆ†æäººç‰©å¤–è²Œæå†™"
   - ä¸åŒä»»åŠ¡çš„å­—æ•°è¦æ±‚ã€æ®µè½æ•°é‡è¦æ±‚ä¸åŒï¼Œä½†æ¨¡æ¿æ˜¯å›ºå®šçš„

2. **å®Œå…¨è‡ªå®šä¹‰**ï¼šéœ€è¦æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„ JSON æ ¼å¼è§„èŒƒ
   - å¤§å¤šæ•°è€å¸ˆä¸æ‡‚ JSON è¯­æ³•
   - è€å¸ˆå·²ç»æœ‰ Word æ ¼å¼çš„è®ºæ–‡æŒ‡å¼•ï¼Œä½†æ— æ³•ç›´æ¥ä½¿ç”¨

### æ ¸å¿ƒéœ€æ±‚

**è€å¸ˆå¸Œæœ›**ï¼š
- ç”¨è‡ªç„¶è¯­è¨€å†™ä½œä»»åŠ¡è¦æ±‚ï¼ˆå°±åƒå¹³æ—¶å†™è®ºæ–‡æŒ‡å¼•ä¸€æ ·ï¼‰
- ç³»ç»Ÿè‡ªåŠ¨ç†è§£å¹¶è½¬åŒ–ä¸º AI å¯è¯†åˆ«çš„æ ¼å¼
- å¯ä»¥åŸºäºç³»ç»Ÿæ¨¡æ¿æ·»åŠ è¦æ±‚ï¼Œä¹Ÿå¯ä»¥å®Œå…¨è‡ªå®šä¹‰
- å¯ä»¥å¯¼å‡ºä¸º Word/Markdownï¼Œç”¨äºå…¶ä»–åœºæ™¯
- å¯ä»¥é‡å¤ä½¿ç”¨ã€åˆ†äº«ç»™åŒäº‹

### è§£å†³æ–¹æ¡ˆ

åˆ©ç”¨ AIï¼ˆDeepSeekï¼‰è‡ªåŠ¨è§£æè€å¸ˆçš„è‡ªç„¶è¯­è¨€è¦æ±‚ï¼Œæ™ºèƒ½è½¬åŒ–ä¸ºç»“æ„åŒ– JSON æ ¼å¼è§„èŒƒï¼š

1. **åœ¨çº¿ç¼–è¾‘å™¨è¾“å…¥**ï¼šè€å¸ˆç”¨ Quill.js ç¼–è¾‘å™¨å†™è¦æ±‚ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ï¼‰
2. **AI æ™ºèƒ½è§£æ**ï¼šEdge Function è°ƒç”¨ DeepSeek ç†è§£è¦æ±‚
3. **å¯è§†åŒ–ç¡®è®¤**ï¼šå±•ç¤º AI çš„ç†è§£ç»“æœï¼Œè€å¸ˆç¡®è®¤æˆ–ä¿®æ”¹
4. **æ™ºèƒ½åˆå¹¶**ï¼šè‡ªåŠ¨åˆå¹¶åˆ°ç³»ç»Ÿæ¨¡æ¿ï¼ˆå¦‚æœ‰ï¼‰ï¼Œå†²çªæ—¶è€å¸ˆè¦æ±‚ä¼˜å…ˆ
5. **ä¿å­˜å’Œé‡ç”¨**ï¼šä¿å­˜ä¸ºè‡ªå®šä¹‰æ¨¡æ¿ï¼Œå¯å‘½åã€åˆ†äº«ã€å¯¼å‡º

---

## What Changes

### æ–°å¢åŠŸèƒ½

1. **AI æ ¼å¼è§„èŒƒç”Ÿæˆå™¨**ï¼ˆæ–° Edge Functionï¼‰
   - Edge Function: `format-spec-generator`
   - è¾“å…¥ï¼šè€å¸ˆçš„è‡ªç„¶è¯­è¨€è¦æ±‚ + å¯é€‰çš„ç³»ç»Ÿæ¨¡æ¿ ID
   - è¾“å‡ºï¼šç»“æ„åŒ– JSON æ ¼å¼è§„èŒƒ + ç†è§£ç¡®è®¤ä¿¡æ¯
   - AIï¼šDeepSeek API

2. **è€å¸ˆç«¯ - è‡ªå®šä¹‰æ ¼å¼ç¼–è¾‘å™¨**
   - åŸºäº Quill.js çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
   - æ”¯æŒä»ç³»ç»Ÿæ¨¡æ¿å¼€å§‹æˆ–ä»é›¶å¼€å§‹
   - å®æ—¶é¢„è§ˆ AI ç†è§£ç»“æœ
   - æ”¯æŒå¯¼å‡ºä¸º Word/Markdown æ ¼å¼

3. **è€å¸ˆç«¯ - è‡ªå®šä¹‰æ ¼å¼ç®¡ç†**
   - æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤è‡ªå®šä¹‰æ¨¡æ¿
   - æ¨¡æ¿å‘½åå’Œæè¿°
   - åˆ†äº«ç»™å…¶ä»–è€å¸ˆï¼ˆå¯é€‰ï¼‰
   - é˜²æ­¢åˆ é™¤æ­£åœ¨ä½¿ç”¨çš„æ¨¡æ¿

4. **æ‰©å±•æ ¼å¼è§„èŒƒç³»ç»Ÿ**
   - æ ¼å¼ JSON æ–°å¢é ‚å±¤å­—æ®µï¼š`constraints`ï¼ˆå­—æ•¸ã€æ®µè½æ•¸é™åˆ¶ï¼‰
   - æ ¼å¼ JSON æ–°å¢é ‚å±¤å­—æ®µï¼š`content_requirements`ï¼ˆå…§å®¹ç„¦é»è¦æ±‚ï¼‰
   - æ ¼å¼æ¨¡æ¿åº«ï¼ˆå¯é‡ç”¨ã€å¯ç·¨è¼¯ï¼Œå½±éŸ¿æœªä¾†ä»»å‹™ï¼‰
   - å‰µå»ºä»»å‹™æ™‚ä¿å­˜æ ¼å¼å¿«ç…§ï¼ˆä»»å‹™è¦æ±‚å›ºå®šï¼‰

5. **AI è¯„åˆ†ä»£ç†**ï¼ˆæ–° Edge Functionï¼‰
   - Edge Function: `grading-agent`
   - è¾“å…¥ï¼šå­¦ç”Ÿè®ºæ–‡ + è¯„åˆ†æ ‡å‡† JSON
   - è¾“å‡ºï¼šå››ä¸ªæ ‡å‡†çš„è¯„åˆ†å»ºè®®ï¼ˆ0-8 åˆ†ï¼‰+ ç†ç”±
   - ä»…ä¾›è€å¸ˆå‚è€ƒï¼Œå­¦ç”Ÿä¸å¯è§

6. **è¯„åˆ†æ ‡å‡†ç³»ç»Ÿ**
   - ç³»ç»Ÿå†…ç½®ï¼šã€Œä¸­åœ‹å¤å…¸æ–‡å­¸ã€IB MYP è¯„åˆ†æ ‡å‡†ï¼ˆA/B/C/Dï¼‰
   - æ”¯æŒè€å¸ˆä¸Šä¼ è‡ªå®šä¹‰è¯„åˆ†æ ‡å‡†ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
   - è¯„åˆ†æ ‡å‡†ä¸æ ¼å¼è¦æ±‚åˆ†ç¦»

---

## Impact

### Affected Specs

**ä¿®æ”¹ç°æœ‰è§„æ ¼**ï¼š
1. `teacher-assignment-management` - ä»»åŠ¡åˆ›å»ºæµç¨‹æ–°å¢è‡ªå®šä¹‰æ ¼å¼æ­¥éª¤
2. `format-specification-system` - æ‰©å±•æ ¼å¼è§„èŒƒæ•°æ®ç»“æ„
3. `teacher-grading` - æ–°å¢ AI è¯„åˆ†å»ºè®®åŠŸèƒ½

**æ–°å¢è§„æ ¼**ï¼š
4. `ai-format-generator` - AI æ ¼å¼è§„èŒƒç”Ÿæˆå™¨
5. `custom-format-management` - è‡ªå®šä¹‰æ ¼å¼ç®¡ç†
6. `grading-rubric-system` - è¯„åˆ†æ ‡å‡†ç³»ç»Ÿ

### Affected Code

**æ–°å¢æ–‡ä»¶**ï¼š
```
shiwen-baojian/
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ teacher/
â”‚   â”‚   â”œâ”€â”€ format-editor.js              # æ ¼å¼ç¼–è¾‘å™¨
â”‚   â”‚   â”œâ”€â”€ format-manager.js             # æ ¼å¼ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ format-exporter.js            # å¯¼å‡ºåŠŸèƒ½
â”‚   â”‚   â””â”€â”€ ai-format-requester.js        # AI è§£æè¯·æ±‚
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ grading-rubrics/
â”‚           â””â”€â”€ ib-myp-chinese.json       # ä¸­å›½å¤å…¸æ–‡å­¦è¯„åˆ†æ ‡å‡†
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ functions/
â”‚       â”œâ”€â”€ format-spec-generator/
â”‚       â”‚   â””â”€â”€ index.ts                  # AI æ ¼å¼ç”Ÿæˆ
â”‚       â””â”€â”€ grading-agent/
â”‚           â””â”€â”€ index.ts                  # AI è¯„åˆ†ä»£ç†
â””â”€â”€ assets/
    â””â”€â”€ data/
        â””â”€â”€ grading-rubrics/
            â””â”€â”€ ib-myp-chinese-literature.json
```

**ä¿®æ”¹æ–‡ä»¶**ï¼š
```
shiwen-baojian/
â”œâ”€â”€ supabase/migrations/
â”‚   â”œâ”€â”€ 015_extend_format_specifications.sql  # æ‰©å±•æ ¼å¼è¡¨å­—æ®µ
â”‚   â””â”€â”€ 016_create_grading_rubrics.sql        # è¯„åˆ†æ ‡å‡†è¡¨
â””â”€â”€ js/teacher/assignment-creator.js          # ä»»åŠ¡åˆ›å»ºæµç¨‹
```

### Database Changes

**ä¸éœ€è¦ä¿®æ”¹è¡¨çµæ§‹** - `format_specifications` è¡¨çš„ `spec_json` å­—æ®µå·²è¶³å¤ 

**æ ¼å¼ JSON æ“´å±•çµæ§‹**ï¼š
```json
{
  "metadata": {...},
  "structure": {...},
  "paragraph_types": {...},
  "constraints": {              // â† AI è§£æç”Ÿæˆ
    "total_word_count": { "min": 1800, "max": 2000 },
    "body_paragraphs": 3
  },
  "content_requirements": [...], // â† AI è§£æç”Ÿæˆ
  "sentence_level_rules": {...},
  "weights_and_scoring": {...}
}
```

**æ–°å¢è¡¨**ï¼š`grading_rubrics`
```sql
CREATE TABLE grading_rubrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL CHECK (type IN ('system', 'custom')),
  created_by UUID REFERENCES auth.users(id),
  criteria JSONB NOT NULL,        -- A/B/C/D æ ‡å‡†å®šä¹‰
  is_public BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

**æ–°å¢è¡¨**ï¼š`ai_grading_suggestions`
```sql
CREATE TABLE ai_grading_suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  essay_id UUID REFERENCES essays(id) ON DELETE CASCADE,
  grading_rubric_id UUID REFERENCES grading_rubrics(id),
  criterion_a_score INTEGER CHECK (criterion_a_score >= 0 AND criterion_a_score <= 8),
  criterion_b_score INTEGER CHECK (criterion_b_score >= 0 AND criterion_b_score <= 8),
  criterion_c_score INTEGER CHECK (criterion_c_score >= 0 AND criterion_c_score <= 8),
  criterion_d_score INTEGER CHECK (criterion_d_score >= 0 AND criterion_d_score <= 8),
  reasoning JSONB NOT NULL,       -- æ¯ä¸ªæ ‡å‡†çš„è¯„åˆ†ç†ç”±
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Integration with Existing System

**ä¸ç°æœ‰åŠŸèƒ½çš„å…³ç³»**ï¼š
1. **æ ¼å¼è§„èŒƒç³»ç»Ÿ**ï¼šæ‰©å±•ç°æœ‰ä¸¤å±‚æ¶æ„ï¼Œå¢å¼ºè€å¸ˆè‡ªå®šä¹‰èƒ½åŠ›
2. **AI åé¦ˆå¼•æ“**ï¼šç»§ç»­ä½¿ç”¨æ ¼å¼è§„èŒƒè¿›è¡Œæ®µè½çº§åé¦ˆ
3. **ä»»åŠ¡ç®¡ç†**ï¼šä»»åŠ¡åˆ›å»ºæµç¨‹æ–°å¢"è‡ªå®šä¹‰æ ¼å¼"æ­¥éª¤
4. **è€å¸ˆæ‰¹æ”¹**ï¼šæ–°å¢"AI è¯„åˆ†å»ºè®®"å‚è€ƒ

---

## Success Criteria

### ç”¨æˆ·ä½“éªŒç›®æ ‡
- è€å¸ˆèƒ½åœ¨ 5 åˆ†é’Ÿå†…åˆ›å»ºè‡ªå®šä¹‰æ ¼å¼ï¼ˆåŸºäºç³»ç»Ÿæ¨¡æ¿ï¼‰
- AI ç†è§£å‡†ç¡®ç‡ > 85%ï¼ˆåŸºäºè€å¸ˆç¡®è®¤ç‡ï¼‰
- è€å¸ˆæ»¡æ„åº¦ > 4/5ï¼ˆé—®å·è°ƒæŸ¥ï¼‰

### æŠ€æœ¯ç›®æ ‡
- AI æ ¼å¼ç”Ÿæˆæ—¶é—´ < 10 ç§’
- å¯¼å‡º Word æ–‡æ¡£æ ¼å¼æ­£ç¡®ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ï¼‰
- åŠ¨æ€æ¨¡æ¿æ›´æ–°å®æ—¶ç”Ÿæ•ˆï¼ˆæ— ç¼“å­˜å»¶è¿Ÿï¼‰

### æ•™è‚²ç›®æ ‡
- è€å¸ˆèƒ½è½»æ¾è¡¨è¾¾å…·ä½“ä»»åŠ¡çš„å†…å®¹è¦æ±‚
- å­¦ç”Ÿæ”¶åˆ°çš„ AI åé¦ˆæ›´è´´è¿‘è€å¸ˆçš„æ•™å­¦æ„å›¾
- å‡å°‘è€å¸ˆæ‰‹åŠ¨é…ç½®æ ¼å¼çš„æ—¶é—´æˆæœ¬

---

## Scope

### âœ… MVP å¿…é¡»åŒ…å«

1. **AI æ ¼å¼ç”Ÿæˆå™¨**ï¼ˆåŒé‡è¾“å‡ºï¼‰
   - Edge Function å®ç°
   - ä¸€æ¬¡è°ƒç”¨ç”Ÿæˆä¸¤ç§è¾“å‡ºï¼š
     - human_readableï¼šæ˜¾ç¤ºåœ¨ Quill ç¼–è¾‘å™¨
     - format_jsonï¼šç¼“å­˜å¹¶ä¿å­˜åˆ°æ•°æ®åº“
   - æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
     - å¢é‡æ¨¡å¼ï¼šåˆå¹¶ç³»ç»Ÿæ¨¡æ¿ + è€å¸ˆè¦æ±‚
     - è‡ªå®šä¹‰æ¨¡å¼ï¼šç”Ÿæˆå®Œæ•´æ ¼å¼ JSON

2. **è€å¸ˆç«¯æ ¼å¼ç¼–è¾‘å™¨**ï¼ˆç»Ÿä¸€ Quill ç•Œé¢ï¼‰
   - æ‰€æœ‰æ ¼å¼æ“ä½œéƒ½åœ¨ä¸€ä¸ª Quill ç¼–è¾‘å™¨ä¸­å®Œæˆ
   - ç³»ç»Ÿæ ¼å¼é¢„è§ˆä¹Ÿæ˜¾ç¤ºåœ¨ Quill ä¸­ï¼ˆäººç±»å¯è¯»ï¼‰
   - ä¸‰ç§ä½¿ç”¨æ¨¡å¼è‡ªç„¶æµè½¬ï¼š
     - æ¨¡å¼ Aï¼šç›´æ¥ä½¿ç”¨ç³»ç»Ÿæ ¼å¼ï¼ˆæ— éœ€ AIï¼‰
     - æ¨¡å¼ Bï¼šåŸºäºç³»ç»Ÿæ ¼å¼ä¿®æ”¹ï¼ˆAI å¢é‡ä¼˜åŒ–ï¼‰
     - æ¨¡å¼ Cï¼šä»é›¶å¼€å§‹è‡ªå®šä¹‰ï¼ˆAI å®Œæ•´ç”Ÿæˆï¼‰
   - AI ä¼˜åŒ–ä¸€æ¬¡ç”ŸæˆåŒé‡è¾“å‡ºï¼ˆäººç±»å¯è¯» + JSONï¼‰
   - è€å¸ˆå¯ç›´æ¥ä» Quill å¤åˆ¶å†…å®¹ï¼ˆæ— éœ€å¯¼å‡ºåŠŸèƒ½ï¼‰

3. **è‡ªå®šä¹‰æ ¼å¼ç®¡ç†**
   - ä¿å­˜ã€å‘½åã€é‡ç”¨
   - æŸ¥çœ‹å’Œç¼–è¾‘ï¼ˆåŠ è½½åˆ° Quill ç¼–è¾‘å™¨ï¼‰
   - æ ¼å¼é¢„è§ˆï¼ˆç³»ç»Ÿæ ¼å¼å’Œè‡ªå®šä¹‰æ ¼å¼ç»Ÿä¸€å±•ç¤ºï¼‰
   - ç®€åŒ–åˆ é™¤é€»è¾‘ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ï¼Œä¸æ£€æŸ¥ä½¿ç”¨æƒ…å†µï¼‰

4. **æ ¼å¼æ¨¡æ¿ç®¡ç†**
   - å‰µå»º/ç·¨è¼¯æ ¼å¼æ¨¡æ¿ï¼ˆç³»çµ±å…§ç½® + è€å¸«è‡ªå®šç¾©ï¼‰
   - å‰µå»ºä»»å‹™æ™‚é¸æ“‡æ¨¡æ¿ï¼Œä¿å­˜å¿«ç…§åˆ°ä»»å‹™
   - ç·¨è¼¯æ¨¡æ¿åªå½±éŸ¿æœªä¾†å‰µå»ºçš„ä»»å‹™

5. **è¯„åˆ†æ ‡å‡†ç³»ç»Ÿ**
   - ç³»ç»Ÿå†…ç½®ã€Œä¸­åœ‹å¤å…¸æ–‡å­¸ã€IB MYP æ ‡å‡†
   - é€‰æ‹©è¯„åˆ†æ ‡å‡†ï¼ˆä»»åŠ¡åˆ›å»ºæ—¶ï¼‰

6. **AI è¯„åˆ†ä»£ç†**
   - Edge Function å®ç°
   - ä»…ä¾›è€å¸ˆå‚è€ƒ
   - åŸºäºè¯„åˆ†æ ‡å‡†çš„å››ä¸ªç»´åº¦

### â¸ï¸ ç¬¬äºŒé˜¶æ®µ

1. å¯¼å‡ºä¸º Word æ ¼å¼ï¼ˆ.docxï¼‰- MVP é˜¶æ®µå¯ä» Quill ç›´æ¥å¤åˆ¶
2. æ¨¡æ¿åˆ†äº«åŠŸèƒ½ï¼ˆè€å¸ˆä¹‹é—´ï¼‰
3. è€å¸ˆä¸Šä¼ è‡ªå®šä¹‰è¯„åˆ†æ ‡å‡†
4. æ ¼å¼ç‰ˆæœ¬å†å²ï¼ˆå…è®¸å›é€€åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼‰

### ğŸ”® ç¬¬ä¸‰é˜¶æ®µ

1. å¯¼å‡ºä¸º PDF æ ¼å¼
2. æ ¼å¼æ¨¡æ¿å¸‚åœºï¼ˆå…¬å¼€åˆ†äº«ï¼‰
3. AI å­¦ä¹ è€å¸ˆåå¥½ï¼ˆä¸ªæ€§åŒ–å»ºè®®ï¼‰

---

## Non-Goals

- âŒ ä¸æ”¯æŒå­¦ç”Ÿè‡ªå®šä¹‰æ ¼å¼
- âŒ ä¸æ”¯æŒ AI ç›´æ¥ä¿®æ”¹è€å¸ˆçš„è¦æ±‚ï¼ˆåªç†è§£ï¼Œä¸æ”¹å†™ï¼‰
- âŒ ä¸æ”¯æŒå†å²ç‰ˆæœ¬å›æ»šï¼ˆMVP é˜¶æ®µï¼‰
- âŒ ä¸æ”¯æŒå¯¼å…¥ Word æ–‡æ¡£ï¼ˆåªæ”¯æŒå¯¼å‡ºï¼‰

---

## Open Questions

1. **å¯¼å‡ºæ ¼å¼ä¼˜å…ˆçº§**ï¼šMarkdown ä¼˜å…ˆè¿˜æ˜¯ Word ä¼˜å…ˆï¼Ÿ
   - å»ºè®®ï¼šMVP å…ˆåš Markdownï¼ˆç®€å•ï¼‰ï¼Œç¬¬äºŒé˜¶æ®µåš Word

2. **AI ç†è§£å¤±è´¥çš„å…œåº•æ–¹æ¡ˆ**ï¼Ÿ
   - å»ºè®®ï¼šå…è®¸è€å¸ˆæ‰‹åŠ¨è°ƒæ•´ JSONï¼ˆæä¾›ç®€åŒ–çš„è¡¨å•ç•Œé¢ï¼‰

3. **æ¨¡æ¿åˆ†äº«çš„æƒé™æ§åˆ¶**ï¼Ÿ
   - å»ºè®®ï¼šMVP é˜¶æ®µåªæ”¯æŒåŒæ ¡è€å¸ˆåˆ†äº«ï¼ˆåŸºäº email åŸŸåï¼‰

4. **è¯„åˆ†æ ‡å‡†ä¸æ ¼å¼è¦æ±‚çš„æƒé‡**ï¼Ÿ
   - å»ºè®®ï¼šæ®µè½åé¦ˆä¸»è¦çœ‹æ ¼å¼ï¼ˆ80%ï¼‰ï¼Œè®ºæ–‡è¯„åˆ†ä¸»è¦çœ‹æ ‡å‡†ï¼ˆ80%ï¼‰

