# 老师自定义格式 + AI 辅助生成 - 任务清单

## 📋 实施策略

**分 2 个会话完成，每个会话一个阶段。**

---

## 🤖 阶段 1：AI 格式生成器 + 评分标准系统

**目标**：老师能用自然语言创建自定义格式，AI 自动生成 JSON  
**预计任务数**：28 个

### 1.1 数据库准备

- [ ] 1.1.1 创建 `016_create_grading_rubrics.sql` 迁移
- [ ] 1.1.2 创建 `grading_rubrics` 表
- [ ] 1.1.3 创建 `ai_grading_suggestions` 表
- [ ] 1.1.4 在 Dashboard 执行迁移
- [ ] 1.1.5 验证表结构和 RLS 策略

**注意**：不需要擴展 `format_specifications` 表，`constraints` 和 `content_requirements` 直接整合到 `spec_json` 中

### 1.2 评分标准数据准备

- [ ] 1.2.1 创建 `assets/data/grading-rubrics/` 目录
- [ ] 1.2.2 转换「中國古典文學」评分标准为 JSON 格式
- [ ] 1.2.3 定义评分标准 JSON Schema
- [ ] 1.2.4 创建评分标准加载器（`js/data/grading-rubric-loader.js`）
- [ ] 1.2.5 测试评分标准加载

### 1.3 AI 格式生成 Edge Function

**參考文檔**：`AI_PROMPT_DESIGN.md`

- [ ] 1.3.1 創建 `supabase/functions/format-spec-generator/` 目錄
- [ ] 1.3.2 實現 System Prompt（複製自 AI_PROMPT_DESIGN.md）
- [ ] 1.3.3 實現 User Prompt Template
- [ ] 1.3.4 整合 DeepSeek API 調用
- [ ] 1.3.5 實現字數/段落數提取邏輯
- [ ] 1.3.6 實現內容要求轉換為 analysis_dimensions
- [ ] 1.3.7 實現 JSON 解析和驗證
- [ ] 1.3.8 實現理解確認信息生成
- [ ] 1.3.9 添加錯誤處理（模糊要求、矛盾要求）
- [ ] 1.3.10 配置環境變量（DEEPSEEK_API_KEY）
- [ ] 1.3.11 部署 Edge Function
- [ ] 1.3.12 使用 Few-shot Examples 測試（5 個案例）

### 1.4 老師端 - 統一 Quill 格式編輯器

**核心設計**：所有格式操作都在一個 Quill 編輯器中完成

- [ ] 1.4.1 創建格式編輯器頁面 HTML（卡片式格式選擇 + Quill 編輯器）
- [ ] 1.4.2 集成 Quill.js 純文本編輯器（toolbar: false）
- [ ] 1.4.3 實現系統格式卡片組件（圖標、名稱、簡介、預覽按鈕）
- [ ] 1.4.4 實現「從零開始」選項卡
- [ ] 1.4.5 實現格式 JSON → 人類可讀轉換函數
- [ ] 1.4.6 實現「加載預覽」功能（在 Quill 中顯示系統格式）
- [ ] 1.4.7 監聽 Quill 內容變化（檢測用戶修改，切換模式）
- [ ] 1.4.8 實現模式識別邏輯（direct / incremental / custom）
- [ ] 1.4.9 實現「AI 優化」按鈕和狀態管理（hasBeenOptimized）
- [ ] 1.4.10 實現 AI 優化請求（調用 format-spec-generator）
- [ ] 1.4.11 處理 AI 雙重輸出（human_readable + format_json）
- [ ] 1.4.12 實現 JSON 緩存（cachedFormatJSON）
- [ ] 1.4.13 實現「保存」按鈕邏輯（強制優化 + 自動優化流程）
- [ ] 1.4.14 實現格式命名和描述輸入
- [ ] 1.4.15 實現保存邏輯（區分三種模式）
- [ ] 1.4.16 測試三種模式的完整流程

**阶段 1 交付成果**：
- ✅ 老师能在统一的 Quill 编辑器中操作所有格式
- ✅ 三种模式自然流转：直接使用 / 增量修改 / 完全自定义
- ✅ AI 一次优化生成双重输出（人类可读 + JSON）
- ✅ 强制优化逻辑确保格式质量
- ✅ 自定义格式保存到数据库

---

## 📊 阶段 2：格式管理 + AI 评分 + 导出功能

**目标**：老师能管理自定义格式、使用 AI 评分建议、导出格式文档  
**预计任务数**：26 个

### 2.1 老師端 - 自定義格式管理

- [ ] 2.1.1 創建格式管理頁面
- [ ] 2.1.2 實現格式列表展示（系統模板 + 自定義模板）
- [ ] 2.1.3 實現格式卡片組件（名稱、描述、創建時間、類型標籤）
- [ ] 2.1.4 實現格式詳情查看（展開/收起）
- [ ] 2.1.5 實現格式編輯功能（跳轉到編輯器）
- [ ] 2.1.6 實現格式刪除功能（簡化版：只能刪除自己創建的）
- [ ] 2.1.7 系統內置格式不可刪除（UI 禁用刪除按鈕）
- [ ] 2.1.8 實現格式搜索和篩選（按類型、創建者）
- [ ] 2.1.9 測試格式管理功能

**注意**：不檢查格式是否被任務使用（快照模式，刪除不影響已創建任務）

### 2.2 格式分享功能（MVP：直接復制）

**注意**：MVP 階段不做導出功能，老師可直接從 Quill 編輯器複製內容

- [ ] 2.2.1 在格式預覽頁面添加「複製格式說明」按鈕
- [ ] 2.2.2 實現一鍵複製到剪貼板功能
- [ ] 2.2.3 複製成功提示
- [ ] 2.2.4 測試複製到 Word/記事本等應用

**第二階段（可選）**：
- [ ] 2.2.5 引入 `docx.js` 庫
- [ ] 2.2.6 實現導出為 Word (.docx) 格式
- [ ] 2.2.7 實現導出為 PDF 格式

### 2.3 任务创建集成

- [ ] 2.3.1 修改任务创建页面，新增"格式要求"步骤
- [ ] 2.3.2 实现格式选择器（系统模板 + 自定义模板）
- [ ] 2.3.3 实现"创建新格式"快捷入口
- [ ] 2.3.4 实现格式预览
- [ ] 2.3.5 实现评分标准选择器
- [ ] 2.3.6 实现任务与格式的关联（动态引用）
- [ ] 2.3.7 测试任务创建流程

### 2.4 AI 评分代理 Edge Function

- [ ] 2.4.1 创建 `supabase/functions/grading-agent/` 目录
- [ ] 2.4.2 实现 Edge Function 基础结构
- [ ] 2.4.3 实现评分标准 JSON 加载
- [ ] 2.4.4 实现学生论文内容提取
- [ ] 2.4.5 实现基于评分标准的分析逻辑（DeepSeek API）
- [ ] 2.4.6 实现四个标准的评分生成（A/B/C/D，各 0-8 分）
- [ ] 2.4.7 实现评分理由生成
- [ ] 2.4.8 配置环境变量
- [ ] 2.4.9 部署 Edge Function
- [ ] 2.4.10 测试 Edge Function 响应

### 2.5 老师端 - AI 评分建议

- [ ] 2.5.1 在老师批改页面添加"AI 评分建议"按钮
- [ ] 2.5.2 实现 AI 评分请求模块
- [ ] 2.5.3 实现加载状态动画
- [ ] 2.5.4 实现评分建议展示界面
- [ ] 2.5.5 实现四个标准的分数和理由显示
- [ ] 2.5.6 实现"采用建议"快捷按钮（填充老师评分表单）
- [ ] 2.5.7 确保学生端不可见 AI 评分
- [ ] 2.5.8 测试 AI 评分功能

**阶段 2 交付成果**：
- ✅ 老师能管理自定义格式（查看、编辑、删除）
- ✅ 老师能导出格式为 Markdown 文件
- ✅ 老师在创建任务时能选择自定义格式
- ✅ 老师批改时能获得 AI 评分建议
- ✅ 学生不可见 AI 评分

---

## 📊 总任务统计

- 阶段 1：28 个任务（AI 格式生成 + 评分标准）
- 阶段 2：26 个任务（格式管理 + AI 评分 + 导出）
- **总计**：54 个任务

---

## 🎯 当前状态

**状态**：等待开始  
**前置条件**：shiwen-baojian-mvp 阶段 2 已完成

---

## 🔄 与现有系统的集成

### 依赖关系

```
shiwen-baojian-mvp (阶段 1-2)
    ↓ 已完成
teacher-custom-format-ai (本变更)
    ↓ 依赖
    - format-specification-system (扩展)
    - teacher-assignment-management (修改)
    - teacher-grading (扩展)
```

### 数据流

```
老师创建任务
    ↓
选择/创建格式规范
    ↓ (如需创建)
编辑器输入要求 → format-spec-generator (AI) → JSON 规范
    ↓
保存自定义格式
    ↓
任务引用格式 ID（动态）
    ↓
学生写作
    ↓
ai-feedback-agent (基于格式规范)
    ↓
学生提交
    ↓
老师批改
    ↓
grading-agent (基于评分标准) → AI 评分建议
    ↓
老师最终评分
```

---

## 📝 注意事项

### 技术关键点

1. **动态模板引用**
   - 任务表存储 `format_spec_id`（不快照 JSON）
   - 每次使用时从数据库加载最新版
   - 需要缓存优化（避免频繁查询）

2. **AI Prompt 设计**
   - `format-spec-generator` 需要精心设计的 System Prompt
   - 示例：识别字数、段落数、内容要求的模式
   - 需要处理模糊或矛盾的老师要求

3. **冲突解决逻辑**
   - 老师要求 > 系统模板
   - 但需要保留系统模板的其他部分（不覆盖全部）
   - 需要细粒度的合并算法

4. **导出格式**
   - Markdown：直接转换 Quill Delta → Markdown
   - 需要处理富文本格式（粗体、斜体、列表）

### 用户体验关键点

1. **AI 理解可视化**
   - 不要直接展示 JSON（老师看不懂）
   - 用表格或卡片展示理解结果
   - 突出显示冲突解决方案

2. **错误处理**
   - AI 解析失败时的友好提示
   - 允许老师手动调整（简化表单）
   - 提供示例和帮助文档

3. **性能优化**
   - AI 解析可能需要 5-10 秒
   - 需要良好的加载动画
   - 考虑后台处理 + 通知

---

## 🧪 测试场景

### 场景 1：基于系统模板创建

1. 老师选择"红楼梦论文格式"
2. 添加要求："详细分析林黛玉和薛宝钗的外貌描写，每个人物不少于 300 字，总字数 1800 字"
3. AI 解析成功
4. 老师确认并保存为"张老师红楼梦人物分析 2025"
5. 在任务创建时选择此格式
6. 学生收到 AI 反馈时包含"外貌描写分析"维度

### 场景 2：完全自定义格式

1. 老师选择"从零开始"
2. 输入详细要求（引言、正文、结论的结构）
3. AI 解析成功
4. 老师确认并保存
5. 使用此格式创建任务

### 场景 3：格式更新实时生效

1. 老师修改已使用的自定义格式（增加字数要求）
2. 正在进行的任务中，学生立即看到新的字数要求
3. 之前的 AI 反馈仍然有效（基于旧版本）
4. 新的 AI 反馈基于最新版本

### 场景 4：AI 评分建议

1. 学生完成论文并提交
2. 老师打开批改页面
3. 点击"AI 评分建议"
4. 5 秒后看到四个标准的评分和理由
5. 老师参考后手动调整分数
6. 学生只能看到老师的最终评分（看不到 AI 建议）

### 场景 5：导出格式文档

1. 老师编辑完自定义格式
2. 点击"导出为 Markdown"
3. 下载 `张老师红楼梦人物分析2025.md` 文件
4. 用其他编辑器打开，格式正确
5. 可以用于发送给学生或存档

