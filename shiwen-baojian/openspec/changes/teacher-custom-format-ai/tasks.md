# 老师自定义格式 + AI 辅助生成 - 任务清单

## 📋 实施策略

**分 3 个会话完成，每个会话一个阶段。**

**总任务数**：79 个（76 个 MVP 必需 + 3 个可选）  
**阶段划分**：22 个 + 29 个 + 25 个 = 76 个（MVP 必需）

**划分原则**：
- 每个阶段 20-30 个任务（可管理的范围，单次会话可完成）
- 明确的交付物（可独立测试和验证）
- 清晰的依赖链（数据库 → AI → 界面 → 集成）
- 风险优先（先验证 AI 核心能力，再做用户界面，最后系统集成）

---

## 🏗️ 阶段 1：数据库 + AI 核心引擎

**目标**：AI 格式生成器可用，能够解析老师要求并生成 JSON  
**任务数**：22 个  
**会话**：第一次会话

**核心设计**：
- AI 双重输出（人类可读 + JSON）
- 支持两种模式（增量 / 自定义）
- AI 职责边界（只做客观检查）
- 基于真实教学案例设计 Prompt

### 1.1 数据库准备

- [ ] 1.1.1 创建 `016_create_grading_rubrics.sql` 迁移
- [ ] 1.1.2 创建 `grading_rubrics` 表
- [ ] 1.1.3 创建 `ai_grading_suggestions` 表
- [ ] 1.1.4 在 Dashboard 执行迁移
- [ ] 1.1.5 验证表结构和 RLS 策略

**注意**：不需要擴展 `format_specifications` 表，`constraints` 和 `content_requirements` 直接整合到 `spec_json` 中

### 1.2 评分标准数据准备

**基于真实教学案例**：IB MYP 中國古典文學評分標準（A/B/C/D 四個標準）

- [ ] 1.2.1 创建 `assets/data/grading-rubrics/` 目录
- [ ] 1.2.2 转换「中國古典文學」评分标准为 JSON 格式（已有文档）
- [ ] 1.2.3 定义评分标准 JSON Schema（参考已有文档）
- [ ] 1.2.4 创建评分标准加载器（`js/data/grading-rubric-loader.js`）
- [ ] 1.2.5 测试评分标准加载和引用

### 1.3 AI 格式生成 Edge Function

**參考文檔**：`AI_PROMPT_DESIGN.md`

- [ ] 1.3.1 創建 `supabase/functions/format-spec-generator/` 目錄
- [ ] 1.3.2 實現 System Prompt（複製自 AI_PROMPT_DESIGN.md）
- [ ] 1.3.3 實現 User Prompt Template
- [ ] 1.3.4 整合 DeepSeek API 調用
- [ ] 1.3.5 實現字數/段落數提取邏輯
- [ ] 1.3.6 實現內容要求轉換為 analysis_dimensions
- [ ] 1.3.7 實現 JSON 解析和驗證
- [ ] 1.3.8 實現理解確認信息生成
- [ ] 1.3.9 添加錯誤處理（模糊要求、矛盾要求）
- [ ] 1.3.10 配置環境變量（DEEPSEEK_API_KEY）
- [ ] 1.3.11 部署 Edge Function
- [ ] 1.3.12 使用真實案例測試（春江花月夜、鶯鶯傳、詩歌自選等 5 個）

**阶段 1 交付成果**：
- ✅ 数据库表结构完整（grading_rubrics, ai_grading_suggestions）
- ✅ 评分标准 JSON 数据准备完成
- ✅ AI Edge Function 部署并可用
- ✅ AI 能解析老师要求并生成双重输出（human_readable + JSON）
- ✅ 遵循 AI 职责边界（只客观检查，不主观判断）
- ✅ 可独立测试 AI 解析能力

---

## 🎨 阶段 2：统一 Quill 编辑器 + 格式管理

**目标**：完整的格式创建和管理界面  
**任务数**：29 个  
**会话**：第二次会话  
**前置条件**：✅ 阶段 1 已完成（AI Engine 可用）

### 2.1 老師端 - 統一 Quill 格式編輯器

**核心設計**：所有格式操作都在一個 Quill 編輯器中完成

- [ ] 2.1.1 創建格式編輯器頁面 HTML（卡片式格式選擇 + Quill 編輯器）
- [ ] 2.1.2 集成 Quill.js 純文本編輯器（toolbar: false）
- [ ] 2.1.3 實現系統格式卡片組件（圖標、名稱、簡介、預覽按鈕）
- [ ] 2.1.4 實現「從零開始」選項卡
- [ ] 2.1.5 實現格式 JSON → 人類可讀轉換函數
- [ ] 2.1.6 實現「加載預覽」功能（在 Quill 中顯示系統格式）
- [ ] 2.1.7 監聽 Quill 內容變化（檢測用戶修改，切換模式）
- [ ] 2.1.8 實現模式識別邏輯（direct / incremental / custom）
- [ ] 2.1.9 實現「AI 優化」按鈕和狀態管理（hasBeenOptimized）
- [ ] 2.1.10 實現 AI 優化請求（調用 format-spec-generator）
- [ ] 2.1.11 處理 AI 雙重輸出（human_readable + format_json）
- [ ] 2.1.12 實現 JSON 緩存（cachedFormatJSON）
- [ ] 2.1.13 實現「保存」按鈕邏輯（強制優化 + 自動優化流程）
- [ ] 2.1.14 實現格式命名和描述輸入
- [ ] 2.1.15 實現保存邏輯（區分三種模式）
- [ ] 2.1.16 測試三種模式的完整流程

### 2.2 老師端 - 自定義格式管理

- [ ] 2.2.1 創建格式管理頁面
- [ ] 2.2.2 實現格式列表展示（系統模板 + 自定義模板）
- [ ] 2.2.3 實現格式卡片組件（名稱、描述、創建時間、類型標籤）
- [ ] 2.2.4 實現格式詳情查看（展開/收起）
- [ ] 2.2.5 實現格式編輯功能（跳轉到編輯器）
- [ ] 2.2.6 實現格式刪除功能（簡化版：只能刪除自己創建的）
- [ ] 2.2.7 系統內置格式不可刪除（UI 禁用刪除按鈕）
- [ ] 2.2.8 實現格式搜索和篩選（按類型、創建者）
- [ ] 2.2.9 測試格式管理功能

**注意**：不檢查格式是否被任務使用（快照模式，刪除不影響已創建任務）

### 2.3 格式復制功能（MVP：直接復制）

**注意**：MVP 階段不做導出功能，老師可直接從 Quill 編輯器複製內容

- [ ] 2.3.1 在格式預覽頁面添加「複製格式說明」按鈕
- [ ] 2.3.2 實現一鍵複製到剪貼板功能
- [ ] 2.3.3 複製成功提示
- [ ] 2.3.4 測試複製到 Word/記事本等應用

**第二階段（可選）**：
- [ ] 2.3.5 引入 `docx.js` 庫
- [ ] 2.3.6 實現導出為 Word (.docx) 格式
- [ ] 2.3.7 實現導出為 PDF 格式

**阶段 2 交付成果**：
- ✅ 老师能在统一的 Quill 编辑器中创建格式
- ✅ 三种模式完整可用（直接使用 / 增量修改 / 完全自定义）
- ✅ 格式管理功能完整（查看、编辑、删除、搜索）
- ✅ 老师可以复制格式说明分享给学生
- ✅ 自定义格式保存到数据库

---

## 🔗 阶段 3：任务集成 + AI 评分系统

**目标**：完全集成到现有系统，老师可使用自定义格式创建任务并获得 AI 评分建议  
**任务数**：25 个  
**会话**：第三次会话  
**前置条件**：✅ 阶段 2 已完成（格式创建和管理）

### 3.1 任务创建集成

- [ ] 3.1.1 修改任务创建页面，新增「格式要求」步骤
- [ ] 3.1.2 实现格式选择器（系统模板 + 自定义模板）
- [ ] 3.1.3 实现「创建新格式」快捷入口（跳转到编辑器）
- [ ] 3.1.4 实现格式预览（在选择器中）
- [ ] 3.1.5 实现评分标准选择器（A/B/C/D 多选）
- [ ] 3.1.6 实现任务与格式的关联（保存快照到 format_spec_json）
- [ ] 3.1.7 测试任务创建流程（使用系统格式和自定义格式）

### 3.2 AI 评分代理 Edge Function

- [ ] 3.2.1 创建 `supabase/functions/grading-agent/` 目录
- [ ] 3.2.2 实现 Edge Function 基础结构
- [ ] 3.2.3 实现评分标准 JSON 加载
- [ ] 3.2.4 实现学生论文内容提取（essays + paragraphs）
- [ ] 3.2.5 实现基于评分标准的分析逻辑（DeepSeek API）
- [ ] 3.2.6 实现四个标准的评分生成（A/B/C/D，各 0-8 分）
- [ ] 3.2.7 实现评分理由生成（客观依据，不主观判断）
- [ ] 3.2.8 配置环境变量（复用 DEEPSEEK_API_KEY）
- [ ] 3.2.9 部署 Edge Function
- [ ] 3.2.10 测试 Edge Function 响应

### 3.3 老师端 - AI 评分建议界面

- [ ] 3.3.1 在老师批改页面添加「AI 评分建议」按钮
- [ ] 3.3.2 实现 AI 评分请求模块（js/teacher/ai-grading-requester.js）
- [ ] 3.3.3 实现加载状态动画（「AI 正在分析论文...」）
- [ ] 3.3.4 实现评分建议展示界面（四个标准的卡片）
- [ ] 3.3.5 实现四个标准的分数和理由显示
- [ ] 3.3.6 实现「采用建议」快捷按钮（一键填充老师评分表单）
- [ ] 3.3.7 确保学生端不可见 AI 评分（RLS 策略）
- [ ] 3.3.8 测试 AI 评分功能（完整流程）

**阶段 3 交付成果**：
- ✅ 老师创建任务时可选择自定义格式
- ✅ 任务创建流程完整集成格式选择
- ✅ 老师批改时可获得 AI 评分建议
- ✅ AI 评分基于选定的评分标准（A/B/C/D）
- ✅ 学生不可见 AI 评分
- ✅ 系统完全集成，生产就绪

---

## 📊 总任务统计（重新核对并重新划分）

**阶段 1：数据库 + AI 核心引擎**
- 1.1 数据库准备：5 个任务
- 1.2 评分标准准备：5 个任务
- 1.3 AI Edge Function：12 个任务
- **小计：22 个任务**

**阶段 2：统一 Quill 编辑器 + 格式管理**
- 2.1 Quill 编辑器界面：16 个任务
- 2.2 格式管理：9 个任务
- 2.3 复制功能：4 个任务（MVP）
- **小计：29 个任务**

**阶段 3：任务集成 + AI 评分系统**
- 3.1 任务创建集成：7 个任务
- 3.2 AI 评分 Edge Function：10 个任务
- 3.3 AI 评分 UI：8 个任务
- **小计：25 个任务**

**总计：76 个任务**（MVP 必需）+ **3 个可选任务**（Word/PDF 导出）= **79 个任务**

**任务分布**：
- 阶段 1：22 个任务（29%）
- 阶段 2：29 个任务（38%）
- 阶段 3：25 个任务（33%）

**划分调整说明**：
- 从 2 个阶段（38+38）→ 3 个阶段（22+29+25）
- 每个阶段更均衡（20-30 个任务范围）
- 每个阶段有明确的交付物和独立测试点
- 依赖关系清晰（数据库 → AI → 界面 → 集成）
- 风险控制（先验证 AI 核心能力，再做用户界面）

---

## 🎯 当前状态

**状态**：等待开始  
**前置条件**：✅ shiwen-baojian-mvp 阶段 3 已完成（131/151 任务，87%）

**依赖的已完成功能**：
- ✅ 任务管理系统（老师可创建任务）
- ✅ 批改系统（老师可批改论文）
- ✅ 格式规范表（`format_specifications` 已创建）
- ✅ AI 反馈引擎（`ai-feedback-agent` 已部署）

---

## 🔄 与现有系统的集成

### 依赖关系

```
shiwen-baojian-mvp (阶段 1-3) ✅ 已完成
    ↓
teacher-custom-format-ai (本变更)
    ↓ 依赖
    - format-specification-system（已创建 format_specifications 表）
    - teacher-assignment-management（任务创建系统）
    - teacher-grading（批改系统）
    - ai-feedback-agent（AI 反馈引擎）
```

### 数据流

```
【格式创建流程】
老师进入格式编辑器
    ↓
选择系统格式预览 OR 从零开始
    ↓
在 Quill 中查看/编辑要求
    ↓ (如有修改)
点击「AI 优化」→ format-spec-generator
    ↓
AI 返回双重输出（human_readable + format_json）
    ↓
Quill 显示 human_readable，缓存 format_json
    ↓
老师确认后保存（保存 format_json 到 format_specifications 表）

【任务创建流程】
老师创建任务
    ↓
选择格式（系统 OR 自定义）
    ↓
保存格式快照到 assignments.format_spec_json
    ↓
学生写作 → ai-feedback-agent（基于 format_spec_json）
    ↓
学生提交
    ↓
老师批改 → grading-agent（基于 grading_rubric_json）→ AI 评分建议
    ↓
老师最终评分
```

---

## 📝 注意事项

### 技术关键点

1. **格式快照模式**
   - 任务创建时保存格式 JSON 快照到 `format_spec_json`
   - 修改格式模板只影响未来创建的任务
   - 符合教学实际（任务布置后要求不变）

2. **AI 双重输出**
   - Edge Function 一次调用生成两种输出
   - human_readable：显示在 Quill，老师确认
   - format_json：缓存在前端，保存到数据库
   - 避免重复调用 AI（节省时间和成本）

3. **AI Prompt 设计**
   - 基于真实教学案例设计（参考 `AI_PROMPT_DESIGN.md`）
   - 支持多样化场景（从 400 字到 2500 字）
   - 遵循职责边界（客观检查，不主观判断）
   - Few-shot Examples 覆盖 5 种典型场景

4. **格式转换函数**
   - formatJSONToHumanReadable()：JSON → 人类可读
   - 用于系统格式预览和 AI 输出展示
   - 格式化输出（标题、列表、缩进）

### 用户体验关键点

1. **统一 Quill 界面**
   - 所有格式操作都在同一个编辑器中
   - 系统格式预览也显示在 Quill 中（人类可读）
   - 三种模式自然流转，无需跳转页面

2. **强制优化逻辑**
   - 模式 A（直接使用）：保存按钮始终可用
   - 模式 B/C（有修改）：必须 AI 优化后才能保存
   - 内容变化后自动禁用保存，提示优化

3. **AI 优化体验**
   - 加载动画：「AI 正在理解您的要求...」（3-5 秒）
   - 优化完成：Quill 内容更新为结构化版本
   - 理解总结：让老师确认 AI 的理解

4. **错误处理**
   - AI 解析失败：友好提示 + 允许重新编辑
   - 网络失败：提示并保留用户输入
   - JSON 缓存丢失：自动重新优化

---

## 🧪 测试场景（基于真实教学案例）

### 场景 1：模式 A - 直接使用系统格式

1. 老师进入格式编辑器
2. 选择「红楼梦论文格式」
3. 点击「加载预览」→ Quill 显示人类可读版本
4. 老师阅读确认：「很好，就用这个」
5. 点击「直接保存使用」
6. 在任务创建时选择此格式

**验证**：
- ✅ 不调用 AI（直接使用系统格式 JSON）
- ✅ 保存速度快（无需等待 AI）

---

### 场景 2：模式 B - 基于系统格式增量

1. 老师选择「红楼梦论文格式」并加载预览
2. 在 Quill 底部添加：
   ```
   总字数 1800-2000 字
   必须 3 个分论点
   详细分析林黛玉和薛宝钗的外貌描写
   ```
3. 点击「AI 优化」（3-5 秒）
4. Quill 显示优化后的结构化版本
5. 老师确认并保存为「张老师红楼梦人物分析 2025」
6. 创建任务时选择此格式
7. 学生收到 AI 反馈时包含「外貌描写分析」维度

**验证**：
- ✅ AI 正确识别增量要求
- ✅ 合并到系统格式
- ✅ 双重输出正常（human_readable + JSON）

---

### 场景 3：模式 C - 完全自定义（极简任务）

**真实案例**：春江花月夜结构分析

1. 老师选择「从零开始」
2. 在 Quill 中输入：
   ```
   请从至少两个方面，写两段话（不需要开头结尾），
   分析《春江花月夜》结构安排的精妙之处。
   字数：400-600 字
   评分标准：B 理解
   ```
3. 点击「AI 优化」
4. AI 输出结构化版本（两段式，无完整论文结构）
5. 老师确认并保存
6. 创建任务时使用此格式
7. 学生写作时只需写两段分析（无需引言和结论）

**验证**：
- ✅ AI 识别这是精简任务
- ✅ 不强加完整论文结构
- ✅ 忠实于老师要求

---

### 场景 4：模式 C - 完全自定义（三段固定结构）

**真实案例**：鶯鶯傳人物分析短写

1. 老师输入三段结构要求
2. AI 优化并生成对应的检查点
3. 保存格式
4. 学生按照三段结构写作
5. AI 反馈检查每段是否符合要求

**验证**：
- ✅ AI 识别固定结构
- ✅ 生成对应的 required_elements

---

### 场景 5：AI 评分建议

1. 学生完成论文并提交
2. 老师打开批改页面
3. 点击「AI 评分建议」
4. 3-5 秒后看到四个标准的评分（A/B/C/D，各 0-8 分）
5. 显示评分理由（基于客观依据）
6. 老师参考后手动调整分数
7. 学生只能看到老师的最终评分

**验证**：
- ✅ AI 评分基于选定的评分标准
- ✅ 评分理由客观（不主观判断）
- ✅ 学生不可见 AI 建议

---

### 场景 6：格式复制分享

1. 老师查看自定义格式
2. 点击「复制格式说明」
3. 复制到剪贴板
4. 粘贴到 Word 或 Google Docs
5. 分享给学生或同事

**验证**：
- ✅ 复制内容格式正确
- ✅ 可在其他应用中使用

