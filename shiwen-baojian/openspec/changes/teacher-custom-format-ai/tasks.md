# 老师自定义格式 + AI 辅助生成 - 任务清单

## 📋 实施策略

**分 2 个会话完成，每个会话一个阶段。**

---

## 🤖 阶段 1：AI 格式生成器 + 评分标准系统

**目标**：老师能用自然语言创建自定义格式，AI 自动生成 JSON  
**预计任务数**：28 个

### 1.1 数据库扩展

- [ ] 1.1.1 创建 `015_extend_format_specifications.sql` 迁移
- [ ] 1.1.2 扩展 `format_specifications` 表字段（`constraints`, `content_requirements`, `is_shared`, `shared_with`）
- [ ] 1.1.3 创建 `016_create_grading_rubrics.sql` 迁移
- [ ] 1.1.4 创建 `grading_rubrics` 表
- [ ] 1.1.5 创建 `ai_grading_suggestions` 表
- [ ] 1.1.6 在 Dashboard 执行迁移
- [ ] 1.1.7 验证表结构和 RLS 策略

### 1.2 评分标准数据准备

- [ ] 1.2.1 创建 `assets/data/grading-rubrics/` 目录
- [ ] 1.2.2 转换「中國古典文學」评分标准为 JSON 格式
- [ ] 1.2.3 定义评分标准 JSON Schema
- [ ] 1.2.4 创建评分标准加载器（`js/data/grading-rubric-loader.js`）
- [ ] 1.2.5 测试评分标准加载

### 1.3 AI 格式生成 Edge Function

- [ ] 1.3.1 创建 `supabase/functions/format-spec-generator/` 目录
- [ ] 1.3.2 实现 Edge Function 基础结构
- [ ] 1.3.3 实现老师要求解析逻辑（DeepSeek API）
- [ ] 1.3.4 实现系统模板加载逻辑
- [ ] 1.3.5 实现智能合并算法（系统模板 + 老师要求）
- [ ] 1.3.6 实现冲突检测和解决（老师优先）
- [ ] 1.3.7 实现字数/段落数提取
- [ ] 1.3.8 实现内容要求转换为 analysis_dimensions
- [ ] 1.3.9 实现理解确认信息生成
- [ ] 1.3.10 配置环境变量（DEEPSEEK_API_KEY）
- [ ] 1.3.11 部署 Edge Function
- [ ] 1.3.12 测试 Edge Function 响应

### 1.4 老师端 - 格式编辑器界面

- [ ] 1.4.1 创建格式编辑器页面 HTML
- [ ] 1.4.2 集成 Quill.js 富文本编辑器
- [ ] 1.4.3 实现系统模板选择器（下拉菜单）
- [ ] 1.4.4 实现"基于模板"vs"从零开始"切换
- [ ] 1.4.5 实现"提交给 AI 解析"按钮
- [ ] 1.4.6 实现 AI 解析请求模块（`js/teacher/ai-format-requester.js`）
- [ ] 1.4.7 实现加载状态动画
- [ ] 1.4.8 实现 AI 理解结果可视化展示
- [ ] 1.4.9 实现冲突解决展示（老师确认）
- [ ] 1.4.10 实现"确认"和"重新编辑"按钮
- [ ] 1.4.11 实现格式命名和描述输入
- [ ] 1.4.12 实现保存自定义格式功能
- [ ] 1.4.13 测试完整编辑流程

**阶段 1 交付成果**：
- ✅ 老师能在编辑器中写自然语言要求
- ✅ AI 能解析并生成 JSON 格式规范
- ✅ 老师能看到 AI 的理解结果并确认
- ✅ 自定义格式保存到数据库

---

## 📊 阶段 2：格式管理 + AI 评分 + 导出功能

**目标**：老师能管理自定义格式、使用 AI 评分建议、导出格式文档  
**预计任务数**：26 个

### 2.1 老师端 - 自定义格式管理

- [ ] 2.1.1 创建格式管理页面
- [ ] 2.1.2 实现格式列表展示（系统模板 + 自定义模板）
- [ ] 2.1.3 实现格式卡片组件（显示名称、描述、创建时间）
- [ ] 2.1.4 实现格式详情查看
- [ ] 2.1.5 实现格式编辑功能
- [ ] 2.1.6 实现格式删除功能（带使用检查）
- [ ] 2.1.7 实现正在使用的格式不可删除提示
- [ ] 2.1.8 实现格式搜索和筛选
- [ ] 2.1.9 测试格式管理功能

### 2.2 格式导出功能

- [ ] 2.2.1 创建格式导出模块（`js/teacher/format-exporter.js`）
- [ ] 2.2.2 实现导出为 Markdown 格式
- [ ] 2.2.3 实现 Markdown 格式化（标题、列表、代码块）
- [ ] 2.2.4 实现下载为 .md 文件
- [ ] 2.2.5 在格式编辑器中添加"导出"按钮
- [ ] 2.2.6 测试导出功能

### 2.3 任务创建集成

- [ ] 2.3.1 修改任务创建页面，新增"格式要求"步骤
- [ ] 2.3.2 实现格式选择器（系统模板 + 自定义模板）
- [ ] 2.3.3 实现"创建新格式"快捷入口
- [ ] 2.3.4 实现格式预览
- [ ] 2.3.5 实现评分标准选择器
- [ ] 2.3.6 实现任务与格式的关联（动态引用）
- [ ] 2.3.7 测试任务创建流程

### 2.4 AI 评分代理 Edge Function

- [ ] 2.4.1 创建 `supabase/functions/grading-agent/` 目录
- [ ] 2.4.2 实现 Edge Function 基础结构
- [ ] 2.4.3 实现评分标准 JSON 加载
- [ ] 2.4.4 实现学生论文内容提取
- [ ] 2.4.5 实现基于评分标准的分析逻辑（DeepSeek API）
- [ ] 2.4.6 实现四个标准的评分生成（A/B/C/D，各 0-8 分）
- [ ] 2.4.7 实现评分理由生成
- [ ] 2.4.8 配置环境变量
- [ ] 2.4.9 部署 Edge Function
- [ ] 2.4.10 测试 Edge Function 响应

### 2.5 老师端 - AI 评分建议

- [ ] 2.5.1 在老师批改页面添加"AI 评分建议"按钮
- [ ] 2.5.2 实现 AI 评分请求模块
- [ ] 2.5.3 实现加载状态动画
- [ ] 2.5.4 实现评分建议展示界面
- [ ] 2.5.5 实现四个标准的分数和理由显示
- [ ] 2.5.6 实现"采用建议"快捷按钮（填充老师评分表单）
- [ ] 2.5.7 确保学生端不可见 AI 评分
- [ ] 2.5.8 测试 AI 评分功能

**阶段 2 交付成果**：
- ✅ 老师能管理自定义格式（查看、编辑、删除）
- ✅ 老师能导出格式为 Markdown 文件
- ✅ 老师在创建任务时能选择自定义格式
- ✅ 老师批改时能获得 AI 评分建议
- ✅ 学生不可见 AI 评分

---

## 📊 总任务统计

- 阶段 1：28 个任务（AI 格式生成 + 评分标准）
- 阶段 2：26 个任务（格式管理 + AI 评分 + 导出）
- **总计**：54 个任务

---

## 🎯 当前状态

**状态**：等待开始  
**前置条件**：shiwen-baojian-mvp 阶段 2 已完成

---

## 🔄 与现有系统的集成

### 依赖关系

```
shiwen-baojian-mvp (阶段 1-2)
    ↓ 已完成
teacher-custom-format-ai (本变更)
    ↓ 依赖
    - format-specification-system (扩展)
    - teacher-assignment-management (修改)
    - teacher-grading (扩展)
```

### 数据流

```
老师创建任务
    ↓
选择/创建格式规范
    ↓ (如需创建)
编辑器输入要求 → format-spec-generator (AI) → JSON 规范
    ↓
保存自定义格式
    ↓
任务引用格式 ID（动态）
    ↓
学生写作
    ↓
ai-feedback-agent (基于格式规范)
    ↓
学生提交
    ↓
老师批改
    ↓
grading-agent (基于评分标准) → AI 评分建议
    ↓
老师最终评分
```

---

## 📝 注意事项

### 技术关键点

1. **动态模板引用**
   - 任务表存储 `format_spec_id`（不快照 JSON）
   - 每次使用时从数据库加载最新版
   - 需要缓存优化（避免频繁查询）

2. **AI Prompt 设计**
   - `format-spec-generator` 需要精心设计的 System Prompt
   - 示例：识别字数、段落数、内容要求的模式
   - 需要处理模糊或矛盾的老师要求

3. **冲突解决逻辑**
   - 老师要求 > 系统模板
   - 但需要保留系统模板的其他部分（不覆盖全部）
   - 需要细粒度的合并算法

4. **导出格式**
   - Markdown：直接转换 Quill Delta → Markdown
   - 需要处理富文本格式（粗体、斜体、列表）

### 用户体验关键点

1. **AI 理解可视化**
   - 不要直接展示 JSON（老师看不懂）
   - 用表格或卡片展示理解结果
   - 突出显示冲突解决方案

2. **错误处理**
   - AI 解析失败时的友好提示
   - 允许老师手动调整（简化表单）
   - 提供示例和帮助文档

3. **性能优化**
   - AI 解析可能需要 5-10 秒
   - 需要良好的加载动画
   - 考虑后台处理 + 通知

---

## 🧪 测试场景

### 场景 1：基于系统模板创建

1. 老师选择"红楼梦论文格式"
2. 添加要求："详细分析林黛玉和薛宝钗的外貌描写，每个人物不少于 300 字，总字数 1800 字"
3. AI 解析成功
4. 老师确认并保存为"张老师红楼梦人物分析 2025"
5. 在任务创建时选择此格式
6. 学生收到 AI 反馈时包含"外貌描写分析"维度

### 场景 2：完全自定义格式

1. 老师选择"从零开始"
2. 输入详细要求（引言、正文、结论的结构）
3. AI 解析成功
4. 老师确认并保存
5. 使用此格式创建任务

### 场景 3：格式更新实时生效

1. 老师修改已使用的自定义格式（增加字数要求）
2. 正在进行的任务中，学生立即看到新的字数要求
3. 之前的 AI 反馈仍然有效（基于旧版本）
4. 新的 AI 反馈基于最新版本

### 场景 4：AI 评分建议

1. 学生完成论文并提交
2. 老师打开批改页面
3. 点击"AI 评分建议"
4. 5 秒后看到四个标准的评分和理由
5. 老师参考后手动调整分数
6. 学生只能看到老师的最终评分（看不到 AI 建议）

### 场景 5：导出格式文档

1. 老师编辑完自定义格式
2. 点击"导出为 Markdown"
3. 下载 `张老师红楼梦人物分析2025.md` 文件
4. 用其他编辑器打开，格式正确
5. 可以用于发送给学生或存档

