# 阶段 3.4 任务审查总结（2025-10-20）

## 📋 审查背景

**审查时间**：2025-10-20  
**审查范围**：阶段 3.4 单页应用集成任务（原 28 个）  
**审查目的**：确保任务清单完整、逻辑清晰、可实施

---

## 🔍 发现的问题

### 问题 1：导入顺序和依赖（中等严重）⚠️

**问题描述**：
- 原任务 3.4.3.2 要求在 `teacher-dashboard.js` 导入 `FormatTemplatePage`
- 但 `format-template-page.js` 文件要到 3.4.4.1 才创建
- 会导致导入错误和测试失败

**解决方案**：
- ✅ 3.4.3.2 改为添加 TODO 注释（占位符）
- ✅ 新增 3.4.3.4：在 3.4.4.1 完成后取消注释
- ✅ 允许 3.4.3.3 测试导航切换（显示"开发中"占位符）

**修改后任务**：
```
3.4.3.2 添加路由占位符（TODO 注释）
3.4.3.3 测试导航切换（占位符版本）
3.4.3.4 取消注释（在 3.4.4.1 完成后）← 新增
```

---

### 问题 2：localStorage key 冲突（小问题）⚠️

**问题描述**：
- 模板库页面的编辑器
- 任务创建界面的展开式编辑器
- 原设计都用 `'format-editor-draft'`，会**互相覆盖**

**解决方案**：
- ✅ 区分不同场景的 key：
  - 模板库：`'format-editor-draft-template'`
  - 任务创建：`'format-editor-draft-inline'`

**修改后任务 3.4.2.4**：
```javascript
// 草稿保存区分场景
- 模板库：'format-editor-draft-template'
- 任务创建：'format-editor-draft-inline'
```

---

### 问题 3：FormatEditorCore 设计不明确（需澄清）❓

**问题描述**：
- 3.4.2.1 没有说明类的设计模式
- 3.4.2.3 要求传入 `supabaseClient` 参数
- 但没说明是实例类还是工具类

**解决方案**（用户已确认）：
- ✅ 设计为**纯工具类**（静态方法）
- ✅ 不持有状态，不需要构造函数
- ✅ 所有方法都是 `static`
- ✅ 需要 supabase 的方法通过参数传入

**修改后设计**：
```javascript
class FormatEditorCore {
  static initQuill(container, options) { ... }
  static async optimizeWithAI(text, mode, baseFormatId, supabase) { ... }
  static async saveFormat(formatData, supabase) { ... }
  static setupDraftAutoSave(quill, draftKey) { ... }
  static loadDraft(draftKey) { ... }
  static clearDraft(draftKey) { ... }
}
```

---

### 问题 4：编辑器 ID 可能冲突（需注意）⚠️

**问题描述**：
- 模板库页面：Quill 容器 `#template-editor`
- 任务创建页面：Quill 容器 `#inline-quill-editor`
- 两个页面不会同时显示（单页应用），所以不会冲突 ✅
- 但需要确保 Quill 实例不重复初始化

**解决方案**：
- ✅ 在 3.4.5.3 补充说明：检查是否已初始化
- ✅ 使用唯一 ID 避免潜在冲突

**修改后任务 3.4.5.3**：
```
- 确保容器 ID 唯一
- 检查是否已初始化，避免重复创建
- 折叠时销毁 Quill 实例（避免内存泄漏）
```

---

### 问题 5：模板库页面的"查看"功能不明确（需澄清）❓

**问题描述**：
- 原任务 3.4.4.2 提到"查看、编辑、删除"按钮
- 但没说明"查看"是什么形式

**解决方案**（用户已确认）：
- ✅ 点击卡片 → 模态框显示 `human_input`（查看详情）
- ✅ 编辑按钮 → 切换到编辑模式
- ✅ 删除按钮 → 确认后删除（系统格式不显示）

**修改后任务 3.4.4.2**：
```
卡片操作：
- 点击卡片 → 模态框显示 human_input（查看详情）
- 编辑按钮 → 切换到编辑模式
- 删除按钮 → 确认后删除（系统格式不显示删除按钮）
```

---

### 问题 6：导航栏文字修改（遗漏）⚠️

**问题描述**：
- 原任务 3.4.3.1 只提到"添加模板库按钮"
- 但根据规划，还需要修改现有按钮文字（我的任務 → 作業管理）

**解决方案**：
- ✅ 新增任务说明：修改现有按钮文字
- ✅ 最终导航：班級管理 / 作業管理 / 模板庫

**修改后任务 3.4.3.1**：
```
- 修改现有按钮：将「我的任務」改为「作業管理」
- 添加新按钮：模板庫
```

---

## ✅ 用户确认的调整

### 确认 1：FormatEditorCore 设计
> **用户**："1、同意"（纯工具类 + 静态方法）

### 确认 2：导入顺序调整
> **用户**："2 同意"（先占位，后取消注释）

### 确认 3：查看功能实现
> **用户**："3，同意"（模态框显示详情）

### 确认 4：任务数量增加
> **用户**："4 可以"（从 28 增加到 30）

---

## 📊 调整后的任务统计

### 原计划
- **任务数**：28 个
- **总进度**：64/106（60%）

### 调整后
- **任务数**：30 个（+2）
  - 3.4.3.4（新增）：取消注释
  - 导航从 3 个改为 4 个
- **总任务**：111 个（108 个 MVP + 3 个可选）
- **总进度**：64/108（59%）

### 任务分布
```
阶段 1：23 个 ✅ 完成
阶段 2：41 个 ✅ 完成
阶段 3.1-3.3：14 个（进行中）
阶段 3.4：30 个（审查后确定）← 新增
```

---

## 🔧 详细修改记录

### 3.4.2.1 创建 FormatEditorCore
**修改前**：
- 定义 `FormatEditorCore` 类
- Quill 初始化方法

**修改后**：
- ✅ **设计为纯工具类**：所有方法都是 static
- ✅ 明确方法签名（包含 supabase 参数）
- ✅ 复用 format-editor.js 的相关代码

---

### 3.4.2.4 草稿自动保存
**修改前**：
- 自动保存到 `localStorage.setItem('format-editor-draft', text)`

**修改后**：
- ✅ **区分不同场景的 key**：
  - 模板库：`'format-editor-draft-template'`
  - 任务创建：`'format-editor-draft-inline'`
- ✅ 新增方法：`loadDraft(draftKey)`, `clearDraft(draftKey)`

---

### 3.4.3 导航和路由
**修改前**：3 个任务

**修改后**：4 个任务
- ✅ 3.4.3.1：修改现有按钮文字 + 添加新按钮
- ✅ 3.4.3.2：添加 TODO 注释（占位符）
- ✅ 3.4.3.3：测试占位符版本
- ✅ 3.4.3.4：**新增** - 取消注释

---

### 3.4.4.2 列表模式
**修改前**：
- 按钮：创建、查看、编辑、删除

**修改后**：
- ✅ 明确"查看"实现：点击卡片 → 模态框显示详情
- ✅ 系统格式不显示删除按钮

---

### 3.4.5.3 集成 Quill
**修改前**：
- 展开时初始化

**修改后**：
- ✅ 确保容器 ID 唯一
- ✅ 检查是否已初始化
- ✅ 折叠时销毁实例

---

## 📋 关键设计决策总结

### 1. FormatEditorCore 架构
- **类型**：纯工具类（静态方法）
- **优点**：无状态，易复用，清晰简单
- **使用方式**：`FormatEditorCore.initQuill(...)`

### 2. localStorage 管理
- **key 命名**：区分场景（template / inline）
- **自动保存**：每次内容变化
- **恢复机制**：页面加载时询问

### 3. 导航结构
- **最终导航**：班級管理 / 作業管理 / 模板庫
- **默认页面**：作業管理
- **路由模式**：单页应用（SPA）

### 4. 模板库交互
- **查看**：模态框显示详情
- **编辑**：整页切换到编辑模式
- **删除**：系统格式不可删除

### 5. 任务创建集成
- **编辑器形式**：展开式（内联）
- **容器 ID**：`#inline-quill-editor`
- **草稿 key**：`format-editor-draft-inline`

---

## 🎯 实施准备

### 已完成
- ✅ 发现并修正所有问题
- ✅ 获得用户确认
- ✅ 更新 tasks.md（30 个任务）
- ✅ 更新总任务统计（108 个）

### 下一步
- 🚀 开始实施第一步：3.4.1.1 创建数据库迁移
- 📝 按顺序完成 30 个任务
- ✅ 每个步骤测试验证

---

## 📚 参考文档

- `tasks.md` - 主任务清单（已更新）
- `proposal.md` - 提案文档
- `INTEGRATION_PLAN.md` - 集成架构设计
- `STAGE3.4_PLAN_CONFIRMED.md` - 用户确认的计划

---

**审查完成时间**：2025-10-20  
**审查结论**：✅ 任务清单已优化，准备实施

