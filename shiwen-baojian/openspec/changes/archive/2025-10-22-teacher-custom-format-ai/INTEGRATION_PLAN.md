# 集成到单页应用 - 详细规划

**创建时间**：2025-10-20  
**状态**：规划中，等待用户确认

---

## 🎯 为什么需要集成？

### 问题发现
- ✅ 阶段 2 创建了功能完整的独立页面（format-editor.html, format-manager.html）
- ✅ 这些页面已测试，功能正常，无 bug
- ❌ **但未集成到 index.html 单页应用**
- ❌ 用户需要在多个页面之间跳转，体验割裂
- ❌ 导航不统一，概念混淆

### 用户反馈
在测试阶段 3 时发现：
- 老师在"创建新任务"界面看到硬编码的格式选项
- 点击后显示 `undefined`（因为未连接到 Supabase）
- 没有集成阶段 2 开发的写作要求管理功能

---

## 🎨 设计方案（方案 C：混合模式）

### 核心理念

**区分两种写作要求**：
1. **通用模板**（is_template = true）
   - 可在多个任务中复用
   - 显示在"模板庫"页面
   - 例如：「红楼梦论文格式」、「张老师 论文格式 v2.0」

2. **任务专属**（is_template = false）
   - 只用于单个任务
   - 不显示在"模板庫"页面
   - 例如：「2025秋 红楼梦外貌分析」（高度定制，包含具体主题）

### 导航栏设计

**最终方案**：**班級管理 / 作業管理 / 模板庫**

```html
<nav class="flex gap-6">
  <button class="nav-tab" data-page="class-management">
    <i class="fas fa-users"></i> 班級管理
  </button>
  <button class="nav-tab active" data-page="assignments">
    <i class="fas fa-clipboard-list"></i> 作業管理
  </button>
  <button class="nav-tab" data-page="format-templates">
    <i class="fas fa-bookmark"></i> 模板庫
  </button>
</nav>
```

**为什么这样命名**：
- ✅ 结构统一（XX管理 / 名词）
- ✅ "作业管理"比"我的任务"更清晰（包含布置+批改）
- ✅ "模板库"突出资源库概念（可复用的模板）
- ✅ 信息准确，减少歧义

### 默认页面

**改为**：老师登录后默认显示"作業管理"

**理由**：
- 老师最常用的功能是查看作业、批改
- 班级管理只在学期初设置

---

## 🏗️ 架构设计

### 页面结构

#### 1. 模板库页面（format-templates）

**列表模式**（默认）：
```
┌─────────────────────────────────────────┐
│ 我的寫作模板                   [+ 創建]  │
│ [搜索...]  [筛选▼]  [排序▼]              │
├─────────────────────────────────────────┤
│ 📚 系统模板                              │
│ ┌──────────┐ ┌──────────┐              │
│ │红楼梦论文│ │说明文格式│              │
│ │1500-2500│ │800-1200 │              │
│ │[查看][编辑]│ │[查看][复制]│              │
│ └──────────┘ └──────────┘              │
│                                         │
│ ✏️ 我的模板                              │
│ ┌──────────┐ ┌──────────┐              │
│ │张老师v2.0│ │分析文格式│              │
│ │使用3次   │ │使用1次   │              │
│ │[查看][编辑][删除]│                      │
│ └──────────┘ └──────────┘              │
└─────────────────────────────────────────┘
```

**编辑模式**（点击"创建"或"编辑"）：
```
┌─────────────────────────────────────────┐
│ [← 返回列表]  編輯寫作模板               │
├─────────────────────────────────────────┤
│ 選擇起點：                               │
│ [从零开始] [基于红楼梦]                  │
│                                         │
│ ┌───────────────────────────────────┐  │
│ │ Quill 编辑器                       │  │
│ │ （输入或编辑写作要求）              │  │
│ └───────────────────────────────────┘  │
│                                         │
│ [AI 优化] [保存] [取消]                  │
└─────────────────────────────────────────┘
```

---

#### 2. 任务创建界面（assignments → create）

**默认状态**：
```
┌─────────────────────────────────────────┐
│ 創建新任務                               │
├─────────────────────────────────────────┤
│ 任务标题：_________________              │
│                                         │
│ 寫作要求：                               │
│ [选择现有模板 ▼] [+ 创建新写作要求]     │
│ └─ 预览区域（选中后显示）                │
│                                         │
│ 评分标准：...                            │
└─────────────────────────────────────────┘
```

**展开编辑器**（点击"+ 创建新写作要求"）：
```
┌─────────────────────────────────────────┐
│ 寫作要求：                               │
│ [选择现有模板 ▼ (禁用)] [+ 创建... (禁用)]│
│                                         │
│ ┌─── 创建新写作要求 ──────────────┐     │
│ │ 起点：[从零][红楼梦]              │     │
│ │ ┌─────────────────────────────┐ │     │
│ │ │ Quill 编辑器                 │ │     │
│ │ └─────────────────────────────┘ │     │
│ │ [AI优化] [保存并使用] [取消]     │     │
│ └────────────────────────────────┘     │
│                                         │
│ 评分标准：...                            │
└─────────────────────────────────────────┘
```

**保存对话框**：
```
┌──────────────────────┐
│ 保存寫作要求          │
├──────────────────────┤
│ 名称：__________      │
│ 描述：__________      │
│                      │
│ 类型：               │
│ ○ 通用模板（可复用） │
│ ● 仅用于本次任务     │
│                      │
│ [取消] [保存]         │
└──────────────────────┘
```

---

## 📊 数据库设计

### 新增字段

```sql
-- 019_add_is_template_field.sql

ALTER TABLE public.format_specifications
ADD COLUMN is_template BOOLEAN DEFAULT false;

COMMENT ON COLUMN public.format_specifications.is_template IS 
'是否为通用模板。true = 可复用模板，显示在模板库；false = 任务专属写作要求，不显示在模板库。';

-- 更新系统格式为通用模板
UPDATE public.format_specifications
SET is_template = true
WHERE is_system = true;
```

### 查询逻辑

```javascript
// 模板库页面：只显示通用模板
.from('format_specifications')
.select('*')
.or('is_template.eq.true,is_system.eq.true')

// 任务创建下拉菜单：显示所有（通用 + 任务专属）
.from('format_specifications')
.select('*')
.or('is_system.eq.true,created_by.eq.userId')
```

---

## 🔧 技术实施

### 文件结构

**新建文件**：
```
shiwen-baojian/js/teacher/
├── format-template-page.js     ⭐ 模板库页面组件
├── format-editor-core.js       ⭐ 共享编辑器逻辑
└── supabase/migrations/
    └── 019_add_is_template_field.sql  ⭐ 数据库迁移
```

**修改文件**：
```
shiwen-baojian/
├── index.html                  ⭐ 添加导航
├── js/
│   ├── teacher/
│   │   ├── teacher-dashboard.js   ⭐ 添加路由 + 默认页面
│   │   └── assignment-creator.js  ⭐ 添加展开式编辑器
```

**保留文件**（集成完成并测试后决定）：
```
shiwen-baojian/
├── format-editor.html      ✅ 备用直接访问
├── format-manager.html     ✅ 备用直接访问
├── js/teacher/
│   ├── format-editor.js    ✅ 逻辑已提取到 core
│   └── format-manager.js   ✅ 逻辑已提取到 page
```

---

## 📋 实施步骤（28 个任务）

### 步骤 1：数据库 + 默认页面（2 个任务）
- 创建迁移，添加 is_template 字段
- 修改默认导航页面

### 步骤 2：模板库导航和路由（3 个任务）
- 添加导航按钮
- 添加路由处理
- 测试导航切换

### 步骤 3：模板库页面组件（5 个任务）
- 创建组件文件
- 实现列表模式
- 实现编辑模式
- 实现模式切换
- 测试页面功能

### 步骤 4：任务创建集成（7 个任务）
- 修改 HTML 模板
- 展开/折叠逻辑
- 集成 Quill 编辑器
- AI 优化功能
- 保存对话框
- 保存并使用流程
- 测试集成

### 步骤 5：共享组件（4 个任务）
- 创建 format-editor-core.js
- 重构模板库页面
- 重构任务创建
- 测试共享组件

### 步骤 6：UI 统一（5 个任务）
- 统一颜色主题
- 统一卡片样式
- 统一按钮样式
- 响应式设计
- 测试 UI 一致性

### 步骤 7：完整测试（4 个任务）
- 测试三个页面导航
- 测试模板库功能
- 测试任务创建集成
- 验证通用模板 vs 任务专属

### 步骤 8：清理（2 个任务）
- 决定是否删除独立页面
- 更新文档

---

## 🎨 UI 风格参考

### index.html 的设计语言

**颜色系统**：
```css
/* 主色调 */
--blue-primary: #3498db
--blue-dark: #2980b9
--indigo: #667eea
--purple: #764ba2

/* 渐变 */
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)
```

**组件样式**：
```css
/* 卡片 */
.card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 1.5rem;
}

/* 按钮 - 主要 */
.btn-primary {
  background: #3498db;
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  transition: all 0.2s;
}

.btn-primary:hover {
  background: #2980b9;
}

/* 按钮 - 次要 */
.btn-secondary {
  background: #95a5a6;
  color: white;
}
```

**导航标签**：
```css
.nav-tab {
  padding: 0.75rem 1.5rem;
  color: #7f8c8d;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.nav-tab.active {
  color: #3498db;
  border-bottom-color: #3498db;
}
```

---

## 🔄 数据流

### 通用模板创建流程

```
模板库页面
  ↓
点击"创建新模板"
  ↓
页面切换到编辑模式
  ↓
选择起点（从零/系统格式）
  ↓
在 Quill 中编辑
  ↓
AI 优化（两阶段流程）
  ↓
保存（is_template = true）
  ↓
返回列表模式，新模板出现在列表中
```

### 任务专属写作要求创建流程

```
任务创建界面
  ↓
点击"+ 创建新写作要求"
  ↓
展开内联编辑器
  ↓
编辑 + AI 优化
  ↓
保存对话框 → 选择"仅用于本次任务"
  ↓
保存（is_template = false）
  ↓
编辑器折叠，下拉菜单自动选中
  ↓
继续填写其他信息，发布任务
```

---

## 📝 代码复用策略

### 从独立页面提取逻辑

**format-manager.js** → **format-template-page.js（列表模式）**
- ✅ 查询逻辑
- ✅ 卡片渲染
- ✅ 搜索/筛选
- ✅ 删除确认

**format-editor.js** → **format-editor-core.js**
- ✅ Quill 初始化
- ✅ AI 优化调用
- ✅ 格式保存
- ✅ 系统格式加载

**复用原则**：
- 直接复制可用代码
- 调整 UI 以匹配 index.html 风格
- 移除独立页面特有的导航元素

---

## ⚠️ 风险和缓解

### 风险 1：Quill 实例冲突
**问题**：任务创建界面可能同时存在多个 Quill 实例  
**缓解**：使用唯一 ID（`inline-quill-editor`），销毁逻辑

### 风险 2：样式冲突
**问题**：format-editor.css 可能与 index.html 样式冲突  
**缓解**：使用内联样式或命名空间隔离

### 风险 3：状态管理
**问题**：展开/折叠状态可能混乱  
**缓解**：明确的状态变量（isEditorExpanded）

---

## ✅ 成功标准

**集成完成后应该能够**：

1. **导航流畅**：
   - ✅ 三个页面切换无卡顿
   - ✅ 默认页面正确（作業管理）

2. **模板库功能完整**：
   - ✅ 查看所有通用模板
   - ✅ 创建新模板（整页编辑）
   - ✅ 编辑现有模板
   - ✅ 删除模板
   - ✅ 返回列表

3. **任务创建集成**：
   - ✅ 下拉菜单显示所有可用写作要求
   - ✅ 点击"创建"展开编辑器
   - ✅ AI 优化正常工作
   - ✅ 保存对话框询问类型
   - ✅ 保存后自动选中

4. **UI 统一**：
   - ✅ 颜色主题一致
   - ✅ 组件样式一致
   - ✅ 完美融入 index.html

5. **功能正确**：
   - ✅ 通用模板显示在模板库
   - ✅ 任务专属不显示在模板库
   - ✅ 所有已有功能正常工作

---

## 📅 实施时间表

**预计总时间**：5-6 小时

| 步骤 | 任务数 | 预计时间 | 可中断 |
|------|--------|---------|--------|
| 1 | 2 | 30分钟 | ✅ |
| 2 | 3 | 30分钟 | ✅ |
| 3 | 5 | 2小时 | ✅ |
| 4 | 7 | 2小时 | ⚠️ |
| 5 | 4 | 1小时 | ✅ |
| 6 | 5 | 30分钟 | ✅ |
| 7 | 4 | 30分钟 | ✅ |
| 8 | 2 | 30分钟 | ✅ |

**建议**：可以分多次会话完成，每次完成 1-2 个步骤

---

## ❓ 待确认问题

### 1. 实施方式
- [ ] 一次性完成（5-6 小时连续工作）
- [ ] 分步完成（每次 1-2 步骤，可中断）

### 2. 测试策略
- [ ] 每步完成都测试
- [ ] 全部完成后统一测试

### 3. 独立页面处理
- [ ] 集成完成立即删除
- [ ] 保留作为备用

---

**等待您的确认指令开始实施！** 🚀

