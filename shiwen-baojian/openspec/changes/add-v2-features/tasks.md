# 時文寶鑑第二版功能實施任務清單

## 📋 實施策略

**分 3 個會話完成，每個會話專注於不同的功能模組。**

---

## 🏗️ 階段 1：多班級支持與數據隔離 ✅ **已完成**

**目標**：實現多班級管理，確保數據完全隔離  
**任務數**：15 個任務  
**會話**：第一次會話  
**完成時間**：2025-10-23

### 1.1 數據庫架構擴展
- [x] 1.1.1 創建 `classes` 表（班級管理）✅
- [x] 1.1.2 創建 `class_members` 表（班級學生關聯）✅
- [x] 1.1.3 修改 `assignments` 表添加 `class_id` 字段✅
- [x] 1.1.4 修改 `essays` 表添加 `class_id` 字段✅
- [x] 1.1.5 更新 RLS 策略支持班級隔離✅
- [x] 1.1.6 創建班級數據隔離的 RPC 函數✅
- [x] 1.1.7 測試數據隔離功能✅

### 1.2 老師端多班級管理
- [x] 1.2.1 擴展班級管理界面（創建、編輯、刪除班級）✅
- [x] 1.2.2 實現班級切換功能✅
- [x] 1.2.3 添加班級學生管理（批量添加、移除學生）✅
- [x] 1.2.4 實現班級任務管理（按班級創建任務）✅
- [x] 1.2.5 添加班級統計面板（學生數量、任務數量等）✅

### 1.3 學生端班級歸屬
- [x] 1.3.1 修改學生任務列表（只顯示所屬班級任務）✅
- [x] 1.3.2 實現班級信息顯示✅
- [x] 1.3.3 測試班級數據隔離✅

### 1.4 班級配色系統（新增）
- [x] 1.4.1 設計 6 種班級配色方案✅
- [x] 1.4.2 實現班級配色工具函數✅
- [x] 1.4.3 老師端作業卡片班級配色✅
- [x] 1.4.4 學生端班級標籤配色（不影響狀態 ribbon）✅
- [x] 1.4.5 測試班級配色系統✅

---

## 🎨 階段 2：精細批注系統與界面優化 ⏳ **進行中**

**目標**：實現類似 Google Docs 的段落批注功能，統一學生端和老師端體驗  
**任務數**：32 個任務（原 18 個 + 新增 14 個）  
**會話**：第二次會話  
**完成時間**：2025-10-24（部分完成，統一批注系統進行中）

### 2.1 批注數據庫設計
- [x] 2.1.1 創建 `annotations` 表（批注存儲）✅
- [x] 2.1.2 創建 `annotation_comments` 表（批注評論）✅
- [x] 2.1.3 設計批注與論文的關聯關係 ✅
- [x] 2.1.4 實現批注的 CRUD RPC 函數 ✅
- [x] 2.1.5 測試批注數據庫操作 ✅

### 2.2 批注前端系統
- [x] 2.2.1 實現文本選擇和高亮功能 ✅
- [x] 2.2.2 創建批注彈出框組件 ✅
- [x] 2.2.3 實現批注添加、編輯、刪除功能 ✅
- [x] 2.2.4 添加批注顯示和隱藏功能 ✅
- [x] 2.2.5 實現 Google Docs 風格浮動批注 ✅
- [x] 2.2.6 實現批注高亮和互動功能 ✅

### 2.3 老師批改界面優化
- [x] 2.3.1 重新設計批改界面布局（Google Docs 風格）✅
- [x] 2.3.2 集成批注系統到批改界面 ✅
- [x] 2.3.3 實現右側浮動批注顯示區域 ✅
- [x] 2.3.4 實現批注與原文的對應關係 ✅
- [x] 2.3.5 測試批注系統完整性 ✅

### 2.4 批注定位和視覺增強（新增）
- [x] 2.4.1 實現批注智能定位算法（避免重疊）✅
- [x] 2.4.2 實現批注順序管理（按原文順序排列）✅
- [x] 2.4.3 實現動態連接線（原文與批注的視覺連接）✅
- [x] 2.4.4 實現增強高亮效果（活躍批注的視覺突出）✅
- [x] 2.4.5 實現批注滾動對齊（批注與原文水平對齊）✅
- [x] 2.4.6 優化批注視覺層次（基礎 vs 增強效果）✅

### 2.5 統一批注系統（學生端與老師端一致化）
- [x] 2.5.1 增強 AnnotationManager 支持角色區分（添加權限控制）
  - 在 constructor 中添加 `options` 參數支持角色配置
  - 添加 `userRole` 屬性 ('teacher' | 'student')
  - 添加 `canEdit` 和 `canDelete` 權限判斷方法
  - 修改 `createFloatingAnnotation` 方法，根據角色和批注所有權決定是否顯示編輯/刪除按鈕
  - 修改 `editAnnotation` 和 `deleteAnnotation` 方法，添加權限檢查
- [x] 2.5.2 修改學生端 HTML 佈局（統一容器結構 + 分層顯示模式）
  - 移除側邊欄風格的批注顯示區域 (`#annotations-display-area`)
  - 修改學生端編輯器模板，使用與老師端一致的 Google Docs 佈局
  - 添加 `.grading-content-wrapper` 和 `.main-content-area` 容器結構
  - **新增**：實現右側側邊欄的分層顯示模式（雨村評點 + 老師批注）
    - 雨村評點區域：可收合設計，默認最小化（只顯示標題）
    - 老師批注區域：智能跟隨原文高亮，佔據主要顯示空間
    - 動態高度分配：根據內容有無調整顯示比例
  - **新增**：添加雨村評點的收合/展開功能
    - 默認狀態：雨村評點區域最小化（只顯示標題和圖標）
    - 點擊展開：顯示 AI 反饋內容，可再次點擊收合
    - 收合時：為老師批注留出更多顯示空間
  - **新增**：實現智能空間分配邏輯
    - 無批注時：雨村評點可佔滿右側空間
    - 有批注時：老師批注優先顯示，雨村評點收合
    - 兩者都有時：動態調整高度比例
- [x] 2.5.3 處理容器差異（確保 AnnotationManager 在兩端都能找到正確容器）
  - 修改 `createFloatingAnnotation` 方法中的容器查找邏輯
  - 支持多種容器選擇器（老師端和學生端可能使用不同的容器 ID）
  - 實現智能容器檢測：`.grading-content-wrapper`、`.w-full.lg\\:w-2\\/3`、`#essayViewer`、`.essay-editor-container`、`.main-content-area`、`.essay-content-section`
- [x] 2.5.4 修改學生端初始化邏輯（使用 AnnotationManager）
  - 修改 `initializeStudentAnnotationSystem` 函數
  - 移除 StudentAnnotationViewer 的導入和使用
  - 改為導入和使用 AnnotationManager
  - 傳入 `userRole: 'student'` 配置
  - **已完成**：函數已經正確使用統一的 AnnotationManager
- [x] 2.5.5 統一 CSS 樣式（移除冗餘樣式）
  - 移除舊的側邊欄風格樣式（Line 1-132）
  - 保留對話框樣式（回覆對話框、創建對話框）
  - 保留孤立批注通知樣式
  - 學生端將直接使用 `css/assignment-management.css` 中的 Google Docs 風格樣式
- [ ] 2.5.6 更新批注加載邏輯（統一數據查詢方式）
  - 修改 `loadAnnotations` 方法，使用直接查詢而非 RPC
  - 確保學生端和老師端都能正確加載批注數據
  - 統一查詢格式和錯誤處理
- [x] 2.5.7 刪除冗餘文件（student-annotation-viewer.js）
  - 完全刪除 `js/student/student-annotation-viewer.js` 文件
  - 功能已被 AnnotationManager 統一處理
- [ ] 2.5.8 實現雨村評點收合/展開功能
  - 設計可收合的雨村評點區域（默認最小化狀態）
  - 實現點擊標題展開/收合 AI 反饋內容
  - 添加視覺指示器（箭頭圖標）顯示收合/展開狀態
  - 實現智能收合邏輯（有批注時自動收合雨村評點）
  - 確保收合時不影響批注的智能跟隨顯示
- [ ] 2.5.9 測試驗證（老師端和學生端批注功能）
  - 測試學生端批注顯示（Google Docs 風格）
  - 測試學生端批注權限（只能編輯自己的批注）
  - 測試老師端批注功能（確保不受影響）
  - 測試批注在不同屏幕尺寸下的顯示效果
  - 測試雨村評點收合/展開功能
  - 測試智能空間分配邏輯

### 2.6 學生端批注互動
- [ ] 2.6.1 實現學生批注回覆功能
- [ ] 2.6.2 實現學生創建批注功能
- [ ] 2.6.3 實現即時通知系統（WebSocket 或 Server-Sent Events）
- [ ] 2.6.4 添加通知管理界面
- [ ] 2.6.5 測試雙向批注溝通流程

### 2.7 論文修訂流程（新增）
- [ ] 2.7.1 修改撤回邏輯（移除批改限制，允許在老師批注後撤回）
- [ ] 2.7.2 實現批注錨定增強（文本片段錨定，而非僅位置索引）
- [ ] 2.7.3 實現批注重新定位算法（學生修改文本後重新定位批注）
- [ ] 2.7.4 實現孤立批注處理（學生刪除文本後批注標記為孤立）
- [ ] 2.7.5 實現修訂歷史追蹤（記錄學生撤回和重新提交的歷史）
- [ ] 2.7.6 測試完整修訂流程（學生提交→老師批注→學生撤回→修改→重新提交）


---

## 🧪 階段 3：測試優化與模板擴充 ✅ **待開始**

**目標**：完善 Edge Functions 測試，擴充模板庫，實現雙語支持  
**任務數**：17 個任務  
**會話**：第三次會話

### 3.1 Edge Functions 測試
- [ ] 3.1.1 創建 `ai-feedback-agent` 單元測試
- [ ] 3.1.2 創建 `format-spec-generator` 單元測試
- [ ] 3.1.3 創建 `grading-agent` 單元測試
- [ ] 3.1.4 實現 Edge Functions 集成測試
- [ ] 3.1.5 添加性能測試和負載測試
- [ ] 3.1.6 創建測試報告和文檔

### 3.2 MYP/DP 模板庫擴充
- [ ] 3.2.1 設計 IB 模板庫數據庫結構
- [ ] 3.2.2 創建 MYP 模板（個人項目、跨學科單元、服務學習）
- [ ] 3.2.3 創建 DP 模板（擴展論文、知識論、內部評估）
- [ ] 3.2.4 實現 IB 評分標準對齊
- [ ] 3.2.5 創建雙語版本模板（中英文）
- [ ] 3.2.6 實現模板管理界面（導入、導出、編輯）
- [ ] 3.2.7 測試 IB 模板庫功能

### 3.3 雙語支持系統
- [ ] 3.3.1 設計語言包系統（JSON 格式）
- [ ] 3.3.2 創建英文語言包
- [ ] 3.3.3 實現語言切換組件
- [ ] 3.3.4 更新所有界面文字支持雙語
- [ ] 3.3.5 實現 AI 內容語言檢測
- [ ] 3.3.6 實現 AI 反饋自動語言切換
- [ ] 3.3.7 測試雙語切換和 AI 語言檢測功能

---

## 📊 任務統計

### 總任務數：70 個
- **階段 1**：20 個任務（多班級支持 + 班級配色系統）✅ **已完成**
- **階段 2**：33 個任務（批注系統 + 視覺增強 + 學生端互動 + 論文修訂流程）🔄 **部分完成**（老師端批注系統已完成）
- **階段 3**：17 個任務（測試、MYP/DP 模板、雙語 AI）⏳ **待開始**

### 實際時間
- **階段 1**：✅ **已完成**（實際耗時：約 3 小時）
- **階段 2**：🔄 **部分完成**（老師端批注系統 + 視覺增強：約 4 小時）
- **階段 3**：⏳ **待開始**（預估：2-3 小時）
- **總計**：9-12 小時

### 依賴關係
- ✅ **階段 1 已完成**（數據庫架構基礎）
- ✅ **階段 2 老師端批注系統已完成**（學生端批注互動待完成）
- 階段 3 可以與階段 2 並行（獨立功能）✅ **可開始**

---

## 🎯 成功標準

### 功能完成標準
- [x] 老師可以管理至少 5 個班級，數據完全隔離 ✅ **已完成**
- [x] 批注系統支持段落級精細批注（老師端）✅ **已完成**
- [ ] 批注系統支持學生端互動 ⏳ **待完成**
- [ ] 三個 Edge Functions 測試覆蓋率 > 90% ⏳ **待開始**
- [ ] 模板庫包含至少 20 個不同類型的寫作模板 ⏳ **待開始**
- [ ] 界面支持中英文無縫切換 ⏳ **待開始**

### 性能標準
- [x] 班級切換響應時間 < 200ms ✅ **已完成**
- [x] 批注保存響應時間 < 100ms ✅ **已完成**
- [ ] Edge Functions 測試執行時間 < 30s ⏳ **待開始**
- [ ] 雙語切換響應時間 < 50ms ⏳ **待開始**

### 用戶體驗標準
- [x] 老師可以直觀地管理多個班級 ✅ **已完成**
- [x] 批注功能直觀易用，類似 Google Docs（老師端）✅ **已完成**
- [ ] 學生可以清楚看到老師的批注和建議 ⏳ **待完成**
- [ ] 雙語切換無縫，不影響使用流程 ⏳ **待開始**

---

**任務清單創建時間**：2025-10-22  
**預估完成時間**：2-3 個開發會話  
**當前狀態**：階段 1 已完成，階段 2-3 待開始

## 📈 階段 1 完成總結

### ✅ 已完成功能
1. **多班級數據庫架構**
   - 創建 `classes`、`class_members`、`pending_students` 表
   - 實現完整的 RLS 策略確保數據隔離
   - 支持多老師、多班級、學生跨班級

2. **老師端多班級管理**
   - 班級創建、編輯、刪除功能
   - 班級切換和統計面板
   - 批量添加學生功能
   - 按班級創建和分配任務

3. **學生端班級支持**
   - 顯示所屬班級的任務
   - 班級信息標籤顯示
   - 支持學生加入多個班級

4. **班級配色系統**
   - 6 種班級配色方案（青灰雅士、青苔書院、秋香學堂、豆沙書齋、栗褐文苑、墨色書院）
   - 老師端：作業卡片 ribbon 和班級標籤都使用班級配色
   - 學生端：班級標籤使用班級配色，ribbon 保持狀態配色

### 🎯 關鍵成就
- **數據隔離**：完全實現班級間數據隔離
- **用戶體驗**：直觀的班級管理和切換
- **視覺設計**：班級配色系統提升識別度
- **架構穩定**：不破壞原有 MVP 功能

### 📋 下一步
- **階段 2**：完成學生端批注互動功能
- **階段 3**：測試優化與模板擴充

## 📈 階段 2 完成總結（2025-10-24）

### ✅ 已完成功能（老師端批注系統 + 視覺增強）
1. **批注數據庫架構**
   - 創建 `annotations` 和 `annotation_comments` 表
   - 實現完整的 RLS 策略和 CRUD RPC 函數
   - 支持 Supabase Realtime 即時更新

2. **Google Docs 風格批注界面**
   - 重新設計批改界面布局，將評分區域移到底部
   - 實現右側浮動批注顯示區域
   - 支持文本選擇和高亮功能

3. **批注互動功能**
   - 文本選擇後自動顯示批注按鈕
   - 浮動批注輸入框，支持即時保存
   - 批注與原文的對應關係和高亮顯示
   - 批注編輯、刪除功能

4. **批注定位和視覺增強（新增）**
   - 實現批注智能定位算法，避免重疊
   - 實現批注順序管理，按原文順序排列
   - 實現動態連接線，原文與批注的視覺連接
   - 實現增強高亮效果，活躍批注的視覺突出
   - 實現批注滾動對齊，批注與原文水平對齊
   - 優化批注視覺層次，基礎 vs 增強效果

5. **視覺和用戶體驗**
   - 仿照 Google Docs 的批注樣式
   - 批注在右側區域垂直浮動顯示
   - 點擊高亮文本時對應批注會高亮
   - 平滑滾動和視覺反饋
   - 動態連接線和脈衝動畫效果

### 🎯 關鍵成就
- **Google Docs 風格**：完全仿照 Google Docs 的批注體驗
- **即時互動**：支持即時批注創建、編輯、刪除
- **視覺對應**：批注與原文的完美對應關係
- **智能定位**：批注自動避免重疊，按原文順序排列
- **視覺增強**：動態連接線、增強高亮、脈衝動畫
- **用戶友好**：直觀的文本選擇和批注流程

### 🔄 待完成功能
- **學生端批注顯示**：學生查看老師批注
- **學生批注回覆**：學生回覆老師批注
- **即時通知系統**：批注更新通知
- **論文修訂流程**：學生撤回和重新提交的批注處理

### 📋 下一步
- **完成學生端批注互動**：實現雙向批注溝通
- **階段 3**：測試優化與模板擴充
