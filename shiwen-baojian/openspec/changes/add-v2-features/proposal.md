# 時文寶鑑第二版功能提案

## Why

### 當前限制
時文寶鑑 MVP 版本存在以下限制：

1. **單班級限制**：老師只能管理一個班級，無法支持多班級教學
2. **批改界面簡陋**：只能評分和寫總評，缺乏精細的段落批注功能
3. **功能測試不足**：三個 Edge Functions 缺乏完整的測試覆蓋
4. **模板庫有限**：只有基本的寫作格式模板，缺乏多樣性
5. **語言單一**：只支持繁體中文，無法服務國際化需求

### 解決方案
通過第二版功能開發，實現：
- **多班級數據隔離**：支持老師管理多個班級，數據完全隔離
- **精細批注系統**：類似 Google Docs 的段落批注功能
- **完整測試覆蓋**：確保三個 Edge Functions 的穩定性和可靠性
- **豐富模板庫**：擴充寫作指引模板，支持更多學科和格式
- **雙語支持**：中英文界面切換，提升國際化能力

### 目標用戶
- **老師**：需要管理多個班級，需要精細的批改工具
- **學生**：需要更豐富的寫作指導模板
- **國際化用戶**：需要英文界面支持

## What Changes

### 1. 多班級支持系統
- **班級數據隔離**：每個班級的學生、任務、論文完全隔離
- **老師班級管理**：創建、編輯、刪除班級
- **班級切換界面**：老師可以在不同班級間切換
- **學生班級歸屬**：學生只能看到所屬班級的任務

### 2. 精細批注系統
- **段落高亮**：老師可以高亮學生論文的任意部分
- **批注添加**：在選中文本上添加評論和建議
- **批注管理**：查看、編輯、刪除批注
- **批注顯示**：學生可以看到老師的批注和建議
- **批注歷史**：追蹤批注的修改歷史

### 3. Edge Functions 測試優化
- **ai-feedback-agent 測試**：完整的 AI 反饋功能測試
- **format-spec-generator 測試**：格式規範生成測試
- **grading-agent 測試**：評分代理功能測試
- **集成測試**：端到端功能測試
- **性能測試**：響應時間和並發測試

### 4. MYP/DP 模板庫擴充
- **MYP 學科模板**：個人項目、跨學科單元、服務學習報告
- **DP 學科模板**：擴展論文、知識論論文、內部評估
- **IB 標準對齊**：符合 IB 評分標準的模板設計
- **雙語模板**：中英文版本的學科模板
- **模板管理**：導入、導出、編輯 IB 標準模板

### 5. 雙語支持系統
- **界面切換**：中英文界面語言切換
- **內容本地化**：所有用戶可見文字支持雙語
- **模板本地化**：寫作模板支持中英文版本
- **AI 反饋本地化**：AI 反饋根據內容語言自動切換輸出語言
- **英文寫作支持**：英文內容的 AI 反饋、指引、範例全部使用英文

## Impact

### Affected Specs
需要修改以下現有規格：

1. **teacher-class-management** - 擴展為多班級管理
2. **teacher-grading** - 添加精細批注功能
3. **database-schema** - 添加班級隔離和批注表
4. **ui-design-system** - 添加雙語支持

需要新增以下規格：

5. **multi-class-support** - 多班級支持系統
6. **fine-grained-annotation** - 精細批注系統
7. **edge-functions-testing** - Edge Functions 測試系統
8. **template-library-expansion** - 模板庫擴充
9. **bilingual-support** - 雙語支持系統

### Affected Code
主要影響的文件和系統：

#### 前端文件
- `js/teacher/class-manager.js` - 擴展多班級管理
- `js/teacher/grading.js` - 添加批注功能
- `js/ui/language-switcher.js` - 新增雙語切換
- `js/features/annotation-system.js` - 新增批注系統
- `css/components.css` - 添加批注和雙語樣式

#### 後端文件
- `supabase/functions/` - 三個 Edge Functions 的測試
- `supabase/migrations/` - 新增班級隔離和批注表
- `assets/data/templates/` - 擴充模板庫

#### 數據庫變更
- 新增 `classes` 表（班級管理）
- 新增 `annotations` 表（批注系統）
- 新增 `template_library` 表（模板庫）
- 修改現有表的 RLS 策略支持班級隔離

### Integration with 太虛幻境
- 保持現有的應用切換器集成
- 雙語支持不影響平台級導航
- 多班級功能在獨立模式下完全可用

### Technical Stack
- **前端**：HTML5, CSS3, Vanilla JavaScript（保持現有技術棧）
- **後端**：Supabase（PostgreSQL + Edge Functions）
- **測試**：Deno 內建測試框架
- **國際化**：簡單的 JSON 語言包系統
- **部署**：GitHub Pages + Cloudflare Pages

## Success Criteria

### 功能目標
- 老師可以管理至少 5 個班級，數據完全隔離
- 批注系統支持段落級精細批注，類似 Google Docs
- 三個 Edge Functions 測試覆蓋率 > 90%
- 模板庫包含至少 20 個不同類型的寫作模板
- 界面支持中英文無縫切換

### 技術目標
- 班級切換響應時間 < 200ms
- 批注保存響應時間 < 100ms
- Edge Functions 測試執行時間 < 30s
- 雙語切換響應時間 < 50ms
- 支持至少 200 個並發用戶

### 用戶體驗目標
- 老師可以直觀地管理多個班級
- 批注功能直觀易用，類似熟悉的文檔編輯器
- 學生可以清楚看到老師的批注和建議
- 雙語切換無縫，不影響使用流程

---

## 📈 當前進度更新（2025-10-23）

### ✅ 階段 1 已完成
- **多班級支持系統**：完全實現
  - 數據庫架構：`classes`、`class_members`、`pending_students` 表
  - RLS 策略：完整的班級數據隔離
  - 老師端：班級管理、切換、學生管理、任務分配
  - 學生端：班級任務顯示、班級信息標籤
- **班級配色系統**：完全實現
  - 6 種班級配色方案
  - 老師端：作業卡片 ribbon 和班級標籤配色
  - 學生端：班級標籤配色（不影響狀態 ribbon）

### ⏳ 階段 2 待開始
- **精細批注系統**：待實現
- **即時通知系統**：待實現

### ⏳ 階段 3 待開始
- **Edge Functions 測試**：待實現
- **MYP/DP 模板庫**：待實現
- **雙語支持系統**：待實現

---

**提案創建時間**：2025-10-22  
**提案狀態**：階段 1 已完成，階段 2-3 進行中  
**實際工作量**：58 個任務（原預估 40-50 個）  
**實際完成時間**：階段 1 約 3 小時，階段 2-3 待開始
