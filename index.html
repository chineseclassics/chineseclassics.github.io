<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>太虛幻境：書院中文經典數字體驗學習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            },
            darkMode: 'class'
        }

        // 檢測暗黑模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .app-icon {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .app-icon:hover {
            transform: scale(1.05);
        }
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .app-container {
            height: calc(100vh - 64px);
        }
        
        @media (max-width: 768px) {
            .app-container {
                height: calc(100vh - 64px);
            }
        }
        

        
        /* 应用详情提示框 */
        .app-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 320px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .app-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .app-tooltip.dark {
            background: #1f2937;
            border-color: #374151;
            color: #f9fafb;
        }
        
        .app-tooltip-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111827;
        }
        
        .app-tooltip.dark .app-tooltip-title {
            color: #f9fafb;
        }
        
        .app-tooltip-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }
        
        .app-tooltip.dark .app-tooltip-subtitle {
            color: #9ca3af;
        }
        
        .app-tooltip-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .app-tooltip-features li {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }
        
        .app-tooltip.dark .app-tooltip-features li {
            color: #d1d5db;
        }
        
        .app-tooltip-features li::before {
            content: "•";
            color: #5D5CDE;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        
        .app-tooltip-quote {
            font-style: italic;
            color: #6b7280;
            font-size: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }
        
        .app-tooltip.dark .app-tooltip-quote {
            color: #9ca3af;
            border-top-color: #374151;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .app-tooltip {
                width: 280px;
                font-size: 14px;
            }
        }
        
        /* 应用切换器样式优化 */
        .switcher-content {
            max-height: calc(85vh - 100px);
            overflow-y: auto;
            /* 隐藏滚动条但保持滚动功能 */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .switcher-content::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        
        /* 应用切换器图标优化 */
        .switcher-app-icon {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }
        
        .switcher-app-icon:hover {
            transform: translateY(-2px) scale(1.05);
        }
        
        .switcher-app-icon:active {
            transform: translateY(0) scale(0.98);
        }
        
        .switcher-app-icon .icon-container {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .switcher-app-icon:hover .icon-container {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .switcher-app-icon .icon-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .switcher-app-icon:hover .icon-container::before {
            left: 100%;
        }
        
        /* 应用名称样式优化 */
        .switcher-app-name {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            height: 2.4em;
            font-size: 11px;
            font-weight: 500;
            color: #374151;
            transition: color 0.2s ease;
        }
        
        .dark .switcher-app-name {
            color: #d1d5db;
        }
        
        .switcher-app-icon:hover .switcher-app-name {
            color: #5D5CDE;
        }
        
        .dark .switcher-app-icon:hover .switcher-app-name {
            color: #818cf8;
        }
        
        /* 应用切换器动画显示 */
        .switcher-modal-show {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        .switcher-modal-show #switcherContainer {
            transform: scale(1) !important;
        }
        
        /* 响应式网格调整 */
        @media (max-width: 640px) {
            #switcherAppGrid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                padding: 1.5rem 1.5rem 1.5rem 1.5rem !important;
            }
        }
        
        @media (min-width: 641px) and (max-width: 768px) {
            #switcherAppGrid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            #switcherAppGrid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        @media (min-width: 1025px) {
            #switcherAppGrid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button id="homeBtn" class="flex items-center space-x-2 px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                    <i class="fas fa-home"></i>
                    <span class="hidden sm:inline">首頁</span>
                </button>
                <div class="hidden sm:block text-gray-400 dark:text-gray-600">|</div>
                <h1 id="currentAppName" class="text-lg font-semibold text-gray-800 dark:text-gray-200">太虛幻境：書院中文經典數字體驗學習</h1>
            </div>
            
            <div class="flex items-center space-x-2">
                <button id="appSwitcherBtn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                    <i class="fas fa-th"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="pt-16 pb-4">
        <!-- 首页视图 -->
        <div id="homeView">
            <div class="py-8 px-4 mb-10 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/10 via-primary/20 to-indigo-900/10 dark:from-indigo-900/30 dark:via-primary/40 dark:to-indigo-900/30"></div>
                
                <div class="absolute top-0 left-0 w-16 h-16 md:w-24 md:h-24 border-l-2 border-t-2 border-primary opacity-30 dark:opacity-40"></div>
                <div class="absolute bottom-0 right-0 w-16 h-16 md:w-24 md:h-24 border-r-2 border-b-2 border-primary opacity-30 dark:opacity-40"></div>
                
                <div class="container mx-auto relative z-10">
                    <h1 class="text-3xl md:text-5xl font-bold text-center">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-700 via-primary to-indigo-700 dark:from-indigo-400 dark:via-primary dark:to-indigo-400">太虛幻境</span>
                    </h1>
                    <h2 class="text-xl md:text-2xl font-medium text-gray-700 dark:text-gray-300 text-center mt-2">書院中文經典數字體驗學習</h2>
                    
                    <div class="w-24 h-1 bg-gradient-to-r from-transparent via-primary to-transparent mx-auto mt-4"></div>
                </div>
            </div>

            <div class="container mx-auto px-4 pb-12">
                <section class="mb-12">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700 dark:text-gray-300">互動小程序</h2>
                    
                    <div id="appGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 md:gap-6">
                        <!-- 应用图标将通过JavaScript动态生成 -->
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-300">關於本站</h2>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                        <p class="mb-3">本網站所有程序由書院中文經典老師開發，歡迎訪問<a href="https://sites.google.com/lms.isf.edu.hk/isf-shuyuan-website/classics/chinese-classics" class="text-primary hover:underline" target="_blank">書院中文經典網站</a>，以及<a href="https://sites.google.com/isf.edu.hk/chineseclassics" class="text-primary hover:underline" target="_blank">中文經典專題學習網站</a>。</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- 应用视图 -->
        <div id="appView" class="hidden">
            <div id="appContainer" class="app-container w-full relative">
                <iframe id="appFrame" class="w-full h-full border-0" src="about:blank"></iframe>
                
                <!-- 加载状态 -->
                <div id="loadingState" class="absolute inset-0 bg-white dark:bg-gray-900 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-600 dark:text-gray-400">正在加載應用...</p>
                    </div>
                </div>
                
                <!-- 错误状态 -->
                <div id="errorState" class="hidden absolute inset-0 bg-white dark:bg-gray-900 flex items-center justify-center">
                    <div class="text-center max-w-md mx-auto p-6">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">無法載入應用</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">該應用可能不支援嵌入模式</p>
                        <button id="openInNewTabBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                            在新標籤頁打開
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <!-- 应用切换器弹窗 -->
    <div id="appSwitcherModal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 pt-20 opacity-0 pointer-events-none transition-all duration-300 ease-out">
        <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm transition-opacity duration-300"></div>
        <div id="switcherContainer" class="relative bg-white dark:bg-gray-800 rounded-2xl max-w-4xl w-full max-h-[70vh] shadow-2xl transform scale-95 transition-all duration-300 ease-out">
            <!-- 简化的顶部区域，只有关闭按钮 -->
            <div class="flex justify-end items-center p-4">
                <button id="closeSwitcherBtn" class="w-10 h-10 rounded-full bg-black bg-opacity-20 hover:bg-opacity-30 text-white hover:text-gray-200 transition-all duration-200 flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- 应用网格区域 -->
            <div class="switcher-content">
                <div id="switcherAppGrid" class="px-6 pb-6 pt-0 grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4">
                    <!-- 应用图标将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 应用数据
        const apps = [
            {
                id: 'changganxinglv',
                name: '長干行旅',
                icon: 'fas fa-ship',
                gradient: 'from-indigo-500 to-violet-500',
                url: 'https://chineseclassics.github.io/changganxinglv.html',
                description: '體驗李白《長干行》中商人與少婦的愛情故事，在角色扮演中感受古典詩歌的浪漫與深情'
            },
            {
                id: 'diandianmobao',
                name: '點點墨寶：漢字學習',
                icon: 'fas fa-paint-brush',
                gradient: 'from-red-500 to-orange-500',
                url: 'https://chineseclassics.github.io/diandianmobao.html',
                description: '通過筆順練習、記憶挑戰和部首組字等多元化遊戲，系統性學習漢字書寫與結構'
            },
            {
                id: 'changhenge',
                name: '《長恨歌》記憶卡牌',
                icon: 'fas fa-memory',
                gradient: 'from-yellow-500 to-amber-500',
                url: 'https://chineseclassics.github.io/changhengejiyi.html',
                description: '翻開卡牌配對白居易《長恨歌》的詩句與釋義，在記憶遊戲中探索唐明皇與楊貴妃的愛情悲歌'
            },
            {
                id: 'leiyu',
                name: '《雷雨》閃電',
                icon: 'fas fa-cloud-rain',
                gradient: 'from-blue-500 to-cyan-500',
                url: 'https://chineseclassics.github.io/leiyushandian.html',
                description: '扮演曹禺《雷雨》中的經典角色躲避命運閃電，在街機遊戲中體驗家庭悲劇的文學深度'
            },
            {
                id: 'shicizuju',
                name: '詩詞組句遊戲',
                icon: 'fas fa-puzzle-piece',
                gradient: 'from-green-500 to-emerald-500',
                url: 'https://chineseclassics.github.io/shicizuju.html'
            },
            {
                id: 'cikeyishou',
                name: '刺客之道 1.0',
                icon: 'fas fa-user-ninja',
                gradient: 'from-purple-500 to-pink-500',
                url: 'https://chineseclassics.github.io/cikezhidao.html',
                description: '扮演《史記·刺客列傳》中的五位古代刺客，在生死抉擇中體驗千秋義勇與歷史風雲'
            },
            {
                id: 'shiguangpintu',
                name: '《長干行》時光拼圖',
                icon: 'fas fa-hourglass-half',
                gradient: 'from-gray-600 to-gray-800',
                url: 'https://chineseclassics.github.io/changganxingshiguang.html',
                description: '拖動李白《長干行》的詩句卡片，按時間順序重新排列，體驗詩中女子從童年到成年的情感時光'
            },
            {
                id: 'nanfengtianci',
                name: '南風填詞',
                icon: 'fas fa-pencil-alt',
                gradient: 'from-teal-500 to-green-400',
                url: 'https://chineseclassics.github.io/nanfengtianci.html',
                description: '體驗古典填詞藝術，在平仄韻律中創作屬於你的詞章，還有背誦挑戰等你來闖關'
            },
            {
                id: 'nanfengzuoshi',
                name: '南風作詩',
                icon: 'fas fa-feather-alt',
                gradient: 'from-indigo-400 to-blue-500',
                url: 'https://chineseclassics.github.io/nanfengzuoshi.html',
                description: '基於欽定詞譜的古典填詞工具，用傳統格律創作你的詞章，還能生成精美的古風壁紙'
            },
            {
                id: 'yinzhangsheji',
                name: '印章設計',
                icon: 'fas fa-stamp',
                gradient: 'from-red-600 to-rose-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E5%8D%B0%E7%AB%A0%E8%A8%AD%E8%A8%88'
            },
            {
                id: 'mishijiangchun',
                name: '迷失江南春',
                icon: 'fas fa-tree',
                gradient: 'from-emerald-500 to-lime-400',
                url: 'https://chineseclassics.github.io/mishijiangnanchun.html',
                description: '穿越蘇杭文化之旅，與古代人物對話收集線索，找出隱藏在不同場景中的時空迷失者'
            },
            {
                id: 'jiangluohua',
                name: '江南落花',
                icon: 'fas fa-spa',
                gradient: 'from-pink-400 to-rose-300',
                url: 'https://chineseclassics.github.io/jiangnanluohua.html',
                description: '駕駛小船躲避紛飛花朵，收集特殊道具並挑戰知識問答，在街機遊戲中探索江南文化之美'
            },
            {
                id: 'wanwuxiaoyao',
                name: '萬物逍遙',
                icon: 'fas fa-leaf',
                gradient: 'from-amber-400 to-yellow-300',
                url: 'https://chineseclassics.github.io/wanwuxiaoyao.html',
                description: '深度體驗莊子哲學的物化之道，從莊周夢蝶到渾沌復生，在七個哲學章節中領悟逍遙境界'
            },
            {
                id: 'yimoji',
                name: '意moji：詩詞意象配對',
                icon: 'fas fa-icons',
                gradient: 'from-violet-500 to-purple-400',
                url: 'https://chineseclassics.github.io/yimoji.html',
                description: '尋找三個與詩詞意象最相關的emoji進行配對'
            },
            {
                id: 'chengyutianci',
                name: '成語填字',
                icon: 'fas fa-font',
                gradient: 'from-cyan-500 to-blue-400',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E6%88%90%E8%AA%9E%E5%A1%AB%E5%AD%97'
            },
            {
                id: 'yuexiaduzuo',
                name: '月下獨酌',
                icon: 'fas fa-moon',
                gradient: 'from-slate-600 to-indigo-400',
                url: 'https://chineseclassics.github.io/yuexiaduzhuo.html',
                description: '加入「月下雅集」群聊，與李白、杜甫、嫦娥等古代詩人在微信群中暢談詩酒風流'
            },
            {
                id: 'langzhuliangrensha',
                name: '狼渚良人殺',
                icon: 'fas fa-paw',
                gradient: 'from-stone-600 to-stone-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E7%8B%BC%E6%B8%9A%E8%89%AF%E4%BA%BA%E6%AE%BA'
            }
        ];

        // 状态管理
        let currentApp = null;
        let currentView = 'home';

        // DOM 元素
        const homeView = document.getElementById('homeView');
        const appView = document.getElementById('appView');
        const appFrame = document.getElementById('appFrame');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const currentAppName = document.getElementById('currentAppName');
        const appGrid = document.getElementById('appGrid');
        const switcherAppGrid = document.getElementById('switcherAppGrid');
        const appSwitcherModal = document.getElementById('appSwitcherModal');

        // Tooltip相关变量
        let currentTooltip = null;
        let tooltipTimeout = null;

        // 创建tooltip
        function createTooltip(app, targetElement) {
            if (!app.description) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'app-tooltip';
            if (document.documentElement.classList.contains('dark')) {
                tooltip.classList.add('dark');
            }

            // 判断是简洁介绍还是详细介绍
            if (typeof app.description === 'string') {
                // 简洁的一句话介绍（不显示重复的app名称）
                tooltip.innerHTML = `
                    <div class="app-tooltip-subtitle" style="color: #5D5CDE; font-style: normal; font-weight: 500; margin-bottom: 0;">${app.description}</div>
                `;
            } else {
                // 详细介绍（保持原格式，但也移除重复名称）
                tooltip.innerHTML = `
                    <div class="app-tooltip-subtitle">${app.description.subtitle}</div>
                    <ul class="app-tooltip-features">
                        ${app.description.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                    <div class="app-tooltip-quote">${app.description.quote}</div>
                `;
            }

            document.body.appendChild(tooltip);

            // 计算位置
            const rect = targetElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width - tooltipRect.width) / 2;
            let top = rect.bottom + 10;

            // 确保不超出屏幕边界
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top + tooltipRect.height > window.innerHeight - 10) {
                top = rect.top - tooltipRect.height - 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';

            // 显示tooltip
            setTimeout(() => tooltip.classList.add('show'), 10);

            return tooltip;
        }

        // 隐藏tooltip
        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.classList.remove('show');
                setTimeout(() => {
                    if (currentTooltip && currentTooltip.parentNode) {
                        currentTooltip.parentNode.removeChild(currentTooltip);
                    }
                    currentTooltip = null;
                }, 300);
            }
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
        }

        // 显示tooltip
        function showTooltip(app, targetElement) {
            hideTooltip();
            if (app.description) {
                tooltipTimeout = setTimeout(() => {
                    currentTooltip = createTooltip(app, targetElement);
                }, 500); // 0.5秒延迟
            }
        }

        // 渲染应用图标
        function renderAppIcon(app, isCompact = false) {
            const size = isCompact ? 'w-12 h-12' : 'aspect-square';
            const iconSize = isCompact ? 'text-xl' : 'text-4xl';
            const textSize = isCompact ? 'text-xs' : 'font-medium';
            
            return `
                <div class="app-icon block w-full text-left no-underline text-gray-800 dark:text-gray-200 relative" 
                     data-app-id="${app.id}" 
                     onclick="openApp('${app.id}')"
                     onmouseenter="handleMouseEnter(event, '${app.id}')"
                     onmouseleave="handleMouseLeave()"
                     ontouchstart="handleTouchStart(event, '${app.id}')"
                     ontouchend="handleTouchEnd(event, '${app.id}')"
                     ontouchmove="handleTouchMove()">
                    <div class="bg-gradient-to-br ${app.gradient} rounded-2xl p-4 ${size} flex items-center justify-center shadow-lg">
                        <i class="${app.icon} text-white ${iconSize}"></i>
                    </div>
                    <p class="text-center mt-2 ${textSize}">${app.name}</p>
                </div>
            `;
        }

        // 鼠标进入事件
        function handleMouseEnter(event, appId) {
            if (isMobile()) return; // 移动端不使用鼠标悬停
            
            const app = apps.find(a => a.id === appId);
            if (app && app.description) {
                showTooltip(app, event.currentTarget);
            }
        }

        // 鼠标离开事件
        function handleMouseLeave() {
            if (!isMobile()) {
                hideTooltip();
            }
        }

        // 移动端长按相关变量
        let longPressTimer = null;
        let isLongPress = false;
        let touchStartTime = 0;

        // 触摸开始事件（移动端）
        function handleTouchStart(event, appId) {
            if (!isMobile()) return;
            
            const app = apps.find(a => a.id === appId);
            if (!app || !app.description) return;
            
            touchStartTime = Date.now();
            isLongPress = false;
            
            // 设置长按定时器（500ms）
            longPressTimer = setTimeout(() => {
                // 这是长按，显示tooltip
                isLongPress = true;
                showTooltip(app, event.currentTarget);
                
                // 触觉反馈
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }, 500);
        }

        // 触摸结束事件
        function handleTouchEnd(event, appId) {
            if (!isMobile()) return;
            
            // 清除长按定时器
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            const touchDuration = Date.now() - touchStartTime;
            
            // 如果是长按，不执行打开应用的操作
            if (isLongPress) {
                isLongPress = false;
                return;
            }
            
            // 如果是短按且当前没有显示tooltip，正常打开应用
            if (touchDuration < 500 && !currentTooltip) {
                // 这里不阻止事件，让onclick正常执行
                return;
            }
            
            // 如果当前有tooltip显示，第一次点击隐藏tooltip
            if (currentTooltip) {
                hideTooltip();
                event.preventDefault();
                return;
            }
        }

        // 触摸移动事件（取消长按）
        function handleTouchMove() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // 点击其他地方隐藏tooltip
        document.addEventListener('click', (event) => {
            if (currentTooltip && !event.target.closest('.app-icon') && !event.target.closest('.app-tooltip')) {
                hideTooltip();
            }
        });

        // 全局函数供HTML调用
        window.handleMouseEnter = handleMouseEnter;
        window.handleMouseLeave = handleMouseLeave;
        window.handleTouchStart = handleTouchStart;
        window.handleTouchEnd = handleTouchEnd;

        // 渲染切换器应用图标（优化版）
        function renderSwitcherAppIcon(app) {
            return `
                <div class="switcher-app-icon text-center" 
                     data-app-id="${app.id}" 
                     onclick="openApp('${app.id}')">
                    <div class="icon-container bg-gradient-to-br ${app.gradient} rounded-xl p-3 w-14 h-14 flex items-center justify-center shadow-lg mx-auto mb-2">
                        <i class="${app.icon} text-white text-lg"></i>
                    </div>
                    <p class="switcher-app-name text-center">${app.name}</p>
                </div>
            `;
        }

        // 渲染应用网格
        function renderApps() {
            appGrid.innerHTML = apps.map(app => renderAppIcon(app)).join('');
            switcherAppGrid.innerHTML = apps.map(app => renderSwitcherAppIcon(app)).join('');
        }

        // 打开应用
        function openApp(appId) {
            const app = apps.find(a => a.id === appId);
            if (!app) return;

            currentApp = app;
            currentView = 'app';
            currentAppName.textContent = app.name;

            // 切换视图
            homeView.classList.add('hidden');
            appView.classList.remove('hidden');

            // 显示加载状态
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');

            // 加载iframe
            appFrame.src = app.url;

            // 设置iframe错误处理
            const timeoutId = setTimeout(() => {
                showError();
            }, 10000); // 10秒超时

            appFrame.onload = () => {
                clearTimeout(timeoutId);
                setTimeout(() => {
                    loadingState.classList.add('hidden');
                }, 1000);
            };

            appFrame.onerror = () => {
                clearTimeout(timeoutId);
                showError();
            };

            // 关闭应用切换器
            hideAppSwitcher();
        }

        // 显示错误状态
        function showError() {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            
            document.getElementById('openInNewTabBtn').onclick = () => {
                window.open(currentApp.url, '_blank');
            };
        }

        // 回到首页
        function showHome() {
            currentView = 'home';
            currentAppName.textContent = '太虛幻境';
            homeView.classList.remove('hidden');
            appView.classList.add('hidden');
            appFrame.src = 'about:blank';
            currentApp = null;
        }

        // 事件监听
        document.getElementById('homeBtn').onclick = showHome;
        
        // 显示应用切换器（带动画）
        function showAppSwitcher() {
            appSwitcherModal.classList.add('switcher-modal-show');
            // 防止背景滚动
            document.body.style.overflow = 'hidden';
        }

        // 隐藏应用切换器（带动画）
        function hideAppSwitcher() {
            appSwitcherModal.classList.remove('switcher-modal-show');
            // 恢复背景滚动
            document.body.style.overflow = '';
        }

        document.getElementById('appSwitcherBtn').onclick = showAppSwitcher;
        
        document.getElementById('closeSwitcherBtn').onclick = hideAppSwitcher;

        // 点击模态框背景关闭
        appSwitcherModal.onclick = (e) => {
            if (e.target === appSwitcherModal) {
                hideAppSwitcher();
            }
        };

        // ESC键关闭切换器
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && appSwitcherModal.classList.contains('switcher-modal-show')) {
                hideAppSwitcher();
            }
        });

        // 检查是否是移动设备
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // 初始化
        renderApps();
    </script>
</body>
</html>
