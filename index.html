<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>太虛幻境：書院中文經典數字體驗學習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            },
            darkMode: 'class'
        }

        // 檢測暗黑模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        .app-icon {
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .app-icon:hover {
            transform: scale(1.05);
        }
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .app-container {
            height: calc(100vh - 64px);
        }
        
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
            }
            
            /* 隐藏移动端的导航栏 */
            .mobile-nav-hide {
                display: none !important;
            }
        }
        
        /* Home指示器样式 */
        .home-indicator {
            position: fixed;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 134px;
            height: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .home-indicator.light {
            background: rgba(255, 255, 255, 0.6);
        }
        
        .home-indicator.active {
            background: #5D5CDE;
            transform: translateX(-50%) scale(1.2);
        }
        
        /* 滑动区域 */
        .swipe-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            z-index: 99;
            background: transparent;
        }
        
        /* 首次使用提示 */
        .tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .swipe-animation {
            width: 60px;
            height: 60px;
            border: 2px solid white;
            border-radius: 50%;
            position: relative;
            margin-bottom: 20px;
            animation: swipeUp 2s infinite;
        }
        
        .swipe-animation::after {
            content: "↑";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
        }
        
        @keyframes swipeUp {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* 浮动返回按钮 */
        .floating-home-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 98;
            transition: all 0.3s ease;
            transform: scale(0);
        }
        
        .floating-home-btn.show {
            transform: scale(1);
        }
        
        .floating-home-btn:active {
            transform: scale(0.9);
        }
        
        /* 应用详情提示框 */
        .app-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 320px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .app-tooltip.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .app-tooltip.dark {
            background: #1f2937;
            border-color: #374151;
            color: #f9fafb;
        }
        
        .app-tooltip-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111827;
        }
        
        .app-tooltip.dark .app-tooltip-title {
            color: #f9fafb;
        }
        
        .app-tooltip-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }
        
        .app-tooltip.dark .app-tooltip-subtitle {
            color: #9ca3af;
        }
        
        .app-tooltip-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .app-tooltip-features li {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }
        
        .app-tooltip.dark .app-tooltip-features li {
            color: #d1d5db;
        }
        
        .app-tooltip-features li::before {
            content: "•";
            color: #5D5CDE;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        
        .app-tooltip-quote {
            font-style: italic;
            color: #6b7280;
            font-size: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }
        
        .app-tooltip.dark .app-tooltip-quote {
            color: #9ca3af;
            border-top-color: #374151;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .app-tooltip {
                width: 280px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button id="homeBtn" class="flex items-center space-x-2 px-3 py-2 text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                    <i class="fas fa-home"></i>
                    <span class="hidden sm:inline">首頁</span>
                </button>
                <div class="hidden sm:block text-gray-400 dark:text-gray-600">|</div>
                <h1 id="currentAppName" class="text-lg font-semibold text-gray-800 dark:text-gray-200">太虛幻境</h1>
            </div>
            
            <div class="flex items-center space-x-2">
                <button id="appSwitcherBtn" class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary transition-colors">
                    <i class="fas fa-th"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="pt-16 pb-20 md:pb-4">
        <!-- 首页视图 -->
        <div id="homeView">
            <div class="py-8 px-4 mb-10 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-indigo-900/10 via-primary/20 to-indigo-900/10 dark:from-indigo-900/30 dark:via-primary/40 dark:to-indigo-900/30"></div>
                
                <div class="absolute top-0 left-0 w-16 h-16 md:w-24 md:h-24 border-l-2 border-t-2 border-primary opacity-30 dark:opacity-40"></div>
                <div class="absolute bottom-0 right-0 w-16 h-16 md:w-24 md:h-24 border-r-2 border-b-2 border-primary opacity-30 dark:opacity-40"></div>
                
                <div class="container mx-auto relative z-10">
                    <h1 class="text-3xl md:text-5xl font-bold text-center">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-700 via-primary to-indigo-700 dark:from-indigo-400 dark:via-primary dark:to-indigo-400">太虛幻境</span>
                    </h1>
                    <h2 class="text-xl md:text-2xl font-medium text-gray-700 dark:text-gray-300 text-center mt-2">書院中文經典數字體驗學習</h2>
                    
                    <div class="w-24 h-1 bg-gradient-to-r from-transparent via-primary to-transparent mx-auto mt-4"></div>
                </div>
            </div>

            <div class="container mx-auto px-4 pb-12">
                <section class="mb-12">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700 dark:text-gray-300">互動小程序</h2>
                    
                    <div id="appGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 md:gap-6">
                        <!-- 应用图标将通过JavaScript动态生成 -->
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl font-bold mb-4 text-gray-700 dark:text-gray-300">關於本站</h2>
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                        <p class="mb-3">本網站所有程序由書院中文經典老師開發，歡迎訪問<a href="https://sites.google.com/lms.isf.edu.hk/isf-shuyuan-website/classics/chinese-classics" class="text-primary hover:underline" target="_blank">書院中文經典網站</a>，以及<a href="https://sites.google.com/isf.edu.hk/chineseclassics" class="text-primary hover:underline" target="_blank">中文經典專題學習網站</a>。</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- 应用视图 -->
        <div id="appView" class="hidden">
            <div id="appContainer" class="app-container w-full relative">
                <iframe id="appFrame" class="w-full h-full border-0" src="about:blank"></iframe>
                
                <!-- 加载状态 -->
                <div id="loadingState" class="absolute inset-0 bg-white dark:bg-gray-900 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-600 dark:text-gray-400">正在加載應用...</p>
                    </div>
                </div>
                
                <!-- 错误状态 -->
                <div id="errorState" class="hidden absolute inset-0 bg-white dark:bg-gray-900 flex items-center justify-center">
                    <div class="text-center max-w-md mx-auto p-6">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">無法載入應用</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">該應用可能不支援嵌入模式</p>
                        <button id="openInNewTabBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                            在新標籤頁打開
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部导航栏（仅移动端显示） -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-2">
        <div id="bottomNav" class="flex justify-around items-center">
            <button class="quick-app-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-300" onclick="showHome()">
                <i class="fas fa-home text-lg mb-1"></i>
                <span class="text-xs">首頁</span>
            </button>
        </div>
    </nav>

    <!-- 应用切换器弹窗 -->
    <div id="appSwitcherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">選擇應用</h3>
                    <button id="closeSwitcherBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="switcherAppGrid" class="p-4 grid grid-cols-3 sm:grid-cols-4 gap-4">
                <!-- 应用图标将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 应用数据
        const apps = [
            {
                id: 'changganxinglv',
                name: '長干行旅',
                icon: 'fas fa-ship',
                gradient: 'from-indigo-500 to-violet-500',
                url: 'https://chineseclassics.github.io/changganxinglv.html',
                description: {
                    title: '長干行旅 - 李白詩歌互動游戲',
                    subtitle: '基於李白《長干行》的互動角色扮演游戲',
                    features: [
                        '雙視角角色扮演：長干少婦或三巴商人',
                        '管理家庭資源與撰寫詩信傳情',
                        '駕駛商船躲避險灘與風浪',
                        '情感羈絆系統：疏離→思念→深愛',
                        '收集《長干行》15句經典詩句',
                        '體驗四季變化與唐代生活'
                    ],
                    quote: '妾髮初覆額，折花門前劇。郎騎竹馬來，繞床弄青梅。'
                }
            },
            {
                id: 'diandianmobao',
                name: '點點墨寶：漢字學習',
                icon: 'fas fa-paint-brush',
                gradient: 'from-red-500 to-orange-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E9%BB%9E%E9%BB%9E%E5%A2%A8%E5%AF%B6%E6%BC%A2%E5%AD%97%E5%AD%B8%E7%BF%92'
            },
            {
                id: 'changhenge',
                name: '《長恨歌》記憶卡牌',
                icon: 'fas fa-memory',
                gradient: 'from-yellow-500 to-amber-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E9%95%B7%E6%81%A8%E6%AD%8C%E8%A8%98%E6%86%B6%E5%8D%A1%E7%89%8C'
            },
            {
                id: 'leiyu',
                name: '《雷雨》游戲',
                icon: 'fas fa-cloud-rain',
                gradient: 'from-blue-500 to-cyan-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E9%9B%B7%E9%9B%A8%E6%B8%B8%E6%88%B2'
            },
            {
                id: 'shicizuju',
                name: '詩詞組句遊戲',
                icon: 'fas fa-puzzle-piece',
                gradient: 'from-green-500 to-emerald-500',
                url: 'https://chineseclassics.github.io/shicizuju.html'
            },
            {
                id: 'cikeyishou',
                name: '刺客之道 1.0',
                icon: 'fas fa-user-ninja',
                gradient: 'from-purple-500 to-pink-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E5%88%BA%E5%AE%A2%E4%B9%8B%E9%81%93-1-0'
            },
            {
                id: 'shiguangpintu',
                name: '《長干行》時光拼圖',
                icon: 'fas fa-hourglass-half',
                gradient: 'from-gray-600 to-gray-800',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E9%95%B7%E5%B9%B2%E8%A1%8C%E6%99%82%E5%85%89%E6%8B%BC%E5%9C%96'
            },
            {
                id: 'nanfengtianci',
                name: '南風填詞',
                icon: 'fas fa-pencil-alt',
                gradient: 'from-teal-500 to-green-400',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E5%8D%97%E9%A2%A8%E5%A1%AB%E8%A9%9E'
            },
            {
                id: 'nanfengzuoshi',
                name: '南風作詩',
                icon: 'fas fa-feather-alt',
                gradient: 'from-indigo-400 to-blue-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E5%8D%97%E9%A2%A8%E4%BD%9C%E8%A9%A9'
            },
            {
                id: 'yinzhangsheji',
                name: '印章設計',
                icon: 'fas fa-stamp',
                gradient: 'from-red-600 to-rose-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E5%8D%B0%E7%AB%A0%E8%A8%AD%E8%A8%88'
            },
            {
                id: 'mishijiangchun',
                name: '迷失江南春',
                icon: 'fas fa-tree',
                gradient: 'from-emerald-500 to-lime-400',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E8%BF%B7%E5%A4%B1%E6%B1%9F%E5%8D%97%E6%98%A5'
            },
            {
                id: 'jiangluohua',
                name: '江南落花',
                icon: 'fas fa-spa',
                gradient: 'from-pink-400 to-rose-300',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E6%B1%9F%E5%8D%97%E8%90%BD%E8%8A%B1'
            },
            {
                id: 'wanwuxiaoyao',
                name: '萬物逍遙',
                icon: 'fas fa-leaf',
                gradient: 'from-amber-400 to-yellow-300',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E8%90%AC%E7%89%A9%E9%80%8D%E9%81%99'
            },
            {
                id: 'yimoji',
                name: '意moji：詩詞意象配對',
                icon: 'fas fa-icons',
                gradient: 'from-violet-500 to-purple-400',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E6%84%8Fmoji%E8%A9%A9%E8%A9%9E%E6%84%8F%E8%B1%A1%E9%85%8D%E5%B0%8D'
            },
            {
                id: 'chengyutianci',
                name: '成語填字',
                icon: 'fas fa-font',
                gradient: 'from-cyan-500 to-blue-400',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E6%88%90%E8%AA%9E%E5%A1%AB%E5%AD%97'
            },
            {
                id: 'yuexiaduzuo',
                name: '月下獨酌',
                icon: 'fas fa-moon',
                gradient: 'from-slate-600 to-indigo-400',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E6%9C%88%E4%B8%8B%E7%8D%A8%E9%85%8C'
            },
            {
                id: 'langzhuliangrensha',
                name: '狼渚良人殺',
                icon: 'fas fa-paw',
                gradient: 'from-stone-600 to-stone-500',
                url: 'https://sites.google.com/isf.edu.hk/aichineseclassics/%E7%8B%BC%E6%B8%9A%E8%89%AF%E4%BA%BA%E6%AE%BA'
            }
        ];

        // 状态管理
        let currentApp = null;
        let currentView = 'home';

        // DOM 元素
        const homeView = document.getElementById('homeView');
        const appView = document.getElementById('appView');
        const appFrame = document.getElementById('appFrame');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const currentAppName = document.getElementById('currentAppName');
        const appGrid = document.getElementById('appGrid');
        const switcherAppGrid = document.getElementById('switcherAppGrid');
        const appSwitcherModal = document.getElementById('appSwitcherModal');
        const bottomNav = document.getElementById('bottomNav');

        // Tooltip相关变量
        let currentTooltip = null;
        let tooltipTimeout = null;

        // 创建tooltip
        function createTooltip(app, targetElement) {
            if (!app.description) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'app-tooltip';
            if (document.documentElement.classList.contains('dark')) {
                tooltip.classList.add('dark');
            }

            tooltip.innerHTML = `
                <div class="app-tooltip-title">${app.description.title}</div>
                <div class="app-tooltip-subtitle">${app.description.subtitle}</div>
                <ul class="app-tooltip-features">
                    ${app.description.features.map(feature => `<li>${feature}</li>`).join('')}
                </ul>
                <div class="app-tooltip-quote">${app.description.quote}</div>
            `;

            document.body.appendChild(tooltip);

            // 计算位置
            const rect = targetElement.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width - tooltipRect.width) / 2;
            let top = rect.bottom + 10;

            // 确保不超出屏幕边界
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top + tooltipRect.height > window.innerHeight - 10) {
                top = rect.top - tooltipRect.height - 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';

            // 显示tooltip
            setTimeout(() => tooltip.classList.add('show'), 10);

            return tooltip;
        }

        // 隐藏tooltip
        function hideTooltip() {
            if (currentTooltip) {
                currentTooltip.classList.remove('show');
                setTimeout(() => {
                    if (currentTooltip && currentTooltip.parentNode) {
                        currentTooltip.parentNode.removeChild(currentTooltip);
                    }
                    currentTooltip = null;
                }, 300);
            }
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
        }

        // 显示tooltip
        function showTooltip(app, targetElement) {
            hideTooltip();
            if (app.description) {
                tooltipTimeout = setTimeout(() => {
                    currentTooltip = createTooltip(app, targetElement);
                }, 500); // 0.5秒延迟
            }
        }

        // 渲染应用图标
        function renderAppIcon(app, isCompact = false) {
            const size = isCompact ? 'w-12 h-12' : 'aspect-square';
            const iconSize = isCompact ? 'text-xl' : 'text-4xl';
            const textSize = isCompact ? 'text-xs' : 'font-medium';
            
            return `
                <div class="app-icon block w-full text-left no-underline text-gray-800 dark:text-gray-200 relative" 
                     data-app-id="${app.id}" 
                     onclick="openApp('${app.id}')"
                     onmouseenter="handleMouseEnter(event, '${app.id}')"
                     onmouseleave="handleMouseLeave()"
                     ontouchstart="handleTouchStart(event, '${app.id}')"
                     ontouchend="handleTouchEnd()">
                    <div class="bg-gradient-to-br ${app.gradient} rounded-2xl p-4 ${size} flex items-center justify-center shadow-lg">
                        <i class="${app.icon} text-white ${iconSize}"></i>
                    </div>
                    <p class="text-center mt-2 ${textSize}">${app.name}</p>
                </div>
            `;
        }

        // 鼠标进入事件
        function handleMouseEnter(event, appId) {
            if (isMobile()) return; // 移动端不使用鼠标悬停
            
            const app = apps.find(a => a.id === appId);
            if (app && app.description) {
                showTooltip(app, event.currentTarget);
            }
        }

        // 鼠标离开事件
        function handleMouseLeave() {
            if (!isMobile()) {
                hideTooltip();
            }
        }

        // 触摸开始事件（移动端）
        function handleTouchStart(event, appId) {
            if (!isMobile()) return;
            
            const app = apps.find(a => a.id === appId);
            if (app && app.description) {
                event.preventDefault(); // 阻止默认行为
                
                // 如果当前已显示tooltip，则隐藏
                if (currentTooltip) {
                    hideTooltip();
                    return;
                }
                
                showTooltip(app, event.currentTarget);
            }
        }

        // 触摸结束事件
        function handleTouchEnd() {
            // 移动端触摸后不立即隐藏，让用户有时间阅读
        }

        // 点击其他地方隐藏tooltip
        document.addEventListener('click', (event) => {
            if (currentTooltip && !event.target.closest('.app-icon') && !event.target.closest('.app-tooltip')) {
                hideTooltip();
            }
        });

        // 全局函数供HTML调用
        window.handleMouseEnter = handleMouseEnter;
        window.handleMouseLeave = handleMouseLeave;
        window.handleTouchStart = handleTouchStart;
        window.handleTouchEnd = handleTouchEnd;

        // 渲染应用网格
        function renderApps() {
            appGrid.innerHTML = apps.map(app => renderAppIcon(app)).join('');
            switcherAppGrid.innerHTML = apps.map(app => renderAppIcon(app, true)).join('');
            
            // 渲染底部导航栏的快捷应用（前3个）
            const quickApps = apps.slice(0, 3);
            const quickNavHTML = quickApps.map(app => `
                <button class="quick-app-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-300" 
                        onclick="openApp('${app.id}')">
                    <i class="${app.icon} text-lg mb-1"></i>
                    <span class="text-xs">${app.name.length > 6 ? app.name.substring(0, 6) + '...' : app.name}</span>
                </button>
            `).join('');
            
            bottomNav.innerHTML = `
                <button class="quick-app-btn flex flex-col items-center p-2 text-gray-600 dark:text-gray-300" 
                        onclick="showHome()">
                    <i class="fas fa-home text-lg mb-1"></i>
                    <span class="text-xs">首頁</span>
                </button>
                ${quickNavHTML}
            `;
        }

        // 打开应用
        function openApp(appId) {
            const app = apps.find(a => a.id === appId);
            if (!app) return;

            currentApp = app;
            currentView = 'app';
            currentAppName.textContent = app.name;

            // 切换视图
            homeView.classList.add('hidden');
            appView.classList.remove('hidden');

            // 显示加载状态
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');

            // 加载iframe
            appFrame.src = app.url;

            // 设置iframe错误处理
            const timeoutId = setTimeout(() => {
                showError();
            }, 10000); // 10秒超时

            appFrame.onload = () => {
                clearTimeout(timeoutId);
                setTimeout(() => {
                    loadingState.classList.add('hidden');
                }, 1000);
            };

            appFrame.onerror = () => {
                clearTimeout(timeoutId);
                showError();
            };

            // 关闭应用切换器
            appSwitcherModal.classList.add('hidden');
        }

        // 显示错误状态
        function showError() {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            
            document.getElementById('openInNewTabBtn').onclick = () => {
                window.open(currentApp.url, '_blank');
            };
        }

        // 回到首页
        function showHome() {
            currentView = 'home';
            currentAppName.textContent = '太虛幻境';
            homeView.classList.remove('hidden');
            appView.classList.add('hidden');
            appFrame.src = 'about:blank';
            currentApp = null;
        }

        // 事件监听
        document.getElementById('homeBtn').onclick = showHome;
        
        document.getElementById('appSwitcherBtn').onclick = () => {
            appSwitcherModal.classList.remove('hidden');
        };
        
        document.getElementById('closeSwitcherBtn').onclick = () => {
            appSwitcherModal.classList.add('hidden');
        };

        // 点击模态框背景关闭
        appSwitcherModal.onclick = (e) => {
            if (e.target === appSwitcherModal) {
                appSwitcherModal.classList.add('hidden');
            }
        };

        // 手势控制相关
        let startY = 0;
        let currentY = 0;
        let isSwipeActive = false;
        let homeIndicator = null;
        let swipeArea = null;
        let floatingHomeBtn = null;
        let tutorialOverlay = null;

        // 检查是否是移动设备
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // 创建移动端UI元素
        function createMobileElements() {
            if (!isMobile()) return;

            // 创建Home指示器
            if (!homeIndicator) {
                homeIndicator = document.createElement('div');
                homeIndicator.className = 'home-indicator';
                document.body.appendChild(homeIndicator);
            }

            // 创建滑动区域
            if (!swipeArea) {
                swipeArea = document.createElement('div');
                swipeArea.className = 'swipe-area';
                document.body.appendChild(swipeArea);
            }

            // 创建浮动返回按钮
            if (!floatingHomeBtn) {
                floatingHomeBtn = document.createElement('button');
                floatingHomeBtn.className = 'floating-home-btn';
                floatingHomeBtn.innerHTML = '<i class="fas fa-home"></i>';
                floatingHomeBtn.onclick = showHome;
                document.body.appendChild(floatingHomeBtn);
            }

            // 隐藏移动端导航栏
            if (currentView === 'app') {
                const nav = document.querySelector('nav');
                const bottomNav = document.querySelector('nav.md\\:hidden');
                const main = document.querySelector('main');
                
                nav.classList.add('mobile-nav-hide');
                bottomNav.classList.add('mobile-nav-hide');
                main.style.paddingTop = '0';
                main.style.paddingBottom = '0';
            }
        }

        // 显示首次使用教程
        function showTutorial() {
            if (!isMobile() || localStorage.getItem('tutorialShown') === 'true') return;

            tutorialOverlay = document.createElement('div');
            tutorialOverlay.className = 'tutorial-overlay';
            tutorialOverlay.innerHTML = `
                <div class="swipe-animation"></div>
                <h3 class="text-xl font-bold mb-2">向上滑動返回桌面</h3>
                <p class="text-center text-gray-300 mb-6">在應用底部向上滑動即可返回首頁<br>就像iPhone一樣簡單</p>
                <button onclick="closeTutorial()" class="bg-white text-black px-6 py-2 rounded-full font-medium">
                    我知道了
                </button>
            `;
            document.body.appendChild(tutorialOverlay);
        }

        // 关闭教程
        function closeTutorial() {
            if (tutorialOverlay) {
                tutorialOverlay.remove();
                tutorialOverlay = null;
            }
            localStorage.setItem('tutorialShown', 'true');
        }

        // 设置手势监听
        function setupGestureListeners() {
            if (!isMobile()) return;

            // 手势开始
            function handleStart(e) {
                if (currentView !== 'app') return;
                
                const touch = e.touches ? e.touches[0] : e;
                startY = touch.clientY;
                isSwipeActive = true;
                
                // 激活Home指示器
                if (homeIndicator) {
                    homeIndicator.classList.add('active');
                }
            }

            // 手势移动
            function handleMove(e) {
                if (!isSwipeActive || currentView !== 'app') return;
                
                const touch = e.touches ? e.touches[0] : e;
                currentY = touch.clientY;
                const deltaY = startY - currentY;
                
                // 只有向上滑动且距离足够时才触发
                if (deltaY > 50) {
                    // 显示浮动按钮作为视觉反馈
                    if (floatingHomeBtn && deltaY > 100) {
                        floatingHomeBtn.classList.add('show');
                    }
                }
            }

            // 手势结束
            function handleEnd(e) {
                if (!isSwipeActive || currentView !== 'app') return;
                
                const deltaY = startY - currentY;
                isSwipeActive = false;
                
                // 重置Home指示器
                if (homeIndicator) {
                    homeIndicator.classList.remove('active');
                }
                
                // 向上滑动超过阈值则返回首页
                if (deltaY > 120) {
                    showHome();
                    // 添加触觉反馈（如果支持）
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                } else {
                    // 隐藏浮动按钮
                    if (floatingHomeBtn) {
                        floatingHomeBtn.classList.remove('show');
                    }
                }
            }

            // 添加事件监听器
            if (swipeArea) {
                // 触摸事件
                swipeArea.addEventListener('touchstart', handleStart, { passive: true });
                swipeArea.addEventListener('touchmove', handleMove, { passive: true });
                swipeArea.addEventListener('touchend', handleEnd, { passive: true });
                
                // 鼠标事件（用于桌面测试）
                swipeArea.addEventListener('mousedown', handleStart);
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleEnd);
            }
        }

        // 更新Home指示器样式
        function updateHomeIndicator() {
            if (!homeIndicator || !isMobile()) return;
            
            // 根据当前应用背景调整指示器颜色
            const isDarkApp = currentApp && ['shiguangpintu', 'langzhuliangrensha', 'yuexiaduzuo'].includes(currentApp.id);
            
            if (currentView === 'app') {
                homeIndicator.style.display = 'block';
                if (isDarkApp) {
                    homeIndicator.classList.add('light');
                } else {
                    homeIndicator.classList.remove('light');
                }
            } else {
                homeIndicator.style.display = 'none';
            }
        }

        // 修改openApp函数以支持移动端全屏
        const originalOpenApp = openApp;
        openApp = function(appId) {
            originalOpenApp(appId);
            
            if (isMobile()) {
                // 隐藏导航栏，实现全屏
                setTimeout(() => {
                    const nav = document.querySelector('nav');
                    const bottomNav = document.querySelector('nav.md\\:hidden');
                    const main = document.querySelector('main');
                    
                    nav.classList.add('mobile-nav-hide');
                    bottomNav.classList.add('mobile-nav-hide');
                    main.style.paddingTop = '0';
                    main.style.paddingBottom = '0';
                    
                    createMobileElements();
                    updateHomeIndicator();
                    
                    // 首次使用显示教程
                    setTimeout(showTutorial, 1000);
                }, 100);
            }
        };

        // 修改showHome函数
        const originalShowHome = showHome;
        showHome = function() {
            originalShowHome();
            
            if (isMobile()) {
                // 恢复导航栏
                const nav = document.querySelector('nav');
                const bottomNav = document.querySelector('nav.md\\:hidden');
                const main = document.querySelector('main');
                
                nav.classList.remove('mobile-nav-hide');
                bottomNav.classList.remove('mobile-nav-hide');
                main.style.paddingTop = '';
                main.style.paddingBottom = '';
                
                updateHomeIndicator();
                
                // 隐藏浮动按钮
                if (floatingHomeBtn) {
                    floatingHomeBtn.classList.remove('show');
                }
            }
        };

        // 窗口大小改变时重新检查
        window.addEventListener('resize', () => {
            if (isMobile()) {
                createMobileElements();
                setupGestureListeners();
            }
        });

        // 初始化
        renderApps();
        
        // 如果是移动端，设置手势监听
        if (isMobile()) {
            createMobileElements();
            setupGestureListeners();
        }

        // 全局函数供HTML调用
        window.closeTutorial = closeTutorial;
    </script>
</body>
</html>
