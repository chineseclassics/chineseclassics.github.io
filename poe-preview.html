<!DOCTYPE html><html lang="zh-TW"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á¥ÖÊ®ìËàäÂ§¢¬∑ÈÇÑÊ∑öÁ∑£</title>
    <style>
        /* Âü∫Á§éÊ®£Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PMingLiU', 'MingLiU', serif;
        }
        
        body {
            background: #f5f5f5 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.1"><path d="M0,0 L200,200 M200,0 L0,200" stroke="black" stroke-width="1"/></svg>');
            color: #333;
            overflow-x: hidden;
        }

        /* ÊöóÈªëÊ®°Âºè */
        @media (prefers-color-scheme: dark) {
            body {
                background: #181818 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" opacity="0.05"><path d="M0,0 L200,200 M200,0 L0,200" stroke="white" stroke-width="1"/></svg>');
                color: #eee;
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .title {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: normal;
            color: #8B4513;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 5px;
        }
        
        .subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }

        @media (prefers-color-scheme: dark) {
            .title {
                color: #d4b483;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            
            .subtitle {
                color: #aaa;
            }
        }
        
        /* ÈÅäÊà≤ÁãÄÊÖãÂçÄÂüü - Â¢ûÂº∑Áâà */
        .game-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Ê∑ªÂä†Ëº™Ëø¥ÈÄ≤Â∫¶Ê¢ù */
        .cycle-progress {
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .cycle-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #5D5CDE, #A5A4FF);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        @media (prefers-color-scheme: dark) {
            .game-status {
                background: rgba(40, 40, 40, 0.8);
                border: 1px solid #444;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            }
            
            .cycle-progress {
                background-color: #333;
            }
        }
        
        .status-item {
            text-align: center;
            padding: 5px 15px;
            position: relative;
            transition: transform 0.2s ease;
        }
        
        /* Ë≥áÊ∫êÈ†ÖÁõÆÊá∏ÂÅúÊïàÊûú */
        .status-item:hover {
            transform: translateY(-3px);
        }
        
        /* Ë≥áÊ∫êËÆäÂåñÂãïÁï´ */
        @keyframes resourceChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .resource-change {
            animation: resourceChange 0.5s ease;
        }
        
        .status-label {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: #8B4513;
            transition: color 0.3s ease;
        }
        
        /* Ë≥áÊ∫êË∂≥Â§†ÊôÇÈ°ØÁ§∫È´ò‰∫Æ */
        .status-value.sufficient {
            color: #4CAF50;
        }
        
        /* Ë≥áÊ∫ê‰∏çË∂≥ÊôÇÈ°ØÁ§∫Ë≠¶Âëä */
        .status-value.insufficient {
            color: #F44336;
        }

        @media (prefers-color-scheme: dark) {
            .status-label {
                color: #aaa;
            }
            
            .status-value {
                color: #d4b483;
            }
            
            .status-value.sufficient {
                color: #81C784;
            }
            
            .status-value.insufficient {
                color: #E57373;
            }
        }
        
        /* ÈÅäÊà≤ÂçÄÂüü‰ΩàÂ±Ä */
        .game-area {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .garden-area {
            flex: 2;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            min-height: 500px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .control-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (prefers-color-scheme: dark) {
            .garden-area {
                background: rgba(40, 40, 40, 0.8);
                border: 1px solid #444;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
        }
        
        /* ÂúíÊûóÂçÄÂüüÂÖÉÁ¥† - Â¢ûÂº∑‰∫íÂãïÊïàÊûú */
        .garden-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 12px;
            min-height: 450px;
        }
        
        .garden-cell {
            background: rgba(230, 230, 230, 0.5);
            border: 1px dashed #aaa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        /* ÂèØ‰∫íÂãïÊèêÁ§∫ÊïàÊûú */
        .garden-cell.interactive {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(93, 92, 222, 0); }
            100% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0); }
        }
        
        .garden-cell:hover {
            background: rgba(230, 230, 230, 0.8);
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Á™ÅÂá∫È°ØÁ§∫‰∏ã‰∏ÄÊ≠•Âª∫Ë≠∞ÁöÑÊ†ºÂ≠ê */
        .garden-cell.suggested-action {
            box-shadow: 0 0 10px 3px rgba(93, 92, 222, 0.6);
        }
        
        .garden-cell.has-building {
            background: rgba(255, 245, 230, 0.6);
            border: 1px solid #d4b483;
        }
        
        .garden-cell.has-flower {
            background: rgba(230, 255, 230, 0.6);
            border: 1px solid #a8d8a8;
        }
        
        .garden-cell.has-memory {
            background: rgba(230, 230, 255, 0.6);
            border: 1px solid #b8c4ff;
            animation: glimmer 3s infinite;
        }
        
        @keyframes glimmer {
            0% { background: rgba(230, 230, 255, 0.6); }
            50% { background: rgba(230, 230, 255, 0.9); }
            100% { background: rgba(230, 230, 255, 0.6); }
        }
        
        .garden-cell.unlock-required {
            background: rgba(0, 0, 0, 0.1);
            border: 1px dashed #666;
            cursor: not-allowed;
        }
        
        .garden-cell.unlock-required::after {
            content: "üîí";
            font-size: 24px;
            color: #666;
        }

        @media (prefers-color-scheme: dark) {
            .garden-cell {
                background: rgba(60, 60, 60, 0.5);
                border: 1px dashed #666;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .garden-cell:hover {
                background: rgba(70, 70, 70, 0.8);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            
            .garden-cell.has-building {
                background: rgba(70, 60, 45, 0.7);
                border: 1px solid #a08463;
            }
            
            .garden-cell.has-flower {
                background: rgba(50, 70, 50, 0.7);
                border: 1px solid #789878;
            }
            
            .garden-cell.has-memory {
                background: rgba(50, 50, 70, 0.7);
                border: 1px solid #8894cf;
            }
            
            @keyframes glimmer {
                0% { background: rgba(50, 50, 70, 0.7); }
                50% { background: rgba(60, 60, 90, 0.9); }
                100% { background: rgba(50, 50, 70, 0.7); }
            }
            
            .garden-cell.unlock-required {
                background: rgba(30, 30, 30, 0.3);
                border: 1px dashed #555;
            }
            
            .garden-cell.unlock-required::after {
                color: #888;
            }
        }
        
        /* ÂñÆÂÖÉÊ†ºÂÖßÂÆπÊ®£ÂºèÊîπÈÄ≤ */
        .building, .flower, .memory {
            width: 85%;
            height: 85%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #5a3921;
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 5px;
        }
        
        .garden-cell:hover .building,
        .garden-cell:hover .flower,
        .garden-cell:hover .memory {
            transform: scale(1.05);
        }
        
        .building-icon, .flower-icon, .memory-icon {
            font-size: 30px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }
        
        .building-name, .flower-name, .memory-name {
            font-size: 13px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        
        /* ÂñÆÂÖÉÊ†ºÁãÄÊÖãÊåáÁ§∫Âô® */
        .cell-status {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            padding: 2px 5px;
            display: flex;
            align-items: center;
            gap: 2px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .garden-cell:hover .cell-status {
            opacity: 1;
        }

        @media (prefers-color-scheme: dark) {
            .building {
                color: #d4b483;
            }
            
            .building-name, .flower-name, .memory-name {
                text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            }
            
            .cell-status {
                background: rgba(50,50,50,0.7);
                color: #ddd;
            }
        }
        
        .decay-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border-radius: 10px;
        }
        
        .decay-icon {
            font-size: 36px;
            color: rgba(139, 69, 19, 0.5);
        }

        @media (prefers-color-scheme: dark) {
            .decay-overlay {
                background: rgba(30, 30, 30, 0.8);
            }
            
            .decay-icon {
                color: rgba(212, 180, 131, 0.5);
            }
        }
        
        /* ÊéßÂà∂Èù¢Êùø - ÊîπÈÄ≤Ë®≠Ë®à */
        .panel {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        /* Èù¢ÊùøÂëºÂê∏ÊïàÊûú */
        .panel.highlight {
            animation: panelHighlight 2s infinite;
        }
        
        @keyframes panelHighlight {
            0% { box-shadow: 0 3px 10px rgba(93, 92, 222, 0.2); }
            50% { box-shadow: 0 3px 15px rgba(93, 92, 222, 0.6); }
            100% { box-shadow: 0 3px 10px rgba(93, 92, 222, 0.2); }
        }
        
        .panel-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #5a3921;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-title-icon {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .panel-help {
            font-size: 16px;
            color: #5D5CDE;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .panel-help:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* ÊîπÈÄ≤ÊåâÈàïÊ®£Âºè */
        .action-button {
            padding: 12px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        /* ÊåâÈàïÊ≥¢Á¥ãÊïàÊûú */
        .action-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .action-button:active::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        /* Á™ÅÂá∫È°ØÁ§∫Êé®Ëñ¶Êìç‰Ωú */
        .action-button.recommended {
            background: #5D5CDE;
            animation: pulse 2s infinite;
        }
        
        .action-button:hover {
            background: #a0522d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .action-button.recommended:hover {
            background: #7170E3;
        }
        
        .action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .action-cost {
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        @media (prefers-color-scheme: dark) {
            .panel {
                background: rgba(40, 40, 40, 0.8);
                border: 1px solid #444;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            }
            
            .panel-title {
                color: #d4b483;
                border-bottom: 1px solid #444;
            }
            
            .action-button {
                background: #5D5CDE;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            
            .action-button:hover {
                background: #7170E3;
                box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            }
            
            .action-button.recommended {
                background: #8B4513;
            }
            
            .action-button.recommended:hover {
                background: #a0522d;
            }
            
            .action-button:disabled {
                background: #555555;
            }
        }
        
        /* ÂàóË°®ÊîπÈÄ≤ */
        .flowers-list, .birds-list, .memories-list, .tears-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: thin;
            scrollbar-color: #8B4513 #f0f0f0;
        }
        
        .flowers-list::-webkit-scrollbar, 
        .birds-list::-webkit-scrollbar, 
        .memories-list::-webkit-scrollbar, 
        .tears-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .flowers-list::-webkit-scrollbar-thumb, 
        .birds-list::-webkit-scrollbar-thumb, 
        .memories-list::-webkit-scrollbar-thumb, 
        .tears-list::-webkit-scrollbar-thumb {
            background-color: #8B4513;
            border-radius: 3px;
        }
        
        .flowers-list::-webkit-scrollbar-track, 
        .birds-list::-webkit-scrollbar-track, 
        .memories-list::-webkit-scrollbar-track, 
        .tears-list::-webkit-scrollbar-track {
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        
        .flower-item, .bird-item, .memory-item, .tear-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            margin-bottom: 5px;
        }
        
        .flower-item:hover, .bird-item:hover, .memory-item:hover, .tear-item:hover {
            background: rgba(230, 230, 230, 0.5);
            transform: translateX(5px);
        }
        
        /* Êñ∞Â¢ûÈ†ÖÁõÆÊïàÊûú */
        .new-item {
            animation: newItem 2s ease;
        }
        
        @keyframes newItem {
            0% { background-color: rgba(93, 92, 222, 0.2); }
            100% { background-color: transparent; }
        }
        
        .flower-item-icon, .bird-item-icon, .memory-item-icon, .tear-item-icon {
            font-size: 22px;
            margin-right: 12px;
            width: 30px;
            text-align: center;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }
        
        .flower-item-details, .bird-item-details, .memory-item-details, .tear-item-details {
            flex: 1;
        }
        
        .item-name {
            font-size: 15px;
            font-weight: bold;
            color: #5a3921;
            margin-bottom: 3px;
        }
        
        .item-level, .item-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        /* Ê∑ªÂä†È†ÖÁõÆÁµ±Ë®àË®àÊï∏Âô®Ê®£Âºè */
        .counter-badge {
            background-color: #5D5CDE;
            color: white;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        @media (prefers-color-scheme: dark) {
            .flowers-list, .birds-list, .memories-list, .tears-list {
                scrollbar-color: #5D5CDE #333;
            }
            
            .flowers-list::-webkit-scrollbar-thumb, 
            .birds-list::-webkit-scrollbar-thumb, 
            .memories-list::-webkit-scrollbar-thumb, 
            .tears-list::-webkit-scrollbar-thumb {
                background-color: #5D5CDE;
            }
            
            .flowers-list::-webkit-scrollbar-track, 
            .birds-list::-webkit-scrollbar-track, 
            .memories-list::-webkit-scrollbar-track, 
            .tears-list::-webkit-scrollbar-track {
                background-color: #333;
            }
            
            .flower-item, .bird-item, .memory-item, .tear-item {
                border-bottom: 1px solid #444;
            }
            
            .flower-item:hover, .bird-item:hover, .memory-item:hover, .tear-item:hover {
                background: rgba(60, 60, 60, 0.5);
            }
            
            .item-name {
                color: #d4b483;
            }
            
            .item-level, .item-description {
                color: #aaa;
            }
            
            .counter-badge {
                background-color: #8B4513;
                box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            }
        }
        
        /* Â∞çË©±Ê°ÜÊîπÈÄ≤ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .dialog-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .dialog {
            background: white;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .dialog-overlay.active .dialog {
            transform: scale(1);
        }
        
        .dialog-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0,0,0,0.05);
            z-index: 1010; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
            -webkit-tap-highlight-color: rgba(0,0,0,0); /* ÁßªÈô§ÁßªÂä®ËÆæÂ§á‰∏äÁöÑÁÇπÂáªÈ´ò‰∫ÆÊïàÊûú */
            touch-action: manipulation; /* ‰ºòÂåñËß¶Êë∏Êìç‰Ωú */
        }
        
        .dialog-close:hover {
            color: #000;
            background: rgba(0,0,0,0.1);
        }
        
        /* Ê∑ªÂä†Ê¥ªË∑ÉÁä∂ÊÄÅÔºåÊîπÂñÑÁßªÂä®ËÆæÂ§á‰∏äÁöÑÂèçÈ¶à */
        .dialog-close:active {
            transform: scale(0.95);
            background: rgba(0,0,0,0.15);
        }
        
        .dialog-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #5a3921;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }
        
        .dialog-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 30%;
            right: 30%;
            height: 2px;
            background: linear-gradient(to right, transparent, #5D5CDE, transparent);
        }
        
        .dialog-content {
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* ÊîπÈÄ≤ÊåâÈàïÊ®£Âºè */
        .dialog-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .dialog-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .dialog-button:active::after {
            animation: ripple 0.6s ease-out;
        }
        
        .dialog-button.primary {
            background: #8B4513;
            color: white;
        }
        
        .dialog-button.primary:hover {
            background: #a0522d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .dialog-button.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .dialog-button.secondary:hover {
            background: #ddd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            .dialog-overlay {
                backdrop-filter: blur(5px);
            }
            
            .dialog {
                background: #282828;
                color: #eee;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            }
            
            .dialog-close {
                color: #aaa;
            }
            
            .dialog-close:hover {
                color: #fff;
                background: rgba(255,255,255,0.1);
            }
            
            .dialog-title {
                color: #d4b483;
            }
            
            .dialog-title::after {
                background: linear-gradient(to right, transparent, #8B4513, transparent);
            }
            
            .dialog-button.primary {
                background: #5D5CDE;
            }
            
            .dialog-button.primary:hover {
                background: #7170E3;
            }
            
            .dialog-button.secondary {
                background: #444;
                color: #eee;
            }
            
            .dialog-button.secondary:hover {
                background: #555;
            }
        }
        
        /* Ë®òÊÜ∂ÈñÉÂõûÂ∞çË©±Ê°Ü */
        .memory-dialog {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #d4b483;
        }
        
        .memory-content {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            text-align: center;
            font-style: italic;
            color: #5a3921;
            position: relative;
        }
        
        /* Ê∑ªÂä†Ë£ùÈ£æÊÄßÂºïËôü */
        .memory-content::before,
        .memory-content::after {
            font-family: serif;
            position: absolute;
            color: rgba(90, 57, 33, 0.1);
            font-size: 60px;
            line-height: 1;
        }
        
        .memory-content::before {
            content: """;
            top: -10px;
            left: 0;
        }
        
        .memory-content::after {
            content: """;
            bottom: -30px;
            right: 0;
        }

        @media (prefers-color-scheme: dark) {
            .memory-dialog {
                background: rgba(40, 40, 40, 0.95);
                border: 1px solid #a08463;
            }
            
            .memory-content {
                color: #d4b483;
            }
            
            .memory-content::before,
            .memory-content::after {
                color: rgba(212, 180, 131, 0.1);
            }
        }
        
        /* ÈÄ≤Â∫¶Ê¢ùÊîπÈÄ≤ */
        .progress-container {
            width: 100%;
            height: 12px;
            background: rgba(230, 230, 230, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .progress-label {
            position: absolute;
            top: -18px;
            right: 0;
            font-size: 12px;
            color: #666;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #8B4513, #d4b483);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        /* ÈÄ≤Â∫¶Ê¢ùÈñÉÂÖâÊïàÊûú */
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, 
                            transparent 0%, 
                            rgba(255,255,255,0.4) 50%, 
                            transparent 100%);
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Ê∑öÊ∞¥ÈÄ≤Â∫¶Ê¢ùÁâπÊÆäÊ®£Âºè */
        .tear-progress-bar {
            background: linear-gradient(to right, #5D5CDE, #A5A4FF); 
        }

        @media (prefers-color-scheme: dark) {
            .progress-container {
                background: rgba(60, 60, 60, 0.5);
                box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            }
            
            .progress-label {
                color: #aaa;
            }
            
            .progress-bar {
                background: linear-gradient(to right, #a0522d, #d4b483);
            }
            
            .tear-progress-bar {
                background: linear-gradient(to right, #5D5CDE, #A5A4FF);
            }
        }
        
        /* Âª∫ÈÄ†ËèúÂñÆÊîπÈÄ≤ */
        .build-menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .build-item {
            padding: 12px;
            background: rgba(255, 245, 230, 0.8);
            border: 1px solid #d4b483;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .build-item:hover {
            background: rgba(255, 245, 230, 1);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Êé®Ëñ¶ÈÅ∏ÊìáÁöÑÈ†ÖÁõÆ */
        .build-item.recommended {
            box-shadow: 0 0 0 2px #5D5CDE, 0 2px 5px rgba(0,0,0,0.1);
            animation: recommendPulse 2s infinite;
        }
        
        @keyframes recommendPulse {
            0% { box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.5), 0 2px 5px rgba(0,0,0,0.1); }
            50% { box-shadow: 0 0 0 3px rgba(93, 92, 222, 1), 0 5px 15px rgba(0,0,0,0.2); }
            100% { box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.5), 0 2px 5px rgba(0,0,0,0.1); }
        }
        
        .build-item.disabled {
            background: #eee;
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }
        
        .build-icon {
            font-size: 28px;
            margin-bottom: 8px;
            color: #5a3921;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
        
        .build-name {
            font-size: 14px;
            text-align: center;
            color: #5a3921;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .build-cost {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.5);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .build-cost-icon {
            font-size: 13px;
        }
        
        /* Âª∫ÁØâË∂≥Â§†Ë≥áÊ∫êÈ°ØÁ§∫ */
        .build-item:not(.disabled) .build-cost {
            color: #4CAF50;
        }

        @media (prefers-color-scheme: dark) {
            .build-item {
                background: rgba(70, 60, 45, 0.8);
                border: 1px solid #a08463;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            
            .build-item:hover {
                background: rgba(80, 70, 55, 1);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            
            .build-item.disabled {
                background: #444;
                opacity: 0.5;
            }
            
            .build-icon {
                color: #d4b483;
            }
            
            .build-name {
                color: #d4b483;
            }
            
            .build-cost {
                color: #aaa;
                background: rgba(0,0,0,0.2);
            }
            
            .build-item:not(.disabled) .build-cost {
                color: #81C784;
            }
        }
        
        /* Ë©©Ë©ûÂ±ïÁ§∫ */
        .poem {
            font-style: italic;
            line-height: 1.8;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .poem::before,
        .poem::after {
            content: '"';
            font-family: serif;
            position: absolute;
            font-size: 40px;
            opacity: 0.2;
        }
        
        .poem::before {
            top: 0;
            left: 10px;
        }
        
        .poem::after {
            bottom: -20px;
            right: 10px;
        }

        @media (prefers-color-scheme: dark) {
            .poem {
                background: rgba(60, 60, 60, 0.7);
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            }
        }
        
        /* Ë≠¶ÂπªÂ∞çË©± */
        .warning-dream {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 25px 0;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-size: 18px;
            line-height: 1.7;
        }
        
        .warning-dream::before,
        .warning-dream::after {
            content: '"';
            font-family: serif;
            font-size: 60px;
            color: rgba(255, 255, 255, 0.2);
            position: absolute;
        }
        
        .warning-dream::before {
            top: 5px;
            left: 15px;
        }
        
        .warning-dream::after {
            bottom: -30px;
            right: 15px;
        }
        
        /* ÁôΩËå´Ëå´ÊïàÊûú */
        @keyframes fadeWhite {
            0% {opacity: 0;}
            100% {opacity: 1;}
        }
        
        .white-fade {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 5s ease;
        }
        
        .white-fade.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .white-fade-text {
            font-size: 36px;
            color: rgba(0, 0, 0, 0.7);
            text-align: center;
            font-style: italic;
        }

        @media (prefers-color-scheme: dark) {
            .white-fade {
                background: #181818;
            }
            
            .white-fade-text {
                color: rgba(255, 255, 255, 0.7);
            }
        }
        
        /* ÁØÄÊ∞£ÊåáÁ§∫Âô® */
        .jieqi-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            font-size: 15px;
            color: #5a3921;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            backdrop-filter: blur(2px);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .jieqi-indicator:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .jieqi-icon {
            font-size: 18px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }
        
        /* ÁØÄÊ∞£ËÆäÂåñÂãïÁï´ */
        .jieqi-change {
            animation: jieqiChange 1s ease;
        }
        
        @keyframes jieqiChange {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @media (prefers-color-scheme: dark) {
            .jieqi-indicator {
                background: rgba(60, 60, 60, 0.8);
                color: #d4b483;
                border: 1px solid rgba(255,255,255,0.05);
                box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            }
            
            .jieqi-indicator:hover {
                box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            }
        }
        
        /* ÈñÉÂõûÂãïÁï´ */
        @keyframes flashback {
            0% {
                filter: grayscale(0%) sepia(0%);
                transform: scale(1);
            }
            50% {
                filter: grayscale(50%) sepia(50%);
                transform: scale(1.05);
            }
            100% {
                filter: grayscale(0%) sepia(0%);
                transform: scale(1);
            }
        }
        
        .flashback {
            animation: flashback 3s ease;
        }

        /* Ê∑öÊ∞¥Êî∂ÈõÜÂãïÁï´ */
        @keyframes tearDrop {
            0% {
                transform: translateY(-30px) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translateY(0) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }
        }

        .tear-drop {
            position: absolute;
            color: #5D5CDE;
            font-size: 28px;
            pointer-events: none;
            animation: tearDrop 1.5s ease forwards;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
        }

        /* Ê∑öÊ∞¥Êª¥ËêΩÁâπÊïà */
        .watering-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle, rgba(165, 164, 255, 0.3) 0%, rgba(93, 92, 222, 0) 70%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            border-radius: 10px;
        }

        .watering-active .watering-effect {
            opacity: 1;
            animation: waterPulse 2s infinite;
        }
        
        @keyframes waterPulse {
            0% { transform: scale(0.95); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.7; }
        }
        
        /* Êñ∞Â¢ûÂÖÉÁ¥† - ÊïôÂ≠∏Á≥ªÁµ± */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .tutorial-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .tutorial-highlight {
            position: absolute;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            pointer-events: none;
            z-index: 2001;
            transition: all 0.5s ease;
        }
        
        .tutorial-tooltip {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2002;
            animation: tooltipPulse 2s infinite;
            pointer-events: auto;
        }
        
        @keyframes tooltipPulse {
            0% { box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 5px 30px rgba(93, 92, 222, 0.5); }
            100% { box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        }
        
        .tutorial-tooltip-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #5a3921;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tutorial-tooltip-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }
        
        .tutorial-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tutorial-progress {
            font-size: 12px;
            color: #999;
        }
        
        .tutorial-button {
            padding: 8px 15px;
            background: #5D5CDE;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .tutorial-button:hover {
            background: #7170E3;
            transform: translateY(-2px);
        }
        
        .tutorial-button.skip {
            background: transparent;
            color: #999;
            text-decoration: underline;
        }
        
        .tutorial-button.skip:hover {
            color: #5D5CDE;
            background: transparent;
            transform: none;
        }

        @media (prefers-color-scheme: dark) {
            .tutorial-tooltip {
                background: #333;
                color: #eee;
            }
            
            .tutorial-tooltip-title {
                color: #d4b483;
            }
            
            .tutorial-tooltip-content {
                color: #bbb;
            }
            
            .tutorial-button {
                background: #8B4513;
            }
            
            .tutorial-button:hover {
                background: #a0522d;
            }
            
            .tutorial-button.skip {
                color: #bbb;
            }
            
            .tutorial-button.skip:hover {
                color: #d4b483;
            }
        }
        
        /* ÊèêÁ§∫Á≥ªÁµ± */
        .hint-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 300px;
            max-width: 80vw;
            overflow: hidden;
        }
        
        .hint {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.5s ease;
            position: relative;
            border-left: 4px solid #5D5CDE;
        }
        
        .hint.show {
            transform: translateX(0);
        }
        
        .hint-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #5a3921;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint-icon {
            font-size: 18px;
            color: #5D5CDE;
        }
        
        .hint-content {
            font-size: 13px;
            line-height: 1.5;
            color: #555;
        }
        
        .hint-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #999;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .hint-close:hover {
            color: #333;
            transform: scale(1.1);
        }
        
        .hint-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #5D5CDE;
            width: 100%;
            transform-origin: left;
            animation: hintProgress 6s linear forwards;
        }
        
        @keyframes hintProgress {
            0% { transform: scaleX(1); }
            100% { transform: scaleX(0); }
        }

        @media (prefers-color-scheme: dark) {
            .hint {
                background: rgba(40, 40, 40, 0.95);
                box-shadow: 0 5px 15px rgba(0,0,0,0.4);
                border-left: 4px solid #8B4513;
            }
            
            .hint-title {
                color: #d4b483;
            }
            
            .hint-icon {
                color: #8B4513;
            }
            
            .hint-content {
                color: #bbb;
            }
            
            .hint-close:hover {
                color: #ddd;
            }
            
            .hint-progress {
                background: #8B4513;
            }
        }
        
        /* ‰∏ªÈÅ∏ÂñÆÂíåÊé®Ëñ¶Ë°åÂãï */
        .main-menu {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 999;
        }
        
        .menu-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #5D5CDE;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            background: #7170E3;
        }
        
        .menu-items {
            position: absolute;
            bottom: 60px;
            left: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .menu-open .menu-items {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .menu-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 200px;
        }
        
        .menu-item:hover {
            transform: translateX(5px);
            background: #f0f0f0;
        }
        
        .menu-item-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #5D5CDE;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .menu-item-text {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        /* Êé®Ëñ¶Ë°åÂãïÊ∞£Ê≥° */
        .action-bubble {
            position: fixed;
            z-index: 990;
            background: white;
            padding: 12px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 250px;
            animation: bubble-bounce 2s infinite;
        }
        
        @keyframes bubble-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .action-bubble:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .bubble-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #5D5CDE;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .bubble-text {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }
        
        .bubble-close {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            color: #666;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
        }
        
        .bubble-close:hover {
            background: rgba(0,0,0,0.2);
            color: #333;
        }

        @media (prefers-color-scheme: dark) {
            .menu-toggle {
                background: #8B4513;
            }
            
            .menu-toggle:hover {
                background: #a0522d;
            }
            
            .menu-item {
                background: #333;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            }
            
            .menu-item:hover {
                background: #444;
            }
            
            .menu-item-icon {
                background: #8B4513;
            }
            
            .menu-item-text {
                color: #eee;
            }
            
            .action-bubble {
                background: #333;
                box-shadow: 0 3px 15px rgba(0,0,0,0.4);
            }
            
            .action-bubble:hover {
                box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            }
            
            .bubble-icon {
                background: #8B4513;
            }
            
            .bubble-text {
                color: #eee;
            }
            
            .bubble-close {
                background: rgba(255,255,255,0.1);
                color: #aaa;
            }
            
            .bubble-close:hover {
                background: rgba(255,255,255,0.2);
                color: #eee;
            }
        }
        
        /* RPGÈ¢®Ê†ºÂ∞çË©±Ê°Ü */
        .rpg-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .rpg-dialog-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .rpg-dialog {
            width: 85%;
            max-width: 600px;
            background-color: rgba(20, 20, 30, 0.9);
            border: 2px solid #8B4513;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 0;
            overflow: hidden;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .rpg-dialog-overlay.active .rpg-dialog {
            transform: translateY(0);
        }
        
        .rpg-character {
            display: flex;
            align-items: center;
            background-color: rgba(139, 69, 19, 0.8);
            padding: 10px 15px;
            border-bottom: 2px solid #5D5CDE;
        }
        
        .rpg-portrait {
            font-size: 32px;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.4);
        }
        
        .rpg-name {
            color: white;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .rpg-textbox {
            padding: 25px;
            background-color: rgba(20, 20, 30, 0.95);
            color: white;
            min-height: 120px;
            position: relative;
        }
        
        .rpg-text {
            font-size: 18px;
            line-height: 1.6;
            margin: 0;
            min-height: 100px;
        }
        
        .rpg-indicator {
            position: absolute;
            right: 15px;
            bottom: 10px;
            color: #5D5CDE;
            animation: bounce 1s infinite;
            font-size: 20px;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @media (prefers-color-scheme: dark) {
            .rpg-character {
                background-color: rgba(93, 92, 222, 0.8);
                border-bottom: 2px solid #8B4513;
            }
        }

        /* ÈüøÊáâÂºèË®≠Ë®àÂ¢ûÂº∑ */
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .garden-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(7, 1fr);
            }
            
            .title {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
            
            .dialog {
                width: 95%;
            }
            
            .status-item {
                padding: 5px 10px;
            }
            
            .garden-cell {
                min-height: 70px;
            }
            
            .action-bubble {
                max-width: 200px;
            }
            
            .garden-cell.interactive,
            .garden-cell.suggested-action {
                animation: mobilePulse 2s infinite;
            }
            
            @keyframes mobilePulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            .rpg-dialog {
                width: 95%;
            }
            
            .rpg-text {
                font-size: 16px;
            }
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.3f7572448765332f3047.js"></script></head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Á¥ÖÊ®ìËàäÂ§¢¬∑ÈÇÑÊ∑öÁ∑£</h1>
            <p class="subtitle">Á•ûÁëõ‰æçËÄÖÁöÑÈÇÑÊ∑ö‰πãÊóÖ</p>
        </div>
        
        <div class="game-status">
            <div class="cycle-progress">
                <div class="cycle-progress-bar" id="cycle-progress-bar" style="width: 4.2%"></div>
            </div>
            <div class="status-item">
                <div class="status-label">
                    <span class="status-icon">üîÑ</span>Ëº™Ëø¥ÈÄ±Êúü
                </div>
                <div class="status-value" id="cycle-count">1</div>
            </div>
            <div class="status-item">
                <div class="status-label">
                    <span class="status-icon">üå±</span>ÁØÄÊ∞£
                </div>
                <div class="status-value" id="jieqi-value">Á´ãÊò•</div>
            </div>
            <div class="status-item">
                <div class="status-label">
                    <span class="status-icon">ü™®</span>ÈùàÁü≥
                </div>
                <div class="status-value" id="stone-count">5</div>
            </div>
            <div class="status-item">
                <div class="status-label">
                    <span class="status-icon">üíß</span>Áµ≥Áè†
                </div>
                <div class="status-value" id="tear-count">1</div>
            </div>
            <div class="status-item">
                <div class="status-label">
                    <span class="status-icon">üß†</span>Ë®òÊÜ∂Á¢éÁâá
                </div>
                <div class="status-value" id="memory-count">0</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="garden-area">
                <div class="garden-grid" id="garden-grid">
                    <!-- ÂãïÊÖãÁîüÊàêÂúíÊûóÊ†ºÂ≠ê -->
                </div>
            </div>
            
            <div class="control-area">
                <div class="panel" id="actions-panel">
                    <h3 class="panel-title">
                        <span class="panel-title-icon">‚ö°</span>
                        Ë°åÂãï
                        <span class="panel-help" id="actions-help">?</span>
                    </h3>
                    <div class="action-buttons">
                        <button class="action-button" id="advance-jieqi">
                            <span><span class="action-icon">üå±</span>Êé®ÈÄ≤ÁØÄÊ∞£</span>
                            <span class="action-cost"><span class="cost-icon">‚è±Ô∏è</span>Ê∂àËÄó: 0</span>
                        </button>
                        <button class="action-button" id="collect-tears">
                            <span><span class="action-icon">üíß</span>Â∞ãÊâæÁµ≥Áè†</span>
                            <span class="action-cost"><span class="cost-icon">‚è±Ô∏è</span>Á≠âÂæÖ: 0</span>
                        </button>
                        <button class="action-button" id="search-memories">
                            <span><span class="action-icon">üß†</span>Â∞ãÊâæÂØ∂ÁéâÈ†òÊÇü</span>
                            <span class="action-cost"><span class="cost-icon">üíß</span>Ê∂àËÄó: 2Áµ≥Áè†</span>
                        </button>
                    </div>
                </div>
                
                <div class="panel" id="flowers-panel">
                    <h3 class="panel-title">
                        <span class="panel-title-icon">üå∫</span>
                        Ëä±È≠Ç <span class="counter-badge" id="flower-count">0/12</span>
                        <span class="panel-help" id="flowers-help">?</span>
                    </h3>
                    <div class="flowers-list" id="flowers-list">
                        <!-- ÂãïÊÖãÁîüÊàêËä±È≠ÇÂàóË°® -->
                    </div>
                </div>
                
                <div class="panel" id="tears-panel">
                    <h3 class="panel-title">
                        <span class="panel-title-icon">üíß</span>
                        Áµ≥Áè† <span class="counter-badge" id="collected-tear-count">1/12</span>
                        <span class="panel-help" id="tears-help">?</span>
                    </h3>
                    <div class="tears-list" id="tears-list">
                        <!-- ÂãïÊÖãÁîüÊàêÊ∑öÊ∞¥ÂàóË°® -->
                    </div>
                </div>
                
                <div class="panel" id="birds-panel">
                    <h3 class="panel-title">
                        <span class="panel-title-icon">üê¶</span>
                        È≥•Èùà <span class="counter-badge" id="bird-count">0/12</span>
                        <span class="panel-help" id="birds-help">?</span>
                    </h3>
                    <div class="birds-list" id="birds-list">
                        <!-- ÂãïÊÖãÁîüÊàêÈ≥•ÈùàÂàóË°® -->
                    </div>
                </div>
                
                <div class="panel" id="memories-panel">
                    <h3 class="panel-title">
                        <span class="panel-title-icon">üß†</span>
                        Ë®òÊÜ∂Êî∂ÈõÜ <span class="counter-badge" id="collected-memory-count">0/24</span>
                        <span class="panel-help" id="memories-help">?</span>
                    </h3>
                    <div class="memories-list" id="memories-list">
                        <!-- ÂãïÊÖãÁîüÊàêË®òÊÜ∂ÂàóË°® -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Â∞çË©±Ê°ÜÊ®°Êùø -->
    <div class="dialog-overlay" id="dialog-overlay">
        <div class="dialog" id="dialog">
            <span class="dialog-close" id="dialog-close">√ó</span>
            <h3 class="dialog-title" id="dialog-title">Â∞çË©±Ê®ôÈ°å</h3>
            <div class="dialog-content" id="dialog-content">
                Â∞çË©±ÂÖßÂÆπ
            </div>
            <div class="dialog-actions">
                <button class="dialog-button secondary" id="dialog-cancel">ÂèñÊ∂à</button>
                <button class="dialog-button primary" id="dialog-confirm">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>
    
    <!-- Ë®òÊÜ∂ÈñÉÂõûÂ∞çË©±Ê°Ü -->
    <div class="dialog-overlay" id="memory-dialog-overlay">
        <div class="dialog memory-dialog" id="memory-dialog">
            <h3 class="dialog-title" id="memory-dialog-title">Ë®òÊÜ∂ÈñÉÂõû</h3>
            <div class="memory-content" id="memory-dialog-content">
                Ë®òÊÜ∂ÂÖßÂÆπ
            </div>
            <div class="dialog-actions">
                <button class="dialog-button primary" id="memory-dialog-close">ÁπºÁ∫å</button>
            </div>
        </div>
    </div>
    
    <!-- RPGÈ¢®Ê†ºÂ∞çË©±Ê°Ü -->
    <div class="rpg-dialog-overlay" id="rpg-dialog-overlay">
        <div class="rpg-dialog">
            <div class="rpg-character">
                <div class="rpg-portrait" id="rpg-portrait">üë∏</div>
                <div class="rpg-name" id="rpg-speaker">Ë≠¶Âπª‰ªôÂ≠ê</div>
            </div>
            <div class="rpg-textbox">
                <p class="rpg-text" id="rpg-text"></p>
                <div class="rpg-indicator">‚ñº</div>
            </div>
        </div>
    </div>
    
    <!-- ÁôΩËå´Ëå´ÊïàÊûú -->
    <div class="white-fade" id="white-fade">
        <div class="white-fade-text">ÁôΩËå´Ëå´Â§ßÂú∞‰∏ÄÁâáÁúü‰πæÊ∑®</div>
    </div>
    
    <!-- ÊïôÂ≠∏Á≥ªÁµ±Ë¶ÜËìãÂ±§ -->
    <div class="tutorial-overlay" id="tutorial-overlay">
        <div class="tutorial-highlight" id="tutorial-highlight"></div>
        <div class="tutorial-tooltip" id="tutorial-tooltip">
            <div class="tutorial-tooltip-title" id="tutorial-tooltip-title">
                <span class="tutorial-tooltip-icon">üí°</span>
                <span id="tutorial-title-text">Ê≠°Ëøé‰æÜÂà∞Á¥ÖÊ®ìËàäÂ§¢</span>
            </div>
            <div class="tutorial-tooltip-content" id="tutorial-tooltip-content">
                ÈÄôÊòØ‰∏ÄÂÄãÈóúÊñºË®òÊÜ∂ËàáÊ∑öÊ∞¥ÁöÑÊïÖ‰∫ã„ÄÇËÆìÊàëÂÄë‰∏ÄÊ≠•Ê≠•‰∫ÜËß£Â¶Ç‰ΩïÈáçÂª∫Â§ßËßÄÂúí„ÄÇ
            </div>
            <div class="tutorial-actions">
                <div class="tutorial-progress" id="tutorial-progress">1/8</div>
                <div>
                    <button class="tutorial-button skip" id="tutorial-skip">Ë∑≥ÈÅéÊïôÂ≠∏</button>
                    <button class="tutorial-button" id="tutorial-next">‰∏ã‰∏ÄÊ≠•</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÊèêÁ§∫ÂÆπÂô® -->
    <div class="hint-container" id="hint-container">
        <!-- ÂãïÊÖãÁîüÊàêÊèêÁ§∫ -->
    </div>
    
    <!-- ‰∏ªÈÅ∏ÂñÆÂíåÊé®Ëñ¶Ë°åÂãï -->
    <div class="main-menu" id="main-menu">
        <div class="menu-toggle" id="menu-toggle">
            <span>‚â°</span>
        </div>
        <div class="menu-items">
            <div class="menu-item" id="menu-tutorial">
                <div class="menu-item-icon">üí°</div>
                <div class="menu-item-text">ÈáçÊñ∞ÈñãÂßãÊïôÂ≠∏</div>
            </div>
            <div class="menu-item" id="menu-targets">
                <div class="menu-item-icon">üéØ</div>
                <div class="menu-item-text">Áï∂ÂâçÁõÆÊ®ô</div>
            </div>
            <div class="menu-item" id="menu-restart">
                <div class="menu-item-icon">üîÑ</div>
                <div class="menu-item-text">ÈáçÊñ∞ÈñãÂßãÈÅäÊà≤</div>
            </div>
        </div>
    </div>
    
    <!-- ÂãïÊÖãÁîüÊàêÊé®Ëñ¶Ë°åÂãïÊ∞£Ê≥° -->
    <div class="action-bubble" id="action-suggestion" style="display: none; top: 100px; left: 100px;">
        <div class="bubble-icon">üí°</div>
        <div class="bubble-text">Êé®Ëñ¶ÁöÑ‰∏ã‰∏ÄÊ≠•Ë°åÂãïÔºöÊî∂ÈõÜÁµ≥Áè†‰æÜÊæÜÁÅåËä±È≠Ç</div>
        <div class="bubble-close" id="bubble-close">√ó</div>
    </div>
    
    <script>
        // ÈÅäÊà≤Êï∏Êìö
        const gameData = {
            cycle: 1,
            jieqiIndex: 0,
            resources: {
                stone: 5,      // ÈùàÁü≥ - Áî®ÊñºÂª∫ÈÄ†Â§ßËßÄÂúíÁöÑÂª∫ÁØâÔºåÈÄöÈÅéÂ∞ãÊâæÂØ∂ÁéâÁöÑÈ†òÊÇüËÄåÁç≤Âæó
                tear: 1,       // Áµ≥Áè† - ÊûóÈªõÁéâÁöÑÊ∑öÊ∞¥ÔºåÁî®ÊñºÊæÜÁÅåËä±È≠Ç
                memory: 0
            },
            jieqi: [
                {name: "Á´ãÊò•", icon: "üå±", season: "Êò•"},
                {name: "Èõ®Ê∞¥", icon: "üåßÔ∏è", season: "Êò•"},
                {name: "È©öËüÑ", icon: "‚ö°", season: "Êò•"},
                {name: "Êò•ÂàÜ", icon: "‚òØÔ∏è", season: "Êò•"},
                {name: "Ê∏ÖÊòé", icon: "üåø", season: "Êò•"},
                {name: "Á©ÄÈõ®", icon: "üíß", season: "Êò•"},
                {name: "Á´ãÂ§è", icon: "‚òÄÔ∏è", season: "Â§è"},
                {name: "Â∞èÊªø", icon: "üåæ", season: "Â§è"},
                {name: "ËäíÁ®Æ", icon: "üë®‚Äçüåæ", season: "Â§è"},
                {name: "Â§èËá≥", icon: "üîÜ", season: "Â§è"},
                {name: "Â∞èÊöë", icon: "üî•", season: "Â§è"},
                {name: "Â§ßÊöë", icon: "üå°Ô∏è", season: "Â§è"},
                {name: "Á´ãÁßã", icon: "üçÇ", season: "Áßã"},
                {name: "ËôïÊöë", icon: "‚õÖ", season: "Áßã"},
                {name: "ÁôΩÈú≤", icon: "üí¶", season: "Áßã"},
                {name: "ÁßãÂàÜ", icon: "‚òØÔ∏è", season: "Áßã"},
                {name: "ÂØíÈú≤", icon: "‚ùÑÔ∏è", season: "Áßã"},
                {name: "ÈúúÈôç", icon: "‚ö™", season: "Áßã"},
                {name: "Á´ãÂÜ¨", icon: "üß£", season: "ÂÜ¨"},
                {name: "Â∞èÈõ™", icon: "üå®Ô∏è", season: "ÂÜ¨"},
                {name: "Â§ßÈõ™", icon: "‚ùÑÔ∏è", season: "ÂÜ¨"},
                {name: "ÂÜ¨Ëá≥", icon: "‚ö´", season: "ÂÜ¨"},
                {name: "Â∞èÂØí", icon: "ü•∂", season: "ÂÜ¨"},
                {name: "Â§ßÂØí", icon: "‚õÑ", season: "ÂÜ¨"}
            ],
            tears: [
                {
                    id: "last-tear",
                    name: "ÊúÄÂæå‰∏ÄÊª¥Ê∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâËá®ÁµÇÂâçÁöÑÊúÄÂæå‰∏ÄÊª¥Ê∑öÊ∞¥",
                    potency: 5,
                    collected: true,
                    scene: "ÈªõÁéâÂú®ÂçäÂ§¢ÂçäÈÜí‰πãÈñìÔºåÁúºËßíÊµÅ‰∏ãÊúÄÂæå‰∏ÄÊª¥Ê∏ÖÊ∑ö„ÄÇ"
                },
                {
                    id: "burial-tear",
                    name: "Ëë¨Ëä±Ê∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâËë¨Ëä±ÊôÇÁöÑÊ∑öÊ∞¥",
                    potency: 3,
                    collected: false,
                    scene: "Ëä±Ë¨ùËä±È£õÈ£õÊªøÂ§©ÔºåÁ¥ÖÊ∂àÈ¶ôÊñ∑ÊúâË™∞ÊÜêÔºü",
                    relatedMemory: "daiyu-burial"
                },
                {
                    id: "parting-tear",
                    name: "Èõ¢Âà•Ê∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâÈõ¢ÈñãÂßëËòáÔºåËàáÂØ∂ÁéâÂàùÂà•ÊôÇÁöÑÊ∑öÊ∞¥",
                    potency: 2,
                    collected: false,
                    scene: "ÈªõÁéâÈÅìÔºö\"ÂØ∂ÁéâÔºå‰Ω†Â•ΩÁîüÂú®ÂÆ∂Ë£°ÂøµÊõ∏Ôºå‰∏çË¶ÅÊÉ≥ËëóÊàë„ÄÇ\"Ë™™ËëóÔºåÁúºÊ∑ö‰∏çË¶∫ÊµÅ‰∏ã„ÄÇ",
                    relatedMemory: "first-meeting"
                },
                {
                    id: "poem-tear",
                    name: "Ë©©Ë©ûÊ∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâÂêüË©©ËêΩÊ∑öÊôÇÁöÑÊ∑öÊ∞¥",
                    potency: 3,
                    collected: false,
                    scene: "‰∏ÄÂπ¥‰∏âÁôæÂÖ≠ÂçÅÊó•ÔºåÈ¢®ÂàÄÈúúÂäçÂö¥Áõ∏ÈÄº„ÄÇÊòéÂ™öÈÆÆÂ¶çËÉΩÂπæÊôÇÔºå‰∏ÄÊúùÊºÇÊ≥äÈõ£Â∞ãË¶ì„ÄÇ",
                    relatedMemory: "daiyu-poem"
                },
                {
                    id: "jealousy-tear",
                    name: "ÈÜãÊÑèÊ∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâÂõ†ÈÜãÊÑèËÄåËêΩ‰∏ãÁöÑÊ∑öÊ∞¥",
                    potency: 2,
                    collected: false,
                    scene: "Ëé´Âè´ÈáëÁéâÂ†ÜÊàêÊ°àÔºåÂ±ïÊîæËäôËìâËªüÂçÅ‰∏â„ÄÇ\"Ë™™Âà∞Ê≠§ËôïÔºå‰∏çË¶∫Êª¥‰∏ãÊ∑ö‰æÜ„ÄÇ",
                    relatedMemory: "daiyu-jealousy"
                },
                {
                    id: "misunderstanding-tear",
                    name: "Ë™§ÊúÉÊ∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâËàáÂØ∂ÁéâÂõ†Ë™§ÊúÉËÄåÊµÅ‰∏ãÁöÑÊ∑öÊ∞¥",
                    potency: 3,
                    collected: false,
                    scene: "Êàë‰ΩïÊõæË™™ÈÅé‰∏ÄÂè•ÔºåÂçäÂè•ËºïËñÑÁöÑË©±Ôºü‰Ω†Â∞±ÊãøËëóÊàëÁöÑË©±ÂéªÂèñÁ¨ë„ÄÇ",
                    relatedMemory: "misunderstanding"
                },
                {
                    id: "promise-tear",
                    name: "ÁõüË™ìÊ∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâËàáÂØ∂ÁéâÁõüË™ìÊôÇÁöÑÊ∑öÊ∞¥",
                    potency: 4,
                    collected: false,
                    scene: "Â§©Áõ°È†≠ÔºåÊµ∑Áõ°È†≠ÔºåÂú®ÈÇ£Ë£°Êè°Âà•‰πÖÈï∑ÂÄô„ÄÇ",
                    relatedMemory: "promise-memory"
                },
                {
                    id: "destruction-tear",
                    name: "ÁÑöÁ®øÊ∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâÁÑöÊØÄË©©Á®øÊôÇÁöÑÊ∑öÊ∞¥",
                    potency: 5,
                    collected: false,
                    scene: "ÈªõÁéâÂøÉ‰∏≠Ëá™ÊÄùÈÅì:\"ÊàëÊ≠ª‰∫ÜÔºåÈÄô‰∫õÂ¢®ÂØ∂ÈÇÑÂú®ÔºåË±à‰∏çÂ§ßÁÇ∫‰∏ñ‰∫∫ÊÅ•Á¨ë„ÄÇ\"ÊñºÊòØ‰æøÂëΩ‰∏´Áí∞Â∞áÂâçÊâÄ‰Ωú‰πãË©©Á®øÁõ°Ë°åÁáíÊØÄ„ÄÇ",
                    relatedMemory: "burn-manuscripts"
                },
                {
                    id: "first-tear",
                    name: "ÂàùÈÅáÊ∑ö",
                    icon: "üíß",
                    description: "ÈªõÁéâÂàùÂà∞Ê¶ÆÂúãÂ∫úËêΩ‰∏ãÁöÑÁ¨¨‰∏ÄÊª¥Ê∑ö",
                    potency: 2,
                    collected: false,
                    scene: "ÈªõÁéâÈÅì:\"Êàë‰æÜ‰∫ÜÂπæÊó•Ôºå‰πüË¶∫ÈÄôË£°ÁöÑÊôØËá¥Â•ΩÔºåÁâ©‰ª∂Êñ∞Â•áÔºå‰∫∫‰πüÊé•È¢®„ÄÇ‰ΩÜÊàëÂ∞ë‰ªÄÈ∫º‰∏çÂ•ΩÔºåÂèàÊ≤í‰∫∫‰∏çÁñºÔºåÊÄéÈ∫ºÊç®ÂæóÂõûÂéªÂë¢„ÄÇ\"Ë™™ËëóÂ∞±ÊúâÊ∑öÁúº‰∫Ü„ÄÇ",
                    relatedMemory: "first-tear"
                }
            ],
            buildings: [
                {
                    id: "base-camp",
                    name: "Ë≠¶Âπª‰ªôÈñ£",
                    icon: "üèØ",
                    description: "Ëº™Ëø¥Ëµ∑ÈªûÔºåÁ•ûÁëõ‰æçËÄÖÁöÑÂ±ÖÊâÄ",
                    cost: {stone: 0, tear: 0},
                    unlocked: true,
                    built: true,
                    position: 12,
                    decayRate: 0,
                    status: "ÂÆåÂ•Ω"
                },
                {
                    id: "xiao-xiang",
                    name: "ÁÄüÊπòÈ§®",
                    icon: "üè†",
                    description: "ÈªõÁéâÁöÑÂ±ÖÊâÄÔºåÂõõÈù¢Áí∞Á´πÔºåÂπΩÈõÖÂà•Ëá¥",
                    cost: {stone: 10, tear: 1},
                    unlocked: true,
                    built: false,
                    position: 6,
                    decayRate: 0.2,
                    relatedFlower: "daiyu-flower",
                    status: "Êú™Âª∫ÈÄ†"
                },
                {
                    id: "yi-hong",
                    name: "ÊÄ°Á¥ÖÈô¢",
                    icon: "üè°",
                    description: "ÂØ∂ÁéâÁöÑÂ±ÖÊâÄÔºåÊ°Ç„ÄÅËñî„ÄÅÊ££Ê£†Á≠âËä±Áí∞Áπû",
                    cost: {stone: 10, tear: 1},
                    unlocked: true,
                    built: false,
                    position: 8,
                    decayRate: 0.15,
                    relatedFlower: "baoyu-flower",
                    status: "Êú™Âª∫ÈÄ†"
                },
                {
                    id: "heng-wu",
                    name: "ËòÖËï™Ëãë",
                    icon: "üè£",
                    description: "ÂØ∂ÈáµÁöÑÂ±ÖÊâÄÔºåÈ¶ôËçâÈÅçÊ§çÔºåÊ∏ÖÈõÖÂà•Ëá¥",
                    cost: {stone: 10, tear: 1},
                    unlocked: true,
                    built: false,
                    position: 16,
                    decayRate: 0.1,
                    relatedFlower: "baochai-flower",
                    status: "Êú™Âª∫ÈÄ†"
                },
                {
                    id: "hai-tang",
                    name: "Êµ∑Ê£†Á§æ",
                    icon: "üèõÔ∏è",
                    description: "ÊπòÈõ≤Â±ÖÊâÄÔºåÊ¢®Ëä±ÈñãÈÅç",
                    cost: {stone: 15, tear: 1},
                    unlocked: false,
                    built: false,
                    position: 18,
                    decayRate: 0.25,
                    relatedFlower: "xiangyun-flower",
                    status: "Êú™Ëß£Èéñ"
                },
                {
                    id: "tan-chun",
                    name: "ÁßãÁàΩÈΩã",
                    icon: "üèòÔ∏è",
                    description: "Êé¢Êò•ÁöÑÂ±ÖÊâÄÔºåÊï¥ÊΩîÁ¥†ÈõÖ",
                    cost: {stone: 15, tear: 1},
                    unlocked: false,
                    built: false,
                    position: 2,
                    decayRate: 0.2,
                    relatedFlower: "tanchun-flower",
                    status: "Êú™Ëß£Èéñ"
                }
            ],
            flowers: [
                {
                    id: "daiyu-flower",
                    name: "ËäôËìâ",
                    character: "ÊûóÈªõÁéâ",
                    icon: "üå∫",
                    description: "Â¨åËâ∑Â¶ÇÈªõÁéâÔºåËä±ÈñãÊòìÈ£ÑÈõ∂",
                    level: 0,
                    maxLevel: 5,
                    growth: 0,
                    unlocked: false,
                    position: -1,
                    needsBuilding: "xiao-xiang",
                    specialCare: "ÈúÄÁî®Ëë¨Ëä±Ê∑öÊæÜÁÅå",
                    seasonalGrowth: {Êò•: 1.5, Â§è: 1, Áßã: 0.5, ÂÜ¨: 0.2},
                    tearPreference: ["burial-tear", "destruction-tear"],
                    judgmentPoem: "ÂèØÂòÜÂÅúÊ©üÂæ∑ÔºåÂ†™ÊÜêË©†ÁµÆÊâç„ÄÇÁéâÂ∏∂Êûó‰∏≠ÊéõÔºåÈáëÁ∞™Èõ™Ë£°Âüã„ÄÇ",
                    memories: [],
                    status: "Êú™Ëß£Èéñ"
                },
                {
                    id: "baochai-flower",
                    name: "Áâ°‰∏π",
                    character: "ËñõÂØ∂Èáµ",
                    icon: "üåπ",
                    description: "ÈõçÂÆπËèØË≤¥Â¶ÇÂØ∂ÈáµÔºåÂõõÂ≠£Â∏∏Èùí",
                    level: 0,
                    maxLevel: 5,
                    growth: 0,
                    unlocked: false,
                    position: -1,
                    needsBuilding: "heng-wu",
                    specialCare: "ÈúÄÁî®ÈÜãÊÑèÊ∑öÊæÜÁÅå",
                    seasonalGrowth: {Êò•: 1, Â§è: 1, Áßã: 1, ÂÜ¨: 0.8},
                    tearPreference: ["jealousy-tear", "misunderstanding-tear"],
                    judgmentPoem: "ÂèØÂòÜÂÅúÊ©üÂæ∑ÔºåÂ†™ÊÜêË©†ÁµÆÊâç„ÄÇÁéâÂ∏∂Êûó‰∏≠ÊéõÔºåÈáëÁ∞™Èõ™Ë£°Âüã„ÄÇ",
                    memories: [],
                    status: "Êú™Ëß£Èéñ"
                },
                {
                    id: "xiangyun-flower",
                    name: "Êµ∑Ê£†",
                    character: "Âè≤ÊπòÈõ≤",
                    icon: "üå∏",
                    description: "Â¶ÇÈÜâÂ¶ÇÁó¥Â¶ÇÊπòÈõ≤ÔºåÈúÄ‰ª•ÈÖíÊ∞¥ÊæÜÁÅå",
                    level: 0,
                    maxLevel: 5,
                    growth: 0,
                    unlocked: false,
                    position: -1,
                    needsBuilding: "hai-tang",
                    specialCare: "Èõ®Â≠£ÁîüÈï∑Âä†ÈÄü",
                    seasonalGrowth: {Êò•: 1.2, Â§è: 0.8, Áßã: 1, ÂÜ¨: 0.5},
                    tearPreference: ["poem-tear", "parting-tear"],
                    judgmentPoem: "ÂØåË≤¥Âèà‰ΩïÁÇ∫ÔºüË•ÅË§ì‰πãÈñìÁà∂ÊØçÈÅï„ÄÇÂ±ïÁúºÂºîÊñúÊöâÔºåÊπòÊ±üÊ∞¥ÈÄùÊ•öÈõ≤È£õ„ÄÇ",
                    memories: [],
                    status: "Êú™Ëß£Èéñ"
                },
                {
                    id: "tanchun-flower",
                    name: "ËñîËñá",
                    character: "Êé¢Êò•",
                    icon: "üå∑",
                    description: "È¢®Âßø‰øäÈÄ∏Â¶ÇÊé¢Êò•ÔºåËá™Êúâ‰∏ÄÁï™È¢®È™®",
                    level: 0,
                    maxLevel: 5,
                    growth: 0,
                    unlocked: false,
                    position: -1,
                    needsBuilding: "tan-chun",
                    specialCare: "ÁßãÂ≠£ÈúÄÈ°çÂ§ñÁÖßÊñô",
                    seasonalGrowth: {Êò•: 1, Â§è: 1.2, Áßã: 0.7, ÂÜ¨: 0.3},
                    tearPreference: ["first-tear", "promise-tear"],
                    judgmentPoem: "ÊâçËá™Á≤æÊòéÂøóËá™È´òÔºåÁîüÊñºÊú´‰∏ñÈÅãÂÅèÊ∂à„ÄÇÊ∏ÖÊòéÊ∂ïÈÄÅÊ±üÈÇäÊúõÔºåÂçÉÈáåÊù±È¢®‰∏ÄÂ§¢ÈÅô„ÄÇ",
                    memories: [],
                    status: "Êú™Ëß£Èéñ"
                }
            ],
            birds: [
                {
                    id: "xiren-bird",
                    name: "ÂñúÈµ≤",
                    character: "Ë•≤‰∫∫",
                    icon: "üê¶",
                    description: "Âã§Âãû‰ººË•≤‰∫∫ÔºåÊØèÊó•Ëá™ÂãïÊî∂ÈõÜÊ∑öÊ∞¥",
                    level: 0,
                    unlocked: false,
                    relatedFlower: "baoyu-flower",
                    abilities: ["ÊØèÊó•Ëá™ÂãïÊî∂ÈõÜÊ∑öÊ∞¥", "È©ÖÊï£ÈÉ®ÂàÜË°∞Êïó"],
                    status: "Êú™Ëß£Èéñ"
                },
                {
                    id: "qingwen-bird",
                    name: "ÈáëÁøÖÈõÄ",
                    character: "Êô¥ÈõØ",
                    icon: "üê§",
                    description: "ÈùàÂ∑ßÂ¶ÇÊô¥ÈõØÔºåËÉΩ‰øÆÂæ©Á†¥Êêç‰πãÁâ©",
                    level: 0,
                    unlocked: false,
                    relatedFlower: "baoyu-flower",
                    abilities: ["‰øÆÂæ©Á†¥ÊêçÂª∫ÁØâ", "ÊèêÈ´òÊ∑öÊ∞¥‰øùÂ≠ò"],
                    status: "Êú™Ëß£Èéñ"
                },
                {
                    id: "pinger-bird",
                    name: "Áï´Áúâ",
                    character: "Âπ≥ÂÖí",
                    icon: "üêß",
                    description: "ÂúìËûçÂ¶ÇÂπ≥ÂÖíÔºåË™øËß£Ëä±È≠ÇË°ùÁ™Å",
                    level: 0,
                    unlocked: false,
                    relatedFlower: "baochai-flower",
                    abilities: ["Êî∂ÈõÜÈ°çÂ§ñÊ∑öÊ∞¥", "Ë™øËß£Ëä±È≠ÇË°ùÁ™Å"],
                    status: "Êú™Ëß£Èéñ"
                }
            ],
            memories: [
                // ÈªõÁéâÊµÅÊ∑öÁöÑË®òÊÜ∂ - Áî®ÊñºÁç≤ÂèñÁµ≥Áè†
                {
                    id: "daiyu-burial",
                    name: "Ëë¨Ëä±Ë®òÊÜ∂",
                    icon: "üíÆ",
                    description: "ÈªõÁéâËë¨Ëä±ÁöÑË®òÊÜ∂Á¢éÁâá",
                    collected: false,
                    requiredJieqi: "Ê∏ÖÊòé",
                    content: "Ëä±Ë¨ùËä±È£õÈ£õÊªøÂ§©ÔºåÁ¥ÖÊ∂àÈ¶ôÊñ∑ÊúâË™∞ÊÜêÔºüÊ∏∏Áµ≤ËªüÁ≥ªÈ£ÑÊò•Ê¶≠ÔºåËêΩÁµÆËºïÊ≤æÊí≤Áπ°Á∞æ„ÄÇÈñ®‰∏≠Â•≥ÂÖíÊÉúÊò•ÊöÆÔºåÊÑÅÁ∑íÊªøÊá∑ÁÑ°ÈáãËôï„ÄÇÊâãÊääËä±Èã§Âá∫Áπ°Èñ®ÔºåÂøçË∏èËêΩËä±‰æÜÂæ©Âéª„ÄÇ",
                    relatedTear: "burial-tear",
                    type: "tear"
                },
                // ÂÖ∂‰ªñË®òÊÜ∂‰øùÊåÅ‰∏çËÆä...
            ],
            cells: Array(25).fill().map((_, i) => ({
                id: i,
                type: "empty",
                buildingId: null,
                flowerId: null,
                memoryId: null,
                decayValue: 0,
                unlocked: i === 12 || [6, 7, 8, 11, 13, 16, 17, 18].includes(i)
            })),
            events: [
                {
                    id: "warning-dream",
                    title: "Ë≠¶ÂπªÂÖ•Â§¢",
                    description: "Ë≠¶Âπª‰ªôÂ≠êË®óÂ§¢ÔºåË¨õËø∞Â§ßËßÄÂúíÁöÑÂâç‰∏ñ",
                    triggered: false,
                    requiredCycle: 1,
                    requiredJieqi: "ÂÜ¨Ëá≥",
                    content: "Ë≠¶ÂπªÈÅìÔºö'Á•ûÁëõÔºå‰ªä‰Ω†Â∑≤Âõû‰æÜÔºåÊîúËëóÁµ≥Áè†ÁöÑÊúÄÂæå‰∏ÄÊª¥Ê∑öÊ∞¥„ÄÇÂ•πÂπæ‰∏ñËº™Ëø¥ÔºåÁÇ∫ÈÇÑ‰Ω†Áï∂Âπ¥ÁöÑ‰∏ÄÁõÜÊ∞¥ÔºåÊµÅÁõ°Ëê¨ÂçÉÊ∑öÊ∞¥„ÄÇÂ¶Ç‰ªä‰Ω†ÂèØÈ°òÁî®Â•πÁöÑÊ∑öÔºåÂèçÂì∫ÁúæËä±È≠ÇÔºü'"
                },
                {
                    id: "white-ground",
                    title: "ÁôΩËå´Ëå´ÁµêÂ±Ä",
                    description: "ÁµÇÊ•µÁµêÂ±ÄÔºå‰∏ÄÂàáÊ≠∏ÊñºËôõÁÑ°",
                    triggered: false,
                    requiredCycle: 3,
                    requiredJieqi: "Â§ßÂØí",
                    content: "ÁôΩËå´Ëå´Â§ßÂú∞‰∏ÄÁâáÁúü‰πæÊ∑®ÔºÅ"
                }
            ],
            suggestedActions: {
                nextBuildingId: null,  // Âª∫Ë≠∞‰∏ã‰∏ÄÊ≠•Âª∫ÈÄ†ÁöÑÂª∫ÁØâ
                nextFlowerId: null,    // Âª∫Ë≠∞‰∏ã‰∏ÄÊ≠•Á®ÆÊ§çÁöÑËä±È≠Ç
                nextAction: null       // Âª∫Ë≠∞‰∏ã‰∏ÄÊ≠•Âü∑Ë°åÁöÑÊìç‰Ωú (collect-tears, search-memories, advance-jieqi)
            },
            tutorialCompleted: false,
            tutorialStep: 0,
            idleTime: 0,              // Áî®Êà∂ÈñíÁΩÆÊôÇÈñì
            lastActionTime: Date.now() // ‰∏äÊ¨°Êìç‰ΩúÊôÇÈñì
        };
        
        // Á≠âÂæÖÈ†ÅÈù¢Âä†ËºâÂÆåÊàê
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
        });
        
        function initializeGame() {
            // ÂÆâÂÖ®Âú∞ÂàùÂßãÂåñDOMÂÖÉÁ¥†ÂºïÁî®
            const elements = {
                // Âü∫Êú¨ÁãÄÊÖãÈ°ØÁ§∫
                gardenGrid: document.getElementById('garden-grid'),
                cycleCount: document.getElementById('cycle-count'),
                jieqiValue: document.getElementById('jieqi-value'),
                tearCount: document.getElementById('tear-count'),
                stoneCount: document.getElementById('stone-count'),
                memoryCount: document.getElementById('memory-count'),
                cycleProgressBar: document.getElementById('cycle-progress-bar'),
                
                // Ë®àÊï∏Âô®
                flowerCount: document.getElementById('flower-count'),
                birdCount: document.getElementById('bird-count'),
                collectedMemoryCount: document.getElementById('collected-memory-count'),
                collectedTearCount: document.getElementById('collected-tear-count'),
                
                // ÂàóË°®ÂÆπÂô®
                flowersList: document.getElementById('flowers-list'),
                birdsList: document.getElementById('birds-list'),
                memoriesList: document.getElementById('memories-list'),
                tearsList: document.getElementById('tears-list'),
                
                // ÊåáÁ§∫Âô®ÂíåÊåâÈàï
                jieqiIndicator: document.getElementById('jieqi-indicator'),
                advanceJieqiBtn: document.getElementById('advance-jieqi'),
                collectTearsBtn: document.getElementById('collect-tears'),
                searchMemoriesBtn: document.getElementById('search-memories'),
                
                // Èù¢ÊùøÂπ´Âä©ÊåâÈàï
                actionsHelp: document.getElementById('actions-help'),
                flowersHelp: document.getElementById('flowers-help'),
                tearsHelp: document.getElementById('tears-help'),
                birdsHelp: document.getElementById('birds-help'),
                memoriesHelp: document.getElementById('memories-help'),
                
                // Â∞çË©±Ê°ÜÂÖÉÁ¥†
                dialogOverlay: document.getElementById('dialog-overlay'),
                dialog: document.getElementById('dialog'),
                dialogTitle: document.getElementById('dialog-title'),
                dialogContent: document.getElementById('dialog-content'),
                dialogClose: document.getElementById('dialog-close'),
                dialogCancel: document.getElementById('dialog-cancel'),
                dialogConfirm: document.getElementById('dialog-confirm'),
                
                // Ë®òÊÜ∂ÈñÉÂõûÂ∞çË©±Ê°Ü
                memoryDialogOverlay: document.getElementById('memory-dialog-overlay'),
                memoryDialog: document.getElementById('memory-dialog'),
                memoryDialogTitle: document.getElementById('memory-dialog-title'),
                memoryDialogContent: document.getElementById('memory-dialog-content'),
                memoryDialogClose: document.getElementById('memory-dialog-close'),
                
                // ÁôΩËå´Ëå´ÊïàÊûú
                whiteFade: document.getElementById('white-fade'),
                
                // ÊïôÂ≠∏Á≥ªÁµ±
                tutorialOverlay: document.getElementById('tutorial-overlay'),
                tutorialHighlight: document.getElementById('tutorial-highlight'),
                tutorialTooltip: document.getElementById('tutorial-tooltip'),
                tutorialTitle: document.getElementById('tutorial-title-text'),
                tutorialContent: document.getElementById('tutorial-tooltip-content'),
                tutorialProgress: document.getElementById('tutorial-progress'),
                tutorialNext: document.getElementById('tutorial-next'),
                tutorialSkip: document.getElementById('tutorial-skip'),
                
                // ÊèêÁ§∫Á≥ªÁµ±
                hintContainer: document.getElementById('hint-container'),
                
                // ‰∏ªÈÅ∏ÂñÆ
                mainMenu: document.getElementById('main-menu'),
                menuToggle: document.getElementById('menu-toggle'),
                menuTutorial: document.getElementById('menu-tutorial'),
                menuTargets: document.getElementById('menu-targets'),
                menuRestart: document.getElementById('menu-restart'),
                
                // Êé®Ëñ¶Ë°åÂãïÊ∞£Ê≥°
                actionSuggestion: document.getElementById('action-suggestion'),
                bubbleClose: document.getElementById('bubble-close')
            };
            
            try {
                // Ë®≠ÁΩÆÂàùÂßãÂª∫ÁØâ
                setupInitialBuilding();
                
                // Ê∏≤ÊüìÂúíÊûóÊ†ºÂ≠ê
                initGarden();
                
                // Êõ¥Êñ∞Ë≥áÊ∫êÈ°ØÁ§∫
                updateResourceDisplay();
                
                // Êõ¥Êñ∞ÂàóË°®
                updateLists();
                
                // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩ
                addEventListeners();
                
                // Ë®≠ÁΩÆËº™Ëø¥ÈÄ≤Â∫¶Ê¢ù
                updateCycleProgress();
                
                // È°ØÁ§∫ÈñãÂ†¥Â∞çË©±ÔºåÁ¢∫‰øù‰∏ÄÂÆöÊúÉÂü∑Ë°åÂà∞
                setTimeout(() => {
                    // Áõ¥Êé•È°ØÁ§∫ÈñãÂ†¥Â∞çË©±
                    showIntroDialog();
                    console.log("È°ØÁ§∫ÈñãÂ†¥Â∞çË©±");
                    
                    // ‰ΩøÁî®ÂÖ®Â±ÄÊ®ôË®ò‰æÜËøΩËπ§ÈñãÂ†¥Â∞çË©±ÊòØÂê¶Â∑≤Á∂ìÁµêÊùü
                    gameData.introShown = false;
                    
                    // Âú®Ë®òÊÜ∂Â∞çË©±Ê°ÜÈóúÈñâÊåâÈàï‰∏äÂ¢ûÂä†Êñ∞ÁöÑÁõ£ËÅΩÂô®
                    const setupIntroListener = function() {
                        if (elements.memoryDialogClose) {
                            console.log("Ë®ªÂÜäÈñãÂ†¥Â∞çË©±ÈóúÈñâÁõ£ËÅΩÂô®");
                            elements.memoryDialogClose.addEventListener('click', function startTutorialAfterIntro() {
                                console.log("ÈñãÂ†¥Â∞çË©±ÈóúÈñâÔºåÊ∫ñÂÇôÈñãÂßãÊïôÂ≠∏");
                                gameData.introShown = true;
                                
                                // Á®çÂæåÈñãÂßãÊïôÂ≠∏
                                setTimeout(() => {
                                    startTutorial();
                                }, 800);
                            }, { once: true });
                        } else {
                            console.log("Ë®òÊÜ∂Â∞çË©±Ê°ÜÈóúÈñâÊåâÈàï‰∏çÂ≠òÂú®Ôºå100ÊØ´ÁßíÂæåÈáçË©¶");
                            setTimeout(setupIntroListener, 100);
                        }
                    };
                    
                    // Á¢∫‰øùÂ∞çË©±Ê°ÜÂíåÊåâÈàïÂ∑≤Á∂ìÂ≠òÂú®
                    setupIntroListener();
                }, 1000);
                
                // Ê™¢Ê∏¨ÊöóÈªëÊ®°Âºè
                detectDarkMode();
                
                // ÈñãÂßãÈñíÁΩÆÊèêÁ§∫Ê™¢Êü•
                setInterval(checkIdleTime, 5000);
                
                // ÊØèÈöî‰∏ÄÊÆµÊôÇÈñìÊõ¥Êñ∞Êé®Ëñ¶Êìç‰Ωú
                setInterval(updateSuggestedActions, 10000);
            } catch (error) {
                console.error("ÈÅäÊà≤ÂàùÂßãÂåñÈåØË™§:", error);
                showHint('ÈåØË™§', 'ÈÅäÊà≤ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÂà∑Êñ∞È†ÅÈù¢ÈáçË©¶', '‚ùå');
            }
            
            // ÂàùÂßãÂåñÂúíÊûóÊ†ºÂ≠ê
            function initGarden() {
                if (!elements.gardenGrid) {
                    console.error("Êâæ‰∏çÂà∞ÂúíÊûóÊ†ºÂ≠êÂÖÉÁ¥†");
                    return;
                }
                
                elements.gardenGrid.innerHTML = '';
                
                // Âà§Êñ∑ÊòØÂê¶ÊúâÂª∫Ë≠∞ÁöÑ‰∏ã‰∏ÄÊ≠•Êìç‰Ωú
                const suggestedBuildingId = gameData.suggestedActions.nextBuildingId;
                const suggestedFlowerId = gameData.suggestedActions.nextFlowerId;
                
                gameData.cells.forEach(cell => {
                    const cellElement = document.createElement('div');
                    // Âü∫Á§éÈ°ûÂêç
                    let cellClass = `garden-cell ${!cell.unlocked ? 'unlock-required' : ''}`;
                    
                    // ÊòØÂê¶ÁÇ∫Êé®Ëñ¶Êìç‰ΩúÁöÑÊ†ºÂ≠ê
                    const isSuggestedBuildingCell = suggestedBuildingId && 
                        gameData.buildings.find(b => b.id === suggestedBuildingId)?.position === cell.id;
                    
                    if (isSuggestedBuildingCell && !cell.buildingId) {
                        cellClass += ' suggested-action';
                    }
                    
                    // Ë®≠ÁΩÆÊ†ºÂ≠êÈ°ûÂûãÈ°ûÂêç
                    if (cell.buildingId) {
                        cellClass += ' has-building';
                    } else if (cell.flowerId) {
                        cellClass += ' has-flower';
                    } else if (cell.memoryId) {
                        cellClass += ' has-memory interactive';
                    } else if (cell.unlocked && (gameData.resources.stone >= 10 || gameData.flowers.some(f => f.unlocked && f.position === -1))) {
                        // Â¶ÇÊûúÊúâË∂≥Â§†Ë≥áÊ∫êÂª∫ÈÄ†ÊàñÊúâËä±È≠ÇÂèØÁ®ÆÊ§çÔºåÊ®ôË®òÁÇ∫ÂèØ‰∫§‰∫í
                        cellClass += ' interactive';
                    }
                    
                    cellElement.className = cellClass;
                    cellElement.dataset.id = cell.id;
                    
                    // Ê†πÊìöÊ†ºÂ≠êÂÖßÂÆπË®≠ÁΩÆHTML
                    let cellHTML = '';
                    let statusText = '';
                    
                    if (cell.buildingId) {
                        const building = gameData.buildings.find(b => b.id === cell.buildingId);
                        if (building) {
                            const condition = 1 - cell.decayValue;
                            let conditionText = getConditionText(condition);
                            let statusIcon = '‚úÖ';
                            
                            if (condition < 0.5) {
                                statusIcon = '‚ö†Ô∏è';
                            }
                            
                            // Âè™ÊúâÈùûË≠¶Âπª‰ªôÈñ£Âª∫ÁØâÊâçÈ°ØÁ§∫ÁãÄÊÖãÊñáÊú¨
                            statusText = building.id !== 'base-camp' ? 
                                `<div class="cell-status"><span>${statusIcon}</span> ${conditionText}</div>` : '';
                            
                            cellHTML = `
                                <div class="building">
                                    <div class="building-icon">${building.icon}</div>
                                    <div class="building-name">${building.name}</div>
                                </div>
                                <div class="decay-overlay" style="opacity: ${cell.decayValue}">
                                    <div class="decay-icon">üï∏Ô∏è</div>
                                </div>
                                <div class="watering-effect"></div>
                                ${statusText}
                            `;
                        }
                    } else if (cell.flowerId) {
                        const flower = gameData.flowers.find(f => f.id === cell.flowerId);
                        if (flower) {
                            const growthPercent = Math.floor(flower.growth);
                            statusText = `<div class="cell-status"><span>${flower.level > 0 ? '‚ú®' : 'üå±'}</span> Lv${flower.level} (${growthPercent}%)</div>`;
                            
                            cellHTML = `
                                <div class="flower">
                                    <div class="flower-icon">${flower.icon}</div>
                                    <div class="flower-name">${flower.name}</div>
                                </div>
                                <div class="watering-effect"></div>
                                ${statusText}
                            `;
                        }
                    } else if (cell.memoryId) {
                        const memory = gameData.memories.find(m => m.id === cell.memoryId);
                        if (memory) {
                            statusText = `<div class="cell-status"><span>üí´</span> ÈªûÊìäÊî∂ÈõÜ</div>`;
                            
                            cellHTML = `
                                <div class="memory">
                                    <div class="memory-icon">${memory.icon}</div>
                                    <div class="memory-name">${memory.name}</div>
                                </div>
                                ${statusText}
                            `;
                        }
                    }
                    
                    cellElement.innerHTML = cellHTML || '';
                    
                    // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
                    cellElement.addEventListener('click', () => {
                        if (cell.unlocked) {
                            gameData.lastActionTime = Date.now(); // Êõ¥Êñ∞ÊúÄÂæåÊìç‰ΩúÊôÇÈñì
                            handleCellClick(cell);
                        } else {
                            showHint('Ê†ºÂ≠êÊú™Ëß£Èéñ', 'ÂÆåÊàêÁõÆÂâç‰ªªÂãô‰ª•Ëß£ÈéñÊõ¥Â§öÂúíÂçÄ', 'üîí');
                        }
                    });
                    
                    elements.gardenGrid.appendChild(cellElement);
                });
            }
            
            // ËôïÁêÜÊ†ºÂ≠êÈªûÊìä
            function handleCellClick(cell) {
                if (cell.buildingId) {
                    // ÈªûÊìäÂ∑≤ÊúâÂª∫ÁØâ
                    const building = gameData.buildings.find(b => b.id === cell.buildingId);
                    
                    // Ë®àÁÆóÁ∂≠‰øÆÊàêÊú¨
                    const decayValue = cell.decayValue;
                    const repairCost = Math.ceil(decayValue * 5);
                    const needsRepair = decayValue > 0.2;
                    
                    // Âà§Êñ∑ÊòØÂê¶ÊúâË∂≥Â§†Ë≥áÊ∫êÁ∂≠‰øÆ
                    const canRepair = gameData.resources.tear >= repairCost;
                    
                    showDialog({
                        title: building.name,
                        content: `
                            <p>${building.description}</p>
                            <div class="progress-container">
                                <div class="progress-label">Âª∫ÁØâÁãÄÊÖã</div>
                                <div class="progress-bar" style="width: ${(1 - cell.decayValue) * 100}%"></div>
                            </div>
                            <p style="margin-top: 15px;">ÁãÄÊÖã: ${getConditionText(1 - cell.decayValue)}</p>
                            ${needsRepair ? `<p style="margin-top: 10px; color: ${canRepair ? '#4CAF50' : '#F44336'};">Á∂≠‰øÆÈúÄË¶Å: ${repairCost} Áµ≥Áè†</p>` : ''}
                            ${building.relatedFlower ? 
                                `<p style="margin-top: 10px;">Áõ∏ÈóúËä±È≠Ç: <strong>${gameData.flowers.find(f => f.id === building.relatedFlower)?.name || 'Êú™Áü•'}</strong> (${gameData.flowers.find(f => f.id === building.relatedFlower)?.character || ''})</p>` : 
                                ''}
                        `,
                        confirmText: needsRepair ? 'Á∂≠‰øÆ' : 'ÈóúÈñâ',
                        cancelText: 'ÈóúÈñâ',
                        showCancel: needsRepair,
                        onConfirm: () => {
                            if (needsRepair) {
                                repairBuilding(cell.id);
                            } else {
                                hideDialog();
                            }
                        }
                    });
                } else if (cell.flowerId) {
                    // ÈªûÊìäÂ∑≤ÊúâËä±È≠Ç
                    const flower = gameData.flowers.find(f => f.id === cell.flowerId);
                    
                    // Ê™¢Êü•ÊòØÂê¶ÊúâÊ∑öÊ∞¥ÂèØÁî®
                    const availableTears = gameData.tears.filter(t => t.collected);
                    const canWater = availableTears.length > 0;
                    
                    // È°ØÁ§∫ÈÅ©ÂêàÁöÑÊ∑öÊ∞¥È°ûÂûã
                    let tearsHtml = '';
                    if (flower.tearPreference && flower.tearPreference.length > 0) {
                        tearsHtml = '<p style="margin-top: 10px;"><strong>ÂÅèÂ•ΩÊ∑öÊ∞¥:</strong> ';
                        flower.tearPreference.forEach((tearId, index) => {
                            const tear = gameData.tears.find(t => t.id === tearId);
                            if (tear) {
                                const isTearCollected = tear.collected;
                                tearsHtml += `<span style="color: ${isTearCollected ? '#4CAF50' : '#999'};">${tear.name}</span>${index < flower.tearPreference.length - 1 ? '„ÄÅ' : ''}`;
                            }
                        });
                        tearsHtml += '</p>';
                    }
                    
                    showDialog({
                        title: `${flower.name} (${flower.character})`,
                        content: `
                            <p>${flower.description}</p>
                            <div style="margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span>Á≠âÁ¥ö: ${flower.level}/${flower.maxLevel}</span>
                                    <span>${Math.floor(flower.growth)}%</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${(flower.growth / 100) * 100}%"></div>
                                </div>
                            </div>
                            <p><strong>ÁâπÊÆäÁÖßÊñô:</strong> ${flower.specialCare}</p>
                            <p style="margin-top: 10px;"><strong>Â≠£ÁØÄÁîüÈï∑ÈÄüÂ∫¶:</strong> 
                                Êò• ${flower.seasonalGrowth.Êò•}x ¬∑ 
                                Â§è ${flower.seasonalGrowth.Â§è}x ¬∑ 
                                Áßã ${flower.seasonalGrowth.Áßã}x ¬∑ 
                                ÂÜ¨ ${flower.seasonalGrowth.ÂÜ¨}x
                            </p>
                            ${tearsHtml}
                            <p style="margin-top: 15px;"><strong>Âà§Ë©û:</strong> <em>${flower.judgmentPoem}</em></p>
                        `,
                        confirmText: canWater ? 'ÊæÜÁÅå' : 'ÁÑ°ÂèØÁî®Ê∑öÊ∞¥',
                        cancelText: 'ÈóúÈñâ',
                        onConfirm: () => {
                            if (canWater) {
                                showWateringDialog(cell.id, flower);
                            } else {
                                hideDialog();
                                showHint('ÊèêÁ§∫', 'Ë´ãÂÖàÊî∂ÈõÜÊ∑öÊ∞¥ÔºåÂÜçÊæÜÁÅåËä±È≠Ç', 'üíß');
                            }
                        }
                    });
                } else if (cell.memoryId) {
                    // ÈªûÊìäË®òÊÜ∂Á¢éÁâá
                    const memory = gameData.memories.find(m => m.id === cell.memoryId);
                    showMemoryDialog(memory);
                    collectMemory(memory.id);
                    
                    // Êõ¥Êñ∞ÊúÄÂæåÊìç‰Ωú
                    gameData.lastActionTime = Date.now();
                    
                    // È°ØÁ§∫‰∏ÄÂÄãÊèêÁ§∫ÔºåÂÖ∑È´îÂÖßÂÆπÊ†πÊìöË®òÊÜ∂È°ûÂûã
                    if (memory.type === "tear") {
                        showHint('Êî∂ÈõÜÊ∑öÊ∞¥', `‰Ω†Áç≤Âæó‰∫Ü‰∏ÄÊª¥Áµ≥Áè†: ${gameData.tears.find(t => t.id === memory.relatedTear)?.name || 'Êú™Áü•Ê∑öÊ∞¥'}`, 'üíß');
                    } else if (memory.type === "stone") {
                        showHint('Áç≤ÂæóÈùàÁü≥', `ÂæûÂØ∂ÁéâÁöÑÈ†òÊÇü‰∏≠Áç≤Âæó‰∫Ü${memory.stoneValue}Â°äÈùàÁü≥`, 'ü™®');
                    }
                } else {
                    // ÈªûÊìäÁ©∫Ê†º
                    showBuildDialog(cell.id);
                }
            }
            
            // È°ØÁ§∫ÊæÜÁÅåÂ∞çË©±Ê°Ü - ÊîπÈÄ≤Áâà
            function showWateringDialog(cellId, flower) {
                // Áç≤ÂèñÂèØÁî®Ê∑öÊ∞¥
                const availableTears = gameData.tears.filter(t => t.collected);
                
                if (availableTears.length === 0) {
                    showMemoryDialog({
                        title: 'ÁÑ°ÂèØÁî®Ê∑öÊ∞¥',
                        content: '‰Ω†ÈúÄË¶ÅÂÖàÊî∂ÈõÜÊ∑öÊ∞¥ÊâçËÉΩÊæÜÁÅåËä±È≠Ç„ÄÇ'
                    });
                    return;
                }
                
                let dialogContent = '<h4 style="margin-bottom: 15px;">ÈÅ∏ÊìáÊ∑öÊ∞¥ÊæÜÁÅå</h4>';
                dialogContent += '<div class="build-menu">';
                
                availableTears.forEach(tear => {
                    // Ê™¢Êü•ÊòØÂê¶ÊòØÂÅèÂ•ΩÊ∑öÊ∞¥
                    const isPreferred = flower.tearPreference && flower.tearPreference.includes(tear.id);
                    const efficiencyText = isPreferred ? '<span style="color: #4CAF50;">(ÊïàÊûúÂä†ÂÄç)</span>' : '';
                    
                    // Ë®àÁÆóÊàêÈï∑È†êÊ∏¨
                    let growthPredict = tear.potency * 10;
                    if (isPreferred) growthPredict *= 2;
                    
                    // ËÄÉÊÖÆÂ≠£ÁØÄ‰øÆÊ≠£
                    const currentSeason = gameData.jieqi[gameData.jieqiIndex].season;
                    const seasonMultiplier = flower.seasonalGrowth[currentSeason] || 1;
                    growthPredict *= seasonMultiplier;
                    
                    // È°ØÁ§∫ÊòØÂê¶ÊúÉÂçáÁ¥ö
                    let levelUpText = '';
                    if (flower.growth + growthPredict >= 100 && flower.level < flower.maxLevel) {
                        levelUpText = '<span style="color: #4CAF50; font-weight: bold;">Â∞áÂçáÁ¥ö!</span>';
                    }
                    
                    // Ê†πÊìöÊòØÂê¶ÁÇ∫Êé®Ëñ¶Ê∑öÊ∞¥ÔºåÊ∑ªÂä†Êé®Ëñ¶Ê®ôË®ò
                    const isRecommended = isPreferred && tear.potency >= 3;
                    const recommendedClass = isRecommended ? 'recommended' : '';
                    
                    dialogContent += `
                        <div class="build-item ${recommendedClass}" data-tear-id="${tear.id}" data-cell-id="${cellId}">
                            <div class="build-icon">${tear.icon}</div>
                            <div class="build-name">${tear.name} ${efficiencyText}</div>
                            <div style="font-size: 11px; margin: 5px 0; color: #666;">
                                È†êË®àÊàêÈï∑: +${Math.floor(growthPredict)}% ${levelUpText}
                            </div>
                            <div class="build-cost">
                                <span class="build-cost-icon">üíß</span>ÊïàÂäõ: ${tear.potency}
                            </div>
                        </div>
                    `;
                });
                
                dialogContent += '</div>';
                
                showDialog({
                    title: 'ÈÅ∏ÊìáÊ∑öÊ∞¥ÊæÜÁÅå',
                    content: dialogContent,
                    hideButtons: true
                });
                
                // Ê∑ªÂä†Ê∑öÊ∞¥ÈªûÊìä‰∫ã‰ª∂
                document.querySelectorAll('.build-item[data-tear-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const tearId = item.dataset.tearId;
                        const cellId = parseInt(item.dataset.cellId);
                        waterFlowerWithTear(cellId, tearId);
                        hideDialog();
                    });
                });
            }
            
            // Áî®Ê∑öÊ∞¥ÊæÜÁÅåËä±È≠Ç - ÊîπÈÄ≤Áâà
            function waterFlowerWithTear(cellId, tearId) {
                const cell = gameData.cells[cellId];
                if (!cell.flowerId) return;
                
                const flower = gameData.flowers.find(f => f.id === cell.flowerId);
                const tear = gameData.tears.find(t => t.id === tearId);
                
                if (!flower || !tear) return;
                
                // Êõ¥Êñ∞ÊúÄÂæåÊìç‰ΩúÊôÇÈñì
                gameData.lastActionTime = Date.now();
                
                // È°ØÁ§∫ÊæÜÁÅåÂãïÁï´
                const cellElement = document.querySelector(`.garden-cell[data-id="${cellId}"]`);
                if (cellElement) {
                    cellElement.classList.add('watering-active');
                    
                    // ÂâµÂª∫Â§öÂÄãÊ∑öÊª¥ÂãïÁï´ÔºåÊèêÂçáË¶ñË¶∫ÊïàÊûú
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const tearDrop = document.createElement('div');
                            tearDrop.className = 'tear-drop';
                            tearDrop.textContent = 'üíß';
                            tearDrop.style.left = `${Math.random() * 70 + 15}%`;
                            tearDrop.style.top = `${Math.random() * 40}%`;
                            cellElement.appendChild(tearDrop);
                            
                            // ÁßªÈô§ÂñÆÂÄãÊ∑öÊª¥
                            setTimeout(() => {
                                if (tearDrop && tearDrop.parentNode) {
                                    tearDrop.remove();
                                }
                            }, 1500);
                        }, i * 300);
                    }
                    
                    // ÁßªÈô§ÊæÜÁÅåÁâπÊïà
                    setTimeout(() => {
                        if (cellElement) {
                            cellElement.classList.remove('watering-active');
                        }
                    }, 2000);
                }
                
                // Ë®àÁÆóÊàêÈï∑ÂÄº
                let growthIncrease = tear.potency * 10;
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÅèÂ•ΩÊ∑öÊ∞¥ÔºåÂ¶ÇÊûúÊòØÂâáÊïàÊûúÂä†ÂÄç
                const isPreferred = flower.tearPreference && flower.tearPreference.includes(tear.id);
                if (isPreferred) {
                    growthIncrease *= 2;
                }
                
                // ËÄÉÊÖÆÂ≠£ÁØÄÂΩ±Èüø
                const currentSeason = gameData.jieqi[gameData.jieqiIndex].season;
                const seasonMultiplier = flower.seasonalGrowth[currentSeason] || 1;
                growthIncrease *= seasonMultiplier;
                
                // Êõ¥Êñ∞Ëä±È≠ÇÊàêÈï∑
                const oldGrowth = flower.growth;
                flower.growth += growthIncrease;
                
                // Ê™¢Êü•ÊòØÂê¶ÂçáÁ¥ö
                let leveledUp = false;
                if (flower.growth >= 100 && flower.level < flower.maxLevel) {
                    flower.level += 1;
                    flower.growth = 0;
                    leveledUp = true;
                    
                    // Ëß£ÈéñÁõ∏ÈóúÈ≥•Èùà
                    if (flower.level >= 3) {
                        const relatedBirds = gameData.birds.filter(b => b.relatedFlower === flower.id && !b.unlocked);
                        if (relatedBirds.length > 0) {
                            relatedBirds[0].unlocked = true;
                            showMemoryDialog({
                                title: `${relatedBirds[0].name}È≥•ÈùàË¶∫ÈÜí`,
                                content: `${flower.character}ÁöÑËä±È≠ÇÂñöÈÜí‰∫Ü${relatedBirds[0].character}ÁöÑÈ≥•ÈùàÔºÅ`
                            });
                            
                            // ÊèêÁ§∫È≥•ÈùàËß£Èéñ
                            setTimeout(() => {
                                showHint('È≥•ÈùàË¶∫ÈÜí', `${relatedBirds[0].character}ÁöÑÈ≥•ÈùàÂ∑≤Ë¢´ÂñöÈÜíÔºåÂ∞áÊèê‰æõÁâπÊÆäËÉΩÂäõÔºÅ`, 'üê¶');
                            }, 2000);
                        }
                    }
                    
                    // Ëß£ÈéñË®òÊÜ∂
                    if (flower.level === flower.maxLevel) {
                        showMemoryDialog({
                            title: `${flower.character}Ë®òÊÜ∂Ë¶∫ÈÜí`,
                            content: `<div class="poem">${flower.judgmentPoem}</div><p style="margin-top: 20px;">${flower.character}ÁöÑËä±È≠ÇÂ∑≤ÂÆåÂÖ®Ë¶∫ÈÜíÔºåÂ•πÁöÑÂà§Ë©ûÊè≠Á§∫‰∫ÜÂëΩÈÅãÁöÑË¨éÂúò„ÄÇ</p>`
                        });
                    }
                }
                
                // ÁâπÊÆäÁØÄÊ∞£‰∫íÂãï
                checkSpecialInteractions(flower);
                
                // Ê∂àËÄóÊ∑öÊ∞¥ÔºàÈô§ÈùûÊòØÊ∞∏‰πÖ‰øùÂ≠òÁöÑÊúÄÂæå‰∏ÄÊª¥Ê∑öÔºâ
                if (tear.id !== 'last-tear') {
                    // ‰∏çÂØ¶ÈöõÂà™Èô§ÔºåËÄåÊòØÊ®ôË®òÁÇ∫Êú™Êî∂ÈõÜ
                    const tearIndex = gameData.tears.findIndex(t => t.id === tear.id);
                    if (tearIndex >= 0) {
                        gameData.tears[tearIndex].collected = false;
                    }
                    
                    // ‰πüÊ∏õÂ∞ëÂèØÁî®Ê∑öÊ∞¥Êï∏Èáè
                    gameData.resources.tear -= 1;
                    
                    // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                    const tearCountEl = elements.tearCount;
                    if (tearCountEl) {
                        tearCountEl.classList.add('resource-change');
                        setTimeout(() => tearCountEl.classList.remove('resource-change'), 500);
                    }
                }
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                initGarden();
                updateLists();
                
                // È°ØÁ§∫ÁµêÊûú
                let resultMessage = '';
                if (leveledUp) {
                    resultMessage = `<span style="color: #4CAF50; font-weight: bold;">${flower.name}ÂçáÁ¥ö‰∫ÜÔºÅ</span><br>Áï∂ÂâçÁ≠âÁ¥ö: ${flower.level}/${flower.maxLevel}`;
                    
                    // Â±ïÁ§∫Á≠âÁ¥öÊèêÁ§∫
                    showHint('Ëä±È≠ÇÂçáÁ¥ö', `${flower.character}ÁöÑËä±È≠ÇÂçáËá≥ ${flower.level} Á¥öÔºÅ`, '‚ú®');
                } else {
                    const growthBefore = Math.floor(oldGrowth);
                    const growthAfter = Math.floor(flower.growth);
                    resultMessage = `${flower.name}ÊàêÈï∑‰∫ÜÔºÅ<br>ÁîüÈï∑ÈÄ≤Â∫¶: ${growthBefore}% ‚Üí <span style="color: #4CAF50; font-weight: bold;">${growthAfter}%</span>`;
                    
                    // Â±ïÁ§∫ÊàêÈï∑ÊèêÁ§∫
                    showHint('Ëä±È≠ÇÊàêÈï∑', `${flower.character}ÁöÑËä±È≠ÇÊàêÈï∑‰∫Ü ${Math.floor(growthIncrease)}%ÔºÅ`, 'üå±');
                }
                
                // ‰ΩøÁî®Ë®òÊÜ∂Â∞çË©±Ê°ÜÂ±ïÁ§∫ÁµêÊûúÔºåÊõ¥ÂÖ∑Ê≤âÊµ∏ÊÑü
                showMemoryDialog({
                    title: 'Ê∑öÊ∞¥ÊæÜÁÅå',
                    content: `<div style="text-align: center;">
                        <p>‰Ω†Áî®<strong>${tear.name}</strong>ÊæÜÁÅå‰∫Ü${flower.character}ÁöÑËä±È≠Ç„ÄÇ</p>
                        <p style="margin-top: 15px;">${resultMessage}</p>
                        ${isPreferred ? '<p style="color: #4CAF50; margin-top: 15px;">ÈÄôÊòØÂ•πÂÅèÂ•ΩÁöÑÊ∑öÊ∞¥ÔºåÊïàÊûúÂä†ÂÄçÔºÅ</p>' : ''}
                        ${seasonMultiplier > 1 ? `<p style="color: #4CAF50; margin-top: 10px;">Áï∂ÂâçÂ≠£ÁØÄ (${currentSeason}) Â∞çÊ≠§Ëä±È≠ÇÊàêÈï∑ÊúâÂà©ÔºÅ</p>` : ''}
                    </div>`
                });
            }
            
            // È°ØÁ§∫Âª∫ÈÄ†Â∞çË©±Ê°Ü - ÊîπÈÄ≤Áâà
            function showBuildDialog(cellId) {
                // Êõ¥Êñ∞ÊúÄÂæåÊìç‰ΩúÊôÇÈñì
                gameData.lastActionTime = Date.now();
                
                const availableBuildings = gameData.buildings.filter(b => !b.built && b.unlocked);
                const availableFlowers = gameData.flowers.filter(f => f.unlocked && f.position === -1);
                
                let dialogContent = '<h4 style="margin-bottom: 15px;">Âª∫ÈÄ†Âª∫ÁØâ</h4>';
                
                if (availableBuildings.length > 0) {
                    dialogContent += '<div class="build-menu">';
                    availableBuildings.forEach(building => {
                        const canAfford = gameData.resources.tear >= building.cost.tear && 
                                        gameData.resources.stone >= building.cost.stone;
                        
                        // Âà§Êñ∑ÊòØÂê¶ÁÇ∫Êé®Ëñ¶Âª∫ÁØâ
                        const isRecommended = building.id === gameData.suggestedActions.nextBuildingId;
                        
                        dialogContent += `
                            <div class="build-item ${!canAfford ? 'disabled' : ''} ${isRecommended ? 'recommended' : ''}" 
                                 data-building-id="${building.id}" 
                                 data-cell-id="${cellId}">
                                <div class="build-icon">${building.icon}</div>
                                <div class="build-name">${building.name}</div>
                                <div style="font-size: 11px; margin: 5px 0; color: #666; text-align: center;">
                                    ${building.description}
                                </div>
                                <div class="build-cost">
                                    <span class="build-cost-icon">üíß</span>${building.cost.tear} Áµ≥Áè†, 
                                    <span class="build-cost-icon">ü™®</span>${building.cost.stone} ÈùàÁü≥
                                </div>
                            </div>
                        `;
                    });
                    dialogContent += '</div>';
                } else {
                    dialogContent += '<p style="text-align: center; color: #666; margin-bottom: 20px;">Êö´ÁÑ°ÂèØÂª∫ÈÄ†ÁöÑÂª∫ÁØâ</p>';
                }
                
                dialogContent += '<h4 style="margin: 20px 0 15px 0;">Á®ÆÊ§çËä±È≠Ç</h4>';
                
                if (availableFlowers.length > 0) {
                    dialogContent += '<div class="build-menu">';
                    availableFlowers.forEach(flower => {
                        const requiredBuilding = gameData.buildings.find(b => b.id === flower.needsBuilding);
                        const buildingBuilt = requiredBuilding && requiredBuilding.built;
                        
                        // Âà§Êñ∑ÊòØÂê¶ÁÇ∫Êé®Ëñ¶Ëä±È≠Ç
                        const isRecommended = flower.id === gameData.suggestedActions.nextFlowerId;
                        
                        dialogContent += `
                            <div class="build-item ${!buildingBuilt ? 'disabled' : ''} ${isRecommended ? 'recommended' : ''}" 
                                 data-flower-id="${flower.id}" 
                                 data-cell-id="${cellId}">
                                <div class="build-icon">${flower.icon}</div>
                                <div class="build-name">${flower.name} (${flower.character})</div>
                                <div style="font-size: 11px; margin: 5px 0; color: #666; text-align: center;">
                                    ${flower.description}
                                </div>
                                <div class="build-cost">
                                    ÈúÄË¶Å: ${requiredBuilding ? requiredBuilding.name : 'Êú™Áü•'} Â∑≤Âª∫ÈÄ†
                                </div>
                            </div>
                        `;
                    });
                    dialogContent += '</div>';
                } else {
                    dialogContent += '<p style="text-align: center; color: #666;">Êö´ÁÑ°ÂèØÁ®ÆÊ§çÁöÑËä±È≠Ç</p>';
                }
                
                showDialog({
                    title: 'Âª∫ÈÄ†ÈÅ∏È†Ö',
                    content: dialogContent,
                    hideButtons: true
                });
                
                // Ê∑ªÂä†Âª∫ÁØâÈªûÊìä‰∫ã‰ª∂
                document.querySelectorAll('.build-item[data-building-id]').forEach(item => {
                    if (!item.classList.contains('disabled')) {
                        item.addEventListener('click', () => {
                            const buildingId = item.dataset.buildingId;
                            const cellId = parseInt(item.dataset.cellId);
                            buildStructure(buildingId, cellId);
                            hideDialog();
                        });
                    } else {
                        // ÁÇ∫Á¶ÅÁî®È†ÖÁõÆÊ∑ªÂä†ÊèêÁ§∫ÈªûÊìä
                        item.addEventListener('click', () => {
                            const buildingId = item.dataset.buildingId;
                            const building = gameData.buildings.find(b => b.id === buildingId);
                            
                            if (building) {
                                const needsTear = gameData.resources.tear < building.cost.tear;
                                const needsStone = gameData.resources.stone < building.cost.stone;
                                
                                let resourceNeeded = '';
                                if (needsTear && needsStone) {
                                    resourceNeeded = 'Áµ≥Áè†ËàáÈùàÁü≥';
                                } else if (needsTear) {
                                    resourceNeeded = 'Áµ≥Áè†';
                                } else if (needsStone) {
                                    resourceNeeded = 'ÈùàÁü≥';
                                }
                                
                                showHint('Ë≥áÊ∫ê‰∏çË∂≥', `Âª∫ÈÄ† ${building.name} ÈúÄË¶ÅÊõ¥Â§ö${resourceNeeded}`, '‚ö†Ô∏è');
                            }
                        });
                    }
                });
                
                // Ê∑ªÂä†Ëä±È≠ÇÈªûÊìä‰∫ã‰ª∂
                document.querySelectorAll('.build-item[data-flower-id]').forEach(item => {
                    if (!item.classList.contains('disabled')) {
                        item.addEventListener('click', () => {
                            const flowerId = item.dataset.flowerId;
                            const cellId = parseInt(item.dataset.cellId);
                            plantFlower(flowerId, cellId);
                            hideDialog();
                        });
                    } else {
                        // ÁÇ∫Á¶ÅÁî®È†ÖÁõÆÊ∑ªÂä†ÊèêÁ§∫ÈªûÊìä
                        item.addEventListener('click', () => {
                            const flowerId = item.dataset.flowerId;
                            const flower = gameData.flowers.find(f => f.id === flowerId);
                            
                            if (flower) {
                                const requiredBuilding = gameData.buildings.find(b => b.id === flower.needsBuilding);
                                
                                showHint('ÁÑ°Ê≥ïÁ®ÆÊ§ç', `ÈúÄË¶ÅÂÖàÂª∫ÈÄ† ${requiredBuilding?.name || 'Áõ∏ÈóúÂª∫ÁØâ'}`, '‚ö†Ô∏è');
                            }
                        });
                    }
                });
            }
            
            // Âª∫ÈÄ†Âª∫ÁØâ - ÊîπÈÄ≤Áâà
            function buildStructure(buildingId, cellId) {
                const building = gameData.buildings.find(b => b.id === buildingId);
                if (!building || building.built) return;
                
                // Ê™¢Êü•Ë≥áÊ∫ê
                if (gameData.resources.tear < building.cost.tear || gameData.resources.stone < building.cost.stone) {
                    showMemoryDialog({
                        title: 'Ë≥áÊ∫ê‰∏çË∂≥',
                        content: 'Ê∑öÊ∞¥ÊàñÈùàÁü≥‰∏çË∂≥ÔºåÁÑ°Ê≥ïÂª∫ÈÄ†'
                    });
                    return;
                }
                
                // Êâ£Èô§Ë≥áÊ∫ê
                gameData.resources.tear -= building.cost.tear;
                gameData.resources.stone -= building.cost.stone;
                
                // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                if (building.cost.tear > 0 && elements.tearCount) {
                    elements.tearCount.classList.add('resource-change');
                    setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                }
                
                if (building.cost.stone > 0 && elements.stoneCount) {
                    elements.stoneCount.classList.add('resource-change');
                    setTimeout(() => elements.stoneCount.classList.remove('resource-change'), 500);
                }
                
                // Êõ¥Êñ∞Âª∫ÁØâÂíåÂñÆÂÖÉÊ†ºÁãÄÊÖã
                building.built = true;
                building.position = cellId;
                building.status = "ÂÆåÂ•Ω";
                gameData.cells[cellId].buildingId = buildingId;
                gameData.cells[cellId].type = 'building';
                
                // Ê™¢Êü•ÊòØÂê¶Ëß£ÈéñÁõ∏ÈóúËä±È≠Ç
                const relatedFlowers = [];
                gameData.flowers.forEach(flower => {
                    if (flower.needsBuilding === buildingId && !flower.unlocked) {
                        flower.unlocked = true;
                        flower.status = "ÂæÖÁ®ÆÊ§ç";
                        relatedFlowers.push(flower);
                        
                        // Êõ¥Êñ∞Âª∫Ë≠∞
                        if (!gameData.suggestedActions.nextFlowerId) {
                            gameData.suggestedActions.nextFlowerId = flower.id;
                        }
                    }
                });
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                initGarden();
                updateLists();
                
                // È°ØÁ§∫Âª∫ÈÄ†ÊàêÂäüÊ∂àÊÅØ
                showMemoryDialog({
                    title: `${building.name}Âª∫ÈÄ†ÂÆåÊàê`,
                    content: `
                        <div style="text-align: center;">
                            <p>${building.icon} ${building.name} Â∑≤ÊàêÂäüÂª∫ÈÄ†ÔºÅ</p>
                            <p style="margin-top: 15px;">${building.description}</p>
                            ${relatedFlowers.length > 0 ? 
                                `<p style="margin-top: 20px; color: #4CAF50;">
                                    <strong>Ëß£ÈéñËä±È≠ÇÔºö</strong> ${relatedFlowers.map(f => `${f.name} (${f.character})`).join('„ÄÅ')}
                                </p>` : 
                                ''}
                        </div>
                    `
                });
                
                // Â¶ÇÊûúËß£Èéñ‰∫ÜËä±È≠ÇÔºåÈ°ØÁ§∫ÊèêÁ§∫
                if (relatedFlowers.length > 0) {
                    setTimeout(() => {
                        showHint('Ëä±È≠ÇËß£Èéñ', `${relatedFlowers.map(f => f.character).join('„ÄÅ')}ÁöÑËä±È≠ÇÂ∑≤Ëß£ÈéñÔºÅ`, 'üå∫');
                    }, 2000);
                }
                
                // Êõ¥Êñ∞Âª∫Ë≠∞ÁöÑ‰∏ã‰∏ÄÊ≠•Êìç‰Ωú
                updateSuggestedActions();
            }
            
            // Á®ÆÊ§çËä±È≠Ç - ÊîπÈÄ≤Áâà
            function plantFlower(flowerId, cellId) {
                const flower = gameData.flowers.find(f => f.id === flowerId);
                if (!flower || flower.position !== -1) return;
                
                // Ê™¢Êü•Â∞çÊáâÂª∫ÁØâÊòØÂê¶Â∑≤Âª∫ÈÄ†
                const requiredBuilding = gameData.buildings.find(b => b.id === flower.needsBuilding);
                if (requiredBuilding && !requiredBuilding.built) {
                    showMemoryDialog({
                        title: 'ÁÑ°Ê≥ïÁ®ÆÊ§ç',
                        content: `ÈúÄË¶ÅÂÖàÂª∫ÈÄ†${requiredBuilding.name}`
                    });
                    return;
                }
                
                // Êõ¥Êñ∞Ëä±È≠ÇÂíåÂñÆÂÖÉÊ†ºÁãÄÊÖã
                flower.position = cellId;
                flower.status = "ÁîüÈï∑‰∏≠";
                gameData.cells[cellId].flowerId = flowerId;
                gameData.cells[cellId].type = 'flower';
                
                // Âà∑Êñ∞UI
                initGarden();
                updateLists();
                
                // È°ØÁ§∫Á®ÆÊ§çÊàêÂäüÂãïÁï´
                const cellElement = document.querySelector(`.garden-cell[data-id="${cellId}"]`);
                if (cellElement) {
                    cellElement.classList.add('flashback');
                    setTimeout(() => {
                        cellElement.classList.remove('flashback');
                    }, 3000);
                }
                
                // È°ØÁ§∫Á®ÆÊ§çÊàêÂäüÂ∞çË©±Ê°Ü
                showMemoryDialog({
                    title: `${flower.name}Â∑≤Á®ÆÊ§ç`,
                    content: `
                        <div style="text-align: center;">
                            <p>${flower.icon} ${flower.character}ÁöÑËä±È≠ÇÂ∑≤Á®Æ‰∏ãÔºÅ</p>
                            <p style="margin-top: 15px;">ÁèæÂú®ÈúÄË¶ÅÁî®Ê∑öÊ∞¥ÊæÜÁÅå‰æÜÂñöÈÜíÂ•πÁöÑË®òÊÜ∂„ÄÇ</p>
                            <p style="margin-top: 20px; color: #5D5CDE;">
                                <strong>ÊèêÁ§∫Ôºö</strong> ${flower.specialCare}
                            </p>
                            <p style="margin-top: 15px; font-style: italic; color: #666;">
                                ÂÅèÂ•ΩÊ∑öÊ∞¥ÂèØ‰ΩøÊàêÈï∑ÈÄüÂ∫¶Âä†ÂÄçÔºÅ
                            </p>
                        </div>
                    `
                });
                
                // ÊèêÁ§∫‰∏ã‰∏ÄÊ≠•ÊæÜÁÅå
                setTimeout(() => {
                    showHint('ÊèêÁ§∫', `ÂòóË©¶Áî®Áµ≥Áè†ÊæÜÁÅå${flower.character}ÁöÑËä±È≠Ç`, 'üíß');
                }, 2000);
                
                // Êõ¥Êñ∞Êé®Ëñ¶ÁöÑ‰∏ã‰∏ÄÊ≠•Ë°åÂãï
                gameData.suggestedActions.nextFlowerId = null;
                
                // Â¶ÇÊûúÈÇÑÊ≤íÊúâÂª∫Ë≠∞ÁöÑÊìç‰ΩúÔºåÂª∫Ë≠∞Êî∂ÈõÜÊ∑öÊ∞¥
                if (!gameData.suggestedActions.nextAction) {
                    gameData.suggestedActions.nextAction = 'collect-tears';
                }
            }
            
            // ‰øÆÂæ©Âª∫ÁØâ - ÊîπÈÄ≤Áâà
            function repairBuilding(cellId) {
                const cell = gameData.cells[cellId];
                if (!cell.buildingId) return;
                
                // Ë®àÁÆó‰øÆÂæ©ÊàêÊú¨
                const decayValue = cell.decayValue;
                const repairCost = Math.ceil(decayValue * 5);
                
                // Ê™¢Êü•Ë≥áÊ∫ê
                if (gameData.resources.tear < repairCost) {
                    showMemoryDialog({
                        title: 'Ê∑öÊ∞¥‰∏çË∂≥',
                        content: `<div style="text-align: center;">
                            <p>‰øÆÂæ©ÈúÄË¶Å ${repairCost} Áµ≥Áè†Ôºå‰ΩÜ‰Ω†Âè™Êúâ ${gameData.resources.tear} Áµ≥Áè†</p>
                            <p style="margin-top: 15px; color: #5D5CDE;">
                                ÊèêÁ§∫: ‰ΩøÁî®„ÄåÂ∞ãÊâæÁµ≥Áè†„ÄçÊåâÈàïÊî∂ÈõÜÊõ¥Â§öÊ∑öÊ∞¥
                            </p>
                        </div>`
                    });
                    return;
                }
                
                // Êâ£Èô§Ë≥áÊ∫ê
                gameData.resources.tear -= repairCost;
                
                // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                if (elements.tearCount) {
                    elements.tearCount.classList.add('resource-change');
                    setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                }
                
                // ‰øÆÂæ©Âª∫ÁØâ
                cell.decayValue = 0;
                
                // Êõ¥Êñ∞Âª∫ÁØâÁãÄÊÖã
                const building = gameData.buildings.find(b => b.id === cell.buildingId);
                if (building) {
                    building.status = "ÂÆåÂ•Ω";
                }
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                initGarden();
                
                // È°ØÁ§∫ÊàêÂäüÂãïÁï´
                const cellElement = document.querySelector(`.garden-cell[data-id="${cellId}"]`);
                if (cellElement) {
                    cellElement.classList.add('flashback');
                    setTimeout(() => {
                        cellElement.classList.remove('flashback');
                    }, 2000);
                }
                
                showMemoryDialog({
                    title: '‰øÆÂæ©ÂÆåÊàê',
                    content: `<div style="text-align: center;">
                        <p>Âª∫ÁØâÂ∑≤ÊÅ¢Âæ©ÂæÄÊó•ÂÖâÂΩ©ÔºÅ</p>
                        <p style="margin-top: 15px; color: #4CAF50;">
                            Ê∂àËÄó: ${repairCost} Áµ≥Áè†
                        </p>
                    </div>`
                });
                
                // ÊèêÁ§∫‰øÆÂæ©ÊàêÂäü
                showHint('Âª∫ÁØâ‰øÆÂæ©', `${building?.name || 'Âª∫ÁØâ'}Â∑≤ÊÅ¢Âæ©ÂÆåÂ•ΩÁãÄÊÖã`, 'üî®');
            }
            
            // Ê™¢Êü•ÁâπÊÆäÁØÄÊ∞£‰∫íÂãï
            function checkSpecialInteractions(flower) {
                const currentJieqi = gameData.jieqi[gameData.jieqiIndex].name;
                
                // ÈªõÁéâËä±È≠ÇÂú®Ê∏ÖÊòé‰∫íÂãï
                if (flower.id === 'daiyu-flower' && currentJieqi === 'Ê∏ÖÊòé' && flower.level >= 2) {
                    const memory = gameData.memories.find(m => m.id === 'daiyu-burial');
                    if (memory && !memory.collected) {
                        memory.collected = true;
                        gameData.resources.memory += 1;
                        
                        // ‰πüÁç≤ÂæóÁâπÊÆäÊ∑öÊ∞¥ - Ëë¨Ëä±Ê∑ö
                        const tear = gameData.tears.find(t => t.id === 'burial-tear');
                        if (tear && !tear.collected) {
                            tear.collected = true;
                            gameData.resources.tear += 1;
                            
                            // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                            if (elements.tearCount) {
                                elements.tearCount.classList.add('resource-change');
                                setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                            }
                            
                            showMemoryDialog({
                                title: 'Ëë¨Ëä±Ë®òÊÜ∂ËàáÊ∑öÊ∞¥',
                                content: `<div class="poem">${memory.content}</div>
                                <p style="margin-top: 20px; text-align: center; color: #5D5CDE;">
                                    ‰Ω†Êî∂ÈõÜÂà∞‰∫Ü„ÄêËë¨Ëä±Ê∑ö„ÄëÔºåÈÄôÊòØÈªõÁéâÂú®Ëë¨Ëä±ÊôÇÊµÅ‰∏ãÁöÑÊ∑öÊ∞¥„ÄÇ
                                </p>`
                            });
                            
                            // ÊèêÁ§∫Áç≤ÂæóÁâπÊÆäÊ∑öÊ∞¥
                            setTimeout(() => {
                                showHint('ÁâπÊÆäÊ∑öÊ∞¥', 'Áç≤Âæó„ÄåËë¨Ëä±Ê∑ö„ÄçÔºåÈÄôÊòØÈªõÁéâËë¨Ëä±ÊôÇÁöÑÊ∑öÊ∞¥', 'üíß');
                            }, 2000);
                        }
                    }
                }
                
                // ÂÖ∂‰ªñËä±È≠ÇËàáË®òÊÜ∂„ÄÅÊ∑öÊ∞¥ÁöÑ‰∫íÂãï
                gameData.memories.forEach(memory => {
                    if (memory.requiredJieqi === currentJieqi && !memory.collected && flower.level >= 2) {
                        // Ê™¢Êü•ÊòØÂê¶ÊúâÈóúËÅØÁöÑÊ∑öÊ∞¥
                        if (memory.relatedTear) {
                            const tear = gameData.tears.find(t => t.id === memory.relatedTear);
                            if (tear && !tear.collected) {
                                tear.collected = true;
                                gameData.resources.tear += 1;
                                memory.collected = true;
                                gameData.resources.memory += 1;
                                
                                // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                                if (elements.tearCount) {
                                    elements.tearCount.classList.add('resource-change');
                                    setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                                }
                                
                                showMemoryDialog({
                                    title: `${memory.name}ËàáÊ∑öÊ∞¥`,
                                    content: `<div class="poem">${memory.content}</div>
                                    <p style="margin-top: 20px; text-align: center; color: #5D5CDE;">
                                        ‰Ω†Êî∂ÈõÜÂà∞‰∫Ü„Äê${tear.name}„ÄëÔºåÈÄôÊòØÈªõÁéâÂú®Ê≠§Â†¥ÊôØ‰∏≠ÊµÅ‰∏ãÁöÑÊ∑öÊ∞¥„ÄÇ
                                    </p>`
                                });
                                
                                // ÊèêÁ§∫Áç≤ÂæóÁâπÊÆäÊ∑öÊ∞¥
                                setTimeout(() => {
                                    showHint('ÁâπÊÆäÊ∑öÊ∞¥', `Áç≤Âæó„Äå${tear.name}„ÄçÔºå‰∏ÄÁ®ÆÁèçË≤¥ÁöÑÊ∑öÊ∞¥`, 'üíß');
                                }, 2000);
                            }
                        }
                    }
                });
            }
            
            // Êî∂ÈõÜË®òÊÜ∂Á¢éÁâá - ÊîπÈÄ≤Áâà
            function collectMemory(memoryId) {
                const memory = gameData.memories.find(m => m.id === memoryId);
                if (!memory || memory.collected) return;
                
                memory.collected = true;
                gameData.resources.memory += 1;
                
                // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                if (elements.memoryCount) {
                    elements.memoryCount.classList.add('resource-change');
                    setTimeout(() => elements.memoryCount.classList.remove('resource-change'), 500);
                }
                
                // Ê†πÊìöË®òÊÜ∂È°ûÂûãÊèê‰æõ‰∏çÂêåÁöÑË≥áÊ∫ê
                if (memory.type === "tear" && memory.relatedTear) {
                    // Â¶ÇÊûúÊòØÊ∑öÊ∞¥È°ûË®òÊÜ∂ÔºåÊèê‰æõÁµ≥Áè†
                    const tear = gameData.tears.find(t => t.id === memory.relatedTear);
                    if (tear && !tear.collected) {
                        tear.collected = true;
                        gameData.resources.tear += 1;
                        
                        // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                        if (elements.tearCount) {
                            elements.tearCount.classList.add('resource-change');
                            setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                        }
                        
                        // ÊèêÁ§∫Áç≤Âæó‰∫ÜÁµ≥Áè†
                        showMemoryDialog({
                            title: `${memory.name}ËàáÁµ≥Áè†`,
                            content: `<div class="poem">${memory.content}</div>
                            <p style="margin-top: 20px; text-align: center; color: #5D5CDE;">
                                ‰Ω†Êî∂ÈõÜÂà∞‰∫Ü„Äê${tear.name}„ÄëÔºåÈÄôÊòØÈªõÁéâÂú®Ê≠§Â†¥ÊôØ‰∏≠ÊµÅ‰∏ãÁöÑÁµ≥Áè†„ÄÇ
                            </p>`
                        });
                    }
                } else if (memory.type === "stone" && memory.stoneValue) {
                    // Â¶ÇÊûúÊòØÈùàÁü≥È°ûË®òÊÜ∂ÔºåÊèê‰æõÈùàÁü≥
                    gameData.resources.stone += memory.stoneValue;
                    
                    // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                    if (elements.stoneCount) {
                        elements.stoneCount.classList.add('resource-change');
                        setTimeout(() => elements.stoneCount.classList.remove('resource-change'), 500);
                    }
                    
                    // ÊèêÁ§∫Áç≤Âæó‰∫ÜÈùàÁü≥
                    showMemoryDialog({
                        title: `${memory.name}`,
                        content: `<div class="poem">${memory.content}</div>
                        <p style="margin-top: 20px; text-align: center; color: #5D5CDE;">
                            ‰Ω†ÂæûÂØ∂ÁéâÁöÑÈ†òÊÇü‰∏≠Áç≤Âæó‰∫Ü ${memory.stoneValue} Â°äÈùàÁü≥ÔºåÂèØÁî®ÊñºÈáçÂª∫Â§ßËßÄÂúí„ÄÇ
                        </p>`
                    });
                    
                    // Â¶ÇÊûúÈÇÑÊ≤íÊúâÂª∫Ë≠∞ÁöÑ‰∏ã‰∏ÄÊ≠•Âª∫ÁØâÔºå‰∏îÊúâÊú™Âª∫ÈÄ†ÁöÑÂª∫ÁØâ
                    if (!gameData.suggestedActions.nextBuildingId) {
                        const buildableBuildings = gameData.buildings.filter(b => !b.built && b.unlocked);
                        if (buildableBuildings.length > 0) {
                            gameData.suggestedActions.nextBuildingId = buildableBuildings[0].id;
                        }
                    }
                } else {
                    // ÊôÆÈÄöË®òÊÜ∂ÔºåÊ≤íÊúâÁâπÊÆäÁçéÂãµ
                    showMemoryDialog({
                        title: memory.name,
                        content: `<div class="poem">${memory.content}</div>`
                    });
                }
                
                // ÁßªÈô§Ë®òÊÜ∂Á¢éÁâá
                const memoryCell = gameData.cells.find(c => c.memoryId === memoryId);
                if (memoryCell) {
                    memoryCell.memoryId = null;
                    memoryCell.type = 'empty';
                }
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                initGarden();
                updateLists();
            }
            
            // Êé®ÈÄ≤ÁØÄÊ∞£ - ÊîπÈÄ≤Áâà
            function advanceJieqi() {
                // Êõ¥Êñ∞ÊúÄÂæåÊìç‰ΩúÊôÇÈñì
                gameData.lastActionTime = Date.now();
                
                // Â¢ûÂä†ÁØÄÊ∞£ÊåáÊï∏
                const oldJieqi = gameData.jieqi[gameData.jieqiIndex];
                gameData.jieqiIndex = (gameData.jieqiIndex + 1) % 24;
                const newJieqi = gameData.jieqi[gameData.jieqiIndex];
                
                // Êí≠ÊîæÁØÄÊ∞£ËÆäÂåñÂãïÁï´
                const jieqiIcon = document.querySelector('.jieqi-icon');
                const jieqiIndicator = document.querySelector('#jieqi-indicator');
                
                if (jieqiIcon && jieqiIndicator) {
                    jieqiIcon.textContent = newJieqi.icon;
                    jieqiIndicator.textContent = newJieqi.name;
                    jieqiIcon.classList.add('jieqi-change');
                    jieqiIndicator.classList.add('jieqi-change');
                    
                    setTimeout(() => {
                        jieqiIcon.classList.remove('jieqi-change');
                        jieqiIndicator.classList.remove('jieqi-change');
                    }, 1000);
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÈÄ≤ÂÖ•Êñ∞Ëº™Ëø¥
                if (gameData.jieqiIndex === 0) {
                    gameData.cycle += 1;
                    if (elements.cycleCount) {
                        elements.cycleCount.textContent = gameData.cycle;
                        elements.cycleCount.classList.add('resource-change');
                        setTimeout(() => elements.cycleCount.classList.remove('resource-change'), 500);
                    }
                    
                    // Ëº™Ëø¥ÈñãÂßãÊèêÁ§∫
                    showMemoryDialog({
                        title: `Á¨¨${gameData.cycle}Ëº™Ëº™Ëø¥ÈñãÂßã`,
                        content: `<div style="text-align: center;">
                            <p>ÊôÇÂÖâÊµÅËΩâÔºåËê¨Áâ©Ê≠∏Èõ∂ÂèàÂæ©Âßã„ÄÇ</p>
                            <p style="margin-top: 15px;">Êñ∞ÁöÑËº™Ëø¥Â∑≤Á∂ìÈñãÂßãÔºå‰Ω†‰ªçÂú®Áî®Ê∑öÊ∞¥ËàáÁÑ°Â∏∏Ë≥ΩË∑ë...</p>
                            ${gameData.cycle > 1 ? `<p style="margin-top: 20px; color: #5D5CDE;">
                                ‰Ω†Â∑≤ÂÆåÊàê ${gameData.cycle - 1} Ëº™Ëº™Ëø¥ÔºåÁπºÁ∫åÊî∂ÈõÜË®òÊÜ∂ËàáÊ∑öÊ∞¥ÔºåÂñöÈÜíÊõ¥Â§öËä±È≠Ç„ÄÇ
                            </p>` : ''}
                        </div>`
                    });
                    
                    // Á¨¨‰∏âËº™ÂæåÁµêÊùüÈÅäÊà≤
                    if (gameData.cycle >= 3 && gameData.jieqiIndex === 23) {
                        setTimeout(() => {
                            triggerWhiteFade();
                        }, 5000);
                    }
                } else {
                    // ‰∏ÄËà¨ÁØÄÊ∞£ËÆäÂåñÊèêÁ§∫
                    showHint('ÁØÄÊ∞£ËÆäÂåñ', `${oldJieqi.name} ‚ûù ${newJieqi.name} (${newJieqi.season}Â≠£)`, newJieqi.icon);
                }
                
                // Êõ¥Êñ∞ÁØÄÊ∞£È°ØÁ§∫
                const currentJieqi = gameData.jieqi[gameData.jieqiIndex];
                if (elements.jieqiValue) {
                    elements.jieqiValue.textContent = currentJieqi.name;
                }
                
                // Êõ¥Êñ∞Ëº™Ëø¥ÈÄ≤Â∫¶
                updateCycleProgress();
                
                // Âª∫ÁØâË°∞Êïó
                gameData.cells.forEach(cell => {
                    if (cell.buildingId) {
                        const building = gameData.buildings.find(b => b.id === cell.buildingId);
                        if (building && building.id !== 'base-camp') {
                            const oldDecayValue = cell.decayValue;
                            cell.decayValue = Math.min(1, cell.decayValue + building.decayRate / 24);
                            
                            // Â¶ÇÊûúË°∞ÊïóÁ®ãÂ∫¶È°ØËëóÂ¢ûÂä†ÔºåÊèêÁ§∫Áé©ÂÆ∂
                            if (cell.decayValue > 0.5 && oldDecayValue <= 0.5) {
                                showHint('Âª∫ÁØâË°∞Êïó', `${building.name}ÈñãÂßãÊòéÈ°ØÊêçÂ£ûÔºåË´ãËÄÉÊÖÆÁ∂≠‰øÆ`, 'üèöÔ∏è');
                            }
                            
                            // Êõ¥Êñ∞Âª∫ÁØâÁãÄÊÖã
                            building.status = getConditionText(1 - cell.decayValue);
                        }
                    }
                });
                
                // Ëä±È≠ÇÁîüÈï∑ÔºàÂ∞ëÈáèË¢´ÂãïÁîüÈï∑Ôºâ
                gameData.flowers.forEach(flower => {
                    if (flower.position !== -1) {
                        const oldGrowth = flower.growth;
                        const season = currentJieqi.season;
                        const growthRate = flower.seasonalGrowth[season] || 0.5;
                        const growthIncrease = growthRate * 2;
                        flower.growth = Math.min(100, flower.growth + growthIncrease);
                        
                        // Â≠£ÁØÄÁâπÂà•ÈÅ©ÂêàÊôÇÊèêÁ§∫
                        if (growthRate > 1 && flower.growth > oldGrowth + 1) {
                            showHint('Ëä±È≠ÇÊàêÈï∑', `${currentJieqi.season}Â≠£ÊúâÂà©Êñº${flower.character}ÁöÑËä±È≠ÇÁîüÈï∑`, 'üå±');
                        }
                        
                        // Ê™¢Êü•ÊòØÂê¶ÂçáÁ¥ö
                        if (flower.growth >= 100 && flower.level < flower.maxLevel) {
                            flower.level += 1;
                            flower.growth = 0;
                            
                            showHint('Ëä±È≠ÇÂçáÁ¥ö', `${flower.character}ÁöÑËä±È≠ÇËá™ÁÑ∂ÂçáÁ¥öÂà∞ Lv${flower.level}ÔºÅ`, '‚ú®');
                            
                            // Ëß£ÈéñÁõ∏ÈóúÈ≥•Èùà
                            if (flower.level >= 3) {
                                const relatedBirds = gameData.birds.filter(b => b.relatedFlower === flower.id && !b.unlocked);
                                if (relatedBirds.length > 0) {
                                    relatedBirds[0].unlocked = true;
                                    showMemoryDialog({
                                        title: `${relatedBirds[0].name}È≥•ÈùàË¶∫ÈÜí`,
                                        content: `${flower.character}ÁöÑËä±È≠ÇÂñöÈÜí‰∫Ü${relatedBirds[0].character}ÁöÑÈ≥•ÈùàÔºÅ`
                                    });
                                }
                            }
                        }
                    }
                });
                
                // È≥•ÈùàÊïàÊûú - Ëá™ÂãïÊî∂ÈõÜÊ∑öÊ∞¥
                const activeCollectorBirds = gameData.birds.filter(b => b.unlocked && 
                    (b.id === 'xiren-bird' || b.id === 'pinger-bird'));
                
                if (activeCollectorBirds.length > 0) {
                    const tearGain = activeCollectorBirds.length;
                    gameData.resources.tear += tearGain;
                    
                    // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                    if (elements.tearCount) {
                        elements.tearCount.classList.add('resource-change');
                        setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                    }
                    
                    showHint('È≥•ÈùàÊïàÊûú', `È≥•ÈùàËá™ÂãïÊî∂ÈõÜ‰∫Ü ${tearGain} Êª¥Áµ≥Áè†`, 'üê¶');
                }
                
                // Èö®Ê©üÁîüÊàêË®òÊÜ∂Á¢éÁâá
                if (Math.random() < 0.3) {
                    spawnMemory();
                }
                
                // Ê™¢Êü•ÊòØÂê¶Ëß∏Áôº‰∫ã‰ª∂
                checkEvents();
                
                // Âà∑Êñ∞UI
                initGarden();
                updateLists();
                updateResourceDisplay();
                
                // Êõ¥Êñ∞Âª∫Ë≠∞Êìç‰Ωú
                updateSuggestedActions();
            }
            
            // Êî∂ÈõÜÁµ≥Áè† - ÊîπÈÄ≤Áâà
            function collectTears() {
                // Êõ¥Êñ∞ÊúÄÂæåÊìç‰ΩúÊôÇÈñì
                gameData.lastActionTime = Date.now();
                
                // Ë®òÈåÑÊåâÈàïÈªûÊìäÈ°ûÂûãÔºåÁî®ÊñºÂºïÂ∞éÁîüÊàêÁõ∏ÊáâÈ°ûÂûãÁöÑË®òÊÜ∂Á¢éÁâá
                try {
                    localStorage.setItem('lastButtonClicked', 'collect-tears');
                } catch (e) {
                    console.log("ÁÑ°Ê≥ïÂ≠òÂÑ≤ÊåâÈàïÈªûÊìä‰ø°ÊÅØ:", e);
                }
                
                // Ë®àÁÆóÂü∫Á§éÁç≤ÂèñÈáè
                let tearGain = 1;
                
                // Ê†πÊìöÁï∂ÂâçÁØÄÊ∞£Âà§Êñ∑È°çÂ§ñÊïàÊûú
                const currentJieqi = gameData.jieqi[gameData.jieqiIndex];
                let seasonalBonus = false;
                
                // Âú®Èõ®Ê∞¥„ÄÅÁ©ÄÈõ®„ÄÅÊ¢ÖÈõ®Á≠âÁØÄÊ∞£ÊúâÈ°çÂ§ñÁµ≥Áè†
                if (['Èõ®Ê∞¥', 'Á©ÄÈõ®', 'ÁôΩÈú≤', 'Â∞èÈõ™', 'Â§ßÈõ™'].includes(currentJieqi.name)) {
                    tearGain += 1;
                    seasonalBonus = true;
                }
                
                // È≥•ÈùàÂä†Êàê
                const activeBirds = gameData.birds.filter(bird => bird.unlocked);
                let birdBonus = false;
                if (activeBirds.length > 0) {
                    tearGain += activeBirds.length;
                    birdBonus = true;
                }
                
                // Â¢ûÂä†Ë≥áÊ∫ê
                gameData.resources.tear += tearGain;
                
                // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                if (elements.tearCount) {
                    elements.tearCount.classList.add('resource-change');
                    setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                }
                
                // Êü•ÊâæÊú™Êî∂ÈõÜÁöÑÊ∑öÊ∞¥
                const uncollectedTears = gameData.tears.filter(t => !t.collected);
                let foundSpecialTear = false;
                
                if (uncollectedTears.length > 0 && Math.random() < 0.3) {
                    // Èö®Ê©üÈÅ∏Êìá‰∏ÄÁ®ÆÊ∑öÊ∞¥Êî∂ÈõÜ
                    const randomTear = uncollectedTears[Math.floor(Math.random() * uncollectedTears.length)];
                    randomTear.collected = true;
                    foundSpecialTear = true;
                    
                    // È°ØÁ§∫ÁâπÊÆäÊèêÁ§∫
                    showMemoryDialog({
                        title: 'ÁâπÊÆäÁµ≥Áè†Êî∂ÈõÜ',
                        content: `<div style="text-align: center;">
                            <p>‰Ω†Âú®Â§ßËßÄÂúí‰∏≠Â∞ãÊâæÂà∞‰∫Ü‰∏ÄÁ®ÆÁâπÊÆäÁöÑÊ∑öÊ∞¥Ôºö</p>
                            <p style="margin: 15px 0; font-size: 20px; color: #5D5CDE;">
                                <strong>${randomTear.icon} ${randomTear.name}</strong>
                            </p>
                            <div class="poem">
                                ${randomTear.scene}
                            </div>
                            <p style="margin-top: 15px; font-style: italic; color: #666;">
                                ÈÄôÁ®ÆÊ∑öÊ∞¥Â∞çÁâπÂÆöËä±È≠ÇÊúâÂä†ÂÄçÊïàÊûú
                            </p>
                        </div>`
                    });
                    
                    // ÊèêÁ§∫ÁâπÊÆäÊ∑öÊ∞¥Êî∂ÈõÜ
                    setTimeout(() => {
                        showHint('ÁâπÊÆäÊ∑öÊ∞¥', `Êî∂ÈõÜÂà∞„Äå${randomTear.name}„ÄçÔºåÊü•ÁúãÊ∑öÊ∞¥ÂàóË°®‰∫ÜËß£Ë©≥ÊÉÖ`, '‚ú®');
                    }, 2000);
                } else {
                    // È°ØÁ§∫ÊôÆÈÄöÊî∂ÈõÜÊèêÁ§∫
                    showMemoryDialog({
                        title: 'Áµ≥Áè†Êî∂ÈõÜ',
                        content: `<div style="text-align: center;">
                            <p>‰Ω†Âú®Â§ßËßÄÂúí‰∏≠Êî∂ÈõÜ‰∫Ü ${tearGain} Êª¥Áµ≥Áè†</p>
                            ${seasonalBonus ? `<p style="margin-top: 10px; color: #4CAF50;">Áï∂ÂâçÁØÄÊ∞£ (${currentJieqi.name}) ‰ΩøÊ∑öÊ∞¥Êõ¥ÂÆπÊòìÊî∂ÈõÜ</p>` : ''}
                            ${birdBonus ? `<p style="margin-top: 10px; color: #4CAF50;">È≥•ÈùàÂπ´Âä©Êî∂ÈõÜ‰∫ÜÈ°çÂ§ñÁöÑÊ∑öÊ∞¥</p>` : ''}
                        </div>`
                    });
                    
                    // ÊèêÁ§∫‰∏ÄËà¨Ê∑öÊ∞¥Êî∂ÈõÜ
                    showHint('Áµ≥Áè†Êî∂ÈõÜ', `Áç≤Âæó‰∫Ü ${tearGain} Êª¥Áµ≥Áè†ÔºåÂèØÁî®ÊñºÊæÜÁÅåËä±È≠ÇÊàñÂª∫ÈÄ†Âª∫ÁØâ`, 'üíß');
                }
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                updateLists();
                
                // Êõ¥Êñ∞Âª∫Ë≠∞Ë°åÂãï
                gameData.suggestedActions.nextAction = null;
                
                // Â¶ÇÊûúÊúâËä±È≠ÇÂèØ‰ª•ÊæÜÁÅå‰∏îÊúâË∂≥Â§†Ê∑öÊ∞¥ÔºåÂª∫Ë≠∞ÊæÜÁÅåËä±È≠Ç
                const plantedFlowers = gameData.flowers.filter(f => f.position !== -1);
                if (plantedFlowers.length > 0 && gameData.resources.tear > 0) {
                    // Ê®ôË®òÂª∫Ë≠∞ÊæÜÁÅåÁöÑËä±È≠Ç
                    const flowerCells = gameData.cells.filter(c => c.flowerId);
                    if (flowerCells.length > 0) {
                        const targetCell = flowerCells[0];
                        const cellElement = document.querySelector(`.garden-cell[data-id="${targetCell.id}"]`);
                        if (cellElement) {
                            setTimeout(() => {
                                cellElement.classList.add('suggested-action');
                            }, 1000);
                        }
                    }
                }
                
                // Â¶ÇÊûúÊ≤íÊúâÁ®ÆÊ§çËä±È≠Ç‰ΩÜÊúâËß£ÈéñÁöÑËä±È≠ÇÔºåÂª∫Ë≠∞Á®ÆÊ§çËä±È≠Ç
                else if (gameData.flowers.filter(f => f.unlocked && f.position === -1).length > 0) {
                    if (!gameData.suggestedActions.nextFlowerId) {
                        const nextFlower = gameData.flowers.find(f => f.unlocked && f.position === -1);
                        if (nextFlower) {
                            gameData.suggestedActions.nextFlowerId = nextFlower.id;
                        }
                    }
                }
                
                // Â¶ÇÊûúÂâõÈñãÂßãÈÅäÊà≤ÔºåÂª∫Ë≠∞Âª∫ÈÄ†Âª∫ÁØâ
                else if (!gameData.suggestedActions.nextBuildingId && gameData.resources.stone >= 10) {
                    const nextBuilding = gameData.buildings.find(b => !b.built && b.unlocked);
                    if (nextBuilding) {
                        gameData.suggestedActions.nextBuildingId = nextBuilding.id;
                    }
                }
            }
            
            // Â∞ãÊâæÂØ∂ÁéâÈ†òÊÇü - ÊîπÈÄ≤Áâà
            function searchMemories() {
                // Êõ¥Êñ∞ÊúÄÂæåÊìç‰ΩúÊôÇÈñì
                gameData.lastActionTime = Date.now();
                
                // Ë®òÈåÑÊåâÈàïÈªûÊìäÈ°ûÂûãÔºåÁî®ÊñºÂºïÂ∞éÁîüÊàêÂØ∂ÁéâÈ†òÊÇüÈ°ûÂûãÁöÑË®òÊÜ∂
                try {
                    localStorage.setItem('lastButtonClicked', 'search-memories');
                } catch (e) {
                    console.log("ÁÑ°Ê≥ïÂ≠òÂÑ≤ÊåâÈàïÈªûÊìä‰ø°ÊÅØ:", e);
                }
                
                if (gameData.resources.tear < 2) {
                    showMemoryDialog({
                        title: 'Áµ≥Áè†‰∏çË∂≥',
                        content: `<div style="text-align: center;">
                            <p>ÈúÄË¶Å2Êª¥Áµ≥Áè†ÊâçËÉΩÂ∞ãÊâæÂØ∂ÁéâÁöÑÈ†òÊÇüË®òÊÜ∂</p>
                            <p style="margin-top: 15px; color: #5D5CDE;">
                                ÂÖà‰ΩøÁî®„ÄåÂ∞ãÊâæÁµ≥Áè†„ÄçÊåâÈàïÊî∂ÈõÜÊõ¥Â§öÊ∑öÊ∞¥
                            </p>
                        </div>`
                    });
                    return;
                }
                
                // Êâ£Èô§Ë≥áÊ∫ê
                gameData.resources.tear -= 2;
                
                // È°ØÁ§∫Ë≥áÊ∫êËÆäÂåñÂãïÁï´
                if (elements.tearCount) {
                    elements.tearCount.classList.add('resource-change');
                    setTimeout(() => elements.tearCount.classList.remove('resource-change'), 500);
                }
                
                // Â¢ûÂä†ÊàêÂäüÁéá - Âü∫ÊñºÁï∂ÂâçËº™Ëø¥ÂíåÂ∑≤Êî∂ÈõÜÁöÑËä±È≠Ç
                const baseProbability = 0.7;
                const cycleBonus = (gameData.cycle - 1) * 0.1;
                const flowerBonus = gameData.flowers.filter(f => f.level > 0).length * 0.05;
                const successRate = Math.min(0.9, baseProbability + cycleBonus + flowerBonus);
                
                // ÂòóË©¶ÁîüÊàêË®òÊÜ∂Á¢éÁâá
                if (Math.random() < successRate) {
                    const memorySpawned = spawnMemory("stone");
                    
                    if (memorySpawned) {
                        showMemoryDialog({
                            title: 'ÁôºÁèæÂØ∂ÁéâÈ†òÊÇü',
                            content: `<div style="text-align: center;">
                                <p>‰Ω†ÊÑüÂèóÂà∞‰∏ÄÁµ≤ÂØ∂ÁéâÁöÑÂøÉÂ¢ÉÔºåÂúí‰∏≠ÊüêËôïÊµÆÁèæ‰∫Ü‰ªñÂ∞ç‰∫∫‰∏ñÁöÑÊÄùËÄÉ„ÄÇ</p>
                                <p style="margin-top: 15px; color: #5D5CDE;">
                                    Â∞ãÊâæË®òÊÜ∂Á¢éÁâá üß† ‰∏¶ÈªûÊìäÂÆÉ‰ª•Áç≤ÂæóÈùàÁü≥„ÄÇ
                                </p>
                                <p style="margin-top: 15px; font-style: italic; color: #666;">
                                    ÈùàÁü≥ÂèØÁî®ÊñºÈáçÂª∫Â§ßËßÄÂúíÂª∫ÁØâÔºåÊÅ¢Âæ©ÊòîÊó•ÁπÅËèØ„ÄÇ
                                </p>
                            </div>`
                        });
                        
                        // ÊèêÁ§∫ÊâæÂà∞Ë®òÊÜ∂
                        showHint('Â∞ãÊâæË®òÊÜ∂', 'ÂúíÊûó‰∏≠Âá∫Áèæ‰∫ÜÂØ∂ÁéâÁöÑÈ†òÊÇüÔºåÈªûÊìäË®òÊÜ∂Á¢éÁâáÁç≤ÂèñÈùàÁü≥', 'üß†');
                    } else {
                        // ÈõñÁÑ∂ÊÉ≥Ë¶ÅÁîüÊàêË®òÊÜ∂Ôºå‰ΩÜÊ≤íÊúâÂêàÈÅ©ÁöÑ‰ΩçÁΩÆ
                        showMemoryDialog({
                            title: 'Â∞ãÊâæÂèóÈòª',
                            content: `<div style="text-align: center;">
                                <p>‰Ω†ÊÑüÂèóÂà∞ÂØ∂ÁéâÁöÑÈ†òÊÇüÂ∞±Âú®ÈôÑËøëÔºå‰ΩÜ‰ºº‰πéÊâæ‰∏çÂà∞ÂêàÈÅ©ÁöÑÂú∞ÊñπÈ°ØÁèæ„ÄÇ</p>
                                <p style="margin-top: 15px; color: #5D5CDE;">
                                    ÂòóË©¶Ê∏ÖÁêÜ‰∏Ä‰∫õÂúíÊûóÊ†ºÂ≠êÔºåÁÇ∫Ë®òÊÜ∂Á¢éÁâáÈ®∞Âá∫Á©∫Èñì„ÄÇ
                                </p>
                            </div>`
                        });
                    }
                } else {
                    showMemoryDialog({
                        title: '‰∏ÄÁÑ°ÊâÄÁç≤',
                        content: `<div style="text-align: center;">
                            <p>Á¥ÖÂ°µËå´Ëå´ÔºåÂØ∂ÁéâÁöÑÈ†òÊÇü‰πüÂ∑≤ÂõõÊï£È£ÑÈõ∂...</p>
                            <p style="margin-top: 15px; font-style: italic; color: #666;">
                                ${getRandomSearchFailMessage()}
                            </p>
                        </div>`
                    });
                    
                    // ÊèêÁ§∫Êú™ÊâæÂà∞Ë®òÊÜ∂
                    showHint('Êú™ÁôºÁèæÈ†òÊÇü', 'ÂòóË©¶Âú®‰∏çÂêåÁØÄÊ∞£ÊêúÂ∞ãÔºåÊàñÂú®Êé®ÈÄ≤ÁØÄÊ∞£ÂæåÂÜçË©¶', '‚è≥');
                }
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                
                // Êõ¥Êñ∞Âª∫Ë≠∞Êìç‰Ωú - Â¶ÇÊûúÂ∞ãÊâæÂ§±ÊïóÔºåÂª∫Ë≠∞Êé®ÈÄ≤ÁØÄÊ∞£
                if (Math.random() < 0.5) {
                    gameData.suggestedActions.nextAction = 'advance-jieqi';
                }
            }
            
            // Èö®Ê©üÁîüÊàêÊú™ÊâæÂà∞Ë®òÊÜ∂ÁöÑÊèêÁ§∫‰ø°ÊÅØ
            function getRandomSearchFailMessage() {
                const messages = [
                    "ÂØ∂Áéâ‰ªäÊó•ÁöÑÂøµÈ†≠Á¥õ‰∫ÇÔºåÈõ£‰ª•ÊçïÊçâ„ÄÇ",
                    "Ë©¶ËëóÂú®‰∏çÂêåÁöÑÁØÄÊ∞£Â∞ãÊâæÔºåÊàñË®±ÊúÉÊúâ‰∏çÂêåÊî∂Á©´„ÄÇ",
                    "ÊúâÊôÇ‰∏çÂ∞ãË¶ìÔºåÂèçÂÄíËÉΩÊúâÊÑèÂ§ñÁôºÁèæ„ÄÇ",
                    "Â§ô‰∏ñÂõ†Á∑£ÔºåÈúÄÂæÖÊ©üÁ∑£ÊàêÁÜüÊôÇÈ°ØÁèæ„ÄÇ",
                    "ÂØ∂ÁéâÁöÑÈ†òÊÇüËàáÁï∂ÂâçÁöÑÁØÄÊ∞£ÂèØËÉΩ‰∏çÁõ∏Â•ëÂêà„ÄÇ"
                ];
                return messages[Math.floor(Math.random() * messages.length)];
            }
            
            // ÁîüÊàêË®òÊÜ∂Á¢éÁâá - ÊîπÈÄ≤Áâà
            function spawnMemory(preferredType) {
                // ÊâæÂá∫Êú™Êî∂ÈõÜÁöÑË®òÊÜ∂
                const uncollectedMemories = gameData.memories.filter(m => !m.collected);
                if (uncollectedMemories.length === 0) return false;
                
                // ÂçÄÂàÜÂÖ©Á®ÆÈ°ûÂûãÁöÑË®òÊÜ∂ - Áµ≥Áè†(Ê∑öÊ∞¥)ÂíåÈùàÁü≥
                const tearsMemories = uncollectedMemories.filter(m => m.type === "tear");
                const stoneMemories = uncollectedMemories.filter(m => m.type === "stone");
                
                // Ê†πÊìöÁï∂ÂâçË°åÂãïÈÅ∏ÊìáË®òÊÜ∂È°ûÂûã
                let chosenMemory;
                let lastButtonClicked;
                try {
                    lastButtonClicked = localStorage.getItem('lastButtonClicked');
                } catch (e) {
                    console.log("ÁÑ°Ê≥ïÁç≤ÂèñÊåâÈàïÈªûÊìä‰ø°ÊÅØ:", e);
                }
                
                // Ê†πÊìöÂÑ™ÂÖàÈ°ûÂûãÂíåÂâ©È§òË®òÊÜ∂ÈÅ∏Êìá
                if (preferredType === "stone" && stoneMemories.length > 0) {
                    chosenMemory = stoneMemories[Math.floor(Math.random() * stoneMemories.length)];
                } else if (preferredType === "tear" && tearsMemories.length > 0) {
                    chosenMemory = tearsMemories[Math.floor(Math.random() * tearsMemories.length)];
                } else if (lastButtonClicked === 'collect-tears' && tearsMemories.length > 0) {
                    // Â¶ÇÊûúÊòØÂ∞ãÊâæÁµ≥Áè†ÔºåÂÑ™ÂÖàÁîüÊàêÊ∑öÊ∞¥È°ûË®òÊÜ∂
                    chosenMemory = tearsMemories[Math.floor(Math.random() * tearsMemories.length)];
                } else if (lastButtonClicked === 'search-memories' && stoneMemories.length > 0) {
                    // Â¶ÇÊûúÊòØÂ∞ãÊâæÂØ∂ÁéâÈ†òÊÇüÔºåÂÑ™ÂÖàÁîüÊàêÈùàÁü≥È°ûË®òÊÜ∂
                    chosenMemory = stoneMemories[Math.floor(Math.random() * stoneMemories.length)];
                } else {
                    // Èö®Ê©üÈÅ∏Êìá‰ªªÊÑèÈ°ûÂûãÁöÑË®òÊÜ∂
                    chosenMemory = uncollectedMemories[Math.floor(Math.random() * uncollectedMemories.length)];
                }
                
                // ÊâæÂá∫Á©∫Èñí‰∏îÂ∑≤Ëß£ÈéñÁöÑÊ†ºÂ≠ê
                const availableCells = gameData.cells.filter(c => c.unlocked && !c.buildingId && !c.flowerId && !c.memoryId);
                if (availableCells.length === 0) return false;
                
                // Èö®Ê©üÈÅ∏Êìá‰∏ÄÂÄãÊ†ºÂ≠ê
                const randomCell = availableCells[Math.floor(Math.random() * availableCells.length)];
                
                // ÊîæÁΩÆË®òÊÜ∂Á¢éÁâá
                randomCell.memoryId = chosenMemory.id;
                randomCell.type = 'memory';
                
                // Âà∑Êñ∞UI
                initGarden();
                
                // Ê®ôË®òÊàêÂäüÁîüÊàêË®òÊÜ∂
                return true;
            }
            
            // Ê™¢Êü•‰∫ã‰ª∂Ëß∏Áôº
            function checkEvents() {
                gameData.events.forEach(event => {
                    if (!event.triggered && gameData.cycle === event.requiredCycle && gameData.jieqi[gameData.jieqiIndex].name === event.requiredJieqi) {
                        event.triggered = true;
                        
                        // Ë≠¶ÂπªÂÖ•Â§¢‰∫ã‰ª∂
                        if (event.id === 'warning-dream') {
                            showMemoryDialog({
                                title: event.title,
                                content: `<div class="warning-dream">${event.content}</div>`
                            });
                        }
                        
                        // ÁôΩËå´Ëå´ÁµêÂ±Ä
                        if (event.id === 'white-ground') {
                            triggerWhiteFade();
                        }
                    }
                });
            }
            
            // È°ØÁ§∫Â∞çË©±Ê°Ü - ÊîπÈÄ≤Áâà
            function showDialog(options) {
                try {
                    if (!elements.dialogTitle || !elements.dialogContent || 
                        !elements.dialogCancel || !elements.dialogConfirm || 
                        !elements.dialogClose || !elements.dialogOverlay) {
                        console.error("Â∞çË©±Ê°ÜÂÖÉÁ¥†Êú™ÊâæÂà∞");
                        return;
                    }
                    
                    elements.dialogTitle.textContent = options.title || 'Â∞çË©±';
                    elements.dialogContent.innerHTML = options.content || '';
                    
                    if (options.hideButtons) {
                        elements.dialogCancel.style.display = 'none';
                        elements.dialogConfirm.style.display = 'none';
                    } else {
                        elements.dialogCancel.style.display = options.showCancel === false ? 'none' : 'block';
                        elements.dialogConfirm.style.display = 'block';
                        elements.dialogCancel.textContent = options.cancelText || 'ÂèñÊ∂à';
                        elements.dialogConfirm.textContent = options.confirmText || 'Á¢∫Ë™ç';
                    }
                    
                    // Ë®≠ÁΩÆÂõûË™ø
                    elements.dialogConfirm.onclick = options.onConfirm || hideDialog;
                    elements.dialogCancel.onclick = options.onCancel || hideDialog;
                    elements.dialogClose.onclick = hideDialog;
                    
                    // ÊâìÈñãÂ∞çË©±Ê°ÜÊôÇÁöÑÂãïÁï´ÊïàÊûú
                    elements.dialogOverlay.classList.add('active');
                } catch (error) {
                    console.error("È°ØÁ§∫Â∞çË©±Ê°ÜÊôÇÂá∫ÈåØ:", error);
                    showHint('ÈåØË™§', 'ÁÑ°Ê≥ïÈ°ØÁ§∫Â∞çË©±Ê°ÜÔºåË´ãÂà∑Êñ∞È†ÅÈù¢ÈáçË©¶', '‚ùå');
                }
            }
            
            // Èö±ËóèÂ∞çË©±Ê°Ü
            function hideDialog() {
                try {
                    if (elements.dialogOverlay) {
                        elements.dialogOverlay.classList.remove('active');
                    }
                } catch (error) {
                    console.error("Èö±ËóèÂ∞çË©±Ê°ÜÊôÇÂá∫ÈåØ:", error);
                }
            }
            
            // È°ØÁ§∫Ë®òÊÜ∂ÈñÉÂõûÂ∞çË©±Ê°Ü - ÊîπÈÄ≤Áâà
            function showMemoryDialog(memory) {
                if (!memory) return;
                
                try {
                    // ÂÆâÂÖ®Ê™¢Êü•ÊâÄÊúâÂÖÉÁ¥†
                    if (!elements.memoryDialogTitle || !elements.memoryDialogContent || 
                        !elements.memoryDialogClose || !elements.memoryDialogOverlay) {
                        console.error("Ë®òÊÜ∂Â∞çË©±Ê°ÜÂÖÉÁ¥†Êú™ÊâæÂà∞");
                        return;
                    }
                    
                    elements.memoryDialogTitle.textContent = memory.title || memory.name || 'Ë®òÊÜ∂ÈñÉÂõû';
                    elements.memoryDialogContent.innerHTML = memory.content || '';
                    elements.memoryDialogClose.onclick = hideMemoryDialog;
                    
                    // È°ØÁ§∫Â∞çË©±Ê°Ü
                    elements.memoryDialogOverlay.classList.add('active');
                    
                    // ÂÆâÂÖ®Âú∞Ê∑ªÂä†ÈñÉÂõûÂãïÁï´
                    const gardenArea = document.querySelector('.garden-area');
                    if (gardenArea) {
                        gardenArea.classList.add('flashback');
                        
                        // 3ÁßíÂæåÁßªÈô§ÈñÉÂõûÂãïÁï´
                        setTimeout(() => {
                            if (gardenArea) {
                                gardenArea.classList.remove('flashback');
                            }
                        }, 3000);
                    }
                } catch (error) {
                    console.error("È°ØÁ§∫Ë®òÊÜ∂Â∞çË©±Ê°ÜÊôÇÂá∫ÈåØ:", error);
                    showHint('ÈåØË™§', 'ÁÑ°Ê≥ïÈ°ØÁ§∫Ë®òÊÜ∂Â∞çË©±Ê°Ü', '‚ùå');
                }
            }
            
            // Èö±ËóèË®òÊÜ∂ÈñÉÂõûÂ∞çË©±Ê°Ü
            function hideMemoryDialog() {
                try {
                    if (elements.memoryDialogOverlay) {
                        elements.memoryDialogOverlay.classList.remove('active');
                    }
                } catch (error) {
                    console.error("Èö±ËóèË®òÊÜ∂Â∞çË©±Ê°ÜÊôÇÂá∫ÈåØ:", error);
                }
            }
            
            // Ëß∏ÁôºÁôΩËå´Ëå´ÁµêÂ±Ä - ÊîπÈÄ≤Áâà
            function triggerWhiteFade() {
                if (!elements.whiteFade) return;
                
                elements.whiteFade.classList.add('active');
                
                // 5ÁßíÂæåÈ°ØÁ§∫ÁµêÊùüÊñáÂ≠ó
                setTimeout(() => {
                    // Ë®àÁÆóÊúÄÁµÇÊàêÁ∏æ
                    const flowerCount = gameData.flowers.filter(f => f.level > 0).length;
                    const maxFlowerLevel = Math.max(...gameData.flowers.map(f => f.level), 0);
                    const memoryCount = gameData.memories.filter(m => m.collected).length;
                    const tearCount = gameData.tears.filter(t => t.collected).length;
                    const buildingCount = gameData.buildings.filter(b => b.built).length;
                    
                    // Ê†πÊìöÊàêÁ∏æÊ±∫ÂÆöÁµêÂ±Ä
                    let conclusionText = '';
                    let titleText = 'ÈÅäÊà≤ÁµêÊùü';
                    
                    if (flowerCount >= 3 && maxFlowerLevel >= 4 && memoryCount >= 15) {
                        // ÂÆåÁæéÁµêÂ±Ä
                        titleText = 'ÂúìÊªøÁµêÂ±Ä';
                        conclusionText = '‰Ω†ÊàêÂäüÊÅ¢Âæ©‰∫ÜÂ§ßËßÄÂúíÁöÑÈ¢®ËèØÔºåËä±È≠ÇÂÄëÂÆåÂÖ®Ë¶∫ÈÜí„ÄÇÁ•ûÁëõËàáÁµ≥Áè†ÁöÑÂâçÁ∑£ÁµÇÂæóÂÑüÈÇÑÔºå‰∏ñÈñìÊÉÖÁ∑£ÔºåÁ∑£‰æÜÁ∑£ÂéªÔºåÂ¶ÇÊòØËÄåÂ∑≤„ÄÇ';
                    } else if (flowerCount >= 2 && maxFlowerLevel >= 3 && memoryCount >= 10) {
                        // ËâØÂ•ΩÁµêÂ±Ä
                        titleText = 'Ê≤âÁù°ÁµêÂ±Ä';
                        conclusionText = '‰Ω†ÂñöÈÜí‰∫ÜÈÉ®ÂàÜËä±È≠ÇÔºåÊî∂ÈõÜ‰∫ÜË®±Â§öË®òÊÜ∂„ÄÇÈõñÊú™ËÉΩÂÆåÂÖ®ÊÅ¢Âæ©Â§ßËßÄÂúíÊòîÊó•Ê¶ÆÂÖâÔºå‰ΩÜÂâç‰∏ñÊÉÖÂÇµÔºåÂ∑≤ÁÑ∂Ê∏ÖÂÑüÂ§ßÂçä„ÄÇ';
                    } else {
                        // ÊôÆÈÄöÁµêÂ±Ä
                        titleText = 'Êï£ËêΩÁµêÂ±Ä';
                        conclusionText = 'ÊôÇÂÖâÊµÅËΩâÔºåÁµÇÁ©∂Èõ£ÊïµÁÑ°Â∏∏„ÄÇËä±È≠ÇÊ∏∫Ê∏∫ÔºåË®òÊÜ∂Êï£ËêΩ„ÄÇÁ¥ÖÂ°µ‰∏ÄÂ§¢ÔºåÁµÇÂ∞áÈÜí‰æÜ„ÄÇ';
                    }
                    
                    showMemoryDialog({
                        title: titleText,
                        content: `<div style="text-align: center;">
                            <p>${conclusionText}</p>
                            <div class="poem" style="margin: 20px 0;">
                                ÁôΩËå´Ëå´Â§ßÂú∞‰∏ÄÁâáÁúü‰πæÊ∑®ÔºÅ
                            </div>
                            <p>‰Ω†Â∑≤Á∂ìÊ≠∑‰∫Ü ${gameData.cycle} Ëº™Ëº™Ëø¥ÔºåÊàêÂ∞±Â¶Ç‰∏ãÔºö</p>
                            <div style="margin: 15px 0; text-align: left; display: inline-block;">
                                <p>‚òÖ ÂñöÈÜíËä±È≠Ç: ${flowerCount} ‰Ωç (ÊúÄÈ´òÁ≠âÁ¥ö: ${maxFlowerLevel})</p>
                                <p>‚òÖ Êî∂ÈõÜË®òÊÜ∂: ${memoryCount} ÊÆµ</p>
                                <p>‚òÖ Êî∂ÈõÜÊ∑öÊ∞¥: ${tearCount} Á®Æ</p>
                                <p>‚òÖ ÈáçÂª∫Âª∫ÁØâ: ${buildingCount} Â∫ß</p>
                            </div>
                            <p style="margin-top: 20px; font-style: italic; color: #5D5CDE;">
                                ÊªøÁ¥ôËçíÂîêË®ÄÔºå‰∏ÄÊääËæõÈÖ∏Ê∑ö„ÄÇÈÉΩÈõ≤‰ΩúËÄÖÁó¥ÔºåË™∞Ëß£ÂÖ∂‰∏≠Âë≥Ôºü
                            </p>
                        </div>`
                    });
                    
                    // ÂÖÅË®±ÂÜçÊ¨°ÈñãÂßã
                    if (elements.memoryDialogClose) {
                        elements.memoryDialogClose.textContent = 'ÂÜçÊ¨°ÈñãÂßã';
                        elements.memoryDialogClose.onclick = () => {
                            hideMemoryDialog();
                            resetGame();
                            if (elements.whiteFade) {
                                elements.whiteFade.classList.remove('active');
                            }
                        };
                    }
                }, 5000);
            }
            
            // ÈáçÁΩÆÈÅäÊà≤ - ÊîπÈÄ≤Áâà
            function resetGame() {
                // ÈáçÁΩÆÊï∏Êìö
                gameData.cycle = 1;
                gameData.jieqiIndex = 0;
                gameData.resources = {
                    stone: 5,
                    tear: 1,
                    memory: 0
                };
                
                // ÈáçÁΩÆÂª∫ÁØâ
                gameData.buildings.forEach(building => {
                    if (building.id !== 'base-camp') {
                        building.built = false;
                        building.position = -1;
                        building.status = "Êú™Âª∫ÈÄ†";
                    } else {
                        building.status = "ÂÆåÂ•Ω";
                    }
                });
                
                // ÈáçÁΩÆËä±È≠Ç
                gameData.flowers.forEach(flower => {
                    flower.unlocked = false;
                    flower.level = 0;
                    flower.growth = 0;
                    flower.position = -1;
                    flower.memories = [];
                    flower.status = "Êú™Ëß£Èéñ";
                });
                
                // ÈáçÁΩÆÈ≥•Èùà
                gameData.birds.forEach(bird => {
                    bird.unlocked = false;
                    bird.level = 0;
                    bird.status = "Êú™Ëß£Èéñ";
                });
                
                // ÈáçÁΩÆË®òÊÜ∂
                gameData.memories.forEach(memory => {
                    memory.collected = false;
                });
                
                // ÈáçÁΩÆÊ∑öÊ∞¥
                gameData.tears.forEach(tear => {
                    tear.collected = (tear.id === 'last-tear'); // Âè™‰øùÁïôÊúÄÂæå‰∏ÄÊª¥Ê∑ö
                });
                
                // ÈáçÁΩÆÂñÆÂÖÉÊ†º
                gameData.cells = Array(25).fill().map((_, i) => ({
                    id: i,
                    type: "empty",
                    buildingId: null,
                    flowerId: null,
                    memoryId: null,
                    decayValue: 0,
                    unlocked: i === 12 || [6, 7, 8, 11, 13, 16, 17, 18].includes(i)
                }));
                
                // Ë®≠ÁΩÆÂàùÂßãÂª∫ÁØâ
                setupInitialBuilding();
                
                // ÈáçÁΩÆ‰∫ã‰ª∂
                gameData.events.forEach(event => {
                    event.triggered = false;
                });
                
                // ÈáçÁΩÆÂª∫Ë≠∞Ë°åÂãï
                gameData.suggestedActions = {
                    nextBuildingId: null,
                    nextFlowerId: null,
                    nextAction: 'collect-tears'
                };
                
                // ÈáçÁΩÆÊïôÂ≠∏
                gameData.tutorialCompleted = false;
                gameData.tutorialStep = 0;
                
                // Âà∑Êñ∞UI
                updateResourceDisplay();
                initGarden();
                updateLists();
                updateCycleProgress();
                
                // È°ØÁ§∫Ê≠°ËøéÊ∂àÊÅØ
                showMemoryDialog({
                    title: 'ÈÅäÊà≤ÈáçÁΩÆ',
                    content: `<div style="text-align: center;">
                        <p>ÊôÇÂÖâÂ¶ÇÈÄÜÊ∞¥ÔºåÂèàÂõûÂà∞ÊúÄÂàù„ÄÇ</p>
                        <p style="margin-top: 15px;">ÈÄô‰∏Ä‰∏ñÔºå‰Ω†Â∞áÈáçÊñ∞Ë∏è‰∏äÈÇÑÊ∑ö‰πãÊóÖ„ÄÇ</p>
                        <p style="margin-top: 20px; color: #5D5CDE;">È°ò‰Ω†ËÉΩÊâæÂà∞Êõ¥Â•ΩÁöÑÈÅìË∑Ø...</p>
                    </div>`
                });
                
                // Âª∂ÈÅ≤È°ØÁ§∫ÊïôÂ≠∏
                setTimeout(() => {
                    startTutorial();
                }, 2000);
            }
            
            // Êõ¥Êñ∞Ë≥áÊ∫êÈ°ØÁ§∫ - ÊîπÈÄ≤Áâà
            function updateResourceDisplay() {
                try {
                    // Êõ¥Êñ∞Âü∫Êú¨Ë≥áÊ∫ê
                    if (elements.cycleCount) elements.cycleCount.textContent = gameData.cycle;
                    if (elements.jieqiValue) elements.jieqiValue.textContent = gameData.jieqi[gameData.jieqiIndex].name;
                    
                    // Êõ¥Êñ∞Áµ≥Áè†ÂíåÈùàÁü≥ÔºåÊ†πÊìöË∂≥Â§†ËàáÂê¶Ê∑ªÂä†‰∏çÂêåÊ®£Âºè
                    if (elements.tearCount) {
                        elements.tearCount.textContent = gameData.resources.tear;
                        
                        // Â∞çÊêúÂ∞ãË®òÊÜ∂‰æÜË™™ÔºåÈúÄË¶Å2Êª¥Áµ≥Áè†
                        if (gameData.resources.tear >= 2) {
                            elements.tearCount.classList.add('sufficient');
                            elements.tearCount.classList.remove('insufficient');
                        } else {
                            elements.tearCount.classList.remove('sufficient');
                            
                            // Âè™Âú®Áµ≥Áè†ÂÆåÂÖ®‰∏çË∂≥ÊôÇÊâçÈ°ØÁ§∫‰∏çË∂≥
                            if (gameData.resources.tear < 1) {
                                elements.tearCount.classList.add('insufficient');
                            } else {
                                elements.tearCount.classList.remove('insufficient');
                            }
                        }
                    }
                    
                    if (elements.stoneCount) {
                        elements.stoneCount.textContent = gameData.resources.stone;
                        
                        // Â∞çÂª∫ÁØâ‰æÜË™™ÔºåÈÄöÂ∏∏ÈúÄË¶Å10Â°äÈùàÁü≥
                        if (gameData.resources.stone >= 10) {
                            elements.stoneCount.classList.add('sufficient');
                            elements.stoneCount.classList.remove('insufficient');
                        } else {
                            elements.stoneCount.classList.remove('sufficient');
                            elements.stoneCount.classList.remove('insufficient');
                        }
                    }
                    
                    if (elements.memoryCount) elements.memoryCount.textContent = gameData.resources.memory;
                    
                    // Êõ¥Êñ∞Ë®àÊï∏Âô®
                    if (elements.flowerCount) 
                        elements.flowerCount.textContent = `${gameData.flowers.filter(f => f.level > 0).length}/12`;
                    if (elements.birdCount) 
                        elements.birdCount.textContent = `${gameData.birds.filter(b => b.unlocked).length}/12`;
                    if (elements.collectedMemoryCount) 
                        elements.collectedMemoryCount.textContent = `${gameData.memories.filter(m => m.collected).length}/24`;
                    if (elements.collectedTearCount) 
                        elements.collectedTearCount.textContent = `${gameData.tears.filter(t => t.collected).length}/12`;
                } catch (error) {
                    console.error("Êõ¥Êñ∞Ë≥áÊ∫êÈ°ØÁ§∫ÊôÇÂá∫ÈåØ:", error);
                }
            }
            
            // Êõ¥Êñ∞Ëº™Ëø¥ÈÄ≤Â∫¶Ê¢ù
            function updateCycleProgress() {
                // Ë®àÁÆóÈÄ≤Â∫¶ÁôæÂàÜÊØîÔºö(Áï∂ÂâçÁØÄÊ∞£ / Á∏ΩÁØÄÊ∞£Êï∏Èáè) * 100
                const progressPercent = (gameData.jieqiIndex / 24) * 100;
                
                // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ùÂØ¨Â∫¶
                if (elements.cycleProgressBar) {
                    elements.cycleProgressBar.style.width = `${progressPercent}%`;
                }
            }
            
            // Êõ¥Êñ∞ÂàóË°® - ÊîπÈÄ≤Áâà
            function updateLists() {
                try {
                    // Êõ¥Êñ∞Ëä±È≠ÇÂàóË°®
                    if (elements.flowersList) {
                        elements.flowersList.innerHTML = '';
                        
                        // ÈÅéÊøæ‰∏¶ÊéíÂ∫èËä±È≠ÇÔºöÂ∑≤Ëß£ÈéñÁöÑÔºåÂÜçÊåâÁ≠âÁ¥öÊéíÂ∫è
                        const sortedFlowers = gameData.flowers
                            .filter(f => f.unlocked)
                            .sort((a, b) => b.level - a.level);
                        
                        if (sortedFlowers.length === 0) {
                            elements.flowersList.innerHTML = '<div style="text-align: center; padding: 15px; color: #999;">Êú™ÁôºÁèæËä±È≠ÇÔºåÂª∫ÈÄ†Âª∫ÁØâËß£Èéñ</div>';
                        } else {
                            sortedFlowers.forEach(flower => {
                                const isNewlyUnlocked = flower.status === "ÂæÖÁ®ÆÊ§ç";
                                
                                // Ë®àÁÆóÊàêÈï∑Ê¢ùÂØ¨Â∫¶
                                const growthWidth = flower.growth / 100 * 100;
                                
                                // Ê±∫ÂÆöËä±È≠ÇÁãÄÊÖãÈ°ØÁ§∫
                                let statusHTML = '';
                                
                                if (flower.position === -1) {
                                    statusHTML = '<span style="color: #FFC107;">ÂæÖÁ®ÆÊ§ç</span>';
                                } else if (flower.level === 0) {
                                    statusHTML = '<span style="color: #4CAF50;">ÂπºËãóÊúü</span>';
                                } else if (flower.level === flower.maxLevel) {
                                    statusHTML = '<span style="color: #9C27B0;">ÂÆåÂÖ®Ë¶∫ÈÜí</span>';
                                } else {
                                    statusHTML = `<span style="color: #5D5CDE;">Á≠âÁ¥ö ${flower.level}</span>`;
                                }
                                
                                const flowerItem = document.createElement('div');
                                flowerItem.className = `flower-item ${isNewlyUnlocked ? 'new-item' : ''}`;
                                flowerItem.innerHTML = `
                                    <div class="flower-item-icon">${flower.icon}</div>
                                    <div class="flower-item-details">
                                        <div class="item-name">${flower.name} (${flower.character})</div>
                                        <div class="item-level">
                                            ${statusHTML}
                                            ${flower.position !== -1 ? `
                                                <div class="progress-container" style="height: 6px; margin-top: 5px;">
                                                    <div class="progress-bar" style="width: ${growthWidth}%"></div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                                
                                // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂È°ØÁ§∫Ë©≥ÊÉÖ
                                flowerItem.addEventListener('click', () => {
                                    // Â¶ÇÊûúËä±È≠ÇÂ∑≤Á®ÆÊ§çÔºåÈ°ØÁ§∫ÂÖ∂‰ΩçÁΩÆ
                                    if (flower.position !== -1) {
                                        // ÈñÉÁàçÂ∞çÊáâÊ†ºÂ≠ê
                                        const cellElement = document.querySelector(`.garden-cell[data-id="${flower.position}"]`);
                                        if (cellElement) {
                                            cellElement.classList.add('flashback');
                                            setTimeout(() => {
                                                cellElement.classList.remove('flashback');
                                            }, 2000);
                                        }
                                    }
                                    
                                    // È°ØÁ§∫Ë©≥Á¥∞‰ø°ÊÅØ
                                    showDialog({
                                        title: `${flower.name} (${flower.character})`,
                                        content: `
                                            <p>${flower.description}</p>
                                            <div style="margin: 15px 0;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                    <span>Á≠âÁ¥ö: ${flower.level}/${flower.maxLevel}</span>
                                                    <span>${Math.floor(flower.growth)}%</span>
                                                </div>
                                                <div class="progress-container">
                                                    <div class="progress-bar" style="width: ${(flower.growth / 100) * 100}%"></div>
                                                </div>
                                            </div>
                                            <p><strong>Áï∂ÂâçÁãÄÊÖã:</strong> ${flower.position === -1 ? 'ÂæÖÁ®ÆÊ§ç' : 'Â∑≤Á®ÆÊ§ç'}</p>
                                            <p style="margin-top: 10px;"><strong>ÁâπÊÆäÁÖßÊñô:</strong> ${flower.specialCare}</p>
                                            <p style="margin-top: 10px;"><strong>Â≠£ÁØÄÁîüÈï∑ÈÄüÂ∫¶:</strong> 
                                                Êò• ${flower.seasonalGrowth.Êò•}x ¬∑ 
                                                Â§è ${flower.seasonalGrowth.Â§è}x ¬∑ 
                                                Áßã ${flower.seasonalGrowth.Áßã}x ¬∑ 
                                                ÂÜ¨ ${flower.seasonalGrowth.ÂÜ¨}x
                                            </p>
                                            <p style="margin-top: 15px;"><strong>Âà§Ë©û:</strong> <em>${flower.judgmentPoem}</em></p>
                                        `,
                                        confirmText: 'ÈóúÈñâ',
                                        showCancel: false
                                    });
                                });
                                
                                elements.flowersList.appendChild(flowerItem);
                            });
                        }
                    }
                    
                    // Êõ¥Êñ∞Ê∑öÊ∞¥ÂàóË°®
                    if (elements.tearsList) {
                        elements.tearsList.innerHTML = '';
                        
                        const collectedTears = gameData.tears.filter(t => t.collected);
                        
                        if (collectedTears.length === 0) {
                            elements.tearsList.innerHTML = '<div style="text-align: center; padding: 15px; color: #999;">Â∞öÊú™Êî∂ÈõÜÁâπÊÆäÊ∑öÊ∞¥</div>';
                        } else {
                            collectedTears.forEach(tear => {
                                const tearItem = document.createElement('div');
                                tearItem.className = 'tear-item';
                                
                                // Ê∑ªÂä†Ê∑öÊ∞¥ÂÅèÂ•Ω‰ø°ÊÅØ
                                const preferredFlowers = gameData.flowers.filter(f => 
                                    f.tearPreference && f.tearPreference.includes(tear.id));
                                
                                let preferredText = '';
                                if (preferredFlowers.length > 0) {
                                    preferredText = `<div style="font-size: 11px; margin-top: 3px; color: #4CAF50;">
                                        Â∞ç ${preferredFlowers.map(f => f.character).join('„ÄÅ')} ÁâπÊïà
                                    </div>`;
                                }
                                
                                tearItem.innerHTML = `
                                    <div class="tear-item-icon">${tear.icon}</div>
                                    <div class="tear-item-details">
                                        <div class="item-name">${tear.name}</div>
                                        <div class="item-description">${tear.description}</div>
                                        ${preferredText}
                                    </div>
                                `;
                                
                                tearItem.addEventListener('click', () => {
                                    showMemoryDialog({
                                        title: tear.name,
                                        content: `<div style="text-align: center;">
                                            <p>${tear.description}</p>
                                            <div class="poem" style="margin: 15px 0;">
                                                ${tear.scene}
                                            </div>
                                            <p><strong>ÊïàÂäõ:</strong> ${tear.potency}</p>
                                            ${preferredFlowers.length > 0 ? 
                                                `<p style="margin-top: 15px; color: #4CAF50;">
                                                    <strong>Â∞ç‰ª•‰∏ãËä±È≠ÇÊúâÂä†ÂÄçÊïàÊûú:</strong><br>
                                                    ${preferredFlowers.map(f => `${f.name} (${f.character})`).join('<br>')}
                                                </p>` : 
                                                ''}
                                        </div>`
                                    });
                                });
                                
                                elements.tearsList.appendChild(tearItem);
                            });
                        }
                    }
                    
                    // Êõ¥Êñ∞È≥•ÈùàÂàóË°®
                    if (elements.birdsList) {
                        elements.birdsList.innerHTML = '';
                        
                        const activeBirds = gameData.birds.filter(b => b.unlocked);
                        
                        if (activeBirds.length === 0) {
                            elements.birdsList.innerHTML = '<div style="text-align: center; padding: 15px; color: #999;">Â∞öÊú™ÂñöÈÜíÈ≥•ÈùàÔºåÊèêÂçáËä±È≠ÇÁ≠âÁ¥öËß£Èéñ</div>';
                        } else {
                            activeBirds.forEach(bird => {
                                const birdItem = document.createElement('div');
                                birdItem.className = 'bird-item';
                                birdItem.innerHTML = `
                                    <div class="bird-item-icon">${bird.icon}</div>
                                    <div class="bird-item-details">
                                        <div class="item-name">${bird.name} (${bird.character})</div>
                                        <div class="item-description">${bird.description}</div>
                                    </div>
                                `;
                                
                                birdItem.addEventListener('click', () => {
                                    // Êü•ÊâæÈóúËÅØËä±È≠Ç
                                    const relatedFlower = gameData.flowers.find(f => f.id === bird.relatedFlower);
                                    
                                    showDialog({
                                        title: `${bird.name} (${bird.character})`,
                                        content: `
                                            <p>${bird.description}</p>
                                            <p style="margin-top: 15px;"><strong>ÁâπÊÆäËÉΩÂäõ:</strong></p>
                                            <ul style="margin-top: 10px; padding-left: 20px;">
                                                ${bird.abilities.map(ability => `<li style="margin-bottom: 5px;">${ability}</li>`).join('')}
                                            </ul>
                                            ${relatedFlower ? 
                                                `<p style="margin-top: 15px;"><strong>ÈóúËÅØËä±È≠Ç:</strong> ${relatedFlower.name} (${relatedFlower.character})</p>` : 
                                                ''}
                                        `,
                                        confirmText: 'ÈóúÈñâ',
                                        showCancel: false
                                    });
                                });
                                
                                elements.birdsList.appendChild(birdItem);
                            });
                        }
                    }
                    
                    // Êõ¥Êñ∞Ë®òÊÜ∂ÂàóË°®
                    if (elements.memoriesList) {
                        elements.memoriesList.innerHTML = '';
                        
                        const collectedMemories = gameData.memories.filter(m => m.collected);
                        
                        if (collectedMemories.length === 0) {
                            elements.memoriesList.innerHTML = '<div style="text-align: center; padding: 15px; color: #999;">Â∞öÊú™Êî∂ÈõÜË®òÊÜ∂Á¢éÁâá</div>';
                        } else {
                            // ÊåâÈ°ûÂûãÂàÜÁµÑÊéíÂ∫è
                            const stoneMemories = collectedMemories.filter(m => m.type === "stone");
                            const tearMemories = collectedMemories.filter(m => m.type === "tear");
                            
                            // ÂÖàÈ°ØÁ§∫ÈùàÁü≥È°ûË®òÊÜ∂
                            if (stoneMemories.length > 0) {
                                const typeHeader = document.createElement('div');
                                typeHeader.className = 'memory-type-header';
                                typeHeader.innerHTML = `<div style="padding: 5px 10px; margin: 5px 0; background: rgba(93, 92, 222, 0.1); border-radius: 5px;">
                                    <span style="font-weight: bold; color: #5D5CDE;">ÂØ∂ÁéâÈ†òÊÇü (${stoneMemories.length})</span>
                                </div>`;
                                elements.memoriesList.appendChild(typeHeader);
                                
                                stoneMemories.forEach(memory => {
                                    createMemoryItem(memory);
                                });
                            }
                            
                            // ÂÜçÈ°ØÁ§∫Ê∑öÊ∞¥È°ûË®òÊÜ∂
                            if (tearMemories.length > 0) {
                                const typeHeader = document.createElement('div');
                                typeHeader.className = 'memory-type-header';
                                typeHeader.innerHTML = `<div style="padding: 5px 10px; margin: 5px 0; background: rgba(139, 69, 19, 0.1); border-radius: 5px;">
                                    <span style="font-weight: bold; color: #8B4513;">ÈªõÁéâË®òÊÜ∂ (${tearMemories.length})</span>
                                </div>`;
                                elements.memoriesList.appendChild(typeHeader);
                                
                                tearMemories.forEach(memory => {
                                    createMemoryItem(memory);
                                });
                            }
                        }
                        
                        // ÂâµÂª∫Ë®òÊÜ∂È†ÖÁõÆÁöÑÂáΩÊï∏
                        function createMemoryItem(memory) {
                            const memoryItem = document.createElement('div');
                            memoryItem.className = 'memory-item';
                            
                            // Ê†πÊìöË®òÊÜ∂È°ûÂûãÈ°ØÁ§∫‰∏çÂêåÂÖßÂÆπ
                            let typeInfo = '';
                            if (memory.type === 'stone') {
                                typeInfo = `<span style="color: #5D5CDE;">Áç≤Âæó ${memory.stoneValue} ÈùàÁü≥</span>`;
                            } else if (memory.type === 'tear') {
                                const relatedTear = gameData.tears.find(t => t.id === memory.relatedTear);
                                typeInfo = `<span style="color: #8B4513;">Áç≤Âæó ${relatedTear?.name || 'Áµ≥Áè†'}</span>`;
                            }
                            
                            memoryItem.innerHTML = `
                                <div class="memory-item-icon">${memory.icon}</div>
                                <div class="memory-item-details">
                                    <div class="item-name">${memory.name}</div>
                                    <div class="item-description">${memory.description}</div>
                                    ${typeInfo ? `<div style="font-size: 11px; margin-top: 3px;">${typeInfo}</div>` : ''}
                                </div>
                            `;
                            
                            memoryItem.addEventListener('click', () => {
                                showMemoryDialog({
                                    title: memory.name,
                                    content: `<div class="poem">${memory.content}</div>`
                                });
                            });
                            
                            elements.memoriesList.appendChild(memoryItem);
                        }
                    }
                } catch (error) {
                    console.error("Êõ¥Êñ∞ÂàóË°®ÊôÇÂá∫ÈåØ:", error);
                }
            }
            
            // Áç≤ÂèñÂª∫ÁØâÁãÄÊÖãÊñáÊú¨
            function getConditionText(condition) {
                if (condition > 0.8) return 'ÂÆåÂ•Ω';
                if (condition > 0.5) return 'Áï•ÊúâÁ†¥Êêç';
                if (condition > 0.2) return 'ÊòéÈ°ØÁ†¥Êêç';
                return 'ÂπæËøëÂùçÂ°å';
            }
            
            // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩ
            function addEventListeners() {
                // Ë°åÂãïÊåâÈàï
                if (elements.advanceJieqiBtn) {
                    elements.advanceJieqiBtn.addEventListener('click', advanceJieqi);
                }
                if (elements.collectTearsBtn) {
                    elements.collectTearsBtn.addEventListener('click', collectTears);
                }
                if (elements.searchMemoriesBtn) {
                    elements.searchMemoriesBtn.addEventListener('click', searchMemories);
                }
                
                // Â∞çË©±Ê°ÜÊåâÈàï
                if (elements.memoryDialogClose) {
                    elements.memoryDialogClose.addEventListener('click', hideMemoryDialog);
                }
                if (elements.dialogClose) {
                    elements.dialogClose.addEventListener('click', hideDialog);
                }
                
                // Âπ´Âä©ÊåâÈàï
                if (elements.actionsHelp) {
                    elements.actionsHelp.addEventListener('click', () => showPanelHelp('actions'));
                }
                if (elements.flowersHelp) {
                    elements.flowersHelp.addEventListener('click', () => showPanelHelp('flowers'));
                }
                if (elements.tearsHelp) {
                    elements.tearsHelp.addEventListener('click', () => showPanelHelp('tears'));
                }
                if (elements.birdsHelp) {
                    elements.birdsHelp.addEventListener('click', () => showPanelHelp('birds'));
                }
                if (elements.memoriesHelp) {
                    elements.memoriesHelp.addEventListener('click', () => showPanelHelp('memories'));
                }
                
                // ÊïôÂ≠∏ÊåâÈàï
                if (elements.tutorialNext) {
                    elements.tutorialNext.addEventListener('click', nextTutorialStep);
                }
                if (elements.tutorialSkip) {
                    elements.tutorialSkip.addEventListener('click', skipTutorial);
                }
                
                // Êé®Ëñ¶Êìç‰ΩúÊ∞£Ê≥°
                if (elements.bubbleClose) {
                    elements.bubbleClose.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (elements.actionSuggestion) {
                            elements.actionSuggestion.style.display = 'none';
                        }
                    });
                }
                
                if (elements.actionSuggestion) {
                    elements.actionSuggestion.addEventListener('click', (e) => {
                        if (e.target !== elements.bubbleClose) {
                            executeRecommendedAction();
                        }
                    });
                }
                
                // ‰∏ªÈÅ∏ÂñÆ
                if (elements.menuToggle) {
                    elements.menuToggle.addEventListener('click', toggleMenu);
                }
                
                if (elements.menuTutorial) {
                    elements.menuTutorial.addEventListener('click', () => {
                        startTutorial();
                        closeMenu();
                    });
                }
                
                if (elements.menuTargets) {
                    elements.menuTargets.addEventListener('click', () => {
                        showCurrentGoals();
                        closeMenu();
                    });
                }
                
                if (elements.menuRestart) {
                    elements.menuRestart.addEventListener('click', () => {
                        showDialog({
                            title: 'Á¢∫Ë™çÈáçÁΩÆ',
                            content: `<div style="text-align: center;">
                                <p>Á¢∫ÂÆöË¶ÅÈáçÁΩÆÈÅäÊà≤ÂóéÔºü</p>
                                <p style="margin-top: 15px; color: #F44336;">ÊâÄÊúâÈÄ≤Â∫¶Â∞áÊúÉ‰∏üÂ§±ÔºÅ</p>
                            </div>`,
                            confirmText: 'ÈáçÁΩÆ',
                            cancelText: 'ÂèñÊ∂à',
                            onConfirm: () => {
                                resetGame();
                                closeMenu();
                            }
                        });
                    });
                }
                
                // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâÈÅ∏ÂñÆ
                document.addEventListener('click', (e) => {
                    if (elements.mainMenu && 
                        elements.mainMenu.classList.contains('menu-open') && 
                        !elements.mainMenu.contains(e.target)) {
                        closeMenu();
                    }
                });
            }
            
            // ÂàáÊèõÈÅ∏ÂñÆ
            function toggleMenu() {
                if (elements.mainMenu) {
                    elements.mainMenu.classList.toggle('menu-open');
                }
            }
            
            // ÈóúÈñâÈÅ∏ÂñÆ
            function closeMenu() {
                if (elements.mainMenu) {
                    elements.mainMenu.classList.remove('menu-open');
                }
            }
            
            // È°ØÁ§∫Áï∂ÂâçÁõÆÊ®ô
            function showCurrentGoals() {
                // Áç≤ÂèñÁï∂ÂâçÈÄ≤Â∫¶
                const builtBuildings = gameData.buildings.filter(b => b.built).length;
                const totalBuildings = gameData.buildings.filter(b => b.unlocked).length;
                
                const plantedFlowers = gameData.flowers.filter(f => f.position !== -1).length;
                const unlockedFlowers = gameData.flowers.filter(f => f.unlocked).length;
                
                const awakenedBirds = gameData.birds.filter(b => b.unlocked).length;
                
                // ÁîüÊàê‰∏ã‰∏ÄÊ≠•ÁõÆÊ®ôÂàóË°®
                let goalsHTML = '';
                
                // Âª∫ÁØâÁõÆÊ®ô
                if (builtBuildings < totalBuildings) {
                    const nextBuilding = gameData.buildings.find(b => !b.built && b.unlocked);
                    if (nextBuilding) {
                        goalsHTML += `<li style="margin-bottom: 8px;">Âª∫ÈÄ† ${nextBuilding.name} (ÈúÄË¶Å ${nextBuilding.cost.stone} ÈùàÁü≥)</li>`;
                    }
                }
                
                // Ëä±È≠ÇÁõÆÊ®ô
                if (plantedFlowers < unlockedFlowers) {
                    const unplantedFlower = gameData.flowers.find(f => f.unlocked && f.position === -1);
                    if (unplantedFlower) {
                        goalsHTML += `<li style="margin-bottom: 8px;">Á®ÆÊ§ç ${unplantedFlower.character} ÁöÑËä±È≠Ç</li>`;
                    }
                }
                
                // ÊæÜÁÅåÁõÆÊ®ô
                const lowLevelFlowers = gameData.flowers.filter(f => f.position !== -1 && f.level < 3);
                if (lowLevelFlowers.length > 0) {
                    goalsHTML += `<li style="margin-bottom: 8px;">ÊæÜÁÅåËä±È≠ÇËá≥Â∞ëÂà∞ Lv3 ‰ª•Ëß£ÈéñÈ≥•Èùà</li>`;
                }
                
                // Êî∂ÈõÜË®òÊÜ∂ÁõÆÊ®ô
                const memoryCount = gameData.memories.filter(m => m.collected).length;
                if (memoryCount < 10) {
                    goalsHTML += `<li style="margin-bottom: 8px;">ÁπºÁ∫åÊî∂ÈõÜË®òÊÜ∂Á¢éÁâá (${memoryCount}/24)</li>`;
                }
                
                // Ëº™Ëø¥ÁõÆÊ®ô
                if (gameData.cycle < 3) {
                    goalsHTML += `<li style="margin-bottom: 8px;">ÂÆåÊàê ${3 - gameData.cycle} Ëº™Ëº™Ëø¥‰ª•ÈÅîÊàêÁµêÂ±Ä</li>`;
                }
                
                // ÁâπÊÆäÁØÄÊ∞£ÁõÆÊ®ô
                const currentJieqi = gameData.jieqi[gameData.jieqiIndex].name;
                const upcomingMemories = gameData.memories.filter(m => 
                    !m.collected && ['Ê∏ÖÊòé', 'Á´ãÂ§è', 'Â§èËá≥', 'ÁôΩÈú≤', 'ÂÜ¨Ëá≥'].includes(m.requiredJieqi));
                
                if (upcomingMemories.length > 0) {
                    const nextMemoryJieqi = upcomingMemories[0].requiredJieqi;
                    goalsHTML += `<li style="margin-bottom: 8px;">Êé®ÈÄ≤ÁØÄÊ∞£Ëá≥ ${nextMemoryJieqi} ÂèØËß∏ÁôºÁâπÊÆäË®òÊÜ∂</li>`;
                }
                
                // È°ØÁ§∫ÁõÆÊ®ôÂ∞çË©±Ê°Ü
                showDialog({
                    title: 'Áï∂ÂâçÁõÆÊ®ô',
                    content: `<div style="text-align: left;">
                        <p>Â§ßËßÄÂúíÈáçÂª∫ÈÄ≤Â∫¶Ôºö</p>
                        <div style="margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span>Âª∫ÁØâ</span>
                                <span>${builtBuildings}/${totalBuildings}</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${(builtBuildings / Math.max(1, totalBuildings)) * 100}%"></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0 5px 0;">
                                <span>Ëä±È≠Ç</span>
                                <span>${gameData.flowers.filter(f => f.level > 0).length}/12</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${(gameData.flowers.filter(f => f.level > 0).length / 12) * 100}%"></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0 5px 0;">
                                <span>È≥•Èùà</span>
                                <span>${awakenedBirds}/12</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${(awakenedBirds / 12) * 100}%"></div>
                            </div>
                        </div>
                        
                        <p style="margin-top: 20px;">Êé®Ëñ¶Êé•‰∏ã‰æÜÔºö</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            ${goalsHTML || '<li>ÊÅ≠ÂñúÔºÅ‰Ω†Â∑≤ÂÆåÊàêÊâÄÊúâ‰∏ªË¶ÅÁõÆÊ®ô</li>'}
                        </ul>
                        
                        <p style="margin-top: 20px; color: #5D5CDE; font-style: italic;">
                            Áï∂ÂâçËº™Ëø¥: ${gameData.cycle}/3
                            ¬∑ Áï∂ÂâçÁØÄÊ∞£: ${currentJieqi}
                        </p>
                    </div>`,
                    confirmText: 'ÈóúÈñâ',
                    showCancel: false
                });
            }
            
            // È°ØÁ§∫Èù¢ÊùøÂπ´Âä©
            function showPanelHelp(panelType) {
                let title = '';
                let content = '';
                
                switch (panelType) {
                    case 'actions':
                        title = 'Ë°åÂãïÈù¢ÊùøÂπ´Âä©';
                        content = `<div style="text-align: left;">
                            <p><strong>Êé®ÈÄ≤ÁØÄÊ∞£</strong>ÔºöÊôÇÈñìÂâçÈÄ≤‰∏ÄÂÄãÁØÄÊ∞£„ÄÇÊØè24ÂÄãÁØÄÊ∞£ÁµÑÊàê‰∏ÄÂÄãÂÆåÊï¥Ëº™Ëø¥„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>Â∞ãÊâæÁµ≥Áè†</strong>ÔºöÊî∂ÈõÜÈªõÁéâÁöÑÊ∑öÊ∞¥ÔºåÁî®ÊñºÊæÜÁÅåËä±È≠ÇÂíåÂª∫ÈÄ†Âª∫ÁØâ„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>Â∞ãÊâæÂØ∂ÁéâÈ†òÊÇü</strong>ÔºöÂ∞ãÊâæÂØ∂ÁéâÁöÑÊÄùËÄÉË®òÊÜ∂ÔºåÁç≤ÂæóÈùàÁü≥Áî®ÊñºÂª∫ÈÄ†„ÄÇ</p>
                            <p style="margin-top: 15px; color: #5D5CDE;">ÊèêÁ§∫Ôºö‰∏çÂêåÁØÄÊ∞£ÊúÉÂΩ±ÈüøËä±È≠ÇÁîüÈï∑ÈÄüÂ∫¶ÂíåÁâπÊÆä‰∫ã‰ª∂Ëß∏Áôº„ÄÇ</p>
                        </div>`;
                        break;
                        
                    case 'flowers':
                        title = 'Ëä±È≠ÇÁ≥ªÁµ±Âπ´Âä©';
                        content = `<div style="text-align: left;">
                            <p>Ëä±È≠ÇÊòØÂ§ßËßÄÂúí‰∏≠Â∞ëÂ•≥ÂÄëÁöÑÂâç‰∏ñÂåñË∫´ÔºåÈúÄË¶ÅÁî®Áµ≥Áè†ÊæÜÁÅåÊâçËÉΩÊàêÈï∑„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>Ëß£ÈéñÊñπÂºè</strong>ÔºöÂª∫ÈÄ†Â∞çÊáâÁöÑÂª∫ÁØâ„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>ÊàêÈï∑ÈúÄÁü•</strong>Ôºö</p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>‰∏çÂêåËä±È≠ÇÂ∞çÁâπÂÆöÊ∑öÊ∞¥ÊúâÂÅèÂ•ΩÔºå‰ΩøÁî®ÂÅèÂ•ΩÊ∑öÊ∞¥ÊïàÊûúÂä†ÂÄç</li>
                                <li>Â≠£ÁØÄÊúÉÂΩ±ÈüøËä±È≠ÇÊàêÈï∑ÈÄüÂ∫¶</li>
                                <li>Ëä±È≠ÇÈÅîÂà∞3Á¥öÊúÉËß£ÈéñÈóúËÅØÈ≥•Èùà</li>
                                <li>Ëä±È≠ÇÈÅîÂà∞ÊªøÁ¥öÊúÉÂÆåÂÖ®Ë¶∫ÈÜíÔºåÊè≠Á§∫Âà§Ë©û</li>
                            </ul>
                        </div>`;
                        break;
                        
                    case 'tears':
                        title = 'Áµ≥Áè†Á≥ªÁµ±Âπ´Âä©';
                        content = `<div style="text-align: left;">
                            <p>Áµ≥Áè†ÊòØÈªõÁéâÁöÑÊ∑öÊ∞¥ÔºåÊòØÈÅäÊà≤‰∏≠ÁöÑÈáçË¶ÅË≥áÊ∫ê„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>Áç≤ÂèñÊñπÂºè</strong>Ôºö</p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>‰ΩøÁî®„ÄåÂ∞ãÊâæÁµ≥Áè†„ÄçË°åÂãï</li>
                                <li>Êé®ÈÄ≤ÁØÄÊ∞£ÊôÇÔºåÈ≥•ÈùàÂèØËá™ÂãïÊî∂ÈõÜ</li>
                                <li>Êî∂ÈõÜË®òÊÜ∂Á¢éÁâáÊúâÊ©üÊúÉÁç≤ÂæóÁâπÊÆäÁµ≥Áè†</li>
                            </ul>
                            <p style="margin-top: 10px;"><strong>ÁâπÊÆäÁµ≥Áè†</strong>ÔºöÊØèÁ®ÆÁâπÊÆäÁµ≥Áè†Â∞çÊáâÈªõÁéâÁîüÂëΩ‰∏≠ÁöÑÁâπÂÆöÂ†¥ÊôØÔºåÂ∞çÁâπÂÆöËä±È≠ÇÊúâÂä†ÂÄçÊïàÊûú„ÄÇ</p>
                        </div>`;
                        break;
                        
                    case 'birds':
                        title = 'È≥•ÈùàÁ≥ªÁµ±Âπ´Âä©';
                        content = `<div style="text-align: left;">
                            <p>È≥•ÈùàÊòØ‰∏´È¨üÂÄëÁöÑÂåñË∫´ÔºåËÉΩÊèê‰æõÁâπÊÆäËÉΩÂäõÂπ´Âä©‰Ω†ÈáçÂª∫Â§ßËßÄÂúí„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>Ëß£ÈéñÊñπÂºè</strong>ÔºöÂ∞áÈóúËÅØËä±È≠ÇÂüπÈ§äËá≥3Á¥ö„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>È≥•ÈùàËÉΩÂäõ</strong>Ôºö</p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>Ëá™ÂãïÊî∂ÈõÜÁµ≥Áè†</li>
                                <li>Ê∏õÁ∑©Âª∫ÁØâË°∞Êïó</li>
                                <li>Êèê‰æõÂÖ∂‰ªñÁâπÊÆäËÉΩÂäõ</li>
                            </ul>
                        </div>`;
                        break;
                        
                    case 'memories':
                        title = 'Ë®òÊÜ∂Á≥ªÁµ±Âπ´Âä©';
                        content = `<div style="text-align: left;">
                            <p>Ë®òÊÜ∂Á¢éÁâáÊòØÁ¥ÖÊ®ìÂ§¢‰∏≠ÁöÑÂ†¥ÊôØÂíåÊÉÖÁØÄÔºåÊî∂ÈõÜÂæåÂèØÁç≤ÂæóË≥áÊ∫ê„ÄÇ</p>
                            <p style="margin-top: 10px;"><strong>Ë®òÊÜ∂È°ûÂûã</strong>Ôºö</p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li><span style="color: #8B4513;">ÈªõÁéâË®òÊÜ∂</span>ÔºöÊî∂ÈõÜÂæåÁç≤ÂæóÁâπÊÆäÁµ≥Áè†</li>
                                <li><span style="color: #5D5CDE;">ÂØ∂ÁéâÈ†òÊÇü</span>ÔºöÊî∂ÈõÜÂæåÁç≤ÂæóÈùàÁü≥</li>
                            </ul>
                            <p style="margin-top: 10px;"><strong>Ëß∏ÁôºÊñπÂºè</strong>Ôºö</p>
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>‰ΩøÁî®„ÄåÂ∞ãÊâæÂØ∂ÁéâÈ†òÊÇü„ÄçË°åÂãï</li>
                                <li>Êé®ÈÄ≤ÁØÄÊ∞£ÊúâÊ©üÊúÉÈö®Ê©üÁîüÊàê</li>
                                <li>ÁâπÂÆöÁØÄÊ∞£ËàáËä±È≠Ç‰∫íÂãïÊúÉËß∏ÁôºÁâπÊÆäË®òÊÜ∂</li>
                            </ul>
                        </div>`;
                        break;
                }
                
                showDialog({
                    title: title,
                    content: content,
                    confirmText: '‰∫ÜËß£',
                    showCancel: false
                });
            }
            
            // Ë®≠ÁΩÆÂàùÂßãÂª∫ÁØâ
            function setupInitialBuilding() {
                const baseCampIndex = gameData.cells.findIndex(c => c.id === 12);
                if (baseCampIndex !== -1) {
                    gameData.cells[baseCampIndex].buildingId = 'base-camp';
                    gameData.cells[baseCampIndex].type = 'building';
                }
            }
            
            // Ê™¢Ê∏¨ÊöóÈªëÊ®°Âºè
            function detectDarkMode() {
                try {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.documentElement.classList.add('dark');
                    }
                    
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                        if (event.matches) {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                    });
                } catch (e) {
                    console.log("ÁÑ°Ê≥ïË®≠ÁΩÆÊöóÈªëÊ®°Âºè:", e);
                }
            }
            
            // È°ØÁ§∫RPGÈ¢®Ê†ºÂ∞çË©±Ê°Ü
            function showRpgDialog(messages, portrait = "üë∏", speaker = "Ë≠¶Âπª‰ªôÂ≠ê", onComplete = null) {
                // Áç≤ÂèñÂ∞çË©±Ê°ÜÂÖÉÁ¥†
                const overlay = document.getElementById('rpg-dialog-overlay');
                const textElement = document.getElementById('rpg-text');
                const portraitElement = document.getElementById('rpg-portrait');
                const speakerElement = document.getElementById('rpg-speaker');
                
                if (!overlay || !textElement || !portraitElement || !speakerElement) {
                    console.error("Êâæ‰∏çÂà∞RPGÂ∞çË©±Ê°ÜÂøÖË¶ÅÂÖÉÁ¥†");
                    return;
                }
                
                // Ë®≠ÁΩÆËßíËâ≤È†≠ÂÉèÂíåÂêçÁ®±
                portraitElement.textContent = portrait;
                speakerElement.textContent = speaker;
                
                // ÈñãÂßãÊôÇÊ∏ÖÁ©∫ÊñáÊú¨
                textElement.textContent = '';
                
                // È°ØÁ§∫Â∞çË©±Ê°Ü
                overlay.classList.add('active');
                
                let currentMessageIndex = 0;
                let charIndex = 0;
                let currentMessage = messages[currentMessageIndex];
                let typing = true;
                
                // ÊâìÂ≠óÊ©üÊïàÊûú
                function typeWriter() {
                    if (charIndex < currentMessage.length) {
                        // ÊØèÊ¨°Ê∑ªÂä†‰∏ÄÂÄãÂ≠óÁ¨¶
                        textElement.textContent += currentMessage.charAt(charIndex);
                        charIndex++;
                        setTimeout(typeWriter, 30); // ÊâìÂ≠óÈÄüÂ∫¶
                    } else {
                        typing = false; // Áï∂ÂâçÊ∂àÊÅØÂ∑≤ÊâìÂÆå
                    }
                }
                
                // ÈñãÂßãÁ¨¨‰∏ÄÊ¢ùÊ∂àÊÅØÁöÑÊâìÂ≠óÊïàÊûú
                typeWriter();
                
                // ËôïÁêÜÈªûÊìä‰∫ã‰ª∂
                function handleClick() {
                    if (typing) {
                        // Â¶ÇÊûúÊ≠£Âú®ÊâìÂ≠óÔºåÂâáÁ´ãÂç≥È°ØÁ§∫ÂÆåÊï¥Ê∂àÊÅØ
                        textElement.textContent = currentMessage;
                        typing = false;
                        charIndex = currentMessage.length;
                    } else {
                        // Â∑≤È°ØÁ§∫ÂÆåÁï∂ÂâçÊ∂àÊÅØÔºåÈÄ≤ÂÖ•‰∏ã‰∏ÄÊ¢ù
                        currentMessageIndex++;
                        
                        if (currentMessageIndex < messages.length) {
                            // ÈÇÑÊúâ‰∏ã‰∏ÄÊ¢ùÊ∂àÊÅØ
                            charIndex = 0;
                            currentMessage = messages[currentMessageIndex];
                            textElement.textContent = '';
                            typing = true;
                            typeWriter();
                        } else {
                            // ÊâÄÊúâÊ∂àÊÅØÈ°ØÁ§∫ÂÆåÁï¢
                            overlay.classList.remove('active');
                            overlay.removeEventListener('click', handleClick);
                            
                            // Â¶ÇÊûúÊúâÂõûË™øÂáΩÊï∏ÔºåÂü∑Ë°åÂÆÉ
                            if (typeof onComplete === 'function') {
                                setTimeout(() => {
                                    onComplete();
                                }, 300);
                            }
                        }
                    }
                }
                
                // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂Áõ£ËÅΩÂô®
                overlay.addEventListener('click', handleClick);
            }
            
            // È°ØÁ§∫ÈñãÂ†¥Â∞çË©±
            function showIntroDialog() {
                // ÂÆöÁæ©Â∞çË©±ÂÖßÂÆπ
                const dialogMessages = [
                    "Âπæ‰∏ñÂπæÂä´‰πãÂæåÔºåÁ•ûÁëõ‰æçËÄÖÁµÇÊñºË¶∫ÈÜí...",
                    "Á•ûÁëõÔºå‰Ω†ÊâãÊåÅËëóÈªõÁéâÊúÄÂæåÁöÑ‰∏ÄÊª¥Ê∑öÊ∞¥ÔºåÂõûÂà∞Â§ßËßÄÂúíË©¶ÂúñÈáçÂª∫ÈÄôÁâáË®òÊÜ∂‰∏≠ÁöÑÊ®ÇÂúü„ÄÇ",
                    "ÈªõÁéâÊõæÁÇ∫ÈÇÑ‰Ω†Áï∂Âπ¥ÊæÜÁÅå‰πãÊÅ©ÔºåÊµÅÁõ°Ëê¨ÂçÉÁúºÊ∑ö„ÄÇÂ¶Ç‰ªäÔºå‰Ω†Â∞á‰ª•Â•πÁöÑÊ∑öÊ∞¥ÂèçÂì∫ÁúæËä±È≠Ç„ÄÇ",
                    "‰Ω†ÁöÑ‰ΩøÂëΩÊòØÈáçÂª∫Â§ßËßÄÂúíÁöÑÂª∫ÁØâÔºåÊî∂ÈõÜÈªõÁéâÁöÑÊ∑öÊ∞¥ÔºåÁî®Ê∑öÊ∞¥ÊæÜÁÅåËä±È≠ÇÔºå‰∏¶ÂñöÈÜíÂåñÁÇ∫È≥•ÈùàÁöÑ‰∏´È¨üÂÄë„ÄÇ",
                    "‰ΩÜË´ãË®ò‰ΩèÔºåÁÑ°Ë´ñÂ§öÂ∞ëÊ∑öÊ∞¥ÔºåÁµÇÈõ£ÊïµÈÅéÊôÇÈñìÁöÑÂäõÈáè...",
                    "È°ò‰Ω†Ê≠§Ë°åÔºå‰∏ÄÂÑüÈªõÁéâÈÇÑÊ∑ö‰πãÈ°ò„ÄÇ"
                ];
                
                // ‰ΩøÁî®RPGÈ¢®Ê†ºÂ∞çË©±Ê°ÜÈ°ØÁ§∫ÈñãÂ†¥Â∞çË©±
                showRpgDialog(dialogMessages, "üë∏", "Ë≠¶Âπª‰ªôÂ≠ê", () => {
                    console.log("ÈñãÂ†¥Â∞çË©±Êí≠ÊîæÂÆåÁï¢");
                    gameData.introShown = true;
                    
                    // ÈñãÂ†¥Â∞çË©±ÁµêÊùüÂæåÈñãÂßãÊïôÂ≠∏
                    setTimeout(() => {
                        startTutorial();
                    }, 800);
                });
            }
            
            // ÊïôÂ≠∏Á≥ªÁµ±
            function startTutorial() {
                // Â¶ÇÊûúÂ∑≤ÂÆåÊàêÊïôÂ≠∏‰∏îÊ≤íÊúâÊòéÁ¢∫Ë¶ÅÊ±ÇÈáçÊñ∞ÈñãÂßãÔºåÁõ¥Êé•ËøîÂõû
                if (gameData.tutorialCompleted && !gameData.tutorialRestart) {
                    return;
                }
                
                // ÈáçÁΩÆÊïôÂ≠∏Ê≠•È©ü
                gameData.tutorialStep = 0;
                showTutorialStep(0);
            }
            
            function nextTutorialStep() {
                gameData.tutorialStep++;
                showTutorialStep(gameData.tutorialStep);
            }
            
            function skipTutorial() {
                gameData.tutorialCompleted = true;
                if (elements.tutorialOverlay) {
                    elements.tutorialOverlay.classList.remove('active');
                }
                showHint('ÊïôÂ≠∏Â∑≤Ë∑≥ÈÅé', 'ÊÇ®ÂèØ‰ª•ÈÄöÈÅéÂ∑¶‰∏ãËßíÈÅ∏ÂñÆÈáçÊñ∞ÈñãÂßãÊïôÂ≠∏', 'üìö');
            }
            
            function showTutorialStep(step) {
                const tutorialSteps = [
                    // Ê≠•È©ü1: Ê≠°Ëøé
                    {
                        title: "Ê≠°Ëøé‰æÜÂà∞Á¥ÖÊ®ìËàäÂ§¢",
                        content: "‰Ω†ÊòØÁ•ûÁëõ‰æçËÄÖÔºåÂõûÂà∞Â§ßËßÄÂúíÂ∞ãÊâæÈªõÁéâÁöÑÊ∑öÊ∞¥ËàáË®òÊÜ∂„ÄÇËÆìÊàëÁÇ∫‰Ω†‰ªãÁ¥πÈÅäÊà≤ÁöÑÂü∫Êú¨Êìç‰Ωú„ÄÇ",
                        highlight: ".header",
                        position: { top: "100px", left: "50%", transform: "translateX(-50%)" }
                    },
                    // Ê≠•È©ü2: Ë≥áÊ∫ê
                    {
                        title: "ÈÅäÊà≤Ë≥áÊ∫ê",
                        content: "ÈÅäÊà≤‰∏≠Êúâ‰∏âÁ®Æ‰∏ªË¶ÅË≥áÊ∫êÔºö<strong>Áµ≥Áè†</strong>(Ê∑öÊ∞¥)„ÄÅ<strong>ÈùàÁü≥</strong>Âíå<strong>Ë®òÊÜ∂Á¢éÁâá</strong>„ÄÇÂÆÉÂÄëÁî®ÊñºÂª∫ÈÄ†Âª∫ÁØâÂíåÂüπÈ§äËä±È≠Ç„ÄÇ",
                        highlight: ".game-status",
                        position: { top: "150px", left: "50%", transform: "translateX(-50%)" }
                    },
                    // Ê≠•È©ü3: ÂúíÊûóÊ†ºÂ≠ê
                    {
                        title: "Â§ßËßÄÂúí",
                        content: "ÈÄôÊòØÂ§ßËßÄÂúíÁöÑ‰∏ªË¶ÅÂçÄÂüü„ÄÇÈªûÊìäÁ©∫ÁôΩÊ†ºÂ≠êÂèØ‰ª•Âª∫ÈÄ†Âª∫ÁØâÊàñÁ®ÆÊ§çËä±È≠Ç„ÄÇÂ∏∂ÊúâüîíÁ¨¶ËôüÁöÑÊ†ºÂ≠êÈúÄË¶ÅËß£Èéñ„ÄÇ",
                        highlight: ".garden-area",
                        position: { top: "250px", right: "350px" }
                    },
                    // Ê≠•È©ü4: Ë°åÂãïÈù¢Êùø
                    {
                        title: "Ë°åÂãïÈù¢Êùø",
                        content: "<strong>Êé®ÈÄ≤ÁØÄÊ∞£</strong>: ÊôÇÈñìÂâçÈÄ≤‰∏ÄÊ≠•„ÄÇ<br><strong>Â∞ãÊâæÁµ≥Áè†</strong>: Êî∂ÈõÜÊ∑öÊ∞¥Ë≥áÊ∫ê„ÄÇ<br><strong>Â∞ãÊâæÂØ∂ÁéâÈ†òÊÇü</strong>: Áç≤ÂèñÈùàÁü≥Áî®ÊñºÂª∫ÈÄ†„ÄÇ",
                        highlight: "#actions-panel",
                        position: { top: "450px", left: "60%", width: "280px" }
                    },
                    // Ê≠•È©ü5: Âª∫ÁØâÂíåËä±È≠Ç
                    {
                        title: "Âª∫ÁØâËàáËä±È≠Ç",
                        content: "È¶ñÂÖàÈúÄË¶ÅÂª∫ÈÄ†Âª∫ÁØâÔºåÁÑ∂ÂæåÊâçËÉΩÁ®ÆÊ§çÂ∞çÊáâÁöÑËä±È≠Ç„ÄÇËä±È≠ÇÈúÄË¶ÅÁî®Ê∑öÊ∞¥ÊæÜÁÅåÊâçËÉΩÊàêÈï∑„ÄÇ",
                        highlight: "#flowers-panel",
                        position: { top: "350px", left: "75%" }
                    },
                    // Ê≠•È©ü6: Áµ≥Áè†Êî∂ÈõÜ
                    {
                        title: "Ê∑öÊ∞¥Êî∂ÈõÜ",
                        content: "ÈªûÊìä„ÄåÂ∞ãÊâæÁµ≥Áè†„ÄçÊåâÈàïÔºåÊî∂ÈõÜÈªõÁéâÁöÑÊ∑öÊ∞¥„ÄÇ‰∏çÂêåÊ∑öÊ∞¥Â∞ç‰∏çÂêåËä±È≠ÇÊúâÁâπÊÆäÊïàÊûú„ÄÇ",
                        highlight: "#collect-tears",
                        position: { top: "280px", left: "75%" }
                    },
                    // Ê≠•È©ü7: ÁØÄÊ∞£Á≥ªÁµ±
                    {
                        title: "ÁØÄÊ∞£ËàáËº™Ëø¥",
                        content: "ÊØè24ÂÄãÁØÄÊ∞£ÂÆåÊàê‰∏ÄÂÄãËº™Ëø¥„ÄÇ‰∏çÂêåÂ≠£ÁØÄÂ∞çËä±È≠ÇÁîüÈï∑Êúâ‰∏çÂêåÂΩ±Èüø„ÄÇÁâπÂÆöÁØÄÊ∞£ÊúÉËß∏ÁôºÁâπÊÆä‰∫ã‰ª∂„ÄÇ",
                        highlight: ".jieqi-indicator",
                        position: { top: "120px", right: "150px" }
                    },
                    // Ê≠•È©ü8: ÈñãÂßãÈÅäÊà≤
                    {
                        title: "ÈñãÂßãÊÇ®ÁöÑÈÇÑÊ∑ö‰πãÊóÖ",
                        content: "ÁèæÂú®ÔºåË´ãÂÖàÈªûÊìä„ÄåÂ∞ãÊâæÁµ≥Áè†„ÄçÊåâÈàïÊî∂ÈõÜÊ∑öÊ∞¥ÔºåÁÑ∂ÂæåÂª∫ÈÄ†‰∏ÄÂ∫ßÂª∫ÁØâÔºåÈñãÂßãÊÇ®ÁöÑÁ¥ÖÊ®ìÈÇÑÊ∑ö‰πãÊóÖÔºÅ",
                        highlight: "#collect-tears",
                        position: { top: "280px", left: "75%" }
                    }
                ];
                
                // Ê™¢Êü•ÊòØÂê¶Â∑≤ÂÆåÊàêÊïôÂ≠∏
                if (step >= tutorialSteps.length) {
                    gameData.tutorialCompleted = true;
                    if (elements.tutorialOverlay) {
                        elements.tutorialOverlay.classList.remove('active');
                    }
                    
                    // È°ØÁ§∫Á¨¨‰∏ÄÂÄãÊèêÁ§∫
                    showHint('Ê∫ñÂÇôÈñãÂßã', 'ÈªûÊìä„ÄåÂ∞ãÊâæÁµ≥Áè†„ÄçÊåâÈàïÊî∂ÈõÜÊ∑öÊ∞¥', 'üíß');
                    
                    // È´ò‰∫ÆÊé®Ëñ¶ÊåâÈàï
                    if (elements.collectTearsBtn) {
                        elements.collectTearsBtn.classList.add('recommended');
                    }
                    
                    return;
                }
                
                const currentStep = tutorialSteps[step];
                
                // ÊøÄÊ¥ªÊïôÂ≠∏Ë¶ÜËìãÂ±§
                if (elements.tutorialOverlay) {
                    elements.tutorialOverlay.classList.add('active');
                }
                
                // È´ò‰∫ÆÁõÆÊ®ôÂÖÉÁ¥†
                if (elements.tutorialHighlight) {
                    const targetElement = document.querySelector(currentStep.highlight);
                    if (targetElement) {
                        const rect = targetElement.getBoundingClientRect();
                        
                        elements.tutorialHighlight.style.width = `${rect.width + 10}px`;
                        elements.tutorialHighlight.style.height = `${rect.height + 10}px`;
                        elements.tutorialHighlight.style.top = `${rect.top - 5}px`;
                        elements.tutorialHighlight.style.left = `${rect.left - 5}px`;
                    }
                }
                
                // Ë®≠ÁΩÆÊèêÁ§∫Ê°Ü‰ΩçÁΩÆÂíåÂÖßÂÆπ
                if (elements.tutorialTooltip) {
                    for (const [key, value] of Object.entries(currentStep.position)) {
                        elements.tutorialTooltip.style[key] = value;
                    }
                    
                    if (elements.tutorialTitle) {
                        elements.tutorialTitle.textContent = currentStep.title;
                    }
                    
                    if (elements.tutorialContent) {
                        elements.tutorialContent.innerHTML = currentStep.content;
                    }
                    
                    if (elements.tutorialProgress) {
                        elements.tutorialProgress.textContent = `${step + 1}/${tutorialSteps.length}`;
                    }
                    
                    if (elements.tutorialNext) {
                        elements.tutorialNext.textContent = step === tutorialSteps.length - 1 ? 'ÂÆåÊàê' : '‰∏ã‰∏ÄÊ≠•';
                    }
                }
            }
            
            // È°ØÁ§∫ÊèêÁ§∫
            function showHint(title, message, icon = 'üí°') {
                if (!elements.hintContainer) return;
                
                const hintId = Date.now();
                const hintElement = document.createElement('div');
                hintElement.className = 'hint';
                hintElement.id = `hint-${hintId}`;
                hintElement.innerHTML = `
                    <span class="hint-close">&times;</span>
                    <div class="hint-title">
                        <span class="hint-icon">${icon}</span>
                        ${title}
                    </div>
                    <div class="hint-content">${message}</div>
                    <div class="hint-progress"></div>
                `;
                
                elements.hintContainer.appendChild(hintElement);
                
                // ÁÇ∫ÊèêÁ§∫Ê∑ªÂä†ÈóúÈñâ‰∫ã‰ª∂
                const closeBtn = hintElement.querySelector('.hint-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        removeHint(hintId);
                    });
                }
                
                // Âª∂ÈÅ≤È°ØÁ§∫ÔºåÊ∑ªÂä†ÂãïÁï´ÊïàÊûú
                setTimeout(() => {
                    hintElement.classList.add('show');
                }, 100);
                
                // 6ÁßíÂæåËá™ÂãïÊ∂àÂ§±
                setTimeout(() => {
                    removeHint(hintId);
                }, 6000);
            }
            
            // ÁßªÈô§ÊèêÁ§∫
            function removeHint(hintId) {
                const hintElement = document.getElementById(`hint-${hintId}`);
                if (hintElement) {
                    hintElement.classList.remove('show');
                    setTimeout(() => {
                        if (hintElement.parentNode) {
                            hintElement.parentNode.removeChild(hintElement);
                        }
                    }, 500);
                }
            }
            
            // Ê™¢Êü•Áî®Êà∂ÈñíÁΩÆÊôÇÈñì
            function checkIdleTime() {
                const currentTime = Date.now();
                const idleTime = currentTime - gameData.lastActionTime;
                
                // Â¶ÇÊûúÈñíÁΩÆÊôÇÈñìË∂ÖÈÅé30ÁßíÔºå‰∏îÊ≤íÊúâÊ¥ªË∫çÂ∞çË©±Ê°Ü
                if (idleTime > 30000 && 
                    !elements.dialogOverlay.classList.contains('active') && 
                    !elements.memoryDialogOverlay.classList.contains('active') &&
                    !elements.tutorialOverlay.classList.contains('active')) {
                    
                    // Êõ¥Êñ∞Âª∫Ë≠∞ÁöÑ‰∏ã‰∏ÄÊ≠•Êìç‰Ωú
                    updateSuggestedActions();
                    
                    // È°ØÁ§∫Êé®Ëñ¶Ë°åÂãï
                    showSuggestion();
                }
            }
            
            // Êõ¥Êñ∞Âª∫Ë≠∞ÁöÑ‰∏ã‰∏ÄÊ≠•Êìç‰Ωú
            function updateSuggestedActions() {
                // Ê†πÊìöÁï∂ÂâçÈÄ≤Â∫¶ÂàÜÊûê‰∏ã‰∏ÄÊ≠•ÊúÄ‰Ω≥Êìç‰Ωú
                const nextAction = {
                    nextBuildingId: null,
                    nextFlowerId: null,
                    nextAction: null
                };
                
                // Â¶ÇÊûúÊ≤íÊúâÊ∑öÊ∞¥ÔºåÂª∫Ë≠∞Êî∂ÈõÜÊ∑öÊ∞¥
                if (gameData.resources.tear === 0) {
                    nextAction.nextAction = 'collect-tears';
                }
                // Â¶ÇÊûúÊúâÊú™Âª∫ÈÄ†ÁöÑÂª∫ÁØâ‰∏îÊúâË∂≥Â§†Ë≥áÊ∫êÔºåÂª∫Ë≠∞Âª∫ÈÄ†
                else if (gameData.buildings.some(b => !b.built && b.unlocked && 
                    gameData.resources.tear >= b.cost.tear && 
                    gameData.resources.stone >= b.cost.stone)) {
                    
                    const nextBuilding = gameData.buildings.find(b => !b.built && b.unlocked && 
                        gameData.resources.tear >= b.cost.tear && 
                        gameData.resources.stone >= b.cost.stone);
                    
                    if (nextBuilding) {
                        nextAction.nextBuildingId = nextBuilding.id;
                    }
                }
                // Â¶ÇÊûúÊúâÊú™Á®ÆÊ§çÁöÑËä±È≠ÇÔºåÂª∫Ë≠∞Á®ÆÊ§ç
                else if (gameData.flowers.some(f => f.unlocked && f.position === -1)) {
                    const nextFlower = gameData.flowers.find(f => f.unlocked && f.position === -1);
                    if (nextFlower) {
                        nextAction.nextFlowerId = nextFlower.id;
                    }
                }
                // Â¶ÇÊûúÊúâÂ∑≤Á®ÆÊ§ç‰ΩÜÊú™ÊªøÁ¥öÁöÑËä±È≠Ç‰∏îÊúâÊ∑öÊ∞¥ÔºåÂª∫Ë≠∞ÊæÜÁÅå
                else if (gameData.flowers.some(f => f.position !== -1 && f.level < f.maxLevel) && 
                    gameData.resources.tear > 0) {
                    
                    // ‰∏çÁõ¥Êé•ÊåáÂÆöÊìç‰ΩúÔºåËÄåÊòØ‰æùË≥¥UIÁ™ÅÂá∫È°ØÁ§∫Ëä±È≠ÇÊ†ºÂ≠ê
                }
                // Â¶ÇÊûúÈùàÁü≥‰∏çË∂≥‰ΩÜÊ∑öÊ∞¥Ë∂≥Â§†ÔºåÂª∫Ë≠∞Â∞ãÊâæÂØ∂ÁéâÈ†òÊÇü
                else if (gameData.resources.stone < 10 && gameData.resources.tear >= 2) {
                    nextAction.nextAction = 'search-memories';
                }
                // ÂÖ∂‰ªñÊÉÖÊ≥ÅÔºåÊé®ÈÄ≤ÁØÄÊ∞£
                else {
                    nextAction.nextAction = 'advance-jieqi';
                }
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÊé®Ëñ¶Êìç‰Ωú
                gameData.suggestedActions = nextAction;
                
                return nextAction;
            }
            
            // È°ØÁ§∫Âª∫Ë≠∞Êìç‰Ωú
            function showSuggestion() {
                if (!elements.actionSuggestion) return;
                
                // Ê∫ñÂÇôÂª∫Ë≠∞ÊñáÊú¨Âíå‰ΩçÁΩÆ
                let suggestionText = '';
                let targetElement = null;
                let bubbleIcon = 'üí°';
                
                if (gameData.suggestedActions.nextBuildingId) {
                    // Âª∫Ë≠∞Âª∫ÈÄ†Âª∫ÁØâ
                    const building = gameData.buildings.find(b => b.id === gameData.suggestedActions.nextBuildingId);
                    suggestionText = `Âª∫Ë≠∞Âª∫ÈÄ† ${building?.name || 'Âª∫ÁØâ'}ÔºåÈªûÊìäÁ©∫ÁôΩÊ†ºÂ≠êÈñãÂßãÂª∫ÈÄ†`;
                    targetElement = document.querySelector(`.garden-cell:not(.has-building):not(.has-flower):not(.has-memory):not(.unlock-required)`);
                    bubbleIcon = 'üè†';
                } else if (gameData.suggestedActions.nextFlowerId) {
                    // Âª∫Ë≠∞Á®ÆÊ§çËä±È≠Ç
                    const flower = gameData.flowers.find(f => f.id === gameData.suggestedActions.nextFlowerId);
                    suggestionText = `Âª∫Ë≠∞Á®ÆÊ§ç ${flower?.character || 'Ëä±È≠Ç'}ÔºåÈªûÊìäÁ©∫ÁôΩÊ†ºÂ≠êÊîæÁΩÆËä±È≠Ç`;
                    targetElement = document.querySelector(`.garden-cell:not(.has-building):not(.has-flower):not(.has-memory):not(.unlock-required)`);
                    bubbleIcon = 'üå∫';
                } else if (gameData.suggestedActions.nextAction) {
                    // Âª∫Ë≠∞Âü∑Ë°åË°åÂãï
                    switch (gameData.suggestedActions.nextAction) {
                        case 'collect-tears':
                            suggestionText = `Âª∫Ë≠∞Êî∂ÈõÜÁµ≥Áè†ÔºåÁÇ∫Ëä±È≠ÇÊæÜÁÅåÊàñÂª∫ÁØâÊèê‰æõË≥áÊ∫ê`;
                            targetElement = elements.collectTearsBtn;
                            bubbleIcon = 'üíß';
                            break;
                        case 'search-memories':
                            suggestionText = `Âª∫Ë≠∞Â∞ãÊâæÂØ∂ÁéâÈ†òÊÇüÔºåÁç≤ÂèñÈùàÁü≥Áî®ÊñºÂª∫ÈÄ†`;
                            targetElement = elements.searchMemoriesBtn;
                            bubbleIcon = 'üß†';
                            break;
                        case 'advance-jieqi':
                            suggestionText = `Âª∫Ë≠∞Êé®ÈÄ≤ÁØÄÊ∞£ÔºåÂâçÈÄ≤Âà∞‰∏ã‰∏ÄÂÄãÊôÇÈñìÈªû`;
                            targetElement = elements.advanceJieqiBtn;
                            bubbleIcon = 'üå±';
                            break;
                    }
                }
                
                // Â¶ÇÊûúÊâæÂà∞ÁõÆÊ®ôÂÖÉÁ¥†ÔºåÂÆö‰ΩçÂíåÈ°ØÁ§∫Âª∫Ë≠∞
                if (targetElement && suggestionText) {
                    const rect = targetElement.getBoundingClientRect();
                    
                    // Ë®≠ÁΩÆÊ∞£Ê≥°‰ΩçÁΩÆÔºåÁõ°Èáè‰∏çÈÅÆÊìãÂÖÉÁ¥†
                    const bubbleElement = elements.actionSuggestion;
                    bubbleElement.style.top = `${rect.top - 70}px`;
                    bubbleElement.style.left = `${rect.left + rect.width / 2 - 125}px`;
                    
                    // Êõ¥Êñ∞Ê∞£Ê≥°ÂÖßÂÆπ
                    const bubbleTextElement = bubbleElement.querySelector('.bubble-text');
                    const bubbleIconElement = bubbleElement.querySelector('.bubble-icon');
                    
                    if (bubbleTextElement) bubbleTextElement.textContent = suggestionText;
                    if (bubbleIconElement) bubbleIconElement.textContent = bubbleIcon;
                    
                    // È°ØÁ§∫Ê∞£Ê≥°
                    bubbleElement.style.display = 'flex';
                    
                    // È´ò‰∫ÆÁõÆÊ®ôÂÖÉÁ¥†
                    if (gameData.suggestedActions.nextAction) {
                        const actionBtn = document.getElementById(`${gameData.suggestedActions.nextAction}`);
                        if (actionBtn) {
                            actionBtn.classList.add('recommended');
                            
                            // 5ÁßíÂæåÁßªÈô§È´ò‰∫Æ
                            setTimeout(() => {
                                actionBtn.classList.remove('recommended');
                            }, 5000);
                        }
                    }
                    
                    // 10ÁßíÂæåÈö±ËóèÊ∞£Ê≥°
                    setTimeout(() => {
                        bubbleElement.style.display = 'none';
                    }, 10000);
                }
            }
            
            // Âü∑Ë°åÊé®Ëñ¶Êìç‰Ωú
            function executeRecommendedAction() {
                if (gameData.suggestedActions.nextAction) {
                    // ÈªûÊìäÊé®Ëñ¶ÊåâÈàï
                    const actionBtn = document.getElementById(`${gameData.suggestedActions.nextAction}`);
                    if (actionBtn) {
                        actionBtn.click();
                    }
                } else if (gameData.suggestedActions.nextBuildingId || gameData.suggestedActions.nextFlowerId) {
                    // È°ØÁ§∫ÈÄöÁî®ÊèêÁ§∫
                    showHint('ÊèêÁ§∫', 'ÈªûÊìäÁ©∫ÁôΩÊ†ºÂ≠êÈñãÂßãÂª∫ÈÄ†ÊàñÁ®ÆÊ§ç', 'üîç');
                }
                
                // Èö±ËóèÂª∫Ë≠∞Ê∞£Ê≥°
                if (elements.actionSuggestion) {
                    elements.actionSuggestion.style.display = 'none';
                }
            }
        } // ÁµêÊùü initializeGame ÂáΩÊï∏
    </script>

</body></html>