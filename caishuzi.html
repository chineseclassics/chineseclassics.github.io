<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç§˜æ•¸å­—ç›’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow: hidden; /* éš±è— confetti é€ æˆçš„æ»¾å‹•æ¢ */
            background: radial-gradient(circle, #89f7fe 0%, #66a6ff 100%);
        }

        /* ç¥ç§˜ç›’å­å‹•ç•« */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        /* ç¥ç§˜ç›’å­ç™¼å…‰å‹•ç•« */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 35px rgba(251, 191, 36, 1); }
        }

        .bouncing-box {
            animation: bounce 2s infinite ease-in-out, glow 3s infinite ease-in-out;
        }

        /* éŒ¯èª¤æ™‚çš„æ–æ™ƒå‹•ç•« */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }

        /* æç¤ºè¨Šæ¯å‡ºç¾çš„å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
          appearance: textfield;
        }

        /* å‹åˆ©æ™‚çš„ confetti æ•ˆæœ */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            border-radius: 50%;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* åˆ†æ•¸å¢åŠ å‹•ç•« */
        @keyframes fadeUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(1.2); opacity: 0; }
        }
        .score-animation {
            animation: fadeUp 1.5s ease-out forwards;
        }

        /* ä¸€æ¬¡çŒœä¸­çš„æ…¶ç¥å‹•ç•« */
        @keyframes firstTryGlow {
            0%, 100% { box-shadow: 0 0 40px 10px rgba(255, 215, 0, 0.7); }
            50% { box-shadow: 0 0 70px 25px rgba(255, 215, 0, 1); }
        }
        .first-try-win {
            animation: firstTryGlow 2.5s ease-in-out;
        }

        /* ç¹¼çºŒæŒ‘æˆ°æŒ‰éˆ•å‘¼å¸ç™¼å…‰æ•ˆæœ */
        @keyframes breatheGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.45); transform: translateY(0); }
            50% { box-shadow: 0 0 20px 8px rgba(34, 197, 94, 0.28); transform: translateY(-1px); }
        }
        .btn-breathe {
            animation: breatheGlow 2.2s ease-in-out infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    <div id="game-container" class="relative bg-white w-11/12 max-w-md p-4 md:p-6 pb-16 md:pb-16 rounded-2xl shadow-2xl text-center transition-all duration-500">
        <!-- Language Switcher (moved to bottom) -->
        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 transform">
            <div class="bg-gray-100 rounded-full p-0.5 shadow-inner flex space-x-0.5">
                <button id="lang-zh" class="px-3 py-1 md:py-1.5 text-xs md:text-sm rounded-full transition shadow-sm bg-blue-500 text-white">ä¸­æ–‡</button>
                <button id="lang-en" class="px-3 py-1 md:py-1.5 text-xs md:text-sm rounded-full transition shadow-sm bg-white text-gray-600">EN</button>
            </div>
        </div>

        <span id="score-plus" class="absolute top-1/2 left-1/2 text-5xl font-bold text-yellow-400 opacity-0" style="transform: translate(-50%, -50%); text-shadow: 2px 2px 4px rgba(0,0,0,0.5); pointer-events: none; z-index: 10;"></span>
        
        <h1 data-i18n-key="title" class="text-2xl md:text-3xl font-bold text-blue-600 mb-2"></h1>
        <p data-i18n-key="prompt" class="text-gray-500 mb-3 text-sm md:text-base"></p>

        <!-- ç¥ç§˜ç›’å­ -->
        <div id="mystery-box-container" class="mb-4 md:mb-6">
            <div id="mystery-box" class="bouncing-box w-28 h-28 md:w-40 md:h-40 mx-auto bg-gradient-to-br from-yellow-300 to-orange-400 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-300">
                <span id="mystery-text" class="text-5xl md:text-7xl font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">?</span>
            </div>
        </div>

        <!-- éŠæˆ²äº’å‹•å€ -->
        <div id="interaction-area">
            <div class="flex flex-col sm:flex-row items-center justify-center gap-3 mb-4">
                <input type="number" id="guess-input" data-i18n-placeholder="inputPlaceholder" class="w-full sm:w-48 text-center text-xl p-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition">
                <button id="guess-button" data-i18n-key="guessButton" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold text-xl py-3 px-8 rounded-xl shadow-md transform hover:scale-105 transition"></button>
            </div>
        </div>
        
        <!-- æç¤ºè¨Šæ¯ -->
        <div id="hint-container" class="h-16 flex flex-col justify-center items-center">
            <p id="main-hint" class="text-xl font-semibold text-gray-700"></p>
            <p id="secondary-hint" class="text-md text-teal-600 font-medium mt-1"></p>
        </div>

        <!-- æ•¸å­—ç¯„åœæŒ‡ç¤ºå™¨ -->
        <div id="range-container" class="w-full bg-gray-200 rounded-full h-5 my-3 md:my-4 p-1 shadow-inner">
            <div id="range-bar" class="bg-gradient-to-r from-cyan-400 to-blue-500 h-full rounded-full transition-all duration-500 ease-out flex items-center justify-between text-white text-xs px-2 font-bold" style="margin-left: 0%; width: 100%;">
                <span id="range-min">1</span>
                <span class="opacity-75">--</span>
                <span id="range-max">100</span>
            </div>
        </div>

        <!-- éŠæˆ²è³‡è¨Šï¼ˆåˆ†æ•¸ã€æ¬¡æ•¸ã€ç­‰ç´šï¼‰ -->
        <div class="mt-2 md:mt-4 text-gray-500 flex justify-center items-center space-x-4 md:space-x-6 text-sm md:text-base">
            <p><span data-i18n-key="scoreLabel"></span><span id="score-display" class="font-bold text-lg text-blue-600">0</span></p>
            <p><span data-i18n-key="attemptsLabel"></span><span id="guess-count" class="font-bold">0</span></p>
            <p><span data-i18n-key="levelLabel" class="hidden sm:inline"></span><span id="level-name" class="font-bold text-lg text-purple-600">â€”</span></p>
        </div>

        <!-- ç­‰ç´šé€²åº¦æ¢ -->
        <div id="level-progress-container" class="mt-2 md:mt-3 px-2 hidden sm:block">
            <div class="bg-gray-200 rounded-full h-3 w-full overflow-hidden shadow-inner">
                <div id="level-progress-bar" class="h-full bg-gradient-to-r from-purple-400 to-indigo-500 transition-all duration-500" style="width: 0%;"></div>
            </div>
            <div class="mt-1 text-xs text-gray-600 text-center"><span id="level-progress-text">0 / 0</span></div>
        </div>

        <!-- å¾½ç« å€åŸŸ -->
        <div id="badge-area" class="mt-3 hidden sm:block">
            <div class="hidden">
                <span data-i18n-key="badgesLabel" class="mr-2"></span>
                <span id="badge-count" class="text-xs bg-gray-100 px-2 py-0.5 rounded-full">0</span>
            </div>
            <div id="badge-list" class="flex gap-2 flex-wrap justify-center"></div>
        </div>

        <!-- å‹åˆ©ç•«é¢ -->
        <div id="win-screen" class="hidden text-center">
            <button id="toggle-facts" class="sm:hidden inline-block mt-2 text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 border border-green-300">é¡¯ç¤ºå°çŸ¥è­˜</button>
            <div id="number-facts" class="hidden sm:block mt-3 md:mt-4 p-3 md:p-4 bg-green-100 border-l-4 border-green-500 text-green-800 text-left rounded-lg h-40 md:h-56 overflow-auto">
                <!-- æ•¸å­¸å°çŸ¥è­˜æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
            </div>
            <button id="restart-button" data-i18n-key="restartButton" class="mt-4 md:mt-5 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl shadow-md transform hover:scale-105 transition-transform text-lg btn-breathe"></button>
        </div>
    </div>

    <script>
    (function() {
        // DOM å…ƒç´ 
        const guessInput = document.getElementById('guess-input');
        const guessButton = document.getElementById('guess-button');
        const restartButton = document.getElementById('restart-button');
        const mainHint = document.getElementById('main-hint');
        const secondaryHint = document.getElementById('secondary-hint');
        const guessCountDisplay = document.getElementById('guess-count');
        const mysteryBox = document.getElementById('mystery-box');
        const mysteryText = document.getElementById('mystery-text');
        const gameContainer = document.getElementById('game-container');
        const rangeBar = document.getElementById('range-bar');
        const rangeMin = document.getElementById('range-min');
        const rangeMax = document.getElementById('range-max');
        const winScreen = document.getElementById('win-screen');
        const numberFacts = document.getElementById('number-facts');
        const scoreDisplay = document.getElementById('score-display');
        const scorePlus = document.getElementById('score-plus');
        const langZhBtn = document.getElementById('lang-zh');
        const langEnBtn = document.getElementById('lang-en');
        const levelNameEl = document.getElementById('level-name');
        const levelProgressBar = document.getElementById('level-progress-bar');
        const levelProgressText = document.getElementById('level-progress-text');
        const badgeCountEl = document.getElementById('badge-count');
        const badgeListEl = document.getElementById('badge-list');
        let currentLanguage = 'zh';

        const translations = {
            title: { zh: 'ç¥ç§˜æ•¸å­—ç›’', en: 'Mystery Number Box' },
            prompt: { zh: 'æˆ‘å¾ 1 åˆ° 100 é¸äº†ä¸€å€‹æ•¸å­—ï¼Œä½ çŒœå¾—åˆ°å—ï¼Ÿ', en: 'I picked a number from 1 to 100. Can you guess it?' },
            inputPlaceholder: { zh: 'è¼¸å…¥ä½ çš„çŒœæ¸¬...', en: 'Enter your guess...' },
            guessButton: { zh: 'çŒœçŒœçœ‹ï¼', en: 'Guess!' },
            scoreLabel: { zh: 'ç¸½åˆ†ï¼š', en: 'Score: ' },
            attemptsLabel: { zh: 'å·²çŒœæ¬¡æ•¸ï¼š', en: 'Attempts: ' },
            levelLabel: { zh: 'ç­‰ç´šï¼š', en: 'Level: ' },
            badgesLabel: { zh: 'å¾½ç« ', en: 'Badges' },
            restartButton: { zh: 'ç¹¼çºŒæŒ‘æˆ°', en: 'Continue' },
            invalidInput: { zh: 'è«‹è¼¸å…¥ 1 åˆ° 100 ä¹‹é–“çš„æ•¸å­—ï¼', en: 'Please enter a number between 1 and 100!' },
            tooHigh: { zh: 'å¤ªå¤§äº†ï¼', en: 'Too high!' },
            tooLow: { zh: 'å¤ªå°äº†ï¼', en: 'Too low!' },
            gettingWarmer: { zh: ' è¶Šä¾†è¶Šç†±äº†ï¼', en: ' Getting warmer!' },
            gettingColder: { zh: ' æœ‰é»å†·æ‰äº†...', en: ' Getting colder...' },
            correct: { zh: 'ç­”å°äº†ï¼å°±æ˜¯ {secretNumber}ï¼', en: 'Correct! The number is {secretNumber}!' },
            winJackpot: { zh: 'å¤©å•Šï¼ä¸€æ¬¡å°±çŒœä¸­ï¼ä½ æ˜¯ç¥é¸ä¹‹äººï¼ç²å¾— {points} åˆ†ï¼', en: 'Whoa! First try! You must be psychic! You get {points} points!' },
            winBonus: { zh: 'å¤ªå²å®³äº†ï¼åªç”¨äº† {guessCount} æ¬¡å°±çŒœå°ï¼Œç²å¾— {points} åˆ†ï¼', en: 'Amazing! Guessed in {guessCount} tries and got {points} points!' },
            winNoBonus: { zh: 'ä½ ç¸½å…±çŒœäº† {guessCount} æ¬¡ï¼å¤ªæ£’äº†ï¼', en: 'You guessed it in {guessCount} tries! Great job!' },
            hintOdd: { zh: 'æç¤ºï¼šç¥ç§˜æ•¸å­—æ˜¯å€‹ã€Œå¥‡æ•¸ã€å–”ï¼', en: 'Hint: The mystery number is an odd number!' },
            hintEven: { zh: 'æç¤ºï¼šç¥ç§˜æ•¸å­—æ˜¯å€‹ã€Œå¶æ•¸ã€å–”ï¼', en: 'Hint: The mystery number is an even number!' },
            hintMultiple10: { zh: 'æç¤ºï¼šé€™å€‹æ•¸å­—æ˜¯ 10 çš„å€æ•¸ã€‚', en: 'Hint: The number is a multiple of 10.' },
            hintMultiple5: { zh: 'æç¤ºï¼šé€™å€‹æ•¸å­—å¯ä»¥è¢« 5 æ•´é™¤ã€‚', en: 'Hint: The number is divisible by 5.' },
            hintPrime: { zh: 'æç¤ºï¼šé€™æ˜¯ä¸€å€‹ã€Œè³ªæ•¸ã€ï¼', en: 'Hint: It\'s a prime number!' },
            hintSumOfDigits: { zh: 'æç¤ºï¼šæ•¸å­—çš„ä½æ•¸åŠ ç¸½æ˜¯ {sum}ã€‚', en: 'Hint: The sum of its digits is {sum}.' },
            hintPerfectSquare: { zh: 'æç¤ºï¼šå®ƒæ˜¯ä¸€å€‹ã€Œå¹³æ–¹æ•¸ã€å–”ï¼(æŸå€‹æ•´æ•¸ä¹˜ä»¥è‡ªå·±)', en: 'Hint: It\'s a perfect square! (an integer multiplied by itself)' },
            hintTensDigit: { zh: 'æç¤ºï¼šå®ƒçš„åä½æ•¸æ˜¯ {digit}ã€‚', en: 'Hint: Its tens digit is {digit}.' },
            factsTitle: { zh: 'é—œæ–¼ {secretNumber} çš„å°çŸ¥è­˜ï¼š', en: 'Fun facts about {secretNumber}:' },
            factOdd: { zh: 'å®ƒæ˜¯ä¸€å€‹å¥‡æ•¸ã€‚', en: 'It is an odd number.' },
            factEven: { zh: 'å®ƒæ˜¯ä¸€å€‹å¶æ•¸ã€‚', en: 'It is an even number.' },
            factPrime: { zh: 'å®ƒæ˜¯ä¸€å€‹è³ªæ•¸ã€‚', en: 'It is a prime number.' },
            factPerfectSquare: { zh: 'å®ƒæ˜¯ {sqrt} çš„å¹³æ–¹ã€‚', en: 'It is the square of {sqrt}.' },
            factMultiple3: { zh: 'å®ƒæ˜¯ 3 çš„å€æ•¸ã€‚', en: 'It is a multiple of 3.' },
            factMultiple5: { zh: 'å®ƒæ˜¯ 5 çš„å€æ•¸ã€‚', en: 'It is a multiple of 5.' },
            factSumOfDigits: { zh: 'å®ƒçš„ä½æ•¸ç¸½å’Œæ˜¯ {sum}ã€‚', en: 'The sum of its digits is {sum}.' }
        };

        // ç­‰ç´šèˆ‡å¾½ç« ç³»çµ±
        const levels = [
            { name: { zh: 'è¦‹ç¿’æ¢éšªå®¶', en: 'Novice Explorer' }, min: 0,   max: 49 },
            { name: { zh: 'æ•¸å­—å­¸å¾’',   en: 'Number Apprentice' }, min: 50,  max: 99 },
            { name: { zh: 'é‚è¼¯å°èƒ½æ‰‹', en: 'Logic Adept' },      min: 100, max: 199 },
            { name: { zh: 'æ™ºæ…§è¡Œè€…',   en: 'Wise Walker' },      min: 200, max: 349 },
            { name: { zh: 'å¿ƒç®—é”äºº',   en: 'Mind Master' },      min: 350, max: 549 },
            { name: { zh: 'è¬é¡Œå¤§å¸«',   en: 'Puzzle Maestro' },   min: 550, max: 799 },
            { name: { zh: 'æ•¸å­—ç‹è€…',   en: 'Number Champion' },  min: 800, max: 1199 },
            { name: { zh: 'çŒœæ•¸å®—å¸«',   en: 'Grand Guesser' },    min: 1200, max: Infinity }
        ];

        const badgeCatalog = [
            { id: 'first-try', icon: 'ğŸ†', color: 'bg-amber-100 text-amber-700', rule: (ctx) => ctx.guessCount === 1, name: { zh: 'ç¥ä¾†ä¸€ç­†', en: 'First Shot' } },
            { id: 'under-3', icon: 'âš¡', color: 'bg-yellow-100 text-yellow-700', rule: (ctx) => ctx.guessCount <= 3, name: { zh: 'é›»å…‰ç«çŸ³', en: 'Lightning Fast' } },
            { id: 'over-10', icon: 'ğŸ§©', color: 'bg-gray-100 text-gray-700', rule: (ctx) => ctx.guessCount >= 10, name: { zh: 'è€å¿ƒæŒ‘æˆ°', en: 'Patient Solver' } },
            { id: 'is-prime', icon: 'ğŸ”·', color: 'bg-blue-100 text-blue-700', rule: (ctx) => ctx.isPrimeSecret, name: { zh: 'è³ªæ•¸çµäºº', en: 'Prime Hunter' } },
            { id: 'perfect-square', icon: 'â– ', color: 'bg-indigo-100 text-indigo-700', rule: (ctx) => ctx.isPerfectSquare, name: { zh: 'å¹³æ–¹è§€å¯Ÿå®¶', en: 'Square Spotter' } },
            { id: 'multiple-10', icon: 'ğŸ”Ÿ', color: 'bg-teal-100 text-teal-700', rule: (ctx) => ctx.isMultiple10, name: { zh: 'æ•´åå¦™æ‰‹', en: 'Deca Master' } },
            { id: 'score-200', icon: 'ğŸ¯', color: 'bg-green-100 text-green-700', rule: (ctx) => ctx.totalScore >= 200, name: { zh: 'ç™¾æ­¥ç©¿æ¥Š', en: 'Sharpshooter' } },
            { id: 'score-500', icon: 'ğŸ’', color: 'bg-purple-100 text-purple-700', rule: (ctx) => ctx.totalScore >= 500, name: { zh: 'å¯¶çŸ³çµäºº', en: 'Gem Hunter' } },
            { id: 'score-1000', icon: 'ğŸ‘‘', color: 'bg-rose-100 text-rose-700', rule: (ctx) => ctx.totalScore >= 1000, name: { zh: 'ç‹è€…åŠ å†•', en: 'Crowned' } },
            // æ–°å¢ï¼šé€£å‹ & å¿«é€Ÿé€£å‹ & é€£çºŒç™»å…¥å¾½ç« 
            { id: 'win-3', icon: 'ğŸ…', color: 'bg-slate-100 text-slate-700', rule: (ctx) => (ctx.winStreak || 0) >= 3, name: { zh: 'é€£å‹ä¸‰å±€', en: 'Win Streak x3' } },
            { id: 'win-5', icon: 'ğŸ¥‡', color: 'bg-amber-100 text-amber-700', rule: (ctx) => (ctx.winStreak || 0) >= 5, name: { zh: 'é€£å‹äº”å±€', en: 'Win Streak x5' } },
            { id: 'quick-3', icon: 'ğŸ”¥', color: 'bg-orange-100 text-orange-700', rule: (ctx) => (ctx.quickWinStreak || 0) >= 3, name: { zh: 'ä¸‰é€£é€Ÿå‹', en: 'Triple Quick Win' } },
            { id: 'daily-3', icon: 'ğŸ“…', color: 'bg-teal-100 text-teal-700', rule: (ctx) => (ctx.loginStreak || 0) >= 3, name: { zh: 'é€£ç™»ä¸‰æ—¥', en: 'Daily x3' } },
            { id: 'daily-7', icon: 'ğŸ“†', color: 'bg-blue-100 text-blue-700', rule: (ctx) => (ctx.loginStreak || 0) >= 7, name: { zh: 'é€£ç™»ä¸ƒæ—¥', en: 'Daily x7' } },
            { id: 'daily-14', icon: 'ğŸ—“ï¸', color: 'bg-indigo-100 text-indigo-700', rule: (ctx) => (ctx.loginStreak || 0) >= 14, name: { zh: 'é€£ç™»åå››æ—¥', en: 'Daily x14' } }
        ];

        function getLevelByScore(score) {
            return levels.find(l => score >= l.min && score <= l.max) || levels[levels.length - 1];
        }

        function getNextLevelThreshold(score) {
            const level = getLevelByScore(score);
            return level.max === Infinity ? { currentMin: level.min, next: null } : { currentMin: level.min, next: level.max + 1 };
        }

        function renderLevel() {
            const level = getLevelByScore(totalScore);
            const name = level.name[currentLanguage];
            levelNameEl.textContent = name;
            const { currentMin, next } = getNextLevelThreshold(totalScore);
            if (next === null) {
                levelProgressBar.style.width = '100%';
                levelProgressText.textContent = `${totalScore - currentMin} / âˆ`;
            } else {
                const span = next - currentMin;
                const progressed = Math.max(0, totalScore - currentMin);
                const pct = Math.min(100, Math.round((progressed / span) * 100));
                levelProgressBar.style.width = pct + '%';
                levelProgressText.textContent = `${progressed} / ${span}`;
            }
        }

        // å¾½ç« å­˜å–
        const STORAGE_KEY = 'caishuzi_profile_v1';
        function loadProfile() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { totalScore: 0, badges: [] }; } catch { return { totalScore: 0, badges: [] }; }
        }
        function saveProfile(profile) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
        }

        let totalScore = 0;
        let profile = loadProfile();
        let earnedBadges = new Set(profile.badges || []);
        if (!isNaN(profile.totalScore)) totalScore = profile.totalScore; // è¦†è“‹åˆå§‹ç¸½åˆ†
        profile.loginStreak = Number(profile.loginStreak || 0);
        profile.winStreak = Number(profile.winStreak || 0);
        profile.quickWinStreak = Number(profile.quickWinStreak || 0);

        function getTodayDateStr() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function updateDailyStreak() {
            const today = getTodayDateStr();
            const last = profile.lastLoginDate;
            if (!last) {
                profile.lastLoginDate = today;
                profile.loginStreak = 1;
                saveProfile(profile);
                return true;
            }
            if (today === last) return false;
            const lastDate = new Date(last + 'T00:00:00');
            const todayDate = new Date(today + 'T00:00:00');
            const diffDays = Math.round((todayDate - lastDate) / 86400000);
            if (diffDays === 1) profile.loginStreak = (profile.loginStreak || 0) + 1; else profile.loginStreak = 1;
            profile.lastLoginDate = today;
            saveProfile(profile);
            return true;
        }

        // æ›´æ–°æ¯æ—¥ç™»å…¥é€£çºŒå¤©æ•¸ä¸¦å˜—è©¦æˆäºˆç™»å…¥å¾½ç« 
        updateDailyStreak();
        tryAwardBadges({
            guessCount: 0,
            totalScore,
            isPrimeSecret: false,
            isPerfectSquare: false,
            isMultiple10: false,
            loginStreak: profile.loginStreak,
            winStreak: profile.winStreak,
            quickWinStreak: profile.quickWinStreak
        });
        renderBadges();

        function tryAwardBadges(context) {
            let newly = [];
            badgeCatalog.forEach(b => {
                if (!earnedBadges.has(b.id) && b.rule(context)) {
                    earnedBadges.add(b.id);
                    newly.push(b.id);
                }
            });
            if (newly.length > 0) {
                profile.totalScore = totalScore;
                profile.badges = Array.from(earnedBadges);
                saveProfile(profile);
                renderBadges();
            }
        }

        function renderBadges() {
            const list = Array.from(earnedBadges);
            badgeCountEl.textContent = String(list.length);
            badgeListEl.innerHTML = list.map(id => {
                const b = badgeCatalog.find(x => x.id === id);
                if (!b) return '';
                const label = b.name[currentLanguage];
                return `<span class="${b.color} px-2 py-1 rounded-full text-xs shadow-sm inline-flex items-center gap-1" title="${label}">${b.icon}<span>${label}</span></span>`;
            }).join('');
        }

        // éŠæˆ²ç‹€æ…‹è®Šæ•¸
        let secretNumber, guessCount, isGameOver;
        let givenHints = [];
        let minRange, maxRange, previousGuess;
        let lastHint = { mainKey: '', status: '', secondaryKey: '', params: {}, warmerColderKey: '' };

        // --- è¼”åŠ©å‡½å¼ ---
        const isPrime = num => { if (num <= 1) return false; for (let i = 2; i * i <= num; i++) if (num % i === 0) return false; return true; };
        const getSumOfDigits = num => String(num).split('').reduce((acc, digit) => acc + Number(digit), 0);
        const isPerfectSquare = num => Math.sqrt(num) % 1 === 0;
        const t = (key, params = {}) => {
            let text = translations[key]?.[currentLanguage] || key;
            for (const [paramKey, paramValue] of Object.entries(params)) {
                text = text.replace(`{${paramKey}}`, paramValue);
            }
            return text;
        };

        // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
        function initGame() {
            secretNumber = Math.floor(Math.random() * 100) + 1;
            guessCount = 0;
            isGameOver = false;
            givenHints = [];
            minRange = 1;
            maxRange = 100;
            previousGuess = null;
            lastHint = { mainKey: '', status: '', secondaryKey: '', params: {}, warmerColderKey: '' };
            
            mainHint.textContent = '';
            secondaryHint.textContent = '';
            guessCountDisplay.textContent = '0';
            guessInput.value = '';
            guessInput.disabled = false;
            guessButton.disabled = false;
            winScreen.classList.add('hidden');
            document.getElementById('interaction-area').style.display = 'block';
            
            gameContainer.classList.remove('first-try-win');
            mysteryBox.classList.remove('bg-green-500');
            mysteryBox.classList.add('bg-gradient-to-br', 'from-yellow-300', 'to-orange-400');
            mysteryText.textContent = '?';
            mysteryBox.classList.add('bouncing-box');
            updateRangeIndicator();
            updateLanguageUI();
            renderLevel();
            renderBadges();
            // é‡æ–°é–‹å§‹æ™‚æ¢å¾©è¢«æ”¶èµ·çš„å€å¡Š
            document.getElementById('hint-container').classList.remove('hidden');
            document.getElementById('range-container').classList.remove('hidden');
            document.getElementById('level-progress-container').classList.remove('hidden');
            document.getElementById('badge-area').classList.remove('hidden');
        }

        // é‡é–‹éŠæˆ²è¦–ç‚ºæ–°å±€é–‹å§‹ï¼šè‹¥ä¸Šä¸€å±€æœªå‹åˆ©çµæŸï¼Œé‡ç½®é€£å‹
        // æ­¤è™•ä¿æŒç¾é‚è¼¯ï¼šåªæœ‰åœ¨å‹åˆ©æ™‚æ‰éå¢é€£å‹ï¼Œç©å®¶æŒ‰é‡æ–°é–‹å§‹ä¸å½±éŸ¿å·²ç´¯ç©é€£å‹

        function handleGuess() {
            if (isGameOver) return;
            const userGuess = parseInt(guessInput.value);
            if (isNaN(userGuess) || userGuess < 1 || userGuess > 100) {
                displayHint('invalidInput', 'warning');
                return;
            }
            guessCount++;
            guessCountDisplay.textContent = guessCount;
            guessInput.value = '';
            guessInput.focus();
            if (userGuess === secretNumber) {
                winGame();
            } else {
                giveFeedback(userGuess);
                updateRange(userGuess);
            }
            previousGuess = userGuess;
        }

        function updateRange(guess) {
            if (guess < secretNumber) minRange = Math.max(minRange, guess + 1);
            else maxRange = Math.min(maxRange, guess - 1);
            updateRangeIndicator();
        }

        function winGame(isLangUpdate = false) {
            if (!isLangUpdate) {
                isGameOver = true;
                guessInput.disabled = true;
                guessButton.disabled = true;
                mysteryBox.classList.remove('bouncing-box', 'bg-gradient-to-br', 'from-yellow-300', 'to-orange-400');
                mysteryBox.classList.add('bg-green-500');
                mysteryText.textContent = secretNumber;
                document.getElementById('interaction-area').style.display = 'none';
                winScreen.classList.remove('hidden');
            }

            mainHint.textContent = t('correct', { secretNumber });
            mainHint.className = 'text-2xl font-bold text-green-600';
            
            const scoreMap = { 1: 100, 2: 40, 3: 30, 4: 20, 5: 10 };
            const points = scoreMap[guessCount] || 0;

            if (!isLangUpdate) {
                if (points > 0) {
                    totalScore += points;
                    scoreDisplay.textContent = totalScore;
                    profile.totalScore = totalScore;
                    // é€£å‹è¨ˆæ•¸æ›´æ–°
                    profile.winStreak = (profile.winStreak || 0) + 1;
                    // å¿«é€Ÿé€£å‹ï¼šæœ¬å±€â‰¤5æ¬¡å³è¦–ç‚ºå¿«é€Ÿå‹
                    if (guessCount <= 5) profile.quickWinStreak = (profile.quickWinStreak || 0) + 1; else profile.quickWinStreak = 0;
                    saveProfile(profile);
                    renderLevel();
                    showScoreAnimation(`+${points}`);
                } else {
                    // ç„¡åŠ åˆ†ä¹Ÿè¨ˆç‚ºå‹åˆ©ï¼Œç¶­æŒé€£å‹ä½†é‡ç½®å¿«é€Ÿé€£å‹ï¼ˆè‹¥>5æ¬¡ï¼‰
                    profile.winStreak = (profile.winStreak || 0) + 1;
                    if (guessCount <= 5) profile.quickWinStreak = (profile.quickWinStreak || 0) + 1; else profile.quickWinStreak = 0;
                    saveProfile(profile);
                }
            }
            
            if (guessCount === 1) {
                secondaryHint.textContent = t('winJackpot', { points: 100 });
                 if (!isLangUpdate) {
                    gameContainer.classList.add('first-try-win');
                    setTimeout(() => gameContainer.classList.remove('first-try-win'), 2500);
                    createConfetti(250, true);
                }
            } else if (points > 0) {
                secondaryHint.textContent = t('winBonus', { guessCount, points });
                if (!isLangUpdate) createConfetti();
            } else {
                secondaryHint.textContent = t('winNoBonus', { guessCount });
                if (!isLangUpdate) createConfetti();
            }

            displayNumberFacts();

            // æˆäºˆå¾½ç« 
            const context = {
                guessCount,
                totalScore,
                isPrimeSecret: isPrime(secretNumber),
                isPerfectSquare: isPerfectSquare(secretNumber),
                isMultiple10: secretNumber % 10 === 0,
                loginStreak: profile.loginStreak,
                winStreak: profile.winStreak,
                quickWinStreak: profile.quickWinStreak
            };
            tryAwardBadges(context);

            // å‹åˆ©å¾Œæ”¶èµ·æ¬¡è¦å€å¡Šï¼Œçµ¦ã€Œå†æ¬¡æŒ‘æˆ°ã€é¨°ä½ç½®
            // æ‰‹æ©Ÿè¦–åœ–å¯éš±è—éƒ¨åˆ†å€å¡Šï¼›æ¡Œé¢ä¿ç•™
            if (window.innerWidth < 640) {
                document.getElementById('hint-container').classList.add('hidden');
                document.getElementById('range-container').classList.add('hidden');
                document.getElementById('level-progress-container').classList.add('hidden');
                document.getElementById('badge-area').classList.add('hidden');
            }
        }

        // --- UI æ›´æ–°å‡½å¼ ---
        function updateLanguageUI() {
            document.querySelectorAll('[data-i18n-key]').forEach(el => el.textContent = t(el.getAttribute('data-i18n-key')));
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
            
            if (currentLanguage === 'zh') {
                langZhBtn.classList.replace('bg-white', 'bg-blue-500');
                langZhBtn.classList.replace('text-gray-600', 'text-white');
                langEnBtn.classList.replace('bg-blue-500', 'bg-white');
                langEnBtn.classList.replace('text-white', 'text-gray-600');
            } else {
                langEnBtn.classList.replace('bg-white', 'bg-blue-500');
                langEnBtn.classList.replace('text-gray-600', 'text-white');
                langZhBtn.classList.replace('bg-blue-500', 'bg-white');
                langZhBtn.classList.replace('text-white', 'text-gray-600');
            }
            
            if (lastHint.mainKey) displayHint(lastHint.mainKey, lastHint.status, lastHint.secondaryKey, lastHint.params, lastHint.warmerColderKey);
            if (isGameOver) winGame(true);
            // å¤šèªè¨€åŒæ­¥
            renderLevel();
            renderBadges();
        }

        function updateRangeIndicator() {
            const leftPercent = ((minRange - 1) / 99) * 100;
            const widthPercent = ((maxRange - minRange + 1) / 100) * 100;
            rangeBar.style.marginLeft = `${leftPercent}%`;
            rangeBar.style.width = `${widthPercent}%`;
            rangeMin.textContent = minRange;
            rangeMax.textContent = maxRange;
        }

        function displayHint(mainKey, status = 'info', secondaryKey = '', params = {}, warmerColderKey = '') {
            lastHint = { mainKey, status, secondaryKey, params, warmerColderKey };

            let mainText = t(mainKey, params);
            if (warmerColderKey) {
                mainText += t(warmerColderKey);
            }
            mainHint.textContent = mainText;

            mainHint.classList.remove('fade-in'); void mainHint.offsetWidth; mainHint.classList.add('fade-in');
            
            secondaryHint.textContent = secondaryKey ? t(secondaryKey, params) : '';
            if(secondaryKey) { secondaryHint.classList.remove('fade-in'); void secondaryHint.offsetWidth; secondaryHint.classList.add('fade-in'); }
            const colorMap = { 'too-high':'text-red-500', 'too-low':'text-blue-500', 'warning':'text-yellow-600', 'info':'text-gray-700' };
            mainHint.className = `text-xl font-semibold ${colorMap[status] || colorMap['info']}`;
        }
        
        function giveFeedback(guess) {
            gameContainer.classList.remove('shake-animation'); void gameContainer.offsetWidth; gameContainer.classList.add('shake-animation');
            let mainKey = guess > secretNumber ? 'tooHigh' : 'tooLow';
            let status = guess > secretNumber ? 'too-high' : 'too-low';
            let warmerColderKey = '';
            
            if (previousGuess !== null) {
                const prevDiff = Math.abs(secretNumber - previousGuess);
                const currDiff = Math.abs(secretNumber - guess);
                if (currDiff < prevDiff) warmerColderKey = 'gettingWarmer';
                else if (currDiff > prevDiff) warmerColderKey = 'gettingColder';
            }

            const funHint = getFunHint();
            displayHint(mainKey, status, funHint.key, funHint.params, warmerColderKey);
        }

        function getFunHint() {
            const hintFunctions = [];
            const add = (key, func) => { if (!givenHints.includes(key)) hintFunctions.push(() => { givenHints.push(key); return func(); }); };
            add('oddEven', () => ({ key: secretNumber % 2 === 0 ? 'hintEven' : 'hintOdd' }));
            if (secretNumber % 10 === 0) add('multiple10', () => ({ key: 'hintMultiple10' }));
            else if (secretNumber % 5 === 0) add('multiple5', () => ({ key: 'hintMultiple5' }));
            if (isPrime(secretNumber)) add('prime', () => ({ key: 'hintPrime' }));
            if (secretNumber > 9) add('sumOfDigits', () => ({ key: 'hintSumOfDigits', params: { sum: getSumOfDigits(secretNumber) }}));
            if (isPerfectSquare(secretNumber)) add('perfectSquare', () => ({ key: 'hintPerfectSquare' }));
            if (secretNumber > 9) add('tensDigit', () => ({ key: 'hintTensDigit', params: { digit: Math.floor(secretNumber / 10) }}));
            if (hintFunctions.length > 0) return hintFunctions[Math.floor(Math.random() * hintFunctions.length)]();
            return { key: '', params: {} };
        }
        
        function displayNumberFacts() {
            let facts = `<p class="font-bold text-lg mb-2">${t('factsTitle', { secretNumber })}</p><ul class="list-disc list-inside space-y-1">`;
            facts += `<li>${t(secretNumber % 2 === 0 ? 'factEven' : 'factOdd')}</li>`;
            if (isPrime(secretNumber)) facts += `<li>${t('factPrime')}</li>`;
            if (isPerfectSquare(secretNumber)) facts += `<li>${t('factPerfectSquare', { sqrt: Math.sqrt(secretNumber) })}</li>`;
            if (secretNumber % 3 === 0) facts += `<li>${t('factMultiple3')}</li>`;
            if (secretNumber % 5 === 0) facts += `<li>${t('factMultiple5')}</li>`;
            if (secretNumber > 9) facts += `<li>${t('factSumOfDigits', { sum: getSumOfDigits(secretNumber) })}</li>`;
            facts += '</ul>';
            numberFacts.innerHTML = facts;
        }

        function showScoreAnimation(text) { scorePlus.textContent = text; scorePlus.classList.remove('score-animation'); void scorePlus.offsetWidth; scorePlus.classList.add('score-animation'); }
        
        function createConfetti(count = 100, isJackpot = false) {
            for (let i = 0; i < count; i++) {
                const c = document.createElement('div');
                c.classList.add('confetti');
                c.style.left = Math.random() * 100 + 'vw';
                c.style.top = -20 + 'px';
                c.style.animationDelay = Math.random() * 3 + 's';
                c.style.animationDuration = (Math.random() * 2 + 3) + 's';
                if (isJackpot) {
                    const colors = ['#ffd700', '#ffdf00', '#f0e68c', '#ffffff', '#c0c0c0'];
                    c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    c.style.transform = `scale(${Math.random() * 0.5 + 0.75})`;
                } else {
                    c.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                }
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 5000);
            }
        }

        // äº‹ä»¶ç›£è½
        guessButton.addEventListener('click', handleGuess);
        guessInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleGuess(); });
        restartButton.addEventListener('click', initGame);
        langZhBtn.addEventListener('click', () => { currentLanguage = 'zh'; updateLanguageUI(); });
        langEnBtn.addEventListener('click', () => { currentLanguage = 'en'; updateLanguageUI(); });
        const toggleFactsBtn = document.getElementById('toggle-facts');
        if (toggleFactsBtn) {
            toggleFactsBtn.addEventListener('click', () => {
                const nf = document.getElementById('number-facts');
                const hidden = nf.classList.toggle('hidden');
                toggleFactsBtn.textContent = hidden ? 'é¡¯ç¤ºå°çŸ¥è­˜' : 'éš±è—å°çŸ¥è­˜';
            });
        }

        // å•Ÿå‹•éŠæˆ²
        initGame();
    })();
    </script>
</body>
</html>


