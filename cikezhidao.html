<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>刺客之道 - 《史記·刺客列傳》互動遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4B4A9F',
                        light: '#FFFFFF',
                        dark: '#181818',
                    },
                },
                fontFamily: {
                    sans: ['Noto Sans TC', 'sans-serif'],
                }
            },
            darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }


        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .story-text {
            text-align: justify;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        /* 打字機效果 */
        .typing-effect::after {
            content: '|';
            animation: cursor-blink 0.8s step-end infinite;
        }
        
        @keyframes cursor-blink {
            from, to { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .skip-typing {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(93, 92, 222, 0.15);
            color: #5D5CDE;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            opacity: 0.8;
        }
        
        .skip-typing:hover {
            background: rgba(93, 92, 222, 0.3);
            opacity: 1;
        }
        
        .skip-typing svg {
            margin-right: 4px;
        }
        /* 暗模式樣式 */
        .dark .story-container {
            background-color: #242424;
            color: #E8E8E8;
        }
        .dark .choice-btn {
            background-color: #333333;
            color: #FFFFFF;
            border-color: #444444;
        }
        .dark .choice-btn:hover {
            background-color: #4B4A9F;
        }
        .character-card {
            transition: transform 0.3s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .character-card:hover {
            transform: translateY(-8px);
            border-color: #5D5CDE;
        }
        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #5D5CDE, #7A79FF);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .character-card:hover::before {
            opacity: 1;
        }
        
        /* 刺客精神视觉标识 */
        .character-card.has-spirit {
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.4);
            border: 2px solid #5D5CDE;
        }
        .character-card.has-spirit::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 1px solid rgba(93, 92, 222, 0.7);
            pointer-events: none;
            z-index: 1;
            border-radius: 4px;
        }
        .spirit-badge {
            background: rgba(93, 92, 222, 0.2);
            color: #5D5CDE;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px auto;
            width: fit-content;
            animation: spiritPulse 2s infinite;
        }
        @keyframes spiritPulse {
            0% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(93, 92, 222, 0); }
            100% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0); }
        }
        .title-brush {
            position: relative;
            display: inline-block;
            padding: 0 20px;
        }
        .title-brush::before {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #5D5CDE 20%, #5D5CDE 80%, transparent);
        }
        .ancient-border {
            border: 2px solid #5D5CDE;
            border-radius: 8px;
            box-shadow: 0 0 0 1px rgba(93, 92, 222, 0.2);
            position: relative;
        }
        .ancient-border::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 1px solid rgba(93, 92, 222, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }
        .scroll-bg {
            /* 背景圖片已移除 */
        }

        /* 成就徽章樣式 */
        .achievement {
            position: relative;
            transition: all 0.3s ease;
        }
        .achievement:hover {
            transform: translateY(-5px);
        }
        .achievement.locked {
            filter: grayscale(100%);
            opacity: 0.6;
        }
        .achievement.locked:hover {
            filter: grayscale(70%);
        }
        .achievement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(93, 92, 222, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .achievement-popup.show {
            transform: translateY(0);
            opacity: 1;
        }
        /* 結局解鎖彈窗樣式 - 使用ID選擇器提高特異性 */
        #ending-unlock-popup {
            bottom: 100px !important; /* 將結局解鎖通知放在成就通知的上方，使用!important確保優先級 */
        }

        /* 結局收集視覺效果 */
        .ending-badge {
            background: linear-gradient(135deg, #5D5CDE, #7A79FF);
            box-shadow: 0 2px 5px rgba(93, 92, 222, 0.3);
            animation: pulse 2s infinite;
        }
        .ending-progress {
            height: 8px;
            transition: width 0.5s ease;
            border-radius: 4px;
            background: linear-gradient(90deg, #5D5CDE, #7A79FF);
        }
        .ending-card {
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem 0.75rem;
        }
        .ending-card.locked {
            filter: blur(3px);
        }
        .ending-card:hover {
            transform: translateY(-5px);
        }
        .ending-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #5D5CDE, #7A79FF);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .ending-card:hover::before {
            opacity: 1;
        }
        .ending-lock {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #5D5CDE;
        }
        .ending-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ending-type-good {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }
        .ending-type-bad {
            background: linear-gradient(135deg, #F44336, #FF9800);
            color: white;
        }
        .ending-type-neutral {
            background: linear-gradient(135deg, #9E9E9E, #607D8B);
            color: white;
        }
        .ending-type-secret {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            color: white;
        }
        
        /* 決策樹視覺效果 */
        .decision-tree {
            position: relative;
        }
        .decision-node {
            position: relative;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .decision-node:hover {
            transform: translateY(-2px);
        }
        .decision-node::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            width: 2px;
            height: 15px;
            background-color: #5D5CDE;
        }
        .decision-node:last-child::after {
            display: none;
        }
        .decision-explored {
            border: 2px solid #5D5CDE;
            background-color: rgba(93, 92, 222, 0.1);
        }
        .decision-unexplored {
            border: 2px dashed #9E9E9E;
            background-color: rgba(158, 158, 158, 0.1);
        }
        
        /* 結局收集進度條動畫 */
        @keyframes progressFill {
            from { width: 0; }
            to { width: var(--target-width); }
        }
        .animate-progress {
            animation: progressFill 1s ease forwards;
        }
        
        /* 結局收集獎勵提示 */
        .reward-icon {
            display: inline-block;
            margin-left: 5px;
            vertical-align: middle;
            color: gold;
            animation: pulse 2s infinite;
        }
        
        /* 新增：角色卡片互動效果 */
        .character-card .completion-ring {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(#5D5CDE var(--percent), transparent var(--percent));
            transform: rotate(-90deg);
        }
        .character-card .completion-ring::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border-radius: 50%;
            background-color: white;
            z-index: 1;
        }
        .character-card .completion-ring::after {
            content: attr(data-percent);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #5D5CDE;
            transform: rotate(90deg);
            z-index: 2;
        }
        .dark .character-card .completion-ring::before {
            background-color: #333;
        }
        
        /* 決策引導提示 */
        .choice-hint {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            cursor: help;
        }
        .hint-rare {
            background-color: #9C27B0;
        }
        .hint-good {
            background-color: #4CAF50;
        }
        .hint-bad {
            background-color: #F44336;
        }
        
        /* 結局收集統計 */
        .stats-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            background-color: rgba(93, 92, 222, 0.2);
            color: #5D5CDE;
            margin-left: 5px;
        }
        
        /* 時間限制選擇的視覺效果 */
        @keyframes urgentPulse {
          0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
          50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        
        .urgent-choice {
          animation: urgentPulse 1.5s infinite;
          border-color: #ef4444 !important;
        }
        
        @keyframes countdown-flash {
          0%, 49% { color: white; }
          50%, 100% { color: #fecaca; }
        }
        
        .countdown-urgent {
          animation: countdown-flash 0.5s infinite;
          font-weight: bold;
        }
        
        /* 教學提示動畫 */
        @keyframes tutorialFadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        .tutorial-animation {
          animation: tutorialFadeIn 0.4s ease-out;
        }
        
        /* 開關按鈕樣式 - 高級美化優化版 */
        .toggle-container {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 22px;
            vertical-align: middle;
        }
        
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-label {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: linear-gradient(to right, #e0e0e0, #d0d0d0);
            transition: all 0.4s cubic-bezier(0.17, 0.67, 0.43, 1.26);
            border-radius: 34px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1),
                         0 1px 2px rgba(255, 255, 255, 0.7);
        }
        
        .dark .toggle-label {
            background: linear-gradient(to right, #444, #333);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2),
                         0 1px 2px rgba(255, 255, 255, 0.05);
        }
        
        .toggle-label:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ffffff, #f5f5f5);
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.17, 0.67, 0.43, 1.26);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .dark .toggle-label:before {
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
        }
        
        .toggle-checkbox:checked + .toggle-label {
            background: linear-gradient(to right, #6A67E5, #5D5CDE);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1),
                         0 1px 3px rgba(93, 92, 222, 0.3);
        }
        
        .toggle-checkbox:checked + .toggle-label:before {
            transform: translateX(20px) translateY(-50%);
            background: linear-gradient(135deg, #ffffff, #f8f8f8);
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.15);
        }
        
        .toggle-label:after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 34px;
            opacity: 0;
            background: rgba(255, 255, 255, 0.2);
            transition: opacity 0.3s ease;
        }
        
        .toggle-label:hover:after {
            opacity: 1;
        }
        
        .toggle-checkbox:active + .toggle-label:before {
            transform: translateY(-50%) scale(0.85);
            width: 20px;
        }
        
        .toggle-checkbox:checked:active + .toggle-label:before {
            transform: translateX(18px) translateY(-50%) scale(0.85);
            width: 20px;
        }
        
        /* 微妙的開關動畫 */
        @keyframes toggleOn {
            0% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0); }
            50% { box-shadow: 0 0 0 4px rgba(93, 92, 222, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0); }
        }
        
        .toggle-checkbox:checked + .toggle-label {
            animation: toggleOn 0.5s ease-out;
        }
        
        /* 首頁成就徽章樣式 */
        .home-achievement-badge {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .home-achievement-badge.unlocked {
            background: linear-gradient(135deg, #5D5CDE, #7A79FF);
            color: white;
            box-shadow: 0 4px 8px rgba(93, 92, 222, 0.3);
        }
        
        .home-achievement-badge.locked {
            background: #E5E5E5;
            color: #9E9E9E;
            filter: grayscale(100%);
            opacity: 0.6;
        }
        
        .dark .home-achievement-badge.locked {
            background: #4A4A4A;
            color: #7E7E7E;
        }
        
        .home-achievement-badge:hover {
            transform: translateY(-5px);
        }
        
        .home-achievement-badge.locked:hover {
            opacity: 0.8;
        }
        
        .home-achievement-tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            transition: transform 0.2s ease;
            z-index: 10;
            pointer-events: none;
        }
        
        .home-achievement-badge:hover .home-achievement-tooltip {
            transform: translateX(-50%) scale(1);
        }
    </style>
</head>
<body class="bg-light dark:bg-dark text-gray-800 dark:text-gray-200 transition-colors duration-200 scroll-bg">
    <div class="container mx-auto px-4 py-4 max-w-6xl">
        <!-- 遊戲標題 -->
        <div class="text-center mb-6">
            <div class="mb-3">
                <h1 class="text-4xl md:text-5xl font-bold text-primary title-brush">刺客之道</h1>
            </div>
            <p class="text-lg mt-2 text-gray-600 dark:text-gray-400">品刺客千秋義　定歷史一瞬局</p>
        </div>

        <!-- 遊戲介紹與進度展示面板 -->
        <div id="game-introduction" class="mb-6 max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
                <!-- 左側：遊戲介紹 -->
                <div class="lg:col-span-4 p-3 rounded-lg bg-white/80 dark:bg-gray-800/80 shadow-lg ancient-border h-full">
                    <h2 class="text-lg font-bold mb-2 text-center text-primary">遊戲簡介</h2>
                    <p class="mb-3 text-base text-gray-700 dark:text-gray-300">《刺客之道》是基於司馬遷《史記·刺客列傳》創作的互動小說遊戲。在遊戲中，你將扮演中國古代五位著名刺客，體驗生死抉擇與忠義情懷。</p>
                    
                    <!-- 更精簡的遊戲說明 -->
                    <div class="mb-2">
                        <div class="grid grid-cols-1 gap-2 text-sm text-gray-700 dark:text-gray-300">
                            <div class="p-2 bg-primary/5 rounded-md">
                                <div class="flex items-center mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8z" />
                                        <path d="M12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" />
                                    </svg>
                                    <p class="font-semibold">選擇與結局</p>
                                </div>
                                <p class="pl-5.5">做出抉擇，影響故事走向。每位刺客有多種不同結局，探索全部結局可提高遊戲進度。關鍵時刻會有限時選擇，隱藏結局等你發現！</p>
                            </div>
                            
                            <div class="p-2 bg-primary/5 rounded-md">
                                <div class="flex items-center mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                                    </svg>
                                    <p class="font-semibold">刺客精神</p>
                                </div>
                                <p class="pl-5.5">每位刺客都有獨特的「刺客精神」。完成角色的歷史結局（符合《史記》記載的故事線），即可獲得該精神並傳遞給下一位刺客，解鎖新角色。</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右側：遊戲進度中心 -->
                <div class="lg:col-span-3 p-4 rounded-lg bg-white/80 dark:bg-gray-800/80 shadow-lg ancient-border h-full transition-all duration-300 hover:shadow-xl">
                    <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                        </svg>
                        <h2 class="text-lg font-bold text-primary">遊戲進度中心</h2>
                    </div>
                    
                    <!-- 結局進度 - 美化版 -->
                    <div class="mb-4 border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-gray-50/80 dark:bg-gray-700/30 transition-all duration-300 hover:bg-white hover:dark:bg-gray-700/50">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                                </svg>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">結局收集</span>
                            </div>
                            <button id="show-endings-collection" class="flex items-center text-xs text-primary bg-primary/10 hover:bg-primary/20 py-1 px-2 rounded transition-all duration-200 hover:shadow">
                                <span id="total-progress-percent" class="font-semibold">0%</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative w-full h-3 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden mb-1">
                            <div id="total-progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-primary to-primary/80 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between items-center text-xs mt-1">
                            <div class="text-gray-500 dark:text-gray-400 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                                已解鎖：<span id="total-endings-unlocked" class="font-medium">0</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400">
                                總計：<span id="total-endings" class="font-medium">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 成就進度 - 美化版 -->
                    <div class="mb-4 border border-gray-200 dark:border-gray-700 rounded-lg p-3 bg-gray-50/80 dark:bg-gray-700/30 transition-all duration-300 hover:bg-white hover:dark:bg-gray-700/50">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">成就解鎖</span>
                            </div>
                            <button id="show-achievements" class="flex items-center text-xs text-primary bg-primary/10 hover:bg-primary/20 py-1 px-2 rounded transition-all duration-200 hover:shadow">
                                <span id="home-achievements-unlocked" class="font-semibold">0</span>/<span id="home-total-achievements">0</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="relative w-full h-3 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden mb-1">
                            <div id="home-achievement-progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-primary/90 to-primary transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- 成就徽章區域 - 美化版 -->
                    <div class="mt-3">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" />
                            </svg>
                            主要成就
                        </div>
                        <div id="home-achievements-grid" class="grid grid-cols-5 gap-2">
                            <!-- 成就徽章將在JS中動態生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主遊戲內容 -->
        <div id="game-container">
            <!-- 初始角色選擇介面 -->
            <div id="character-selection" class="fade-in">
                <h2 class="text-2xl font-bold mb-4 text-center">選擇一位刺客，開始你的故事</h2>
                
                <!-- 更緊湊的角色選擇卡片佈局 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                    <!-- 曹沫卡片 -->
                    <div class="character-card p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md hover:shadow-xl cursor-pointer transform transition-all hover:-translate-y-1" data-character="cao-mo">
                        <div class="relative">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235D5CDE;stop-opacity:0.2' /%3E%3Cstop offset='100%25' style='stop-color:%235D5CDE;stop-opacity:0.1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23grad)'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='40' text-anchor='middle' dominant-baseline='middle' fill='%235D5CDE'%3E曹沫%3C/text%3E%3C/svg%3E" alt="曹沫" class="w-full h-32 object-cover rounded-md mb-2">
                            <div class="absolute top-2 right-2 bg-primary/80 text-white px-2 py-1 rounded text-xs">春秋時期</div>
                            <div class="completion-ring absolute top-2 left-2 w-8 h-8" style="--percent: 0%" data-percent="0%"></div>
                            <div id="progress-cao-mo" class="hidden">
                                <span class="completed-endings">0</span>/<span class="total-endings">0</span>
                            </div>
                        </div>
                        
                        <!-- 只保留描述 -->
                        <div class="py-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">魯國勇士，以匕首威脅齊桓公，收回失地</p>
                        </div>
                        
                        <!-- 開始按鈕 -->
                        <div class="flex justify-center">
                            <button class="w-full px-3 py-1.5 bg-primary text-white rounded-md text-sm hover:bg-secondary transition-colors flex items-center justify-center">
                                <span>開始體驗</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 專諸卡片 -->
                    <div class="character-card p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md hover:shadow-xl cursor-pointer transform transition-all hover:-translate-y-1" data-character="zhuan-zhu">
                        <div class="relative">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235D5CDE;stop-opacity:0.2' /%3E%3Cstop offset='100%25' style='stop-color:%235D5CDE;stop-opacity:0.1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23grad)'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='40' text-anchor='middle' dominant-baseline='middle' fill='%235D5CDE'%3E專諸%3C/text%3E%3C/svg%3E" alt="專諸" class="w-full h-32 object-cover rounded-md mb-2">
                            <div class="absolute top-2 right-2 bg-primary/80 text-white px-2 py-1 rounded text-xs">春秋時期</div>
                            <div class="completion-ring absolute top-2 left-2 w-8 h-8" style="--percent: 0%" data-percent="0%"></div>
                            <div id="progress-zhuan-zhu" class="hidden">
                                <span class="completed-endings">0</span>/<span class="total-endings">0</span>
                            </div>
                        </div>
                        
                        <!-- 只保留描述 -->
                        <div class="py-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">魚腹藏匕首，刺殺吳王僚成就闔閭霸業</p>
                        </div>
                        
                        <!-- 開始按鈕 -->
                        <div class="flex justify-center">
                            <button class="w-full px-3 py-1.5 bg-primary text-white rounded-md text-sm hover:bg-secondary transition-colors flex items-center justify-center">
                                <span>開始體驗</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 豫讓卡片 -->
                    <div class="character-card p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md hover:shadow-xl cursor-pointer transform transition-all hover:-translate-y-1" data-character="yu-rang">
                        <div class="relative">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235D5CDE;stop-opacity:0.2' /%3E%3Cstop offset='100%25' style='stop-color:%235D5CDE;stop-opacity:0.1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23grad)'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='40' text-anchor='middle' dominant-baseline='middle' fill='%235D5CDE'%3E豫讓%3C/text%3E%3C/svg%3E" alt="豫讓" class="w-full h-32 object-cover rounded-md mb-2">
                            <div class="absolute top-2 right-2 bg-primary/80 text-white px-2 py-1 rounded text-xs">戰國時期</div>
                            <div class="completion-ring absolute top-2 left-2 w-8 h-8" style="--percent: 0%" data-percent="0%"></div>
                            <div id="progress-yu-rang" class="hidden">
                                <span class="completed-endings">0</span>/<span class="total-endings">0</span>
                            </div>
                        </div>
                        
                        <!-- 只保留描述 -->
                        <div class="py-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">為報智伯知遇之恩，三次行刺趙襄子</p>
                        </div>
                        
                        <!-- 開始按鈕 -->
                        <div class="flex justify-center">
                            <button class="w-full px-3 py-1.5 bg-primary text-white rounded-md text-sm hover:bg-secondary transition-colors flex items-center justify-center">
                                <span>開始體驗</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 聶政卡片 -->
                    <div class="character-card p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md hover:shadow-xl cursor-pointer transform transition-all hover:-translate-y-1" data-character="nie-zheng">
                        <div class="relative">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235D5CDE;stop-opacity:0.2' /%3E%3Cstop offset='100%25' style='stop-color:%235D5CDE;stop-opacity:0.1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23grad)'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='40' text-anchor='middle' dominant-baseline='middle' fill='%235D5CDE'%3E聶政%3C/text%3E%3C/svg%3E" alt="聶政" class="w-full h-32 object-cover rounded-md mb-2">
                            <div class="absolute top-2 right-2 bg-primary/80 text-white px-2 py-1 rounded text-xs">戰國時期</div>
                            <div class="completion-ring absolute top-2 left-2 w-8 h-8" style="--percent: 0%" data-percent="0%"></div>
                            <div id="progress-nie-zheng" class="hidden">
                                <span class="completed-endings">0</span>/<span class="total-endings">0</span>
                            </div>
                        </div>
                        
                        <!-- 只保留描述 -->
                        <div class="py-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">為母隱忍，捨身報知己，刺殺韓相俠累</p>
                        </div>
                        
                        <!-- 開始按鈕 -->
                        <div class="flex justify-center">
                            <button class="w-full px-3 py-1.5 bg-primary text-white rounded-md text-sm hover:bg-secondary transition-colors flex items-center justify-center">
                                <span>開始體驗</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 荊軻卡片 -->
                    <div class="character-card p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md hover:shadow-xl cursor-pointer transform transition-all hover:-translate-y-1" data-character="jing-ke">
                        <div class="relative">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%235D5CDE;stop-opacity:0.2' /%3E%3Cstop offset='100%25' style='stop-color:%235D5CDE;stop-opacity:0.1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' fill='url(%23grad)'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='40' text-anchor='middle' dominant-baseline='middle' fill='%235D5CDE'%3E荊軻%3C/text%3E%3C/svg%3E" alt="荊軻" class="w-full h-32 object-cover rounded-md mb-2">
                            <div class="absolute top-2 right-2 bg-primary/80 text-white px-2 py-1 rounded text-xs">戰國時期</div>
                            <div class="completion-ring absolute top-2 left-2 w-8 h-8" style="--percent: 0%" data-percent="0%"></div>
                            <div id="progress-jing-ke" class="hidden">
                                <span class="completed-endings">0</span>/<span class="total-endings">0</span>
                            </div>
                        </div>
                        
                        <!-- 只保留描述 -->
                        <div class="py-2">
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">風蕭蕭兮易水寒，壯士一去兮不復還</p>
                        </div>
                        
                        <!-- 開始按鈕 -->
                        <div class="flex justify-center">
                            <button class="w-full px-3 py-1.5 bg-primary text-white rounded-md text-sm hover:bg-secondary transition-colors flex items-center justify-center">
                                <span>開始體驗</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 刪除這個段落 -->
            </div>

            <!-- 遊戲故事內容 -->
            <div id="story-content" class="hidden fade-in story-container p-6 rounded-lg bg-white dark:bg-gray-800 shadow-lg">
                <div class="flex items-center justify-between mb-6">
                    <button id="back-button" class="px-4 py-2 flex items-center text-primary hover:text-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        返回
                    </button>
                    <div class="flex items-center">
                        <span id="character-name" class="text-xl font-bold"></span>
                        <span class="ml-2 px-2 py-1 text-xs bg-primary text-white rounded-full" id="character-era"></span>
                    </div>
                    <div class="flex items-center">
                        <label for="hints-toggle" class="mr-2 text-xs text-gray-600 dark:text-gray-400">選項提示</label>
                        <div class="toggle-container">
                            <input type="checkbox" id="hints-toggle" class="toggle-checkbox"/>
                            <label for="hints-toggle" class="toggle-label"></label>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div id="story-progress" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                        <div id="progress-bar" class="h-2 bg-primary rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 id="scene-title" class="text-xl font-bold mb-4"></h3>
                    <p id="story-text" class="story-text"></p>
                </div>

                <!-- 知識點 -->
                <div id="knowledge-point" class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-md border-l-4 border-primary hidden">
                    <h4 class="font-bold text-primary mb-2">歷史知識點</h4>
                    <p id="knowledge-content" class="text-sm"></p>
                </div>
                
                <!-- 選擇區 -->
                <div id="choices-container" class="space-y-3 mt-8"></div>
            </div>

            <!-- 結局展示 -->
            <div id="ending-screen" class="hidden fade-in">
                <div class="p-6 rounded-lg bg-white dark:bg-gray-800 shadow-lg text-center">
                    <h2 class="text-2xl font-bold mb-4">故事結局</h2>
                    <div id="ending-type-badge" class="inline-block px-2 py-1 text-xs text-white rounded-full mb-4"></div>
                    <p id="ending-text" class="text-lg mb-6 story-text"></p>
                    
                    <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                        <h4 class="font-bold text-primary mb-2">歷史評價</h4>
                        <p id="historical-comment" class="text-sm"></p>
                    </div>
                    
                    <!-- 新增：結局收集統計 -->
                    <div class="mb-6 p-4 bg-primary/10 rounded-md">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-primary">結局收集</h4>
                            <span id="character-endings-stat" class="text-sm">0/0</span>
                        </div>
                        <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2">
                            <div id="character-endings-progress" class="h-2 bg-primary rounded-full" style="width: 0%"></div>
                        </div>
                        
                        <!-- 新增：特殊結局解鎖提示 -->
                        <div id="special-ending-hint" class="mt-4 text-sm text-gray-600 dark:text-gray-400 hidden">
                            <span class="font-semibold">提示：</span><span id="special-ending-text"></span>
                        </div>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <button id="replay-button" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">再次體驗</button>
                        <button id="view-endings-button" class="px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-colors">查看結局收集</button>
                        <button id="return-home-button" class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">返回首頁</button>
                    </div>
                </div>
            </div>
            
            <!-- 新增：決策樹彈窗 -->
            <div id="decision-tree-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">關鍵決策點</h3>
                        <button id="close-decision-tree" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        以下是解鎖不同結局的關鍵決策點。探索不同的選擇可能會引導你到達不同的結局。
                    </div>
                    <div id="decision-tree-container" class="space-y-4 max-h-[60vh] overflow-y-auto">
                        <!-- 決策樹將在JS中動態生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 成就系統彈窗 -->
    <div id="achievements-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-7xl w-full flex flex-col" style="max-height: 95vh;">
            <div class="p-2 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-primary">刺客之道成就</h3>
                <button id="close-achievements" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-2 border-b border-gray-200 dark:border-gray-700">
                <!-- 成就進度條 -->
                <div>
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-primary">成就解鎖進度</h4>
                        <span id="achievement-progress-percent" class="text-sm font-semibold text-primary">0%</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="achievement-progress-bar" class="ending-progress" style="width: 0%"></div>
                    </div>
                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-400 text-center">
                        已解鎖 <span id="achievements-unlocked">0</span> 個成就，共 <span id="total-achievements">0</span> 個
                    </div>
                </div>
            </div>
            
            <!-- 成就容器 - 優化布局，確保能顯示所有內容 -->
            <div class="p-2 flex-grow flex" id="achievements-container-wrapper">
                <div id="achievements-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-2 w-full">
                    <!-- 成就將在JS中動態生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增：結局收集庫彈窗 -->
    <div id="endings-collection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-primary">結局收集庫</h3>
                <button id="close-endings-collection" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-3">
                <div class="mb-2 flex flex-wrap items-center">
                    <div class="flex items-center mr-4 mb-1">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400 ml-1">正面結局</span>
                    </div>
                    <div class="flex items-center mr-4 mb-1">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400 ml-1">負面結局</span>
                    </div>
                    <div class="flex items-center mr-4 mb-1">
                        <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400 ml-1">中立結局</span>
                    </div>
                    <div class="flex items-center mb-1">
                        <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                        <span class="text-xs text-gray-600 dark:text-gray-400 ml-1">隱藏結局</span>
                    </div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 w-full mt-1">
                        <span class="font-semibold">提示：</span>有些結局需要特定的選擇組合才能解鎖。不同的選擇路徑可能導致不同的結局。
                    </div>
                </div>
                
                <!-- 角色選擇標籤 -->
                <div class="mb-2 border-b border-gray-200 dark:border-gray-700">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="endings-tabs">
                        <li class="mr-1">
                            <a href="#" class="inline-block py-2 px-3 rounded-t-lg border-b-2 border-primary text-primary active" data-character="cao-mo">曹沫</a>
                        </li>
                        <li class="mr-1">
                            <a href="#" class="inline-block py-2 px-3 rounded-t-lg border-b-2 border-transparent hover:border-gray-300" data-character="zhuan-zhu">專諸</a>
                        </li>
                        <li class="mr-1">
                            <a href="#" class="inline-block py-2 px-3 rounded-t-lg border-b-2 border-transparent hover:border-gray-300" data-character="yu-rang">豫讓</a>
                        </li>
                        <li class="mr-1">
                            <a href="#" class="inline-block py-2 px-3 rounded-t-lg border-b-2 border-transparent hover:border-gray-300" data-character="nie-zheng">聶政</a>
                        </li>
                        <li>
                            <a href="#" class="inline-block py-2 px-3 rounded-t-lg border-b-2 border-transparent hover:border-gray-300" data-character="jing-ke">荊軻</a>
                        </li>
                    </ul>
                </div>
                
                <!-- 結局卡片容器 -->
                <div id="endings-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 max-h-[70vh] overflow-y-auto pr-1">
                    <!-- 結局卡片將在JS中動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 通知系統容器 -->
    <div id="notifications-container" class="fixed bottom-0 right-0 p-4 z-50 flex flex-col items-end space-y-4 pointer-events-none">
    </div>
    
    <!-- 通知模板（隱藏） -->
    <template id="notification-templates">
        <!-- 成就通知模板 -->
        <div id="achievement-template" class="notification-item bg-yellow-500 bg-opacity-90 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-12 opacity-0 transition-all duration-500 pointer-events-auto">
            <div class="flex items-center">
                <div class="mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <div class="text-sm font-semibold">成就解鎖！</div>
                    <div class="notification-content text-lg font-bold"></div>
                </div>
            </div>
        </div>

        <!-- 結局解鎖通知模板 -->
        <div id="ending-unlock-template" class="notification-item bg-primary bg-opacity-90 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-12 opacity-0 transition-all duration-500 pointer-events-auto">
            <div class="flex items-center">
                <div class="mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
                    </svg>
                </div>
                <div>
                    <div class="text-sm font-semibold">新結局解鎖！</div>
                    <div class="notification-content text-lg font-bold"></div>
                    <div class="notification-meta text-xs mt-1"></div>
                </div>
            </div>
        </div>
        
        <!-- 角色解鎖通知模板 -->
        <div id="character-unlock-template" class="notification-item bg-green-600 bg-opacity-90 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-12 opacity-0 transition-all duration-500 pointer-events-auto">
            <div class="flex items-center">
                <div class="mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <div class="text-sm font-semibold">新角色解鎖！</div>
                    <div class="notification-content text-lg font-bold"></div>
                    <div class="notification-meta text-xs mt-1"></div>
                </div>
            </div>
        </div>
        
        <!-- 刺客精神通知模板 -->
        <div id="spirit-acquired-template" class="notification-item bg-purple-600 bg-opacity-90 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-12 opacity-0 transition-all duration-500 pointer-events-auto">
            <div class="flex items-center">
                <div class="mr-3 text-3xl notification-icon"></div>
                <div>
                    <div class="text-sm font-semibold">獲得刺客精神！</div>
                    <div class="notification-content text-lg font-bold"></div>
                    <div class="notification-meta text-xs mt-1"></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // 檢測並應用深色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 角色數據
        const characters = {
            "cao-mo": {
                name: "曹沫",
                era: "春秋時期",
                title: "魯國勇士",
                description: "為魯國奪回失地",
                scenarios: [
                    {
                        title: "出征前夕",
                        text: "你是曹沫，魯國人，憑勇敢和氣力侍奉魯莊公。多次與齊國交戰都被打敗，魯莊公不得不獻出遂邑，向齊國求和。",
                        knowledge: "春秋時期的魯國是周天子的宗親國，而齊國則是當時強大的諸侯國，軍事力量遠勝於魯國。",
                        choices: [
                            { text: "接受現實，保持忠誠侍奉", next: "cao-mo-1a", hint: { type: "neutral", text: "穩健選擇" } },
                            { text: "想辦法為魯國奪回失地", next: "cao-mo-1b", hint: { type: "good", text: "勇氣之選" } }
                        ]
                    },
                    {
                        id: "cao-mo-1a",
                        title: "繼續侍奉",
                        text: "你選擇接受現實，繼續忠誠侍奉魯莊公。不久後，齊桓公約魯莊公在柯地會面訂立盟約，你被任命隨行。",
                        knowledge: "古代諸侯間的會盟是重要的外交活動，通常需要宰殺牲畜，歃血為盟，以示誠意。",
                        choices: [
                            { text: "只做護衛，不做異想", next: "cao-mo-2a", hint: { type: "bad", text: "保守之選" } },
                            { text: "這是個奪回失地的機會", next: "cao-mo-2b", hint: { type: "good", text: "把握機會" } }
                        ]
                    },
                    {
                        id: "cao-mo-1b",
                        title: "謀劃復土",
                        text: "你日夜思考如何為魯國奪回失地，得知齊桓公約魯莊公在柯地會面訂立盟約，你被任命隨行。這是一個千載難逢的機會。",
                        knowledge: "春秋時期，弱國通過智謀與勇氣扭轉局勢的例子並不少見，這也體現了當時'以力服人'與'以義服人'的雙重價值觀。",
                        choices: [
                            { text: "謹慎考慮風險，放棄冒險", next: "cao-mo-2a", hint: { type: "bad", text: "放棄機會" } },
                            { text: "準備匕首，伺機行動", next: "cao-mo-2b", hint: { type: "good", text: "勇者無懼" } }
                        ]
                    },
                    {
                        id: "cao-mo-2a",
                        title: "錯失機會",
                        text: "你選擇不冒險，只安靜地做好護衛工作。盟約簽訂，齊國依然保有魯國的土地，而魯國的國力日漸式微。",
                        knowledge: "在春秋戰國的弱肉強食環境中，弱小國家往往需要非常手段才能自保。",
                        choices: [
                            { text: "接受命運，維持現狀", next: "cao-mo-end-1", hint: { type: "bad", text: "甘於平凡" } },
                            { text: "後悔不已，尋求其他機會", next: "cao-mo-end-2", hint: { type: "neutral", text: "內心不甘" } }
                        ]
                    },
                    {
                        id: "cao-mo-2b",
                        title: "挾持齊桓公",
                        text: "盟約簽訂後，你突然拔出預先準備的匕首，直接挾持了齊桓公。面對慌亂的情況，你冷靜地對齊桓公說：'齊國強大，魯國弱小，齊國以大國的身份侵略魯國，這樣也太過分了！如今魯國的城牆倒塌的話，就會壓到齊國的邊境，大王應該考慮這個問題。'",
                        knowledge: "這種以小博大的行為在春秋時期被視為勇氣和智慧的表現，甚至會被尊為義士。",
                        choices: [
                            { text: "要求齊桓公歸還全部土地", next: "cao-mo-3a", hint: { type: "good", text: "全力爭取" } },
                            { text: "以齊桓公的安全換取部分土地", next: "cao-mo-3b", hint: { type: "neutral", text: "適度妥協" } }
                        ]
                    },
                    {
                        id: "cao-mo-3a",
                        title: "堅決要求",
                        text: "你堅決要求齊桓公歸還所有侵占的魯國土地。在你的剛毅決心和匕首威脅下，齊桓公不得不同意。你已經實現了不可能的任務，為魯國爭回了尊嚴。",
                        knowledge: "曹沫的義舉被後人傳頌，體現了'士為知己者死'的忠義精神。",
                        choices: [
                            { text: "結束故事，查看歷史評價", next: "cao-mo-end-3", hint: { type: "good", text: "歷史結局" } }
                        ]
                    },
                    {
                        id: "cao-mo-3b",
                        title: "有限要求",
                        text: "你要求齊桓公歸還部分魯國土地，齊桓公答應了。儘管你沒有爭取到全部土地，但也為魯國挽回了部分損失。",
                        knowledge: "在外交談判中，即使是處於劣勢的一方，有時也能通過智謀和勇氣爭取到有利條件。",
                        choices: [
                            { text: "結束故事，查看歷史評價", next: "cao-mo-end-4", hint: { type: "neutral", text: "現實結局" } }
                        ]
                    }
                ],
                endings: {
                    "cao-mo-end-1": {
                        name: "謹守成規",
                        text: "你選擇接受現狀，魯國繼續生活在齊國的陰影下。雖然你繼續忠誠地服務於魯莊公，但國家的未來變得更加黯淡。歷史沒有記住你的名字。",
                        comment: "曹沫在歷史上因其挾持齊桓公、為魯國奪回失地的勇舉而被記載。若他沒有採取行動，或許就不會被《史記》記載為義士。",
                        type: "bad"
                    },
                    "cao-mo-end-2": {
                        name: "良機虛失",
                        text: "你錯過了最佳時機，之後再也沒有這樣的機會。魯國的國力繼續衰弱，而你終生生活在對那一刻未能採取行動的遺憾中。",
                        comment: "《史記·刺客列傳》中記載的五位刺客都有一個共同點：他們都能抓住關鍵時刻，不畏生死地採取行動。",
                        type: "neutral"
                    },
                    "cao-mo-end-3": {
                        name: "威震齊王",
                        text: "在你的威脅下，齊桓公答應將侵占的魯國土地全部歸還。話說完後，你便將匕首扔掉，走下盟壇，回到群臣位置上，面不改色，談吐從容如常。齊桓公雖然很生氣，但在管仲的勸說下，最終還是履行了承諾，將土地歸還給魯國。你的義舉被後世傳頌。",
                        comment: "《史記》記載，曹沫通過這一義舉，使魯國收回了多次戰敗失去的土地。這種以小博大、智勇雙全的行為體現了中國古代'義'的價值觀。",
                        type: "good"
                    },
                    "cao-mo-end-4": {
                        name: "功成半返",
                        text: "齊桓公在你的威脅下歸還了部分土地，儘管不是全部，但也為魯國爭得了喘息的機會。你的勇氣獲得了魯莊公的讚賞，也為後人所敬仰。",
                        comment: "歷史上的曹沫確實通過挾持齊桓公成功讓齊國歸還了侵占的魯國土地，這一行為被視為忠義的典範。",
                        type: "neutral"
                    }
                },
                // 關鍵決策點
                keyDecisions: [
                    {
                        title: "初次選擇",
                        description: "是否為魯國奪回失地",
                        choices: [
                            { text: "接受現實", outcome: "導向消極結局" },
                            { text: "想辦法奪回失地", outcome: "導向積極結局" }
                        ]
                    },
                    {
                        title: "關鍵時刻",
                        description: "盟約簽訂時的行動",
                        choices: [
                            { text: "安靜做護衛", outcome: "錯失機會" },
                            { text: "挾持齊桓公", outcome: "為魯國爭回尊嚴" }
                        ]
                    },
                    {
                        title: "最終要求",
                        description: "向齊桓公提出的條件",
                        choices: [
                            { text: "歸還全部土地", outcome: "獲得完全勝利" },
                            { text: "歸還部分土地", outcome: "部分勝利" }
                        ]
                    }
                ]
            },
            "zhuan-zhu": {
                name: "專諸",
                era: "春秋時期",
                title: "吳國堂邑人",
                description: "以匕首刺殺吳王僚",
                scenarios: [
                    {
                        title: "接受任務",
                        text: "你是專諸，吳國堂邑人。伍子胥從楚國流亡到吳國時，認出你有非凡本領。現在，吳國公子光有意除掉吳王僚自立為王，伍子胥將你推薦給了公子光。",
                        knowledge: "春秋時期吳國內部的權力鬥爭複雜，公子光作為王室成員，覬覦王位已久。",
                        choices: [
                            { text: "拒絕公子光的邀請", next: "zhuan-zhu-1a", hint: { type: "neutral", text: "明哲保身" } },
                            { text: "接受公子光的邀請", next: "zhuan-zhu-1b", hint: { type: "good", text: "歷史抉擇" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-1a",
                        title: "拒絕任務",
                        text: "你拒絕了公子光的邀請，選擇遠離權力鬥爭。然而，這種選擇在當時的環境下並不容易，你知道自己可能面臨怎樣的後果。",
                        knowledge: "春秋時期的政治險惡，拒絕權貴往往意味著危險。當時的'士'階層常常面臨'進則兼濟天下，退則獨善其身'的選擇。",
                        choices: [
                            { text: "隱居避世", next: "zhuan-zhu-end-1", hint: { type: "bad", text: "遠離歷史" } },
                            { text: "改變主意，接受任務", next: "zhuan-zhu-1b", hint: { type: "good", text: "重返歷史" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-1b",
                        title: "接受任務",
                        text: "你接受了公子光的邀請，他像對待貴客一樣款待你。公子光告訴你：'這是個千載難逢的好機會，如果現在不爭取的話，又怎麼會有所成就呢！'",
                        knowledge: "《史記》中記載，公子光認為自己是真正的繼承人，因而多年來一直暗中圖謀王位。",
                        choices: [
                            { text: "建議以毒藥暗殺", next: "zhuan-zhu-2a", hint: { type: "neutral", text: "隱蔽方法" } },
                            { text: "提出匕首藏魚腹的計劃", next: "zhuan-zhu-2b", hint: { type: "good", text: "歷史選擇" } },
                            { text: "提議先評估吳王僚的守衛情況", next: "zhuan-zhu-2c", hint: { type: "neutral", text: "謹慎行事" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-2a",
                        title: "毒藥計劃",
                        text: "你建議使用毒藥暗殺吳王僚。然而公子光認為這個計劃風險太大，容易暴露。吳王僚的侍衛眾多，需要更隱蔽的方法。",
                        knowledge: "在古代刺殺中，毒藥雖然隱蔽，但成功率較低，且容易被察覺，特別是對於有專人試毒的君主。",
                        choices: [
                            { text: "另想他法", next: "zhuan-zhu-2b", hint: { type: "good", text: "靈活變通" } },
                            { text: "堅持毒藥計劃", next: "zhuan-zhu-end-2", hint: { type: "bad", text: "固執己見" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-2b",
                        title: "魚腹藏匕",
                        text: "公子光計劃邀請吳王僚赴宴。你提出將匕首藏在烤魚的肚子裡，待宴席上端上烤魚時，剖開魚腹取出匕首刺殺吳王僚。",
                        knowledge: "這個計劃在《史記》中被詳細記載，體現了春秋時期刺客的智謀和勇氣。",
                        choices: [
                            { text: "細緻準備，等待時機", next: "zhuan-zhu-3a", hint: { type: "good", text: "完善計劃" } },
                            { text: "尋找可靠的廚師協助", next: "zhuan-zhu-3b", hint: { type: "neutral", text: "尋求幫手" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-2c",
                        title: "審慎評估",
                        text: "你建議先評估吳王僚的防衛情況，了解他的日常習慣和侍衛部署。公子光同意了你的建議，派人暗中收集情報。經過數日觀察，你發現吳王僚極為警覺，侍衛眾多，唯有在宴席上才可能放鬆警惕。",
                        knowledge: "古代刺客在行動前往往會詳細了解目標的習慣和防衛，以提高成功率。",
                        choices: [
                            { text: "制定魚腹藏匕計劃", next: "zhuan-zhu-2b", hint: { type: "good", text: "精心策劃" } },
                            { text: "提議埋伏刺殺", next: "zhuan-zhu-3c", hint: { type: "neutral", text: "另闢蹊徑" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-3a",
                        title: "行刺時刻",
                        text: "四月丙子這天，公子光設宴邀請吳王僚，並在地下室埋伏了武士。吳王僚派遣士兵排成長隊，從宮中一直排到公子光家門口。宴會正酣，你端著藏有匕首的烤魚走向吳王僚...",
                        knowledge: "古代宮廷中的刺殺極其危險，成功的可能性很小，大多數刺客都是抱著必死的決心。",
                        choices: [
                            { text: "放棄行動，尋求逃脫", next: "zhuan-zhu-end-3", hint: { type: "bad", text: "臨陣退縮" } },
                            { text: "毫不猶豫，立即行動", next: "zhuan-zhu-4a", hint: { type: "good", text: "歷史之舉" } },
                            { text: "尋找更好時機", next: "zhuan-zhu-4b", hint: { type: "neutral", text: "審時度勢" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-3b",
                        title: "廚師協助",
                        text: "你覺得若要完美執行魚腹藏匕計劃，需要一位可靠的廚師協助。公子光推薦了自己的心腹廚師，此人烹飪技藝精湛，且忠心耿耿。你與這位廚師密謀，確保匕首能完美隱藏於魚腹中。",
                        knowledge: "刺殺行動往往需要多人配合，但人多也意味著洩密風險增加。",
                        choices: [
                            { text: "謹慎行事，進行刺殺", next: "zhuan-zhu-3a", hint: { type: "good", text: "籌謀完備" } },
                            { text: "懷疑廚師忠誠度，親自準備", next: "zhuan-zhu-4c", hint: { type: "neutral", text: "防範於未然" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-3c",
                        title: "埋伏計劃",
                        text: "你提議在吳王僚前往公子光府邸的路上設下埋伏。公子光考慮再三，認為風險太大：'吳王僚出行必有重兵護衛，埋伏難以成功，不如在宴席上行動，我已在府中暗藏勇士，可在事後接應。'",
                        knowledge: "春秋時期，君主出行常有重兵保護，路上埋伏的刺殺成功率極低。",
                        choices: [
                            { text: "接受建議，改用魚腹藏匕", next: "zhuan-zhu-2b", hint: { type: "good", text: "接受良策" } },
                            { text: "堅持埋伏計劃", next: "zhuan-zhu-end-5", hint: { type: "bad", text: "固執冒險" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-4a",
                        title: "刺殺成功",
                        text: "你端著烤魚來到吳王僚面前，剖開魚腹，拿出匕首立即刺向吳王僚，吳王僚當場被刺死。雖然你隨即被吳王僚的武士殺死，但公子光出動埋伏的士兵，消滅了吳王僚的人，自立為王，是為吳王闔閭。",
                        knowledge: "專諸的刺殺成功改變了吳國歷史，吳王闔閭後來成為春秋時期重要的霸主之一。",
                        choices: [
                            { text: "結束故事，查看歷史評價", next: "zhuan-zhu-end-4", hint: { type: "good", text: "歷史結局" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-4b",
                        title: "臨陣猶豫",
                        text: "你端著烤魚走到吳王僚面前，但看到他身邊的侍衛如此之多，一時猶豫不決。這短暫的遲疑被吳王僚敏銳地察覺，他疑惑地問道：'這魚有何特別之處，讓你如此遲疑？'",
                        knowledge: "在危急關頭的猶豫常常導致刺殺失敗，《史記》中很多失敗的刺客都是因為在關鍵時刻缺乏決斷力。",
                        choices: [
                            { text: "強作鎮定，再尋機會", next: "zhuan-zhu-5a", hint: { type: "neutral", text: "沉著應對" } },
                            { text: "立刻決斷，奮力一擊", next: "zhuan-zhu-4a", hint: { type: "good", text: "把握時機" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-4c",
                        title: "親自準備",
                        text: "你決定不完全信任廚師，自己參與烤魚的準備，確保萬無一失。宴會這天，你隨侍在側，待公子光命令上魚時，你親自端上了藏有匕首的烤魚。",
                        knowledge: "刺客親自參與準備工作能降低計劃暴露的風險，但也可能因不專業而引起懷疑。",
                        choices: [
                            { text: "剖魚行刺", next: "zhuan-zhu-4a", hint: { type: "good", text: "時機已到" } },
                            { text: "察覺異常，暫緩行動", next: "zhuan-zhu-5b", hint: { type: "neutral", text: "謹慎觀察" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-5a",
                        title: "再尋機會",
                        text: "你強作鎮定，回答道：'這是一道特別的烤魚，需要在王面前才能展現其獨特風味。'吳王僚將信將疑，命令你先給他的侍衛品嚐。你知道計劃可能敗露，必須迅速決斷。",
                        knowledge: "古代君王常有試毒官，食物必先經過試毒才能食用，這是防止暗殺的常見手段。",
                        choices: [
                            { text: "當機立斷，拔出匕首", next: "zhuan-zhu-6a", hint: { type: "good", text: "決斷時刻" } },
                            { text: "放棄行動，尋求脫身", next: "zhuan-zhu-end-6", hint: { type: "bad", text: "功虧一簣" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-5b",
                        title: "暫緩行動",
                        text: "端上烤魚後，你察覺到吳王僚席位周圍的氣氛有些不對勁，侍衛們似乎格外警覺。你向公子光使了個眼色，暗示情況可能有變。公子光微微點頭，隨即提議先上些酒肉，待氣氛熱烈些再上烤魚。",
                        knowledge: "敏銳的洞察力是刺客的重要素質，能在關鍵時刻察覺危險並調整計劃。",
                        choices: [
                            { text: "等待更安全的時機", next: "zhuan-zhu-6b", hint: { type: "good", text: "韜光養晦" } },
                            { text: "認為時機已失，放棄行動", next: "zhuan-zhu-end-7", hint: { type: "neutral", text: "知難而退" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-6a",
                        title: "最後一搏",
                        text: "你看出情況不妙，知道再無機會，立刻剖開魚腹，拔出匕首刺向吳王僚。吳王僚雖有防備，但被你的突然襲擊刺中要害。你隨即被蜂擁而上的侍衛亂刀砍死，但公子光早有準備，立刻發動埋伏的士兵控制了局面。",
                        knowledge: "在刺殺行動中，即使局勢不利，專諸仍然選擇了奮不顧身的一擊，這種決斷是成功的關鍵。",
                        choices: [
                            { text: "結束故事，查看歷史評價", next: "zhuan-zhu-end-4", hint: { type: "good", text: "歷史結局" } }
                        ]
                    },
                    {
                        id: "zhuan-zhu-6b",
                        title: "時機再現",
                        text: "宴會進行了一段時間，酒過三巡，吳王僚漸漸放鬆警惕。公子光向你使眼色，你知道時機已到。你重新端起那盤藏有匕首的烤魚，走向吳王僚。",
                        knowledge: "選擇合適的時機對刺殺行動至關重要，酒宴進行到後半段，目標警惕性下降時往往是最佳時機。",
                        choices: [
                            { text: "毫不猶豫，果斷行動", next: "zhuan-zhu-4a", hint: { type: "good", text: "決勝時刻" } }
                        ]
                    }
                ],
                endings: {
                    "zhuan-zhu-end-1": {
                        name: "明哲保身",
                        text: "你選擇隱居避世，遠離權力爭鬥。公子光另尋他人實施計劃，結果失敗，自己也被處死。你雖然保全了性命，但沒能在歷史上留下名字。",
                        comment: "在《史記·刺客列傳》中，司馬遷記載的五位刺客都選擇了赴死行刺，而非明哲保身。這反映了古代中國'士為知己者死'的價值觀。",
                        type: "bad"
                    },
                    "zhuan-zhu-end-2": {
                        name: "毒計不成",
                        text: "你堅持使用毒藥計劃，但在實施過程中被吳王僚的侍衛發現。你被處死，公子光也因此受到牽連，計劃徹底失敗。",
                        comment: "在歷史上，專諸選擇了更為巧妙的魚腹藏匕計劃，體現了刺客不僅需要勇氣，還需要智謀。",
                        type: "bad"
                    },
                    "zhuan-zhu-end-3": {
                        name: "功虧一簣",
                        text: "在最後關頭，你選擇了放棄行動。公子光的計劃敗露，你和公子光都被處死。歷史上沒有記載你的名字。",
                        comment: "《史記·刺客列傳》中的刺客都以敢於犧牲自我完成使命為特點，這是他們被後世銘記的主要原因。",
                        type: "bad"
                    },
                    "zhuan-zhu-end-4": {
                        name: "魚藏匕首",
                        text: "你成功刺殺了吳王僚，雖然自己也隨即被殺，但幫助公子光登上王位，成為吳王闔閭。闔閭記得你的忠誠，將你的兒子封為上卿。你的名字也因此被後世銘記。",
                        comment: "《史記》記載，專諸的刺殺成為了中國歷史上著名的政變案例。他雖然犧牲了自己，但成就了吳國的霸業，體現了'成大事者不拘小節'的政治現實。",
                        type: "good"
                    },
                    "zhuan-zhu-end-5": {
                        name: "伏謀不成",
                        text: "你堅持埋伏計劃，但在行動當天，吳王僚突然改變路線，使埋伏落空。計劃敗露後，你與公子光都被吳王僚處死。吳國的歷史因此改變，伍子胥也被牽連而死。",
                        comment: "歷史上的專諸選擇了更為可行的魚腹藏匕計劃，在室內宴席上行刺成功率更高。埋伏路上刺殺君主幾乎沒有成功的先例。",
                        type: "bad"
                    },
                    "zhuan-zhu-end-6": {
                        name: "計敗身死",
                        text: "你看出計劃可能敗露，選擇放棄行動，尋找借口脫身。然而，吳王僚已經起疑，命令侍衛搜查烤魚。匕首被發現，你被當場拿下。在嚴刑拷打下，你供出了公子光的計劃。你和公子光都被處死，吳國的歷史走向了另一條道路。",
                        comment: "專諸在歷史上的成功關鍵在於他的決斷力和不惜犧牲自己的精神。若在關鍵時刻退縮，不僅使命失敗，更可能連累他人。",
                        type: "bad"
                    },
                    "zhuan-zhu-end-7": {
                        name: "棄機遠遁",
                        text: "你認為時機已失，暗示公子光放棄行動。公子光雖然不甘心，但也明白勉強行事只會招致失敗。宴會平安結束後，公子光決定推遲計劃，另尋時機。然而，吳王僚從此更加警惕，公子光再也找不到合適的機會。多年後，公子光病死，你也在默默無聞中度過餘生。",
                        comment: "刺殺是一項風險極高的行動，有時候放棄一時的機會是明智的選擇。然而，歷史上能被銘記的往往是那些把握機會、勇往直前的人物。",
                        type: "neutral"
                    }
                },
                // 關鍵決策點
                keyDecisions: [
                    {
                        title: "接受使命",
                        description: "是否接受公子光的刺殺任務",
                        choices: [
                            { text: "拒絕任務", outcome: "避世自保，無法載入史冊" },
                            { text: "接受任務", outcome: "踏上歷史舞台的機會" }
                        ]
                    },
                    {
                        title: "行刺計劃",
                        description: "如何實施刺殺",
                        choices: [
                            { text: "毒藥暗殺", outcome: "高風險，易被發現" },
                            { text: "魚腹藏匕", outcome: "歷史上的成功策略" },
                            { text: "埋伏刺殺", outcome: "成功率低，風險高" }
                        ]
                    },
                    {
                        title: "關鍵時刻",
                        description: "刺殺執行時的決斷",
                        choices: [
                            { text: "果斷行動", outcome: "成功完成使命，雖死猶榮" },
                            { text: "臨陣退縮", outcome: "任務失敗，遭遇不測" }
                        ]
                    }
                ]
            },
            "yu-rang": {
                name: "豫讓",
                era: "戰國時期",
                title: "晉國義士",
                description: "為報知遇之恩，三次行刺趙襄子",
                scenarios: [
                    {
                        title: "主君之死",
                        text: "你是豫讓，曾經侍奉過范氏和中行氏，但都未受重用。後來你侍奉智伯，智伯十分尊重你。然而，智伯與趙襄子交戰，被趙、韓、魏三家聯合消滅了。更令人憤慨的是，趙襄子將智伯的頭顱製成飲器。",
                        knowledge: "戰國時期的晉國內部軍閥混戰，智伯曾是強大的軍閥之一，但因驕傲自滿而被其他家族聯合消滅。",
                        choices: [
                            { text: "為智伯復仇", next: "yu-rang-1a", hint: { type: "good", text: "忠義之舉" } },
                            { text: "保全自己，另擇明主", next: "yu-rang-1b", hint: { type: "neutral", text: "理性選擇" } }
                        ]
                    },
                    {
                        id: "yu-rang-1a",
                        title: "立誓復仇",
                        text: "你逃到山中，感慨道：'士為知己者死，女為悅己者容。智伯知我，我必須為他報仇，即使死了，靈魂也不會羞愧！'你決心要為智伯報仇，刺殺趙襄子。",
                        knowledge: "'士為知己者死'是中國古代重要的價值觀，體現了'知遇之恩'的重要性。",
                        choices: [
                            { text: "改變容貌，潛入趙襄子宮中", next: "yu-rang-2a", hint: { type: "good", text: "歷史選擇" } },
                            { text: "尋找志同道合之士", next: "yu-rang-2b", hint: { type: "neutral", text: "尋求幫助" } }
                        ]
                    },
                    {
                        id: "yu-rang-1b",
                        title: "尋找新主",
                        text: "你考慮到智伯已死，復仇只會搭上自己的性命。你決定保全自己，尋找新的明主侍奉。然而，你內心深處始終被愧疚折磨著。",
                        knowledge: "在戰國時期，士人常常在各國之間流動，尋找賞識自己的君主。但重義輕生的價值觀也深入人心。",
                        choices: [
                            { text: "堅持理性選擇，離開晉國", next: "yu-rang-end-1", hint: { type: "bad", text: "明哲保身" } },
                            { text: "無法釋懷，決定復仇", next: "yu-rang-1a", hint: { type: "good", text: "忠義抉擇" } }
                        ]
                    },
                    {
                        id: "yu-rang-2a",
                        title: "第一次刺殺",
                        text: "你改名換姓，偽裝成犯罪受刑的人，潛入趙襄子的宮中修整廁所，隨身帶著匕首，準備刺殺襄子。",
                        knowledge: "古代刺客常採用各種偽裝潛入目標身邊，《史記》中記載的許多刺客都使用過類似手段。",
                        choices: [
                            { text: "趙襄子上廁所時行刺", next: "yu-rang-3a", hint: { type: "good", text: "把握機會" } },
                            { text: "通過其他僕役獲取更多情報", next: "yu-rang-3b", hint: { type: "neutral", text: "審慎行事" } }
                        ]
                    },
                    {
                        id: "yu-rang-2b",
                        title: "結交同志",
                        text: "你四處尋找與你有相同志向的人。在一家酒館中，你遇到了幾位曾經侍奉智伯的舊部下，他們也對趙襄子深恨不已。你們決定一起策劃復仇。",
                        knowledge: "戰國時期，失敗一方的殘部常常會尋求機會為故主報仇，這種現象在歷史中屢見不鮮。",
                        choices: [
                            { text: "計劃集體行動", next: "yu-rang-3c", hint: { type: "neutral", text: "團隊行動" } },
                            { text: "認為人多口雜，決定獨自行動", next: "yu-rang-2a", hint: { type: "good", text: "謹慎之選" } }
                        ]
                    },
                    {
                        id: "yu-rang-3b",
                        title: "深入了解",
                        text: "你在宮中修整廁所的同時，與其他僕役交談，了解了更多趙襄子的習慣和宮中的布局。你發現趙襄子每日清晨都會獨自在後花園散步，那裡的守衛相對較少。",
                        knowledge: "刺客在行動前收集情報是非常重要的，這可以大大提高行動的成功率。",
                        choices: [
                            { text: "仍選擇在廁所行刺", next: "yu-rang-3a", hint: { type: "good", text: "按計劃行事" } },
                            { text: "改為在花園埋伏", next: "yu-rang-4c", hint: { type: "neutral", text: "臨時變更" } }
                        ]
                    },
                    {
                        id: "yu-rang-3c",
                        title: "集體行動",
                        text: "你和智伯的舊部下制定了周密的計劃，準備在趙襄子外出狩獵時伏擊他。然而，就在行動前夕，其中一人酒後失言，被趙家細作得知。趙襄子取消了狩獵計劃，並下令搜捕所有參與者。",
                        knowledge: "在古代，集體謀反行動往往因人多口雜而失敗。這也是為何許多刺客選擇獨自行動。",
                        choices: [
                            { text: "及時逃離，另尋機會", next: "yu-rang-4d", hint: { type: "neutral", text: "保全實力" } },
                            { text: "被捕但不透露身份", next: "yu-rang-end-5", hint: { type: "bad", text: "義勇就擒" } }
                        ]
                    },
                    {
                        id: "yu-rang-3a",
                        title: "第一次失敗",
                        text: "趙襄子上廁所時，心中一驚，讓隨從捉住並審問你。發現你身上藏著短劍，你坦承：'我要為智伯報仇！'趙襄子的侍從都想要殺死你，但趙襄子卻說：'這是個有義氣的人。'最後釋放了你。",
                        knowledge: "趙襄子不殺豫讓，體現了戰國時期尊重'義'的價值觀，也展示了趙襄子的政治智慧。",
                        choices: [
                            { text: "接受失敗，放棄復仇", next: "yu-rang-end-2", hint: { type: "neutral", text: "知恩圖報" } },
                            { text: "繼續謀劃第二次刺殺", next: "yu-rang-4a", hint: { type: "good", text: "堅持復仇" } }
                        ]
                    },
                    {
                        id: "yu-rang-4a",
                        title: "第二次刺殺",
                        text: "你沒有放棄，而是全身塗滿油漆，讓身體潰爛，長滿惡瘡，又吞下火炭使聲音沙啞，讓自己面目全非。你的朋友認出你後，建議你先獲得趙襄子的信任再行刺。你卻說：'已經侍奉過別人，又想殺他，這是不忠。我這樣做就是要讓那些心懷二意侍奉君主的人感到慚愧。'",
                        knowledge: "豫讓拒絕通過取得信任再行刺的方法，體現了他對'忠義'的獨特理解。",
                        choices: [
                            { text: "在趙襄子經過橋下時埋伏", next: "yu-rang-5a", hint: { type: "good", text: "歷史抉擇" } },
                            { text: "考慮朋友的建議", next: "yu-rang-5b", hint: { type: "neutral", text: "換一策略" } }
                        ]
                    },
                    {
                        id: "yu-rang-4c",
                        title: "花園伏擊",
                        text: "清晨，你躲在後花園的假山後面，等待趙襄子現身。當他獨自一人漫步至此時，你突然躍出，持劍刺向他。可惜趙襄子身手敏捷，躲過了你的襲擊，並喊來了侍衛。",
                        knowledge: "趙襄子作為一方諸侯，本身也是有武藝的，這在戰國時期的諸侯中並不罕見。",
                        choices: [
                            { text: "與侍衛搏鬥，試圖再次刺殺", next: "yu-rang-5c", hint: { type: "neutral", text: "奮力一搏" } },
                            { text: "知道機會已失，試圖逃脫", next: "yu-rang-end-6", hint: { type: "bad", text: "急流勇退" } }
                        ]
                    },
                    {
                        id: "yu-rang-4d",
                        title: "獨自潛行",
                        text: "你的同伴被捕，但你及時逃脫。你明白想要報仇，只能靠自己。經過深思熟慮，你決定自殘容貌，以全新的身份再次行動。你塗滿油漆，使皮膚潰爛，吞下火炭讓聲音沙啞，將自己變成另一個人。",
                        knowledge: "豫讓的自殘行為在《史記》中被詳細記載，體現了他為報仇不惜犧牲一切的決心。",
                        choices: [
                            { text: "在橋下埋伏趙襄子", next: "yu-rang-5a", hint: { type: "good", text: "堅定刺殺" } }
                        ]
                    },
                    {
                        id: "yu-rang-5b",
                        title: "循序漸進",
                        text: "你決定採納朋友的建議，通過獲取趙襄子的信任來尋找更好的刺殺機會。你故意在趙襄子經常狩獵的地方'偶遇'他，並幫助他獵殺了一隻正要攻擊他的野豬。趙襄子對你的勇敢印象深刻，邀請你成為他的侍衛。",
                        knowledge: "在中國古代，刺客經常使用各種方法接近目標，包括通過立功獲得信任。但是，這種方法在豫讓看來有違他的忠義觀念。",
                        choices: [
                            { text: "接受職位，等待機會", next: "yu-rang-6b", hint: { type: "neutral", text: "臥底行動" } },
                            { text: "無法接受二主之嫌，拒絕", next: "yu-rang-end-7", hint: { type: "good", text: "忠義之選" } }
                        ]
                    },
                    {
                        id: "yu-rang-5c",
                        title: "花園激戰",
                        text: "你與趙襄子和他的侍衛展開激烈搏鬥。雖然你武藝高超，但寡不敵眾，很快就被制服。趙襄子認出了你：'你不是豫讓嗎？為何如此執著於復仇？'",
                        knowledge: "戰國時期的復仇行為通常是公開的，刺客往往樂於表明身份，展示自己的忠義。",
                        choices: [
                            { text: "坦白身份和動機", next: "yu-rang-6c", hint: { type: "neutral", text: "直言不諱" } },
                            { text: "拼死反抗，不願被捕", next: "yu-rang-end-8", hint: { type: "bad", text: "寧死不屈" } }
                        ]
                    },
                    {
                        id: "yu-rang-5a",
                        title: "再次失敗",
                        text: "你埋伏在趙襄子必經的橋下。趙襄子剛到橋上，馬就受驚了。趙襄子喊道：'這一定是豫讓！'派人一查，果然是你。趙襄子問你為何執著於為智伯報仇而不為范氏和中行氏報仇。你回答：'我服侍范氏和中行氏，他們待我如普通人，我也以普通人的方式回報他們。智伯待我如國士，我也必須以國士的方式回報他。'",
                        knowledge: "這段對話是《刺客列傳》的精彩部分，揭示了古代中國'士'階層的價值觀：君待臣以禮，則臣盡忠以死。",
                        choices: [
                            { text: "請求擊打趙襄子的衣服以償夙願", next: "yu-rang-6a", hint: { type: "good", text: "歷史結局" } },
                            { text: "認為已盡全力，放棄復仇", next: "yu-rang-end-3", hint: { type: "neutral", text: "識時務者" } },
                            { text: "憤而自殺，以死明志", next: "yu-rang-end-9", hint: { type: "good", text: "捍衛忠義" } }
                        ]
                    },
                    {
                        id: "yu-rang-6a",
                        title: "最後請求",
                        text: "趙襄子再次打算饒你，你說：'我聽說聖明的君主不會掩蓋別人的美德，忠誠的臣子有為美名而死的道義。今天的事情，我本應伏法受誅，但我懇求能夠得到您的衣服來擊打它，以此來表達我替智伯報仇的心意，這樣我就是死了也沒有遺憾了。'",
                        knowledge: "古代中國的'名'與'實'觀念十分重要，豫讓通過擊打衣服，在精神上完成了自己的復仇使命。",
                        choices: [
                            { text: "擊襲衣服，自刎而死", next: "yu-rang-end-4", hint: { type: "good", text: "精神勝利" } }
                        ]
                    },
                    {
                        id: "yu-rang-6b",
                        title: "近在眼前",
                        text: "你成為趙襄子的近身侍衛，每天都有機會接近他。然而，你發現自己的內心開始動搖。趙襄子並非你想像中的暴君，他對待下屬十分寬厚，甚至多次提拔你。一日，趙襄子單獨召見你，說：'我知道你是誰，豫讓。'",
                        knowledge: "古代很多復仇者在接近目標後，會發現復仇對象的多面性，由此產生道德困境。",
                        choices: [
                            { text: "堅持復仇，拔劍而起", next: "yu-rang-7a", hint: { type: "good", text: "不改初衷" } },
                            { text: "坦白身份，放棄復仇", next: "yu-rang-end-10", hint: { type: "neutral", text: "知恩圖報" } }
                        ]
                    },
                    {
                        id: "yu-rang-7a",
                        title: "最後時刻",
                        text: "你聽到趙襄子知道你的身份，立刻拔劍而起。趙襄子並未呼喚侍衛，而是平靜地站在原地：'我早已知道你的身份，但我欣賞你的忠義，所以留你在身邊。如果你現在殺了我，你將成就自己的名聲，但也會帶給趙國百姓更多的動盪。'",
                        knowledge: "趙襄子在趙國推行仁政，深受百姓愛戴。在他治理下，趙國國力日漸強盛。",
                        choices: [
                            { text: "完成復仇，刺殺趙襄子", next: "yu-rang-end-12", hint: { type: "neutral", text: "鐵血復仇" } },
                            { text: "放下刀劍，請求擊衣", next: "yu-rang-6a", hint: { type: "good", text: "歷史選擇" } }
                        ]
                    },
                    {
                        id: "yu-rang-7b",
                        title: "寸步不讓",
                        text: "你說：'智伯待我如國士，知我重於千金。他的過錯我知道，但以我的身份，不能只記他的過，不念他的恩。我今日必須為他復仇，否則何以為人？'",
                        knowledge: "豫讓的回應體現了中國傳統文化中'受恩必報'的觀念，同時也反映了士人階層的人格尊嚴。",
                        choices: [
                            { text: "請求擊打趙襄子的衣服", next: "yu-rang-6a", hint: { type: "good", text: "名實兼顧" } }
                        ]
                    }
                ],
                endings: {
                    "yu-rang-end-1": {
                        name: "逃避復仇",
                        text: "你選擇理性地保全自己，離開晉國尋找新的出路。雖然活了下來，但內心的愧疚始終伴隨著你，你的名字也沒有被歷史銘記。",
                        comment: "在《史記·刺客列傳》中，司馬遷讚賞的是那些不畏生死、重視忠義的人物。如果豫讓選擇明哲保身，就不會有後來的感人故事。",
                        type: "bad"
                    },
                    "yu-rang-end-2": {
                        name: "感恩釋懷",
                        text: "你接受了第一次刺殺的失敗，感激趙襄子的寬容，放棄了復仇。你活了下來，但為自己未能完成為智伯報仇的誓言而愧疚終生。",
                        comment: "歷史上的豫讓並未在第一次失敗後放棄，他的堅持不懈體現了戰國時期士人'言必信，行必果'的精神。",
                        type: "neutral"
                    },
                    "yu-rang-end-3": {
                        name: "知難而退",
                        text: "在第二次刺殺失敗後，你認為已經盡了全力，接受了無法為智伯報仇的現實。你的故事仍然被人傳頌，但不如歷史上真實的豫讓那樣令人震撼。",
                        comment: "豫讓的故事之所以感人，正是因為他不惜一切代價要完成復仇。他寧可死也要在精神上完成對主君的承諾。",
                        type: "neutral"
                    },
                    "yu-rang-end-4": {
                        name: "擊衣伏劍",
                        text: "當時襄子非常讚賞你的義氣，便命令使者將衣服拿給你。你拔出劍來三次跳起來擊刺它，說：'我可以到九泉之下去報答智伯了！'於是伏劍自刎。你死的那天，趙國的志士得知這個消息，都為你痛哭流淚。",
                        comment: "《史記》記載，豫讓的忠義之舉感動了無數人。他不惜自殘容貌，三次行刺，最終以擊襲衣服完成了精神上的復仇，展現了戰國時期'士'階層的氣節和忠義精神。",
                        type: "good"
                    },
                    "yu-rang-end-5": {
                        name: "一謀俱敗",
                        text: "你的同伴們被捕，供出了計劃的細節，但都不知道你的真實身份。趙襄子加強了自身的防衛，你的復仇計劃變得更加困難。最終，你離開了趙國，在遠方度過餘生，終日活在未能完成復仇的愧疚中。",
                        comment: "在中國古代，復仇不僅僅是為了個人情感，更是一種文化和道德責任。未能完成復仇使命的人往往難以在心理上得到安寧。",
                        type: "bad"
                    },
                    "yu-rang-end-6": {
                        name: "臨陣逃生",
                        text: "你在花園刺殺失敗後試圖逃脫，但趙襄子的侍衛包圍了整個宮殿。你被捕後拒絕透露身份，但趙襄子已經認出了你：'這是智伯的舊臣豫讓。'最終，你被處決，但臨死前仍高呼智伯之名，表明自己的忠義。",
                        comment: "即使在死亡面前，對主君的忠誠也是戰國時期士人最為看重的品質。豫讓雖然失敗，但他堅守忠義的精神贏得了後世的尊敬。",
                        type: "bad"
                    },
                    "yu-rang-end-7": {
                        name: "義不二主",
                        text: "你無法接受侍奉趙襄子，因為這會讓你背負二主之嫌。你公開表明自己的身份，並宣稱：'智伯待我如國士，我豫讓決不會背叛我的主君！'趙襄子再次被你的忠義所感動，但你拒絕接受他的寬恕，拔劍自刎，用死亡捍衛了自己的忠義。",
                        comment: "在中國傳統文化中，'忠'是最高的道德準則之一。豫讓寧可死也不願意背叛已故的主君，這種精神令人敬佩。",
                        type: "good"
                    },
                    "yu-rang-end-8": {
                        name: "臨終無悔",
                        text: "被捕後，你拒絕投降，不斷掙扎反抗。在混亂中，一名侍衛失手刺傷了你的喉嚨。趙襄子急忙上前，希望能夠救你，但為時已晚。你臨死前用沙啞的聲音說出最後一句話：'智伯，我無顏見你於九泉之下。'",
                        comment: "對於古代士人而言，為主君報仇是義不容辭的責任。豫讓即使在死亡的邊緣，仍然惦記著自己未能完成的使命，這種精神感動了無數後人。",
                        type: "bad"
                    },
                    "yu-rang-end-9": {
                        name: "以死明志",
                        text: "在第二次刺殺失敗後，你認為自己辜負了智伯的知遇之恩，當場抽出短劍，自刎而死。趙襄子見狀大驚，試圖阻止卻為時已晚。他感嘆道：'豫讓真乃義士也！'命人厚葬你，並在墓前立碑，銘記你的忠義。",
                        comment: "在古代中國，自殺常被視為表達忠誠和決心的極端方式。豫讓通過自殺，向世人昭示了自己對智伯不變的忠誠，雖然沒能完成復仇，但他的忠義精神同樣令人景仰。",
                        type: "good"
                    },
                    "yu-rang-end-10": {
                        name: "捨執歸平",
                        text: "你向趙襄子坦白了自己的身份和初衷，並表示願意放棄復仇。趙襄子深受感動，不僅不怪罪你，還提拔你為重臣。你在趙國為官多年，推行善政，造福百姓。雖然你沒有完成為智伯復仇的誓言，但你以另一種方式實現了價值。然而，每當夜深人靜，你仍會想起智伯，心中充滿複雜的情感。",
                        comment: "放下仇恨，選擇建設性的道路並非容易之事。在某種程度上，這比單純的復仇需要更大的勇氣。如果豫讓選擇了這條路，或許能夠成就不同的傳奇。",
                        type: "neutral"
                    },
                    "yu-rang-end-11": {
                        name: "兩全其道",
                        text: "聽了趙襄子的話，你開始重新思考智伯的為人。經過深入了解，你確實發現智伯在位時有許多暴虐行為。你決定重新評價自己的立場：'我感謝智伯的知遇之恩，但也不能無視他的過失。或許真正的忠義不是盲目復仇，而是為民求福。'你最終選擇留在趙國，協助趙襄子治理國家。這一選擇雖然在當時頗受爭議，但後世史家對你有了更加全面的評價。",
                        comment: "在中國傳統文化中，'義'與'忠'常常被放在一起談論，但兩者有時會產生衝突。豫讓若能超越個人恩怨，選擇對社會更有益的道路，或許也是一種更高層次的智慧。",
                        type: "secret"
                    },
                    "yu-rang-end-12": {
                        name: "報仇雪恨",
                        text: "你最終還是無法放棄復仇，劍鋒一閃，刺中了趙襄子的胸膛。趙襄子臨死前只說了一句話：'你完成了你的使命，但趙國會因此陷入混亂...'你實現了復仇，但趙國確如趙襄子所言陷入了內亂。你被趙國新君處死，而智伯的在天之靈是否真的因你的復仇而得到安慰，已無從得知。",
                        comment: "復仇是一把雙刃劍，它可能帶來正義的實現，但也可能引發更大的災難。在《史記》中，司馬遷對豫讓的描寫側重於他的忠義精神，而非復仇行為本身的結果，這或許也是一種對復仇文化的反思。",
                        type: "neutral"
                    }
                },
                // 關鍵決策點
                keyDecisions: [
                    {
                        title: "初始抉擇",
                        description: "智伯死後的選擇",
                        choices: [
                            { text: "為智伯復仇", outcome: "踏上復仇之路" },
                            { text: "保全自己", outcome: "無法載入史冊" }
                        ]
                    },
                    {
                        title: "第一次失敗後",
                        description: "趙襄子釋放你後的選擇",
                        choices: [
                            { text: "感恩放棄復仇", outcome: "背叛了對智伯的忠義" },
                            { text: "堅持復仇", outcome: "自殘容貌，死志更堅" }
                        ]
                    },
                    {
                        title: "最終選擇",
                        description: "如何完成復仇使命",
                        choices: [
                            { text: "擊襲衣服", outcome: "在精神上完成復仇，名垂青史" },
                            { text: "堅持剿滅肉身", outcome: "實質復仇，但引發動亂" }
                        ]
                    }
                ]
            },
            "nie-zheng": {
                name: "聶政",
                era: "戰國時期",
                title: "轵邑勇士",
                description: "為報知己厚恩，刺殺韓相俠累",
                scenarios: [
                    {
                        title: "齊國避難",
                        text: "你是聶政，轵縣深井里人。因為殺人躲避仇家追殺，你和母親、姐姐逃到齊國，以屠宰為職業。雖身在市井，但你內心仍有大志。",
                        knowledge: "戰國時期的社會流動性較強，即便是因犯罪而逃亡的人，也有可能在他鄉重新開始。",
                        choices: [
                            { text: "安心屠宰，照顧家人", next: "nie-zheng-1a", hint: { type: "neutral", text: "盡孝之道" } },
                            { text: "保持警惕，等待機會", next: "nie-zheng-1b", hint: { type: "good", text: "懷才待用" } }
                        ]
                    },
                    {
                        id: "nie-zheng-1a",
                        title: "安穩生活",
                        text: "你選擇安心在齊國做一名屠夫，精心照顧母親和姐姐。這時，有一位叫嚴仲子的人多次來訪，甚至送上百金為你母親祝壽。",
                        knowledge: "在古代，能送百金這樣的厚禮，說明嚴仲子非富即貴，很可能有所求。",
                        choices: [
                            { text: "保持警惕，婉拒厚禮", next: "nie-zheng-2a", hint: { type: "good", text: "謹慎之舉" } }
                        ]
                    },
                    {
                        id: "nie-zheng-1b",
                        title: "等待機會",
                        text: "你表面上是一名普通屠夫，但內心一直在等待能夠施展才華的機會。這時，有一位叫嚴仲子的人多次來訪，甚至送上百金為你母親祝壽。",
                        knowledge: "許多懷才不遇的士人會寄身於市井，等待明主的賞識。",
                        choices: [
                            { text: "謹慎回應，試探對方意圖", next: "nie-zheng-2a", hint: { type: "good", text: "審時度勢" } }
                        ]
                    },
                    {
                        id: "nie-zheng-2a",
                        title: "嚴仲子的請求",
                        text: "你辭謝嚴仲子的厚禮：'我很慶幸我的老母尚在，以屠狗為職業，也能奉養母親。我有足夠的能力供養母親，不敢接受仲子的賜予。'嚴仲子告訴你他有仇要報，遍遊諸侯國，只為尋找能幫他報仇的人。",
                        knowledge: "古代的'士'階層常有'士為知己者死'的觀念，而嚴仲子正是在尋找這樣的人。",
                        choices: [
                            { text: "拒絕他的請求", next: "nie-zheng-3a", hint: { type: "good", text: "孝道為先" } },
                            { text: "詢問詳情但不承諾", next: "nie-zheng-3b", hint: { type: "neutral", text: "審慎了解" } }
                        ]
                    },
                    {
                        id: "nie-zheng-3a",
                        title: "婉拒請求",
                        text: "你明確拒絕嚴仲子：'我之所以降低自己的志向，委屈自己，在市井裡做一個普通的屠夫，只是想能夠通過這種方法來奉養母親。老母尚在人世，我聶政是不敢用自己的性命來答應為他人獻身的。'",
                        knowledge: "在中國傳統思想中，'孝'與'義'同樣重要，二者發生衝突時往往以'孝'為先。",
                        choices: [
                            { text: "繼續生活，直到母親去世", next: "nie-zheng-4a", hint: { type: "good", text: "孝盡後報恩" } }
                        ]
                    },
                    {
                        id: "nie-zheng-3b",
                        title: "暫不承諾",
                        text: "你對嚴仲子的遭遇表示同情，但沒有立即答應：'老母尚在人世，我聶政是不敢用自己的性命來答應為他人獻身的。'嚴仲子雖然失望，但理解你的難處，表示尊重你的決定。",
                        knowledge: "戰國時期的士人常常面臨家庭責任與個人抱負之間的矛盾。",
                        choices: [
                            { text: "繼續生活，直到母親去世", next: "nie-zheng-4a", hint: { type: "good", text: "先孝後義" } }
                        ]
                    },
                    {
                        id: "nie-zheng-4a",
                        title: "母親去世",
                        text: "很久之後，你的母親去世了。你安葬完母親，脫掉喪服，感慨道：'我只是一個市井上的普通百姓，手拿著刀來屠宰牲畜罷了；而嚴仲子身為諸侯國的卿相，竟然不遠千里，降低自己的身份屈駕前來與我結交。像他這樣一個賢明聖德的人，我怎麼能獨自心安理得地默不作聲！'",
                        knowledge: "母親去世後，聶政不再有後顧之憂，可以專注於'義'的追求。這反映了中國傳統文化中'孝'與'義'的倫理順序。",
                        choices: [
                            { text: "尋找嚴仲子，願意為他效力", next: "nie-zheng-5a", hint: { type: "good", text: "知恩圖報" } },
                            { text: "繼續平凡生活，照顧姐姐", next: "nie-zheng-end-1", hint: { type: "bad", text: "遠離是非" } },
                            { text: "與姐姐商議此事", next: "nie-zheng-4b", hint: { type: "neutral", text: "徵求意見" } }
                        ]
                    },
                    {
                        id: "nie-zheng-4b",
                        title: "姐弟對話",
                        text: "你將嚴仲子的事情告訴了姐姐聶榮。聶榮沉思片刻，說道：'弟弟，知遇之恩當報，但我也擔心你的安危。我們已經失去了母親，我不想再失去你。然而，你若心意已決，我定當支持你。'",
                        knowledge: "聶榮在《史記》中被描述為性情剛烈的女子，她對弟弟的情感既有親情的擔憂，又有對義氣的理解和尊重。",
                        choices: [
                            { text: "決定尋找嚴仲子", next: "nie-zheng-5a", hint: { type: "good", text: "義不容辭" } },
                            { text: "為了姐姐放棄報恩", next: "nie-zheng-end-4", hint: { type: "neutral", text: "顧念親情" } }
                        ]
                    },
                    {
                        id: "nie-zheng-5a",
                        title: "接受使命",
                        text: "你來到濮陽，見到嚴仲子說：'從前我沒有答應仲子先生的原因，是因為母親健在；如今老母不幸已經過世，仲子想要向誰尋仇？就請允許我替您處理這件事情吧。'嚴仲子告訴你他的仇人是韓國的宰相俠累，還是韓王的叔父，守衛非常森嚴。",
                        knowledge: "韓國宰相俠累不僅是高官，還是王室成員，刺殺他的難度極高，幾乎是不可能完成的任務。",
                        choices: [
                            { text: "接受挑戰，獨自前往", next: "nie-zheng-6a", hint: { type: "good", text: "勇毅果決" } },
                            { text: "請求嚴仲子提供支援", next: "nie-zheng-6b", hint: { type: "neutral", text: "尋求幫手" } }
                        ]
                    },
                    {
                        id: "nie-zheng-6a",
                        title: "獨自刺殺",
                        text: "你拒絕了嚴仲子提供的支援：'韓國和衛國相距不遠。要殺韓國的國相，而這位國相又是國君的親戚，不可以派太多人。人多必出紕漏，一旦洩露消息，韓國全國上下都會與仲子為敵，這太危險了。'你帶著寶劍獨自前往韓國。",
                        knowledge: "聶政選擇獨自行動，既是為了提高成功率，也是為了保護嚴仲子。",
                        choices: [
                            { text: "潛入韓國王宮執行刺殺", next: "nie-zheng-7a", hint: { type: "good", text: "直搗黃龍" } },
                            { text: "先暗中調查俠累行蹤", next: "nie-zheng-6c", hint: { type: "neutral", text: "謹慎行事" } }
                        ]
                    },
                    {
                        id: "nie-zheng-6c",
                        title: "細密調查",
                        text: "你決定先潛入韓國，暗中調查俠累的日常行蹤和護衛情況。經過數日觀察，你發現俠累每五日便會去郊外的別館休息，那裡的守衛相對較少。",
                        knowledge: "精心的準備和情報收集是刺客成功的關鍵。歷史上許多成功的刺殺都經過了縝密的計劃。",
                        choices: [
                            { text: "在別館行刺", next: "nie-zheng-7b", hint: { type: "neutral", text: "趁虛而入" } },
                            { text: "仍選擇在朝堂行刺", next: "nie-zheng-7a", hint: { type: "good", text: "歷史選擇" } }
                        ]
                    },
                    {
                        id: "nie-zheng-7a",
                        title: "最後一擊",
                        text: "你來到韓國，發現宰相俠累正坐在堂上，身邊守衛眾多。你毫不猶豫，直接衝上前去刺殺了俠累。左右的人大聲呼喊，你又殺死了數十人。為了不連累嚴仲子，你自毀容貌，挖出雙眼，剖腹自殺。",
                        knowledge: "聶政自毀容貌是為了避免被認出，從而保護嚴仲子和自己的家人。這種極端的自我犧牲精神令人震撼。",
                        choices: [
                            { text: "查看故事結局", next: "nie-zheng-end-3", hint: { type: "good", text: "歷史結局" } },
                            { text: "試圖突圍逃走", next: "nie-zheng-7c", hint: { type: "neutral", text: "求生之路" } }
                        ]
                    },
                    {
                        id: "nie-zheng-7c",
                        title: "試圖突圍",
                        text: "殺死俠累後，你沒有選擇自毀容貌，而是憑藉高超的武藝，試圖突破重圍逃走。你連殺數十名侍衛，衝出宮門，但城中已經戒嚴，禁衛軍四處搜捕。",
                        knowledge: "在古代刺殺高官後試圖逃脫幾乎是不可能的任務，尤其是在都城這樣的重兵把守之地。",
                        choices: [
                            { text: "隱藏身份，夜間突圍", next: "nie-zheng-8c", hint: { type: "neutral", text: "智取生路" } },
                            { text: "自知難逃，自盡保密", next: "nie-zheng-end-5", hint: { type: "bad", text: "捍衛身後名" } }
                        ]
                    },
                    {
                        id: "nie-zheng-8a",
                        title: "最後的戰鬥",
                        text: "你決定與追兵周旋，為自己爭取時間。在殺死多名侍衛後，你已身受重傷。為了不連累嚴仲子，你用劍挖出自己的眼睛，割下臉上的肌肉，最後自刎而死。",
                        knowledge: "刺客為了保護主使者和家人，往往會採取極端的方式防止身份被識別。聶政的做法在歷史上極為罕見，體現了他的忠義精神。",
                        choices: [
                            { text: "查看故事結局", next: "nie-zheng-end-3", hint: { type: "good", text: "非凡忠義" } }
                        ]
                    },
                    {
                        id: "nie-zheng-8b",
                        title: "成功逃脫",
                        text: "你憑藉出色的身手和對地形的了解，成功突破了侍衛的包圍，逃出了別館，趁夜離開了韓國。你沒有立即返回嚴仲子處，而是四處流浪，隱姓埋名。",
                        knowledge: "在中國古代，成功完成刺殺並逃脫的例子極為罕見。如果聶政真的選擇這條路，歷史可能會有不同的記載。",
                        choices: [
                            { text: "秘密返回尋找姐姐", next: "nie-zheng-9a", hint: { type: "neutral", text: "思念親人" } },
                            { text: "從此隱居，離群索居", next: "nie-zheng-end-6", hint: { type: "neutral", text: "遠離是非" } }
                        ]
                    },
                    {
                        id: "nie-zheng-8c",
                        title: "追捕與藏匿",
                        text: "你找到一家客棧藏身，計劃夜間突圍。但韓國已經加強搜捕，你的特徵被廣泛通報。入夜時，你偽裝成商人準備離城，卻在城門口被守衛認出。",
                        knowledge: "古代城市的守衛系統在重大事件後會特別嚴密，尤其是針對政治暗殺事件。",
                        choices: [
                            { text: "拼死突圍", next: "nie-zheng-end-7", hint: { type: "bad", text: "臨危一搏" } },
                            { text: "自盡保密", next: "nie-zheng-end-5", hint: { type: "neutral", text: "保全大局" } }
                        ]
                    },
                    {
                        id: "nie-zheng-9a",
                        title: "尋找姐姐",
                        text: "幾個月後，你秘密返回齊國尋找姐姐聶榮。當你在深夜敲響家門時，姐姐驚喜萬分，但也非常擔心：'弟弟，你已成為各國追捕的要犯，不能久留。我擔心連累你，更擔心連累嚴仲子。'",
                        knowledge: "兄妹親情在中國傳統文化中佔有重要地位，聶政和聶榮的故事尤為感人。",
                        choices: [
                            { text: "帶姐姐一起隱居", next: "nie-zheng-end-8", hint: { type: "neutral", text: "相依為命" } },
                            { text: "為保護姐姐，獨自離去", next: "nie-zheng-end-9", hint: { type: "good", text: "捨己為人" } }
                        ]
                    }
                ],
                endings: {
                    "nie-zheng-end-1": {
                        name: "安居守孝",
                        text: "你選擇繼續平凡的生活，照顧姐姐，遠離權力鬥爭。嚴仲子最終沒能為自己報仇，而你雖然活了下來，但沒有成就足以讓後人銘記的義舉。",
                        comment: "在《史記·刺客列傳》中，聶政因為其非凡的忠義之舉而被記載。如果他選擇平凡生活，就不會有後來感人的故事。",
                        type: "bad"
                    },
                    "nie-zheng-end-2": {
                        name: "連累知己",
                        text: "你帶著幫手前往韓國，但行動剛開始就被發現。幫手被抓，供出了嚴仲子。你雖然逃脫，但嚴仲子和他的家族遭到滅族之禍，你的姐姐也因此受到牽連。",
                        comment: "歷史上的聶政正是考慮到多人行動可能帶來的風險，才選擇獨自前往。他的智慧和勇氣使他的刺殺行動成為了千古佳話。",
                        type: "bad"
                    },
                    "nie-zheng-end-3": {
                        name: "毀貌報恩",
                        text: "你成功刺殺了韓國宰相俠累，並自毀容貌而死。韓國人將你的屍體在集市上公開，懸賞詢問，沒有人認識你是誰。\n\n後來，你的姐姐聶榮聽聞此事，前來認屍，痛哭說道：'這是轵縣深井里一個叫作聶政的人。'她解釋你為何要毀容：'我弟弟因為我仍然在世的原因，又將自己的身體嚴重摧殘，以此來斷絕牽連別人的線索。我怎麼能因為擔心自己遭到殺身之禍，而埋沒賢弟的名聲呢！'她悲傷過度，死在你的屍體旁邊。\n\n你和姐姐的故事震驚了各國，人們稱讚：'不只聶政是個能人，連他的姐姐也是一個性情剛烈的女子。'",
                        comment: "《史記》記載，聶政和他姐姐的故事感動了無數人。這個故事體現了中國古代'士為知己者死'、'士可殺不可辱'的價值觀，以及兄妹之間的深厚情誼。",
                        type: "good"
                    },
                    "nie-zheng-end-4": {
                        name: "顧全手足",
                        text: "為了不讓姐姐傷心，你放棄了報答嚴仲子的念頭，與姐姐繼續平凡生活。嚴仲子苦等多時，最終找到其他人報仇，但那人失敗被捕，牽連了嚴仲子全族。當你聽聞此事，內心充滿愧疚和悔恨，但一切已無法挽回。",
                        comment: "《史記》中記載的聶政，正是因為在孝道盡了之後，選擇了為知己赴死的道路，才被後世稱頌。這種捨生取義的精神是中國傳統文化中最為推崇的價值觀之一。",
                        type: "neutral"
                    },
                    "nie-zheng-end-5": {
                        name: "亡身牽累",
                        text: "面對無法突破的重圍，你選擇自盡，但沒有自毀容貌。韓國官府很快確認了你的身份，並順藤摸瓜找到了嚴仲子。嚴仲子全族遭到滅殺，連你的姐姐聶榮也被牽連而死。你在黃泉路上永遠背負著連累親友的愧疚。",
                        comment: "聶政在歷史上自毀容貌正是為了保護嚴仲子和姐姐。這種極端的自我犧牲精神展現了中國古代士人'士為知己者死'的崇高品格。",
                        type: "bad"
                    },
                    "nie-zheng-end-6": {
                        name: "攜恨歸隱",
                        text: "你成功刺殺俠累並逃脫，從此隱居山林，不再與外界來往。韓國虽然追查刺客，但始終未能找到真相。你活到了老年，但每當想起姐姐和嚴仲子，心中總是難以釋懷。\n\n多年後，有人在山中發現一位隱士留下的遺書，講述了刺殺俠累的真相。這個故事才得以流傳，但已經與《史記》中記載的版本大相徑庭。",
                        comment: "歷史上的聶政之所以讓人感動，正是因為他不僅完成了使命，還通過自毀容貌保護了嚴仲子和家人。如果他選擇逃生，可能就不會有後來那麼感人的故事了。",
                        type: "neutral"
                    },
                    "nie-zheng-end-7": {
                        name: "城門絕命",
                        text: "你在城門口被發現，拼死反抗，殺傷多名守衛，但最終不敵眾多士兵的圍攻，身中數箭而死。韓國官府通過你的裝束和隨身物品，很快查出你的身份，並派兵襲擊嚴仲子的宅邸。嚴仲子全族及你的姐姐都因此遇難。",
                        comment: "在中國傳統價值觀中，成功完成使命固然重要，但保全主使者和親人的安全同樣重要。聶政自毀容貌的行為被後世讚頌，正是因為他不僅完成了任務，還保護了身後之人。",
                        type: "bad"
                    },
                    "nie-zheng-end-8": {
                        name: "偕隱山林",
                        text: "你帶著姐姐聶榮一起隱居深山。雖然生活艱辛，但兄妹相依為命，也有一種平靜的幸福。多年後，嚴仲子派人找到了你們，告知俠累死後，韓國內部發生了變故，他已恢復了地位。\n\n他邀請你出山相助，但你婉拒了，選擇與姐姐繼續隱居生活。你們的故事沒有被《史記》記載，但在當地流傳著一對隱居山林的兄妹的傳說。",
                        comment: "聶政和聶榮的故事之所以感人，不僅因為他們的忠義，還因為兄妹之間的深情。在歷史上，聶榮為了弟弟的名聲不惜犧牲自己，展現了中國古代家族倫理中最為崇高的情感。",
                        type: "neutral"
                    },
                    "nie-zheng-end-9": {
                        name: "全姊捨身",
                        text: "為了保護姐姐，你選擇獨自離去。你告訴姐姐：'我已經完成了對嚴仲子的承諾，接下來我要保證你的安全。請忘記我，過你自己的生活。'說完，你消失在夜色中。\n\n多年後，韓國仍在搜尋刺殺俠累的兇手。有一天，一具無名屍體被發現在邊境，面容被毀，無法辨認。但有人在屍體上發現了一封信，上面寫著：'願我妹聶榮平安喜樂，願嚴仲子永享安康。'聶榮得知後悲痛欲絕，不久也離開人世。",
                        comment: "聶政和聶榮的故事展現了中國古代最為人稱道的兄妹之情。在現實中，聶政為了不連累姐姐而自毀容貌，而聶榮則為了弟弟的名聲而犧牲自己。這種相互犧牲的精神千百年來感動了無數人。",
                        type: "good"
                    }
                },
                // 關鍵決策點
                keyDecisions: [
                    {
                        title: "母親在世時",
                        description: "面對嚴仲子請求的選擇",
                        choices: [
                            { text: "為孝拒絕", outcome: "履行孝道，推遲義舉" },
                            { text: "貿然允諾", outcome: "可能連累家人" }
                        ]
                    },
                    {
                        title: "母親去世後",
                        description: "是否接受嚴仲子的請求",
                        choices: [
                            { text: "尋找嚴仲子", outcome: "踏上危險的復仇之路" },
                            { text: "照顧姐姐", outcome: "平安一生，不載史冊" }
                        ]
                    },
                    {
                        title: "任務完成時",
                        description: "刺殺俠累後的選擇",
                        choices: [
                            { text: "自毀容貌", outcome: "保護嚴仲子和姐姐，名垂千古" },
                            { text: "試圖逃脫", outcome: "可能連累他人，歷史或改寫" }
                        ]
                    }
                ]
            },
            "jing-ke": {
                name: "荊軻",
                era: "戰國時期",
                title: "燕國刺客",
                description: "刺秦王，風蕭蕭兮易水寒",
                scenarios: [
                    {
                        title: "燕國相遇",
                        text: "你是荊軻，衛國人，後遷徙到燕國。你喜歡讀書、擊劍，但未被重用。在燕國，你與殺狗的屠夫和擊筑師高漸離結交，常在集市飲酒。表面上看你是個市井之徒，但燕國隱士田光先生卻知道你非等閒之輩。",
                        knowledge: "荊軻在歷史上形象複雜，既有市井氣息，又有文人風骨，精通劍術卻深居簡出。",
                        choices: [
                            { text: "繼續隱居市井", next: "jing-ke-1a", hint: { type: "neutral", text: "安於現狀" } },
                            { text: "積極尋求機會", next: "jing-ke-1b", hint: { type: "good", text: "求取功名" } }
                        ]
                    },
                    {
                        id: "jing-ke-1a",
                        title: "隱居生活",
                        text: "你繼續與屠夫和高漸離飲酒作樂，但燕太子丹聽聞你的名聲，通過田光先生邀請你前往宮中。田光為表誠意，拔劍自刎以證明不會洩露秘密。",
                        knowledge: "田光的自殺體現了戰國時期士人的義氣和決斷，也說明太子丹所謀之事非同小可。",
                        choices: [
                            { text: "拒絕太子丹的邀請", next: "jing-ke-end-1", hint: { type: "bad", text: "錯過歷史" } },
                            { text: "前往太子丹宮中", next: "jing-ke-2a", hint: { type: "good", text: "改變命運" } }
                        ]
                    },
                    {
                        id: "jing-ke-1b",
                        title: "把握機會",
                        text: "你一直在等待施展才華的機會。不久，燕太子丹通過田光先生邀請你前往宮中。田光為表誠意，拔劍自刎以證明不會洩露秘密。",
                        knowledge: "荊軻原本並非刺客，而是一個有才華的士人，只是時勢造就了他後來的命運。",
                        choices: [
                            { text: "前往太子丹宮中", next: "jing-ke-2a", hint: { type: "good", text: "勇敢一步" } }
                        ]
                    },
                    {
                        id: "jing-ke-2a",
                        title: "太子的請求",
                        text: "你來到太子丹的宮中，太子向你叩頭說：'秦王野心勃勃，已滅韓國，又向南攻楚，向北逼趙。燕國弱小，難以抵抗。我有一計，派遣勇士出使秦國，若能刺殺秦王，諸侯可趁機聯合抗秦。這是我最大的希望，但不知託付給誰才好。'",
                        knowledge: "當時秦國已占領六國大部分領土，形勢危急。燕太子丹的計劃是孤注一擲的嘗試。",
                        choices: [
                            { text: "婉拒太子請求", next: "jing-ke-end-2", hint: { type: "bad", text: "明哲保身" } },
                            { text: "接受太子委託", next: "jing-ke-3a", hint: { type: "good", text: "勇赴國難" } }
                        ]
                    },
                    {
                        id: "jing-ke-3a",
                        title: "準備刺秦",
                        text: "你答應了太子丹的請求，被封為上卿，住進高級公館。太子每天都來探望你，提供豐盛的飲食和珍寶美女。秦軍逼近燕國南部邊境，太子催促你行動。你提出需要能接近秦王的信物----樊於期的頭顱和燕地督亢的地圖。",
                        knowledge: "荊軻提出的計劃十分精妙----秦王懸賞千金尋找樊於期的頭顱，而地圖則可以引誘貪婪的秦王靠近。",
                        choices: [
                            { text: "勸說樊於期自刎", next: "jing-ke-4a", hint: { type: "good", text: "歷史之選" } },
                            { text: "想辦法獲取其他信物", next: "jing-ke-end-3", hint: { type: "neutral", text: "另尋他途" } }
                        ]
                    },
                    {
                        id: "jing-ke-4a",
                        title: "說服樊於期",
                        text: "太子丹不忍殺死樊於期，你私下拜訪樊於期，說：'秦國對待將軍您太狠毒了！我想帶著將軍的頭顱去見秦王，近身後刺殺他，為將軍報仇，也解除燕國的憂患。'樊於期聽後悲憤交加，立即自刎。",
                        knowledge: "樊於期的自刎體現了戰國時期士人的氣節，也為荊軻刺秦提供了關鍵的信物。",
                        choices: [
                            { text: "準備啟程前往秦國", next: "jing-ke-5a", hint: { type: "good", text: "踏上征程" } }
                        ]
                    },
                    {
                        id: "jing-ke-5a",
                        title: "易水送別",
                        text: "太子為你準備了趙國徐夫人的鋒利匕首，浸入毒液。又派秦舞陽作你的助手。臨行前，太子和賓客們穿著白色的衣服帽子為你送行，一直送到易水邊。高漸離擊筑，你唱著'風蕭蕭兮易水寒，壯士一去兮不復還'的歌，眾人淚如雨下。",
                        knowledge: "易水送別是中國歷史上著名的悲壯場景，荊軻的歌聲千古流傳，被視為壯士赴死的絕唱。",
                        choices: [
                            { text: "毅然啟程前往秦國", next: "jing-ke-6a", hint: { type: "good", text: "赴義之旅" } }
                        ]
                    },
                    {
                        id: "jing-ke-6a",
                        title: "咸陽宮中",
                        text: "你到達秦國後，通過寵臣蒙嘉引見秦王。在咸陽宮的隆重儀式上，你手捧裝有樊於期頭顱的匣子，秦舞陽手捧地圖匣子前行。秦舞陽突然臉色大變，你微笑著替他解釋，穩定了局勢。",
                        knowledge: "秦舞陽的表現差點破壞計劃，體現了刺殺行動的高風險性。荊軻的臨危不亂顯示了他的非凡膽識。",
                        choices: [
                            { text: "展開地圖，拔出匕首", next: "jing-ke-7a", hint: { type: "good", text: "時機已到" } },
                            { text: "觀察情況，稍後再出手", next: "jing-ke-7a", hint: { type: "neutral", text: "謹慎行事" } }
                        ]
                    },
                    {
                        id: "jing-ke-7a",
                        title: "刺殺時刻",
                        text: "秦王要求看地圖，你拿過地圖呈上，等地圖展到盡頭，藏在裡面的匕首露出來。你立即左手抓住秦王衣袖，右手持匕首刺向秦王。匕首未中，秦王驚退。你追逐秦王繞柱而走，情勢危急。",
                        knowledge: "這次刺殺雖然失敗，但千年來一直被視為中國歷史上最著名的刺殺事件之一。",
                        choices: [
                            { text: "堅持戰鬥到最後一刻", next: "jing-ke-end-4", hint: { type: "good", text: "歷史結局" } },
                            { text: "投擲匕首作最後一搏", next: "jing-ke-7d", hint: { type: "neutral", text: "險中求勝" } }
                        ]
                    },
                    {
                        id: "jing-ke-7c",
                        title: "背叛太子",
                        text: "你決定向秦王透露太子丹的計劃，秦王起初不信，但當你拿出證據時，他大為震驚。秦王承諾若情報屬實，將封你為將軍，賞賜千金。",
                        knowledge: "歷史上確有許多人為利益背叛主君，雖然荊軻不屬此列，但這種可能性在亂世中並非罕見。",
                        choices: [
                            { text: "接受秦王承諾，成為秦國將領", next: "jing-ke-end-6", hint: { type: "bad", text: "忘恩負義" } },
                            { text: "背叛只是詭計，突然發動攻擊", next: "jing-ke-8b", hint: { type: "neutral", text: "計中有計" } }
                        ]
                    },
                    {
                        id: "jing-ke-7d",
                        title: "最後一搏",
                        text: "眼見秦王不斷後退，你意識到無法近身。千鈞一髮之際，你將匕首用盡全力投向秦王。匕首劃破空氣，直奔秦王面門。",
                        knowledge: "歷史上荊軻確實被逼到絕境，但他選擇了直接追擊而非投擲匕首。投擲武器是一種冒險的策略，成功率低但可能造成出其不意的效果。",
                        choices: [
                            { text: "查看結果", next: "jing-ke-end-7", hint: { type: "neutral", text: "最後希望" } }
                        ]
                    },
                    {
                        id: "jing-ke-8a",
                        title: "最後搏鬥",
                        text: "你向已受傷的秦王發起最後攻擊。秦王倉皇中拔出佩劍格擋，侍衛們也紛紛趕來。你雖奮力搏殺，但寡不敵眾，被侍衛刺傷多處。",
                        knowledge: "即使是最精心策劃的刺殺行動，面對眾多保護目標的侍衛時也難以成功。歷史上大多數刺客都未能完成任務並存活下來。",
                        choices: [
                            { text: "高聲宣告使命，從容就義", next: "jing-ke-end-8", hint: { type: "good", text: "壯志未酬" } }
                        ]
                    },
                    {
                        id: "jing-ke-8b",
                        title: "計中有計",
                        text: "當秦王放鬆警惕靠近你時，你突然拔出隱藏的第二把匕首，猛刺秦王腹部。秦王猝不及防，被你刺中。但秦王身上穿著鎧甲，傷口不深。侍衛們立即撲向你。",
                        knowledge: "古代刺客有時會使用聲東擊西的戰術，通過假投降或假背叛來獲取接近目標的機會。",
                        choices: [
                            { text: "查看結局", next: "jing-ke-end-9", hint: { type: "neutral", text: "最終一搏" } }
                        ]
                    }
                ],
                endings: {
                    "jing-ke-end-1": {
                        name: "沉浮市井",
                        text: "你拒絕了太子丹的邀請，繼續在市井中生活。秦國大軍很快攻破燕國，太子丹被殺，而你的名字也沒有被歷史銘記。",
                        comment: "如果荊軻拒絕太子丹，歷史上最為人知的刺殺故事就不會發生。《史記·刺客列傳》中記載的荊軻，正是因為他最終接受了太子丹的委託而被後世銘記。",
                        type: "bad"
                    },
                    "jing-ke-end-2": {
                        name: "避禍全身",
                        text: "你婉拒了太子丹的請求，認為刺殺秦王幾乎不可能成功。太子只得另尋他人，但最終沒有人敢嘗試。秦國很快攻破燕國，太子丹被殺。",
                        comment: "荊軻的故事之所以動人，正是因為他知道凶多吉少卻仍然接受了任務。這種明知不可為而為之的精神，體現了戰國士人的勇氣和擔當。",
                        type: "bad"
                    },
                    "jing-ke-end-3": {
                        name: "失信物敗",
                        text: "你放棄了使用樊於期頭顱的計劃，尋找其他方法接近秦王。然而，沒有足夠有價值的信物，秦王根本不會親自接見你。刺殺計劃失敗，燕國不久後被秦國滅亡。",
                        comment: "荊軻需要樊於期的頭顱和燕地地圖作為接近秦王的信物，這是計劃成功的關鍵。歷史上荊軻確實用這種方式獲得了接近秦王的機會。",
                        type: "neutral"
                    },
                    "jing-ke-end-4": {
                        name: "壯士不還",
                        text: "秦王在侍從的幫助下逃脫，並拔劍擊傷你的腿。你知道任務失敗，靠在銅柱上大笑：'事情之所以不能成功，是因為我想要生擒你，讓你歸還諸侯的土地！'最終你被秦王的侍從殺死。\n\n秦王因此大怒，派出更多軍隊攻打燕國，十個月後攻破薊城。太子丹被殺，燕國滅亡。高漸離改名換姓躲藏，後被發現並被秦始皇弄瞎雙眼。高漸離仍不放棄，在再次侍奉秦始皇時，將鉛塊藏在筑中擊打秦始皇，但未成功，被殺。\n\n你的故事流傳千古，成為中國歷史上最著名的刺客。",
                        comment: "《史記》記載，荊軻刺秦失敗後，秦王對燕國的報復更為猛烈。然而，荊軻臨危不懼、寧死不屈的精神一直被後世傳頌。他的'風蕭蕭兮易水寒，壯士一去兮不復還'成為千古絕唱，象徵了中國古代士人的氣節和勇氣。",
                        type: "good"
                    },
                    "jing-ke-end-5": {
                        name: "背主求生",
                        text: "你見秦王受傷但未死，而侍衛已蜂擁而至，便轉身試圖逃離。在混亂中，你殺死數名侍衛，衝出宮門，但很快被秦國大軍追上並擒獲。經嚴刑拷打後，你供出太子丹的計劃。秦王大怒，不僅處死你，還派遣大軍立即攻打燕國。燕國很快滅亡，太子丹自刎而死。你在歷史上留下了失敗刺客和背叛者的雙重形象。",
                        comment: "荊軻若選擇逃跑而非戰死，可能會讓歷史對他的評價大不相同。中國古代極為重視臨危不懼、從容就義的品格，這也是為何歷史上的荊軻選擇了戰鬥到最後一刻。",
                        type: "bad"
                    },
                    "jing-ke-end-6": {
                        name: "叛主求生",
                        text: "你選擇背叛太子丹，成為秦國將領。秦王以你提供的情報對燕國發動突襲，太子丹被俘並受辱而死。你雖然獲得了榮華富貴，但在秦國人眼中始終是個背叛者，不被信任。秦統一六國後，你被秦始皇視為心腹大患而處死。歷史記載你為背叛者，千古唾罵。",
                        comment: "忠義是中國古代最重要的價值觀之一，背叛主君的人即使一時得志，也往往不得好終。荊軻若真的背叛太子丹，就不會成為後世敬仰的義士。",
                        type: "bad"
                    },
                    "jing-ke-end-7": {
                        name: "刃劃龍顏",
                        text: "你投出的匕首劃過空中，擦過秦王的面頰，在他臉上留下一道血痕，卻未能致命。秦王大怒，親自持劍向你刺來。你空手搏擊，殺死數名侍衛，但最終寡不敵眾，被秦王的劍刺穿胸膛。你倒在血泊中，微笑著說：'我雖未能殺你，但讓你的臉上永遠留下燕國的印記，告誡你不要忘記天下仍有勇士敢於挑戰暴秦！'秦王因你的刺殺更加憤怒，加速了滅燕的進程，但你的故事也流傳千古。",
                        comment: "歷史上荊軻雖未能殺死秦王，但他的義舉震撼了當時的世界，成為反抗暴政的象徵。即使失敗，勇氣和精神也能激勵後人。",
                        type: "neutral"
                    },
                    "jing-ke-end-8": {
                        name: "慷慨赴死",
                        text: "在最後的搏殺中，你被侍衛們重重包圍。你高聲宣告：'燕國蒙冤，諸侯受壓，我荊軻今日雖死，必有後來者繼續反抗暴秦！'說完，你用匕首自刎，從容就義。秦王雖然受傷，但很快康復，卻因此事對燕國恨之入骨，派大軍攻打燕國。燕國滅亡後，秦王仍心有餘悸，加速了統一六國的步伐。你的名字和壯舉流傳後世，成為反抗暴政的象徵。",
                        comment: "荊軻的刺秦行動雖然失敗，但他的英勇精神影響了無數後人。在中國文化中，有時失敗的英雄比成功的常人更受尊敬，因為他們展現了人性中最崇高的品質。",
                        type: "good"
                    },
                    "jing-ke-end-9": {
                        name: "最後機謀",
                        text: "你的詭計雖然使秦王受傷，但未能致命。在混戰中，你殺死數名侍衛，但最終被制服。秦王親自審問你，問你為何要行刺。你正氣凜然地說：'為燕國，為天下蒼生！暴秦必亡！'秦王大怒，將你五馬分屍，並將你的頭顱懸掛在咸陽城門示眾。\n\n你的行動雖然失敗，但激勵了更多反抗秦國的人。雖然燕國最終被滅，但你的名字和精神卻傳頌千古。後人每當提起反抗暴政的勇士，必定會想起你荊軻的名字。",
                        comment: "荊軻的故事之所以感人，不僅因為他的勇氣，還因為他對理想的堅持。即使面對必死的局面，他依然選擇了反抗而非屈服，這種精神永遠值得後人敬仰。",
                        type: "neutral"
                    },
                    "jing-ke-end-10": {
                        text: "在你持匕首追逐秦王的時候，意外發現秦王後背露出破綻。你鼓足全力，一躍而起，匕首深深刺入秦王背部。秦王倒地，鮮血四濺。你高喊：'燕國復仇！天下蒼生得解脫！'秦王侍衛一擁而上將你亂劍砍死，但為時已晚，秦王嬴政重傷不治而亡。\n\n秦國隨後陷入內亂，六國趁機起兵反抗，最終秦帝國在未能統一天下的情況下提前崩潰。歷史走向完全改變，而你，荊軻，成為了扭轉歷史的關鍵人物，被後世尊為救世英雄。",
                        comment: "這個結局純屬虛構，與史實不符。歷史上荊軻確實未能刺殺秦王，但他捨生取義的精神仍然值得敬佩。這種假設性的結局讓我們思考：如果荊軻成功了，歷史會如何改寫？",
                        type: "secret"
                    }
                },
                // 關鍵決策點
                keyDecisions: [
                    {
                        title: "面對機會",
                        description: "是否接受太子丹的邀請",
                        choices: [
                            { text: "拒絕邀請", outcome: "遠離歷史舞台" },
                            { text: "接受邀請", outcome: "踏上千古名垂之路" }
                        ]
                    },
                    {
                        title: "刺殺準備",
                        description: "如何取得接近秦王的信物",
                        choices: [
                            { text: "勸說樊於期自刎", outcome: "獲得秦王最想要的禮物" },
                            { text: "使用其他信物", outcome: "難以獲得秦王親自接見" }
                        ]
                    },
                    {
                        title: "關鍵時刻",
                        description: "咸陽宮中面對秦王",
                        choices: [
                            { text: "展開地圖，拔出匕首", outcome: "即刻行動，成就千古名刺" },
                            { text: "觀望猶豫", outcome: "可能錯失唯一機會" }
                        ]
                    }
                ]
            }
        };

        // 遊戲狀態
        let gameState = {
            currentCharacter: null,
            currentScenario: null,
            progress: 0,
            completedEndings: {
                "cao-mo": [],
                "zhuan-zhu": [],
                "yu-rang": [],
                "nie-zheng": [],
                "jing-ke": []
            },
            unlockedAchievements: [],
            // 新增：隱藏提示解鎖狀態
            unlockedHints: {},
            // 新增：特殊結局解鎖條件追蹤
            specialEndingProgress: {
                "yu-rang-end-11": false, // 豫讓的特殊結局
                "jing-ke-end-10": false,  // 荊軻的秘密結局
                "cao-mo-secret-ending": false, // 曹沫的隱藏結局（待實現）
                "zhuan-zhu-secret-ending": false, // 專諸的隱藏結局（待實現）
                "nie-zheng-secret-ending": false // 聶政的隱藏結局（待實現）
            },
            // 新增：結局類型分布統計
            endingTypeStats: {
                "good": 0,
                "neutral": 0,
                "bad": 0,
                "secret": 0
            },
            // 新增：角色決策記錄
            decisionsHistory: {},
            // 新增：時間限制選擇教學標記
            hasSeenTimedChoice: false,
            // 新增：音效設置
            soundEnabled: true,
            // 新增：角色解鎖狀態（按時代順序）
            unlockedCharacters: ["cao-mo"], // 初始只解鎖曹沫
            // 新增：獲得的刺客精神
            acquiredSpirits: [],
            // 新增：選項提示顯示設置
            showChoiceHints: false // 默認不顯示選項提示
        };

        // 成就系統定義
        const achievements = [
            {
                id: "first_ending",
                name: "初探刺客之道",
                description: "解鎖第一個結局",
                icon: "🏆",
                condition: (gameState) => {
                    return Object.values(gameState.completedEndings).some(endings => endings.length > 0);
                }
            },
            {
                id: "master_assassin",
                name: "刺客大師",
                description: "每位角色至少解鎖一個結局",
                icon: "🗡️",
                condition: (gameState) => {
                    return Object.values(gameState.completedEndings).every(endings => endings.length > 0);
                }
            },
            {
                id: "good_endings",
                name: "忠義之士",
                description: "解鎖5個正面結局",
                icon: "🌟",
                condition: (gameState) => {
                    return gameState.endingTypeStats.good >= 5;
                }
            },
            {
                id: "bad_endings",
                name: "遺恨千古",
                description: "解鎖5個負面結局",
                icon: "⚰️",
                condition: (gameState) => {
                    return gameState.endingTypeStats.bad >= 5;
                }
            },
            {
                id: "neutral_endings",
                name: "中庸之道",
                description: "解鎖5個中立結局",
                icon: "☯️",
                condition: (gameState) => {
                    return gameState.endingTypeStats.neutral >= 5;
                }
            },
            {
                id: "secret_path_explorer",
                name: "探索隱秘",
                description: "發現一個隱藏結局",
                icon: "🔍",
                condition: (gameState) => {
                    return gameState.endingTypeStats.secret >= 1;
                }
            },
            {
                id: "cao_mo_master",
                name: "曹沫的傳承",
                description: "解鎖曹沫所有結局",
                icon: "🛡️",
                condition: (gameState) => {
                    const totalEndings = Object.keys(characters["cao-mo"].endings).length;
                    return gameState.completedEndings["cao-mo"].length >= totalEndings;
                }
            },
            {
                id: "zhuan_zhu_master",
                name: "專諸的智謀",
                description: "解鎖專諸所有結局",
                icon: "🐟",
                condition: (gameState) => {
                    const totalEndings = Object.keys(characters["zhuan-zhu"].endings).length;
                    return gameState.completedEndings["zhuan-zhu"].length >= totalEndings;
                }
            },
            {
                id: "yu_rang_master",
                name: "豫讓的忠義",
                description: "解鎖豫讓所有結局",
                icon: "👑",
                condition: (gameState) => {
                    const totalEndings = Object.keys(characters["yu-rang"].endings).length;
                    return gameState.completedEndings["yu-rang"].length >= totalEndings;
                }
            },
            {
                id: "nie_zheng_master",
                name: "聶政的情義",
                description: "解鎖聶政所有結局",
                icon: "👁️",
                condition: (gameState) => {
                    const totalEndings = Object.keys(characters["nie-zheng"].endings).length;
                    return gameState.completedEndings["nie-zheng"].length >= totalEndings;
                }
            },
            {
                id: "jing_ke_master",
                name: "荊軻的悲歌",
                description: "解鎖荊軻所有結局",
                icon: "🎵",
                condition: (gameState) => {
                    const totalEndings = Object.keys(characters["jing-ke"].endings).length;
                    return gameState.completedEndings["jing-ke"].length >= totalEndings;
                }
            },
            {
                id: "half_collector",
                name: "史記研讀者",
                description: "解鎖總結局數的一半",
                icon: "📜",
                condition: (gameState) => {
                    const totalEndingsCount = Object.values(characters).reduce((acc, character) => 
                        acc + Object.keys(character.endings).length, 0);
                    const totalCompletedCount = Object.values(gameState.completedEndings).reduce((acc, endings) => 
                        acc + endings.length, 0);
                    return totalCompletedCount >= (totalEndingsCount / 2);
                }
            },
            {
                id: "completionist",
                name: "刺客列傳大師",
                description: "解鎖所有結局",
                icon: "👑",
                condition: (gameState) => {
                    const totalEndingsCount = Object.values(characters).reduce((acc, character) => 
                        acc + Object.keys(character.endings).length, 0);
                    const totalCompletedCount = Object.values(gameState.completedEndings).reduce((acc, endings) => 
                        acc + endings.length, 0);
                    return totalCompletedCount >= totalEndingsCount;
                }
            },
            {
                id: "speedy_decision",
                name: "當機立斷",
                description: "在時間限制選擇中迅速做出決定",
                icon: "⏱️",
                condition: (gameState) => {
                    return gameState.hasSeenTimedChoice;
                }
            },
            {
                id: "historian",
                name: "歷史學家",
                description: "閱讀每個故事的所有知識點",
                icon: "📚",
                condition: (gameState) => {
                    // 至少解鎖了10個結局就視為閱讀了大量知識點
                    const totalCompletedCount = Object.values(gameState.completedEndings).reduce((acc, endings) => 
                        acc + endings.length, 0);
                    return totalCompletedCount >= 10;
                }
            },
            // 新增成就
            {
                id: "story_explorer",
                name: "故事起點",
                description: "開始每位角色的故事至少一次",
                icon: "🔖",
                condition: (gameState) => {
                    // 檢查每個角色是否都至少有一個決策紀錄
                    return Object.keys(characters).every(characterId => 
                        gameState.decisionsHistory[characterId] && gameState.decisionsHistory[characterId].length > 0
                    );
                }
            },
            {
                id: "spring_autumn_scholar",
                name: "春秋學者",
                description: "體驗所有春秋時期角色的故事",
                icon: "🌿",
                condition: (gameState) => {
                    // 春秋時期的角色: 曹沫、專諸
                    return ["cao-mo", "zhuan-zhu"].every(characterId => 
                        gameState.completedEndings[characterId].length > 0
                    );
                }
            },
            {
                id: "warring_states_scholar",
                name: "戰國學者",
                description: "體驗所有戰國時期角色的故事",
                icon: "⚔️",
                condition: (gameState) => {
                    // 戰國時期的角色: 豫讓、聶政、荊軻
                    return ["yu-rang", "nie-zheng", "jing-ke"].every(characterId => 
                        gameState.completedEndings[characterId].length > 0
                    );
                }
            },
            {
                id: "clothes_striker",
                name: "衣帶詔",
                description: "在豫讓故事中選擇擊打趙襄子的衣服",
                icon: "👘",
                condition: (gameState) => {
                    // 檢查豫讓的結局中是否包含擊衣結局
                    return gameState.completedEndings["yu-rang"].includes("yu-rang-end-4");
                }
            },
            {
                id: "wind_blows_cold",
                name: "風蕭蕭兮",
                description: "體驗荊軻臨別時的易水送別場景",
                icon: "🌊",
                condition: (gameState) => {
                    // 檢查荊軻的決策歷史中是否有易水送別相關選擇
                    return gameState.decisionsHistory["jing-ke"] && 
                           gameState.decisionsHistory["jing-ke"].some(decision => 
                               decision.includes("毅然啟程") || decision.includes("踏上征程")
                           );
                }
            },
            {
                id: "assassins_heart",
                name: "刺客之心",
                description: "在所有角色的故事中至少選擇一次主動刺殺選項",
                icon: "🩸",
                condition: (gameState) => {
                    // 檢查每個角色是否都有與刺殺相關的決策
                    const assassinationChoices = {
                        "cao-mo": ["挾持齊桓公", "要求齊桓公歸還全部土地"],
                        "zhuan-zhu": ["提出匕首藏魚腹的計劃", "毫不猶豫，立即行動"],
                        "yu-rang": ["為智伯復仇", "堅持復仇"],
                        "nie-zheng": ["接受挑戰，獨自前往", "潛入韓國王宮執行刺殺"],
                        "jing-ke": ["接受太子委託", "展開地圖，拔出匕首"]
                    };
                    
                    return Object.entries(assassinationChoices).every(([characterId, choices]) => {
                        return gameState.decisionsHistory[characterId] && 
                               choices.some(choice => 
                                   gameState.decisionsHistory[characterId].some(decision => 
                                       decision.includes(choice)
                                   )
                               );
                    });
                }
            },
            {
                id: "self_sacrifice",
                name: "赴湯蹈火",
                description: "在每個角色的故事中都選擇過自我犧牲的選項",
                icon: "🔥",
                condition: (gameState) => {
                    // 檢查每個角色是否都有與自我犧牲相關的結局
                    const sacrificeEndings = {
                        "cao-mo": ["cao-mo-end-3"],
                        "zhuan-zhu": ["zhuan-zhu-end-4"],
                        "yu-rang": ["yu-rang-end-4", "yu-rang-end-7", "yu-rang-end-9"],
                        "nie-zheng": ["nie-zheng-end-3", "nie-zheng-end-9"],
                        "jing-ke": ["jing-ke-end-4", "jing-ke-end-8"]
                    };
                    
                    return Object.entries(sacrificeEndings).every(([characterId, endings]) => {
                        return gameState.completedEndings[characterId] && 
                               endings.some(ending => 
                                   gameState.completedEndings[characterId].includes(ending)
                               );
                    });
                }
            },
            {
                id: "filial_duty",
                name: "孝義兩全",
                description: "在聶政的故事中既照顧母親又完成使命",
                icon: "👪",
                condition: (gameState) => {
                    // 檢查聶政是否有同時表現孝道和完成使命的結局
                    return gameState.completedEndings["nie-zheng"].includes("nie-zheng-end-3");
                }
            },
            {
                id: "fate_controller",
                name: "命運操控者",
                description: "在不同角色故事中解鎖所有不同類型的結局",
                icon: "🎭",
                condition: (gameState) => {
                    // 檢查是否解鎖了所有類型的結局
                    return gameState.endingTypeStats.good > 0 && 
                           gameState.endingTypeStats.bad > 0 && 
                           gameState.endingTypeStats.neutral > 0 && 
                           gameState.endingTypeStats.secret > 0;
                }
            },
            {
                id: "beyond_death",
                name: "死而後已",
                description: "獲得所有因角色犧牲而告終的結局",
                icon: "⚱️",
                condition: (gameState) => {
                    // 所有角色犧牲的結局
                    const sacrificeEndings = [
                        "zhuan-zhu-end-4", // 專諸犧牲結局
                        "yu-rang-end-4",   // 豫讓犧牲結局
                        "nie-zheng-end-3", // 聶政犧牲結局
                        "jing-ke-end-4"    // 荊軻犧牲結局
                    ];
                    
                    return sacrificeEndings.every(endingId => {
                        const characterId = endingId.split('-')[0] + '-' + endingId.split('-')[1];
                        return gameState.completedEndings[characterId].includes(endingId);
                    });
                }
            },
            {
                id: "eternal_glory",
                name: "千古流名",
                description: "獲得所有被後世稱頌的結局",
                icon: "🏛️",
                condition: (gameState) => {
                    // 所有被後世稱頌的結局
                    const gloriousEndings = [
                        "cao-mo-end-3",    // 曹沫被稱頌的結局
                        "zhuan-zhu-end-4", // 專諸被稱頌的結局
                        "yu-rang-end-4",   // 豫讓被稱頌的結局
                        "nie-zheng-end-3", // 聶政被稱頌的結局
                        "jing-ke-end-4"    // 荊軻被稱頌的結局
                    ];
                    
                    return gloriousEndings.every(endingId => {
                        const characterId = endingId.split('-')[0] + '-' + endingId.split('-')[1];
                        return gameState.completedEndings[characterId].includes(endingId);
                    });
                }
            },
            {
                id: "hidden_stories",
                name: "史記重寫",
                description: "發現所有隱藏結局",
                icon: "📖",
                condition: (gameState) => {
                    // 檢查是否發現了所有隱藏結局
                    const secretEndings = [];
                    
                    // 搜集所有標記為secret類型的結局
                    Object.entries(characters).forEach(([characterId, character]) => {
                        Object.entries(character.endings).forEach(([endingId, ending]) => {
                            if (ending.type === 'secret') {
                                secretEndings.push({characterId, endingId});
                            }
                        });
                    });
                    
                    // 如果沒有隱藏結局，則此成就不可獲得
                    if (secretEndings.length === 0) return false;
                    
                    // 檢查是否所有隱藏結局都已解鎖
                    return secretEndings.every(({characterId, endingId}) => 
                        gameState.completedEndings[characterId].includes(endingId)
                    );
                }
            },
            {
                id: "time_traveler",
                name: "穿越古今",
                description: "在同一遊戲session中體驗所有角色的故事",
                icon: "⏳",
                condition: (gameState) => {
                    // 檢查是否所有角色都有決策記錄，且這些記錄是在本次session中產生的
                    // (此處簡化為檢查每個角色是否都有決策記錄)
                    return Object.keys(characters).every(characterId => 
                        gameState.decisionsHistory[characterId] && gameState.decisionsHistory[characterId].length > 0
                    );
                }
            },
            {
                id: "assassins_creed",
                name: "刺客信條",
                description: "在一個角色的故事中只選擇最危險的選項",
                icon: "🎯",
                condition: (gameState) => {
                    // 簡化實現：檢查是否在任一角色的故事中獲得了明確需要冒險的結局
                    const riskTakingEndings = [
                        "cao-mo-end-3",    // 曹沫冒險結局
                        "zhuan-zhu-end-4", // 專諸冒險結局
                        "yu-rang-end-4",   // 豫讓冒險結局
                        "nie-zheng-end-3", // 聶政冒險結局
                        "jing-ke-end-4"    // 荊軻冒險結局
                    ];
                    
                    return riskTakingEndings.some(endingId => {
                        const characterId = endingId.split('-')[0] + '-' + endingId.split('-')[1];
                        return gameState.completedEndings[characterId].includes(endingId);
                    });
                }
            }
        ];

        // 時間限制選擇功能
        function addTimedChoice(choicesContainer, choices, timeLimit, defaultChoice) {
            // 檢查是否是第一次遇到時間限制選擇
            if (!gameState.hasSeenTimedChoice) {
                // 顯示教學提示
                showTimedChoiceTutorial();
                // 標記玩家已看過教學
                gameState.hasSeenTimedChoice = true;
            }
            
            // 創建計時器元素
            const timerContainer = document.createElement('div');
            timerContainer.className = 'fixed top-4 right-4 bg-red-500 text-white px-3 py-2 rounded-full font-bold z-50 animate-pulse';
            timerContainer.innerHTML = `<span id="countdown">${timeLimit}</span>秒內決定！`;
            document.body.appendChild(timerContainer);
            
            // 添加選項但添加時間限制樣式
            choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-btn w-full p-4 rounded-lg bg-white dark:bg-gray-700 border border-red-500 dark:border-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200';
                button.textContent = choice.text;
                
                // 為選項添加延遲出現的動畫效果
                button.style.opacity = '0';
                button.style.animation = `fadeIn 0.5s ease-in-out ${0.1 * index}s forwards`;
                
                // 按鈕點擊事件
                button.addEventListener('click', () => {
                    clearInterval(intervalId);
                    document.body.removeChild(timerContainer);
                    makeChoice(choice.next, choice.text);
                });
                
                choicesContainer.appendChild(button);
            });
            
            // 倒計時功能
            let timeRemaining = timeLimit;
            const intervalId = setInterval(() => {
                timeRemaining -= 1;
                document.getElementById('countdown').textContent = timeRemaining;
                
                // 抖動效果增強
                if (timeRemaining <= 3) {
                    timerContainer.classList.add('animate-bounce');
                    timerContainer.style.backgroundColor = '#ef4444';
                }
                
                // 時間到，自動選擇默認選項
                if (timeRemaining <= 0) {
                    clearInterval(intervalId);
                    document.body.removeChild(timerContainer);
                    const defaultIndex = defaultChoice || 0;
                    makeChoice(choices[defaultIndex].next, choices[defaultIndex].text);
                }
            }, 1000);
        }

        // 顯示時間限制教學提示
        function showTimedChoiceTutorial() {
            // 創建教學提示元素
            const tutorialOverlay = document.createElement('div');
            tutorialOverlay.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[999]';
            
            const tutorialBox = document.createElement('div');
            tutorialBox.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md';
            
            tutorialBox.innerHTML = `
                <h3 class="text-xl font-bold text-primary mb-3">危急時刻！</h3>
                <div class="mb-4">
                    <div class="mb-4 text-gray-700 dark:text-gray-300">
                        <p>這是一個需要快速決策的關鍵時刻！</p>
                        <p class="mt-2">你必須在倒計時結束前做出決定，否則將自動選擇第一個選項。</p>
                        <p class="mt-2">時間有限，抉擇關鍵，歷史將因你的選擇而改變！</p>
                    </div>
                    <div class="flex justify-center">
                        <div class="inline-block bg-red-500 text-white px-3 py-2 rounded-full font-bold animate-pulse mt-2">
                            <span class="countdown-urgent">倒計時示例</span>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="close-tutorial" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                        了解，準備行動！
                    </button>
                </div>
            `;
            
            tutorialOverlay.appendChild(tutorialBox);
            document.body.appendChild(tutorialOverlay);
            
            // 關閉按鈕事件
            document.getElementById('close-tutorial').addEventListener('click', () => {
                document.body.removeChild(tutorialOverlay);
            });
        }

        // 更新故事內容
        function updateStoryContent() {
            // 更新進度條
            const totalScenarios = gameState.currentCharacter.scenarios.length;
            const progressPercent = (gameState.progress / totalScenarios) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            
            // 更新場景標題
            document.getElementById('scene-title').textContent = gameState.currentScenario.title;
            
            // 清除可能存在的跳過按鈕
            const existingSkipButton = document.querySelector('.skip-typing');
            if (existingSkipButton) {
                existingSkipButton.remove();
            }
            
            // 實現打字機效果
            const storyText = document.getElementById('story-text');
            storyText.innerHTML = ''; // 清空內容
            storyText.classList.add('typing-effect');
            
            // 添加一個小提示，告訴用戶可以點擊跳過
            const skipHint = document.createElement('div');
            skipHint.className = 'text-xs text-center text-gray-500 dark:text-gray-400 mt-2 animate-pulse';
            skipHint.textContent = '點擊任意位置跳過';
            document.getElementById('story-content').appendChild(skipHint);
            
            // 添加明顯的跳過按鈕
            const skipButton = document.createElement('button');
            skipButton.className = 'skip-typing';
            skipButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                跳過
            `;
            document.getElementById('story-content').appendChild(skipButton);
            
            // 打字機效果的速度 (毫秒/字符) - 調整為更慢的速度
            const typingSpeed = 90;
            const text = gameState.currentScenario.text;
            let index = 0;
            let isComplete = false;
            
            // 確保選項容器在打字機效果結束前隱藏
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.style.display = 'none';
            
            // 跳過按鈕點擊事件處理函數
            const skipTypingHandler = () => {
                if (!isComplete) {
                    clearInterval(typingInterval);
                    storyText.textContent = text;
                    storyText.classList.remove('typing-effect');
                    isComplete = true;
                    
                    // 移除提示
                    if (skipHint.parentNode) {
                        skipHint.parentNode.removeChild(skipHint);
                    }
                    
                    // 移除跳過按鈕
                    if (skipButton.parentNode) {
                        skipButton.parentNode.removeChild(skipButton);
                    }
                    
                    // 移除點擊事件監聽器
                    document.removeEventListener('click', skipTypingHandler);
                    
                    // 恢復選項容器的顯示，添加平滑過渡效果
                    choicesContainer.style.display = '';
                    choicesContainer.classList.add('choices-container-animate');
                    
                    // 動畫結束後移除動畫類，以便下次使用
                    setTimeout(() => {
                        choicesContainer.classList.remove('choices-container-animate');
                    }, 600);
                    
                    // 顯示知識點和選項
                    showKnowledgeAndChoices();
                }
            };
            
            document.addEventListener('click', skipTypingHandler);
            
            // 打字機效果的計時器
            const typingInterval = setInterval(() => {
                if (index < text.length) {
                    storyText.textContent += text.charAt(index);
                    index++;
                    
                    // 滾動到文本底部以確保最新文本可見
                    storyText.scrollTop = storyText.scrollHeight;
                } else {
                    // 打字機效果完成
                    clearInterval(typingInterval);
                    storyText.classList.remove('typing-effect');
                    isComplete = true;
                    
                    // 移除提示
                    if (skipHint.parentNode) {
                        skipHint.parentNode.removeChild(skipHint);
                    }
                    
                    // 移除跳過按鈕
                    if (skipButton.parentNode) {
                        skipButton.parentNode.removeChild(skipButton);
                    }
                    
                    // 移除點擊事件監聽器
                    document.removeEventListener('click', skipTypingHandler);
                    
                    // 恢復選項容器的顯示
                    choicesContainer.style.display = '';
                    
                    // 顯示知識點和選項
                    showKnowledgeAndChoices();
                }
            }, typingSpeed);
            
            // 用於顯示知識點和選項的函數
            function showKnowledgeAndChoices() {
                // 處理知識點的顯示
                const knowledgePoint = document.getElementById('knowledge-point');
                
                // 確保知識點初始狀態
                knowledgePoint.classList.add('hidden');
                knowledgePoint.classList.remove('slide-in-right');
                knowledgePoint.style.opacity = "0";
                knowledgePoint.style.display = "block"; // 恢復顯示屬性，確保元素可見
                
                // 設定更短的閱讀時間，加快節奏
                const readingDelay = 250; // 進一步減少到250ms，讓知識點更快出現
                const knowledgeAnimationDelay = 80; // 縮短知識點動畫準備時間
                const knowledgeToChoicesDelay = 800; // 縮短知識點出現後到選項出現的等待時間
                
                // 先顯示知識點，再顯示選項，製造流暢的序列效果
                if (gameState.currentScenario.knowledge) {
                    // 設置知識點內容
                    document.getElementById('knowledge-content').textContent = gameState.currentScenario.knowledge;
                    
                    // 延遲一點再顯示知識點，讓用戶先閱讀情節
                    setTimeout(() => {
                        // 播放輕微提示音效
                        playSound('click');
                        
                        // 顯示知識點
                        knowledgePoint.classList.remove('hidden');
                        
                        // 觸發動畫
                        setTimeout(() => {
                            knowledgePoint.classList.add('slide-in-right');
                            knowledgePoint.style.opacity = "1";
                            knowledgePoint.style.transition = "opacity 0.6s ease-in-out, transform 0.6s ease-out"; // 增加動畫持續時間和緩動效果
                            
                            // 顯示知識點後再顯示選項，使用較長的延遲創造更好的節奏
                            setTimeout(() => {
                                // 預先準備選項容器的過渡效果
                                const choicesContainer = document.getElementById('choices-container');
                                choicesContainer.style.opacity = '0';
                                choicesContainer.style.transform = 'translateY(10px)';
                                choicesContainer.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                                choicesContainer.style.display = 'block';
                                
                                // 添加短暫延遲以確保過渡效果正確觸發
                                setTimeout(() => {
                                    choicesContainer.style.opacity = '1';
                                    choicesContainer.style.transform = 'translateY(0)';
                                    updateChoices();
                                }, 50);
                            }, knowledgeToChoicesDelay);
                        }, knowledgeAnimationDelay);
                    }, readingDelay);
                } else {
                    // 如果沒有知識點，稍微延遲後顯示選項，讓用戶有時間閱讀故事
                    setTimeout(() => {
                        // 預先準備選項容器的過渡效果
                        const choicesContainer = document.getElementById('choices-container');
                        choicesContainer.style.opacity = '0';
                        choicesContainer.style.transform = 'translateY(10px)';
                        choicesContainer.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                        choicesContainer.style.display = 'block';
                        
                        // 添加短暫延遲以確保過渡效果正確觸發
                        setTimeout(() => {
                            choicesContainer.style.opacity = '1';
                            choicesContainer.style.transform = 'translateY(0)';
                            updateChoices();
                        }, 50);
                    }, readingDelay); // 使用相同的閱讀延遲
                }
            }
            
            // 更新選擇的函數
            function updateChoices() {
                const choicesContainer = document.getElementById('choices-container');
                choicesContainer.innerHTML = '';
                
                if (gameState.currentScenario.choices) {
                    // 檢查是否是需要時間限制的關鍵場景
                    const characterName = gameState.currentCharacter.name;
                    const scenarioId = gameState.currentScenario.id;
                    
                    const isTimedScene = 
                        (characterName === "曹沫" && scenarioId === "cao-mo-2b") ||
                        (characterName === "專諸" && scenarioId === "zhuan-zhu-3a") ||
                        (characterName === "豫讓" && scenarioId === "yu-rang-5a") ||
                        (characterName === "聶政" && scenarioId === "nie-zheng-7a") ||
                        (characterName === "荊軻" && scenarioId === "jing-ke-7a");
                        
                    if (isTimedScene) {
                        // 播放緊急決策音效
                        playSound('urgentDecision');
                        
                        // 時間限制根據場景不同而變化
                        let timeLimit = 10; // 默認10秒
                        if (characterName === "曹沫") timeLimit = 15;
                        if (characterName === "豫讓") timeLimit = 8;
                        if (characterName === "聶政") timeLimit = 12;
                        
                        // 添加時間限制選擇
                        addTimedChoice(choicesContainer, gameState.currentScenario.choices, timeLimit, 0);
                        
                        // 解鎖當機立斷成就
                        if (!gameState.unlockedAchievements.includes("speedy_decision")) {
                            gameState.hasSeenTimedChoice = true;
                            checkAchievements();
                        }
                    } else {
                        // 原有的選擇渲染代碼，添加更好的動畫效果
                        gameState.currentScenario.choices.forEach((choice, index) => {
                            const button = document.createElement('button');
                            button.className = 'choice-btn w-full p-4 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200';
                            button.textContent = choice.text;
                            
                            // 優化選項動畫效果，移除延遲讓選項同時出現
                            button.style.opacity = '0';
                            button.style.transform = 'translateY(10px)';
                            button.style.animation = `fadeIn 0.4s ease-out forwards`;
                            // 添加自定義過渡效果
                            button.style.transition = 'transform 0.25s ease-out, opacity 0.25s ease-out, box-shadow 0.25s ease, background-color 0.25s ease';
                            
                            button.addEventListener('click', () => makeChoice(choice.next, choice.text));
                            
                            // 添加選擇提示 (如果存在並且提示系統開啟)
                            if (choice.hint && gameState.showChoiceHints) {
                                const hintDiv = document.createElement('div');
                                hintDiv.className = `choice-hint hint-${choice.hint.type}`;
                                hintDiv.title = choice.hint.text;
                                hintDiv.textContent = '?';
                                button.style.position = 'relative';
                                button.appendChild(hintDiv);
                            }
                            
                            choicesContainer.appendChild(button);
                        });
                    }
                }
            }
        }
        
        // 切換選項提示功能
        function toggleChoiceHints() {
            // 切換功能開關狀態
            gameState.showChoiceHints = !gameState.showChoiceHints;
            
            // 更新開關視覺效果
            const toggleCheckbox = document.getElementById('hints-toggle');
            if (toggleCheckbox) {
                toggleCheckbox.checked = gameState.showChoiceHints;
            }
            
            // 如果當前有選項顯示，則重新渲染選項以更新提示
            if (gameState.currentScenario && gameState.currentScenario.choices) {
                const choicesContainer = document.getElementById('choices-container');
                if (choicesContainer) {
                    // 清空目前選項
                    choicesContainer.innerHTML = '';
                    
                    // 重新渲染選項及提示
                    gameState.currentScenario.choices.forEach((choice, index) => {
                        const button = document.createElement('button');
                        button.className = 'choice-btn w-full p-4 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200';
                        button.textContent = choice.text;
                        
                        button.style.opacity = '0';
                        button.style.animation = `fadeIn 0.4s ease-out forwards`;
                        button.style.transition = 'transform 0.25s ease-out, opacity 0.25s ease-out, box-shadow 0.25s ease, background-color 0.25s ease';
                        
                        button.addEventListener('click', () => makeChoice(choice.next, choice.text));
                        
                        // 添加選擇提示 (如果存在並且提示系統開啟)
                        if (choice.hint && gameState.showChoiceHints) {
                            const hintDiv = document.createElement('div');
                            hintDiv.className = `choice-hint hint-${choice.hint.type}`;
                            hintDiv.title = choice.hint.text;
                            hintDiv.textContent = '?';
                            button.style.position = 'relative';
                            button.appendChild(hintDiv);
                        }
                        
                        choicesContainer.appendChild(button);
                    });
                }
            }
            
            // 播放音效
            playSound('click');
        }

        // 初始化遊戲
        function initGame() {
            // 計算每個角色的總結局數
            updateEndingCounts();
            
            // 初始化成就系統
            initAchievements();
            
            // 初始化結局收集庫
            initEndingsCollection();
            
            // 更新總進度條
            updateTotalProgress();
            
            // 初始化首頁成就快覽
            initHomeAchievements();
            
            // 更新角色卡片解鎖狀態
            updateCharacterCards();
            
            // 綁定選項提示開關事件
            document.getElementById('hints-toggle').addEventListener('click', toggleChoiceHints);
            
            // 為菜單按鈕添加事件監聽器
            document.getElementById('show-achievements').addEventListener('click', () => {
                document.getElementById('achievements-modal').classList.remove('hidden');
                updateAchievementProgress(); // 更新成就進度
            });
            
            document.getElementById('show-endings-collection').addEventListener('click', () => {
                document.getElementById('endings-collection-modal').classList.remove('hidden');
                updateEndingsCollection(); // 更新結局收集庫內容
            });
            
            // 為結局收集庫關閉按鈕添加更完善的邏輯
            document.getElementById('close-endings-collection').addEventListener('click', () => {
                // 隱藏結局收集庫
                document.getElementById('endings-collection-modal').classList.add('hidden');
                
                // 判斷應該顯示哪個界面
                if (document.getElementById('ending-screen').classList.contains('hidden') === false) {
                    // 如果是從結局頁面打開的結局收集庫，則返回結局頁面
                    document.getElementById('ending-screen').classList.remove('hidden');
                } else if (document.getElementById('story-content').classList.contains('hidden') === false) {
                    // 如果是從故事內容頁面打開的結局收集庫，則返回故事內容頁面
                    document.getElementById('story-content').classList.remove('hidden');
                } else {
                    // 否則，返回首頁
                    document.getElementById('character-selection').classList.remove('hidden');
                    document.getElementById('game-introduction').classList.remove('hidden');
                    
                    // 重新觸發淡入動畫
                    const selection = document.getElementById('character-selection');
                    selection.classList.remove('fade-in');
                    void selection.offsetWidth;
                    selection.classList.add('fade-in');
                    
                    console.log('從結局收集庫返回首頁');
                }
            });
            
            // 為結局標籤添加事件監聽器
            document.querySelectorAll('#endings-tabs a').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 移除所有標籤的活動狀態
                    document.querySelectorAll('#endings-tabs a').forEach(t => {
                        t.classList.remove('border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'hover:border-gray-300');
                    });
                    
                    // 添加當前標籤的活動狀態
                    e.target.classList.add('border-primary', 'text-primary');
                    e.target.classList.remove('border-transparent', 'hover:border-gray-300');
                    
                    // 更新結局展示
                    updateEndingsCollection(e.target.getAttribute('data-character'));
                });
            });
            
            // 保留關閉決策樹彈窗的事件監聽器
            document.getElementById('close-decision-tree').addEventListener('click', () => {
                document.getElementById('decision-tree-modal').classList.add('hidden');
            });
            
            // 確保初始化時不會嘗試引用已被移除的元素
            
            // 為結束屏幕上的查看結局按鈕添加事件監聽器
            document.getElementById('view-endings-button').addEventListener('click', () => {
                document.getElementById('ending-screen').classList.add('hidden');
                document.getElementById('endings-collection-modal').classList.remove('hidden');
                
                // 更新結局庫並自動選擇當前角色的標籤
                const characterId = Object.keys(characters).find(key => characters[key] === gameState.currentCharacter);
                
                // 設置對應標籤為活動狀態
                document.querySelectorAll('#endings-tabs a').forEach(tab => {
                    if (tab.getAttribute('data-character') === characterId) {
                        tab.classList.add('border-primary', 'text-primary');
                        tab.classList.remove('border-transparent', 'hover:border-gray-300');
                    } else {
                        tab.classList.remove('border-primary', 'text-primary');
                        tab.classList.add('border-transparent', 'hover:border-gray-300');
                    }
                });
                
                updateEndingsCollection(characterId);
            });
            
            // 關閉成就模態視窗的事件監聽器
            document.getElementById('close-achievements').addEventListener('click', () => {
                document.getElementById('achievements-modal').classList.add('hidden');
            });
        }
        
        // 初始化首頁成就快覽
        function initHomeAchievements() {
            const achievementsContainer = document.getElementById('home-achievements-grid');
            achievementsContainer.innerHTML = ''; // 清空容器
            
            // 計算成就總數和解鎖數量
            const totalAchievements = achievements.length;
            const unlockedCount = gameState.unlockedAchievements.length;
            
            // 更新首頁成就計數
            document.getElementById('home-achievements-unlocked').textContent = unlockedCount;
            document.getElementById('home-total-achievements').textContent = totalAchievements;
            
            // 更新進度條
            const percent = totalAchievements > 0 ? Math.round((unlockedCount / totalAchievements) * 100) : 0;
            document.getElementById('home-achievement-progress-bar').style.width = `${percent}%`;
            
            // 創建主要成就徽章
            const mainAchievements = [
                "first_ending", 
                "master_assassin",
                "good_endings", 
                "secret_path_explorer",
                "completionist"
            ];
            
            // 優先顯示的前5個成就
            mainAchievements.forEach(achievementId => {
                const achievement = achievements.find(a => a.id === achievementId);
                if (!achievement) return;
                
                const isUnlocked = gameState.unlockedAchievements.includes(achievementId);
                
                const badgeElement = document.createElement('div');
                badgeElement.className = `home-achievement-badge ${isUnlocked ? 'unlocked' : 'locked'}`;
                badgeElement.innerHTML = `
                    ${achievement.icon}
                    <div class="home-achievement-tooltip">${achievement.name}</div>
                `;
                
                // 點擊查看成就詳情
                badgeElement.addEventListener('click', () => {
                    document.getElementById('achievements-modal').classList.remove('hidden');
                    updateAchievementProgress();
                });
                
                achievementsContainer.appendChild(badgeElement);
            });
        }
        
        // 刺客精神定義
        const assassinSpirits = {
            "cao-mo": {
                name: "義膽精神",
                description: "面對強敵不畏懼，敢於為弱國爭取尊嚴",
                unlockRequirement: "cao-mo-end-3", // 威震齊王結局
                icon: "🛡️"
            },
            "zhuan-zhu": {
                name: "隱忍精神",
                description: "等待時機，不動聲色，一擊必中",
                unlockRequirement: "zhuan-zhu-end-4", // 魚藏匕首結局
                icon: "🐟"
            },
            "yu-rang": {
                name: "知遇精神",
                description: "為知己者死，報恩不計生死",
                unlockRequirement: "yu-rang-end-4", // 擊衣伏劍結局
                icon: "👑"
            },
            "nie-zheng": {
                name: "兩全精神",
                description: "平衡孝與義，為母盡孝後義不容辭",
                unlockRequirement: "nie-zheng-end-3", // 毀貌報恩結局
                icon: "👁️"
            },
            "jing-ke": {
                name: "壯烈精神",
                description: "明知不歸路，仍勇往直前",
                unlockRequirement: "jing-ke-end-4", // 壯士不還結局
                icon: "🎵"
            }
        };

        // 顯示決策樹
        function showDecisionTree() {
            const modal = document.getElementById('decision-tree-modal');
            const container = document.getElementById('decision-tree-container');
            container.innerHTML = '';
            
            if (!gameState.currentCharacter || !gameState.currentCharacter.keyDecisions) return;
            
            gameState.currentCharacter.keyDecisions.forEach(decision => {
                const decisionNode = document.createElement('div');
                decisionNode.className = 'p-4 border border-gray-300 dark:border-gray-600 rounded-lg';
                
                const title = document.createElement('h4');
                title.className = 'font-bold text-primary mb-2';
                title.textContent = decision.title;
                
                const description = document.createElement('p');
                description.className = 'text-sm text-gray-600 dark:text-gray-400 mb-3';
                description.textContent = decision.description;
                
                const choicesList = document.createElement('div');
                choicesList.className = 'space-y-2';
                
                decision.choices.forEach(choice => {
                    const choiceItem = document.createElement('div');
                    choiceItem.className = 'flex items-center justify-between p-2 border border-gray-200 dark:border-gray-700 rounded';
                    
                    const choiceText = document.createElement('span');
                    choiceText.textContent = choice.text;
                    
                    const outcomeText = document.createElement('span');
                    outcomeText.className = 'text-sm text-gray-500 dark:text-gray-400';
                    outcomeText.textContent = choice.outcome;
                    
                    choiceItem.appendChild(choiceText);
                    choiceItem.appendChild(outcomeText);
                    choicesList.appendChild(choiceItem);
                });
                
                decisionNode.appendChild(title);
                decisionNode.appendChild(description);
                decisionNode.appendChild(choicesList);
                container.appendChild(decisionNode);
            });
            
            modal.classList.remove('hidden');
        }
        
        // 檢查刺客精神解鎖條件
        function checkSpiritUnlock(characterId, endingId) {
            const spirit = assassinSpirits[characterId];
            
            // 如果達成解鎖條件且尚未獲得該精神
            if (spirit && spirit.unlockRequirement === endingId && 
                !gameState.acquiredSpirits.includes(characterId)) {
                
                // 獲得刺客精神
                gameState.acquiredSpirits.push(characterId);
                
                // 解鎖下一位刺客
                const characterOrder = ["cao-mo", "zhuan-zhu", "yu-rang", "nie-zheng", "jing-ke"];
                const currentIndex = characterOrder.indexOf(characterId);
                
                if (currentIndex < characterOrder.length - 1) {
                    const nextCharacter = characterOrder[currentIndex + 1];
                    if (!gameState.unlockedCharacters.includes(nextCharacter)) {
                        gameState.unlockedCharacters.push(nextCharacter);
                        showCharacterUnlockNotification(nextCharacter);
                    }
                }
                
                // 顯示獲得精神通知
                showSpiritAcquiredNotification(characterId);
                
                // 更新角色卡片顯示
                updateCharacterCards();
            }
        }
        
        // 顯示角色解鎖通知
        function showCharacterUnlockNotification(characterId) {
            // 使用通知隊列系統顯示角色解鎖通知
            const metaContent = `${characters[characterId].era} - ${characters[characterId].description}`;
            notificationQueue.add('character-unlock', characters[characterId].name, metaContent);
        }
        
        // 顯示刺客精神獲得通知
        function showSpiritAcquiredNotification(characterId) {
            const spirit = assassinSpirits[characterId];
            
            // 使用通知隊列系統顯示刺客精神獲得通知
            notificationQueue.add('spirit-acquired', spirit.name, spirit.description, spirit.icon);
        }
        
        // 顯示刺客精神解鎖提示（氣泡方式）
        function showSpiritUnlockHint(characterId) {
            // 檢查是否已有氣泡，如果有則移除
            const existingBubble = document.getElementById('spirit-hint-bubble');
            if (existingBubble) {
                document.body.removeChild(existingBubble);
                return;
            }
            
            // 獲取觸發元素位置（解鎖精神徽章）
            const targetElement = event.currentTarget;
            const targetRect = targetElement.getBoundingClientRect();
            
            // 獲取相關資訊
            const spirit = assassinSpirits[characterId];
            const requiredEndingId = spirit.unlockRequirement;
            const requiredEnding = characters[characterId].endings[requiredEndingId];
            
            // 創建氣泡提示
            const hintBubble = document.createElement('div');
            hintBubble.id = 'spirit-hint-bubble';
            
            // 設置氣泡樣式並定位在觸發元素附近
            // 為移動設備適配，使用絕對定位並基於視窗大小調整位置
            const isSmallScreen = window.innerWidth < 640;
            
            hintBubble.className = 'fixed z-50 bg-white dark:bg-gray-800 rounded-lg shadow-xl p-4 max-w-xs transition-opacity duration-200';
            hintBubble.style.opacity = '0';
            
            // 根據螢幕大小設定不同的定位
            if (isSmallScreen) {
                // 移動設備上居中顯示
                hintBubble.style.left = '50%';
                hintBubble.style.top = '50%';
                hintBubble.style.transform = 'translate(-50%, -50%)';
                hintBubble.classList.add('w-4/5');
            } else {
                // 桌面版本，顯示在觸發元素附近
                // 計算氣泡位置，避免超出視窗邊界
                let bubbleLeft = targetRect.left + targetRect.width / 2;
                // 確保氣泡不會超出右側邊界
                bubbleLeft = Math.min(bubbleLeft, window.innerWidth - 320);
                // 確保氣泡不會超出左側邊界
                bubbleLeft = Math.max(bubbleLeft, 160);
                
                hintBubble.style.left = `${bubbleLeft}px`;
                hintBubble.style.top = `${targetRect.bottom + 10}px`;
                // 添加小三角形指示箭頭
                hintBubble.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
            }
            
            // 氣泡內容 - 使用簡潔的文字鼓勵玩家研究《史記》原文
            hintBubble.innerHTML = `
                <div class="flex items-start">
                    <div class="text-2xl mr-3 mt-1">${spirit.icon}</div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-primary mb-1">解鎖${spirit.name}</h3>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">
                            按照《史記·刺客列傳》中<span class="font-bold">${characters[characterId].name}</span>的原始故事線走，達成「${requiredEnding.name}」結局。
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            研究歷史原文，重現刺客精神
                        </p>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 self-start ml-1" id="close-spirit-bubble">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                ${!isSmallScreen ? `
                <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-b-8 border-l-transparent border-r-transparent border-b-white dark:border-b-gray-800"></div>
                ` : ''}
            `;
            
            document.body.appendChild(hintBubble);
            
            // 淡入動畫
            setTimeout(() => {
                hintBubble.style.opacity = '1';
            }, 10);
            
            // 關閉按鈕事件
            document.getElementById('close-spirit-bubble').addEventListener('click', (e) => {
                e.stopPropagation();
                hintBubble.style.opacity = '0';
                setTimeout(() => {
                    if (hintBubble.parentNode) {
                        document.body.removeChild(hintBubble);
                    }
                }, 200);
            });
            
            // 點擊其他地方關閉氣泡
            document.addEventListener('click', function closeHintOnClickOutside(e) {
                if (hintBubble.parentNode && !hintBubble.contains(e.target) && e.target !== targetElement) {
                    hintBubble.style.opacity = '0';
                    setTimeout(() => {
                        if (hintBubble.parentNode) {
                            document.body.removeChild(hintBubble);
                        }
                    }, 200);
                    document.removeEventListener('click', closeHintOnClickOutside);
                }
            });
            
            // 自動關閉計時器 (8秒)
            setTimeout(() => {
                if (hintBubble.parentNode) {
                    hintBubble.style.opacity = '0';
                    setTimeout(() => {
                        if (hintBubble.parentNode) {
                            document.body.removeChild(hintBubble);
                        }
                    }, 200);
                }
            }, 8000);
        }
        
        // 更新角色卡片顯示
        function updateCharacterCards() {
            document.querySelectorAll('.character-card').forEach(card => {
                const characterId = card.getAttribute('data-character');
                
                // 更新解鎖狀態
                if (gameState.unlockedCharacters.includes(characterId)) {
                    card.classList.remove('opacity-70', 'locked-character');
                    card.classList.add('cursor-pointer', 'hover:shadow-xl', 'transform', 'transition-all', 'hover:-translate-y-1');
                    
                    // 移除鎖定標誌（如果存在）
                    let lockIcon = card.querySelector('.lock-icon');
                    if (lockIcon) {
                        card.removeChild(lockIcon);
                    }
                    
                    // 啟用點擊事件
                    card.onclick = () => {
                        playSound('click');
                        card.classList.add('bounce-effect');
                        setTimeout(() => {
                            startCharacterStory(characterId);
                            card.classList.remove('bounce-effect');
                        }, 300);
                    };
                    
                    // 處理刺客精神徽章
                    // 找到描述部分，用於插入徽章
                    const descriptionDiv = card.querySelector('.py-2');
                    
                    // 移除所有可能存在的精神徽章（已解鎖或未解鎖）
                    const existingSpiritBadge = card.querySelector('.spirit-badge');
                    if (existingSpiritBadge) {
                        existingSpiritBadge.remove();
                    }
                    
                    const existingUnlockedBadge = card.querySelector('.unlocked-spirit-badge');
                    if (existingUnlockedBadge) {
                        existingUnlockedBadge.remove();
                    }
                    
                    // 如果已獲得該角色的刺客精神，顯示精神徽章
                    if (gameState.acquiredSpirits.includes(characterId)) {
                        // 創建精神徽章 - 確保放在描述之前並置於中間
                        const spiritBadge = document.createElement('div');
                        spiritBadge.className = 'spirit-badge px-3 py-1 bg-primary/20 text-primary rounded-full text-xs flex items-center justify-center mt-2 mx-auto w-fit';
                        spiritBadge.innerHTML = `
                            <span class="mr-1">${assassinSpirits[characterId].icon}</span>
                            <span id="character-spirit">${assassinSpirits[characterId].name}</span>
                        `;
                        
                        // 插入徽章到描述之前
                        if (descriptionDiv) {
                            descriptionDiv.parentNode.insertBefore(spiritBadge, descriptionDiv);
                        } else {
                            card.appendChild(spiritBadge);
                        }
                        
                        // 確保徽章位置正確
                        spiritBadge.style.position = 'relative';
                        spiritBadge.style.top = 'auto';
                        spiritBadge.style.right = 'auto';
                    } 
                    // 顯示未解鎖的刺客精神提示
                    else if (gameState.unlockedCharacters.includes(characterId) && characterId in assassinSpirits) {
                        // 檢查是否已有未解鎖徽章
                        let unlockedSpiritBadge = card.querySelector('.unlocked-spirit-badge');
                        if (!unlockedSpiritBadge) {
                            // 創建未解鎖精神徽章
                            unlockedSpiritBadge = document.createElement('div');
                            unlockedSpiritBadge.className = 'unlocked-spirit-badge px-3 py-1 bg-gray-300/30 dark:bg-gray-700/30 text-gray-500 dark:text-gray-400 rounded-full text-xs flex items-center justify-center mt-2 mx-auto w-fit cursor-pointer transition-all hover:bg-gray-300/50 dark:hover:bg-gray-700/50';
                            unlockedSpiritBadge.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                                <span>解鎖刺客精神</span>
                            `;
                            
                            // 插入徽章到描述之前
                            if (descriptionDiv) {
                                descriptionDiv.parentNode.insertBefore(unlockedSpiritBadge, descriptionDiv);
                            } else {
                                card.appendChild(unlockedSpiritBadge);
                            }
                            
                            // 確保徽章位置正確
                            unlockedSpiritBadge.style.position = 'relative';
                            unlockedSpiritBadge.style.top = 'auto';
                            unlockedSpiritBadge.style.right = 'auto';
                            
                            // 添加點擊事件，顯示如何解鎖的提示
                            unlockedSpiritBadge.addEventListener('click', (e) => {
                                e.stopPropagation(); // 防止觸發角色卡點擊事件
                                showSpiritUnlockHint(characterId);
                                playSound('click');
                            });
                        }
                    }
                } else {
                    // 鎖定的角色卡片
                    card.classList.add('opacity-70', 'locked-character');
                    card.classList.remove('cursor-pointer', 'hover:shadow-xl', 'transform', 'transition-all', 'hover:-translate-y-1');
                    
                    // 添加鎖定標誌
                    let lockIcon = card.querySelector('.lock-icon');
                    if (!lockIcon) {
                        lockIcon = document.createElement('div');
                        lockIcon.className = 'lock-icon absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-lg';
                        lockIcon.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        `;
                        card.appendChild(lockIcon);
                    }
                    
                    // 添加鎖定角色點擊提示
                    card.onclick = () => {
                        showUnlockHint(characterId);
                        playSound('click');
                    };
                }
            });
        }
        
        // 初始化成就系統
        function initAchievements() {
            const container = document.getElementById('achievements-container');
            container.innerHTML = '';
            
            // 更新成就進度條
            updateAchievementProgress();
            
            // 特殊成就ID列表
            const specialAchievements = [
                "secret_path_explorer", "hidden_stories", "speedy_decision", 
                "time_traveler", "fate_controller", "clothes_striker", 
                "wind_blows_cold", "beyond_death", "eternal_glory", "assassins_creed"
            ];
            
            // 一次性展示所有成就，沒有分類
            achievements.forEach(achievement => {
                const isUnlocked = gameState.unlockedAchievements.includes(achievement.id);
                const isSpecial = specialAchievements.includes(achievement.id);
                
                const achievementElem = document.createElement('div');
                achievementElem.className = `achievement p-2 rounded-lg border ${isUnlocked ? 'border-primary bg-primary/10' : 'border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-800/50'} ${isUnlocked ? '' : 'locked'} flex flex-col h-full relative`;
                
                // 特殊成就標記
                let specialBadge = '';
                if (isSpecial) {
                    specialBadge = `<div class="absolute -top-1 -right-1 bg-purple-500 text-white text-xs font-bold px-2 py-0.5 rounded-lg shadow-md animate-pulse transform rotate-12">稀有</div>`;
                }
                
                achievementElem.innerHTML = `
                    ${specialBadge}
                    <div class="flex items-center">
                        <div class="text-2xl mr-2 flex-shrink-0">${achievement.icon}</div>
                        <div class="flex-grow min-w-0">
                            <div class="font-bold text-sm truncate ${isSpecial ? 'text-purple-600 dark:text-purple-400' : ''}">${achievement.name}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">${achievement.description}</div>
                        </div>
                    </div>
                    <div class="mt-auto pt-1 text-right">
                        <span class="text-xs px-2 py-0.5 rounded-full ${isUnlocked ? 'bg-green-500 text-white' : isSpecial ? 'bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 border border-purple-300 dark:border-purple-700' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}">${isUnlocked ? '已解鎖' : '未解鎖'}</span>
                    </div>
                `;
                
                container.appendChild(achievementElem);
            });
        }
        
        // 更新成就進度
        function updateAchievementProgress() {
            const totalAchievements = achievements.length;
            const unlockedCount = gameState.unlockedAchievements.length;
            const percent = totalAchievements > 0 ? Math.round((unlockedCount / totalAchievements) * 100) : 0;
            
            document.getElementById('achievement-progress-percent').textContent = `${percent}%`;
            document.getElementById('achievement-progress-bar').style.width = `${percent}%`;
            document.getElementById('achievements-unlocked').textContent = unlockedCount;
            document.getElementById('total-achievements').textContent = totalAchievements;
            
            // 同時更新首頁成就進度
            document.getElementById('home-achievements-unlocked').textContent = unlockedCount;
            document.getElementById('home-total-achievements').textContent = totalAchievements;
            document.getElementById('home-achievement-progress-bar').style.width = `${percent}%`;
            
            // 更新首頁的成就徽章
            initHomeAchievements();
        }
        
        // 初始化結局收集庫
        function initEndingsCollection() {
            // 默認顯示第一個角色的結局
            updateEndingsCollection('cao-mo');
        }
        
        // 更新結局收集庫
        function updateEndingsCollection(characterId = 'cao-mo') {
            const container = document.getElementById('endings-container');
            container.innerHTML = '';
            
            const character = characters[characterId];
            const endings = character.endings;
            const unlockedEndings = gameState.completedEndings[characterId];
            
            Object.entries(endings).forEach(([endingId, ending]) => {
                const isUnlocked = unlockedEndings.includes(endingId);
                const endingCard = document.createElement('div');
                endingCard.className = `ending-card p-3 rounded-lg ${isUnlocked ? 'bg-white dark:bg-gray-800' : 'bg-gray-100 dark:bg-gray-700 locked'} border border-gray-200 dark:border-gray-600 relative flex items-center justify-center flex-col`;
                
                // 結局內容
                if (isUnlocked) {
                    // 決定圖標
                    let icon = '';
                    switch(ending.type) {
                        case 'good':
                            icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>';
                            break;
                        case 'bad':
                            icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>';
                            break;
                        case 'secret':
                            icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>';
                            break;
                        default:
                            icon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>';
                    }
                    
                    // 添加結局類型徽章和名稱
                    let badgeClass = '';
                    switch(ending.type) {
                        case 'good': badgeClass = 'ending-type-good'; break;
                        case 'bad': badgeClass = 'ending-type-bad'; break;
                        case 'secret': badgeClass = 'ending-type-secret'; break;
                        default: badgeClass = 'ending-type-neutral';
                    }
                    
                    endingCard.innerHTML = `
                        <div class="ending-type-badge ${badgeClass} text-xs">${ending.type === 'good' ? '正面' : ending.type === 'bad' ? '負面' : ending.type === 'secret' ? '隱藏' : '中立'}</div>
                        ${icon}
                        <h3 class="text-sm font-bold text-center mb-1">${ending.name || '隱藏結局'}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center line-clamp-2">${ending.text.substring(0, 30)}...</p>
                    `;
                    
                    // 添加點擊事件
                    endingCard.addEventListener('click', () => {
                        showFullEnding(character, endingId, ending);
                    });
                    endingCard.classList.add('cursor-pointer', 'hover:border-primary');
                } else {
                    endingCard.innerHTML = `
                        <div class="text-center py-3">
                            <div class="ending-lock">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <h3 class="text-sm font-bold mt-2 mb-1">未解鎖</h3>
                        </div>
                    `;
                }
                
                container.appendChild(endingCard);
            });
        }
        
        // 顯示完整結局
        function showFullEnding(character, endingId, ending) {
            const modal = document.getElementById('endings-collection-modal');
            modal.classList.add('hidden');
            
            // 設置游戲的當前角色並顯示結局頁面
            gameState.currentCharacter = character;
            document.getElementById('ending-screen').classList.remove('hidden');
            
            // 更新結局內容
            document.getElementById('ending-text').textContent = ending.text;
            document.getElementById('historical-comment').textContent = ending.comment;
            
            // 更新結局類型徽章
            const badgeElem = document.getElementById('ending-type-badge');
            let badgeClass = '';
            
            switch(ending.type) {
                case 'good':
                    badgeClass = 'bg-green-500';
                    break;
                case 'bad':
                    badgeClass = 'bg-red-500';
                    break;
                case 'secret':
                    badgeClass = 'bg-purple-500';
                    break;
                default:
                    badgeClass = 'bg-gray-500';
            }
            
            badgeElem.className = `inline-block px-2 py-1 text-xs text-white rounded-full mb-4 ${badgeClass}`;
            badgeElem.textContent = ending.name || '隱藏結局';
            
            // 更新結局收集進度
            updateEndingCollectionProgress(character.name);
        }
        
        // 檢查成就
        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!gameState.unlockedAchievements.includes(achievement.id) && achievement.condition(gameState)) {
                    unlockAchievement(achievement);
                }
            });
        }
        
        // 通知隊列系統
        const notificationQueue = {
            queue: [],
            isProcessing: false,
            
            // 添加通知到隊列
            add(type, content, metaContent = '', icon = '') {
                // 創建通知對象
                const notification = { type, content, metaContent, icon };
                
                // 添加到隊列
                this.queue.push(notification);
                
                // 如果目前沒有正在顯示的通知，開始處理隊列
                if (!this.isProcessing) {
                    this.processQueue();
                }
            },
            
            // 處理隊列
            processQueue() {
                if (this.queue.length === 0) {
                    this.isProcessing = false;
                    return;
                }
                
                this.isProcessing = true;
                
                // 獲取隊列中的第一個通知
                const notification = this.queue.shift();
                
                // 顯示該通知
                this.showNotification(notification, () => {
                    // 通知結束後，繼續處理隊列中的下一個通知
                    setTimeout(() => {
                        this.processQueue();
                    }, 300); // 兩個通知之間的間隔時間
                });
            },
            
            // 顯示指定通知
            showNotification(notification, callback) {
                // 獲取模板容器
                const templatesContainer = document.getElementById('notification-templates');
                
                if (!templatesContainer) {
                    console.error(`通知模板容器 'notification-templates' 不存在`);
                    callback();
                    return;
                }
                
                // 從模板容器中獲取特定模板
                const templateId = `${notification.type}-template`;
                const template = templatesContainer.content.querySelector(`#${templateId}`);
                
                if (!template) {
                    console.error(`通知模板 ${templateId} 不存在`);
                    callback();
                    return;
                }
                
                // 複製模板創建新通知元素
                const notificationElement = template.cloneNode(true);
                notificationElement.id = `notification-${Date.now()}`;
                
                // 設置通知內容
                const contentElement = notificationElement.querySelector('.notification-content');
                if (contentElement) {
                    contentElement.textContent = notification.content;
                }
                
                // 設置元數據內容（如有）
                const metaElement = notificationElement.querySelector('.notification-meta');
                if (metaElement && notification.metaContent) {
                    metaElement.textContent = notification.metaContent;
                }
                
                // 設置圖標（如有）
                const iconElement = notificationElement.querySelector('.notification-icon');
                if (iconElement && notification.icon) {
                    iconElement.textContent = notification.icon;
                }
                
                // 將通知添加到容器
                const container = document.getElementById('notifications-container');
                container.appendChild(notificationElement);
                
                // 播放適當的音效
                switch (notification.type) {
                    case 'achievement-popup':
                        playSound('achievementUnlock');
                        break;
                    case 'ending-unlock-popup':
                        playSound('endingUnlock');
                        break;
                    case 'character-unlock-popup':
                    case 'spirit-acquired-popup':
                        playSound('achievementUnlock');
                        break;
                }
                
                // 顯示通知（延遲一點以確保 DOM 更新）
                setTimeout(() => {
                    notificationElement.style.transform = 'translateY(0)';
                    notificationElement.style.opacity = '1';
                    
                    // 設置通知自動消失的計時器（1秒後）
                    setTimeout(() => {
                        // 隱藏通知
                        notificationElement.style.transform = 'translateY(12px)';
                        notificationElement.style.opacity = '0';
                        
                        // 移除元素
                        setTimeout(() => {
                            if (notificationElement.parentNode) {
                                container.removeChild(notificationElement);
                            }
                            callback();
                        }, 500); // 透明度過渡完成後移除元素
                    }, 1000);
                }, 10);
            }
        };
        
        // 解鎖成就
        function unlockAchievement(achievement) {
            gameState.unlockedAchievements.push(achievement.id);
            
            // 更新UI
            initAchievements();
            
            // 更新首頁成就快覽
            initHomeAchievements();
            
            // 使用通知隊列顯示成就通知
            notificationQueue.add('achievement', achievement.name);
        }

        // 不需要在這裡設置點擊事件，由updateCharacterCards函數處理
        // 為每個角色卡片設置點擊事件在updateCharacterCards函數中完成

        // 開始角色的故事
        function startCharacterStory(characterId) {
            // 隱藏角色選擇和遊戲介紹，顯示故事內容
            document.getElementById('character-selection').classList.add('hidden');
            document.getElementById('game-introduction').classList.add('hidden');
            document.getElementById('story-content').classList.remove('hidden');
            document.getElementById('ending-screen').classList.add('hidden');
            
            // 獲取當前角色數據
            gameState.currentCharacter = characters[characterId];
            
            // 更新角色信息顯示
            document.getElementById('character-name').textContent = gameState.currentCharacter.name;
            document.getElementById('character-era').textContent = gameState.currentCharacter.era;
            
            // 重置遊戲進度
            gameState.progress = 0;
            gameState.currentScenario = gameState.currentCharacter.scenarios[0];
            
            // 清空決策歷史 (針對此角色)
            if (!gameState.decisionsHistory[characterId]) {
                gameState.decisionsHistory[characterId] = [];
            }
            
            // 更新故事內容
            updateStoryContent();
        }

        // 做出選擇
        function makeChoice(nextId, choiceText) {
            // 播放選擇音效
            playSound('selectOption');
            
            // 記錄決策
            const characterId = Object.keys(characters).find(key => characters[key] === gameState.currentCharacter);
            if (!gameState.decisionsHistory[characterId]) {
                gameState.decisionsHistory[characterId] = [];
            }
            gameState.decisionsHistory[characterId].push(choiceText);
            
            // 檢查特殊結局條件
            checkSpecialEndingConditions(characterId, nextId, choiceText);
            
            // 立即隱藏知識點和選項，確保在場景轉換時不會顯示上一個場景的元素
            const knowledgePoint = document.getElementById('knowledge-point');
            if (knowledgePoint) {
                knowledgePoint.classList.add('hidden');
                knowledgePoint.classList.remove('slide-in-right');
                knowledgePoint.style.opacity = "0";
                knowledgePoint.style.display = "none"; // 強制隱藏
            }
            
            // 立即清空選項容器，防止舊選項殘留
            const choicesContainer = document.getElementById('choices-container');
            if (choicesContainer) {
                choicesContainer.innerHTML = ''; 
                choicesContainer.style.display = 'none'; // 暫時隱藏選項容器
                
                // 確保清除任何可能的定時器
                if (window.choiceDisplayTimer) {
                    clearTimeout(window.choiceDisplayTimer);
                }
            }
            
            // 檢查是否是結局
            if (nextId.includes('end')) {
                showEnding(nextId);
                return;
            }
            
            // 查找下一個場景
            const nextScenario = gameState.currentCharacter.scenarios.find(s => s.id === nextId);
            if (nextScenario) {
                gameState.currentScenario = nextScenario;
                gameState.progress++;
                
                // 添加轉場效果
                const storyContainer = document.getElementById('story-content');
                if (storyContainer) {
                    storyContainer.style.opacity = '0';
                    
                    // 重置可能存在的跳過按鈕狀態
                    const existingSkipButton = document.querySelector('.skip-typing');
                    if (existingSkipButton) {
                        existingSkipButton.remove();
                    }
                    
                    setTimeout(() => {
                        updateStoryContent();
                        storyContainer.style.opacity = '1';
                        
                        // 平滑滾動到頂部
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 300);
                } else {
                    console.error("找不到故事容器元素");
                    // 嘗試直接更新內容作為備用機制
                    updateStoryContent();
                }
            } else {
                console.error(`找不到場景：${nextId}`);
            }
        }
        
        // 檢查特殊結局條件
        function checkSpecialEndingConditions(characterId, nextId, choiceText) {
            // 豫讓的特殊結局條件
            if (characterId === 'yu-rang' && nextId === 'yu-rang-6a' && choiceText.includes('請求擊打趙襄子的衣服')) {
                // 如果玩家從第7a場景(最後時刻)選擇放下刀劍並選擇擊衣
                const history = gameState.decisionsHistory[characterId];
                if (history && history.length >= 2 && history[history.length - 2].includes('坦白身份')) {
                    gameState.specialEndingProgress['yu-rang-end-11'] = true;
                }
            }
            
            // 荊軻的秘密結局條件
            if (characterId === 'jing-ke' && nextId === 'jing-ke-end-4' && gameState.currentScenario.id === 'jing-ke-7a') {
                // 如果玩家在第7a場景選擇了"堅持戰鬥到最後一刻"
                const totalJingKeEndings = Object.keys(characters['jing-ke'].endings).length;
                const completedCount = gameState.completedEndings['jing-ke'].length;
                
                // 如果已經解鎖了至少一半的結局，有20%的機會觸發秘密結局
                if (completedCount >= totalJingKeEndings / 2 && Math.random() < 0.2) {
                    gameState.specialEndingProgress['jing-ke-end-10'] = true;
                }
            }
        }

        // 顯示結局
        function showEnding(endingId) {
            const characterId = Object.keys(characters).find(key => characters[key] === gameState.currentCharacter);
            let ending = gameState.currentCharacter.endings[endingId];
            let finalEndingId = endingId;
            
            // 檢查是否有特殊結局條件
            if (characterId === 'yu-rang' && endingId === 'yu-rang-end-4' && gameState.specialEndingProgress['yu-rang-end-11']) {
                // 顯示豫讓的特殊結局
                finalEndingId = 'yu-rang-end-11';
                ending = gameState.currentCharacter.endings[finalEndingId];
            } else if (characterId === 'jing-ke' && endingId === 'jing-ke-end-4' && gameState.specialEndingProgress['jing-ke-end-10']) {
                // 顯示荊軻的秘密結局
                finalEndingId = 'jing-ke-end-10';
                ending = gameState.currentCharacter.endings[finalEndingId];
            }
            
            document.getElementById('story-content').classList.add('hidden');
            document.getElementById('ending-screen').classList.remove('hidden');
            
            // 添加動畫效果
            const endingText = document.getElementById('ending-text');
            endingText.classList.remove('fade-in');
            void endingText.offsetWidth; // 重置動畫
            endingText.classList.add('fade-in');
            endingText.textContent = ending.text;
            
            const historicalComment = document.getElementById('historical-comment');
            historicalComment.classList.remove('slide-in-right');
            void historicalComment.offsetWidth; // 重置動畫
            historicalComment.classList.add('slide-in-right');
            historicalComment.textContent = ending.comment;
            
            // 顯示結局名稱徽章
            const badgeElem = document.getElementById('ending-type-badge');
            let badgeClass = '';
            
            switch(ending.type) {
                case 'good':
                    badgeClass = 'bg-green-500';
                    break;
                case 'bad':
                    badgeClass = 'bg-red-500';
                    break;
                case 'secret':
                    badgeClass = 'bg-purple-500';
                    break;
                default:
                    badgeClass = 'bg-gray-500';
            }
            
            badgeElem.className = `inline-block px-2 py-1 text-xs text-white rounded-full mb-4 ${badgeClass}`;
            badgeElem.textContent = ending.name || '隱藏結局';
            
            // 記錄已完成的結局
            if (!gameState.completedEndings[characterId].includes(finalEndingId)) {
                gameState.completedEndings[characterId].push(finalEndingId);
                
                // 更新結局類型統計
                if (ending.type) {
                    gameState.endingTypeStats[ending.type] = (gameState.endingTypeStats[ending.type] || 0) + 1;
                }
                
                updateProgressDisplay();
                updateTotalProgress();
                updateEndingCollectionProgress(gameState.currentCharacter.name);
                
                // 顯示結局解鎖提示
                showEndingUnlockNotification(finalEndingId, ending);
                
                // 檢查是否解鎖新成就
                checkAchievements();
                
                // 檢查是否解鎖刺客精神和新角色
                checkSpiritUnlock(characterId, finalEndingId);
            }
            
            // 平滑滾動到頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // 特殊結局解鎖提示
            const specialHint = document.getElementById('special-ending-hint');
            const specialText = document.getElementById('special-ending-text');
            
            // 檢查是否需要顯示特殊結局解鎖提示
            if (ending.type === 'good' && !gameState.completedEndings[characterId].some(id => characters[characterId].endings[id].type === 'secret')) {
                specialHint.classList.remove('hidden');
                
                if (characterId === 'yu-rang') {
                    specialText.textContent = "反思趙襄子與智伯的關係，也許還有其他可能的結局...";
                } else if (characterId === 'jing-ke') {
                    specialText.textContent = "命運有時會產生意外的轉折，嘗試體驗更多荊軻的結局...";
                } else {
                    specialHint.classList.add('hidden');
                }
            } else {
                specialHint.classList.add('hidden');
            }
        }
        
        // 顯示結局解鎖通知
        function showEndingUnlockNotification(endingId, ending) {
            // 計算解鎖進度
            const characterId = Object.keys(characters).find(key => characters[key].endings[endingId]);
            const totalEndings = Object.keys(characters[characterId].endings).length;
            const unlockedEndings = gameState.completedEndings[characterId].length;
            
            // 使用通知隊列系統
            const metaContent = `已解鎖${unlockedEndings}/${totalEndings}個${characters[characterId].name}的結局`;
            notificationQueue.add('ending-unlock', ending.name || '隱藏結局', metaContent);
        }

        // 更新結局計數顯示
        function updateEndingCounts() {
            // 計算每個角色的總結局數
            const endingCounts = {
                "cao-mo": Object.keys(characters["cao-mo"].endings).length,
                "zhuan-zhu": Object.keys(characters["zhuan-zhu"].endings).length,
                "yu-rang": Object.keys(characters["yu-rang"].endings).length,
                "nie-zheng": Object.keys(characters["nie-zheng"].endings).length,
                "jing-ke": Object.keys(characters["jing-ke"].endings).length
            };
            
            // 更新UI顯示
            for (const character in endingCounts) {
                const progressElement = document.getElementById(`progress-${character}`);
                if (progressElement) {
                    progressElement.querySelector('.total-endings').textContent = endingCounts[character];
                    progressElement.querySelector('.completed-endings').textContent = gameState.completedEndings[character].length;
                    
                    // 更新完成百分比環
                    const completedCount = gameState.completedEndings[character].length;
                    const percentComplete = endingCounts[character] > 0 ? Math.round((completedCount / endingCounts[character]) * 100) : 0;
                    const ringElement = document.querySelector(`.character-card[data-character="${character}"] .completion-ring`);
                    
                    if (ringElement) {
                        ringElement.style.setProperty('--percent', `${percentComplete}%`);
                        ringElement.setAttribute('data-percent', `${percentComplete}%`);
                    }
                }
            }
        }
        
        // 更新總進度條
        function updateTotalProgress() {
            const totalEndingsCount = Object.values(characters).reduce((acc, character) => 
                acc + Object.keys(character.endings).length, 0);
            
            const totalCompletedCount = Object.values(gameState.completedEndings).reduce((acc, endings) => 
                acc + endings.length, 0);
            
            const percentComplete = totalEndingsCount > 0 ? Math.round((totalCompletedCount / totalEndingsCount) * 100) : 0;
            
            document.getElementById('total-progress-percent').textContent = `${percentComplete}%`;
            document.getElementById('total-progress-bar').style.width = `${percentComplete}%`;
            document.getElementById('total-endings-unlocked').textContent = totalCompletedCount;
            document.getElementById('total-endings').textContent = totalEndingsCount;
        }
        
        // 更新結局收集進度
        function updateEndingCollectionProgress(characterName) {
            const characterId = Object.keys(characters).find(key => characters[key].name === characterName);
            if (!characterId) return;
            
            const totalEndings = Object.keys(characters[characterId].endings).length;
            const completedCount = gameState.completedEndings[characterId].length;
            const percentComplete = totalEndings > 0 ? Math.round((completedCount / totalEndings) * 100) : 0;
            
            document.getElementById('character-endings-stat').textContent = `${completedCount}/${totalEndings}`;
            document.getElementById('character-endings-progress').style.width = `${percentComplete}%`;
        }
        
        // 更新進度顯示
        function updateProgressDisplay() {
            // 根據已完成的結局更新角色卡片的樣式
            document.querySelectorAll('.character-card').forEach(card => {
                const characterId = card.getAttribute('data-character');
                const completedCount = gameState.completedEndings[characterId].length;
                const totalCount = Object.keys(characters[characterId].endings).length;
                
                // 更新進度顯示
                const progressElement = document.getElementById(`progress-${characterId}`);
                if (progressElement) {
                    progressElement.querySelector('.completed-endings').textContent = completedCount;
                    
                    // 更新完成百分比環
                    const percentComplete = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                    const ringElement = card.querySelector('.completion-ring');
                    
                    if (ringElement) {
                        ringElement.style.setProperty('--percent', `${percentComplete}%`);
                        ringElement.setAttribute('data-percent', `${percentComplete}%`);
                    }
                }
            });
        }

        // 返回按鈕
        document.getElementById('back-button').addEventListener('click', () => {
            document.getElementById('character-selection').classList.remove('hidden');
            document.getElementById('game-introduction').classList.remove('hidden');
            document.getElementById('story-content').classList.add('hidden');
            document.getElementById('ending-screen').classList.add('hidden');
        });

        // 結局頁面的按鈕
        document.getElementById('replay-button').addEventListener('click', () => {
            if (gameState.currentCharacter) {
                startCharacterStory(Object.keys(characters).find(key => characters[key] === gameState.currentCharacter));
            }
        });

        document.getElementById('return-home-button').addEventListener('click', () => {
            // 確保正確隱藏所有遊戲界面並顯示首頁
            document.getElementById('story-content').classList.add('hidden');
            document.getElementById('ending-screen').classList.add('hidden');
            
            // 先移除所有可能的淡入效果類，然後重新添加，確保動畫正確觸發
            const selection = document.getElementById('character-selection');
            selection.classList.remove('fade-in');
            void selection.offsetWidth; // 強制重新計算，觸發動畫
            selection.classList.add('fade-in');
            
            // 顯示首頁元素
            document.getElementById('character-selection').classList.remove('hidden');
            document.getElementById('game-introduction').classList.remove('hidden');
            
            // 記錄返回首頁操作
            console.log('返回首頁');
        });

        // 音效系統
        const sounds = {
            click: new Audio("data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"),
            selectOption: new Audio("data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"),
            achievementUnlock: new Audio("data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"),
            endingUnlock: new Audio("data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"),
            urgentDecision: new Audio("data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAA1N3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyMzUAVFNTRQAAAA8AAANMYXZmNTcuODMuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAATEFNRTMuMTAwVVVVVVVVVVVVVUxBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQsRbAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVf/zQMSkAAADSAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV")
        };

        // 播放音效的函數
        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(error => {
                    console.log("音效播放失敗: ", error);
                });
            }
        }

        // 顯示角色解鎖提示
        function showUnlockHint(characterId) {
            // 創建提示框
            const hintPopup = document.createElement('div');
            hintPopup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // 確定前一個角色和需要的結局
            const characterOrder = ["cao-mo", "zhuan-zhu", "yu-rang", "nie-zheng", "jing-ke"];
            const currentIndex = characterOrder.indexOf(characterId);
            
            if (currentIndex <= 0) return; // 不應該發生，因為曹沫默認解鎖
            
            const previousCharId = characterOrder[currentIndex - 1];
            const requiredEndingId = assassinSpirits[previousCharId].unlockRequirement;
            const requiredEnding = characters[previousCharId].endings[requiredEndingId];
            
            hintPopup.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-5">
                    <div class="text-center mb-4">
                        <div class="bg-primary/10 inline-flex items-center justify-center p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold mt-3 text-primary">角色尚未解鎖</h3>
                    </div>
                    
                    <div class="mb-4 text-gray-700 dark:text-gray-300">
                        <p>要解鎖 <span class="font-bold text-primary">${characters[characterId].name}</span>，你需要先在 <span class="font-bold">${characters[previousCharId].name}</span> 的故事中獲得「${assassinSpirits[previousCharId].name}」。</p>
                        <p class="mt-2">完成 ${characters[previousCharId].name} 的「${requiredEnding.name}」結局，即可解鎖此角色。</p>
                    </div>
                    
                    <div class="flex items-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-md mb-3">
                        <div class="mr-3 text-2xl">${assassinSpirits[previousCharId].icon}</div>
                        <div>
                            <div class="font-bold text-sm">${assassinSpirits[previousCharId].name}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400">${assassinSpirits[previousCharId].description}</div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="close-unlock-hint" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                            了解
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(hintPopup);
            
            // 關閉按鈕事件
            document.getElementById('close-unlock-hint').addEventListener('click', () => {
                document.body.removeChild(hintPopup);
            });
        }
        
        // DOM 加載完成後初始化遊戲
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
        });
    </script>
</body>
</html>
