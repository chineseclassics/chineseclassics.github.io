<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 移除了CSP定義 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古典填詞工具 - 基於欽定詞譜</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- 添加更多字體資源，提升海報效果 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 韻部選擇按鈕 */
        .rhyme-select-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background: linear-gradient(45deg, #5D5CDE 0%, #7469DC 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(93, 92, 222, 0.2);
        }

        .rhyme-select-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(93, 92, 222, 0.4);
        }

        .rhyme-select-button.selected {
            background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
        }

        .rhyme-select-button .music-icon {
            margin-right: 5px;
            font-size: 1.1em;
        }
        
        /* 背诵挑战按钮样式 - 与韵部选择按钮和谐但有区别的配色 */
        .challenge-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background: linear-gradient(45deg, #FF7043 0%, #FF8A65 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 112, 67, 0.2);
        }

        .challenge-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 112, 67, 0.4);
        }

        .challenge-button.active {
            background: linear-gradient(45deg, #E64A19 0%, #FF7043 100%);
        }

        .challenge-button .challenge-icon {
            margin-right: 5px;
            font-size: 1.1em;
        }
        
        /* 深色模式下的背诵挑战按钮 */
        .dark-mode .challenge-button {
            background: linear-gradient(45deg, #FF5722 0%, #FF7043 100%);
            box-shadow: 0 3px 10px rgba(255, 87, 34, 0.25);
        }
        
        .dark-mode .challenge-button:hover {
            box-shadow: 0 6px 15px rgba(255, 87, 34, 0.45);
        }
        
        /* 韻部選擇彈窗樣式 */
        .rhyme-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* 默认隐藏模态窗口 */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        /* 韻部卡片相關樣式 */
        .rhyme-info-panel {
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f6fa;
            border-radius: 8px;
            font-size: 0.9em;
            color: #555;
        }
        
        .dark-mode .rhyme-info-panel {
            background: #2a2e3c;
            color: #ccc;
        }
        
        .rhyme-scheme-info {
            margin-bottom: 15px;
            color: #333;
            font-size: 0.9em;
            background: #f5f6fa;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .dark-mode .rhyme-scheme-info {
            background: #2a2e3c;
            border-color: #3a3f52;
            color: #e0e0e0;
        }
        
        .rhyme-scheme-info h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #5D5CDE;
        }
        
        .dark-mode .rhyme-scheme-info h4 {
            color: #7469DC;
        }
        
        .rhyme-scheme-types {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .rhyme-scheme-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rhyme-scheme-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            min-width: 45px;
            text-align: center;
        }
        
        .ping-badge {
            background-color: var(--ping-bg);
            border: 1px solid var(--ping-border);
            color: var(--ping-text);
        }
        
        .ze-badge {
            background-color: var(--ze-bg);
            border: 1px solid var(--ze-border);
            color: var(--ze-text);
        }
        
        .ru-badge {
            background-color: #eee8f8;
            border: 1px solid #9c7ed0;
            color: #6a4baa;
        }
        
        .huan-badge {
            background-color: #e8f2ff;
            border: 1px solid #5587d5;
            color: #2c5694;
        }
        
        .ye-badge {
            background-color: #fff1e6;
            border: 1px solid #e09356;
            color: #b15c10;
        }
        
        .dark-mode .ru-badge {
            background-color: #382d4a;
            border-color: #7a6ba5;
            color: #b7a1e3;
        }
        
        .dark-mode .huan-badge {
            background-color: #293447;
            border-color: #4571b5;
            color: #89b5f5;
        }
        
        .dark-mode .ye-badge {
            background-color: #3d2e1d;
            border-color: #a16a3d;
            color: #e09c65;
        }
        
        .rhyme-scheme-desc {
            font-size: 0.85em;
            color: #666;
        }
        
        .dark-mode .rhyme-scheme-desc {
            color: #aaa;
        }
        
        .rhyme-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            max-height: 450px; /* 增加最大高度，以便显示三行卡片 */
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .rhyme-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .dark-mode .rhyme-card {
            background: #3a3f52;
            border-color: #4a4f66;
        }
        
        .rhyme-card:hover {
            border-color: #5D5CDE;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(93, 92, 222, 0.2);
        }
        
        .rhyme-card.selected {
            border-color: #5D5CDE;
            background: rgba(93, 92, 222, 0.1);
        }
        
        .dark-mode .rhyme-card.selected {
            border-color: #7469DC;
            background: rgba(116, 105, 220, 0.2);
        }
        
        .rhyme-card-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.95em;
        }
        
        .dark-mode .rhyme-card-name {
            color: #e0e0e0;
        }
        
        .rhyme-card-desc {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 8px;
        }
        
        .dark-mode .rhyme-card-desc {
            color: #aaa;
        }
        
        .rhyme-card-samples {
            font-size: 0.85em;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .rhyme-card-ping {
            color: #2c4da9;
        }
        
        .rhyme-card-ze {
            color: #b43b36;
            margin-left: 5px;
        }
        
        .dark-mode .rhyme-card-ping {
            color: #a0c0ff;
        }
        
        .dark-mode .rhyme-card-ze {
            color: #ffb0aa;
        }
        
        /* 開關切換器樣式 */
        .rhyme-toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-right: 8px;
        }
        
        .rhyme-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .rhyme-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .rhyme-toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .rhyme-toggle-slider {
            background-color: #5D5CDE;
        }
        
        input:checked + .rhyme-toggle-slider:before {
            transform: translateX(20px);
        }
        
        .rhyme-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: visible; /* 改为visible，不显示滚动条 */
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode .rhyme-modal-content {
            background: #2c3143;
            color: #e0e0e0;
        }
        
        .rhyme-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .dark-mode .rhyme-modal-header {
            border-bottom: 1px solid #3a3f52;
        }
        
        .rhyme-modal-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .dark-mode .rhyme-modal-title {
            color: #e0e0e0;
        }
        
        .rhyme-modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .dark-mode .rhyme-modal-close {
            color: #aaa;
        }
        
        .rhyme-modal-body {
            padding: 20px;
        }
        
        .rhyme-modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            gap: 10px;
        }
        
        .dark-mode .rhyme-modal-footer {
            border-top: 1px solid #3a3f52;
        }
        
        .rhyme-apply-btn, .rhyme-cancel-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .rhyme-apply-btn {
            background: linear-gradient(45deg, #5D5CDE 0%, #7469DC 100%);
            color: white;
        }
        
        .rhyme-cancel-btn {
            background: #f0f0f0;
            color: #333;
        }
        
        .dark-mode .rhyme-cancel-btn {
            background: #3a3f52;
            color: #e0e0e0;
        }
        
        .rhyme-apply-btn:hover, .rhyme-cancel-btn:hover {
            transform: translateY(-2px);
        }
        
        .rhyme-group-dropdown {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .dark-mode .rhyme-group-dropdown {
            background: #3a3f52;
            border-color: #4a4f66;
            color: #e0e0e0;
        }
        
        .rhyme-group-dropdown:focus {
            border-color: #5D5CDE;
            outline: none;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .rhyme-group-info {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            display: none;
        }
        
        .rhyme-group-info.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .dark-mode .rhyme-group-info {
            background: #2a2e3c;
            border-color: #3a3f52;
        }
        
        .rhyme-group-info-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #5D5CDE;
        }
        
        .dark-mode .rhyme-group-info-title {
            color: #7469DC;
        }
        
        .rhyme-group-description {
            margin-bottom: 12px;
            color: #555;
            font-size: 0.9em;
        }
        
        .dark-mode .rhyme-group-description {
            color: #ccc;
        }
        
        .rhyme-sample-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .rhyme-ping-sample, .rhyme-ze-sample {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .rhyme-ping-sample {
            background: #e1eeff;
            color: #2c4da9;
        }
        
        .rhyme-ze-sample {
            background: #f9e9e8;
            color: #b43b36;
        }
        
        .dark-mode .rhyme-ping-sample {
            background: #2c3f65;
            color: #a0c0ff;
        }
        
        .dark-mode .rhyme-ze-sample {
            background: #5a302e;
            color: #ffb0aa;
        }
        
        .rhyme-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f0f7ff;
            color: #2c4da9;
        }
        
        .dark-mode .rhyme-status {
            background: #2c3f65;
            color: #a0c0ff;
        }
        
        .rhyme-status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4caf50;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .rhyme-status-icon::before {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 固定位置选择器样式 */
        .fixed-position {
            position: fixed !important;
            left: 50% !important;
            bottom: 20px !important;
            transform: translateX(-50%);
            z-index: 1000 !important;
            min-width: 280px;
            max-width: 90vw;
            background: white;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3) !important;
        }
        
        /* 高亮正在编辑的字符 */
        .actively-editing {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.8) !important;
            z-index: 50;
            position: relative;
            animation: highlight-pulse 1s infinite;
        }
        
        @keyframes highlight-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 152, 0, 0.8); }
            50% { box-shadow: 0 0 25px rgba(255, 152, 0, 1); }
        }
        
        /* 遮罩层样式 */
        .rhyme-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }
        
        /* === 作品列表相关样式 === */
        
        /* 侧边栏标签 */
        .sidebar-tabs {
            display: flex;
            margin-top: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px;
            gap: 2px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tab-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* 标签内容容器 */
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* 作品列表容器 */
        .works-list-container {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }
        
        /* 作品列表头部 */
        .works-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .works-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
            font-weight: 600;
        }
        
        .works-actions {
            display: flex;
            gap: 8px;
        }
        
        .works-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .works-actions .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .works-actions .btn-danger {
            border-color: rgba(244, 67, 54, 0.5);
            background: rgba(244, 67, 54, 0.1);
        }
        
        .works-actions .btn-danger:hover {
            background: rgba(244, 67, 54, 0.2);
        }
        
        /* 作品网格 */
        .works-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* 作品卡片 */
        .work-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .work-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(93, 92, 222, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .work-card.current-work {
            border-color: #5D5CDE;
            background: rgba(93, 92, 222, 0.1);
        }
        
        .work-card.current-work::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #5D5CDE;
        }
        
        /* 作品卡片头部 */
        .work-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .work-title {
            flex: 1;
            min-width: 0;
        }
        
        .cipai-name {
            font-weight: 600;
            color: white;
            font-size: 16px;
        }
        
        .author-name {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-left: 5px;
        }
        
        .work-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        
        .btn-icon {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .btn-icon.btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
            color: #ff6b6b;
        }
        
        /* 作品预览 */
        .work-preview {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
            font-family: "Noto Serif SC", serif;
        }
        
        /* 作品元信息 */
        .work-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .work-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .work-stats span {
            display: block;
        }
        
        .work-time {
            text-align: right;
            line-height: 1.3;
        }
        
        /* 当前作品指示器 */
        .current-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #5D5CDE;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }
        
        /* 空状态消息 */
        .empty-works-message {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 暗黑模式适配 */
        .dark-mode .works-header h3 {
            color: #e6e6e6;
        }
        
        .dark-mode .work-card {
            background: rgba(40, 40, 55, 0.6);
            border-color: rgba(60, 60, 75, 0.8);
        }
        
        .dark-mode .work-card:hover {
            background: rgba(40, 40, 55, 0.8);
            border-color: rgba(93, 92, 222, 0.6);
        }
        
        .dark-mode .cipai-name {
            color: #e6e6e6;
        }
        
        .dark-mode .author-name {
            color: rgba(230, 230, 230, 0.7);
        }
        
        .dark-mode .work-preview {
            color: rgba(230, 230, 230, 0.8);
        }
        
        .dark-mode .work-meta {
            color: rgba(230, 230, 230, 0.6);
        }
        
        /* 响应式适配 */
        @media (max-width: 768px) {
            .works-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .works-actions {
                justify-content: center;
            }
            
            .work-header {
                flex-direction: column;
                gap: 8px;
            }
            
            .work-actions {
                align-self: flex-end;
            }
            
            .work-meta {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .work-time {
                text-align: left;
            }
        }

        body {
            font-family: "Noto Serif SC", "SimSun", serif;
            background: var(--light-bg);
            min-height: 100vh;
            padding: 10px;
            transition: background 0.5s ease;
        }
        
        .dark-mode body {
            background: var(--dark-bg);
            color: #e6e6e6;
        }

        .container {
            max-width: 1400px;
            height: calc(100vh - 20px);
            margin: 0 auto;
            background: var(--card-light-bg);
            border-radius: 18px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
            animation: container-fade-in 0.8s ease-out;
        }
        
        .dark-mode .container {
            background: var(--card-dark-bg);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes container-fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 深色模式支持 */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #162447 100%);
                color: #e6e6e6;
            }
            
            .container {
                background: rgba(30, 30, 42, 0.97);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            }
            
            .sidebar {
                background: rgba(32, 32, 45, 0.9);
                border-right: 1px solid rgba(255, 255, 255, 0.05);
                box-shadow: 3px 0 15px -5px rgba(0, 0, 0, 0.2);
            }
            
            .sidebar-header {
                background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
                box-shadow: 0 4px 18px rgba(0, 0, 0, 0.3);
            }
            
            .poem-item {
                background: rgba(40, 40, 55, 0.8);
                border-color: rgba(60, 60, 75, 0.8);
                color: #e0e0e0;
            }
            
            .poem-item:hover {
                border-color: #6A67E5;
                box-shadow: 0 6px 15px rgba(93, 92, 222, 0.4);
            }
            
            .poem-item.active {
                background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
                border-color: #4A4AE0;
            }
            
            .poem-header h2 {
                color: #e0e0e0;
            }
            
            .author-info, #authorDisplay {
                color: #7469DC;
            }
            
            .display-area {
                background: rgba(36, 36, 48, 0.95);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            
            .rhyme-group-selector, .floating-rhyme-selector {
                background: rgba(36, 36, 48, 0.95);
                border-color: #5D5CDE;
            }
            
            .rhyme-group-info {
                background: rgba(45, 45, 60, 0.8);
                border-color: rgba(80, 80, 100, 0.3);
            }
            
            .rhyme-group-dropdown {
                background: rgba(36, 36, 48, 0.95);
                border-color: rgba(93, 92, 222, 0.5);
                color: #e0e0e0;
            }
            
            .floating-rhyme-char {
                background: rgba(45, 45, 60, 0.8);
                border-color: rgba(80, 80, 100, 0.3);
                color: #e0e0e0;
            }
            
            .floating-rhyme-char:hover {
                background: #5D5CDE;
                color: white;
            }
            
            .cipai-toggle-btn {
                background: rgba(36, 36, 48, 0.95);
                border-color: rgba(80, 80, 100, 0.3);
            }
            
            .version-btn {
                background: rgba(45, 45, 60, 0.8);
                border-color: rgba(80, 80, 100, 0.3);
                color: #e0e0e0;
            }
            
            .version-btn.active {
                background: #5D5CDE;
                color: white;
            }
            
            .btn {
                background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
            }
            
            .punctuation {
                color: #a0a0a0;
            }
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            padding: 0;
            position: relative;
            overflow: hidden;
            height: 100%;
            transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
            box-shadow: 3px 0 15px -5px rgba(0, 0, 0, 0.07);
        }
        
        .dark-mode .sidebar {
            background: rgba(32, 32, 45, 0.9);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 3px 0 15px -5px rgba(0, 0, 0, 0.2);
        }
        
        .poem-list-container {
            overflow-y: auto;
            height: calc(100% - 150px); /* 减去标题和搜索框的高度 */
            padding-top: 15px;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            display: flex;
            flex-direction: column;
            padding: 28px 24px;
            background: linear-gradient(45deg, #5D5CDE 0%, #7469DC 100%);
            color: white;
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.15);
            margin-bottom: 0;
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 10;
            transition: all 0.3s ease;
            animation: sidebar-header-fade-in 0.6s ease-out;
        }
        
        .dark-mode .sidebar-header {
            background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
            box-shadow: 0 4px 18px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes sidebar-header-fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .app-title {
            font-size: 2.2em;
            margin: 0 0 26px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1.2px;
            text-align: center;
            font-weight: 700;
            font-family: "Noto Serif SC", serif;
        }

        .search-box {
            width: 100%;
            padding: 12px 18px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            margin-bottom: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
            font-family: "Noto Serif SC", serif;
            font-weight: 400;
        }

        .search-box:focus {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.18);
            outline: none;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .cipai-section {
            margin-bottom: 25px;
            padding: 0 20px;
        }

        .cipai-title {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            font-family: "Noto Serif SC", serif;
        }

        .char-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .poem-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 0 2px;
        }

        .poem-item {
            padding: 14px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.215, 0.61, 0.355, 1);
            text-align: left;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin: 0 1px 10px 1px;
            transform: translateY(0);
            position: relative;
            overflow: hidden;
        }
        
        .poem-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(93, 92, 222, 0), rgba(93, 92, 222, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .poem-item:hover {
            border-color: #5D5CDE;
            box-shadow: 0 6px 15px rgba(93, 92, 222, 0.25);
            transform: translateY(-3px);
        }
        
        .poem-item:hover::before {
            opacity: 1;
        }

        .poem-item.active {
            background: linear-gradient(45deg, #5D5CDE 0%, #7469DC 100%);
            color: white;
            border-color: #5D5CDE;
            box-shadow: 0 6px 20px rgba(93, 92, 222, 0.4);
        }
        
        .dark-mode .poem-item {
            background: rgba(40, 40, 55, 0.8);
            border-color: rgba(60, 60, 75, 0.8);
            color: #e0e0e0;
        }
        
        .dark-mode .poem-item:hover {
            border-color: #6A67E5;
            box-shadow: 0 6px 15px rgba(93, 92, 222, 0.4);
        }
        
        .dark-mode .poem-item.active {
            background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
            border-color: #4A4AE0;
        }

        .poem-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 5px;
            font-family: "Noto Serif SC", serif;
        }

        .poem-preview {
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
            font-family: "Noto Serif SC", serif;
            font-weight: 300;
        }

        .poem-item.active .poem-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        .display-area {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .poem-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .poem-header h2 {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 700;
            font-family: "Noto Serif SC", serif;
        }

        .poem-header .author-info {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        /* 作者名編輯相關樣式 - 簡化版 */
        .author-info-simple {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
        }
        
        #authorDisplay {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px 10px;
        }
        
        #authorDisplay:hover {
            text-decoration: underline;
        }

        .author-input {
            border: 2px solid #667eea;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 1.2em;
            text-align: center;
            min-width: 150px;
            color: #667eea;
            font-weight: bold;
        }

        /* 格律圖例 */
        .pattern-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.85em;
            flex-wrap: wrap;
        }
        
        /* 例词开关样式 */
        .example-toggle-container {
            display: flex;
            align-items: center;
            margin-left: 5px;
            padding: 0 8px;
            border-radius: 15px;
            transition: all 0.3s ease;
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .example-toggle-container:hover {
            background-color: rgba(93, 92, 222, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(93, 92, 222, 0.2);
        }
        
        .dark-mode .example-toggle-container {
            background-color: rgba(116, 105, 220, 0.2);
        }
        
        .dark-mode .example-toggle-container:hover {
            background-color: rgba(116, 105, 220, 0.3);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-symbol {
            width: 25px;
            height: 25px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
        }

        .ping-legend { background-color: var(--ping-bg); border: 2px solid var(--ping-border); color: var(--ping-text); }
        .ze-legend { background-color: var(--ze-bg); border: 2px solid var(--ze-border); color: var(--ze-text); }
        .flexible-legend { background-color: var(--flexible-bg); border: 2px solid var(--flexible-border); color: var(--flexible-text); }
        .rhyme-ping-legend { background-color: var(--ping-bg); border: 2px solid var(--ping-border); box-shadow: 0 0 0 2px var(--ping-border); color: var(--ping-text); }
        .rhyme-ze-legend { background-color: var(--ze-bg); border: 2px solid var(--ze-border); box-shadow: 0 0 0 2px var(--ze-border); color: var(--ze-text); }

        .version-switcher {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .version-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .version-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .poem-display {
            font-size: 1.4em;
            line-height: 2.5;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            font-family: "LXGW WenKai", serif;
        }

        .poem-line {
            margin-bottom: 20px;
        }

        .char-span {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-width: 35px;
            height: 45px;
            line-height: 45px;
            margin: 0 4px; /* 增加字符间距从2px到4px */
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.215, 0.61, 0.355, 1);
            border-radius: 5px;
            text-align: center;
            position: relative;
            border: 2px solid transparent;
            -webkit-tap-highlight-color: transparent; /* 移除iOS上的点击高亮 */
            touch-action: manipulation; /* 优化触摸行为 */
        }

        .char-span:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .char-span.editing {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
            animation: pulse 1.2s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.3);
        }

        .char-span.modified {
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(93, 92, 222, 0.25);
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        /* 創建CSS變量用於主題配色 */
        :root {
            /* 主要配色 */
            --primary-color: #4a6fdc;
            --primary-light: #8aa3ea;
            --primary-dark: #2c4da9;
            --primary-hover: #5c7fe3;
            --primary-active: #3e5fb8;
            
            /* 次要配色 */
            --secondary-color: #6e48aa;
            --secondary-light: #9a7ccc;
            --secondary-dark: #523487;
            
            /* 中性色 */
            --neutral-100: #f8f9fa;
            --neutral-200: #e9ecef;
            --neutral-300: #dee2e6;
            --neutral-400: #ced4da;
            --neutral-500: #adb5bd;
            --neutral-600: #6c757d;
            --neutral-700: #495057;
            --neutral-800: #343a40;
            --neutral-900: #212529;
            
            /* 功能色 */
            --success-color: #38b27b;
            --info-color: #59a6e2;
            --warning-color: #ffaa40;
            --error-color: #e65f5c;
            
            /* 專用平仄韻配色 */
            --ping-bg: #e1eeff;
            --ping-border: #4a6fdc;
            --ping-text: #2c4da9;
            
            --ze-bg: #f9e9e8;
            --ze-border: #d95550;
            --ze-text: #b43b36;
            
            --flexible-bg: #f0e7f7;
            --flexible-border: #8e6ac2;
            --flexible-text: #6e48aa;
            
            /* 明暗模式背景 */
            --light-bg: linear-gradient(135deg, #f8f9fa 0%, #e1eeff 100%);
            --dark-bg: linear-gradient(135deg, #1e2130 0%, #2c3143 100%);
            
            /* 卡片背景 */
            --card-light-bg: rgba(255, 255, 255, 0.98);
            --card-dark-bg: rgba(37, 40, 53, 0.97);
        }
        
        /* 平仄和押韻樣式 */
        .ping-char {
            background-color: var(--ping-bg) !important;
            border: 2px solid var(--ping-border) !important;
            color: #000000 !important; /* 統一為黑色 */
        }

        .ze-char {
            background-color: var(--ze-bg) !important;
            border: 2px solid var(--ze-border) !important;
            color: #000000 !important; /* 統一為黑色 */
        }

        .flexible-char {
            background-color: var(--flexible-bg) !important;
            border: 2px solid var(--flexible-border) !important;
            color: #000000 !important; /* 統一為黑色 */
        }

        /* 韵脚基本样式 */
        .rhyme-ping {
            background-color: var(--ping-bg) !important;
            border: 2px solid var(--ping-border) !important;
            font-weight: bold;
            position: relative;
            z-index: 5; /* 确保动画不被其他元素遮挡 */
            color: #000000 !important; /* 統一為黑色 */
        }

        .rhyme-ze {
            background-color: var(--ze-bg) !important;
            border: 2px solid var(--ze-border) !important;
            font-weight: bold;
            position: relative;
            z-index: 5; /* 确保动画不被其他元素遮挡 */
            color: #000000 !important; /* 統一為黑色 */
        }
        
        /* 深色模式下的文字顏色調整 */
        .dark-mode .ping-char,
        .dark-mode .ze-char,
        .dark-mode .flexible-char,
        .dark-mode .rhyme-ping,
        .dark-mode .rhyme-ze {
            color: #ffffff !important; /* 深色模式下統一為白色 */
        }
        
        /* 平仄不匹配樣式 - 只添加虛線邊框和驚嘆號，完全保留原有平仄顏色和邊框顏色 */
        .tone-mismatch {
            position: relative;
            border-style: dashed !important;
            /* 不改變邊框顏色，保留原有平仄顏色的邊框 */
            /* 不改變背景色，保留原有平仄顏色 */
        }

        .tone-mismatch::after {
            content: '!';
            position: absolute;
            top: -8px;
            right: -5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--warning-color);
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 5px rgba(255, 170, 64, 0.7);
            z-index: 10; /* 確保驚嘆號顯示在最上層 */
        }
        
        /* 平仄建議選擇器 */
        .tone-suggestion-box {
            margin-top: 10px;
            padding: 8px;
            background: var(--neutral-100);
            border: 1px solid var(--warning-color);
            border-radius: 5px;
            font-size: 0.9em;
        }

        .tone-suggestion-title {
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--warning-color);
        }

        .tone-suggestion-chars {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .suggestion-char {
            padding: 3px 8px;
            background-color: white;
            border: 1px solid var(--neutral-300);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-char:hover {
            background-color: var(--primary-light);
            color: white;
            transform: scale(1.1);
        }

        .dark-mode .tone-suggestion-box {
            background: var(--neutral-800);
            border-color: var(--warning-color);
        }

        .dark-mode .suggestion-char {
            background-color: var(--neutral-700);
            border-color: var(--neutral-600);
            color: var(--neutral-200);
        }

        .dark-mode .suggestion-char:hover {
            background-color: var(--primary-dark);
            color: white;
        }

        /* 背诵挑战样式 */
        .recite-correct {
            background-color: rgba(76, 175, 80, 0.3) !important;
            border-color: rgba(76, 175, 80, 0.8) !important;
            color: #006400 !important;
        }
        
        .recite-incorrect {
            background-color: rgba(244, 67, 54, 0.3) !important;
            border-color: rgba(244, 67, 54, 0.8) !important;
            color: #8B0000 !important;
        }
        
        /* 深色模式下的背诵挑战样式 */
        .dark-mode .recite-correct {
            background-color: rgba(76, 175, 80, 0.4) !important;
            border-color: rgba(76, 175, 80, 0.9) !important;
            color: #90ee90 !important; /* 亮绿色 */
        }
        
        .dark-mode .recite-incorrect {
            background-color: rgba(244, 67, 54, 0.4) !important;
            border-color: rgba(244, 67, 54, 0.9) !important;
            color: #ffcccb !important; /* 亮红色 */
        }
        
        /* 添加韵脚位置动画效果 */
        .char-span.rhyme-ping {
            animation: rhyme-pulse-ping-glow 1.5s infinite !important;
            box-shadow: 0 0 10px 3px rgba(74, 111, 220, 0.6) !important; /* 光暈效果 */
            position: relative;
            z-index: 5; /* 確保光暈不被其他元素遮擋 */
        }

        .char-span.rhyme-ze {
            animation: rhyme-pulse-ze-glow 1.5s infinite !important;
            box-shadow: 0 0 10px 3px rgba(217, 85, 80, 0.6) !important; /* 光暈效果 */
            position: relative;
            z-index: 5; /* 確保光暈不被其他元素遮擋 */
        }

        @keyframes rhyme-pulse-ping-glow {
            0%, 100% { 
                box-shadow: 0 0 10px 3px rgba(74, 111, 220, 0.6), 0 0 15px 5px rgba(74, 111, 220, 0.3); 
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 15px 5px rgba(74, 111, 220, 0.8), 0 0 25px 10px rgba(74, 111, 220, 0.4); 
                transform: scale(1.05);
            }
        }

        @keyframes rhyme-pulse-ze-glow {
            0%, 100% { 
                box-shadow: 0 0 10px 3px rgba(217, 85, 80, 0.6), 0 0 15px 5px rgba(217, 85, 80, 0.3); 
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 15px 5px rgba(217, 85, 80, 0.8), 0 0 25px 10px rgba(217, 85, 80, 0.4); 
                transform: scale(1.05);
            }
        }
        
        /* 直接在韵脚字上触发动画效果，简化动画选择器 */
        .rhyme-ping {
            animation: rhyme-pulse-ping-glow 1.5s infinite;
        }
        
        .rhyme-ze {
            animation: rhyme-pulse-ze-glow 1.5s infinite;
        }
        
        .defined-rhyme {
            position: relative;
        }
        
        .defined-rhyme::after {
            content: '';
            position: absolute;
            top: -8px;
            right: -5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.7);
        }

        /* 输入法风格的韵字弹窗样式 */
        .floating-rhyme-selector {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            min-width: 280px;
            max-width: 90vw;
            animation: fadeIn 0.2s ease-out;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.95);
        }
        
        .dark-mode .floating-rhyme-selector {
            background: rgba(40, 40, 60, 0.95);
            color: #e0e0e0;
        }
        
        /* 独立的箭头元素 */
        .selector-arrow {
            position: absolute;
            width: 0;
            height: 0;
            z-index: 100;
            transform: translateX(-50%);
        }
        
        .selector-arrow.arrow-down {
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #667eea;
        }
        
        .selector-arrow.arrow-up {
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #667eea;
            border-top: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .floating-rhyme-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0;
            margin-bottom: 10px;
        }

        .floating-rhyme-char {
            padding: 8px 0;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 1em;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .dark-mode .floating-rhyme-char {
            background: #3a3f52;
            border-color: #4a4f66;
            color: #e0e0e0;
        }

        .floating-rhyme-char:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .floating-rhyme-char:active {
            transform: scale(0.95);
        }
        
        .floating-rhyme-title {
            text-align: center;
            margin-bottom: 10px;
            color: #333;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .dark-mode .floating-rhyme-title {
            color: #e0e0e0;
        }
        
        /* 分页控制样式 */
        .rhyme-selector-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }
        
        .rhyme-page-indicator {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
            flex: 1;
        }
        
        .rhyme-page-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.2s ease;
        }
        
        .dark-mode .rhyme-page-dot {
            background: #4a4f66;
        }
        
        .rhyme-page-dot.active {
            background: #667eea;
            width: 12px;
            height: 12px;
        }
        
        .rhyme-nav-button {
            background: none;
            border: none;
            color: #667eea;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.2s ease;
            border-radius: 5px;
        }
        
        .dark-mode .rhyme-nav-button {
            color: #7469DC;
        }
        
        .rhyme-nav-button:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .rhyme-nav-button:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .rhyme-nav-button:active {
            transform: scale(0.95);
        }
        
        .rhyme-type-indicator {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .ping-indicator {
            background-color: var(--ping-bg, #e1eeff);
            border: 1px solid var(--ping-border, #4a6fdc);
            color: var(--ping-text, #2c4da9);
        }
        
        .ze-indicator {
            background-color: var(--ze-bg, #f9e9e8);
            border: 1px solid var(--ze-border, #d95550);
            color: var(--ze-text, #b43b36);
        }
        
        /* 旧的全屏韵字选择器样式（保留作为备选） */
        .rhyme-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 400px;
        }

        .rhyme-selector h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }

        .rhyme-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .rhyme-char-btn {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .rhyme-char-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .rhyme-close {
            width: 100%;
            padding: 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .rhyme-hint {
            font-size: 0.9em;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes rhyme-pulse {
            0%, 100% { box-shadow: 0 0 0 rgba(102, 126, 234, 0); }
            50% { box-shadow: 0 0 8px rgba(102, 126, 234, 0.8); }
        }
        
        .rhyme-position {
            animation: rhyme-pulse 2s infinite;
            position: relative;
        }

        .char-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 1em;
            color: #333;
            outline: none;
            font-family: "LXGW WenKai", sans-serif;
        }

        .punctuation {
            margin: 0 5px;
            color: #666;
            cursor: default;
        }

        .controls {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 5px;
            transition: all 0.3s ease;
            min-height: 44px; /* 确保触摸友好 */
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 1 auto;
            max-width: 180px;
            touch-action: manipulation;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .feedback.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .feedback.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .prompt-message {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-top: 100px;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .main-content { flex-direction: column; }
            .sidebar { 
                width: 100%;
                /* 移除最大高度限制，让侧边栏可以自然扩展 */
                height: auto !important;
                min-height: 100% !important;
                overflow-y: auto;
            }
            .poem-display { 
                font-size: 1.1em; 
                line-height: 1.8;
            }
            .char-span { 
                min-width: 28px; 
                height: 38px;
                line-height: 38px;
                margin: 0 2px;
            }
            .display-area { padding: 12px; }
            .app-title { 
                font-size: 1.6em; 
                margin-bottom: 12px;
            }
            .poem-item { 
                padding: 12px; 
                margin-bottom: 8px; 
                touch-action: manipulation; 
            }
            .poem-item:active { transform: scale(0.98); }
            .btn { 
                padding: 10px 16px;
                font-size: 0.9em;
                margin: 0 4px;
                min-height: 44px; 
                touch-action: manipulation;
            }
            .rhyme-group-dropdown { 
                font-size: 14px;
                padding: 10px;
                height: 44px; 
            }
            .mobile-view-list .sidebar,
            .mobile-view-edit .content-area { animation: fadeIn 0.3s ease-out; }
            
            @keyframes fadeIn {
                from { opacity: 0.7; transform: translateY(5px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* 超小屏幕额外优化 */
            @media (max-width: 480px) {
                .poem-display { font-size: 1em; line-height: 1.7; }
                .char-span { 
                    min-width: 26px;
                    height: 34px;
                    line-height: 34px;
                    margin: 0 1px;
                }
                .sidebar-header { padding: 20px 16px; }
                .app-title { font-size: 1.4em; margin-bottom: 10px; }
                .search-box { padding: 10px 14px; }
                .poem-header h2 { font-size: 1.5em; }
                .controls { 
                    flex-wrap: wrap;
                    justify-content: center;
                    gap: 8px;
                }
                .btn { 
                    padding: 8px 14px;
                    flex: 1 0 auto;
                    max-width: 120px;
                }
                .pattern-legend { 
                    flex-wrap: wrap;
                    justify-content: center;
                    font-size: 0.8em;
                }
                .stats { 
                    flex-direction: column;
                    align-items: center;
                    gap: 8px;
                }
            }
        }

        .pattern-source {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8em;
            color: #888;
        }
        
        /* 添加移動端滑動相關樣式 */
        .swipe-hint {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 2000;
            transition: transform 0.3s ease;
            pointer-events: none;
        }
        
        .swipe-hint.active {
            transform: translateX(-50%) translateY(0);
        }
        
        .swipe-progress {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 0%;
            background: #5D5CDE;
            z-index: 1000;
            transition: width 0.1s ease;
        }
        
        /* 桌面版按鈕隱藏 */
        @media (min-width: 769px) {
            .swipe-hint, 
            .swipe-progress {
                display: none !important;
            }
        }
        
        /* 側邊欄切換按鈕樣式 */
        .sidebar-toggle-container {
            position: absolute;
            z-index: 100;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            display: none; /* 默認隱藏，只在桌面版顯示 */
        }
        
        .sidebar-toggle-btn {
            width: 28px;
            height: 60px;
            border-radius: 0 4px 4px 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            border-left: none;
            transition: all 0.3s ease;
        }
        
        .sidebar-toggle-btn:hover {
            background: #f9f9f9;
        }
        
        .sidebar-toggle-btn .chevron-icon {
            transition: transform 0.3s ease;
        }
        
        /* 側邊欄隱藏時的按鈕樣式 */
        .sidebar-hidden .sidebar-toggle-btn .chevron-icon {
            transform: rotate(180deg);
        }
        
        /* 桌面版特有樣式 */
        @media (min-width: 769px) {
            .sidebar-hidden .sidebar {
                margin-left: -320px; /* 隱藏側邊欄 */
            }
            
            .sidebar-hidden .content-area {
                margin-left: 0;
            }
            
            .sidebar, .content-area {
                transition: all 0.3s ease;
            }
            
            .sidebar-toggle-container {
                display: flex; /* 桌面版顯示側邊欄切換按鈕 */
                left: 320px; /* 初始位置，與側邊欄寬度相同 */
            }
            
            .sidebar-hidden .sidebar-toggle-container {
                left: 0; /* 側邊欄隱藏時，按鈕靠左 */
            }
        }
        /* 移動端視圖樣式 */
        @media (max-width: 768px) {
            .column-toggle-container {
                display: block;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .sidebar, .content-area {
                width: 100%;
                transition: transform 0.3s ease, opacity 0.3s ease, height 0.3s ease;
            }
            
            /* 默認顯示詞牌列表，隱藏內容區 */
            .mobile-view-list .sidebar {
                display: block !important;
                opacity: 1 !important;
                height: calc(100% - 20px) !important;
                transform: translateY(0) !important;
            }
            
            .mobile-view-list .content-area {
                display: none !important;
                opacity: 0 !important;
                height: 0 !important;
                transform: translateY(20px) !important;
            }
            
            /* 顯示內容區，隱藏詞牌列表 */
            .mobile-view-edit .sidebar {
                display: none !important;
                opacity: 0 !important;
                height: 0 !important;
                transform: translateY(-20px) !important;
            }
            
            .mobile-view-edit .content-area {
                display: block !important;
                opacity: 1 !important;
                height: calc(100% - 20px) !important;
                transform: translateY(0) !important;
            }
            
            /* 適配小屏幕的字體和布局 */
            .poem-display {
                font-size: 1.2em;
                line-height: 1.8;
            }
            
            .char-span {
                min-width: 28px;
                height: 38px;
                line-height: 38px;
                margin: 0 2px;
            }
            
            .app-title {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            
            .poem-header h2 {
                font-size: 1.8em;
            }
            
            .display-area {
                padding: 15px;
            }
            
            .controls .btn {
                padding: 10px 20px;
                font-size: 0.9em;
                margin: 0 5px;
            }
        }
        
        /* 优化的韵部选择器样式 */
        .rhyme-group-selector {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 10px;
            margin: 0 auto 15px auto;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .rhyme-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .rhyme-group-title {
            font-size: 1em;
            color: #333;
            font-weight: bold;
            margin: 0;
            white-space: nowrap;
            margin-right: 10px;
        }
        
        .rhyme-group-dropdown {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .rhyme-group-dropdown:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }
        
        .rhyme-group-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px;
            text-align: left;
            border: 1px solid #e0e0e0;
            margin-top: 5px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .rhyme-group-info.active {
            max-height: 150px;
            opacity: 1;
            margin-bottom: 5px;
        }
        
        .rhyme-group-info-title {
            font-weight: bold;
            margin-bottom: 3px;
            color: #667eea;
            font-size: 0.9em;
        }
        
        .rhyme-group-description {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .rhyme-sample-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        
        .rhyme-ping-sample, .rhyme-ze-sample {
            font-size: 0.8em;
        }
        
        .rhyme-ping-sample::before {
            content: '平聲: ';
            font-weight: bold;
            color: #2196f3;
        }
        
        .rhyme-ze-sample::before {
            content: '仄聲: ';
            font-weight: bold;
            color: #f44336;
        }
        
        /* 選中韻部的狀態指示器 */
        .rhyme-status {
            display: flex;
            align-items: center;
            font-size: 0.85em;
            color: #4caf50;
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .rhyme-status-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4caf50;
            margin-right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rhyme-status-icon::before {
            content: '✓';
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        /* 评价结果窗口样式优化 */
        .evaluation-section-title {
            color: #5D5CDE;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .evaluation-content-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            line-height: 1.7;
            color: #333;
            border: 1px solid #e9ecef;
            font-size: 0.95em;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* 针对列表容器的特殊处理 */
        ul.evaluation-content-box, ol.evaluation-content-box {
            padding-left: 15px;
            padding-right: 15px;
            margin: 0;
            list-style-position: inside;
        }
        
        .highlights-title {
            color: #28a745 !important;
        }
        
        .suggestions-title {
            color: #dc3545 !important;
        }
        
        .highlights-box {
            background: #f0f8f0 !important;
            border-color: #d4edda !important;
        }
        
        .suggestions-box {
            background: #fff5f5 !important;
            border-color: #f5c6cb !important;
        }
        
        .evaluation-list-item {
            margin-bottom: 8px;
            line-height: 1.6;
            color: #333;
            padding: 4px 0;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* 深色模式下的评价结果样式 */
        .dark-mode .evaluation-section-title {
            color: #7469DC;
        }
        
        .dark-mode .evaluation-content-box {
            background: #343a40;
            color: #f8f9fa;
            border-color: #495057;
        }
        
        .dark-mode .highlights-title {
            color: #40d058 !important;
        }
        
        .dark-mode .suggestions-title {
            color: #ff6b6b !important;
        }
        
        .dark-mode .highlights-box {
            background: #1e3a1e !important;
            color: #e8f5e8 !important;
            border-color: #2d5a2d !important;
        }
        
        .dark-mode .suggestions-box {
            background: #3a1e1e !important;
            color: #f5e8e8 !important;
            border-color: #5a2d2d !important;
        }
        
        .dark-mode .evaluation-list-item {
            color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 側邊欄切換控制器 - 桌面版專用 -->
        <div class="sidebar-toggle-container" id="sidebarToggleContainer">
            <div class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="切換詞牌列表">
                <span class="sidebar-toggle-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron-icon">
                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </span>
            </div>
        </div>
        
        <!-- 移除詞牌列表切換按鈕，使用滑動切換 -->
        
        <div class="main-content">
            <div class="sidebar" id="sidebarContainer">
                <div class="sidebar-header">
                    <h1 class="app-title">南風填詞</h1>
                    <input type="text" class="search-box" id="searchBox" placeholder="搜索詞牌名稱或作者...">
                    <div class="sidebar-tabs">
                        <button class="tab-btn active" onclick="switchSidebarTab('poems')">詞牌</button>
                        <button class="tab-btn" onclick="switchSidebarTab('works')">我的作品</button>
                    </div>
                </div>
                <div id="poemList" class="poem-list-container tab-content active">
                    <!-- 詞作列表將由JavaScript生成 -->
                </div>
                <div id="worksContainer" class="works-list-container tab-content">
                    <!-- 作品列表將由JavaScript生成 -->
                </div>
            </div>
            
            <div class="content-area" id="contentContainer">
                <div class="display-area">
                    <div class="prompt-message" id="promptMessage">
                        請從左側選擇一首詞作開始體驗
                    </div>
                    
                    <div id="poemDisplay" style="display: none;">
                        <div class="poem-header">
                            <h2 id="poemTitle"></h2>
                            <div class="author-info" id="authorInfo"></div>
                        </div>

                        <!-- 韵部选择器 - 优化版 -->
                        <div class="legend-with-rhyme-button">
                            <div class="pattern-legend" id="patternLegendInline">
                                <div class="legend-item">
                                    <div class="legend-symbol ping-legend"></div>
                                    <span>平聲</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol ze-legend"></div>
                                    <span>仄聲</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol flexible-legend"></div>
                                    <span>可平可仄</span>
                                </div>
                                <!-- 例词显示开关 -->
                                <div class="legend-item example-toggle-container">
                                    <label class="rhyme-toggle-switch">
                                        <input type="checkbox" id="exampleWordToggle" checked>
                                        <span class="rhyme-toggle-slider"></span>
                                    </label>
                                    <span>顯示例詞</span>
                                </div>
                            </div>
                            <div class="rhyme-buttons-container" style="display: flex; justify-content: center; gap: 8px; align-items: center; max-width: 400px; margin: 0 auto;">
                                <button id="rhymeSelectButton" class="rhyme-select-button" onclick="unlockAndShowRhymeModal()">
                                    <span class="music-icon">🎵</span>
                                    選擇韻部
                                </button>
                                <button id="reciteChallengeButton" class="challenge-button" onclick="toggleReciteChallenge()">
                                    <span class="challenge-icon">🎮</span>
                                    背誦挑戰
                                </button>
                            </div>
                        </div>
                        
                        <!-- 韻部選擇彈窗 - 修复结构 -->
                        <!-- 韻部選擇彈窗 - 卡片式界面 -->
                        <div id="rhymeModal" class="rhyme-modal">
                            <div class="rhyme-modal-content">
                                <div class="rhyme-modal-header">
                                    <div class="rhyme-modal-title" id="rhymeModalTitle"></div>
                                    <button id="rhymeModalClose" class="rhyme-modal-close">&times;</button>
                                </div>
                                
                                <div class="rhyme-modal-body">
                                    <!-- 完全移除了rhyme-info-panel -->
                                    <div class="rhyme-cards-container" id="rhymeCardsContainer">
                                        <!-- 韵部卡片将由JavaScript生成 -->
                                    </div>
                                    
                                    <div class="rhyme-settings">
                                        <label class="rhyme-toggle">
                                            <span class="rhyme-toggle-switch">
                                                <input type="checkbox" id="rhymeHintToggle" checked>
                                                <span class="rhyme-toggle-slider"></span>
                                            </span>
                                            顯示韻腳輔助提示字
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 保留原始的图例，但默认隐藏 -->
                        <div class="pattern-legend" id="patternLegend" style="display: none;">
                            <div class="legend-item">
                                <div class="legend-symbol ping-legend"></div>
                                <span>平聲</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol ze-legend"></div>
                                <span>仄聲</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-symbol flexible-legend"></div>
                                <span>可平可仄</span>
                            </div>
                        </div>
                        
                        <div class="pattern-source" id="patternSource" style="display: none;">
                            
                        </div>
                        
                        <div class="version-switcher" id="versionSwitcher" style="display: none;">
                            <!-- 版本切換按鈕將由JavaScript生成 -->
                        </div>
                        
                        <div class="poem-display" id="poemContent">
                            <!-- 詞作內容將由JavaScript生成 -->
                        </div>
                        

                        
                        <div class="controls">
                            <button class="btn" onclick="saveCurrentWorkQuick()">💾 保存作品</button>
                            <button class="btn" onclick="resetPoem()">還原原作</button>
                            <button class="btn" onclick="copyTextToClipboard()">複製文本</button>
                            <button class="btn" onclick="openPosterGenerator()">生成壁紙</button>
                            <button class="btn" onclick="requestAIEvaluation()" id="aiEvaluationBtn">AI評價</button>
                        </div>
                        
                        <div class="stats" id="statsInfo">
                            <div class="stat-item">
                                <span>已修改：</span>
                                <span id="modifiedCount">0</span>
                                <span>字</span>
                            </div>
                            <div class="stat-item">
                                <span>總字數：</span>
                                <span id="totalCount">0</span>
                                <span>字</span>
                            </div>
                            <div class="stat-item">
                                <span>修改率：</span>
                                <span id="modifyRate">0%</span>
                            </div>
                        </div>
                        
                        <div id="feedback"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加海报生成模态窗口 - 简洁按钮风格 -->
<div id="posterModal" class="rhyme-modal">
    <div class="rhyme-modal-content" style="max-width: 380px; max-height: 90vh; overflow-y: auto; background: rgba(255, 255, 255, 0.95)">
        <div class="rhyme-modal-header">
            <div class="rhyme-modal-title">生成壁紙</div>
            <button id="posterModalClose" class="rhyme-modal-close">&times;</button>
        </div>
        
        <div class="rhyme-modal-body" style="padding: 15px; display: flex; flex-direction: column;">
            <!-- 壁纸预览区域 -->
            <div class="poster-preview" id="posterPreviewSection">
                <div style="background: #f5f5f5; height: 300px; border-radius: 8px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
                    <div id="posterPlaceholder" style="display: none;"></div>
                    <canvas id="posterCanvas" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></canvas>
                    <div id="posterLoading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center;">
                        <div style="text-align: center;">
                            <div class="loader"></div>
                            <p style="margin-top: 10px; color: #5D5CDE;">生成中...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 风格按钮选择区域 -->
                <div style="margin-bottom: 15px;">
                    <h3 style="margin-top: 0; margin-bottom: 10px; color: #5D5CDE; text-align: center;">選擇壁紙樣式</h3>
                    <div class="style-buttons-container">
                        <button class="style-button xuan-button active" data-style="xuan">宣紙</button>
                        <button class="style-button mo-button" data-style="mo">墨韻</button>
                        <button class="style-button qinghua-button" data-style="qinghua">青花</button>
                        <button class="style-button danqing-button" data-style="danqing">丹心</button>
                        <button class="style-button songyan-button" data-style="songyan">松煙</button>
                        <button class="style-button zhujian-button" data-style="zhujian">竹簡</button>
                    </div>
                </div>
                
                <!-- 下载按钮 -->
                <div style="text-align: center; margin-top: 15px; margin-bottom: 10px;">
                    <button id="downloadPosterBtn" class="setting-button download-btn">下載壁紙</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 壁紙生成模態窗口樣式 */
.setting-button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 5px;
}

.generate-btn {
    background: linear-gradient(45deg, #5D5CDE 0%, #7469DC 100%);
    color: white;
}

.generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(93, 92, 222, 0.3);
}

.download-btn {
    background: linear-gradient(45deg, #5D5CDE 0%, #7469DC 100%);
    color: white;
    display: inline-block;
    padding: 10px 25px;
}

.dark-mode .download-btn {
    background: linear-gradient(45deg, #4A4AE0 0%, #5245C2 100%);
    color: #ffffff;
}

.download-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(93, 92, 222, 0.3);
}

.download-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #5D5CDE;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 2s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 风格按钮样式 */
.style-buttons-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
}

.style-button {
    padding: 12px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    border: 2px solid #e0e0e0;
    min-width: 110px;
    text-align: center;
}

.style-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.style-button.active {
    border-color: #5D5CDE;
    box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.5);
    background-color: rgba(93, 92, 222, 0.2);
}

/* 墨韻風格按鈕特殊處理 */
.mo-button.active {
    text-shadow: 0 0 3px #ffffff, 0 0 5px #ffffff;
    border-color: #5D5CDE;
    box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.5), 0 0 10px rgba(255, 255, 255, 0.3);
}

/* 不同风格的按钮样式 */
.xuan-button {
    background-color: #f9f2dc;
    color: #333333;
    border-color: #d9b27c;
}

.mo-button {
    background-color: #1c1c1c;
    color: #e8e8e8;
    border-color: #555555;
}

.qinghua-button {
    background-color: #e8f2f7;
    color: #245a7a;
    border-color: #6b93ad;
}

.danqing-button {
    background-color: #fff2f2;
    color: #8a292d;
    border-color: #c24e54;
}

.songyan-button {
    background-color: #e6efe0;
    color: #1c4024;
    border-color: #587f5e;
}

.zhujian-button {
    background-color: #e0d4b8;
    color: #5c3c10;
    border-color: #9b7d56;
}

/* 不同风格的预览样式 */
.xuan-style {
    background-color: #f9f2dc;
    color: #333333;
}

.mo-style {
    background-color: #1c1c1c;
    color: #e8e8e8;
}

.qinghua-style {
    background-color: #e8f2f7;
    color: #245a7a;
}

.danqing-style {
    background-color: #fff2f2;
    color: #8a292d;
}

.songyan-style {
    background-color: #e6efe0;
    color: #1c4024;
}

.preview-title {
    font-size: 12px;
    margin-bottom: 5px;
    font-weight: bold;
}

.preview-author {
    font-size: 10px;
    margin-bottom: 10px;
}

.preview-content {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.preview-char {
    font-size: 14px;
    line-height: 1.2;
}

/* 响应式适配 */
@media (max-width: 768px) {
    .rhyme-modal-content {
        flex-direction: column;
        overflow-y: auto !important;
        max-height: 90vh !important;
    }
    
    .rhyme-modal-body {
        flex-direction: column !important;
    }
    
    .style-cards-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    #posterCanvas {
        max-width: 100% !important;
        max-height: 250px !important;
    }
}
</style>

<script>
        // 韵部选择相关变量
        window.showRhymeHints = true; // 默认显示韵脚辅助提示
        
        // 首先，确保全局函数容器存在
        window.nanfengApp = window.nanfengApp || {};
        
        // 定义移动端视图切换函数 - 必须先定义这些函数，因为selectPoem会用到它们
        // 切換到列表視圖
        window.nanfengApp.switchToListView = function() {
            console.log("切换到列表视图");
            const container = document.querySelector('.container');
            container.classList.add('view-transitioning');
            container.classList.remove('mobile-view-edit');
            container.classList.add('mobile-view-list');
            window.nanfengViewMode = 'list';
            
            // 检查元素是否存在后再操作
            const cipaiToggleText = document.getElementById('cipaiToggleText');
            if (cipaiToggleText) {
                cipaiToggleText.textContent = "開始創作";
            }
            
            // 結束過渡動畫
            setTimeout(() => {
                container.classList.remove('view-transitioning');
            }, 500);
        };
        
        // 切換到編輯視圖
        window.nanfengApp.switchToEditView = function() {
            console.log("切换到编辑视图");
            const container = document.querySelector('.container');
            container.classList.add('view-transitioning');
            container.classList.remove('mobile-view-list');
            container.classList.add('mobile-view-edit');
            window.nanfengViewMode = 'edit';
            
            // 检查元素是否存在后再操作
            const cipaiToggleText = document.getElementById('cipaiToggleText');
            if (cipaiToggleText) {
                cipaiToggleText.textContent = "查看詞牌";
            }
            
            // 結束過渡動畫
            setTimeout(() => {
                container.classList.remove('view-transitioning');
            }, 500);
        };
        
        // 背诵挑战模式变量
        let isReciteChallengeMode = false;
        let reciteStartTime = null;
        let correctCharsCount = 0;
        let totalCharsToRecite = 0;
        
        // 切换背诵挑战模式
        function toggleReciteChallenge() {
            isReciteChallengeMode = !isReciteChallengeMode;
            const button = document.getElementById('reciteChallengeButton');
            const exampleToggleContainer = document.querySelector('.example-toggle-container');
            
            if (isReciteChallengeMode) {
                // 进入背诵挑战模式
                button.innerHTML = `
                    <span class="challenge-icon">🚫</span>
                    退出挑战
                `;
                button.style.background = "linear-gradient(45deg, #e55039 0%, #ff7979 100%)";
                
                // 隐藏例词开关
                if (exampleToggleContainer) {
                    exampleToggleContainer.style.display = 'none';
                }
                
                startReciteChallenge();
            } else {
                // 退出背诵挑战模式 - 保持橙色主题
                button.innerHTML = `
                    <span class="challenge-icon">🎮</span>
                    背誦挑戰
                `;
                // 保持橙色，不要改回蓝紫色
                button.style.background = "linear-gradient(45deg, #FF7043 0%, #FF8A65 100%)";
                
                // 恢复显示例词开关
                if (exampleToggleContainer) {
                    exampleToggleContainer.style.display = 'flex';
                }
                
                exitReciteChallenge();
            }
        }
        
        // 开始背诵挑战
        function startReciteChallenge() {
            if (!currentPoem) {
                showFeedback("请先选择一首词作再开始背诵挑战", "warning");
                isReciteChallengeMode = false;
                toggleReciteChallenge();
                return;
            }
            
            // 重置计数器和计时器
            correctCharsCount = 0;
            totalCharsToRecite = 0;
            reciteStartTime = new Date();
            
            // 关闭例词显示（利用现有功能）
            const exampleToggle = document.getElementById('exampleWordToggle');
            if (exampleToggle.checked) {
                exampleToggle.checked = false;
                // 手动触发事件
                const event = new Event('change');
                exampleToggle.dispatchEvent(event);
            }
            
            // 重新渲染词作，进入背诵模式
            renderPoemWithPattern(true);
            
            showFeedback("背诵挑战开始！点击字格填写正确的字", "info");
        }
        
        // 退出背诵挑战
        function exitReciteChallenge() {
            // 恢复例词显示开关状态
            const exampleToggle = document.getElementById('exampleWordToggle');
            if (exampleToggle && !exampleToggle.checked) {
                exampleToggle.checked = true;
            }
            
            // 恢复显示
            renderPoemWithPattern();
            showFeedback("已退出背诵挑战", "info");
        }
        
        // 定义全局selectPoem函数
        window.selectPoem = function(cipaiName, versionKey, e) {
            console.log(`调用selectPoem: ${cipaiName}, ${versionKey}`);
            
            // 如果正在背诵挑战中，提示并退出
            if (isReciteChallengeMode) {
                if (confirm("切换词牌将退出背诵挑战模式，确定要继续吗？")) {
                    // 退出背诵挑战模式
                    toggleReciteChallenge();
                } else {
                    return;
                }
            }
            
            // 移除所有作品的選中狀態
            document.querySelectorAll('.poem-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 如果是通過點擊列表項選擇
            if (e && e.target) {
                const poemItem = e.target.closest('.poem-item');
                if (poemItem) {
                    poemItem.classList.add('active');
                }
            }
            // 否則這是通過版本切換按鈕調用的，不需要處理選中狀態
            // 系統將載入新版本，但不需要在列表中進行視覺上的更新

            currentCipai = cipaiName;
            currentVersion = versionKey;
            currentPoem = cipaiPatterns[cipaiName].versions[versionKey];
            userSelectedRhymeGroup = null; // 重置用户选择的韵部
            currentRhymeGroups = {}; // 重置韵部
            
            // 清空所有修改记录 - 修复切换词牌时修改保留的问题
            modifiedChars.clear();
            modifiedCharRecords = []; // 完全清空修改记录数组
            
            // 更新韵部按钮文本状态，但不自动显示韵部选择器
            updateRhymeButtonText();
            
            // 显示诗词内容
            displayPoem(cipaiName, versionKey);
            
            // 只在移動裝置上自動切換視圖 - 使用全局定义的函数
            if (window.innerWidth <= 768) {
                console.log("移動端選擇詞牌：自動切換到編輯視圖");
                try {
                    // 使用安全的方式调用视图切换函数
                    if (typeof window.nanfengApp.switchToEditView === 'function') {
                        window.nanfengApp.switchToEditView();
                    } else {
                        console.error("switchToEditView函数未正确定义在window.nanfengApp上");
                    }
                } catch (err) {
                    console.error("视图切换出错:", err);
                }
            }
        };
        
        // 填充韵部下拉菜单
        function populateRhymeGroupDropdown() {
            const dropdown = document.getElementById('rhymeGroupDropdown');
            if (!dropdown) return;
            
            // 清空现有选项，只保留第一个默认选项
            dropdown.innerHTML = '<option value="" disabled selected>請選擇詩詞韻部...</option>';
            
            // 分析词谱中的韵脚类型
            const rhymeTypes = new Set();
            if (currentPoem && currentPoem.pattern) {
                currentPoem.pattern.forEach(line => {
                    if (line.rhyme && line.rhyme.length > 0) {
                        line.rhyme.forEach(charIndex => {
                            const tone = line.tones[charIndex];
                            if (tone === '△') rhymeTypes.add('ping');
                            if (tone === '▲') rhymeTypes.add('ze');
                        });
                    }
                });
            }
            
            // 创建韵部选项
            Object.keys(rhymeDatabase).forEach(groupId => {
                const group = rhymeDatabase[groupId];
                
                // 检查该韵部是否有需要的平仄字
                let shouldShow = false;
                if ((rhymeTypes.has('ping') && group.pingChars.length > 0) || 
                    (rhymeTypes.has('ze') && group.zeChars.length > 0)) {
                    shouldShow = true;
                }
                
                if (shouldShow) {
                    const option = document.createElement('option');
                    option.value = groupId;
                    option.textContent = `${group.name} - ${group.description}`;
                    dropdown.appendChild(option);
                }
            });
            
            // 如果已经选择了韵部，预先选中它
            if (userSelectedRhymeGroup) {
                dropdown.value = userSelectedRhymeGroup;
                // 触发一次change事件，显示详情
                const event = new Event('change');
                dropdown.dispatchEvent(event);
                // 显示已选择状态
                const rhymeStatus = document.getElementById('rhymeStatus');
                const rhymeStatusText = document.getElementById('rhymeStatusText');
                if (rhymeStatus && rhymeStatusText) {
                    rhymeStatus.style.display = 'flex';
                    rhymeStatusText.textContent = `已選擇「${rhymeDatabase[userSelectedRhymeGroup].name}」韻部`;
                }
            }
        }
        
        // 关闭韵部选择模态窗口
        window.closeRhymeModal = function() {
            const modal = document.getElementById('rhymeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        // 完全重写韵部选择逻辑，移除自动弹出功能
        
        // 彻底阻断所有自动弹窗路径
        
        // 頁面加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
            initMobileViewToggle();
        });
        
        // 移除冗余的韻部選擇器相關函數，統一使用displayRhymeModal作為入口點
        // 所有其他函數都已廢棄
        
        function optimizeRhymeModalDisplay() {
            // 设置韵部选择器的标题
            const modalTitle = document.getElementById('rhymeModalTitle');
            if (modalTitle && currentCipai) {
                modalTitle.textContent = `${currentCipai}：選擇韻部`;
            }
            
            // 分析韵脚类型并优化韵部卡片显示
            const rhymeTypes = analyzeRhymeTypes();
            
            // 优化卡片显示
            const rhymeCards = document.querySelectorAll('.rhyme-card');
            rhymeCards.forEach(card => {
                const nameElem = card.querySelector('.rhyme-card-name');
                if (!nameElem) return;
                
                // 查找对应的韵部
                const name = nameElem.textContent;
                let group = Object.values(rhymeDatabase).find(g => g.name === name);
                if (!group) return;
                
                // 确定显示的韵脚类型
                let showPing = rhymeTypes.has('ping') || (!rhymeTypes.has('ping') && !rhymeTypes.has('ze'));
                let showZe = rhymeTypes.has('ze') || (!rhymeTypes.has('ping') && !rhymeTypes.has('ze'));
                
                // 更新样本容器
                const samplesContainer = card.querySelector('.rhyme-card-samples');
                if (samplesContainer) {
                    samplesContainer.innerHTML = '';
                    
                    // 平声韵脚字
                    if (showPing && group.pingChars.length > 0) {
                        const charsLimit = showZe ? 3 : 6;
                        const pingChars = group.pingChars.slice(0, charsLimit).join('、') + 
                                      (group.pingChars.length > charsLimit ? '...' : '');
                        samplesContainer.innerHTML += `<span class="rhyme-card-ping">平：${pingChars}</span>`;
                    }
                    
                    // 仄声韵脚字
                    if (showZe && group.zeChars.length > 0) {
                        const charsLimit = showPing ? 3 : 6;
                        const zeChars = group.zeChars.slice(0, charsLimit).join('、') + 
                                    (group.zeChars.length > charsLimit ? '...' : '');
                        samplesContainer.innerHTML += `<span class="rhyme-card-ze">仄：${zeChars}</span>`;
                    }
                }
            });
        }
        
        function safeShowRhymeModal() {
            console.log("🔐 安全显示韵部模态窗口");
            
            // 获取已存在的模态窗口
            let modal = document.getElementById('rhymeModal');
            
            // 如果模态窗口不存在，创建新窗口
            if (!modal) {
                console.log("🏗️ 创建新的韵部模态窗口");
                
                modal = document.createElement('div');
                modal.id = 'rhymeModal';
                modal.className = 'rhyme-modal';
                
                modal.innerHTML = `
                    <div class="rhyme-modal-content">
                        <div class="rhyme-modal-header">
                            <div class="rhyme-modal-title">選擇詩詞韻部</div>
                            <button id="rhymeModalClose" class="rhyme-modal-close">&times;</button>
                        </div>
                        
                        <div class="rhyme-modal-body">
                            <div class="rhyme-info-panel">
                                <div id="rhymeTypeInfo"></div>
                            </div>
                            
                            <div class="rhyme-cards-container" id="rhymeCardsContainer">
                                <!-- 韵部卡片将由JavaScript生成 -->
                            </div>
                            
                            <div class="rhyme-settings">
                                <label class="rhyme-toggle">
                                    <span class="rhyme-toggle-switch">
                                        <input type="checkbox" id="rhymeHintToggle" checked>
                                        <span class="rhyme-toggle-slider"></span>
                                    </span>
                                    顯示韻腳輔助提示字
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // 分析词谱中的韵脚类型
            const rhymeTypes = new Set();
            if (currentPoem && currentPoem.pattern) {
                currentPoem.pattern.forEach(line => {
                    if (line.rhyme && line.rhyme.length > 0) {
                        line.rhyme.forEach(charIndex => {
                            const tone = line.tones[charIndex];
                            if (tone === '△') rhymeTypes.add('ping');
                            if (tone === '▲') rhymeTypes.add('ze');
                        });
                    }
                });
            }
            
            // 更新韵部类型信息
            const rhymeTypeInfo = document.getElementById('rhymeTypeInfo');
            if (rhymeTypeInfo) {
                let typeText = "當前詞牌需要";
                if (rhymeTypes.has('ping') && rhymeTypes.has('ze')) {
                    typeText += "平聲韻和仄聲韻";
                } else if (rhymeTypes.has('ping')) {
                    typeText += "平聲韻";
                } else if (rhymeTypes.has('ze')) {
                    typeText += "仄聲韻";
                } else {
                    typeText += "未指定韻部";
                }
                rhymeTypeInfo.textContent = typeText;
            }
            
            // 渲染韵部卡片
            const cardsContainer = document.getElementById('rhymeCardsContainer');
            if (cardsContainer) {
                cardsContainer.innerHTML = '';
                
                // 创建韵部卡片
                Object.keys(rhymeDatabase).forEach(groupId => {
                    const group = rhymeDatabase[groupId];
                    
                    // 检查该韵部是否有需要的平仄字
                    let shouldShow = false;
                    if ((rhymeTypes.has('ping') && group.pingChars.length > 0) || 
                        (rhymeTypes.has('ze') && group.zeChars.length > 0)) {
                        shouldShow = true;
                    }
                    
                    if (shouldShow) {
                        const card = document.createElement('div');
                        card.className = 'rhyme-card';
                        if (userSelectedRhymeGroup == groupId) {
                            card.classList.add('selected');
                        }
                        
                        // 提取示例字符
                        const pingChars = group.pingChars.slice(0, 3).join('、');
                        const zeChars = group.zeChars.slice(0, 3).join('、');
                        
                        card.innerHTML = `
                            <div class="rhyme-card-name">${group.name}</div>
                            <div class="rhyme-card-desc">${group.description}</div>
                            <div class="rhyme-card-samples">
                                ${group.pingChars.length > 0 ? `<span class="rhyme-card-ping">平：${pingChars}</span>` : ''}
                                ${group.zeChars.length > 0 ? `<span class="rhyme-card-ze">仄：${zeChars}</span>` : ''}
                            </div>
                        `;
                        
                        // 添加点击事件
                        card.addEventListener('click', () => {
                            // 移除所有卡片的选中状态
                            document.querySelectorAll('.rhyme-card').forEach(c => {
                                c.classList.remove('selected');
                            });
                            
                            // 设置当前卡片为选中状态
                            card.classList.add('selected');
                            
                            // 保存选择的韵部
                            userSelectedRhymeGroup = groupId;
                            
                            // 应用选择的韵部
                            applyUserSelectedRhymeGroup();
                            
                            // 更新韵部按钮文本
                            updateRhymeButtonText();
                            
                            // 关闭模态窗口
                            closeRhymeModal();
                        });
                        
                        cardsContainer.appendChild(card);
                    }
                });
            }
            
            // 为关闭按钮添加事件
            const closeBtn = document.getElementById('rhymeModalClose');
            if (closeBtn) {
                closeBtn.onclick = closeRhymeModal;
            }
            
            // 为韵部提示开关添加事件
            const hintToggle = document.getElementById('rhymeHintToggle');
            if (hintToggle) {
                hintToggle.checked = window.showRhymeHints !== false; // 默认为true
                hintToggle.onchange = function() {
                    window.showRhymeHints = this.checked;
                };
            }
            
            // 显示模态窗口
            modal.style.display = 'flex';
        }
        
        // 新增直接显示韵部模态窗口的函数，避免使用可能被篡改的函数
        function directShowRhymeModal(isUserTriggered, forceExecute) {
            console.log("直接显示韵部模态窗口，isUserTriggered:", isUserTriggered, "forceExecute:", forceExecute);
            
            // 只有在明确用户触发且强制执行的情况下才显示
            if (isUserTriggered !== true || forceExecute !== true) {
                console.log("拒绝显示韵部模态窗口 - 不满足严格条件");
                return false;
            }
            
            // 立即设置标题为当前词牌名称
            console.log("设置韵部选择器标题为当前词牌:", currentCipai);
            
            // 获取已存在的模态窗口标题元素
            const modalTitle = document.getElementById('rhymeModalTitle');
            if (modalTitle && currentCipai) {
                modalTitle.textContent = `${currentCipai}：選擇韻部`;
            }
            
            // 执行优化韵部选择器显示的函数
            optimizeRhymeModalDisplay();
            
            // 获取已存在的模态窗口
            let modal = document.getElementById('rhymeModal');
            
            // 如果模态窗口不存在，创建新窗口
            if (!modal) {
                console.log("创建新的韵部模态窗口");
                
                modal = document.createElement('div');
                modal.id = 'rhymeModal';
                modal.className = 'rhyme-modal';
                
                modal.innerHTML = `
                    <div class="rhyme-modal-content">
                        <div class="rhyme-modal-header">
                            <div class="rhyme-modal-title">選擇詩詞韻部</div>
                            <button id="rhymeModalClose" class="rhyme-modal-close">&times;</button>
                        </div>
                        
                        <div class="rhyme-modal-body">
                            <div class="rhyme-info-panel">
                                <div id="rhymeTypeInfo"></div>
                            </div>
                            
                            <div class="rhyme-cards-container" id="rhymeCardsContainer">
                                <!-- 韵部卡片将由JavaScript生成 -->
                            </div>
                            
                            <div class="rhyme-settings">
                                <label class="rhyme-toggle">
                                    <span class="rhyme-toggle-switch">
                                        <input type="checkbox" id="rhymeHintToggle" checked>
                                        <span class="rhyme-toggle-slider"></span>
                                    </span>
                                    顯示韻腳輔助提示字
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // 分析词谱中的韵脚类型
            const rhymeTypes = new Set();
            if (currentPoem && currentPoem.pattern) {
                currentPoem.pattern.forEach(line => {
                    if (line.rhyme && line.rhyme.length > 0) {
                        line.rhyme.forEach(charIndex => {
                            const tone = line.tones[charIndex];
                            if (tone === '△') rhymeTypes.add('ping');
                            if (tone === '▲') rhymeTypes.add('ze');
                        });
                    }
                });
            }
            
            // 更新韵部类型信息
            const rhymeTypeInfo = document.getElementById('rhymeTypeInfo');
            if (rhymeTypeInfo) {
                let typeText = "當前詞牌需要";
                if (rhymeTypes.has('ping') && rhymeTypes.has('ze')) {
                    typeText += "平聲韻和仄聲韻";
                } else if (rhymeTypes.has('ping')) {
                    typeText += "平聲韻";
                } else if (rhymeTypes.has('ze')) {
                    typeText += "仄聲韻";
                } else {
                    typeText += "未指定韻部";
                }
                rhymeTypeInfo.textContent = typeText;
            }
            
            // 渲染韵部卡片
            const cardsContainer = document.getElementById('rhymeCardsContainer');
            if (cardsContainer) {
                cardsContainer.innerHTML = '';
                
                // 创建韵部卡片
                Object.keys(rhymeDatabase).forEach(groupId => {
                    const group = rhymeDatabase[groupId];
                    
                    // 检查该韵部是否有需要的平仄字
                    let shouldShow = false;
                    if ((rhymeTypes.has('ping') && group.pingChars.length > 0) || 
                        (rhymeTypes.has('ze') && group.zeChars.length > 0)) {
                        shouldShow = true;
                    }
                    
                    if (shouldShow) {
                        const card = document.createElement('div');
                        card.className = 'rhyme-card';
                        if (userSelectedRhymeGroup == groupId) {
                            card.classList.add('selected');
                        }
                        
                        // 提取示例字符
                        const pingChars = group.pingChars.slice(0, 3).join('、');
                        const zeChars = group.zeChars.slice(0, 3).join('、');
                        
                        card.innerHTML = `
                            <div class="rhyme-card-name">${group.name}</div>
                            <div class="rhyme-card-desc">${group.description}</div>
                            <div class="rhyme-card-samples">
                                ${group.pingChars.length > 0 ? `<span class="rhyme-card-ping">平：${pingChars}</span>` : ''}
                                ${group.zeChars.length > 0 ? `<span class="rhyme-card-ze">仄：${zeChars}</span>` : ''}
                            </div>
                        `;
                        
                        // 添加点击事件
                        card.addEventListener('click', () => {
                            // 移除所有卡片的选中状态
                            document.querySelectorAll('.rhyme-card').forEach(c => {
                                c.classList.remove('selected');
                            });
                            
                            // 设置当前卡片为选中状态
                            card.classList.add('selected');
                            
                            // 保存选择的韵部
                            userSelectedRhymeGroup = groupId;
                            
                            // 应用选择的韵部
                            applyUserSelectedRhymeGroup();
                            
                            // 更新韵部按钮文本
                            updateRhymeButtonText();
                            
                            // 关闭模态窗口
                            closeRhymeModal();
                        });
                        
                        cardsContainer.appendChild(card);
                    }
                });
            }
            
            // 为关闭按钮添加事件
            const closeBtn = document.getElementById('rhymeModalClose');
            if (closeBtn) {
                closeBtn.onclick = closeRhymeModal;
            }
            
            // 为韵部提示开关添加事件
            const hintToggle = document.getElementById('rhymeHintToggle');
            if (hintToggle) {
                hintToggle.checked = window.showRhymeHints !== false; // 默认为true
                hintToggle.onchange = function() {
                    window.showRhymeHints = this.checked;
                };
            }
            
            // 优化韵部选择器显示
            optimizeRhymeModalDisplay();
            
            // 显示模态窗口
            modal.style.display = 'flex';
            return true;
        }
        
        // 完全覆盖原有的showRhymeModal函数，使其永远不会自动弹出
        window.showRhymeModal = function(isUserTriggered) {
            console.log("拦截showRhymeModal调用，isUserTriggered:", isUserTriggered);
            
            // 如果全局禁用了自动韵部模态窗口，则永远不自动弹出
            if (window.autoRhymeModalDisabled) {
                console.log("全局禁用了自动韵部模态窗口，拒绝显示");
                return false;
            }
            
            // 如果不是用户明确触发，则拒绝显示
            if (isUserTriggered !== true) {
                console.log("非用户触发的韵部模态窗口请求，拒绝显示");
                return false;
            }
            
            // 如果是用户触发，则调用新的直接显示函数
            return directShowRhymeModal(true, true);
        };
        
        // 完全禁用自动调用showRhymeGroupSelector
        window.showRhymeGroupSelector = function() {
            console.log("拦截showRhymeGroupSelector调用，该函数已被禁用");
            // 只更新按钮文本，不做其他任何操作
            updateRhymeButtonText();
            return false;
        };
        
        // 添加辅助函数来设置韵部选择器标题和优化韵部卡片显示
        function enhanceRhymeModalDisplay() {
            // 1. 设置标题为当前词牌名称
            const modalTitle = document.getElementById('rhymeModalTitle');
            if (modalTitle && currentCipai) {
                modalTitle.textContent = `${currentCipai}：選擇韻部`;
            }
            
            // 2. 分析当前词牌需要的韵脚类型
            const rhymeTypes = new Set();
            if (currentPoem && currentPoem.pattern) {
                currentPoem.pattern.forEach(line => {
                    if (line.rhyme && line.rhyme.length > 0) {
                        line.rhyme.forEach(charIndex => {
                            const tone = line.tones[charIndex];
                            if (tone === '△') rhymeTypes.add('ping');
                            if (tone === '▲') rhymeTypes.add('ze');
                        });
                    }
                });
            }
            
            // 3. 优化韵部卡片显示
            const rhymeCards = document.querySelectorAll('.rhyme-card');
            rhymeCards.forEach(card => {
                const groupId = card.dataset.groupId;
                if (groupId && rhymeDatabase[groupId]) {
                    const group = rhymeDatabase[groupId];
                    
                    // 确定要显示哪些类型的韵脚字
                    let showPing = rhymeTypes.has('ping');
                    let showZe = rhymeTypes.has('ze');
                    
                    // 如果都没有指定，则都显示
                    if (!showPing && !showZe) {
                        showPing = true;
                        showZe = true;
                    }
                    
                    // 获取样本容器
                    const samplesContainer = card.querySelector('.rhyme-card-samples');
                    if (samplesContainer) {
                        samplesContainer.innerHTML = '';
                        
                        // 显示平声韵脚字
                        if (showPing && group.pingChars.length > 0) {
                            const pingChars = group.pingChars.slice(0, 6).join('、') + (group.pingChars.length > 6 ? '...' : '');
                            const pingSpan = document.createElement('span');
                            pingSpan.className = 'rhyme-card-ping';
                            pingSpan.textContent = `平：${pingChars}`;
                            samplesContainer.appendChild(pingSpan);
                        }
                        
                        // 显示仄声韵脚字
                        if (showZe && group.zeChars.length > 0) {
                            const zeChars = group.zeChars.slice(0, 6).join('、') + (group.zeChars.length > 6 ? '...' : '');
                            const zeSpan = document.createElement('span');
                            zeSpan.className = 'rhyme-card-ze';
                            zeSpan.textContent = `仄：${zeChars}`;
                            samplesContainer.appendChild(zeSpan);
                        }
                    }
                }
            });
        }
        
        // 更新韵部选择按钮文本
        function updateRhymeButtonText() {
            const button = document.getElementById('rhymeSelectButton');
            if (!button) return;
            
            if (userSelectedRhymeGroup && rhymeDatabase[userSelectedRhymeGroup]) {
                const groupName = rhymeDatabase[userSelectedRhymeGroup].name;
                button.innerHTML = `
                    <span class="music-icon">🎵</span>
                    已選：${groupName}
                `;
                button.classList.add('selected');
            } else {
                button.innerHTML = `
                    <span class="music-icon">🎵</span>
                    選擇韻部
                `;
                button.classList.remove('selected');
            }
        }
        
        // 基於詞庫和欽定詞譜的詞牌格律數據
        const cipaiPatterns = {
            "菩薩蠻": {
                totalChars: 44,
                breakpoint: 4,  // 表示第4行之前是上闕，從第4行開始是下闕
                versions: {
                    "溫庭筠": {
                        author: "溫庭筠",
                        content: "小山重疊金明滅，鬢雲欲度香腮雪。懶起畫蛾眉，弄妝梳洗遲。照花前後鏡，花面交相映。新帖繡羅襦，雙雙金鷓鴣。",
                        pattern: [
                            { text: "小山重疊金明滅", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "鬢雲欲度香腮雪", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "懶起畫蛾眉", tones: "⊙●●○△", rhyme: [4] },
                            { text: "弄妝梳洗遲", tones: "⊙○○●△", rhyme: [4] },
                            { text: "照花前後鏡", tones: "⊙○○●▲", rhyme: [4] },
                            { text: "花面交相映", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "新帖繡羅襦", tones: "⊙●●○△", rhyme: [4] },
                            { text: "雙雙金鷓鴣", tones: "⊙○○●△", rhyme: [4] }
                        ]
                    },
                    "李白": {
                        author: "李白",
                        content: "平林漠漠煙如織，寒山一帶傷心碧。暝色入高樓，有人樓上愁。玉階空佇立，宿鳥歸飛急。何處是歸程？長亭更短亭。",
                        pattern: [
                            { text: "平林漠漠煙如織", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "寒山一帶傷心碧", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "暝色入高樓", tones: "⊙●⊙○△", rhyme: [4] },
                            { text: "有人樓上愁", tones: "⊙○○●△", rhyme: [4] },
                            { text: "玉階空佇立", tones: "⊙○○●▲", rhyme: [4] },
                            { text: "宿鳥歸飛急", tones: "⊙●⊙○▲", rhyme: [4] },
                            { text: "何處是歸程", tones: "⊙●●○△", rhyme: [4] },
                            { text: "長亭更短亭", tones: "⊙○⊙●△", rhyme: [4] }
                        ]
                    }
                }
            },
            "憶秦娥": {
                totalChars: 35,
                breakpoint: 5,  // 表示第5行之前是上闕，從第5行開始是下闕
                versions: {
                    "李白": {
                        author: "李白",
                        content: "簫聲咽，秦娥夢斷秦樓月。秦樓月，年年柳色，灞陵傷別。樂游原上清秋節，咸陽古道音塵絕。音塵絕，西風殘照，漢家陵闕。",
                        pattern: [
                            { text: "簫聲咽", tones: "○⊙▲", rhyme: [2] },
                            { text: "秦娥夢斷秦樓月", tones: "○○⊙●○○▲", rhyme: [6] },
                            { text: "秦樓月", tones: "○○▲", rhyme: [2] },
                            { text: "年年柳色", tones: "⊙○⊙●", rhyme: [] },
                            { text: "灞陵傷別", tones: "●○○▲", rhyme: [3] },
                            { text: "樂游原上清秋節", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "咸陽古道音塵絕", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "音塵絕", tones: "○○▲", rhyme: [2] },
                            { text: "西風殘照", tones: "⊙○⊙●", rhyme: [] },
                            { text: "漢家陵闕", tones: "●○○▲", rhyme: [3] }
                        ]
                    }
                }
            },
            "相見歡": {
                totalChars: 36,
                breakpoint: 3,
                versions: {
                    "李煜": {
                        author: "李煜",
                        content: "無言獨上西樓，月如鉤，寂寞梧桐深院鎖清秋。剪不斷，理還亂，是離愁。別是一番滋味在心頭。",
                        pattern: [
                            { text: "無言獨上西樓", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "月如鉤", tones: "●○△", rhyme: [2] },
                            { text: "寂寞梧桐深院鎖清秋", tones: "⊙●⊙○○●●○△", rhyme: [8] },
                            { text: "剪不斷", tones: "●⊙▲", rhyme: [2] },
                            { text: "理還亂", tones: "⊙○▲", rhyme: [2] },
                            { text: "是離愁", tones: "●○△", rhyme: [2] },
                            { text: "別是一番滋味在心頭", tones: "⊙●⊙○○●●○△", rhyme: [8] }
                        ]
                    },
                    "李煜2": {
                        author: "李煜",
                        content: "林花謝了春紅，太匆匆。無奈朝來寒雨、晚來風。胭脂淚，相留醉，几時重。自是人生長恨、水長東。",
                        pattern: [
                            { text: "林花謝了春紅", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "太匆匆", tones: "●○△", rhyme: [2] },
                            { text: "無奈朝來寒雨、晚來風", tones: "⊙●⊙○○●⊙●○△", rhyme: [9] },
                            { text: "胭脂淚", tones: "⊙⊙▲", rhyme: [2] },
                            { text: "相留醉", tones: "⊙○▲", rhyme: [2] },
                            { text: "几時重", tones: "●○△", rhyme: [2] },
                            { text: "自是人生長恨、水長東", tones: "⊙●⊙○○●⊙●○△", rhyme: [9] }
                        ]
                    }
                }
            },
            "烏夜啼": {
                totalChars: 47,
                breakpoint: 4,
                versions: {
                    "李煜1": {
                        author: "李煜",
                        content: "昨夜風兼雨，簾幃颯颯秋聲。燭殘漏斷頻欹枕，起坐不能平。世事漫隨流水，算來一夢浮生。醉鄉路穩宜頻到，此外不堪行。",
                        pattern: [
                            { text: "昨夜風兼雨", tones: "●●○○●", rhyme: [] },
                            { text: "簾幃颯颯秋聲", tones: "⊙○●●○△", rhyme: [5] },
                            { text: "燭殘漏斷頻欹枕", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "起坐不能平", tones: "⊙●●○△", rhyme: [4] },
                            { text: "世事漫隨流水", tones: "⊙●⊙○⊙●", rhyme: [] },
                            { text: "算來一夢浮生", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "醉鄉路穩宜頻到", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "此外不堪行", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    }
                }
            },
            "浣溪沙": {
                totalChars: 36,
                breakpoint: 3,  // 上闕3行，下闕3行
                versions: {
                    "晏殊1": {
                        author: "晏殊",
                        content: "一曲新詞酒一杯。去年天氣舊池臺。夕陽西下幾時回？無可奈何花落去，似曾相識燕歸來。小園香徑獨徘徊。",
                        pattern: [
                            { text: "一曲新詞酒一杯", tones: "●●○○●●△", rhyme: [6] },
                            { text: "去年天氣舊池臺", tones: "●○○●●○△", rhyme: [6] },
                            { text: "夕陽西下幾時回", tones: "●○○●●○△", rhyme: [6] },
                            { text: "無可奈何花落去", tones: "⊙●●○○●●", rhyme: [] },
                            { text: "似曾相識燕歸來", tones: "●○○●●○△", rhyme: [6] },
                            { text: "小園香徑獨徘徊", tones: "●○○●●○△", rhyme: [6] }
                        ]
                    },
                    "晏殊2": {
                        author: "晏殊",
                        content: "一向年光有限身。等閒離別易消魂。酒筵歌席莫辭頻。滿目山河空念遠，落花風雨更傷春。不如憐取眼前人。",
                        pattern: [
                            { text: "一向年光有限身", tones: "●●○○●●△", rhyme: [6] },
                            { text: "等閒離別易消魂", tones: "●○○●●○△", rhyme: [6] },
                            { text: "酒筵歌席莫辭頻", tones: "●○○●●○△", rhyme: [6] },
                            { text: "滿目山河空念遠", tones: "●●○○○●●", rhyme: [] },
                            { text: "落花風雨更傷春", tones: "●○○●●○△", rhyme: [6] },
                            { text: "不如憐取眼前人", tones: "●○○●●○△", rhyme: [6] }
                        ]
                    },
                    "秦觀": {
                        author: "秦觀",
                        content: "漠漠輕寒上小樓。曉陰無賴似窮秋。淡煙流水畫屏幽。自在飛花輕似夢，無邊絲雨細如愁。寶簾閑掛小銀鉤。",
                        pattern: [
                            { text: "漠漠輕寒上小樓", tones: "●●○○●●△", rhyme: [6] },
                            { text: "曉陰無賴似窮秋", tones: "●○○●●○△", rhyme: [6] },
                            { text: "淡煙流水畫屏幽", tones: "●○○●●○△", rhyme: [6] },
                            { text: "自在飛花輕似夢", tones: "●●○○○●●", rhyme: [] },
                            { text: "無邊絲雨細如愁", tones: "○○○●●○△", rhyme: [6] },
                            { text: "寶簾閑掛小銀鉤", tones: "●○○●●○△", rhyme: [6] }
                        ]
                    }
                }
            },
            "如夢令": {
                totalChars: 33,
                versions: {
                    "李清照1": {
                        author: "李清照",
                        content: "常記溪亭日暮。沉醉不知歸路。興盡晚回舟，誤入藕花深處。爭渡。爭渡。驚起一灘鷗鷺。",
                        pattern: [
                            { text: "常記溪亭日暮", tones: "⊙●○○●▲", rhyme: [5] },
                            { text: "沉醉不知歸路", tones: "○●●○○▲", rhyme: [5] },
                            { text: "興盡晚回舟", tones: "●●●○○", rhyme: [] },
                            { text: "誤入藕花深處", tones: "●●●○○▲", rhyme: [5] },
                            { text: "爭渡", tones: "○▲", rhyme: [1] },
                            { text: "爭渡", tones: "○▲", rhyme: [1] },
                            { text: "驚起一灘鷗鷺", tones: "○●●○○▲", rhyme: [5] }
                        ]
                    },
                    "李清照2": {
                        author: "李清照",
                        content: "昨夜雨疏風驟。濃睡不消殘酒。試問卷帘人，卻道海棠依舊。知否？知否？應是綠肥紅瘦。",
                        pattern: [
                            { text: "昨夜雨疏風驟", tones: "●●●○○▲", rhyme: [5] },
                            { text: "濃睡不消殘酒", tones: "○●●○○▲", rhyme: [5] },
                            { text: "試問卷帘人", tones: "●●●○○", rhyme: [] },
                            { text: "卻道海棠依舊", tones: "●●●○○▲", rhyme: [5] },
                            { text: "知否", tones: "○▲", rhyme: [1] },
                            { text: "知否", tones: "○▲", rhyme: [1] },
                            { text: "應是綠肥紅瘦", tones: "●●●○○▲", rhyme: [5] }
                        ]
                    }
                }
            },
            "清平樂": {
                totalChars: 46,
                breakpoint: 4,
                versions: {
                    "李煜": {
                        author: "李煜",
                        content: "別來春半，觸目柔腸斷。砌下落梅如雪亂，拂了一身還滿。雁來音信無憑，路遙歸夢難成。離恨恰如春草，更行更遠還生。",
                        pattern: [
                            { text: "別來春半", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "觸目柔腸斷", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "砌下落梅如雪亂", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "拂了一身還滿", tones: "⊙●⊙○⊙▲", rhyme: [5] },
                            { text: "雁來音信無憑", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "路遙歸夢難成", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "離恨恰如春草", tones: "⊙●⊙○⊙●", rhyme: [] },
                            { text: "更行更遠還生", tones: "⊙○⊙●○△", rhyme: [5] }
                        ]
                    }
                }
            },
            "玉樓春": {
                totalChars: 56,
                versions: {
                    "李煜": {
                        author: "李煜",
                        content: "晚妝初了明肌雪，春殿嬪娥魚貫列。鳳簫吹斷水云間，重按霓裳歌遍徹。臨風誰更飄香屑，醉拍闌干情味切。歸時休放燭花紅，待踏馬蹄清夜月。",
                        pattern: [
                            { text: "晚妝初了明肌雪", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "春殿嬪娥魚貫列", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "鳳簫吹斷水云間", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "重按霓裳歌遍徹", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "臨風誰更飄香屑", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "醉拍闌干情味切", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "歸時休放燭花紅", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "待踏馬蹄清夜月", tones: "⊙●⊙○○●▲", rhyme: [6] }
                        ]
                    }
                },
                breakpoint: 4
            },
            "拋球樂": {
                totalChars: 40,
                versions: {
                    "敦煌曲子": {
                        author: "敦煌曲子",
                        content: "珠淚紛紛濕綺羅。少年公子負恩多。當初姊妹分明道，莫把真心過於他。子細思量著，淡薄知聞解好麼？",
                        pattern: [
                            { text: "珠淚紛紛濕綺羅", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "少年公子負恩多", tones: "⊙○○●●○△", rhyme: [6] },
                            { text: "當初姊妹分明道", tones: "⊙○⊙●⊙○●", rhyme: [] },
                            { text: "莫把真心過於他", tones: "⊙●⊙○⊙●△", rhyme: [6] },
                            { text: "子細思量著", tones: "⊙●○○●", rhyme: [] },
                            { text: "淡薄知聞解好麼", tones: "⊙●○○⊙●△", rhyme: [6] }
                        ]
                    }
                }
            },
            "望江南": {
                totalChars: 27,
                versions: {
                    "敦煌曲子": {
                        author: "敦煌曲子",
                        content: "莫攀我，攀我太心偏。我是曲江臨池柳，者人折了那人攀。恩愛一時間。",
                        pattern: [
                            { text: "莫攀我", tones: "○⊙●", rhyme: [] },
                            { text: "攀我太心偏", tones: "⊙●●○△", rhyme: [4] },
                            { text: "我是曲江臨池柳", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "者人折了那人攀", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "恩愛一時間", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    }
                }
            },
            "破陣子": {
                totalChars: 62,
                breakpoint: 5,
                versions: {
                    "李煜": {
                        author: "李煜",
                        content: "四十年來家國，三千里地山河。鳳閣龍樓連霄漢，玉樹瓊枝作煙蘿。幾曾識干戈？一旦歸為臣虜，沈腰潘鬢消磨。最是倉惶辭廟日，教坊猶奏別離歌。垂淚對宮娥。",
                        pattern: [
                            { text: "四十年來家國", tones: "●●○○⊙●", rhyme: [] },
                            { text: "三千里地山河", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "鳳閣龍樓連霄漢", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "玉樹瓊枝作煙蘿", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "幾曾識干戈", tones: "⊙○⊙●△", rhyme: [4] },
                            { text: "一旦歸為臣虜", tones: "●●○○⊙●", rhyme: [] },
                            { text: "沈腰潘鬢消磨", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "最是倉惶辭廟日", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "教坊猶奏別離歌", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "垂淚對宮娥", tones: "⊙○⊙●△", rhyme: [4] }
                        ]
                    }
                }
            },
            "河傳": {
                totalChars: 54,
                breakpoint: 7,
                versions: {
                    "辛棄疾": {
                        author: "辛棄疾",
                        content: "春水千里孤舟浪起夢攜西子覺來村巷夕陽斜幾家短牆紅杏花晚雲做造些兒雨折花去岸上誰家女太狂顛笑那邊柳綿被風吹上天",
                        pattern: [
                            { text: "春水", tones: "○▲", rhyme: [1] },
                            { text: "千里", tones: "○▲", rhyme: [1] },
                            { text: "孤舟浪起", tones: "○○●▲", rhyme: [3] },
                            { text: "夢攜西子", tones: "●○○▲", rhyme: [3] },
                            { text: "覺來村巷夕陽斜", tones: "●○○●●○△", rhyme: [6] },
                            { text: "幾家", tones: "●△", rhyme: [1] },
                            { text: "短牆紅杏花", tones: "●○○●△", rhyme: [4] },
                            { text: "晚雲做造些兒雨", tones: "●○●●○○▲", rhyme: [6] },
                            { text: "折花去", tones: "●○▲", rhyme: [2] },
                            { text: "岸上誰家女", tones: "●●○○▲", rhyme: [4] },
                            { text: "太狂顛", tones: "●○△", rhyme: [2] },
                            { text: "笑那邊", tones: "●●△", rhyme: [2] },
                            { text: "柳綿", tones: "●△", rhyme: [1] },
                            { text: "被風吹上天", tones: "●○○●△", rhyme: [4] }
                        ]
                    }
                }
            },
            "浪淘沙": {
                totalChars: 54,
                breakpoint: 5,
                versions: {
                    "李煜": {
                        author: "李煜",
                        content: "簾外雨潺潺，春意闌珊。羅衾不耐五更寒。夢裡不知身是客，一晌貪歡。獨自莫憑欄，無限江山。別時容易見時難。流水落花春去也，天上人間。",
                        pattern: [
                            { text: "簾外雨潺潺", tones: "⊙●●○△", rhyme: [4] },
                            { text: "春意闌珊", tones: "⊙●○△", rhyme: [3] },
                            { text: "羅衾不耐五更寒", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "夢裡不知身是客", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "一晌貪歡", tones: "⊙●○△", rhyme: [3] },
                            { text: "獨自莫憑欄", tones: "⊙●●○△", rhyme: [4] },
                            { text: "無限江山", tones: "⊙●○△", rhyme: [3] },
                            { text: "別時容易見時難", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "流水落花春去也", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "天上人間", tones: "⊙●○△", rhyme: [3] }
                        ]
                    }
                }
            },
            "虞美人": {
                totalChars: 56,
                breakpoint: 5,  // 上闕5行，下闕5行
                versions: {
                    "李煜": {
                        author: "李煜",
                        content: "春花秋月何時了，往事知多少。小樓昨夜又東風，故國不堪回首、月明中。雕闌玉砌應猶在，只是朱顏改。問君能有幾多愁，恰似一江春水、向東流。",
                        pattern: [
                            { text: "春花秋月何時了", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "往事知多少", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "小樓昨夜又東風", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "故國不堪回首", tones: "⊙●⊙○○●", rhyme: [] },
                            { text: "月明中", tones: "●○△", rhyme: [2] },
                            { text: "雕闌玉砌應猶在", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "只是朱顏改", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "問君能有幾多愁", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "恰似一江春水", tones: "⊙●⊙○○●", rhyme: [] },
                            { text: "向東流", tones: "●○△", rhyme: [2] }
                        ]
                    }
                }
            },
            "蝶戀花": {
                totalChars: 60,
                breakpoint: 5,  // 上闕5行，下闕5行
                versions: {
                    "歐陽修": {
                        author: "歐陽修",
                        content: "庭院深深深幾許？楊柳堆煙，簾幕無重數。玉勒雕鞍遊冶處。樓高不見章臺路。雨橫風狂三月暮。門掩黃昏，無計留春住。淚眼問花花不語。亂紅飛過鞦韆去。",
                        pattern: [
                            { text: "庭院深深深幾許", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "楊柳堆煙", tones: "⊙●○○", rhyme: [] },
                            { text: "簾幕無重數", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "玉勒雕鞍遊冶處", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "樓高不見章臺路", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "雨橫風狂三月暮", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "門掩黃昏", tones: "⊙●○○", rhyme: [] },
                            { text: "無計留春住", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "淚眼問花花不語", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "亂紅飛過鞦韆去", tones: "⊙○⊙●○○▲", rhyme: [6] }
                        ]
                    },
                    "蘇軾": {
                        author: "蘇軾",
                        content: "花褪殘紅青杏小。燕子飛時，綠水人家繞。枝上柳綿吹又少。天涯何處無芳草。牆裡鞦韆牆外道。牆外行人，牆裡佳人笑。笑漸不聞聲漸悄。多情卻被無情惱。",
                        pattern: [
                            { text: "花褪殘紅青杏小", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "燕子飛時", tones: "⊙●○○", rhyme: [] },
                            { text: "綠水人家繞", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "枝上柳綿吹又少", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "天涯何處無芳草", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "牆裡鞦韆牆外道", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "牆外行人", tones: "⊙●○○", rhyme: [] },
                            { text: "牆裡佳人笑", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "笑漸不聞聲漸悄", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "多情卻被無情惱", tones: "⊙○⊙●○○▲", rhyme: [6] }
                        ]
                    },
                    "蘇軾": {
                        author: "蘇軾",
                        content: "花褪殘紅青杏小。燕子飛時，綠水人家繞。枝上柳綿吹又少。天涯何處無芳草。牆裡鞦韆牆外道。牆外行人，牆裡佳人笑。笑漸不聞聲漸悄。多情卻被無情惱。",
                        pattern: [
                            { text: "花褪殘紅青杏小", tones: "○●○○○●▲", rhyme: [6] },
                            { text: "燕子飛時", tones: "●●○△", rhyme: [3] },
                            { text: "綠水人家繞", tones: "●●○○▲", rhyme: [4] },
                            { text: "枝上柳綿吹又少", tones: "○●●○○○▲", rhyme: [6] },
                            { text: "天涯何處無芳草", tones: "○○○●○○▲", rhyme: [6] },
                            { text: "牆裡鞦韆牆外道", tones: "○●○○○●▲", rhyme: [6] },
                            { text: "牆外行人", tones: "○●○△", rhyme: [3] },
                            { text: "牆裡佳人笑", tones: "○●○○▲", rhyme: [4] },
                            { text: "笑漸不聞聲漸悄", tones: "●●●○○●▲", rhyme: [6] },
                            { text: "多情卻被無情惱", tones: "○○●●○○▲", rhyme: [6] }
                        ]
                    }
                }
            },
            "鷓鴣天": {
                totalChars: 55,
                breakpoint: 4,
                versions: {
                    "晏幾道": {
                        author: "晏幾道",
                        content: "彩袖殷勤捧玉鐘，當年拚卻醉顏紅。舞低楊柳樓心月，歌盡桃花扇底風。從別后，憶相逢。幾回魂夢與君同。今宵剩把銀釭照，猶恐相逢是夢中。",
                        pattern: [
                            { text: "彩袖殷勤捧玉鐘", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "當年拚卻醉顏紅", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "舞低楊柳樓心月", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "歌盡桃花扇底風", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "從別后", tones: "○●●", rhyme: [] },
                            { text: "憶相逢", tones: "●○△", rhyme: [2] },
                            { text: "幾回魂夢與君同", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "今宵剩把銀釭照", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "猶恐相逢是夢中", tones: "⊙●○○⊙●△", rhyme: [6] }
                        ]
                    },
                    "李清照": {
                        author: "李清照",
                        content: "暗淡輕黃體性柔。情疏跡遠只香留。何須淺碧深紅色，自是花中第一流。梅定妒，菊應羞。畫闌開處冠中秋。騷人可煞無情思，何事當年不見收？",
                        pattern: [
                            { text: "暗淡輕黃體性柔", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "情疏跡遠只香留", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "何須淺碧深紅色", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "自是花中第一流", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "梅定妒", tones: "○●●", rhyme: [] },
                            { text: "菊應羞", tones: "●○△", rhyme: [2] },
                            { text: "畫闌開處冠中秋", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "騷人可煞無情思", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "何事當年不見收", tones: "⊙●○○⊙●△", rhyme: [6] }
                        ]
                    },
                    "姜夔": {
                        author: "姜夔",
                        content: "肥水東流無盡期。當初不合種相思。夢中未比丹青見，暗裡忽驚山鳥啼。春未綠，鬢先絲。人間別久不成悲。誰教歲歲紅蓮夜，兩處沈吟各自知。",
                        pattern: [
                            { text: "肥水東流無盡期", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "當初不合種相思", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "夢中未比丹青見", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "暗裡忽驚山鳥啼", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "春未綠", tones: "○●●", rhyme: [] },
                            { text: "鬢先絲", tones: "●○△", rhyme: [2] },
                            { text: "人間別久不成悲", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "誰教歲歲紅蓮夜", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "兩處沈吟各自知", tones: "⊙●○○⊙●△", rhyme: [6] }
                        ]
                    }
                }
            },
            "臨江仙": {
                totalChars: 58,
                breakpoint: 5,
                multipleChars: true,
                allChars: [58, 60],
                versions: {
                    "晏幾道": {
                        author: "晏幾道",
                        content: "夢後樓臺高鎖，酒醒簾幕低垂。去年春恨卻來時。落花人獨立，微雨燕雙飛。記得小蘋初見，兩重心字羅衣。琵琶弦上說相思。當時明月在，曾照彩雲歸。",
                        pattern: [
                            { text: "夢後樓臺高鎖", tones: "⊙●⊙○○●", rhyme: [] },
                            { text: "酒醒簾幕低垂", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "去年春恨卻來時", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "落花人獨立", tones: "⊙○○●●", rhyme: [] },
                            { text: "微雨燕雙飛", tones: "⊙●●○△", rhyme: [4] },
                            { text: "記得小蘋初見", tones: "⊙●⊙○○●", rhyme: [] },
                            { text: "兩重心字羅衣", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "琵琶弦上說相思", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "當時明月在", tones: "⊙○○●●", rhyme: [] },
                            { text: "曾照彩雲歸", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    },
                    "李清照": {
                        author: "李清照",
                        content: "庭院深深深几許，云窗霧閣常扃。柳梢梅萼漸分明。春歸秣陵樹，人老建康城。感月吟風多少事，如今老去無成。誰怜憔悴更雕零。試燈無意思，踏雪沒心情。",
                        pattern: [
                            { text: "庭院深深深几許", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "云窗霧閣常扃", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "柳梢梅萼漸分明", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "春歸秣陵樹", tones: "⊙○○●●", rhyme: [] },
                            { text: "人老建康城", tones: "⊙●●○△", rhyme: [4] },
                            { text: "感月吟風多少事", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "如今老去無成", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "誰怜憔悴更雕零", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "試燈無意思", tones: "⊙○○●●", rhyme: [] },
                            { text: "踏雪沒心情", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    },
                    "蘇軾": {
                        author: "蘇軾",
                        content: "夜飲東坡醒復醉，歸來仿佛三更。家童鼻息已雷鳴。敲門都不應，倚杖聽江聲。長恨此身非我有，何時忘卻營營。夜闌風靜縠紋平。小舟從此逝，江海寄餘生。",
                        pattern: [
                            { text: "夜飲東坡醒復醉", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "歸來仿佛三更", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "家童鼻息已雷鳴", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "敲門都不應", tones: "⊙○○●●", rhyme: [] },
                            { text: "倚杖聽江聲", tones: "⊙●●○△", rhyme: [4] },
                            { text: "長恨此身非我有", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "何時忘卻營營", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "夜闌風靜縠紋平", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "小舟從此逝", tones: "⊙○○●●", rhyme: [] },
                            { text: "江海寄餘生", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    }
                }
            },
            "點絳唇": {
                totalChars: 40,
                breakpoint: 4,
                versions: {
                    "李清照": {
                        author: "李清照",
                        content: "蹴罷秋千，起來慵整纖纖手。露濃花瘦，薄汗輕衣透。見有人來，襪剗金釵溜。和羞走，倚門回首，卻把青梅嗅。",
                        pattern: [
                            { text: "蹴罷秋千", tones: "⊙●○△", rhyme: [3] },
                            { text: "起來慵整纖纖手", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "露濃花瘦", tones: "●○○▲", rhyme: [3] },
                            { text: "薄汗輕衣透", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "見有人來", tones: "⊙●○△", rhyme: [3] },
                            { text: "襪剗金釵溜", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "和羞走", tones: "○⊙▲", rhyme: [2] },
                            { text: "倚門回首", tones: "●○○▲", rhyme: [3] },
                            { text: "卻把青梅嗅", tones: "⊙●○○▲", rhyme: [4] }
                        ]
                    }
                }
            },
            "減字木蘭花": {
                totalChars: 44,
                breakpoint: 4,  // 表示第4行之前是上闕，從第4行開始是下闕
                versions: {
                    "李清照": {
                        author: "李清照",
                        content: "賣花擔上，買得一枝春欲放。淚染輕勻，猶帶彤霞曉露痕。怕郎猜道，奴面不如花面好。云鬢斜簪，徒要教郎比并看。",
                        pattern: [
                            { text: "賣花擔上", tones: "●○○▲", rhyme: [3] },
                            { text: "買得一枝春欲放", tones: "●●●○○●▲", rhyme: [6] },
                            { text: "淚染輕勻", tones: "●●○△", rhyme: [3] },
                            { text: "猶帶彤霞曉露痕", tones: "○●○○●●△", rhyme: [6] },
                            { text: "怕郎猜道", tones: "●○○▲", rhyme: [3] },
                            { text: "奴面不如花面好", tones: "○●●○○●▲", rhyme: [6] },
                            { text: "云鬢斜簪", tones: "○●○△", rhyme: [3] },
                            { text: "徒要教郎比并看", tones: "○●○○●●△", rhyme: [6] }
                        ]
                    }
                }
            },
            "釵頭鳳": {
                totalChars: 60,
                breakpoint: 10,
                versions: {
                    "陸游": {
                        author: "陸游",
                        content: "紅酥手黃滕酒滿城春色宮牆柳東風惡歡情薄一懷愁緒幾年離索錯錯錯春如舊人空瘦淚痕紅浥鮫綃透桃花落閑池閣山盟雖在錦書難托莫莫莫",
                        pattern: [
                            { text: "紅酥手", tones: "○○▲", rhyme: [2] },
                            { text: "黃滕酒", tones: "○○▲", rhyme: [2] },
                            { text: "滿城春色宮牆柳", tones: "●○○●○○▲", rhyme: [6] },
                            { text: "東風惡", tones: "○○▲", rhyme: [2] },
                            { text: "歡情薄", tones: "○○▲", rhyme: [2] },
                            { text: "一懷愁緒", tones: "⊙○○●", rhyme: [] },
                            { text: "幾年離索", tones: "●○○▲", rhyme: [3] },
                            { text: "錯", tones: "▲", rhyme: [0] },
                            { text: "錯", tones: "▲", rhyme: [0] },
                            { text: "錯", tones: "▲", rhyme: [0] },
                            { text: "春如舊", tones: "○○▲", rhyme: [2] },
                            { text: "人空瘦", tones: "○○▲", rhyme: [2] },
                            { text: "淚痕紅浥鮫綃透", tones: "●○○●○○▲", rhyme: [6] },
                            { text: "桃花落", tones: "○○▲", rhyme: [2] },
                            { text: "閑池閣", tones: "○○▲", rhyme: [2] },
                            { text: "山盟雖在", tones: "⊙○○●", rhyme: [] },
                            { text: "錦書難托", tones: "●○○▲", rhyme: [3] },
                            { text: "莫", tones: "▲", rhyme: [0] },
                            { text: "莫", tones: "▲", rhyme: [0] },
                            { text: "莫", tones: "▲", rhyme: [0] }
                        ]
                    }
                }
            },
            "一剪梅": {
                totalChars: 60,
                breakpoint: 6,
                versions: {
                    "李清照": {
                        author: "李清照",
                        content: "紅藕香殘玉簟秋。輕解羅裳，獨上蘭舟。雲中誰寄錦書來？雁字回時，月滿西樓。花自飄零水自流，一種相思，兩處閒愁。此情無計可消除，才下眉頭，卻上心頭。",
                        pattern: [
                            { text: "紅藕香殘玉簟秋", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "輕解羅裳", tones: "⊙●○○", rhyme: [] },
                            { text: "獨上蘭舟", tones: "⊙●○△", rhyme: [3] },
                            { text: "雲中誰寄錦書來", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "雁字回時", tones: "⊙●○○", rhyme: [] },
                            { text: "月滿西樓", tones: "⊙●○△", rhyme: [3] },
                            { text: "花自飄零水自流", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "一種相思", tones: "⊙●○○", rhyme: [] },
                            { text: "兩處閒愁", tones: "⊙●○△", rhyme: [3] },
                            { text: "此情無計可消除", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "才下眉頭", tones: "⊙●○○", rhyme: [] },
                            { text: "卻上心頭", tones: "⊙●○△", rhyme: [3] }
                        ]
                    }
                }
            },
            "漁家傲": {
                totalChars: 62,
                breakpoint: 5,
                versions: {
                    "李清照": {
                        author: "李清照",
                        content: "天接雲濤連曉霧。星河欲轉千帆舞。彷彿夢魂歸帝所。聞天語。殷勤問我歸何處。我報路長嗟日暮。學詩謾有驚人句。九萬里風鵬正舉。風休住。蓬舟吹取三山去。",
                        pattern: [
                            { text: "天接雲濤連曉霧", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "星河欲轉千帆舞", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "彷彿夢魂歸帝所", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "聞天語", tones: "○⊙▲", rhyme: [2] },
                            { text: "殷勤問我歸何處", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "我報路長嗟日暮", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "學詩謾有驚人句", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "九萬里風鵬正舉", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "風休住", tones: "○⊙▲", rhyme: [2] },
                            { text: "蓬舟吹取三山去", tones: "⊙○⊙●○○▲", rhyme: [6] }
                        ]
                    }
                }
            },
            "聲聲慢": {
                totalChars: 97,
                breakpoint: 11,
                versions: {
                    "李清照": {
                        author: "李清照",
                        content: "尋尋覓覓，冷冷清清，淒淒慘慘戚戚。乍暖還寒時候，最難將息。三杯兩盞淡酒，怎敵他、晚來風急。雁過也，正傷心，卻是舊時相識。滿地黃花堆積，憔悴損、如今有誰堪摘。守著窗兒，獨自怎生得黑？梧桐更兼細雨，到黃昏、點點滴滴。這次第，怎一個、愁字了得。",
                        pattern: [
                            { text: "尋尋覓覓", tones: "○○●▲", rhyme: [3] },
                            { text: "冷冷清清", tones: "●●○○", rhyme: [] },
                            { text: "淒淒慘慘戚戚", tones: "○○●●●▲", rhyme: [5] },
                            { text: "乍暖還寒時候", tones: "●●○○○●", rhyme: [] },
                            { text: "最難將息", tones: "●○○▲", rhyme: [3] },
                            { text: "三杯兩盞淡酒", tones: "○○●●●●", rhyme: [] },
                            { text: "怎敵他", tones: "●●○", rhyme: [] },
                            { text: "晚來風急", tones: "●○○▲", rhyme: [3] },
                            { text: "雁過也", tones: "●●●", rhyme: [] },
                            { text: "正傷心", tones: "●○○", rhyme: [] },
                            { text: "卻是舊時相識", tones: "●●●○○▲", rhyme: [5] },
                            { text: "滿地黃花堆積", tones: "●●○○○▲", rhyme: [5] },
                            { text: "憔悴損", tones: "○●●", rhyme: [] },
                            { text: "如今有誰堪摘", tones: "○○●○○▲", rhyme: [5] },
                            { text: "守著窗兒", tones: "●●○○", rhyme: [] },
                            { text: "獨自怎生得黑", tones: "●●●○●▲", rhyme: [5] },
                            { text: "梧桐更兼細雨", tones: "○○●○●●", rhyme: [] },
                            { text: "到黃昏", tones: "●○○", rhyme: [] },
                            { text: "點點滴滴", tones: "●●●▲", rhyme: [3] },
                            { text: "這次第", tones: "●●●", rhyme: [] },
                            { text: "怎一個", tones: "●●●", rhyme: [] },
                            { text: "愁字了得", tones: "○●●▲", rhyme: [3] }
                        ]
                    }
                }
            },
            "永遇樂": {
                totalChars: 104,
                breakpoint: 12,
                versions: {
                    "李清照": {
                        author: "李清照",
                        content: "落日熔金，暮雲合璧，人在何處？染柳煙濃，吹梅笛怨，春意知幾許？元宵佳節，融和天氣，次第豈無風雨？來相召，香車寶馬，謝他酒朋詩侶。中州盛日，閨門多暇，記得偏重三五。鋪翠冠兒、捻金雪柳，簇帶爭濟楚。如今憔悴，風鬟霧鬢，怕見夜間出去。不如向，簾兒底下，聽人笑語。",
                        pattern: [
                            { text: "落日熔金", tones: "○●○○", rhyme: [] },
                            { text: "暮雲合璧", tones: "⊙○○●", rhyme: [] },
                            { text: "人在何處", tones: "○●○▲", rhyme: [3] },
                            { text: "染柳煙濃", tones: "●●○○", rhyme: [] },
                            { text: "吹梅笛怨", tones: "○○●●", rhyme: [] },
                            { text: "春意知幾許", tones: "●●○○▲", rhyme: [4] },
                            { text: "元宵佳節", tones: "⊙○⊙●", rhyme: [] },
                            { text: "融和天氣", tones: "○○●●", rhyme: [] },
                            { text: "次第豈無風雨", tones: "⊙●●○○▲", rhyme: [5] },
                            { text: "來相召", tones: "●○○", rhyme: [] },
                            { text: "香車寶馬", tones: "○○⊙●", rhyme: [] },
                            { text: "謝他酒朋詩侶", tones: "●○⊙⊙○▲", rhyme: [5] },
                            { text: "中州盛日", tones: "○○●●", rhyme: [] },
                            { text: "閨門多暇", tones: "○○○●", rhyme: [] },
                            { text: "記得偏重三五", tones: "⊙●⊙○⊙▲", rhyme: [5] },
                            { text: "鋪翠冠兒", tones: "●●○○", rhyme: [] },
                            { text: "捻金雪柳", tones: "⊙○○●", rhyme: [] },
                            { text: "簇帶爭濟楚", tones: "○●○○▲", rhyme: [4] },
                            { text: "如今憔悴", tones: "●○○●", rhyme: [] },
                            { text: "風鬟霧鬢", tones: "⊙○⊙●", rhyme: [] },
                            { text: "怕見夜間出去", tones: "⊙●⊙○⊙▲", rhyme: [5] },
                            { text: "不如向", tones: "⊙○●", rhyme: [] },
                            { text: "簾兒底下", tones: "○○●●", rhyme: [] },
                            { text: "聽人笑語", tones: "●○●▲", rhyme: [3] }
                        ]
                    }
                }
            },
            "青玉案": {
                totalChars: 67,
                breakpoint: 6,
                versions: {
                    "辛棄疾": {
                        author: "辛棄疾",
                        content: "東風夜放花千樹，更吹落、星如雨。寶馬雕車香滿路。鳳簫聲動，玉壺光轉，一夜魚龍舞。蛾兒雪柳黃金縷，笑語盈盈暗香去。眾裏尋他千百度，驀然回首，那人卻在，燈火闌珊處。",
                        pattern: [
                            { text: "東風夜放花千樹", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "更吹落、星如雨", tones: "●⊙●○○○▲", rhyme: [6] },
                            { text: "寶馬雕車香滿路", tones: "●●○○○●▲", rhyme: [6] },
                            { text: "鳳簫聲動", tones: "⊙○○●", rhyme: [] },
                            { text: "玉壺光轉", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "一夜魚龍舞", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "蛾兒雪柳黃金縷", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "笑語盈盈暗香去", tones: "⊙●○○●○▲", rhyme: [6] },
                            { text: "眾裏尋他千百度", tones: "●●○○○●▲", rhyme: [6] },
                            { text: "驀然回首", tones: "⊙○○●", rhyme: [] },
                            { text: "那人卻在", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "燈火闌珊處", tones: "⊙●○●▲", rhyme: [4] }
                        ]
                    }
                }
            },
            "醜奴兒": {
                totalChars: 40,
                breakpoint: 4,
                versions: {
                    "辛棄疾": {
                        author: "辛棄疾",
                        content: "少年不識愁滋味，愛上層樓。愛上層樓。為賦新詞強說愁。而今識盡愁滋味，欲說還休。欲說還休。卻道天涼好個秋。",
                        pattern: [
                            { text: "少年不識愁滋味", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "愛上層樓", tones: "⊙●○△", rhyme: [3] },
                            { text: "愛上層樓", tones: "⊙●○△", rhyme: [3] },
                            { text: "為賦新詞強說愁", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "而今識盡愁滋味", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "欲說還休", tones: "⊙●○△", rhyme: [3] },
                            { text: "欲說還休", tones: "⊙●○△", rhyme: [3] },
                            { text: "卻道天涼好個秋", tones: "⊙●○○⊙●△", rhyme: [6] }
                        ]
                    }
                }
            },
            "摸魚兒": {
                totalChars: 116,
                breakpoint: 12,
                versions: {
                    "辛棄疾": {
                        author: "辛棄疾",
                        content: "更能消、幾番風雨。匆匆春又歸去。惜春長怕花開早，何況落紅無數。春且住。見說道、天涯芳草無歸路。怨春不語。算只有殷勤，畫簷蛛網，盡日惹飛絮。長門事，準擬佳期又誤。蛾眉曾有人妒。千金縱買相如賦，脈脈此情誰訴？君莫舞。君不見、玉環飛燕皆塵土。閒愁最苦。休去倚危欄，斜陽正在、煙柳斷腸處。",
                        pattern: [
                            { text: "更能消", tones: "●○○", rhyme: [] },
                            { text: "幾番風雨", tones: "●○○●", rhyme: [] },
                            { text: "匆匆春又歸去", tones: "○○○●○▲", rhyme: [5] },
                            { text: "惜春長怕花開早", tones: "⊙○○●○○●", rhyme: [] },
                            { text: "何況落紅無數", tones: "○●●○○▲", rhyme: [5] },
                            { text: "春且住", tones: "○●▲", rhyme: [2] },
                            { text: "見說道", tones: "●⊙●", rhyme: [] },
                            { text: "天涯芳草無歸路", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "怨春不語", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "算只有殷勤", tones: "●●●○○", rhyme: [] },
                            { text: "畫簷蛛網", tones: "⊙○⊙●", rhyme: [] },
                            { text: "盡日惹飛絮", tones: "⊙●●○▲", rhyme: [4] },
                            { text: "長門事", tones: "○○●", rhyme: [] },
                            { text: "準擬佳期又誤", tones: "⊙●○○●▲", rhyme: [5] },
                            { text: "蛾眉曾有人妒", tones: "○○○●○▲", rhyme: [5] },
                            { text: "千金縱買相如賦", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "脈脈此情誰訴", tones: "⊙●⊙○○▲", rhyme: [5] },
                            { text: "君莫舞", tones: "○●▲", rhyme: [2] },
                            { text: "君不見", tones: "●⊙●", rhyme: [] },
                            { text: "玉環飛燕皆塵土", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "閒愁最苦", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "休去倚危欄", tones: "●●●○○", rhyme: [] },
                            { text: "斜陽正在", tones: "⊙○⊙●", rhyme: [] },
                            { text: "煙柳斷腸處", tones: "⊙●●○▲", rhyme: [4] }
                        ]
                    }
                }
            },
            "賀新郎": {
                totalChars: 116,
                breakpoint: 12,
                versions: {
                    "辛棄疾": {
                        author: "辛棄疾",
                        content: "綠樹聽鵜鴂，更那堪，鷓鴣聲住，杜鵑聲切。啼到春歸無尋處，苦恨芳菲都歇。算未抵，人間離別。馬上琵琶關塞黑，更長門翠輦辭金闕。看燕燕，送歸妾。將軍百戰身名裂，向河梁，回頭萬里，故人長絕。易水蕭蕭西風冷，滿座衣冠似雪。正壯士，悲歌未徹。啼鳥還知如許恨，料不啼清淚長啼血。誰共我，醉明月。",
                        pattern: [
                            { text: "綠樹聽鵜鴂", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "更那堪", tones: "●○○", rhyme: [] },
                            { text: "鷓鴣聲住", tones: "⊙○⊙●", rhyme: [] },
                            { text: "杜鵑聲切", tones: "●○○▲", rhyme: [3] },
                            { text: "啼到春歸無尋處", tones: "⊙●⊙○○⊙●", rhyme: [] },
                            { text: "苦恨芳菲都歇", tones: "⊙●○○⊙▲", rhyme: [5] },
                            { text: "算未抵", tones: "⊙●●", rhyme: [] },
                            { text: "人間離別", tones: "○○⊙▲", rhyme: [3] },
                            { text: "馬上琵琶關塞黑", tones: "⊙●⊙○○⊙●", rhyme: [] },
                            { text: "更長門翠輦辭金闕", tones: "●⊙○⊙●○○▲", rhyme: [7] },
                            { text: "看燕燕", tones: "⊙●●", rhyme: [] },
                            { text: "送歸妾", tones: "●○▲", rhyme: [2] },
                            { text: "將軍百戰身名裂", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "向河梁", tones: "●○○", rhyme: [] },
                            { text: "回頭萬里", tones: "⊙○⊙●", rhyme: [] },
                            { text: "故人長絕", tones: "●○○▲", rhyme: [3] },
                            { text: "易水蕭蕭西風冷", tones: "⊙●⊙○○⊙●", rhyme: [] },
                            { text: "滿座衣冠似雪", tones: "⊙●○○⊙▲", rhyme: [5] },
                            { text: "正壯士", tones: "⊙●●", rhyme: [] },
                            { text: "悲歌未徹", tones: "○○⊙▲", rhyme: [3] },
                            { text: "啼鳥還知如許恨", tones: "⊙●⊙○○⊙●", rhyme: [] },
                            { text: "料不啼清淚長啼血", tones: "●⊙○⊙●○○▲", rhyme: [7] },
                            { text: "誰共我", tones: "⊙●●", rhyme: [] },
                            { text: "醉明月", tones: "●○▲", rhyme: [2] }
                        ]
                    }
                }
            },
            "雨霖鈴": {
                totalChars: 103,
                breakpoint: 11,
                versions: {
                    "柳永": {
                        author: "柳永",
                        content: "寒蟬淒切。對長亭晚，驟雨初歇。都門帳飲無緒，方留戀處、蘭舟催發。執手相看淚眼，竟無語凝噎。念去去、千里煙波，暮靄沉沉楚天闊。多情自古傷離別。更那堪、冷落清秋節。今宵酒醒何處？楊柳岸、曉風殘月。此去經年，應是良辰好景虛設。便縱有、千種風情，更與何人說？",
                        pattern: [
                            { text: "寒蟬淒切", tones: "○○○▲", rhyme: [3] },
                            { text: "對長亭晚", tones: "●○○●", rhyme: [] },
                            { text: "驟雨初歇", tones: "●●○▲", rhyme: [3] },
                            { text: "都門帳飲無緒", tones: "○○●●○●", rhyme: [] },
                            { text: "方留戀處", tones: "○○●●", rhyme: [] },
                            { text: "蘭舟催發", tones: "○○○▲", rhyme: [3] },
                            { text: "執手相看淚眼", tones: "●●○○●●", rhyme: [] },
                            { text: "竟無語凝噎", tones: "●○●○▲", rhyme: [4] },
                            { text: "念去去", tones: "●●●", rhyme: [] },
                            { text: "千里煙波", tones: "○●○○", rhyme: [] },
                            { text: "暮靄沉沉楚天闊", tones: "●●○○●○▲", rhyme: [6] },
                            { text: "多情自古傷離別", tones: "○○●●○○▲", rhyme: [6] },
                            { text: "更那堪", tones: "●○○", rhyme: [] },
                            { text: "冷落清秋節", tones: "●●○○▲", rhyme: [4] },
                            { text: "今宵酒醒何處", tones: "○○●●○●", rhyme: [] },
                            { text: "楊柳岸", tones: "○●●", rhyme: [] },
                            { text: "曉風殘月", tones: "●○○▲", rhyme: [3] },
                            { text: "此去經年", tones: "●●○○", rhyme: [] },
                            { text: "應是良辰好景虛設", tones: "○●○○●●○▲", rhyme: [7] },
                            { text: "便縱有", tones: "●●●", rhyme: [] },
                            { text: "千種風情", tones: "○●○○", rhyme: [] },
                            { text: "更與何人說", tones: "●●○○▲", rhyme: [4] }
                        ]
                    }
                }
            },
            "八聲甘州": {
                totalChars: 94,
                breakpoint: 9,
                versions: {
                    "柳永": {
                        author: "柳永",
                        content: "對瀟瀟暮雨灑江天，一番洗清秋。漸霜風淒緊，關河冷落，殘照當樓。是處紅衰翠減，苒苒物華休。惟有長江水，無語東流。不忍登高臨遠，望故鄉渺邈，歸思難收。嘆年來蹤跡，何事苦淹留？想佳人、妝樓顒望，誤幾回、天際識歸舟？爭知我、倚闌干處，正恁凝愁。",
                        pattern: [
                            { text: "對瀟瀟暮雨灑江天", tones: "●⊙○●●●○○", rhyme: [] },
                            { text: "一番洗清秋", tones: "⊙⊙●○△", rhyme: [4] },
                            { text: "漸霜風淒緊", tones: "●○○⊙●", rhyme: [] },
                            { text: "關河冷落", tones: "⊙○⊙●", rhyme: [] },
                            { text: "殘照當樓", tones: "⊙●○△", rhyme: [3] },
                            { text: "是處紅衰翠減", tones: "⊙●○○⊙●", rhyme: [] },
                            { text: "苒苒物華休", tones: "⊙●●○△", rhyme: [4] },
                            { text: "惟有長江水", tones: "⊙●○○●", rhyme: [] },
                            { text: "無語東流", tones: "⊙●○△", rhyme: [3] },
                            { text: "不忍登高臨遠", tones: "⊙●⊙○⊙●", rhyme: [] },
                            { text: "望故鄉渺邈", tones: "●⊙○⊙●", rhyme: [] },
                            { text: "歸思難收", tones: "⊙●○△", rhyme: [3] },
                            { text: "嘆年來蹤跡", tones: "●○○⊙●", rhyme: [] },
                            { text: "何事苦淹留", tones: "⊙●●○△", rhyme: [4] },
                            { text: "想佳人", tones: "●○○", rhyme: [] },
                            { text: "妝樓顒望", tones: "⊙○○●", rhyme: [] },
                            { text: "誤幾回", tones: "●⊙○", rhyme: [] },
                            { text: "天際識歸舟", tones: "⊙●●○△", rhyme: [4] },
                            { text: "爭知我", tones: "○○●", rhyme: [] },
                            { text: "倚闌干處", tones: "●○○●", rhyme: [] },
                            { text: "正恁凝愁", tones: "⊙●○△", rhyme: [3] }
                        ]
                    }
                }
            },
            "念奴嬌": {
                totalChars: 100,
                breakpoint: 11,
                versions: {
                    "蘇軾": {
                        author: "蘇軾",
                        content: "大江東去，浪淘盡、千古風流人物。故壘西邊，人道是、三國周郎赤壁。亂石穿空，驚濤拍岸，卷起千堆雪。江山如畫，一時多少豪傑。遙想公瑾當年，小喬初嫁了，雄姿英發。羽扇綸巾，談笑間、檣櫓灰飛煙滅。故國神游，多情應笑我，早生華髮。人間如夢，一尊還酹江月。",
                        pattern: [
                            { text: "大江東去", tones: "●○○●", rhyme: [] },
                            { text: "浪淘盡", tones: "●○●", rhyme: [] },
                            { text: "千古風流人物", tones: "○●○○○▲", rhyme: [5] },
                            { text: "故壘西邊", tones: "●●○○", rhyme: [] },
                            { text: "人道是", tones: "○●●", rhyme: [] },
                            { text: "三國周郎赤壁", tones: "○●○○●▲", rhyme: [5] },
                            { text: "亂石穿空", tones: "●●○○", rhyme: [] },
                            { text: "驚濤拍岸", tones: "○○●●", rhyme: [] },
                            { text: "卷起千堆雪", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "江山如畫", tones: "○○○●", rhyme: [] },
                            { text: "一時多少豪傑", tones: "●⊙○●○▲", rhyme: [5] },
                            { text: "遙想公瑾當年", tones: "⊙●⊙●○○", rhyme: [] },
                            { text: "小喬初嫁了", tones: "●○○●●", rhyme: [] },
                            { text: "雄姿英發", tones: "○○○▲", rhyme: [3] },
                            { text: "羽扇綸巾", tones: "●●○○", rhyme: [] },
                            { text: "談笑間", tones: "○●●", rhyme: [] },
                            { text: "檣櫓灰飛煙滅", tones: "⊙●○○○▲", rhyme: [5] },
                            { text: "故國神游", tones: "●●○○", rhyme: [] },
                            { text: "多情應笑我", tones: "⊙○⊙●●", rhyme: [] },
                            { text: "早生華髮", tones: "●○○▲", rhyme: [3] },
                            { text: "人間如夢", tones: "⊙○○●", rhyme: [] },
                            { text: "一尊還酹江月", tones: "●○○●○▲", rhyme: [5] }
                        ]
                    }
                }
            },
            "江城子": {
                totalChars: 70,
                breakpoint: 8,
                versions: {
                    "蘇軾1": {
                        author: "蘇軾",
                        content: "老夫聊發少年狂。左牽黃。右擎蒼。錦帽貂裘，千騎卷平岡。欲報傾城隨太守，親射虎，看孫郎。酒酣胸膽尚開張。鬢微霜。又何妨。持節雲中，何日遣馮唐？會挽雕弓如滿月，西北望，射天狼。",
                        pattern: [
                            { text: "老夫聊發少年狂", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "左牽黃", tones: "●○△", rhyme: [2] },
                            { text: "右擎蒼", tones: "●○△", rhyme: [2] },
                            { text: "錦帽貂裘", tones: "⊙●○○", rhyme: [] },
                            { text: "千騎卷平岡", tones: "⊙●●○△", rhyme: [4] },
                            { text: "欲報傾城隨太守", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "親射虎", tones: "○●●", rhyme: [] },
                            { text: "看孫郎", tones: "●○△", rhyme: [2] },
                            { text: "酒酣胸膽尚開張", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "鬢微霜", tones: "●○△", rhyme: [2] },
                            { text: "又何妨", tones: "●○△", rhyme: [2] },
                            { text: "持節雲中", tones: "⊙●○○", rhyme: [] },
                            { text: "何日遣馮唐", tones: "⊙●●○△", rhyme: [4] },
                            { text: "會挽雕弓如滿月", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "西北望", tones: "○●●", rhyme: [] },
                            { text: "射天狼", tones: "●○△", rhyme: [2] }
                        ]
                    },
                    "蘇軾2": {
                        author: "蘇軾",
                        content: "十年生死兩茫茫。不思量。自難忘。千里孤墳，無處話淒涼。縱使相逢應不識，塵滿面，鬢如霜。夜來幽夢忽還鄉。小軒窗。正梳妝。相顧無言，惟有淚千行。料得年年腸斷處，明月夜，短松岡。",
                        pattern: [
                            { text: "十年生死兩茫茫", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "不思量", tones: "●○△", rhyme: [2] },
                            { text: "自難忘", tones: "●○△", rhyme: [2] },
                            { text: "千里孤墳", tones: "⊙●○○", rhyme: [] },
                            { text: "無處話淒涼", tones: "⊙●●○△", rhyme: [4] },
                            { text: "縱使相逢應不識", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "塵滿面", tones: "○●●", rhyme: [] },
                            { text: "鬢如霜", tones: "●○△", rhyme: [2] },
                            { text: "夜來幽夢忽還鄉", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "小軒窗", tones: "●○△", rhyme: [2] },
                            { text: "正梳妝", tones: "●○△", rhyme: [2] },
                            { text: "相顧無言", tones: "⊙●○○", rhyme: [] },
                            { text: "惟有淚千行", tones: "⊙●●○△", rhyme: [4] },
                            { text: "料得年年腸斷處", tones: "⊙●⊙○○●●", rhyme: [] },
                            { text: "明月夜", tones: "○●●", rhyme: [] },
                            { text: "短松岡", tones: "●○△", rhyme: [2] }
                        ]
                    }
                }
            },
            "卜算子": {
                totalChars: 43,
                breakpoint: 4,  // 表示第4行之前是上闕，從第4行開始是下闕
                versions: {
                    "蘇軾": {
                        author: "蘇軾",
                        content: "缺月掛疏桐，漏斷人初靜。誰見幽人獨往來，飄緲孤鴻影。驚起卻回頭，有恨無人省。揀盡寒枝不肯棲，寂寞沙洲冷。",
                        pattern: [
                            { text: "缺月掛疏桐", tones: "⊙●●○○", rhyme: [] },
                            { text: "漏斷人初靜", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "誰見幽人獨往來", tones: "⊙●○○●●○", rhyme: [] },
                            { text: "飄緲孤鴻影", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "驚起卻回頭", tones: "⊙●●○○", rhyme: [] },
                            { text: "有恨無人省", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "揀盡寒枝不肯棲", tones: "⊙●○○●●○", rhyme: [] },
                            { text: "寂寞沙洲冷", tones: "⊙●○○▲", rhyme: [4] }
                        ]
                    }
                }
            },
            "定風波": {
                totalChars: 57,
                breakpoint: 5,
                versions: {
                    "蘇軾": {
                        author: "蘇軾",
                        content: "莫聽穿林打葉聲。何妨吟嘯且徐行。竹杖芒鞋輕勝馬，誰怕？一蓑煙雨任平生。料峭春風吹酒醒，微冷，山頭斜照卻相迎。回首向來蕭瑟處，歸去，也無風雨也無晴。",
                        pattern: [
                            { text: "莫聽穿林打葉聲", tones: "⊙●○○●●△", rhyme: [6] },
                            { text: "何妨吟嘯且徐行", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "竹杖芒鞋輕勝馬", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "誰怕", tones: "○▲", rhyme: [1] },
                            { text: "一蓑煙雨任平生", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "料峭春風吹酒醒", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "微冷", tones: "○▲", rhyme: [1] },
                            { text: "山頭斜照卻相迎", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "回首向來蕭瑟處", tones: "⊙●⊙○○●▲", rhyme: [6] },
                            { text: "歸去", tones: "○▲", rhyme: [1] },
                            { text: "也無風雨也無晴", tones: "⊙○⊙●●○△", rhyme: [6] }
                        ]
                    }
                }
            },
            "水龍吟": {
                totalChars: 102,
                breakpoint: 12,
                versions: {
                    "蘇軾": {
                        author: "蘇軾",
                        content: "似花還似非花，也無人惜從教墜。拋家傍路，思量卻是，無情有思。縈損柔腸，困酣嬌眼，欲開還閉。夢隨風萬里，尋郎去處，又還被、鶯呼起。不恨此花飛盡，恨西園、落紅難綴。曉來雨過，遺蹤何在？一池萍碎。春色三分，二分塵土，一分流水。細看來，不是楊花，點點是、離人淚。",
                        pattern: [
                            { text: "似花還似非花", tones: "●○⊙●○○", rhyme: [] },
                            { text: "也無人惜從教墜", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "拋家傍路", tones: "⊙○●●", rhyme: [] },
                            { text: "思量卻是", tones: "⊙○⊙●", rhyme: [] },
                            { text: "無情有思", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "縈損柔腸", tones: "⊙●○○", rhyme: [] },
                            { text: "困酣嬌眼", tones: "⊙○⊙●", rhyme: [] },
                            { text: "欲開還閉", tones: "⊙○○▲", rhyme: [3] },
                            { text: "夢隨風萬里", tones: "●⊙○⊙●", rhyme: [] },
                            { text: "尋郎去處", tones: "⊙○⊙●", rhyme: [] },
                            { text: "又還被", tones: "⊙○●", rhyme: [] },
                            { text: "鶯呼起", tones: "○○▲", rhyme: [2] },
                            { text: "不恨此花飛盡", tones: "⊙●⊙○⊙●", rhyme: [] },
                            { text: "恨西園", tones: "●○○", rhyme: [] },
                            { text: "落紅難綴", tones: "⊙○○▲", rhyme: [3] },
                            { text: "曉來雨過", tones: "⊙○⊙●", rhyme: [] },
                            { text: "遺蹤何在", tones: "⊙○○●", rhyme: [] },
                            { text: "一池萍碎", tones: "⊙○○▲", rhyme: [3] },
                            { text: "春色三分", tones: "⊙●○○", rhyme: [] },
                            { text: "二分塵土", tones: "⊙○⊙●", rhyme: [] },
                            { text: "一分流水", tones: "⊙○○▲", rhyme: [3] },
                            { text: "細看來", tones: "●○○", rhyme: [] },
                            { text: "不是楊花", tones: "●●⊙○", rhyme: [] },
                            { text: "點點是", tones: "⊙●●", rhyme: [] },
                            { text: "離人淚", tones: "○○▲", rhyme: [2] }
                        ]
                    }
                }
            },
            "鵲橋仙": {
                totalChars: 56,
                breakpoint: 6,
                versions: {
                    "秦觀": {
                        author: "秦觀",
                        content: "纖雲弄巧，飛星傳恨，銀漢迢迢暗度。金風玉露一相逢，便勝卻、人間無數。柔情似水，佳期如夢，忍顧鵲橋歸路。兩情若是久長時，又豈在、朝朝暮暮。",
                        pattern: [
                            { text: "纖雲弄巧", tones: "⊙○⊙●", rhyme: [] },
                            { text: "飛星傳恨", tones: "⊙○⊙●", rhyme: [] },
                            { text: "銀漢迢迢暗度", tones: "⊙●⊙○⊙▲", rhyme: [5] },
                            { text: "金風玉露一相逢", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "便勝卻", tones: "●⊙●", rhyme: [] },
                            { text: "人間無數", tones: "○○⊙▲", rhyme: [3] },
                            { text: "柔情似水", tones: "⊙○⊙●", rhyme: [] },
                            { text: "佳期如夢", tones: "⊙○⊙●", rhyme: [] },
                            { text: "忍顧鵲橋歸路", tones: "⊙●⊙○⊙▲", rhyme: [5] },
                            { text: "兩情若是久長時", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "又豈在", tones: "●⊙●", rhyme: [] },
                            { text: "朝朝暮暮", tones: "○○⊙▲", rhyme: [3] }
                        ]
                    }
                }
            },
            "踏莎行": {
                totalChars: 58,
                breakpoint: 5,
                versions: {
                    "秦觀": {
                        author: "秦觀",
                        content: "霧失樓臺，月迷津渡。桃源望斷無尋處。可堪孤館閉春寒，杜鵑聲裏斜陽暮。驛寄梅花，魚傳尺素。砌成此恨無重數。郴江幸自繞郴山，為誰流下瀟湘去？",
                        pattern: [
                            { text: "霧失樓臺", tones: "⊙●○○", rhyme: [] },
                            { text: "月迷津渡", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "桃源望斷無尋處", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "可堪孤館閉春寒", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "杜鵑聲裏斜陽暮", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "驛寄梅花", tones: "⊙●○○", rhyme: [] },
                            { text: "魚傳尺素", tones: "⊙○⊙▲", rhyme: [3] },
                            { text: "砌成此恨無重數", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "郴江幸自繞郴山", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "為誰流下瀟湘去", tones: "⊙○⊙●○○▲", rhyme: [6] }
                        ]
                    },
                    "姜夔": {
                        author: "姜夔",
                        content: "燕燕輕盈，鶯鶯嬌軟。分明又向華胥見。夜長爭得薄情知？春初早被相思染。別後書辭，別時針線。離魂暗逐郎行遠。淮南皓月冷千山，冥冥歸去無人管。",
                        pattern: [
                            { text: "燕燕輕盈", tones: "⊙●○○", rhyme: [] },
                            { text: "鶯鶯嬌軟", tones: "⊙○⊙●", rhyme: [] },
                            { text: "分明又向華胥見", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "夜長爭得薄情知", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "春初早被相思染", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "別後書辭", tones: "⊙●○○", rhyme: [] },
                            { text: "別時針線", tones: "⊙○⊙●", rhyme: [] },
                            { text: "離魂暗逐郎行遠", tones: "⊙○⊙●○○▲", rhyme: [6] },
                            { text: "淮南皓月冷千山", tones: "⊙○⊙●●○○", rhyme: [] },
                            { text: "冥冥歸去無人管", tones: "⊙○⊙●○○▲", rhyme: [6] }
                        ]
                    }
                }
            },
            "望海潮": {
                totalChars: 107,
                breakpoint: 11,
                versions: {
                    "秦觀": {
                        author: "秦觀",
                        content: "梅英疏淡，冰澌溶泄，東風暗換年華。金谷俊遊，銅駝巷陌，新晴細履平沙。長記誤隨車。正絮翻蝶舞，芳思交加。柳下桃蹊，亂分春色到人家。西園夜飲鳴笳。有華燈礙月，飛蓋妨花。蘭苑未空，行人漸老，重來是事堪嗟。煙暝酒旗斜。但倚樓極目，時見棲鴉。無奈歸心，暗隨流水到天涯。",
                        pattern: [
                            { text: "梅英疏淡", tones: "○○○●", rhyme: [] },
                            { text: "冰澌溶泄", tones: "○○⊙●", rhyme: [] },
                            { text: "東風暗換年華", tones: "○○●●○△", rhyme: [5] },
                            { text: "金谷俊遊", tones: "○●●○", rhyme: [] },
                            { text: "銅駝巷陌", tones: "○○●●", rhyme: [] },
                            { text: "新晴細履平沙", tones: "○○●●○△", rhyme: [5] },
                            { text: "長記誤隨車", tones: "○●●○△", rhyme: [4] },
                            { text: "正絮翻蝶舞", tones: "●○●○●", rhyme: [] },
                            { text: "芳思交加", tones: "○●○△", rhyme: [3] },
                            { text: "柳下桃蹊", tones: "●●○○", rhyme: [] },
                            { text: "亂分春色到人家", tones: "●○○●●○△", rhyme: [6] },
                            { text: "西園夜飲鳴笳", tones: "○○●●○△", rhyme: [5] },
                            { text: "有華燈礙月", tones: "●○○●●", rhyme: [] },
                            { text: "飛蓋妨花", tones: "⊙●○△", rhyme: [3] },
                            { text: "蘭苑未空", tones: "○●●○", rhyme: [] },
                            { text: "行人漸老", tones: "○○●●", rhyme: [] },
                            { text: "重來是事堪嗟", tones: "○○●●○△", rhyme: [5] },
                            { text: "煙暝酒旗斜", tones: "○●●○△", rhyme: [4] },
                            { text: "但倚樓極目", tones: "●●○⊙●", rhyme: [] },
                            { text: "時見棲鴉", tones: "○●○△", rhyme: [3] },
                            { text: "無奈歸心", tones: "⊙●○○", rhyme: [] },
                            { text: "暗隨流水到天涯", tones: "●●○●●○△", rhyme: [6] }
                        ]
                    }
                }
            },
            "西江月": {
                totalChars: 50,
                breakpoint: 4,
                versions: {
                    "辛棄疾": {
                        author: "辛棄疾",
                        content: "明月別枝驚鵲，清風半夜鳴蟬。稻花香裏說豐年，聽取蛙聲一片。七八個星天外，兩三點雨山前。舊時茅店社林邊，路轉溪橋忽見。",
                        pattern: [
                            { text: "明月別枝驚鵲", tones: "⊙●⊙○○●", rhyme: [] },
                            { text: "清風半夜鳴蟬", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "稻花香裏說豐年", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "聽取蛙聲一片", tones: "⊙●○○⊙▲", rhyme: [5] },
                            { text: "七八個星天外", tones: "⊙●⊙○○●", rhyme: [] },
                            { text: "兩三點雨山前", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "舊時茅店社林邊", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "路轉溪橋忽見", tones: "⊙●○○⊙▲", rhyme: [5] }
                        ]
                    }
                }
            },
            "少年遊": {
                totalChars: 51,
                breakpoint: 6,
                versions: {
                    "周邦彥": {
                        author: "周邦彥",
                        content: "并刀如水，吳鹽勝雪，纖手破新橙。錦幄初溫，獸煙不斷，相對坐調笙。低聲問向誰行宿，城上已三更。馬滑霜濃，不如休去，直是少人行。",
                        pattern: [
                            { text: "并刀如水", tones: "○○○●", rhyme: [] },
                            { text: "吳鹽勝雪", tones: "○○●●", rhyme: [] },
                            { text: "纖手破新橙", tones: "○●●○△", rhyme: [4] },
                            { text: "錦幄初溫", tones: "●●○○", rhyme: [] },
                            { text: "獸煙不斷", tones: "●○⊙●", rhyme: [] },
                            { text: "相對坐調笙", tones: "⊙●●○△", rhyme: [4] },
                            { text: "低聲問向誰行宿", tones: "○○●●○○●", rhyme: [] },
                            { text: "城上已三更", tones: "○●●○△", rhyme: [4] },
                            { text: "馬滑霜濃", tones: "●●○○", rhyme: [] },
                            { text: "不如休去", tones: "●○⊙●", rhyme: [] },
                            { text: "直是少人行", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    }
                }
            },
            "蘇幕遮": {
                totalChars: 62,
                breakpoint: 7,
                versions: {
                    "周邦彥": {
                        author: "周邦彥",
                        content: "燎沉香，消溽暑。鳥雀呼晴，侵曉窺簷語。葉上初陽乾宿雨。水面清圓，一一風荷舉。故鄉遙，何日去？家住吳門，久作長安旅。五月漁郎相憶否？小楫輕舟，夢入芙蓉浦。",
                        pattern: [
                            { text: "燎沉香", tones: "●○○", rhyme: [] },
                            { text: "消溽暑", tones: "○●▲", rhyme: [2] },
                            { text: "鳥雀呼晴", tones: "⊙●○○", rhyme: [] },
                            { text: "侵曉窺簷語", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "葉上初陽乾宿雨", tones: "⊙●○○○●▲", rhyme: [6] },
                            { text: "水面清圓", tones: "⊙●○○", rhyme: [] },
                            { text: "一一風荷舉", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "故鄉遙", tones: "●○○", rhyme: [] },
                            { text: "何日去", tones: "○●▲", rhyme: [2] },
                            { text: "家住吳門", tones: "⊙●○○", rhyme: [] },
                            { text: "久作長安旅", tones: "⊙●○○▲", rhyme: [4] },
                            { text: "五月漁郎相憶否", tones: "⊙●○○○●▲", rhyme: [6] },
                            { text: "小楫輕舟", tones: "⊙●○○", rhyme: [] },
                            { text: "夢入芙蓉浦", tones: "⊙●○○▲", rhyme: [4] }
                        ]
                    }
                }
            },
            
            "高陽臺": {
                totalChars: 100,
                breakpoint: 11,
                versions: {
                    "張炎": {
                        author: "張炎",
                        content: "接葉巢鶯，平波卷絮，斷橋斜日歸船。能幾番遊？看花又是明年。東風且伴薔薇住，到薔薇、春已堪憐。更淒然，萬綠西泠，一抹荒煙。當年燕子知何處？但苔深韋曲，草暗斜川。見說新愁，如今也到鷗邊。無心再續笙歌夢，掩重門、淺醉閒眠。莫開簾，怕見飛花，怕聽啼鵑。",
                        pattern: [
                            { text: "接葉巢鶯", tones: "⊙●○○", rhyme: [] },
                            { text: "平波卷絮", tones: "○○●●", rhyme: [] },
                            { text: "斷橋斜日歸船", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "能幾番遊", tones: "⊙●○○", rhyme: [] },
                            { text: "看花又是明年", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "東風且伴薔薇住", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "到薔薇", tones: "●⊙○", rhyme: [] },
                            { text: "春已堪憐", tones: "⊙●○△", rhyme: [3] },
                            { text: "更淒然", tones: "●○○", rhyme: [] },
                            { text: "萬綠西泠", tones: "⊙●○○", rhyme: [] },
                            { text: "一抹荒煙", tones: "⊙●○△", rhyme: [3] },
                            { text: "當年燕子知何處", tones: "○○●●○○●", rhyme: [] },
                            { text: "但苔深韋曲", tones: "●○○⊙●", rhyme: [] },
                            { text: "草暗斜川", tones: "⊙●○△", rhyme: [3] },
                            { text: "見說新愁", tones: "⊙●○○", rhyme: [] },
                            { text: "如今也到鷗邊", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "無心再續笙歌夢", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "掩重門", tones: "●⊙○", rhyme: [] },
                            { text: "淺醉閒眠", tones: "⊙●○△", rhyme: [3] },
                            { text: "莫開簾", tones: "●○○", rhyme: [] },
                            { text: "怕見飛花", tones: "⊙●○○", rhyme: [] },
                            { text: "怕聽啼鵑", tones: "⊙●○△", rhyme: [3] }
                        ]
                    }
                }
            },
            
            "解連環": {
                totalChars: 106,
                breakpoint: 13,
                versions: {
                    "張炎": {
                        author: "張炎",
                        content: "楚江空晚。悵離群萬里，恍然驚散。自顧影、卻下寒塘，正沙淨草枯，水平天遠。寫不成書，只寄得、相思一點。料因循誤了，殘氈擁雪，故人心眼。誰憐旅愁荏苒。謾長門夜悄，錦箏彈怨。想伴侶、猶宿蘆花，也曾念春前，去程應轉。暮雨相呼，怕驀地、玉關重見。未羞他、雙燕歸來，畫簾半卷。",
                        pattern: [
                            { text: "楚江空晚", tones: "●○○▲", rhyme: [3] },
                            { text: "悵離群萬里", tones: "⊙○○●●", rhyme: [] },
                            { text: "恍然驚散", tones: "●○○▲", rhyme: [3] },
                            { text: "自顧影", tones: "●●⊙", rhyme: [] },
                            { text: "卻下寒塘", tones: "⊙●○○", rhyme: [4] },
                            { text: "正沙淨草枯", tones: "●⊙●⊙○", rhyme: [] },
                            { text: "水平天遠", tones: "●○○▲", rhyme: [3] },
                            { text: "寫不成書", tones: "⊙●○○", rhyme: [] },
                            { text: "只寄得", tones: "⊙⊙●", rhyme: [] },
                            { text: "相思一點", tones: "⊙○○▲", rhyme: [3] },
                            { text: "料因循誤了", tones: "●⊙○●●", rhyme: [] },
                            { text: "殘氈擁雪", tones: "⊙●○○", rhyme: [] },
                            { text: "故人心眼", tones: "⊙⊙○▲", rhyme: [3] },
                            { text: "誰憐旅愁荏苒", tones: "○○●○●▲", rhyme: [5] },
                            { text: "謾長門夜悄", tones: "●○○●●", rhyme: [] },
                            { text: "錦箏彈怨", tones: "⊙⊙○▲", rhyme: [3] },
                            { text: "想伴侶", tones: "●●⊙", rhyme: [] },
                            { text: "猶宿蘆花", tones: "○●○○", rhyme: [4] },
                            { text: "也曾念春前", tones: "●⊙●○○", rhyme: [] },
                            { text: "去程應轉", tones: "●⊙○▲", rhyme: [3] },
                            { text: "暮雨相呼", tones: "●●○○", rhyme: [] },
                            { text: "怕驀地", tones: "●⊙●", rhyme: [] },
                            { text: "玉關重見", tones: "⊙○○▲", rhyme: [3] },
                            { text: "未羞他", tones: "⊙○⊙", rhyme: [] },
                            { text: "雙燕歸來", tones: "●○●●", rhyme: [4] },
                            { text: "畫簾半卷", tones: "●○●▲", rhyme: [3] }
                        ]
                    }
                }
            },
            
            "風入松": {
                totalChars: 76,
                breakpoint: 7,
                versions: {
                    "吳文英": {
                        author: "吳文英",
                        content: "聽風聽雨過清明。愁草瘞花銘。樓前綠暗分攜路，一絲柳、一寸柔情。料峭春寒中酒，交加曉夢啼鶯。西園日日掃林亭。依舊賞新晴。黃蜂頻撲鞦韆索，有當時、纖手香凝。惆悵雙鴛不到，幽階一夜苔生。",
                        pattern: [
                            { text: "聽風聽雨過清明", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "愁草瘞花銘", tones: "⊙●●○△", rhyme: [4] },
                            { text: "樓前綠暗分攜路", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "一絲柳", tones: "⊙○⊙", rhyme: [] },
                            { text: "一寸柔情", tones: "⊙●○△", rhyme: [3, 4] },
                            { text: "料峭春寒中酒", tones: "⊙●○○○●", rhyme: [] },
                            { text: "交加曉夢啼鶯", tones: "⊙○⊙●○△", rhyme: [5] },
                            { text: "西園日日掃林亭", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "依舊賞新晴", tones: "⊙●●○△", rhyme: [4] },
                            { text: "黃蜂頻撲鞦韆索", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "有當時", tones: "⊙○⊙", rhyme: [] },
                            { text: "纖手香凝", tones: "⊙●○△", rhyme: [3, 4] },
                            { text: "惆悵雙鴛不到", tones: "⊙●○○○●", rhyme: [] },
                            { text: "幽階一夜苔生", tones: "⊙○⊙●○△", rhyme: [5] }
                        ]
                    }
                }
            },
            
            "思佳客": {
                totalChars: 55,
                breakpoint: 4,  // 表示第4行之前是上闕，從第4行開始是下闕
                versions: {
                    "吳文英": {
                        author: "吳文英",
                        content: "釵燕攏雲睡起時。隔牆折得杏花枝。青春半面妝如畫，細雨三更花又飛。輕愛別，舊相知。斷腸青塚幾斜暉。斷紅一任風吹起，結習空時不點衣。",
                        pattern: [
                            { text: "釵燕攏雲睡起時", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "隔牆折得杏花枝", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "青春半面妝如畫", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "細雨三更花又飛", tones: "⊙●○○⊙●△", rhyme: [6] },
                            { text: "輕愛別", tones: "○●●", rhyme: [] },
                            { text: "舊相知", tones: "●○△", rhyme: [2] },
                            { text: "斷腸青塚幾斜暉", tones: "⊙○⊙●●○△", rhyme: [6] },
                            { text: "斷紅一任風吹起", tones: "⊙○⊙●○○●", rhyme: [] },
                            { text: "結習空時不點衣", tones: "⊙●○○⊙●△", rhyme: [6] }
                        ]
                    }
                }
            },
            
            "天香": {
                totalChars: 96,
                breakpoint: 11,
                versions: {
                    "王沂孫": {
                        author: "王沂孫",
                        content: "孤嶠蟠煙，層濤蛻月，驪宮夜采鉛水。汛遠槎風，夢深薇露，化作斷魂心字。紅瓷候火，還乍識、冰環玉指。一縷縈簾翠影，依稀海天雲氣。幾回殢嬌半醉。翦春燈、夜寒花碎。更好故溪飛雪，小窗深閉。荀令如今頓老，總忘卻、樽前舊風味。謾惜餘薰，空篝素被。",
                        pattern: [
                            { text: "孤嶠蟠煙", tones: "⊙●○○", rhyme: [] },
                            { text: "層濤蛻月", tones: "○○●●", rhyme: [] },
                            { text: "驪宮夜采鉛水", tones: "●●○○○▲", rhyme: [5] },
                            { text: "汛遠槎風", tones: "●●○○", rhyme: [] },
                            { text: "夢深薇露", tones: "○○⊙●", rhyme: [] },
                            { text: "化作斷魂心字", tones: "●●○○○▲", rhyme: [5] },
                            { text: "紅瓷候火", tones: "●○○●", rhyme: [] },
                            { text: "還乍識", tones: "○●●", rhyme: [] },
                            { text: "冰環玉指", tones: "●○○▲", rhyme: [3] },
                            { text: "一縷縈簾翠影", tones: "○●○○●●", rhyme: [] },
                            { text: "依稀海天雲氣", tones: "○○●○○▲", rhyme: [5] },
                            { text: "幾回殢嬌半醉", tones: "○○●○●▲", rhyme: [5] },
                            { text: "翦春燈", tones: "●○○", rhyme: [] },
                            { text: "夜寒花碎", tones: "●○○▲", rhyme: [3] },
                            { text: "更好故溪飛雪", tones: "○●○○●●", rhyme: [] },
                            { text: "小窗深閉", tones: "●○○▲", rhyme: [3] },
                            { text: "荀令如今頓老", tones: "○●○○●▲", rhyme: [5] },
                            { text: "總忘卻", tones: "●○●", rhyme: [] },
                            { text: "樽前舊風味", tones: "○○●○▲", rhyme: [4] },
                            { text: "謾惜餘薰", tones: "●●○○", rhyme: [] },
                            { text: "空篝素被", tones: "○○●▲", rhyme: [3] }
                        ]
                    }
                }
            },
            
            "滿庭芳": {
                totalChars: 95,
                breakpoint: 11,
                versions: {
                    "周邦彥": {
                        author: "周邦彥",
                        content: "風老鶯雛，雨肥梅子，午陰嘉樹清圓。地卑山近，衣潤費爐煙。人靜烏鳶自樂，小橋外、新綠濺濺。憑欄久，黃蘆苦竹，擬泛九江船。年年。如社燕，飄流瀚海，來寄修椽。且莫思身外，長近樽前。憔悴江南倦客，不堪聽、急管繁弦。歌筵畔，先安簟枕，容我醉時眠。",
                        pattern: [
                            { text: "風老鶯雛", tones: "⊙●○○", rhyme: [] },
                            { text: "雨肥梅子", tones: "⊙○⊙●", rhyme: [] },
                            { text: "午陰嘉樹清圓", tones: "●⊙○●○△", rhyme: [5] },
                            { text: "地卑山近", tones: "●○○●", rhyme: [] },
                            { text: "衣潤費爐煙", tones: "○●●○△", rhyme: [4] },
                            { text: "人靜烏鳶自樂", tones: "⊙●○○●●", rhyme: [] },
                            { text: "小橋外", tones: "⊙⊙●", rhyme: [] },
                            { text: "新綠濺濺", tones: "⊙●○△", rhyme: [3] },
                            { text: "憑欄久", tones: "○○●", rhyme: [] },
                            { text: "黃蘆苦竹", tones: "⊙○⊙●", rhyme: [] },
                            { text: "擬泛九江船", tones: "⊙●●○△", rhyme: [4] },
                            { text: "年年", tones: "○△", rhyme: [1] },
                            { text: "如社燕", tones: "○●●", rhyme: [] },
                            { text: "飄流瀚海", tones: "○○●●", rhyme: [] },
                            { text: "來寄修椽", tones: "⊙●○△", rhyme: [3] },
                            { text: "且莫思身外", tones: "●○●○○", rhyme: [] },
                            { text: "長近樽前", tones: "⊙●○△", rhyme: [3] },
                            { text: "憔悴江南倦客", tones: "⊙●⊙○●●", rhyme: [] },
                            { text: "不堪聽", tones: "⊙⊙●", rhyme: [] },
                            { text: "急管繁弦", tones: "⊙●○△", rhyme: [3] },
                            { text: "歌筵畔", tones: "○○●", rhyme: [] },
                            { text: "先安簟枕", tones: "⊙○⊙●", rhyme: [] },
                            { text: "容我醉時眠", tones: "⊙●●○△", rhyme: [4] }
                        ]
                    }
                }
            },
            
            "疏影": {
                totalChars: 110,
                breakpoint: 12,
                versions: {
                    "姜夔": {
                        author: "姜夔",
                        content: "苔枝綴玉，有翠禽小小，枝上同宿。客裏相逢，籬角黃昏，無言自倚修竹。昭君不慣胡沙遠，但暗憶、江南江北。想佩環、月夜歸來，化作此花幽獨。猶記深宮舊事，那人正睡裡，飛近蛾綠。莫似春風，不管盈盈，早與安排金屋。還教一片隨波去，又卻怨、玉龍哀曲。等恁時、重覓幽香，已入小窗橫幅。",
                        pattern: [
                            { text: "苔枝綴玉", tones: "○○●▲", rhyme: [3] },
                            { text: "有翠禽小小", tones: "●●○●●", rhyme: [] },
                            { text: "枝上同宿", tones: "○●○▲", rhyme: [3] },
                            { text: "客裏相逢", tones: "●●○○", rhyme: [] },
                            { text: "籬角黃昏", tones: "○●○○", rhyme: [] },
                            { text: "無言自倚修竹", tones: "○○●●○▲", rhyme: [5] },
                            { text: "昭君不慣胡沙遠", tones: "○○●●○○●", rhyme: [] },
                            { text: "但暗憶", tones: "●●●", rhyme: [] },
                            { text: "江南江北", tones: "○○○▲", rhyme: [3] },
                            { text: "想佩環", tones: "●●○", rhyme: [] },
                            { text: "月夜歸來", tones: "●●○○", rhyme: [] },
                            { text: "化作此花幽獨", tones: "●●●○○▲", rhyme: [5] },
                            { text: "猶記深宮舊事", tones: "○●○○●●", rhyme: [] },
                            { text: "那人正睡裡", tones: "●○●●●", rhyme: [] },
                            { text: "飛近蛾綠", tones: "○●○▲", rhyme: [3] },
                            { text: "莫似春風", tones: "●●○○", rhyme: [] },
                            { text: "不管盈盈", tones: "●●○○", rhyme: [] },
                            { text: "早與安排金屋", tones: "●●○○○▲", rhyme: [5] },
                            { text: "還教一片隨波去", tones: "○○●●○○●", rhyme: [] },
                            { text: "又卻怨", tones: "●●●", rhyme: [] },
                            { text: "玉龍哀曲", tones: "●○○▲", rhyme: [3] },
                            { text: "等恁時", tones: "●●○", rhyme: [] },
                            { text: "重覓幽香", tones: "○●○○", rhyme: [] },
                            { text: "已入小窗橫幅", tones: "●●●○○▲", rhyme: [5] }
                        ]
                    }
                }
            },
            
            "暗香": {
                totalChars: 97,
                breakpoint: 11,
                versions: {
                    "姜夔": {
                        author: "姜夔",
                        content: "舊時月色。算幾番照我，梅邊吹笛。喚起玉人，不管清寒與攀摘。何遜而今漸老，都忘卻、春風詞筆。但怪得、竹外疏花，香冷入瑤席。江國。正寂寂。嘆寄與路遙，夜雪初積。翠尊易泣。紅萼無言耿相憶。長記曾攜手處，千樹壓、西湖寒碧。又片片、吹盡也，幾時見得？",
                        pattern: [
                            { text: "舊時月色", tones: "●○●▲", rhyme: [3] },
                            { text: "算幾番照我", tones: "●●○●●", rhyme: [] },
                            { text: "梅邊吹笛", tones: "○○○▲", rhyme: [3] },
                            { text: "喚起玉人", tones: "●●●○", rhyme: [] },
                            { text: "不管清寒與攀摘", tones: "●●○○●○▲", rhyme: [6] },
                            { text: "何遜而今漸老", tones: "○●○○●●", rhyme: [] },
                            { text: "都忘卻", tones: "○●●", rhyme: [] },
                            { text: "春風詞筆", tones: "○○○▲", rhyme: [3] },
                            { text: "但怪得", tones: "●●●", rhyme: [] },
                            { text: "竹外疏花", tones: "●●○○", rhyme: [] },
                            { text: "香冷入瑤席", tones: "○●●○▲", rhyme: [4] },
                            { text: "江國", tones: "○▲", rhyme: [1] },
                            { text: "正寂寂", tones: "●●▲", rhyme: [2] },
                            { text: "嘆寄與路遙", tones: "●●●●○", rhyme: [] },
                            { text: "夜雪初積", tones: "●●○▲", rhyme: [3] },
                            { text: "翠尊易泣", tones: "●○●▲", rhyme: [3] },
                            { text: "紅萼無言耿相憶", tones: "○●○○●○▲", rhyme: [6] },
                            { text: "長記曾攜手處", tones: "○●○○●●", rhyme: [] },
                            { text: "千樹壓", tones: "○●●", rhyme: [] },
                            { text: "西湖寒碧", tones: "○○○▲", rhyme: [3] },
                            { text: "又片片", tones: "●●●", rhyme: [] },
                            { text: "吹盡也", tones: "○●●", rhyme: [] },
                            { text: "幾時見得", tones: "●○●▲", rhyme: [3] }
                        ]
                    }
                }
            }
        };

        // 完整韻部數據庫（基於詞林正韻，擴充版）
        const rhymeDatabase = {
            1: { // 東冬韻
                name: "東冬韻",
                description: "現代基本押 -ong/-ung 韻",
                pingChars: [
                    // 原有基礎字
                    "東", "中", "終", "弓", "風", "空", "公", "功", "工", "紅", "通", "龍", "從", "重", "峰", "蜂",
                    // 擴充常用字
                    "宮", "豐", "融", "松", "鐘", "叢", "胸", "雄", "窮", "瓏", "籠", "隆", "逢", "蟲", "縱", "衷",
                    "翁", "農", "充", "茸", "弘", "崇", "絨", "葱", "沖", "忠", "聰", "容", "蓉", "戎", "封", "蹤",
                    "慵", "庸", "鴻", "朦", "鍾", "烽", "鋒"
                ],
                zeChars: [
                    // 原有基礎字
                    "動", "總", "攏", "種", "用", "供", "共",
                    // 擴充常用字
                    "洞", "夢", "董", "送", "頌", "控", "痛", "湧", "縱", "捧", "鳳", "凍", "恐", "哄", "拱", "統",
                    "聳", "壟", "弄", "擁", "寵", "鞏", "諷", "誦", "重", "踵", "衷", "訟", "慟", "疼", "仲", "眾",
                    "腫", "奉", "溶"
                ]
            },
            20: { // 江陽韻
                name: "江陽韻",
                description: "現代基本押 -ang/-iang 韻",
                pingChars: [
                    // 原有基礎字
                    "江", "陽", "方", "長", "光", "香", "良", "忙", "郎", "量", "強", "商", "章", "常", "房", "行", "王", "腸", "張", "藏", "涼", "桑", "娘", "窗", "梁", "央", "楊", "幫",
                    // 擴充常用字
                    "瀧", "堂", "湘", "唐", "昌", "塘", "場", "鄉", "疆", "彰", "桐", "傷", "芳", "狂", "蒼", "忘", "航", "霜", "裳", "康", "帆", "殤", "妨", "糧", "牆", "鴦", "鑲", "航",
                    "囊", "莊", "裝", "隆", "嚮", "觴", "廊", "皇", "漿", "將", "黃", "蹤", "當", "芒", "粱", "浪", "乾", "良", "飄", "徨", "殃", "妝", "倉", "揚", "羊", "滄", "邦"
                ],
                zeChars: [
                    // 原有基礎字
                    "講", "養", "望", "上", "往", "響", "象", "相", "降", "帳", "仗", "廣", "漾", "障", "掌", "壯", "亮", "想", "讓", "浪", "強",
                    // 擴充常用字
                    "港", "巷", "像", "鞅", "癢", "獎", "仰", "諒", "長", "唱", "朗", "幌", "網", "賞", "向", "兩", "壤", "幻", "撞", "站", "惋", "釀",
                    "量", "蕩", "餉", "樣", "傍", "恙", "享", "當", "抗", "爽", "狀", "恍", "臟", "攘", "榜", "喪", "遠", "漲", "慷", "况", "賞", "忘"
                ]
            },
            21: { // 真文元韻
                name: "真文元韻",
                description: "現代基本押 -en/-in/-un/-ün 韻",
                pingChars: [
                    // 原有基礎字
                    "真", "人", "因", "辰", "身", "新", "春", "親", "民", "巾", "珍", "陳", "神", "塵", "津", "貧", "勻", "文", "雲", "分", "君", "群", "聞", "溫", "村", "魂", "存",
                    // 擴充常用字
                    "辛", "申", "鄰", "臣", "繽", "芬", "薪", "紛", "昆", "芹", "唇", "筠", "氛", "氤", "純", "輪", "墳", "焚", "萱", "鈞", "軍", "勳", "旬", "瑾", "循", "醇", "倫",
                    "巡", "欣", "秦", "崙", "恩", "根", "論", "吞", "坤", "荀", "奔", "遵", "燉", "薰", "頻", "馴", "紋", "昏", "婚", "昕", "蚊", "昆", "孫", "痕", "門", "暾", "敦"
                ],
                zeChars: [
                    // 原有基礎字
                    "引", "準", "忍", "進", "近", "印", "運", "緊", "韻", "允", "穩", "信", "順", "振", "困", "問", "敏", "晉", "隱", "訓", "蘊",
                    // 擴充常用字
                    "俊", "盡", "筍", "聘", "閩", "瑾", "嶙", "盾", "朕", "遜", "慎", "認", "趁", "噴", "隕", "潤", "吝", "燼", "殞", "僅", "恨",
                    "峻", "瞬", "浚", "寸", "鈍", "遁", "憤", "迅", "贐", "舜", "覲", "粉", "紊", "遜", "嫩", "訊", "蠢", "窘", "喘", "蕈", "隼", "盾"
                ]
            },
            22: { // 侵韻
                name: "侵韻",
                description: "現代基本押 -im/-in 韻",
                pingChars: [
                    // 原有基礎字
                    "侵", "心", "琴", "林", "深", "金", "音", "尋", "沈", "吟", "禽", "襟", "今", "陰", "斟", "欽", "臨", "衾", "岑", "霖", "針",
                    // 擴充常用字
                    "簪", "歆", "淋", "琛", "蔭", "森", "潯", "擒", "芩", "妊", "箴", "參", "淫", "黔", "壬", "任", "忱", "喑", "琳", "椹", "涔",
                    "蟫", "愔", "郴", "檎", "芩", "駸", "襟", "禁", "喑", "參", "摻", "嶔", "酣", "感", "禽"
                ],
                zeChars: [
                    // 原有基礎字
                    "寢", "飲", "錦", "品", "枕", "審", "禁", "沁", "蔭", "甚", "浸", "沈", "朕", "任", "廩",
                    // 擴充常用字
                    "衽", "噤", "覃", "稔", "凜", "懍", "荏", "嬸", "葚", "稟", "譖", "讖", "飲", "噤", "鴆",
                    "賃", "喑", "滲", "窨", "妊", "諗", "紝", "寢", "吟", "瀋", "梣", "枕", "鬢", "禁", "飪"
                ]
            },
            3: { // 支微齊灰韻
                name: "支微齊灰韻", 
                description: "現代基本押 -i/-ei 韻",
                pingChars: [
                    // 原有基礎字
                    "支", "知", "時", "詩", "思", "之", "辭", "詞", "期", "基", "絲", "司", "飛", "非", "歸", "機", "幾", "齊", "妻", "西", "提", "題",
                    // 擴充常用字
                    "離", "灰", "推", "微", "回", "杯", "梅", "開", "來", "雷", "陪", "裴", "雪", "追", "危", "規", "迷", "披", "衰", "雖", "悲",
                    "妃", "徘", "徊", "威", "巍", "稀", "希", "窺", "斯", "施", "師", "醫", "兒", "雞", "垂", "吹", "茶", "皆", "階", "堆", "催", 
                    "枝", "姿", "旗", "棋", "奇", "疑", "嵇", "怡", "遲", "欺", "肥", "栖", "牌", "杯", "媒", "煤", "偎", "培", "輝", "徽"
                ],
                zeChars: [
                    // 原有基礎字
                    "紙", "指", "水", "起", "止", "美", "是", "此", "意", "志", "地", "利", "器", "至", "易", "位",
                    // 擴充常用字
                    "以", "已", "義", "理", "記", "你", "只", "李", "里", "死", "使", "始", "四", "字", "自", "似", "寄", "繼", "弟", "第",
                    "異", "費", "慰", "置", "備", "禮", "例", "體", "寺", "嗜", "稚", "膩", "試", "喜", "系", "泥", "睡", "翠", "醉", "芝",
                    "味", "胃", "衛", "謂", "畏", "緯", "偉", "暱", "瑞", "綴", "墜"
                ]
            },
            4: { // 魚虞韻
                name: "魚虞韻",
                description: "現代基本押 -u 韻",
                pingChars: [
                    // 原有基礎字
                    "魚", "書", "居", "車", "如", "虞", "無", "須", "朱", "珠", "都", "圖", "屠", "湖", "孤", "徒", "途", "塗",
                    // 擴充常用字
                    "夫", "呼", "蒲", "扶", "輸", "枯", "奴", "殊", "姝", "樞", "廬", "儒", "驅", "區", "株", "初", "梳",
                    "鋤", "瑜", "盧", "蘆", "壺", "雛", "廚", "拘", "俱", "駒", "模", "膚", "驢", "蔬", "疏", "敷", "紓", "舒", 
                    "趨", "廬", "閭", "爐", "娛", "愚", "於", "臾", "蘇", "吾", "逋", "租", "蒙", "龜", "吳", "狐", "蛛", "乎"
                ],
                zeChars: [
                    // 原有基礎字
                    "語", "與", "雨", "古", "土", "鼓", "虎", "主", "取", "武", "五", "苦",
                    // 擴充常用字
                    "句", "許", "處", "所", "去", "步", "住", "路", "故", "護", "度", "渡", "怒", "暮", "顧", "父", "負", "聚",
                    "務", "數", "舞", "賦", "妒", "戶", "互", "怖", "普", "譜", "輔", "素", "訴", "樹", "煮", "註", "墓", "慕", 
                    "羽", "具", "遇", "禦", "侮", "拒", "據", "醋", "糊", "甫", "撫", "俯", "傅", "婦", "付", "腐"
                ]
            },
            7: { // 元寒刪先韻
                name: "元寒刪先韻",
                description: "現代基本押 -an/-ian 韻",
                pingChars: [
                    // 原有基礎字
                    "元", "源", "園", "寒", "安", "難", "餐", "官", "觀", "冠", "歡", "寬", "關", "還", "山", "間", "天", "年", "前", "千", "先", "邊", "連", "全", "圓", "然", "延",
                    // 擴充常用字
                    "眠", "田", "川", "權", "宣", "煙", "言", "鮮", "妍", "蟬", "仙", "韓", "閒", "閑", "顏", "看", "班", "蘭", "攀", "彎", "環", "旋", "傳", "船",
                    "乾", "肩", "堅", "研", "燕", "箋", "牽", "鉛", "玄", "遷", "緣", "顛", "鞭", "篇", "翩", "潛", "端", "酸", "團", "灣", "頑", "盤", "殘", "欄", 
                    "桓", "丸", "穿", "巔", "蕭", "條", "迢", "魂", "根", "痕", "恩", "論", "村", "屯", "奔", "昆"
                ],
                zeChars: [
                    // 原有基礎字
                    "遠", "晚", "反", "短", "館", "眼", "簡", "善", "遣", "淺", "典", "轉", "展", "願", "建", "健", "見", "面", "變", "遍", "戀",
                    // 擴充常用字
                    "件", "現", "辦", "飯", "散", "伴", "半", "但", "慢", "漢", "亂", "算", "選", "線", "練", "便", "賤", "念", "卷", "戀", "艷", "電", "辯",
                    "岸", "婉", "玩", "挽", "晏", "綰", "染", "淺", "踐", "箭", "限", "剪", "薦", "顯", "苑", "院", "眷", "券", "勸", "獻", 
                    "羨", "彥", "諺", "硯", "晏", "驗", "偃", "賺", "盼", "竄", "換", "幻", "煥", "喚", "患", "綻", "鑽", "斷", "嬋", "產"
                ]
            },
            8: { // 蕭餚豪韻
                name: "蕭餚豪韻",
                description: "現代基本押 -ao 韻",
                pingChars: [
                    // 原有基礎字
                    "蕭", "條", "調", "超", "朝", "搖", "遙", "橋", "喬", "高", "刀", "桃", "毛", "勞", "豪", "號", "陶", "曹", "遭",
                    // 擴充常用字
                    "招", "韶", "消", "宵", "霄", "飄", "漂", "瓢", "嬌", "饒", "聊", "包", "胞", "拋", "袍", "茅", "遙", "姚",
                    "飊", "瑤", "堯", "標", "彪", "苞", "炮", "庖", "咆", "滔", "洮", "濤", "韜", "敲", "翹", "樵", "僑", "焦", "椒", "蕉", "貂", "雕", "凋", "迢", "髦"
                ],
                zeChars: [
                    // 原有基礎字
                    "小", "少", "了", "曉", "好", "道", "造", "老", "考", "笑", "照", "要", "調", "料", "教", "校", "報", "到",
                    // 擴充常用字
                    "妙", "召", "趙", "悄", "俏", "掃", "寶", "暴", "爆", "惱", "腦", "島", "釣", "鬧", "導", "燥", "皂", "竅",
                    "孝", "窈", "渺", "妙", "廟", "悼", "擾", "撓", "惱", "鬧", "抱", "飽", "爆", "保", "炒", "吵", "弔", "掉", "兆", "詔", "罩", "燥", "躁", "操", "冒", "帽"
                ]
            },
            9: { // 歌韻
                name: "歌韻",
                description: "現代基本押 -o/-e 韻",
                pingChars: [
                    // 原有基礎字
                    "歌", "多", "河", "和", "波", "科", "何", "過", "磨", "哥", "阿",
                    // 擴充常用字
                    "娑", "梭", "婆", "羅", "螺", "鵝", "蓑", "拖", "邏", "蘿", "窩", "呵", "番", "茄", "蛾", "蛾", "駝", "沱",
                    "訶", "詞", "怡", "蕃", "莎", "梭", "摞", "陀", "佗", "馱", "跎", "他", "它", "池", "馳", "弛", "遲", "這", "哪", "舵", "那", "柯", "蜘", "疴", "籮"
                ],
                zeChars: [
                    // 原有基礎字
                    "我", "可", "果", "坐", "過", "和", "課", "作", "做",
                    // 擴充常用字
                    "墮", "裸", "臥", "貨", "賀", "禍", "破", "鎖", "座", "左", "佐", "舵", "朵", "妥", "餓", "惰", "墮", "個",
                    "佔", "捨", "跛", "挫", "錯", "鈔", "措", "躇", "啓", "惡", "喝", "舍", "貸", "貼", "嚓", "妲", "它", "爸", "呱", "爹", "坷"
                ]
            },
            10: { // 佳麻韻
                name: "佳麻韻",
                description: "現代基本押 -a 韻",
                pingChars: [
                    // 原有基礎字
                    "佳", "花", "家", "茶", "華", "沙", "車", "牙", "加", "瓜",
                    // 擴充常用字
                    "霞", "遮", "紗", "斜", "嘉", "誇", "奢", "麻", "鴉", "蝦", "些", "衙", "涯", "槎", "芽", "鰕", "葭", 
                    "嘉", "爺", "邪", "爹", "奢", "賒", "耶", "椰", "伽", "茄", "拿", "呀", "芭", "巴", "爬", "琶", "葩", "趴", "蟆", "麻", "痲", "碼", "媽", "摩", "磨", "螞", "騾", "查", "渣", "蛇", "茶"
                ],
                zeChars: [
                    // 原有基礎字
                    "馬", "下", "也", "夏", "假", "畫", "化", "話", "罵", "怕",
                    // 擴充常用字
                    "霸", "灑", "瓦", "耍", "詐", "借", "暇", "賈", "價", "稼", "駕", "嫁", "亞", "納", "啞", "雅", "咱", "洒",
                    "灑", "惹", "藉", "謝", "卸", "寫", "瀉", "捨", "社", "射", "赦", "舍", "姹", "差", "槎", "搽", "帕", "怯", "蓋", "蝦", "厦", "廈", "罅", "鰕", "可", "亞", "壓", "啊", "啦", "吧", "爬", "趴"
                ]
            },
            11: { // 庚青蒸韻
                name: "庚青蒸韻",
                description: "現代基本押 -ing/-eng 韻",
                pingChars: [
                    // 原有基礎字
                    "更", "平", "京", "明", "生", "行", "清", "情", "晴", "精", "成", "城", "程", "聲", "名", "令", "輕", "青", "經", "形", "亭", "庭", "停", "星", "聽", "冰", "應", "蒸", "能", "朋",
                    // 擴充常用字
                    "榮", "英", "鳴", "莖", "盈", "貞", "迎", "驚", "鯨", "瑩", "瓊", "榮", "兵", "丁", "寧", "鶯", "萌", "澄", "橙", "燈", "呈", "征", "爭",
                    "仍", "憑", "猩", "馨", "箏", "騰", "膨", "棚", "彭", "烹", "鵬", "澎", "宏", "弘", "洪", "鴻", "宗", "綜", "棕", "蹤", "縱", "叢", "聰", "忡", "充", "衝", "沖", "中", "忠", "鍾", "鐘"
                ],
                zeChars: [
                    // 原有基礎字
                    "景", "請", "整", "靜", "省", "命", "正", "性", "應", "定", "聽",
                    // 擴充常用字
                    "令", "病", "永", "政", "映", "影", "境", "警", "敬", "鏡", "競", "井", "凈", "領", "令", "冷", "穩", "印", "孕", "應", "訂", "頂", "釘",
                    "炳", "秉", "柄", "稟", "餅", "並", "屏", "頂", "挺", "艇", "訂", "錠", "鼎", "定", "盛", "聖", "詠", "永", "泳", "柄", "病", "冷", "凈", "靖", "幸", "鏡", "敬", "淨", "頸"
                ]
            },
            12: { // 尤韻
                name: "尤韻",
                description: "現代基本押 -ou/-iu 韻",
                pingChars: [
                    // 原有基礎字
                    "尤", "流", "留", "由", "油", "游", "牛", "修", "秋", "周", "州", "舟", "收", "求", "浮", "頭", "投", "溝", "幽",
                    // 擴充常用字
                    "休", "愁", "稠", "優", "憂", "悠", "柔", "丘", "抽", "酬", "籌", "綢", "裘", "郵", "樓", "謀", "侯", "喉",
                    "歐", "鷗", "毬", "仇", "綉", "繡", "琇", "揪", "鳩", "酋", "猶", "揉", "搜", "卿", "輜", "貿", "牟", "侯", "猴", "兜", "鈎", "溜", "酒", "琉", "劉", "友", "舊", "九", "久", "有", "又"
                ],
                zeChars: [
                    // 原有基礎字
                    "有", "後", "手", "走", "九", "就", "秀", "舊", "右",
                    // 擴充常用字
                    "口", "厚", "友", "臭", "久", "酒", "柳", "朽", "狗", "守", "湊", "扣", "某", "母", "否", "咎", "叟", "嗅", "帚",
                    "藕", "茂", "霧", "務", "牡", "貿", "鉾", "矛", "侮", "廡", "效", "校", "斗", "豆", "逗", "陡", "斗", "竇", "狩", "首", "扣", "受", "玖", "柚", "繆", "抖", "糗", "毆", "透", "偶", "漏"
                ]
            },
            14: { // 覃鹽咸韻
                name: "覃鹽咸韻",
                description: "現代基本押 -an/-iam 韻",
                pingChars: [
                    // 原有基礎字
                    "南", "男", "談", "甘", "三", "鹽", "嚴", "占", "添", "兼", "沾", "尖", "潛", "甜", "咸", "含", "函",
                    // 擴充常用字
                    "監", "藍", "貪", "巖", "簽", "黏", "鐮", "廉", "纖", "尖", "鹼", "饞", "蟾", "瞻", "銜", "蘸", "杉", "柑",
                    "禽", "詹", "蟬", "鉗", "鋤", "檢", "蘞", "鐮", "鎌", "纖", "諂", "碟", "菅", "巒", "彎", "援", "蕉", "燕", "妍", "煙", "研", "輦", "亭", "詠", "聯", "淵"
                ],
                zeChars: [
                    // 原有基礎字
                    "感", "覽", "點", "檢", "臉", "染", "掩", "念", "驗", "店",
                    // 擴充常用字
                    "敢", "減", "憾", "艷", "斬", "懺", "欠", "漸", "淡", "墜", "站", "鑑", "欖", "參", "撼", "慘", "暗", "答",
                    "紺", "闇", "黯", "嬚", "斬", "湛", "斬", "禁", "襟", "泯", "閔", "淡", "澹", "簟", "諗", "貶", "砭", "漸", "閃", "豔", "斂", "撿", "殮", "翻", "煽", "薄", "帶", "錢", "淺", "漣"
                ]
            },
            15: { // 屋沃韻 (入聲韻，在現代漢語中已合併到其他韻)
                name: "屋沃韻",
                description: "現代基本押 -u 韻",
                pingChars: [], // 入聲韻無平聲字
                zeChars: [
                    // 原有基礎字
                    "屋", "木", "竹", "目", "服", "福", "祿", "谷", "熟", "肉", "族", "鹿", "腹", "菊", "陸", "逐", "宿", "牧", "伏", "讀", "育", "六", "哭", "速", "祝", "築", "穆", "睦", "足", "曲",
                    // 擴充常用字
                    "獨", "覆", "復", "黑", "綠", "錄", "蓄", "浴", "俗", "濁", "督", "哭", "版", "幅", "酷", "促", "戮", "牧", "穀", "鵠",
                    "覆", "卜", "曝", "僕", "樸", "樸", "樸", "菔", "輻", "副", "蝠", "匐", "幞", "廓", "穀", "穀", "榖", "轂", "鞠", "沐", "杜", "獨", "續", "軸", "餗", "屬", "贖", "矚", "燭", "觸"
                ]
            },
            16: { // 覺藥韻 (入聲韻，在現代漢語中已合併到其他韻)
                name: "覺藥韻",
                description: "現代基本押 -uo/-o 韻",
                pingChars: [], // 入聲韻無平聲字
                zeChars: [
                    // 原有基礎字
                    "覺", "角", "樂", "捉", "朔", "數", "卓", "啄", "琢", "剝", "駁", "雹", "璞", "樸", "殼", "確", "濁", "擢", "濯", "握", "學", "藥", "薄", "惡", "作", "落", "閣", "鶴",
                    // 擴充常用字
                    "郭", "霍", "鑊", "削", "略", "虐", "爵", "嚼", "著", "錯", "箔", "鐸", "諾", "若", "弱", "掠", "略", "虐", "爵", "壑", "鑿",
                    "橐", "托", "拓", "託", "萼", "愕", "諤", "萼", "鄂", "遏", "頞", "噩", "鱷", "鄂", "愕", "噩", "鍔", "鶚", "遌", "餓", "廓", "郭", "槨", "謔", "霍", "穫", "矍", "攫", "爵", "嚼", "拍", "伯", "帛", "白", "鐸", "鐲", "铎", "浊"
                ]
            },
            17: { // 質陌錫職緝韻 (入聲韻，在現代漢語中已合併到其他韻)
                name: "質陌錫職緝韻",
                description: "現代基本押 -i 韻",
                pingChars: [], // 入聲韻無平聲字
                zeChars: [
                    // 原有基礎字
                    "質", "日", "筆", "出", "室", "實", "疾", "術", "一", "乙", "吉", "秩", "率", "律", "逸", "失", "漆", "慄", "畢", "恤", "密", "蜜", "溢", "膝", "匹", "述", "黜", "弼", "七", "叱", "卒", "悉", "戌",
                    // 擴充常用字
                    "立", "集", "及", "急", "習", "濕", "入", "執", "十", "力", "息", "惜", "席", "昔", "石", "適", "積", "織", "植", "飾", "食", "拾", "識", "式", "色", "淑", "熟",
                    "泣", "邑", "揖", "級", "給", "汲", "棘", "極", "迫", "彼", "壁", "避", "璧", "僻", "劈", "霹", "擘", "祕", "泌", "秘", "密", "滴", "摘", "敵", "擊", "激", "歷", "曆", "瀝", "礫", "癖", "擲", "舌", "刻", "策", "百", "白", "拍"
                ]
            },
            18: { // 物月曷黠屑葉韻 (入聲韻，在現代漢語中已合併到其他韻)
                name: "物月曷黠屑葉韻",
                description: "現代基本押 -ue/-ie/-e 韻",
                pingChars: [], // 入聲韻無平聲字
                zeChars: [
                    // 原有基礎字
                    "物", "佛", "拂", "屈", "鬱", "乞", "掘", "吃", "訖", "紱", "弗", "勿", "迄", "不", "怫", "沸", "厥", "倔", "崛", "尉", "蔚", "契", "屹", "熨", "月", "骨", "發", "闕", "越", "謁", "沒", "伐", "罰", "卒", "竭",
                    // 擴充常用字
                    "決", "缺", "血", "潔", "傑", "結", "節", "別", "切", "雪", "設", "說", "刮", "滑", "奪", "括", "闊", "割", "聶", "業", "葉", "涅", "猝", "歇", "熱", "裂", "折",
                    "突", "墾", "惑", "笏", "忽", "勃", "跋", "渤", "勃", "撥", "渤", "鉢", "玦", "抉", "訣", "蕨", "噦", "猰", "缺", "撇", "蔑", "穴", "滅", "孽", "蠍", "蝎", "噎", "業", "脅", "洩", "泄", "躍", "越", "哲", "竭"
                ]
            },
            19: { // 合洽韻 (入聲韻，在現代漢語中已合併到其他韻)
                name: "合洽韻",
                description: "現代基本押 -a/-ia 韻",
                pingChars: [], // 入聲韻無平聲字
                zeChars: [
                    // 原有基礎字
                    "合", "塔", "答", "納", "榻", "閤", "雜", "臘", "匝", "闔", "蛤", "衲", "沓", "鴿", "踏", "拓", "拉", "盍", "塌", "咂", "盒", "卅", "搭", "褡", "颯", "磕", "榼", "遢", "蹋", "蠟", "溘", "邋", "趿", "洽", "狹", "峽", "法", "甲", "業", "匣", "壓", "鴨", "乏", "怯", "劫",
                    // 擴充常用字
                    "盒", "夾", "狹", "俠", "峽", "轄", "蝦", "霞", "瞎", "押", "鴨", "蠟", "狎", "插", "洽", "掐", "刷", "耷", "搭", "答", "雜", "眨", "煆", "瘕", "榻",
                    "黠", "瞎", "獵", "郝", "澀", "歙", "攝", "澀", "歇", "涉", "懾", "燮", "葉", "鍤", "鑊", "鋏", "莢", "浹", "挾", "頰", "掐", "恰", "匣", "黠", "瞎", "瞎", "匼", "擺", "敗", "憊", "唄", "韛", "韝", "擺", "帶", "法", "甲", "蠍", "協", "脅", "颬"
                ]
            }
        };
        
        // 為方便查詢，我們將平仄各自合併
        const flattenedRhymeChars = {};
        Object.keys(rhymeDatabase).forEach(groupId => {
            const group = rhymeDatabase[groupId];
            flattenedRhymeChars[groupId] = {
                ping: [...group.pingChars],
                ze: [...group.zeChars],
                all: [...group.pingChars, ...group.zeChars]
            };
        });

        let currentPoem = null;
        let currentRhymeGroups = {}; // 存儲不同韻腳的韻部
        let currentAuthor = null;
        let modifiedChars = new Set();
        let currentCipai = null;
        let currentVersion = null;
        let userSelectedRhymeGroup = null; // 用户选择的韵部
        
        // === 数据持久化存储功能 ===
        
        // 检测localStorage可用性
        const isStorageAvailable = (function() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                return true;
            } catch (e) {
                console.log('localStorage不可用，使用内存存储');
                return false;
            }
        })();
        
        // 内存存储（作为localStorage的后备）
        const memoryStorage = {
            data: {},
            setItem: function(key, value) {
                this.data[key] = value;
            },
            getItem: function(key) {
                return this.data[key] || null;
            },
            removeItem: function(key) {
                delete this.data[key];
            },
            clear: function() {
                this.data = {};
            }
        };
        
        // 安全的存储访问
        const storage = {
            setItem: function(key, value) {
                try {
                    if (isStorageAvailable) {
                        localStorage.setItem(key, value);
                    } else {
                        memoryStorage.setItem(key, value);
                    }
                } catch (e) {
                    console.error('存储写入失败:', e);
                    memoryStorage.setItem(key, value);
                }
            },
            getItem: function(key) {
                try {
                    if (isStorageAvailable) {
                        return localStorage.getItem(key);
                    } else {
                        return memoryStorage.getItem(key);
                    }
                } catch (e) {
                    console.error('存储读取失败:', e);
                    return memoryStorage.getItem(key);
                }
            },
            removeItem: function(key) {
                try {
                    if (isStorageAvailable) {
                        localStorage.removeItem(key);
                    } else {
                        memoryStorage.removeItem(key);
                    }
                } catch (e) {
                    console.error('存储删除失败:', e);
                    memoryStorage.removeItem(key);
                }
            },
            clear: function() {
                try {
                    if (isStorageAvailable) {
                        // 只清除我们的数据，不影响其他应用
                        const keys = Object.keys(localStorage).filter(key => 
                            key.startsWith('nanfeng_')
                        );
                        keys.forEach(key => localStorage.removeItem(key));
                    } else {
                        memoryStorage.clear();
                    }
                } catch (e) {
                    console.error('存储清除失败:', e);
                    memoryStorage.clear();
                }
            }
        };
        
        // 自动保存定时器
        let autoSaveTimer = null;
        let lastSaveTime = null;
        
        // 当前作品唯一ID
        let currentWorkId = null;
        
        // === 数据管理核心功能 ===
        
        // 生成唯一ID
        function generateWorkId() {
            return 'work_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // 获取当前作品数据
        function getCurrentWorkData() {
            if (!currentPoem) return null;
            
            return {
                id: currentWorkId,
                cipai: currentCipai,
                version: currentVersion,
                author: currentAuthor || currentPoem.author,
                originalContent: currentPoem.content,
                modifiedContent: getModifiedContent(),
                modifiedChars: Array.from(modifiedChars).map(span => ({
                    lineIndex: parseInt(span.dataset.lineIndex),
                    charIndex: parseInt(span.dataset.charIndex),
                    originalChar: span.dataset.originalChar,
                    newChar: span.textContent
                })),
                rhymeGroup: userSelectedRhymeGroup,
                createTime: currentWorkId ? getWorkById(currentWorkId)?.createTime : new Date().toISOString(),
                lastModified: new Date().toISOString(),
                wordCount: getModifiedContent().replace(/[，。！？；：、\s]/g, '').length
            };
        }
        
        // 保存当前作品
        function saveCurrentWork(showFeedback = true) {
            const workData = getCurrentWorkData();
            if (!workData) {
                if (showFeedback) {
                    showMessage('没有可保存的作品', 'warning');
                }
                return false;
            }
            
            // 如果是新作品，生成ID
            if (!currentWorkId) {
                currentWorkId = generateWorkId();
                workData.id = currentWorkId;
            }
            
            try {
                // 获取现有作品列表
                const works = getAllWorks();
                
                // 查找是否已存在相同ID的作品
                const existingIndex = works.findIndex(w => w.id === workData.id);
                
                if (existingIndex >= 0) {
                    // 更新现有作品
                    works[existingIndex] = workData;
                } else {
                    // 添加新作品
                    works.unshift(workData); // 新作品放在最前面
                }
                
                // 保存到存储
                storage.setItem('nanfeng_works', JSON.stringify(works));
                lastSaveTime = new Date();
                
                if (showFeedback) {
                    showMessage('作品已保存', 'success');
                }
                
                // 更新作品列表显示
                updateWorksList();
                
                return true;
            } catch (error) {
                console.error('保存作品失败:', error);
                if (showFeedback) {
                    showMessage('保存失败: ' + error.message, 'error');
                }
                return false;
            }
        }
        
        // 获取所有作品
        function getAllWorks() {
            try {
                const worksData = storage.getItem('nanfeng_works');
                return worksData ? JSON.parse(worksData) : [];
            } catch (error) {
                console.error('读取作品列表失败:', error);
                return [];
            }
        }
        
        // 根据ID获取作品
        function getWorkById(id) {
            const works = getAllWorks();
            return works.find(work => work.id === id);
        }
        
        // 删除作品
        function deleteWork(id) {
            try {
                const works = getAllWorks();
                const filteredWorks = works.filter(work => work.id !== id);
                storage.setItem('nanfeng_works', JSON.stringify(filteredWorks));
                
                // 如果删除的是当前作品，清空当前状态
                if (currentWorkId === id) {
                    currentWorkId = null;
                }
                
                updateWorksList();
                showMessage('作品已删除', 'success');
                return true;
            } catch (error) {
                console.error('删除作品失败:', error);
                showMessage('删除失败: ' + error.message, 'error');
                return false;
            }
        }
        
        // 加载作品
        function loadWork(id) {
            const work = getWorkById(id);
            if (!work) {
                showMessage('作品不存在', 'error');
                return false;
            }
            
            try {
                // 确保词牌存在
                if (!cipaiPatterns[work.cipai] || !cipaiPatterns[work.cipai].versions[work.version]) {
                    showMessage('词牌数据不存在，无法加载作品', 'error');
                    return false;
                }
                
                // 设置当前作品信息
                currentWorkId = work.id;
                currentCipai = work.cipai;
                currentVersion = work.version;
                currentPoem = cipaiPatterns[work.cipai].versions[work.version];
                currentAuthor = work.author !== currentPoem.author ? work.author : null;
                userSelectedRhymeGroup = work.rhymeGroup;
                
                // 清空修改记录
                modifiedChars.clear();
                modifiedCharRecords = [];
                
                // 显示诗词内容
                displayPoem(work.cipai, work.version);
                
                // 恢复修改的字符
                if (work.modifiedChars && work.modifiedChars.length > 0) {
                    setTimeout(() => {
                        work.modifiedChars.forEach(mod => {
                            const span = document.querySelector(`[data-line-index="${mod.lineIndex}"][data-char-index="${mod.charIndex}"]`);
                            if (span) {
                                span.textContent = mod.newChar;
                                span.dataset.originalChar = mod.originalChar;
                                modifiedChars.add(span);
                                
                                // 更新修改记录
                                const record = {
                                    lineIndex: mod.lineIndex,
                                    charIndex: mod.charIndex,
                                    originalChar: mod.originalChar,
                                    newChar: mod.newChar,
                                    timestamp: new Date().toISOString()
                                };
                                
                                const existingIndex = modifiedCharRecords.findIndex(r =>
                                    r.lineIndex === mod.lineIndex && r.charIndex === mod.charIndex
                                );
                                
                                if (existingIndex >= 0) {
                                    modifiedCharRecords[existingIndex] = record;
                                } else {
                                    modifiedCharRecords.push(record);
                                }
                            }
                        });
                        
                        // 更新韵部按钮状态
                        updateRhymeButtonText();
                    }, 100);
                }
                
                showMessage('作品已加载', 'success');
                return true;
            } catch (error) {
                console.error('加载作品失败:', error);
                showMessage('加载失败: ' + error.message, 'error');
                return false;
            }
        }
        
        // 自动保存功能
        function scheduleAutoSave() {
            // 清除之前的定时器
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            // 设置新的定时器（3秒后自动保存）
            autoSaveTimer = setTimeout(() => {
                saveCurrentWork(false); // 不显示反馈信息
            }, 3000);
        }
        
        // 触发自动保存
        function triggerAutoSave() {
            // 只有在有实际修改时才自动保存
            if (modifiedChars.size > 0) {
                scheduleAutoSave();
            }
        }
        
        // === 作品列表UI管理 ===
        
        // 加载并显示作品列表
        function loadWorksList() {
            updateWorksList();
        }
        
        // 更新作品列表显示
        function updateWorksList() {
            const worksContainer = document.getElementById('worksContainer');
            if (!worksContainer) {
                console.warn('未找到作品容器，可能是UI结构问题');
                return;
            }
            
            const works = getAllWorks();
            
            if (works.length === 0) {
                worksContainer.innerHTML = `
                    <div class="empty-works-message">
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                            <div style="font-size: 16px; margin-bottom: 8px;">还没有保存的作品</div>
                            <div style="font-size: 14px; color: #999;">开始填词创作，系统会自动保存您的作品</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const worksHtml = works.map(work => createWorkCard(work)).join('');
            worksContainer.innerHTML = `
                <div class="works-header">
                    <h3>我的作品 (${works.length})</h3>
                    <div class="works-actions">
                        <button class="btn btn-sm" onclick="exportAllWorks()">导出作品</button>
                        <button class="btn btn-sm btn-danger" onclick="clearAllWorks()">清空全部</button>
                    </div>
                </div>
                <div class="works-grid">
                    ${worksHtml}
                </div>
            `;
        }
        
        // 创建作品卡片
        function createWorkCard(work) {
            const isCurrentWork = currentWorkId === work.id;
            const createTime = new Date(work.createTime).toLocaleDateString();
            const lastModified = new Date(work.lastModified).toLocaleString();
            const preview = work.modifiedContent.substring(0, 30) + (work.modifiedContent.length > 30 ? '...' : '');
            
            return `
                <div class="work-card ${isCurrentWork ? 'current-work' : ''}" data-work-id="${work.id}">
                    <div class="work-header">
                        <div class="work-title">
                            <span class="cipai-name">${work.cipai}</span>
                            ${work.author !== work.cipai ? `<span class="author-name">- ${work.author}</span>` : ''}
                        </div>
                        <div class="work-actions">
                            <button class="btn-icon" onclick="loadWork('${work.id}')" title="加载作品">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            <button class="btn-icon" onclick="duplicateWork('${work.id}')" title="复制作品">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn-icon btn-danger" onclick="confirmDeleteWork('${work.id}')" title="删除作品">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="work-preview">
                        ${preview}
                    </div>
                    <div class="work-meta">
                        <div class="work-stats">
                            <span>${work.wordCount}字</span>
                            ${work.rhymeGroup ? `<span>韵部: ${rhymeDatabase[work.rhymeGroup]?.name || '未知'}</span>` : ''}
                        </div>
                        <div class="work-time">
                            创建: ${createTime}
                            ${work.createTime !== work.lastModified ? `<br>修改: ${lastModified}` : ''}
                        </div>
                    </div>
                    ${isCurrentWork ? '<div class="current-indicator">当前作品</div>' : ''}
                </div>
            `;
        }
        
        // 复制作品
        function duplicateWork(id) {
            const work = getWorkById(id);
            if (!work) {
                showMessage('作品不存在', 'error');
                return;
            }
            
            // 创建副本
            const duplicate = {
                ...work,
                id: generateWorkId(),
                createTime: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            
            try {
                const works = getAllWorks();
                works.unshift(duplicate);
                storage.setItem('nanfeng_works', JSON.stringify(works));
                updateWorksList();
                showMessage('作品已复制', 'success');
            } catch (error) {
                console.error('复制作品失败:', error);
                showMessage('复制失败: ' + error.message, 'error');
            }
        }
        
        // 确认删除作品
        function confirmDeleteWork(id) {
            const work = getWorkById(id);
            if (!work) return;
            
            if (confirm(`确定要删除作品《${work.cipai}》吗？\n此操作无法撤销。`)) {
                deleteWork(id);
            }
        }
        
        // 导出所有作品
        function exportAllWorks() {
            const works = getAllWorks();
            if (works.length === 0) {
                showMessage('没有可导出的作品', 'warning');
                return;
            }
            
            try {
                const exportData = {
                    version: '1.0',
                    exportTime: new Date().toISOString(),
                    totalWorks: works.length,
                    works: works
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `南风填词作品集_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('作品已导出', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showMessage('导出失败: ' + error.message, 'error');
            }
        }
        
        // 清空所有作品
        function clearAllWorks() {
            const works = getAllWorks();
            if (works.length === 0) {
                showMessage('没有作品可清空', 'warning');
                return;
            }
            
            if (confirm(`确定要清空所有 ${works.length} 个作品吗？\n此操作无法撤销！`)) {
                try {
                    storage.clear();
                    currentWorkId = null;
                    updateWorksList();
                    showMessage('所有作品已清空', 'success');
                } catch (error) {
                    console.error('清空失败:', error);
                    showMessage('清空失败: ' + error.message, 'error');
                }
            }
        }
        
        // 显示消息的简化版本（如果没有showFeedback函数）
        function showMessage(message, type = 'info') {
            if (typeof showFeedback === 'function') {
                showFeedback(message, type);
            } else {
                // 简单的alert备用方案
                alert(message);
            }
        }
        
        // === 侧边栏标签切换功能 ===
        
        // 切换侧边栏标签
        function switchSidebarTab(tab) {
            // 更新标签按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'poems') {
                document.getElementById('poemList').classList.add('active');
            } else if (tab === 'works') {
                document.getElementById('worksContainer').classList.add('active');
                // 切换到作品列表时刷新数据
                updateWorksList();
            }
        }
        
        // 保存当前作品的快捷按钮
        function saveCurrentWorkQuick() {
            if (currentPoem) {
                saveCurrentWork(true);
            } else {
                showMessage('请先选择一首词作', 'warning');
            }
        }

        // 初始化頁面
        function initPage() {
            renderPoemList();
            loadWorksList();
            
            // 搜索功能
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterCipaiList(searchTerm);
            });
        }

        // 過濾詞牌列表
        function filterCipaiList(searchTerm) {
            const cipaiSections = document.querySelectorAll('.cipai-section');
            
            cipaiSections.forEach(section => {
                const cipaiTitle = section.querySelector('.cipai-title').textContent.toLowerCase();
                const poemItems = section.querySelectorAll('.poem-item');
                let sectionVisible = false;
                
                poemItems.forEach(item => {
                    const author = item.querySelector('.poem-title').textContent.toLowerCase();
                    const content = item.querySelector('.poem-preview').textContent.toLowerCase();
                    
                    if (cipaiTitle.includes(searchTerm) || author.includes(searchTerm) || content.includes(searchTerm)) {
                        item.style.display = 'block';
                        sectionVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                section.style.display = sectionVisible ? 'block' : 'none';
            });
        }

        // 渲染詞作列表 - 按詞牌分類
        function renderPoemList() {
            const poemList = document.getElementById('poemList');
            poemList.innerHTML = '';

            // 先按詞牌字數排序
            const sortedCipai = Object.keys(cipaiPatterns).sort((a, b) => {
                return cipaiPatterns[a].totalChars - cipaiPatterns[b].totalChars;
            });

            sortedCipai.forEach(cipaiName => {
                const cipaiData = cipaiPatterns[cipaiName];
                const cipaiSection = document.createElement('div');
                cipaiSection.className = 'cipai-section';

                const cipaiTitle = document.createElement('div');
                cipaiTitle.className = 'cipai-title';
                cipaiTitle.innerHTML = `${cipaiName} <span class="char-count">${cipaiData.totalChars}字</span>`;
                cipaiSection.appendChild(cipaiTitle);

                const poemListDiv = document.createElement('div');
                poemListDiv.className = 'poem-list';

                Object.keys(cipaiData.versions).forEach(versionKey => {
                    const poem = cipaiData.versions[versionKey];
                    const poemItem = document.createElement('div');
                    poemItem.className = 'poem-item';
                    // 添加事件对象e作为参数传递
                    poemItem.onclick = (e) => selectPoem(cipaiName, versionKey, e);

                    const preview = poem.content.substring(0, 20) + (poem.content.length > 20 ? '...' : '');

                    poemItem.innerHTML = `
                        <div class="poem-title">${poem.author}</div>
                        <div class="poem-preview">${preview}</div>
                    `;

                    poemListDiv.appendChild(poemItem);
                });

                cipaiSection.appendChild(poemListDiv);
                poemList.appendChild(cipaiSection);
            });
        }

        // 選擇詞作 - 簡化版本，完全禁用自動韻部選擇


        // 显示韵部选择器 - 优化版，添加了元素存在性检查
        function showRhymeGroupSelector() {
            // 获取所有需要的DOM元素，添加存在性检查
            const rhymeGroupSelector = document.getElementById('rhymeGroupSelector');
            if (!rhymeGroupSelector) {
                console.warn('找不到rhymeGroupSelector元素，停止显示韵部选择器');
                return;
            }
            
            const dropdown = document.getElementById('rhymeGroupDropdown');
            if (!dropdown) {
                console.warn('找不到rhymeGroupDropdown元素，停止显示韵部选择器');
                return;
            }
            
            const rhymeGroupInfo = document.getElementById('rhymeGroupInfo');
            const rhymeGroupName = document.getElementById('rhymeGroupName');
            const rhymeGroupDesc = document.getElementById('rhymeGroupDesc');
            const rhymePingSample = document.getElementById('rhymePingSample');
            const rhymeZeSample = document.getElementById('rhymeZeSample');
            const rhymeStatus = document.getElementById('rhymeStatus');
            const rhymeStatusText = document.getElementById('rhymeStatusText');
            
            // 确保有当前选定的诗词模式
            if (!currentPoem || !currentPoem.pattern) {
                console.warn('没有当前选定的诗词模式，停止显示韵部选择器');
                return;
            }
            
            // 分析词谱中的韵脚类型
            const rhymeTypes = new Set();
            currentPoem.pattern.forEach(line => {
                if (line.rhyme && line.rhyme.length > 0) {
                    line.rhyme.forEach(charIndex => {
                        const tone = line.tones[charIndex];
                        if (tone === '△') rhymeTypes.add('ping');
                        if (tone === '▲') rhymeTypes.add('ze');
                    });
                }
            });
            
            // 清空现有选项，只保留第一个默认选项
            dropdown.innerHTML = '<option value="" disabled selected>請選擇詩詞韻部...</option>';
            
            // 创建韵部选项
            Object.keys(rhymeDatabase).forEach(groupId => {
                const group = rhymeDatabase[groupId];
                
                // 检查该韵部是否有需要的平仄字
                let shouldShow = false;
                if ((rhymeTypes.has('ping') && group.pingChars.length > 0) || 
                    (rhymeTypes.has('ze') && group.zeChars.length > 0)) {
                    shouldShow = true;
                }
                
                if (shouldShow) {
                    const option = document.createElement('option');
                    option.value = groupId;
                    option.textContent = `${group.name} - ${group.description}`;
                    dropdown.appendChild(option);
                }
            });
            
            // 如果已经选择了韵部，预先选中它
            if (userSelectedRhymeGroup && rhymeDatabase[userSelectedRhymeGroup]) {
                dropdown.value = userSelectedRhymeGroup;
                // 触发一次change事件，显示详情
                const event = new Event('change');
                dropdown.dispatchEvent(event);
                // 显示已选择状态
                if (rhymeStatus && rhymeStatusText) {
                    rhymeStatus.style.display = 'flex';
                    rhymeStatusText.textContent = `已選擇「${rhymeDatabase[userSelectedRhymeGroup].name}」韻部`;
                }
            }
            
            // 下拉菜单变化事件
            dropdown.addEventListener('change', function() {
                const selectedGroupId = parseInt(this.value);
                if (selectedGroupId && rhymeDatabase[selectedGroupId]) {
                    const group = rhymeDatabase[selectedGroupId];
                    
                    // 显示选中韵部的详细信息
                    if (rhymeGroupName) rhymeGroupName.textContent = group.name;
                    if (rhymeGroupDesc) rhymeGroupDesc.textContent = group.description;
                    
                    // 显示样本字符
                    if (rhymePingSample) {
                        if (group.pingChars.length > 0) {
                            const samplePing = group.pingChars.slice(0, 5).join('、');
                            rhymePingSample.textContent = samplePing + (group.pingChars.length > 5 ? '...' : '');
                            rhymePingSample.style.display = 'block';
                        } else {
                            rhymePingSample.style.display = 'none';
                        }
                    }
                    
                    if (rhymeZeSample) {
                        if (group.zeChars.length > 0) {
                            const sampleZe = group.zeChars.slice(0, 5).join('、');
                            rhymeZeSample.textContent = sampleZe + (group.zeChars.length > 5 ? '...' : '');
                            rhymeZeSample.style.display = 'block';
                        } else {
                            rhymeZeSample.style.display = 'none';
                        }
                    }
                    
                    // 显示详情区域
                    if (rhymeGroupInfo) rhymeGroupInfo.classList.add('active');
                    
                    // 保存选择的韵部
                    userSelectedRhymeGroup = selectedGroupId;
                    
                    // 直接应用选择的韻部，无需点击确认按钮
                    applyUserSelectedRhymeGroup();
                    
                    // 显示已选择状态
                    if (rhymeStatus && rhymeStatusText) {
                        rhymeStatus.style.display = 'flex';
                        rhymeStatusText.textContent = `已選擇「${group.name}」韻部`;
                    }
                } else {
                    // 隐藏详情区域
                    if (rhymeGroupInfo) rhymeGroupInfo.classList.remove('active');
                    
                    // 清除选择
                    userSelectedRhymeGroup = null;
                    
                    // 隐藏已选择状态
                    if (rhymeStatus) rhymeStatus.style.display = 'none';
                }
            });
            
            // 始终显示韵部选择器
            rhymeGroupSelector.style.display = 'block';
        }
        
        // 应用用户选择的韵部
        function applyUserSelectedRhymeGroup() {
            if (!userSelectedRhymeGroup) return;
            
            // 分析词谱中的韵脚类型
            currentPoem.pattern.forEach(line => {
                if (line.rhyme && line.rhyme.length > 0) {
                    line.rhyme.forEach(charIndex => {
                        const tone = line.tones[charIndex];
                        if (tone === '△') {
                            // 设置平声韵部
                            currentRhymeGroups['△'] = userSelectedRhymeGroup;
                        }
                        if (tone === '▲') {
                            // 设置仄声韵部
                            currentRhymeGroups['▲'] = userSelectedRhymeGroup;
                        }
                    });
                }
            });
            
            // 显示提示
            showFeedback(`已选择「${rhymeDatabase[userSelectedRhymeGroup].name}」作为韵部。`, 'info');
        }

        // 顯示詞作
        function displayPoem(cipaiName, versionKey) {
            if (!currentPoem) return;

            modifiedChars.clear();

            // 隱藏提示信息，顯示詞作 - 添加安全检查
            const promptMessage = document.getElementById('promptMessage');
            const poemDisplay = document.getElementById('poemDisplay');
            const patternSource = document.getElementById('patternSource');
            
            if (promptMessage) promptMessage.style.display = 'none';
            if (poemDisplay) poemDisplay.style.display = 'block';
            if (patternSource) patternSource.style.display = 'block';

            // 設置標題和作者 - 添加安全检查
            const poemTitle = document.getElementById('poemTitle');
            if (poemTitle) {
                poemTitle.textContent = cipaiName;
            } else {
                console.warn('找不到poemTitle元素');
            }
            
            // 設置可編輯的作者信息 - 簡化版，添加安全检查
            const authorInfo = document.getElementById('authorInfo');
            if (authorInfo) {
                authorInfo.innerHTML = `
                    <div class="author-info-simple">
                        <span id="authorDisplay" onclick="editAuthor()">${currentAuthor || currentPoem.author}</span>
                    </div>
                `;
            } else {
                console.warn('找不到authorInfo元素');
            }

            // 使用內聯圖例 - 隱藏原圖例
            const patternLegend = document.getElementById('patternLegend');
            const patternLegendInline = document.getElementById('patternLegendInline');
            if (patternLegend) patternLegend.style.display = 'none';
            if (patternLegendInline) patternLegendInline.style.display = 'flex';

            // 顯示版本切換器（如果有多個版本） - 添加安全检查
            const versionSwitcher = document.getElementById('versionSwitcher');
            if (!versionSwitcher) {
                console.warn('找不到versionSwitcher元素');
                return; // 如果找不到元素，提前退出
            }
            
            const versions = Object.keys(cipaiPatterns[cipaiName].versions);
            
            if (versions.length > 1) {
                versionSwitcher.innerHTML = '';
                versionSwitcher.style.display = 'flex';
                
                versions.forEach(version => {
                    const author = cipaiPatterns[cipaiName].versions[version].author;
                    const btn = document.createElement('button');
                    btn.className = 'version-btn' + (version === versionKey ? ' active' : '');
                    btn.textContent = author;
                    btn.onclick = () => selectPoem(cipaiName, version);
                    versionSwitcher.appendChild(btn);
                });
            } else {
                versionSwitcher.style.display = 'none';
            }
            
            // 不再显示格律来源
            const patternSourceElem = document.getElementById('patternSource');
            if (patternSourceElem) {
                patternSourceElem.innerHTML = ``;
            }
            
            // 更新韵部选择按钮文本
            updateRhymeButtonText();

            // 渲染詞作內容
            renderPoemWithPattern();
            updateStats();
        }

        // 解锁并显示韵部模态窗口的函数 - 简化版本，作为统一入口点
        function unlockAndShowRhymeModal() {
            console.log("🔓 用户点击了韵部选择按钮");
            // 直接调用显示韵部选择器函数
            displayRhymeModal();
        }
        
        // 简化版韵部选择窗口显示函数 - 统一入口点
        function displayRhymeModal() {
            console.log("📋 显示韵部选择器");
            
            // 1. 获取或创建模态窗口
            let modal = document.getElementById('rhymeModal');
            if (!modal) {
                console.log("🏗️ 创建新的韵部模态窗口");
                
                modal = document.createElement('div');
                modal.id = 'rhymeModal';
                modal.className = 'rhyme-modal';
                
                modal.innerHTML = `
                    <div class="rhyme-modal-content">
                        <div class="rhyme-modal-header">
                            <div class="rhyme-modal-title" id="rhymeModalTitle">選擇詩詞韻部</div>
                            <button id="rhymeModalClose" class="rhyme-modal-close">&times;</button>
                        </div>
                        
                        <div class="rhyme-modal-body">
                            <div class="rhyme-info-panel">
                                <div id="rhymeTypeInfo"></div>
                            </div>
                            
                            <div class="rhyme-cards-container" id="rhymeCardsContainer">
                                <!-- 韵部卡片将由JavaScript生成 -->
                            </div>
                            
                            <div class="rhyme-settings">
                                <label class="rhyme-toggle">
                                    <span class="rhyme-toggle-switch">
                                        <input type="checkbox" id="rhymeHintToggle" checked>
                                        <span class="rhyme-toggle-slider"></span>
                                    </span>
                                    顯示韻腳輔助提示字
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            // 重新绑定关闭按钮事件 - 每次显示时都重新绑定
            const closeBtn = document.getElementById('rhymeModalClose');
            if (closeBtn) {
                // 使用直接函数而不是引用，避免作用域问题
                closeBtn.onclick = function() {
                    const modal = document.getElementById('rhymeModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };
            }
            
            // 重新绑定提示开关事件
            const hintToggle = document.getElementById('rhymeHintToggle');
            if (hintToggle) {
                hintToggle.checked = window.showRhymeHints !== false;
                hintToggle.onchange = function() {
                    window.showRhymeHints = this.checked;
                };
            }
            
            // 2. 设置词牌名到标题
            const modalTitle = document.getElementById('rhymeModalTitle');
            if (modalTitle && currentCipai) {
                // 3. 分析词谱中的韵脚类型
                const rhymeTypes = analyzeRhymeTypes();
                
                // 确定韵律类型名称和样式
                let rhymeTypeName = "";
                let rhymeTypeClass = "";
                
                if (rhymeTypes.has('ping') && rhymeTypes.has('ze')) {
                    rhymeTypeName = "換韻";
                    rhymeTypeClass = "huan-badge";
                } else if (rhymeTypes.has('ping')) {
                    rhymeTypeName = "平韻";
                    rhymeTypeClass = "ping-badge";
                } else if (rhymeTypes.has('ze')) {
                    rhymeTypeName = "仄韻";
                    rhymeTypeClass = "ze-badge";
                }
                
                // 构建带样式的标题
                if (rhymeTypeName) {
                    modalTitle.innerHTML = `${currentCipai}：選擇韻部 <span class="rhyme-scheme-badge ${rhymeTypeClass}">${rhymeTypeName}</span>`;
                } else {
                    modalTitle.textContent = `${currentCipai}：選擇韻部`;
                }
                
                console.log("✅ 设置韵部选择器标题：", modalTitle.textContent);
            }
            
            // 4. 更新韵部类型信息面板
            updateRhymeTypeInfo(analyzeRhymeTypes());
            
            // 5. 渲染韵部卡片，根据韵脚类型过滤字符
            renderRhymeCards(analyzeRhymeTypes());
            
            // 6. 显示模态窗口
            modal.style.display = 'flex';
            console.log("✅ 韵部选择器显示完成");
        }
        
        // 分析当前词牌的韵脚类型
        // 分析当前词牌的韵脚类型
        function analyzeRhymeTypes() {
            const rhymeTypes = new Set();
            
            if (currentPoem && currentPoem.pattern) {
                currentPoem.pattern.forEach(line => {
                    if (line.rhyme && line.rhyme.length > 0) {
                        line.rhyme.forEach(charIndex => {
                            const tone = line.tones[charIndex];
                            if (tone === '△') rhymeTypes.add('ping');
                            if (tone === '▲') rhymeTypes.add('ze');
                        });
                    }
                });
            }
            
            return rhymeTypes;
        }
        
        // 更新韵部类型信息面板
        function updateRhymeTypeInfo(rhymeTypes) {
            // 完全移除韻部信息顯示，不再需要這個函數的實際功能
            // 但保留函數本身以防其他地方調用
        }
        
        // 渲染韵部卡片
        function renderRhymeCards(rhymeTypes) {
            const cardsContainer = document.getElementById('rhymeCardsContainer');
            if (!cardsContainer) return;
            
            cardsContainer.innerHTML = '';
            console.log("🧩 开始渲染韵部卡片");
            
            // 确定需要显示的韵类型
            const showPingChars = rhymeTypes.has('ping');
            const showZeChars = rhymeTypes.has('ze');
            
            // 如果没有明确指定，默认两种都显示
            const shouldShowPing = showPingChars || (!showPingChars && !showZeChars);
            const shouldShowZe = showZeChars || (!showPingChars && !showZeChars);
            
            let cardCount = 0;
            
            // 遍历所有韵部
            Object.keys(rhymeDatabase).forEach(groupId => {
                const group = rhymeDatabase[groupId];
                
                // 根据韵部类型过滤
                const hasPingChars = shouldShowPing && group.pingChars.length > 0;
                const hasZeChars = shouldShowZe && group.zeChars.length > 0;
                
                // 只显示有相关字符的韵部
                if (hasPingChars || hasZeChars) {
                    const card = document.createElement('div');
                    card.className = 'rhyme-card';
                    if (userSelectedRhymeGroup == groupId) {
                        card.classList.add('selected');
                    }
                    
                    // 构建卡片内容
                    let cardContent = '';
                    cardContent += `<div class="rhyme-card-name">${group.name}</div>`;
                    cardContent += `<div class="rhyme-card-desc">${group.description}</div>`;
                    cardContent += `<div class="rhyme-card-samples">`;
                    
                    // 显示平声字示例
                    if (hasPingChars) {
                        // 确定平声字显示数量：当只显示平声时多显示几个
                        const pingCharLimit = hasZeChars ? 3 : 6;
                        const pingChars = group.pingChars.slice(0, pingCharLimit).join('、');
                        const pingMore = group.pingChars.length > pingCharLimit ? '...' : '';
                        cardContent += `<span class="rhyme-card-ping">平：${pingChars}${pingMore}</span>`;
                    }
                    
                    // 显示仄声字示例
                    if (hasZeChars) {
                        // 确定仄声字显示数量：当只显示仄声时多显示几个
                        const zeCharLimit = hasPingChars ? 3 : 6;
                        const zeChars = group.zeChars.slice(0, zeCharLimit).join('、');
                        const zeMore = group.zeChars.length > zeCharLimit ? '...' : '';
                        cardContent += `<span class="rhyme-card-ze">仄：${zeChars}${zeMore}</span>`;
                    }
                    
                    cardContent += `</div>`;
                    card.innerHTML = cardContent;
                    
                    // 添加点击事件
                    card.addEventListener('click', () => {
                        // 移除所有卡片的选中状态
                        document.querySelectorAll('.rhyme-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // 设置当前卡片为选中状态
                        card.classList.add('selected');
                        
                        // 保存选择的韵部
                        userSelectedRhymeGroup = groupId;
                        
                        // 应用选择的韵部
                        applyUserSelectedRhymeGroup();
                        
                        // 更新韵部按钮文本
                        updateRhymeButtonText();
                        
                        // 关闭模态窗口
                        closeRhymeModal();
                    });
                    
                    cardsContainer.appendChild(card);
                    cardCount++;
                }
            });
            
            console.log(`✅ 渲染了${cardCount}个韵部卡片`);
        }
        
        // 簡化版：編輯作者名功能
        function editAuthor() {
            const authorDisplay = document.getElementById('authorDisplay');
            const currentName = currentAuthor || currentPoem.author;
            
            authorDisplay.innerHTML = `
                <input type="text" class="author-input" value="${currentName}" 
                       placeholder="輸入您的名字" id="authorInput">
            `;
            
            const input = document.getElementById('authorInput');
            input.focus();
            input.select();
            
            const saveAuthor = () => {
                currentAuthor = input.value.trim();
                // 如果輸入的名字與原作者相同或為空，恢復為原作者名稱
                if (!currentAuthor || currentAuthor === currentPoem.author) {
                    currentAuthor = null;
                    authorDisplay.textContent = currentPoem.author;
                } else {
                    authorDisplay.textContent = currentAuthor;
                }
            };
            
            input.addEventListener('blur', saveAuthor);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveAuthor();
                }
            });
        }

                // 已廢棄：詞牌上下闕分界點定義 - 現在通過sections屬性直接表示

        // 存储修改记录的数组
        let modifiedCharRecords = [];
        
        // 根據詞譜渲染詞作內容
        function renderPoemWithPattern(isReciteMode = false) {
            const poemContent = document.getElementById('poemContent');
            if (!poemContent) {
                console.warn('找不到poemContent元素');
                return;
            }
            
            poemContent.innerHTML = '';

            if (!currentPoem || !currentPoem.pattern) {
                console.warn('沒有可用的詞譜數據');
                return;
            }

            // 獲取分界點（直接從詞牌數據結構中獲取）
            const breakpoint = cipaiPatterns[currentCipai] && cipaiPatterns[currentCipai].breakpoint;
            
            // 檢查是否顯示例詞（背诵模式下强制不显示）
            const showExampleWords = !isReciteMode && document.getElementById('exampleWordToggle').checked;
            
            // 如果是背诵模式，记录需要背诵的总字数和每行的提示字符位置
            let lineHintPositions = []; // 存储每行的提示字符位置
            if (isReciteMode) {
                totalCharsToRecite = 0;
                correctCharsCount = 0;
                
                // 为每行随机选择一个提示字符位置
                currentPoem.pattern.forEach((lineData, index) => {
                    if (lineData.text && lineData.text.length > 0) {
                        const randomPos = Math.floor(Math.random() * lineData.text.length);
                        lineHintPositions[index] = randomPos;
                        console.log(`第${index+1}行提示字符位置: ${randomPos} (字符: ${lineData.text[randomPos]})`);
                    }
                });
            }
            
            console.log("背诵模式:", isReciteMode, "提示字符位置:", lineHintPositions);
            
            currentPoem.pattern.forEach((lineData, lineIndex) => {
                // 如果當前行索引等於分界點，添加分隔符
                if (breakpoint !== undefined && lineIndex === breakpoint) {
                    const spacerDiv = document.createElement('div');
                    spacerDiv.className = 'poem-line spacer';
                    spacerDiv.style.height = '30px'; // 空行的高度
                    poemContent.appendChild(spacerDiv);
                }

                const lineDiv = document.createElement('div');
                lineDiv.className = 'poem-line';
                
                // 根據分界點判斷上下闕
                if (breakpoint !== undefined) {
                    lineDiv.dataset.section = lineIndex < breakpoint ? "上闕" : "下闕";
                }

                if (!lineData.text || !lineData.tones) {
                    console.warn(`第${lineIndex+1}行缺少文本或平仄數據`);
                    return;
                }

                const chars = lineData.text.split('');
                const tones = lineData.tones.split('');

                chars.forEach((char, charIndex) => {
                    const span = document.createElement('span');
                    span.className = 'char-span';
                    span.textContent = char;
                    span.dataset.lineIndex = lineIndex;
                    span.dataset.charIndex = charIndex;
                    span.dataset.originalChar = char; // 保存原始字符

                    // 設置平仄樣式
                    if (charIndex < tones.length) {
                        const tone = tones[charIndex];
                        if (tone === '○') {
                            span.classList.add('ping-char');
                        } else if (tone === '●') {
                            span.classList.add('ze-char');
                        } else if (tone === '⊙') {
                            span.classList.add('flexible-char');
                        } else if (tone === '△') {
                            span.classList.add('rhyme-ping');
                        } else if (tone === '▲') {
                            span.classList.add('rhyme-ze');
                        }
    
                        // 檢查是否是韻腳位置
                        const isRhyme = lineData.rhyme && lineData.rhyme.includes(charIndex);
                        if (isRhyme) {
                            span.classList.add('rhyme-position'); // 添加韵脚动画效果
                        }
                        
                        // 检查是否是背诵模式下的提示字符
                        const isHintChar = isReciteMode && (lineIndex < lineHintPositions.length && charIndex === lineHintPositions[lineIndex]);
                        
                        // 根据是否为背诵模式设置不同的点击事件
                        if (isReciteMode) {
                            if (isHintChar) {
                                // 这是提示字符，显示但不可点击
                                span.style.cursor = 'default';
                                span.style.opacity = '1.0';
                                span.style.background = 'rgba(100, 149, 237, 0.1)'; // 淡蓝色背景表示提示字符
                                span.style.borderColor = 'rgba(100, 149, 237, 0.3)';
                                span.title = '提示字符';
                            } else {
                                // 其他字符可以点击
                                span.style.cursor = 'pointer';
                                span.onclick = () => {
                                    console.log("背诵模式点击了字符:", char, "行:", lineIndex, "位置:", charIndex);
                                    showReciteCharSelector(span, char, lineIndex, charIndex);
                                };
                                totalCharsToRecite++; // 计入需要背诵的字数
                            }
                        } else {
                            span.onclick = () => editCharWithPattern(span, char, tone, isRhyme, lineIndex, charIndex);
                        }
                    } else {
                        console.warn(`第${lineIndex+1}行字符${charIndex+1}缺少平仄標記`);
                    }
                    
                    // 检查是否是背诵模式下的提示字符
                    const isHintChar = isReciteMode && (lineIndex < lineHintPositions.length && charIndex === lineHintPositions[lineIndex]);
                    
                    console.log(`行${lineIndex+1}字符${charIndex+1}: isReciteMode=${isReciteMode}, isHintChar=${isHintChar}, 字符="${char}"`);
                    
                    // 检查这个位置是否有修改记录
                    const record = modifiedCharRecords.find(r => 
                        r.lineIndex === lineIndex && r.charIndex === charIndex
                    );
                    
                    if (record) {
                        // 如果有修改记录，应用修改
                        span.textContent = record.newChar;
                        span.classList.add('modified');
                        modifiedChars.add(span);
                        console.log(`应用修改记录: ${record.newChar}`);
                    } else if (isReciteMode) {
                        // 背诵模式优先处理
                        if (isHintChar) {
                            // 背诵模式下的提示字符，保持原有内容显示
                            span.textContent = char; // 确保显示原字符
                            span.style.backgroundColor = 'rgba(100, 149, 237, 0.1)'; // 淡蓝色背景
                            span.style.borderColor = 'rgba(100, 149, 237, 0.3)';
                            span.title = '提示字符';
                            console.log(`设置提示字符: ${char}`);
                        } else {
                            // 背诵模式下，非提示字符清空内容
                            span.textContent = '';
                            console.log(`清空非提示字符`);
                        }
                    } else if (!showExampleWords) {
                        // 非背诵模式下，如果不显示例词，清空内容
                        span.textContent = '';
                        console.log(`清空例词`);
                    }
                    // 如果不是背诵模式且显示例词，保持原内容(char)不变
                    
                    lineDiv.appendChild(span);
                });

                poemContent.appendChild(lineDiv);
            });
        }
        
        // 添加例词显示开关事件监听
        document.addEventListener('DOMContentLoaded', function() {
            const exampleWordToggle = document.getElementById('exampleWordToggle');
            if (exampleWordToggle) {
                exampleWordToggle.addEventListener('change', function() {
                    // 重新渲染诗词内容以应用例词显示/隐藏设置
                    renderPoemWithPattern();
                });
            }
        });

        // 根據格律編輯字符
        async function editCharWithPattern(span, originalChar, expectedTone, isRhyme, lineIndex, charIndex) {
            if (span.classList.contains('editing')) return;

            // 无论是什么字符，都先进入编辑模式
            span.classList.add('editing');
            const input = document.createElement('input');
            input.className = 'char-input';
            input.type = 'text';
            input.maxLength = 1;
            input.value = span.textContent;
            
            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();
            
            // 如果是韻腳位置且已經確定了韻組，同时显示韻字選擇器
            if (isRhyme && currentRhymeGroups[expectedTone]) {
                // 延迟一点点显示选择器，确保输入框已经完全显示
                setTimeout(() => {
                    showRhymeSelector(span, originalChar, expectedTone, true); // 传入true表示用户正在编辑
                }, 10);
            }

            const finishEdit = async () => {
                // 检查是否显示例词
                const showExampleWords = document.getElementById('exampleWordToggle').checked;
                
                // 获取用户输入
                const userInput = input.value.trim();
                
                // 处理用户输入逻辑
                let newChar;
                if (userInput) {
                    // 用户输入了内容，使用输入内容
                    newChar = userInput;
                } else if (showExampleWords) {
                    // 用户没有输入，但例词开关打开，使用原始字符
                    newChar = originalChar;
                } else {
                    // 用户没有输入，且例词开关关闭，保持空白
                    newChar = '';
                }
                
                span.classList.remove('editing');
                span.innerHTML = newChar;
                
                // 只有当有内容时才检查平仄
                if (newChar) {
                    // 检查平仄是否正确 (使用新的API)
                    const isMatchingTone = await checkToneMatch(newChar, expectedTone);
                    
                    if (!isMatchingTone) {
                        // 添加視覺提示
                        span.classList.add('tone-mismatch');
                        
                        // 根據平仄類型顯示適當的提示信息
                        let toneType = '';
                        if (expectedTone === '○' || expectedTone === '△') {
                            toneType = '平聲(陰平/陽平)';
                        } else if (expectedTone === '●' || expectedTone === '▲') {
                            toneType = '仄聲(上聲/去聲)';
                        }
                        
                        showFeedback(`提示：「${newChar}」可能不符合${toneType}要求。`, 'warning');
                    } else {
                        // 移除任何錯誤標記
                        span.classList.remove('tone-mismatch');
                    }
                    
                    // 如果是韻腳位置且是第一次填寫，設定韻組並顯示更明確的提示
                    if (isRhyme && !currentRhymeGroups[expectedTone]) {
                        const rhymeGroup = findRhymeGroup(newChar);
                        if (rhymeGroup) {
                            currentRhymeGroups[expectedTone] = rhymeGroup;
                            const rhymeTypeName = expectedTone === '△' ? '平韻' : '仄韻';
                            const message = `您已選擇「${newChar}」字作為${rhymeTypeName}，屬於「${rhymeDatabase[rhymeGroup].name}」韻部。後續韻腳將推薦同韻字。`;
                            showFeedback(message, 'info');
                            
                            // 更新所有同类韵脚的提示
                            updateRhymePositionsHighlight(expectedTone);
                        }
                    }
                    
                    // 檢查韻腳是否正確
                    if (isRhyme && currentRhymeGroups[expectedTone]) {
                        const rhymeGroup = findRhymeGroup(newChar);
                        if (rhymeGroup && rhymeGroup !== currentRhymeGroups[expectedTone]) {
                            showFeedback(`提示：「${newChar}」不屬於您選擇的${rhymeDatabase[currentRhymeGroups[expectedTone]].name}韻部`, 'warning');
                        }
                    }
                }
                
                // 记录修改状态
                if (userInput) {
                    // 用户输入了内容，记录为修改
                    span.classList.add('modified');
                    modifiedChars.add(span);
                    
                    // 保存修改记录
                    const record = {
                        lineIndex: lineIndex,
                        charIndex: charIndex,
                        originalChar: originalChar,
                        newChar: userInput,
                        timestamp: new Date().toISOString()
                    };
                    
                    // 更新或添加修改记录
                    const existingRecordIndex = modifiedCharRecords.findIndex(r => 
                        r.lineIndex === lineIndex && r.charIndex === charIndex
                    );
                    
                    if (existingRecordIndex >= 0) {
                        modifiedCharRecords[existingRecordIndex] = record;
                    } else {
                        modifiedCharRecords.push(record);
                    }
                    
                    // 触发自动保存
                    triggerAutoSave();
                } else {
                    // 用户没有输入内容，不记录为修改
                    span.classList.remove('modified');
                    modifiedChars.delete(span);
                    
                    // 移除该位置的修改记录
                    const recordIndex = modifiedCharRecords.findIndex(r => 
                        r.lineIndex === lineIndex && r.charIndex === charIndex
                    );
                    
                    if (recordIndex >= 0) {
                        modifiedCharRecords.splice(recordIndex, 1);
                    }
                    
                    // 如果有修改则触发自动保存
                    if (modifiedChars.size > 0) {
                        triggerAutoSave();
                    }
                }
                
                updateStats();
            };

            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    finishEdit();
                }
                if (e.key === 'Escape') {
                    span.classList.remove('editing');
                    span.innerHTML = originalChar;
                }
            });
        }

        // 更新所有同类韵脚位置的高亮效果
        function updateRhymePositionsHighlight(rhymeType) {
            // 移除所有同类韵脚位置的动画效果
            document.querySelectorAll('.rhyme-position').forEach(el => {
                if (el.classList.contains(rhymeType === '△' ? 'rhyme-ping' : 'rhyme-ze')) {
                    // 移除动画效果
                    el.classList.remove('rhyme-position');
                    // 添加已定义韵部的标记
                    el.classList.add('defined-rhyme');
                }
            });
        }
        
        // 載入拼音轉換庫 pinyin-pro
        function loadPinyinAPI() {
            return new Promise((resolve) => {
                if (window.pinyinPro) {
                    resolve(true);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/pinyin-pro@3.13.2/dist/index.js";
                script.async = true;
                
                script.onload = () => resolve(true);
                script.onerror = () => resolve(false);
                
                document.head.appendChild(script);
            });
        }

        // 判斷漢字聲調
        async function getCharTone(char) {
            // 確保API已加載
            const isLoaded = await loadPinyinAPI();
            if (!isLoaded || !window.pinyinPro) {
                console.warn('拼音API載入失敗');
                return 0; // 無法判斷
            }
            
            try {
                // 獲取帶數字聲調的拼音
                const pinyinWithTone = window.pinyinPro.pinyin(char, { 
                    toneType: 'num',  // 使用數字標記聲調
                    type: 'array'     // 返回數組格式
                });
                
                // 從拼音中提取聲調數字
                if (pinyinWithTone && pinyinWithTone.length > 0) {
                    const match = pinyinWithTone[0].match(/[1-4]$/);
                    if (match) {
                        return parseInt(match[0]);
                    }
                }
            } catch (e) {
                console.warn('拼音轉換錯誤:', e);
            }
            
            return 0; // 預設返回0表示無法判斷
        }

        // 判斷是否為平聲
        async function isPingSheng(char) {
            const tone = await getCharTone(char);
            if (tone === 0) return null; // 無法判斷
            return (tone === 1 || tone === 2); // 1、2聲為平聲
        }

        // 檢查平仄是否匹配
        async function checkToneMatch(char, expectedTone) {
            const isPing = await isPingSheng(char);
            
            // 無法判斷時默認視為符合要求
            if (isPing === null) return true;
            
            if (expectedTone === '○' || expectedTone === '△') {
                return isPing === true;
            } else if (expectedTone === '●' || expectedTone === '▲') {
                return isPing === false;
            } else if (expectedTone === '⊙') {
                // 可平可仄位置，任何字都符合
                return true;
            }
            
            return true;
        }

        // 獲取平仄描述
        function getToneDescription(tone) {
            switch(tone) {
                case '○': return '平聲字';
                case '●': return '仄聲字';
                case '△': return '平韻字';
                case '▲': return '仄韻字';
                case '⊙': return '可平可仄';
                default: return '合適的字';
            }
        }

        // 顯示韻字選擇器 - 優先顯示在輸入框下方，模仿下拉選單
        function showRhymeSelector(span, originalChar, rhymeType, isEditMode = false) {
            // 如果已經有選擇器，先移除
            closeRhymeSelector();
            
            const rhymeGroup = currentRhymeGroups[rhymeType];
            const rhymeData = rhymeDatabase[rhymeGroup];
            const rhymeTypeName = rhymeType === '△' ? '平韻' : '仄韻';
            
            // 获取字符或输入框的精确位置信息
            const spanRect = span.getBoundingClientRect();
            
            // 创建选择器面板，先设置为隐藏状态
            const selector = document.createElement('div');
            selector.className = 'floating-rhyme-selector';
            selector.style.position = 'fixed';  // 使用fixed相对于视窗定位
            selector.style.visibility = 'hidden'; // 先隐藏，避免闪烁
            selector.dataset.forCharId = span.dataset.charId || Date.now();
            
            if (!span.dataset.charId) {
                span.dataset.charId = selector.dataset.forCharId;
            }
            
            // 获取字符或输入框的关键位置
            const charBottom = spanRect.bottom;
            const charTop = spanRect.top;
            const charLeft = spanRect.left;
            const charWidth = spanRect.width;
            const charCenterX = charLeft + (charWidth / 2);
            
            // 根据平仄选择合适的字符集
            let chars;
            if (rhymeType === '△') {
                chars = rhymeData.pingChars;
            } else if (rhymeType === '▲') {
                chars = rhymeData.zeChars;
            } else {
                chars = [...rhymeData.pingChars, ...rhymeData.zeChars];
            }
            
            // 计算分页参数
            const CHARS_PER_PAGE = 24; // 每页显示6×4=24个字符
            const totalPages = Math.ceil(chars.length / CHARS_PER_PAGE);
            let currentPage = 1;
            
            // 添加内容 - 增加分页控制
            selector.innerHTML = `
                <div class="floating-rhyme-title">選擇${rhymeTypeName}「${originalChar}」的替換字 - ${rhymeData.name}</div>
                <div class="floating-rhyme-grid" id="floatingRhymeGrid"></div>
                <div class="rhyme-selector-controls">
                    <button class="rhyme-nav-button prev-button" id="prevPageBtn" ${currentPage <= 1 ? 'disabled' : ''}>&laquo;</button>
                    <div class="rhyme-page-indicator" id="pageIndicator">
                        ${Array(totalPages).fill(0).map((_, i) => 
                            `<div class="rhyme-page-dot ${i+1 === currentPage ? 'active' : ''}" data-page="${i+1}"></div>`
                        ).join('')}
                    </div>
                    <button class="rhyme-nav-button next-button" id="nextPageBtn" ${currentPage >= totalPages ? 'disabled' : ''}>&raquo;</button>
                </div>
            `;
            
            // 创建半透明遮罩层
            const overlay = document.createElement('div');
            overlay.className = 'rhyme-overlay';
            document.body.appendChild(overlay);
            
            // 先添加到DOM以获取尺寸
            document.body.appendChild(selector);
            
            // 填充当前页的韻字网格
            function renderCurrentPage() {
                const grid = selector.querySelector('#floatingRhymeGrid');
                grid.innerHTML = ''; // 清空当前内容
                
                const startIdx = (currentPage - 1) * CHARS_PER_PAGE;
                const endIdx = Math.min(startIdx + CHARS_PER_PAGE, chars.length);
                const currentPageChars = chars.slice(startIdx, endIdx);
                
                // 显示当前页的字符
                currentPageChars.forEach(char => {
                    const btn = document.createElement('button');
                    btn.className = 'floating-rhyme-char';
                    btn.textContent = char;
                    btn.dataset.char = char;
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        selectRhymeChar(span, char, originalChar);
                    };
                    grid.appendChild(btn);
                });
                
                // 更新分页控制
                const prevBtn = selector.querySelector('#prevPageBtn');
                const nextBtn = selector.querySelector('#nextPageBtn');
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
                
                // 更新页面指示器
                const dots = selector.querySelectorAll('.rhyme-page-dot');
                dots.forEach(dot => {
                    const page = parseInt(dot.dataset.page);
                    if (page === currentPage) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
            
            // 初始渲染第一页
            renderCurrentPage();
            
            // 添加分页控制事件
            const prevBtn = selector.querySelector('#prevPageBtn');
            const nextBtn = selector.querySelector('#nextPageBtn');
            
            prevBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentPage > 1) {
                    currentPage--;
                    renderCurrentPage();
                }
            });
            
            nextBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCurrentPage();
                }
            });
            
            // 页面指示器点击事件
            const pageIndicator = selector.querySelector('#pageIndicator');
            pageIndicator.addEventListener('click', (e) => {
                e.stopPropagation();
                if (e.target.classList.contains('rhyme-page-dot')) {
                    const page = parseInt(e.target.dataset.page);
                    if (page !== currentPage) {
                        currentPage = page;
                        renderCurrentPage();
                    }
                }
            });
            
            // 现在获取准确的选择器尺寸
            const selectorWidth = selector.offsetWidth;
            const selectorHeight = selector.offsetHeight;
            
            // 获取视窗尺寸
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // 设置安全距离
            const safeDistance = 10; // 输入框下方只需要小距离即可
            
            // 定位策略：优先放在输入框正下方（像下拉菜单一样）
            let selectorTop;
            let selectorLeft;
            
            // 检查下方空间是否足够
            if (viewportHeight - charBottom > selectorHeight + safeDistance) {
                // 优先选择：放在字符/输入框正下方
                selectorTop = charBottom + safeDistance;
            } 
            // 如果下方空间不足，则放在上方
            else if (charTop > selectorHeight + safeDistance) {
                // 放在字符上方
                selectorTop = charTop - selectorHeight - safeDistance;
            } 
            // 最后选择：空间不足时尽量放在合适位置
            else {
                // 如果上下都不够，优先放在页面中央位置
                selectorTop = Math.max(10, (viewportHeight - selectorHeight) / 2);
            }
            
            // 水平对齐：优先与字符左对齐（像下拉菜单），确保能完全显示
            selectorLeft = charLeft;
            
            // 确保选择器不会超出右边界
            if (selectorLeft + selectorWidth > viewportWidth - 10) {
                // 如果超出右边界，尝试右对齐
                selectorLeft = charLeft + charWidth - selectorWidth;
                
                // 如果还是不行，就居中对齐
                if (selectorLeft < 10) {
                    selectorLeft = charCenterX - (selectorWidth / 2);
                    
                    // 最后确保不会超出左右边界
                    selectorLeft = Math.max(10, Math.min(viewportWidth - selectorWidth - 10, selectorLeft));
                }
            }
            
            // 最终应用选择器位置
            selector.style.left = `${selectorLeft}px`;
            selector.style.top = `${selectorTop}px`;
            selector.style.visibility = 'visible'; // 现在可以显示了
            
            // 添加小箭头指示（如果是下拉模式）
            if (viewportHeight - charBottom > selectorHeight + safeDistance) {
                selector.style.borderTopLeftRadius = '0';
                selector.style.borderTopRightRadius = '0';
                // 可以在这里添加一个小箭头元素指向输入框
            }
            
            // 高亮显示当前正在编辑的字符
            if (!isEditMode) { // 如果不是编辑模式，才添加高亮
                span.classList.add('actively-editing');
            }
            
            // 阻止选择器内部点击事件冒泡
            selector.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 保存引用以便关闭时使用
            window.currentRhymeSelector = selector;
            window.currentRhymeOverlay = overlay;
            
            // 點擊文檔其他地方時關閉選擇器
            setTimeout(() => {
                document.addEventListener('click', closeRhymeSelectorOnClickOutside);
            }, 10);
        }
        
        // 點擊外部時關閉韻字選擇器
        function closeRhymeSelectorOnClickOutside(e) {
            const selector = window.currentRhymeSelector;
            if (selector && !selector.contains(e.target) && !e.target.classList.contains('char-span')) {
                closeRhymeSelector();
                document.removeEventListener('click', closeRhymeSelectorOnClickOutside);
            }
        }

        // 選擇韻字
        function selectRhymeChar(span, char, originalChar) {
            span.innerHTML = char;
            
            if (char !== originalChar) {
                span.classList.add('modified');
                modifiedChars.add(span);
            } else {
                span.classList.remove('modified');
                modifiedChars.delete(span);
            }
            
            updateStats();
            // 选择字符后自动关闭选择器窗口
            closeRhymeSelector();
        }

        // 關閉韻字選擇器
        function closeRhymeSelector() {
            if (window.currentRhymeSelector) {
                document.body.removeChild(window.currentRhymeSelector);
                window.currentRhymeSelector = null;
            }
            if (window.currentRhymeOverlay) {
                document.body.removeChild(window.currentRhymeOverlay);
                window.currentRhymeOverlay = null;
            }
            
            // 移除正在编辑的字符高亮
            document.querySelectorAll('.actively-editing').forEach(el => {
                el.classList.remove('actively-editing');
            });
            
            // 清除事件监听器
            document.removeEventListener('click', closeRhymeSelectorOnClickOutside);
        }

        // 查找字符属于哪个韵部
        function findRhymeGroup(char) {
            for (let groupId in rhymeDatabase) {
                const group = rhymeDatabase[groupId];
                if (group.pingChars.includes(char) || group.zeChars.includes(char)) {
                    return parseInt(groupId);
                }
            }
            return null;
        }

        // 更新統計信息
        function updateStats() {
            const totalChars = document.querySelectorAll('.char-span').length;
            const modifiedCount = modifiedChars.size;
            const modifyRate = totalChars > 0 ? Math.round((modifiedCount / totalChars) * 100) : 0;

            document.getElementById('modifiedCount').textContent = modifiedCount;
            document.getElementById('totalCount').textContent = totalChars;
            document.getElementById('modifyRate').textContent = modifyRate + '%';
        }

        // 重置詞作
        function resetPoem() {
            if (!currentPoem) return;

            document.querySelectorAll('.char-span').forEach(span => {
                span.classList.remove('modified', 'editing');
            });
            
            modifiedChars.clear();
            currentRhymeGroups = {};
            renderPoemWithPattern();
            showFeedback('已恢復為原作', 'info');
        }

        // 複製文本到剪貼板
        function copyTextToClipboard() {
            if (!currentPoem) return;

            const modifiedCount = modifiedChars.size;
            
            // 即使没有修改，也允许复制原文
            // if (modifiedCount === 0) {
            //     showFeedback('您還沒有進行任何修改', 'info');
            //     return;
            // }

            const modifiedContent = getModifiedContent();
            const authorText = currentAuthor || currentPoem.author;
            const textToCopy = `${currentCipai}\n${authorText}\n${modifiedContent}`;
            
            // 使用Clipboard API複製文本
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showFeedback(`文本已複製到剪貼板！`, 'success');
                })
                .catch(err => {
                    showFeedback(`複製失敗: ${err}`, 'warning');
                    console.error('複製失敗:', err);
                });
        }
        
        // 保留兼容性
        function saveCreation() {
            copyTextToClipboard();
        }

        // 海報生成器相關功能
        // 打開海報生成窗口
        function openPosterGenerator() {
            const posterModal = document.getElementById('posterModal');
            if (posterModal) {
                posterModal.style.display = 'flex';
                
                // 關閉按鈕事件
                document.getElementById('posterModalClose').onclick = function() {
                    posterModal.style.display = 'none';
                };
                
                // 初始化設置和事件
                initPosterGenerator();
            } else {
                console.error('找不到海報生成器模態窗口');
            }
        }
        
        // 初始化海報生成器
        function initPosterGenerator() {
            // 默认选择宣纸风格并生成壁纸
            document.querySelectorAll('.style-button').forEach(button => {
                button.addEventListener('click', function() {
                    // 移除其他按钮的活跃状态
                    document.querySelectorAll('.style-button').forEach(b => b.classList.remove('active'));
                    // 添加当前按钮的活跃状态
                    this.classList.add('active');
                    // 获取风格
                    const style = this.dataset.style;
                    // 生成壁纸
                    generatePosterFromStyle(style);
                });
            });
            
            // 默认选择宣纸风格并生成壁纸
            generatePosterFromStyle('xuan');
            
            // 下載按鈕事件
            document.getElementById('downloadPosterBtn').onclick = downloadPoster;
            
            // 關閉按鈕點擊外部區域時關閉窗口
            document.getElementById('posterModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // 清除以前的圖像
            document.getElementById('posterCanvas').style.display = 'none';
            document.getElementById('posterPlaceholder').style.display = 'flex';
            document.getElementById('downloadPosterBtn').disabled = true;
        }
        
        // 自动生成海报 (从风格卡片直接生成)
        function generatePosterFromStyle(style) {
            if (!currentPoem) {
                alert('請先選擇一首詞作');
                return;
            }
            
            // 显示预览区域
            document.getElementById('posterPreviewSection').style.display = 'block';
            
            // 顯示加載中
            const loadingEl = document.getElementById('posterLoading');
            loadingEl.style.display = 'flex';
            
            // 设置样式
            const settings = {
                posterStyle: style,
                decorStyle: 'simple', // 默认简约风格
                fontStyle: 'kai', // 默认楷体
                showCipaiTitle: true,
                showAuthor: true,
                textureStrength: 0.5,
                posterSize: '9:16', // 默认手机壁纸比例
                
                // 詞作數據
                cipaiName: currentCipai,
                author: currentAuthor || currentPoem.author,
                content: getModifiedContent().split('\n')
            };
            
            // 異步生成海報
            setTimeout(() => {
                try {
                    // 創建和配置畫布
                    const canvas = setupCanvas(settings);
                    
                    // 繪製背景
                    drawBackground(canvas, settings);
                    
                    // 繪製詞作內容
                    drawPoem(canvas, settings);
                    
                    // 顯示海報
                    const canvasEl = document.getElementById('posterCanvas');
                    canvasEl.style.display = 'block';
                    
                    // 啟用下載按鈕
                    document.getElementById('downloadPosterBtn').disabled = false;
                } catch (error) {
                    console.error('生成海報時出錯:', error);
                    alert('生成海報時出錯: ' + error.message);
                } finally {
                    // 隱藏加載中
                    loadingEl.style.display = 'none';
                }
            }, 500); // 延遲執行以顯示加載動畫
        }
        
        // 獲取海報設置
        function getPosterSettings() {
            const settings = {
                posterStyle: document.getElementById('posterStyle').value,
                decorStyle: document.getElementById('decorStyle').value,
                fontStyle: document.getElementById('fontStyle').value,
                showCipaiTitle: document.getElementById('showCipaiTitle').checked,
                showAuthor: document.getElementById('showAuthor').checked,
                textureStrength: parseInt(document.getElementById('textureStrength').value) / 100,
                posterSize: document.getElementById('posterSize').value,
                
                // 詞作數據
                cipaiName: currentCipai,
                author: currentAuthor || currentPoem.author,
                content: getModifiedContent().split('\n'),
                
                // 設計參數
                fontSize: 0, // 將根據畫布大小計算
                lineHeight: 0,
                marginTop: 0,
                marginRight: 0,
                titleSize: 0,
                authorSize: 0
            };
            
            return settings;
        }
        
        // 設置畫布
        function setupCanvas(settings) {
            const canvas = document.getElementById('posterCanvas');
            const ctx = canvas.getContext('2d');
            
            // 設置畫布尺寸
            let width, height;
            const baseSize = 1200; // 基礎尺寸
            
            switch (settings.posterSize) {
                case '16:9':
                    width = baseSize;
                    height = Math.round(baseSize * (9/16));
                    break;
                case '9:16':
                    width = Math.round(baseSize * (9/16));
                    height = baseSize;
                    break;
                case '1:1':
                    width = baseSize;
                    height = baseSize;
                    break;
                case '4:3':
                    width = baseSize;
                    height = Math.round(baseSize * (3/4));
                    break;
                default:
                    width = Math.round(baseSize * (9/16));
                    height = baseSize;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // 計算字體大小和間距
            settings.fontSize = Math.round(width * 0.055); // 基礎字體大小
            settings.lineHeight = Math.round(settings.fontSize * 1.7); // 行高
            settings.marginTop = Math.round(height * 0.12); // 頂部邊距
            settings.marginRight = Math.round(width * 0.15); // 右側邊距（豎排從右向左）
            settings.titleSize = Math.round(settings.fontSize * 1.5); // 標題字體大小
            settings.authorSize = Math.round(settings.fontSize * 0.8); // 作者字體大小
            
            return {canvas, ctx, width, height, settings};
        }
        
        // 繪製背景
        function drawBackground({canvas, ctx, width, height, settings}) {
            // 清除畫布
            ctx.clearRect(0, 0, width, height);
            
            // 背景色和紋理
            let bgColor, textColor, borderColor;
            
            switch (settings.posterStyle) {
                case 'xuan': // 宣紙風格
                    bgColor = '#f9f2dc';
                    textColor = '#333333';
                    borderColor = '#d9b27c';
                    break;
                case 'mo': // 墨韻風格
                    bgColor = '#1c1c1c';
                    textColor = '#e8e8e8';
                    borderColor = '#555555';
                    break;
                case 'qinghua': // 青花風格
                    bgColor = '#e8f2f7';
                    textColor = '#245a7a';
                    borderColor = '#6b93ad';
                    break;
                case 'danqing': // 丹心風格
                    bgColor = '#fff2f2';
                    textColor = '#8a292d';
                    borderColor = '#c24e54';
                    break;
                case 'songyan': // 松煙風格
                    bgColor = '#e6efe0';
                    textColor = '#1c4024';
                    borderColor = '#587f5e';
                    break;
                case 'zhujian': // 竹簡風格
                    bgColor = '#e0d4b8';
                    textColor = '#5c3c10';
                    borderColor = '#9b7d56';
                    break;
                default:
                    bgColor = '#f9f2dc';
                    textColor = '#333333';
                    borderColor = '#d9b27c';
            }
            
            // 設置背景色
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, width, height);
            
            // 添加背景紋理
            if (settings.textureStrength > 0) {
                addBackgroundTexture(ctx, width, height, settings.textureStrength, settings.posterStyle);
            }
            
            // 添加裝飾風格
            addDecoration(ctx, width, height, settings);
            
            // 添加雙線邊框
            const borderWidth = Math.round(width * 0.02);
            const innerBorderWidth = Math.round(width * 0.01);
            const borderGap = Math.round(width * 0.01);
            
            // 繪製外邊框
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = borderWidth;
            ctx.strokeRect(borderWidth/2, borderWidth/2, width - borderWidth, height - borderWidth);
            
            // 繪製內邊框
            ctx.lineWidth = innerBorderWidth;
            ctx.strokeRect(borderWidth + borderGap + innerBorderWidth/2, 
                          borderWidth + borderGap + innerBorderWidth/2, 
                          width - 2*(borderWidth + borderGap + innerBorderWidth/2), 
                          height - 2*(borderWidth + borderGap + innerBorderWidth/2));
            
            // 返回顏色配置
            return {textColor, bgColor, borderColor};
        }
        
        // 添加背景紋理
        function addBackgroundTexture(ctx, width, height, strength, style) {
            ctx.save();
            
            // 設置透明度
            ctx.globalAlpha = strength * 0.3;
            
            // 紙質紋理
            for (let i = 0; i < width * height / 300; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const radius = Math.random() * 1.5 + 0.5;
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                
                // 根據風格設置紋理顏色
                if (style === 'mo') { // 墨韻風格
                    ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.03 + 0.01})`;
                } else if (style === 'qinghua') { // 青花風格
                    ctx.fillStyle = `rgba(36, 90, 122, ${Math.random() * 0.03 + 0.01})`;
                } else if (style === 'danqing') { // 丹青風格
                    ctx.fillStyle = `rgba(138, 41, 45, ${Math.random() * 0.03 + 0.01})`;
                } else if (style === 'songyan') { // 松煙風格
                    ctx.fillStyle = `rgba(28, 64, 36, ${Math.random() * 0.03 + 0.01})`;
                } else { // 宣紙風格
                    ctx.fillStyle = `rgba(0, 0, 0, ${Math.random() * 0.03 + 0.01})`;
                }
                
                ctx.fill();
            }
            
            // 線條紋理
            ctx.globalAlpha = strength * 0.05;
            
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const length = Math.random() * 100 + 50;
                const angle = Math.random() * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + Math.cos(angle) * length, y + Math.sin(angle) * length);
                
                // 根據風格設置線條顏色
                if (style === 'mo') { // 墨韻風格
                    ctx.strokeStyle = `rgba(255, 255, 255, ${Math.random() * 0.1 + 0.05})`;
                } else if (style === 'qinghua') { // 青花風格
                    ctx.strokeStyle = `rgba(36, 90, 122, ${Math.random() * 0.1 + 0.05})`;
                } else if (style === 'danqing') { // 丹青風格
                    ctx.strokeStyle = `rgba(138, 41, 45, ${Math.random() * 0.1 + 0.05})`;
                } else if (style === 'songyan') { // 松煙風格
                    ctx.strokeStyle = `rgba(28, 64, 36, ${Math.random() * 0.1 + 0.05})`;
                } else { // 宣紙風格
                    ctx.strokeStyle = `rgba(0, 0, 0, ${Math.random() * 0.1 + 0.05})`;
                }
                
                ctx.lineWidth = Math.random() * 0.5 + 0.5;
                ctx.stroke();
            }
            
            ctx.restore();
        }
        
        // 添加裝飾風格
        function addDecoration(ctx, width, height, settings) {
            const style = settings.decorStyle;
            
            if (style === 'simple') {
                // 簡約風格不添加額外裝飾
                return;
            }
            
            ctx.save();
            
            if (style === 'seal') {
                // 印章風格
                drawSeal(ctx, width, height, settings);
            } else if (style === 'ink') {
                // 水墨風格
                drawInkDecoration(ctx, width, height, settings);
            } else if (style === 'scroll') {
                // 古籍風格
                drawScrollDecoration(ctx, width, height, settings);
            }
            
            ctx.restore();
        }
        
        // 繪製印章
        function drawSeal(ctx, width, height, settings) {
            // 獲取顏色
            let sealColor;
            
            switch (settings.posterStyle) {
                case 'mo': // 墨韻風格
                    sealColor = 'rgba(240, 40, 40, 0.7)';
                    break;
                default:
                    sealColor = 'rgba(220, 20, 20, 0.7)';
            }
            
            // 計算印章大小和位置
            const sealSize = Math.min(width, height) * 0.2;
            const x = width * 0.8;
            const y = height * 0.8;
            
            // 繪製印章
            ctx.globalAlpha = 0.7;
            ctx.fillStyle = sealColor;
            
            ctx.beginPath();
            ctx.arc(x, y, sealSize, 0, Math.PI * 2);
            ctx.fill();
            
            // 繪製印章紋理
            ctx.globalAlpha = 0.9;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            
            // 內部方形
            ctx.beginPath();
            ctx.rect(x - sealSize * 0.7, y - sealSize * 0.7, sealSize * 1.4, sealSize * 1.4);
            ctx.stroke();
            
            // 內部線條
            const lines = 3;
            for (let i = 0; i < lines; i++) {
                const angle = Math.PI * 2 * i / lines;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + Math.cos(angle) * sealSize * 0.9, y + Math.sin(angle) * sealSize * 0.9);
                ctx.stroke();
            }
            
            ctx.globalAlpha = 1.0;
        }
        
        // 繪製水墨裝飾
        function drawInkDecoration(ctx, width, height, settings) {
            // 獲取顏色
            let inkColor;
            
            switch (settings.posterStyle) {
                case 'mo': // 墨韻風格
                    inkColor = 'rgba(255, 255, 255, 0.08)';
                    break;
                case 'qinghua': // 青花風格
                    inkColor = 'rgba(36, 90, 122, 0.1)';
                    break;
                case 'danqing': // 丹青風格
                    inkColor = 'rgba(138, 41, 45, 0.1)';
                    break;
                case 'songyan': // 松煙風格
                    inkColor = 'rgba(28, 64, 36, 0.1)';
                    break;
                default:
                    inkColor = 'rgba(0, 0, 0, 0.07)';
            }
            
            // 繪製墨跡
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = inkColor;
            
            // 上方裝飾
            const topSize = width * 0.3;
            ctx.beginPath();
            ctx.moveTo(width * 0.5, 0);
            ctx.bezierCurveTo(
                width * 0.3, height * 0.05,
                width * 0.2, height * 0.02,
                width * 0.1, height * 0.1
            );
            ctx.bezierCurveTo(
                width * 0.15, height * 0.15,
                width * 0.4, height * 0.12,
                width * 0.5, height * 0.08
            );
            ctx.bezierCurveTo(
                width * 0.6, height * 0.12,
                width * 0.85, height * 0.15,
                width * 0.9, height * 0.1
            );
            ctx.bezierCurveTo(
                width * 0.8, height * 0.02,
                width * 0.7, height * 0.05,
                width * 0.5, 0
            );
            ctx.fill();
            
            // 下方裝飾
            ctx.beginPath();
            ctx.moveTo(width * 0.5, height);
            ctx.bezierCurveTo(
                width * 0.3, height * 0.95,
                width * 0.2, height * 0.98,
                width * 0.1, height * 0.9
            );
            ctx.bezierCurveTo(
                width * 0.15, height * 0.85,
                width * 0.4, height * 0.88,
                width * 0.5, height * 0.92
            );
            ctx.bezierCurveTo(
                width * 0.6, height * 0.88,
                width * 0.85, height * 0.85,
                width * 0.9, height * 0.9
            );
            ctx.bezierCurveTo(
                width * 0.8, height * 0.98,
                width * 0.7, height * 0.95,
                width * 0.5, height
            );
            ctx.fill();
            
            ctx.globalAlpha = 1.0;
        }
        
        // 繪製古籍裝飾
        function drawScrollDecoration(ctx, width, height, settings) {
            // 獲取顏色
            let lineColor;
            
            switch (settings.posterStyle) {
                case 'mo': // 墨韻風格
                    lineColor = 'rgba(255, 255, 255, 0.2)';
                    break;
                case 'qinghua': // 青花風格
                    lineColor = 'rgba(36, 90, 122, 0.2)';
                    break;
                case 'danqing': // 丹青風格
                    lineColor = 'rgba(138, 41, 45, 0.2)';
                    break;
                case 'songyan': // 松煙風格
                    lineColor = 'rgba(28, 64, 36, 0.2)';
                    break;
                default:
                    lineColor = 'rgba(0, 0, 0, 0.15)';
            }
            
            // 繪製線條
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 1;
            
            // 繪製豎線
            const numLines = Math.floor(width / 30);
            const lineSpacing = width / (numLines + 1);
            
            for (let i = 1; i <= numLines; i++) {
                const x = i * lineSpacing;
                ctx.beginPath();
                ctx.moveTo(x, height * 0.05);
                ctx.lineTo(x, height * 0.95);
                ctx.stroke();
            }
            
            // 繪製橫線
            ctx.beginPath();
            ctx.moveTo(width * 0.05, height * 0.05);
            ctx.lineTo(width * 0.95, height * 0.05);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(width * 0.05, height * 0.95);
            ctx.lineTo(width * 0.95, height * 0.95);
            ctx.stroke();
        }
        
        // 繪製詞作內容 - 全新改版
        function drawPoem({ctx, width, height, settings}) {
            // 獲取顏色配置
            let textColor;
            
            switch (settings.posterStyle) {
                case 'mo': // 墨韻風格
                    textColor = '#e8e8e8';
                    break;
                case 'qinghua': // 青花風格
                    textColor = '#245a7a';
                    break;
                case 'danqing': // 丹青風格
                    textColor = '#8a292d';
                    break;
                case 'songyan': // 松煙風格
                    textColor = '#1c4024';
                    break;
                case 'zhujian': // 竹簡風格
                    textColor = '#5c3c10';
                    break;
                default: // 宣紙風格
                    textColor = '#333333';
            }
            
            // 設置字體風格 - 強制使用LXGW文楷作為詞作正文字體
            let fontFamily = "'LXGW WenKai', '楷體', 'KaiTi', serif";
            
            ctx.fillStyle = textColor;
            
            // 定義邊框和邊距
            const borderWidth = Math.round(width * 0.02);
            const safeMargin = borderWidth * 1.5; // 安全邊距
            
            // 計算詞牌基本信息
            const cipaiName = settings.cipaiName;
            const cipaiData = cipaiPatterns[cipaiName];
            const breakpoint = cipaiData ? cipaiData.breakpoint : null; // 取得上下闕分界點
            
            // 詞行和總行數
            const lines = settings.content;
            const totalLines = lines.length;
            
            // 分析上下闕
            let upperLines = lines;
            let lowerLines = [];
            
            // 如果有分界點並且行數足夠，分為上下闕
            if (breakpoint && totalLines > breakpoint && breakpoint < totalLines) {
                upperLines = lines.slice(0, breakpoint);
                lowerLines = lines.slice(breakpoint);
            }
            
            // 計算基本尺寸參數
            const titleWidth = width * 0.12; // 標題區域寬度
            const authorWidth = width * 0.10; // 作者區域寬度
            const contentWidth = width - titleWidth - authorWidth - (safeMargin * 2); // 內容區域寬度
            
            // 增加標題和作者與邊框的距離，確保一致性
            const edgeMargin = safeMargin * 2.5; // 增加邊緣間距，並確保一致性
            
            // 計算X座標位置 (從右向左)
            const titleX = width - edgeMargin - titleWidth/2; // 標題位置，距離右邊框更遠
            const titleContentGap = width * 0.08; // 標題和內容之間的空白豎行寬度
            const contentRight = width - edgeMargin - titleWidth - titleContentGap; // 內容右邊界，增加了空白豎行
            const authorX = edgeMargin + authorWidth/2; // 作者位置，距離左邊框更遠
            
            // 計算標題字體大小與間距
            let titleSize = Math.round(width * 0.045); // 標題基礎字體大小
            if (settings.cipaiName.length > 7) {
                titleSize = Math.round(titleSize * (7 / settings.cipaiName.length));
            }
            
            // 計算內容字體大小
            const baseContentFontSize = Math.round(width * 0.04); // 內容基礎字體大小
            
            // 計算所有行中的最大字符數
            const maxCharsInLine = Math.max(...lines.map(line => line.length));
            
            // 計算上下闕各自的最大字符數
            const maxUpperChars = Math.max(...upperLines.map(line => line.length));
            const maxLowerChars = lowerLines.length ? Math.max(...lowerLines.map(line => line.length)) : 0;
            
            // 根據行數調整字體大小
            let fontSize = baseContentFontSize;
            if (totalLines > 12) {
                fontSize = Math.max(baseContentFontSize * 0.8, baseContentFontSize * (12 / totalLines));
            }
            
            // 計算行間距 (每行的寬度，從右向左)
            const totalContentWidth = contentWidth * 0.95; // 內容區域有效寬度，稍微收縮以確保美觀
            
            // 動態調整行間距
            let lineSpacing;
            if (lowerLines.length > 0) {
                // 上下闕分別布局
                const upperLineSpacing = Math.min(totalContentWidth / upperLines.length, fontSize * 2);
                const lowerLineSpacing = Math.min(totalContentWidth / lowerLines.length, fontSize * 2);
                lineSpacing = Math.min(upperLineSpacing, lowerLineSpacing); // 使用較小的間距保持一致性
            } else {
                // 單一布局
                lineSpacing = Math.min(totalContentWidth / totalLines, fontSize * 2);
            }
            
            // 計算字間距
            const charSpacing = fontSize * 1.4; // 字符垂直間距
            
            // 繪製詞牌名（標題）- 豎排在右側
            if (settings.showCipaiTitle) {
                ctx.font = `bold ${titleSize}px ${fontFamily}`;
                const titleChars = settings.cipaiName.split('');
                const titleSpacing = Math.min(titleSize * 1.4, height * 0.6 / titleChars.length);
                const titleStartY = safeMargin * 6 + titleSize/2; // 進一步增加標題與頂部邊框的距離
                
                // 繪製豎排標題
                for (let i = 0; i < titleChars.length; i++) {
                    const char = titleChars[i];
                    const metrics = ctx.measureText(char);
                    const charWidth = metrics.width;
                    const charY = titleStartY + i * titleSpacing;
                    ctx.fillText(char, titleX - charWidth/2, charY);
                }
            }
            
            // 繪製作者 - 豎排在左側底部
            if (settings.showAuthor) {
                const authorSize = Math.round(fontSize * 0.8); // 作者字體大小
                ctx.font = `${authorSize}px ${fontFamily}`;
                const authorChars = settings.author.split('');
                const authorSpacing = authorSize * 1.3;
                const authorTotalHeight = authorChars.length * authorSpacing;
                const authorStartY = height - safeMargin * 3; // 底部固定位置
                
                // 繪製豎排作者名
                for (let i = 0; i < authorChars.length; i++) {
                    const char = authorChars[i];
                    const metrics = ctx.measureText(char);
                    const charWidth = metrics.width;
                    const charY = authorStartY - authorTotalHeight + i * authorSpacing;
                    ctx.fillText(char, authorX - charWidth/2, charY);
                }
            }
            
            // 設置詞作內容字體
            ctx.font = `${fontSize}px ${fontFamily}`;
            
            // 如果需要分上下闕顯示
            if (lowerLines.length > 0) {
                // 上闕高度
                const upperHeight = maxUpperChars * charSpacing;
                // 下闕高度
                const lowerHeight = maxLowerChars * charSpacing;
                
                // 計算詞牌與詞句間的間隔（豎排布局中的豎行間距是水平方向的）
                const titleContentGap = lineSpacing * 1.5; // 設置為一個半豎行的寬度
                
                // 上闕起始Y位置 (上方區域) - 增加與上方邊框的距離
                const upperStartY = safeMargin * 5 + charSpacing * 2; // 增加頂部邊距約兩個字符的距離
                
                // 下闕起始Y位置 (下方區域) - 保持對稱
                const lowerStartY = height/2 + safeMargin * 5; // 保持與上闕相同的邊距
                
                // 繪製分隔線
                ctx.save();
                ctx.strokeStyle = textColor;
                ctx.globalAlpha = 0.3;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(width * 0.1, height/2);
                ctx.lineTo(width * 0.9, height/2);
                ctx.stroke();
                ctx.restore();
                
                // 計算上下闕的行數
                const numUpperLines = upperLines.length;
                const numLowerLines = lowerLines.length;
                
                // 徹底重構繪製邏輯，解決上下闋對齊問題
                
                // 預先計算所有行的X座標，確保上下闋第一行精確對齊
                const allLinesX = []; // 存儲所有行的X座標（包括上下闕）
                
                // 第一步：計算所有行的理想X座標
                const totalLines = numUpperLines + numLowerLines;
                const firstColumnX = contentRight; // 第一列（最右側）固定位置
                
                // 確保適當的行間距，無論行數如何
                const commonLineSpacing = Math.min(
                    totalContentWidth / Math.max(numUpperLines, numLowerLines),
                    fontSize * 2
                );
                
                // 第二步：使用同一算法計算所有行的X座標
                for (let i = 0; i < totalLines; i++) {
                    if (i < numUpperLines) {
                        // 上闕行
                        allLinesX.push(firstColumnX - i * commonLineSpacing);
                    } else if (i === numUpperLines) {
                        // 下闕第一行 - 向右偏移一個豎行位置，使其與上闕第一行對齊
                        allLinesX.push(firstColumnX + commonLineSpacing); // 增加了commonLineSpacing向右偏移
                    } else {
                        // 下闕其他行 - 基於下闕第一行的位置計算
                        const lowerLineIndex = i - numUpperLines;
                        // 注意：這裡使用下闕第一行的X座標作為基準，減去行索引乘以間距
                        allLinesX.push(firstColumnX + commonLineSpacing - lowerLineIndex * commonLineSpacing);
                    }
                }
                
                // 第三步：基於預計算的座標繪製上闕
                for (let i = 0; i < numUpperLines; i++) {
                    const line = upperLines[i];
                    const lineX = allLinesX[i];
                    
                    // 繪製每個字
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const metrics = ctx.measureText(char);
                        const charWidth = metrics.width;
                        const charY = upperStartY + j * charSpacing;
                        ctx.fillText(char, lineX - charWidth/2, charY);
                    }
                }
                
                // 第四步：基於預計算的座標繪製下闕
                for (let i = 0; i < numLowerLines; i++) {
                    const line = lowerLines[i];
                    const lineX = allLinesX[numUpperLines + i]; // 使用預計算的X座標
                    
                    // 繪製每個字
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const metrics = ctx.measureText(char);
                        const charWidth = metrics.width;
                        const charY = lowerStartY + j * charSpacing;
                        ctx.fillText(char, lineX - charWidth/2, charY);
                    }
                }
                
                // 額外調試信息 - 在控制台打印出座標值，便於確認
                console.log("上闕第一行X座標:", allLinesX[0]);
                console.log("下闕第一行X座標:", allLinesX[numUpperLines]);
                if (allLinesX[0] === allLinesX[numUpperLines]) {
                    console.log("✓ 上下闕第一行X座標完全一致");
                } else {
                    console.log("✗ 上下闕第一行X座標不一致");
                }
            } else {
                // 不分上下闕，單一布局
                // 计算内容总高度
                const totalContentHeight = maxCharsInLine * charSpacing;
                // 计算垂直居中的起始位置（增加了顶部边距）
                const contentStartY = Math.max(
                    safeMargin * 6, // 大幅增加顶部最小边距
                    (height - totalContentHeight) / 2 // 垂直居中处理
                );
                
                // 从右向左绘制每一行
                for (let i = 0; i < totalLines; i++) {
                    const line = lines[i];
                    const lineX = contentRight - i * lineSpacing;
                    
                    // 豎排每個字
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        const metrics = ctx.measureText(char);
                        const charWidth = metrics.width;
                        const charY = contentStartY + j * charSpacing;
                        ctx.fillText(char, lineX - charWidth/2, charY);
                    }
                }
            }
        }
        
        // 下載海報
        function downloadPoster() {
            const canvas = document.getElementById('posterCanvas');
            
            if (!canvas) {
                alert('未找到海報畫布');
                return;
            }
            
            // 創建臨時鏈接
            const link = document.createElement('a');
            
            // 設置下載文件名
            const fileName = `${currentCipai}_${currentAuthor || currentPoem.author}.png`;
            link.download = fileName;
            
            // 設置圖像數據
            link.href = canvas.toDataURL('image/png');
            
            // 模擬點擊下載
            link.click();
        }

        // 獲取修改後的內容
        function getModifiedContent() {
            let content = '';
            document.querySelectorAll('.poem-line').forEach(line => {
                line.childNodes.forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        content += node.textContent;
                    } else if (node.tagName === 'SPAN') {
                        content += node.textContent;
                    }
                });
                content += '\n';
            });
            return content.trim();
        }

        // 顯示反饋信息
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.innerHTML = message.replace(/\n/g, '<br>');
            feedback.className = `feedback ${type}`;
            
            setTimeout(() => {
                if (type !== 'success') {
                    feedback.innerHTML = '';
                    feedback.className = '';
                }
            }, 5000);
        }

        // 移動端和桌面端視圖切換功能
        function initMobileViewToggle() {
            const container = document.querySelector('.container');
            const mainContent = document.querySelector('.main-content');
            const sidebarContainer = document.getElementById('sidebarContainer');
            const contentContainer = document.getElementById('contentContainer');
            
            // 添加滑動指示器元素 - 移除文字提示以避免在非移動端顯示
            const leftIndicator = document.createElement('div');
            leftIndicator.className = 'swipe-indicator swipe-indicator-left';
            leftIndicator.innerHTML = `
                <div class="swipe-arrow swipe-arrow-left"></div>
                <div class="swipe-arrow swipe-arrow-left"></div>
            `;
            
            const rightIndicator = document.createElement('div');
            rightIndicator.className = 'swipe-indicator swipe-indicator-right';
            rightIndicator.innerHTML = `
                <div class="swipe-arrow swipe-arrow-right"></div>
                <div class="swipe-arrow swipe-arrow-right"></div>
            `;
            
            // 添加滑動提示元素
            const swipeHint = document.createElement('div');
            swipeHint.className = 'swipe-hint';
            swipeHint.textContent = '左右滑動切換界面';
            
            // 添加滑動進度條
            const swipeProgress = document.createElement('div');
            swipeProgress.className = 'swipe-progress';
            
            // 將元素添加到DOM
            mainContent.appendChild(leftIndicator);
            mainContent.appendChild(rightIndicator);
            document.body.appendChild(swipeHint);
            mainContent.appendChild(swipeProgress);
            
            // 設置默認視圖 - 桌面默認顯示詞牌列表，移動端默認顯示詞牌列表
            if (window.innerWidth <= 768) {
                container.classList.add('mobile-view-list'); // 修改：默认显示词牌列表
                
                // 初次加載時顯示滑動指示 (延遲幾秒後顯示)
                setTimeout(() => {
                    showSwipeInstructions();
                }, 2000);
            }
            
            // 初始化視圖狀態
            if (window.innerWidth <= 768) {
                // 移動端：使用保存的視圖模式或默認為詞牌列表視圖
                const savedMode = window.nanfengViewMode || 'list';
                if (savedMode === 'list') {
                    container.classList.remove('mobile-view-edit');
                    container.classList.add('mobile-view-list');
                } else {
                    container.classList.remove('mobile-view-list');
                    container.classList.add('mobile-view-edit');
                }
            } else {
                // 桌面端：根據保存的側邊欄狀態設置
                const sidebarVisible = window.sidebarVisible;
                if (sidebarVisible === false) {
                    container.classList.add('sidebar-hidden');
                } else {
                    container.classList.remove('sidebar-hidden');
                }
            }
            
            // 窗口大小變化時的處理
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    // 切換到桌面模式
                    container.classList.remove('mobile-view-list', 'mobile-view-edit');
                    
                    // 根據保存的側邊欄狀態設置
                    const sidebarVisible = window.sidebarVisible;
                    if (sidebarVisible === false) {
                        container.classList.add('sidebar-hidden');
                    } else {
                        container.classList.remove('sidebar-hidden');
                    }
                } else {
                    // 切換到移動模式
                    const currentMode = window.nanfengViewMode || 'edit';
                    if (currentMode === 'list') {
                        container.classList.remove('mobile-view-edit');
                        container.classList.add('mobile-view-list');
                    } else {
                        container.classList.remove('mobile-view-list');
                        container.classList.add('mobile-view-edit');
                    }
                }
            });
            
            // 初始化滑動觸控事件
            initSwipeGestures();
            
            // 切換到列表視圖
            function switchToListView() {
                container.classList.add('view-transitioning');
                container.classList.remove('mobile-view-edit');
                container.classList.add('mobile-view-list');
                window.nanfengViewMode = 'list';
                cipaiToggleText.textContent = "開始創作";
                
                // 結束過渡動畫
                setTimeout(() => {
                    container.classList.remove('view-transitioning');
                }, 500);
            }
            
            // 切換到編輯視圖
            function switchToEditView() {
                container.classList.add('view-transitioning');
                container.classList.remove('mobile-view-list');
                container.classList.add('mobile-view-edit');
                window.nanfengViewMode = 'edit';
                cipaiToggleText.textContent = "查看詞牌";
                
                // 結束過渡動畫
                setTimeout(() => {
                    container.classList.remove('view-transitioning');
                }, 500);
            }
            
            // 切換移動視圖
            function toggleMobileView() {
                if (container.classList.contains('mobile-view-edit')) {
                    switchToListView();
                } else {
                    switchToEditView();
                }
            }
            
            // 初始化滑動手勢
            function initSwipeGestures() {
                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let touchEndY = 0;
                let currentSwipeDistance = 0;
                let isSwipeInProgress = false;
                let swipeStartTime = 0;
                const minSwipeDistance = 50; // 減小最小滑動距離，使滑動更容易觸發
                const maxSwipeTime = 600; // 增加最大滑動時間，使滑動更容易觸發
                const maxVerticalOffset = 100; // 增加最大垂直偏移量，更寬容的判定
                
                mainContent.addEventListener('touchstart', function(e) {
                    if (window.innerWidth > 768) return;
                    
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                    swipeStartTime = Date.now();
                    isSwipeInProgress = true;
                    currentSwipeDistance = 0;
                    swipeProgress.style.width = '0%';
                    
                    // 輸出調試信息
                    console.log("觸摸開始: ", touchStartX, touchStartY);
                });
                
                mainContent.addEventListener('touchmove', function(e) {
                    if (!isSwipeInProgress || window.innerWidth > 768) return;
                    
                    const currentX = e.changedTouches[0].screenX;
                    const currentY = e.changedTouches[0].screenY;
                    const deltaX = currentX - touchStartX;
                    const deltaY = currentY - touchStartY;
                    
                    // 輸出調試信息
                    console.log("觸摸移動: ", deltaX, deltaY);
                    
                    // 檢查是否主要是水平滑動
                    if (Math.abs(deltaY) > maxVerticalOffset && Math.abs(deltaY) > Math.abs(deltaX) * 1.5) {
                        // 這是垂直滑動，不處理
                        console.log("判定為垂直滑動，忽略");
                        isSwipeInProgress = false;
                        swipeProgress.style.width = '0%';
                        return;
                    }
                    
                    // 這是水平滑動，更新進度條
                    currentSwipeDistance = deltaX;
                    const screenWidth = window.innerWidth;
                    let progressPercent;
                    
                    // 視圖切換方向取決於當前視圖和滑動方向
                    if (container.classList.contains('mobile-view-edit')) {
                        // 從編輯視圖向右滑動到詞牌列表
                        if (deltaX > 0) {
                            progressPercent = Math.min(100, (deltaX / minSwipeDistance) * 80);
                            showSwipeHint("右滑 → 查看詞牌");
                            console.log("編輯視圖向右滑動: ", progressPercent, "%");
                        } else {
                            progressPercent = 0;
                        }
                    } else {
                        // 從詞牌列表向左滑動到編輯視圖
                        if (deltaX < 0) {
                            progressPercent = Math.min(100, (Math.abs(deltaX) / minSwipeDistance) * 80);
                            showSwipeHint("← 左滑 創作界面");
                            console.log("列表視圖向左滑動: ", progressPercent, "%");
                        } else {
                            progressPercent = 0;
                        }
                    }
                    
                    // 更新進度條
                    swipeProgress.style.width = progressPercent + '%';
                    
                    // 防止頁面滾動
                    if (Math.abs(deltaX) > 10 && Math.abs(deltaX) > Math.abs(deltaY)) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                mainContent.addEventListener('touchend', function(e) {
                    if (!isSwipeInProgress || window.innerWidth > 768) return;
                    
                    touchEndX = e.changedTouches[0].screenX;
                    touchEndY = e.changedTouches[0].screenY;
                    const swipeTime = Date.now() - swipeStartTime;
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    
                    // 輸出調試信息
                    console.log("觸摸結束: ", deltaX, deltaY, "耗時: ", swipeTime, "ms");
                    
                    isSwipeInProgress = false;
                    swipeProgress.style.width = '0%';
                    hideSwipeHint();
                    
                    // 檢查是否有效的水平滑動 - 更寬容的判定條件
                    if (Math.abs(deltaX) >= minSwipeDistance && 
                        Math.abs(deltaY) <= maxVerticalOffset && 
                        swipeTime <= maxSwipeTime) {
                        
                        console.log("有效滑動: ", deltaX > 0 ? "向右" : "向左");
                        
                        // 視圖切換方向取決於當前視圖和滑動方向
                        if (container.classList.contains('mobile-view-edit')) {
                            // 從編輯視圖向右滑動到詞牌列表
                            if (deltaX > 0) {
                                console.log("從編輯視圖切換到列表視圖");
                                switchToListView();
                            }
                        } else {
                            // 從詞牌列表向左滑動到編輯視圖
                            if (deltaX < 0) {
                                console.log("從列表視圖切換到編輯視圖");
                                switchToEditView();
                            }
                        }
                    } else {
                        console.log("無效滑動，條件不滿足", "deltaX:", Math.abs(deltaX), ">=", minSwipeDistance, "deltaY:", Math.abs(deltaY), "<=", maxVerticalOffset, "swipeTime:", swipeTime, "<=", maxSwipeTime);
                    }
                });
            }
            
            // 顯示滑動提示
            function showSwipeHint(message) {
                const hint = document.querySelector('.swipe-hint');
                hint.textContent = message;
                hint.classList.add('active');
                
                // 自動隱藏提示
                clearTimeout(window.swipeHintTimeout);
                window.swipeHintTimeout = setTimeout(() => {
                    hideSwipeHint();
                }, 2000);
            }
            
            // 隱藏滑動提示
            function hideSwipeHint() {
                const hint = document.querySelector('.swipe-hint');
                hint.classList.remove('active');
            }
            
            // 顯示滑動指示說明
            function showSwipeInstructions() {
                // 使用會話變量代替localStorage
                if (window.swipeInstructionShown) {
                    return;
                }
                
                const message = container.classList.contains('mobile-view-edit') ? 
                    "右滑可查看詞牌列表" : "左滑可進入創作界面";
                    
                showSwipeHint(message);
                
                // 記錄用户已經看過指示（使用會話變量）
                window.swipeInstructionShown = true;
                
                // 每次顯示3秒後自動隱藏
                setTimeout(() => {
                    hideSwipeHint();
                }, 3000);
            }
        }
        
        // 显示背诵挑战字符选择器
        function showReciteCharSelector(span, originalChar, lineIndex, charIndex) {
            console.log("显示背诵字符选择器:", originalChar, lineIndex, charIndex);
            
            // 验证参数
            if (!originalChar || originalChar.trim() === '') {
                console.error("原始字符为空，无法显示选择器");
                return;
            }
            
            // 如果已经有选择器，先移除
            closeRhymeSelector();
            
            // 创建选择器面板
            const selector = document.createElement('div');
            selector.className = 'floating-rhyme-selector';
            selector.style.position = 'fixed';
            selector.style.visibility = 'hidden'; // 先隐藏，避免闪烁
            selector.dataset.forCharId = span.dataset.charId || Date.now();
            
            if (!span.dataset.charId) {
                span.dataset.charId = selector.dataset.forCharId;
            }
            
            // 获取字符或输入框的精确位置信息
            const spanRect = span.getBoundingClientRect();
            
            // 创建半透明遮罩层
            const overlay = document.createElement('div');
            overlay.className = 'rhyme-overlay';
            document.body.appendChild(overlay);
            
            // 准备字符选项 - 正确的字符加上额外的字符
            const options = [];
            options.push(originalChar); // 添加正确选项
            
            // 查找同词中的其他字符作为干扰项
            const otherChars = [];
            currentPoem.pattern.forEach(line => {
                line.text.split('').forEach(char => {
                    if (char !== originalChar && !otherChars.includes(char) && char.trim() !== '') {
                        otherChars.push(char);
                    }
                });
            });
            
            // 随机选择5个干扰项
            const shuffledChars = otherChars.sort(() => 0.5 - Math.random());
            options.push(...shuffledChars.slice(0, 5));
            
            // 打乱选项顺序
            const shuffledOptions = options.sort(() => 0.5 - Math.random());
            
            // 添加内容
            selector.innerHTML = `
                <div class="floating-rhyme-title">请选择正确的字</div>
                <div class="floating-rhyme-grid" id="floatingRhymeGrid"></div>
            `;
            
            // 先添加到DOM以获取尺寸
            document.body.appendChild(selector);
            
            // 填充字符网格
            const grid = selector.querySelector('#floatingRhymeGrid');
            grid.innerHTML = ''; // 清空当前内容
            
            shuffledOptions.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'floating-rhyme-char';
                btn.textContent = char;
                btn.dataset.char = char;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    // 检查是否选择正确
                    const isCorrect = (char === originalChar);
                    selectReciteChar(span, char, originalChar, isCorrect);
                };
                grid.appendChild(btn);
            });
            
            // 获取视窗尺寸
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // 现在获取准确的选择器尺寸
            const selectorWidth = selector.offsetWidth;
            const selectorHeight = selector.offsetHeight;
            
            // 计算位置
            const charBottom = spanRect.bottom;
            const charTop = spanRect.top;
            const charLeft = spanRect.left;
            const charWidth = spanRect.width;
            const charCenterX = charLeft + (charWidth / 2);
            
            // 设置安全距离
            const safeDistance = 10;
            
            // 定位策略：优先放在输入框正下方
            let selectorTop;
            let selectorLeft;
            
            // 检查下方空间是否足够
            if (viewportHeight - charBottom > selectorHeight + safeDistance) {
                // 优先选择：放在字符下方
                selectorTop = charBottom + safeDistance;
            } 
            // 如果下方空间不足，则放在上方
            else if (charTop > selectorHeight + safeDistance) {
                // 放在字符上方
                selectorTop = charTop - selectorHeight - safeDistance;
            } 
            // 最后选择：空间不足时尽量放在合适位置
            else {
                // 如果上下都不够，优先放在页面中央位置
                selectorTop = Math.max(10, (viewportHeight - selectorHeight) / 2);
            }
            
            // 水平对齐：优先与字符左对齐，确保能完全显示
            selectorLeft = charLeft;
            
            // 确保选择器不会超出右边界
            if (selectorLeft + selectorWidth > viewportWidth - 10) {
                // 如果超出右边界，尝试右对齐
                selectorLeft = charLeft + charWidth - selectorWidth;
                
                // 如果还是不行，就居中对齐
                if (selectorLeft < 10) {
                    selectorLeft = charCenterX - (selectorWidth / 2);
                    
                    // 最后确保不会超出左右边界
                    selectorLeft = Math.max(10, Math.min(viewportWidth - selectorWidth - 10, selectorLeft));
                }
            }
            
            // 最终应用选择器位置
            selector.style.left = `${selectorLeft}px`;
            selector.style.top = `${selectorTop}px`;
            selector.style.visibility = 'visible'; // 现在可以显示了
            
            // 高亮显示当前正在编辑的字符
            span.classList.add('actively-editing');
            
            // 阻止选择器内部点击事件冒泡
            selector.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 保存引用以便关闭时使用
            window.currentRhymeSelector = selector;
            window.currentRhymeOverlay = overlay;
            
            // 點擊文檔其他地方時關閉選擇器
            setTimeout(() => {
                document.addEventListener('click', closeRhymeSelectorOnClickOutside);
            }, 10);
        }
        
        // 选择背诵字符
        function selectReciteChar(span, selectedChar, originalChar, isCorrect) {
            // 填入所选字符
            span.innerHTML = selectedChar;
            
            // 清除之前的样式
            span.classList.remove('recite-correct', 'recite-incorrect');
            
            // 根据是否正确添加不同的样式
            if (isCorrect) {
                span.classList.add('recite-correct');
                
                // 显示成功反馈
                span.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
                span.style.borderColor = 'rgba(76, 175, 80, 0.8)';
                span.style.color = '#006400';
                span.style.cursor = 'default'; // 正确字符不再可点击
                span.onclick = null; // 移除点击事件
                
                // 增加正确字数计数（只有在之前没有计算过的情况下）
                if (!span.dataset.hasBeenCorrect) {
                    correctCharsCount++;
                    span.dataset.hasBeenCorrect = 'true';
                }
            } else {
                span.classList.add('recite-incorrect');
                
                // 显示失败反馈
                span.style.backgroundColor = 'rgba(244, 67, 54, 0.3)';
                span.style.borderColor = 'rgba(244, 67, 54, 0.8)';
                span.style.color = '#8B0000';
                span.style.cursor = 'pointer'; // 错误字符仍然可点击
                
                // 保持点击事件，让用户可以继续修改
                span.onclick = () => {
                    console.log("用户重新点击错误字符:", selectedChar, "原字符:", originalChar);
                    showReciteCharSelector(span, originalChar, parseInt(span.dataset.lineIndex), parseInt(span.dataset.charIndex));
                };
                
                // 如果这个字符之前被标记为正确，需要减少计数
                if (span.dataset.hasBeenCorrect === 'true') {
                    correctCharsCount--;
                    span.dataset.hasBeenCorrect = 'false';
                }
            }
            
            // 记录修改（用于数据保存）
            if (!isReciteChallengeMode) { // 非背诵模式才记录修改
                span.classList.add('modified');
                modifiedChars.add(span);
                
                // 保存修改记录
                const record = {
                    lineIndex: parseInt(span.dataset.lineIndex),
                    charIndex: parseInt(span.dataset.charIndex),
                    originalChar: originalChar,
                    newChar: selectedChar,
                    timestamp: new Date().toISOString()
                };
                
                const existingRecordIndex = modifiedCharRecords.findIndex(r => 
                    r.lineIndex === record.lineIndex && r.charIndex === record.charIndex
                );
                
                if (existingRecordIndex >= 0) {
                    modifiedCharRecords[existingRecordIndex] = record;
                } else {
                    modifiedCharRecords.push(record);
                }
                
                // 触发自动保存
                triggerAutoSave();
            }
            
            // 关闭选择器
            closeRhymeSelector();
            
            // 检查是否完成挑战
            checkReciteCompletion();
        }
        
        // 检查背诵挑战是否完成
        function checkReciteCompletion() {
            if (!isReciteChallengeMode) return;
            
            // 检查所有字格是否都已填写
            const allFilled = Array.from(document.querySelectorAll('.char-span')).every(span => 
                span.textContent !== '' || !span.dataset.originalChar || span.dataset.originalChar.trim() === ''
            );
            
            // 如果全部填写完毕，显示完成信息
            if (allFilled) {
                const reciteEndTime = new Date();
                const timeTaken = Math.round((reciteEndTime - reciteStartTime) / 1000); // 秒数
                
                // 计算准确率
                const accuracy = Math.round((correctCharsCount / totalCharsToRecite) * 100);
                
                // 显示完成弹窗
                showReciteCompletionModal(timeTaken, accuracy);
            }
        }
        
        // 显示背诵完成弹窗
        function showReciteCompletionModal(timeTaken, accuracy) {
            // 创建模态窗口
            const modal = document.createElement('div');
            modal.className = 'rhyme-modal';
            modal.style.display = 'flex';
            
            // 构建弹窗内容
            modal.innerHTML = `
                <div class="rhyme-modal-content" style="max-width: 400px;">
                    <div class="rhyme-modal-header">
                        <div class="rhyme-modal-title">背诵挑战完成！</div>
                        <button id="completionModalClose" class="rhyme-modal-close">&times;</button>
                    </div>
                    <div class="rhyme-modal-body" style="text-align: center; padding: 20px;">
                        <div style="margin-bottom: 20px; font-size: 60px;">🎉</div>
                        <h3 style="margin-bottom: 20px; color: #5D5CDE;">恭喜您完成背诵挑战！</h3>
                        <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                            <div style="margin-bottom: 10px;">
                                <span style="font-weight: bold;">用时：</span> ${formatTime(timeTaken)}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <span style="font-weight: bold;">准确率：</span> ${accuracy}%
                            </div>
                            <div>
                                <span style="font-weight: bold;">总字数：</span> ${totalCharsToRecite}
                            </div>
                        </div>
                        <div class="controls" style="justify-content: center; border-top: none; margin-top: 0;">
                            <button class="btn" id="tryAgainBtn">再试一次</button>
                            <button class="btn" id="exitReciteBtn">退出挑战</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到文档
            document.body.appendChild(modal);
            
            // 绑定关闭按钮事件
            document.getElementById('completionModalClose').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 绑定再试一次按钮事件
            document.getElementById('tryAgainBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
                startReciteChallenge(); // 重新开始挑战
            });
            
            // 绑定退出挑战按钮事件
            document.getElementById('exitReciteBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
                toggleReciteChallenge(); // 退出挑战模式
            });
        }
        
        // 格式化时间
        function formatTime(seconds) {
            if (seconds < 60) {
                return `${seconds}秒`;
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}分${remainingSeconds}秒`;
            }
        }
        
        // 側邊欄切換按鈕點擊處理
        document.getElementById('sidebarToggleBtn').addEventListener('click', function() {
            const container = document.querySelector('.container');
            if (container.classList.contains('sidebar-hidden')) {
                container.classList.remove('sidebar-hidden');
                window.sidebarVisible = true;
            } else {
                container.classList.add('sidebar-hidden');
                window.sidebarVisible = false;
            }
        });
        
        // 頁面加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
            initMobileViewToggle();
        });
        // AI评价功能
        async function requestAIEvaluation() {
            const button = document.getElementById('aiEvaluationBtn');
            
            // 检查是否有当前词作
            if (!currentPoem || !currentCipai) {
                showFeedback('请先选择一首词作', 'warning');
                return;
            }
            
            // 获取用户填写的内容
            const userContent = getModifiedContent();
            const originalContent = currentPoem.content;
            
            // 如果没有修改，提示用户
            if (modifiedChars.size === 0) {
                showFeedback('您还没有填写任何字词，请先进行创作', 'warning');
                return;
            }
            
            // 立即显示评价框with加载动画
            showEvaluationLoadingModal();
            
            // 显示按钮加载状态
            button.disabled = true;
            button.textContent = 'AI评价中...';
            
            try {
                // 准备评价请求的数据
                const evaluationData = {
                    cipaiName: currentCipai,
                    originalContent: originalContent,
                    userContent: userContent,
                    author: currentAuthor || currentPoem.author,
                    modifiedCount: modifiedChars.size,
                    totalChars: document.querySelectorAll('.char-span').length
                };
                
                // 调用DeepSeek API
                const result = await callDeepSeekAPI(evaluationData);
                
                // 用动画效果显示评价结果
                showEvaluationResultWithAnimation(result);
                
            } catch (error) {
                console.error('AI评价失败:', error);
                showEvaluationError(error.message);
            } finally {
                // 恢复按钮状态
                button.disabled = false;
                button.textContent = 'AI評價';
            }
        }
        
        // 使用DeepSeek API调用AI进行评价
        async function callDeepSeekAPI(evaluationData) {
            // DeepSeek API配置
            const apiKey = 'sk-d850478e8977454abc9975d544ffd4e3'; // 您的API密钥
            const apiUrl = 'https://api.deepseek.com/chat/completions'; // 根据文档的正确端点
            
            // 构建评价提示词
            const prompt = `请作为一位专业的古典诗词专家，对用户填写的词作进行详细评价。

**词作信息：**
- 词牌名：${evaluationData.cipaiName}
- 原作者：${currentPoem.author}
- 填词者：${evaluationData.author}
- 修改字数：${evaluationData.modifiedCount}/${evaluationData.totalChars}

**原作内容：**
${evaluationData.originalContent}

**用户填写内容：**
${evaluationData.userContent}

**评价要求：**
请从以下四个方面进行专业评价并打分（每项25分，总分100分）：

1. **平仄合律性（25分）**：是否符合词牌的平仄格律要求
2. **押韵准确性（25分）**：韵脚是否准确，韵部是否统一协调
3. **意境表达（25分）**：词意是否优美，情感表达是否真挚动人
4. **用词精准性（25分）**：用词是否恰当得体，是否有生僻或不当用词

**输出格式要求：**
请严格按照以下JSON格式返回评价结果，不要包含任何markdown标记或其他文字：

{
  "totalScore": 85,
  "scores": {
    "rhythm": 22,
    "rhyme": 20,
    "meaning": 21,
    "vocabulary": 22
  },
  "evaluation": "整体评价文字描述...",
  "suggestions": [
    "具体修改建议1",
    "具体修改建议2",
    "具体修改建议3"
  ],
  "highlights": [
    "优秀之处1",
    "优秀之处2"
  ]
}`;

            try {
                // 构建请求体（按照DeepSeek API文档格式）
                const requestBody = {
                    model: "deepseek-chat", // 使用deepseek-chat模型
                    messages: [
                        {
                            role: "system",
                            content: "你是一位专业的古典诗词专家，精通格律、韵部、意境分析和文学评价。"
                        },
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000,
                    stream: false
                };

                console.log('发送DeepSeek API请求...');
                
                // 发送请求到DeepSeek API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DeepSeek API错误响应:', response.status, errorText);
                    throw new Error(`DeepSeek API请求失败: ${response.status} ${response.statusText}\n${errorText}`);
                }
                
                const data = await response.json();
                console.log('DeepSeek API响应:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('DeepSeek API返回数据格式错误');
                }
                
                const content = data.choices[0].message.content.trim();
                console.log('AI返回内容:', content);
                
                try {
                    // 尝试解析JSON响应
                    let jsonContent = content;
                    
                    // 移除可能的markdown代码块标记
                    jsonContent = jsonContent.replace(/```json\s*|\s*```/g, '');
                    jsonContent = jsonContent.replace(/```\s*|\s*```/g, '');
                    
                    // 尝试找到JSON部分
                    const jsonMatch = jsonContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const evaluationResult = JSON.parse(jsonMatch[0]);
                        console.log('解析成功的评价结果:', evaluationResult);
                        return evaluationResult;
                    } else {
                        throw new Error('响应中未找到有效的JSON格式');
                    }
                } catch (parseError) {
                    console.error('解析JSON失败:', parseError);
                    // 如果JSON解析失败，创建一个包含原始响应的结果
                    const fallbackResult = {
                        totalScore: 75,
                        scores: {
                            rhythm: 18,
                            rhyme: 19,
                            meaning: 20,
                            vocabulary: 18
                        },
                        evaluation: content,
                        suggestions: ["AI返回格式解析失败，以上为原始评价内容"],
                        highlights: ["已完成词作创作"]
                    };
                    return fallbackResult;
                }
            } catch (error) {
                console.error('DeepSeek API调用失败:', error);
                
                // 检查是否是CORS错误
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    throw new Error('网络连接失败：可能是由于浏览器CORS限制。建议使用代理服务器或在支持的环境中运行。\n\n技术详情：' + error.message);
                }
                
                throw error;
            }
        }
        
        // 显示评价结果
        function showEvaluationResult(result) {
            // 创建评价结果模态窗口
            const modal = document.createElement('div');
            modal.className = 'rhyme-modal';
            modal.style.display = 'flex';
            
            // 计算等级
            const grade = getGrade(result.totalScore);
            const gradeColor = getGradeColor(result.totalScore);
            
            modal.innerHTML = `
                <div class="rhyme-modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div class="rhyme-modal-header">
                        <div class="rhyme-modal-title">AI 评价结果</div>
                        <button id="evaluationModalClose" class="rhyme-modal-close">&times;</button>
                    </div>
                    <div class="rhyme-modal-body" style="padding: 20px;">
                        <!-- 总分展示 -->
                        <div style="text-align: center; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px;">
                            <div style="font-size: 48px; font-weight: bold; color: ${gradeColor}; margin-bottom: 10px;">
                                ${result.totalScore}
                            </div>
                            <div style="font-size: 18px; color: ${gradeColor}; font-weight: bold;">
                                ${grade} - ${getGradeLabel(result.totalScore)}
                            </div>
                        </div>
                        
                        <!-- 分项评分 -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #5D5CDE; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📊 分项评分
                            </h4>
                            <div class="score-items">
                                <div class="score-item">
                                    <span>⚖️ 平仄合律性</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${(result.scores.rhythm/25)*100}%"></div>
                                        <span class="score-text">${result.scores.rhythm}/25</span>
                                    </div>
                                </div>
                                <div class="score-item">
                                    <span>🎵 押韵准确性</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${(result.scores.rhyme/25)*100}%"></div>
                                        <span class="score-text">${result.scores.rhyme}/25</span>
                                    </div>
                                </div>
                                <div class="score-item">
                                    <span>🎭 意境表达</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${(result.scores.meaning/25)*100}%"></div>
                                        <span class="score-text">${result.scores.meaning}/25</span>
                                    </div>
                                </div>
                                <div class="score-item">
                                    <span>✒️ 用词精准性</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${(result.scores.vocabulary/25)*100}%"></div>
                                        <span class="score-text">${result.scores.vocabulary}/25</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 整体评价 -->
                        <div style="margin-bottom: 25px;">
                            <h4 class="evaluation-section-title">
                                💭 专家点评
                            </h4>
                            <div class="evaluation-content-box">
                                ${result.evaluation}
                            </div>
                        </div>
                        
                        <!-- 优点和建议 -->
                        <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px;">
                            ${result.highlights && result.highlights.length > 0 ? `
                            <div>
                                <h4 class="evaluation-section-title highlights-title">
                                    ✨ 优秀之处
                                </h4>
                                <ul class="evaluation-content-box highlights-box">
                                    ${result.highlights.map(highlight => `<li class="evaluation-list-item">${highlight}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            ${result.suggestions && result.suggestions.length > 0 ? `
                            <div>
                                <h4 class="evaluation-section-title suggestions-title">
                                    💡 修改建议
                                </h4>
                                <ol class="evaluation-content-box suggestions-box">
                                    ${result.suggestions.map(suggestion => `<li class="evaluation-list-item">${suggestion}</li>`).join('')}
                                </ol>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
                            <button class="btn" id="closeEvaluationBtn" style="background: #6c757d;">关闭</button>
                            <button class="btn" id="copyEvaluationBtn">复制评价</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定关闭按钮事件
            document.getElementById('evaluationModalClose').addEventListener('click', closeEvaluationModal);
            document.getElementById('closeEvaluationBtn').addEventListener('click', closeEvaluationModal);
            
            // 绑定复制按钮事件
            document.getElementById('copyEvaluationBtn').addEventListener('click', () => {
                copyEvaluationToClipboard(result);
            });
            
            function closeEvaluationModal() {
                document.body.removeChild(modal);
            }
        }
        
        // 获取评分等级
        function getGrade(score) {
            if (score >= 90) return 'A+';
            if (score >= 80) return 'A';
            if (score >= 70) return 'B+';
            if (score >= 60) return 'B';
            if (score >= 50) return 'C';
            return 'D';
        }
        
        // 获取评分颜色
        function getGradeColor(score) {
            if (score >= 90) return '#28a745';
            if (score >= 80) return '#20c997';
            if (score >= 70) return '#ffc107';
            if (score >= 60) return '#fd7e14';
            if (score >= 50) return '#dc3545';
            return '#6c757d';
        }
        
        // 获取评分图标
        function getGradeIcon(score) {
            if (score >= 90) return '🏆';
            if (score >= 80) return '🎉';
            if (score >= 70) return '👍';
            if (score >= 60) return '📝';
            if (score >= 50) return '💪';
            return '📚';
        }
        
        // 获取评分标签
        function getGradeLabel(score) {
            if (score >= 90) return '优秀';
            if (score >= 80) return '良好';
            if (score >= 70) return '中等';
            if (score >= 60) return '及格';
            if (score >= 50) return '需努力';
            return '继续加油';
        }
        
        // 显示评价加载模态窗口
        function showEvaluationLoadingModal() {
            // 创建加载模态窗口
            const modal = document.createElement('div');
            modal.id = 'evaluationLoadingModal';
            modal.className = 'rhyme-modal';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="rhyme-modal-content" style="max-width: 500px; text-align: center;">
                    <div class="rhyme-modal-header">
                        <div class="rhyme-modal-title">AI 正在分析您的作品</div>
                        <button id="evaluationLoadingClose" class="rhyme-modal-close">&times;</button>
                    </div>
                    <div class="rhyme-modal-body" style="padding: 40px;">
                        <!-- 加载动画 -->
                        <div class="evaluation-loading-container">
                            <div class="evaluation-spinner"></div>
                            <div id="evaluationStageText" class="evaluation-stage-text">正在初始化分析...</div>
                            <div class="evaluation-progress-bar">
                                <div id="evaluationProgressFill" class="evaluation-progress-fill"></div>
                            </div>
                            <div class="evaluation-tips">
                                <p>🎯 AI正在从格律、韵律、意境、用词等多个维度进行专业分析</p>
                                <p>⏰ 预计需要10-30秒，请耐心等待</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定关闭按钮
            document.getElementById('evaluationLoadingClose').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 开始阶段性提示动画
            startEvaluationStageAnimation();
        }
        
        // 开始评价阶段动画
        function startEvaluationStageAnimation() {
            const stages = [
                { text: "正在分析平仄格律...", progress: 20 },
                { text: "正在检查押韵规律...", progress: 40 },
                { text: "正在评估意境表达...", progress: 60 },
                { text: "正在分析用词精准性...", progress: 80 },
                { text: "正在生成综合评价...", progress: 95 }
            ];
            
            let currentStage = 0;
            const stageText = document.getElementById('evaluationStageText');
            const progressFill = document.getElementById('evaluationProgressFill');
            
            function updateStage() {
                if (currentStage < stages.length && stageText && progressFill) {
                    const stage = stages[currentStage];
                    stageText.textContent = stage.text;
                    progressFill.style.width = stage.progress + '%';
                    currentStage++;
                    
                    // 随机间隔时间，让进度更自然
                    const nextDelay = Math.random() * 1500 + 1000; // 1-2.5秒随机间隔
                    setTimeout(updateStage, nextDelay);
                }
            }
            
            // 开始第一个阶段
            setTimeout(updateStage, 500);
        }
        
        // 用动画效果显示评价结果
        function showEvaluationResultWithAnimation(result) {
            const loadingModal = document.getElementById('evaluationLoadingModal');
            if (loadingModal) {
                // 先更新进度到100%
                const progressFill = document.getElementById('evaluationProgressFill');
                const stageText = document.getElementById('evaluationStageText');
                if (progressFill) progressFill.style.width = '100%';
                if (stageText) stageText.textContent = '分析完成！正在生成报告...';
                
                // 延迟一下再显示结果，让用户看到完成状态
                setTimeout(() => {
                    document.body.removeChild(loadingModal);
                    showEvaluationResult(result);
                }, 1000);
            } else {
                // 如果没有加载窗口，直接显示结果
                showEvaluationResult(result);
            }
        }
        
        // 显示评价错误
        function showEvaluationError(errorMessage) {
            const loadingModal = document.getElementById('evaluationLoadingModal');
            if (loadingModal) {
                // 替换加载内容为错误信息
                const modalBody = loadingModal.querySelector('.rhyme-modal-body');
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">😔</div>
                        <h3 style="color: #dc3545; margin-bottom: 15px;">AI评价失败</h3>
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #721c24;">
                            ${errorMessage}
                        </div>
                        <div style="display: flex; justify-content: center; gap: 15px;">
                            <button class="btn" id="retryEvaluationBtn" style="background: #007bff;">重试</button>
                            <button class="btn" id="closeErrorBtn" style="background: #6c757d;">关闭</button>
                        </div>
                    </div>
                `;
                
                // 绑定按钮事件
                document.getElementById('retryEvaluationBtn').addEventListener('click', () => {
                    document.body.removeChild(loadingModal);
                    requestAIEvaluation(); // 重新尝试评价
                });
                
                document.getElementById('closeErrorBtn').addEventListener('click', () => {
                    document.body.removeChild(loadingModal);
                });
            } else {
                // 如果没有加载窗口，显示普通错误信息
                showFeedback('AI评价失败: ' + errorMessage, 'warning');
            }
        }
        
        // 复制评价结果到剪贴板
        function copyEvaluationToClipboard(result) {
            const evaluationText = `
AI 评价结果 - ${currentCipai}

总分：${result.totalScore}/100 (${getGrade(result.totalScore)})

分项评分：
• 平仄合律性：${result.scores.rhythm}/25
• 押韵准确性：${result.scores.rhyme}/25  
• 意境表达：${result.scores.meaning}/25
• 用词精准性：${result.scores.vocabulary}/25

整体评价：
${result.evaluation}

${result.highlights && result.highlights.length > 0 ? `
优秀之处：
${result.highlights.map((h, i) => `${i + 1}. ${h}`).join('\n')}
` : ''}

${result.suggestions && result.suggestions.length > 0 ? `
修改建议：
${result.suggestions.map((s, i) => `${i + 1}. ${s}`).join('\n')}
` : ''}

——————————————
作品信息：
词牌：${currentCipai}
作者：${currentAuthor || currentPoem.author}
填写内容：
${getModifiedContent()}
            `.trim();
            
            navigator.clipboard.writeText(evaluationText)
                .then(() => {
                    showFeedback('评价结果已复制到剪贴板', 'success');
                })
                .catch(err => {
                    showFeedback('复制失败：' + err.message, 'warning');
                });
        }
        
    </script>
    
    <!-- AI评价结果样式 -->
    <style>
        .score-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .score-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-item span:first-child {
            min-width: 100px;
            font-weight: 500;
            color: #333;
        }
        
        .score-bar {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #5D5CDE 0%, #7469DC 100%);
            border-radius: 12px;
            transition: width 0.8s ease;
        }
        
        .score-text {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }
        
        /* 深色模式适配 */
        .dark-mode .score-item span:first-child {
            color: #e0e0e0;
        }
        
        .dark-mode .score-bar {
            background: #495057;
        }
        
        .dark-mode .score-text {
            color: #adb5bd;
        }
    </style>
</body>
</html>




















