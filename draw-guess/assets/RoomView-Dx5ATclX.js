import{l as Ae,r as T,u as J,f as W,d as Z,h as j,i as de,m as ve,c,e,o as u,_ as ee,n as N,a as F,F as U,p as q,q as ce,t as f,b as a,s as Q,x as X,y as ze,j as H,g as He,v as Oe,z as Ue,A as qe,k as Je,B as Ke}from"./index-NnPZJkkc.js";import{b as se,a as me,c as ne,d as $e,e as Ce,u as Ye,W as Xe}from"./WaitingLobby-CftKwXrG.js";const ge=Ae("drawing",()=>{const t=T("pen"),o=T("#000000"),v=T(3),d=T(!1),s=T([]);function m(y){t.value=y}function G(y){o.value=y}function b(y){v.value=Math.max(1,Math.min(20,y))}function $(y){s.value.push(y)}function M(){s.value=[]}function I(y){d.value=y}return{tool:t,color:o,lineWidth:v,isDrawing:d,strokes:s,setTool:m,setColor:G,setLineWidth:b,addStroke:$,clearStrokes:M,setDrawing:I}});function ke(t,o){const v=t.getBoundingClientRect();let d,s;if(o instanceof MouseEvent)d=o.clientX,s=o.clientY;else if(o instanceof TouchEvent&&o.touches.length>0&&o.touches[0])d=o.touches[0].clientX,s=o.touches[0].clientY;else return null;return{x:d-v.left,y:s-v.top}}function ue(t,o){if(t.save(),o.tool==="fill"){o.canvasSize&&(t.fillStyle=o.color,t.fillRect(0,0,o.canvasSize.width,o.canvasSize.height)),t.restore();return}if(o.points.length<2){t.restore();return}o.tool==="pen"?(t.strokeStyle=o.color,t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round"):o.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),o.points[0]&&t.moveTo(o.points[0].x,o.points[0].y);for(let v=1;v<o.points.length;v++){const d=o.points[v];d&&t.lineTo(d.x,d.y)}t.stroke(),t.restore()}function De(t,o){const v=t.getContext("2d");if(!v)return;const d=t.getBoundingClientRect();v.clearRect(0,0,t.width,t.height),v.fillStyle="#FFFFFF",v.fillRect(0,0,d.width,d.height),o.forEach(s=>{ue(v,s)})}function Se(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const L=T(null),B=T(null),E=T(null),O=T(null);function xe(){const t=ge(),o=se(),v=J(),{sendDrawing:d}=me(),s=W(()=>!v.user||!o.currentRoom?!1:o.currentRoom.current_drawer_id===v.user.id);let m=null;const G=50;function b(r){console.log("[useDrawing] initCanvas è¢«èª¿ç”¨"),L.value=r;const h=r.getContext("2d",{willReadFrequently:!0});if(!h){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}B.value=h;const w=window.devicePixelRatio||1,z=r.getBoundingClientRect();r.width=z.width*w,r.height=z.height*w,h.scale(w,w),h.fillStyle="#FFFFFF",h.fillRect(0,0,z.width,z.height),t.clearStrokes(),console.log("[useDrawing] Canvas åˆå§‹åŒ–å®Œæˆï¼Œç­†è§¸å·²æ¸…ç©º"),new ResizeObserver(()=>{if(!L.value||!B.value)return;const V=L.value.getBoundingClientRect(),P=window.devicePixelRatio||1;L.value.width=V.width*P,L.value.height=V.height*P,B.value.scale(P,P),B.value.fillStyle="#FFFFFF",B.value.fillRect(0,0,V.width,V.height),De(L.value,t.strokes)}).observe(r)}function $(r){if(!L.value)return;if(!s.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}r.preventDefault(),t.setDrawing(!0);const h=ke(L.value,r);h&&(E.value={id:Se(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[h],timestamp:Date.now()},O.value=h)}function M(r){if(!L.value||!B.value||!t.isDrawing||!E.value)return;r.preventDefault();const h=ke(L.value,r);if(!h||!O.value)return;const w=B.value;w.save(),E.value.tool==="pen"?(w.strokeStyle=E.value.color,w.lineWidth=E.value.lineWidth,w.lineCap="round",w.lineJoin="round"):E.value.tool==="eraser"&&(w.globalCompositeOperation="destination-out",w.lineWidth=E.value.lineWidth,w.lineCap="round",w.lineJoin="round"),w.beginPath(),w.moveTo(O.value.x,O.value.y),w.lineTo(h.x,h.y),w.stroke(),w.restore(),E.value.points.push(h),O.value=h,m===null&&(m=window.setTimeout(()=>{y(),m=null},G))}function I(){!t.isDrawing||!E.value||(t.setDrawing(!1),m&&(clearTimeout(m),m=null),y(),E.value=null,O.value=null)}async function y(){if(!(!E.value||!o.currentRoom||!v.user))try{const r={...E.value,userId:v.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",r.id),await d(o.currentRoom.code,r)}catch(r){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",r)}}function C(r){if(!(!L.value||!B.value)){if(r.userId&&v.user&&r.userId===v.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",r.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",r.id,r.tool),t.addStroke(r),ue(B.value,r)}}function R(){if(console.log("[useDrawing] clearCanvasLocal è¢«èª¿ç”¨"),!L.value||!B.value){console.warn("[useDrawing] clearCanvasLocal: canvas æˆ– ctx ä¸å­˜åœ¨");return}const r=B.value,w=L.value.getBoundingClientRect();console.log("[useDrawing] æ¸…ç©ºç•«å¸ƒï¼Œå°ºå¯¸:",w.width,"x",w.height),r.clearRect(0,0,w.width,w.height),r.fillStyle="#FFFFFF",r.fillRect(0,0,w.width,w.height),t.clearStrokes(),console.log("[useDrawing] ç•«å¸ƒå·²æ¸…ç©º")}async function k(){if(console.log("[useDrawing] clearCanvas è¢«èª¿ç”¨"),!L.value||!B.value||!o.currentRoom||!v.user){console.warn("[useDrawing] clearCanvas: ç¼ºå°‘å¿…è¦æ¢ä»¶");return}const r=L.value.getBoundingClientRect(),h={id:Se(),tool:"fill",color:"#FFFFFF",lineWidth:0,points:[],timestamp:Date.now(),canvasSize:{width:r.width,height:r.height}};ue(B.value,h),t.addStroke(h);try{const w={...h,userId:v.user.id};await d(o.currentRoom.code,w),console.log("[useDrawing] æ¸…ç©ºç•«å¸ƒç­†è§¸å·²å»£æ’­")}catch(w){console.error("[useDrawing] å»£æ’­æ¸…ç©ºç­†è§¸å¤±æ•—:",w)}}function _(r){t.setTool(r)}function i(r){t.setColor(r)}function l(r){t.setLineWidth(r)}function g(){L.value&&De(L.value,t.strokes)}return{canvasRef:L,initCanvas:b,startDrawing:$,draw:M,stopDrawing:I,clearCanvas:k,clearCanvasLocal:R,setTool:_,setColor:i,setLineWidth:l,handleDrawingData:C,redrawStrokes:g}}const je={class:"drawing-canvas-container"},Qe=Z({__name:"DrawingCanvas",setup(t,{expose:o}){const{initCanvas:v,startDrawing:d,draw:s,stopDrawing:m,handleDrawingData:G}=xe(),b=se(),$=J(),M=ge(),I=ne(),{subscribeDrawing:y}=me(),C=T(null);function R(){if(console.log("[DrawingCanvas] localClearCanvas è¢«èª¿ç”¨"),!C.value){console.warn("[DrawingCanvas] canvas å…ƒç´ ä¸å­˜åœ¨");return}const x=C.value,V=x.getContext("2d");if(!V){console.warn("[DrawingCanvas] ç„¡æ³•ç²å– ctx");return}const P=x.getBoundingClientRect(),A=window.devicePixelRatio||1;x.width=P.width*A,x.height=P.height*A,V.scale(A,A),V.fillStyle="#FFFFFF",V.fillRect(0,0,P.width,P.height),M.clearStrokes(),console.log("[DrawingCanvas] ç•«å¸ƒå·²æ¸…ç©º")}j(()=>I.currentRound?.id,(x,V)=>{console.log("[DrawingCanvas] watch currentRound.id:",{oldRoundId:V,newRoundId:x}),x&&x!==V&&(console.log("[DrawingCanvas] æ–°è¼ªæ¬¡é–‹å§‹ï¼Œæ¸…ç©ºç•«å¸ƒ"),R())}),o({clearCanvas:R});function k(x){d(x)}function _(x){s(x)}function i(){m()}function l(){m()}function g(x){d(x)}function r(x){s(x)}function h(){m()}let w=null;function z(){!b.currentRoom||!$.user||(w=y(b.currentRoom.code,x=>{G(x)}))}return de(()=>{console.log("[DrawingCanvas] onMounted - çµ„ä»¶æ›è¼‰"),C.value&&v(C.value),z()}),ve(()=>{w&&(w(),w=null)}),(x,V)=>(u(),c("div",je,[e("canvas",{ref_key:"canvasElement",ref:C,class:"drawing-canvas",onMousedown:k,onMousemove:_,onMouseup:i,onMouseleave:l,onTouchstart:g,onTouchmove:r,onTouchend:h},null,544)]))}}),Ze=ee(Qe,[["__scopeId","data-v-38d12a7b"]]),et={class:"toolbar-section"},tt={key:0,class:"tool-label"},st={key:0,class:"tool-label"},nt={key:0,class:"toolbar-section colors-section"},ot=["onClick","title"],rt={class:"toolbar-section size-section"},at={class:"size-dots"},it=["onClick","title"],lt={class:"toolbar-section"},ct={key:0,class:"tool-label"},ut=Z({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const o=ge(),{setTool:v,setColor:d,setLineWidth:s,clearCanvas:m}=xe(),G=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],b=W(()=>o.tool),$=W(()=>o.color),M=W(()=>o.lineWidth);function I(k){v(k)}function y(k){d(k)}function C(k){o.setLineWidth(k),s(k)}async function R(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&await m()}return(k,_)=>(u(),c("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",et,[e("button",{onClick:_[0]||(_[0]=i=>I("pen")),class:N(["tool-btn",{active:b.value==="pen"}]),title:"ç•«ç­†"},[_[2]||(_[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?F("",!0):(u(),c("span",tt,"ç•«ç­†"))],2),e("button",{onClick:_[1]||(_[1]=i=>I("eraser")),class:N(["tool-btn",{active:b.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[_[3]||(_[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?F("",!0):(u(),c("span",st,"æ©¡çš®æ“¦"))],2)]),b.value==="pen"?(u(),c("div",nt,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(u(),c(U,null,q(G,i=>e("div",{key:i,onClick:l=>y(i),class:N(["color-cell",{selected:$.value===i}]),style:ce({backgroundColor:i}),title:i},null,14,ot)),64))],2)])):F("",!0),e("div",rt,[e("div",at,[(u(),c(U,null,q([2,5,10,15],i=>e("div",{key:i,onClick:l=>C(i),class:N(["size-dot",{active:M.value===i}]),style:ce({width:`${i+8}px`,height:`${i+8}px`}),title:`${i}px`},null,14,it)),64))])]),e("div",lt,[e("button",{onClick:R,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[_[4]||(_[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?F("",!0):(u(),c("span",ct,"æ¸…ç©º"))])])],2))}}),dt=ee(ut,[["__scopeId","data-v-74596782"]]),vt={class:"player-list"},mt={class:"player-list-header"},gt={class:"player-count"},wt={class:"player-rank"},ht={class:"player-info"},ft={class:"player-name"},_t={key:0,class:"drawer-badge"},pt={key:1,class:"host-badge"},yt={class:"player-score"},Rt=["onClick"],bt={key:0,class:"winner-banner"},Ct={class:"winner-text"},kt={class:"winner-name"},Dt={class:"winner-score"},St=Z({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:o}){const v=o,d=se(),s=ne(),m=J(),{playerRankings:G,winner:b}=$e(),$=W(()=>G.value),M=T(!1);function I(i){return d.participants.find(g=>g.user_id===i)?.nickname||"æœªçŸ¥ç©å®¶"}function y(i){return m.user?.id===i}function C(i){return d.currentRoom?.host_id===i}function R(i){return s.currentRound?.drawer_id===i||d.currentRoom?.current_drawer_id===i}function k(i){return d.isHost&&!y(i)}async function _(i,l){if(!(M.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${l} å—ï¼Ÿ`))){M.value=!0;try{const r=await d.kickPlayer(i);r.success?v("player-kicked",i):alert(r.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(r){console.error("è¸¢äººå¤±æ•—:",r),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{M.value=!1}}}return(i,l)=>(u(),c("div",vt,[e("div",mt,[e("span",gt,"ç©å®¶ ("+f($.value.length)+")",1)]),(u(!0),c(U,null,q($.value,(g,r)=>(u(),c("div",{key:g.id,class:N(["player-item",{"is-current":y(g.user_id)},{"is-drawer":R(g.user_id)}])},[e("div",wt,f(r+1),1),e("div",{class:N(["player-avatar",{drawing:R(g.user_id)}])},f(I(g.user_id).charAt(0)),3),e("div",ht,[e("div",ft,[Q(f(I(g.user_id))+" ",1),R(g.user_id)?(u(),c("span",_t,"âœï¸")):F("",!0),C(g.user_id)?(u(),c("span",pt,"ğŸ‘‘")):F("",!0)]),e("div",yt,f(g.score)+" åˆ†",1)]),k(g.user_id)?(u(),c("button",{key:0,class:"kick-btn",onClick:h=>_(g.user_id,I(g.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,Rt)):F("",!0)],2))),128)),t.showWinner&&a(b)?(u(),c("div",bt,[l[1]||(l[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Ct,[l[0]||(l[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",kt,f(I(a(b).user_id)),1),e("div",Dt,f(a(b).score)+" åˆ†",1)])])):F("",!0)]))}}),Fe=ee(St,[["__scopeId","data-v-984c1c4a"]]),Ft={class:"round-summary"},$t={class:"summary-card"},xt={key:0,class:"selection-waiting-banner"},Wt={class:"waiting-text"},Tt={class:"next-drawer-name"},It={class:"summary-header"},Gt={class:"summary-title"},Mt={class:"round-info"},Lt={class:"answer-reveal"},Vt={class:"answer-text"},Nt={class:"drawer-section"},Bt={class:"drawer-info"},Et={class:"drawer-name"},Pt={key:0,class:"drawer-score"},At={class:"guessers-section"},zt={key:0,class:"no-guessers"},Ht={key:1,class:"guessers-list"},Ot={class:"guesser-rank"},Ut={class:"guesser-name"},qt={class:"guesser-score"},Jt={key:1,class:"rating-section"},Kt={class:"star-rating"},Yt=["onMouseenter","onClick","disabled"],Xt={class:"rating-info"},jt={key:0,class:"rated-text"},Qt={key:1,class:"rate-hint"},Zt={key:2,class:"average-rating"},es={class:"avg-score"},ts={class:"avg-stars"},ss={class:"avg-count"},ns={key:3,class:"next-drawer-info"},os={class:"next-drawer-name-display"},rs={key:4,class:"game-ending-info"},as=Z({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:o}){const v=t,d=o,s=J(),m=T(0),G=T(0),b=T(!1),$=T([]),M=W(()=>s.user?.id===v.drawerId),I=W(()=>$.value.length===0?0:$.value.reduce((l,g)=>l+g.rating,0)/$.value.length),y=W(()=>$.value.length);async function C(i){if(!(b.value||M.value||!s.user))try{const{error:l}=await X.from("drawing_ratings").upsert({round_id:v.roundId,rater_id:s.user.id,drawer_id:v.drawerId,rating:i},{onConflict:"round_id,rater_id"});if(l)throw l;m.value=i,b.value=!0,d("rating-submitted",i)}catch(l){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",l)}}async function R(){try{const{data:i,error:l}=await X.from("drawing_ratings").select("rater_id, rating").eq("round_id",v.roundId);if(l)throw l;if($.value=i||[],s.user){const g=$.value.find(r=>r.rater_id===s.user.id);g&&(m.value=g.rating,b.value=!0)}}catch(i){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",i)}}function k(){const i=X.channel(`ratings:${v.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${v.roundId}`},()=>{R()}).subscribe();return()=>{X.removeChannel(i)}}let _=null;return de(()=>{R(),_=k()}),ve(()=>{_&&_()}),j(()=>v.roundId,()=>{R()}),(i,l)=>(u(),c("div",Ft,[e("div",$t,[t.isWaitingForSelection?(u(),c("div",xt,[l[2]||(l[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Wt,[e("span",Tt,f(t.nextDrawerName),1),l[1]||(l[1]=Q(" æ­£åœ¨é¸è©... ",-1))]),l[3]||(l[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):F("",!0),e("div",It,[e("h2",Gt,f(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Mt,"ç¬¬ "+f(t.roundNumber)+" / "+f(t.totalRounds)+" è¼ª",1)]),e("div",Lt,[l[4]||(l[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Vt,f(t.correctAnswer),1)]),e("div",Nt,[e("div",Bt,[l[5]||(l[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Et,f(t.drawerName),1),t.drawerScore>0?(u(),c("span",Pt,"+"+f(t.drawerScore)+" åˆ†",1)):F("",!0)])]),e("div",At,[l[6]||(l[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(u(),c("div",zt," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(u(),c("div",Ht,[(u(!0),c(U,null,q(t.correctGuessers,(g,r)=>(u(),c("div",{key:g.userId,class:"guesser-item"},[e("span",Ot,f(r+1),1),e("span",Ut,f(g.name),1),e("span",qt,"+"+f(g.score),1)]))),128))]))]),M.value?F("",!0):(u(),c("div",Jt,[l[7]||(l[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Kt,[(u(),c(U,null,q(5,g=>e("button",{key:g,class:N(["star-btn",{active:g<=(G.value||m.value),selected:g<=m.value}]),onMouseenter:r=>G.value=g,onMouseleave:l[0]||(l[0]=r=>G.value=0),onClick:r=>C(g),disabled:b.value}," â­ ",42,Yt)),64))]),e("div",Xt,[b.value?(u(),c("span",jt,"ä½ çš„è©•åˆ†ï¼š"+f(m.value)+" æ˜Ÿ",1)):(u(),c("span",Qt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),y.value>0?(u(),c("div",Zt,[l[8]||(l[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",es,f(I.value.toFixed(1)),1),e("span",ts,f("â­".repeat(Math.round(I.value))),1),e("span",ss,"("+f(y.value)+" äººå·²è©•)",1)])):F("",!0),t.nextDrawerName&&!t.isLastRound?(u(),c("div",ns,[l[9]||(l[9]=e("div",{class:"next-drawer-label"},"ä¸‹ä¸€è¼ªç•«æ‰‹",-1)),e("div",os,"âœï¸ "+f(t.nextDrawerName),1)])):F("",!0),t.isLastRound?(u(),c("div",rs,[...l[10]||(l[10]=[e("div",{class:"ending-label"},"ğŸ‰ é€™æ˜¯æœ€å¾Œä¸€è¼ªï¼",-1)])])):F("",!0)])]))}}),is=ee(as,[["__scopeId","data-v-2a39ef4b"]]);function ls(){const t=ne(),o=J(),{calculateGuessScore:v,updatePlayerScore:d}=$e(),s=T(""),m=T(null),G=T(!1),b=W(()=>t.isCurrentDrawer?t.currentWord:null),$=W(()=>t.correctGuesses),M=W(()=>o.user?t.hasGuessed(o.user.id):!1);async function I(){if(!t.currentRound||!o.user)return m.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return m.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return m.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(M.value)return m.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return m.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{G.value=!0,m.value=null;const R=s.value.trim(),k=t.currentWord||"",_=y(R,k),i=_?v($.value.length):0,{data:l,error:g}=await X.from("guesses").insert({round_id:t.currentRound.id,user_id:o.user.id,guess_text:R,is_correct:_,score_earned:i}).select().single();if(g)throw g;return t.guesses.push(l),_&&o.user&&await d(o.user.id,i),s.value="",{success:!0,isCorrect:_,guess:l}}catch(R){return m.value=R instanceof Error?R.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",R),{success:!1,error:m.value}}finally{G.value=!1}}function y(R,k){const _=R.trim(),i=k.trim();return _===i}function C(){m.value=null}return{guessInput:s,error:m,loading:G,currentWord:b,correctGuesses:$,hasGuessed:M,submitGuess:I,clearError:C}}const cs={class:"game-container"},us={key:0,class:"container margin-top-large"},ds={class:"row flex-center"},vs={class:"col-12 col-md-8"},ms={key:1,class:"game-layout"},gs={class:"game-sidebar game-players"},ws={class:"player-list-container"},hs={class:"game-main"},fs={key:0,class:"time-display"},_s={key:1,class:"time-display summary"},ps={class:"time-number"},ys={class:"round-info"},Rs={class:"round-label"},bs={key:0,class:"phase-label"},Cs={key:2,class:"word-display"},ks={class:"word-text"},Ds={key:3,class:"word-display"},Ss={class:"drawer-hint"},Fs={class:"word-slots"},$s={key:4,class:"word-display summary-word"},xs={class:"word-text revealed"},Ws={class:"game-content-area"},Ts={class:"game-canvas"},Is={key:0,class:"time-progress"},Gs={key:1,class:"summary-overlay"},Ms={class:"game-chat-panel"},Ls={key:0,class:"chat-msg system-msg answer-revealed"},Vs={key:1,class:"chat-msg system-msg"},Ns={class:"msg-player"},Bs={key:0,class:"msg-correct"},Es={key:1,class:"msg-text"},Ps={key:2,class:"chat-msg correct-self"},As={class:"chat-input-area"},zs={key:0,type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"},Hs=["placeholder","disabled"],Os=["disabled"],Us={key:2,class:"container margin-top-large"},qs={class:"row flex-center"},Js={class:"col-12 col-md-8"},Ks={class:"card"},Ys={class:"card-body text-center"},Xs=Z({__name:"RoomView",setup(t){const o=ze(),v=Je(),d=se(),s=ne(),m=J(),{subscribeRoom:G,unsubscribeRoom:b,subscribeGameState:$}=me(),{isPlaying:M,isWaiting:I,isFinished:y,timeRemaining:C,isCountingDown:R,isCurrentDrawer:k,drawTime:_,currentRoundNumber:i,totalRounds:l,startGame:g,isDrawing:r,isSummary:h,summaryTimeRemaining:w,startSummaryCountdown:z,stopSummaryCountdown:x,startCountdown:V,stopCountdown:P}=Ce(),{hasGuessed:A,guessInput:K,submitGuess:We,loading:Te}=ls(),{leaveRoom:Ie}=Ye(),S=W(()=>d.currentRoom),we=W(()=>Te.value),he=T(null),te=T(null),oe=W(()=>{const p=S.value?.current_drawer_id;return p&&d.participants.find(D=>D.user_id===p)?.nickname||"ç•«å®¶"}),Ge=W(()=>{if(!S.value||d.participants.length===0)return"";const n=(S.value.current_round||0)%d.participants.length;return d.participants[n]?.nickname||"ä¸‹ä¸€ä½ç•«å®¶"}),fe=W(()=>i.value>=l.value),_e=W(()=>[...s.guesses].sort((p,n)=>new Date(p.guessed_at).getTime()-new Date(n.guessed_at).getTime()));function Me(){te.value&&(te.value.scrollTop=te.value.scrollHeight)}j(_e,()=>{Ke(Me)},{deep:!0}),j(()=>d.participants,p=>{if(!m.user||!S.value)return;!p.some(D=>D.user_id===m.user.id)&&S.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),d.clearRoom(),v.push("/"))},{deep:!0});function pe(p){return d.participants.find(D=>D.user_id===p)?.nickname||"æœªçŸ¥ç©å®¶"}const Le=W(()=>k.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":A.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ve=W(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),ye=W(()=>s.currentRoundCorrectGuesses.length*5),Re=W(()=>s.currentRoundCorrectGuesses.map(p=>({userId:p.user_id,name:pe(p.user_id),score:p.score_earned}))),Ne=T(null);function Be(){!s.currentRound||!s.currentWord||(Ne.value={roundNumber:i.value,answer:s.currentWord,drawerName:oe.value,drawerId:s.currentRound.drawer_id,drawerScore:ye.value,correctGuessers:Re.value,roundId:s.currentRound.id})}j(h,(p,n)=>{p&&!n&&i.value>0&&Be()});function re(p){he.value=p,setTimeout(()=>{he.value=null},3e3)}async function be(){!k.value&&K.value.trim()&&await We()}async function Ee(){const p=await g();!p.success&&p.error&&re(p.error)}async function ae(){const p=await Ie();S.value&&b(S.value.code),await v.push("/"),!p.success&&p.error&&re(p.error)}async function Pe(p){if(!s.currentRound)return;const n=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,p);!n.success&&n.error&&re(n.error)}return de(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",o.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",S.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",m.user?.id);const p=o.params.code;if(p&&!S.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",p),S.value&&m.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",S.value.status),await s.loadCurrentRound(S.value.id),S.value.status==="playing"&&s.currentRound){const n=s.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:n.round_number,startedAt:n.started_at,endedAt:n.ended_at,drawerId:n.drawer_id}),n.drawer_id&&d.setCurrentDrawer(n.drawer_id),n.started_at&&!n.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),s.setRoundStatus("drawing");const D=new Date(n.started_at).getTime(),ie=Date.now(),le=Math.floor((ie-D)/1e3),Y=Math.max(0,_.value-le);console.log("[RoomView] åˆ·æ–°æ¢å¾©å€’è¨ˆæ™‚:",Y,"ç§’"),V(Y)}else n.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await G(S.value.code,S.value.id,m.user.id,{nickname:m.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(n){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",n)}$(S.value.code,async n=>{if(console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",n),n.drawerId&&S.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",n.drawerId),d.setCurrentDrawer(n.drawerId)),n.roundStatus){if(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",n.roundStatus),s.setRoundStatus(n.roundStatus),n.roundStatus==="drawing"){x(),s.clearRatings();let D=_.value;if(n.startedAt){const ie=new Date(n.startedAt).getTime(),le=Date.now(),Y=Math.floor((le-ie)/1e3);D=Math.max(0,_.value-Y),console.log("[RoomView] æ ¹æ“šæœå‹™å™¨æ™‚é–“è¨ˆç®—å‰©é¤˜æ™‚é–“:",D,"ç§’ (elapsed:",Y,"ç§’)")}console.log("[RoomView] é–‹å§‹å€’è¨ˆæ™‚:",D,"ç§’"),V(D)}n.roundStatus==="summary"&&(P(),n.isLastRound?d.isHost&&setTimeout(async()=>{const{endGame:D}=Ce();await D()},5e3):z())}S.value&&(await d.loadRoom(S.value.id),await s.loadCurrentRound(S.value.id))}),await s.loadAllGuesses(S.value.id)}}),ve(()=>{S.value&&b(S.value.code)}),(p,n)=>(u(),c("div",cs,[a(I)?(u(),c("div",us,[e("div",ds,[e("div",vs,[H(Xe,{room:S.value,participants:a(d).participants,onStartGame:Ee,onLeaveRoom:ae},null,8,["room","participants"])])])])):a(M)?(u(),c("div",ms,[e("div",gs,[e("div",ws,[H(Fe,{"show-winner":!1})])]),e("div",hs,[e("div",{class:N(["game-header",{"time-critical":a(C)!==null&&a(C)<=10}])},[a(r)&&a(R)&&a(C)!==null?(u(),c("div",fs,[e("span",{class:N(["time-number",{"time-warning":a(C)<=10,"time-critical-pulse":a(C)<=5}])},f(a(C)),3),n[1]||(n[1]=e("span",{class:"time-label"},"ç§’",-1))])):a(h)&&a(w)!==null?(u(),c("div",_s,[e("span",ps,f(a(w)),1),n[2]||(n[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):F("",!0),e("div",ys,[e("span",Rs,"ç¬¬ "+f(a(i))+" / "+f(a(l))+" è¼ª",1),a(h)?(u(),c("span",bs,"è¼ªæ¬¡çµç®—")):F("",!0)]),a(r)&&a(k)&&a(s).currentWord?(u(),c("div",Cs,[n[3]||(n[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",ks,f(a(s).currentWord),1)])):a(r)?(u(),c("div",Ds,[e("span",Ss,"ğŸ¨ "+f(oe.value)+" æ­£åœ¨ç•«",1),e("span",Fs,f(Ve.value),1)])):a(h)&&a(s).currentWord?(u(),c("div",$s,[n[4]||(n[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",xs,f(a(s).currentWord),1)])):F("",!0),e("button",{class:"leave-btn",onClick:ae,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ws,[e("div",{class:N(["game-toolbar",{disabled:a(h)}])},[H(dt,{compact:!0})],2),e("div",Ts,[H(Ze),!a(h)&&a(R)&&a(C)!==null?(u(),c("div",Is,[e("div",{class:N(["time-bar",{"time-warning":a(C)<=10}]),style:ce({width:`${a(C)/a(_)*100}%`})},null,6)])):F("",!0),a(h)?(u(),c("div",Gs,[H(is,{"round-number":a(i),"total-rounds":a(l),"correct-answer":a(s).currentWord||"","drawer-name":oe.value,"drawer-id":a(s).currentRound?.drawer_id||"","drawer-score":ye.value,"correct-guessers":Re.value,"round-id":a(s).currentRound?.id||"","is-host":a(d).isHost,"is-last-round":fe.value,"next-drawer-name":fe.value?"":Ge.value,onRatingSubmitted:Pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round","next-drawer-name"])])):F("",!0)]),e("div",Ms,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:te},[a(h)?(u(),c("div",Ls,[n[5]||(n[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),n[6]||(n[6]=Q(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,f(a(s).currentWord),1)])):F("",!0),a(h)?F("",!0):(u(),c("div",Vs,[...n[7]||(n[7]=[e("span",{class:"msg-icon"},"ğŸ®",-1),Q(" éŠæˆ²é–‹å§‹ï¼ ",-1)])])),(u(!0),c(U,null,q(a(h)?a(s).currentRoundCorrectGuesses:_e.value,D=>(u(),c("div",{key:D.id,class:N(["chat-msg",{"correct-guess":D.is_correct,"wrong-guess":!D.is_correct}])},[e("span",Ns,f(pe(D.user_id)),1),D.is_correct?(u(),c("span",Bs,"çŒœä¸­äº†ï¼ +"+f(D.score_earned),1)):(u(),c("span",Es,f(D.guess_text),1))],2))),128)),!a(h)&&a(A)?(u(),c("div",Ps,[...n[8]||(n[8]=[e("span",{class:"msg-icon"},"âœ…",-1),Q(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):F("",!0)],512),e("div",As,[a(h)?(u(),c("input",zs)):He((u(),c("input",{key:1,"onUpdate:modelValue":n[0]||(n[0]=D=>qe(K)?K.value=D:null),type:"text",placeholder:Le.value,maxlength:"32",disabled:we.value||a(A)||a(k),onKeyup:Ue(be,["enter"]),class:"chat-input-field"},null,40,Hs)),[[Oe,a(K)]]),e("button",{onClick:be,disabled:a(h)||we.value||a(A)||a(k)||!a(K).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Os)])])])])])):a(y)?(u(),c("div",Us,[e("div",qs,[e("div",Js,[e("div",Ks,[e("div",Ys,[n[9]||(n[9]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),H(Fe,{"show-winner":!0}),e("button",{onClick:ae,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):F("",!0)]))}}),Zs=ee(Xs,[["__scopeId","data-v-c76fcb6d"]]);export{Zs as default};
