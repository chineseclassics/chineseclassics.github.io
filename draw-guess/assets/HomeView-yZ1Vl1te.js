import{d as S,u as H,c as u,a as C,b as a,e,t as m,o as d,_ as I,r as $,f as R,w as T,g as h,v as y,h as A,i as j,j as V,k as q}from"./index-wDTh4NzO.js";import{u as U,a as J,b as M,W}from"./useRealtime-CcpqkPb7.js";const F={class:"user-auth"},L={key:0},B=["disabled"],D=["disabled"],N={key:1,class:"row flex-middle"},E={class:"col-8"},O={class:"row flex-middle"},z={class:"col-2"},P=["src","alt"],K={key:1,class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-secondary)","border-color":"var(--border-light)",color:"var(--text-primary)"}},Q={class:"col-10"},X={class:"text-hand"},Y={class:"text-small"},Z={class:"col-4 text-right"},ee=["disabled"],te={key:2,class:"alert alert-danger margin-top-small"},oe=S({__name:"UserAuth",setup(G){const l=H();async function o(){const s=await l.signInAnonymously();s&&!s.success&&console.error("匿名登入失敗:",s.error)}async function w(){const s=await l.signInWithGoogle();s&&!s.success&&console.error("Google 登入失敗:",s.error)}async function b(){const s=await l.signOut();s.success||console.error("登出失敗:",s.error)}return(s,r)=>(d(),u("div",F,[a(l).isAuthenticated?(d(),u("div",N,[e("div",E,[e("div",O,[e("div",z,[a(l).profile?.avatar_url?(d(),u("img",{key:0,src:a(l).profile.avatar_url,alt:a(l).profile.display_name,class:"border",style:{width:"40px",height:"40px","border-radius":"50%","object-fit":"cover","border-color":"var(--border-color)"}},null,8,P)):(d(),u("div",K,m(a(l).profile?.display_name?.charAt(0)||"?"),1))]),e("div",Q,[e("div",X,m(a(l).profile?.display_name||"用戶"),1),e("div",Y,m(a(l).isAnonymous?"匿名遊玩":"已登入"),1)])])]),e("div",Z,[e("button",{onClick:b,disabled:a(l).loading,class:"paper-btn btn-small"},m(a(l).loading?"處理中...":"登出"),9,ee)])])):(d(),u("div",L,[e("button",{onClick:o,disabled:a(l).loading,class:"paper-btn btn-primary btn-block margin-bottom-small"},m(a(l).loading?"處理中...":"匿名遊玩"),9,B),e("button",{onClick:w,disabled:a(l).loading,class:"paper-btn btn-secondary btn-block"},m(a(l).loading?"處理中...":"Google 登入"),9,D)])),a(l).error?(d(),u("div",te,m(a(l).error),1)):C("",!0)]))}}),se=I(oe,[["__scopeId","data-v-300f2b31"]]),ne={class:"room-create"},le={class:"card"},ae={class:"card-body"},re={class:"form-group"},ie={class:"form-group"},ue={class:"text-small"},de={key:0,class:"text-small",style:{color:"#e8590c"}},ce={class:"margin-top-medium"},me={class:"form-group"},ve={class:"form-group"},pe=["max"],_e={class:"text-small"},ge={class:"form-group"},be={class:"form-group"},fe={key:0,class:"alert alert-danger margin-top-small"},he={class:"row flex-spaces margin-top-medium"},ye=["disabled"],we=S({__name:"RoomCreate",emits:["cancel","created"],setup(G,{emit:l}){const o=l,{createRoom:w,loading:b}=U(),s=$({name:"",wordsText:"",settings:{draw_time:120,rounds:5,word_count_per_round:3,hints_count:2}}),r=$(null);function g(v){return v.split(/[,\n]/).map(t=>t.trim()).filter(t=>t.length>0)}function x(){r.value=null}const p=R(()=>g(s.value.wordsText)),c=R(()=>p.value.length),_=R(()=>s.value.wordsText.length),i=R(()=>s.value.name.trim().length>0&&s.value.name.length<=50&&c.value>=6&&_.value<=600&&p.value.every(v=>v.length>=1&&v.length<=32)&&s.value.settings.rounds<=c.value);async function f(){if(!i.value){r.value="請檢查表單輸入";return}r.value=null;try{const v=p.value.map(n=>({text:n,source:"custom"})),t=await w({name:s.value.name.trim(),words:v,settings:s.value.settings});t.success&&t.room?o("created",t.room.code):(r.value=t.error||"創建房間失敗",console.error("創建房間失敗:",t.error))}catch(v){r.value=v instanceof Error?v.message:"創建房間時發生錯誤",console.error("創建房間異常:",v)}}return(v,t)=>(d(),u("div",ne,[e("div",le,[e("div",ae,[t[14]||(t[14]=e("h2",{class:"card-title text-hand-title"},"創建房間",-1)),e("form",{onSubmit:T(f,["prevent"])},[e("div",re,[t[7]||(t[7]=e("label",null,"房間名稱",-1)),h(e("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>s.value.name=n),type:"text",placeholder:"輸入房間名稱",maxlength:"50",required:""},null,512),[[y,s.value.name]])]),e("div",ie,[t[8]||(t[8]=e("label",null,"自定義詞語（至少 6 個，每個 1-32 字符，最多 600 字符）",-1)),h(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=n=>s.value.wordsText=n),rows:"6",placeholder:`輸入詞語，用逗號或換行分隔
例如：春天,友誼,勇氣`,onInput:x},null,544),[[y,s.value.wordsText]]),e("div",ue," 已輸入 "+m(c.value)+" 個詞語，"+m(_.value)+" / 600 字符 ",1),c.value<6?(d(),u("div",de," 還需要 "+m(6-c.value)+" 個詞語 ",1)):C("",!0)]),e("div",ce,[t[13]||(t[13]=e("h4",{class:"text-hand-title"},"遊戲設置",-1)),e("div",me,[t[9]||(t[9]=e("label",null,"繪畫時間（秒）",-1)),h(e("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>s.value.settings.draw_time=n),type:"number",min:"60",max:"180",required:""},null,512),[[y,s.value.settings.draw_time,void 0,{number:!0}]])]),e("div",ve,[t[10]||(t[10]=e("label",null,"輪數",-1)),h(e("input",{"onUpdate:modelValue":t[3]||(t[3]=n=>s.value.settings.rounds=n),type:"number",min:3,max:Math.min(10,c.value),required:""},null,8,pe),[[y,s.value.settings.rounds,void 0,{number:!0}]]),e("div",_e," 最多 "+m(Math.min(10,c.value))+" 輪（不能超過詞語總數） ",1)]),e("div",ge,[t[11]||(t[11]=e("label",null,"每輪可選詞數",-1)),h(e("input",{"onUpdate:modelValue":t[4]||(t[4]=n=>s.value.settings.word_count_per_round=n),type:"number",min:"1",max:"5",required:""},null,512),[[y,s.value.settings.word_count_per_round,void 0,{number:!0}]])]),e("div",be,[t[12]||(t[12]=e("label",null,"提示數量",-1)),h(e("input",{"onUpdate:modelValue":t[5]||(t[5]=n=>s.value.settings.hints_count=n),type:"number",min:"0",max:"5",required:""},null,512),[[y,s.value.settings.hints_count,void 0,{number:!0}]])])]),r.value?(d(),u("div",fe,m(r.value),1)):C("",!0),e("div",he,[e("button",{type:"submit",disabled:a(b)||!i.value,class:"paper-btn btn-primary"},m(a(b)?"創建中...":"創建房間"),9,ye),e("button",{type:"button",onClick:t[6]||(t[6]=n=>v.$emit("cancel")),class:"paper-btn btn-secondary"}," 取消 ")])],32)])])]))}}),xe=I(we,[["__scopeId","data-v-36d67146"]]),$e={class:"room-join"},ke={class:"card"},Re={class:"card-body"},Ve={class:"form-group"},Ce={class:"form-group"},Se={key:0,class:"alert alert-danger"},Ge={class:"row flex-spaces margin-top-medium"},He=["disabled"],Ie=S({__name:"RoomJoin",emits:["cancel","joined"],setup(G,{emit:l}){const o=l,{joinRoom:w,loading:b}=U(),s=H(),r=$({code:"",nickname:s.profile?.display_name||""}),g=$(null);function x(_){const i=_.target;r.value.code=i.value.replace(/\D/g,"").slice(0,6),g.value=null}const p=R(()=>r.value.code.length===6&&r.value.nickname.trim().length>0&&r.value.nickname.length<=20);async function c(){if(!p.value){g.value="請檢查表單輸入";return}g.value=null;const _=await w(r.value.code,r.value.nickname.trim());_.success?o("joined"):g.value=_.error||"加入房間失敗"}return(_,i)=>(d(),u("div",$e,[e("div",ke,[e("div",Re,[i[6]||(i[6]=e("h2",{class:"card-title text-hand-title"},"加入房間",-1)),e("form",{onSubmit:T(c,["prevent"])},[e("div",Ve,[i[3]||(i[3]=e("label",null,"房間碼",-1)),h(e("input",{"onUpdate:modelValue":i[0]||(i[0]=f=>r.value.code=f),type:"text",class:"text-center",style:{"font-size":"2rem","letter-spacing":"0.5rem"},placeholder:"000000",maxlength:"6",pattern:"[0-9]{6}",required:"",onInput:x},null,544),[[y,r.value.code]]),i[4]||(i[4]=e("div",{class:"text-small"}," 輸入 6 位數字房間碼 ",-1))]),e("div",Ce,[i[5]||(i[5]=e("label",null,"暱稱",-1)),h(e("input",{"onUpdate:modelValue":i[1]||(i[1]=f=>r.value.nickname=f),type:"text",placeholder:"輸入您的暱稱",maxlength:"20",required:""},null,512),[[y,r.value.nickname]])]),g.value?(d(),u("div",Se,m(g.value),1)):C("",!0),e("div",Ge,[e("button",{type:"submit",disabled:a(b)||!p.value,class:"paper-btn btn-primary"},m(a(b)?"加入中...":"加入房間"),9,He),e("button",{type:"button",onClick:i[2]||(i[2]=f=>_.$emit("cancel")),class:"paper-btn btn-secondary"}," 取消 ")])],32)])])]))}}),Ue=I(Ie,[["__scopeId","data-v-35f98c69"]]),Ae={class:"container margin-top-large"},Te={class:"row flex-center"},je={class:"col-12 col-md-10 col-lg-8"},qe={class:"margin-bottom-large"},Je={key:0,class:"margin-bottom-large"},Me={key:1,class:"margin-bottom-large"},We={key:2},Fe={key:0,class:"margin-bottom-large"},Le={key:1,class:"margin-bottom-large"},Be={key:2,class:"row flex-center"},De={class:"col-12 col-md-6"},Oe=S({__name:"HomeView",setup(G){const l=q(),{currentRoom:o,participants:w,leaveRoom:b}=U(),{startGame:s}=J(),{subscribeRoom:r,unsubscribeRoom:g}=M(),x=H(),p=$(!1),c=$(!1);function _(t){p.value=!1,o.value&&l.push(`/room/${o.value.code}`)}function i(){c.value=!1,o.value&&l.push(`/room/${o.value.code}`)}async function f(){console.log("[HomeView] 開始遊戲，當前狀態:",o.value?.status);const t=await s();if(console.log("[HomeView] 開始遊戲結果:",t,"當前狀態:",o.value?.status),t.success)if(await new Promise(n=>setTimeout(n,200)),o.value&&(o.value.status==="playing"||o.value.status==="finished")){const n=l.currentRoute.value;n.name!=="room"||n.params.code!==o.value.code?(console.log("[HomeView] handleStartGame 中跳轉到 RoomView:",o.value.code),l.push(`/room/${o.value.code}`)):console.log("[HomeView] handleStartGame 中已在 RoomView，無需跳轉")}else console.warn("[HomeView] handleStartGame 中狀態不正確:",{currentRoom:o.value,status:o.value?.status});else console.error("開始遊戲失敗:",t.error)}async function v(){(await b()).success&&(p.value=!1,c.value=!1)}return A(()=>o.value,t=>{t&&x.user?r(t.code,t.id,x.user.id,{nickname:x.profile?.display_name||"玩家"}):t||o.value&&g(o.value.code)},{immediate:!0}),A(()=>o.value?.status,(t,n)=>{if(console.log("[HomeView] 房間狀態變化:",{oldStatus:n,newStatus:t,currentRoute:l.currentRoute.value.name}),o.value&&(t==="playing"||t==="finished")){const k=l.currentRoute.value;k.name!=="room"||k.params.code!==o.value.code?(console.log("[HomeView] 準備跳轉到 RoomView:",o.value.code),setTimeout(()=>{o.value&&(o.value.status==="playing"||o.value.status==="finished")?(console.log("[HomeView] 執行跳轉到 RoomView:",o.value.code),l.push(`/room/${o.value.code}`)):console.warn("[HomeView] 跳轉條件不滿足:",{currentRoom:o.value,status:o.value?.status})},100)):console.log("[HomeView] 已在 RoomView，無需跳轉")}}),j(()=>{}),(t,n)=>(d(),u("div",Ae,[e("div",Te,[e("div",je,[n[5]||(n[5]=e("div",{class:"text-center margin-bottom-large"},[e("h1",{class:"text-hand-title"}," 你畫我猜 "),e("p",{class:"lead text-hand"}," 通過繪畫和猜測，學習中文詞彙 ")],-1)),e("div",qe,[V(se)]),a(o)&&a(o).status==="waiting"?(d(),u("div",Je,[V(W,{room:a(o),participants:a(w),onStartGame:f,onLeaveRoom:v},null,8,["room","participants"])])):a(o)&&(a(o).status==="playing"||a(o).status==="finished")?(d(),u("div",Me,[...n[4]||(n[4]=[e("div",{class:"text-center"},[e("p",{class:"text-hand"},"正在跳轉到遊戲房間...")],-1)])])):(d(),u("div",We,[p.value?(d(),u("div",Fe,[V(xe,{onCreated:_,onCancel:n[0]||(n[0]=()=>{console.log("取消創建房間"),p.value=!1})})])):c.value?(d(),u("div",Le,[V(Ue,{onJoined:i,onCancel:n[1]||(n[1]=k=>c.value=!1)})])):(d(),u("div",Be,[e("div",De,[e("button",{onClick:n[2]||(n[2]=k=>p.value=!0),class:"paper-btn btn-primary btn-block margin-bottom-small"}," 創建房間 "),e("button",{onClick:n[3]||(n[3]=k=>c.value=!0),class:"paper-btn btn-secondary btn-block"}," 加入房間 ")])]))]))])])]))}});export{Oe as default};
