import{l as he,r as S,u as B,d as A,i as ne,m as oe,c as h,e as t,o as f,_ as J,f as x,n as L,a as M,F as z,p as U,q,t as $,b as d,s as O,x as fe,y as me,j as I,g as ge,v as pe,z as _e,A as we}from"./index-DU6_oAU9.js";import{c as Y,b as K,d as Q,e as re,a as ye,u as be,W as Fe}from"./useRealtime-CWhQZTke.js";const ie=he("drawing",()=>{const e=S("pen"),s=S("#000000"),a=S(3),r=S(!1),n=S([]);function i(l){e.value=l}function v(l){s.value=l}function p(l){a.value=Math.max(1,Math.min(20,l))}function b(l){n.value.push(l)}function C(){n.value=[]}function k(l){r.value=l}return{tool:e,color:s,lineWidth:a,isDrawing:r,strokes:n,setTool:i,setColor:v,setLineWidth:p,addStroke:b,clearStrokes:C,setDrawing:k}});function te(e,s){const a=e.getBoundingClientRect();let r,n;if(s instanceof MouseEvent)r=s.clientX,n=s.clientY;else if(s instanceof TouchEvent&&s.touches.length>0&&s.touches[0])r=s.touches[0].clientX,n=s.touches[0].clientY;else return null;return{x:r-a.left,y:n-a.top}}function ae(e,s){if(!(s.points.length<2)){e.save(),s.tool==="pen"?(e.strokeStyle=s.color,e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"):s.tool==="eraser"&&(e.globalCompositeOperation="destination-out",e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"),e.beginPath(),s.points[0]&&e.moveTo(s.points[0].x,s.points[0].y);for(let a=1;a<s.points.length;a++){const r=s.points[a];r&&e.lineTo(r.x,r.y)}e.stroke(),e.restore()}}function j(e,s){const a=e.getContext("2d");if(!a)return;const r=e.getBoundingClientRect();a.clearRect(0,0,e.width,e.height),a.fillStyle="#FFFFFF",a.fillRect(0,0,r.width,r.height),s.forEach(n=>{ae(a,n)})}function Ce(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function le(){const e=ie(),s=Y(),a=B(),{sendDrawing:r}=K(),n=S(null),i=S(null),v=S(null),p=S(null);let b=null;const C=50;function k(o){n.value=o;const u=o.getContext("2d",{willReadFrequently:!0});if(!u){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}i.value=u;const _=window.devicePixelRatio||1,E=o.getBoundingClientRect();o.width=E.width*_,o.height=E.height*_,u.scale(_,_),u.fillStyle="#FFFFFF",u.fillRect(0,0,E.width,E.height),n.value&&j(n.value,e.strokes),new ResizeObserver(()=>{if(!n.value||!i.value)return;const V=n.value.getBoundingClientRect(),P=window.devicePixelRatio||1;n.value.width=V.width*P,n.value.height=V.height*P,i.value.scale(P,P),i.value.fillStyle="#FFFFFF",i.value.fillRect(0,0,V.width,V.height),j(n.value,e.strokes)}).observe(o)}function l(o){if(!n.value)return;o.preventDefault(),e.setDrawing(!0);const u=te(n.value,o);u&&(v.value={id:Ce(),tool:e.tool,color:e.color,lineWidth:e.lineWidth,points:[u],timestamp:Date.now()},p.value=u)}function R(o){if(!n.value||!i.value||!e.isDrawing||!v.value)return;o.preventDefault();const u=te(n.value,o);if(!u||!p.value)return;const _=i.value;_.save(),v.value.tool==="pen"?(_.strokeStyle=v.value.color,_.lineWidth=v.value.lineWidth,_.lineCap="round",_.lineJoin="round"):v.value.tool==="eraser"&&(_.globalCompositeOperation="destination-out",_.lineWidth=v.value.lineWidth,_.lineCap="round",_.lineJoin="round"),_.beginPath(),_.moveTo(p.value.x,p.value.y),_.lineTo(u.x,u.y),_.stroke(),_.restore(),v.value.points.push(u),p.value=u,b===null&&(b=window.setTimeout(()=>{y(),b=null},C))}function c(){!e.isDrawing||!v.value||(e.setDrawing(!1),b&&(clearTimeout(b),b=null),y(),v.value=null,p.value=null)}async function y(){if(!(!v.value||!s.currentRoom||!a.user))try{const o={...v.value,userId:a.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",o.id),await r(s.currentRoom.code,o)}catch(o){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",o)}}function g(o){if(!(!n.value||!i.value)){if(o.userId&&a.user&&o.userId===a.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",o.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",o.id),e.addStroke(o),ae(i.value,o)}}function m(){if(!n.value||!i.value)return;const o=i.value,u=n.value;o.clearRect(0,0,u.width,u.height),o.fillStyle="#FFFFFF",o.fillRect(0,0,u.width,u.height),e.clearStrokes()}function D(o){e.setTool(o)}function T(o){e.setColor(o)}function W(o){e.setLineWidth(o)}function N(){n.value&&j(n.value,e.strokes)}return{canvasRef:n,initCanvas:k,startDrawing:l,draw:R,stopDrawing:c,clearCanvas:m,setTool:D,setColor:T,setLineWidth:W,handleDrawingData:g,redrawStrokes:N}}const ke={class:"drawing-canvas-container"},Re=A({__name:"DrawingCanvas",setup(e){const{initCanvas:s,startDrawing:a,draw:r,stopDrawing:n,handleDrawingData:i}=le(),v=Y(),p=B(),{subscribeDrawing:b}=K(),C=S(null);function k(W){a(W)}function l(W){r(W)}function R(){n()}function c(){n()}function y(W){a(W)}function g(W){r(W)}function m(){n()}let D=null;function T(){!v.currentRoom||!p.user||(D=b(v.currentRoom.code,W=>{i(W)}))}return ne(()=>{C.value&&s(C.value),T()}),oe(()=>{D&&(D(),D=null)}),(W,N)=>(f(),h("div",ke,[t("canvas",{ref_key:"canvasElement",ref:C,class:"drawing-canvas",onMousedown:k,onMousemove:l,onMouseup:R,onMouseleave:c,onTouchstart:y,onTouchmove:g,onTouchend:m},null,544)]))}}),De=J(Re,[["__scopeId","data-v-e71ea6a0"]]),Se={class:"toolbar-section"},We={key:0,class:"tool-label"},$e={key:0,class:"tool-label"},Te={key:0,class:"toolbar-section colors-section"},xe=["onClick","title"],Me={class:"toolbar-section size-section"},Ge={class:"size-dots"},Le=["onClick","title"],Ee={class:"toolbar-section"},Ve={key:0,class:"tool-label"},Pe=A({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(e){const s=ie(),{setTool:a,setColor:r,setLineWidth:n,clearCanvas:i}=le(),v=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],p=x(()=>s.tool),b=x(()=>s.color),C=x(()=>s.lineWidth);function k(y){a(y)}function l(y){r(y)}function R(y){s.setLineWidth(y),n(y)}function c(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&i()}return(y,g)=>(f(),h("div",{class:L(["drawing-toolbar",{"toolbar-compact":e.compact}])},[t("div",Se,[t("button",{onClick:g[0]||(g[0]=m=>k("pen")),class:L(["tool-btn",{active:p.value==="pen"}]),title:"ç•«ç­†"},[g[2]||(g[2]=t("span",{class:"tool-icon"},"âœï¸",-1)),e.compact?M("",!0):(f(),h("span",We,"ç•«ç­†"))],2),t("button",{onClick:g[1]||(g[1]=m=>k("eraser")),class:L(["tool-btn",{active:p.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[g[3]||(g[3]=t("span",{class:"tool-icon"},"ğŸ§¹",-1)),e.compact?M("",!0):(f(),h("span",$e,"æ©¡çš®æ“¦"))],2)]),p.value==="pen"?(f(),h("div",Te,[t("div",{class:L(["color-grid",{"color-grid-compact":e.compact}])},[(f(),h(z,null,U(v,m=>t("div",{key:m,onClick:D=>l(m),class:L(["color-cell",{selected:b.value===m}]),style:q({backgroundColor:m}),title:m},null,14,xe)),64))],2)])):M("",!0),t("div",Me,[t("div",Ge,[(f(),h(z,null,U([2,5,10,15],m=>t("div",{key:m,onClick:D=>R(m),class:L(["size-dot",{active:C.value===m}]),style:q({width:`${m+8}px`,height:`${m+8}px`}),title:`${m}px`},null,14,Le)),64))])]),t("div",Ee,[t("button",{onClick:c,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[g[4]||(g[4]=t("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),e.compact?M("",!0):(f(),h("span",Ve,"æ¸…ç©º"))])])],2))}}),Ie=J(Pe,[["__scopeId","data-v-7e7250c3"]]),Be={class:"player-list"},Ne={class:"player-list-header"},Oe={class:"player-count"},ze={class:"player-rank"},Ue={class:"player-info"},Ae={class:"player-name"},Je={key:0,class:"drawer-badge"},Ye={key:1,class:"host-badge"},He={class:"player-score"},Xe={key:0,class:"winner-banner"},je={class:"winner-text"},qe={class:"winner-name"},Ke={class:"winner-score"},Qe=A({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(e){const s=Y(),a=Q(),r=B(),{playerRankings:n,winner:i}=re(),v=x(()=>n.value);function p(l){return s.participants.find(c=>c.user_id===l)?.nickname||"æœªçŸ¥ç©å®¶"}function b(l){return r.user?.id===l}function C(l){return s.currentRoom?.host_id===l}function k(l){return a.currentRound?.drawer_id===l}return(l,R)=>(f(),h("div",Be,[t("div",Ne,[t("span",Oe,"ç©å®¶ ("+$(v.value.length)+")",1)]),(f(!0),h(z,null,U(v.value,(c,y)=>(f(),h("div",{key:c.id,class:L(["player-item",{"is-current":b(c.user_id)},{"is-drawer":k(c.user_id)}])},[t("div",ze,$(y+1),1),t("div",{class:L(["player-avatar",{drawing:k(c.user_id)}])},$(p(c.user_id).charAt(0)),3),t("div",Ue,[t("div",Ae,[O($(p(c.user_id))+" ",1),k(c.user_id)?(f(),h("span",Je,"âœï¸")):M("",!0),C(c.user_id)?(f(),h("span",Ye,"ğŸ‘‘")):M("",!0)]),t("div",He,$(c.score)+" åˆ†",1)])],2))),128)),e.showWinner&&d(i)?(f(),h("div",Xe,[R[1]||(R[1]=t("div",{class:"winner-icon"},"ğŸ†",-1)),t("div",je,[R[0]||(R[0]=t("div",{class:"winner-title"},"ç²å‹è€…",-1)),t("div",qe,$(p(d(i).user_id)),1),t("div",Ke,$(d(i).score)+" åˆ†",1)])])):M("",!0)]))}}),se=J(Qe,[["__scopeId","data-v-4094673d"]]);function Ze(){const e=Q(),s=B(),{calculateGuessScore:a,updatePlayerScore:r}=re(),n=S(""),i=S(null),v=S(!1),p=x(()=>e.isCurrentDrawer?e.currentWord:null),b=x(()=>e.correctGuesses),C=x(()=>s.user?e.hasGuessed(s.user.id):!1);async function k(){if(!e.currentRound||!s.user)return i.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!n.value.trim())return i.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(n.value.length>32)return i.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(C.value)return i.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(e.isCurrentDrawer)return i.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{v.value=!0,i.value=null;const c=n.value.trim(),y=e.currentWord||"",g=l(c,y),m=g?a(b.value.length):0,{data:D,error:T}=await fe.from("guesses").insert({round_id:e.currentRound.id,user_id:s.user.id,guess_text:c,is_correct:g,score_earned:m}).select().single();if(T)throw T;return e.guesses.push(D),g&&s.user&&await r(s.user.id,m),g&&(n.value=""),{success:!0,isCorrect:g,guess:D}}catch(c){return i.value=c instanceof Error?c.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",c),{success:!1,error:i.value}}finally{v.value=!1}}function l(c,y){const g=c.trim(),m=y.trim();return g===m}function R(){i.value=null}return{guessInput:n,error:i,loading:v,currentWord:p,correctGuesses:b,hasGuessed:C,submitGuess:k,clearError:R}}const et={class:"game-container"},tt={key:0,class:"container margin-top-large"},st={class:"row flex-center"},nt={class:"col-12 col-md-8"},ot={key:1,class:"game-layout"},rt={class:"game-sidebar game-players"},it={class:"player-list-container"},at={class:"game-main"},lt={class:"game-header"},ct={key:0,class:"time-display"},ut={key:1,class:"word-display"},dt={class:"word-text"},vt={key:2,class:"word-display"},ht={class:"word-slots"},ft={class:"game-content-area"},mt={class:"game-toolbar"},gt={class:"game-canvas"},pt={key:0,class:"time-progress"},_t={class:"game-chat-panel"},wt={key:0,class:"chat-msg word-hint-msg"},yt={class:"msg-player"},bt={key:0,class:"msg-correct"},Ft={key:1,class:"msg-text"},Ct={key:1,class:"chat-msg correct-self"},kt={class:"chat-input-area"},Rt=["placeholder","disabled"],Dt=["disabled"],St={key:2,class:"container margin-top-large"},Wt={class:"row flex-center"},$t={class:"col-12 col-md-8"},Tt={class:"card"},xt={class:"card-body text-center"},Mt=A({__name:"RoomView",setup(e){const s=me(),a=Y(),r=Q(),n=B(),{subscribeRoom:i,subscribeGuesses:v,unsubscribeRoom:p}=K(),{isPlaying:b,isWaiting:C,isFinished:k,timeRemaining:l,isCountingDown:R,isCurrentDrawer:c,drawTime:y,startGame:g,skipWord:m}=ye(),{hasGuessed:D,guessInput:T,submitGuess:W,loading:N}=Ze(),{leaveRoom:o}=be(),u=x(()=>a.currentRoom),_=x(()=>N.value),E=S(null),Z=S(null),V=x(()=>[...r.guesses].sort((w,F)=>new Date(w.guessed_at).getTime()-new Date(F.guessed_at).getTime()));function P(w){return a.participants.find(G=>G.user_id===w)?.nickname||"æœªçŸ¥ç©å®¶"}const ce=x(()=>c.value?"ä½ æ˜¯ç•«å®¶ï¼Œè«‹ç•«ç•«...":D.value?"ä½ å·²çŒœä¸­ï¼":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),ue=x(()=>r.currentWord?r.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ");function H(w){E.value=w,setTimeout(()=>{E.value=null},3e3)}async function ee(){!c.value&&T.value.trim()&&await W()}async function de(){const w=await g();!w.success&&w.error&&H(w.error)}async function X(){const w=await o();!w.success&&w.error&&H(w.error)}async function ve(){const w=await m();!w.success&&w.error&&H(w.error)}return ne(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",s.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",u.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",n.user?.id);const w=s.params.code;w&&!u.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",w),u.value&&n.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",u.value.status),await r.loadCurrentRound(u.value.id),i(u.value.code,u.value.id,n.user.id,{nickname:n.profile?.display_name||"ç©å®¶"}),r.currentRound&&v(u.value.code,r.currentRound.id))}),oe(()=>{u.value&&p(u.value.code)}),(w,F)=>(f(),h("div",et,[d(C)?(f(),h("div",tt,[t("div",st,[t("div",nt,[I(Fe,{room:u.value,participants:d(a).participants,onStartGame:de,onLeaveRoom:X},null,8,["room","participants"])])])])):d(b)?(f(),h("div",ot,[t("div",rt,[t("div",it,[I(se,{"show-winner":!1})])]),t("div",at,[t("div",lt,[d(R)&&d(l)!==null?(f(),h("div",ct,[t("span",{class:L(["time-number",{"time-warning":d(l)<=10}])},$(d(l)),3)])):M("",!0),d(c)&&d(r).currentWord?(f(),h("div",ut,[F[1]||(F[1]=t("span",{class:"word-label"},"ä½ çš„è©èª",-1)),t("span",dt,$(d(r).currentWord),1),t("button",{class:"skip-btn",onClick:ve,title:"è·³éæ­¤è©"},"è·³é")])):(f(),h("div",vt,[t("span",ht,$(ue.value),1)])),t("button",{class:"leave-btn",onClick:X,title:"é›¢é–‹æˆ¿é–“"},"âœ•")]),t("div",ft,[t("div",mt,[I(Ie,{compact:!0})]),t("div",gt,[I(De),d(R)&&d(l)!==null?(f(),h("div",pt,[t("div",{class:L(["time-bar",{"time-warning":d(l)<=10}]),style:q({width:`${d(l)/d(y)*100}%`})},null,6)])):M("",!0)]),t("div",_t,[t("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:Z},[F[5]||(F[5]=t("div",{class:"chat-msg system-msg"},[t("span",{class:"msg-icon"},"ğŸ®"),O(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),d(c)&&d(r).currentWord?(f(),h("div",wt,[F[2]||(F[2]=t("span",{class:"msg-icon"},"ğŸ¨",-1)),F[3]||(F[3]=O(" ä½ è¦ç•«ï¼š",-1)),t("strong",null,$(d(r).currentWord),1)])):M("",!0),(f(!0),h(z,null,U(V.value,G=>(f(),h("div",{key:G.id,class:L(["chat-msg",{"correct-guess":G.is_correct,"wrong-guess":!G.is_correct}])},[t("span",yt,$(P(G.user_id)),1),G.is_correct?(f(),h("span",bt,"çŒœä¸­äº†ï¼ +"+$(G.score_earned),1)):(f(),h("span",Ft,$(G.guess_text),1))],2))),128)),d(D)?(f(),h("div",Ct,[...F[4]||(F[4]=[t("span",{class:"msg-icon"},"âœ…",-1),O(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),t("div",kt,[ge(t("input",{"onUpdate:modelValue":F[0]||(F[0]=G=>we(T)?T.value=G:null),type:"text",placeholder:ce.value,maxlength:"32",disabled:_.value||d(D)||d(c),onKeyup:_e(ee,["enter"]),class:"chat-input-field"},null,40,Rt),[[pe,d(T)]]),t("button",{onClick:ee,disabled:_.value||d(D)||d(c)||!d(T).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Dt)])])])])])):d(k)?(f(),h("div",St,[t("div",Wt,[t("div",$t,[t("div",Tt,[t("div",xt,[F[6]||(F[6]=t("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),I(se,{"show-winner":!0}),t("button",{onClick:X,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),Et=J(Mt,[["__scopeId","data-v-90e2afbb"]]);export{Et as default};
