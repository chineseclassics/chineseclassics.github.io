import{l as ae,r as k,u as E,d as P,i as j,m as Q,c as m,e as t,o as g,_ as B,f as x,n as T,a as $,F as Y,p as A,q as J,t as W,b as _,s as X,x as ie,y as re,j as V,z as le,g as ce,v as ue,A as de,B as ve}from"./index-CfZPCy1Z.js";import{c as N,b as O,d as q,e as Z,a as he,u as fe,W as me}from"./useRealtime-DAxbKDik.js";const ee=ae("drawing",()=>{const e=k("pen"),s=k("#000000"),a=k(3),u=k(!1),n=k([]);function i(c){e.value=c}function r(c){s.value=c}function f(c){a.value=Math.max(1,Math.min(20,c))}function y(c){n.value.push(c)}function R(){n.value=[]}function b(c){u.value=c}return{tool:e,color:s,lineWidth:a,isDrawing:u,strokes:n,setTool:i,setColor:r,setLineWidth:f,addStroke:y,clearStrokes:R,setDrawing:b}});function z(e,s){const a=e.getBoundingClientRect(),u=e.width/a.width,n=e.height/a.height;let i,r;if(s instanceof MouseEvent)i=s.clientX,r=s.clientY;else if(s instanceof TouchEvent&&s.touches.length>0&&s.touches[0])i=s.touches[0].clientX,r=s.touches[0].clientY;else return null;return{x:(i-a.left)*u,y:(r-a.top)*n}}function te(e,s){if(!(s.points.length<2)){e.save(),s.tool==="pen"?(e.strokeStyle=s.color,e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"):s.tool==="eraser"&&(e.globalCompositeOperation="destination-out",e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"),e.beginPath(),s.points[0]&&e.moveTo(s.points[0].x,s.points[0].y);for(let a=1;a<s.points.length;a++){const u=s.points[a];u&&e.lineTo(u.x,u.y)}e.stroke(),e.restore()}}function H(e,s){const a=e.getContext("2d");a&&(a.clearRect(0,0,e.width,e.height),a.fillStyle="#FFFFFF",a.fillRect(0,0,e.width,e.height),s.forEach(u=>{te(a,u)}))}function ge(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function se(){const e=ee(),s=N(),a=E(),{sendDrawing:u}=O(),n=k(null),i=k(null),r=k(null),f=k(null);let y=null;const R=50;function b(o){n.value=o;const h=o.getContext("2d",{willReadFrequently:!0});if(!h){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}i.value=h;const p=window.devicePixelRatio||1,L=o.getBoundingClientRect();o.width=L.width*p,o.height=L.height*p,h.scale(p,p),h.canvas.width=L.width,h.canvas.height=L.height,h.fillStyle="#FFFFFF",h.fillRect(0,0,o.width,o.height),n.value&&H(n.value,e.strokes)}function c(o){if(!n.value)return;o.preventDefault(),e.setDrawing(!0);const h=z(n.value,o);h&&(r.value={id:ge(),tool:e.tool,color:e.color,lineWidth:e.lineWidth,points:[h],timestamp:Date.now()},f.value=h)}function C(o){if(!n.value||!i.value||!e.isDrawing||!r.value)return;o.preventDefault();const h=z(n.value,o);if(!h||!f.value)return;const p=i.value;p.save(),r.value.tool==="pen"?(p.strokeStyle=r.value.color,p.lineWidth=r.value.lineWidth,p.lineCap="round",p.lineJoin="round"):r.value.tool==="eraser"&&(p.globalCompositeOperation="destination-out",p.lineWidth=r.value.lineWidth,p.lineCap="round",p.lineJoin="round"),p.beginPath(),p.moveTo(f.value.x,f.value.y),p.lineTo(h.x,h.y),p.stroke(),p.restore(),r.value.points.push(h),f.value=h,y===null&&(y=window.setTimeout(()=>{w(),y=null},R))}function l(){!e.isDrawing||!r.value||(e.setDrawing(!1),y&&(clearTimeout(y),y=null),w(),r.value=null,f.value=null)}async function w(){if(!(!r.value||!s.currentRoom||!a.user))try{const o={...r.value,userId:a.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",o.id),await u(s.currentRoom.code,o)}catch(o){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",o)}}function v(o){if(!(!n.value||!i.value)){if(o.userId&&a.user&&o.userId===a.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",o.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",o.id),e.addStroke(o),te(i.value,o)}}function d(){if(!n.value||!i.value)return;const o=i.value,h=n.value;o.clearRect(0,0,h.width,h.height),o.fillStyle="#FFFFFF",o.fillRect(0,0,h.width,h.height),e.clearStrokes()}function D(o){e.setTool(o)}function G(o){e.setColor(o)}function S(o){e.setLineWidth(o)}function I(){n.value&&H(n.value,e.strokes)}return{canvasRef:n,initCanvas:b,startDrawing:c,draw:C,stopDrawing:l,clearCanvas:d,setTool:D,setColor:G,setLineWidth:S,handleDrawingData:v,redrawStrokes:I}}const pe={class:"drawing-canvas-container"},_e=P({__name:"DrawingCanvas",setup(e){const{initCanvas:s,startDrawing:a,draw:u,stopDrawing:n,handleDrawingData:i}=se(),r=N(),f=E(),{subscribeDrawing:y,unsubscribeRoom:R}=O(),b=k(null);function c(S){a(S)}function C(S){u(S)}function l(){n()}function w(){n()}function v(S){a(S)}function d(S){u(S)}function D(){n()}function G(){!r.currentRoom||!f.user||y(r.currentRoom.code,S=>{i(S)})}return j(()=>{b.value&&s(b.value),G()}),Q(()=>{r.currentRoom&&R(r.currentRoom.code)}),(S,I)=>(g(),m("div",pe,[t("canvas",{ref_key:"canvasElement",ref:b,class:"drawing-canvas",onMousedown:c,onMousemove:C,onMouseup:l,onMouseleave:w,onTouchstart:v,onTouchmove:d,onTouchend:D},null,544)]))}}),we=B(_e,[["__scopeId","data-v-e4ccc127"]]),ye={class:"toolbar-section"},be={key:0,class:"tool-label"},Fe={key:0,class:"tool-label"},Ce={key:0,class:"toolbar-section colors-section"},Re=["onClick","title"],Se={class:"toolbar-section size-section"},De={class:"size-dots"},ke=["onClick","title"],$e={class:"toolbar-section"},We={key:0,class:"tool-label"},Te=P({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(e){const s=ee(),{setTool:a,setColor:u,setLineWidth:n,clearCanvas:i}=se(),r=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],f=x(()=>s.tool),y=x(()=>s.color),R=x(()=>s.lineWidth);function b(w){a(w)}function c(w){u(w)}function C(w){s.setLineWidth(w),n(w)}function l(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&i()}return(w,v)=>(g(),m("div",{class:T(["drawing-toolbar",{"toolbar-compact":e.compact}])},[t("div",ye,[t("button",{onClick:v[0]||(v[0]=d=>b("pen")),class:T(["tool-btn",{active:f.value==="pen"}]),title:"ç•«ç­†"},[v[2]||(v[2]=t("span",{class:"tool-icon"},"âœï¸",-1)),e.compact?$("",!0):(g(),m("span",be,"ç•«ç­†"))],2),t("button",{onClick:v[1]||(v[1]=d=>b("eraser")),class:T(["tool-btn",{active:f.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[v[3]||(v[3]=t("span",{class:"tool-icon"},"ğŸ§¹",-1)),e.compact?$("",!0):(g(),m("span",Fe,"æ©¡çš®æ“¦"))],2)]),f.value==="pen"?(g(),m("div",Ce,[t("div",{class:T(["color-grid",{"color-grid-compact":e.compact}])},[(g(),m(Y,null,A(r,d=>t("div",{key:d,onClick:D=>c(d),class:T(["color-cell",{selected:y.value===d}]),style:J({backgroundColor:d}),title:d},null,14,Re)),64))],2)])):$("",!0),t("div",Se,[t("div",De,[(g(),m(Y,null,A([2,5,10,15],d=>t("div",{key:d,onClick:D=>C(d),class:T(["size-dot",{active:R.value===d}]),style:J({width:`${d+8}px`,height:`${d+8}px`}),title:`${d}px`},null,14,ke)),64))])]),t("div",$e,[t("button",{onClick:l,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[v[4]||(v[4]=t("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),e.compact?$("",!0):(g(),m("span",We,"æ¸…ç©º"))])])],2))}}),xe=B(Te,[["__scopeId","data-v-7e7250c3"]]),Ge={class:"player-list"},Le={class:"player-list-header"},Me={class:"player-count"},Ve={class:"player-rank"},Ee={class:"player-info"},Ie={class:"player-name"},Pe={key:0,class:"drawer-badge"},Be={key:1,class:"host-badge"},Ne={class:"player-score"},Ue={key:0,class:"winner-banner"},Ye={class:"winner-text"},Ae={class:"winner-name"},Je={class:"winner-score"},Xe=P({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(e){const s=N(),a=q(),u=E(),{playerRankings:n,winner:i}=Z(),r=x(()=>n.value);function f(c){return s.participants.find(l=>l.user_id===c)?.nickname||"æœªçŸ¥ç©å®¶"}function y(c){return u.user?.id===c}function R(c){return s.currentRoom?.host_id===c}function b(c){return a.currentRound?.drawer_id===c}return(c,C)=>(g(),m("div",Ge,[t("div",Le,[t("span",Me,"ç©å®¶ ("+W(r.value.length)+")",1)]),(g(!0),m(Y,null,A(r.value,(l,w)=>(g(),m("div",{key:l.id,class:T(["player-item",{"is-current":y(l.user_id)},{"is-drawer":b(l.user_id)}])},[t("div",Ve,W(w+1),1),t("div",{class:T(["player-avatar",{drawing:b(l.user_id)}])},W(f(l.user_id).charAt(0)),3),t("div",Ee,[t("div",Ie,[X(W(f(l.user_id))+" ",1),b(l.user_id)?(g(),m("span",Pe,"âœï¸")):$("",!0),R(l.user_id)?(g(),m("span",Be,"ğŸ‘‘")):$("",!0)]),t("div",Ne,W(l.score)+" åˆ†",1)])],2))),128)),e.showWinner&&_(i)?(g(),m("div",Ue,[C[1]||(C[1]=t("div",{class:"winner-icon"},"ğŸ†",-1)),t("div",Ye,[C[0]||(C[0]=t("div",{class:"winner-title"},"ç²å‹è€…",-1)),t("div",Ae,W(f(_(i).user_id)),1),t("div",Je,W(_(i).score)+" åˆ†",1)])])):$("",!0)]))}}),K=B(Xe,[["__scopeId","data-v-4094673d"]]);function Oe(){const e=q(),s=E(),{calculateGuessScore:a,updatePlayerScore:u}=Z(),n=k(""),i=k(null),r=k(!1),f=x(()=>e.isCurrentDrawer?e.currentWord:null),y=x(()=>e.correctGuesses),R=x(()=>s.user?e.hasGuessed(s.user.id):!1);async function b(){if(!e.currentRound||!s.user)return i.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!n.value.trim())return i.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(n.value.length>32)return i.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(R.value)return i.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(e.isCurrentDrawer)return i.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{r.value=!0,i.value=null;const l=n.value.trim(),w=e.currentWord||"",v=c(l,w),d=v?a(y.value.length):0,{data:D,error:G}=await ie.from("guesses").insert({round_id:e.currentRound.id,user_id:s.user.id,guess_text:l,is_correct:v,score_earned:d}).select().single();if(G)throw G;return e.guesses.push(D),v&&s.user&&await u(s.user.id,d),v&&(n.value=""),{success:!0,isCorrect:v,guess:D}}catch(l){return i.value=l instanceof Error?l.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",l),{success:!1,error:i.value}}finally{r.value=!1}}function c(l,w){const v=l.trim(),d=w.trim();return v===d}function C(){i.value=null}return{guessInput:n,error:i,loading:r,currentWord:f,correctGuesses:y,hasGuessed:R,submitGuess:b,clearError:C}}const qe={class:"game-container"},ze={key:0,class:"container margin-top-large"},He={class:"row flex-center"},Ke={class:"col-12 col-md-8"},je={key:1,class:"game-layout"},Qe={class:"game-sidebar game-players"},Ze={class:"player-list-container"},et={class:"game-main"},tt={class:"game-header"},st={key:0,class:"word-display"},ot={class:"word-text"},nt={key:1,class:"word-display"},at={class:"game-canvas-area"},it={class:"game-toolbar"},rt={class:"game-canvas"},lt={key:0,class:"time-progress"},ct={class:"game-bottom"},ut={class:"game-answer"},dt={class:"answer-messages"},vt={key:0,class:"answer-info"},ht={class:"answer-info"},ft={class:"answer-input"},mt=["placeholder","disabled"],gt={key:2,class:"container margin-top-large"},pt={class:"row flex-center"},_t={class:"col-12 col-md-8"},wt={class:"card"},yt={class:"card-body text-center"},bt=P({__name:"RoomView",setup(e){const s=re(),a=N(),u=q(),n=E(),{subscribeRoom:i,subscribeGuesses:r,unsubscribeRoom:f}=O(),{isPlaying:y,isWaiting:R,isFinished:b,timeRemaining:c,isCountingDown:C,isCurrentDrawer:l,drawTime:w,startGame:v}=he(),{hasGuessed:d,guessInput:D,submitGuess:G,loading:S}=Oe(),{leaveRoom:I}=fe(),o=x(()=>a.currentRoom),h=x(()=>S.value);async function p(){!l.value&&D.value.trim()&&await G()}async function L(){(await v()).success}async function U(){(await I()).success}function oe(){console.log("è·³éè©èª")}return j(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",s.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",o.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",n.user?.id);const M=s.params.code;M&&!o.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",M),o.value&&n.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",o.value.status),await u.loadCurrentRound(o.value.id),i(o.value.code,o.value.id,n.user.id,{nickname:n.profile?.display_name||"ç©å®¶"}),u.currentRound&&r(o.value.code,u.currentRound.id))}),Q(()=>{o.value&&f(o.value.code)}),(M,F)=>(g(),m("div",qe,[_(R)?(g(),m("div",ze,[t("div",He,[t("div",Ke,[V(me,{room:o.value,participants:_(a).participants,onStartGame:L,onLeaveRoom:U},null,8,["room","participants"])])])])):_(y)?(g(),m("div",je,[t("div",Qe,[t("div",Ze,[V(K,{"show-winner":!1})])]),t("div",et,[t("div",tt,[_(l)&&_(u).currentWord?(g(),m("div",st,[F[1]||(F[1]=t("span",{class:"word-label"},"æç¤º",-1)),t("span",ot,W(_(u).currentWord),1),t("button",{class:"skip-btn",onClick:oe,title:"è·³éæ­¤è©"},"è·³é")])):(g(),m("div",nt,[...F[2]||(F[2]=[t("span",{class:"word-hint"},"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ",-1)])])),t("button",{class:"leave-btn",onClick:U,title:"é›¢é–‹æˆ¿é–“"},"âœ•")]),t("div",at,[t("div",it,[V(xe,{compact:!0})]),t("div",rt,[V(we),_(C)&&_(c)!==null?(g(),m("div",lt,[t("div",{class:T(["time-bar",{"time-warning":_(c)<=10}]),style:J({width:`${_(c)/_(w)*100}%`})},null,6)])):$("",!0)])]),t("div",ct,[t("div",ut,[F[5]||(F[5]=t("div",{class:"answer-header"},"ç­”æ¡ˆ",-1)),t("div",dt,[_(l)?(g(),m("div",vt,[...F[3]||(F[3]=[t("span",{class:"info-icon"},"â„¹ï¸",-1),X(" ç­‰å¾…ç©å®¶åŠ å…¥ ",-1)])])):$("",!0),t("div",ht,[F[4]||(F[4]=t("span",{class:"info-icon"},"âœï¸",-1)),X(" "+W(_(l)?"è¼ªåˆ°ä½ äº†ï¼":"è¼¸å…¥ä½ çš„ç­”æ¡ˆ"),1)])]),t("div",ft,[ce(t("input",{"onUpdate:modelValue":F[0]||(F[0]=ne=>ve(D)?D.value=ne:null),type:"text",placeholder:_(l)?"è¼ªåˆ°ä½ äº†":"è¼¸å…¥ç­”æ¡ˆ...",maxlength:"32",disabled:h.value||_(d)||_(l),onKeyup:de(p,["enter"])},null,40,mt),[[ue,_(D)]])])]),F[6]||(F[6]=le('<div class="game-chat" data-v-258aa2e0><div class="chat-header" data-v-258aa2e0>èŠå¤©å®¤</div><div class="chat-messages" data-v-258aa2e0><div class="chat-msg" data-v-258aa2e0><span class="chat-icon" data-v-258aa2e0>â„¹ï¸</span> æ­¡è¿ä¾†åˆ°éŠæˆ²ï¼</div></div><div class="chat-input" data-v-258aa2e0><input type="text" placeholder="è«‹ç™»å…¥ä»¥ç™¼é€è¨Šæ¯" disabled data-v-258aa2e0></div></div>',1))])])])):_(b)?(g(),m("div",gt,[t("div",pt,[t("div",_t,[t("div",wt,[t("div",yt,[F[7]||(F[7]=t("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),V(K,{"show-winner":!0}),t("button",{onClick:U,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):$("",!0)]))}}),Rt=B(bt,[["__scopeId","data-v-258aa2e0"]]);export{Rt as default};
