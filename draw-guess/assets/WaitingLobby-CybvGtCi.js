const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BYgLtfVD.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as dr,f as E,y as Ae,c as K,o as F,z as Ar,a as Re,e as x,A as Mr,B as We,r as W,u as me,E as y,I as He,h as Pr,t as Y,m as ae,n as Ye,F as Ke,p as Dr,b as ne,_ as Nr}from"./index-BYgLtfVD.js";const qr=["width","height","fill","transform"],kr={key:0},Or=x("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),Hr=[Or],Ur={key:1},Wr=x("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Br=x("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Lr=[Wr,Br],$r={key:2},Zr=x("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Vr=[Zr],jr={key:3},zr=x("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Yr=[zr],Kr={key:4},Fr=x("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Qr=[Fr],Jr={key:5},Xr=x("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),et=[Xr],rt={name:"PhPaintBrush"},Bt=dr({...rt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const u=e,a=Ae("weight","regular"),c=Ae("size","1em"),D=Ae("color","currentColor"),I=Ae("mirrored",!1),p=E(()=>u.weight??a),Z=E(()=>u.size??c),B=E(()=>u.color??D),C=E(()=>u.mirrored!==void 0?u.mirrored?"scale(-1, 1)":void 0:I?"scale(-1, 1)":void 0);return(R,T)=>(F(),K("svg",Mr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:Z.value,height:Z.value,fill:B.value,transform:C.value},R.$attrs),[Ar(R.$slots,"default"),p.value==="bold"?(F(),K("g",kr,Hr)):p.value==="duotone"?(F(),K("g",Ur,Lr)):p.value==="fill"?(F(),K("g",$r,Vr)):p.value==="light"?(F(),K("g",jr,Yr)):p.value==="regular"?(F(),K("g",Kr,Qr)):p.value==="thin"?(F(),K("g",Jr,et)):Re("",!0)],16,qr))}}),Ge=We("room",()=>{const e=W(null),u=W([]),a=W(!1),c=W(null),D=E(()=>{const t=me();return e.value?.host_id===t.user?.id});async function I(t){try{a.value=!0,c.value=null;const r=me();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch($){console.warn("載入用戶資料時發生錯誤（非關鍵）:",$)}const o=t.gameMode||"classic",g=t.settings.storyboard_writing_mode||"free";if((o==="classic"||o==="storyboard"&&g==="wordlist")&&t.words.length<6)throw new Error("至少需要 6 個詞語");let N=null,v=0;const L=10;for(;v<L&&!N;){v++;const s={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null,game_mode:o,single_round_mode:t.singleRoundMode||!1,is_final_round:!1},{data:i,error:_}=await y.from("game_rooms").insert(s).select().single();if(_){if(_.code==="23505")continue;throw new Error(_.message||"插入房間失敗")}if(i){N=i;break}}if(!N)throw new Error("無法生成唯一房間碼，請重試");const oe={room_id:N.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:$}=await y.from("room_participants").insert(oe);$&&console.error("創建參與記錄錯誤:",$)}catch($){console.error("創建參與記錄時發生錯誤:",$)}try{const{data:$,error:s}=await y.from("room_participants").select("*").eq("room_id",N.id).order("joined_at",{ascending:!0});s?console.error("載入參與者列表失敗:",s):$&&(u.value=$)}catch($){console.error("載入參與者列表時發生錯誤:",$)}return e.value=N,{success:!0,room:N}}catch(r){return c.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:c.value}}finally{a.value=!1}}async function p(t,r){try{a.value=!0,c.value=null;const o=me();if(!o.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:g,error:M}=await y.from("game_rooms").select("*").eq("code",t).single();if(M||!g)throw new Error("房間不存在");if(g.status!=="waiting")throw new Error("房間已開始或已結束");const{data:N}=await y.from("room_participants").select("*").eq("room_id",g.id).eq("user_id",o.user.id).maybeSingle();if(N)return e.value=g,await B(g.id),{success:!0,room:g};const{error:v}=await y.from("room_participants").insert({room_id:g.id,user_id:o.user.id,nickname:r.trim(),score:0});if(v){if(v.code==="23505"||v.message.includes("duplicate"))return e.value=g,await B(g.id),{success:!0,room:g};throw v}return e.value=g,await B(g.id),{success:!0,room:g}}catch(o){return c.value=o instanceof Error?o.message:"加入房間失敗",console.error("加入房間錯誤:",o),{success:!1,error:c.value}}finally{a.value=!1}}async function Z(){try{if(!e.value)return{success:!0};a.value=!0,c.value=null;const t=me();if(!t.user)throw new Error("請先登入");const{error:r}=await y.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(D.value){const{error:o}=await y.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);o&&console.error("關閉房間失敗:",o)}return e.value=null,u.value=[],{success:!0}}catch(t){return c.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,u.value=[],{success:!1,error:c.value}}finally{a.value=!1}}async function B(t){try{const{data:r,error:o}=await y.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(o)throw o;u.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function C(t){try{a.value=!0,c.value=null;const{data:r,error:o}=await y.from("game_rooms").select("*").eq("id",t).single();if(o)throw o;return e.value=r,await B(t),{success:!0,room:r}}catch(r){return c.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:c.value}}finally{a.value=!1}}async function R(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await y.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(t==="finished"&&e.value&&await T(),e.value){const o=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:o,newStatus:e.value.status})}return{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:c.value}}}async function T(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:t,error:r}=await y.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(r){console.error("獲取參與者錯誤:",r);return}if(!t||t.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const o=t.map(v=>v.user_id),{data:g,error:M}=await y.from("users").select("id, user_type").in("id",o);if(M){console.error("獲取用戶信息錯誤:",M);return}const N=new Set(g?.filter(v=>v.user_type==="registered").map(v=>v.id)||[]);for(const v of t){if(!N.has(v.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${v.user_id} 的積分累積`);continue}if(v.score>0){const{error:L}=await y.rpc("accumulate_user_score",{user_id_param:v.user_id,score_to_add:v.score});if(L){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",L);const{data:oe,error:$}=await y.from("users").select("total_score").eq("id",v.user_id).single();if($){console.error(`[RoomStore] 獲取用戶 ${v.user_id} 總積分錯誤:`,$);continue}const s=(oe?.total_score||0)+v.score,{error:i}=await y.from("users").update({total_score:s}).eq("id",v.user_id);i?console.error(`[RoomStore] 更新用戶 ${v.user_id} 總積分錯誤:`,i):console.log(`[RoomStore] 用戶 ${v.user_id} 積分已累積: +${v.score} (總積分: ${s})`)}else console.log(`[RoomStore] 用戶 ${v.user_id} 積分已累積: +${v.score}`)}}}catch(t){console.error("[RoomStore] 累積積分錯誤:",t)}}async function O(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await y.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:c.value}}}async function A(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:t});const r={...e.value.settings,...t},{error:o}=await y.from("game_rooms").update({settings:r}).eq("id",e.value.id);if(o)throw o;return e.value&&(e.value.settings=r,console.log("[RoomStore] 房間設置已更新:",r)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",r),{success:!1,error:c.value}}}function H(){e.value=null,u.value=[],c.value=null}function Q(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function l(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!D.value)return{success:!1,error:"只有房主可以踢人"};const r=me();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,c.value=null;const{data:o,error:g}=await y.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(g)throw new Error(g.message);if(o&&!o.success)throw new Error(o.error||"踢出玩家失敗");return await B(e.value.id),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:c.value}}finally{a.value=!1}}async function m(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:t});const{error:r}=await y.from("game_rooms").update({is_final_round:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.is_final_round=t,console.log("[RoomStore] 最後一局標記已更新:",t)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",r),{success:!1,error:c.value}}}return{currentRoom:e,participants:u,loading:a,error:c,isHost:D,createRoom:I,joinRoom:p,leaveRoom:Z,kickPlayer:l,loadParticipants:B,loadRoom:C,updateRoomStatus:R,updateRoomDrawer:O,updateRoomSettings:A,setCurrentDrawer:Q,setFinalRound:m,clearRoom:H}}),Fe=100,Qe=10,Je=10,Xe=10,er=6,rr=100;function tt(){const e=Ge();function u(C){const R=Fe-C*Qe;return Math.max(R,Je)}function a(C,R=0){if(C===0)return 0;const T=C*Xe,O=Math.round(R*er);return T+O}async function c(C,R,T=0){const O=a(R,T);return O===0?!0:await D(C,O)}async function D(C,R){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:T,error:O}=await y.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",C).single();if(O)throw O;const A=(T?.score||0)+R,{error:H}=await y.from("room_participants").update({score:A}).eq("room_id",e.currentRoom.id).eq("user_id",C);if(H)throw H;const Q=e.participants.findIndex(l=>l.user_id===C);return Q!==-1&&e.participants[Q]&&(e.participants[Q].score=A),!0}catch(T){return console.error("更新玩家分數錯誤:",T),!1}}function I(){if(!e.participants||e.participants.length===0)return null;const C=[...e.participants].sort((R,T)=>T.score-R.score);return C.length===1||C[0]&&C[1]&&C[0].score>C[1].score?{user_id:C[0]?.user_id||"",score:C[0]?.score||0}:{user_id:C[0]?.user_id||"",score:C[0]?.score||0}}const p=E(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((R,T)=>T.score!==R.score?T.score-R.score:new Date(R.joined_at).getTime()-new Date(T.joined_at).getTime()).map((R,T)=>({id:R.id,user_id:R.user_id,score:R.score,rank:T+1}))),Z=E(()=>e.currentRoom?.status!=="finished"?null:I());function B(){return rr}return{GUESS_BASE_SCORE:Fe,GUESS_DECREMENT:Qe,GUESS_MIN_SCORE:Je,DRAWING_SCORE_PER_GUESS:Xe,RATING_BONUS_PER_STAR:er,WINNER_BONUS:rr,calculateGuessScore:u,calculateDrawingScore:a,calculateWinner:I,updatePlayerScore:D,updateDrawerScore:c,playerRankings:p,winner:Z,getWinnerBonus:B}}const Be=We("game",()=>{const e=Ge(),u=me(),a=W(null),c=W(null),D=W(0),I=W([]),p=E(()=>I.value.filter(f=>f.is_correct)),Z=E(()=>a.value?I.value.filter(f=>f.round_id===a.value.id):[]),B=E(()=>Z.value.filter(f=>f.is_correct)),C=W("drawing"),R=W([]),T=W(!1),O=W([]),A=W([]),H=E(()=>R.value.length===0?0:R.value.reduce((w,d)=>w+d.rating,0)/R.value.length);function Q(f){C.value=f}function l(f){const w=R.value.findIndex(d=>d.rater_id===f.rater_id);w>=0?R.value[w]=f:R.value.push(f)}function m(){R.value=[]}function t(){if(T.value||!c.value)return null;const f=c.value,w=f.length,d=[];for(let X=0;X<w;X++)O.value.includes(X)||d.push(X);if(d.length===0)return null;const k=Math.floor(Math.random()*d.length),V=d[k];if(V===void 0)return null;const J=f[V];return J?(O.value.push(V),A.value.push(J),T.value=!0,{index:V,char:J}):null}function r(f,w,d=[]){T.value=f,O.value=w,A.value=d}function o(f){D.value=f}function g(){T.value=!1,O.value=[],A.value=[]}async function M(f,w=!1){try{const{data:d,error:k}=await y.from("game_rounds").select("*").eq("room_id",f).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(k)throw k;return d&&(a.value=d,d.word_text&&(D.value=d.word_text.length,console.log("[loadCurrentRound] 設置 wordLength:",D.value)),w||u.user&&d.drawer_id===u.user.id?c.value=d.word_text:c.value=null,d.hint_given!==void 0&&(T.value=d.hint_given),d.revealed_indices&&Array.isArray(d.revealed_indices)&&(O.value=d.revealed_indices),d.revealed_chars&&Array.isArray(d.revealed_chars)&&(A.value=d.revealed_chars,console.log("[loadCurrentRound] 恢復 revealedChars:",A.value)),await N(d.id)),{success:!0,round:d}}catch(d){return console.error("載入當前輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"載入輪次失敗"}}}async function N(f){try{const{data:w,error:d}=await y.from("guesses").select("*").eq("round_id",f).order("guessed_at",{ascending:!0});if(d)throw d;const k=w||[],V=new Set(I.value.map(X=>X.id)),J=k.filter(X=>!V.has(X.id));J.length>0&&(I.value=[...I.value,...J])}catch(w){console.error("載入猜測記錄錯誤:",w)}}async function v(f){try{const{data:w,error:d}=await y.from("game_rounds").select("id").eq("room_id",f);if(d)throw d;if(!w||w.length===0){I.value=[];return}const k=w.map(X=>X.id),{data:V,error:J}=await y.from("guesses").select("*").in("round_id",k).order("guessed_at",{ascending:!0});if(J)throw J;I.value=V||[]}catch(w){console.error("載入所有猜測記錄錯誤:",w)}}async function L(f,w,d,k){try{if(!e.currentRoom)throw new Error("沒有當前房間");const V=(e.currentRoom.current_round||0)+1,{data:J,error:X}=await y.from("game_rounds").insert({room_id:f,round_number:V,drawer_id:w,word_text:d,word_source:k}).select().single();if(X)throw X;return a.value=J,c.value=d,await y.from("game_rooms").update({current_round:V,current_drawer_id:w}).eq("id",f),{success:!0,round:J}}catch(V){return console.error("創建輪次錯誤:",V),{success:!1,error:V instanceof Error?V.message:"創建輪次失敗"}}}function oe(f){return a.value?I.value.some(w=>w.round_id===a.value.id&&w.user_id===f&&w.is_correct):!1}const $=E(()=>!a.value||!u.user?!1:a.value.drawer_id===u.user.id);async function s(){if(!a.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const f=p.value.length,w=H.value,{updateDrawerScore:d}=tt();console.log("[endRound] 猜中人數:",f,"平均評分:",w),await d(a.value.drawer_id,f,w);const{error:k}=await y.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(k)throw k;return{success:!0}}catch(f){return console.error("結束輪次錯誤:",f),{success:!1,error:f instanceof Error?f.message:"結束輪次失敗"}}}function i(){a.value=null,c.value=null,D.value=0,I.value=[],C.value="drawing",R.value=[],T.value=!1,O.value=[],A.value=[]}async function _(f,w,d){if(!u.user)return{success:!1,error:"用戶未登錄"};try{const{data:k,error:V}=await y.from("drawing_ratings").upsert({round_id:f,rater_id:u.user.id,drawer_id:w,rating:d},{onConflict:"round_id,rater_id"}).select().single();if(V)throw V;return k&&l(k),{success:!0,rating:k}}catch(k){return console.error("提交評分錯誤:",k),{success:!1,error:k instanceof Error?k.message:"提交評分失敗"}}}async function q(f){try{const{data:w,error:d}=await y.from("drawing_ratings").select("*").eq("round_id",f);if(d)throw d;return R.value=w||[],{success:!0,ratings:w}}catch(w){return console.error("載入評分錯誤:",w),{success:!1,error:w instanceof Error?w.message:"載入評分失敗"}}}return{currentRound:a,currentWord:c,currentWordLength:D,guesses:I,correctGuesses:p,currentRoundGuesses:Z,currentRoundCorrectGuesses:B,isCurrentDrawer:$,roundStatus:C,ratings:R,averageRating:H,hintGiven:T,revealedIndices:O,revealedChars:A,loadCurrentRound:M,loadGuesses:N,loadAllGuesses:v,createRound:L,hasGuessed:oe,endRound:s,clearGame:i,setRoundStatus:Q,addRating:l,clearRatings:m,submitRating:_,loadRatings:q,giveHint:t,setHintState:r,setWordLength:o,resetHint:g}});function tr(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function or(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function Ue(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function Lt(e){return e.trim().length===0}function $t(e,u=100){return e.length>u}const Le=We("story",()=>{const e=me(),u=W([]),a=W([]),c=W([]),D=W("setup"),I=W(!1),p=W(null),Z=E(()=>{const s=u.value.filter(i=>i.itemType==="text");return s.length===0?null:s[s.length-1]}),B=E(()=>{if(u.value.length===0)return null;const s=u.value[0];return s&&s.itemType==="text"?s.content:null}),C=E(()=>e.user&&a.value.find(s=>s.userId===e.user.id)||null),R=E(()=>e.user&&c.value.find(s=>s.voterId===e.user.id)||null),T=E(()=>{const s=new Map;for(const i of a.value)s.set(i.id,0);for(const i of c.value){const _=s.get(i.submissionId)||0;s.set(i.submissionId,_+1)}return s}),O=E(()=>{if(a.value.length===0)return null;let s=-1,i=[];for(const _ of a.value){const q=T.value.get(_.id)||0;q>s?(s=q,i=[_]):q===s&&i.push(_)}return i.length>0?i[0]:null});async function A(s){try{I.value=!0,p.value=null;const{data:i,error:_}=await y.from("story_chains").select("*").eq("room_id",s).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(_)throw new Error(_.message);return u.value=(i||[]).map(q=>tr(q)),console.log("[StoryStore] 故事鏈已載入:",u.value.length,"項"),{success:!0,data:u.value}}catch(i){return p.value=i instanceof Error?i.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",i),{success:!1,error:p.value}}finally{I.value=!1}}async function H(s){try{I.value=!0,p.value=null;const i={room_id:s.roomId,round_number:s.roundNumber,item_type:s.itemType,content:s.content,author_id:s.authorId,author_name:s.authorName},{data:_,error:q}=await y.from("story_chains").insert(i).select().single();if(q)throw new Error(q.message);const f=tr(_);return u.value.push(f),console.log("[StoryStore] 故事鏈項目已添加:",f),{success:!0,data:f}}catch(i){return p.value=i instanceof Error?i.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",i),{success:!1,error:p.value}}finally{I.value=!1}}async function Q(s,i,_,q){return H({roomId:s,roundNumber:0,itemType:"text",content:i,authorId:_,authorName:q})}async function l(s,i,_,q){return H({roomId:s,roundNumber:-1,itemType:"text",content:i,authorId:_,authorName:q})}async function m(s){try{I.value=!0,p.value=null;const{data:i,error:_}=await y.from("story_submissions").select("*").eq("round_id",s).order("created_at",{ascending:!0});if(_)throw new Error(_.message);return a.value=(i||[]).map(q=>or(q)),console.log("[StoryStore] 句子提交已載入:",a.value.length,"項"),{success:!0,data:a.value}}catch(i){return p.value=i instanceof Error?i.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",i),{success:!1,error:p.value}}finally{I.value=!1}}async function t(s,i){if(!e.user)return{success:!1,error:"用戶未登錄"};try{I.value=!0,p.value=null;const _={round_id:s,user_id:e.user.id,sentence:i.trim(),vote_count:0,is_winner:!1},{data:q,error:f}=await y.from("story_submissions").upsert(_,{onConflict:"round_id,user_id"}).select().single();if(f)throw new Error(f.message);const w=or(q),d=a.value.findIndex(k=>k.roundId===s&&k.userId===e.user.id);return d>=0?a.value[d]=w:a.value.push(w),console.log("[StoryStore] 句子已提交:",w),{success:!0,data:w}}catch(_){return p.value=_ instanceof Error?_.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",_),{success:!1,error:p.value}}finally{I.value=!1}}async function r(s){try{const{error:i}=await y.from("story_submissions").update({is_winner:!0}).eq("id",s);if(i)throw new Error(i.message);const _=a.value.find(q=>q.id===s);return _&&(_.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",s),{success:!0}}catch(i){return p.value=i instanceof Error?i.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",i),{success:!1,error:p.value}}}async function o(s){try{I.value=!0,p.value=null;const{data:i,error:_}=await y.from("story_votes").select("*").eq("round_id",s);if(_)throw new Error(_.message);return c.value=(i||[]).map(q=>Ue(q)),console.log("[StoryStore] 投票記錄已載入:",c.value.length,"項"),{success:!0,data:c.value}}catch(i){return p.value=i instanceof Error?i.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",i),{success:!1,error:p.value}}finally{I.value=!1}}async function g(s,i){if(!e.user)return{success:!1,error:"用戶未登錄"};try{I.value=!0,p.value=null;const _={round_id:s,voter_id:e.user.id,submission_id:i},{data:q,error:f}=await y.from("story_votes").upsert(_,{onConflict:"round_id,voter_id"}).select().single();if(f)throw new Error(f.message);const w=Ue(q),d=c.value.findIndex(k=>k.roundId===s&&k.voterId===e.user.id);return d>=0?c.value[d]=w:c.value.push(w),console.log("[StoryStore] 投票已記錄:",w),{success:!0,data:w}}catch(_){return p.value=_ instanceof Error?_.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",_),{success:!1,error:p.value}}finally{I.value=!1}}function M(s){D.value=s,console.log("[StoryStore] 階段已更新:",s)}function N(){a.value=[],c.value=[],console.log("[StoryStore] 輪次數據已清除")}function v(){u.value=[],a.value=[],c.value=[],D.value="setup",p.value=null,console.log("[StoryStore] 所有故事數據已清除")}function L(s){u.value.some(_=>_.id===s.id)||(u.value.push(s),console.log("[StoryStore] 本地添加故事鏈項目:",s))}function oe(s){const i=a.value.findIndex(_=>_.id===s.id);i>=0?a.value[i]=s:a.value.push(s),console.log("[StoryStore] 本地添加句子提交:",s)}function $(s){const i=c.value.findIndex(_=>_.roundId===s.roundId&&_.voterId===s.voterId);i>=0?c.value[i]=s:c.value.push(s),console.log("[StoryStore] 本地添加投票記錄:",s)}return{storyChain:u,submissions:a,votes:c,currentPhase:D,loading:I,error:p,latestSentence:Z,storyOpening:B,mySubmission:C,myVote:R,voteCounts:T,winningSubmission:O,loadStoryChain:A,addStoryChainItem:H,addStoryOpening:Q,addStoryEnding:l,addStoryChainItemLocal:L,loadSubmissions:m,submitSentence:t,markWinningSubmission:r,addSubmissionLocal:oe,loadVotes:o,castVote:g,addVoteLocal:$,setPhase:M,clearRoundData:N,clearAll:v}}),ue=new Map,ce=W("disconnected"),le=new Map,we=new Map,Ie=new Set;function te(...e){}function ee(...e){console.warn("[Realtime]",...e)}function se(){const e=Ge(),u=Be(),a=Le();function c(l){const m=`room:${l}`;if(ue.has(m))return ue.get(m);const t=y.channel(m,{config:{private:!0,presence:{key:"user"},broadcast:{self:!0,replay:{since:Date.now()-600*1e3,limit:20}}}});return ue.set(m,t),t}function D(l,m,t,r,o){l==="SUBSCRIBED"?(ce.value="connected",m.track({user_id:r,...o}).catch(g=>{ee("Presence track 失敗:",g)})):l==="CHANNEL_ERROR"||l==="TIMED_OUT"?(ce.value="disconnected",ee("訂閱失敗:",l)):l==="CLOSED"&&(ce.value="disconnected")}async function I(l,m,t,r){if(!l||!m)throw ee("缺少 roomCode 或 roomId"),new Error("缺少 roomCode 或 roomId");try{await y.realtime.setAuth(),te("Realtime Auth 設置成功")}catch(o){ee("Realtime Auth 設置失敗:",o)}return new Promise((o,g)=>{const M=c(l),N=M.state;if(N==="joined"){ce.value="connected",o(M);return}if(N==="joining"){const v=setInterval(()=>{const L=M.state;L==="joined"?(clearInterval(v),o(M)):(L==="closed"||L==="errored")&&(clearInterval(v),g(new Error(`連接失敗: ${L}`)))},100);setTimeout(()=>{clearInterval(v),M.state!=="joined"&&(ee("subscribeRoom - 連接超時"),g(new Error("連接超時")))},1e4);return}if(Ie.has(l)){ce.value="connecting",M.subscribe(v=>{D(v,M,l,t,r),v==="SUBSCRIBED"?o(M):(v==="CHANNEL_ERROR"||v==="TIMED_OUT")&&g(new Error(`訂閱失敗: ${v}`))});return}p(M,l,m),Ie.add(l),ce.value="connecting",M.subscribe(v=>{D(v,M,l,t,r),v==="SUBSCRIBED"?o(M):(v==="CHANNEL_ERROR"||v==="TIMED_OUT")&&g(new Error(`訂閱失敗: ${v}`))})})}function p(l,m,t){l.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async r=>{te("房間狀態變化:",r.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async r=>{te("參與者變化:",r.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async r=>{if(te("輪次變化:",r.eventType,r.new),e.currentRoom){const o=r.new,g=u.currentRound?.id;g?r.eventType==="INSERT"&&o?.id!==g?(te("輪次變化：新輪次 INSERT",{newId:o?.id,currentId:g}),await u.loadCurrentRound(e.currentRoom.id)):r.eventType:await u.loadCurrentRound(e.currentRoom.id)}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async r=>{const o=r.new;if(o&&u.currentRound&&(await u.loadGuesses(o.round_id),o.is_correct&&e.isHost&&u.roundStatus==="drawing")){const g=u.currentRound.drawer_id,M=e.participants.filter(L=>L.user_id!==g),N=new Set(u.currentRoundCorrectGuesses.map(L=>L.user_id));if(M.length>0&&M.every(L=>N.has(L.user_id))){const{useGame:L}=await He(async()=>{const{useGame:$}=await Promise.resolve().then(()=>at);return{useGame:$}},void 0),{endRound:oe}=L();await oe()}}}).on("postgres_changes",{event:"*",schema:"public",table:"story_votes"},r=>{const o=r.new;if(o&&u.currentRound&&o.round_id===u.currentRound.id){te("收到投票變更:",r.eventType,o);const g=Ue(o);a.addVoteLocal(g)}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"story_submissions"},async r=>{const o=r.new;o&&u.currentRound&&o.round_id===u.currentRound.id&&await a.loadSubmissions(u.currentRound.id)}).on("broadcast",{event:"drawing"},r=>{const o=le.get(m);o&&r.payload?.stroke&&(te("分發給",o.size,"個回調"),o.forEach(g=>g(r.payload.stroke)))}).on("broadcast",{event:"game_state"},r=>{r?.meta?.replayed;const o=r.payload;o?.type==="round_update"&&(te("處理數據庫廣播的輪次更新:",{wordLength:o.wordLength,drawerId:o.drawerId,hintGiven:o.hintGiven}),o.wordLength>0&&u.setWordLength(o.wordLength),o.hintGiven!==void 0&&u.setHintState(o.hintGiven,o.revealedIndices||[],o.revealedChars||[]));const g=we.get(m);g&&o&&(te("分發給",g.size,"個遊戲狀態回調"),g.forEach(M=>M(o)))}).on("presence",{event:"sync"},()=>{const r=l.presenceState();te("Presence 同步，在線:",Object.keys(r).length)})}function Z(l,m){return le.has(l)||le.set(l,new Set),le.get(l).add(m),()=>{le.get(l)?.delete(m)}}function B(l,m){const t=c(l),r=`guesses:${m}`;return t[r]||(t.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${m}`},async o=>{te("收到新猜測記錄:",o.eventType,o.new),await u.loadGuesses(m)}),t[r]=!0),t}function C(l,m){return we.has(l)||we.set(l,new Set),we.get(l).add(m),()=>{we.get(l)?.delete(m)}}async function R(l,m){const t=c(l),r=t.state;if(r!=="joined")return ee("Channel 未連接，狀態:",r,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{te("廣播遊戲狀態:",m);const o=await t.send({type:"broadcast",event:"game_state",payload:m});return o==="error"?(ee("發送遊戲狀態失敗"),{error:"發送失敗"}):o}catch(o){return ee("發送遊戲狀態錯誤:",o),{error:o instanceof Error?o.message:"發送失敗"}}}async function T(l,m){const t=c(l),r=t.state;if(r!=="joined")return ee("Channel 未連接，無法發送繪畫數據，狀態:",r),{error:"Channel 未連接"};try{const o=await t.send({type:"broadcast",event:"drawing",payload:{stroke:m}});return o==="error"?(ee("發送失敗"),{error:"發送失敗"}):o}catch(o){return ee("發送錯誤:",o),{error:o instanceof Error?o.message:"發送失敗"}}}function O(l){const m=`room:${l}`,t=ue.get(m);t&&(y.removeChannel(t),ue.delete(m)),le.delete(l),we.delete(l),Ie.delete(l)}async function A(l,m,t,r){const o=`room:${l}`,g=ue.get(o);if(!g){try{await I(l,m,t,r)}catch(N){ee("連接恢復：重新訂閱失敗:",N)}return}const M=g.state;if(M==="joined"){ce.value="connected";return}if(M!=="joining"&&(M==="errored"||M==="closed")){try{y.removeChannel(g)}catch(N){ee("移除異常 Channel 失敗:",N)}ue.delete(o),Ie.delete(l);try{await I(l,m,t,r)}catch(N){ee("連接恢復：重新訂閱失敗:",N)}}}function H(){ue.forEach(l=>y.removeChannel(l)),ue.clear(),le.clear(),Ie.clear()}function Q(){return ce.value}return{connectionStatus:ce,subscribeRoom:I,subscribeDrawing:Z,subscribeGuesses:B,subscribeGameState:C,sendDrawing:T,broadcastGameState:R,unsubscribeRoom:O,unsubscribeAll:H,getConnectionStatus:Q,checkAndRestoreConnection:A}}function ot(){const e=Ge(),u=Be(),a=Le(),{unsubscribeRoom:c}=se(),D=E(()=>e.currentRoom),I=E(()=>e.participants),p=E(()=>e.isHost),Z=E(()=>D.value&&D.value.game_mode==="storyboard"?3:2),B=E(()=>!D.value||D.value.status!=="waiting"||!p.value?!1:I.value.length>=Z.value);function C(){const A=e.currentRoom;A&&(console.log("[useRoom] 清理舊房間狀態:",A.code),c(A.code)),u.clearGame(),a.clearAll(),e.clearRoom()}async function R(A){return C(),await e.createRoom(A)}async function T(A,H){return C(),await e.joinRoom(A,H)}async function O(){return await e.leaveRoom()}return{currentRoom:D,participants:I,isHost:p,canStartGame:B,minPlayersRequired:Z,loading:E(()=>e.loading),error:E(()=>e.error),createRoom:R,joinRoom:T,leaveRoom:O}}const nt=6,nr=60,sr=60,ar=60,st=6,ur=10,cr=10,ir=10,ke=6,he=W(null),Oe=W(!1);let _e=null;const de=W(null);let pe=null;const Me=W(new Set),lr=W("setup"),ye=W(null);let Se=null;function mr(){const e=Ge(),u=Be(),a=Le();se();const c=he,D=Oe,I=de,p=E(()=>e.currentRoom?.status||"waiting"),Z=E(()=>p.value==="playing"),B=E(()=>p.value==="waiting"),C=E(()=>p.value==="finished"),R=E(()=>u.roundStatus),T=E(()=>R.value==="drawing"),O=E(()=>R.value==="summary"),A=E(()=>e.currentRoom?.game_mode==="storyboard"),H=lr,Q=ye,l=E(()=>A.value&&H.value==="drawing"),m=E(()=>A.value&&H.value==="writing"),t=E(()=>A.value&&H.value==="voting"),r=E(()=>A.value&&H.value==="summary"),o=E(()=>A.value&&H.value==="setup"),g=E(()=>A.value&&H.value==="ending"),M=E(()=>u.currentRound),N=E(()=>e.currentRoom?.current_round||0),v=E(()=>e.currentRoom?.settings.rounds||0),L=E(()=>e.currentRoom?.settings.draw_time||60),oe=E(()=>u.isCurrentDrawer);function $(n){console.log("[useGame] startCountdown 開始，時長:",n,"秒"),_e&&clearInterval(_e),he.value=n,Oe.value=!0,_e=window.setInterval(()=>{he.value!==null&&he.value>0?he.value--:(s(),Z.value&&M.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),V()))},1e3)}function s(){_e&&(clearInterval(_e),_e=null),Oe.value=!1}function i(){s(),he.value=null}function _(n){console.log("[useGame] startSummaryCountdown 開始"),pe&&clearInterval(pe);const h=n??nt;de.value=h,console.log("[useGame] 開始總結倒計時:",h,"秒"),pe=window.setInterval(async()=>{de.value!==null&&de.value>0?(de.value--,console.log("[useGame] 總結倒計時:",de.value)):(q(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await J()))},1e3)}function q(){console.log("[useGame] stopSummaryCountdown"),pe&&(clearInterval(pe),pe=null),de.value=null}function f(){if(!e.currentRoom)return null;const n=e.currentRoom.words;if(n.length===0)return null;const h=[];for(let G=0;G<n.length;G++)Me.value.has(G)||h.push(G);let b=0;if(h.length>0){const G=Math.floor(Math.random()*h.length);b=h[G]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),Me.value.clear(),b=Math.floor(Math.random()*n.length);return Me.value.add(b),n[b]??null}async function w(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{Me.value.clear();const n=e.participants.length,h=await e.updateRoomSettings({rounds:n});if(!h.success)return h;console.log("[useGame] 輪數已自動設定為房間人數:",n);const b=await e.updateRoomStatus("playing");if(!b.success)return b;if(A.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),ie("setup"),a.clearAll();const{broadcastGameState:S}=se();return await S(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await d()}catch(n){return console.error("開始遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"開始遊戲失敗"}}}async function d(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const h=(e.currentRoom.current_round||0)+1;try{const b=(h-1)%e.participants.length,G=e.participants[b];if(console.log("[startDrawingPhase] 第",h,"輪，畫家:",G?.nickname),!G)throw new Error("無法選擇畫家");let S=null;if(A.value){const U=a.latestSentence;U?(S={text:U.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",S.text)):(S={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(S=f(),!S)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",S.text)}await e.updateRoomDrawer(G.user_id),u.setRoundStatus("drawing");const P=await u.createRound(e.currentRoom.id,G.user_id,S.text,S.source);if(!P.success||!P.round)throw new Error("創建輪次失敗");const{broadcastGameState:z}=se();return A.value?await z(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:G.user_id,drawerName:G.nickname,roundNumber:h,startedAt:P.round.started_at,clearCanvas:!0}):await z(e.currentRoom.code,{roundStatus:"drawing",wordLength:S.text.length,drawerId:G.user_id,drawerName:G.nickname,roundNumber:h,startedAt:P.round.started_at,clearCanvas:!0}),{success:!0,drawerId:G.user_id,word:S.text}}catch(b){return console.error("開始繪畫階段錯誤:",b),{success:!1,error:b instanceof Error?b.message:"開始繪畫階段失敗"}}}async function k(){return await d()}async function V(){if(!M.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const n=await u.endRound();if(!n.success)return n;const h=!1,{broadcastGameState:b}=se();return await b(e.currentRoom.code,{roundStatus:"summary",drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:h,startedAt:new Date().toISOString()}),{success:!0,gameEnded:h}}catch(n){return console.error("結束輪次錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束輪次失敗"}}}async function J(){return e.currentRoom?e.isHost?(await d(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function X(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return s(),await e.updateRoomStatus("finished"),{success:!0}}catch(n){return console.error("結束遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束遊戲失敗"}}}async function fr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(R.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),q(),await d()}catch(n){return console.error("下一局錯誤:",n),{success:!1,error:n instanceof Error?n.message:"下一局失敗"}}}const gr=E(()=>{if(c.value===null)return"--:--";const n=Math.floor(c.value/60),h=c.value%60;return`${n.toString().padStart(2,"0")}:${h.toString().padStart(2,"0")}`});function ie(n){console.log("[useGame] 設置分鏡模式階段:",n),lr.value=n,a.setPhase(n)}function vr(n,h){console.log("[useGame] 開始分鏡模式倒計時:",n,"秒"),Se&&clearInterval(Se),ye.value=n,Se=window.setInterval(()=>{ye.value!==null&&ye.value>0?ye.value--:(Ce(),h&&h())},1e3)}function Ce(){Se&&(clearInterval(Se),Se=null)}function wr(){Ce(),ye.value=null}function hr(){if(!e.currentRoom)return null;const n=e.currentRoom.words;if(n.length===0)return null;const b=e.currentRoom.used_word_indexes||[],G=new Set(b),S=[];for(let j=0;j<n.length;j++)G.has(j)||S.push(j);let P,z;if(S.length>0){const j=Math.floor(Math.random()*S.length);P=S[j]??0,z=[...b,P]}else console.log("[useGame] 分鏡模式：所有詞語都用過了，重置並重新選擇"),P=Math.floor(Math.random()*n.length),z=[P];const U=n[P];return U?(console.log("[useGame] 分鏡模式抽取詞句:",U.text,"索引:",P),{promptText:U.text,newUsedIndexes:z}):null}async function _r(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),ie("drawing"),a.clearRoundData();const n=new Date().toISOString(),b=e.currentRoom.settings?.storyboard_writing_mode==="wordlist";let G=null,S={storyboard_phase:"drawing",updated_at:n};if(b){const U=hr();U?(G=U.promptText,S.storyboard_writing_prompt_text=G,S.used_word_indexes=U.newUsedIndexes,console.log("[useGame] 依詞句庫編劇模式：本輪詞句 =",G)):console.warn("[useGame] 依詞句庫編劇模式：無法抽取詞句（詞句庫可能為空）")}else S.storyboard_writing_prompt_text=null;const{error:P}=await y.from("game_rooms").update(S).eq("id",e.currentRoom.id);if(P)console.error("[useGame] 更新數據庫失敗:",P);else if(G!==null){const U=e.currentRoom;U.storyboard_writing_prompt_text=G,U.used_word_indexes=S.used_word_indexes}const{broadcastGameState:z}=se();return await z(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:n,clearCanvas:!0,...G&&{storyboardWritingPromptText:G}}),{success:!0,promptText:G}}async function pr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const n=new Date().toISOString(),{error:h}=await y.from("game_rooms").update({storyboard_phase:"writing",updated_at:n}).eq("id",e.currentRoom.id);h&&console.error("[useGame] 更新數據庫失敗:",h),ie("writing");const{broadcastGameState:b}=se();return await b(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:n}),{success:!0}}async function yr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const n=new Date().toISOString(),{error:h}=await y.from("game_rooms").update({storyboard_phase:"voting",updated_at:n}).eq("id",e.currentRoom.id);h&&console.error("[useGame] 更新數據庫失敗:",h),ie("voting");const{broadcastGameState:b}=se();return await b(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:n}),{success:!0}}async function Sr(n){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const h=new Date().toISOString(),{error:b}=await y.from("game_rooms").update({storyboard_phase:"summary",updated_at:h}).eq("id",e.currentRoom.id);b&&console.error("[useGame] 更新數據庫失敗:",b),ie("summary");const{broadcastGameState:G}=se();return await G(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:h,storyboardRoundResult:n?{winningSentence:n.winningSentence||"故事繼續發展中...",winnerName:n.winnerName||"",winnerId:n.winnerId||"",winnerVoteCount:n.winnerVoteCount||0,drawerScore:n.drawerScore||0,screenwriterScore:n.screenwriterScore||0}:void 0}),{success:!0}}async function Rr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:n}=await y.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);n&&console.error("[useGame] 更新數據庫失敗:",n),ie("ending");const{broadcastGameState:h}=se();return await h(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function $e(){const n=a.submissions,h=a.votes;if(n.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const b=new Map;for(const j of n)b.set(j.id,0);for(const j of h){const re=b.get(j.submissionId)||0;b.set(j.submissionId,re+1)}let G=-1,S=[];for(const j of n){const re=b.get(j.id)||0;re>G?(G=re,S=[j]):re===G&&S.push(j)}const P=S.length>1;if(S.length===1)return console.log("[useGame] 唯一最高票勝出:",S[0]?.sentence),{submission:S[0]||null,voteCount:G,hasTie:!1};const z=Math.floor(Math.random()*S.length),U=S[z]||null;return console.log("[useGame] 平票隨機選擇勝出:",U?.sentence,"(共",S.length,"個平票)"),{submission:U,voteCount:G,hasTie:P}}async function br(n){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!u.currentRound)return{success:!1,error:"沒有當前輪次"};const h=u.currentRound.round_number,b=u.currentRound.drawer_id,S=e.participants.find(P=>P.user_id===b)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",h);try{const P=u.currentRound.id;console.log("[useGame] 載入最新的提交和投票數據，輪次 ID:",P),await a.loadSubmissions(P),await a.loadVotes(P),console.log("[useGame] 數據載入完成 - 提交:",a.submissions.length,"投票:",a.votes.length);const{submission:z,voteCount:U,hasTie:j}=$e();let re,fe,ge;z?(re=z.sentence,fe=z.userId,ge=e.participants.find(ve=>ve.user_id===fe)?.nickname||"編劇",await a.markWinningSubmission(z.id),console.log("[useGame] 勝出句子:",re,"作者:",ge,"票數:",U,"平票:",j)):(re="故事繼續發展中...",fe=b,ge=S,console.log("[useGame] 沒有提交，使用默認句子"));let xe="/placeholder-image.png";if(n)try{const Ee=await new Promise(ve=>{n.toBlob(ve,"image/png",.9)});if(Ee){const{supabase:ve}=await He(async()=>{const{supabase:qe}=await import("./index-BYgLtfVD.js").then(Tr=>Tr.Q);return{supabase:qe}},__vite__mapDeps([0,1])),xr=Date.now(),je=`storyboard/${e.currentRoom.id}/round_${h}_${xr}.png`,{error:ze}=await ve.storage.from("canvas-snapshots").upload(je,Ee,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(ze)console.error("[useGame] 截圖上傳失敗:",ze);else{const{data:qe}=ve.storage.from("canvas-snapshots").getPublicUrl(je);xe=qe.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",xe)}}}catch(Ee){console.error("[useGame] 截圖上傳錯誤:",Ee)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:h,itemType:"image",content:xe,authorId:b,authorName:S}),await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:h,itemType:"text",content:re,authorId:fe,authorName:ge}),console.log("[useGame] Story_Chain 已更新");let Te=0;z&&U>0&&(Te=Pe(U),await be(fe,Te),console.log("[useGame] 編劇得分:",Te,"分給",ge,"(得票數:",U,")"));const Ze=u.averageRating||0,Ne=De(Ze);await be(b,Ne),console.log("[useGame] 畫家得分:",Ne,"分給",S,"(平均評星:",Ze,")");const Ve={success:!0,winningSentence:re,winnerName:ge,winnerId:fe,winnerVoteCount:U,drawerScore:Ne,screenwriterScore:Te,imageUrl:xe};return console.log("[useGame] 輪次結算完成:",Ve),Ve}catch(P){return console.error("[useGame] 輪次結算錯誤:",P),{success:!1,error:P instanceof Error?P.message:"輪次結算失敗"}}}function Er(){const n=document.querySelector("canvas.drawing-canvas");return n||document.querySelector("canvas")||null}function Ir(n){switch(n){case"drawing":return nr;case"writing":return sr;case"voting":return ar;default:return 0}}function Pe(n){return n===0?0:ur+n*cr}function De(n=0){const h=Math.round(n*ke);return ir+h}function Gr(n){return Math.round(n*ke)}async function Cr(n,h,b,G=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{if(b>0){const P=Pe(b);console.log("[useGame] 編劇得分:",P,"分給",n,"(得票數:",b,")"),await be(n,P)}const S=De(G);return console.log("[useGame] 畫家得分:",S,"分給",h,"(平均評星:",G,")"),await be(h,S),{success:!0}}catch(S){return console.error("[useGame] 計算分鏡模式得分錯誤:",S),{success:!1,error:S instanceof Error?S.message:"計算得分失敗"}}}async function be(n,h){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:b}=await He(async()=>{const{supabase:j}=await import("./index-BYgLtfVD.js").then(re=>re.Q);return{supabase:j}},__vite__mapDeps([0,1])),{data:G,error:S}=await b.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",n).single();if(S)throw S;const P=(G?.score||0)+h,{error:z}=await b.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",n);if(z)throw z;const U=e.participants.findIndex(j=>j.user_id===n);return U!==-1&&e.participants[U]&&(e.participants[U].score=P),console.log("[useGame] 玩家",n,"得分更新為",P),!0}catch(b){return console.error("[useGame] 更新玩家分數錯誤:",b),!1}}return Pr(()=>{s(),q(),Ce()}),{gameStatus:p,isPlaying:Z,isWaiting:B,isFinished:C,currentRound:M,currentRoundNumber:N,totalRounds:v,drawTime:L,isCurrentDrawer:oe,timeRemaining:c,isCountingDown:D,formattedTime:gr,roundStatus:R,isDrawing:T,isSummary:O,summaryTimeRemaining:I,isStoryboardMode:A,storyboardPhase:H,storyboardTimeRemaining:Q,isStoryboardDrawing:l,isStoryboardWriting:m,isStoryboardVoting:t,isStoryboardSummary:r,isStoryboardSetup:o,isStoryboardEnding:g,startGame:w,newGame:fr,startNextRound:k,startDrawingPhase:d,endRound:V,continueToNextRound:J,endGame:X,startCountdown:$,stopCountdown:s,startSummaryCountdown:_,stopSummaryCountdown:q,resetCountdown:i,setStoryboardPhase:ie,startStoryboardCountdown:vr,stopStoryboardCountdown:Ce,resetStoryboardCountdown:wr,enterStoryboardDrawingPhase:_r,enterStoryboardWritingPhase:pr,enterStoryboardVotingPhase:yr,enterStoryboardSummaryPhase:Sr,enterStoryboardEndingPhase:Rr,getStoryboardPhaseDuration:Ir,calculateWinningSentence:$e,finalizeStoryboardRound:br,getCanvasElement:Er,calculateScreenwriterScore:Pe,calculateDirectorScore:De,calculateRatingBonus:Gr,calculateStoryboardRoundScores:Cr,updateStoryboardPlayerScore:be,STORYBOARD_DRAWING_TIME:nr,STORYBOARD_WRITING_TIME:sr,STORYBOARD_VOTING_TIME:ar,STORYBOARD_SUMMARY_TIME:st,SCREENWRITER_BASE_SCORE:ur,SCREENWRITER_VOTE_BONUS:cr,DIRECTOR_BASE_SCORE:ir,RATING_BONUS_MULTIPLIER:ke}}const at=Object.freeze(Object.defineProperty({__proto__:null,useGame:mr},Symbol.toStringTag,{value:"Module"})),ut={class:"waiting-lobby"},ct={class:"card"},it={class:"card-body"},lt={class:"room-info text-center margin-bottom-medium"},dt={class:"card-title text-hand-title"},mt={class:"room-details"},ft={class:"detail-item margin-bottom-small"},gt={class:"badge badge-secondary room-code-badge"},vt={class:"detail-row"},wt={class:"detail-item"},ht={class:"badge"},_t={class:"detail-item"},pt={class:"players-section margin-bottom-medium"},yt={class:"text-hand-title margin-bottom-small"},St={class:"players-list"},Rt={class:"player-avatar"},bt={class:"player-info"},Et={class:"player-name"},It={key:0,class:"badge badge-warning"},Gt={class:"room-settings margin-bottom-medium"},Ct={class:"setting-item"},xt={class:"setting-value"},Tt={class:"setting-item"},At={class:"setting-label"},Mt={class:"setting-value"},Pt={key:0,class:"setting-item"},Dt={class:"setting-value"},Nt={class:"lobby-actions"},qt=["disabled"],kt={key:1,class:"alert alert-warning text-center"},Ot=["disabled"],Ht={key:0,class:"alert alert-danger margin-top-small"},Ut=dr({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:u}){const a=e,c=u,{isHost:D,canStartGame:I,minPlayersRequired:p,leaveRoom:Z,loading:B,error:C}=ot(),{startGame:R}=mr(),T=E(()=>{const m=a.room?.settings.rounds||0,t=a.participants.length,r=m>0?m:t;return r>0?r:1});function O(m){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[m||""]||m||"未知"}function A(m){return{classic:"傳統模式",storyboard:"分鏡接龍"}[m||""]||"傳統模式"}function H(m){return a.room?.host_id===m}async function Q(){(await R()).success&&c("startGame")}async function l(){(await Z()).success&&c("leaveRoom")}return(m,t)=>(F(),K("div",ut,[x("div",ct,[x("div",it,[x("div",lt,[x("h2",dt,Y(e.room?.name),1),x("div",mt,[x("div",ft,[t[0]||(t[0]=ae(" 房間碼：",-1)),x("span",gt,Y(e.room?.code),1)]),x("div",vt,[x("div",wt,[t[1]||(t[1]=ae(" 狀態：",-1)),x("span",ht,Y(O(e.room?.status)),1)]),x("div",_t,[t[2]||(t[2]=ae(" 模式：",-1)),x("span",{class:Ye(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},Y(A(e.room?.game_mode)),3)])])])]),x("div",pt,[x("h4",yt,"玩家列表 ("+Y(e.participants.length)+")",1),x("div",St,[(F(!0),K(Ke,null,Dr(e.participants,r=>(F(),K("div",{key:r.id,class:Ye(["player-item",{"is-host":H(r.user_id)}])},[x("div",Rt,Y(r.nickname.charAt(0).toUpperCase()),1),x("div",bt,[x("div",Et,[ae(Y(r.nickname)+" ",1),H(r.user_id)?(F(),K("span",It," 房主 ")):Re("",!0)])])],2))),128))])]),x("div",Gt,[x("div",Ct,[t[4]||(t[4]=x("span",{class:"setting-label"},"繪畫時間：",-1)),x("span",xt,[x("strong",null,Y(e.room?.settings.draw_time),1),t[3]||(t[3]=ae("秒",-1))])]),x("div",Tt,[x("span",At,Y(e.room?.game_mode==="storyboard"?"每場鏡數":"每局輪數")+"：",1),x("span",Mt,[x("strong",null,Y(T.value),1),ae(Y(e.room?.game_mode==="storyboard"?"鏡":"輪"),1)])]),e.room?.game_mode!=="storyboard"?(F(),K("div",Pt,[t[6]||(t[6]=x("span",{class:"setting-label"},"詞語總數：",-1)),x("span",Dt,[x("strong",null,Y(e.room?.word_count),1),t[5]||(t[5]=ae("個",-1))])])):Re("",!0)]),x("div",Nt,[ne(D)&&ne(I)?(F(),K("button",{key:0,disabled:ne(B),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:Q},Y(ne(B)?"開始中":"開始遊戲"),9,qt)):ne(D)?(F(),K("div",kt,[ae(" 至少需要 "+Y(ne(p))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(F(),K(Ke,{key:0},[ae(" （分鏡接龍模式） ")],64)):Re("",!0)])):Re("",!0),x("button",{disabled:ne(B),class:"paper-btn btn-secondary btn-block",onClick:l},Y(ne(B)?"離開中":"離開房間"),9,Ot)]),ne(C)?(F(),K("div",Ht,Y(ne(C)),1)):Re("",!0)])])]))}}),Zt=Nr(Ut,[["__scopeId","data-v-ec12b121"]]);export{Bt as I,Zt as W,se as a,Ge as b,Le as c,Be as d,tt as e,Lt as f,mr as g,$t as i,ot as u};
