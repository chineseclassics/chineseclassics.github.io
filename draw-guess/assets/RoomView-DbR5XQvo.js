import{l as pe,r as S,u as O,d as J,i as re,m as ie,c as v,e,o as h,_ as Y,f as M,n as x,a as G,F as A,p as H,q as Q,t as D,b as i,s as U,x as _e,h as we,y as ye,j as N,g as be,v as Fe,z as Ce,A as Re,k as ke,B as De}from"./index-D55TnuIM.js";import{c as X,b as Z,d as ee,e as ae,a as Se,u as We,W as $e}from"./useRealtime-B7axQE-R.js";const le=pe("drawing",()=>{const t=S("pen"),o=S("#000000"),a=S(3),c=S(!1),s=S([]);function r(d){t.value=d}function u(d){o.value=d}function _(d){a.value=Math.max(1,Math.min(20,d))}function F(d){s.value.push(d)}function R(){s.value=[]}function k(d){c.value=d}return{tool:t,color:o,lineWidth:a,isDrawing:c,strokes:s,setTool:r,setColor:u,setLineWidth:_,addStroke:F,clearStrokes:R,setDrawing:k}});function oe(t,o){const a=t.getBoundingClientRect();let c,s;if(o instanceof MouseEvent)c=o.clientX,s=o.clientY;else if(o instanceof TouchEvent&&o.touches.length>0&&o.touches[0])c=o.touches[0].clientX,s=o.touches[0].clientY;else return null;return{x:c-a.left,y:s-a.top}}function ce(t,o){if(!(o.points.length<2)){t.save(),o.tool==="pen"?(t.strokeStyle=o.color,t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round"):o.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),o.points[0]&&t.moveTo(o.points[0].x,o.points[0].y);for(let a=1;a<o.points.length;a++){const c=o.points[a];c&&t.lineTo(c.x,c.y)}t.stroke(),t.restore()}}function K(t,o){const a=t.getContext("2d");if(!a)return;const c=t.getBoundingClientRect();a.clearRect(0,0,t.width,t.height),a.fillStyle="#FFFFFF",a.fillRect(0,0,c.width,c.height),o.forEach(s=>{ce(a,s)})}function Te(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ue(){const t=le(),o=X(),a=O(),{sendDrawing:c}=Z(),s=S(null),r=S(null),u=S(null),_=S(null);let F=null;const R=50;function k(n){s.value=n;const w=n.getContext("2d",{willReadFrequently:!0});if(!w){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}r.value=w;const y=window.devicePixelRatio||1,I=n.getBoundingClientRect();n.width=I.width*y,n.height=I.height*y,w.scale(y,y),w.fillStyle="#FFFFFF",w.fillRect(0,0,I.width,I.height),s.value&&K(s.value,t.strokes),new ResizeObserver(()=>{if(!s.value||!r.value)return;const P=s.value.getBoundingClientRect(),B=window.devicePixelRatio||1;s.value.width=P.width*B,s.value.height=P.height*B,r.value.scale(B,B),r.value.fillStyle="#FFFFFF",r.value.fillRect(0,0,P.width,P.height),K(s.value,t.strokes)}).observe(n)}function d(n){if(!s.value)return;n.preventDefault(),t.setDrawing(!0);const w=oe(s.value,n);w&&(u.value={id:Te(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[w],timestamp:Date.now()},_.value=w)}function g(n){if(!s.value||!r.value||!t.isDrawing||!u.value)return;n.preventDefault();const w=oe(s.value,n);if(!w||!_.value)return;const y=r.value;y.save(),u.value.tool==="pen"?(y.strokeStyle=u.value.color,y.lineWidth=u.value.lineWidth,y.lineCap="round",y.lineJoin="round"):u.value.tool==="eraser"&&(y.globalCompositeOperation="destination-out",y.lineWidth=u.value.lineWidth,y.lineCap="round",y.lineJoin="round"),y.beginPath(),y.moveTo(_.value.x,_.value.y),y.lineTo(w.x,w.y),y.stroke(),y.restore(),u.value.points.push(w),_.value=w,F===null&&(F=window.setTimeout(()=>{m(),F=null},R))}function l(){!t.isDrawing||!u.value||(t.setDrawing(!1),F&&(clearTimeout(F),F=null),m(),u.value=null,_.value=null)}async function m(){if(!(!u.value||!o.currentRoom||!a.user))try{const n={...u.value,userId:a.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",n.id),await c(o.currentRoom.code,n)}catch(n){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",n)}}function p(n){if(!(!s.value||!r.value)){if(n.userId&&a.user&&n.userId===a.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",n.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",n.id),t.addStroke(n),ce(r.value,n)}}function f(){if(!s.value||!r.value)return;const n=r.value,w=s.value;n.clearRect(0,0,w.width,w.height),n.fillStyle="#FFFFFF",n.fillRect(0,0,w.width,w.height),t.clearStrokes()}function T(n){t.setTool(n)}function E(n){t.setColor(n)}function W(n){t.setLineWidth(n)}function V(){s.value&&K(s.value,t.strokes)}return{canvasRef:s,initCanvas:k,startDrawing:d,draw:g,stopDrawing:l,clearCanvas:f,setTool:T,setColor:E,setLineWidth:W,handleDrawingData:p,redrawStrokes:V}}const xe={class:"drawing-canvas-container"},Me=J({__name:"DrawingCanvas",setup(t){const{initCanvas:o,startDrawing:a,draw:c,stopDrawing:s,handleDrawingData:r}=ue(),u=X(),_=O(),{subscribeDrawing:F}=Z(),R=S(null);function k(W){a(W)}function d(W){c(W)}function g(){s()}function l(){s()}function m(W){a(W)}function p(W){c(W)}function f(){s()}let T=null;function E(){!u.currentRoom||!_.user||(T=F(u.currentRoom.code,W=>{r(W)}))}return re(()=>{R.value&&o(R.value),E()}),ie(()=>{T&&(T(),T=null)}),(W,V)=>(h(),v("div",xe,[e("canvas",{ref_key:"canvasElement",ref:R,class:"drawing-canvas",onMousedown:k,onMousemove:d,onMouseup:g,onMouseleave:l,onTouchstart:m,onTouchmove:p,onTouchend:f},null,544)]))}}),Ge=Y(Me,[["__scopeId","data-v-e71ea6a0"]]),Le={class:"toolbar-section"},Ee={key:0,class:"tool-label"},Ve={key:0,class:"tool-label"},Pe={key:0,class:"toolbar-section colors-section"},Be=["onClick","title"],Ie={class:"toolbar-section size-section"},Ne={class:"size-dots"},Oe=["onClick","title"],ze={class:"toolbar-section"},Ue={key:0,class:"tool-label"},Ae=J({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const o=le(),{setTool:a,setColor:c,setLineWidth:s,clearCanvas:r}=ue(),u=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],_=M(()=>o.tool),F=M(()=>o.color),R=M(()=>o.lineWidth);function k(m){a(m)}function d(m){c(m)}function g(m){o.setLineWidth(m),s(m)}function l(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&r()}return(m,p)=>(h(),v("div",{class:x(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",Le,[e("button",{onClick:p[0]||(p[0]=f=>k("pen")),class:x(["tool-btn",{active:_.value==="pen"}]),title:"ç•«ç­†"},[p[2]||(p[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?G("",!0):(h(),v("span",Ee,"ç•«ç­†"))],2),e("button",{onClick:p[1]||(p[1]=f=>k("eraser")),class:x(["tool-btn",{active:_.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[p[3]||(p[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?G("",!0):(h(),v("span",Ve,"æ©¡çš®æ“¦"))],2)]),_.value==="pen"?(h(),v("div",Pe,[e("div",{class:x(["color-grid",{"color-grid-compact":t.compact}])},[(h(),v(A,null,H(u,f=>e("div",{key:f,onClick:T=>d(f),class:x(["color-cell",{selected:F.value===f}]),style:Q({backgroundColor:f}),title:f},null,14,Be)),64))],2)])):G("",!0),e("div",Ie,[e("div",Ne,[(h(),v(A,null,H([2,5,10,15],f=>e("div",{key:f,onClick:T=>g(f),class:x(["size-dot",{active:R.value===f}]),style:Q({width:`${f+8}px`,height:`${f+8}px`}),title:`${f}px`},null,14,Oe)),64))])]),e("div",ze,[e("button",{onClick:l,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[p[4]||(p[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?G("",!0):(h(),v("span",Ue,"æ¸…ç©º"))])])],2))}}),He=Y(Ae,[["__scopeId","data-v-7e7250c3"]]),Je={class:"player-list"},Ye={class:"player-list-header"},Xe={class:"player-count"},je={class:"player-rank"},qe={class:"player-info"},Ke={class:"player-name"},Qe={key:0,class:"drawer-badge"},Ze={key:1,class:"host-badge"},et={class:"player-score"},tt={key:0,class:"winner-banner"},st={class:"winner-text"},ot={class:"winner-name"},nt={class:"winner-score"},rt=J({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(t){const o=X(),a=ee(),c=O(),{playerRankings:s,winner:r}=ae(),u=M(()=>s.value);function _(d){return o.participants.find(l=>l.user_id===d)?.nickname||"æœªçŸ¥ç©å®¶"}function F(d){return c.user?.id===d}function R(d){return o.currentRoom?.host_id===d}function k(d){return a.currentRound?.drawer_id===d}return(d,g)=>(h(),v("div",Je,[e("div",Ye,[e("span",Xe,"ç©å®¶ ("+D(u.value.length)+")",1)]),(h(!0),v(A,null,H(u.value,(l,m)=>(h(),v("div",{key:l.id,class:x(["player-item",{"is-current":F(l.user_id)},{"is-drawer":k(l.user_id)}])},[e("div",je,D(m+1),1),e("div",{class:x(["player-avatar",{drawing:k(l.user_id)}])},D(_(l.user_id).charAt(0)),3),e("div",qe,[e("div",Ke,[U(D(_(l.user_id))+" ",1),k(l.user_id)?(h(),v("span",Qe,"âœï¸")):G("",!0),R(l.user_id)?(h(),v("span",Ze,"ğŸ‘‘")):G("",!0)]),e("div",et,D(l.score)+" åˆ†",1)])],2))),128)),t.showWinner&&i(r)?(h(),v("div",tt,[g[1]||(g[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",st,[g[0]||(g[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",ot,D(_(i(r).user_id)),1),e("div",nt,D(i(r).score)+" åˆ†",1)])])):G("",!0)]))}}),ne=Y(rt,[["__scopeId","data-v-4094673d"]]);function it(){const t=ee(),o=O(),{calculateGuessScore:a,updatePlayerScore:c}=ae(),s=S(""),r=S(null),u=S(!1),_=M(()=>t.isCurrentDrawer?t.currentWord:null),F=M(()=>t.correctGuesses),R=M(()=>o.user?t.hasGuessed(o.user.id):!1);async function k(){if(!t.currentRound||!o.user)return r.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return r.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return r.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(R.value)return r.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return r.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{u.value=!0,r.value=null;const l=s.value.trim(),m=t.currentWord||"",p=d(l,m),f=p?a(F.value.length):0,{data:T,error:E}=await _e.from("guesses").insert({round_id:t.currentRound.id,user_id:o.user.id,guess_text:l,is_correct:p,score_earned:f}).select().single();if(E)throw E;return t.guesses.push(T),p&&o.user&&await c(o.user.id,f),s.value="",{success:!0,isCorrect:p,guess:T}}catch(l){return r.value=l instanceof Error?l.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",l),{success:!1,error:r.value}}finally{u.value=!1}}function d(l,m){const p=l.trim(),f=m.trim();return p===f}function g(){r.value=null}return{guessInput:s,error:r,loading:u,currentWord:_,correctGuesses:F,hasGuessed:R,submitGuess:k,clearError:g}}const at={class:"game-container"},lt={key:0,class:"container margin-top-large"},ct={class:"row flex-center"},ut={class:"col-12 col-md-8"},dt={key:1,class:"game-layout"},vt={class:"game-sidebar game-players"},ht={class:"player-list-container"},mt={class:"game-main"},ft={key:0,class:"time-display"},gt={class:"round-info"},pt={class:"round-label"},_t={key:1,class:"word-display"},wt={class:"word-text"},yt={key:2,class:"word-display"},bt={class:"word-slots"},Ft={class:"game-content-area"},Ct={class:"game-toolbar"},Rt={class:"game-canvas"},kt={key:0,class:"time-progress"},Dt={class:"game-chat-panel"},St={key:0,class:"chat-msg word-hint-msg"},Wt={class:"msg-player"},$t={key:0,class:"msg-correct"},Tt={key:1,class:"msg-text"},xt={key:1,class:"chat-msg correct-self"},Mt={class:"chat-input-area"},Gt=["placeholder","disabled"],Lt=["disabled"],Et={key:2,class:"container margin-top-large"},Vt={class:"row flex-center"},Pt={class:"col-12 col-md-8"},Bt={class:"card"},It={class:"card-body text-center"},Nt=J({__name:"RoomView",setup(t){const o=ye(),a=ke(),c=X(),s=ee(),r=O(),{subscribeRoom:u,subscribeGuesses:_,unsubscribeRoom:F}=Z(),{isPlaying:R,isWaiting:k,isFinished:d,timeRemaining:g,isCountingDown:l,isCurrentDrawer:m,drawTime:p,currentRoundNumber:f,totalRounds:T,startGame:E,skipWord:W}=Se(),{hasGuessed:V,guessInput:n,submitGuess:w,loading:y}=it(),{leaveRoom:I}=We(),$=M(()=>c.currentRoom),P=M(()=>y.value),B=S(null),z=S(null),te=M(()=>[...s.guesses].sort((b,C)=>new Date(b.guessed_at).getTime()-new Date(C.guessed_at).getTime()));function de(){z.value&&(z.value.scrollTop=z.value.scrollHeight)}we(te,()=>{De(de)},{deep:!0});function ve(b){return c.participants.find(L=>L.user_id===b)?.nickname||"æœªçŸ¥ç©å®¶"}const he=M(()=>m.value?"ä½ æ˜¯ç•«å®¶ï¼Œè«‹ç•«ç•«...":V.value?"ä½ å·²çŒœä¸­ï¼":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),me=M(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ");function j(b){B.value=b,setTimeout(()=>{B.value=null},3e3)}async function se(){!m.value&&n.value.trim()&&await w()}async function fe(){const b=await E();!b.success&&b.error&&j(b.error)}async function q(){const b=await I();$.value&&F($.value.code),await a.push("/"),!b.success&&b.error&&j(b.error)}async function ge(){const b=await W();!b.success&&b.error&&j(b.error)}return re(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",o.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",$.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",r.user?.id);const b=o.params.code;b&&!$.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",b),$.value&&r.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",$.value.status),await s.loadCurrentRound($.value.id),u($.value.code,$.value.id,r.user.id,{nickname:r.profile?.display_name||"ç©å®¶"}),s.currentRound&&_($.value.code,s.currentRound.id))}),ie(()=>{$.value&&F($.value.code)}),(b,C)=>(h(),v("div",at,[i(k)?(h(),v("div",lt,[e("div",ct,[e("div",ut,[N($e,{room:$.value,participants:i(c).participants,onStartGame:fe,onLeaveRoom:q},null,8,["room","participants"])])])])):i(R)?(h(),v("div",dt,[e("div",vt,[e("div",ht,[N(ne,{"show-winner":!1})])]),e("div",mt,[e("div",{class:x(["game-header",{"time-critical":i(g)!==null&&i(g)<=10}])},[i(l)&&i(g)!==null?(h(),v("div",ft,[e("span",{class:x(["time-number",{"time-warning":i(g)<=10,"time-critical-pulse":i(g)<=5}])},D(i(g)),3),C[1]||(C[1]=e("span",{class:"time-label"},"ç§’",-1))])):G("",!0),e("div",gt,[e("span",pt,"ç¬¬ "+D(i(f))+" / "+D(i(T))+" è¼ª",1)]),i(m)&&i(s).currentWord?(h(),v("div",_t,[C[2]||(C[2]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",wt,D(i(s).currentWord),1),e("button",{class:"skip-btn",onClick:ge,title:"è·³éæ­¤è©"},"è·³é")])):(h(),v("div",yt,[e("span",bt,D(me.value),1)])),e("button",{class:"leave-btn",onClick:q,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ft,[e("div",Ct,[N(He,{compact:!0})]),e("div",Rt,[N(Ge),i(l)&&i(g)!==null?(h(),v("div",kt,[e("div",{class:x(["time-bar",{"time-warning":i(g)<=10}]),style:Q({width:`${i(g)/i(p)*100}%`})},null,6)])):G("",!0)]),e("div",Dt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[C[6]||(C[6]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),U(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),i(m)&&i(s).currentWord?(h(),v("div",St,[C[3]||(C[3]=e("span",{class:"msg-icon"},"ğŸ¨",-1)),C[4]||(C[4]=U(" ä½ è¦ç•«ï¼š",-1)),e("strong",null,D(i(s).currentWord),1)])):G("",!0),(h(!0),v(A,null,H(te.value,L=>(h(),v("div",{key:L.id,class:x(["chat-msg",{"correct-guess":L.is_correct,"wrong-guess":!L.is_correct}])},[e("span",Wt,D(ve(L.user_id)),1),L.is_correct?(h(),v("span",$t,"çŒœä¸­äº†ï¼ +"+D(L.score_earned),1)):(h(),v("span",Tt,D(L.guess_text),1))],2))),128)),i(V)?(h(),v("div",xt,[...C[5]||(C[5]=[e("span",{class:"msg-icon"},"âœ…",-1),U(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):G("",!0)],512),e("div",Mt,[be(e("input",{"onUpdate:modelValue":C[0]||(C[0]=L=>Re(n)?n.value=L:null),type:"text",placeholder:he.value,maxlength:"32",disabled:P.value||i(V)||i(m),onKeyup:Ce(se,["enter"]),class:"chat-input-field"},null,40,Gt),[[Fe,i(n)]]),e("button",{onClick:se,disabled:P.value||i(V)||i(m)||!i(n).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Lt)])])])])])):i(d)?(h(),v("div",Et,[e("div",Vt,[e("div",Pt,[e("div",Bt,[e("div",It,[C[7]||(C[7]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),N(ne,{"show-winner":!0}),e("button",{onClick:q,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):G("",!0)]))}}),Ut=Y(Nt,[["__scopeId","data-v-f4e0857a"]]);export{Ut as default};
