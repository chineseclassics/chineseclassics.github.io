import{d as ve,f as p,n as te,c as H,o as P,p as ye,a as ae,e as w,q as Se,s as _e,r as x,u as X,B as _,H as Ee,x as be,t as B,j as K,F as Ce,i as Ge,b as j,y as Ae,_ as ke}from"./index-Cgq7LTIg.js";const Me=["width","height","fill","transform"],Ie={key:0},Te=w("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),qe=[Te],Ne={key:1},De=w("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),xe=w("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),He=[De,xe],Pe={key:2},$e=w("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Ue=[$e],Oe={key:3},Be=w("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Ze=[Be],je={key:4},We=w("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Le=[We],ze={key:5},Ve=w("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Fe=[Ve],Ke={name:"PhPaintBrush"},Tr=ve({...Ke,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const f=e,u=te("weight","regular"),l=te("size","1em"),R=te("color","currentColor"),k=te("mirrored",!1),A=p(()=>f.weight??u),I=p(()=>f.size??l),C=p(()=>f.color??R),m=p(()=>f.mirrored!==void 0?f.mirrored?"scale(-1, 1)":void 0:k?"scale(-1, 1)":void 0);return(g,y)=>(P(),H("svg",Se({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:I.value,height:I.value,fill:C.value,transform:m.value},g.$attrs),[ye(g.$slots,"default"),A.value==="bold"?(P(),H("g",Ie,qe)):A.value==="duotone"?(P(),H("g",Ne,He)):A.value==="fill"?(P(),H("g",Pe,Ue)):A.value==="light"?(P(),H("g",Oe,Ze)):A.value==="regular"?(P(),H("g",je,Le)):A.value==="thin"?(P(),H("g",ze,Fe)):ae("",!0)],16,Me))}}),re=_e("room",()=>{const e=x(null),f=x([]),u=x(!1),l=x(null),R=p(()=>{const r=X();return e.value?.host_id===r.user?.id});async function k(r){try{u.value=!0,l.value=null;const t=X();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(o){console.warn("載入用戶資料時發生錯誤（非關鍵）:",o)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");let s=null,v=0;const h=10;for(;v<h&&!s;){v++;const S={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:O,error:i}=await _.from("game_rooms").insert(S).select().single();if(i){if(i.code==="23505")continue;throw new Error(i.message||"插入房間失敗")}if(O){s=O;break}}if(!s)throw new Error("無法生成唯一房間碼，請重試");const T={room_id:s.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:o}=await _.from("room_participants").insert(T);o&&console.error("創建參與記錄錯誤:",o)}catch(o){console.error("創建參與記錄時發生錯誤:",o)}try{const{data:o,error:S}=await _.from("room_participants").select("*").eq("room_id",s.id).order("joined_at",{ascending:!0});S?console.error("載入參與者列表失敗:",S):o&&(f.value=o)}catch(o){console.error("載入參與者列表時發生錯誤:",o)}return e.value=s,{success:!0,room:s}}catch(t){return l.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:l.value}}finally{u.value=!1}}async function A(r,t){try{u.value=!0,l.value=null;const s=X();if(!s.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:v,error:h}=await _.from("game_rooms").select("*").eq("code",r).single();if(h||!v)throw new Error("房間不存在");if(v.status!=="waiting")throw new Error("房間已開始或已結束");const{data:T}=await _.from("room_participants").select("*").eq("room_id",v.id).eq("user_id",s.user.id).maybeSingle();if(T)return e.value=v,await C(v.id),{success:!0,room:v};const{error:o}=await _.from("room_participants").insert({room_id:v.id,user_id:s.user.id,nickname:t.trim(),score:0});if(o){if(o.code==="23505"||o.message.includes("duplicate"))return e.value=v,await C(v.id),{success:!0,room:v};throw o}return e.value=v,await C(v.id),{success:!0,room:v}}catch(s){return l.value=s instanceof Error?s.message:"加入房間失敗",console.error("加入房間錯誤:",s),{success:!1,error:l.value}}finally{u.value=!1}}async function I(){try{if(!e.value)return{success:!0};u.value=!0,l.value=null;const r=X();if(!r.user)throw new Error("請先登入");const{error:t}=await _.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(R.value){const{error:s}=await _.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);s&&console.error("關閉房間失敗:",s)}return e.value=null,f.value=[],{success:!0}}catch(r){return l.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,f.value=[],{success:!1,error:l.value}}finally{u.value=!1}}async function C(r){try{const{data:t,error:s}=await _.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(s)throw s;f.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function m(r){try{u.value=!0,l.value=null;const{data:t,error:s}=await _.from("game_rooms").select("*").eq("id",r).single();if(s)throw s;return e.value=t,await C(r),{success:!0,room:t}}catch(t){return l.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:l.value}}finally{u.value=!1}}async function g(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await _.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(r==="finished"&&e.value&&await y(),e.value){const s=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:s,newStatus:e.value.status})}return{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:l.value}}}async function y(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:r,error:t}=await _.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(t){console.error("獲取參與者錯誤:",t);return}if(!r||r.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const s=r.map(o=>o.user_id),{data:v,error:h}=await _.from("users").select("id, user_type").in("id",s);if(h){console.error("獲取用戶信息錯誤:",h);return}const T=new Set(v?.filter(o=>o.user_type==="registered").map(o=>o.id)||[]);for(const o of r){if(!T.has(o.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${o.user_id} 的積分累積`);continue}if(o.score>0){const{error:S}=await _.rpc("accumulate_user_score",{user_id_param:o.user_id,score_to_add:o.score});if(S){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",S);const{data:O,error:i}=await _.from("users").select("total_score").eq("id",o.user_id).single();if(i){console.error(`[RoomStore] 獲取用戶 ${o.user_id} 總積分錯誤:`,i);continue}const c=(O?.total_score||0)+o.score,{error:E}=await _.from("users").update({total_score:c}).eq("id",o.user_id);E?console.error(`[RoomStore] 更新用戶 ${o.user_id} 總積分錯誤:`,E):console.log(`[RoomStore] 用戶 ${o.user_id} 積分已累積: +${o.score} (總積分: ${c})`)}else console.log(`[RoomStore] 用戶 ${o.user_id} 積分已累積: +${o.score}`)}}}catch(r){console.error("[RoomStore] 累積積分錯誤:",r)}}async function M(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await _.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:l.value}}}async function $(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:r});const t={...e.value.settings,...r},{error:s}=await _.from("game_rooms").update({settings:t}).eq("id",e.value.id);if(s)throw s;return e.value&&(e.value.settings=t,console.log("[RoomStore] 房間設置已更新:",t)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",t),{success:!1,error:l.value}}}function U(){e.value=null,f.value=[],l.value=null}function n(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function a(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!R.value)return{success:!1,error:"只有房主可以踢人"};const t=X();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};u.value=!0,l.value=null;const{data:s,error:v}=await _.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(v)throw new Error(v.message);if(s&&!s.success)throw new Error(s.error||"踢出玩家失敗");return await C(e.value.id),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:l.value}}finally{u.value=!1}}return{currentRoom:e,participants:f,loading:u,error:l,isHost:R,createRoom:k,joinRoom:A,leaveRoom:I,kickPlayer:a,loadParticipants:C,loadRoom:m,updateRoomStatus:g,updateRoomDrawer:M,updateRoomSettings:$,setCurrentDrawer:n,clearRoom:U}});function Je(){const e=re(),f=p(()=>e.currentRoom),u=p(()=>e.participants),l=p(()=>e.isHost),R=p(()=>!f.value||f.value.status!=="waiting"||!l.value?!1:u.value.length>=2);async function k(C){return await e.createRoom(C)}async function A(C,m){return await e.joinRoom(C,m)}async function I(){return await e.leaveRoom()}return{currentRoom:f,participants:u,isHost:l,canStartGame:R,loading:p(()=>e.loading),error:p(()=>e.error),createRoom:k,joinRoom:A,leaveRoom:I}}const le=100,de=50,me=10,Ye=10,fe=100,ge=[1,.8,.6,.4,.2];function Qe(){const e=re();function f(m){const g=Math.min(m,ge.length-1),y=ge[g]??0;return Math.round(le*y)}function u(m,g=0){if(m===0)return 0;const y=m*me,M=Math.round(g*Ye);return de+y+M}async function l(m,g,y=0){const M=u(g,y);return M===0?!0:await R(m,M)}async function R(m,g){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:y,error:M}=await _.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",m).single();if(M)throw M;const $=(y?.score||0)+g,{error:U}=await _.from("room_participants").update({score:$}).eq("room_id",e.currentRoom.id).eq("user_id",m);if(U)throw U;const n=e.participants.findIndex(a=>a.user_id===m);return n!==-1&&e.participants[n]&&(e.participants[n].score=$),!0}catch(y){return console.error("更新玩家分數錯誤:",y),!1}}function k(){if(!e.participants||e.participants.length===0)return null;const m=[...e.participants].sort((g,y)=>y.score-g.score);return m.length===1||m[0]&&m[1]&&m[0].score>m[1].score?{user_id:m[0]?.user_id||"",score:m[0]?.score||0}:{user_id:m[0]?.user_id||"",score:m[0]?.score||0}}const A=p(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((g,y)=>y.score!==g.score?y.score-g.score:new Date(g.joined_at).getTime()-new Date(y.joined_at).getTime()).map((g,y)=>({id:g.id,user_id:g.user_id,score:g.score,rank:y+1}))),I=p(()=>e.currentRoom?.status!=="finished"?null:k());function C(){return fe}return{GUESS_BASE_SCORE:le,DRAWING_BASE_SCORE:de,DRAWING_BONUS_PER_GUESS:me,WINNER_BONUS:fe,calculateGuessScore:f,calculateDrawingScore:u,calculateWinner:k,updatePlayerScore:R,updateDrawerScore:l,playerRankings:A,winner:I,getWinnerBonus:C}}const he=_e("game",()=>{const e=re(),f=X(),u=x(null),l=x(null),R=x([]),k=p(()=>R.value.filter(i=>i.is_correct)),A=p(()=>u.value?R.value.filter(i=>i.round_id===u.value.id):[]),I=p(()=>A.value.filter(i=>i.is_correct)),C=x("drawing"),m=x([]),g=x([]),y=p(()=>g.value.length===0?0:g.value.reduce((c,E)=>c+E.rating,0)/g.value.length);function M(i){C.value=i}function $(i){m.value=i}function U(i){const c=g.value.findIndex(E=>E.rater_id===i.rater_id);c>=0?g.value[c]=i:g.value.push(i)}function n(){g.value=[]}async function a(i){try{const{data:c,error:E}=await _.from("game_rounds").select("*").eq("room_id",i).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(E)throw E;return c&&(u.value=c,l.value=c.word_text,c.word_options&&Array.isArray(c.word_options)&&(m.value=c.word_options),await r(c.id)),{success:!0,round:c}}catch(c){return console.error("載入當前輪次錯誤:",c),{success:!1,error:c instanceof Error?c.message:"載入輪次失敗"}}}async function r(i){try{const{data:c,error:E}=await _.from("guesses").select("*").eq("round_id",i).order("guessed_at",{ascending:!0});if(E)throw E;const b=c||[],q=new Set(R.value.map(G=>G.id)),d=b.filter(G=>!q.has(G.id));d.length>0&&(R.value=[...R.value,...d])}catch(c){console.error("載入猜測記錄錯誤:",c)}}async function t(i){try{const{data:c,error:E}=await _.from("game_rounds").select("id").eq("room_id",i);if(E)throw E;if(!c||c.length===0){R.value=[];return}const b=c.map(G=>G.id),{data:q,error:d}=await _.from("guesses").select("*").in("round_id",b).order("guessed_at",{ascending:!0});if(d)throw d;R.value=q||[]}catch(c){console.error("載入所有猜測記錄錯誤:",c)}}async function s(i,c,E,b){try{if(!e.currentRoom)throw new Error("沒有當前房間");const q=(e.currentRoom.current_round||0)+1,{data:d,error:G}=await _.from("game_rounds").insert({room_id:i,round_number:q,drawer_id:c,word_text:E,word_source:b}).select().single();if(G)throw G;return u.value=d,l.value=E,await _.from("game_rooms").update({current_round:q,current_drawer_id:c}).eq("id",i),{success:!0,round:d}}catch(q){return console.error("創建輪次錯誤:",q),{success:!1,error:q instanceof Error?q.message:"創建輪次失敗"}}}function v(i){return u.value?R.value.some(c=>c.round_id===u.value.id&&c.user_id===i&&c.is_correct):!1}const h=p(()=>!u.value||!f.user?!1:u.value.drawer_id===f.user.id);async function T(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const i=k.value.length,c=y.value,{updateDrawerScore:E}=Qe();console.log("[endRound] 猜中人數:",i,"平均評分:",c),await E(u.value.drawer_id,i,c);const{error:b}=await _.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",u.value.id);if(b)throw b;return{success:!0}}catch(i){return console.error("結束輪次錯誤:",i),{success:!1,error:i instanceof Error?i.message:"結束輪次失敗"}}}function o(){u.value=null,l.value=null,R.value=[],C.value="drawing",m.value=[],g.value=[]}async function S(i,c,E){if(!f.user)return{success:!1,error:"用戶未登錄"};try{const{data:b,error:q}=await _.from("drawing_ratings").upsert({round_id:i,rater_id:f.user.id,drawer_id:c,rating:E},{onConflict:"round_id,rater_id"}).select().single();if(q)throw q;return b&&U(b),{success:!0,rating:b}}catch(b){return console.error("提交評分錯誤:",b),{success:!1,error:b instanceof Error?b.message:"提交評分失敗"}}}async function O(i){try{const{data:c,error:E}=await _.from("drawing_ratings").select("*").eq("round_id",i);if(E)throw E;return g.value=c||[],{success:!0,ratings:c}}catch(c){return console.error("載入評分錯誤:",c),{success:!1,error:c instanceof Error?c.message:"載入評分失敗"}}}return{currentRound:u,currentWord:l,guesses:R,correctGuesses:k,currentRoundGuesses:A,currentRoundCorrectGuesses:I,isCurrentDrawer:h,roundStatus:C,wordOptions:m,ratings:g,averageRating:y,loadCurrentRound:a,loadGuesses:r,loadAllGuesses:t,createRound:s,hasGuessed:v,endRound:T,clearGame:o,setRoundStatus:M,setWordOptions:$,addRating:U,clearRatings:n,submitRating:S,loadRatings:O}}),W=new Map,L=x("disconnected"),z=new Map,oe=new Set,se=new Map;function V(...e){}function Z(...e){console.warn("[Realtime]",...e)}function ie(){const e=re(),f=he();function u(n){const a=`room:${n}`;if(W.has(a))return W.get(a);const r=_.channel(a,{config:{presence:{key:"user"},broadcast:{self:!0}}});return W.set(a,r),r}function l(n){const a=se.get(n);a&&(clearTimeout(a),se.delete(n))}function R(n,a,r,t,s){n==="SUBSCRIBED"?(L.value="connected",l(r),a.track({user_id:t,...s}).catch(v=>{Z("Presence track 失敗:",v)})):n==="CHANNEL_ERROR"||n==="TIMED_OUT"?(L.value="disconnected",Z("訂閱失敗:",n),k(r,t,s)):n==="CLOSED"&&(L.value="disconnected")}function k(n,a,r,t=0){if(t>=3){Z("重連失敗次數過多，停止重連");return}l(n);const s=Math.min(1e3*Math.pow(2,t),1e4),v=window.setTimeout(()=>{const h=W.get(`room:${n}`);h&&h.state!=="joined"&&h.subscribe(T=>{T==="SUBSCRIBED"?R(T,h,n,a,r):(T==="CHANNEL_ERROR"||T==="TIMED_OUT")&&k(n,a,r,t+1)})},s);se.set(n,v)}function A(n,a,r,t){return new Promise((s,v)=>{if(!n||!a){Z("缺少 roomCode 或 roomId"),v(new Error("缺少 roomCode 或 roomId"));return}const h=u(n),T=h.state;if(T==="joined"){L.value="connected",s(h);return}if(T==="joining"){const o=setInterval(()=>{const S=h.state;S==="joined"?(clearInterval(o),s(h)):(S==="closed"||S==="errored")&&(clearInterval(o),v(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(o),h.state!=="joined"&&v(new Error("連接超時"))},5e3);return}if(oe.has(n)){L.value="connecting",h.subscribe(o=>{R(o,h,n,r,t),o==="SUBSCRIBED"?s(h):(o==="CHANNEL_ERROR"||o==="TIMED_OUT")&&v(new Error(`訂閱失敗: ${o}`))});return}h.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${a}`},async o=>{V("房間狀態變化:",o.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${a}`},async o=>{V("參與者變化:",o.eventType),await e.loadParticipants(a)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${a}`},async o=>{V("輪次變化:",o.eventType,o.new),e.currentRoom&&await f.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async o=>{const S=o.new;if(S&&f.currentRound&&(await f.loadGuesses(S.round_id),S.is_correct&&e.isHost&&f.roundStatus==="drawing")){const O=f.currentRound.drawer_id,i=e.participants.filter(b=>b.user_id!==O),c=new Set(f.currentRoundCorrectGuesses.map(b=>b.user_id));if(i.length>0&&i.every(b=>c.has(b.user_id))){const{useGame:b}=await Ee(async()=>{const{useGame:d}=await Promise.resolve().then(()=>Xe);return{useGame:d}},void 0),{endRound:q}=b();await q()}}}).on("broadcast",{event:"drawing"},o=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(o));const S=z.get(n);S&&o.payload?.stroke?(console.log("[Realtime] 分發給",S.size,"個回調"),S.forEach(O=>O(o.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",S?.size,"stroke:",o.payload?.stroke)}).on("presence",{event:"sync"},()=>{const o=h.presenceState();V("Presence 同步，在線:",Object.keys(o).length)}),oe.add(n),L.value="connecting",h.subscribe(o=>{R(o,h,n,r,t),o==="SUBSCRIBED"?s(h):(o==="CHANNEL_ERROR"||o==="TIMED_OUT")&&v(new Error(`訂閱失敗: ${o}`))})})}function I(n,a){return z.has(n)||z.set(n,new Set),z.get(n).add(a),()=>{z.get(n)?.delete(a)}}function C(n,a){const r=u(n),t=`guesses:${a}`;return r[t]||(r.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${a}`},async s=>{V("收到新猜測記錄:",s.eventType,s.new),await f.loadGuesses(a)}),r[t]=!0),r}function m(n,a){const r=u(n),t=`gameState:${n}`;return r[t]||(r.on("broadcast",{event:"game_state"},s=>{V("收到遊戲狀態廣播:",s.payload),a(s.payload)}),r[t]=!0),r}async function g(n,a){const r=u(n),t=r.state;if(t!=="joined")return Z("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{V("廣播遊戲狀態:",a);const s=await r.send({type:"broadcast",event:"game_state",payload:a});return s==="error"?(Z("發送遊戲狀態失敗"),{error:"發送失敗"}):s}catch(s){return Z("發送遊戲狀態錯誤:",s),{error:s instanceof Error?s.message:"發送失敗"}}}async function y(n,a){const r=u(n),t=r.state;if(t!=="joined")return Z("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const s=await r.send({type:"broadcast",event:"drawing",payload:{stroke:a}});return s==="error"?(Z("發送失敗"),{error:"發送失敗"}):s}catch(s){return Z("發送錯誤:",s),{error:s instanceof Error?s.message:"發送失敗"}}}function M(n){const a=`room:${n}`,r=W.get(a);l(n),r&&(_.removeChannel(r),W.delete(a)),z.delete(n),oe.delete(n)}function $(){se.forEach((n,a)=>l(a)),W.forEach(n=>_.removeChannel(n)),W.clear(),z.clear(),oe.clear()}function U(){return L.value}return{connectionStatus:L,subscribeRoom:A,subscribeDrawing:I,subscribeGuesses:C,subscribeGameState:m,sendDrawing:y,broadcastGameState:g,unsubscribeRoom:M,unsubscribeAll:$,getConnectionStatus:U}}const we=6,J=x(null),ue=x(!1);let Y=null;const F=x(null);let Q=null;const ne=x(new Set);function pe(){const e=re(),f=he();ie();const u=J,l=ue,R=F,k=p(()=>e.currentRoom?.status||"waiting"),A=p(()=>k.value==="playing"),I=p(()=>k.value==="waiting"),C=p(()=>k.value==="finished"),m=p(()=>f.roundStatus),g=p(()=>m.value==="drawing"),y=p(()=>m.value==="summary"),M=p(()=>f.currentRound),$=p(()=>e.currentRoom?.current_round||0),U=p(()=>e.currentRoom?.settings.rounds||0),n=p(()=>e.currentRoom?.settings.draw_time||60),a=p(()=>f.isCurrentDrawer);function r(d){console.log("[useGame] startCountdown 開始，時長:",d,"秒"),Y&&clearInterval(Y),J.value=d,ue.value=!0,Y=window.setInterval(()=>{J.value!==null&&J.value>0?J.value--:(t(),A.value&&M.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),i()))},1e3)}function t(){Y&&(clearInterval(Y),Y=null),ue.value=!1}function s(){t(),J.value=null}function v(){console.log("[useGame] startSummaryCountdown 開始"),Q&&clearInterval(Q),F.value=we,console.log("[useGame] 開始總結倒計時:",we,"秒"),Q=window.setInterval(async()=>{F.value!==null&&F.value>0?(F.value--,console.log("[useGame] 總結倒計時:",F.value)):(h(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await c()))},1e3)}function h(){console.log("[useGame] stopSummaryCountdown"),Q&&(clearInterval(Q),Q=null),F.value=null}function T(){if(!e.currentRoom)return null;const d=e.currentRoom.words;if(d.length===0)return null;const G=[];for(let D=0;D<d.length;D++)ne.value.has(D)||G.push(D);let N=0;if(G.length>0){const D=Math.floor(Math.random()*G.length);N=G[D]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),ne.value.clear(),N=Math.floor(Math.random()*d.length);return ne.value.add(N),d[N]??null}async function o(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{ne.value.clear();const d=e.participants.length,G=await e.updateRoomSettings({rounds:d});if(!G.success)return G;console.log("[useGame] 輪數已自動設定為房間人數:",d);const N=await e.updateRoomStatus("playing");return N.success?await S():N}catch(d){return console.error("開始遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"開始遊戲失敗"}}}async function S(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const G=(e.currentRoom.current_round||0)+1;try{const N=(G-1)%e.participants.length,D=e.participants[N];if(console.log("[startDrawingPhase] 第",G,"輪，畫家:",D?.nickname),!D)throw new Error("無法選擇畫家");const ee=T();if(!ee)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",ee.text),await e.updateRoomDrawer(D.user_id);const ce=await f.createRound(e.currentRoom.id,D.user_id,ee.text,ee.source);if(!ce.success||!ce.round)throw new Error("創建輪次失敗");const{broadcastGameState:Re}=ie();return await Re(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:D.user_id,drawerName:D.nickname,roundNumber:G,startedAt:ce.round.started_at}),{success:!0,drawerId:D.user_id,word:ee.text}}catch(N){return console.error("開始繪畫階段錯誤:",N),{success:!1,error:N instanceof Error?N.message:"開始繪畫階段失敗"}}}async function O(){return await S()}async function i(){if(!M.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const d=await f.endRound();if(!d.success)return d;const G=!1,{broadcastGameState:N}=ie();return await N(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:G}),{success:!0,gameEnded:G}}catch(d){return console.error("結束輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束輪次失敗"}}}async function c(){return e.currentRoom?e.isHost?(await S(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function E(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return t(),await e.updateRoomStatus("finished"),{success:!0}}catch(d){return console.error("結束遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束遊戲失敗"}}}async function b(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(m.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),h(),await S()}catch(d){return console.error("下一局錯誤:",d),{success:!1,error:d instanceof Error?d.message:"下一局失敗"}}}const q=p(()=>{if(u.value===null)return"--:--";const d=Math.floor(u.value/60),G=u.value%60;return`${d.toString().padStart(2,"0")}:${G.toString().padStart(2,"0")}`});return be(()=>{t(),h()}),{gameStatus:k,isPlaying:A,isWaiting:I,isFinished:C,currentRound:M,currentRoundNumber:$,totalRounds:U,drawTime:n,isCurrentDrawer:a,timeRemaining:u,isCountingDown:l,formattedTime:q,roundStatus:m,isDrawing:g,isSummary:y,summaryTimeRemaining:R,startGame:o,newGame:b,startNextRound:O,startDrawingPhase:S,endRound:i,continueToNextRound:c,endGame:E,startCountdown:r,stopCountdown:t,startSummaryCountdown:v,stopSummaryCountdown:h,resetCountdown:s}}const Xe=Object.freeze(Object.defineProperty({__proto__:null,useGame:pe},Symbol.toStringTag,{value:"Module"})),er={class:"waiting-lobby"},rr={class:"card"},tr={class:"card-body"},or={class:"room-info text-center margin-bottom-medium"},sr={class:"card-title text-hand-title"},nr={class:"room-details"},ar={class:"detail-item margin-bottom-small"},cr={class:"badge badge-secondary room-code-badge"},ir={class:"detail-item"},ur={class:"badge"},lr={class:"players-section margin-bottom-medium"},dr={class:"text-hand-title margin-bottom-small"},mr={class:"players-list"},fr={class:"player-avatar"},gr={class:"player-info"},wr={class:"player-name"},vr={key:0,class:"badge badge-warning"},_r={class:"room-settings margin-bottom-medium"},hr={class:"setting-item"},pr={class:"setting-value"},Rr={class:"setting-item"},yr={class:"setting-value"},Sr={class:"setting-item"},Er={class:"setting-value"},br={class:"lobby-actions"},Cr=["disabled"],Gr={key:1,class:"alert alert-warning text-center"},Ar=["disabled"],kr={key:0,class:"alert alert-danger margin-top-small"},Mr=ve({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:f}){const u=e,l=f,{isHost:R,canStartGame:k,leaveRoom:A,loading:I,error:C}=Je(),{startGame:m}=pe(),g=p(()=>{const n=u.room?.settings.rounds||0,a=u.participants.length,r=n>0?n:a;return r>0?r:1});function y(n){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[n||""]||n||"未知"}function M(n){return u.room?.host_id===n}async function $(){(await m()).success&&l("startGame")}async function U(){(await A()).success&&l("leaveRoom")}return(n,a)=>(P(),H("div",er,[w("div",rr,[w("div",tr,[w("div",or,[w("h2",sr,B(e.room?.name),1),w("div",nr,[w("div",ar,[a[0]||(a[0]=K(" 房間碼：",-1)),w("span",cr,B(e.room?.code),1)]),w("div",ir,[a[1]||(a[1]=K(" 狀態：",-1)),w("span",ur,B(y(e.room?.status)),1)])])]),w("div",lr,[w("h4",dr,"玩家列表 ("+B(e.participants.length)+")",1),w("div",mr,[(P(!0),H(Ce,null,Ge(e.participants,r=>(P(),H("div",{key:r.id,class:Ae(["player-item",{"is-host":M(r.user_id)}])},[w("div",fr,B(r.nickname.charAt(0).toUpperCase()),1),w("div",gr,[w("div",wr,[K(B(r.nickname)+" ",1),M(r.user_id)?(P(),H("span",vr," 房主 ")):ae("",!0)])])],2))),128))])]),w("div",_r,[w("div",hr,[a[3]||(a[3]=w("span",{class:"setting-label"},"繪畫時間：",-1)),w("span",pr,[w("strong",null,B(e.room?.settings.draw_time),1),a[2]||(a[2]=K("秒",-1))])]),w("div",Rr,[a[5]||(a[5]=w("span",{class:"setting-label"},"每局輪數：",-1)),w("span",yr,[w("strong",null,B(g.value),1),a[4]||(a[4]=K("輪",-1))])]),w("div",Sr,[a[7]||(a[7]=w("span",{class:"setting-label"},"詞語總數：",-1)),w("span",Er,[w("strong",null,B(e.room?.word_count),1),a[6]||(a[6]=K("個",-1))])])]),w("div",br,[j(R)&&j(k)?(P(),H("button",{key:0,disabled:j(I),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:$},B(j(I)?"開始中":"開始遊戲"),9,Cr)):j(R)?(P(),H("div",Gr," 至少需要 2 個玩家才能開始遊戲 ")):ae("",!0),w("button",{disabled:j(I),class:"paper-btn btn-secondary btn-block",onClick:U},B(j(I)?"離開中":"離開房間"),9,Ar)]),j(C)?(P(),H("div",kr,B(j(C)),1)):ae("",!0)])])]))}}),qr=ke(Mr,[["__scopeId","data-v-b0994167"]]);export{Tr as I,qr as W,ie as a,re as b,he as c,Qe as d,pe as e,Je as u};
