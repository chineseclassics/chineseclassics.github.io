import{u as N,f as T,r as g,E as f}from"./index-C924DiRn.js";const l=g([]),u=g({}),S=g(!1),M=g({}),A=g(null),c=g(!1);function K(){const a=N(),n=T(()=>c.value);async function o(e=!1){if(!a.profile?.email)return c.value=!1,!1;if(c.value&&!e)return!0;const{data:r,error:t}=await f.from("word_library_admins").select("email").eq("email",a.profile.email).maybeSingle();return t?(console.warn("[WordLibrary] 檢查管理員權限失敗:",t),c.value=!1,!1):(c.value=!!r,c.value)}async function _(e={}){try{S.value=!0,A.value=null;let r=f.from("word_collections").select("id, slug, title, description, entry_count, is_active").order("title",{ascending:!0});e.includeInactive||(r=r.eq("is_active",!0));const{data:t,error:s}=await r;if(s)throw s;return l.value=t||[],l.value}catch(r){return A.value=r instanceof Error?r.message:"載入詞句庫失敗",[]}finally{S.value=!1}}async function x(e,r=!1){if(!r&&u.value[e])return u.value[e];M.value[e]=!0;try{const{data:t,error:s}=await f.from("word_entries").select("id, collection_id, text, category").eq("collection_id",e).order("text",{ascending:!0});if(s)throw s;return u.value[e]=t||[],u.value[e]}catch(t){return A.value=t instanceof Error?t.message:"載入詞句條目失敗",u.value[e]=[],[]}finally{M.value[e]=!1}}async function y(e){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const r=e.slug||e.title.trim().toLowerCase().replace(/\s+/g,"-"),t={title:e.title.trim(),slug:r,description:e.description?.trim()||null},{data:s,error:i}=await f.from("word_collections").insert(t).select("id, slug, title, description, entry_count, is_active").single();return i?{success:!1,error:i.message||"新增主題失敗"}:(l.value=[...l.value,s],{success:!0,collection:s})}async function C(e,r,t){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const s=r.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{data:i,error:h}=await f.from("word_entries").insert({collection_id:e,text:s,category:t?.trim()||null}).select("id, collection_id, text, category").single();if(h)return{success:!1,error:h.message||"新增條目失敗"};const w=i,j=u.value[e]||[];return u.value[e]=[...j,w],l.value=l.value.map(p=>p.id===e?{...p,entry_count:(p.entry_count||0)+1}:p),{success:!0,entry:w}}async function m(e,r,t){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const s=t.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{error:i}=await f.from("word_entries").update({text:s}).eq("id",e);if(i)return{success:!1,error:i.message||"更新失敗"};const h=u.value[r]||[];return u.value[r]=h.map(w=>w.id===e?{...w,text:s}:w),{success:!0}}async function L(e,r){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await f.from("word_entries").delete().eq("id",e);if(t)return{success:!1,error:t.message||"刪除失敗"};const s=u.value[r]||[];return u.value[r]=s.filter(i=>i.id!==e),l.value=l.value.map(i=>i.id===r?{...i,entry_count:Math.max(0,(i.entry_count||1)-1)}:i),{success:!0}}async function v(e,r){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await f.from("word_collections").update({is_active:r}).eq("id",e);return t?{success:!1,error:t.message||"更新狀態失敗"}:(l.value=l.value.map(s=>s.id===e?{...s,is_active:r}:s),{success:!0})}async function E(e){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:r}=await f.from("word_entries").delete().eq("collection_id",e);if(r)return{success:!1,error:r.message||"刪除詞條失敗"};const{error:t}=await f.from("word_collections").delete().eq("id",e);return t?{success:!1,error:t.message||"刪除主題失敗"}:(l.value=l.value.filter(s=>s.id!==e),delete u.value[e],{success:!0})}return{collections:l,entriesMap:u,loadingCollections:S,loadingEntries:M,error:A,isAdmin:n,refreshAdminStatus:o,loadCollections:_,loadEntries:x,addCollection:y,addEntry:C,updateEntry:m,deleteEntry:L,toggleCollectionActive:v,deleteCollection:E}}const q="ai-word-generator-rate-limit",W=10,k=300*1e3,U=3e4,R=g(!1),d=g(null);function b(){try{const a=localStorage.getItem(q);if(a)return JSON.parse(a)}catch{}return{calls:[]}}function D(a){try{localStorage.setItem(q,JSON.stringify(a))}catch{}}function P(a){const o=Date.now()-k;return a.filter(_=>_>o)}function O(){const a=b(),n=P(a.calls);n.length!==a.calls.length&&D({calls:n});const o=Math.max(0,W-n.length);return{isLimited:n.length>=W,remainingCalls:o}}function G(){const a=b(),n=P(a.calls);n.push(Date.now()),D({calls:n})}function J(a){return a.map(n=>n.trim()).filter(n=>n.length>0).join("，")}function X(){const a=T(()=>O()),n=T(()=>a.value.isLimited),o=T(()=>a.value.remainingCalls);async function _(y){if(!y||y.trim().length===0)return d.value="請先輸入房間主題",null;const{isLimited:C}=O();if(C)return d.value="請求次數已達上限，請 5 分鐘後再試",null;R.value=!0,d.value=null;try{G();const m=new Promise((e,r)=>{setTimeout(()=>r(new Error("TIMEOUT")),U)}),L=f.functions.invoke("generate-words",{body:{theme:y.trim()}}),{data:v,error:E}=await Promise.race([L,m]);if(E)throw E;return!v||!v.success?(d.value=v?.error||"AI 服務暫時不可用，請稍後再試或手動輸入詞語",null):{words:v.words||[],isThemeAdjusted:v.isThemeAdjusted||!1,adjustedTheme:v.adjustedTheme}}catch(m){return m instanceof Error?m.message==="TIMEOUT"?d.value="AI 服務響應超時，請稍後再試":m.message.includes("network")||m.message.includes("fetch")?d.value="網絡連接失敗，請檢查網絡後重試":d.value="AI 服務暫時不可用，請稍後再試或手動輸入詞語":d.value="AI 服務暫時不可用，請稍後再試或手動輸入詞語",null}finally{R.value=!1}}function x(){localStorage.removeItem(q)}return{isGenerating:R,isRateLimited:n,remainingCalls:o,error:d,generateWords:_,formatWordsForInput:J,resetRateLimit:x}}export{X as a,J as f,K as u};
