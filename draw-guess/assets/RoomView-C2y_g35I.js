import{l as Ae,r as x,u as q,d as J,i as se,m as te,c as i,e,o as a,_ as K,f as L,n as N,a as G,F as V,p as O,q as ce,t as v,b as o,s as U,h as Q,x as Z,y as ze,j as B,z as ye,A as Ue,g as qe,v as Je,B as Ke,C as Ye,k as Xe,D as je}from"./index-DiT7Z-i0.js";import{c as ne,b as ue,d as de,e as $e,a as Qe,u as Ze,W as es}from"./WaitingLobby-DdUhsoml.js";const Ce=Ae("drawing",()=>{const t=x("pen"),c=x("#000000"),d=x(3),u=x(!1),s=x([]);function l(R){t.value=R}function g(R){c.value=R}function f(R){d.value=Math.max(1,Math.min(20,R))}function k(R){s.value.push(R)}function T(){s.value=[]}function S(R){u.value=R}return{tool:t,color:c,lineWidth:d,isDrawing:u,strokes:s,setTool:l,setColor:g,setLineWidth:f,addStroke:k,clearStrokes:T,setDrawing:S}});function be(t,c){const d=t.getBoundingClientRect();let u,s;if(c instanceof MouseEvent)u=c.clientX,s=c.clientY;else if(c instanceof TouchEvent&&c.touches.length>0&&c.touches[0])u=c.touches[0].clientX,s=c.touches[0].clientY;else return null;return{x:u-d.left,y:s-d.top}}function Se(t,c){if(!(c.points.length<2)){t.save(),c.tool==="pen"?(t.strokeStyle=c.color,t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"):c.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),c.points[0]&&t.moveTo(c.points[0].x,c.points[0].y);for(let d=1;d<c.points.length;d++){const u=c.points[d];u&&t.lineTo(u.x,u.y)}t.stroke(),t.restore()}}function ie(t,c){const d=t.getContext("2d");if(!d)return;const u=t.getBoundingClientRect();d.clearRect(0,0,t.width,t.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,u.width,u.height),c.forEach(s=>{Se(d,s)})}function ss(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Fe(){const t=Ce(),c=ne(),d=q(),{sendDrawing:u}=ue(),s=x(null),l=x(null),g=x(null),f=x(null);let k=null;const T=50;function S(n){s.value=n;const b=n.getContext("2d",{willReadFrequently:!0});if(!b){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}l.value=b;const I=window.devicePixelRatio||1,H=n.getBoundingClientRect();n.width=H.width*I,n.height=H.height*I,b.scale(I,I),b.fillStyle="#FFFFFF",b.fillRect(0,0,H.width,H.height),s.value&&ie(s.value,t.strokes),new ResizeObserver(()=>{if(!s.value||!l.value)return;const P=s.value.getBoundingClientRect(),A=window.devicePixelRatio||1;s.value.width=P.width*A,s.value.height=P.height*A,l.value.scale(A,A),l.value.fillStyle="#FFFFFF",l.value.fillRect(0,0,P.width,P.height),ie(s.value,t.strokes)}).observe(n)}function R(n){if(!s.value)return;n.preventDefault(),t.setDrawing(!0);const b=be(s.value,n);b&&(g.value={id:ss(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[b],timestamp:Date.now()},f.value=b)}function M(n){if(!s.value||!l.value||!t.isDrawing||!g.value)return;n.preventDefault();const b=be(s.value,n);if(!b||!f.value)return;const I=l.value;I.save(),g.value.tool==="pen"?(I.strokeStyle=g.value.color,I.lineWidth=g.value.lineWidth,I.lineCap="round",I.lineJoin="round"):g.value.tool==="eraser"&&(I.globalCompositeOperation="destination-out",I.lineWidth=g.value.lineWidth,I.lineCap="round",I.lineJoin="round"),I.beginPath(),I.moveTo(f.value.x,f.value.y),I.lineTo(b.x,b.y),I.stroke(),I.restore(),g.value.points.push(b),f.value=b,k===null&&(k=window.setTimeout(()=>{$(),k=null},T))}function w(){!t.isDrawing||!g.value||(t.setDrawing(!1),k&&(clearTimeout(k),k=null),$(),g.value=null,f.value=null)}async function $(){if(!(!g.value||!c.currentRoom||!d.user))try{const n={...g.value,userId:d.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",n.id),await u(c.currentRoom.code,n)}catch(n){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",n)}}function p(n){if(!(!s.value||!l.value)){if(n.userId&&d.user&&n.userId===d.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",n.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",n.id),t.addStroke(n),Se(l.value,n)}}function m(){if(!s.value||!l.value)return;const n=l.value,b=s.value;n.clearRect(0,0,b.width,b.height),n.fillStyle="#FFFFFF",n.fillRect(0,0,b.width,b.height),t.clearStrokes()}function D(n){t.setTool(n)}function y(n){t.setColor(n)}function C(n){t.setLineWidth(n)}function _(){s.value&&ie(s.value,t.strokes)}return{canvasRef:s,initCanvas:S,startDrawing:R,draw:M,stopDrawing:w,clearCanvas:m,setTool:D,setColor:y,setLineWidth:C,handleDrawingData:p,redrawStrokes:_}}const ts={class:"drawing-canvas-container"},ns=J({__name:"DrawingCanvas",setup(t){const{initCanvas:c,startDrawing:d,draw:u,stopDrawing:s,handleDrawingData:l,clearCanvas:g}=Fe(),f=ne(),k=q(),{subscribeDrawing:T}=ue(),S=x(null);function R(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),g()}function M(n){d(n)}function w(n){u(n)}function $(){s()}function p(){s()}function m(n){d(n)}function D(n){u(n)}function y(){s()}let C=null;function _(){!f.currentRoom||!k.user||(C=T(f.currentRoom.code,n=>{l(n)}))}return se(()=>{S.value&&c(S.value),_(),window.addEventListener("clearCanvas",R)}),te(()=>{C&&(C(),C=null),window.removeEventListener("clearCanvas",R)}),(n,b)=>(a(),i("div",ts,[e("canvas",{ref_key:"canvasElement",ref:S,class:"drawing-canvas",onMousedown:M,onMousemove:w,onMouseup:$,onMouseleave:p,onTouchstart:m,onTouchmove:D,onTouchend:y},null,544)]))}}),os=K(ns,[["__scopeId","data-v-f29d9704"]]),rs={class:"toolbar-section"},as={key:0,class:"tool-label"},is={key:0,class:"tool-label"},ls={key:0,class:"toolbar-section colors-section"},cs=["onClick","title"],us={class:"toolbar-section size-section"},ds={class:"size-dots"},vs=["onClick","title"],ms={class:"toolbar-section"},hs={key:0,class:"tool-label"},fs=J({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const c=Ce(),{setTool:d,setColor:u,setLineWidth:s,clearCanvas:l}=Fe(),g=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],f=L(()=>c.tool),k=L(()=>c.color),T=L(()=>c.lineWidth);function S($){d($)}function R($){u($)}function M($){c.setLineWidth($),s($)}function w(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&l()}return($,p)=>(a(),i("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",rs,[e("button",{onClick:p[0]||(p[0]=m=>S("pen")),class:N(["tool-btn",{active:f.value==="pen"}]),title:"ç•«ç­†"},[p[2]||(p[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?G("",!0):(a(),i("span",as,"ç•«ç­†"))],2),e("button",{onClick:p[1]||(p[1]=m=>S("eraser")),class:N(["tool-btn",{active:f.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[p[3]||(p[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?G("",!0):(a(),i("span",is,"æ©¡çš®æ“¦"))],2)]),f.value==="pen"?(a(),i("div",ls,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(a(),i(V,null,O(g,m=>e("div",{key:m,onClick:D=>R(m),class:N(["color-cell",{selected:k.value===m}]),style:ce({backgroundColor:m}),title:m},null,14,cs)),64))],2)])):G("",!0),e("div",us,[e("div",ds,[(a(),i(V,null,O([2,5,10,15],m=>e("div",{key:m,onClick:D=>M(m),class:N(["size-dot",{active:T.value===m}]),style:ce({width:`${m+8}px`,height:`${m+8}px`}),title:`${m}px`},null,14,vs)),64))])]),e("div",ms,[e("button",{onClick:w,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[p[4]||(p[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?G("",!0):(a(),i("span",hs,"æ¸…ç©º"))])])],2))}}),le=K(fs,[["__scopeId","data-v-7e7250c3"]]),ws={class:"player-list"},gs={class:"player-list-header"},_s={class:"player-count"},ps={class:"player-rank"},ys={class:"player-info"},bs={class:"player-name"},ks={key:0,class:"drawer-badge"},Rs={key:1,class:"host-badge"},$s={class:"player-score"},Cs=["onClick"],Ss={key:0,class:"winner-banner"},Fs={class:"winner-text"},Ds={class:"winner-name"},Ws={class:"winner-score"},xs=J({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:c}){const d=c,u=ne(),s=de(),l=q(),{playerRankings:g,winner:f}=$e(),k=L(()=>g.value),T=x(!1);function S(m){return u.participants.find(y=>y.user_id===m)?.nickname||"æœªçŸ¥ç©å®¶"}function R(m){return l.user?.id===m}function M(m){return u.currentRoom?.host_id===m}function w(m){return s.currentRound?.drawer_id===m}function $(m){return u.isHost&&!R(m)}async function p(m,D){if(!(T.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${D} å—ï¼Ÿ`))){T.value=!0;try{const C=await u.kickPlayer(m);C.success?d("player-kicked",m):alert(C.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(C){console.error("è¸¢äººå¤±æ•—:",C),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{T.value=!1}}}return(m,D)=>(a(),i("div",ws,[e("div",gs,[e("span",_s,"ç©å®¶ ("+v(k.value.length)+")",1)]),(a(!0),i(V,null,O(k.value,(y,C)=>(a(),i("div",{key:y.id,class:N(["player-item",{"is-current":R(y.user_id)},{"is-drawer":w(y.user_id)}])},[e("div",ps,v(C+1),1),e("div",{class:N(["player-avatar",{drawing:w(y.user_id)}])},v(S(y.user_id).charAt(0)),3),e("div",ys,[e("div",bs,[U(v(S(y.user_id))+" ",1),w(y.user_id)?(a(),i("span",ks,"âœï¸")):G("",!0),M(y.user_id)?(a(),i("span",Rs,"ğŸ‘‘")):G("",!0)]),e("div",$s,v(y.score)+" åˆ†",1)]),$(y.user_id)?(a(),i("button",{key:0,class:"kick-btn",onClick:_=>p(y.user_id,S(y.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,Cs)):G("",!0)],2))),128)),t.showWinner&&o(f)?(a(),i("div",Ss,[D[1]||(D[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Fs,[D[0]||(D[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",Ds,v(S(o(f).user_id)),1),e("div",Ws,v(o(f).score)+" åˆ†",1)])])):G("",!0)]))}}),ke=K(xs,[["__scopeId","data-v-846d90e2"]]),Ts={class:"word-selection"},Is={class:"selection-card"},Gs={class:"selection-header"},Ms={class:"round-info"},Ls={class:"countdown-section"},Ns={class:"countdown-number"},Vs={class:"countdown-text"},Es={class:"word-options"},Bs=["onClick","disabled"],Os={class:"word-text"},Hs={key:0,class:"word-source"},Ps={class:"selection-footer"},As=["disabled"],zs=J({__name:"WordSelection",props:{wordOptions:{},roundNumber:{},totalRounds:{},selectionTime:{}},emits:["word-selected"],setup(t,{emit:c}){const d=t,u=c,s=x(null),l=x(!1),g=x(d.selectionTime);let f=null;function k(M){l.value||(s.value=M)}function T(){!s.value||l.value||(l.value=!0,u("word-selected",s.value),f&&clearInterval(f))}function S(){if(l.value)return;const M=Math.floor(Math.random()*d.wordOptions.length),w=d.wordOptions[M];w&&(s.value=w.text,l.value=!0,u("word-selected",w.text))}function R(){g.value=d.selectionTime,f=window.setInterval(()=>{g.value>0?g.value--:(f&&clearInterval(f),S())},1e3)}return se(()=>{R()}),te(()=>{f&&clearInterval(f)}),(M,w)=>(a(),i("div",Ts,[e("div",Is,[e("div",Gs,[w[0]||(w[0]=e("h2",{class:"selection-title"},"ğŸ¨ è¼ªåˆ°ä½ ç•«ç•«äº†ï¼",-1)),e("div",Ms,"ç¬¬ "+v(t.roundNumber)+" / "+v(t.totalRounds)+" è¼ª",1)]),e("div",Ls,[e("div",{class:N(["countdown-ring",{warning:g.value<=5}])},[e("span",Ns,v(g.value),1)],2),e("div",Vs,v(g.value<=5?"å³å°‡è‡ªå‹•é¸æ“‡ï¼":"è«‹é¸æ“‡ä¸€å€‹è©èª"),1)]),e("div",Es,[(a(!0),i(V,null,O(t.wordOptions,($,p)=>(a(),i("button",{key:p,class:N(["word-option",{selected:s.value===$.text}]),onClick:m=>k($.text),disabled:l.value},[e("span",Os,v($.text),1),$.source==="custom"?(a(),i("span",Hs,"è‡ªè¨‚")):G("",!0)],10,Bs))),128))]),e("div",Ps,[e("button",{class:"confirm-btn",disabled:!s.value||l.value,onClick:T},v(l.value?"å·²é¸æ“‡":"ç¢ºèªé¸æ“‡"),9,As)])])]))}}),Us=K(zs,[["__scopeId","data-v-00208fc2"]]),qs={class:"round-summary"},Js={class:"summary-card"},Ks={key:0,class:"selection-waiting-banner"},Ys={class:"waiting-text"},Xs={class:"next-drawer-name"},js={class:"summary-header"},Qs={class:"summary-title"},Zs={class:"round-info"},et={class:"answer-reveal"},st={class:"answer-text"},tt={class:"drawer-section"},nt={class:"drawer-info"},ot={class:"drawer-name"},rt={key:0,class:"drawer-score"},at={class:"guessers-section"},it={key:0,class:"no-guessers"},lt={key:1,class:"guessers-list"},ct={class:"guesser-rank"},ut={class:"guesser-name"},dt={class:"guesser-score"},vt={key:1,class:"rating-section"},mt={class:"star-rating"},ht=["onMouseenter","onClick","disabled"],ft={class:"rating-info"},wt={key:0,class:"rated-text"},gt={key:1,class:"rate-hint"},_t={key:2,class:"average-rating"},pt={class:"avg-score"},yt={class:"avg-stars"},bt={class:"avg-count"},kt={key:3,class:"summary-footer"},Rt={key:0,class:"countdown"},$t=J({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["next-round","rating-submitted"],setup(t,{emit:c}){const d=t,u=c,s=q(),l=x(0),g=x(0),f=x(!1),k=x([]),T=x(8);let S=null;const R=L(()=>s.user?.id===d.drawerId),M=L(()=>k.value.length===0?0:k.value.reduce((_,n)=>_+n.rating,0)/k.value.length),w=L(()=>k.value.length);async function $(C){if(!(f.value||R.value||!s.user))try{const{error:_}=await Z.from("drawing_ratings").upsert({round_id:d.roundId,rater_id:s.user.id,drawer_id:d.drawerId,rating:C},{onConflict:"round_id,rater_id"});if(_)throw _;l.value=C,f.value=!0,u("rating-submitted",C)}catch(_){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",_)}}async function p(){try{const{data:C,error:_}=await Z.from("drawing_ratings").select("rater_id, rating").eq("round_id",d.roundId);if(_)throw _;if(k.value=C||[],s.user){const n=k.value.find(b=>b.rater_id===s.user.id);n&&(l.value=n.rating,f.value=!0)}}catch(C){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",C)}}function m(){const C=Z.channel(`ratings:${d.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${d.roundId}`},()=>{p()}).subscribe();return()=>{Z.removeChannel(C)}}function D(){S=window.setInterval(()=>{T.value>0?T.value--:(S&&clearInterval(S),d.isHost&&u("next-round"))},1e3)}let y=null;return se(()=>{p(),y=m(),D()}),te(()=>{S&&clearInterval(S),y&&y()}),Q(()=>d.roundId,()=>{p(),T.value=8}),(C,_)=>(a(),i("div",qs,[e("div",Js,[t.isWaitingForSelection?(a(),i("div",Ks,[_[3]||(_[3]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Ys,[e("span",Xs,v(t.nextDrawerName),1),_[2]||(_[2]=U(" æ­£åœ¨é¸è©... ",-1))]),_[4]||(_[4]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):G("",!0),e("div",js,[e("h2",Qs,v(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Zs,"ç¬¬ "+v(t.roundNumber)+" / "+v(t.totalRounds)+" è¼ª",1)]),e("div",et,[_[5]||(_[5]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",st,v(t.correctAnswer),1)]),e("div",tt,[e("div",nt,[_[6]||(_[6]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",ot,v(t.drawerName),1),t.drawerScore>0?(a(),i("span",rt,"+"+v(t.drawerScore)+" åˆ†",1)):G("",!0)])]),e("div",at,[_[7]||(_[7]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(a(),i("div",it," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(a(),i("div",lt,[(a(!0),i(V,null,O(t.correctGuessers,(n,b)=>(a(),i("div",{key:n.userId,class:"guesser-item"},[e("span",ct,v(b+1),1),e("span",ut,v(n.name),1),e("span",dt,"+"+v(n.score),1)]))),128))]))]),R.value?G("",!0):(a(),i("div",vt,[_[8]||(_[8]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",mt,[(a(),i(V,null,O(5,n=>e("button",{key:n,class:N(["star-btn",{active:n<=(g.value||l.value),selected:n<=l.value}]),onMouseenter:b=>g.value=n,onMouseleave:_[0]||(_[0]=b=>g.value=0),onClick:b=>$(n),disabled:f.value}," â­ ",42,ht)),64))]),e("div",ft,[f.value?(a(),i("span",wt,"ä½ çš„è©•åˆ†ï¼š"+v(l.value)+" æ˜Ÿ",1)):(a(),i("span",gt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),w.value>0?(a(),i("div",_t,[_[9]||(_[9]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",pt,v(M.value.toFixed(1)),1),e("span",yt,v("â­".repeat(Math.round(M.value))),1),e("span",bt,"("+v(w.value)+" äººå·²è©•)",1)])):G("",!0),t.isWaitingForSelection?G("",!0):(a(),i("div",kt,[T.value>0?(a(),i("div",Rt,v(T.value)+" ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€è¼ª ",1)):G("",!0),t.isHost?(a(),i("button",{key:1,class:"next-btn",onClick:_[1]||(_[1]=n=>C.$emit("next-round"))},v(t.isLastRound?"æŸ¥çœ‹çµæœ":"ä¸‹ä¸€è¼ª"),1)):G("",!0)]))])]))}}),Re=K($t,[["__scopeId","data-v-23450531"]]);function Ct(){const t=de(),c=q(),{calculateGuessScore:d,updatePlayerScore:u}=$e(),s=x(""),l=x(null),g=x(!1),f=L(()=>t.isCurrentDrawer?t.currentWord:null),k=L(()=>t.correctGuesses),T=L(()=>c.user?t.hasGuessed(c.user.id):!1);async function S(){if(!t.currentRound||!c.user)return l.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return l.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return l.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(T.value)return l.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return l.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{g.value=!0,l.value=null;const w=s.value.trim(),$=t.currentWord||"",p=R(w,$),m=p?d(k.value.length):0,{data:D,error:y}=await Z.from("guesses").insert({round_id:t.currentRound.id,user_id:c.user.id,guess_text:w,is_correct:p,score_earned:m}).select().single();if(y)throw y;return t.guesses.push(D),p&&c.user&&await u(c.user.id,m),s.value="",{success:!0,isCorrect:p,guess:D}}catch(w){return l.value=w instanceof Error?w.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",w),{success:!1,error:l.value}}finally{g.value=!1}}function R(w,$){const p=w.trim(),m=$.trim();return p===m}function M(){l.value=null}return{guessInput:s,error:l,loading:g,currentWord:f,correctGuesses:k,hasGuessed:T,submitGuess:S,clearError:M}}const St={class:"game-container"},Ft={key:0,class:"container margin-top-large"},Dt={class:"row flex-center"},Wt={class:"col-12 col-md-8"},xt={key:1,class:"game-layout"},Tt={class:"game-sidebar game-players"},It={class:"player-list-container"},Gt={class:"game-main"},Mt={key:0,class:"time-display"},Lt={key:1,class:"time-display selecting"},Nt={class:"time-number time-warning"},Vt={key:2,class:"time-display summary"},Et={class:"time-number"},Bt={class:"round-info"},Ot={class:"round-label"},Ht={key:0,class:"phase-label"},Pt={key:1,class:"phase-label"},At={key:3,class:"word-display"},zt={class:"word-text"},Ut={key:4,class:"word-display"},qt={class:"word-slots"},Jt={key:5,class:"word-display"},Kt={class:"word-slots"},Yt={key:6,class:"word-display summary-word"},Xt={class:"word-text revealed"},jt={class:"game-content-area"},Qt={class:"game-toolbar disabled"},Zt={class:"game-canvas selection-phase"},en={key:2,class:"first-round-waiting"},sn={class:"waiting-card"},tn={class:"waiting-title"},nn={class:"game-chat-panel"},on={class:"game-toolbar disabled"},rn={class:"game-canvas summary-phase"},an={class:"game-chat-panel"},ln={class:"chat-msg system-msg answer-revealed"},cn={class:"msg-player"},un={class:"msg-correct"},dn={class:"game-toolbar"},vn={class:"game-canvas"},mn={key:0,class:"time-progress"},hn={class:"game-chat-panel"},fn={class:"msg-player"},wn={key:0,class:"msg-correct"},gn={key:1,class:"msg-text"},_n={key:0,class:"chat-msg correct-self"},pn={class:"chat-input-area"},yn=["placeholder","disabled"],bn=["disabled"],kn={key:2,class:"container margin-top-large"},Rn={class:"row flex-center"},$n={class:"col-12 col-md-8"},Cn={class:"card"},Sn={class:"card-body text-center"},Fn=J({__name:"RoomView",setup(t){const c=ze(),d=Xe(),u=ne(),s=de(),l=q(),{subscribeRoom:g,subscribeGuesses:f,unsubscribeRoom:k,subscribeGameState:T}=ue(),{isPlaying:S,isWaiting:R,isFinished:M,timeRemaining:w,isCountingDown:$,isCurrentDrawer:p,drawTime:m,currentRoundNumber:D,totalRounds:y,startGame:C,skipWord:_,isSelecting:n,isDrawing:b,isSummary:I,wordOptions:H,selectionTimeRemaining:oe,summaryTimeRemaining:P,selectWord:A,stopSelectionCountdown:De,startSelectionCountdown:We,startSummaryCountdown:xe,stopSummaryCountdown:Te,startCountdown:Ie}=Qe(),{hasGuessed:ee,guessInput:Y,submitGuess:Ge,loading:Me}=Ct(),{leaveRoom:Le}=Ze(),F=L(()=>u.currentRoom),ve=L(()=>Me.value),me=x(null),z=x(null),X=L(()=>{const h=F.value?.current_drawer_id;return h&&u.participants.find(W=>W.user_id===h)?.nickname||"ç•«å®¶"}),he=L(()=>!F.value||!l.user?!1:F.value.current_drawer_id===l.user.id),fe=L(()=>[...s.guesses].sort((h,r)=>new Date(h.guessed_at).getTime()-new Date(r.guessed_at).getTime()));function Ne(){z.value&&(z.value.scrollTop=z.value.scrollHeight)}Q(fe,()=>{je(Ne)},{deep:!0}),Q(()=>s.currentRound?.id,(h,r)=>{h&&h!==r&&F.value&&(console.log("[RoomView] è¼ªæ¬¡è®ŠåŒ–ï¼Œé‡æ–°è¨‚é–±çŒœæ¸¬:",h),f(F.value.code,h))}),Q(()=>u.participants,h=>{if(!l.user||!F.value)return;!h.some(W=>W.user_id===l.user.id)&&F.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),u.clearRoom(),d.push("/"))},{deep:!0});function re(h){return u.participants.find(W=>W.user_id===h)?.nickname||"æœªçŸ¥ç©å®¶"}const Ve=L(()=>p.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":ee.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ee=L(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),we=L(()=>s.correctGuesses.length*5),ge=L(()=>s.correctGuesses.map(h=>({userId:h.user_id,name:re(h.user_id),score:h.score_earned}))),E=x(null);function Be(){!s.currentRound||!s.currentWord||(E.value={roundNumber:D.value,answer:s.currentWord,drawerName:X.value,drawerId:s.currentRound.drawer_id,drawerScore:we.value,correctGuessers:ge.value,roundId:s.currentRound.id})}Q(n,(h,r)=>{h&&!r&&D.value>0&&Be()});function j(h){me.value=h,setTimeout(()=>{me.value=null},3e3)}async function _e(){!p.value&&Y.value.trim()&&await Ge()}async function Oe(){const h=await C();!h.success&&h.error&&j(h.error)}async function ae(){const h=await Le();F.value&&k(F.value.code),await d.push("/"),!h.success&&h.error&&j(h.error)}async function He(){const h=await _();!h.success&&h.error&&j(h.error)}async function Pe(h){const r=H.value.find(W=>W.text===h);if(r){const W=await A(r);!W.success&&W.error&&j(W.error)}}async function pe(h){if(!s.currentRound)return;const r=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,h);!r.success&&r.error&&j(r.error)}return se(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",c.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",F.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",l.user?.id);const h=c.params.code;if(h&&!F.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",h),F.value&&l.user){console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",F.value.status),await s.loadCurrentRound(F.value.id);try{await g(F.value.code,F.value.id,l.user.id,{nickname:l.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(r){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",r)}T(F.value.code,async r=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",r),r.roundStatus&&(s.setRoundStatus(r.roundStatus),r.roundStatus==="selecting"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),Te(),u.isHost||We()),r.roundStatus==="drawing"&&(De(),u.isHost||Ie(m.value)),r.roundStatus==="summary"&&(u.isHost||xe())),r.wordOptions!==void 0&&s.setWordOptions(r.wordOptions),r.drawerId&&F.value&&u.setCurrentDrawer(r.drawerId),F.value&&(await u.loadRoom(F.value.id),await s.loadCurrentRound(F.value.id),r.roundStatus==="drawing"&&s.currentRound&&(console.log("[RoomView] ç¹ªç•«éšæ®µï¼Œè¨‚é–±çŒœæ¸¬è¨˜éŒ„:",s.currentRound.id),f(F.value.code,s.currentRound.id)))}),s.currentRound&&f(F.value.code,s.currentRound.id)}}),te(()=>{F.value&&k(F.value.code)}),(h,r)=>(a(),i("div",St,[o(R)?(a(),i("div",Ft,[e("div",Dt,[e("div",Wt,[B(es,{room:F.value,participants:o(u).participants,onStartGame:Oe,onLeaveRoom:ae},null,8,["room","participants"])])])])):o(S)?(a(),i("div",xt,[e("div",Tt,[e("div",It,[B(ke,{"show-winner":!1})])]),e("div",Gt,[e("div",{class:N(["game-header",{"time-critical":o(w)!==null&&o(w)<=10}])},[o(b)&&o($)&&o(w)!==null?(a(),i("div",Mt,[e("span",{class:N(["time-number",{"time-warning":o(w)<=10,"time-critical-pulse":o(w)<=5}])},v(o(w)),3),r[1]||(r[1]=e("span",{class:"time-label"},"ç§’",-1))])):o(n)&&o(oe)!==null?(a(),i("div",Lt,[e("span",Nt,v(o(oe)),1),r[2]||(r[2]=e("span",{class:"time-label"},"ç§’é¸è©",-1))])):o(I)&&o(P)!==null?(a(),i("div",Vt,[e("span",Et,v(o(P)),1),r[3]||(r[3]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):G("",!0),e("div",Bt,[e("span",Ot,"ç¬¬ "+v(o(D)+(o(n)?1:0))+" / "+v(o(y))+" è¼ª",1),o(n)?(a(),i("span",Ht,"é¸è©ä¸­")):o(I)?(a(),i("span",Pt,"è¼ªæ¬¡çµç®—")):G("",!0)]),o(b)&&o(p)&&o(s).currentWord?(a(),i("div",At,[r[4]||(r[4]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",zt,v(o(s).currentWord),1),e("button",{class:"skip-btn",onClick:He,title:"è·³éæ­¤è©"},"è·³é")])):o(b)?(a(),i("div",Ut,[e("span",qt,v(Ee.value),1)])):o(n)?(a(),i("div",Jt,[e("span",Kt,v(he.value?"è«‹é¸æ“‡è¦ç•«çš„è©èª":`${X.value} æ­£åœ¨é¸è©...`),1)])):o(I)&&o(s).currentWord?(a(),i("div",Yt,[r[5]||(r[5]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",Xt,v(o(s).currentWord),1)])):G("",!0),e("button",{class:"leave-btn",onClick:ae,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",jt,[o(n)?(a(),i(V,{key:0},[e("div",Qt,[B(le,{compact:!0})]),e("div",Zt,[he.value?(a(),ye(Us,{key:0,"word-options":o(H),"round-number":o(D)+1,"total-rounds":o(y),"selection-time":15,onWordSelected:Pe},null,8,["word-options","round-number","total-rounds"])):E.value?(a(),ye(Re,{key:1,"round-number":E.value.roundNumber,"total-rounds":o(y),"correct-answer":E.value.answer,"drawer-name":E.value.drawerName,"drawer-id":E.value.drawerId,"drawer-score":E.value.drawerScore,"correct-guessers":E.value.correctGuessers,"round-id":E.value.roundId,"is-host":o(u).isHost,"is-last-round":!1,"is-waiting-for-selection":!0,"next-drawer-name":X.value,onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","next-drawer-name"])):(a(),i("div",en,[e("div",sn,[r[6]||(r[6]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("h2",tn,v(X.value)+" æ­£åœ¨é¸è©...",1),r[7]||(r[7]=Ue('<p class="waiting-hint" data-v-3e6219f0>ç¬¬ä¸€è¼ªå³å°‡é–‹å§‹</p><div class="waiting-dots" data-v-3e6219f0><span class="dot" data-v-3e6219f0></span><span class="dot" data-v-3e6219f0></span><span class="dot" data-v-3e6219f0></span></div>',2))])]))]),e("div",nn,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[...r[8]||(r[8]=[e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"â³"),U(" ç­‰å¾…ç•«å®¶é¸è©... ")],-1)])],512),r[9]||(r[9]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ç­‰å¾…é¸è©...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):o(I)?(a(),i(V,{key:1},[e("div",on,[B(le,{compact:!0})]),e("div",rn,[B(Re,{"round-number":o(D),"total-rounds":o(y),"correct-answer":o(s).currentWord||"","drawer-name":X.value,"drawer-id":o(s).currentRound?.drawer_id||"","drawer-score":we.value,"correct-guessers":ge.value,"round-id":o(s).currentRound?.id||"","is-host":o(u).isHost,"is-last-round":o(D)>=o(y),onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",an,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[e("div",ln,[r[10]||(r[10]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),r[11]||(r[11]=U(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,v(o(s).currentWord),1)]),(a(!0),i(V,null,O(o(s).correctGuesses,W=>(a(),i("div",{key:W.id,class:"chat-msg correct-guess"},[e("span",cn,v(re(W.user_id)),1),e("span",un,"çŒœä¸­äº†ï¼ +"+v(W.score_earned),1)]))),128))],512),r[12]||(r[12]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(a(),i(V,{key:2},[e("div",dn,[B(le,{compact:!0})]),e("div",vn,[B(os),o($)&&o(w)!==null?(a(),i("div",mn,[e("div",{class:N(["time-bar",{"time-warning":o(w)<=10}]),style:ce({width:`${o(w)/o(m)*100}%`})},null,6)])):G("",!0)]),e("div",hn,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[r[14]||(r[14]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),U(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(a(!0),i(V,null,O(fe.value,W=>(a(),i("div",{key:W.id,class:N(["chat-msg",{"correct-guess":W.is_correct,"wrong-guess":!W.is_correct}])},[e("span",fn,v(re(W.user_id)),1),W.is_correct?(a(),i("span",wn,"çŒœä¸­äº†ï¼ +"+v(W.score_earned),1)):(a(),i("span",gn,v(W.guess_text),1))],2))),128)),o(ee)?(a(),i("div",_n,[...r[13]||(r[13]=[e("span",{class:"msg-icon"},"âœ…",-1),U(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):G("",!0)],512),e("div",pn,[qe(e("input",{"onUpdate:modelValue":r[0]||(r[0]=W=>Ye(Y)?Y.value=W:null),type:"text",placeholder:Ve.value,maxlength:"32",disabled:ve.value||o(ee)||o(p),onKeyup:Ke(_e,["enter"]),class:"chat-input-field"},null,40,yn),[[Je,o(Y)]]),e("button",{onClick:_e,disabled:ve.value||o(ee)||o(p)||!o(Y).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,bn)])])],64))])])])):o(M)?(a(),i("div",kn,[e("div",Rn,[e("div",$n,[e("div",Cn,[e("div",Sn,[r[15]||(r[15]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),B(ke,{"show-winner":!0}),e("button",{onClick:ae,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):G("",!0)]))}}),xn=K(Fn,[["__scopeId","data-v-3e6219f0"]]);export{xn as default};
