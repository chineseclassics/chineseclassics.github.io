const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DAV_pZ_l.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as ir,f as R,y as xe,c as j,o as z,z as Tr,a as Re,e as C,A as Ar,B as Le,r as O,u as me,E as y,I as He,h as xr,t as Z,s as se,n as Ke,F as Fe,m as Dr,b as ne,_ as Pr}from"./index-DAV_pZ_l.js";const Nr=["width","height","fill","transform"],Mr={key:0},qr=C("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),kr=[qr],Or={key:1},Hr=C("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Br=C("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Lr=[Hr,Br],Ur={key:2},$r=C("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Wr=[$r],Vr={key:3},Zr=C("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),jr=[Zr],zr={key:4},Yr=C("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Kr=[Yr],Fr={key:5},Qr=C("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Jr=[Qr],Xr={name:"PhPaintBrush"},Lt=ir({...Xr,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const u=e,a=xe("weight","regular"),c=xe("size","1em"),N=xe("color","currentColor"),E=xe("mirrored",!1),_=R(()=>u.weight??a),W=R(()=>u.size??c),H=R(()=>u.color??N),b=R(()=>u.mirrored!==void 0?u.mirrored?"scale(-1, 1)":void 0:E?"scale(-1, 1)":void 0);return(p,T)=>(z(),j("svg",Ar({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:W.value,height:W.value,fill:H.value,transform:b.value},p.$attrs),[Tr(p.$slots,"default"),_.value==="bold"?(z(),j("g",Mr,kr)):_.value==="duotone"?(z(),j("g",Or,Lr)):_.value==="fill"?(z(),j("g",Ur,Wr)):_.value==="light"?(z(),j("g",Vr,jr)):_.value==="regular"?(z(),j("g",zr,Kr)):_.value==="thin"?(z(),j("g",Fr,Jr)):Re("",!0)],16,Nr))}}),Ce=Le("room",()=>{const e=O(null),u=O([]),a=O(!1),c=O(null),N=R(()=>{const t=me();return e.value?.host_id===t.user?.id});async function E(t){try{a.value=!0,c.value=null;const r=me();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(x){console.warn("載入用戶資料時發生錯誤（非關鍵）:",x)}const o=t.gameMode||"classic";if(o==="classic"&&t.words.length<6)throw new Error("至少需要 6 個詞語");let m=null,G=0;const L=10;for(;G<L&&!m;){G++;const Q={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null,game_mode:o,single_round_mode:t.singleRoundMode||!1,is_final_round:!1},{data:ee,error:s}=await y.from("game_rooms").insert(Q).select().single();if(s){if(s.code==="23505")continue;throw new Error(s.message||"插入房間失敗")}if(ee){m=ee;break}}if(!m)throw new Error("無法生成唯一房間碼，請重試");const w={room_id:m.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:x}=await y.from("room_participants").insert(w);x&&console.error("創建參與記錄錯誤:",x)}catch(x){console.error("創建參與記錄時發生錯誤:",x)}try{const{data:x,error:Q}=await y.from("room_participants").select("*").eq("room_id",m.id).order("joined_at",{ascending:!0});Q?console.error("載入參與者列表失敗:",Q):x&&(u.value=x)}catch(x){console.error("載入參與者列表時發生錯誤:",x)}return e.value=m,{success:!0,room:m}}catch(r){return c.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:c.value}}finally{a.value=!1}}async function _(t,r){try{a.value=!0,c.value=null;const o=me();if(!o.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:m,error:G}=await y.from("game_rooms").select("*").eq("code",t).single();if(G||!m)throw new Error("房間不存在");if(m.status!=="waiting")throw new Error("房間已開始或已結束");const{data:L}=await y.from("room_participants").select("*").eq("room_id",m.id).eq("user_id",o.user.id).maybeSingle();if(L)return e.value=m,await H(m.id),{success:!0,room:m};const{error:w}=await y.from("room_participants").insert({room_id:m.id,user_id:o.user.id,nickname:r.trim(),score:0});if(w){if(w.code==="23505"||w.message.includes("duplicate"))return e.value=m,await H(m.id),{success:!0,room:m};throw w}return e.value=m,await H(m.id),{success:!0,room:m}}catch(o){return c.value=o instanceof Error?o.message:"加入房間失敗",console.error("加入房間錯誤:",o),{success:!1,error:c.value}}finally{a.value=!1}}async function W(){try{if(!e.value)return{success:!0};a.value=!0,c.value=null;const t=me();if(!t.user)throw new Error("請先登入");const{error:r}=await y.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(N.value){const{error:o}=await y.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);o&&console.error("關閉房間失敗:",o)}return e.value=null,u.value=[],{success:!0}}catch(t){return c.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,u.value=[],{success:!1,error:c.value}}finally{a.value=!1}}async function H(t){try{const{data:r,error:o}=await y.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(o)throw o;u.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function b(t){try{a.value=!0,c.value=null;const{data:r,error:o}=await y.from("game_rooms").select("*").eq("id",t).single();if(o)throw o;return e.value=r,await H(t),{success:!0,room:r}}catch(r){return c.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:c.value}}finally{a.value=!1}}async function p(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await y.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(t==="finished"&&e.value&&await T(),e.value){const o=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:o,newStatus:e.value.status})}return{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:c.value}}}async function T(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:t,error:r}=await y.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(r){console.error("獲取參與者錯誤:",r);return}if(!t||t.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const o=t.map(w=>w.user_id),{data:m,error:G}=await y.from("users").select("id, user_type").in("id",o);if(G){console.error("獲取用戶信息錯誤:",G);return}const L=new Set(m?.filter(w=>w.user_type==="registered").map(w=>w.id)||[]);for(const w of t){if(!L.has(w.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${w.user_id} 的積分累積`);continue}if(w.score>0){const{error:x}=await y.rpc("accumulate_user_score",{user_id_param:w.user_id,score_to_add:w.score});if(x){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",x);const{data:Q,error:ee}=await y.from("users").select("total_score").eq("id",w.user_id).single();if(ee){console.error(`[RoomStore] 獲取用戶 ${w.user_id} 總積分錯誤:`,ee);continue}const s=(Q?.total_score||0)+w.score,{error:i}=await y.from("users").update({total_score:s}).eq("id",w.user_id);i?console.error(`[RoomStore] 更新用戶 ${w.user_id} 總積分錯誤:`,i):console.log(`[RoomStore] 用戶 ${w.user_id} 積分已累積: +${w.score} (總積分: ${s})`)}else console.log(`[RoomStore] 用戶 ${w.user_id} 積分已累積: +${w.score}`)}}}catch(t){console.error("[RoomStore] 累積積分錯誤:",t)}}async function k(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await y.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:c.value}}}async function P(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:t});const r={...e.value.settings,...t},{error:o}=await y.from("game_rooms").update({settings:r}).eq("id",e.value.id);if(o)throw o;return e.value&&(e.value.settings=r,console.log("[RoomStore] 房間設置已更新:",r)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",r),{success:!1,error:c.value}}}function B(){e.value=null,u.value=[],c.value=null}function Y(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function d(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!N.value)return{success:!1,error:"只有房主可以踢人"};const r=me();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,c.value=null;const{data:o,error:m}=await y.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(m)throw new Error(m.message);if(o&&!o.success)throw new Error(o.error||"踢出玩家失敗");return await H(e.value.id),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:c.value}}finally{a.value=!1}}async function f(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:t});const{error:r}=await y.from("game_rooms").update({is_final_round:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.is_final_round=t,console.log("[RoomStore] 最後一局標記已更新:",t)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",r),{success:!1,error:c.value}}}return{currentRoom:e,participants:u,loading:a,error:c,isHost:N,createRoom:E,joinRoom:_,leaveRoom:W,kickPlayer:d,loadParticipants:H,loadRoom:b,updateRoomStatus:p,updateRoomDrawer:k,updateRoomSettings:P,setCurrentDrawer:Y,setFinalRound:f,clearRoom:B}});function et(){const e=Ce(),u=R(()=>e.currentRoom),a=R(()=>e.participants),c=R(()=>e.isHost),N=R(()=>u.value&&u.value.game_mode==="storyboard"?3:2),E=R(()=>!u.value||u.value.status!=="waiting"||!c.value?!1:a.value.length>=N.value);async function _(b){return await e.createRoom(b)}async function W(b,p){return await e.joinRoom(b,p)}async function H(){return await e.leaveRoom()}return{currentRoom:u,participants:a,isHost:c,canStartGame:E,minPlayersRequired:N,loading:R(()=>e.loading),error:R(()=>e.error),createRoom:_,joinRoom:W,leaveRoom:H}}const Qe=100,Je=50,Xe=10,rt=10,er=100,rr=[1,.8,.6,.4,.2];function tt(){const e=Ce();function u(b){const p=Math.min(b,rr.length-1),T=rr[p]??0;return Math.round(Qe*T)}function a(b,p=0){if(b===0)return 0;const T=b*Xe,k=Math.round(p*rt);return Je+T+k}async function c(b,p,T=0){const k=a(p,T);return k===0?!0:await N(b,k)}async function N(b,p){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:T,error:k}=await y.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",b).single();if(k)throw k;const P=(T?.score||0)+p,{error:B}=await y.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",b);if(B)throw B;const Y=e.participants.findIndex(d=>d.user_id===b);return Y!==-1&&e.participants[Y]&&(e.participants[Y].score=P),!0}catch(T){return console.error("更新玩家分數錯誤:",T),!1}}function E(){if(!e.participants||e.participants.length===0)return null;const b=[...e.participants].sort((p,T)=>T.score-p.score);return b.length===1||b[0]&&b[1]&&b[0].score>b[1].score?{user_id:b[0]?.user_id||"",score:b[0]?.score||0}:{user_id:b[0]?.user_id||"",score:b[0]?.score||0}}const _=R(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((p,T)=>T.score!==p.score?T.score-p.score:new Date(p.joined_at).getTime()-new Date(T.joined_at).getTime()).map((p,T)=>({id:p.id,user_id:p.user_id,score:p.score,rank:T+1}))),W=R(()=>e.currentRoom?.status!=="finished"?null:E());function H(){return er}return{GUESS_BASE_SCORE:Qe,DRAWING_BASE_SCORE:Je,DRAWING_BONUS_PER_GUESS:Xe,WINNER_BONUS:er,calculateGuessScore:u,calculateDrawingScore:a,calculateWinner:E,updatePlayerScore:N,updateDrawerScore:c,playerRankings:_,winner:W,getWinnerBonus:H}}const lr=Le("game",()=>{const e=Ce(),u=me(),a=O(null),c=O(null),N=O(0),E=O([]),_=R(()=>E.value.filter(g=>g.is_correct)),W=R(()=>a.value?E.value.filter(g=>g.round_id===a.value.id):[]),H=R(()=>W.value.filter(g=>g.is_correct)),b=O("drawing"),p=O([]),T=O(!1),k=O([]),P=O([]),B=R(()=>p.value.length===0?0:p.value.reduce((v,l)=>v+l.rating,0)/p.value.length);function Y(g){b.value=g}function d(g){const v=p.value.findIndex(l=>l.rater_id===g.rater_id);v>=0?p.value[v]=g:p.value.push(g)}function f(){p.value=[]}function t(){if(T.value||!c.value)return null;const g=c.value,v=g.length,l=[];for(let F=0;F<v;F++)k.value.includes(F)||l.push(F);if(l.length===0)return null;const q=Math.floor(Math.random()*l.length),$=l[q];if($===void 0)return null;const K=g[$];return K?(k.value.push($),P.value.push(K),T.value=!0,{index:$,char:K}):null}function r(g,v,l=[]){T.value=g,k.value=v,P.value=l}function o(g){N.value=g}function m(){T.value=!1,k.value=[],P.value=[]}async function G(g,v=!1){try{const{data:l,error:q}=await y.from("game_rounds").select("*").eq("room_id",g).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(q)throw q;return l&&(a.value=l,l.word_text&&(N.value=l.word_text.length,console.log("[loadCurrentRound] 設置 wordLength:",N.value)),v||u.user&&l.drawer_id===u.user.id?c.value=l.word_text:c.value=null,l.hint_given!==void 0&&(T.value=l.hint_given),l.revealed_indices&&Array.isArray(l.revealed_indices)&&(k.value=l.revealed_indices),l.revealed_chars&&Array.isArray(l.revealed_chars)&&(P.value=l.revealed_chars,console.log("[loadCurrentRound] 恢復 revealedChars:",P.value)),await L(l.id)),{success:!0,round:l}}catch(l){return console.error("載入當前輪次錯誤:",l),{success:!1,error:l instanceof Error?l.message:"載入輪次失敗"}}}async function L(g){try{const{data:v,error:l}=await y.from("guesses").select("*").eq("round_id",g).order("guessed_at",{ascending:!0});if(l)throw l;const q=v||[],$=new Set(E.value.map(F=>F.id)),K=q.filter(F=>!$.has(F.id));K.length>0&&(E.value=[...E.value,...K])}catch(v){console.error("載入猜測記錄錯誤:",v)}}async function w(g){try{const{data:v,error:l}=await y.from("game_rounds").select("id").eq("room_id",g);if(l)throw l;if(!v||v.length===0){E.value=[];return}const q=v.map(F=>F.id),{data:$,error:K}=await y.from("guesses").select("*").in("round_id",q).order("guessed_at",{ascending:!0});if(K)throw K;E.value=$||[]}catch(v){console.error("載入所有猜測記錄錯誤:",v)}}async function x(g,v,l,q){try{if(!e.currentRoom)throw new Error("沒有當前房間");const $=(e.currentRoom.current_round||0)+1,{data:K,error:F}=await y.from("game_rounds").insert({room_id:g,round_number:$,drawer_id:v,word_text:l,word_source:q}).select().single();if(F)throw F;return a.value=K,c.value=l,await y.from("game_rooms").update({current_round:$,current_drawer_id:v}).eq("id",g),{success:!0,round:K}}catch($){return console.error("創建輪次錯誤:",$),{success:!1,error:$ instanceof Error?$.message:"創建輪次失敗"}}}function Q(g){return a.value?E.value.some(v=>v.round_id===a.value.id&&v.user_id===g&&v.is_correct):!1}const ee=R(()=>!a.value||!u.user?!1:a.value.drawer_id===u.user.id);async function s(){if(!a.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const g=_.value.length,v=B.value,{updateDrawerScore:l}=tt();console.log("[endRound] 猜中人數:",g,"平均評分:",v),await l(a.value.drawer_id,g,v);const{error:q}=await y.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(q)throw q;return{success:!0}}catch(g){return console.error("結束輪次錯誤:",g),{success:!1,error:g instanceof Error?g.message:"結束輪次失敗"}}}function i(){a.value=null,c.value=null,N.value=0,E.value=[],b.value="drawing",p.value=[],T.value=!1,k.value=[],P.value=[]}async function S(g,v,l){if(!u.user)return{success:!1,error:"用戶未登錄"};try{const{data:q,error:$}=await y.from("drawing_ratings").upsert({round_id:g,rater_id:u.user.id,drawer_id:v,rating:l},{onConflict:"round_id,rater_id"}).select().single();if($)throw $;return q&&d(q),{success:!0,rating:q}}catch(q){return console.error("提交評分錯誤:",q),{success:!1,error:q instanceof Error?q.message:"提交評分失敗"}}}async function M(g){try{const{data:v,error:l}=await y.from("drawing_ratings").select("*").eq("round_id",g);if(l)throw l;return p.value=v||[],{success:!0,ratings:v}}catch(v){return console.error("載入評分錯誤:",v),{success:!1,error:v instanceof Error?v.message:"載入評分失敗"}}}return{currentRound:a,currentWord:c,currentWordLength:N,guesses:E,correctGuesses:_,currentRoundGuesses:W,currentRoundCorrectGuesses:H,isCurrentDrawer:ee,roundStatus:b,ratings:p,averageRating:B,hintGiven:T,revealedIndices:k,revealedChars:P,loadCurrentRound:G,loadGuesses:L,loadAllGuesses:w,createRound:x,hasGuessed:Q,endRound:s,clearGame:i,setRoundStatus:Y,addRating:d,clearRatings:f,submitRating:S,loadRatings:M,giveHint:t,setHintState:r,setWordLength:o,resetHint:m}});function tr(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function or(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function Be(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function Ut(e){return e.trim().length===0}function $t(e,u=100){return e.length>u}const dr=Le("story",()=>{const e=me(),u=O([]),a=O([]),c=O([]),N=O("setup"),E=O(!1),_=O(null),W=R(()=>{const s=u.value.filter(i=>i.itemType==="text");return s.length===0?null:s[s.length-1]}),H=R(()=>{if(u.value.length===0)return null;const s=u.value[0];return s&&s.itemType==="text"?s.content:null}),b=R(()=>e.user&&a.value.find(s=>s.userId===e.user.id)||null),p=R(()=>e.user&&c.value.find(s=>s.voterId===e.user.id)||null),T=R(()=>{const s=new Map;for(const i of a.value)s.set(i.id,0);for(const i of c.value){const S=s.get(i.submissionId)||0;s.set(i.submissionId,S+1)}return s}),k=R(()=>{if(a.value.length===0)return null;let s=-1,i=[];for(const S of a.value){const M=T.value.get(S.id)||0;M>s?(s=M,i=[S]):M===s&&i.push(S)}return i.length>0?i[0]:null});async function P(s){try{E.value=!0,_.value=null;const{data:i,error:S}=await y.from("story_chains").select("*").eq("room_id",s).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(S)throw new Error(S.message);return u.value=(i||[]).map(M=>tr(M)),console.log("[StoryStore] 故事鏈已載入:",u.value.length,"項"),{success:!0,data:u.value}}catch(i){return _.value=i instanceof Error?i.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",i),{success:!1,error:_.value}}finally{E.value=!1}}async function B(s){try{E.value=!0,_.value=null;const i={room_id:s.roomId,round_number:s.roundNumber,item_type:s.itemType,content:s.content,author_id:s.authorId,author_name:s.authorName},{data:S,error:M}=await y.from("story_chains").insert(i).select().single();if(M)throw new Error(M.message);const g=tr(S);return u.value.push(g),console.log("[StoryStore] 故事鏈項目已添加:",g),{success:!0,data:g}}catch(i){return _.value=i instanceof Error?i.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",i),{success:!1,error:_.value}}finally{E.value=!1}}async function Y(s,i,S,M){return B({roomId:s,roundNumber:0,itemType:"text",content:i,authorId:S,authorName:M})}async function d(s,i,S,M){return B({roomId:s,roundNumber:-1,itemType:"text",content:i,authorId:S,authorName:M})}async function f(s){try{E.value=!0,_.value=null;const{data:i,error:S}=await y.from("story_submissions").select("*").eq("round_id",s).order("created_at",{ascending:!0});if(S)throw new Error(S.message);return a.value=(i||[]).map(M=>or(M)),console.log("[StoryStore] 句子提交已載入:",a.value.length,"項"),{success:!0,data:a.value}}catch(i){return _.value=i instanceof Error?i.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",i),{success:!1,error:_.value}}finally{E.value=!1}}async function t(s,i){if(!e.user)return{success:!1,error:"用戶未登錄"};try{E.value=!0,_.value=null;const S={round_id:s,user_id:e.user.id,sentence:i.trim(),vote_count:0,is_winner:!1},{data:M,error:g}=await y.from("story_submissions").upsert(S,{onConflict:"round_id,user_id"}).select().single();if(g)throw new Error(g.message);const v=or(M),l=a.value.findIndex(q=>q.roundId===s&&q.userId===e.user.id);return l>=0?a.value[l]=v:a.value.push(v),console.log("[StoryStore] 句子已提交:",v),{success:!0,data:v}}catch(S){return _.value=S instanceof Error?S.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",S),{success:!1,error:_.value}}finally{E.value=!1}}async function r(s){try{const{error:i}=await y.from("story_submissions").update({is_winner:!0}).eq("id",s);if(i)throw new Error(i.message);const S=a.value.find(M=>M.id===s);return S&&(S.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",s),{success:!0}}catch(i){return _.value=i instanceof Error?i.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",i),{success:!1,error:_.value}}}async function o(s){try{E.value=!0,_.value=null;const{data:i,error:S}=await y.from("story_votes").select("*").eq("round_id",s);if(S)throw new Error(S.message);return c.value=(i||[]).map(M=>Be(M)),console.log("[StoryStore] 投票記錄已載入:",c.value.length,"項"),{success:!0,data:c.value}}catch(i){return _.value=i instanceof Error?i.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",i),{success:!1,error:_.value}}finally{E.value=!1}}async function m(s,i){if(!e.user)return{success:!1,error:"用戶未登錄"};try{E.value=!0,_.value=null;const S={round_id:s,voter_id:e.user.id,submission_id:i},{data:M,error:g}=await y.from("story_votes").upsert(S,{onConflict:"round_id,voter_id"}).select().single();if(g)throw new Error(g.message);const v=Be(M),l=c.value.findIndex(q=>q.roundId===s&&q.voterId===e.user.id);return l>=0?c.value[l]=v:c.value.push(v),console.log("[StoryStore] 投票已記錄:",v),{success:!0,data:v}}catch(S){return _.value=S instanceof Error?S.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",S),{success:!1,error:_.value}}finally{E.value=!1}}function G(s){N.value=s,console.log("[StoryStore] 階段已更新:",s)}function L(){a.value=[],c.value=[],console.log("[StoryStore] 輪次數據已清除")}function w(){u.value=[],a.value=[],c.value=[],N.value="setup",_.value=null,console.log("[StoryStore] 所有故事數據已清除")}function x(s){u.value.some(S=>S.id===s.id)||(u.value.push(s),console.log("[StoryStore] 本地添加故事鏈項目:",s))}function Q(s){const i=a.value.findIndex(S=>S.id===s.id);i>=0?a.value[i]=s:a.value.push(s),console.log("[StoryStore] 本地添加句子提交:",s)}function ee(s){const i=c.value.findIndex(S=>S.roundId===s.roundId&&S.voterId===s.voterId);i>=0?c.value[i]=s:c.value.push(s),console.log("[StoryStore] 本地添加投票記錄:",s)}return{storyChain:u,submissions:a,votes:c,currentPhase:N,loading:E,error:_,latestSentence:W,storyOpening:H,mySubmission:b,myVote:p,voteCounts:T,winningSubmission:k,loadStoryChain:P,addStoryChainItem:B,addStoryOpening:Y,addStoryEnding:d,addStoryChainItemLocal:x,loadSubmissions:f,submitSentence:t,markWinningSubmission:r,addSubmissionLocal:Q,loadVotes:o,castVote:m,addVoteLocal:ee,setPhase:G,clearRoundData:L,clearAll:w}}),ae=new Map,ue=O("disconnected"),le=new Map,Ee=new Map,Ie=new Set;function oe(...e){}function X(...e){console.warn("[Realtime]",...e)}function ce(){const e=Ce(),u=lr(),a=dr();function c(d){const f=`room:${d}`;if(ae.has(f))return ae.get(f);const t=y.channel(f,{config:{private:!0,presence:{key:"user"},broadcast:{self:!0,replay:{since:Date.now()-600*1e3,limit:20}}}});return ae.set(f,t),t}function N(d,f,t,r,o){d==="SUBSCRIBED"?(ue.value="connected",f.track({user_id:r,...o}).catch(m=>{X("Presence track 失敗:",m)})):d==="CHANNEL_ERROR"||d==="TIMED_OUT"?(ue.value="disconnected",X("訂閱失敗:",d)):d==="CLOSED"&&(ue.value="disconnected")}async function E(d,f,t,r){if(!d||!f)throw X("缺少 roomCode 或 roomId"),new Error("缺少 roomCode 或 roomId");try{await y.realtime.setAuth(),oe("Realtime Auth 設置成功")}catch(o){X("Realtime Auth 設置失敗:",o)}return new Promise((o,m)=>{const G=c(d),L=G.state;if(L==="joined"){ue.value="connected",o(G);return}if(L==="joining"){const w=setInterval(()=>{const x=G.state;x==="joined"?(clearInterval(w),o(G)):(x==="closed"||x==="errored")&&(clearInterval(w),m(new Error(`連接失敗: ${x}`)))},100);setTimeout(()=>{clearInterval(w),G.state!=="joined"&&(X("subscribeRoom - 連接超時"),m(new Error("連接超時")))},1e4);return}if(Ie.has(d)){ue.value="connecting",G.subscribe(w=>{N(w,G,d,t,r),w==="SUBSCRIBED"?o(G):(w==="CHANNEL_ERROR"||w==="TIMED_OUT")&&m(new Error(`訂閱失敗: ${w}`))});return}_(G,d,f),Ie.add(d),ue.value="connecting",G.subscribe(w=>{N(w,G,d,t,r),w==="SUBSCRIBED"?o(G):(w==="CHANNEL_ERROR"||w==="TIMED_OUT")&&m(new Error(`訂閱失敗: ${w}`))})})}function _(d,f,t){d.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async r=>{oe("房間狀態變化:",r.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async r=>{oe("參與者變化:",r.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async r=>{if(oe("輪次變化:",r.eventType,r.new),e.currentRoom){const o=r.new,m=u.currentRound?.id;m?r.eventType==="INSERT"&&o?.id!==m?(oe("輪次變化：新輪次 INSERT",{newId:o?.id,currentId:m}),await u.loadCurrentRound(e.currentRoom.id)):r.eventType:await u.loadCurrentRound(e.currentRoom.id)}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async r=>{const o=r.new;if(o&&u.currentRound&&(await u.loadGuesses(o.round_id),o.is_correct&&e.isHost&&u.roundStatus==="drawing")){const m=u.currentRound.drawer_id,G=e.participants.filter(x=>x.user_id!==m),L=new Set(u.currentRoundCorrectGuesses.map(x=>x.user_id));if(G.length>0&&G.every(x=>L.has(x.user_id))){const{useGame:x}=await He(async()=>{const{useGame:ee}=await Promise.resolve().then(()=>st);return{useGame:ee}},void 0),{endRound:Q}=x();await Q()}}}).on("postgres_changes",{event:"*",schema:"public",table:"story_votes"},r=>{const o=r.new;if(o&&u.currentRound&&o.round_id===u.currentRound.id){oe("收到投票變更:",r.eventType,o);const m=Be(o);a.addVoteLocal(m)}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"story_submissions"},async r=>{const o=r.new;o&&u.currentRound&&o.round_id===u.currentRound.id&&await a.loadSubmissions(u.currentRound.id)}).on("broadcast",{event:"drawing"},r=>{const o=le.get(f);o&&r.payload?.stroke&&(oe("分發給",o.size,"個回調"),o.forEach(m=>m(r.payload.stroke)))}).on("broadcast",{event:"game_state"},r=>{r?.meta?.replayed;const o=r.payload;o?.type==="round_update"&&(oe("處理數據庫廣播的輪次更新:",{wordLength:o.wordLength,drawerId:o.drawerId,hintGiven:o.hintGiven}),o.wordLength>0&&u.setWordLength(o.wordLength),o.hintGiven!==void 0&&u.setHintState(o.hintGiven,o.revealedIndices||[],o.revealedChars||[]));const m=Ee.get(f);m&&o&&(oe("分發給",m.size,"個遊戲狀態回調"),m.forEach(G=>G(o)))}).on("presence",{event:"sync"},()=>{const r=d.presenceState();oe("Presence 同步，在線:",Object.keys(r).length)})}function W(d,f){return le.has(d)||le.set(d,new Set),le.get(d).add(f),()=>{le.get(d)?.delete(f)}}function H(d,f){const t=c(d),r=`guesses:${f}`;return t[r]||(t.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${f}`},async o=>{oe("收到新猜測記錄:",o.eventType,o.new),await u.loadGuesses(f)}),t[r]=!0),t}function b(d,f){return Ee.has(d)||Ee.set(d,new Set),Ee.get(d).add(f),()=>{Ee.get(d)?.delete(f)}}async function p(d,f){const t=c(d),r=t.state;if(r!=="joined")return X("Channel 未連接，狀態:",r,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{oe("廣播遊戲狀態:",f);const o=await t.send({type:"broadcast",event:"game_state",payload:f});return o==="error"?(X("發送遊戲狀態失敗"),{error:"發送失敗"}):o}catch(o){return X("發送遊戲狀態錯誤:",o),{error:o instanceof Error?o.message:"發送失敗"}}}async function T(d,f){const t=c(d),r=t.state;if(r!=="joined")return X("Channel 未連接，無法發送繪畫數據，狀態:",r),{error:"Channel 未連接"};try{const o=await t.send({type:"broadcast",event:"drawing",payload:{stroke:f}});return o==="error"?(X("發送失敗"),{error:"發送失敗"}):o}catch(o){return X("發送錯誤:",o),{error:o instanceof Error?o.message:"發送失敗"}}}function k(d){const f=`room:${d}`,t=ae.get(f);t&&(y.removeChannel(t),ae.delete(f)),le.delete(d),Ie.delete(d)}async function P(d,f,t,r){const o=`room:${d}`,m=ae.get(o);if(!m){try{await E(d,f,t,r)}catch(L){X("連接恢復：重新訂閱失敗:",L)}return}const G=m.state;if(G==="joined"){ue.value="connected";return}if(G!=="joining"&&(G==="errored"||G==="closed")){try{y.removeChannel(m)}catch(L){X("移除異常 Channel 失敗:",L)}ae.delete(o),Ie.delete(d);try{await E(d,f,t,r)}catch(L){X("連接恢復：重新訂閱失敗:",L)}}}function B(){ae.forEach(d=>y.removeChannel(d)),ae.clear(),le.clear(),Ie.clear()}function Y(){return ue.value}return{connectionStatus:ue,subscribeRoom:E,subscribeDrawing:W,subscribeGuesses:H,subscribeGameState:b,sendDrawing:T,broadcastGameState:p,unsubscribeRoom:k,unsubscribeAll:B,getConnectionStatus:Y,checkAndRestoreConnection:P}}const ot=5,nr=60,sr=60,ar=60,nt=5,Me=10,qe=5,ke=2,ur=3,he=O(null),Oe=O(!1);let _e=null;const de=O(null);let ye=null;const De=O(new Set),cr=O("setup"),pe=O(null);let Se=null;function mr(){const e=Ce(),u=lr(),a=dr();ce();const c=he,N=Oe,E=de,_=R(()=>e.currentRoom?.status||"waiting"),W=R(()=>_.value==="playing"),H=R(()=>_.value==="waiting"),b=R(()=>_.value==="finished"),p=R(()=>u.roundStatus),T=R(()=>p.value==="drawing"),k=R(()=>p.value==="summary"),P=R(()=>e.currentRoom?.game_mode==="storyboard"),B=cr,Y=pe,d=R(()=>P.value&&B.value==="drawing"),f=R(()=>P.value&&B.value==="writing"),t=R(()=>P.value&&B.value==="voting"),r=R(()=>P.value&&B.value==="summary"),o=R(()=>P.value&&B.value==="setup"),m=R(()=>P.value&&B.value==="ending"),G=R(()=>u.currentRound),L=R(()=>e.currentRoom?.current_round||0),w=R(()=>e.currentRoom?.settings.rounds||0),x=R(()=>e.currentRoom?.settings.draw_time||60),Q=R(()=>u.isCurrentDrawer);function ee(n){console.log("[useGame] startCountdown 開始，時長:",n,"秒"),_e&&clearInterval(_e),he.value=n,Oe.value=!0,_e=window.setInterval(()=>{he.value!==null&&he.value>0?he.value--:(s(),W.value&&G.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),$()))},1e3)}function s(){_e&&(clearInterval(_e),_e=null),Oe.value=!1}function i(){s(),he.value=null}function S(n){console.log("[useGame] startSummaryCountdown 開始"),ye&&clearInterval(ye);const h=n??ot;de.value=h,console.log("[useGame] 開始總結倒計時:",h,"秒"),ye=window.setInterval(async()=>{de.value!==null&&de.value>0?(de.value--,console.log("[useGame] 總結倒計時:",de.value)):(M(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await K()))},1e3)}function M(){console.log("[useGame] stopSummaryCountdown"),ye&&(clearInterval(ye),ye=null),de.value=null}function g(){if(!e.currentRoom)return null;const n=e.currentRoom.words;if(n.length===0)return null;const h=[];for(let D=0;D<n.length;D++)De.value.has(D)||h.push(D);let I=0;if(h.length>0){const D=Math.floor(Math.random()*h.length);I=h[D]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),De.value.clear(),I=Math.floor(Math.random()*n.length);return De.value.add(I),n[I]??null}async function v(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{De.value.clear();const n=e.participants.length,h=await e.updateRoomSettings({rounds:n});if(!h.success)return h;console.log("[useGame] 輪數已自動設定為房間人數:",n);const I=await e.updateRoomStatus("playing");if(!I.success)return I;if(P.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),ie("setup"),a.clearAll();const{broadcastGameState:A}=ce();return await A(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await l()}catch(n){return console.error("開始遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"開始遊戲失敗"}}}async function l(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const h=(e.currentRoom.current_round||0)+1;try{const I=(h-1)%e.participants.length,D=e.participants[I];if(console.log("[startDrawingPhase] 第",h,"輪，畫家:",D?.nickname),!D)throw new Error("無法選擇畫家");let A=null;if(P.value){const te=a.latestSentence;te?(A={text:te.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",A.text)):(A={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(A=g(),!A)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",A.text)}await e.updateRoomDrawer(D.user_id),u.setRoundStatus("drawing");const U=await u.createRound(e.currentRoom.id,D.user_id,A.text,A.source);if(!U.success||!U.round)throw new Error("創建輪次失敗");const{broadcastGameState:V}=ce();return P.value?await V(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:D.user_id,drawerName:D.nickname,roundNumber:h,startedAt:U.round.started_at,clearCanvas:!0}):await V(e.currentRoom.code,{roundStatus:"drawing",wordLength:A.text.length,drawerId:D.user_id,drawerName:D.nickname,roundNumber:h,startedAt:U.round.started_at,clearCanvas:!0}),{success:!0,drawerId:D.user_id,word:A.text}}catch(I){return console.error("開始繪畫階段錯誤:",I),{success:!1,error:I instanceof Error?I.message:"開始繪畫階段失敗"}}}async function q(){return await l()}async function $(){if(!G.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const n=await u.endRound();if(!n.success)return n;const h=!1,{broadcastGameState:I}=ce();return await I(e.currentRoom.code,{roundStatus:"summary",drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:h,startedAt:new Date().toISOString()}),{success:!0,gameEnded:h}}catch(n){return console.error("結束輪次錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束輪次失敗"}}}async function K(){return e.currentRoom?e.isHost?(await l(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function F(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return s(),await e.updateRoomStatus("finished"),{success:!0}}catch(n){return console.error("結束遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束遊戲失敗"}}}async function fr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(p.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),M(),await l()}catch(n){return console.error("下一局錯誤:",n),{success:!1,error:n instanceof Error?n.message:"下一局失敗"}}}const gr=R(()=>{if(c.value===null)return"--:--";const n=Math.floor(c.value/60),h=c.value%60;return`${n.toString().padStart(2,"0")}:${h.toString().padStart(2,"0")}`});function ie(n){console.log("[useGame] 設置分鏡模式階段:",n),cr.value=n,a.setPhase(n)}function vr(n,h){console.log("[useGame] 開始分鏡模式倒計時:",n,"秒"),Se&&clearInterval(Se),pe.value=n,Se=window.setInterval(()=>{pe.value!==null&&pe.value>0?pe.value--:(Ge(),h&&h())},1e3)}function Ge(){Se&&(clearInterval(Se),Se=null)}function wr(){Ge(),pe.value=null}async function hr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),ie("drawing"),a.clearRoundData();const{broadcastGameState:n}=ce();return await n(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString(),clearCanvas:!0}),{success:!0}}async function _r(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const n=new Date().toISOString(),{error:h}=await y.from("game_rooms").update({storyboard_phase:"writing",updated_at:n}).eq("id",e.currentRoom.id);h&&console.error("[useGame] 更新數據庫失敗:",h),ie("writing");const{broadcastGameState:I}=ce();return await I(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:n}),{success:!0}}async function yr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const n=new Date().toISOString(),{error:h}=await y.from("game_rooms").update({storyboard_phase:"voting",updated_at:n}).eq("id",e.currentRoom.id);h&&console.error("[useGame] 更新數據庫失敗:",h),ie("voting");const{broadcastGameState:I}=ce();return await I(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:n}),{success:!0}}async function pr(n){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const h=new Date().toISOString(),{error:I}=await y.from("game_rooms").update({storyboard_phase:"summary",updated_at:h}).eq("id",e.currentRoom.id);I&&console.error("[useGame] 更新數據庫失敗:",I),ie("summary");const{broadcastGameState:D}=ce();return await D(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:h,storyboardRoundResult:n?{winningSentence:n.winningSentence||"故事繼續發展中...",winnerName:n.winnerName||"",winnerId:n.winnerId||"",winnerVoteCount:n.winnerVoteCount||0,drawerScore:n.drawerScore||0,screenwriterScore:n.screenwriterScore||0}:void 0}),{success:!0}}async function Sr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:n}=await y.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);n&&console.error("[useGame] 更新數據庫失敗:",n),ie("ending");const{broadcastGameState:h}=ce();return await h(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function Ue(){const n=a.submissions,h=a.votes;if(n.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const I=new Map;for(const J of n)I.set(J.id,0);for(const J of h){const re=I.get(J.submissionId)||0;I.set(J.submissionId,re+1)}let D=-1,A=[];for(const J of n){const re=I.get(J.id)||0;re>D?(D=re,A=[J]):re===D&&A.push(J)}const U=A.length>1;if(A.length===1)return console.log("[useGame] 唯一最高票勝出:",A[0]?.sentence),{submission:A[0]||null,voteCount:D,hasTie:!1};const V=Math.floor(Math.random()*A.length),te=A[V]||null;return console.log("[useGame] 平票隨機選擇勝出:",te?.sentence,"(共",A.length,"個平票)"),{submission:te,voteCount:D,hasTie:U}}async function Rr(n){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!u.currentRound)return{success:!1,error:"沒有當前輪次"};const h=u.currentRound.round_number,I=u.currentRound.drawer_id,A=e.participants.find(U=>U.user_id===I)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",h);try{const U=u.currentRound.id;console.log("[useGame] 載入最新的提交和投票數據，輪次 ID:",U),await a.loadSubmissions(U),await a.loadVotes(U),console.log("[useGame] 數據載入完成 - 提交:",a.submissions.length,"投票:",a.votes.length);const{submission:V,voteCount:te,hasTie:J}=Ue();let re,ge,ve;V?(re=V.sentence,ge=V.userId,ve=e.participants.find(we=>we.user_id===ge)?.nickname||"編劇",await a.markWinningSubmission(V.id),console.log("[useGame] 勝出句子:",re,"作者:",ve,"票數:",te,"平票:",J)):(re="故事繼續發展中...",ge=I,ve=A,console.log("[useGame] 沒有提交，使用默認句子"));let Te="/placeholder-image.png";if(n)try{const be=await new Promise(we=>{n.toBlob(we,"image/png",.9)});if(be){const{supabase:we}=await He(async()=>{const{supabase:Ne}=await import("./index-DAV_pZ_l.js").then(Gr=>Gr.Q);return{supabase:Ne}},__vite__mapDeps([0,1])),Cr=Date.now(),ze=`storyboard/${e.currentRoom.id}/round_${h}_${Cr}.png`,{error:Ye}=await we.storage.from("canvas-snapshots").upload(ze,be,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(Ye)console.error("[useGame] 截圖上傳失敗:",Ye);else{const{data:Ne}=we.storage.from("canvas-snapshots").getPublicUrl(ze);Te=Ne.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Te)}}}catch(be){console.error("[useGame] 截圖上傳錯誤:",be)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:h,itemType:"image",content:Te,authorId:I,authorName:A}),await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:h,itemType:"text",content:re,authorId:ge,authorName:ve}),console.log("[useGame] Story_Chain 已更新");const Ze=a.votes.length;let Ae=0;V&&(Ae=Me,await fe(ge,Ae),console.log("[useGame] 編劇勝出得分:",Ae,"分給",ve));const Pe=qe+Ze*ke;await fe(I,Pe),console.log("[useGame] 畫家得分:",Pe,"分給",A,"(投票人數:",Ze,")");const je={success:!0,winningSentence:re,winnerName:ve,winnerId:ge,winnerVoteCount:te,drawerScore:Pe,screenwriterScore:Ae,imageUrl:Te};return console.log("[useGame] 輪次結算完成:",je),je}catch(U){return console.error("[useGame] 輪次結算錯誤:",U),{success:!1,error:U instanceof Error?U.message:"輪次結算失敗"}}}function br(){const n=document.querySelector("canvas.drawing-canvas");return n||document.querySelector("canvas")||null}function Er(n){switch(n){case"drawing":return nr;case"writing":return sr;case"voting":return ar;default:return 0}}function $e(){return Me}function We(n){return qe+n*ke}function Ve(n){return Math.round(n*ur)}async function Ir(n,h,I,D=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const A=$e();console.log("[useGame] 編劇勝出得分:",A,"分給",n),await fe(n,A);const U=We(I);if(console.log("[useGame] 畫家得分:",U,"分給",h,"(投票人數:",I,")"),await fe(h,U),D>0){const V=Ve(D);console.log("[useGame] 評星加分:",V,"分給",h,"(平均評星:",D,")"),await fe(h,V)}return{success:!0}}catch(A){return console.error("[useGame] 計算分鏡模式得分錯誤:",A),{success:!1,error:A instanceof Error?A.message:"計算得分失敗"}}}async function fe(n,h){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:I}=await He(async()=>{const{supabase:J}=await import("./index-DAV_pZ_l.js").then(re=>re.Q);return{supabase:J}},__vite__mapDeps([0,1])),{data:D,error:A}=await I.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",n).single();if(A)throw A;const U=(D?.score||0)+h,{error:V}=await I.from("room_participants").update({score:U}).eq("room_id",e.currentRoom.id).eq("user_id",n);if(V)throw V;const te=e.participants.findIndex(J=>J.user_id===n);return te!==-1&&e.participants[te]&&(e.participants[te].score=U),console.log("[useGame] 玩家",n,"得分更新為",U),!0}catch(I){return console.error("[useGame] 更新玩家分數錯誤:",I),!1}}return xr(()=>{s(),M(),Ge()}),{gameStatus:_,isPlaying:W,isWaiting:H,isFinished:b,currentRound:G,currentRoundNumber:L,totalRounds:w,drawTime:x,isCurrentDrawer:Q,timeRemaining:c,isCountingDown:N,formattedTime:gr,roundStatus:p,isDrawing:T,isSummary:k,summaryTimeRemaining:E,isStoryboardMode:P,storyboardPhase:B,storyboardTimeRemaining:Y,isStoryboardDrawing:d,isStoryboardWriting:f,isStoryboardVoting:t,isStoryboardSummary:r,isStoryboardSetup:o,isStoryboardEnding:m,startGame:v,newGame:fr,startNextRound:q,startDrawingPhase:l,endRound:$,continueToNextRound:K,endGame:F,startCountdown:ee,stopCountdown:s,startSummaryCountdown:S,stopSummaryCountdown:M,resetCountdown:i,setStoryboardPhase:ie,startStoryboardCountdown:vr,stopStoryboardCountdown:Ge,resetStoryboardCountdown:wr,enterStoryboardDrawingPhase:hr,enterStoryboardWritingPhase:_r,enterStoryboardVotingPhase:yr,enterStoryboardSummaryPhase:pr,enterStoryboardEndingPhase:Sr,getStoryboardPhaseDuration:Er,calculateWinningSentence:Ue,finalizeStoryboardRound:Rr,getCanvasElement:br,calculateScreenwriterWinScore:$e,calculateDirectorScore:We,calculateRatingBonus:Ve,calculateStoryboardRoundScores:Ir,updateStoryboardPlayerScore:fe,STORYBOARD_DRAWING_TIME:nr,STORYBOARD_WRITING_TIME:sr,STORYBOARD_VOTING_TIME:ar,STORYBOARD_SUMMARY_TIME:nt,SCREENWRITER_WIN_SCORE:Me,DIRECTOR_BASE_SCORE:qe,DIRECTOR_VOTE_BONUS:ke,RATING_BONUS_MULTIPLIER:ur}}const st=Object.freeze(Object.defineProperty({__proto__:null,useGame:mr},Symbol.toStringTag,{value:"Module"})),at={class:"waiting-lobby"},ut={class:"card"},ct={class:"card-body"},it={class:"room-info text-center margin-bottom-medium"},lt={class:"card-title text-hand-title"},dt={class:"room-details"},mt={class:"detail-item margin-bottom-small"},ft={class:"badge badge-secondary room-code-badge"},gt={class:"detail-row"},vt={class:"detail-item"},wt={class:"badge"},ht={class:"detail-item"},_t={class:"players-section margin-bottom-medium"},yt={class:"text-hand-title margin-bottom-small"},pt={class:"players-list"},St={class:"player-avatar"},Rt={class:"player-info"},bt={class:"player-name"},Et={key:0,class:"badge badge-warning"},It={class:"room-settings margin-bottom-medium"},Ct={class:"setting-item"},Gt={class:"setting-value"},Tt={class:"setting-item"},At={class:"setting-label"},xt={class:"setting-value"},Dt={key:0,class:"setting-item"},Pt={class:"setting-value"},Nt={class:"lobby-actions"},Mt=["disabled"],qt={key:1,class:"alert alert-warning text-center"},kt=["disabled"],Ot={key:0,class:"alert alert-danger margin-top-small"},Ht=ir({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:u}){const a=e,c=u,{isHost:N,canStartGame:E,minPlayersRequired:_,leaveRoom:W,loading:H,error:b}=et(),{startGame:p}=mr(),T=R(()=>{const f=a.room?.settings.rounds||0,t=a.participants.length,r=f>0?f:t;return r>0?r:1});function k(f){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[f||""]||f||"未知"}function P(f){return{classic:"傳統模式",storyboard:"分鏡接龍"}[f||""]||"傳統模式"}function B(f){return a.room?.host_id===f}async function Y(){(await p()).success&&c("startGame")}async function d(){(await W()).success&&c("leaveRoom")}return(f,t)=>(z(),j("div",at,[C("div",ut,[C("div",ct,[C("div",it,[C("h2",lt,Z(e.room?.name),1),C("div",dt,[C("div",mt,[t[0]||(t[0]=se(" 房間碼：",-1)),C("span",ft,Z(e.room?.code),1)]),C("div",gt,[C("div",vt,[t[1]||(t[1]=se(" 狀態：",-1)),C("span",wt,Z(k(e.room?.status)),1)]),C("div",ht,[t[2]||(t[2]=se(" 模式：",-1)),C("span",{class:Ke(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},Z(P(e.room?.game_mode)),3)])])])]),C("div",_t,[C("h4",yt,"玩家列表 ("+Z(e.participants.length)+")",1),C("div",pt,[(z(!0),j(Fe,null,Dr(e.participants,r=>(z(),j("div",{key:r.id,class:Ke(["player-item",{"is-host":B(r.user_id)}])},[C("div",St,Z(r.nickname.charAt(0).toUpperCase()),1),C("div",Rt,[C("div",bt,[se(Z(r.nickname)+" ",1),B(r.user_id)?(z(),j("span",Et," 房主 ")):Re("",!0)])])],2))),128))])]),C("div",It,[C("div",Ct,[t[4]||(t[4]=C("span",{class:"setting-label"},"繪畫時間：",-1)),C("span",Gt,[C("strong",null,Z(e.room?.settings.draw_time),1),t[3]||(t[3]=se("秒",-1))])]),C("div",Tt,[C("span",At,Z(e.room?.game_mode==="storyboard"?"每場鏡數":"每局輪數")+"：",1),C("span",xt,[C("strong",null,Z(T.value),1),se(Z(e.room?.game_mode==="storyboard"?"鏡":"輪"),1)])]),e.room?.game_mode!=="storyboard"?(z(),j("div",Dt,[t[6]||(t[6]=C("span",{class:"setting-label"},"詞語總數：",-1)),C("span",Pt,[C("strong",null,Z(e.room?.word_count),1),t[5]||(t[5]=se("個",-1))])])):Re("",!0)]),C("div",Nt,[ne(N)&&ne(E)?(z(),j("button",{key:0,disabled:ne(H),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:Y},Z(ne(H)?"開始中":"開始遊戲"),9,Mt)):ne(N)?(z(),j("div",qt,[se(" 至少需要 "+Z(ne(_))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(z(),j(Fe,{key:0},[se(" （分鏡接龍模式） ")],64)):Re("",!0)])):Re("",!0),C("button",{disabled:ne(H),class:"paper-btn btn-secondary btn-block",onClick:d},Z(ne(H)?"離開中":"離開房間"),9,kt)]),ne(b)?(z(),j("div",Ot,Z(ne(b)),1)):Re("",!0)])])]))}}),Wt=Pr(Ht,[["__scopeId","data-v-ec12b121"]]);export{Lt as I,Wt as W,ce as a,Ce as b,dr as c,lr as d,tt as e,Ut as f,mr as g,$t as i,et as u};
