import{k as K,r as T,f as h,u as Z,s as N,z as se,l as oe,d as ne,c as D,e as y,a as M,t as j,x as X,F as ae,m as ie,b as C,o as P,_ as ce}from"./index-2DM7Ir7C.js";const z=K("room",()=>{const e=T(null),m=T([]),i=T(!1),o=T(null),p=h(()=>{const n=Z();return e.value?.host_id===n.user?.id});async function v(n){try{i.value=!0,o.value=null;const r=Z();if(!r.user)throw new Error("請先登入");if(!r.profile){const f="https://sylsqdkkshkeicaxhisq.supabase.co",E="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5bHNxZGtrc2hrZWljYXhoaXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwOTAyNjgsImV4cCI6MjA4MDY2NjI2OH0.ZqcDaGIr4fCxGmgQm00zUdZei50HGs3Aa_SlWEPBA6A",c=r.session?.access_token||E,w=r.user,I={id:w.id,email:w.email||null,display_name:w.user_metadata?.full_name||w.user_metadata?.name||`訪客${Math.floor(Math.random()*1e4)}`,avatar_url:w.user_metadata?.avatar_url||w.user_metadata?.picture||null,user_type:w.is_anonymous?"anonymous":"registered"};try{const A=await fetch(`${f}/rest/v1/users`,{method:"POST",headers:{apikey:E,"Content-Type":"application/json",Prefer:"return=representation",Authorization:`Bearer ${c}`},body:JSON.stringify(I)});if(A.ok){const b=await A.json();r.profile=Array.isArray(b)?b[0]:b}else if(A.status===409||A.status===23505){const b=await fetch(`${f}/rest/v1/users?id=eq.${w.id}&select=*`,{method:"GET",headers:{apikey:E,Authorization:`Bearer ${c}`}});if(b.ok){const G=await b.json();r.profile=Array.isArray(G)?G[0]:G}}else{const b=await A.text();console.error("❌ 創建用戶資料失敗:",A.status,b)}}catch(A){console.error("創建用戶資料時發生錯誤:",A)}}if(n.words.length<6)throw new Error("至少需要 6 個詞語");if(n.settings.rounds>n.words.length)throw new Error("輪數不能超過詞語總數");let t=null,s=0;const d=10;for(;s<d&&!t;){s++;const f=Math.floor(1e5+Math.random()*9e5).toString(),E={code:f,name:n.name,host_id:r.user.id,words:n.words,word_count:n.words.length,status:"waiting",settings:n.settings,current_round:0,current_drawer_id:null},c=r.user?.id;if(!c)throw new Error("請先登入");E.host_id=c;const I=r.session?.access_token,A="https://sylsqdkkshkeicaxhisq.supabase.co",b="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5bHNxZGtrc2hrZWljYXhoaXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwOTAyNjgsImV4cCI6MjA4MDY2NjI2OH0.ZqcDaGIr4fCxGmgQm00zUdZei50HGs3Aa_SlWEPBA6A",G=`${A}/rest/v1/game_rooms`,H={apikey:b,"Content-Type":"application/json",Prefer:"return=representation"};I&&(H.Authorization=`Bearer ${I}`);const re=fetch(G,{method:"POST",headers:H,body:JSON.stringify(E)}),te=new Promise((O,q)=>{setTimeout(()=>q(new Error("插入房間超時（10 秒）")),1e4)});let J;try{J=await Promise.race([re,te])}catch(O){throw console.error("❌ 插入超時:",O),new Error("插入房間超時，請檢查網絡連接")}if(!J.ok){const O=await J.text();console.error("❌ 插入失敗:",{status:J.status,statusText:J.statusText,error:O});let q=`插入失敗: ${J.status}`;try{const W=JSON.parse(O);q=W.message||W.error_description||q}catch{q=O||q}throw new Error(q)}const B=await J.json(),U=Array.isArray(B)?B[0]:B;if(!U){console.error("❌ 插入成功但沒有返回數據");continue}if(U.code!==f){console.warn("⚠️ 返回的房間碼與請求的不一致，可能重複");try{await fetch(`${A}/rest/v1/game_rooms?id=eq.${U.id}`,{method:"DELETE",headers:{apikey:b,...I?{Authorization:`Bearer ${I}`}:{}}})}catch(O){console.error("刪除重複房間失敗:",O)}continue}t=U;break}if(!t)throw new Error("無法生成唯一房間碼，請重試");const _="https://sylsqdkkshkeicaxhisq.supabase.co",x="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5bHNxZGtrc2hrZWljYXhoaXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwOTAyNjgsImV4cCI6MjA4MDY2NjI2OH0.ZqcDaGIr4fCxGmgQm00zUdZei50HGs3Aa_SlWEPBA6A",k=r.session?.access_token||x,$={room_id:t.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const f=await fetch(`${_}/rest/v1/room_participants`,{method:"POST",headers:{apikey:x,"Content-Type":"application/json",Prefer:"return=representation",Authorization:`Bearer ${k}`},body:JSON.stringify($)});if(!f.ok){const E=await f.text();console.error("❌ 創建參與記錄錯誤:",f.status,E)}}catch(f){console.error("創建參與記錄時發生錯誤:",f)}try{const f=await fetch(`${_}/rest/v1/room_participants?room_id=eq.${t.id}&select=*&order=joined_at.asc`,{method:"GET",headers:{apikey:x,Authorization:`Bearer ${k}`}});if(f.ok){const E=await f.json();m.value=Array.isArray(E)?E:[E]}else console.error("載入參與者列表失敗:",f.status)}catch(f){console.error("載入參與者列表時發生錯誤:",f)}return e.value=t,{success:!0,room:t}}catch(r){return o.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:o.value}}finally{i.value=!1}}async function S(n,r){try{i.value=!0,o.value=null;const t=Z();if(!t.user)throw new Error("請先登入");if(!/^\d{6}$/.test(n))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:s,error:d}=await N.from("game_rooms").select("*").eq("code",n).single();if(d||!s)throw new Error("房間不存在");if(s.status!=="waiting")throw new Error("房間已開始或已結束");const{data:_}=await N.from("room_participants").select("*").eq("room_id",s.id).eq("user_id",t.user.id).single();if(_)return e.value=s,await g(s.id),{success:!0,room:s};const{error:x}=await N.from("room_participants").insert({room_id:s.id,user_id:t.user.id,nickname:r.trim(),score:0});if(x)throw x;return e.value=s,await g(s.id),{success:!0,room:s}}catch(t){return o.value=t instanceof Error?t.message:"加入房間失敗",console.error("加入房間錯誤:",t),{success:!1,error:o.value}}finally{i.value=!1}}async function R(){try{if(!e.value)return{success:!0};i.value=!0,o.value=null;const n=Z();if(!n.user)throw new Error("請先登入");const r="https://sylsqdkkshkeicaxhisq.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5bHNxZGtrc2hrZWljYXhoaXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwOTAyNjgsImV4cCI6MjA4MDY2NjI2OH0.ZqcDaGIr4fCxGmgQm00zUdZei50HGs3Aa_SlWEPBA6A",s=n.session?.access_token||t,d=`${r}/rest/v1/room_participants?room_id=eq.${e.value.id}&user_id=eq.${n.user.id}`,_=await fetch(d,{method:"DELETE",headers:{apikey:t,Authorization:`Bearer ${s}`}});if(!_.ok){const x=await _.text();throw new Error(`刪除參與記錄失敗: ${_.status} ${x||""}`)}if(p.value){const x=`${r}/rest/v1/game_rooms?id=eq.${e.value.id}`,k=await fetch(x,{method:"PATCH",headers:{apikey:t,"Content-Type":"application/json",Prefer:"return=representation",Authorization:`Bearer ${s}`},body:JSON.stringify({status:"finished"})});if(!k.ok){const $=await k.text();console.error("關閉房間失敗:",k.status,$||"未知錯誤")}}return e.value=null,m.value=[],{success:!0}}catch(n){return o.value=n instanceof Error?n.message:"離開房間失敗",console.error("離開房間錯誤:",n),e.value=null,m.value=[],{success:!1,error:o.value}}finally{i.value=!1}}async function g(n){try{const{data:r,error:t}=await N.from("room_participants").select("*").eq("room_id",n).order("joined_at",{ascending:!0});if(t)throw t;m.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function a(n){try{i.value=!0,o.value=null;const{data:r,error:t}=await N.from("game_rooms").select("*").eq("id",n).single();if(t)throw t;return e.value=r,await g(n),{success:!0,room:r}}catch(r){return o.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:o.value}}finally{i.value=!1}}async function u(n){try{if(!e.value)throw new Error("沒有當前房間");const{error:r}=await N.from("game_rooms").update({status:n}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.status=n),{success:!0}}catch(r){return o.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:o.value}}}function l(){e.value=null,m.value=[],o.value=null}return{currentRoom:e,participants:m,loading:i,error:o,isHost:p,createRoom:v,joinRoom:S,leaveRoom:R,loadParticipants:g,loadRoom:a,updateRoomStatus:u,clearRoom:l}});function ue(){const e=z(),m=h(()=>e.currentRoom),i=h(()=>e.participants),o=h(()=>e.isHost),p=h(()=>!m.value||m.value.status!=="waiting"||!o.value?!1:i.value.length>=2);async function v(g){return await e.createRoom(g)}async function S(g,a){return await e.joinRoom(g,a)}async function R(){return await e.leaveRoom()}return{currentRoom:m,participants:i,isHost:o,canStartGame:p,loading:h(()=>e.loading),error:h(()=>e.error),createRoom:v,joinRoom:S,leaveRoom:R}}const le=K("game",()=>{const e=z(),m=Z(),i=T(null),o=T(null),p=T([]),v=h(()=>p.value.filter(r=>r.is_correct));async function S(r){try{const{data:t,error:s}=await N.from("game_rounds").select("*").eq("room_id",r).order("round_number",{ascending:!1}).limit(1).single();if(s&&s.code!=="PGRST116")throw s;return t&&(i.value=t,o.value=t.word_text,await R(t.id)),{success:!0,round:t}}catch(t){return console.error("載入當前輪次錯誤:",t),{success:!1,error:t instanceof Error?t.message:"載入輪次失敗"}}}async function R(r){try{const{data:t,error:s}=await N.from("guesses").select("*").eq("round_id",r).order("guessed_at",{ascending:!0});if(s)throw s;p.value=t||[]}catch(t){console.error("載入猜測記錄錯誤:",t)}}async function g(r,t,s,d){try{if(!e.currentRoom)throw new Error("沒有當前房間");const _=(e.currentRoom.current_round||0)+1,{data:x,error:k}=await N.from("game_rounds").insert({room_id:r,round_number:_,drawer_id:t,word_text:s,word_source:d}).select().single();if(k)throw k;return i.value=x,o.value=s,p.value=[],await N.from("game_rooms").update({current_round:_,current_drawer_id:t}).eq("id",r),{success:!0,round:x}}catch(_){return console.error("創建輪次錯誤:",_),{success:!1,error:_ instanceof Error?_.message:"創建輪次失敗"}}}function a(r){return p.value.some(t=>t.user_id===r&&t.is_correct)}const u=h(()=>!i.value||!m.user?!1:i.value.drawer_id===m.user.id);async function l(){if(!i.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const r=v.value.length,{useScoring:t}=await se(async()=>{const{useScoring:_}=await Promise.resolve().then(()=>de);return{useScoring:_}},void 0),{updateDrawerScore:s}=t();await s(i.value.drawer_id,r);const{error:d}=await N.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",i.value.id);if(d)throw d;return{success:!0}}catch(r){return console.error("結束輪次錯誤:",r),{success:!1,error:r instanceof Error?r.message:"結束輪次失敗"}}}function n(){i.value=null,o.value=null,p.value=[]}return{currentRound:i,currentWord:o,guesses:p,correctGuesses:v,isCurrentDrawer:u,loadCurrentRound:S,loadGuesses:R,createRound:g,hasGuessed:a,endRound:l,clearGame:n}}),Y=100,L=50,V=10,F=100,Q=[1,.8,.6,.4,.2];function ee(){const e=z();function m(a){const u=Math.min(a,Q.length-1),l=Q[u]??0;return Math.round(Y*l)}function i(a){return a===0?0:L+a*V}async function o(a,u){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:l,error:n}=await N.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",a).single();if(n)throw n;const r=(l?.score||0)+u,{error:t}=await N.from("room_participants").update({score:r}).eq("room_id",e.currentRoom.id).eq("user_id",a);if(t)throw t;const s=e.participants.findIndex(d=>d.user_id===a);return s!==-1&&e.participants[s]&&(e.participants[s].score=r),!0}catch(l){return console.error("更新玩家分數錯誤:",l),!1}}async function p(a,u){const l=i(u);return l===0?!0:await o(a,l)}function v(){if(!e.participants||e.participants.length===0)return null;const a=[...e.participants].sort((u,l)=>l.score-u.score);return a.length===1||a[0]&&a[1]&&a[0].score>a[1].score?{user_id:a[0]?.user_id||"",score:a[0]?.score||0}:{user_id:a[0]?.user_id||"",score:a[0]?.score||0}}const S=h(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((u,l)=>l.score!==u.score?l.score-u.score:new Date(u.joined_at).getTime()-new Date(l.joined_at).getTime()).map((u,l)=>({id:u.id,user_id:u.user_id,score:u.score,rank:l+1}))),R=h(()=>e.currentRoom?.status!=="finished"?null:v());function g(){return F}return{GUESS_BASE_SCORE:Y,DRAWING_BASE_SCORE:L,DRAWING_BONUS_PER_GUESS:V,WINNER_BONUS:F,calculateGuessScore:m,calculateDrawingScore:i,calculateWinner:v,updatePlayerScore:o,updateDrawerScore:p,playerRankings:S,winner:R,getWinnerBonus:g}}const de=Object.freeze(Object.defineProperty({__proto__:null,useScoring:ee},Symbol.toStringTag,{value:"Module"}));function me(){const e=z(),m=le(),{updateDrawerScore:i}=ee(),o=T(null),p=T(!1);let v=null;const S=h(()=>e.currentRoom?.status||"waiting"),R=h(()=>S.value==="playing"),g=h(()=>S.value==="waiting"),a=h(()=>S.value==="finished"),u=h(()=>m.currentRound),l=h(()=>e.currentRoom?.current_round||0),n=h(()=>e.currentRoom?.settings.rounds||0),r=h(()=>e.currentRoom?.settings.draw_time||60),t=h(()=>m.isCurrentDrawer);function s(c){v&&clearInterval(v),o.value=c,p.value=!0,v=window.setInterval(()=>{o.value!==null&&o.value>0?o.value--:(d(),R.value&&u.value&&$())},1e3)}function d(){v&&(clearInterval(v),v=null),p.value=!1}function _(){d(),o.value=null}async function x(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const c=await e.updateRoomStatus("playing");return c.success?await k():c}catch(c){return console.error("開始遊戲錯誤:",c),{success:!1,error:c instanceof Error?c.message:"開始遊戲失敗"}}}async function k(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const c=e.currentRoom.words,w=e.currentRoom.current_round||0;if(w>=c.length||w>=n.value)return await f(),{success:!1,error:"所有輪次已完成"};try{const I=c[w],A=w%e.participants.length,b=e.participants[A];if(!b||!I)throw new Error("無法選擇畫家或詞語");const G=await m.createRound(e.currentRoom.id,b.user_id,I.text,I.source);return G.success&&G.round&&s(r.value),G}catch(I){return console.error("開始下一輪錯誤:",I),{success:!1,error:I instanceof Error?I.message:"開始下一輪失敗"}}}async function $(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{d();const c=m.correctGuesses.length;await i(u.value.drawer_id,c);const w=await m.endRound();return w.success?(e.currentRoom.current_round||0)>=n.value?(await f(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await k()},2e3),{success:!0,gameEnded:!1}):w}catch(c){return console.error("結束輪次錯誤:",c),{success:!1,error:c instanceof Error?c.message:"結束輪次失敗"}}}async function f(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return d(),await e.updateRoomStatus("finished"),{success:!0}}catch(c){return console.error("結束遊戲錯誤:",c),{success:!1,error:c instanceof Error?c.message:"結束遊戲失敗"}}}const E=h(()=>{if(o.value===null)return"--:--";const c=Math.floor(o.value/60),w=o.value%60;return`${c.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`});return oe(()=>{d()}),{gameStatus:S,isPlaying:R,isWaiting:g,isFinished:a,currentRound:u,currentRoundNumber:l,totalRounds:n,drawTime:r,isCurrentDrawer:t,timeRemaining:o,isCountingDown:p,formattedTime:E,startGame:x,startNextRound:k,endRound:$,endGame:f,startCountdown:s,stopCountdown:d,resetCountdown:_}}const fe={class:"waiting-lobby"},he={class:"card-minimal"},pe={class:"mb-6"},we={class:"text-xl font-light text-text-primary mb-2"},_e={class:"text-sm text-text-secondary"},ye={class:"font-mono text-text-primary"},ve={class:"text-sm text-text-secondary mt-1"},ge={class:"text-text-primary"},Re={class:"mb-6"},xe={class:"text-sm font-medium text-text-primary mb-3"},Ie={class:"space-y-2"},Se={class:"w-8 h-8 rounded-full bg-bg-secondary border-thin border-border-light flex items-center justify-center text-text-secondary text-sm"},Ee={class:"flex-1"},be={class:"text-sm text-text-primary"},ke={key:0,class:"text-xs text-text-secondary ml-2"},Ae={class:"mb-6 text-sm text-text-secondary"},Ne={class:"space-y-3"},je=["disabled"],Ge={key:1,class:"text-sm text-text-secondary text-center"},Ce=["disabled"],Te={key:0,class:"mt-4 text-sm text-red-600 bg-red-50 p-2 rounded-minimal border-thin border-red-200"},Oe=ne({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:m}){const i=e,o=m,{isHost:p,canStartGame:v,leaveRoom:S,loading:R,error:g}=ue(),{startGame:a}=me();function u(t){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[t||""]||t||"未知"}function l(t){return i.room?.host_id===t}async function n(){(await a()).success&&o("startGame")}async function r(){(await S()).success&&o("leaveRoom")}return(t,s)=>(P(),D("div",fe,[y("div",he,[y("div",pe,[y("h2",we,j(e.room?.name),1),y("div",_e,[s[0]||(s[0]=X(" 房間碼：",-1)),y("span",ye,j(e.room?.code),1)]),y("div",ve,[s[1]||(s[1]=X(" 狀態：",-1)),y("span",ge,j(u(e.room?.status)),1)])]),y("div",Re,[y("h3",xe," 玩家列表 ("+j(e.participants.length)+") ",1),y("div",Ie,[(P(!0),D(ae,null,ie(e.participants,d=>(P(),D("div",{key:d.id,class:"flex items-center gap-3 p-2 rounded-minimal border-thin border-border-light"},[y("div",Se,j(d.nickname.charAt(0)),1),y("div",Ee,[y("div",be,[X(j(d.nickname)+" ",1),l(d.user_id)?(P(),D("span",ke," (房主) ")):M("",!0)])])]))),128))])]),y("div",Ae,[y("div",null,"繪畫時間："+j(e.room?.settings.draw_time)+" 秒",1),y("div",null,"輪數："+j(e.room?.settings.rounds)+" 輪",1),y("div",null,"詞語總數："+j(e.room?.word_count)+" 個",1)]),y("div",Ne,[C(p)&&C(v)?(P(),D("button",{key:0,onClick:n,disabled:C(R),class:"btn-minimal w-full"},j(C(R)?"開始中...":"開始遊戲"),9,je)):C(p)?(P(),D("div",Ge," 至少需要 2 個玩家才能開始遊戲 ")):M("",!0),y("button",{onClick:r,disabled:C(R),class:"btn-minimal w-full"},j(C(R)?"離開中...":"離開房間"),9,Ce)]),C(g)?(P(),D("div",Te,j(C(g)),1)):M("",!0)])]))}}),qe=ce(Oe,[["__scopeId","data-v-501d8817"]]);export{qe as W,me as a,z as b,le as c,ee as d,ue as u};
