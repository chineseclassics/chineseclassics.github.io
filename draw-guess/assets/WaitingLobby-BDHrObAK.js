import{d as we,f as h,m as re,c as H,o as O,n as Re,a as se,e as v,p as ye,q as ve,r as x,u as Q,B as y,H as Se,s as be,t as B,k as F,F as Ee,y as Ce,b as U,x as Ge,_ as Ae}from"./index-CPAvdvPl.js";const ke=["width","height","fill","transform"],Me={key:0},Ne=v("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),Ie=[Ne],Te={key:1},De=v("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),qe=v("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),xe=[De,qe],He={key:2},Oe=v("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Pe=[Oe],Be={key:3},Ze=v("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Ue=[Ze],$e={key:4},je=v("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),We=[je],Le={key:5},ze=v("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Ve=[ze],Fe={name:"PhPaintBrush"},Nr=we({...Fe,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const m=e,c=re("weight","regular"),i=re("size","1em"),_=re("color","currentColor"),M=re("mirrored",!1),G=h(()=>m.weight??c),I=h(()=>m.size??i),b=h(()=>m.color??_),d=h(()=>m.mirrored!==void 0?m.mirrored?"scale(-1, 1)":void 0:M?"scale(-1, 1)":void 0);return(f,p)=>(O(),H("svg",ye({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:I.value,height:I.value,fill:b.value,transform:d.value},f.$attrs),[Re(f.$slots,"default"),G.value==="bold"?(O(),H("g",Me,Ie)):G.value==="duotone"?(O(),H("g",Te,xe)):G.value==="fill"?(O(),H("g",He,Pe)):G.value==="light"?(O(),H("g",Be,Ue)):G.value==="regular"?(O(),H("g",$e,We)):G.value==="thin"?(O(),H("g",Le,Ve)):se("",!0)],16,ke))}}),ee=ve("room",()=>{const e=x(null),m=x([]),c=x(!1),i=x(null),_=h(()=>{const r=Q();return e.value?.host_id===r.user?.id});async function M(r){try{c.value=!0,i.value=null;const t=Q();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(u){console.warn("載入用戶資料時發生錯誤（非關鍵）:",u)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");if(r.settings.rounds>r.words.length)throw new Error("輪數不能超過詞語總數");let n=null,s=0;const w=10;for(;s<w&&!n;){s++;const D={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:g,error:E}=await y.from("game_rooms").insert(D).select().single();if(E){if(E.code==="23505")continue;throw new Error(E.message||"插入房間失敗")}if(g){n=g;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const T={room_id:n.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:u}=await y.from("room_participants").insert(T);u&&console.error("創建參與記錄錯誤:",u)}catch(u){console.error("創建參與記錄時發生錯誤:",u)}try{const{data:u,error:D}=await y.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});D?console.error("載入參與者列表失敗:",D):u&&(m.value=u)}catch(u){console.error("載入參與者列表時發生錯誤:",u)}return e.value=n,{success:!0,room:n}}catch(t){return i.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:i.value}}finally{c.value=!1}}async function G(r,t){try{c.value=!0,i.value=null;const n=Q();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:s,error:w}=await y.from("game_rooms").select("*").eq("code",r).single();if(w||!s)throw new Error("房間不存在");if(s.status!=="waiting")throw new Error("房間已開始或已結束");const{data:T}=await y.from("room_participants").select("*").eq("room_id",s.id).eq("user_id",n.user.id).maybeSingle();if(T)return e.value=s,await b(s.id),{success:!0,room:s};const{error:u}=await y.from("room_participants").insert({room_id:s.id,user_id:n.user.id,nickname:t.trim(),score:0});if(u){if(u.code==="23505"||u.message.includes("duplicate"))return e.value=s,await b(s.id),{success:!0,room:s};throw u}return e.value=s,await b(s.id),{success:!0,room:s}}catch(n){return i.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:i.value}}finally{c.value=!1}}async function I(){try{if(!e.value)return{success:!0};c.value=!0,i.value=null;const r=Q();if(!r.user)throw new Error("請先登入");const{error:t}=await y.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(_.value){const{error:n}=await y.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,m.value=[],{success:!0}}catch(r){return i.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,m.value=[],{success:!1,error:i.value}}finally{c.value=!1}}async function b(r){try{const{data:t,error:n}=await y.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(n)throw n;m.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function d(r){try{c.value=!0,i.value=null;const{data:t,error:n}=await y.from("game_rooms").select("*").eq("id",r).single();if(n)throw n;return e.value=t,await b(r),{success:!0,room:t}}catch(t){return i.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:i.value}}finally{c.value=!1}}async function f(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await y.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(e.value){const n=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(t){return i.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:i.value}}}async function p(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await y.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return i.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:i.value}}}function N(){e.value=null,m.value=[],i.value=null}function P(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function A(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!_.value)return{success:!1,error:"只有房主可以踢人"};const t=Q();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};c.value=!0,i.value=null;const{data:n,error:s}=await y.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(s)throw new Error(s.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await b(e.value.id),{success:!0}}catch(t){return i.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:i.value}}finally{c.value=!1}}return{currentRoom:e,participants:m,loading:c,error:i,isHost:_,createRoom:M,joinRoom:G,leaveRoom:I,kickPlayer:A,loadParticipants:b,loadRoom:d,updateRoomStatus:f,updateRoomDrawer:p,setCurrentDrawer:P,clearRoom:N}});function Ke(){const e=ee(),m=h(()=>e.currentRoom),c=h(()=>e.participants),i=h(()=>e.isHost),_=h(()=>!m.value||m.value.status!=="waiting"||!i.value?!1:c.value.length>=2);async function M(b){return await e.createRoom(b)}async function G(b,d){return await e.joinRoom(b,d)}async function I(){return await e.leaveRoom()}return{currentRoom:m,participants:c,isHost:i,canStartGame:_,loading:h(()=>e.loading),error:h(()=>e.error),createRoom:M,joinRoom:G,leaveRoom:I}}const ue=100,le=50,de=10,Je=10,me=100,fe=[1,.8,.6,.4,.2];function Ye(){const e=ee();function m(d){const f=Math.min(d,fe.length-1),p=fe[f]??0;return Math.round(ue*p)}function c(d,f=0){if(d===0)return 0;const p=d*de,N=Math.round(f*Je);return le+p+N}async function i(d,f,p=0){const N=c(f,p);return N===0?!0:await _(d,N)}async function _(d,f){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:p,error:N}=await y.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",d).single();if(N)throw N;const P=(p?.score||0)+f,{error:A}=await y.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",d);if(A)throw A;const r=e.participants.findIndex(t=>t.user_id===d);return r!==-1&&e.participants[r]&&(e.participants[r].score=P),!0}catch(p){return console.error("更新玩家分數錯誤:",p),!1}}function M(){if(!e.participants||e.participants.length===0)return null;const d=[...e.participants].sort((f,p)=>p.score-f.score);return d.length===1||d[0]&&d[1]&&d[0].score>d[1].score?{user_id:d[0]?.user_id||"",score:d[0]?.score||0}:{user_id:d[0]?.user_id||"",score:d[0]?.score||0}}const G=h(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((f,p)=>p.score!==f.score?p.score-f.score:new Date(f.joined_at).getTime()-new Date(p.joined_at).getTime()).map((f,p)=>({id:f.id,user_id:f.user_id,score:f.score,rank:p+1}))),I=h(()=>e.currentRoom?.status!=="finished"?null:M());function b(){return me}return{GUESS_BASE_SCORE:ue,DRAWING_BASE_SCORE:le,DRAWING_BONUS_PER_GUESS:de,WINNER_BONUS:me,calculateGuessScore:m,calculateDrawingScore:c,calculateWinner:M,updatePlayerScore:_,updateDrawerScore:i,playerRankings:G,winner:I,getWinnerBonus:b}}const he=ve("game",()=>{const e=ee(),m=Q(),c=x(null),i=x(null),_=x([]),M=h(()=>_.value.filter(l=>l.is_correct)),G=h(()=>c.value?_.value.filter(l=>l.round_id===c.value.id):[]),I=h(()=>G.value.filter(l=>l.is_correct)),b=x("drawing"),d=x([]),f=x([]),p=h(()=>f.value.length===0?0:f.value.reduce((o,R)=>o+R.rating,0)/f.value.length);function N(l){b.value=l}function P(l){d.value=l}function A(l){const o=f.value.findIndex(R=>R.rater_id===l.rater_id);o>=0?f.value[o]=l:f.value.push(l)}function r(){f.value=[]}async function t(l){try{const{data:o,error:R}=await y.from("game_rounds").select("*").eq("room_id",l).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(R)throw R;return o&&(c.value=o,i.value=o.word_text,o.word_options&&Array.isArray(o.word_options)&&(d.value=o.word_options),await n(o.id)),{success:!0,round:o}}catch(o){return console.error("載入當前輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入輪次失敗"}}}async function n(l){try{const{data:o,error:R}=await y.from("guesses").select("*").eq("round_id",l).order("guessed_at",{ascending:!0});if(R)throw R;const S=o||[],a=new Set(_.value.map(k=>k.id)),C=S.filter(k=>!a.has(k.id));C.length>0&&(_.value=[..._.value,...C])}catch(o){console.error("載入猜測記錄錯誤:",o)}}async function s(l){try{const{data:o,error:R}=await y.from("game_rounds").select("id").eq("room_id",l);if(R)throw R;if(!o||o.length===0){_.value=[];return}const S=o.map(k=>k.id),{data:a,error:C}=await y.from("guesses").select("*").in("round_id",S).order("guessed_at",{ascending:!0});if(C)throw C;_.value=a||[]}catch(o){console.error("載入所有猜測記錄錯誤:",o)}}async function w(l,o,R,S){try{if(!e.currentRoom)throw new Error("沒有當前房間");const a=(e.currentRoom.current_round||0)+1,{data:C,error:k}=await y.from("game_rounds").insert({room_id:l,round_number:a,drawer_id:o,word_text:R,word_source:S}).select().single();if(k)throw k;return c.value=C,i.value=R,await y.from("game_rooms").update({current_round:a,current_drawer_id:o}).eq("id",l),{success:!0,round:C}}catch(a){return console.error("創建輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"創建輪次失敗"}}}function T(l){return c.value?_.value.some(o=>o.round_id===c.value.id&&o.user_id===l&&o.is_correct):!1}const u=h(()=>!c.value||!m.user?!1:c.value.drawer_id===m.user.id);async function D(){if(!c.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const l=M.value.length,o=p.value,{updateDrawerScore:R}=Ye();console.log("[endRound] 猜中人數:",l,"平均評分:",o),await R(c.value.drawer_id,l,o);const{error:S}=await y.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",c.value.id);if(S)throw S;return{success:!0}}catch(l){return console.error("結束輪次錯誤:",l),{success:!1,error:l instanceof Error?l.message:"結束輪次失敗"}}}function g(){c.value=null,i.value=null,_.value=[],b.value="drawing",d.value=[],f.value=[]}async function E(l,o,R){if(!m.user)return{success:!1,error:"用戶未登錄"};try{const{data:S,error:a}=await y.from("drawing_ratings").upsert({round_id:l,rater_id:m.user.id,drawer_id:o,rating:R},{onConflict:"round_id,rater_id"}).select().single();if(a)throw a;return S&&A(S),{success:!0,rating:S}}catch(S){return console.error("提交評分錯誤:",S),{success:!1,error:S instanceof Error?S.message:"提交評分失敗"}}}async function W(l){try{const{data:o,error:R}=await y.from("drawing_ratings").select("*").eq("round_id",l);if(R)throw R;return f.value=o||[],{success:!0,ratings:o}}catch(o){return console.error("載入評分錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入評分失敗"}}}return{currentRound:c,currentWord:i,guesses:_,correctGuesses:M,currentRoundGuesses:G,currentRoundCorrectGuesses:I,isCurrentDrawer:u,roundStatus:b,wordOptions:d,ratings:f,averageRating:p,loadCurrentRound:t,loadGuesses:n,loadAllGuesses:s,createRound:w,hasGuessed:T,endRound:D,clearGame:g,setRoundStatus:N,setWordOptions:P,addRating:A,clearRatings:r,submitRating:E,loadRatings:W}}),$=new Map,j=x("disconnected"),L=new Map,te=new Set,ne=new Map;function z(...e){}function Z(...e){console.warn("[Realtime]",...e)}function ce(){const e=ee(),m=he();function c(r){const t=`room:${r}`;if($.has(t))return $.get(t);const n=y.channel(t,{config:{presence:{key:"user"},broadcast:{self:!0}}});return $.set(t,n),n}function i(r){const t=ne.get(r);t&&(clearTimeout(t),ne.delete(r))}function _(r,t,n,s,w){r==="SUBSCRIBED"?(j.value="connected",i(n),t.track({user_id:s,...w}).catch(T=>{Z("Presence track 失敗:",T)})):r==="CHANNEL_ERROR"||r==="TIMED_OUT"?(j.value="disconnected",Z("訂閱失敗:",r),M(n,s,w)):r==="CLOSED"&&(j.value="disconnected")}function M(r,t,n,s=0){if(s>=3){Z("重連失敗次數過多，停止重連");return}i(r);const w=Math.min(1e3*Math.pow(2,s),1e4),T=window.setTimeout(()=>{const u=$.get(`room:${r}`);u&&u.state!=="joined"&&u.subscribe(D=>{D==="SUBSCRIBED"?_(D,u,r,t,n):(D==="CHANNEL_ERROR"||D==="TIMED_OUT")&&M(r,t,n,s+1)})},w);ne.set(r,T)}function G(r,t,n,s){return new Promise((w,T)=>{if(!r||!t){Z("缺少 roomCode 或 roomId"),T(new Error("缺少 roomCode 或 roomId"));return}const u=c(r),D=u.state;if(D==="joined"){j.value="connected",w(u);return}if(D==="joining"){const g=setInterval(()=>{const E=u.state;E==="joined"?(clearInterval(g),w(u)):(E==="closed"||E==="errored")&&(clearInterval(g),T(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(g),u.state!=="joined"&&T(new Error("連接超時"))},5e3);return}if(te.has(r)){j.value="connecting",u.subscribe(g=>{_(g,u,r,n,s),g==="SUBSCRIBED"?w(u):(g==="CHANNEL_ERROR"||g==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${g}`))});return}u.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async g=>{z("房間狀態變化:",g.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async g=>{z("參與者變化:",g.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async g=>{z("輪次變化:",g.eventType,g.new),e.currentRoom&&await m.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async g=>{const E=g.new;if(E&&m.currentRound&&(await m.loadGuesses(E.round_id),E.is_correct&&e.isHost&&m.roundStatus==="drawing")){const W=m.currentRound.drawer_id,l=e.participants.filter(S=>S.user_id!==W),o=new Set(m.currentRoundCorrectGuesses.map(S=>S.user_id));if(l.length>0&&l.every(S=>o.has(S.user_id))){const{useGame:S}=await Se(async()=>{const{useGame:C}=await Promise.resolve().then(()=>Qe);return{useGame:C}},void 0),{endRound:a}=S();await a()}}}).on("broadcast",{event:"drawing"},g=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(g));const E=L.get(r);E&&g.payload?.stroke?(console.log("[Realtime] 分發給",E.size,"個回調"),E.forEach(W=>W(g.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",E?.size,"stroke:",g.payload?.stroke)}).on("presence",{event:"sync"},()=>{const g=u.presenceState();z("Presence 同步，在線:",Object.keys(g).length)}),te.add(r),j.value="connecting",u.subscribe(g=>{_(g,u,r,n,s),g==="SUBSCRIBED"?w(u):(g==="CHANNEL_ERROR"||g==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${g}`))})})}function I(r,t){return L.has(r)||L.set(r,new Set),L.get(r).add(t),()=>{L.get(r)?.delete(t)}}function b(r,t){const n=c(r),s=`guesses:${t}`;return n[s]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${t}`},async w=>{z("收到新猜測記錄:",w.eventType,w.new),await m.loadGuesses(t)}),n[s]=!0),n}function d(r,t){const n=c(r),s=`gameState:${r}`;return n[s]||(n.on("broadcast",{event:"game_state"},w=>{z("收到遊戲狀態廣播:",w.payload),t(w.payload)}),n[s]=!0),n}async function f(r,t){const n=c(r),s=n.state;if(s!=="joined")return Z("Channel 未連接，狀態:",s,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{z("廣播遊戲狀態:",t);const w=await n.send({type:"broadcast",event:"game_state",payload:t});return w==="error"?(Z("發送遊戲狀態失敗"),{error:"發送失敗"}):w}catch(w){return Z("發送遊戲狀態錯誤:",w),{error:w instanceof Error?w.message:"發送失敗"}}}async function p(r,t){const n=c(r),s=n.state;if(s!=="joined")return Z("Channel 未連接，無法發送繪畫數據，狀態:",s),{error:"Channel 未連接"};try{const w=await n.send({type:"broadcast",event:"drawing",payload:{stroke:t}});return w==="error"?(Z("發送失敗"),{error:"發送失敗"}):w}catch(w){return Z("發送錯誤:",w),{error:w instanceof Error?w.message:"發送失敗"}}}function N(r){const t=`room:${r}`,n=$.get(t);i(r),n&&(y.removeChannel(n),$.delete(t)),L.delete(r),te.delete(r)}function P(){ne.forEach((r,t)=>i(t)),$.forEach(r=>y.removeChannel(r)),$.clear(),L.clear(),te.clear()}function A(){return j.value}return{connectionStatus:j,subscribeRoom:G,subscribeDrawing:I,subscribeGuesses:b,subscribeGameState:d,sendDrawing:p,broadcastGameState:f,unsubscribeRoom:N,unsubscribeAll:P,getConnectionStatus:A}}const ge=6,K=x(null),ie=x(!1);let J=null;const V=x(null);let Y=null;const oe=x(new Set);function _e(){const e=ee(),m=he();ce();const c=K,i=ie,_=V,M=h(()=>e.currentRoom?.status||"waiting"),G=h(()=>M.value==="playing"),I=h(()=>M.value==="waiting"),b=h(()=>M.value==="finished"),d=h(()=>m.roundStatus),f=h(()=>d.value==="drawing"),p=h(()=>d.value==="summary"),N=h(()=>m.currentRound),P=h(()=>e.currentRoom?.current_round||0),A=h(()=>e.currentRoom?.settings.rounds||0),r=h(()=>e.currentRoom?.settings.draw_time||60),t=h(()=>m.isCurrentDrawer);function n(a){console.log("[useGame] startCountdown 開始，時長:",a,"秒"),J&&clearInterval(J),K.value=a,ie.value=!0,J=window.setInterval(()=>{K.value!==null&&K.value>0?K.value--:(s(),G.value&&N.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),l()))},1e3)}function s(){J&&(clearInterval(J),J=null),ie.value=!1}function w(){s(),K.value=null}function T(){console.log("[useGame] startSummaryCountdown 開始"),Y&&clearInterval(Y),V.value=ge,console.log("[useGame] 開始總結倒計時:",ge,"秒"),Y=window.setInterval(async()=>{V.value!==null&&V.value>0?(V.value--,console.log("[useGame] 總結倒計時:",V.value)):(u(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await o()))},1e3)}function u(){console.log("[useGame] stopSummaryCountdown"),Y&&(clearInterval(Y),Y=null),V.value=null}function D(){if(!e.currentRoom)return null;const a=e.currentRoom.words;if(a.length===0)return null;const C=[];for(let q=0;q<a.length;q++)oe.value.has(q)||C.push(q);let k=0;if(C.length>0){const q=Math.floor(Math.random()*C.length);k=C[q]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),oe.value.clear(),k=Math.floor(Math.random()*a.length);return oe.value.add(k),a[k]??null}async function g(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{oe.value.clear();const a=await e.updateRoomStatus("playing");return a.success?await E():a}catch(a){return console.error("開始遊戲錯誤:",a),{success:!1,error:a instanceof Error?a.message:"開始遊戲失敗"}}}async function E(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const a=e.currentRoom.current_round||0,C=a+1;if(a>=A.value)return await R(),{success:!1,error:"所有輪次已完成"};try{const k=(C-1)%e.participants.length,q=e.participants[k];if(console.log("[startDrawingPhase] 第",C,"輪，畫家:",q?.nickname),!q)throw new Error("無法選擇畫家");const X=D();if(!X)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",X.text),await e.updateRoomDrawer(q.user_id);const ae=await m.createRound(e.currentRoom.id,q.user_id,X.text,X.source);if(!ae.success||!ae.round)throw new Error("創建輪次失敗");const{broadcastGameState:pe}=ce();return await pe(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:q.user_id,drawerName:q.nickname,roundNumber:C,startedAt:ae.round.started_at}),{success:!0,drawerId:q.user_id,word:X.text}}catch(k){return console.error("開始繪畫階段錯誤:",k),{success:!1,error:k instanceof Error?k.message:"開始繪畫階段失敗"}}}async function W(){return await E()}async function l(){if(!N.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const a=await m.endRound();if(!a.success)return a;const k=(e.currentRoom.current_round||0)>=A.value,{broadcastGameState:q}=ce();return await q(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:k}),{success:!0,gameEnded:k}}catch(a){return console.error("結束輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"結束輪次失敗"}}}async function o(){return e.currentRoom?e.isHost?(e.currentRoom.current_round||0)>=A.value?(await R(),{success:!0,gameEnded:!0}):(await E(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function R(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return s(),await e.updateRoomStatus("finished"),{success:!0}}catch(a){return console.error("結束遊戲錯誤:",a),{success:!1,error:a instanceof Error?a.message:"結束遊戲失敗"}}}const S=h(()=>{if(c.value===null)return"--:--";const a=Math.floor(c.value/60),C=c.value%60;return`${a.toString().padStart(2,"0")}:${C.toString().padStart(2,"0")}`});return be(()=>{s(),u()}),{gameStatus:M,isPlaying:G,isWaiting:I,isFinished:b,currentRound:N,currentRoundNumber:P,totalRounds:A,drawTime:r,isCurrentDrawer:t,timeRemaining:c,isCountingDown:i,formattedTime:S,roundStatus:d,isDrawing:f,isSummary:p,summaryTimeRemaining:_,startGame:g,startNextRound:W,startDrawingPhase:E,endRound:l,continueToNextRound:o,endGame:R,startCountdown:n,stopCountdown:s,startSummaryCountdown:T,stopSummaryCountdown:u,resetCountdown:w}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,useGame:_e},Symbol.toStringTag,{value:"Module"})),Xe={class:"waiting-lobby"},er={class:"card"},rr={class:"card-body"},tr={class:"room-info text-center margin-bottom-medium"},nr={class:"card-title text-hand-title"},or={class:"room-details"},sr={class:"detail-item margin-bottom-small"},ar={class:"badge badge-secondary room-code-badge"},cr={class:"detail-item"},ir={class:"badge"},ur={class:"players-section margin-bottom-medium"},lr={class:"text-hand-title margin-bottom-small"},dr={class:"players-list"},mr={class:"player-avatar"},fr={class:"player-info"},gr={class:"player-name"},wr={key:0,class:"badge badge-warning"},vr={class:"room-settings margin-bottom-medium"},hr={class:"setting-item"},_r={class:"setting-value"},pr={class:"setting-item"},Rr={class:"setting-value"},yr={class:"setting-item"},Sr={class:"setting-value"},br={class:"lobby-actions"},Er=["disabled"],Cr={key:1,class:"alert alert-warning text-center"},Gr=["disabled"],Ar={key:0,class:"alert alert-danger margin-top-small"},kr=we({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:m}){const c=e,i=m,{isHost:_,canStartGame:M,leaveRoom:G,loading:I,error:b}=Ke(),{startGame:d}=_e();function f(A){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[A||""]||A||"未知"}function p(A){return c.room?.host_id===A}async function N(){(await d()).success&&i("startGame")}async function P(){(await G()).success&&i("leaveRoom")}return(A,r)=>(O(),H("div",Xe,[v("div",er,[v("div",rr,[v("div",tr,[v("h2",nr,B(e.room?.name),1),v("div",or,[v("div",sr,[r[0]||(r[0]=F(" 房間碼：",-1)),v("span",ar,B(e.room?.code),1)]),v("div",cr,[r[1]||(r[1]=F(" 狀態：",-1)),v("span",ir,B(f(e.room?.status)),1)])])]),v("div",ur,[v("h4",lr,"玩家列表 ("+B(e.participants.length)+")",1),v("div",dr,[(O(!0),H(Ee,null,Ce(e.participants,t=>(O(),H("div",{key:t.id,class:Ge(["player-item",{"is-host":p(t.user_id)}])},[v("div",mr,B(t.nickname.charAt(0).toUpperCase()),1),v("div",fr,[v("div",gr,[F(B(t.nickname)+" ",1),p(t.user_id)?(O(),H("span",wr," 房主 ")):se("",!0)])])],2))),128))])]),v("div",vr,[v("div",hr,[r[3]||(r[3]=v("span",{class:"setting-label"},"繪畫時間：",-1)),v("span",_r,[v("strong",null,B(e.room?.settings.draw_time),1),r[2]||(r[2]=F("秒",-1))])]),v("div",pr,[r[5]||(r[5]=v("span",{class:"setting-label"},"輪數：",-1)),v("span",Rr,[v("strong",null,B(e.room?.settings.rounds),1),r[4]||(r[4]=F("輪",-1))])]),v("div",yr,[r[7]||(r[7]=v("span",{class:"setting-label"},"詞語總數：",-1)),v("span",Sr,[v("strong",null,B(e.room?.word_count),1),r[6]||(r[6]=F("個",-1))])])]),v("div",br,[U(_)&&U(M)?(O(),H("button",{key:0,disabled:U(I),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:N},B(U(I)?"開始中":"開始遊戲"),9,Er)):U(_)?(O(),H("div",Cr," 至少需要 2 個玩家才能開始遊戲 ")):se("",!0),v("button",{disabled:U(I),class:"paper-btn btn-secondary btn-block",onClick:P},B(U(I)?"離開中":"離開房間"),9,Gr)]),U(b)?(O(),H("div",Ar,B(U(b)),1)):se("",!0)])])]))}}),Ir=Ae(kr,[["__scopeId","data-v-950a757c"]]);export{Nr as I,Ir as W,ce as a,ee as b,he as c,Ye as d,_e as e,Ke as u};
