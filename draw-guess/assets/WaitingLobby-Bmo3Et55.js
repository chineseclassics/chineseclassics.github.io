import{l as ge,r as N,f as h,u as F,x as p,m as Re,d as ye,c as H,e as x,a as te,t as M,s as ce,F as Se,p as Ee,b as B,o as $,_ as be}from"./index-CFZYcN-t.js";const z=ge("room",()=>{const e=N(null),f=N([]),a=N(!1),u=N(null),w=h(()=>{const t=F();return e.value?.host_id===t.user?.id});async function E(t){try{a.value=!0,u.value=null;const r=F();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(i){console.warn("載入用戶資料時發生錯誤（非關鍵）:",i)}if(t.words.length<6)throw new Error("至少需要 6 個詞語");if(t.settings.rounds>t.words.length)throw new Error("輪數不能超過詞語總數");let n=null,c=0;const l=10;for(;c<l&&!n;){c++;const G={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null},{data:o,error:s}=await p.from("game_rooms").insert(G).select().single();if(s){if(s.code==="23505")continue;throw new Error(s.message||"插入房間失敗")}if(o){n=o;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const T={room_id:n.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:i}=await p.from("room_participants").insert(T);i&&console.error("創建參與記錄錯誤:",i)}catch(i){console.error("創建參與記錄時發生錯誤:",i)}try{const{data:i,error:G}=await p.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});G?console.error("載入參與者列表失敗:",G):i&&(f.value=i)}catch(i){console.error("載入參與者列表時發生錯誤:",i)}return e.value=n,{success:!0,room:n}}catch(r){return u.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:u.value}}finally{a.value=!1}}async function S(t,r){try{a.value=!0,u.value=null;const n=F();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:c,error:l}=await p.from("game_rooms").select("*").eq("code",t).single();if(l||!c)throw new Error("房間不存在");if(c.status!=="waiting")throw new Error("房間已開始或已結束");const{data:T}=await p.from("room_participants").select("*").eq("room_id",c.id).eq("user_id",n.user.id).maybeSingle();if(T)return e.value=c,await g(c.id),{success:!0,room:c};const{error:i}=await p.from("room_participants").insert({room_id:c.id,user_id:n.user.id,nickname:r.trim(),score:0});if(i){if(i.code==="23505"||i.message.includes("duplicate"))return e.value=c,await g(c.id),{success:!0,room:c};throw i}return e.value=c,await g(c.id),{success:!0,room:c}}catch(n){return u.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:u.value}}finally{a.value=!1}}async function R(){try{if(!e.value)return{success:!0};a.value=!0,u.value=null;const t=F();if(!t.user)throw new Error("請先登入");const{error:r}=await p.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(w.value){const{error:n}=await p.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,f.value=[],{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,f.value=[],{success:!1,error:u.value}}finally{a.value=!1}}async function g(t){try{const{data:r,error:n}=await p.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(n)throw n;f.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function m(t){try{a.value=!0,u.value=null;const{data:r,error:n}=await p.from("game_rooms").select("*").eq("id",t).single();if(n)throw n;return e.value=r,await g(t),{success:!0,room:r}}catch(r){return u.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:u.value}}finally{a.value=!1}}async function v(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await p.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(e.value){const n=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:u.value}}}async function _(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await p.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:u.value}}}function O(){e.value=null,f.value=[],u.value=null}function C(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function k(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!w.value)return{success:!1,error:"只有房主可以踢人"};const r=F();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,u.value=null;const{data:n,error:c}=await p.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(c)throw new Error(c.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await g(e.value.id),{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:u.value}}finally{a.value=!1}}return{currentRoom:e,participants:f,loading:a,error:u,isHost:w,createRoom:E,joinRoom:S,leaveRoom:R,kickPlayer:k,loadParticipants:g,loadRoom:m,updateRoomStatus:v,updateRoomDrawer:_,setCurrentDrawer:C,clearRoom:O}});function xe(){const e=z(),f=h(()=>e.currentRoom),a=h(()=>e.participants),u=h(()=>e.isHost),w=h(()=>!f.value||f.value.status!=="waiting"||!u.value?!1:a.value.length>=2);async function E(g){return await e.createRoom(g)}async function S(g,m){return await e.joinRoom(g,m)}async function R(){return await e.leaveRoom()}return{currentRoom:f,participants:a,isHost:u,canStartGame:w,loading:h(()=>e.loading),error:h(()=>e.error),createRoom:E,joinRoom:S,leaveRoom:R}}const ue=100,ie=50,le=10,de=100,fe=[1,.8,.6,.4,.2];function ke(){const e=z();function f(m){const v=Math.min(m,fe.length-1),_=fe[v]??0;return Math.round(ue*_)}function a(m){return m===0?0:ie+m*le}async function u(m,v){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:_,error:O}=await p.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",m).single();if(O)throw O;const C=(_?.score||0)+v,{error:k}=await p.from("room_participants").update({score:C}).eq("room_id",e.currentRoom.id).eq("user_id",m);if(k)throw k;const t=e.participants.findIndex(r=>r.user_id===m);return t!==-1&&e.participants[t]&&(e.participants[t].score=C),!0}catch(_){return console.error("更新玩家分數錯誤:",_),!1}}async function w(m,v){const _=a(v);return _===0?!0:await u(m,_)}function E(){if(!e.participants||e.participants.length===0)return null;const m=[...e.participants].sort((v,_)=>_.score-v.score);return m.length===1||m[0]&&m[1]&&m[0].score>m[1].score?{user_id:m[0]?.user_id||"",score:m[0]?.score||0}:{user_id:m[0]?.user_id||"",score:m[0]?.score||0}}const S=h(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((v,_)=>_.score!==v.score?_.score-v.score:new Date(v.joined_at).getTime()-new Date(_.joined_at).getTime()).map((v,_)=>({id:v.id,user_id:v.user_id,score:v.score,rank:_+1}))),R=h(()=>e.currentRoom?.status!=="finished"?null:E());function g(){return de}return{GUESS_BASE_SCORE:ue,DRAWING_BASE_SCORE:ie,DRAWING_BONUS_PER_GUESS:le,WINNER_BONUS:de,calculateGuessScore:f,calculateDrawingScore:a,calculateWinner:E,updatePlayerScore:u,updateDrawerScore:w,playerRankings:S,winner:R,getWinnerBonus:g}}const we=ge("game",()=>{const e=z(),f=F(),a=N(null),u=N(null),w=N([]),E=h(()=>w.value.filter(o=>o.is_correct)),S=N("drawing"),R=N([]),g=N([]),m=h(()=>g.value.length===0?0:g.value.reduce((s,y)=>s+y.rating,0)/g.value.length);function v(o){S.value=o}function _(o){R.value=o}function O(o){const s=g.value.findIndex(y=>y.rater_id===o.rater_id);s>=0?g.value[s]=o:g.value.push(o)}function C(){g.value=[]}async function k(o){try{const{data:s,error:y}=await p.from("game_rounds").select("*").eq("room_id",o).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(y)throw y;if(s){if(a.value=s,u.value=s.word_text,s.status){const q=S.value==="selecting",D=s.status==="completed";q&&D||(S.value=s.status)}s.word_options&&Array.isArray(s.word_options)&&(R.value=s.word_options),await t(s.id)}return{success:!0,round:s}}catch(s){return console.error("載入當前輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入輪次失敗"}}}async function t(o){try{const{data:s,error:y}=await p.from("guesses").select("*").eq("round_id",o).order("guessed_at",{ascending:!0});if(y)throw y;w.value=s||[]}catch(s){console.error("載入猜測記錄錯誤:",s)}}async function r(o,s,y,q){try{if(!e.currentRoom)throw new Error("沒有當前房間");const D=(e.currentRoom.current_round||0)+1,{data:Y,error:K}=await p.from("game_rounds").insert({room_id:o,round_number:D,drawer_id:s,word_text:y,word_source:q}).select().single();if(K)throw K;return a.value=Y,u.value=y,w.value=[],await p.from("game_rooms").update({current_round:D,current_drawer_id:s}).eq("id",o),{success:!0,round:Y}}catch(D){return console.error("創建輪次錯誤:",D),{success:!1,error:D instanceof Error?D.message:"創建輪次失敗"}}}function n(o){return w.value.some(s=>s.user_id===o&&s.is_correct)}const c=h(()=>!a.value||!f.user?!1:a.value.drawer_id===f.user.id);async function l(){if(!a.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const o=E.value.length,{updateDrawerScore:s}=ke();await s(a.value.drawer_id,o);const{error:y}=await p.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(y)throw y;return{success:!0}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}function T(){a.value=null,u.value=null,w.value=[],S.value="drawing",R.value=[],g.value=[]}async function i(o,s,y){if(!f.user)return{success:!1,error:"用戶未登錄"};try{const{data:q,error:D}=await p.from("drawing_ratings").upsert({round_id:o,rater_id:f.user.id,drawer_id:s,rating:y},{onConflict:"round_id,rater_id"}).select().single();if(D)throw D;return q&&O(q),{success:!0,rating:q}}catch(q){return console.error("提交評分錯誤:",q),{success:!1,error:q instanceof Error?q.message:"提交評分失敗"}}}async function G(o){try{const{data:s,error:y}=await p.from("drawing_ratings").select("*").eq("round_id",o);if(y)throw y;return g.value=s||[],{success:!0,ratings:s}}catch(s){return console.error("載入評分錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入評分失敗"}}}return{currentRound:a,currentWord:u,guesses:w,correctGuesses:E,isCurrentDrawer:c,roundStatus:S,wordOptions:R,ratings:g,averageRating:m,loadCurrentRound:k,loadGuesses:t,createRound:r,hasGuessed:n,endRound:l,clearGame:T,setRoundStatus:v,setWordOptions:_,addRating:O,clearRatings:C,submitRating:i,loadRatings:G}}),P=new Map,A=N("disconnected"),j=new Map,X=new Set,Z=new Map;function L(...e){}function U(...e){console.warn("[Realtime]",...e)}function ee(){const e=z(),f=we();function a(t){const r=`room:${t}`;if(P.has(r))return P.get(r);const n=p.channel(r,{config:{presence:{key:"user"},broadcast:{self:!1}}});return P.set(r,n),n}function u(t){const r=Z.get(t);r&&(clearTimeout(r),Z.delete(t))}function w(t,r,n,c,l){t==="SUBSCRIBED"?(A.value="connected",u(n),r.track({user_id:c,...l}).catch(T=>{U("Presence track 失敗:",T)})):t==="CHANNEL_ERROR"||t==="TIMED_OUT"?(A.value="disconnected",U("訂閱失敗:",t),E(n,c,l)):t==="CLOSED"&&(A.value="disconnected")}function E(t,r,n,c=0){if(c>=3){U("重連失敗次數過多，停止重連");return}u(t);const l=Math.min(1e3*Math.pow(2,c),1e4),T=window.setTimeout(()=>{const i=P.get(`room:${t}`);i&&i.state!=="joined"&&i.subscribe(G=>{G==="SUBSCRIBED"?w(G,i,t,r,n):(G==="CHANNEL_ERROR"||G==="TIMED_OUT")&&E(t,r,n,c+1)})},l);Z.set(t,T)}function S(t,r,n,c){return new Promise((l,T)=>{if(!t||!r){U("缺少 roomCode 或 roomId"),T(new Error("缺少 roomCode 或 roomId"));return}const i=a(t),G=i.state;if(G==="joined"){A.value="connected",l(i);return}if(G==="joining"){const o=setInterval(()=>{const s=i.state;s==="joined"?(clearInterval(o),l(i)):(s==="closed"||s==="errored")&&(clearInterval(o),T(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(o),i.state!=="joined"&&T(new Error("連接超時"))},5e3);return}if(X.has(t)){A.value="connecting",i.subscribe(o=>{w(o,i,t,n,c),o==="SUBSCRIBED"?l(i):(o==="CHANNEL_ERROR"||o==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${o}`))});return}i.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${r}`},async o=>{L("房間狀態變化:",o.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${r}`},async o=>{L("參與者變化:",o.eventType),await e.loadParticipants(r)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${r}`},async o=>{L("輪次變化:",o.eventType),e.currentRoom&&await f.loadCurrentRound(e.currentRoom.id)}).on("broadcast",{event:"drawing"},o=>{const s=j.get(t);s&&o.payload?.stroke&&s.forEach(y=>y(o.payload.stroke))}).on("presence",{event:"sync"},()=>{const o=i.presenceState();L("Presence 同步，在線:",Object.keys(o).length)}),X.add(t),A.value="connecting",i.subscribe(o=>{w(o,i,t,n,c),o==="SUBSCRIBED"?l(i):(o==="CHANNEL_ERROR"||o==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${o}`))})})}function R(t,r){return j.has(t)||j.set(t,new Set),j.get(t).add(r),()=>{j.get(t)?.delete(r)}}function g(t,r){const n=a(t),c=`guesses:${r}`;return n[c]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${r}`},async l=>{L("猜測記錄變化:",l.eventType),await f.loadGuesses(r)}),n[c]=!0),n}function m(t,r){const n=a(t),c=`gameState:${t}`;return n[c]||(n.on("broadcast",{event:"game_state"},l=>{L("收到遊戲狀態廣播:",l.payload),r(l.payload)}),n[c]=!0),n}async function v(t,r){const n=a(t),c=n.state;if(c!=="joined")return U("Channel 未連接，狀態:",c,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{L("廣播遊戲狀態:",r);const l=await n.send({type:"broadcast",event:"game_state",payload:r});return l==="error"?(U("發送遊戲狀態失敗"),{error:"發送失敗"}):l}catch(l){return U("發送遊戲狀態錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}async function _(t,r){const n=a(t),c=n.state;if(c!=="joined")return U("Channel 未連接，無法發送繪畫數據，狀態:",c),{error:"Channel 未連接"};try{const l=await n.send({type:"broadcast",event:"drawing",payload:{stroke:r}});return l==="error"?(U("發送失敗"),{error:"發送失敗"}):l}catch(l){return U("發送錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}function O(t){const r=`room:${t}`,n=P.get(r);u(t),n&&(p.removeChannel(n),P.delete(r)),j.delete(t),X.delete(t)}function C(){Z.forEach((t,r)=>u(r)),P.forEach(t=>p.removeChannel(t)),P.clear(),j.clear(),X.clear()}function k(){return A.value}return{connectionStatus:A,subscribeRoom:S,subscribeDrawing:R,subscribeGuesses:g,subscribeGameState:m,sendDrawing:_,broadcastGameState:v,unsubscribeRoom:O,unsubscribeAll:C,getConnectionStatus:k}}const Te=15,me=8;function Ge(){const e=z(),f=we();ee();const a=N(null),u=N(!1);let w=null;const E=N(null);let S=null;const R=N(null);let g=null;const m=h(()=>e.currentRoom?.status||"waiting"),v=h(()=>m.value==="playing"),_=h(()=>m.value==="waiting"),O=h(()=>m.value==="finished"),C=h(()=>f.roundStatus),k=h(()=>C.value==="selecting"),t=h(()=>C.value==="drawing"),r=h(()=>C.value==="summary"),n=h(()=>f.currentRound),c=h(()=>e.currentRoom?.current_round||0),l=h(()=>e.currentRoom?.settings.rounds||0),T=h(()=>e.currentRoom?.settings.draw_time||60),i=h(()=>f.wordOptions),G=h(()=>f.isCurrentDrawer);function o(d){w&&clearInterval(w),a.value=d,u.value=!0,w=window.setInterval(()=>{a.value!==null&&a.value>0?a.value--:(s(),v.value&&n.value&&e.isHost&&se())},1e3)}function s(){w&&(clearInterval(w),w=null),u.value=!1}function y(){s(),a.value=null}function q(){S&&clearInterval(S),E.value=Te,S=window.setInterval(()=>{if(E.value!==null&&E.value>0)E.value--;else{D();const I=e.currentRoom?.current_drawer_id===authStore.user?.id;if(k.value&&I&&i.value.length>0){console.log("[useGame] 選詞超時，畫家自動選擇第一個詞");const b=i.value[0];b&&ne(b)}}},1e3)}function D(){S&&(clearInterval(S),S=null),E.value=null}function Y(){g&&clearInterval(g),R.value=me,console.log("[useGame] 開始總結倒計時:",me,"秒"),g=window.setInterval(async()=>{R.value!==null&&R.value>0?R.value--:(K(),console.log("[useGame] 總結倒計時結束, isSummary:",r.value,"isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await ae()))},1e3)}function K(){g&&(clearInterval(g),g=null),R.value=null}function ve(){if(!e.currentRoom)return[];const d=e.currentRoom.words,I=e.currentRoom.current_round||0,b=d.slice(I);if(b.length===0)return[];const W=[...b].sort(()=>Math.random()-.5);return W.slice(0,Math.min(3,W.length)).map(Q=>({text:Q.text,source:Q.source}))}async function he(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const d=await e.updateRoomStatus("playing");return d.success?await J():d}catch(d){return console.error("開始遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"開始遊戲失敗"}}}async function J(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const d=e.currentRoom.current_round||0,I=d+1;if(d>=l.value)return await re(),{success:!1,error:"所有輪次已完成"};try{const b=(I-1)%e.participants.length,W=e.participants[b];if(console.log("[startSelectionPhase] 下一輪:",I,"畫家索引:",b,"畫家:",W?.nickname),!W)throw new Error("無法選擇畫家");const V=ve();if(V.length===0)throw new Error("沒有可用的詞語");f.setWordOptions(V),f.setRoundStatus("selecting"),f.clearRatings(),await e.updateRoomDrawer(W.user_id);const{broadcastGameState:Q}=ee();return await Q(e.currentRoom.code,{roundStatus:"selecting",wordOptions:V,drawerId:W.user_id}),q(),{success:!0,drawerId:W.user_id,options:V}}catch(b){return console.error("開始選詞階段錯誤:",b),{success:!1,error:b instanceof Error?b.message:"開始選詞階段失敗"}}}async function ne(d){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const I=e.currentRoom.current_drawer_id;if(!I)return{success:!1,error:"沒有當前畫家"};if(I!==authStore.user?.id)return console.log("[selectWord] 非畫家嘗試選詞，忽略"),{success:!1,error:"只有畫家可以選詞"};if(f.roundStatus!=="selecting")return console.log("[selectWord] 當前不是選詞階段，忽略"),{success:!1,error:"當前不是選詞階段"};D(),console.log("[selectWord] 畫家選擇詞語:",d.text);try{const b=await f.createRound(e.currentRoom.id,I,d.text,d.source);if(b.success&&b.round){f.setRoundStatus("drawing"),f.setWordOptions([]);const{broadcastGameState:W}=ee();await W(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:I}),o(T.value)}return b}catch(b){return console.error("選擇詞語錯誤:",b),{success:!1,error:b instanceof Error?b.message:"選擇詞語失敗"}}}async function oe(){return await J()}async function se(){if(!n.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{s();const d=await f.endRound();if(!d.success)return d;f.setRoundStatus("summary");const{broadcastGameState:I}=ee();return await I(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id}),Y(),{success:!0,gameEnded:!1}}catch(d){return console.error("結束輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束輪次失敗"}}}async function ae(){return e.currentRoom?(K(),(e.currentRoom.current_round||0)>=l.value?(await re(),{success:!0,gameEnded:!0}):(await J(),{success:!0,gameEnded:!1})):{success:!1,error:"沒有當前房間"}}async function re(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return s(),await e.updateRoomStatus("finished"),{success:!0}}catch(d){return console.error("結束遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束遊戲失敗"}}}async function _e(){if(!n.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!G.value)return{success:!1,error:"只有畫家可以跳過詞語"};try{return s(),await oe()}catch(d){return console.error("跳過詞語錯誤:",d),{success:!1,error:d instanceof Error?d.message:"跳過詞語失敗"}}}const pe=h(()=>{if(a.value===null)return"--:--";const d=Math.floor(a.value/60),I=a.value%60;return`${d.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}`});return Re(()=>{s(),D(),K()}),{gameStatus:m,isPlaying:v,isWaiting:_,isFinished:O,currentRound:n,currentRoundNumber:c,totalRounds:l,drawTime:T,isCurrentDrawer:G,timeRemaining:a,isCountingDown:u,formattedTime:pe,roundStatus:C,isSelecting:k,isDrawing:t,isSummary:r,wordOptions:i,selectionTimeRemaining:E,summaryTimeRemaining:R,startGame:he,startNextRound:oe,startSelectionPhase:J,selectWord:ne,endRound:se,continueToNextRound:ae,endGame:re,skipWord:_e,startCountdown:o,stopCountdown:s,stopSelectionCountdown:D,resetCountdown:y}}const De={class:"waiting-lobby"},Ie={class:"card"},Ce={class:"card-body"},Ne={class:"margin-bottom-medium"},Oe={class:"card-title text-hand-title"},qe={class:"text-small"},Me={style:{"font-family":"monospace"}},We={class:"text-small margin-top-small"},Ue={class:"margin-bottom-medium"},Be={class:"text-hand-title"},Pe={class:"margin-top-small"},Ae={style:{"flex-shrink":"0","margin-right":"0.75rem"}},He={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},$e={style:{flex:"1"}},je={class:"text-hand",style:{"font-weight":"500"}},Le={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},Ke={class:"margin-bottom-medium text-small"},Fe=["disabled"],Ve={key:1,class:"text-small text-center margin-bottom-small"},ze=["disabled"],Ye={key:0,class:"alert alert-danger margin-top-medium"},Je=ye({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:f}){const a=e,u=f,{isHost:w,canStartGame:E,leaveRoom:S,loading:R,error:g}=xe(),{startGame:m}=Ge();function v(k){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[k||""]||k||"未知"}function _(k){return a.room?.host_id===k}async function O(){(await m()).success&&u("startGame")}async function C(){(await S()).success&&u("leaveRoom")}return(k,t)=>($(),H("div",De,[x("div",Ie,[x("div",Ce,[x("div",Ne,[x("h2",Oe,M(e.room?.name),1),x("div",qe,[t[0]||(t[0]=ce(" 房間碼：",-1)),x("span",Me,M(e.room?.code),1)]),x("div",We," 狀態："+M(v(e.room?.status)),1)]),x("div",Ue,[x("h4",Be,"玩家列表 ("+M(e.participants.length)+")",1),x("div",Pe,[($(!0),H(Se,null,Ee(e.participants,r=>($(),H("div",{key:r.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[x("div",Ae,[x("div",He,M(r.nickname.charAt(0).toUpperCase()),1)]),x("div",$e,[x("div",je,[ce(M(r.nickname)+" ",1),_(r.user_id)?($(),H("span",Le," 房主 ")):te("",!0)])])]))),128))])]),x("div",Ke,[x("div",null,"繪畫時間："+M(e.room?.settings.draw_time)+" 秒",1),x("div",null,"輪數："+M(e.room?.settings.rounds)+" 輪",1),x("div",null,"詞語總數："+M(e.room?.word_count)+" 個",1)]),x("div",null,[B(w)&&B(E)?($(),H("button",{key:0,onClick:O,disabled:B(R),class:"paper-btn btn-primary btn-block margin-bottom-small"},M(B(R)?"開始中...":"開始遊戲"),9,Fe)):B(w)?($(),H("div",Ve," 至少需要 2 個玩家才能開始遊戲 ")):te("",!0),x("button",{onClick:C,disabled:B(R),class:"paper-btn btn-secondary btn-block"},M(B(R)?"離開中...":"離開房間"),9,ze)]),B(g)?($(),H("div",Ye,M(B(g)),1)):te("",!0)])])]))}}),Xe=be(Je,[["__scopeId","data-v-769c8ad1"]]);export{Xe as W,Ge as a,ee as b,z as c,we as d,ke as e,xe as u};
