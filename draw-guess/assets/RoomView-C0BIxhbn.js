import{l as Ve,r as S,u as q,d as J,i as se,m as te,c as i,e,o as r,_ as Y,f as G,n as N,a as I,F as E,p as O,q as ce,t as v,b as o,s as U,h as ee,x as Q,y as Be,j as B,z as ye,A as Oe,g as Pe,v as He,B as Ae,C as ze,k as Ue,D as qe}from"./index-7kBb4hlT.js";import{c as ne,b as ue,d as de,e as $e,a as Je,u as Ye,W as Xe}from"./WaitingLobby-DFj7uQxC.js";const Ce=Ve("drawing",()=>{const t=S("pen"),c=S("#000000"),d=S(3),h=S(!1),s=S([]);function l(_){t.value=_}function w(_){c.value=_}function f(_){d.value=Math.max(1,Math.min(20,_))}function b(_){s.value.push(_)}function x(){s.value=[]}function $(_){h.value=_}return{tool:t,color:c,lineWidth:d,isDrawing:h,strokes:s,setTool:l,setColor:w,setLineWidth:f,addStroke:b,clearStrokes:x,setDrawing:$}});function be(t,c){const d=t.getBoundingClientRect();let h,s;if(c instanceof MouseEvent)h=c.clientX,s=c.clientY;else if(c instanceof TouchEvent&&c.touches.length>0&&c.touches[0])h=c.touches[0].clientX,s=c.touches[0].clientY;else return null;return{x:h-d.left,y:s-d.top}}function Se(t,c){if(!(c.points.length<2)){t.save(),c.tool==="pen"?(t.strokeStyle=c.color,t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"):c.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),c.points[0]&&t.moveTo(c.points[0].x,c.points[0].y);for(let d=1;d<c.points.length;d++){const h=c.points[d];h&&t.lineTo(h.x,h.y)}t.stroke(),t.restore()}}function ie(t,c){const d=t.getContext("2d");if(!d)return;const h=t.getBoundingClientRect();d.clearRect(0,0,t.width,t.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,h.width,h.height),c.forEach(s=>{Se(d,s)})}function je(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Fe(){const t=Ce(),c=ne(),d=q(),{sendDrawing:h}=ue(),s=S(null),l=S(null),w=S(null),f=S(null);let b=null;const x=50;function $(n){s.value=n;const y=n.getContext("2d",{willReadFrequently:!0});if(!y){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}l.value=y;const C=window.devicePixelRatio||1,P=n.getBoundingClientRect();n.width=P.width*C,n.height=P.height*C,y.scale(C,C),y.fillStyle="#FFFFFF",y.fillRect(0,0,P.width,P.height),s.value&&ie(s.value,t.strokes),new ResizeObserver(()=>{if(!s.value||!l.value)return;const H=s.value.getBoundingClientRect(),A=window.devicePixelRatio||1;s.value.width=H.width*A,s.value.height=H.height*A,l.value.scale(A,A),l.value.fillStyle="#FFFFFF",l.value.fillRect(0,0,H.width,H.height),ie(s.value,t.strokes)}).observe(n)}function _(n){if(!s.value)return;n.preventDefault(),t.setDrawing(!0);const y=be(s.value,n);y&&(w.value={id:je(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[y],timestamp:Date.now()},f.value=y)}function F(n){if(!s.value||!l.value||!t.isDrawing||!w.value)return;n.preventDefault();const y=be(s.value,n);if(!y||!f.value)return;const C=l.value;C.save(),w.value.tool==="pen"?(C.strokeStyle=w.value.color,C.lineWidth=w.value.lineWidth,C.lineCap="round",C.lineJoin="round"):w.value.tool==="eraser"&&(C.globalCompositeOperation="destination-out",C.lineWidth=w.value.lineWidth,C.lineCap="round",C.lineJoin="round"),C.beginPath(),C.moveTo(f.value.x,f.value.y),C.lineTo(y.x,y.y),C.stroke(),C.restore(),w.value.points.push(y),f.value=y,b===null&&(b=window.setTimeout(()=>{R(),b=null},x))}function u(){!t.isDrawing||!w.value||(t.setDrawing(!1),b&&(clearTimeout(b),b=null),R(),w.value=null,f.value=null)}async function R(){if(!(!w.value||!c.currentRoom||!d.user))try{const n={...w.value,userId:d.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",n.id),await h(c.currentRoom.code,n)}catch(n){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",n)}}function p(n){if(!(!s.value||!l.value)){if(n.userId&&d.user&&n.userId===d.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",n.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",n.id),t.addStroke(n),Se(l.value,n)}}function k(){if(!s.value||!l.value)return;const n=l.value,y=s.value;n.clearRect(0,0,y.width,y.height),n.fillStyle="#FFFFFF",n.fillRect(0,0,y.width,y.height),t.clearStrokes()}function M(n){t.setTool(n)}function L(n){t.setColor(n)}function T(n){t.setLineWidth(n)}function g(){s.value&&ie(s.value,t.strokes)}return{canvasRef:s,initCanvas:$,startDrawing:_,draw:F,stopDrawing:u,clearCanvas:k,setTool:M,setColor:L,setLineWidth:T,handleDrawingData:p,redrawStrokes:g}}const Ke={class:"drawing-canvas-container"},Qe=J({__name:"DrawingCanvas",setup(t){const{initCanvas:c,startDrawing:d,draw:h,stopDrawing:s,handleDrawingData:l,clearCanvas:w}=Fe(),f=ne(),b=q(),{subscribeDrawing:x}=ue(),$=S(null);function _(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),w()}function F(n){d(n)}function u(n){h(n)}function R(){s()}function p(){s()}function k(n){d(n)}function M(n){h(n)}function L(){s()}let T=null;function g(){!f.currentRoom||!b.user||(T=x(f.currentRoom.code,n=>{l(n)}))}return se(()=>{$.value&&c($.value),g(),window.addEventListener("clearCanvas",_)}),te(()=>{T&&(T(),T=null),window.removeEventListener("clearCanvas",_)}),(n,y)=>(r(),i("div",Ke,[e("canvas",{ref_key:"canvasElement",ref:$,class:"drawing-canvas",onMousedown:F,onMousemove:u,onMouseup:R,onMouseleave:p,onTouchstart:k,onTouchmove:M,onTouchend:L},null,544)]))}}),Ze=Y(Qe,[["__scopeId","data-v-f29d9704"]]),es={class:"toolbar-section"},ss={key:0,class:"tool-label"},ts={key:0,class:"tool-label"},ns={key:0,class:"toolbar-section colors-section"},os=["onClick","title"],rs={class:"toolbar-section size-section"},as={class:"size-dots"},is=["onClick","title"],ls={class:"toolbar-section"},cs={key:0,class:"tool-label"},us=J({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const c=Ce(),{setTool:d,setColor:h,setLineWidth:s,clearCanvas:l}=Fe(),w=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],f=G(()=>c.tool),b=G(()=>c.color),x=G(()=>c.lineWidth);function $(R){d(R)}function _(R){h(R)}function F(R){c.setLineWidth(R),s(R)}function u(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&l()}return(R,p)=>(r(),i("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",es,[e("button",{onClick:p[0]||(p[0]=k=>$("pen")),class:N(["tool-btn",{active:f.value==="pen"}]),title:"ç•«ç­†"},[p[2]||(p[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?I("",!0):(r(),i("span",ss,"ç•«ç­†"))],2),e("button",{onClick:p[1]||(p[1]=k=>$("eraser")),class:N(["tool-btn",{active:f.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[p[3]||(p[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?I("",!0):(r(),i("span",ts,"æ©¡çš®æ“¦"))],2)]),f.value==="pen"?(r(),i("div",ns,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(r(),i(E,null,O(w,k=>e("div",{key:k,onClick:M=>_(k),class:N(["color-cell",{selected:b.value===k}]),style:ce({backgroundColor:k}),title:k},null,14,os)),64))],2)])):I("",!0),e("div",rs,[e("div",as,[(r(),i(E,null,O([2,5,10,15],k=>e("div",{key:k,onClick:M=>F(k),class:N(["size-dot",{active:x.value===k}]),style:ce({width:`${k+8}px`,height:`${k+8}px`}),title:`${k}px`},null,14,is)),64))])]),e("div",ls,[e("button",{onClick:u,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[p[4]||(p[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?I("",!0):(r(),i("span",cs,"æ¸…ç©º"))])])],2))}}),le=Y(us,[["__scopeId","data-v-7e7250c3"]]),ds={class:"player-list"},vs={class:"player-list-header"},ms={class:"player-count"},hs={class:"player-rank"},ws={class:"player-info"},fs={class:"player-name"},gs={key:0,class:"drawer-badge"},_s={key:1,class:"host-badge"},ps={class:"player-score"},ys={key:0,class:"winner-banner"},bs={class:"winner-text"},Rs={class:"winner-name"},ks={class:"winner-score"},$s=J({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(t){const c=ne(),d=de(),h=q(),{playerRankings:s,winner:l}=$e(),w=G(()=>s.value);function f(_){return c.participants.find(u=>u.user_id===_)?.nickname||"æœªçŸ¥ç©å®¶"}function b(_){return h.user?.id===_}function x(_){return c.currentRoom?.host_id===_}function $(_){return d.currentRound?.drawer_id===_}return(_,F)=>(r(),i("div",ds,[e("div",vs,[e("span",ms,"ç©å®¶ ("+v(w.value.length)+")",1)]),(r(!0),i(E,null,O(w.value,(u,R)=>(r(),i("div",{key:u.id,class:N(["player-item",{"is-current":b(u.user_id)},{"is-drawer":$(u.user_id)}])},[e("div",hs,v(R+1),1),e("div",{class:N(["player-avatar",{drawing:$(u.user_id)}])},v(f(u.user_id).charAt(0)),3),e("div",ws,[e("div",fs,[U(v(f(u.user_id))+" ",1),$(u.user_id)?(r(),i("span",gs,"âœï¸")):I("",!0),x(u.user_id)?(r(),i("span",_s,"ğŸ‘‘")):I("",!0)]),e("div",ps,v(u.score)+" åˆ†",1)])],2))),128)),t.showWinner&&o(l)?(r(),i("div",ys,[F[1]||(F[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",bs,[F[0]||(F[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",Rs,v(f(o(l).user_id)),1),e("div",ks,v(o(l).score)+" åˆ†",1)])])):I("",!0)]))}}),Re=Y($s,[["__scopeId","data-v-4094673d"]]),Cs={class:"word-selection"},Ss={class:"selection-card"},Fs={class:"selection-header"},Ds={class:"round-info"},Ws={class:"countdown-section"},xs={class:"countdown-number"},Ts={class:"countdown-text"},Is={class:"word-options"},Gs=["onClick","disabled"],Ms={class:"word-text"},Ls={key:0,class:"word-source"},Ns={class:"selection-footer"},Es=["disabled"],Vs=J({__name:"WordSelection",props:{wordOptions:{},roundNumber:{},totalRounds:{},selectionTime:{}},emits:["word-selected"],setup(t,{emit:c}){const d=t,h=c,s=S(null),l=S(!1),w=S(d.selectionTime);let f=null;function b(F){l.value||(s.value=F)}function x(){!s.value||l.value||(l.value=!0,h("word-selected",s.value),f&&clearInterval(f))}function $(){if(l.value)return;const F=Math.floor(Math.random()*d.wordOptions.length),u=d.wordOptions[F];u&&(s.value=u.text,l.value=!0,h("word-selected",u.text))}function _(){w.value=d.selectionTime,f=window.setInterval(()=>{w.value>0?w.value--:(f&&clearInterval(f),$())},1e3)}return se(()=>{_()}),te(()=>{f&&clearInterval(f)}),(F,u)=>(r(),i("div",Cs,[e("div",Ss,[e("div",Fs,[u[0]||(u[0]=e("h2",{class:"selection-title"},"ğŸ¨ è¼ªåˆ°ä½ ç•«ç•«äº†ï¼",-1)),e("div",Ds,"ç¬¬ "+v(t.roundNumber)+" / "+v(t.totalRounds)+" è¼ª",1)]),e("div",Ws,[e("div",{class:N(["countdown-ring",{warning:w.value<=5}])},[e("span",xs,v(w.value),1)],2),e("div",Ts,v(w.value<=5?"å³å°‡è‡ªå‹•é¸æ“‡ï¼":"è«‹é¸æ“‡ä¸€å€‹è©èª"),1)]),e("div",Is,[(r(!0),i(E,null,O(t.wordOptions,(R,p)=>(r(),i("button",{key:p,class:N(["word-option",{selected:s.value===R.text}]),onClick:k=>b(R.text),disabled:l.value},[e("span",Ms,v(R.text),1),R.source==="custom"?(r(),i("span",Ls,"è‡ªè¨‚")):I("",!0)],10,Gs))),128))]),e("div",Ns,[e("button",{class:"confirm-btn",disabled:!s.value||l.value,onClick:x},v(l.value?"å·²é¸æ“‡":"ç¢ºèªé¸æ“‡"),9,Es)])])]))}}),Bs=Y(Vs,[["__scopeId","data-v-00208fc2"]]),Os={class:"round-summary"},Ps={class:"summary-card"},Hs={key:0,class:"selection-waiting-banner"},As={class:"waiting-text"},zs={class:"next-drawer-name"},Us={class:"summary-header"},qs={class:"summary-title"},Js={class:"round-info"},Ys={class:"answer-reveal"},Xs={class:"answer-text"},js={class:"drawer-section"},Ks={class:"drawer-info"},Qs={class:"drawer-name"},Zs={key:0,class:"drawer-score"},et={class:"guessers-section"},st={key:0,class:"no-guessers"},tt={key:1,class:"guessers-list"},nt={class:"guesser-rank"},ot={class:"guesser-name"},rt={class:"guesser-score"},at={key:1,class:"rating-section"},it={class:"star-rating"},lt=["onMouseenter","onClick","disabled"],ct={class:"rating-info"},ut={key:0,class:"rated-text"},dt={key:1,class:"rate-hint"},vt={key:2,class:"average-rating"},mt={class:"avg-score"},ht={class:"avg-stars"},wt={class:"avg-count"},ft={key:3,class:"summary-footer"},gt={key:0,class:"countdown"},_t=J({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["next-round","rating-submitted"],setup(t,{emit:c}){const d=t,h=c,s=q(),l=S(0),w=S(0),f=S(!1),b=S([]),x=S(8);let $=null;const _=G(()=>s.user?.id===d.drawerId),F=G(()=>b.value.length===0?0:b.value.reduce((g,n)=>g+n.rating,0)/b.value.length),u=G(()=>b.value.length);async function R(T){if(!(f.value||_.value||!s.user))try{const{error:g}=await Q.from("drawing_ratings").upsert({round_id:d.roundId,rater_id:s.user.id,drawer_id:d.drawerId,rating:T},{onConflict:"round_id,rater_id"});if(g)throw g;l.value=T,f.value=!0,h("rating-submitted",T)}catch(g){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",g)}}async function p(){try{const{data:T,error:g}=await Q.from("drawing_ratings").select("rater_id, rating").eq("round_id",d.roundId);if(g)throw g;if(b.value=T||[],s.user){const n=b.value.find(y=>y.rater_id===s.user.id);n&&(l.value=n.rating,f.value=!0)}}catch(T){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",T)}}function k(){const T=Q.channel(`ratings:${d.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${d.roundId}`},()=>{p()}).subscribe();return()=>{Q.removeChannel(T)}}function M(){$=window.setInterval(()=>{x.value>0?x.value--:($&&clearInterval($),d.isHost&&h("next-round"))},1e3)}let L=null;return se(()=>{p(),L=k(),M()}),te(()=>{$&&clearInterval($),L&&L()}),ee(()=>d.roundId,()=>{p(),x.value=8}),(T,g)=>(r(),i("div",Os,[e("div",Ps,[t.isWaitingForSelection?(r(),i("div",Hs,[g[3]||(g[3]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",As,[e("span",zs,v(t.nextDrawerName),1),g[2]||(g[2]=U(" æ­£åœ¨é¸è©... ",-1))]),g[4]||(g[4]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):I("",!0),e("div",Us,[e("h2",qs,v(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Js,"ç¬¬ "+v(t.roundNumber)+" / "+v(t.totalRounds)+" è¼ª",1)]),e("div",Ys,[g[5]||(g[5]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Xs,v(t.correctAnswer),1)]),e("div",js,[e("div",Ks,[g[6]||(g[6]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Qs,v(t.drawerName),1),t.drawerScore>0?(r(),i("span",Zs,"+"+v(t.drawerScore)+" åˆ†",1)):I("",!0)])]),e("div",et,[g[7]||(g[7]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(r(),i("div",st," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(r(),i("div",tt,[(r(!0),i(E,null,O(t.correctGuessers,(n,y)=>(r(),i("div",{key:n.userId,class:"guesser-item"},[e("span",nt,v(y+1),1),e("span",ot,v(n.name),1),e("span",rt,"+"+v(n.score),1)]))),128))]))]),_.value?I("",!0):(r(),i("div",at,[g[8]||(g[8]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",it,[(r(),i(E,null,O(5,n=>e("button",{key:n,class:N(["star-btn",{active:n<=(w.value||l.value),selected:n<=l.value}]),onMouseenter:y=>w.value=n,onMouseleave:g[0]||(g[0]=y=>w.value=0),onClick:y=>R(n),disabled:f.value}," â­ ",42,lt)),64))]),e("div",ct,[f.value?(r(),i("span",ut,"ä½ çš„è©•åˆ†ï¼š"+v(l.value)+" æ˜Ÿ",1)):(r(),i("span",dt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),u.value>0?(r(),i("div",vt,[g[9]||(g[9]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",mt,v(F.value.toFixed(1)),1),e("span",ht,v("â­".repeat(Math.round(F.value))),1),e("span",wt,"("+v(u.value)+" äººå·²è©•)",1)])):I("",!0),t.isWaitingForSelection?I("",!0):(r(),i("div",ft,[x.value>0?(r(),i("div",gt,v(x.value)+" ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€è¼ª ",1)):I("",!0),t.isHost?(r(),i("button",{key:1,class:"next-btn",onClick:g[1]||(g[1]=n=>T.$emit("next-round"))},v(t.isLastRound?"æŸ¥çœ‹çµæœ":"ä¸‹ä¸€è¼ª"),1)):I("",!0)]))])]))}}),ke=Y(_t,[["__scopeId","data-v-23450531"]]);function pt(){const t=de(),c=q(),{calculateGuessScore:d,updatePlayerScore:h}=$e(),s=S(""),l=S(null),w=S(!1),f=G(()=>t.isCurrentDrawer?t.currentWord:null),b=G(()=>t.correctGuesses),x=G(()=>c.user?t.hasGuessed(c.user.id):!1);async function $(){if(!t.currentRound||!c.user)return l.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return l.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return l.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(x.value)return l.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return l.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{w.value=!0,l.value=null;const u=s.value.trim(),R=t.currentWord||"",p=_(u,R),k=p?d(b.value.length):0,{data:M,error:L}=await Q.from("guesses").insert({round_id:t.currentRound.id,user_id:c.user.id,guess_text:u,is_correct:p,score_earned:k}).select().single();if(L)throw L;return t.guesses.push(M),p&&c.user&&await h(c.user.id,k),s.value="",{success:!0,isCorrect:p,guess:M}}catch(u){return l.value=u instanceof Error?u.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",u),{success:!1,error:l.value}}finally{w.value=!1}}function _(u,R){const p=u.trim(),k=R.trim();return p===k}function F(){l.value=null}return{guessInput:s,error:l,loading:w,currentWord:f,correctGuesses:b,hasGuessed:x,submitGuess:$,clearError:F}}const yt={class:"game-container"},bt={key:0,class:"container margin-top-large"},Rt={class:"row flex-center"},kt={class:"col-12 col-md-8"},$t={key:1,class:"game-layout"},Ct={class:"game-sidebar game-players"},St={class:"player-list-container"},Ft={class:"game-main"},Dt={key:0,class:"time-display"},Wt={key:1,class:"time-display selecting"},xt={class:"time-number time-warning"},Tt={key:2,class:"time-display summary"},It={class:"time-number"},Gt={class:"round-info"},Mt={class:"round-label"},Lt={key:0,class:"phase-label"},Nt={key:1,class:"phase-label"},Et={key:3,class:"word-display"},Vt={class:"word-text"},Bt={key:4,class:"word-display"},Ot={class:"word-slots"},Pt={key:5,class:"word-display"},Ht={class:"word-slots"},At={key:6,class:"word-display summary-word"},zt={class:"word-text revealed"},Ut={class:"game-content-area"},qt={class:"game-toolbar disabled"},Jt={class:"game-canvas selection-phase"},Yt={key:2,class:"first-round-waiting"},Xt={class:"waiting-card"},jt={class:"waiting-title"},Kt={class:"game-chat-panel"},Qt={class:"game-toolbar disabled"},Zt={class:"game-canvas summary-phase"},en={class:"game-chat-panel"},sn={class:"chat-msg system-msg answer-revealed"},tn={class:"msg-player"},nn={class:"msg-correct"},on={class:"game-toolbar"},rn={class:"game-canvas"},an={key:0,class:"time-progress"},ln={class:"game-chat-panel"},cn={class:"msg-player"},un={key:0,class:"msg-correct"},dn={key:1,class:"msg-text"},vn={key:0,class:"chat-msg correct-self"},mn={class:"chat-input-area"},hn=["placeholder","disabled"],wn=["disabled"],fn={key:2,class:"container margin-top-large"},gn={class:"row flex-center"},_n={class:"col-12 col-md-8"},pn={class:"card"},yn={class:"card-body text-center"},bn=J({__name:"RoomView",setup(t){const c=Be(),d=Ue(),h=ne(),s=de(),l=q(),{subscribeRoom:w,subscribeGuesses:f,unsubscribeRoom:b,subscribeGameState:x}=ue(),{isPlaying:$,isWaiting:_,isFinished:F,timeRemaining:u,isCountingDown:R,isCurrentDrawer:p,drawTime:k,currentRoundNumber:M,totalRounds:L,startGame:T,skipWord:g,isSelecting:n,isDrawing:y,isSummary:C,wordOptions:P,selectionTimeRemaining:oe,summaryTimeRemaining:H,selectWord:A}=Je(),{hasGuessed:Z,guessInput:X,submitGuess:De,loading:We}=pt(),{leaveRoom:xe}=Ye(),D=G(()=>h.currentRoom),ve=G(()=>We.value),me=S(null),z=S(null),j=G(()=>{const m=D.value?.current_drawer_id;return m&&h.participants.find(W=>W.user_id===m)?.nickname||"ç•«å®¶"}),he=G(()=>!D.value||!l.user?!1:D.value.current_drawer_id===l.user.id),we=G(()=>[...s.guesses].sort((m,a)=>new Date(m.guessed_at).getTime()-new Date(a.guessed_at).getTime()));function Te(){z.value&&(z.value.scrollTop=z.value.scrollHeight)}ee(we,()=>{qe(Te)},{deep:!0}),ee(()=>s.currentRound?.id,(m,a)=>{m&&m!==a&&D.value&&(console.log("[RoomView] è¼ªæ¬¡è®ŠåŒ–ï¼Œé‡æ–°è¨‚é–±çŒœæ¸¬:",m),f(D.value.code,m))});function re(m){return h.participants.find(W=>W.user_id===m)?.nickname||"æœªçŸ¥ç©å®¶"}const Ie=G(()=>p.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":Z.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ge=G(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),fe=G(()=>s.correctGuesses.length*5),ge=G(()=>s.correctGuesses.map(m=>({userId:m.user_id,name:re(m.user_id),score:m.score_earned}))),V=S(null);function Me(){!s.currentRound||!s.currentWord||(V.value={roundNumber:M.value,answer:s.currentWord,drawerName:j.value,drawerId:s.currentRound.drawer_id,drawerScore:fe.value,correctGuessers:ge.value,roundId:s.currentRound.id})}ee(n,(m,a)=>{m&&!a&&M.value>0&&Me()});function K(m){me.value=m,setTimeout(()=>{me.value=null},3e3)}async function _e(){!p.value&&X.value.trim()&&await De()}async function Le(){const m=await T();!m.success&&m.error&&K(m.error)}async function ae(){const m=await xe();D.value&&b(D.value.code),await d.push("/"),!m.success&&m.error&&K(m.error)}async function Ne(){const m=await g();!m.success&&m.error&&K(m.error)}async function Ee(m){const a=P.value.find(W=>W.text===m);if(a){const W=await A(a);!W.success&&W.error&&K(W.error)}}async function pe(m){if(!s.currentRound)return;const a=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,m);!a.success&&a.error&&K(a.error)}return se(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",c.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",D.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",l.user?.id);const m=c.params.code;if(m&&!D.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",m),D.value&&l.user){console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",D.value.status),await s.loadCurrentRound(D.value.id);try{await w(D.value.code,D.value.id,l.user.id,{nickname:l.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(a){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",a)}x(D.value.code,async a=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",a),a.roundStatus&&(s.setRoundStatus(a.roundStatus),a.roundStatus==="selecting"&&window.dispatchEvent(new CustomEvent("clearCanvas"))),a.wordOptions!==void 0&&s.setWordOptions(a.wordOptions),a.drawerId&&D.value&&h.setCurrentDrawer(a.drawerId),D.value&&(await h.loadRoom(D.value.id),await s.loadCurrentRound(D.value.id))}),s.currentRound&&f(D.value.code,s.currentRound.id)}}),te(()=>{D.value&&b(D.value.code)}),(m,a)=>(r(),i("div",yt,[o(_)?(r(),i("div",bt,[e("div",Rt,[e("div",kt,[B(Xe,{room:D.value,participants:o(h).participants,onStartGame:Le,onLeaveRoom:ae},null,8,["room","participants"])])])])):o($)?(r(),i("div",$t,[e("div",Ct,[e("div",St,[B(Re,{"show-winner":!1})])]),e("div",Ft,[e("div",{class:N(["game-header",{"time-critical":o(u)!==null&&o(u)<=10}])},[o(y)&&o(R)&&o(u)!==null?(r(),i("div",Dt,[e("span",{class:N(["time-number",{"time-warning":o(u)<=10,"time-critical-pulse":o(u)<=5}])},v(o(u)),3),a[1]||(a[1]=e("span",{class:"time-label"},"ç§’",-1))])):o(n)&&o(oe)!==null?(r(),i("div",Wt,[e("span",xt,v(o(oe)),1),a[2]||(a[2]=e("span",{class:"time-label"},"ç§’é¸è©",-1))])):o(C)&&o(H)!==null?(r(),i("div",Tt,[e("span",It,v(o(H)),1),a[3]||(a[3]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):I("",!0),e("div",Gt,[e("span",Mt,"ç¬¬ "+v(o(M)+(o(n)?1:0))+" / "+v(o(L))+" è¼ª",1),o(n)?(r(),i("span",Lt,"é¸è©ä¸­")):o(C)?(r(),i("span",Nt,"è¼ªæ¬¡çµç®—")):I("",!0)]),o(y)&&o(p)&&o(s).currentWord?(r(),i("div",Et,[a[4]||(a[4]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",Vt,v(o(s).currentWord),1),e("button",{class:"skip-btn",onClick:Ne,title:"è·³éæ­¤è©"},"è·³é")])):o(y)?(r(),i("div",Bt,[e("span",Ot,v(Ge.value),1)])):o(n)?(r(),i("div",Pt,[e("span",Ht,v(he.value?"è«‹é¸æ“‡è¦ç•«çš„è©èª":`${j.value} æ­£åœ¨é¸è©...`),1)])):o(C)&&o(s).currentWord?(r(),i("div",At,[a[5]||(a[5]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",zt,v(o(s).currentWord),1)])):I("",!0),e("button",{class:"leave-btn",onClick:ae,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ut,[o(n)?(r(),i(E,{key:0},[e("div",qt,[B(le,{compact:!0})]),e("div",Jt,[he.value?(r(),ye(Bs,{key:0,"word-options":o(P),"round-number":o(M)+1,"total-rounds":o(L),"selection-time":15,onWordSelected:Ee},null,8,["word-options","round-number","total-rounds"])):V.value?(r(),ye(ke,{key:1,"round-number":V.value.roundNumber,"total-rounds":o(L),"correct-answer":V.value.answer,"drawer-name":V.value.drawerName,"drawer-id":V.value.drawerId,"drawer-score":V.value.drawerScore,"correct-guessers":V.value.correctGuessers,"round-id":V.value.roundId,"is-host":o(h).isHost,"is-last-round":!1,"is-waiting-for-selection":!0,"next-drawer-name":j.value,onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","next-drawer-name"])):(r(),i("div",Yt,[e("div",Xt,[a[6]||(a[6]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("h2",jt,v(j.value)+" æ­£åœ¨é¸è©...",1),a[7]||(a[7]=Oe('<p class="waiting-hint" data-v-e6d1fea2>ç¬¬ä¸€è¼ªå³å°‡é–‹å§‹</p><div class="waiting-dots" data-v-e6d1fea2><span class="dot" data-v-e6d1fea2></span><span class="dot" data-v-e6d1fea2></span><span class="dot" data-v-e6d1fea2></span></div>',2))])]))]),e("div",Kt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[...a[8]||(a[8]=[e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"â³"),U(" ç­‰å¾…ç•«å®¶é¸è©... ")],-1)])],512),a[9]||(a[9]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ç­‰å¾…é¸è©...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):o(C)?(r(),i(E,{key:1},[e("div",Qt,[B(le,{compact:!0})]),e("div",Zt,[B(ke,{"round-number":o(M),"total-rounds":o(L),"correct-answer":o(s).currentWord||"","drawer-name":j.value,"drawer-id":o(s).currentRound?.drawer_id||"","drawer-score":fe.value,"correct-guessers":ge.value,"round-id":o(s).currentRound?.id||"","is-host":o(h).isHost,"is-last-round":o(M)>=o(L),onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",en,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[e("div",sn,[a[10]||(a[10]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),a[11]||(a[11]=U(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,v(o(s).currentWord),1)]),(r(!0),i(E,null,O(o(s).correctGuesses,W=>(r(),i("div",{key:W.id,class:"chat-msg correct-guess"},[e("span",tn,v(re(W.user_id)),1),e("span",nn,"çŒœä¸­äº†ï¼ +"+v(W.score_earned),1)]))),128))],512),a[12]||(a[12]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(r(),i(E,{key:2},[e("div",on,[B(le,{compact:!0})]),e("div",rn,[B(Ze),o(R)&&o(u)!==null?(r(),i("div",an,[e("div",{class:N(["time-bar",{"time-warning":o(u)<=10}]),style:ce({width:`${o(u)/o(k)*100}%`})},null,6)])):I("",!0)]),e("div",ln,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[a[14]||(a[14]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),U(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(r(!0),i(E,null,O(we.value,W=>(r(),i("div",{key:W.id,class:N(["chat-msg",{"correct-guess":W.is_correct,"wrong-guess":!W.is_correct}])},[e("span",cn,v(re(W.user_id)),1),W.is_correct?(r(),i("span",un,"çŒœä¸­äº†ï¼ +"+v(W.score_earned),1)):(r(),i("span",dn,v(W.guess_text),1))],2))),128)),o(Z)?(r(),i("div",vn,[...a[13]||(a[13]=[e("span",{class:"msg-icon"},"âœ…",-1),U(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):I("",!0)],512),e("div",mn,[Pe(e("input",{"onUpdate:modelValue":a[0]||(a[0]=W=>ze(X)?X.value=W:null),type:"text",placeholder:Ie.value,maxlength:"32",disabled:ve.value||o(Z)||o(p),onKeyup:Ae(_e,["enter"]),class:"chat-input-field"},null,40,hn),[[He,o(X)]]),e("button",{onClick:_e,disabled:ve.value||o(Z)||o(p)||!o(X).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,wn)])])],64))])])])):o(F)?(r(),i("div",fn,[e("div",gn,[e("div",_n,[e("div",pn,[e("div",yn,[a[15]||(a[15]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),B(Re,{"show-winner":!0}),e("button",{onClick:ae,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):I("",!0)]))}}),$n=Y(bn,[["__scopeId","data-v-e6d1fea2"]]);export{$n as default};
