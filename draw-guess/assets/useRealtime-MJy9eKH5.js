import{l as z,r as k,f as v,u as M,x as h,m as Z,d as ee,c as N,e as R,a as $,t as E,s as I,F as re,p as te,b as D,o as j,_ as oe}from"./index-CCY5bz-L.js";const B=z("room",()=>{const r=k(null),m=k([]),c=k(!1),a=k(null),f=v(()=>{const o=M();return r.value?.host_id===o.user?.id});async function _(o){try{c.value=!0,a.value=null;const e=M();if(!e.user)throw new Error("請先登入");if(!e.profile&&e.user)try{await e.loadUserProfile(e.user.id,!1)}catch(d){console.warn("載入用戶資料時發生錯誤（非關鍵）:",d)}if(o.words.length<6)throw new Error("至少需要 6 個詞語");if(o.settings.rounds>o.words.length)throw new Error("輪數不能超過詞語總數");let t=null,n=0;const g=10;for(;n<g&&!t;){n++;const S={code:Math.floor(1e5+Math.random()*9e5).toString(),name:o.name,host_id:e.user.id,words:o.words,word_count:o.words.length,status:"waiting",settings:o.settings,current_round:0,current_drawer_id:null},{data:U,error:q}=await h.from("game_rooms").insert(S).select().single();if(q){if(q.code==="23505")continue;throw new Error(q.message||"插入房間失敗")}if(U){t=U;break}}if(!t)throw new Error("無法生成唯一房間碼，請重試");const u={room_id:t.id,user_id:e.user.id,nickname:e.profile?.display_name||"房主",score:0};try{const{error:d}=await h.from("room_participants").insert(u);d&&console.error("創建參與記錄錯誤:",d)}catch(d){console.error("創建參與記錄時發生錯誤:",d)}try{const{data:d,error:S}=await h.from("room_participants").select("*").eq("room_id",t.id).order("joined_at",{ascending:!0});S?console.error("載入參與者列表失敗:",S):d&&(m.value=d)}catch(d){console.error("載入參與者列表時發生錯誤:",d)}return r.value=t,{success:!0,room:t}}catch(e){return a.value=e instanceof Error?e.message:"創建房間失敗",console.error("創建房間錯誤:",e),{success:!1,error:a.value}}finally{c.value=!1}}async function y(o,e){try{c.value=!0,a.value=null;const t=M();if(!t.user)throw new Error("請先登入");if(!/^\d{6}$/.test(o))throw new Error("房間碼必須是 6 位數字");if(!e||e.trim().length===0)throw new Error("請輸入暱稱");if(e.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:n,error:g}=await h.from("game_rooms").select("*").eq("code",o).single();if(g||!n)throw new Error("房間不存在");if(n.status!=="waiting")throw new Error("房間已開始或已結束");const{data:u}=await h.from("room_participants").select("*").eq("room_id",n.id).eq("user_id",t.user.id).maybeSingle();if(u)return r.value=n,await p(n.id),{success:!0,room:n};const{error:d}=await h.from("room_participants").insert({room_id:n.id,user_id:t.user.id,nickname:e.trim(),score:0});if(d){if(d.code==="23505"||d.message.includes("duplicate"))return r.value=n,await p(n.id),{success:!0,room:n};throw d}return r.value=n,await p(n.id),{success:!0,room:n}}catch(t){return a.value=t instanceof Error?t.message:"加入房間失敗",console.error("加入房間錯誤:",t),{success:!1,error:a.value}}finally{c.value=!1}}async function b(){try{if(!r.value)return{success:!0};c.value=!0,a.value=null;const o=M();if(!o.user)throw new Error("請先登入");const{error:e}=await h.from("room_participants").delete().eq("room_id",r.value.id).eq("user_id",o.user.id);if(e)throw new Error(`刪除參與記錄失敗: ${e.message||"未知錯誤"}`);if(f.value){const{error:t}=await h.from("game_rooms").update({status:"finished"}).eq("id",r.value.id);t&&console.error("關閉房間失敗:",t)}return r.value=null,m.value=[],{success:!0}}catch(o){return a.value=o instanceof Error?o.message:"離開房間失敗",console.error("離開房間錯誤:",o),r.value=null,m.value=[],{success:!1,error:a.value}}finally{c.value=!1}}async function p(o){try{const{data:e,error:t}=await h.from("room_participants").select("*").eq("room_id",o).order("joined_at",{ascending:!0});if(t)throw t;m.value=e||[]}catch(e){console.error("載入參與者錯誤:",e)}}async function i(o){try{c.value=!0,a.value=null;const{data:e,error:t}=await h.from("game_rooms").select("*").eq("id",o).single();if(t)throw t;return r.value=e,await p(o),{success:!0,room:e}}catch(e){return a.value=e instanceof Error?e.message:"載入房間失敗",console.error("載入房間錯誤:",e),{success:!1,error:a.value}}finally{c.value=!1}}async function l(o){try{if(!r.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:r.value.id,oldStatus:r.value.status,newStatus:o});const{error:e}=await h.from("game_rooms").update({status:o}).eq("id",r.value.id);if(e)throw e;if(r.value){const t=r.value.status;r.value.status=o,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:t,newStatus:r.value.status})}return{success:!0}}catch(e){return a.value=e instanceof Error?e.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",e),{success:!1,error:a.value}}}function s(){r.value=null,m.value=[],a.value=null}return{currentRoom:r,participants:m,loading:c,error:a,isHost:f,createRoom:_,joinRoom:y,leaveRoom:b,loadParticipants:p,loadRoom:i,updateRoomStatus:l,clearRoom:s}});function ne(){const r=B(),m=v(()=>r.currentRoom),c=v(()=>r.participants),a=v(()=>r.isHost),f=v(()=>!m.value||m.value.status!=="waiting"||!a.value?!1:c.value.length>=2);async function _(p){return await r.createRoom(p)}async function y(p,i){return await r.joinRoom(p,i)}async function b(){return await r.leaveRoom()}return{currentRoom:m,participants:c,isHost:a,canStartGame:f,loading:v(()=>r.loading),error:v(()=>r.error),createRoom:_,joinRoom:y,leaveRoom:b}}const L=100,H=50,F=10,V=100,K=[1,.8,.6,.4,.2];function J(){const r=B();function m(i){const l=Math.min(i,K.length-1),s=K[l]??0;return Math.round(L*s)}function c(i){return i===0?0:H+i*F}async function a(i,l){if(!r.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:s,error:o}=await h.from("room_participants").select("score").eq("room_id",r.currentRoom.id).eq("user_id",i).single();if(o)throw o;const e=(s?.score||0)+l,{error:t}=await h.from("room_participants").update({score:e}).eq("room_id",r.currentRoom.id).eq("user_id",i);if(t)throw t;const n=r.participants.findIndex(g=>g.user_id===i);return n!==-1&&r.participants[n]&&(r.participants[n].score=e),!0}catch(s){return console.error("更新玩家分數錯誤:",s),!1}}async function f(i,l){const s=c(l);return s===0?!0:await a(i,s)}function _(){if(!r.participants||r.participants.length===0)return null;const i=[...r.participants].sort((l,s)=>s.score-l.score);return i.length===1||i[0]&&i[1]&&i[0].score>i[1].score?{user_id:i[0]?.user_id||"",score:i[0]?.score||0}:{user_id:i[0]?.user_id||"",score:i[0]?.score||0}}const y=v(()=>!r.participants||r.participants.length===0?[]:[...r.participants].sort((l,s)=>s.score!==l.score?s.score-l.score:new Date(l.joined_at).getTime()-new Date(s.joined_at).getTime()).map((l,s)=>({id:l.id,user_id:l.user_id,score:l.score,rank:s+1}))),b=v(()=>r.currentRoom?.status!=="finished"?null:_());function p(){return V}return{GUESS_BASE_SCORE:L,DRAWING_BASE_SCORE:H,DRAWING_BONUS_PER_GUESS:F,WINNER_BONUS:V,calculateGuessScore:m,calculateDrawingScore:c,calculateWinner:_,updatePlayerScore:a,updateDrawerScore:f,playerRankings:y,winner:b,getWinnerBonus:p}}const Q=z("game",()=>{const r=B(),m=M(),c=k(null),a=k(null),f=k([]),_=v(()=>f.value.filter(e=>e.is_correct));async function y(e){try{const{data:t,error:n}=await h.from("game_rounds").select("*").eq("room_id",e).order("round_number",{ascending:!1}).limit(1).single();if(n&&n.code!=="PGRST116")throw n;return t&&(c.value=t,a.value=t.word_text,await b(t.id)),{success:!0,round:t}}catch(t){return console.error("載入當前輪次錯誤:",t),{success:!1,error:t instanceof Error?t.message:"載入輪次失敗"}}}async function b(e){try{const{data:t,error:n}=await h.from("guesses").select("*").eq("round_id",e).order("guessed_at",{ascending:!0});if(n)throw n;f.value=t||[]}catch(t){console.error("載入猜測記錄錯誤:",t)}}async function p(e,t,n,g){try{if(!r.currentRoom)throw new Error("沒有當前房間");const u=(r.currentRoom.current_round||0)+1,{data:d,error:S}=await h.from("game_rounds").insert({room_id:e,round_number:u,drawer_id:t,word_text:n,word_source:g}).select().single();if(S)throw S;return c.value=d,a.value=n,f.value=[],await h.from("game_rooms").update({current_round:u,current_drawer_id:t}).eq("id",e),{success:!0,round:d}}catch(u){return console.error("創建輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"創建輪次失敗"}}}function i(e){return f.value.some(t=>t.user_id===e&&t.is_correct)}const l=v(()=>!c.value||!m.user?!1:c.value.drawer_id===m.user.id);async function s(){if(!c.value||!r.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const e=_.value.length,{updateDrawerScore:t}=J();await t(c.value.drawer_id,e);const{error:n}=await h.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",c.value.id);if(n)throw n;return{success:!0}}catch(e){return console.error("結束輪次錯誤:",e),{success:!1,error:e instanceof Error?e.message:"結束輪次失敗"}}}function o(){c.value=null,a.value=null,f.value=[]}return{currentRound:c,currentWord:a,guesses:f,correctGuesses:_,isCurrentDrawer:l,loadCurrentRound:y,loadGuesses:b,createRound:p,hasGuessed:i,endRound:s,clearGame:o}});function se(){const r=B(),m=Q(),{updateDrawerScore:c}=J(),a=k(null),f=k(!1);let _=null;const y=v(()=>r.currentRoom?.status||"waiting"),b=v(()=>y.value==="playing"),p=v(()=>y.value==="waiting"),i=v(()=>y.value==="finished"),l=v(()=>m.currentRound),s=v(()=>r.currentRoom?.current_round||0),o=v(()=>r.currentRoom?.settings.rounds||0),e=v(()=>r.currentRoom?.settings.draw_time||60),t=v(()=>m.isCurrentDrawer);function n(w){_&&clearInterval(_),a.value=w,f.value=!0,_=window.setInterval(()=>{a.value!==null&&a.value>0?a.value--:(g(),b.value&&l.value&&U())},1e3)}function g(){_&&(clearInterval(_),_=null),f.value=!1}function u(){g(),a.value=null}async function d(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};if(r.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(r.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const w=await r.updateRoomStatus("playing");return w.success?await S():w}catch(w){return console.error("開始遊戲錯誤:",w),{success:!1,error:w instanceof Error?w.message:"開始遊戲失敗"}}}async function S(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};const w=r.currentRoom.words,x=r.currentRoom.current_round||0;if(x>=w.length||x>=o.value)return await q(),{success:!1,error:"所有輪次已完成"};try{const C=w[x],Y=x%r.participants.length,A=r.participants[Y];if(!A||!C)throw new Error("無法選擇畫家或詞語");const W=await m.createRound(r.currentRoom.id,A.user_id,C.text,C.source);return W.success&&W.round&&n(e.value),W}catch(C){return console.error("開始下一輪錯誤:",C),{success:!1,error:C instanceof Error?C.message:"開始下一輪失敗"}}}async function U(){if(!l.value||!r.currentRoom)return{success:!1,error:"沒有當前輪次"};try{g();const w=m.correctGuesses.length;await c(l.value.drawer_id,w);const x=await m.endRound();return x.success?(r.currentRoom.current_round||0)>=o.value?(await q(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await S()},2e3),{success:!0,gameEnded:!1}):x}catch(w){return console.error("結束輪次錯誤:",w),{success:!1,error:w instanceof Error?w.message:"結束輪次失敗"}}}async function q(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};try{return g(),await r.updateRoomStatus("finished"),{success:!0}}catch(w){return console.error("結束遊戲錯誤:",w),{success:!1,error:w instanceof Error?w.message:"結束遊戲失敗"}}}const X=v(()=>{if(a.value===null)return"--:--";const w=Math.floor(a.value/60),x=a.value%60;return`${w.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`});return Z(()=>{g()}),{gameStatus:y,isPlaying:b,isWaiting:p,isFinished:i,currentRound:l,currentRoundNumber:s,totalRounds:o,drawTime:e,isCurrentDrawer:t,timeRemaining:a,isCountingDown:f,formattedTime:X,startGame:d,startNextRound:S,endRound:U,endGame:q,startCountdown:n,stopCountdown:g,resetCountdown:u}}const ae={class:"waiting-lobby"},ce={class:"card"},ie={class:"card-body"},ue={class:"margin-bottom-medium"},le={class:"card-title text-hand-title"},de={class:"text-small"},me={style:{"font-family":"monospace"}},fe={class:"text-small margin-top-small"},ge={class:"margin-bottom-medium"},we={class:"text-hand-title"},he={class:"margin-top-small"},ve={style:{"flex-shrink":"0","margin-right":"0.75rem"}},_e={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},pe={style:{flex:"1"}},Re={class:"text-hand",style:{"font-weight":"500"}},be={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},ye={class:"margin-bottom-medium text-small"},Se=["disabled"],Ee={key:1,class:"text-small text-center margin-bottom-small"},xe=["disabled"],ke={key:0,class:"alert alert-danger margin-top-medium"},De=ee({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(r,{emit:m}){const c=r,a=m,{isHost:f,canStartGame:_,leaveRoom:y,loading:b,error:p}=ne(),{startGame:i}=se();function l(t){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[t||""]||t||"未知"}function s(t){return c.room?.host_id===t}async function o(){(await i()).success&&a("startGame")}async function e(){(await y()).success&&a("leaveRoom")}return(t,n)=>(j(),N("div",ae,[R("div",ce,[R("div",ie,[R("div",ue,[R("h2",le,E(r.room?.name),1),R("div",de,[n[0]||(n[0]=I(" 房間碼：",-1)),R("span",me,E(r.room?.code),1)]),R("div",fe," 狀態："+E(l(r.room?.status)),1)]),R("div",ge,[R("h4",we,"玩家列表 ("+E(r.participants.length)+")",1),R("div",he,[(j(!0),N(re,null,te(r.participants,g=>(j(),N("div",{key:g.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[R("div",ve,[R("div",_e,E(g.nickname.charAt(0).toUpperCase()),1)]),R("div",pe,[R("div",Re,[I(E(g.nickname)+" ",1),s(g.user_id)?(j(),N("span",be," 房主 ")):$("",!0)])])]))),128))])]),R("div",ye,[R("div",null,"繪畫時間："+E(r.room?.settings.draw_time)+" 秒",1),R("div",null,"輪數："+E(r.room?.settings.rounds)+" 輪",1),R("div",null,"詞語總數："+E(r.room?.word_count)+" 個",1)]),R("div",null,[D(f)&&D(_)?(j(),N("button",{key:0,onClick:o,disabled:D(b),class:"paper-btn btn-primary btn-block margin-bottom-small"},E(D(b)?"開始中...":"開始遊戲"),9,Se)):D(f)?(j(),N("div",Ee," 至少需要 2 個玩家才能開始遊戲 ")):$("",!0),R("button",{onClick:e,disabled:D(b),class:"paper-btn btn-secondary btn-block"},E(D(b)?"離開中...":"離開房間"),9,xe)]),D(p)?(j(),N("div",ke,E(D(p)),1)):$("",!0)])])]))}}),Ge=oe(De,[["__scopeId","data-v-769c8ad1"]]),P=new Map,G=k("disconnected"),T=new Map,O=new Set;function qe(){const r=B(),m=Q();function c(s){const o=`room:${s}`;if(P.has(o))return P.get(o);console.log("[useRealtime] 創建新 channel:",o);const e=h.channel(o,{config:{presence:{key:"user"},broadcast:{self:!1}}});return P.set(o,e),e}function a(s,o,e,t){if(!s||!o){console.warn("[subscribeRoom] 缺少 roomCode 或 roomId");return}const n=c(s),g=n.state;return console.log("[subscribeRoom] roomCode:",s,"channelState:",g),g==="joined"?(console.log("[subscribeRoom] Channel 已連接，跳過訂閱"),G.value="connected",n):g==="joining"?(console.log("[subscribeRoom] Channel 正在連接中，跳過"),n):O.has(s)?(console.log("[subscribeRoom] 監聽器已設置，只需重新訂閱"),G.value="connecting",n.subscribe(async u=>{f(u,n,e,t)}),n):(n.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${o}`},async u=>{console.log("[Realtime] 房間狀態變化:",u),r.currentRoom&&await r.loadRoom(r.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${o}`},async u=>{console.log("[Realtime] 參與者變化:",u),await r.loadParticipants(o)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${o}`},async u=>{console.log("[Realtime] 輪次變化:",u),r.currentRoom&&await m.loadCurrentRound(r.currentRoom.id)}).on("broadcast",{event:"drawing"},u=>{console.log("[Realtime] 收到繪畫數據:",u),(T.get(s)||[]).forEach(S=>{u.payload?.stroke&&S(u.payload.stroke)})}).on("presence",{event:"sync"},()=>{const u=n.presenceState();console.log("[Realtime] Presence 狀態:",u)}).on("presence",{event:"join"},({key:u,newPresences:d})=>{console.log("[Realtime] 玩家加入:",u,d)}).on("presence",{event:"leave"},({key:u,leftPresences:d})=>{console.log("[Realtime] 玩家離開:",u,d)}),O.add(s),G.value="connecting",n.subscribe(async u=>{f(u,n,e,t)}),n)}async function f(s,o,e,t){if(console.log("[Realtime] 訂閱狀態:",s),s==="SUBSCRIBED"){G.value="connected";try{await o.track({user_id:e,...t})}catch(n){console.warn("[Realtime] Presence track 失敗:",n)}}else s==="CHANNEL_ERROR"||s==="TIMED_OUT"?(G.value="disconnected",console.warn("[Realtime] 訂閱失敗:",s)):s==="CLOSED"&&(G.value="disconnected",console.log("[Realtime] 連接關閉"))}function _(s,o){console.log("[subscribeDrawing] 註冊繪畫回調，roomCode:",s),T.has(s)||T.set(s,[]);const e=T.get(s);return e.includes(o)||e.push(o),()=>{const t=e.indexOf(o);t>=0&&e.splice(t,1)}}function y(s,o){const e=c(s);return e.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${o}`},async t=>{console.log("[Realtime] 猜測記錄變化:",t),await m.loadGuesses(o)}),e}async function b(s,o){const e=c(s),t=e.state;if(console.log("[sendDrawing] roomCode:",s,"channelState:",t),t!=="joined")return console.warn("[sendDrawing] Channel 未連接，狀態:",t),{error:"Channel 未連接"};try{const n=await e.send({type:"broadcast",event:"drawing",payload:{stroke:o}});return n==="error"?(console.warn("[sendDrawing] 發送失敗"),{error:"發送失敗"}):(console.log("[sendDrawing] 發送成功"),n)}catch(n){return console.warn("[sendDrawing] 發送錯誤:",n),{error:n instanceof Error?n.message:"發送失敗"}}}function p(s){const o=`room:${s}`,e=P.get(o);console.log("[unsubscribeRoom] roomCode:",s,"channel exists:",!!e),e&&(h.removeChannel(e),P.delete(o)),T.delete(s),O.delete(s)}function i(){P.forEach(s=>{h.removeChannel(s)}),P.clear(),T.clear(),O.clear()}function l(){return G.value}return{connectionStatus:G,subscribeRoom:a,subscribeDrawing:_,subscribeGuesses:y,sendDrawing:b,unsubscribeRoom:p,unsubscribeAll:i,getConnectionStatus:l}}export{Ge as W,se as a,qe as b,B as c,Q as d,J as e,ne as u};
