const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-gHJ9yNH2.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as ur,f as S,y as Ge,c as j,o as z,z as Cr,a as pe,e as C,A as Gr,B as Oe,r as U,u as de,E as R,L as qe,h as Tr,t as V,s as oe,n as Ve,F as je,m as Ar,b as te,_ as xr}from"./index-gHJ9yNH2.js";const Pr=["width","height","fill","transform"],Dr={key:0},Nr=C("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),Mr=[Nr],qr={key:1},Or=C("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),kr=C("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Hr=[Or,kr],Br={key:2},Ur=C("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),$r=[Ur],Wr={key:3},Zr=C("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Lr=[Zr],Vr={key:4},jr=C("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),zr=[jr],Yr={key:5},Kr=C("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Fr=[Kr],Jr={name:"PhPaintBrush"},kt=ur({...Jr,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const i=e,s=Ge("weight","regular"),u=Ge("size","1em"),T=Ge("color","currentColor"),D=Ge("mirrored",!1),w=S(()=>i.weight??s),Z=S(()=>i.size??u),M=S(()=>i.color??T),E=S(()=>i.mirrored!==void 0?i.mirrored?"scale(-1, 1)":void 0:D?"scale(-1, 1)":void 0);return(h,G)=>(z(),j("svg",Gr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:Z.value,height:Z.value,fill:M.value,transform:E.value},h.$attrs),[Cr(h.$slots,"default"),w.value==="bold"?(z(),j("g",Dr,Mr)):w.value==="duotone"?(z(),j("g",qr,Hr)):w.value==="fill"?(z(),j("g",Br,$r)):w.value==="light"?(z(),j("g",Wr,Lr)):w.value==="regular"?(z(),j("g",Vr,zr)):w.value==="thin"?(z(),j("g",Yr,Fr)):pe("",!0)],16,Pr))}}),be=Oe("room",()=>{const e=U(null),i=U([]),s=U(!1),u=U(null),T=S(()=>{const t=de();return e.value?.host_id===t.user?.id});async function D(t){try{s.value=!0,u.value=null;const r=de();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(W){console.warn("載入用戶資料時發生錯誤（非關鍵）:",W)}const m=t.gameMode||"classic";if(m==="classic"&&t.words.length<6)throw new Error("至少需要 6 個詞語");let g=null,q=0;const N=10;for(;q<N&&!g;){q++;const Y={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null,game_mode:m,single_round_mode:t.singleRoundMode||!1,is_final_round:!1},{data:Q,error:n}=await R.from("game_rooms").insert(Y).select().single();if(n){if(n.code==="23505")continue;throw new Error(n.message||"插入房間失敗")}if(Q){g=Q;break}}if(!g)throw new Error("無法生成唯一房間碼，請重試");const _={room_id:g.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:W}=await R.from("room_participants").insert(_);W&&console.error("創建參與記錄錯誤:",W)}catch(W){console.error("創建參與記錄時發生錯誤:",W)}try{const{data:W,error:Y}=await R.from("room_participants").select("*").eq("room_id",g.id).order("joined_at",{ascending:!0});Y?console.error("載入參與者列表失敗:",Y):W&&(i.value=W)}catch(W){console.error("載入參與者列表時發生錯誤:",W)}return e.value=g,{success:!0,room:g}}catch(r){return u.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:u.value}}finally{s.value=!1}}async function w(t,r){try{s.value=!0,u.value=null;const m=de();if(!m.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:g,error:q}=await R.from("game_rooms").select("*").eq("code",t).single();if(q||!g)throw new Error("房間不存在");if(g.status!=="waiting")throw new Error("房間已開始或已結束");const{data:N}=await R.from("room_participants").select("*").eq("room_id",g.id).eq("user_id",m.user.id).maybeSingle();if(N)return e.value=g,await M(g.id),{success:!0,room:g};const{error:_}=await R.from("room_participants").insert({room_id:g.id,user_id:m.user.id,nickname:r.trim(),score:0});if(_){if(_.code==="23505"||_.message.includes("duplicate"))return e.value=g,await M(g.id),{success:!0,room:g};throw _}return e.value=g,await M(g.id),{success:!0,room:g}}catch(m){return u.value=m instanceof Error?m.message:"加入房間失敗",console.error("加入房間錯誤:",m),{success:!1,error:u.value}}finally{s.value=!1}}async function Z(){try{if(!e.value)return{success:!0};s.value=!0,u.value=null;const t=de();if(!t.user)throw new Error("請先登入");const{error:r}=await R.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(T.value){const{error:m}=await R.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);m&&console.error("關閉房間失敗:",m)}return e.value=null,i.value=[],{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,i.value=[],{success:!1,error:u.value}}finally{s.value=!1}}async function M(t){try{const{data:r,error:m}=await R.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(m)throw m;i.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function E(t){try{s.value=!0,u.value=null;const{data:r,error:m}=await R.from("game_rooms").select("*").eq("id",t).single();if(m)throw m;return e.value=r,await M(t),{success:!0,room:r}}catch(r){return u.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:u.value}}finally{s.value=!1}}async function h(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await R.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(t==="finished"&&e.value&&await G(),e.value){const m=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:m,newStatus:e.value.status})}return{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:u.value}}}async function G(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:t,error:r}=await R.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(r){console.error("獲取參與者錯誤:",r);return}if(!t||t.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const m=t.map(_=>_.user_id),{data:g,error:q}=await R.from("users").select("id, user_type").in("id",m);if(q){console.error("獲取用戶信息錯誤:",q);return}const N=new Set(g?.filter(_=>_.user_type==="registered").map(_=>_.id)||[]);for(const _ of t){if(!N.has(_.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${_.user_id} 的積分累積`);continue}if(_.score>0){const{error:W}=await R.rpc("accumulate_user_score",{user_id_param:_.user_id,score_to_add:_.score});if(W){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",W);const{data:Y,error:Q}=await R.from("users").select("total_score").eq("id",_.user_id).single();if(Q){console.error(`[RoomStore] 獲取用戶 ${_.user_id} 總積分錯誤:`,Q);continue}const n=(Y?.total_score||0)+_.score,{error:c}=await R.from("users").update({total_score:n}).eq("id",_.user_id);c?console.error(`[RoomStore] 更新用戶 ${_.user_id} 總積分錯誤:`,c):console.log(`[RoomStore] 用戶 ${_.user_id} 積分已累積: +${_.score} (總積分: ${n})`)}else console.log(`[RoomStore] 用戶 ${_.user_id} 積分已累積: +${_.score}`)}}}catch(t){console.error("[RoomStore] 累積積分錯誤:",t)}}async function O(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await R.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:u.value}}}async function H(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:t});const r={...e.value.settings,...t},{error:m}=await R.from("game_rooms").update({settings:r}).eq("id",e.value.id);if(m)throw m;return e.value&&(e.value.settings=r,console.log("[RoomStore] 房間設置已更新:",r)),{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",r),{success:!1,error:u.value}}}function $(){e.value=null,i.value=[],u.value=null}function l(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function b(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!T.value)return{success:!1,error:"只有房主可以踢人"};const r=de();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};s.value=!0,u.value=null;const{data:m,error:g}=await R.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(g)throw new Error(g.message);if(m&&!m.success)throw new Error(m.error||"踢出玩家失敗");return await M(e.value.id),{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:u.value}}finally{s.value=!1}}async function d(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:t});const{error:r}=await R.from("game_rooms").update({is_final_round:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.is_final_round=t,console.log("[RoomStore] 最後一局標記已更新:",t)),{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",r),{success:!1,error:u.value}}}return{currentRoom:e,participants:i,loading:s,error:u,isHost:T,createRoom:D,joinRoom:w,leaveRoom:Z,kickPlayer:b,loadParticipants:M,loadRoom:E,updateRoomStatus:h,updateRoomDrawer:O,updateRoomSettings:H,setCurrentDrawer:l,setFinalRound:d,clearRoom:$}});function Qr(){const e=be(),i=S(()=>e.currentRoom),s=S(()=>e.participants),u=S(()=>e.isHost),T=S(()=>i.value&&i.value.game_mode==="storyboard"?3:2),D=S(()=>!i.value||i.value.status!=="waiting"||!u.value?!1:s.value.length>=T.value);async function w(E){return await e.createRoom(E)}async function Z(E,h){return await e.joinRoom(E,h)}async function M(){return await e.leaveRoom()}return{currentRoom:i,participants:s,isHost:u,canStartGame:D,minPlayersRequired:T,loading:S(()=>e.loading),error:S(()=>e.error),createRoom:w,joinRoom:Z,leaveRoom:M}}const ze=100,Ye=50,Ke=10,Xr=10,Fe=100,Je=[1,.8,.6,.4,.2];function et(){const e=be();function i(E){const h=Math.min(E,Je.length-1),G=Je[h]??0;return Math.round(ze*G)}function s(E,h=0){if(E===0)return 0;const G=E*Ke,O=Math.round(h*Xr);return Ye+G+O}async function u(E,h,G=0){const O=s(h,G);return O===0?!0:await T(E,O)}async function T(E,h){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:G,error:O}=await R.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",E).single();if(O)throw O;const H=(G?.score||0)+h,{error:$}=await R.from("room_participants").update({score:H}).eq("room_id",e.currentRoom.id).eq("user_id",E);if($)throw $;const l=e.participants.findIndex(b=>b.user_id===E);return l!==-1&&e.participants[l]&&(e.participants[l].score=H),!0}catch(G){return console.error("更新玩家分數錯誤:",G),!1}}function D(){if(!e.participants||e.participants.length===0)return null;const E=[...e.participants].sort((h,G)=>G.score-h.score);return E.length===1||E[0]&&E[1]&&E[0].score>E[1].score?{user_id:E[0]?.user_id||"",score:E[0]?.score||0}:{user_id:E[0]?.user_id||"",score:E[0]?.score||0}}const w=S(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((h,G)=>G.score!==h.score?G.score-h.score:new Date(h.joined_at).getTime()-new Date(G.joined_at).getTime()).map((h,G)=>({id:h.id,user_id:h.user_id,score:h.score,rank:G+1}))),Z=S(()=>e.currentRoom?.status!=="finished"?null:D());function M(){return Fe}return{GUESS_BASE_SCORE:ze,DRAWING_BASE_SCORE:Ye,DRAWING_BONUS_PER_GUESS:Ke,WINNER_BONUS:Fe,calculateGuessScore:i,calculateDrawingScore:s,calculateWinner:D,updatePlayerScore:T,updateDrawerScore:u,playerRankings:w,winner:Z,getWinnerBonus:M}}const cr=Oe("game",()=>{const e=be(),i=de(),s=U(null),u=U(null),T=U([]),D=S(()=>T.value.filter(a=>a.is_correct)),w=S(()=>s.value?T.value.filter(a=>a.round_id===s.value.id):[]),Z=S(()=>w.value.filter(a=>a.is_correct)),M=U("drawing"),E=U([]),h=U([]),G=U(!1),O=U([]),H=S(()=>h.value.length===0?0:h.value.reduce((f,v)=>f+v.rating,0)/h.value.length);function $(a){M.value=a}function l(a){E.value=a}function b(a){const f=h.value.findIndex(v=>v.rater_id===a.rater_id);f>=0?h.value[f]=a:h.value.push(a)}function d(){h.value=[]}function t(){if(G.value||!u.value)return null;const a=u.value.length,f=[];for(let k=0;k<a;k++)O.value.includes(k)||f.push(k);if(f.length===0)return null;const v=Math.floor(Math.random()*f.length),A=f[v];return A===void 0?null:(O.value.push(A),G.value=!0,A)}function r(a,f){G.value=a,O.value=f}function m(){G.value=!1,O.value=[]}async function g(a,f=!1){try{const{data:v,error:A}=await R.from("game_rounds").select("*").eq("room_id",a).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(A)throw A;return v&&(s.value=v,f||i.user&&v.drawer_id===i.user.id?u.value=v.word_text:u.value=null,v.word_options&&Array.isArray(v.word_options)&&(E.value=v.word_options),v.hint_given!==void 0&&(G.value=v.hint_given),v.revealed_indices&&Array.isArray(v.revealed_indices)&&(O.value=v.revealed_indices),await q(v.id)),{success:!0,round:v}}catch(v){return console.error("載入當前輪次錯誤:",v),{success:!1,error:v instanceof Error?v.message:"載入輪次失敗"}}}async function q(a){try{const{data:f,error:v}=await R.from("guesses").select("*").eq("round_id",a).order("guessed_at",{ascending:!0});if(v)throw v;const A=f||[],k=new Set(T.value.map(ee=>ee.id)),X=A.filter(ee=>!k.has(ee.id));X.length>0&&(T.value=[...T.value,...X])}catch(f){console.error("載入猜測記錄錯誤:",f)}}async function N(a){try{const{data:f,error:v}=await R.from("game_rounds").select("id").eq("room_id",a);if(v)throw v;if(!f||f.length===0){T.value=[];return}const A=f.map(ee=>ee.id),{data:k,error:X}=await R.from("guesses").select("*").in("round_id",A).order("guessed_at",{ascending:!0});if(X)throw X;T.value=k||[]}catch(f){console.error("載入所有猜測記錄錯誤:",f)}}async function _(a,f,v,A){try{if(!e.currentRoom)throw new Error("沒有當前房間");const k=(e.currentRoom.current_round||0)+1,{data:X,error:ee}=await R.from("game_rounds").insert({room_id:a,round_number:k,drawer_id:f,word_text:v,word_source:A}).select().single();if(ee)throw ee;return s.value=X,u.value=v,await R.from("game_rooms").update({current_round:k,current_drawer_id:f}).eq("id",a),{success:!0,round:X}}catch(k){return console.error("創建輪次錯誤:",k),{success:!1,error:k instanceof Error?k.message:"創建輪次失敗"}}}function W(a){return s.value?T.value.some(f=>f.round_id===s.value.id&&f.user_id===a&&f.is_correct):!1}const Y=S(()=>!s.value||!i.user?!1:s.value.drawer_id===i.user.id);async function Q(){if(!s.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const a=D.value.length,f=H.value,{updateDrawerScore:v}=et();console.log("[endRound] 猜中人數:",a,"平均評分:",f),await v(s.value.drawer_id,a,f);const{error:A}=await R.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",s.value.id);if(A)throw A;return{success:!0}}catch(a){return console.error("結束輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"結束輪次失敗"}}}function n(){s.value=null,u.value=null,T.value=[],M.value="drawing",E.value=[],h.value=[],G.value=!1,O.value=[]}async function c(a,f,v){if(!i.user)return{success:!1,error:"用戶未登錄"};try{const{data:A,error:k}=await R.from("drawing_ratings").upsert({round_id:a,rater_id:i.user.id,drawer_id:f,rating:v},{onConflict:"round_id,rater_id"}).select().single();if(k)throw k;return A&&b(A),{success:!0,rating:A}}catch(A){return console.error("提交評分錯誤:",A),{success:!1,error:A instanceof Error?A.message:"提交評分失敗"}}}async function y(a){try{const{data:f,error:v}=await R.from("drawing_ratings").select("*").eq("round_id",a);if(v)throw v;return h.value=f||[],{success:!0,ratings:f}}catch(f){return console.error("載入評分錯誤:",f),{success:!1,error:f instanceof Error?f.message:"載入評分失敗"}}}return{currentRound:s,currentWord:u,guesses:T,correctGuesses:D,currentRoundGuesses:w,currentRoundCorrectGuesses:Z,isCurrentDrawer:Y,roundStatus:M,wordOptions:E,ratings:h,averageRating:H,hintGiven:G,revealedIndices:O,loadCurrentRound:g,loadGuesses:q,loadAllGuesses:N,createRound:_,hasGuessed:W,endRound:Q,clearGame:n,setRoundStatus:$,setWordOptions:l,addRating:b,clearRatings:d,submitRating:c,loadRatings:y,giveHint:t,setHintState:r,resetHint:m}});function Qe(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function Xe(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function er(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function Ht(e){return e.trim().length===0}function Bt(e,i=100){return e.length>i}const rt=Oe("story",()=>{const e=de(),i=U([]),s=U([]),u=U([]),T=U("setup"),D=U(!1),w=U(null),Z=S(()=>{const n=i.value.filter(c=>c.itemType==="text");return n.length===0?null:n[n.length-1]}),M=S(()=>{if(i.value.length===0)return null;const n=i.value[0];return n&&n.itemType==="text"?n.content:null}),E=S(()=>e.user&&s.value.find(n=>n.userId===e.user.id)||null),h=S(()=>e.user&&u.value.find(n=>n.voterId===e.user.id)||null),G=S(()=>{const n=new Map;for(const c of s.value)n.set(c.id,0);for(const c of u.value){const y=n.get(c.submissionId)||0;n.set(c.submissionId,y+1)}return n}),O=S(()=>{if(s.value.length===0)return null;let n=-1,c=[];for(const y of s.value){const a=G.value.get(y.id)||0;a>n?(n=a,c=[y]):a===n&&c.push(y)}return c.length>0?c[0]:null});async function H(n){try{D.value=!0,w.value=null;const{data:c,error:y}=await R.from("story_chains").select("*").eq("room_id",n).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(y)throw new Error(y.message);return i.value=(c||[]).map(a=>Qe(a)),console.log("[StoryStore] 故事鏈已載入:",i.value.length,"項"),{success:!0,data:i.value}}catch(c){return w.value=c instanceof Error?c.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",c),{success:!1,error:w.value}}finally{D.value=!1}}async function $(n){try{D.value=!0,w.value=null;const c={room_id:n.roomId,round_number:n.roundNumber,item_type:n.itemType,content:n.content,author_id:n.authorId,author_name:n.authorName},{data:y,error:a}=await R.from("story_chains").insert(c).select().single();if(a)throw new Error(a.message);const f=Qe(y);return i.value.push(f),console.log("[StoryStore] 故事鏈項目已添加:",f),{success:!0,data:f}}catch(c){return w.value=c instanceof Error?c.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",c),{success:!1,error:w.value}}finally{D.value=!1}}async function l(n,c,y,a){return $({roomId:n,roundNumber:0,itemType:"text",content:c,authorId:y,authorName:a})}async function b(n,c,y,a){return $({roomId:n,roundNumber:-1,itemType:"text",content:c,authorId:y,authorName:a})}async function d(n){try{D.value=!0,w.value=null;const{data:c,error:y}=await R.from("story_submissions").select("*").eq("round_id",n).order("created_at",{ascending:!0});if(y)throw new Error(y.message);return s.value=(c||[]).map(a=>Xe(a)),console.log("[StoryStore] 句子提交已載入:",s.value.length,"項"),{success:!0,data:s.value}}catch(c){return w.value=c instanceof Error?c.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",c),{success:!1,error:w.value}}finally{D.value=!1}}async function t(n,c){if(!e.user)return{success:!1,error:"用戶未登錄"};try{D.value=!0,w.value=null;const y={round_id:n,user_id:e.user.id,sentence:c.trim(),vote_count:0,is_winner:!1},{data:a,error:f}=await R.from("story_submissions").upsert(y,{onConflict:"round_id,user_id"}).select().single();if(f)throw new Error(f.message);const v=Xe(a),A=s.value.findIndex(k=>k.roundId===n&&k.userId===e.user.id);return A>=0?s.value[A]=v:s.value.push(v),console.log("[StoryStore] 句子已提交:",v),{success:!0,data:v}}catch(y){return w.value=y instanceof Error?y.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",y),{success:!1,error:w.value}}finally{D.value=!1}}async function r(n){try{const{error:c}=await R.from("story_submissions").update({is_winner:!0}).eq("id",n);if(c)throw new Error(c.message);const y=s.value.find(a=>a.id===n);return y&&(y.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",n),{success:!0}}catch(c){return w.value=c instanceof Error?c.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",c),{success:!1,error:w.value}}}async function m(n){try{D.value=!0,w.value=null;const{data:c,error:y}=await R.from("story_votes").select("*").eq("round_id",n);if(y)throw new Error(y.message);return u.value=(c||[]).map(a=>er(a)),console.log("[StoryStore] 投票記錄已載入:",u.value.length,"項"),{success:!0,data:u.value}}catch(c){return w.value=c instanceof Error?c.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",c),{success:!1,error:w.value}}finally{D.value=!1}}async function g(n,c){if(!e.user)return{success:!1,error:"用戶未登錄"};try{D.value=!0,w.value=null;const y={round_id:n,voter_id:e.user.id,submission_id:c},{data:a,error:f}=await R.from("story_votes").upsert(y,{onConflict:"round_id,voter_id"}).select().single();if(f)throw new Error(f.message);const v=er(a),A=u.value.findIndex(k=>k.roundId===n&&k.voterId===e.user.id);return A>=0?u.value[A]=v:u.value.push(v),console.log("[StoryStore] 投票已記錄:",v),{success:!0,data:v}}catch(y){return w.value=y instanceof Error?y.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",y),{success:!1,error:w.value}}finally{D.value=!1}}function q(n){T.value=n,console.log("[StoryStore] 階段已更新:",n)}function N(){s.value=[],u.value=[],console.log("[StoryStore] 輪次數據已清除")}function _(){i.value=[],s.value=[],u.value=[],T.value="setup",w.value=null,console.log("[StoryStore] 所有故事數據已清除")}function W(n){i.value.some(y=>y.id===n.id)||(i.value.push(n),console.log("[StoryStore] 本地添加故事鏈項目:",n))}function Y(n){const c=s.value.findIndex(y=>y.id===n.id);c>=0?s.value[c]=n:s.value.push(n),console.log("[StoryStore] 本地添加句子提交:",n)}function Q(n){const c=u.value.findIndex(y=>y.roundId===n.roundId&&y.voterId===n.voterId);c>=0?u.value[c]=n:u.value.push(n),console.log("[StoryStore] 本地添加投票記錄:",n)}return{storyChain:i,submissions:s,votes:u,currentPhase:T,loading:D,error:w,latestSentence:Z,storyOpening:M,mySubmission:E,myVote:h,voteCounts:G,winningSubmission:O,loadStoryChain:H,addStoryChainItem:$,addStoryOpening:l,addStoryEnding:b,addStoryChainItemLocal:W,loadSubmissions:d,submitSentence:t,markWinningSubmission:r,addSubmissionLocal:Y,loadVotes:m,castVote:g,addVoteLocal:Q,setPhase:q,clearRoundData:N,clearAll:_}}),ne=new Map,se=U("disconnected"),ie=new Map,Re=new Set;function ae(...e){}function J(...e){console.warn("[Realtime]",...e)}function ue(){const e=be(),i=cr();function s(l){const b=`room:${l}`;if(ne.has(b))return ne.get(b);const d=R.channel(b,{config:{presence:{key:"user"},broadcast:{self:!0}}});return ne.set(b,d),d}function u(l,b,d,t,r){l==="SUBSCRIBED"?(se.value="connected",b.track({user_id:t,...r}).catch(m=>{J("Presence track 失敗:",m)})):l==="CHANNEL_ERROR"||l==="TIMED_OUT"?(se.value="disconnected",J("訂閱失敗:",l)):l==="CLOSED"&&(se.value="disconnected")}function T(l,b,d,t){return new Promise((r,m)=>{if(!l||!b){J("缺少 roomCode 或 roomId"),m(new Error("缺少 roomCode 或 roomId"));return}const g=s(l),q=g.state;if(q==="joined"){se.value="connected",r(g);return}if(q==="joining"){const N=setInterval(()=>{const _=g.state;_==="joined"?(clearInterval(N),r(g)):(_==="closed"||_==="errored")&&(clearInterval(N),m(new Error(`連接失敗: ${_}`)))},100);setTimeout(()=>{clearInterval(N),g.state!=="joined"&&(J("subscribeRoom - 連接超時"),m(new Error("連接超時")))},1e4);return}if(Re.has(l)){se.value="connecting",g.subscribe(N=>{u(N,g,l,d,t),N==="SUBSCRIBED"?r(g):(N==="CHANNEL_ERROR"||N==="TIMED_OUT")&&m(new Error(`訂閱失敗: ${N}`))});return}D(g,l,b),Re.add(l),se.value="connecting",g.subscribe(N=>{u(N,g,l,d,t),N==="SUBSCRIBED"?r(g):(N==="CHANNEL_ERROR"||N==="TIMED_OUT")&&m(new Error(`訂閱失敗: ${N}`))})})}function D(l,b,d){l.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${d}`},async t=>{ae("房間狀態變化:",t.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${d}`},async t=>{ae("參與者變化:",t.eventType),await e.loadParticipants(d)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${d}`},async t=>{if(ae("輪次變化:",t.eventType,t.new),e.currentRoom){const r=t.new,m=i.currentRound?.id;m?t.eventType==="INSERT"&&r?.id!==m?(ae("輪次變化：新輪次 INSERT",{newId:r?.id,currentId:m}),await i.loadCurrentRound(e.currentRoom.id)):t.eventType:await i.loadCurrentRound(e.currentRoom.id)}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async t=>{const r=t.new;if(r&&i.currentRound&&(await i.loadGuesses(r.round_id),r.is_correct&&e.isHost&&i.roundStatus==="drawing")){const m=i.currentRound.drawer_id,g=e.participants.filter(_=>_.user_id!==m),q=new Set(i.currentRoundCorrectGuesses.map(_=>_.user_id));if(g.length>0&&g.every(_=>q.has(_.user_id))){const{useGame:_}=await qe(async()=>{const{useGame:Y}=await Promise.resolve().then(()=>ot);return{useGame:Y}},void 0),{endRound:W}=_();await W()}}}).on("broadcast",{event:"drawing"},t=>{const r=ie.get(b);r&&t.payload?.stroke&&(ae("分發給",r.size,"個回調"),r.forEach(m=>m(t.payload.stroke)))}).on("presence",{event:"sync"},()=>{const t=l.presenceState();ae("Presence 同步，在線:",Object.keys(t).length)})}function w(l,b){return ie.has(l)||ie.set(l,new Set),ie.get(l).add(b),()=>{ie.get(l)?.delete(b)}}function Z(l,b){const d=s(l),t=`guesses:${b}`;return d[t]||(d.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${b}`},async r=>{ae("收到新猜測記錄:",r.eventType,r.new),await i.loadGuesses(b)}),d[t]=!0),d}function M(l,b){const d=s(l),t=`gameState:${l}`;return d[t]||(d.on("broadcast",{event:"game_state"},r=>{ae("收到遊戲狀態廣播:",r.payload),b(r.payload)}),d[t]=!0),d}async function E(l,b){const d=s(l),t=d.state;if(t!=="joined")return J("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{ae("廣播遊戲狀態:",b);const r=await d.send({type:"broadcast",event:"game_state",payload:b});return r==="error"?(J("發送遊戲狀態失敗"),{error:"發送失敗"}):r}catch(r){return J("發送遊戲狀態錯誤:",r),{error:r instanceof Error?r.message:"發送失敗"}}}async function h(l,b){const d=s(l),t=d.state;if(t!=="joined")return J("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const r=await d.send({type:"broadcast",event:"drawing",payload:{stroke:b}});return r==="error"?(J("發送失敗"),{error:"發送失敗"}):r}catch(r){return J("發送錯誤:",r),{error:r instanceof Error?r.message:"發送失敗"}}}function G(l){const b=`room:${l}`,d=ne.get(b);d&&(R.removeChannel(d),ne.delete(b)),ie.delete(l),Re.delete(l)}async function O(l,b,d,t){const r=`room:${l}`,m=ne.get(r);if(!m){try{await T(l,b,d,t)}catch(q){J("連接恢復：重新訂閱失敗:",q)}return}const g=m.state;if(g==="joined"){se.value="connected";return}if(g!=="joining"&&(g==="errored"||g==="closed")){try{R.removeChannel(m)}catch(q){J("移除異常 Channel 失敗:",q)}ne.delete(r),Re.delete(l);try{await T(l,b,d,t)}catch(q){J("連接恢復：重新訂閱失敗:",q)}}}function H(){ne.forEach(l=>R.removeChannel(l)),ne.clear(),ie.clear(),Re.clear()}function $(){return se.value}return{connectionStatus:se,subscribeRoom:T,subscribeDrawing:w,subscribeGuesses:Z,subscribeGameState:M,sendDrawing:h,broadcastGameState:E,unsubscribeRoom:G,unsubscribeAll:H,getConnectionStatus:$,checkAndRestoreConnection:O}}const rr=6,tr=60,or=60,nr=60,tt=5,Pe=10,De=5,Ne=2,sr=3,ve=U(null),Me=U(!1);let we=null;const le=U(null);let he=null;const Te=U(new Set),ar=U("setup"),_e=U(null);let ye=null;function ir(){const e=be(),i=cr(),s=rt();ue();const u=ve,T=Me,D=le,w=S(()=>e.currentRoom?.status||"waiting"),Z=S(()=>w.value==="playing"),M=S(()=>w.value==="waiting"),E=S(()=>w.value==="finished"),h=S(()=>i.roundStatus),G=S(()=>h.value==="drawing"),O=S(()=>h.value==="summary"),H=S(()=>e.currentRoom?.game_mode==="storyboard"),$=ar,l=_e,b=S(()=>H.value&&$.value==="drawing"),d=S(()=>H.value&&$.value==="writing"),t=S(()=>H.value&&$.value==="voting"),r=S(()=>H.value&&$.value==="summary"),m=S(()=>H.value&&$.value==="setup"),g=S(()=>H.value&&$.value==="ending"),q=S(()=>i.currentRound),N=S(()=>e.currentRoom?.current_round||0),_=S(()=>e.currentRoom?.settings.rounds||0),W=S(()=>e.currentRoom?.settings.draw_time||60),Y=S(()=>i.isCurrentDrawer);function Q(o){console.log("[useGame] startCountdown 開始，時長:",o,"秒"),we&&clearInterval(we),ve.value=o,Me.value=!0,we=window.setInterval(()=>{ve.value!==null&&ve.value>0?ve.value--:(n(),Z.value&&q.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),X()))},1e3)}function n(){we&&(clearInterval(we),we=null),Me.value=!1}function c(){n(),ve.value=null}function y(){console.log("[useGame] startSummaryCountdown 開始"),he&&clearInterval(he),le.value=rr,console.log("[useGame] 開始總結倒計時:",rr,"秒"),he=window.setInterval(async()=>{le.value!==null&&le.value>0?(le.value--,console.log("[useGame] 總結倒計時:",le.value)):(a(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await ee()))},1e3)}function a(){console.log("[useGame] stopSummaryCountdown"),he&&(clearInterval(he),he=null),le.value=null}function f(){if(!e.currentRoom)return null;const o=e.currentRoom.words;if(o.length===0)return null;const p=[];for(let P=0;P<o.length;P++)Te.value.has(P)||p.push(P);let I=0;if(p.length>0){const P=Math.floor(Math.random()*p.length);I=p[P]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),Te.value.clear(),I=Math.floor(Math.random()*o.length);return Te.value.add(I),o[I]??null}async function v(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{Te.value.clear();const o=e.participants.length,p=await e.updateRoomSettings({rounds:o});if(!p.success)return p;console.log("[useGame] 輪數已自動設定為房間人數:",o);const I=await e.updateRoomStatus("playing");if(!I.success)return I;if(H.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),ce("setup"),s.clearAll();const{broadcastGameState:x}=ue();return await x(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await A()}catch(o){return console.error("開始遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"開始遊戲失敗"}}}async function A(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const p=(e.currentRoom.current_round||0)+1;try{const I=(p-1)%e.participants.length,P=e.participants[I];if(console.log("[startDrawingPhase] 第",p,"輪，畫家:",P?.nickname),!P)throw new Error("無法選擇畫家");let x=null;if(H.value){const re=s.latestSentence;re?(x={text:re.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",x.text)):(x={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(x=f(),!x)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",x.text)}await e.updateRoomDrawer(P.user_id);const B=await i.createRound(e.currentRoom.id,P.user_id,x.text,x.source);if(!B.success||!B.round)throw new Error("創建輪次失敗");const{broadcastGameState:F}=ue();return H.value?await F(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:P.user_id,drawerName:P.nickname,roundNumber:p,startedAt:B.round.started_at}):await F(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:P.user_id,drawerName:P.nickname,roundNumber:p,startedAt:B.round.started_at}),{success:!0,drawerId:P.user_id,word:x.text}}catch(I){return console.error("開始繪畫階段錯誤:",I),{success:!1,error:I instanceof Error?I.message:"開始繪畫階段失敗"}}}async function k(){return await A()}async function X(){if(!q.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const o=await i.endRound();if(!o.success)return o;const p=!1,{broadcastGameState:I}=ue();return await I(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:p}),{success:!0,gameEnded:p}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}async function ee(){return e.currentRoom?e.isHost?(await A(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function lr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await e.updateRoomStatus("finished"),{success:!0}}catch(o){return console.error("結束遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束遊戲失敗"}}}async function dr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(h.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),a(),await A()}catch(o){return console.error("下一局錯誤:",o),{success:!1,error:o instanceof Error?o.message:"下一局失敗"}}}const mr=S(()=>{if(u.value===null)return"--:--";const o=Math.floor(u.value/60),p=u.value%60;return`${o.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`});function ce(o){console.log("[useGame] 設置分鏡模式階段:",o),ar.value=o,s.setPhase(o)}function fr(o,p){console.log("[useGame] 開始分鏡模式倒計時:",o,"秒"),ye&&clearInterval(ye),_e.value=o,ye=window.setInterval(()=>{_e.value!==null&&_e.value>0?_e.value--:(Ee(),p&&p())},1e3)}function Ee(){ye&&(clearInterval(ye),ye=null)}function gr(){Ee(),_e.value=null}async function vr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),ce("drawing"),s.clearRoundData();const{broadcastGameState:o}=ue();return await o(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString()}),{success:!0}}async function wr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const o=new Date().toISOString(),{error:p}=await R.from("game_rooms").update({storyboard_phase:"writing",updated_at:o}).eq("id",e.currentRoom.id);p&&console.error("[useGame] 更新數據庫失敗:",p),ce("writing");const{broadcastGameState:I}=ue();return await I(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:o}),{success:!0}}async function hr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const o=new Date().toISOString(),{error:p}=await R.from("game_rooms").update({storyboard_phase:"voting",updated_at:o}).eq("id",e.currentRoom.id);p&&console.error("[useGame] 更新數據庫失敗:",p),ce("voting");const{broadcastGameState:I}=ue();return await I(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:o}),{success:!0}}async function _r(o){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const p=new Date().toISOString(),{error:I}=await R.from("game_rooms").update({storyboard_phase:"summary",updated_at:p}).eq("id",e.currentRoom.id);I&&console.error("[useGame] 更新數據庫失敗:",I),ce("summary");const{broadcastGameState:P}=ue();return await P(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:p,storyboardRoundResult:o?{winningSentence:o.winningSentence||"故事繼續發展中...",winnerName:o.winnerName||"",winnerId:o.winnerId||"",winnerVoteCount:o.winnerVoteCount||0,drawerScore:o.drawerScore||0,screenwriterScore:o.screenwriterScore||0}:void 0}),{success:!0}}async function yr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:o}=await R.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);o&&console.error("[useGame] 更新數據庫失敗:",o),ce("ending");const{broadcastGameState:p}=ue();return await p(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function ke(){const o=s.submissions,p=s.votes;if(o.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const I=new Map;for(const L of o)I.set(L.id,0);for(const L of p){const K=I.get(L.submissionId)||0;I.set(L.submissionId,K+1)}let P=-1,x=[];for(const L of o){const K=I.get(L.id)||0;K>P?(P=K,x=[L]):K===P&&x.push(L)}const B=x.length>1;if(x.length===1)return console.log("[useGame] 唯一最高票勝出:",x[0]?.sentence),{submission:x[0]||null,voteCount:P,hasTie:!1};const F=Math.floor(Math.random()*x.length),re=x[F]||null;return console.log("[useGame] 平票隨機選擇勝出:",re?.sentence,"(共",x.length,"個平票)"),{submission:re,voteCount:P,hasTie:B}}async function pr(o){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!i.currentRound)return{success:!1,error:"沒有當前輪次"};const p=i.currentRound.round_number,I=i.currentRound.drawer_id,x=e.participants.find(B=>B.user_id===I)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",p);try{const{submission:B,voteCount:F,hasTie:re}=ke();let L,K,fe;B?(L=B.sentence,K=B.userId,fe=e.participants.find(ge=>ge.user_id===K)?.nickname||"編劇",await s.markWinningSubmission(B.id),console.log("[useGame] 勝出句子:",L,"作者:",fe,"票數:",F,"平票:",re)):(L="故事繼續發展中...",K=I,fe=x,console.log("[useGame] 沒有提交，使用默認句子"));let Ie="/placeholder-image.png";if(o)try{const Se=await new Promise(ge=>{o.toBlob(ge,"image/png",.9)});if(Se){const{supabase:ge}=await qe(async()=>{const{supabase:xe}=await import("./index-gHJ9yNH2.js").then(Ir=>Ir.O);return{supabase:xe}},__vite__mapDeps([0,1])),Er=Date.now(),Ze=`storyboard/${e.currentRoom.id}/round_${p}_${Er}.png`,{error:Le}=await ge.storage.from("canvas-snapshots").upload(Ze,Se,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(Le)console.error("[useGame] 截圖上傳失敗:",Le);else{const{data:xe}=ge.storage.from("canvas-snapshots").getPublicUrl(Ze);Ie=xe.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Ie)}}}catch(Se){console.error("[useGame] 截圖上傳錯誤:",Se)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await s.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:p,itemType:"image",content:Ie,authorId:I,authorName:x}),await s.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:p,itemType:"text",content:L,authorId:K,authorName:fe}),console.log("[useGame] Story_Chain 已更新");const $e=s.votes.length;let Ce=0;B&&(Ce=Pe,await me(K,Ce),console.log("[useGame] 編劇勝出得分:",Ce,"分給",fe));const Ae=De+$e*Ne;await me(I,Ae),console.log("[useGame] 畫家得分:",Ae,"分給",x,"(投票人數:",$e,")");const We={success:!0,winningSentence:L,winnerName:fe,winnerId:K,winnerVoteCount:F,drawerScore:Ae,screenwriterScore:Ce,imageUrl:Ie};return console.log("[useGame] 輪次結算完成:",We),We}catch(B){return console.error("[useGame] 輪次結算錯誤:",B),{success:!1,error:B instanceof Error?B.message:"輪次結算失敗"}}}function Sr(){const o=document.querySelector("canvas.drawing-canvas");return o||document.querySelector("canvas")||null}function Rr(o){switch(o){case"drawing":return tr;case"writing":return or;case"voting":return nr;default:return 0}}function He(){return Pe}function Be(o){return De+o*Ne}function Ue(o){return Math.round(o*sr)}async function br(o,p,I,P=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const x=He();console.log("[useGame] 編劇勝出得分:",x,"分給",o),await me(o,x);const B=Be(I);if(console.log("[useGame] 畫家得分:",B,"分給",p,"(投票人數:",I,")"),await me(p,B),P>0){const F=Ue(P);console.log("[useGame] 評星加分:",F,"分給",p,"(平均評星:",P,")"),await me(p,F)}return{success:!0}}catch(x){return console.error("[useGame] 計算分鏡模式得分錯誤:",x),{success:!1,error:x instanceof Error?x.message:"計算得分失敗"}}}async function me(o,p){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:I}=await qe(async()=>{const{supabase:L}=await import("./index-gHJ9yNH2.js").then(K=>K.O);return{supabase:L}},__vite__mapDeps([0,1])),{data:P,error:x}=await I.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",o).single();if(x)throw x;const B=(P?.score||0)+p,{error:F}=await I.from("room_participants").update({score:B}).eq("room_id",e.currentRoom.id).eq("user_id",o);if(F)throw F;const re=e.participants.findIndex(L=>L.user_id===o);return re!==-1&&e.participants[re]&&(e.participants[re].score=B),console.log("[useGame] 玩家",o,"得分更新為",B),!0}catch(I){return console.error("[useGame] 更新玩家分數錯誤:",I),!1}}return Tr(()=>{n(),a(),Ee()}),{gameStatus:w,isPlaying:Z,isWaiting:M,isFinished:E,currentRound:q,currentRoundNumber:N,totalRounds:_,drawTime:W,isCurrentDrawer:Y,timeRemaining:u,isCountingDown:T,formattedTime:mr,roundStatus:h,isDrawing:G,isSummary:O,summaryTimeRemaining:D,isStoryboardMode:H,storyboardPhase:$,storyboardTimeRemaining:l,isStoryboardDrawing:b,isStoryboardWriting:d,isStoryboardVoting:t,isStoryboardSummary:r,isStoryboardSetup:m,isStoryboardEnding:g,startGame:v,newGame:dr,startNextRound:k,startDrawingPhase:A,endRound:X,continueToNextRound:ee,endGame:lr,startCountdown:Q,stopCountdown:n,startSummaryCountdown:y,stopSummaryCountdown:a,resetCountdown:c,setStoryboardPhase:ce,startStoryboardCountdown:fr,stopStoryboardCountdown:Ee,resetStoryboardCountdown:gr,enterStoryboardDrawingPhase:vr,enterStoryboardWritingPhase:wr,enterStoryboardVotingPhase:hr,enterStoryboardSummaryPhase:_r,enterStoryboardEndingPhase:yr,getStoryboardPhaseDuration:Rr,calculateWinningSentence:ke,finalizeStoryboardRound:pr,getCanvasElement:Sr,calculateScreenwriterWinScore:He,calculateDirectorScore:Be,calculateRatingBonus:Ue,calculateStoryboardRoundScores:br,updateStoryboardPlayerScore:me,STORYBOARD_DRAWING_TIME:tr,STORYBOARD_WRITING_TIME:or,STORYBOARD_VOTING_TIME:nr,STORYBOARD_SUMMARY_TIME:tt,SCREENWRITER_WIN_SCORE:Pe,DIRECTOR_BASE_SCORE:De,DIRECTOR_VOTE_BONUS:Ne,RATING_BONUS_MULTIPLIER:sr}}const ot=Object.freeze(Object.defineProperty({__proto__:null,useGame:ir},Symbol.toStringTag,{value:"Module"})),nt={class:"waiting-lobby"},st={class:"card"},at={class:"card-body"},ut={class:"room-info text-center margin-bottom-medium"},ct={class:"card-title text-hand-title"},it={class:"room-details"},lt={class:"detail-item margin-bottom-small"},dt={class:"badge badge-secondary room-code-badge"},mt={class:"detail-item margin-bottom-small"},ft={class:"badge"},gt={class:"detail-item"},vt={class:"players-section margin-bottom-medium"},wt={class:"text-hand-title margin-bottom-small"},ht={class:"players-list"},_t={class:"player-avatar"},yt={class:"player-info"},pt={class:"player-name"},St={key:0,class:"badge badge-warning"},Rt={class:"room-settings margin-bottom-medium"},bt={class:"setting-item"},Et={class:"setting-value"},It={class:"setting-item"},Ct={class:"setting-label"},Gt={class:"setting-value"},Tt={key:0,class:"setting-item"},At={class:"setting-value"},xt={class:"lobby-actions"},Pt=["disabled"],Dt={key:1,class:"alert alert-warning text-center"},Nt=["disabled"],Mt={key:0,class:"alert alert-danger margin-top-small"},qt=ur({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:i}){const s=e,u=i,{isHost:T,canStartGame:D,minPlayersRequired:w,leaveRoom:Z,loading:M,error:E}=Qr(),{startGame:h}=ir(),G=S(()=>{const d=s.room?.settings.rounds||0,t=s.participants.length,r=d>0?d:t;return r>0?r:1});function O(d){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[d||""]||d||"未知"}function H(d){return{classic:"傳統模式",storyboard:"分鏡接龍"}[d||""]||"傳統模式"}function $(d){return s.room?.host_id===d}async function l(){(await h()).success&&u("startGame")}async function b(){(await Z()).success&&u("leaveRoom")}return(d,t)=>(z(),j("div",nt,[C("div",st,[C("div",at,[C("div",ut,[C("h2",ct,V(e.room?.name),1),C("div",it,[C("div",lt,[t[0]||(t[0]=oe(" 房間碼：",-1)),C("span",dt,V(e.room?.code),1)]),C("div",mt,[t[1]||(t[1]=oe(" 狀態：",-1)),C("span",ft,V(O(e.room?.status)),1)]),C("div",gt,[t[2]||(t[2]=oe(" 模式：",-1)),C("span",{class:Ve(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},V(H(e.room?.game_mode)),3)])])]),C("div",vt,[C("h4",wt,"玩家列表 ("+V(e.participants.length)+")",1),C("div",ht,[(z(!0),j(je,null,Ar(e.participants,r=>(z(),j("div",{key:r.id,class:Ve(["player-item",{"is-host":$(r.user_id)}])},[C("div",_t,V(r.nickname.charAt(0).toUpperCase()),1),C("div",yt,[C("div",pt,[oe(V(r.nickname)+" ",1),$(r.user_id)?(z(),j("span",St," 房主 ")):pe("",!0)])])],2))),128))])]),C("div",Rt,[C("div",bt,[t[4]||(t[4]=C("span",{class:"setting-label"},"繪畫時間：",-1)),C("span",Et,[C("strong",null,V(e.room?.settings.draw_time),1),t[3]||(t[3]=oe("秒",-1))])]),C("div",It,[C("span",Ct,V(e.room?.game_mode==="storyboard"?"每場鏡數":"每局輪數")+"：",1),C("span",Gt,[C("strong",null,V(G.value),1),oe(V(e.room?.game_mode==="storyboard"?"鏡":"輪"),1)])]),e.room?.game_mode!=="storyboard"?(z(),j("div",Tt,[t[6]||(t[6]=C("span",{class:"setting-label"},"詞語總數：",-1)),C("span",At,[C("strong",null,V(e.room?.word_count),1),t[5]||(t[5]=oe("個",-1))])])):pe("",!0)]),C("div",xt,[te(T)&&te(D)?(z(),j("button",{key:0,disabled:te(M),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:l},V(te(M)?"開始中":"開始遊戲"),9,Pt)):te(T)?(z(),j("div",Dt,[oe(" 至少需要 "+V(te(w))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(z(),j(je,{key:0},[oe(" （分鏡接龍模式） ")],64)):pe("",!0)])):pe("",!0),C("button",{disabled:te(M),class:"paper-btn btn-secondary btn-block",onClick:b},V(te(M)?"離開中":"離開房間"),9,Nt)]),te(E)?(z(),j("div",Mt,V(te(E)),1)):pe("",!0)])])]))}}),Ut=xr(qt,[["__scopeId","data-v-208677e9"]]);export{kt as I,Ut as W,ue as a,be as b,cr as c,et as d,rt as e,Ht as f,ir as g,Bt as i,Qr as u};
