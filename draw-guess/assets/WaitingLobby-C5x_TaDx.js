const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DIgi5Eet.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as gr,f as b,y as Me,c as Y,o as K,z as Nr,a as be,e as T,A as Dr,B as We,r as $,u as fe,E as y,L as Ue,h as kr,t as j,s as ce,n as Xe,F as Je,m as qr,b as se,_ as Or}from"./index-DIgi5Eet.js";const Hr=["width","height","fill","transform"],Br={key:0},$r=T("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),Ur=[$r],Wr={key:1},Lr=T("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Zr=T("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Vr=[Lr,Zr],jr={key:2},zr=T("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Yr=[zr],Kr={key:3},Fr=T("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Xr=[Fr],Jr={key:4},Qr=T("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),et=[Qr],rt={key:5},tt=T("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),ot=[tt],nt={name:"PhPaintBrush"},Vt=gr({...nt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const f=e,a=Me("weight","regular"),l=Me("size","1em"),C=Me("color","currentColor"),x=Me("mirrored",!1),h=b(()=>f.weight??a),Z=b(()=>f.size??l),k=b(()=>f.color??C),E=b(()=>f.mirrored!==void 0?f.mirrored?"scale(-1, 1)":void 0:x?"scale(-1, 1)":void 0);return(p,A)=>(K(),Y("svg",Dr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:Z.value,height:Z.value,fill:k.value,transform:E.value},p.$attrs),[Nr(p.$slots,"default"),h.value==="bold"?(K(),Y("g",Br,Ur)):h.value==="duotone"?(K(),Y("g",Wr,Vr)):h.value==="fill"?(K(),Y("g",jr,Yr)):h.value==="light"?(K(),Y("g",Kr,Xr)):h.value==="regular"?(K(),Y("g",Jr,et)):h.value==="thin"?(K(),Y("g",rt,ot)):be("",!0)],16,Hr))}}),Ge=We("room",()=>{const e=$(null),f=$([]),a=$(!1),l=$(null),C=b(()=>{const r=fe();return e.value?.host_id===r.user?.id});async function x(r){try{a.value=!0,l.value=null;const t=fe();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(_){console.warn("載入用戶資料時發生錯誤（非關鍵）:",_)}const u=r.gameMode||"classic";if(u==="classic"&&r.words.length<6)throw new Error("至少需要 6 個詞語");let S=null,I=0;const D=10;for(;I<D&&!S;){I++;const W={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null,game_mode:u,single_round_mode:r.singleRoundMode||!1,is_final_round:!1},{data:L,error:n}=await y.from("game_rooms").insert(W).select().single();if(n){if(n.code==="23505")continue;throw new Error(n.message||"插入房間失敗")}if(L){S=L;break}}if(!S)throw new Error("無法生成唯一房間碼，請重試");const c={room_id:S.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:_}=await y.from("room_participants").insert(c);_&&console.error("創建參與記錄錯誤:",_)}catch(_){console.error("創建參與記錄時發生錯誤:",_)}try{const{data:_,error:W}=await y.from("room_participants").select("*").eq("room_id",S.id).order("joined_at",{ascending:!0});W?console.error("載入參與者列表失敗:",W):_&&(f.value=_)}catch(_){console.error("載入參與者列表時發生錯誤:",_)}return e.value=S,{success:!0,room:S}}catch(t){return l.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:l.value}}finally{a.value=!1}}async function h(r,t){try{a.value=!0,l.value=null;const u=fe();if(!u.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:S,error:I}=await y.from("game_rooms").select("*").eq("code",r).single();if(I||!S)throw new Error("房間不存在");if(S.status!=="waiting")throw new Error("房間已開始或已結束");const{data:D}=await y.from("room_participants").select("*").eq("room_id",S.id).eq("user_id",u.user.id).maybeSingle();if(D)return e.value=S,await k(S.id),{success:!0,room:S};const{error:c}=await y.from("room_participants").insert({room_id:S.id,user_id:u.user.id,nickname:t.trim(),score:0});if(c){if(c.code==="23505"||c.message.includes("duplicate"))return e.value=S,await k(S.id),{success:!0,room:S};throw c}return e.value=S,await k(S.id),{success:!0,room:S}}catch(u){return l.value=u instanceof Error?u.message:"加入房間失敗",console.error("加入房間錯誤:",u),{success:!1,error:l.value}}finally{a.value=!1}}async function Z(){try{if(!e.value)return{success:!0};a.value=!0,l.value=null;const r=fe();if(!r.user)throw new Error("請先登入");const{error:t}=await y.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(C.value){const{error:u}=await y.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);u&&console.error("關閉房間失敗:",u)}return e.value=null,f.value=[],{success:!0}}catch(r){return l.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,f.value=[],{success:!1,error:l.value}}finally{a.value=!1}}async function k(r){try{const{data:t,error:u}=await y.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(u)throw u;f.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function E(r){try{a.value=!0,l.value=null;const{data:t,error:u}=await y.from("game_rooms").select("*").eq("id",r).single();if(u)throw u;return e.value=t,await k(r),{success:!0,room:t}}catch(t){return l.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:l.value}}finally{a.value=!1}}async function p(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await y.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(r==="finished"&&e.value&&await A(),e.value){const u=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:u,newStatus:e.value.status})}return{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:l.value}}}async function A(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:r,error:t}=await y.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(t){console.error("獲取參與者錯誤:",t);return}if(!r||r.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const u=r.map(c=>c.user_id),{data:S,error:I}=await y.from("users").select("id, user_type").in("id",u);if(I){console.error("獲取用戶信息錯誤:",I);return}const D=new Set(S?.filter(c=>c.user_type==="registered").map(c=>c.id)||[]);for(const c of r){if(!D.has(c.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${c.user_id} 的積分累積`);continue}if(c.score>0){const{error:_}=await y.rpc("accumulate_user_score",{user_id_param:c.user_id,score_to_add:c.score});if(_){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",_);const{data:W,error:L}=await y.from("users").select("total_score").eq("id",c.user_id).single();if(L){console.error(`[RoomStore] 獲取用戶 ${c.user_id} 總積分錯誤:`,L);continue}const n=(W?.total_score||0)+c.score,{error:d}=await y.from("users").update({total_score:n}).eq("id",c.user_id);d?console.error(`[RoomStore] 更新用戶 ${c.user_id} 總積分錯誤:`,d):console.log(`[RoomStore] 用戶 ${c.user_id} 積分已累積: +${c.score} (總積分: ${n})`)}else console.log(`[RoomStore] 用戶 ${c.user_id} 積分已累積: +${c.score}`)}}}catch(r){console.error("[RoomStore] 累積積分錯誤:",r)}}async function q(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await y.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:l.value}}}async function H(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:r});const t={...e.value.settings,...r},{error:u}=await y.from("game_rooms").update({settings:t}).eq("id",e.value.id);if(u)throw u;return e.value&&(e.value.settings=t,console.log("[RoomStore] 房間設置已更新:",t)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",t),{success:!1,error:l.value}}}function U(){e.value=null,f.value=[],l.value=null}function F(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function o(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!C.value)return{success:!1,error:"只有房主可以踢人"};const t=fe();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,l.value=null;const{data:u,error:S}=await y.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(S)throw new Error(S.message);if(u&&!u.success)throw new Error(u.error||"踢出玩家失敗");return await k(e.value.id),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:l.value}}finally{a.value=!1}}async function m(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:r});const{error:t}=await y.from("game_rooms").update({is_final_round:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.is_final_round=r,console.log("[RoomStore] 最後一局標記已更新:",r)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",t),{success:!1,error:l.value}}}return{currentRoom:e,participants:f,loading:a,error:l,isHost:C,createRoom:x,joinRoom:h,leaveRoom:Z,kickPlayer:o,loadParticipants:k,loadRoom:E,updateRoomStatus:p,updateRoomDrawer:q,updateRoomSettings:H,setCurrentDrawer:F,setFinalRound:m,clearRoom:U}});function st(){const e=Ge(),f=b(()=>e.currentRoom),a=b(()=>e.participants),l=b(()=>e.isHost),C=b(()=>f.value&&f.value.game_mode==="storyboard"?3:2),x=b(()=>!f.value||f.value.status!=="waiting"||!l.value?!1:a.value.length>=C.value);async function h(E){return await e.createRoom(E)}async function Z(E,p){return await e.joinRoom(E,p)}async function k(){return await e.leaveRoom()}return{currentRoom:f,participants:a,isHost:l,canStartGame:x,minPlayersRequired:C,loading:b(()=>e.loading),error:b(()=>e.error),createRoom:h,joinRoom:Z,leaveRoom:k}}const Qe=100,er=50,rr=10,at=10,tr=100,or=[1,.8,.6,.4,.2];function ct(){const e=Ge();function f(E){const p=Math.min(E,or.length-1),A=or[p]??0;return Math.round(Qe*A)}function a(E,p=0){if(E===0)return 0;const A=E*rr,q=Math.round(p*at);return er+A+q}async function l(E,p,A=0){const q=a(p,A);return q===0?!0:await C(E,q)}async function C(E,p){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:A,error:q}=await y.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",E).single();if(q)throw q;const H=(A?.score||0)+p,{error:U}=await y.from("room_participants").update({score:H}).eq("room_id",e.currentRoom.id).eq("user_id",E);if(U)throw U;const F=e.participants.findIndex(o=>o.user_id===E);return F!==-1&&e.participants[F]&&(e.participants[F].score=H),!0}catch(A){return console.error("更新玩家分數錯誤:",A),!1}}function x(){if(!e.participants||e.participants.length===0)return null;const E=[...e.participants].sort((p,A)=>A.score-p.score);return E.length===1||E[0]&&E[1]&&E[0].score>E[1].score?{user_id:E[0]?.user_id||"",score:E[0]?.score||0}:{user_id:E[0]?.user_id||"",score:E[0]?.score||0}}const h=b(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((p,A)=>A.score!==p.score?A.score-p.score:new Date(p.joined_at).getTime()-new Date(A.joined_at).getTime()).map((p,A)=>({id:p.id,user_id:p.user_id,score:p.score,rank:A+1}))),Z=b(()=>e.currentRoom?.status!=="finished"?null:x());function k(){return tr}return{GUESS_BASE_SCORE:Qe,DRAWING_BASE_SCORE:er,DRAWING_BONUS_PER_GUESS:rr,WINNER_BONUS:tr,calculateGuessScore:f,calculateDrawingScore:a,calculateWinner:x,updatePlayerScore:C,updateDrawerScore:l,playerRankings:h,winner:Z,getWinnerBonus:k}}const vr=We("game",()=>{const e=Ge(),f=fe(),a=$(null),l=$(null),C=$([]),x=b(()=>C.value.filter(i=>i.is_correct)),h=b(()=>a.value?C.value.filter(i=>i.round_id===a.value.id):[]),Z=b(()=>h.value.filter(i=>i.is_correct)),k=$("drawing"),E=$([]),p=$([]),A=$(!1),q=$([]),H=b(()=>p.value.length===0?0:p.value.reduce((g,w)=>g+w.rating,0)/p.value.length);function U(i){k.value=i}function F(i){E.value=i}function o(i){const g=p.value.findIndex(w=>w.rater_id===i.rater_id);g>=0?p.value[g]=i:p.value.push(i)}function m(){p.value=[]}function r(){if(A.value||!l.value)return null;const i=l.value.length,g=[];for(let O=0;O<i;O++)q.value.includes(O)||g.push(O);if(g.length===0)return null;const w=Math.floor(Math.random()*g.length),M=g[w];return M===void 0?null:(q.value.push(M),A.value=!0,M)}function t(i,g){A.value=i,q.value=g}function u(){A.value=!1,q.value=[]}async function S(i,g=!1){try{const{data:w,error:M}=await y.from("game_rounds").select("*").eq("room_id",i).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(M)throw M;return w&&(a.value=w,g||f.user&&w.drawer_id===f.user.id?l.value=w.word_text:l.value=null,w.word_options&&Array.isArray(w.word_options)&&(E.value=w.word_options),w.hint_given!==void 0&&(A.value=w.hint_given),w.revealed_indices&&Array.isArray(w.revealed_indices)&&(q.value=w.revealed_indices),await I(w.id)),{success:!0,round:w}}catch(w){return console.error("載入當前輪次錯誤:",w),{success:!1,error:w instanceof Error?w.message:"載入輪次失敗"}}}async function I(i){try{const{data:g,error:w}=await y.from("guesses").select("*").eq("round_id",i).order("guessed_at",{ascending:!0});if(w)throw w;const M=g||[],O=new Set(C.value.map(oe=>oe.id)),te=M.filter(oe=>!O.has(oe.id));te.length>0&&(C.value=[...C.value,...te])}catch(g){console.error("載入猜測記錄錯誤:",g)}}async function D(i){try{const{data:g,error:w}=await y.from("game_rounds").select("id").eq("room_id",i);if(w)throw w;if(!g||g.length===0){C.value=[];return}const M=g.map(oe=>oe.id),{data:O,error:te}=await y.from("guesses").select("*").in("round_id",M).order("guessed_at",{ascending:!0});if(te)throw te;C.value=O||[]}catch(g){console.error("載入所有猜測記錄錯誤:",g)}}async function c(i,g,w,M){try{if(!e.currentRoom)throw new Error("沒有當前房間");const O=(e.currentRoom.current_round||0)+1,{data:te,error:oe}=await y.from("game_rounds").insert({room_id:i,round_number:O,drawer_id:g,word_text:w,word_source:M}).select().single();if(oe)throw oe;return a.value=te,l.value=w,await y.from("game_rooms").update({current_round:O,current_drawer_id:g}).eq("id",i),{success:!0,round:te}}catch(O){return console.error("創建輪次錯誤:",O),{success:!1,error:O instanceof Error?O.message:"創建輪次失敗"}}}function _(i){return a.value?C.value.some(g=>g.round_id===a.value.id&&g.user_id===i&&g.is_correct):!1}const W=b(()=>!a.value||!f.user?!1:a.value.drawer_id===f.user.id);async function L(){if(!a.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const i=x.value.length,g=H.value,{updateDrawerScore:w}=ct();console.log("[endRound] 猜中人數:",i,"平均評分:",g),await w(a.value.drawer_id,i,g);const{error:M}=await y.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(M)throw M;return{success:!0}}catch(i){return console.error("結束輪次錯誤:",i),{success:!1,error:i instanceof Error?i.message:"結束輪次失敗"}}}function n(){a.value=null,l.value=null,C.value=[],k.value="drawing",E.value=[],p.value=[],A.value=!1,q.value=[]}async function d(i,g,w){if(!f.user)return{success:!1,error:"用戶未登錄"};try{const{data:M,error:O}=await y.from("drawing_ratings").upsert({round_id:i,rater_id:f.user.id,drawer_id:g,rating:w},{onConflict:"round_id,rater_id"}).select().single();if(O)throw O;return M&&o(M),{success:!0,rating:M}}catch(M){return console.error("提交評分錯誤:",M),{success:!1,error:M instanceof Error?M.message:"提交評分失敗"}}}async function v(i){try{const{data:g,error:w}=await y.from("drawing_ratings").select("*").eq("round_id",i);if(w)throw w;return p.value=g||[],{success:!0,ratings:g}}catch(g){return console.error("載入評分錯誤:",g),{success:!1,error:g instanceof Error?g.message:"載入評分失敗"}}}return{currentRound:a,currentWord:l,guesses:C,correctGuesses:x,currentRoundGuesses:h,currentRoundCorrectGuesses:Z,isCurrentDrawer:W,roundStatus:k,wordOptions:E,ratings:p,averageRating:H,hintGiven:A,revealedIndices:q,loadCurrentRound:S,loadGuesses:I,loadAllGuesses:D,createRound:c,hasGuessed:_,endRound:L,clearGame:n,setRoundStatus:U,setWordOptions:F,addRating:o,clearRatings:m,submitRating:d,loadRatings:v,giveHint:r,setHintState:t,resetHint:u}});function nr(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function sr(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function ar(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function jt(e){return e.trim().length===0}function zt(e,f=100){return e.length>f}const ut=We("story",()=>{const e=fe(),f=$([]),a=$([]),l=$([]),C=$("setup"),x=$(!1),h=$(null),Z=b(()=>{const n=f.value.filter(d=>d.itemType==="text");return n.length===0?null:n[n.length-1]}),k=b(()=>{if(f.value.length===0)return null;const n=f.value[0];return n&&n.itemType==="text"?n.content:null}),E=b(()=>e.user&&a.value.find(n=>n.userId===e.user.id)||null),p=b(()=>e.user&&l.value.find(n=>n.voterId===e.user.id)||null),A=b(()=>{const n=new Map;for(const d of a.value)n.set(d.id,0);for(const d of l.value){const v=n.get(d.submissionId)||0;n.set(d.submissionId,v+1)}return n}),q=b(()=>{if(a.value.length===0)return null;let n=-1,d=[];for(const v of a.value){const i=A.value.get(v.id)||0;i>n?(n=i,d=[v]):i===n&&d.push(v)}return d.length>0?d[0]:null});async function H(n){try{x.value=!0,h.value=null;const{data:d,error:v}=await y.from("story_chains").select("*").eq("room_id",n).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return f.value=(d||[]).map(i=>nr(i)),console.log("[StoryStore] 故事鏈已載入:",f.value.length,"項"),{success:!0,data:f.value}}catch(d){return h.value=d instanceof Error?d.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",d),{success:!1,error:h.value}}finally{x.value=!1}}async function U(n){try{x.value=!0,h.value=null;const d={room_id:n.roomId,round_number:n.roundNumber,item_type:n.itemType,content:n.content,author_id:n.authorId,author_name:n.authorName},{data:v,error:i}=await y.from("story_chains").insert(d).select().single();if(i)throw new Error(i.message);const g=nr(v);return f.value.push(g),console.log("[StoryStore] 故事鏈項目已添加:",g),{success:!0,data:g}}catch(d){return h.value=d instanceof Error?d.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",d),{success:!1,error:h.value}}finally{x.value=!1}}async function F(n,d,v,i){return U({roomId:n,roundNumber:0,itemType:"text",content:d,authorId:v,authorName:i})}async function o(n,d,v,i){return U({roomId:n,roundNumber:-1,itemType:"text",content:d,authorId:v,authorName:i})}async function m(n){try{x.value=!0,h.value=null;const{data:d,error:v}=await y.from("story_submissions").select("*").eq("round_id",n).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return a.value=(d||[]).map(i=>sr(i)),console.log("[StoryStore] 句子提交已載入:",a.value.length,"項"),{success:!0,data:a.value}}catch(d){return h.value=d instanceof Error?d.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",d),{success:!1,error:h.value}}finally{x.value=!1}}async function r(n,d){if(!e.user)return{success:!1,error:"用戶未登錄"};try{x.value=!0,h.value=null;const v={round_id:n,user_id:e.user.id,sentence:d.trim(),vote_count:0,is_winner:!1},{data:i,error:g}=await y.from("story_submissions").upsert(v,{onConflict:"round_id,user_id"}).select().single();if(g)throw new Error(g.message);const w=sr(i),M=a.value.findIndex(O=>O.roundId===n&&O.userId===e.user.id);return M>=0?a.value[M]=w:a.value.push(w),console.log("[StoryStore] 句子已提交:",w),{success:!0,data:w}}catch(v){return h.value=v instanceof Error?v.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",v),{success:!1,error:h.value}}finally{x.value=!1}}async function t(n){try{const{error:d}=await y.from("story_submissions").update({is_winner:!0}).eq("id",n);if(d)throw new Error(d.message);const v=a.value.find(i=>i.id===n);return v&&(v.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",n),{success:!0}}catch(d){return h.value=d instanceof Error?d.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",d),{success:!1,error:h.value}}}async function u(n){try{x.value=!0,h.value=null;const{data:d,error:v}=await y.from("story_votes").select("*").eq("round_id",n);if(v)throw new Error(v.message);return l.value=(d||[]).map(i=>ar(i)),console.log("[StoryStore] 投票記錄已載入:",l.value.length,"項"),{success:!0,data:l.value}}catch(d){return h.value=d instanceof Error?d.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",d),{success:!1,error:h.value}}finally{x.value=!1}}async function S(n,d){if(!e.user)return{success:!1,error:"用戶未登錄"};try{x.value=!0,h.value=null;const v={round_id:n,voter_id:e.user.id,submission_id:d},{data:i,error:g}=await y.from("story_votes").upsert(v,{onConflict:"round_id,voter_id"}).select().single();if(g)throw new Error(g.message);const w=ar(i),M=l.value.findIndex(O=>O.roundId===n&&O.voterId===e.user.id);return M>=0?l.value[M]=w:l.value.push(w),console.log("[StoryStore] 投票已記錄:",w),{success:!0,data:w}}catch(v){return h.value=v instanceof Error?v.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",v),{success:!1,error:h.value}}finally{x.value=!1}}function I(n){C.value=n,console.log("[StoryStore] 階段已更新:",n)}function D(){a.value=[],l.value=[],console.log("[StoryStore] 輪次數據已清除")}function c(){f.value=[],a.value=[],l.value=[],C.value="setup",h.value=null,console.log("[StoryStore] 所有故事數據已清除")}function _(n){f.value.some(v=>v.id===n.id)||(f.value.push(n),console.log("[StoryStore] 本地添加故事鏈項目:",n))}function W(n){const d=a.value.findIndex(v=>v.id===n.id);d>=0?a.value[d]=n:a.value.push(n),console.log("[StoryStore] 本地添加句子提交:",n)}function L(n){const d=l.value.findIndex(v=>v.roundId===n.roundId&&v.voterId===n.voterId);d>=0?l.value[d]=n:l.value.push(n),console.log("[StoryStore] 本地添加投票記錄:",n)}return{storyChain:f,submissions:a,votes:l,currentPhase:C,loading:x,error:h,latestSentence:Z,storyOpening:k,mySubmission:E,myVote:p,voteCounts:A,winningSubmission:q,loadStoryChain:H,addStoryChainItem:U,addStoryOpening:F,addStoryEnding:o,addStoryChainItemLocal:_,loadSubmissions:m,submitSentence:r,markWinningSubmission:t,addSubmissionLocal:W,loadVotes:u,castVote:S,addVoteLocal:L,setPhase:I,clearRoundData:D,clearAll:c}}),re=new Map,ee=$("disconnected"),de=new Map,he=new Set,Pe=new Map,ae=new Map,X=new Map,Ie=new Map,ke=10,cr=1e3,it=3e4;function ie(...e){}function z(...e){console.warn("[Realtime]",...e)}function qe(){const e=navigator.userAgent;return/^((?!chrome|android).)*safari/i.test(e)}function ue(){const e=Ge(),f=vr();function a(o){const m=`room:${o}`;if(re.has(m))return re.get(m);const r=y.channel(m,{config:{presence:{key:"user"},broadcast:{self:!0}}});return re.set(m,r),r}function l(o){const m=Pe.get(o);m&&(clearTimeout(m),Pe.delete(o))}function C(o,m,r,t,u){if(Ie.set(r,{roomId:"",userId:t,userData:u}),o==="SUBSCRIBED")ee.value="connected",l(r),ae.set(r,0),X.set(r,!1),(async(I=3)=>{for(let D=0;D<I;D++)try{await m.track({user_id:t,...u}),ie("Presence track 成功");return}catch(c){z(`Presence track 失敗 (嘗試 ${D+1}/${I}):`,c),D<I-1&&await new Promise(_=>setTimeout(_,500*(D+1)))}})();else if(o==="CHANNEL_ERROR"||o==="TIMED_OUT"){if(ee.value="disconnected",X.get(r))return;const S=ae.get(r)||0;z("訂閱失敗:",o,"(嘗試次數:",S,", 瀏覽器:",navigator.userAgent.slice(0,50),")"),X.set(r,!0),x(r,t,u)}else o==="CLOSED"&&(ee.value="disconnected",X.set(r,!1))}function x(o,m,r){const t=ae.get(o)||0;if(t>=ke){z(`重連失敗次數過多 (${t} 次)，停止重連。請刷新頁面重試。`),ee.value="disconnected",X.set(o,!1);return}l(o),ae.set(o,t+1);const u=qe(),S=u?cr*2:cr,I=Math.min(S*Math.pow(1.5,t),it),D=window.setTimeout(async()=>{const c=`room:${o}`;let _=re.get(c),W=!1;if(_){const L=_.state;if(L==="errored"||L==="closed"){try{y.removeChannel(_)}catch(n){z("移除舊 Channel 失敗:",n)}re.delete(c),he.delete(o),_=void 0,W=!0,u&&await new Promise(n=>setTimeout(n,500))}}if(!_||W){try{_=y.channel(c,{config:{presence:{key:"user"},broadcast:{self:!0}}}),re.set(c,_),X.set(o,!1),ee.value="connecting",_.subscribe(L=>{C(L,_,o,m,r)})}catch(L){z("重建 Channel 失敗:",L),X.set(o,!0),x(o,m,r)}return}_.state!=="joined"?(X.set(o,!1),ee.value="connecting",_.subscribe(L=>{C(L,_,o,m,r)})):(ee.value="connected",X.set(o,!1),ae.set(o,0))},I);Pe.set(o,D)}function h(o,m,r,t){return new Promise((u,S)=>{if(!o||!m){z("缺少 roomCode 或 roomId"),S(new Error("缺少 roomCode 或 roomId"));return}Ie.set(o,{roomId:m,userId:r,userData:t});const I=a(o),D=I.state;if(D==="joined"){ee.value="connected",X.set(o,!1),u(I);return}if(D==="joining"){const c=setInterval(()=>{const W=I.state;W==="joined"?(clearInterval(c),X.set(o,!1),u(I)):(W==="closed"||W==="errored")&&clearInterval(c)},100),_=qe()?1e4:5e3;setTimeout(()=>{clearInterval(c),I.state!=="joined"&&(z("subscribeRoom - 連接超時"),S(new Error("連接超時")))},_);return}if(he.has(o)){ee.value="connecting",I.subscribe(c=>{C(c,I,o,r,t),c==="SUBSCRIBED"?u(I):(c==="CHANNEL_ERROR"||c==="TIMED_OUT")&&(ae.get(o)||0)>=ke&&S(new Error(`訂閱失敗: ${c}`))});return}I.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${m}`},async c=>{ie("房間狀態變化:",c.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${m}`},async c=>{ie("參與者變化:",c.eventType),await e.loadParticipants(m)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${m}`},async c=>{ie("輪次變化:",c.eventType,c.new),e.currentRoom&&await f.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async c=>{const _=c.new;if(_&&f.currentRound&&(await f.loadGuesses(_.round_id),_.is_correct&&e.isHost&&f.roundStatus==="drawing")){const W=f.currentRound.drawer_id,L=e.participants.filter(v=>v.user_id!==W),n=new Set(f.currentRoundCorrectGuesses.map(v=>v.user_id));if(L.length>0&&L.every(v=>n.has(v.user_id))){const{useGame:v}=await Ue(async()=>{const{useGame:g}=await Promise.resolve().then(()=>dt);return{useGame:g}},void 0),{endRound:i}=v();await i()}}}).on("broadcast",{event:"drawing"},c=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(c));const _=de.get(o);_&&c.payload?.stroke?(console.log("[Realtime] 分發給",_.size,"個回調"),_.forEach(W=>W(c.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",_?.size,"stroke:",c.payload?.stroke)}).on("presence",{event:"sync"},()=>{const c=I.presenceState();ie("Presence 同步，在線:",Object.keys(c).length)}),he.add(o),ee.value="connecting",I.subscribe(c=>{C(c,I,o,r,t),c==="SUBSCRIBED"?u(I):(c==="CHANNEL_ERROR"||c==="TIMED_OUT")&&(ae.get(o)||0)>=ke&&S(new Error(`訂閱失敗: ${c}`))})})}function Z(o,m){return de.has(o)||de.set(o,new Set),de.get(o).add(m),()=>{de.get(o)?.delete(m)}}function k(o,m){const r=a(o),t=`guesses:${m}`;return r[t]||(r.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${m}`},async u=>{ie("收到新猜測記錄:",u.eventType,u.new),await f.loadGuesses(m)}),r[t]=!0),r}function E(o,m){const r=a(o),t=`gameState:${o}`;return r[t]||(r.on("broadcast",{event:"game_state"},u=>{ie("收到遊戲狀態廣播:",u.payload),m(u.payload)}),r[t]=!0),r}async function p(o,m){const r=a(o),t=r.state;if(t!=="joined")return z("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{ie("廣播遊戲狀態:",m);const u=await r.send({type:"broadcast",event:"game_state",payload:m});return u==="error"?(z("發送遊戲狀態失敗"),{error:"發送失敗"}):u}catch(u){return z("發送遊戲狀態錯誤:",u),{error:u instanceof Error?u.message:"發送失敗"}}}async function A(o,m){const r=a(o),t=r.state;if(t!=="joined")return z("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const u=await r.send({type:"broadcast",event:"drawing",payload:{stroke:m}});return u==="error"?(z("發送失敗"),{error:"發送失敗"}):u}catch(u){return z("發送錯誤:",u),{error:u instanceof Error?u.message:"發送失敗"}}}function q(o){const m=`room:${o}`,r=re.get(m);l(o),ae.delete(o),X.delete(o),Ie.delete(o),r&&(y.removeChannel(r),re.delete(m)),de.delete(o),he.delete(o)}async function H(o,m,r,t){const u=`room:${o}`,S=re.get(u);if(Ie.set(o,{roomId:m,userId:r,userData:t}),X.get(o))return;if(!S){try{await h(o,m,r,t)}catch(D){z("連接恢復：重新訂閱失敗:",D)}return}const I=S.state;if(I==="joined"){ee.value="connected";return}if(I!=="joining"){if(qe()&&(I==="errored"||I==="closed")){try{y.removeChannel(S)}catch(D){z("移除異常 Channel 失敗:",D)}re.delete(u),he.delete(o),await new Promise(D=>setTimeout(D,500));try{await h(o,m,r,t)}catch(D){z("連接恢復 (Safari)：重新訂閱失敗:",D)}return}ae.set(o,0),X.set(o,!0),x(o,r,t)}}function U(){Pe.forEach((o,m)=>l(m)),re.forEach(o=>y.removeChannel(o)),re.clear(),de.clear(),he.clear(),X.clear(),Ie.clear(),ae.clear()}function F(){return ee.value}return{connectionStatus:ee,subscribeRoom:h,subscribeDrawing:Z,subscribeGuesses:k,subscribeGameState:E,sendDrawing:A,broadcastGameState:p,unsubscribeRoom:q,unsubscribeAll:U,getConnectionStatus:F,checkAndRestoreConnection:H}}const ur=6,ir=60,lr=60,dr=60,lt=5,Oe=10,He=5,Be=2,mr=3,_e=$(null),$e=$(!1);let ye=null;const me=$(null);let pe=null;const xe=$(new Set),fr=$("setup"),Se=$(null);let Re=null;function wr(){const e=Ge(),f=vr(),a=ut();ue();const l=_e,C=$e,x=me,h=b(()=>e.currentRoom?.status||"waiting"),Z=b(()=>h.value==="playing"),k=b(()=>h.value==="waiting"),E=b(()=>h.value==="finished"),p=b(()=>f.roundStatus),A=b(()=>p.value==="drawing"),q=b(()=>p.value==="summary"),H=b(()=>e.currentRoom?.game_mode==="storyboard"),U=fr,F=Se,o=b(()=>H.value&&U.value==="drawing"),m=b(()=>H.value&&U.value==="writing"),r=b(()=>H.value&&U.value==="voting"),t=b(()=>H.value&&U.value==="summary"),u=b(()=>H.value&&U.value==="setup"),S=b(()=>H.value&&U.value==="ending"),I=b(()=>f.currentRound),D=b(()=>e.currentRoom?.current_round||0),c=b(()=>e.currentRoom?.settings.rounds||0),_=b(()=>e.currentRoom?.settings.draw_time||60),W=b(()=>f.isCurrentDrawer);function L(s){console.log("[useGame] startCountdown 開始，時長:",s,"秒"),ye&&clearInterval(ye),_e.value=s,$e.value=!0,ye=window.setInterval(()=>{_e.value!==null&&_e.value>0?_e.value--:(n(),Z.value&&I.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),te()))},1e3)}function n(){ye&&(clearInterval(ye),ye=null),$e.value=!1}function d(){n(),_e.value=null}function v(){console.log("[useGame] startSummaryCountdown 開始"),pe&&clearInterval(pe),me.value=ur,console.log("[useGame] 開始總結倒計時:",ur,"秒"),pe=window.setInterval(async()=>{me.value!==null&&me.value>0?(me.value--,console.log("[useGame] 總結倒計時:",me.value)):(i(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await oe()))},1e3)}function i(){console.log("[useGame] stopSummaryCountdown"),pe&&(clearInterval(pe),pe=null),me.value=null}function g(){if(!e.currentRoom)return null;const s=e.currentRoom.words;if(s.length===0)return null;const R=[];for(let N=0;N<s.length;N++)xe.value.has(N)||R.push(N);let G=0;if(R.length>0){const N=Math.floor(Math.random()*R.length);G=R[N]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),xe.value.clear(),G=Math.floor(Math.random()*s.length);return xe.value.add(G),s[G]??null}async function w(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{xe.value.clear();const s=e.participants.length,R=await e.updateRoomSettings({rounds:s});if(!R.success)return R;console.log("[useGame] 輪數已自動設定為房間人數:",s);const G=await e.updateRoomStatus("playing");if(!G.success)return G;if(H.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),le("setup"),a.clearAll();const{broadcastGameState:P}=ue();return await P(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await M()}catch(s){return console.error("開始遊戲錯誤:",s),{success:!1,error:s instanceof Error?s.message:"開始遊戲失敗"}}}async function M(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const R=(e.currentRoom.current_round||0)+1;try{const G=(R-1)%e.participants.length,N=e.participants[G];if(console.log("[startDrawingPhase] 第",R,"輪，畫家:",N?.nickname),!N)throw new Error("無法選擇畫家");let P=null;if(H.value){const ne=a.latestSentence;ne?(P={text:ne.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",P.text)):(P={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(P=g(),!P)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",P.text)}await e.updateRoomDrawer(N.user_id);const B=await f.createRound(e.currentRoom.id,N.user_id,P.text,P.source);if(!B.success||!B.round)throw new Error("創建輪次失敗");const{broadcastGameState:Q}=ue();return H.value?await Q(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:N.user_id,drawerName:N.nickname,roundNumber:R,startedAt:B.round.started_at}):await Q(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:N.user_id,drawerName:N.nickname,roundNumber:R,startedAt:B.round.started_at}),{success:!0,drawerId:N.user_id,word:P.text}}catch(G){return console.error("開始繪畫階段錯誤:",G),{success:!1,error:G instanceof Error?G.message:"開始繪畫階段失敗"}}}async function O(){return await M()}async function te(){if(!I.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const s=await f.endRound();if(!s.success)return s;const R=!1,{broadcastGameState:G}=ue();return await G(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:R}),{success:!0,gameEnded:R}}catch(s){return console.error("結束輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"結束輪次失敗"}}}async function oe(){return e.currentRoom?e.isHost?(await M(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function hr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await e.updateRoomStatus("finished"),{success:!0}}catch(s){return console.error("結束遊戲錯誤:",s),{success:!1,error:s instanceof Error?s.message:"結束遊戲失敗"}}}async function _r(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(p.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),i(),await M()}catch(s){return console.error("下一局錯誤:",s),{success:!1,error:s instanceof Error?s.message:"下一局失敗"}}}const yr=b(()=>{if(l.value===null)return"--:--";const s=Math.floor(l.value/60),R=l.value%60;return`${s.toString().padStart(2,"0")}:${R.toString().padStart(2,"0")}`});function le(s){console.log("[useGame] 設置分鏡模式階段:",s),fr.value=s,a.setPhase(s)}function pr(s,R){console.log("[useGame] 開始分鏡模式倒計時:",s,"秒"),Re&&clearInterval(Re),Se.value=s,Re=window.setInterval(()=>{Se.value!==null&&Se.value>0?Se.value--:(Te(),R&&R())},1e3)}function Te(){Re&&(clearInterval(Re),Re=null)}function Sr(){Te(),Se.value=null}async function Rr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),le("drawing"),a.clearRoundData();const{broadcastGameState:s}=ue();return await s(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString()}),{success:!0}}async function br(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const s=new Date().toISOString(),{error:R}=await y.from("game_rooms").update({storyboard_phase:"writing",updated_at:s}).eq("id",e.currentRoom.id);R&&console.error("[useGame] 更新數據庫失敗:",R),le("writing");const{broadcastGameState:G}=ue();return await G(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:s}),{success:!0}}async function Er(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const s=new Date().toISOString(),{error:R}=await y.from("game_rooms").update({storyboard_phase:"voting",updated_at:s}).eq("id",e.currentRoom.id);R&&console.error("[useGame] 更新數據庫失敗:",R),le("voting");const{broadcastGameState:G}=ue();return await G(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:s}),{success:!0}}async function Ir(s){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const R=new Date().toISOString(),{error:G}=await y.from("game_rooms").update({storyboard_phase:"summary",updated_at:R}).eq("id",e.currentRoom.id);G&&console.error("[useGame] 更新數據庫失敗:",G),le("summary");const{broadcastGameState:N}=ue();return await N(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:R,storyboardRoundResult:s?{winningSentence:s.winningSentence||"故事繼續發展中...",winnerName:s.winnerName||"",winnerId:s.winnerId||"",winnerVoteCount:s.winnerVoteCount||0,drawerScore:s.drawerScore||0,screenwriterScore:s.screenwriterScore||0}:void 0}),{success:!0}}async function Gr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:s}=await y.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);s&&console.error("[useGame] 更新數據庫失敗:",s),le("ending");const{broadcastGameState:R}=ue();return await R(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function Le(){const s=a.submissions,R=a.votes;if(s.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const G=new Map;for(const V of s)G.set(V.id,0);for(const V of R){const J=G.get(V.submissionId)||0;G.set(V.submissionId,J+1)}let N=-1,P=[];for(const V of s){const J=G.get(V.id)||0;J>N?(N=J,P=[V]):J===N&&P.push(V)}const B=P.length>1;if(P.length===1)return console.log("[useGame] 唯一最高票勝出:",P[0]?.sentence),{submission:P[0]||null,voteCount:N,hasTie:!1};const Q=Math.floor(Math.random()*P.length),ne=P[Q]||null;return console.log("[useGame] 平票隨機選擇勝出:",ne?.sentence,"(共",P.length,"個平票)"),{submission:ne,voteCount:N,hasTie:B}}async function Tr(s){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!f.currentRound)return{success:!1,error:"沒有當前輪次"};const R=f.currentRound.round_number,G=f.currentRound.drawer_id,P=e.participants.find(B=>B.user_id===G)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",R);try{const{submission:B,voteCount:Q,hasTie:ne}=Le();let V,J,ve;B?(V=B.sentence,J=B.userId,ve=e.participants.find(we=>we.user_id===J)?.nickname||"編劇",await a.markWinningSubmission(B.id),console.log("[useGame] 勝出句子:",V,"作者:",ve,"票數:",Q,"平票:",ne)):(V="故事繼續發展中...",J=G,ve=P,console.log("[useGame] 沒有提交，使用默認句子"));let Ae="/placeholder-image.png";if(s)try{const Ee=await new Promise(we=>{s.toBlob(we,"image/png",.9)});if(Ee){const{supabase:we}=await Ue(async()=>{const{supabase:De}=await import("./index-DIgi5Eet.js").then(xr=>xr.O);return{supabase:De}},__vite__mapDeps([0,1])),Pr=Date.now(),Ke=`storyboard/${e.currentRoom.id}/round_${R}_${Pr}.png`,{error:Fe}=await we.storage.from("canvas-snapshots").upload(Ke,Ee,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(Fe)console.error("[useGame] 截圖上傳失敗:",Fe);else{const{data:De}=we.storage.from("canvas-snapshots").getPublicUrl(Ke);Ae=De.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Ae)}}}catch(Ee){console.error("[useGame] 截圖上傳錯誤:",Ee)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:R,itemType:"image",content:Ae,authorId:G,authorName:P}),await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:R,itemType:"text",content:V,authorId:J,authorName:ve}),console.log("[useGame] Story_Chain 已更新");const ze=a.votes.length;let Ce=0;B&&(Ce=Oe,await ge(J,Ce),console.log("[useGame] 編劇勝出得分:",Ce,"分給",ve));const Ne=He+ze*Be;await ge(G,Ne),console.log("[useGame] 畫家得分:",Ne,"分給",P,"(投票人數:",ze,")");const Ye={success:!0,winningSentence:V,winnerName:ve,winnerId:J,winnerVoteCount:Q,drawerScore:Ne,screenwriterScore:Ce,imageUrl:Ae};return console.log("[useGame] 輪次結算完成:",Ye),Ye}catch(B){return console.error("[useGame] 輪次結算錯誤:",B),{success:!1,error:B instanceof Error?B.message:"輪次結算失敗"}}}function Ar(){const s=document.querySelector("canvas.drawing-canvas");return s||document.querySelector("canvas")||null}function Cr(s){switch(s){case"drawing":return ir;case"writing":return lr;case"voting":return dr;default:return 0}}function Ze(){return Oe}function Ve(s){return He+s*Be}function je(s){return Math.round(s*mr)}async function Mr(s,R,G,N=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const P=Ze();console.log("[useGame] 編劇勝出得分:",P,"分給",s),await ge(s,P);const B=Ve(G);if(console.log("[useGame] 畫家得分:",B,"分給",R,"(投票人數:",G,")"),await ge(R,B),N>0){const Q=je(N);console.log("[useGame] 評星加分:",Q,"分給",R,"(平均評星:",N,")"),await ge(R,Q)}return{success:!0}}catch(P){return console.error("[useGame] 計算分鏡模式得分錯誤:",P),{success:!1,error:P instanceof Error?P.message:"計算得分失敗"}}}async function ge(s,R){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:G}=await Ue(async()=>{const{supabase:V}=await import("./index-DIgi5Eet.js").then(J=>J.O);return{supabase:V}},__vite__mapDeps([0,1])),{data:N,error:P}=await G.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",s).single();if(P)throw P;const B=(N?.score||0)+R,{error:Q}=await G.from("room_participants").update({score:B}).eq("room_id",e.currentRoom.id).eq("user_id",s);if(Q)throw Q;const ne=e.participants.findIndex(V=>V.user_id===s);return ne!==-1&&e.participants[ne]&&(e.participants[ne].score=B),console.log("[useGame] 玩家",s,"得分更新為",B),!0}catch(G){return console.error("[useGame] 更新玩家分數錯誤:",G),!1}}return kr(()=>{n(),i(),Te()}),{gameStatus:h,isPlaying:Z,isWaiting:k,isFinished:E,currentRound:I,currentRoundNumber:D,totalRounds:c,drawTime:_,isCurrentDrawer:W,timeRemaining:l,isCountingDown:C,formattedTime:yr,roundStatus:p,isDrawing:A,isSummary:q,summaryTimeRemaining:x,isStoryboardMode:H,storyboardPhase:U,storyboardTimeRemaining:F,isStoryboardDrawing:o,isStoryboardWriting:m,isStoryboardVoting:r,isStoryboardSummary:t,isStoryboardSetup:u,isStoryboardEnding:S,startGame:w,newGame:_r,startNextRound:O,startDrawingPhase:M,endRound:te,continueToNextRound:oe,endGame:hr,startCountdown:L,stopCountdown:n,startSummaryCountdown:v,stopSummaryCountdown:i,resetCountdown:d,setStoryboardPhase:le,startStoryboardCountdown:pr,stopStoryboardCountdown:Te,resetStoryboardCountdown:Sr,enterStoryboardDrawingPhase:Rr,enterStoryboardWritingPhase:br,enterStoryboardVotingPhase:Er,enterStoryboardSummaryPhase:Ir,enterStoryboardEndingPhase:Gr,getStoryboardPhaseDuration:Cr,calculateWinningSentence:Le,finalizeStoryboardRound:Tr,getCanvasElement:Ar,calculateScreenwriterWinScore:Ze,calculateDirectorScore:Ve,calculateRatingBonus:je,calculateStoryboardRoundScores:Mr,updateStoryboardPlayerScore:ge,STORYBOARD_DRAWING_TIME:ir,STORYBOARD_WRITING_TIME:lr,STORYBOARD_VOTING_TIME:dr,STORYBOARD_SUMMARY_TIME:lt,SCREENWRITER_WIN_SCORE:Oe,DIRECTOR_BASE_SCORE:He,DIRECTOR_VOTE_BONUS:Be,RATING_BONUS_MULTIPLIER:mr}}const dt=Object.freeze(Object.defineProperty({__proto__:null,useGame:wr},Symbol.toStringTag,{value:"Module"})),mt={class:"waiting-lobby"},ft={class:"card"},gt={class:"card-body"},vt={class:"room-info text-center margin-bottom-medium"},wt={class:"card-title text-hand-title"},ht={class:"room-details"},_t={class:"detail-item margin-bottom-small"},yt={class:"badge badge-secondary room-code-badge"},pt={class:"detail-item margin-bottom-small"},St={class:"badge"},Rt={class:"detail-item"},bt={class:"players-section margin-bottom-medium"},Et={class:"text-hand-title margin-bottom-small"},It={class:"players-list"},Gt={class:"player-avatar"},Tt={class:"player-info"},At={class:"player-name"},Ct={key:0,class:"badge badge-warning"},Mt={class:"room-settings margin-bottom-medium"},Pt={class:"setting-item"},xt={class:"setting-value"},Nt={class:"setting-item"},Dt={class:"setting-label"},kt={class:"setting-value"},qt={key:0,class:"setting-item"},Ot={class:"setting-value"},Ht={class:"lobby-actions"},Bt=["disabled"],$t={key:1,class:"alert alert-warning text-center"},Ut=["disabled"],Wt={key:0,class:"alert alert-danger margin-top-small"},Lt=gr({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:f}){const a=e,l=f,{isHost:C,canStartGame:x,minPlayersRequired:h,leaveRoom:Z,loading:k,error:E}=st(),{startGame:p}=wr(),A=b(()=>{const m=a.room?.settings.rounds||0,r=a.participants.length,t=m>0?m:r;return t>0?t:1});function q(m){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[m||""]||m||"未知"}function H(m){return{classic:"傳統模式",storyboard:"分鏡接龍"}[m||""]||"傳統模式"}function U(m){return a.room?.host_id===m}async function F(){(await p()).success&&l("startGame")}async function o(){(await Z()).success&&l("leaveRoom")}return(m,r)=>(K(),Y("div",mt,[T("div",ft,[T("div",gt,[T("div",vt,[T("h2",wt,j(e.room?.name),1),T("div",ht,[T("div",_t,[r[0]||(r[0]=ce(" 房間碼：",-1)),T("span",yt,j(e.room?.code),1)]),T("div",pt,[r[1]||(r[1]=ce(" 狀態：",-1)),T("span",St,j(q(e.room?.status)),1)]),T("div",Rt,[r[2]||(r[2]=ce(" 模式：",-1)),T("span",{class:Xe(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},j(H(e.room?.game_mode)),3)])])]),T("div",bt,[T("h4",Et,"玩家列表 ("+j(e.participants.length)+")",1),T("div",It,[(K(!0),Y(Je,null,qr(e.participants,t=>(K(),Y("div",{key:t.id,class:Xe(["player-item",{"is-host":U(t.user_id)}])},[T("div",Gt,j(t.nickname.charAt(0).toUpperCase()),1),T("div",Tt,[T("div",At,[ce(j(t.nickname)+" ",1),U(t.user_id)?(K(),Y("span",Ct," 房主 ")):be("",!0)])])],2))),128))])]),T("div",Mt,[T("div",Pt,[r[4]||(r[4]=T("span",{class:"setting-label"},"繪畫時間：",-1)),T("span",xt,[T("strong",null,j(e.room?.settings.draw_time),1),r[3]||(r[3]=ce("秒",-1))])]),T("div",Nt,[T("span",Dt,j(e.room?.game_mode==="storyboard"?"每場鏡數":"每局輪數")+"：",1),T("span",kt,[T("strong",null,j(A.value),1),ce(j(e.room?.game_mode==="storyboard"?"鏡":"輪"),1)])]),e.room?.game_mode!=="storyboard"?(K(),Y("div",qt,[r[6]||(r[6]=T("span",{class:"setting-label"},"詞語總數：",-1)),T("span",Ot,[T("strong",null,j(e.room?.word_count),1),r[5]||(r[5]=ce("個",-1))])])):be("",!0)]),T("div",Ht,[se(C)&&se(x)?(K(),Y("button",{key:0,disabled:se(k),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:F},j(se(k)?"開始中":"開始遊戲"),9,Bt)):se(C)?(K(),Y("div",$t,[ce(" 至少需要 "+j(se(h))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(K(),Y(Je,{key:0},[ce(" （分鏡接龍模式） ")],64)):be("",!0)])):be("",!0),T("button",{disabled:se(k),class:"paper-btn btn-secondary btn-block",onClick:o},j(se(k)?"離開中":"離開房間"),9,Ut)]),se(E)?(K(),Y("div",Wt,j(se(E)),1)):be("",!0)])])]))}}),Yt=Or(Lt,[["__scopeId","data-v-208677e9"]]);export{Vt as I,Yt as W,ue as a,Ge as b,vr as c,ct as d,ut as e,jt as f,wr as g,zt as i,st as u};
