import{d as te,f as v,p as oe,c as $,o as D,q as ue,a as ie,e as y,s as Ge,v as Ee,h as B,u as X,B as b,A as re,w as K,z as Me,n as le,r as we,_ as de,J as Ie,x as Ne,g as ve,b as H,t as P,j as Z,F as Te,y as De}from"./index-5I9K_xaV.js";const qe=["width","height","fill","transform"],xe={key:0},Be=y("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),He=[Be],Oe={key:1},Pe=y("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),$e=y("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Ze=[Pe,$e],Ue={key:2},We=y("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),je=[We],Le={key:3},ze=y("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Ve=[ze],Fe={key:4},Ke=y("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Je=[Ke],Ye={key:5},Qe=y("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Xe=[Qe],er={name:"PhPaintBrush"},Dr=te({...er,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const a=e,o=oe("weight","regular"),c=oe("size","1em"),_=oe("color","currentColor"),R=oe("mirrored",!1),C=v(()=>a.weight??o),k=v(()=>a.size??c),p=v(()=>a.color??_),f=v(()=>a.mirrored!==void 0?a.mirrored?"scale(-1, 1)":void 0:R?"scale(-1, 1)":void 0);return(m,h)=>(D(),$("svg",Ge({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:k.value,height:k.value,fill:p.value,transform:f.value},m.$attrs),[ue(m.$slots,"default"),C.value==="bold"?(D(),$("g",xe,He)):C.value==="duotone"?(D(),$("g",Oe,Ze)):C.value==="fill"?(D(),$("g",Ue,je)):C.value==="light"?(D(),$("g",Le,Ve)):C.value==="regular"?(D(),$("g",Fe,Je)):C.value==="thin"?(D(),$("g",Ye,Xe)):ie("",!0)],16,qe))}}),ne=Ee("room",()=>{const e=B(null),a=B([]),o=B(!1),c=B(null),_=v(()=>{const r=X();return e.value?.host_id===r.user?.id});async function R(r){try{o.value=!0,c.value=null;const t=X();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(l){console.warn("載入用戶資料時發生錯誤（非關鍵）:",l)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");if(r.settings.rounds>r.words.length)throw new Error("輪數不能超過詞語總數");let n=null,i=0;const w=10;for(;i<w&&!n;){i++;const q={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:g,error:A}=await b.from("game_rooms").insert(q).select().single();if(A){if(A.code==="23505")continue;throw new Error(A.message||"插入房間失敗")}if(g){n=g;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const T={room_id:n.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:l}=await b.from("room_participants").insert(T);l&&console.error("創建參與記錄錯誤:",l)}catch(l){console.error("創建參與記錄時發生錯誤:",l)}try{const{data:l,error:q}=await b.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});q?console.error("載入參與者列表失敗:",q):l&&(a.value=l)}catch(l){console.error("載入參與者列表時發生錯誤:",l)}return e.value=n,{success:!0,room:n}}catch(t){return c.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:c.value}}finally{o.value=!1}}async function C(r,t){try{o.value=!0,c.value=null;const n=X();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:i,error:w}=await b.from("game_rooms").select("*").eq("code",r).single();if(w||!i)throw new Error("房間不存在");if(i.status!=="waiting")throw new Error("房間已開始或已結束");const{data:T}=await b.from("room_participants").select("*").eq("room_id",i.id).eq("user_id",n.user.id).maybeSingle();if(T)return e.value=i,await p(i.id),{success:!0,room:i};const{error:l}=await b.from("room_participants").insert({room_id:i.id,user_id:n.user.id,nickname:t.trim(),score:0});if(l){if(l.code==="23505"||l.message.includes("duplicate"))return e.value=i,await p(i.id),{success:!0,room:i};throw l}return e.value=i,await p(i.id),{success:!0,room:i}}catch(n){return c.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:c.value}}finally{o.value=!1}}async function k(){try{if(!e.value)return{success:!0};o.value=!0,c.value=null;const r=X();if(!r.user)throw new Error("請先登入");const{error:t}=await b.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(_.value){const{error:n}=await b.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,a.value=[],{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,a.value=[],{success:!1,error:c.value}}finally{o.value=!1}}async function p(r){try{const{data:t,error:n}=await b.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(n)throw n;a.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function f(r){try{o.value=!0,c.value=null;const{data:t,error:n}=await b.from("game_rooms").select("*").eq("id",r).single();if(n)throw n;return e.value=t,await p(r),{success:!0,room:t}}catch(t){return c.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:c.value}}finally{o.value=!1}}async function m(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await b.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(e.value){const n=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(t){return c.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:c.value}}}async function h(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await b.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return c.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:c.value}}}function N(){e.value=null,a.value=[],c.value=null}function O(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function M(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!_.value)return{success:!1,error:"只有房主可以踢人"};const t=X();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};o.value=!0,c.value=null;const{data:n,error:i}=await b.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(i)throw new Error(i.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await p(e.value.id),{success:!0}}catch(t){return c.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:c.value}}finally{o.value=!1}}return{currentRoom:e,participants:a,loading:o,error:c,isHost:_,createRoom:R,joinRoom:C,leaveRoom:k,kickPlayer:M,loadParticipants:p,loadRoom:f,updateRoomStatus:m,updateRoomDrawer:h,setCurrentDrawer:O,clearRoom:N}});function rr(){const e=ne(),a=v(()=>e.currentRoom),o=v(()=>e.participants),c=v(()=>e.isHost),_=v(()=>!a.value||a.value.status!=="waiting"||!c.value?!1:o.value.length>=2);async function R(p){return await e.createRoom(p)}async function C(p,f){return await e.joinRoom(p,f)}async function k(){return await e.leaveRoom()}return{currentRoom:a,participants:o,isHost:c,canStartGame:_,loading:v(()=>e.loading),error:v(()=>e.error),createRoom:R,joinRoom:C,leaveRoom:k}}const tr=te({__name:"WiredButton",props:{disabled:{type:Boolean},loading:{type:Boolean},variant:{},block:{type:Boolean}},emits:["click"],setup(e,{emit:a}){const o=e,c=a,_=B(null),R=v(()=>({"wired-button-primary":o.variant==="primary","wired-button-secondary":o.variant==="secondary","wired-button-success":o.variant==="success","wired-button-warning":o.variant==="warning","wired-button-danger":o.variant==="danger","wired-button-block":o.block})),C=v(()=>({width:o.block?"100%":void 0}));function k(p){!o.disabled&&!o.loading&&c("click",p)}return(p,f)=>{const m=we("wired-button",!0);return D(),re(m,{ref_key:"buttonElement",ref:_,disabled:e.disabled,class:le(["wired-button",R.value,{"wired-button-loading":e.loading}]),style:Me(C.value),onClick:k},{default:K(()=>[ue(p.$slots,"default",{},void 0,!0)]),_:3},8,["disabled","class","style"])}}}),_e=de(tr,[["__scopeId","data-v-31510379"]]),nr=te({__name:"WiredCard",props:{elevation:{default:2},variant:{default:"default"}},setup(e){const a=e,o=v(()=>({"wired-card-primary":a.variant==="primary","wired-card-secondary":a.variant==="secondary"}));return(c,_)=>{const R=we("wired-card",!0);return D(),re(R,{class:le(["wired-card",o.value]),elevation:e.elevation},{default:K(()=>[ue(c.$slots,"default",{},void 0,!0)]),_:3},8,["class","elevation"])}}}),or=de(nr,[["__scopeId","data-v-06fb0899"]]),sr=te({__name:"WiredBadge",props:{variant:{default:"default"}},setup(e){const a=e,o=v(()=>({"wired-badge-primary":a.variant==="primary","wired-badge-secondary":a.variant==="secondary","wired-badge-success":a.variant==="success","wired-badge-warning":a.variant==="warning","wired-badge-danger":a.variant==="danger"}));return(c,_)=>{const R=we("wired-badge",!0);return D(),re(R,{class:le(["wired-badge",o.value])},{default:K(()=>[ue(c.$slots,"default",{},void 0,!0)]),_:3},8,["class"])}}}),ar=de(sr,[["__scopeId","data-v-6fe7f5e5"]]),he=100,pe=50,ye=10,cr=10,Re=100,Se=[1,.8,.6,.4,.2];function ir(){const e=ne();function a(f){const m=Math.min(f,Se.length-1),h=Se[m]??0;return Math.round(he*h)}function o(f,m=0){if(f===0)return 0;const h=f*ye,N=Math.round(m*cr);return pe+h+N}async function c(f,m,h=0){const N=o(m,h);return N===0?!0:await _(f,N)}async function _(f,m){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:h,error:N}=await b.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",f).single();if(N)throw N;const O=(h?.score||0)+m,{error:M}=await b.from("room_participants").update({score:O}).eq("room_id",e.currentRoom.id).eq("user_id",f);if(M)throw M;const r=e.participants.findIndex(t=>t.user_id===f);return r!==-1&&e.participants[r]&&(e.participants[r].score=O),!0}catch(h){return console.error("更新玩家分數錯誤:",h),!1}}function R(){if(!e.participants||e.participants.length===0)return null;const f=[...e.participants].sort((m,h)=>h.score-m.score);return f.length===1||f[0]&&f[1]&&f[0].score>f[1].score?{user_id:f[0]?.user_id||"",score:f[0]?.score||0}:{user_id:f[0]?.user_id||"",score:f[0]?.score||0}}const C=v(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((m,h)=>h.score!==m.score?h.score-m.score:new Date(m.joined_at).getTime()-new Date(h.joined_at).getTime()).map((m,h)=>({id:m.id,user_id:m.user_id,score:m.score,rank:h+1}))),k=v(()=>e.currentRoom?.status!=="finished"?null:R());function p(){return Re}return{GUESS_BASE_SCORE:he,DRAWING_BASE_SCORE:pe,DRAWING_BONUS_PER_GUESS:ye,WINNER_BONUS:Re,calculateGuessScore:a,calculateDrawingScore:o,calculateWinner:R,updatePlayerScore:_,updateDrawerScore:c,playerRankings:C,winner:k,getWinnerBonus:p}}const Ce=Ee("game",()=>{const e=ne(),a=X(),o=B(null),c=B(null),_=B([]),R=v(()=>_.value.filter(d=>d.is_correct)),C=v(()=>o.value?_.value.filter(d=>d.round_id===o.value.id):[]),k=v(()=>C.value.filter(d=>d.is_correct)),p=B("drawing"),f=B([]),m=B([]),h=v(()=>m.value.length===0?0:m.value.reduce((s,S)=>s+S.rating,0)/m.value.length);function N(d){p.value=d}function O(d){f.value=d}function M(d){const s=m.value.findIndex(S=>S.rater_id===d.rater_id);s>=0?m.value[s]=d:m.value.push(d)}function r(){m.value=[]}async function t(d){try{const{data:s,error:S}=await b.from("game_rounds").select("*").eq("room_id",d).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(S)throw S;return s&&(o.value=s,c.value=s.word_text,s.word_options&&Array.isArray(s.word_options)&&(f.value=s.word_options),await n(s.id)),{success:!0,round:s}}catch(s){return console.error("載入當前輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入輪次失敗"}}}async function n(d){try{const{data:s,error:S}=await b.from("guesses").select("*").eq("round_id",d).order("guessed_at",{ascending:!0});if(S)throw S;const E=s||[],u=new Set(_.value.map(I=>I.id)),G=E.filter(I=>!u.has(I.id));G.length>0&&(_.value=[..._.value,...G])}catch(s){console.error("載入猜測記錄錯誤:",s)}}async function i(d){try{const{data:s,error:S}=await b.from("game_rounds").select("id").eq("room_id",d);if(S)throw S;if(!s||s.length===0){_.value=[];return}const E=s.map(I=>I.id),{data:u,error:G}=await b.from("guesses").select("*").in("round_id",E).order("guessed_at",{ascending:!0});if(G)throw G;_.value=u||[]}catch(s){console.error("載入所有猜測記錄錯誤:",s)}}async function w(d,s,S,E){try{if(!e.currentRoom)throw new Error("沒有當前房間");const u=(e.currentRoom.current_round||0)+1,{data:G,error:I}=await b.from("game_rounds").insert({room_id:d,round_number:u,drawer_id:s,word_text:S,word_source:E}).select().single();if(I)throw I;return o.value=G,c.value=S,await b.from("game_rooms").update({current_round:u,current_drawer_id:s}).eq("id",d),{success:!0,round:G}}catch(u){return console.error("創建輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"創建輪次失敗"}}}function T(d){return o.value?_.value.some(s=>s.round_id===o.value.id&&s.user_id===d&&s.is_correct):!1}const l=v(()=>!o.value||!a.user?!1:o.value.drawer_id===a.user.id);async function q(){if(!o.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const d=R.value.length,s=h.value,{updateDrawerScore:S}=ir();console.log("[endRound] 猜中人數:",d,"平均評分:",s),await S(o.value.drawer_id,d,s);const{error:E}=await b.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",o.value.id);if(E)throw E;return{success:!0}}catch(d){return console.error("結束輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束輪次失敗"}}}function g(){o.value=null,c.value=null,_.value=[],p.value="drawing",f.value=[],m.value=[]}async function A(d,s,S){if(!a.user)return{success:!1,error:"用戶未登錄"};try{const{data:E,error:u}=await b.from("drawing_ratings").upsert({round_id:d,rater_id:a.user.id,drawer_id:s,rating:S},{onConflict:"round_id,rater_id"}).select().single();if(u)throw u;return E&&M(E),{success:!0,rating:E}}catch(E){return console.error("提交評分錯誤:",E),{success:!1,error:E instanceof Error?E.message:"提交評分失敗"}}}async function L(d){try{const{data:s,error:S}=await b.from("drawing_ratings").select("*").eq("round_id",d);if(S)throw S;return m.value=s||[],{success:!0,ratings:s}}catch(s){return console.error("載入評分錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入評分失敗"}}}return{currentRound:o,currentWord:c,guesses:_,correctGuesses:R,currentRoundGuesses:C,currentRoundCorrectGuesses:k,isCurrentDrawer:l,roundStatus:p,wordOptions:f,ratings:m,averageRating:h,loadCurrentRound:t,loadGuesses:n,loadAllGuesses:i,createRound:w,hasGuessed:T,endRound:q,clearGame:g,setRoundStatus:N,setWordOptions:O,addRating:M,clearRatings:r,submitRating:A,loadRatings:L}}),W=new Map,j=B("disconnected"),z=new Map,se=new Set,ae=new Map;function V(...e){}function U(...e){console.warn("[Realtime]",...e)}function me(){const e=ne(),a=Ce();function o(r){const t=`room:${r}`;if(W.has(t))return W.get(t);const n=b.channel(t,{config:{presence:{key:"user"},broadcast:{self:!0}}});return W.set(t,n),n}function c(r){const t=ae.get(r);t&&(clearTimeout(t),ae.delete(r))}function _(r,t,n,i,w){r==="SUBSCRIBED"?(j.value="connected",c(n),t.track({user_id:i,...w}).catch(T=>{U("Presence track 失敗:",T)})):r==="CHANNEL_ERROR"||r==="TIMED_OUT"?(j.value="disconnected",U("訂閱失敗:",r),R(n,i,w)):r==="CLOSED"&&(j.value="disconnected")}function R(r,t,n,i=0){if(i>=3){U("重連失敗次數過多，停止重連");return}c(r);const w=Math.min(1e3*Math.pow(2,i),1e4),T=window.setTimeout(()=>{const l=W.get(`room:${r}`);l&&l.state!=="joined"&&l.subscribe(q=>{q==="SUBSCRIBED"?_(q,l,r,t,n):(q==="CHANNEL_ERROR"||q==="TIMED_OUT")&&R(r,t,n,i+1)})},w);ae.set(r,T)}function C(r,t,n,i){return new Promise((w,T)=>{if(!r||!t){U("缺少 roomCode 或 roomId"),T(new Error("缺少 roomCode 或 roomId"));return}const l=o(r),q=l.state;if(q==="joined"){j.value="connected",w(l);return}if(q==="joining"){const g=setInterval(()=>{const A=l.state;A==="joined"?(clearInterval(g),w(l)):(A==="closed"||A==="errored")&&(clearInterval(g),T(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(g),l.state!=="joined"&&T(new Error("連接超時"))},5e3);return}if(se.has(r)){j.value="connecting",l.subscribe(g=>{_(g,l,r,n,i),g==="SUBSCRIBED"?w(l):(g==="CHANNEL_ERROR"||g==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${g}`))});return}l.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async g=>{V("房間狀態變化:",g.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async g=>{V("參與者變化:",g.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async g=>{V("輪次變化:",g.eventType,g.new),e.currentRoom&&await a.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async g=>{const A=g.new;if(A&&a.currentRound&&(await a.loadGuesses(A.round_id),A.is_correct&&e.isHost&&a.roundStatus==="drawing")){const L=a.currentRound.drawer_id,d=e.participants.filter(E=>E.user_id!==L),s=new Set(a.currentRoundCorrectGuesses.map(E=>E.user_id));if(d.length>0&&d.every(E=>s.has(E.user_id))){const{useGame:E}=await Ie(async()=>{const{useGame:G}=await Promise.resolve().then(()=>ur);return{useGame:G}},void 0),{endRound:u}=E();await u()}}}).on("broadcast",{event:"drawing"},g=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(g));const A=z.get(r);A&&g.payload?.stroke?(console.log("[Realtime] 分發給",A.size,"個回調"),A.forEach(L=>L(g.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",A?.size,"stroke:",g.payload?.stroke)}).on("presence",{event:"sync"},()=>{const g=l.presenceState();V("Presence 同步，在線:",Object.keys(g).length)}),se.add(r),j.value="connecting",l.subscribe(g=>{_(g,l,r,n,i),g==="SUBSCRIBED"?w(l):(g==="CHANNEL_ERROR"||g==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${g}`))})})}function k(r,t){return z.has(r)||z.set(r,new Set),z.get(r).add(t),()=>{z.get(r)?.delete(t)}}function p(r,t){const n=o(r),i=`guesses:${t}`;return n[i]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${t}`},async w=>{V("收到新猜測記錄:",w.eventType,w.new),await a.loadGuesses(t)}),n[i]=!0),n}function f(r,t){const n=o(r),i=`gameState:${r}`;return n[i]||(n.on("broadcast",{event:"game_state"},w=>{V("收到遊戲狀態廣播:",w.payload),t(w.payload)}),n[i]=!0),n}async function m(r,t){const n=o(r),i=n.state;if(i!=="joined")return U("Channel 未連接，狀態:",i,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{V("廣播遊戲狀態:",t);const w=await n.send({type:"broadcast",event:"game_state",payload:t});return w==="error"?(U("發送遊戲狀態失敗"),{error:"發送失敗"}):w}catch(w){return U("發送遊戲狀態錯誤:",w),{error:w instanceof Error?w.message:"發送失敗"}}}async function h(r,t){const n=o(r),i=n.state;if(i!=="joined")return U("Channel 未連接，無法發送繪畫數據，狀態:",i),{error:"Channel 未連接"};try{const w=await n.send({type:"broadcast",event:"drawing",payload:{stroke:t}});return w==="error"?(U("發送失敗"),{error:"發送失敗"}):w}catch(w){return U("發送錯誤:",w),{error:w instanceof Error?w.message:"發送失敗"}}}function N(r){const t=`room:${r}`,n=W.get(t);c(r),n&&(b.removeChannel(n),W.delete(t)),z.delete(r),se.delete(r)}function O(){ae.forEach((r,t)=>c(t)),W.forEach(r=>b.removeChannel(r)),W.clear(),z.clear(),se.clear()}function M(){return j.value}return{connectionStatus:j,subscribeRoom:C,subscribeDrawing:k,subscribeGuesses:p,subscribeGameState:f,sendDrawing:h,broadcastGameState:m,unsubscribeRoom:N,unsubscribeAll:O,getConnectionStatus:M}}const be=6,J=B(null),ge=B(!1);let Y=null;const F=B(null);let Q=null;const ce=B(new Set);function ke(){const e=ne(),a=Ce();me();const o=J,c=ge,_=F,R=v(()=>e.currentRoom?.status||"waiting"),C=v(()=>R.value==="playing"),k=v(()=>R.value==="waiting"),p=v(()=>R.value==="finished"),f=v(()=>a.roundStatus),m=v(()=>f.value==="drawing"),h=v(()=>f.value==="summary"),N=v(()=>a.currentRound),O=v(()=>e.currentRoom?.current_round||0),M=v(()=>e.currentRoom?.settings.rounds||0),r=v(()=>e.currentRoom?.settings.draw_time||60),t=v(()=>a.isCurrentDrawer);function n(u){console.log("[useGame] startCountdown 開始，時長:",u,"秒"),Y&&clearInterval(Y),J.value=u,ge.value=!0,Y=window.setInterval(()=>{J.value!==null&&J.value>0?J.value--:(i(),C.value&&N.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),d()))},1e3)}function i(){Y&&(clearInterval(Y),Y=null),ge.value=!1}function w(){i(),J.value=null}function T(){console.log("[useGame] startSummaryCountdown 開始"),Q&&clearInterval(Q),F.value=be,console.log("[useGame] 開始總結倒計時:",be,"秒"),Q=window.setInterval(async()=>{F.value!==null&&F.value>0?(F.value--,console.log("[useGame] 總結倒計時:",F.value)):(l(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await s()))},1e3)}function l(){console.log("[useGame] stopSummaryCountdown"),Q&&(clearInterval(Q),Q=null),F.value=null}function q(){if(!e.currentRoom)return null;const u=e.currentRoom.words;if(u.length===0)return null;const G=[];for(let x=0;x<u.length;x++)ce.value.has(x)||G.push(x);let I=0;if(G.length>0){const x=Math.floor(Math.random()*G.length);I=G[x]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),ce.value.clear(),I=Math.floor(Math.random()*u.length);return ce.value.add(I),u[I]??null}async function g(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{ce.value.clear();const u=await e.updateRoomStatus("playing");return u.success?await A():u}catch(u){return console.error("開始遊戲錯誤:",u),{success:!1,error:u instanceof Error?u.message:"開始遊戲失敗"}}}async function A(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const u=e.currentRoom.current_round||0,G=u+1;if(u>=M.value)return await S(),{success:!1,error:"所有輪次已完成"};try{const I=(G-1)%e.participants.length,x=e.participants[I];if(console.log("[startDrawingPhase] 第",G,"輪，畫家:",x?.nickname),!x)throw new Error("無法選擇畫家");const ee=q();if(!ee)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",ee.text),await e.updateRoomDrawer(x.user_id);const fe=await a.createRound(e.currentRoom.id,x.user_id,ee.text,ee.source);if(!fe.success||!fe.round)throw new Error("創建輪次失敗");const{broadcastGameState:Ae}=me();return await Ae(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:x.user_id,drawerName:x.nickname,roundNumber:G,startedAt:fe.round.started_at}),{success:!0,drawerId:x.user_id,word:ee.text}}catch(I){return console.error("開始繪畫階段錯誤:",I),{success:!1,error:I instanceof Error?I.message:"開始繪畫階段失敗"}}}async function L(){return await A()}async function d(){if(!N.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const u=await a.endRound();if(!u.success)return u;const I=(e.currentRoom.current_round||0)>=M.value,{broadcastGameState:x}=me();return await x(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:I}),{success:!0,gameEnded:I}}catch(u){return console.error("結束輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"結束輪次失敗"}}}async function s(){return e.currentRoom?e.isHost?(e.currentRoom.current_round||0)>=M.value?(await S(),{success:!0,gameEnded:!0}):(await A(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function S(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return i(),await e.updateRoomStatus("finished"),{success:!0}}catch(u){return console.error("結束遊戲錯誤:",u),{success:!1,error:u instanceof Error?u.message:"結束遊戲失敗"}}}const E=v(()=>{if(o.value===null)return"--:--";const u=Math.floor(o.value/60),G=o.value%60;return`${u.toString().padStart(2,"0")}:${G.toString().padStart(2,"0")}`});return Ne(()=>{i(),l()}),{gameStatus:R,isPlaying:C,isWaiting:k,isFinished:p,currentRound:N,currentRoundNumber:O,totalRounds:M,drawTime:r,isCurrentDrawer:t,timeRemaining:o,isCountingDown:c,formattedTime:E,roundStatus:f,isDrawing:m,isSummary:h,summaryTimeRemaining:_,startGame:g,startNextRound:L,startDrawingPhase:A,endRound:d,continueToNextRound:s,endGame:S,startCountdown:n,stopCountdown:i,startSummaryCountdown:T,stopSummaryCountdown:l,resetCountdown:w}}const ur=Object.freeze(Object.defineProperty({__proto__:null,useGame:ke},Symbol.toStringTag,{value:"Module"})),lr={class:"waiting-lobby"},dr={class:"waiting-lobby-content"},fr={class:"room-info"},mr={class:"text-hand-title room-name"},gr={class:"room-details"},wr={class:"detail-item"},vr={class:"room-code"},_r={class:"detail-item"},hr={class:"players-section"},pr={class:"text-hand-title players-title"},yr={class:"players-list"},Rr={class:"player-avatar"},Sr={class:"player-info"},br={class:"player-name"},Er={class:"room-settings"},Cr={class:"setting-item"},kr={class:"setting-item"},Ar={class:"setting-item"},Gr={class:"lobby-actions"},Mr={key:1,class:"warning-text"},Ir={key:0,class:"error-message"},Nr=te({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:a}){const o=e,c=a,{isHost:_,canStartGame:R,leaveRoom:C,loading:k,error:p}=rr(),{startGame:f}=ke();function m(M){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[M||""]||M||"未知"}function h(M){return o.room?.host_id===M}async function N(){(await f()).success&&c("startGame")}async function O(){(await C()).success&&c("leaveRoom")}return(M,r)=>(D(),$("div",lr,[ve(H(or),{elevation:"3"},{default:K(()=>[y("div",dr,[y("div",fr,[y("h2",mr,P(e.room?.name),1),y("div",gr,[y("div",wr,[r[0]||(r[0]=Z(" 房間碼：",-1)),y("span",vr,P(e.room?.code),1)]),y("div",_r," 狀態："+P(m(e.room?.status)),1)])]),y("div",hr,[y("h4",pr,"玩家列表 ("+P(e.participants.length)+")",1),y("div",yr,[(D(!0),$(Te,null,De(e.participants,t=>(D(),$("div",{key:t.id,class:le(["player-item",{"is-host":h(t.user_id)}])},[y("div",Rr,P(t.nickname.charAt(0).toUpperCase()),1),y("div",Sr,[y("div",br,[Z(P(t.nickname)+" ",1),h(t.user_id)?(D(),re(H(ar),{key:0,variant:"warning",class:"host-badge"},{default:K(()=>[...r[1]||(r[1]=[Z(" 房主 ",-1)])]),_:1})):ie("",!0)])])],2))),128))])]),y("div",Er,[y("div",Cr,[r[2]||(r[2]=Z(" 繪畫時間：",-1)),y("strong",null,P(e.room?.settings.draw_time),1),r[3]||(r[3]=Z(" 秒 ",-1))]),y("div",kr,[r[4]||(r[4]=Z(" 輪數：",-1)),y("strong",null,P(e.room?.settings.rounds),1),r[5]||(r[5]=Z(" 輪 ",-1))]),y("div",Ar,[r[6]||(r[6]=Z(" 詞語總數：",-1)),y("strong",null,P(e.room?.word_count),1),r[7]||(r[7]=Z(" 個 ",-1))])]),y("div",Gr,[H(_)&&H(R)?(D(),re(H(_e),{key:0,disabled:H(k),loading:H(k),variant:"primary",block:"",onClick:N},{default:K(()=>[Z(P(H(k)?"開始中":"開始遊戲"),1)]),_:1},8,["disabled","loading"])):H(_)?(D(),$("div",Mr," 至少需要 2 個玩家才能開始遊戲 ")):ie("",!0),ve(H(_e),{disabled:H(k),loading:H(k),variant:"secondary",block:"",onClick:O},{default:K(()=>[Z(P(H(k)?"離開中":"離開房間"),1)]),_:1},8,["disabled","loading"])]),H(p)?(D(),$("div",Ir,P(H(p)),1)):ie("",!0)])]),_:1})]))}}),qr=de(Nr,[["__scopeId","data-v-efd0cfaf"]]);export{Dr as I,or as W,_e as a,me as b,qr as c,ne as d,Ce as e,ir as f,ke as g,rr as u};
