import{m as F,r as k,f as E,u as j,x as b,A as X,j as K,d as J,c as M,e as D,a as U,t as T,s as B,F as Q,p as Z,b as N,o as $,_ as ee}from"./index-A7eUUhde.js";const A=F("room",()=>{const e=k(null),w=k([]),u=k(!1),s=k(null),g=E(()=>{const c=j();return e.value?.host_id===c.user?.id});async function S(c){try{u.value=!0,s.value=null;const r=j();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(_){console.warn("載入用戶資料時發生錯誤（非關鍵）:",_)}if(c.words.length<6)throw new Error("至少需要 6 個詞語");if(c.settings.rounds>c.words.length)throw new Error("輪數不能超過詞語總數");let t=null,a=0;const h=10;for(;a<h&&!t;){a++;const q={code:Math.floor(1e5+Math.random()*9e5).toString(),name:c.name,host_id:r.user.id,words:c.words,word_count:c.words.length,status:"waiting",settings:c.settings,current_round:0,current_drawer_id:null},{data:P,error:o}=await b.from("game_rooms").insert(q).select().single();if(o){if(o.code==="23505")continue;throw new Error(o.message||"插入房間失敗")}if(P){t=P;break}}if(!t)throw new Error("無法生成唯一房間碼，請重試");const x={room_id:t.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:_}=await b.from("room_participants").insert(x);_&&console.error("創建參與記錄錯誤:",_)}catch(_){console.error("創建參與記錄時發生錯誤:",_)}try{const{data:_,error:q}=await b.from("room_participants").select("*").eq("room_id",t.id).order("joined_at",{ascending:!0});q?console.error("載入參與者列表失敗:",q):_&&(w.value=_)}catch(_){console.error("載入參與者列表時發生錯誤:",_)}return e.value=t,{success:!0,room:t}}catch(r){return s.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:s.value}}finally{u.value=!1}}async function R(c,r){try{u.value=!0,s.value=null;const t=j();if(!t.user)throw new Error("請先登入");if(!/^\d{6}$/.test(c))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:a,error:h}=await b.from("game_rooms").select("*").eq("code",c).single();if(h||!a)throw new Error("房間不存在");if(a.status!=="waiting")throw new Error("房間已開始或已結束");const{data:x}=await b.from("room_participants").select("*").eq("room_id",a.id).eq("user_id",t.user.id).maybeSingle();if(x)return e.value=a,await m(a.id),{success:!0,room:a};const{error:_}=await b.from("room_participants").insert({room_id:a.id,user_id:t.user.id,nickname:r.trim(),score:0});if(_){if(_.code==="23505"||_.message.includes("duplicate"))return e.value=a,await m(a.id),{success:!0,room:a};throw _}return e.value=a,await m(a.id),{success:!0,room:a}}catch(t){return s.value=t instanceof Error?t.message:"加入房間失敗",console.error("加入房間錯誤:",t),{success:!1,error:s.value}}finally{u.value=!1}}async function y(){try{if(!e.value)return{success:!0};u.value=!0,s.value=null;const c=j();if(!c.user)throw new Error("請先登入");const{error:r}=await b.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",c.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(g.value){const{error:t}=await b.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);t&&console.error("關閉房間失敗:",t)}return e.value=null,w.value=[],{success:!0}}catch(c){return s.value=c instanceof Error?c.message:"離開房間失敗",console.error("離開房間錯誤:",c),e.value=null,w.value=[],{success:!1,error:s.value}}finally{u.value=!1}}async function m(c){try{const{data:r,error:t}=await b.from("room_participants").select("*").eq("room_id",c).order("joined_at",{ascending:!0});if(t)throw t;w.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function d(c){try{u.value=!0,s.value=null;const{data:r,error:t}=await b.from("game_rooms").select("*").eq("id",c).single();if(t)throw t;return e.value=r,await m(c),{success:!0,room:r}}catch(r){return s.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:s.value}}finally{u.value=!1}}async function f(c){try{if(!e.value)throw new Error("沒有當前房間");const{error:r}=await b.from("game_rooms").update({status:c}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.status=c),{success:!0}}catch(r){return s.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:s.value}}}function v(){e.value=null,w.value=[],s.value=null}return{currentRoom:e,participants:w,loading:u,error:s,isHost:g,createRoom:S,joinRoom:R,leaveRoom:y,loadParticipants:m,loadRoom:d,updateRoomStatus:f,clearRoom:v}});function re(){const e=A(),w=E(()=>e.currentRoom),u=E(()=>e.participants),s=E(()=>e.isHost),g=E(()=>!w.value||w.value.status!=="waiting"||!s.value?!1:u.value.length>=2);async function S(m){return await e.createRoom(m)}async function R(m,d){return await e.joinRoom(m,d)}async function y(){return await e.leaveRoom()}return{currentRoom:w,participants:u,isHost:s,canStartGame:g,loading:E(()=>e.loading),error:E(()=>e.error),createRoom:S,joinRoom:R,leaveRoom:y}}const Y=F("game",()=>{const e=A(),w=j(),u=k(null),s=k(null),g=k([]),S=E(()=>g.value.filter(r=>r.is_correct));async function R(r){try{const{data:t,error:a}=await b.from("game_rounds").select("*").eq("room_id",r).order("round_number",{ascending:!1}).limit(1).single();if(a&&a.code!=="PGRST116")throw a;return t&&(u.value=t,s.value=t.word_text,await y(t.id)),{success:!0,round:t}}catch(t){return console.error("載入當前輪次錯誤:",t),{success:!1,error:t instanceof Error?t.message:"載入輪次失敗"}}}async function y(r){try{const{data:t,error:a}=await b.from("guesses").select("*").eq("round_id",r).order("guessed_at",{ascending:!0});if(a)throw a;g.value=t||[]}catch(t){console.error("載入猜測記錄錯誤:",t)}}async function m(r,t,a,h){try{if(!e.currentRoom)throw new Error("沒有當前房間");const x=(e.currentRoom.current_round||0)+1,{data:_,error:q}=await b.from("game_rounds").insert({room_id:r,round_number:x,drawer_id:t,word_text:a,word_source:h}).select().single();if(q)throw q;return u.value=_,s.value=a,g.value=[],await b.from("game_rooms").update({current_round:x,current_drawer_id:t}).eq("id",r),{success:!0,round:_}}catch(x){return console.error("創建輪次錯誤:",x),{success:!1,error:x instanceof Error?x.message:"創建輪次失敗"}}}function d(r){return g.value.some(t=>t.user_id===r&&t.is_correct)}const f=E(()=>!u.value||!w.user?!1:u.value.drawer_id===w.user.id);async function v(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const r=S.value.length,{useScoring:t}=await X(async()=>{const{useScoring:x}=await Promise.resolve().then(()=>te);return{useScoring:x}},void 0),{updateDrawerScore:a}=t();await a(u.value.drawer_id,r);const{error:h}=await b.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",u.value.id);if(h)throw h;return{success:!0}}catch(r){return console.error("結束輪次錯誤:",r),{success:!1,error:r instanceof Error?r.message:"結束輪次失敗"}}}function c(){u.value=null,s.value=null,g.value=[]}return{currentRound:u,currentWord:s,guesses:g,correctGuesses:S,isCurrentDrawer:f,loadCurrentRound:R,loadGuesses:y,createRound:m,hasGuessed:d,endRound:v,clearGame:c}}),L=100,H=50,C=10,I=100,V=[1,.8,.6,.4,.2];function z(){const e=A();function w(d){const f=Math.min(d,V.length-1),v=V[f]??0;return Math.round(L*v)}function u(d){return d===0?0:H+d*C}async function s(d,f){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:v,error:c}=await b.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",d).single();if(c)throw c;const r=(v?.score||0)+f,{error:t}=await b.from("room_participants").update({score:r}).eq("room_id",e.currentRoom.id).eq("user_id",d);if(t)throw t;const a=e.participants.findIndex(h=>h.user_id===d);return a!==-1&&e.participants[a]&&(e.participants[a].score=r),!0}catch(v){return console.error("更新玩家分數錯誤:",v),!1}}async function g(d,f){const v=u(f);return v===0?!0:await s(d,v)}function S(){if(!e.participants||e.participants.length===0)return null;const d=[...e.participants].sort((f,v)=>v.score-f.score);return d.length===1||d[0]&&d[1]&&d[0].score>d[1].score?{user_id:d[0]?.user_id||"",score:d[0]?.score||0}:{user_id:d[0]?.user_id||"",score:d[0]?.score||0}}const R=E(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((f,v)=>v.score!==f.score?v.score-f.score:new Date(f.joined_at).getTime()-new Date(v.joined_at).getTime()).map((f,v)=>({id:f.id,user_id:f.user_id,score:f.score,rank:v+1}))),y=E(()=>e.currentRoom?.status!=="finished"?null:S());function m(){return I}return{GUESS_BASE_SCORE:L,DRAWING_BASE_SCORE:H,DRAWING_BONUS_PER_GUESS:C,WINNER_BONUS:I,calculateGuessScore:w,calculateDrawingScore:u,calculateWinner:S,updatePlayerScore:s,updateDrawerScore:g,playerRankings:R,winner:y,getWinnerBonus:m}}const te=Object.freeze(Object.defineProperty({__proto__:null,useScoring:z},Symbol.toStringTag,{value:"Module"}));function ne(){const e=A(),w=Y(),{updateDrawerScore:u}=z(),s=k(null),g=k(!1);let S=null;const R=E(()=>e.currentRoom?.status||"waiting"),y=E(()=>R.value==="playing"),m=E(()=>R.value==="waiting"),d=E(()=>R.value==="finished"),f=E(()=>w.currentRound),v=E(()=>e.currentRoom?.current_round||0),c=E(()=>e.currentRoom?.settings.rounds||0),r=E(()=>e.currentRoom?.settings.draw_time||60),t=E(()=>w.isCurrentDrawer);function a(n){S&&clearInterval(S),s.value=n,g.value=!0,S=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(h(),y.value&&f.value&&P())},1e3)}function h(){S&&(clearInterval(S),S=null),g.value=!1}function x(){h(),s.value=null}async function _(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const n=await e.updateRoomStatus("playing");return n.success?await q():n}catch(n){return console.error("開始遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"開始遊戲失敗"}}}async function q(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const n=e.currentRoom.words,l=e.currentRoom.current_round||0;if(l>=n.length||l>=c.value)return await o(),{success:!1,error:"所有輪次已完成"};try{const p=n[l],G=l%e.participants.length,W=e.participants[G];if(!W||!p)throw new Error("無法選擇畫家或詞語");const O=await w.createRound(e.currentRoom.id,W.user_id,p.text,p.source);return O.success&&O.round&&a(r.value),O}catch(p){return console.error("開始下一輪錯誤:",p),{success:!1,error:p instanceof Error?p.message:"開始下一輪失敗"}}}async function P(){if(!f.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{h();const n=w.correctGuesses.length;await u(f.value.drawer_id,n);const l=await w.endRound();return l.success?(e.currentRoom.current_round||0)>=c.value?(await o(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await q()},2e3),{success:!0,gameEnded:!1}):l}catch(n){return console.error("結束輪次錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束輪次失敗"}}}async function o(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return h(),await e.updateRoomStatus("finished"),{success:!0}}catch(n){return console.error("結束遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束遊戲失敗"}}}const i=E(()=>{if(s.value===null)return"--:--";const n=Math.floor(s.value/60),l=s.value%60;return`${n.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`});return K(()=>{h()}),{gameStatus:R,isPlaying:y,isWaiting:m,isFinished:d,currentRound:f,currentRoundNumber:v,totalRounds:c,drawTime:r,isCurrentDrawer:t,timeRemaining:s,isCountingDown:g,formattedTime:i,startGame:_,startNextRound:q,endRound:P,endGame:o,startCountdown:a,stopCountdown:h,resetCountdown:x}}const oe={class:"waiting-lobby"},se={class:"card-hand"},ae={class:"mb-6"},ce={class:"text-xl font-hand-title text-text-primary mb-2"},ie={class:"text-sm text-text-secondary"},ue={class:"font-mono text-text-primary"},le={class:"text-sm text-text-secondary mt-1"},de={class:"text-text-primary"},fe={class:"mb-6"},me={class:"text-sm font-medium text-text-primary mb-3"},we={class:"space-y-2"},ve={class:"w-8 h-8 rounded-full bg-paper-bg-dark border-hand border-border-hand-light flex items-center justify-center text-text-primary text-sm font-hand"},he={class:"flex-1"},_e={class:"text-sm text-text-primary"},ge={key:0,class:"text-xs text-text-secondary ml-2"},pe={class:"mb-6 text-sm text-text-secondary"},Re={class:"space-y-3"},ye=["disabled"],be={key:1,class:"text-sm text-text-secondary text-center"},Ee=["disabled"],Se={key:0,class:"mt-4 text-sm text-text-primary bg-accent-soft-pink/30 p-2 rounded-hand border-hand border-accent-soft-pink font-hand"},xe=J({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:w}){const u=e,s=w,{isHost:g,canStartGame:S,leaveRoom:R,loading:y,error:m}=re(),{startGame:d}=ne();function f(t){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[t||""]||t||"未知"}function v(t){return u.room?.host_id===t}async function c(){(await d()).success&&s("startGame")}async function r(){(await R()).success&&s("leaveRoom")}return(t,a)=>($(),M("div",oe,[D("div",se,[D("div",ae,[D("h2",ce,T(e.room?.name),1),D("div",ie,[a[0]||(a[0]=B(" 房間碼：",-1)),D("span",ue,T(e.room?.code),1)]),D("div",le,[a[1]||(a[1]=B(" 狀態：",-1)),D("span",de,T(f(e.room?.status)),1)])]),D("div",fe,[D("h3",me," 玩家列表 ("+T(e.participants.length)+") ",1),D("div",we,[($(!0),M(Q,null,Z(e.participants,h=>($(),M("div",{key:h.id,class:"flex items-center gap-3 p-2 rounded-hand border-hand border-border-hand-light"},[D("div",ve,T(h.nickname.charAt(0)),1),D("div",he,[D("div",_e,[B(T(h.nickname)+" ",1),v(h.user_id)?($(),M("span",ge," (房主) ")):U("",!0)])])]))),128))])]),D("div",pe,[D("div",null,"繪畫時間："+T(e.room?.settings.draw_time)+" 秒",1),D("div",null,"輪數："+T(e.room?.settings.rounds)+" 輪",1),D("div",null,"詞語總數："+T(e.room?.word_count)+" 個",1)]),D("div",Re,[N(g)&&N(S)?($(),M("button",{key:0,onClick:c,disabled:N(y),class:"btn-minimal w-full"},T(N(y)?"開始中...":"開始遊戲"),9,ye)):N(g)?($(),M("div",be," 至少需要 2 個玩家才能開始遊戲 ")):U("",!0),D("button",{onClick:r,disabled:N(y),class:"btn-minimal w-full"},T(N(y)?"離開中...":"離開房間"),9,Ee)]),N(m)?($(),M("div",Se,T(N(m)),1)):U("",!0)])]))}}),Ge=ee(xe,[["__scopeId","data-v-b4175016"]]);function qe(){const e=A(),w=Y(),u=k(new Map),s=k("disconnected"),g=3,S=1e3,R=k(new Map),y=k(new Map);function m(o){const i=`room:${o}`;if(u.value.has(i))return u.value.get(i);const n=b.channel(i,{config:{presence:{key:"user"}}});return u.value.set(i,n),n}function d(o,i){const n=m(o);return n.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${i}`},async l=>{console.log("房間狀態變化:",l),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}),n}function f(o,i){const n=m(o);return n.on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${i}`},async l=>{console.log("參與者變化:",l),await e.loadParticipants(i)}),n}function v(o,i){const n=m(o);return n.on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${i}`},async l=>{console.log("輪次變化:",l),e.currentRoom&&await w.loadCurrentRound(e.currentRoom.id)}),n}function c(o,i){const n=m(o);return n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${i}`},async l=>{console.log("猜測記錄變化:",l),await w.loadGuesses(i)}).subscribe(),n}function r(o,i){const n=m(o);return n.on("broadcast",{event:"drawing"},l=>{console.log("收到繪畫數據:",l),i(l.payload.stroke)}).subscribe(),n}async function t(o,i){try{const n=m(o);if(s.value==="disconnected")return console.warn("Realtime 未連接，無法發送繪畫數據"),{error:"連接未建立"};const l=await n.send({type:"broadcast",event:"drawing",payload:{stroke:i}});return l==="error"?(console.error("發送繪畫數據失敗"),{error:"發送失敗"}):l}catch(n){return console.error("發送繪畫數據錯誤:",n),{error:n instanceof Error?n.message:"發送失敗"}}}function a(o,i,n){const l=m(o);return l.on("presence",{event:"sync"},()=>{const p=l.presenceState();console.log("Presence 狀態:",p)}).on("presence",{event:"join"},({key:p,newPresences:G})=>{console.log("玩家加入:",p,G)}).on("presence",{event:"leave"},({key:p,leftPresences:G})=>{console.log("玩家離開:",p,G)}),l}function h(o,i,n,l){if(!o||!i)return;const p=m(o);return d(o,i),f(o,i),v(o,i),a(o),p.on("system",{},G=>{console.log("Realtime 系統狀態:",G),G.status==="ok"?(s.value="connected",R.value.set(o,0),x(o)):G.status==="error"&&(s.value="disconnected",console.warn("Realtime 連接錯誤，嘗試重試"),_(o,i,n,l))}),p.subscribe(async G=>{console.log("Realtime 訂閱狀態:",G),G==="SUBSCRIBED"?(s.value="connected",R.value.set(o,0),x(o),await p.track({user_id:n,...l})):(G==="CHANNEL_ERROR"||G==="TIMED_OUT")&&(s.value="disconnected",console.warn("Realtime 訂閱失敗，嘗試重試"),_(o,i,n,l))}),p}function x(o){const i=y.value.get(o);i&&(clearTimeout(i),y.value.delete(o))}function _(o,i,n,l){const p=R.value.get(o)||0;if(p>=g){console.error(`Realtime 連接失敗，已達到最大重試次數 (${g})`),s.value="disconnected";return}x(o);const G=window.setTimeout(()=>{console.log(`嘗試重新連接 Realtime (${p+1}/${g})`),R.value.set(o,p+1),q(o),h(o,i,n,l)},S*(p+1));y.value.set(o,G)}function q(o){const i=`room:${o}`,n=u.value.get(i);n&&(b.removeChannel(n),u.value.delete(i)),x(o),R.value.delete(o)}function P(){u.value.forEach((o,i)=>{b.removeChannel(o),x(i)}),u.value.clear(),R.value.clear(),y.value.clear()}return K(()=>{P()}),{connectionStatus:s,subscribeRoom:h,subscribeDrawing:r,subscribeGuesses:c,sendDrawing:t,unsubscribeRoom:q,unsubscribeAll:P}}export{Ge as W,ne as a,qe as b,A as c,Y as d,z as e,re as u};
