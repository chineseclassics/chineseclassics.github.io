const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BhuEJWht.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as gr,f as R,y as Me,c as Y,o as K,z as Nr,a as be,e as G,A as Dr,B as We,r as $,u as fe,E as _,L as Ue,h as kr,t as j,s as ce,n as Xe,F as Je,m as qr,b as se,_ as Or}from"./index-BhuEJWht.js";const Hr=["width","height","fill","transform"],Br={key:0},$r=G("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),Ur=[$r],Wr={key:1},Lr=G("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Zr=G("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Vr=[Lr,Zr],jr={key:2},zr=G("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Yr=[zr],Kr={key:3},Fr=G("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Xr=[Fr],Jr={key:4},Qr=G("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),et=[Qr],rt={key:5},tt=G("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),ot=[tt],nt={name:"PhPaintBrush"},Vt=gr({...nt,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const g=e,a=Me("weight","regular"),d=Me("size","1em"),A=Me("color","currentColor"),P=Me("mirrored",!1),w=R(()=>g.weight??a),Z=R(()=>g.size??d),k=R(()=>g.color??A),b=R(()=>g.mirrored!==void 0?g.mirrored?"scale(-1, 1)":void 0:P?"scale(-1, 1)":void 0);return(y,T)=>(K(),Y("svg",Dr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:Z.value,height:Z.value,fill:k.value,transform:b.value},y.$attrs),[Nr(y.$slots,"default"),w.value==="bold"?(K(),Y("g",Br,Ur)):w.value==="duotone"?(K(),Y("g",Wr,Vr)):w.value==="fill"?(K(),Y("g",jr,Yr)):w.value==="light"?(K(),Y("g",Kr,Xr)):w.value==="regular"?(K(),Y("g",Jr,et)):w.value==="thin"?(K(),Y("g",rt,ot)):be("",!0)],16,Hr))}}),Ge=We("room",()=>{const e=$(null),g=$([]),a=$(!1),d=$(null),A=R(()=>{const r=fe();return e.value?.host_id===r.user?.id});async function P(r){try{a.value=!0,d.value=null;const t=fe();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(h){console.warn("載入用戶資料時發生錯誤（非關鍵）:",h)}const i=r.gameMode||"classic";if(i==="classic"&&r.words.length<6)throw new Error("至少需要 6 個詞語");let p=null,E=0;const D=10;for(;E<D&&!p;){E++;const W={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null,game_mode:i,single_round_mode:r.singleRoundMode||!1,is_final_round:!1},{data:L,error:n}=await _.from("game_rooms").insert(W).select().single();if(n){if(n.code==="23505")continue;throw new Error(n.message||"插入房間失敗")}if(L){p=L;break}}if(!p)throw new Error("無法生成唯一房間碼，請重試");const c={room_id:p.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:h}=await _.from("room_participants").insert(c);h&&console.error("創建參與記錄錯誤:",h)}catch(h){console.error("創建參與記錄時發生錯誤:",h)}try{const{data:h,error:W}=await _.from("room_participants").select("*").eq("room_id",p.id).order("joined_at",{ascending:!0});W?console.error("載入參與者列表失敗:",W):h&&(g.value=h)}catch(h){console.error("載入參與者列表時發生錯誤:",h)}return e.value=p,{success:!0,room:p}}catch(t){return d.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:d.value}}finally{a.value=!1}}async function w(r,t){try{a.value=!0,d.value=null;const i=fe();if(!i.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:p,error:E}=await _.from("game_rooms").select("*").eq("code",r).single();if(E||!p)throw new Error("房間不存在");if(p.status!=="waiting")throw new Error("房間已開始或已結束");const{data:D}=await _.from("room_participants").select("*").eq("room_id",p.id).eq("user_id",i.user.id).maybeSingle();if(D)return e.value=p,await k(p.id),{success:!0,room:p};const{error:c}=await _.from("room_participants").insert({room_id:p.id,user_id:i.user.id,nickname:t.trim(),score:0});if(c){if(c.code==="23505"||c.message.includes("duplicate"))return e.value=p,await k(p.id),{success:!0,room:p};throw c}return e.value=p,await k(p.id),{success:!0,room:p}}catch(i){return d.value=i instanceof Error?i.message:"加入房間失敗",console.error("加入房間錯誤:",i),{success:!1,error:d.value}}finally{a.value=!1}}async function Z(){try{if(!e.value)return{success:!0};a.value=!0,d.value=null;const r=fe();if(!r.user)throw new Error("請先登入");const{error:t}=await _.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(A.value){const{error:i}=await _.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);i&&console.error("關閉房間失敗:",i)}return e.value=null,g.value=[],{success:!0}}catch(r){return d.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,g.value=[],{success:!1,error:d.value}}finally{a.value=!1}}async function k(r){try{const{data:t,error:i}=await _.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(i)throw i;g.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function b(r){try{a.value=!0,d.value=null;const{data:t,error:i}=await _.from("game_rooms").select("*").eq("id",r).single();if(i)throw i;return e.value=t,await k(r),{success:!0,room:t}}catch(t){return d.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:d.value}}finally{a.value=!1}}async function y(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await _.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(r==="finished"&&e.value&&await T(),e.value){const i=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:i,newStatus:e.value.status})}return{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:d.value}}}async function T(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:r,error:t}=await _.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(t){console.error("獲取參與者錯誤:",t);return}if(!r||r.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const i=r.map(c=>c.user_id),{data:p,error:E}=await _.from("users").select("id, user_type").in("id",i);if(E){console.error("獲取用戶信息錯誤:",E);return}const D=new Set(p?.filter(c=>c.user_type==="registered").map(c=>c.id)||[]);for(const c of r){if(!D.has(c.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${c.user_id} 的積分累積`);continue}if(c.score>0){const{error:h}=await _.rpc("accumulate_user_score",{user_id_param:c.user_id,score_to_add:c.score});if(h){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",h);const{data:W,error:L}=await _.from("users").select("total_score").eq("id",c.user_id).single();if(L){console.error(`[RoomStore] 獲取用戶 ${c.user_id} 總積分錯誤:`,L);continue}const n=(W?.total_score||0)+c.score,{error:m}=await _.from("users").update({total_score:n}).eq("id",c.user_id);m?console.error(`[RoomStore] 更新用戶 ${c.user_id} 總積分錯誤:`,m):console.log(`[RoomStore] 用戶 ${c.user_id} 積分已累積: +${c.score} (總積分: ${n})`)}else console.log(`[RoomStore] 用戶 ${c.user_id} 積分已累積: +${c.score}`)}}}catch(r){console.error("[RoomStore] 累積積分錯誤:",r)}}async function q(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await _.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:d.value}}}async function H(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:r});const t={...e.value.settings,...r},{error:i}=await _.from("game_rooms").update({settings:t}).eq("id",e.value.id);if(i)throw i;return e.value&&(e.value.settings=t,console.log("[RoomStore] 房間設置已更新:",t)),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",t),{success:!1,error:d.value}}}function U(){e.value=null,g.value=[],d.value=null}function F(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function o(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!A.value)return{success:!1,error:"只有房主可以踢人"};const t=fe();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,d.value=null;const{data:i,error:p}=await _.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(p)throw new Error(p.message);if(i&&!i.success)throw new Error(i.error||"踢出玩家失敗");return await k(e.value.id),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:d.value}}finally{a.value=!1}}async function f(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:r});const{error:t}=await _.from("game_rooms").update({is_final_round:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.is_final_round=r,console.log("[RoomStore] 最後一局標記已更新:",r)),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",t),{success:!1,error:d.value}}}return{currentRoom:e,participants:g,loading:a,error:d,isHost:A,createRoom:P,joinRoom:w,leaveRoom:Z,kickPlayer:o,loadParticipants:k,loadRoom:b,updateRoomStatus:y,updateRoomDrawer:q,updateRoomSettings:H,setCurrentDrawer:F,setFinalRound:f,clearRoom:U}});function st(){const e=Ge(),g=R(()=>e.currentRoom),a=R(()=>e.participants),d=R(()=>e.isHost),A=R(()=>g.value&&g.value.game_mode==="storyboard"?3:2),P=R(()=>!g.value||g.value.status!=="waiting"||!d.value?!1:a.value.length>=A.value);async function w(b){return await e.createRoom(b)}async function Z(b,y){return await e.joinRoom(b,y)}async function k(){return await e.leaveRoom()}return{currentRoom:g,participants:a,isHost:d,canStartGame:P,minPlayersRequired:A,loading:R(()=>e.loading),error:R(()=>e.error),createRoom:w,joinRoom:Z,leaveRoom:k}}const Qe=100,er=50,rr=10,at=10,tr=100,or=[1,.8,.6,.4,.2];function ct(){const e=Ge();function g(b){const y=Math.min(b,or.length-1),T=or[y]??0;return Math.round(Qe*T)}function a(b,y=0){if(b===0)return 0;const T=b*rr,q=Math.round(y*at);return er+T+q}async function d(b,y,T=0){const q=a(y,T);return q===0?!0:await A(b,q)}async function A(b,y){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:T,error:q}=await _.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",b).single();if(q)throw q;const H=(T?.score||0)+y,{error:U}=await _.from("room_participants").update({score:H}).eq("room_id",e.currentRoom.id).eq("user_id",b);if(U)throw U;const F=e.participants.findIndex(o=>o.user_id===b);return F!==-1&&e.participants[F]&&(e.participants[F].score=H),!0}catch(T){return console.error("更新玩家分數錯誤:",T),!1}}function P(){if(!e.participants||e.participants.length===0)return null;const b=[...e.participants].sort((y,T)=>T.score-y.score);return b.length===1||b[0]&&b[1]&&b[0].score>b[1].score?{user_id:b[0]?.user_id||"",score:b[0]?.score||0}:{user_id:b[0]?.user_id||"",score:b[0]?.score||0}}const w=R(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((y,T)=>T.score!==y.score?T.score-y.score:new Date(y.joined_at).getTime()-new Date(T.joined_at).getTime()).map((y,T)=>({id:y.id,user_id:y.user_id,score:y.score,rank:T+1}))),Z=R(()=>e.currentRoom?.status!=="finished"?null:P());function k(){return tr}return{GUESS_BASE_SCORE:Qe,DRAWING_BASE_SCORE:er,DRAWING_BONUS_PER_GUESS:rr,WINNER_BONUS:tr,calculateGuessScore:g,calculateDrawingScore:a,calculateWinner:P,updatePlayerScore:A,updateDrawerScore:d,playerRankings:w,winner:Z,getWinnerBonus:k}}const vr=We("game",()=>{const e=Ge(),g=fe(),a=$(null),d=$(null),A=$([]),P=R(()=>A.value.filter(l=>l.is_correct)),w=R(()=>a.value?A.value.filter(l=>l.round_id===a.value.id):[]),Z=R(()=>w.value.filter(l=>l.is_correct)),k=$("drawing"),b=$([]),y=$([]),T=$(!1),q=$([]),H=R(()=>y.value.length===0?0:y.value.reduce((u,C)=>u+C.rating,0)/y.value.length);function U(l){k.value=l}function F(l){b.value=l}function o(l){const u=y.value.findIndex(C=>C.rater_id===l.rater_id);u>=0?y.value[u]=l:y.value.push(l)}function f(){y.value=[]}function r(){if(T.value||!d.value)return null;const l=d.value.length,u=[];for(let O=0;O<l;O++)q.value.includes(O)||u.push(O);if(u.length===0)return null;const C=Math.floor(Math.random()*u.length),x=u[C];return x===void 0?null:(q.value.push(x),T.value=!0,x)}function t(l,u){T.value=l,q.value=u}function i(){T.value=!1,q.value=[]}async function p(l){try{const{data:u,error:C}=await _.from("game_rounds").select("*").eq("room_id",l).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(C)throw C;return u&&(a.value=u,d.value=u.word_text,u.word_options&&Array.isArray(u.word_options)&&(b.value=u.word_options),u.hint_given!==void 0&&(T.value=u.hint_given),u.revealed_indices&&Array.isArray(u.revealed_indices)&&(q.value=u.revealed_indices),await E(u.id)),{success:!0,round:u}}catch(u){return console.error("載入當前輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"載入輪次失敗"}}}async function E(l){try{const{data:u,error:C}=await _.from("guesses").select("*").eq("round_id",l).order("guessed_at",{ascending:!0});if(C)throw C;const x=u||[],O=new Set(A.value.map(oe=>oe.id)),te=x.filter(oe=>!O.has(oe.id));te.length>0&&(A.value=[...A.value,...te])}catch(u){console.error("載入猜測記錄錯誤:",u)}}async function D(l){try{const{data:u,error:C}=await _.from("game_rounds").select("id").eq("room_id",l);if(C)throw C;if(!u||u.length===0){A.value=[];return}const x=u.map(oe=>oe.id),{data:O,error:te}=await _.from("guesses").select("*").in("round_id",x).order("guessed_at",{ascending:!0});if(te)throw te;A.value=O||[]}catch(u){console.error("載入所有猜測記錄錯誤:",u)}}async function c(l,u,C,x){try{if(!e.currentRoom)throw new Error("沒有當前房間");const O=(e.currentRoom.current_round||0)+1,{data:te,error:oe}=await _.from("game_rounds").insert({room_id:l,round_number:O,drawer_id:u,word_text:C,word_source:x}).select().single();if(oe)throw oe;return a.value=te,d.value=C,await _.from("game_rooms").update({current_round:O,current_drawer_id:u}).eq("id",l),{success:!0,round:te}}catch(O){return console.error("創建輪次錯誤:",O),{success:!1,error:O instanceof Error?O.message:"創建輪次失敗"}}}function h(l){return a.value?A.value.some(u=>u.round_id===a.value.id&&u.user_id===l&&u.is_correct):!1}const W=R(()=>!a.value||!g.user?!1:a.value.drawer_id===g.user.id);async function L(){if(!a.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const l=P.value.length,u=H.value,{updateDrawerScore:C}=ct();console.log("[endRound] 猜中人數:",l,"平均評分:",u),await C(a.value.drawer_id,l,u);const{error:x}=await _.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(x)throw x;return{success:!0}}catch(l){return console.error("結束輪次錯誤:",l),{success:!1,error:l instanceof Error?l.message:"結束輪次失敗"}}}function n(){a.value=null,d.value=null,A.value=[],k.value="drawing",b.value=[],y.value=[],T.value=!1,q.value=[]}async function m(l,u,C){if(!g.user)return{success:!1,error:"用戶未登錄"};try{const{data:x,error:O}=await _.from("drawing_ratings").upsert({round_id:l,rater_id:g.user.id,drawer_id:u,rating:C},{onConflict:"round_id,rater_id"}).select().single();if(O)throw O;return x&&o(x),{success:!0,rating:x}}catch(x){return console.error("提交評分錯誤:",x),{success:!1,error:x instanceof Error?x.message:"提交評分失敗"}}}async function v(l){try{const{data:u,error:C}=await _.from("drawing_ratings").select("*").eq("round_id",l);if(C)throw C;return y.value=u||[],{success:!0,ratings:u}}catch(u){return console.error("載入評分錯誤:",u),{success:!1,error:u instanceof Error?u.message:"載入評分失敗"}}}return{currentRound:a,currentWord:d,guesses:A,correctGuesses:P,currentRoundGuesses:w,currentRoundCorrectGuesses:Z,isCurrentDrawer:W,roundStatus:k,wordOptions:b,ratings:y,averageRating:H,hintGiven:T,revealedIndices:q,loadCurrentRound:p,loadGuesses:E,loadAllGuesses:D,createRound:c,hasGuessed:h,endRound:L,clearGame:n,setRoundStatus:U,setWordOptions:F,addRating:o,clearRatings:f,submitRating:m,loadRatings:v,giveHint:r,setHintState:t,resetHint:i}});function nr(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function sr(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function ar(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function jt(e){return e.trim().length===0}function zt(e,g=100){return e.length>g}const ut=We("story",()=>{const e=fe(),g=$([]),a=$([]),d=$([]),A=$("setup"),P=$(!1),w=$(null),Z=R(()=>{const n=g.value.filter(m=>m.itemType==="text");return n.length===0?null:n[n.length-1]}),k=R(()=>{if(g.value.length===0)return null;const n=g.value[0];return n&&n.itemType==="text"?n.content:null}),b=R(()=>e.user&&a.value.find(n=>n.userId===e.user.id)||null),y=R(()=>e.user&&d.value.find(n=>n.voterId===e.user.id)||null),T=R(()=>{const n=new Map;for(const m of a.value)n.set(m.id,0);for(const m of d.value){const v=n.get(m.submissionId)||0;n.set(m.submissionId,v+1)}return n}),q=R(()=>{if(a.value.length===0)return null;let n=-1,m=[];for(const v of a.value){const l=T.value.get(v.id)||0;l>n?(n=l,m=[v]):l===n&&m.push(v)}return m.length>0?m[0]:null});async function H(n){try{P.value=!0,w.value=null;const{data:m,error:v}=await _.from("story_chains").select("*").eq("room_id",n).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return g.value=(m||[]).map(l=>nr(l)),console.log("[StoryStore] 故事鏈已載入:",g.value.length,"項"),{success:!0,data:g.value}}catch(m){return w.value=m instanceof Error?m.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",m),{success:!1,error:w.value}}finally{P.value=!1}}async function U(n){try{P.value=!0,w.value=null;const m={room_id:n.roomId,round_number:n.roundNumber,item_type:n.itemType,content:n.content,author_id:n.authorId,author_name:n.authorName},{data:v,error:l}=await _.from("story_chains").insert(m).select().single();if(l)throw new Error(l.message);const u=nr(v);return g.value.push(u),console.log("[StoryStore] 故事鏈項目已添加:",u),{success:!0,data:u}}catch(m){return w.value=m instanceof Error?m.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",m),{success:!1,error:w.value}}finally{P.value=!1}}async function F(n,m,v,l){return U({roomId:n,roundNumber:0,itemType:"text",content:m,authorId:v,authorName:l})}async function o(n,m,v,l){return U({roomId:n,roundNumber:-1,itemType:"text",content:m,authorId:v,authorName:l})}async function f(n){try{P.value=!0,w.value=null;const{data:m,error:v}=await _.from("story_submissions").select("*").eq("round_id",n).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return a.value=(m||[]).map(l=>sr(l)),console.log("[StoryStore] 句子提交已載入:",a.value.length,"項"),{success:!0,data:a.value}}catch(m){return w.value=m instanceof Error?m.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",m),{success:!1,error:w.value}}finally{P.value=!1}}async function r(n,m){if(!e.user)return{success:!1,error:"用戶未登錄"};try{P.value=!0,w.value=null;const v={round_id:n,user_id:e.user.id,sentence:m.trim(),vote_count:0,is_winner:!1},{data:l,error:u}=await _.from("story_submissions").upsert(v,{onConflict:"round_id,user_id"}).select().single();if(u)throw new Error(u.message);const C=sr(l),x=a.value.findIndex(O=>O.roundId===n&&O.userId===e.user.id);return x>=0?a.value[x]=C:a.value.push(C),console.log("[StoryStore] 句子已提交:",C),{success:!0,data:C}}catch(v){return w.value=v instanceof Error?v.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",v),{success:!1,error:w.value}}finally{P.value=!1}}async function t(n){try{const{error:m}=await _.from("story_submissions").update({is_winner:!0}).eq("id",n);if(m)throw new Error(m.message);const v=a.value.find(l=>l.id===n);return v&&(v.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",n),{success:!0}}catch(m){return w.value=m instanceof Error?m.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",m),{success:!1,error:w.value}}}async function i(n){try{P.value=!0,w.value=null;const{data:m,error:v}=await _.from("story_votes").select("*").eq("round_id",n);if(v)throw new Error(v.message);return d.value=(m||[]).map(l=>ar(l)),console.log("[StoryStore] 投票記錄已載入:",d.value.length,"項"),{success:!0,data:d.value}}catch(m){return w.value=m instanceof Error?m.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",m),{success:!1,error:w.value}}finally{P.value=!1}}async function p(n,m){if(!e.user)return{success:!1,error:"用戶未登錄"};try{P.value=!0,w.value=null;const v={round_id:n,voter_id:e.user.id,submission_id:m},{data:l,error:u}=await _.from("story_votes").upsert(v,{onConflict:"round_id,voter_id"}).select().single();if(u)throw new Error(u.message);const C=ar(l),x=d.value.findIndex(O=>O.roundId===n&&O.voterId===e.user.id);return x>=0?d.value[x]=C:d.value.push(C),console.log("[StoryStore] 投票已記錄:",C),{success:!0,data:C}}catch(v){return w.value=v instanceof Error?v.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",v),{success:!1,error:w.value}}finally{P.value=!1}}function E(n){A.value=n,console.log("[StoryStore] 階段已更新:",n)}function D(){a.value=[],d.value=[],console.log("[StoryStore] 輪次數據已清除")}function c(){g.value=[],a.value=[],d.value=[],A.value="setup",w.value=null,console.log("[StoryStore] 所有故事數據已清除")}function h(n){g.value.some(v=>v.id===n.id)||(g.value.push(n),console.log("[StoryStore] 本地添加故事鏈項目:",n))}function W(n){const m=a.value.findIndex(v=>v.id===n.id);m>=0?a.value[m]=n:a.value.push(n),console.log("[StoryStore] 本地添加句子提交:",n)}function L(n){const m=d.value.findIndex(v=>v.roundId===n.roundId&&v.voterId===n.voterId);m>=0?d.value[m]=n:d.value.push(n),console.log("[StoryStore] 本地添加投票記錄:",n)}return{storyChain:g,submissions:a,votes:d,currentPhase:A,loading:P,error:w,latestSentence:Z,storyOpening:k,mySubmission:b,myVote:y,voteCounts:T,winningSubmission:q,loadStoryChain:H,addStoryChainItem:U,addStoryOpening:F,addStoryEnding:o,addStoryChainItemLocal:h,loadSubmissions:f,submitSentence:r,markWinningSubmission:t,addSubmissionLocal:W,loadVotes:i,castVote:p,addVoteLocal:L,setPhase:E,clearRoundData:D,clearAll:c}}),re=new Map,ee=$("disconnected"),de=new Map,he=new Set,Pe=new Map,ae=new Map,X=new Map,Ie=new Map,ke=10,cr=1e3,it=3e4;function ie(...e){}function z(...e){console.warn("[Realtime]",...e)}function qe(){const e=navigator.userAgent;return/^((?!chrome|android).)*safari/i.test(e)}function ue(){const e=Ge(),g=vr();function a(o){const f=`room:${o}`;if(re.has(f))return re.get(f);const r=_.channel(f,{config:{presence:{key:"user"},broadcast:{self:!0}}});return re.set(f,r),r}function d(o){const f=Pe.get(o);f&&(clearTimeout(f),Pe.delete(o))}function A(o,f,r,t,i){if(Ie.set(r,{roomId:"",userId:t,userData:i}),o==="SUBSCRIBED")ee.value="connected",d(r),ae.set(r,0),X.set(r,!1),(async(E=3)=>{for(let D=0;D<E;D++)try{await f.track({user_id:t,...i}),ie("Presence track 成功");return}catch(c){z(`Presence track 失敗 (嘗試 ${D+1}/${E}):`,c),D<E-1&&await new Promise(h=>setTimeout(h,500*(D+1)))}})();else if(o==="CHANNEL_ERROR"||o==="TIMED_OUT"){if(ee.value="disconnected",X.get(r))return;const p=ae.get(r)||0;z("訂閱失敗:",o,"(嘗試次數:",p,", 瀏覽器:",navigator.userAgent.slice(0,50),")"),X.set(r,!0),P(r,t,i)}else o==="CLOSED"&&(ee.value="disconnected",X.set(r,!1))}function P(o,f,r){const t=ae.get(o)||0;if(t>=ke){z(`重連失敗次數過多 (${t} 次)，停止重連。請刷新頁面重試。`),ee.value="disconnected",X.set(o,!1);return}d(o),ae.set(o,t+1);const i=qe(),p=i?cr*2:cr,E=Math.min(p*Math.pow(1.5,t),it),D=window.setTimeout(async()=>{const c=`room:${o}`;let h=re.get(c),W=!1;if(h){const L=h.state;if(L==="errored"||L==="closed"){try{_.removeChannel(h)}catch(n){z("移除舊 Channel 失敗:",n)}re.delete(c),he.delete(o),h=void 0,W=!0,i&&await new Promise(n=>setTimeout(n,500))}}if(!h||W){try{h=_.channel(c,{config:{presence:{key:"user"},broadcast:{self:!0}}}),re.set(c,h),X.set(o,!1),ee.value="connecting",h.subscribe(L=>{A(L,h,o,f,r)})}catch(L){z("重建 Channel 失敗:",L),X.set(o,!0),P(o,f,r)}return}h.state!=="joined"?(X.set(o,!1),ee.value="connecting",h.subscribe(L=>{A(L,h,o,f,r)})):(ee.value="connected",X.set(o,!1),ae.set(o,0))},E);Pe.set(o,D)}function w(o,f,r,t){return new Promise((i,p)=>{if(!o||!f){z("缺少 roomCode 或 roomId"),p(new Error("缺少 roomCode 或 roomId"));return}Ie.set(o,{roomId:f,userId:r,userData:t});const E=a(o),D=E.state;if(D==="joined"){ee.value="connected",X.set(o,!1),i(E);return}if(D==="joining"){const c=setInterval(()=>{const W=E.state;W==="joined"?(clearInterval(c),X.set(o,!1),i(E)):(W==="closed"||W==="errored")&&clearInterval(c)},100),h=qe()?1e4:5e3;setTimeout(()=>{clearInterval(c),E.state!=="joined"&&(z("subscribeRoom - 連接超時"),p(new Error("連接超時")))},h);return}if(he.has(o)){ee.value="connecting",E.subscribe(c=>{A(c,E,o,r,t),c==="SUBSCRIBED"?i(E):(c==="CHANNEL_ERROR"||c==="TIMED_OUT")&&(ae.get(o)||0)>=ke&&p(new Error(`訂閱失敗: ${c}`))});return}E.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${f}`},async c=>{ie("房間狀態變化:",c.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${f}`},async c=>{ie("參與者變化:",c.eventType),await e.loadParticipants(f)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${f}`},async c=>{ie("輪次變化:",c.eventType,c.new),e.currentRoom&&await g.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async c=>{const h=c.new;if(h&&g.currentRound&&(await g.loadGuesses(h.round_id),h.is_correct&&e.isHost&&g.roundStatus==="drawing")){const W=g.currentRound.drawer_id,L=e.participants.filter(v=>v.user_id!==W),n=new Set(g.currentRoundCorrectGuesses.map(v=>v.user_id));if(L.length>0&&L.every(v=>n.has(v.user_id))){const{useGame:v}=await Ue(async()=>{const{useGame:u}=await Promise.resolve().then(()=>dt);return{useGame:u}},void 0),{endRound:l}=v();await l()}}}).on("broadcast",{event:"drawing"},c=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(c));const h=de.get(o);h&&c.payload?.stroke?(console.log("[Realtime] 分發給",h.size,"個回調"),h.forEach(W=>W(c.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",h?.size,"stroke:",c.payload?.stroke)}).on("presence",{event:"sync"},()=>{const c=E.presenceState();ie("Presence 同步，在線:",Object.keys(c).length)}),he.add(o),ee.value="connecting",E.subscribe(c=>{A(c,E,o,r,t),c==="SUBSCRIBED"?i(E):(c==="CHANNEL_ERROR"||c==="TIMED_OUT")&&(ae.get(o)||0)>=ke&&p(new Error(`訂閱失敗: ${c}`))})})}function Z(o,f){return de.has(o)||de.set(o,new Set),de.get(o).add(f),()=>{de.get(o)?.delete(f)}}function k(o,f){const r=a(o),t=`guesses:${f}`;return r[t]||(r.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${f}`},async i=>{ie("收到新猜測記錄:",i.eventType,i.new),await g.loadGuesses(f)}),r[t]=!0),r}function b(o,f){const r=a(o),t=`gameState:${o}`;return r[t]||(r.on("broadcast",{event:"game_state"},i=>{ie("收到遊戲狀態廣播:",i.payload),f(i.payload)}),r[t]=!0),r}async function y(o,f){const r=a(o),t=r.state;if(t!=="joined")return z("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{ie("廣播遊戲狀態:",f);const i=await r.send({type:"broadcast",event:"game_state",payload:f});return i==="error"?(z("發送遊戲狀態失敗"),{error:"發送失敗"}):i}catch(i){return z("發送遊戲狀態錯誤:",i),{error:i instanceof Error?i.message:"發送失敗"}}}async function T(o,f){const r=a(o),t=r.state;if(t!=="joined")return z("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const i=await r.send({type:"broadcast",event:"drawing",payload:{stroke:f}});return i==="error"?(z("發送失敗"),{error:"發送失敗"}):i}catch(i){return z("發送錯誤:",i),{error:i instanceof Error?i.message:"發送失敗"}}}function q(o){const f=`room:${o}`,r=re.get(f);d(o),ae.delete(o),X.delete(o),Ie.delete(o),r&&(_.removeChannel(r),re.delete(f)),de.delete(o),he.delete(o)}async function H(o,f,r,t){const i=`room:${o}`,p=re.get(i);if(Ie.set(o,{roomId:f,userId:r,userData:t}),X.get(o))return;if(!p){try{await w(o,f,r,t)}catch(D){z("連接恢復：重新訂閱失敗:",D)}return}const E=p.state;if(E==="joined"){ee.value="connected";return}if(E!=="joining"){if(qe()&&(E==="errored"||E==="closed")){try{_.removeChannel(p)}catch(D){z("移除異常 Channel 失敗:",D)}re.delete(i),he.delete(o),await new Promise(D=>setTimeout(D,500));try{await w(o,f,r,t)}catch(D){z("連接恢復 (Safari)：重新訂閱失敗:",D)}return}ae.set(o,0),X.set(o,!0),P(o,r,t)}}function U(){Pe.forEach((o,f)=>d(f)),re.forEach(o=>_.removeChannel(o)),re.clear(),de.clear(),he.clear(),X.clear(),Ie.clear(),ae.clear()}function F(){return ee.value}return{connectionStatus:ee,subscribeRoom:w,subscribeDrawing:Z,subscribeGuesses:k,subscribeGameState:b,sendDrawing:T,broadcastGameState:y,unsubscribeRoom:q,unsubscribeAll:U,getConnectionStatus:F,checkAndRestoreConnection:H}}const ur=6,ir=60,lr=60,dr=60,lt=5,Oe=10,He=5,Be=2,mr=3,_e=$(null),$e=$(!1);let ye=null;const me=$(null);let pe=null;const xe=$(new Set),fr=$("setup"),Se=$(null);let Re=null;function wr(){const e=Ge(),g=vr(),a=ut();ue();const d=_e,A=$e,P=me,w=R(()=>e.currentRoom?.status||"waiting"),Z=R(()=>w.value==="playing"),k=R(()=>w.value==="waiting"),b=R(()=>w.value==="finished"),y=R(()=>g.roundStatus),T=R(()=>y.value==="drawing"),q=R(()=>y.value==="summary"),H=R(()=>e.currentRoom?.game_mode==="storyboard"),U=fr,F=Se,o=R(()=>H.value&&U.value==="drawing"),f=R(()=>H.value&&U.value==="writing"),r=R(()=>H.value&&U.value==="voting"),t=R(()=>H.value&&U.value==="summary"),i=R(()=>H.value&&U.value==="setup"),p=R(()=>H.value&&U.value==="ending"),E=R(()=>g.currentRound),D=R(()=>e.currentRoom?.current_round||0),c=R(()=>e.currentRoom?.settings.rounds||0),h=R(()=>e.currentRoom?.settings.draw_time||60),W=R(()=>g.isCurrentDrawer);function L(s){console.log("[useGame] startCountdown 開始，時長:",s,"秒"),ye&&clearInterval(ye),_e.value=s,$e.value=!0,ye=window.setInterval(()=>{_e.value!==null&&_e.value>0?_e.value--:(n(),Z.value&&E.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),te()))},1e3)}function n(){ye&&(clearInterval(ye),ye=null),$e.value=!1}function m(){n(),_e.value=null}function v(){console.log("[useGame] startSummaryCountdown 開始"),pe&&clearInterval(pe),me.value=ur,console.log("[useGame] 開始總結倒計時:",ur,"秒"),pe=window.setInterval(async()=>{me.value!==null&&me.value>0?(me.value--,console.log("[useGame] 總結倒計時:",me.value)):(l(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await oe()))},1e3)}function l(){console.log("[useGame] stopSummaryCountdown"),pe&&(clearInterval(pe),pe=null),me.value=null}function u(){if(!e.currentRoom)return null;const s=e.currentRoom.words;if(s.length===0)return null;const S=[];for(let N=0;N<s.length;N++)xe.value.has(N)||S.push(N);let I=0;if(S.length>0){const N=Math.floor(Math.random()*S.length);I=S[N]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),xe.value.clear(),I=Math.floor(Math.random()*s.length);return xe.value.add(I),s[I]??null}async function C(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{xe.value.clear();const s=e.participants.length,S=await e.updateRoomSettings({rounds:s});if(!S.success)return S;console.log("[useGame] 輪數已自動設定為房間人數:",s);const I=await e.updateRoomStatus("playing");if(!I.success)return I;if(H.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),le("setup"),a.clearAll();const{broadcastGameState:M}=ue();return await M(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await x()}catch(s){return console.error("開始遊戲錯誤:",s),{success:!1,error:s instanceof Error?s.message:"開始遊戲失敗"}}}async function x(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const S=(e.currentRoom.current_round||0)+1;try{const I=(S-1)%e.participants.length,N=e.participants[I];if(console.log("[startDrawingPhase] 第",S,"輪，畫家:",N?.nickname),!N)throw new Error("無法選擇畫家");let M=null;if(H.value){const ne=a.latestSentence;ne?(M={text:ne.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",M.text)):(M={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(M=u(),!M)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",M.text)}await e.updateRoomDrawer(N.user_id);const B=await g.createRound(e.currentRoom.id,N.user_id,M.text,M.source);if(!B.success||!B.round)throw new Error("創建輪次失敗");const{broadcastGameState:Q}=ue();return H.value?await Q(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:N.user_id,drawerName:N.nickname,roundNumber:S,startedAt:B.round.started_at}):await Q(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:N.user_id,drawerName:N.nickname,roundNumber:S,startedAt:B.round.started_at}),{success:!0,drawerId:N.user_id,word:M.text}}catch(I){return console.error("開始繪畫階段錯誤:",I),{success:!1,error:I instanceof Error?I.message:"開始繪畫階段失敗"}}}async function O(){return await x()}async function te(){if(!E.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const s=await g.endRound();if(!s.success)return s;const S=!1,{broadcastGameState:I}=ue();return await I(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:S}),{success:!0,gameEnded:S}}catch(s){return console.error("結束輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"結束輪次失敗"}}}async function oe(){return e.currentRoom?e.isHost?(await x(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function hr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await e.updateRoomStatus("finished"),{success:!0}}catch(s){return console.error("結束遊戲錯誤:",s),{success:!1,error:s instanceof Error?s.message:"結束遊戲失敗"}}}async function _r(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(y.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),l(),await x()}catch(s){return console.error("下一局錯誤:",s),{success:!1,error:s instanceof Error?s.message:"下一局失敗"}}}const yr=R(()=>{if(d.value===null)return"--:--";const s=Math.floor(d.value/60),S=d.value%60;return`${s.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}`});function le(s){console.log("[useGame] 設置分鏡模式階段:",s),fr.value=s,a.setPhase(s)}function pr(s,S){console.log("[useGame] 開始分鏡模式倒計時:",s,"秒"),Re&&clearInterval(Re),Se.value=s,Re=window.setInterval(()=>{Se.value!==null&&Se.value>0?Se.value--:(Te(),S&&S())},1e3)}function Te(){Re&&(clearInterval(Re),Re=null)}function Sr(){Te(),Se.value=null}async function Rr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),le("drawing"),a.clearRoundData();const{broadcastGameState:s}=ue();return await s(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString()}),{success:!0}}async function br(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const s=new Date().toISOString(),{error:S}=await _.from("game_rooms").update({storyboard_phase:"writing",updated_at:s}).eq("id",e.currentRoom.id);S&&console.error("[useGame] 更新數據庫失敗:",S),le("writing");const{broadcastGameState:I}=ue();return await I(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:s}),{success:!0}}async function Er(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const s=new Date().toISOString(),{error:S}=await _.from("game_rooms").update({storyboard_phase:"voting",updated_at:s}).eq("id",e.currentRoom.id);S&&console.error("[useGame] 更新數據庫失敗:",S),le("voting");const{broadcastGameState:I}=ue();return await I(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:s}),{success:!0}}async function Ir(s){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const S=new Date().toISOString(),{error:I}=await _.from("game_rooms").update({storyboard_phase:"summary",updated_at:S}).eq("id",e.currentRoom.id);I&&console.error("[useGame] 更新數據庫失敗:",I),le("summary");const{broadcastGameState:N}=ue();return await N(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:S,storyboardRoundResult:s?{winningSentence:s.winningSentence||"故事繼續發展中...",winnerName:s.winnerName||"",winnerId:s.winnerId||"",winnerVoteCount:s.winnerVoteCount||0,drawerScore:s.drawerScore||0,screenwriterScore:s.screenwriterScore||0}:void 0}),{success:!0}}async function Gr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:s}=await _.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);s&&console.error("[useGame] 更新數據庫失敗:",s),le("ending");const{broadcastGameState:S}=ue();return await S(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function Le(){const s=a.submissions,S=a.votes;if(s.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const I=new Map;for(const V of s)I.set(V.id,0);for(const V of S){const J=I.get(V.submissionId)||0;I.set(V.submissionId,J+1)}let N=-1,M=[];for(const V of s){const J=I.get(V.id)||0;J>N?(N=J,M=[V]):J===N&&M.push(V)}const B=M.length>1;if(M.length===1)return console.log("[useGame] 唯一最高票勝出:",M[0]?.sentence),{submission:M[0]||null,voteCount:N,hasTie:!1};const Q=Math.floor(Math.random()*M.length),ne=M[Q]||null;return console.log("[useGame] 平票隨機選擇勝出:",ne?.sentence,"(共",M.length,"個平票)"),{submission:ne,voteCount:N,hasTie:B}}async function Tr(s){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!g.currentRound)return{success:!1,error:"沒有當前輪次"};const S=g.currentRound.round_number,I=g.currentRound.drawer_id,M=e.participants.find(B=>B.user_id===I)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",S);try{const{submission:B,voteCount:Q,hasTie:ne}=Le();let V,J,ve;B?(V=B.sentence,J=B.userId,ve=e.participants.find(we=>we.user_id===J)?.nickname||"編劇",await a.markWinningSubmission(B.id),console.log("[useGame] 勝出句子:",V,"作者:",ve,"票數:",Q,"平票:",ne)):(V="故事繼續發展中...",J=I,ve=M,console.log("[useGame] 沒有提交，使用默認句子"));let Ae="/placeholder-image.png";if(s)try{const Ee=await new Promise(we=>{s.toBlob(we,"image/png",.9)});if(Ee){const{supabase:we}=await Ue(async()=>{const{supabase:De}=await import("./index-BhuEJWht.js").then(xr=>xr.O);return{supabase:De}},__vite__mapDeps([0,1])),Pr=Date.now(),Ke=`storyboard/${e.currentRoom.id}/round_${S}_${Pr}.png`,{error:Fe}=await we.storage.from("canvas-snapshots").upload(Ke,Ee,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(Fe)console.error("[useGame] 截圖上傳失敗:",Fe);else{const{data:De}=we.storage.from("canvas-snapshots").getPublicUrl(Ke);Ae=De.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Ae)}}}catch(Ee){console.error("[useGame] 截圖上傳錯誤:",Ee)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:S,itemType:"image",content:Ae,authorId:I,authorName:M}),await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:S,itemType:"text",content:V,authorId:J,authorName:ve}),console.log("[useGame] Story_Chain 已更新");const ze=a.votes.length;let Ce=0;B&&(Ce=Oe,await ge(J,Ce),console.log("[useGame] 編劇勝出得分:",Ce,"分給",ve));const Ne=He+ze*Be;await ge(I,Ne),console.log("[useGame] 畫家得分:",Ne,"分給",M,"(投票人數:",ze,")");const Ye={success:!0,winningSentence:V,winnerName:ve,winnerId:J,winnerVoteCount:Q,drawerScore:Ne,screenwriterScore:Ce,imageUrl:Ae};return console.log("[useGame] 輪次結算完成:",Ye),Ye}catch(B){return console.error("[useGame] 輪次結算錯誤:",B),{success:!1,error:B instanceof Error?B.message:"輪次結算失敗"}}}function Ar(){const s=document.querySelector("canvas.drawing-canvas");return s||document.querySelector("canvas")||null}function Cr(s){switch(s){case"drawing":return ir;case"writing":return lr;case"voting":return dr;default:return 0}}function Ze(){return Oe}function Ve(s){return He+s*Be}function je(s){return Math.round(s*mr)}async function Mr(s,S,I,N=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const M=Ze();console.log("[useGame] 編劇勝出得分:",M,"分給",s),await ge(s,M);const B=Ve(I);if(console.log("[useGame] 畫家得分:",B,"分給",S,"(投票人數:",I,")"),await ge(S,B),N>0){const Q=je(N);console.log("[useGame] 評星加分:",Q,"分給",S,"(平均評星:",N,")"),await ge(S,Q)}return{success:!0}}catch(M){return console.error("[useGame] 計算分鏡模式得分錯誤:",M),{success:!1,error:M instanceof Error?M.message:"計算得分失敗"}}}async function ge(s,S){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:I}=await Ue(async()=>{const{supabase:V}=await import("./index-BhuEJWht.js").then(J=>J.O);return{supabase:V}},__vite__mapDeps([0,1])),{data:N,error:M}=await I.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",s).single();if(M)throw M;const B=(N?.score||0)+S,{error:Q}=await I.from("room_participants").update({score:B}).eq("room_id",e.currentRoom.id).eq("user_id",s);if(Q)throw Q;const ne=e.participants.findIndex(V=>V.user_id===s);return ne!==-1&&e.participants[ne]&&(e.participants[ne].score=B),console.log("[useGame] 玩家",s,"得分更新為",B),!0}catch(I){return console.error("[useGame] 更新玩家分數錯誤:",I),!1}}return kr(()=>{n(),l(),Te()}),{gameStatus:w,isPlaying:Z,isWaiting:k,isFinished:b,currentRound:E,currentRoundNumber:D,totalRounds:c,drawTime:h,isCurrentDrawer:W,timeRemaining:d,isCountingDown:A,formattedTime:yr,roundStatus:y,isDrawing:T,isSummary:q,summaryTimeRemaining:P,isStoryboardMode:H,storyboardPhase:U,storyboardTimeRemaining:F,isStoryboardDrawing:o,isStoryboardWriting:f,isStoryboardVoting:r,isStoryboardSummary:t,isStoryboardSetup:i,isStoryboardEnding:p,startGame:C,newGame:_r,startNextRound:O,startDrawingPhase:x,endRound:te,continueToNextRound:oe,endGame:hr,startCountdown:L,stopCountdown:n,startSummaryCountdown:v,stopSummaryCountdown:l,resetCountdown:m,setStoryboardPhase:le,startStoryboardCountdown:pr,stopStoryboardCountdown:Te,resetStoryboardCountdown:Sr,enterStoryboardDrawingPhase:Rr,enterStoryboardWritingPhase:br,enterStoryboardVotingPhase:Er,enterStoryboardSummaryPhase:Ir,enterStoryboardEndingPhase:Gr,getStoryboardPhaseDuration:Cr,calculateWinningSentence:Le,finalizeStoryboardRound:Tr,getCanvasElement:Ar,calculateScreenwriterWinScore:Ze,calculateDirectorScore:Ve,calculateRatingBonus:je,calculateStoryboardRoundScores:Mr,updateStoryboardPlayerScore:ge,STORYBOARD_DRAWING_TIME:ir,STORYBOARD_WRITING_TIME:lr,STORYBOARD_VOTING_TIME:dr,STORYBOARD_SUMMARY_TIME:lt,SCREENWRITER_WIN_SCORE:Oe,DIRECTOR_BASE_SCORE:He,DIRECTOR_VOTE_BONUS:Be,RATING_BONUS_MULTIPLIER:mr}}const dt=Object.freeze(Object.defineProperty({__proto__:null,useGame:wr},Symbol.toStringTag,{value:"Module"})),mt={class:"waiting-lobby"},ft={class:"card"},gt={class:"card-body"},vt={class:"room-info text-center margin-bottom-medium"},wt={class:"card-title text-hand-title"},ht={class:"room-details"},_t={class:"detail-item margin-bottom-small"},yt={class:"badge badge-secondary room-code-badge"},pt={class:"detail-item margin-bottom-small"},St={class:"badge"},Rt={class:"detail-item"},bt={class:"players-section margin-bottom-medium"},Et={class:"text-hand-title margin-bottom-small"},It={class:"players-list"},Gt={class:"player-avatar"},Tt={class:"player-info"},At={class:"player-name"},Ct={key:0,class:"badge badge-warning"},Mt={class:"room-settings margin-bottom-medium"},Pt={class:"setting-item"},xt={class:"setting-value"},Nt={class:"setting-item"},Dt={class:"setting-label"},kt={class:"setting-value"},qt={key:0,class:"setting-item"},Ot={class:"setting-value"},Ht={class:"lobby-actions"},Bt=["disabled"],$t={key:1,class:"alert alert-warning text-center"},Ut=["disabled"],Wt={key:0,class:"alert alert-danger margin-top-small"},Lt=gr({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:g}){const a=e,d=g,{isHost:A,canStartGame:P,minPlayersRequired:w,leaveRoom:Z,loading:k,error:b}=st(),{startGame:y}=wr(),T=R(()=>{const f=a.room?.settings.rounds||0,r=a.participants.length,t=f>0?f:r;return t>0?t:1});function q(f){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[f||""]||f||"未知"}function H(f){return{classic:"傳統模式",storyboard:"分鏡接龍"}[f||""]||"傳統模式"}function U(f){return a.room?.host_id===f}async function F(){(await y()).success&&d("startGame")}async function o(){(await Z()).success&&d("leaveRoom")}return(f,r)=>(K(),Y("div",mt,[G("div",ft,[G("div",gt,[G("div",vt,[G("h2",wt,j(e.room?.name),1),G("div",ht,[G("div",_t,[r[0]||(r[0]=ce(" 房間碼：",-1)),G("span",yt,j(e.room?.code),1)]),G("div",pt,[r[1]||(r[1]=ce(" 狀態：",-1)),G("span",St,j(q(e.room?.status)),1)]),G("div",Rt,[r[2]||(r[2]=ce(" 模式：",-1)),G("span",{class:Xe(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},j(H(e.room?.game_mode)),3)])])]),G("div",bt,[G("h4",Et,"玩家列表 ("+j(e.participants.length)+")",1),G("div",It,[(K(!0),Y(Je,null,qr(e.participants,t=>(K(),Y("div",{key:t.id,class:Xe(["player-item",{"is-host":U(t.user_id)}])},[G("div",Gt,j(t.nickname.charAt(0).toUpperCase()),1),G("div",Tt,[G("div",At,[ce(j(t.nickname)+" ",1),U(t.user_id)?(K(),Y("span",Ct," 房主 ")):be("",!0)])])],2))),128))])]),G("div",Mt,[G("div",Pt,[r[4]||(r[4]=G("span",{class:"setting-label"},"繪畫時間：",-1)),G("span",xt,[G("strong",null,j(e.room?.settings.draw_time),1),r[3]||(r[3]=ce("秒",-1))])]),G("div",Nt,[G("span",Dt,j(e.room?.game_mode==="storyboard"?"每場鏡數":"每局輪數")+"：",1),G("span",kt,[G("strong",null,j(T.value),1),ce(j(e.room?.game_mode==="storyboard"?"鏡":"輪"),1)])]),e.room?.game_mode!=="storyboard"?(K(),Y("div",qt,[r[6]||(r[6]=G("span",{class:"setting-label"},"詞語總數：",-1)),G("span",Ot,[G("strong",null,j(e.room?.word_count),1),r[5]||(r[5]=ce("個",-1))])])):be("",!0)]),G("div",Ht,[se(A)&&se(P)?(K(),Y("button",{key:0,disabled:se(k),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:F},j(se(k)?"開始中":"開始遊戲"),9,Bt)):se(A)?(K(),Y("div",$t,[ce(" 至少需要 "+j(se(w))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(K(),Y(Je,{key:0},[ce(" （分鏡接龍模式） ")],64)):be("",!0)])):be("",!0),G("button",{disabled:se(k),class:"paper-btn btn-secondary btn-block",onClick:o},j(se(k)?"離開中":"離開房間"),9,Ut)]),se(b)?(K(),Y("div",Wt,j(se(b)),1)):be("",!0)])])]))}}),Yt=Or(Lt,[["__scopeId","data-v-208677e9"]]);export{Vt as I,Yt as W,ue as a,Ge as b,vr as c,ct as d,ut as e,jt as f,wr as g,zt as i,st as u};
