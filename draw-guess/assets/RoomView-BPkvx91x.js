import{l as Ge,r as D,u as J,d as H,i as K,m as Q,c as r,e,o,_ as A,f as M,n as L,a as T,F as B,p as P,q as ae,t as u,b as n,s as q,x as Le,h as ge,y as j,z as Ne,j as V,A as he,g as Be,v as Ee,B as Ve,C as Pe,k as Oe,D as He}from"./index-xE11Gejf.js";import{c as Z,b as ie,d as le,e as we,a as Ae,u as ze,W as Ue}from"./useRealtime-zGkUMmJd.js";const pe=Ge("drawing",()=>{const s=D("pen"),l=D("#000000"),c=D(3),h=D(!1),t=D([]);function a(g){s.value=g}function v(g){l.value=g}function _(g){c.value=Math.max(1,Math.min(20,g))}function R(g){t.value.push(g)}function S(){t.value=[]}function F(g){h.value=g}return{tool:s,color:l,lineWidth:c,isDrawing:h,strokes:t,setTool:a,setColor:v,setLineWidth:_,addStroke:R,clearStrokes:S,setDrawing:F}});function _e(s,l){const c=s.getBoundingClientRect();let h,t;if(l instanceof MouseEvent)h=l.clientX,t=l.clientY;else if(l instanceof TouchEvent&&l.touches.length>0&&l.touches[0])h=l.touches[0].clientX,t=l.touches[0].clientY;else return null;return{x:h-c.left,y:t-c.top}}function be(s,l){if(!(l.points.length<2)){s.save(),l.tool==="pen"?(s.strokeStyle=l.color,s.lineWidth=l.lineWidth,s.lineCap="round",s.lineJoin="round"):l.tool==="eraser"&&(s.globalCompositeOperation="destination-out",s.lineWidth=l.lineWidth,s.lineCap="round",s.lineJoin="round"),s.beginPath(),l.points[0]&&s.moveTo(l.points[0].x,l.points[0].y);for(let c=1;c<l.points.length;c++){const h=l.points[c];h&&s.lineTo(h.x,h.y)}s.stroke(),s.restore()}}function oe(s,l){const c=s.getContext("2d");if(!c)return;const h=s.getBoundingClientRect();c.clearRect(0,0,s.width,s.height),c.fillStyle="#FFFFFF",c.fillRect(0,0,h.width,h.height),l.forEach(t=>{be(c,t)})}function qe(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ye(){const s=pe(),l=Z(),c=J(),{sendDrawing:h}=ie(),t=D(null),a=D(null),v=D(null),_=D(null);let R=null;const S=50;function F(i){t.value=i;const y=i.getContext("2d",{willReadFrequently:!0});if(!y){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}a.value=y;const x=window.devicePixelRatio||1,O=i.getBoundingClientRect();i.width=O.width*x,i.height=O.height*x,y.scale(x,x),y.fillStyle="#FFFFFF",y.fillRect(0,0,O.width,O.height),t.value&&oe(t.value,s.strokes),new ResizeObserver(()=>{if(!t.value||!a.value)return;const z=t.value.getBoundingClientRect(),E=window.devicePixelRatio||1;t.value.width=z.width*E,t.value.height=z.height*E,a.value.scale(E,E),a.value.fillStyle="#FFFFFF",a.value.fillRect(0,0,z.width,z.height),oe(t.value,s.strokes)}).observe(i)}function g(i){if(!t.value)return;i.preventDefault(),s.setDrawing(!0);const y=_e(t.value,i);y&&(v.value={id:qe(),tool:s.tool,color:s.color,lineWidth:s.lineWidth,points:[y],timestamp:Date.now()},_.value=y)}function $(i){if(!t.value||!a.value||!s.isDrawing||!v.value)return;i.preventDefault();const y=_e(t.value,i);if(!y||!_.value)return;const x=a.value;x.save(),v.value.tool==="pen"?(x.strokeStyle=v.value.color,x.lineWidth=v.value.lineWidth,x.lineCap="round",x.lineJoin="round"):v.value.tool==="eraser"&&(x.globalCompositeOperation="destination-out",x.lineWidth=v.value.lineWidth,x.lineCap="round",x.lineJoin="round"),x.beginPath(),x.moveTo(_.value.x,_.value.y),x.lineTo(y.x,y.y),x.stroke(),x.restore(),v.value.points.push(y),_.value=y,R===null&&(R=window.setTimeout(()=>{p(),R=null},S))}function m(){!s.isDrawing||!v.value||(s.setDrawing(!1),R&&(clearTimeout(R),R=null),p(),v.value=null,_.value=null)}async function p(){if(!(!v.value||!l.currentRoom||!c.user))try{const i={...v.value,userId:c.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",i.id),await h(l.currentRoom.code,i)}catch(i){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",i)}}function k(i){if(!(!t.value||!a.value)){if(i.userId&&c.user&&i.userId===c.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",i.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",i.id),s.addStroke(i),be(a.value,i)}}function b(){if(!t.value||!a.value)return;const i=a.value,y=t.value;i.clearRect(0,0,y.width,y.height),i.fillStyle="#FFFFFF",i.fillRect(0,0,y.width,y.height),s.clearStrokes()}function I(i){s.setTool(i)}function N(i){s.setColor(i)}function C(i){s.setLineWidth(i)}function f(){t.value&&oe(t.value,s.strokes)}return{canvasRef:t,initCanvas:F,startDrawing:g,draw:$,stopDrawing:m,clearCanvas:b,setTool:I,setColor:N,setLineWidth:C,handleDrawingData:k,redrawStrokes:f}}const Je={class:"drawing-canvas-container"},Ye=H({__name:"DrawingCanvas",setup(s){const{initCanvas:l,startDrawing:c,draw:h,stopDrawing:t,handleDrawingData:a}=ye(),v=Z(),_=J(),{subscribeDrawing:R}=ie(),S=D(null);function F(C){c(C)}function g(C){h(C)}function $(){t()}function m(){t()}function p(C){c(C)}function k(C){h(C)}function b(){t()}let I=null;function N(){!v.currentRoom||!_.user||(I=R(v.currentRoom.code,C=>{a(C)}))}return K(()=>{S.value&&l(S.value),N()}),Q(()=>{I&&(I(),I=null)}),(C,f)=>(o(),r("div",Je,[e("canvas",{ref_key:"canvasElement",ref:S,class:"drawing-canvas",onMousedown:F,onMousemove:g,onMouseup:$,onMouseleave:m,onTouchstart:p,onTouchmove:k,onTouchend:b},null,544)]))}}),Xe=A(Ye,[["__scopeId","data-v-e71ea6a0"]]),je={class:"toolbar-section"},Ke={key:0,class:"tool-label"},Qe={key:0,class:"tool-label"},Ze={key:0,class:"toolbar-section colors-section"},es=["onClick","title"],ss={class:"toolbar-section size-section"},ts={class:"size-dots"},ns=["onClick","title"],os={class:"toolbar-section"},rs={key:0,class:"tool-label"},as=H({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(s){const l=pe(),{setTool:c,setColor:h,setLineWidth:t,clearCanvas:a}=ye(),v=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],_=M(()=>l.tool),R=M(()=>l.color),S=M(()=>l.lineWidth);function F(p){c(p)}function g(p){h(p)}function $(p){l.setLineWidth(p),t(p)}function m(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&a()}return(p,k)=>(o(),r("div",{class:L(["drawing-toolbar",{"toolbar-compact":s.compact}])},[e("div",je,[e("button",{onClick:k[0]||(k[0]=b=>F("pen")),class:L(["tool-btn",{active:_.value==="pen"}]),title:"ç•«ç­†"},[k[2]||(k[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),s.compact?T("",!0):(o(),r("span",Ke,"ç•«ç­†"))],2),e("button",{onClick:k[1]||(k[1]=b=>F("eraser")),class:L(["tool-btn",{active:_.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[k[3]||(k[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),s.compact?T("",!0):(o(),r("span",Qe,"æ©¡çš®æ“¦"))],2)]),_.value==="pen"?(o(),r("div",Ze,[e("div",{class:L(["color-grid",{"color-grid-compact":s.compact}])},[(o(),r(B,null,P(v,b=>e("div",{key:b,onClick:I=>g(b),class:L(["color-cell",{selected:R.value===b}]),style:ae({backgroundColor:b}),title:b},null,14,es)),64))],2)])):T("",!0),e("div",ss,[e("div",ts,[(o(),r(B,null,P([2,5,10,15],b=>e("div",{key:b,onClick:I=>$(b),class:L(["size-dot",{active:S.value===b}]),style:ae({width:`${b+8}px`,height:`${b+8}px`}),title:`${b}px`},null,14,ns)),64))])]),e("div",os,[e("button",{onClick:m,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[k[4]||(k[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),s.compact?T("",!0):(o(),r("span",rs,"æ¸…ç©º"))])])],2))}}),re=A(as,[["__scopeId","data-v-7e7250c3"]]),is={class:"player-list"},ls={class:"player-list-header"},cs={class:"player-count"},us={class:"player-rank"},ds={class:"player-info"},vs={class:"player-name"},ms={key:0,class:"drawer-badge"},hs={key:1,class:"host-badge"},_s={class:"player-score"},fs={key:0,class:"winner-banner"},gs={class:"winner-text"},ws={class:"winner-name"},ps={class:"winner-score"},bs=H({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(s){const l=Z(),c=le(),h=J(),{playerRankings:t,winner:a}=we(),v=M(()=>t.value);function _(g){return l.participants.find(m=>m.user_id===g)?.nickname||"æœªçŸ¥ç©å®¶"}function R(g){return h.user?.id===g}function S(g){return l.currentRoom?.host_id===g}function F(g){return c.currentRound?.drawer_id===g}return(g,$)=>(o(),r("div",is,[e("div",ls,[e("span",cs,"ç©å®¶ ("+u(v.value.length)+")",1)]),(o(!0),r(B,null,P(v.value,(m,p)=>(o(),r("div",{key:m.id,class:L(["player-item",{"is-current":R(m.user_id)},{"is-drawer":F(m.user_id)}])},[e("div",us,u(p+1),1),e("div",{class:L(["player-avatar",{drawing:F(m.user_id)}])},u(_(m.user_id).charAt(0)),3),e("div",ds,[e("div",vs,[q(u(_(m.user_id))+" ",1),F(m.user_id)?(o(),r("span",ms,"âœï¸")):T("",!0),S(m.user_id)?(o(),r("span",hs,"ğŸ‘‘")):T("",!0)]),e("div",_s,u(m.score)+" åˆ†",1)])],2))),128)),s.showWinner&&n(a)?(o(),r("div",fs,[$[1]||($[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",gs,[$[0]||($[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",ws,u(_(n(a).user_id)),1),e("div",ps,u(n(a).score)+" åˆ†",1)])])):T("",!0)]))}}),fe=A(bs,[["__scopeId","data-v-4094673d"]]),ys={class:"word-selection"},$s={class:"selection-card"},Rs={class:"selection-header"},ks={class:"round-info"},Cs={class:"countdown-section"},Ss={class:"countdown-number"},Fs={class:"countdown-text"},Ws={class:"word-options"},Ds=["onClick","disabled"],xs={class:"word-text"},Ts={key:0,class:"word-source"},Is={class:"selection-footer"},Ms=["disabled"],Gs=H({__name:"WordSelection",props:{wordOptions:{},roundNumber:{},totalRounds:{},selectionTime:{}},emits:["word-selected"],setup(s,{emit:l}){const c=s,h=l,t=D(null),a=D(!1),v=D(c.selectionTime);let _=null;function R($){a.value||(t.value=$)}function S(){!t.value||a.value||(a.value=!0,h("word-selected",t.value),_&&clearInterval(_))}function F(){if(a.value)return;const $=Math.floor(Math.random()*c.wordOptions.length),m=c.wordOptions[$];m&&(t.value=m.text,a.value=!0,h("word-selected",m.text))}function g(){v.value=c.selectionTime,_=window.setInterval(()=>{v.value>0?v.value--:(_&&clearInterval(_),F())},1e3)}return K(()=>{g()}),Q(()=>{_&&clearInterval(_)}),($,m)=>(o(),r("div",ys,[e("div",$s,[e("div",Rs,[m[0]||(m[0]=e("h2",{class:"selection-title"},"ğŸ¨ è¼ªåˆ°ä½ ç•«ç•«äº†ï¼",-1)),e("div",ks,"ç¬¬ "+u(s.roundNumber)+" / "+u(s.totalRounds)+" è¼ª",1)]),e("div",Cs,[e("div",{class:L(["countdown-ring",{warning:v.value<=5}])},[e("span",Ss,u(v.value),1)],2),e("div",Fs,u(v.value<=5?"å³å°‡è‡ªå‹•é¸æ“‡ï¼":"è«‹é¸æ“‡ä¸€å€‹è©èª"),1)]),e("div",Ws,[(o(!0),r(B,null,P(s.wordOptions,(p,k)=>(o(),r("button",{key:k,class:L(["word-option",{selected:t.value===p.text}]),onClick:b=>R(p.text),disabled:a.value},[e("span",xs,u(p.text),1),p.source==="custom"?(o(),r("span",Ts,"è‡ªè¨‚")):T("",!0)],10,Ds))),128))]),e("div",Is,[e("button",{class:"confirm-btn",disabled:!t.value||a.value,onClick:S},u(a.value?"å·²é¸æ“‡":"ç¢ºèªé¸æ“‡"),9,Ms)])])]))}}),Ls=A(Gs,[["__scopeId","data-v-00208fc2"]]),Ns={class:"waiting-selection"},Bs={class:"waiting-card"},Es={class:"waiting-info"},Vs={class:"waiting-title"},Ps={class:"round-info"},Os={key:0,class:"last-round-review"},Hs={class:"review-word"},As=H({__name:"WaitingSelection",props:{drawerName:{},roundNumber:{},totalRounds:{},showLastRound:{type:Boolean},lastRoundWord:{}},setup(s){return(l,c)=>(o(),r("div",Ns,[e("div",Bs,[c[1]||(c[1]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil"},"âœï¸")],-1)),e("div",Es,[e("h2",Vs,u(s.drawerName)+" æ­£åœ¨é¸æ“‡è©èª...",1),e("div",Ps,"ç¬¬ "+u(s.roundNumber)+" / "+u(s.totalRounds)+" è¼ª",1)]),c[2]||(c[2]=Le('<div class="waiting-hint" data-v-3f01f28b><p data-v-3f01f28b>è«‹ç¨å€™ï¼Œç•«å®¶æ­£åœ¨å¾ 3 å€‹è©èªä¸­é¸æ“‡ä¸€å€‹</p><div class="dots" data-v-3f01f28b><span class="dot" data-v-3f01f28b></span><span class="dot" data-v-3f01f28b></span><span class="dot" data-v-3f01f28b></span></div></div>',1)),s.showLastRound&&s.lastRoundWord?(o(),r("div",Os,[c[0]||(c[0]=e("div",{class:"review-title"},"ä¸Šä¸€è¼ªç­”æ¡ˆ",-1)),e("div",Hs,u(s.lastRoundWord),1)])):T("",!0)])]))}}),zs=A(As,[["__scopeId","data-v-3f01f28b"]]),Us={class:"round-summary"},qs={class:"summary-card"},Js={class:"summary-header"},Ys={class:"round-info"},Xs={class:"answer-reveal"},js={class:"answer-text"},Ks={class:"drawer-section"},Qs={class:"drawer-info"},Zs={class:"drawer-name"},et={key:0,class:"drawer-score"},st={class:"guessers-section"},tt={key:0,class:"no-guessers"},nt={key:1,class:"guessers-list"},ot={class:"guesser-rank"},rt={class:"guesser-name"},at={class:"guesser-score"},it={key:0,class:"rating-section"},lt={class:"star-rating"},ct=["onMouseenter","onClick","disabled"],ut={class:"rating-info"},dt={key:0,class:"rated-text"},vt={key:1,class:"rate-hint"},mt={key:1,class:"average-rating"},ht={class:"avg-score"},_t={class:"avg-stars"},ft={class:"avg-count"},gt={class:"summary-footer"},wt={key:0,class:"countdown"},pt=H({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean}},emits:["next-round","rating-submitted"],setup(s,{emit:l}){const c=s,h=l,t=J(),a=D(0),v=D(0),_=D(!1),R=D([]),S=D(8);let F=null;const g=M(()=>t.user?.id===c.drawerId),$=M(()=>R.value.length===0?0:R.value.reduce((f,i)=>f+i.rating,0)/R.value.length),m=M(()=>R.value.length);async function p(C){if(!(_.value||g.value||!t.user))try{const{error:f}=await j.from("drawing_ratings").upsert({round_id:c.roundId,user_id:t.user.id,rating:C});if(f)throw f;a.value=C,_.value=!0,h("rating-submitted",C)}catch(f){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",f)}}async function k(){try{const{data:C,error:f}=await j.from("drawing_ratings").select("user_id, rating").eq("round_id",c.roundId);if(f)throw f;if(R.value=C||[],t.user){const i=R.value.find(y=>y.user_id===t.user.id);i&&(a.value=i.rating,_.value=!0)}}catch(C){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",C)}}function b(){const C=j.channel(`ratings:${c.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${c.roundId}`},()=>{k()}).subscribe();return()=>{j.removeChannel(C)}}function I(){F=window.setInterval(()=>{S.value>0?S.value--:(F&&clearInterval(F),c.isHost&&h("next-round"))},1e3)}let N=null;return K(()=>{k(),N=b(),I()}),Q(()=>{F&&clearInterval(F),N&&N()}),ge(()=>c.roundId,()=>{k(),S.value=8}),(C,f)=>(o(),r("div",Us,[e("div",qs,[e("div",Js,[f[2]||(f[2]=e("h2",{class:"summary-title"},"ğŸ¨ è¼ªæ¬¡çµæŸ",-1)),e("div",Ys,"ç¬¬ "+u(s.roundNumber)+" / "+u(s.totalRounds)+" è¼ª",1)]),e("div",Xs,[f[3]||(f[3]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",js,u(s.correctAnswer),1)]),e("div",Ks,[e("div",Qs,[f[4]||(f[4]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Zs,u(s.drawerName),1),s.drawerScore>0?(o(),r("span",et,"+"+u(s.drawerScore)+" åˆ†",1)):T("",!0)])]),e("div",st,[f[5]||(f[5]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),s.correctGuessers.length===0?(o(),r("div",tt," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(o(),r("div",nt,[(o(!0),r(B,null,P(s.correctGuessers,(i,y)=>(o(),r("div",{key:i.userId,class:"guesser-item"},[e("span",ot,u(y+1),1),e("span",rt,u(i.name),1),e("span",at,"+"+u(i.score),1)]))),128))]))]),g.value?T("",!0):(o(),r("div",it,[f[6]||(f[6]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",lt,[(o(),r(B,null,P(5,i=>e("button",{key:i,class:L(["star-btn",{active:i<=(v.value||a.value),selected:i<=a.value}]),onMouseenter:y=>v.value=i,onMouseleave:f[0]||(f[0]=y=>v.value=0),onClick:y=>p(i),disabled:_.value}," â­ ",42,ct)),64))]),e("div",ut,[_.value?(o(),r("span",dt,"ä½ çš„è©•åˆ†ï¼š"+u(a.value)+" æ˜Ÿ",1)):(o(),r("span",vt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),m.value>0?(o(),r("div",mt,[f[7]||(f[7]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",ht,u($.value.toFixed(1)),1),e("span",_t,u("â­".repeat(Math.round($.value))),1),e("span",ft,"("+u(m.value)+" äººå·²è©•)",1)])):T("",!0),e("div",gt,[S.value>0?(o(),r("div",wt,u(S.value)+" ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€è¼ª ",1)):T("",!0),s.isHost?(o(),r("button",{key:1,class:"next-btn",onClick:f[1]||(f[1]=i=>C.$emit("next-round"))},u(s.isLastRound?"æŸ¥çœ‹çµæœ":"ä¸‹ä¸€è¼ª"),1)):T("",!0)])])]))}}),bt=A(pt,[["__scopeId","data-v-0f83f4da"]]);function yt(){const s=le(),l=J(),{calculateGuessScore:c,updatePlayerScore:h}=we(),t=D(""),a=D(null),v=D(!1),_=M(()=>s.isCurrentDrawer?s.currentWord:null),R=M(()=>s.correctGuesses),S=M(()=>l.user?s.hasGuessed(l.user.id):!1);async function F(){if(!s.currentRound||!l.user)return a.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!t.value.trim())return a.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(t.value.length>32)return a.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(S.value)return a.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(s.isCurrentDrawer)return a.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{v.value=!0,a.value=null;const m=t.value.trim(),p=s.currentWord||"",k=g(m,p),b=k?c(R.value.length):0,{data:I,error:N}=await j.from("guesses").insert({round_id:s.currentRound.id,user_id:l.user.id,guess_text:m,is_correct:k,score_earned:b}).select().single();if(N)throw N;return s.guesses.push(I),k&&l.user&&await h(l.user.id,b),t.value="",{success:!0,isCorrect:k,guess:I}}catch(m){return a.value=m instanceof Error?m.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",m),{success:!1,error:a.value}}finally{v.value=!1}}function g(m,p){const k=m.trim(),b=p.trim();return k===b}function $(){a.value=null}return{guessInput:t,error:a,loading:v,currentWord:_,correctGuesses:R,hasGuessed:S,submitGuess:F,clearError:$}}const $t={class:"game-container"},Rt={key:0,class:"container margin-top-large"},kt={class:"row flex-center"},Ct={class:"col-12 col-md-8"},St={key:1,class:"game-layout"},Ft={class:"game-sidebar game-players"},Wt={class:"player-list-container"},Dt={class:"game-main"},xt={key:0,class:"time-display"},Tt={key:1,class:"time-display selecting"},It={class:"time-number time-warning"},Mt={key:2,class:"time-display summary"},Gt={class:"time-number"},Lt={class:"round-info"},Nt={class:"round-label"},Bt={key:0,class:"phase-label"},Et={key:1,class:"phase-label"},Vt={key:3,class:"word-display"},Pt={class:"word-text"},Ot={key:4,class:"word-display"},Ht={class:"word-slots"},At={key:5,class:"word-display"},zt={class:"word-slots"},Ut={key:6,class:"word-display summary-word"},qt={class:"word-text revealed"},Jt={class:"game-content-area"},Yt={class:"game-toolbar disabled"},Xt={class:"game-canvas selection-phase"},jt={class:"game-chat-panel"},Kt={class:"game-toolbar disabled"},Qt={class:"game-canvas summary-phase"},Zt={class:"game-chat-panel"},en={class:"chat-msg system-msg answer-revealed"},sn={class:"msg-player"},tn={class:"msg-correct"},nn={class:"game-toolbar"},on={class:"game-canvas"},rn={key:0,class:"time-progress"},an={class:"game-chat-panel"},ln={key:0,class:"chat-msg word-hint-msg"},cn={class:"msg-player"},un={key:0,class:"msg-correct"},dn={key:1,class:"msg-text"},vn={key:1,class:"chat-msg correct-self"},mn={class:"chat-input-area"},hn=["placeholder","disabled"],_n=["disabled"],fn={key:2,class:"container margin-top-large"},gn={class:"row flex-center"},wn={class:"col-12 col-md-8"},pn={class:"card"},bn={class:"card-body text-center"},yn=H({__name:"RoomView",setup(s){const l=Ne(),c=Oe(),h=Z(),t=le(),a=J(),{subscribeRoom:v,subscribeGuesses:_,unsubscribeRoom:R}=ie(),{isPlaying:S,isWaiting:F,isFinished:g,timeRemaining:$,isCountingDown:m,isCurrentDrawer:p,drawTime:k,currentRoundNumber:b,totalRounds:I,startGame:N,skipWord:C,isSelecting:f,isDrawing:i,isSummary:y,wordOptions:x,selectionTimeRemaining:O,summaryTimeRemaining:ee,selectWord:z}=Ae(),{hasGuessed:E,guessInput:Y,submitGuess:$e,loading:Re}=yt(),{leaveRoom:ke}=ze(),G=M(()=>h.currentRoom),ce=M(()=>Re.value),ue=D(null),U=D(null),se=M(()=>{const w=G.value?.current_drawer_id;return w&&h.participants.find(W=>W.user_id===w)?.nickname||"ç•«å®¶"}),de=M(()=>!G.value||!a.user?!1:G.value.current_drawer_id===a.user.id),ve=M(()=>[...t.guesses].sort((w,d)=>new Date(w.guessed_at).getTime()-new Date(d.guessed_at).getTime()));function Ce(){U.value&&(U.value.scrollTop=U.value.scrollHeight)}ge(ve,()=>{He(Ce)},{deep:!0});function te(w){return h.participants.find(W=>W.user_id===w)?.nickname||"æœªçŸ¥ç©å®¶"}const Se=M(()=>p.value?"ä½ æ˜¯ç•«å®¶ï¼Œè«‹ç•«ç•«...":E.value?"ä½ å·²çŒœä¸­ï¼":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Fe=M(()=>t.currentWord?t.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),We=M(()=>t.correctGuesses.length*5),De=M(()=>t.correctGuesses.map(w=>({userId:w.user_id,name:te(w.user_id),score:w.score_earned})));function X(w){ue.value=w,setTimeout(()=>{ue.value=null},3e3)}async function me(){!p.value&&Y.value.trim()&&await $e()}async function xe(){const w=await N();!w.success&&w.error&&X(w.error)}async function ne(){const w=await ke();G.value&&R(G.value.code),await c.push("/"),!w.success&&w.error&&X(w.error)}async function Te(){const w=await C();!w.success&&w.error&&X(w.error)}async function Ie(w){const d=x.value.find(W=>W.text===w);if(d){const W=await z(d);!W.success&&W.error&&X(W.error)}}async function Me(w){if(!t.currentRound)return;const d=await t.submitRating(t.currentRound.id,t.currentRound.drawer_id,w);!d.success&&d.error&&X(d.error)}return K(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",l.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",G.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",a.user?.id);const w=l.params.code;w&&!G.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",w),G.value&&a.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",G.value.status),await t.loadCurrentRound(G.value.id),v(G.value.code,G.value.id,a.user.id,{nickname:a.profile?.display_name||"ç©å®¶"}),t.currentRound&&_(G.value.code,t.currentRound.id))}),Q(()=>{G.value&&R(G.value.code)}),(w,d)=>(o(),r("div",$t,[n(F)?(o(),r("div",Rt,[e("div",kt,[e("div",Ct,[V(Ue,{room:G.value,participants:n(h).participants,onStartGame:xe,onLeaveRoom:ne},null,8,["room","participants"])])])])):n(S)?(o(),r("div",St,[e("div",Ft,[e("div",Wt,[V(fe,{"show-winner":!1})])]),e("div",Dt,[e("div",{class:L(["game-header",{"time-critical":n($)!==null&&n($)<=10}])},[n(i)&&n(m)&&n($)!==null?(o(),r("div",xt,[e("span",{class:L(["time-number",{"time-warning":n($)<=10,"time-critical-pulse":n($)<=5}])},u(n($)),3),d[1]||(d[1]=e("span",{class:"time-label"},"ç§’",-1))])):n(f)&&n(O)!==null?(o(),r("div",Tt,[e("span",It,u(n(O)),1),d[2]||(d[2]=e("span",{class:"time-label"},"ç§’é¸è©",-1))])):n(y)&&n(ee)!==null?(o(),r("div",Mt,[e("span",Gt,u(n(ee)),1),d[3]||(d[3]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):T("",!0),e("div",Lt,[e("span",Nt,"ç¬¬ "+u(n(b)+(n(f)?1:0))+" / "+u(n(I))+" è¼ª",1),n(f)?(o(),r("span",Bt,"é¸è©ä¸­")):n(y)?(o(),r("span",Et,"è¼ªæ¬¡çµç®—")):T("",!0)]),n(i)&&n(p)&&n(t).currentWord?(o(),r("div",Vt,[d[4]||(d[4]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",Pt,u(n(t).currentWord),1),e("button",{class:"skip-btn",onClick:Te,title:"è·³éæ­¤è©"},"è·³é")])):n(i)?(o(),r("div",Ot,[e("span",Ht,u(Fe.value),1)])):n(f)?(o(),r("div",At,[e("span",zt,u(de.value?"è«‹é¸æ“‡è¦ç•«çš„è©èª":`${se.value} æ­£åœ¨é¸è©...`),1)])):n(y)&&n(t).currentWord?(o(),r("div",Ut,[d[5]||(d[5]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",qt,u(n(t).currentWord),1)])):T("",!0),e("button",{class:"leave-btn",onClick:ne,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Jt,[n(f)?(o(),r(B,{key:0},[e("div",Yt,[V(re,{compact:!0})]),e("div",Xt,[de.value?(o(),he(Ls,{key:0,"word-options":n(x),"round-number":n(b)+1,"total-rounds":n(I),"selection-time":15,onWordSelected:Ie},null,8,["word-options","round-number","total-rounds"])):(o(),he(zs,{key:1,"drawer-name":se.value,"round-number":n(b)+1,"total-rounds":n(I)},null,8,["drawer-name","round-number","total-rounds"]))]),e("div",jt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[...d[6]||(d[6]=[e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"â³"),q(" ç­‰å¾…ç•«å®¶é¸è©... ")],-1)])],512),d[7]||(d[7]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ç­‰å¾…é¸è©...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):n(y)?(o(),r(B,{key:1},[e("div",Kt,[V(re,{compact:!0})]),e("div",Qt,[V(bt,{"round-number":n(b),"total-rounds":n(I),"correct-answer":n(t).currentWord||"","drawer-name":se.value,"drawer-id":n(t).currentRound?.drawer_id||"","drawer-score":We.value,"correct-guessers":De.value,"round-id":n(t).currentRound?.id||"","is-host":n(h).isHost,"is-last-round":n(b)>=n(I),onRatingSubmitted:Me},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",Zt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[e("div",en,[d[8]||(d[8]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),d[9]||(d[9]=q(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,u(n(t).currentWord),1)]),(o(!0),r(B,null,P(n(t).correctGuesses,W=>(o(),r("div",{key:W.id,class:"chat-msg correct-guess"},[e("span",sn,u(te(W.user_id)),1),e("span",tn,"çŒœä¸­äº†ï¼ +"+u(W.score_earned),1)]))),128))],512),d[10]||(d[10]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(o(),r(B,{key:2},[e("div",nn,[V(re,{compact:!0})]),e("div",on,[V(Xe),n(m)&&n($)!==null?(o(),r("div",rn,[e("div",{class:L(["time-bar",{"time-warning":n($)<=10}]),style:ae({width:`${n($)/n(k)*100}%`})},null,6)])):T("",!0)]),e("div",an,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[d[14]||(d[14]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),q(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),n(p)&&n(t).currentWord?(o(),r("div",ln,[d[11]||(d[11]=e("span",{class:"msg-icon"},"ğŸ¨",-1)),d[12]||(d[12]=q(" ä½ è¦ç•«ï¼š",-1)),e("strong",null,u(n(t).currentWord),1)])):T("",!0),(o(!0),r(B,null,P(ve.value,W=>(o(),r("div",{key:W.id,class:L(["chat-msg",{"correct-guess":W.is_correct,"wrong-guess":!W.is_correct}])},[e("span",cn,u(te(W.user_id)),1),W.is_correct?(o(),r("span",un,"çŒœä¸­äº†ï¼ +"+u(W.score_earned),1)):(o(),r("span",dn,u(W.guess_text),1))],2))),128)),n(E)?(o(),r("div",vn,[...d[13]||(d[13]=[e("span",{class:"msg-icon"},"âœ…",-1),q(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):T("",!0)],512),e("div",mn,[Be(e("input",{"onUpdate:modelValue":d[0]||(d[0]=W=>Pe(Y)?Y.value=W:null),type:"text",placeholder:Se.value,maxlength:"32",disabled:ce.value||n(E)||n(p),onKeyup:Ve(me,["enter"]),class:"chat-input-field"},null,40,hn),[[Ee,n(Y)]]),e("button",{onClick:me,disabled:ce.value||n(E)||n(p)||!n(Y).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,_n)])])],64))])])])):n(g)?(o(),r("div",fn,[e("div",gn,[e("div",wn,[e("div",pn,[e("div",bn,[d[15]||(d[15]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),V(fe,{"show-winner":!0}),e("button",{onClick:ne,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):T("",!0)]))}}),kn=A(yn,[["__scopeId","data-v-0810fd30"]]);export{kn as default};
