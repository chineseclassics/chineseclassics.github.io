import{u as G,f as x,r as v,E as f}from"./index-Cm5t9MsT.js";const l=v([]),u=v({}),S=v(!1),M=v({}),T=v(null),c=v(!1);function F(){const a=G(),n=x(()=>c.value);async function o(e=!1){if(!a.profile?.email)return c.value=!1,!1;if(c.value&&!e)return!0;const{data:t,error:r}=await f.from("word_library_admins").select("email").eq("email",a.profile.email).maybeSingle();return r?(console.warn("[WordLibrary] 檢查管理員權限失敗:",r),c.value=!1,!1):(c.value=!!t,c.value)}async function y(e={}){try{S.value=!0,T.value=null;let t=f.from("word_collections").select("id, slug, title, description, entry_count, is_active").order("title",{ascending:!0});e.includeInactive||(t=t.eq("is_active",!0));const{data:r,error:s}=await t;if(s)throw s;return l.value=r||[],l.value}catch(t){return T.value=t instanceof Error?t.message:"載入詞句庫失敗",[]}finally{S.value=!1}}async function C(e,t=!1){if(!t&&u.value[e])return u.value[e];M.value[e]=!0;try{const{data:r,error:s}=await f.from("word_entries").select("id, collection_id, text, category").eq("collection_id",e).order("text",{ascending:!0});if(s)throw s;return u.value[e]=r||[],u.value[e]}catch(r){return T.value=r instanceof Error?r.message:"載入詞句條目失敗",u.value[e]=[],[]}finally{M.value[e]=!1}}async function _(e){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const t=e.slug||e.title.trim().toLowerCase().replace(/\s+/g,"-"),r={title:e.title.trim(),slug:t,description:e.description?.trim()||null},{data:s,error:i}=await f.from("word_collections").insert(r).select("id, slug, title, description, entry_count, is_active").single();return i?{success:!1,error:i.message||"新增主題失敗"}:(l.value=[...l.value,s],{success:!0,collection:s})}async function E(e,t,r){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const s=t.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{data:i,error:g}=await f.from("word_entries").insert({collection_id:e,text:s,category:r?.trim()||null}).select("id, collection_id, text, category").single();if(g)return{success:!1,error:g.message||"新增條目失敗"};const w=i,j=u.value[e]||[];return u.value[e]=[...j,w],l.value=l.value.map(A=>A.id===e?{...A,entry_count:(A.entry_count||0)+1}:A),{success:!0,entry:w}}async function h(e,t,r){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const s=r.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{error:i}=await f.from("word_entries").update({text:s}).eq("id",e);if(i)return{success:!1,error:i.message||"更新失敗"};const g=u.value[t]||[];return u.value[t]=g.map(w=>w.id===e?{...w,text:s}:w),{success:!0}}async function p(e,t){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:r}=await f.from("word_entries").delete().eq("id",e);if(r)return{success:!1,error:r.message||"刪除失敗"};const s=u.value[t]||[];return u.value[t]=s.filter(i=>i.id!==e),l.value=l.value.map(i=>i.id===t?{...i,entry_count:Math.max(0,(i.entry_count||1)-1)}:i),{success:!0}}async function L(e,t){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:r}=await f.from("word_collections").update({is_active:t}).eq("id",e);return r?{success:!1,error:r.message||"更新狀態失敗"}:(l.value=l.value.map(s=>s.id===e?{...s,is_active:t}:s),{success:!0})}async function m(e){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await f.from("word_entries").delete().eq("collection_id",e);if(t)return{success:!1,error:t.message||"刪除詞條失敗"};const{error:r}=await f.from("word_collections").delete().eq("id",e);return r?{success:!1,error:r.message||"刪除主題失敗"}:(l.value=l.value.filter(s=>s.id!==e),delete u.value[e],{success:!0})}return{collections:l,entriesMap:u,loadingCollections:S,loadingEntries:M,error:T,isAdmin:n,refreshAdminStatus:o,loadCollections:y,loadEntries:C,addCollection:_,addEntry:E,updateEntry:h,deleteEntry:p,toggleCollectionActive:L,deleteCollection:m}}const R="ai-word-generator-rate-limit",W=10,N=300*1e3,k=3e4,q=v(!1),d=v(null);function b(){try{const a=localStorage.getItem(R);if(a)return JSON.parse(a)}catch{}return{calls:[]}}function D(a){try{localStorage.setItem(R,JSON.stringify(a))}catch{}}function P(a){const o=Date.now()-N;return a.filter(y=>y>o)}function O(){const a=b(),n=P(a.calls);n.length!==a.calls.length&&D({calls:n});const o=Math.max(0,W-n.length);return{isLimited:n.length>=W,remainingCalls:o}}function U(){const a=b(),n=P(a.calls);n.push(Date.now()),D({calls:n})}function J(a){return a.map(n=>n.trim()).filter(n=>n.length>0).join("，")}function K(){const a=x(()=>O()),n=x(()=>a.value.isLimited),o=x(()=>a.value.remainingCalls);async function y(_,E){const h=E?.mode||"classic",p=E?.storyGenre?.trim()||void 0;if(!_||_.trim().length===0)return d.value=h==="storyboard"?"請先輸入故事標題":"請先輸入房間主題",null;const{isLimited:L}=O();if(L)return d.value="請求次數已達上限，請 5 分鐘後再試",null;q.value=!0,d.value=null;try{U();const m=new Promise((i,g)=>{setTimeout(()=>g(new Error("TIMEOUT")),k)}),e={theme:_.trim(),mode:h};p&&(e.storyGenre=p);const t=f.functions.invoke("generate-words",{body:e}),{data:r,error:s}=await Promise.race([t,m]);if(s)throw s;return!r||!r.success?(d.value=r?.error||"AI 服務暫時不可用，請稍後再試或手動輸入詞語",null):{words:r.words||[],isThemeAdjusted:r.isThemeAdjusted||!1,adjustedTheme:r.adjustedTheme}}catch(m){return m instanceof Error?m.message==="TIMEOUT"?d.value="AI 服務響應超時，請稍後再試":m.message.includes("network")||m.message.includes("fetch")?d.value="網絡連接失敗，請檢查網絡後重試":d.value="AI 服務暫時不可用，請稍後再試或手動輸入詞語":d.value="AI 服務暫時不可用，請稍後再試或手動輸入詞語",null}finally{q.value=!1}}function C(){localStorage.removeItem(R)}return{isGenerating:q,isRateLimited:n,remainingCalls:o,error:d,generateWords:y,formatWordsForInput:J,resetRateLimit:C}}export{K as a,J as f,F as u};
