import{l as Ne,r as I,u as z,f as T,d as X,h as K,i as ie,m as le,c,e,o as u,_ as j,n as L,a as M,F as B,p as A,q as ae,t as w,b as l,s as Y,x as J,y as Ee,j as P,g as Be,v as Pe,z as Ae,A as He,k as Oe,B as ze}from"./index-DTsQU2hd.js";import{b as Q,a as ce,c as Z,d as Re,e as _e,u as Ue,W as qe}from"./WaitingLobby-DiyLfkcC.js";const ke=Ne("drawing",()=>{const t=I("pen"),a=I("#000000"),v=I(3),d=I(!1),s=I([]);function i(b){t.value=b}function p(b){a.value=b}function h(b){v.value=Math.max(1,Math.min(20,b))}function y(b){s.value.push(b)}function C(){s.value=[]}function G(b){d.value=b}return{tool:t,color:a,lineWidth:v,isDrawing:d,strokes:s,setTool:i,setColor:p,setLineWidth:h,addStroke:y,clearStrokes:C,setDrawing:G}});function pe(t,a){const v=t.getBoundingClientRect();let d,s;if(a instanceof MouseEvent)d=a.clientX,s=a.clientY;else if(a instanceof TouchEvent&&a.touches.length>0&&a.touches[0])d=a.touches[0].clientX,s=a.touches[0].clientY;else return null;return{x:d-v.left,y:s-v.top}}function Ce(t,a){if(!(a.points.length<2)){t.save(),a.tool==="pen"?(t.strokeStyle=a.color,t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"):a.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),a.points[0]&&t.moveTo(a.points[0].x,a.points[0].y);for(let v=1;v<a.points.length;v++){const d=a.points[v];d&&t.lineTo(d.x,d.y)}t.stroke(),t.restore()}}function re(t,a){const v=t.getContext("2d");if(!v)return;const d=t.getBoundingClientRect();v.clearRect(0,0,t.width,t.height),v.fillStyle="#FFFFFF",v.fillRect(0,0,d.width,d.height),a.forEach(s=>{Ce(v,s)})}function Je(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function $e(){const t=ke(),a=Q(),v=z(),{sendDrawing:d}=ce(),s=T(()=>!v.user||!a.currentRoom?!1:a.currentRoom.current_drawer_id===v.user.id),i=I(null),p=I(null),h=I(null),y=I(null);let C=null;const G=50;function b(m){i.value=m;const x=m.getContext("2d",{willReadFrequently:!0});if(!x){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}p.value=x;const D=window.devicePixelRatio||1,H=m.getBoundingClientRect();m.width=H.width*D,m.height=H.height*D,x.scale(D,D),x.fillStyle="#FFFFFF",x.fillRect(0,0,H.width,H.height),i.value&&re(i.value,t.strokes),new ResizeObserver(()=>{if(!i.value||!p.value)return;const E=i.value.getBoundingClientRect(),O=window.devicePixelRatio||1;i.value.width=E.width*O,i.value.height=E.height*O,p.value.scale(O,O),p.value.fillStyle="#FFFFFF",p.value.fillRect(0,0,E.width,E.height),re(i.value,t.strokes)}).observe(m)}function W(m){if(!i.value)return;if(!s.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}m.preventDefault(),t.setDrawing(!0);const x=pe(i.value,m);x&&(h.value={id:Je(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[x],timestamp:Date.now()},y.value=x)}function R(m){if(!i.value||!p.value||!t.isDrawing||!h.value)return;m.preventDefault();const x=pe(i.value,m);if(!x||!y.value)return;const D=p.value;D.save(),h.value.tool==="pen"?(D.strokeStyle=h.value.color,D.lineWidth=h.value.lineWidth,D.lineCap="round",D.lineJoin="round"):h.value.tool==="eraser"&&(D.globalCompositeOperation="destination-out",D.lineWidth=h.value.lineWidth,D.lineCap="round",D.lineJoin="round"),D.beginPath(),D.moveTo(y.value.x,y.value.y),D.lineTo(x.x,x.y),D.stroke(),D.restore(),h.value.points.push(x),y.value=x,C===null&&(C=window.setTimeout(()=>{f(),C=null},G))}function k(){!t.isDrawing||!h.value||(t.setDrawing(!1),C&&(clearTimeout(C),C=null),f(),h.value=null,y.value=null)}async function f(){if(!(!h.value||!a.currentRoom||!v.user))try{const m={...h.value,userId:v.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",m.id),await d(a.currentRoom.code,m)}catch(m){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",m)}}function o(m){if(!(!i.value||!p.value)){if(m.userId&&v.user&&m.userId===v.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",m.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",m.id),t.addStroke(m),Ce(p.value,m)}}function r(){if(!i.value||!p.value)return;const m=p.value,x=i.value;m.clearRect(0,0,x.width,x.height),m.fillStyle="#FFFFFF",m.fillRect(0,0,x.width,x.height),t.clearStrokes()}function g(m){t.setTool(m)}function $(m){t.setColor(m)}function N(m){t.setLineWidth(m)}function V(){i.value&&re(i.value,t.strokes)}return{canvasRef:i,initCanvas:b,startDrawing:W,draw:R,stopDrawing:k,clearCanvas:r,setTool:g,setColor:$,setLineWidth:N,handleDrawingData:o,redrawStrokes:V}}const Ke={class:"drawing-canvas-container"},Ye=X({__name:"DrawingCanvas",setup(t){const{initCanvas:a,startDrawing:v,draw:d,stopDrawing:s,handleDrawingData:i,clearCanvas:p}=$e(),h=Q(),y=z(),C=Z(),{subscribeDrawing:G}=ce(),b=I(null);K(()=>C.currentRound?.id,(V,m)=>{V&&V!==m&&(console.log("[DrawingCanvas] è¼ªæ¬¡è®ŠåŒ–ï¼Œæ¸…ç©ºç•«å¸ƒ:",{oldRoundId:m,newRoundId:V}),p())});function W(V){v(V)}function R(V){d(V)}function k(){s()}function f(){s()}function o(V){v(V)}function r(V){d(V)}function g(){s()}let $=null;function N(){!h.currentRoom||!y.user||($=G(h.currentRoom.code,V=>{i(V)}))}return ie(()=>{b.value&&a(b.value),N()}),le(()=>{$&&($(),$=null)}),(V,m)=>(u(),c("div",Ke,[e("canvas",{ref_key:"canvasElement",ref:b,class:"drawing-canvas",onMousedown:W,onMousemove:R,onMouseup:k,onMouseleave:f,onTouchstart:o,onTouchmove:r,onTouchend:g},null,544)]))}}),Xe=j(Ye,[["__scopeId","data-v-4736f3e5"]]),je={class:"toolbar-section"},Qe={key:0,class:"tool-label"},Ze={key:0,class:"tool-label"},et={key:0,class:"toolbar-section colors-section"},tt=["onClick","title"],st={class:"toolbar-section size-section"},nt={class:"size-dots"},ot=["onClick","title"],rt={class:"toolbar-section"},at={key:0,class:"tool-label"},it=X({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const a=ke(),{setTool:v,setColor:d,setLineWidth:s,clearCanvas:i}=$e(),p=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],h=T(()=>a.tool),y=T(()=>a.color),C=T(()=>a.lineWidth);function G(k){v(k)}function b(k){d(k)}function W(k){a.setLineWidth(k),s(k)}function R(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&i()}return(k,f)=>(u(),c("div",{class:L(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",je,[e("button",{onClick:f[0]||(f[0]=o=>G("pen")),class:L(["tool-btn",{active:h.value==="pen"}]),title:"ç•«ç­†"},[f[2]||(f[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?M("",!0):(u(),c("span",Qe,"ç•«ç­†"))],2),e("button",{onClick:f[1]||(f[1]=o=>G("eraser")),class:L(["tool-btn",{active:h.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[f[3]||(f[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?M("",!0):(u(),c("span",Ze,"æ©¡çš®æ“¦"))],2)]),h.value==="pen"?(u(),c("div",et,[e("div",{class:L(["color-grid",{"color-grid-compact":t.compact}])},[(u(),c(B,null,A(p,o=>e("div",{key:o,onClick:r=>b(o),class:L(["color-cell",{selected:y.value===o}]),style:ae({backgroundColor:o}),title:o},null,14,tt)),64))],2)])):M("",!0),e("div",st,[e("div",nt,[(u(),c(B,null,A([2,5,10,15],o=>e("div",{key:o,onClick:r=>W(o),class:L(["size-dot",{active:C.value===o}]),style:ae({width:`${o+8}px`,height:`${o+8}px`}),title:`${o}px`},null,14,ot)),64))])]),e("div",rt,[e("button",{onClick:R,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[f[4]||(f[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?M("",!0):(u(),c("span",at,"æ¸…ç©º"))])])],2))}}),ye=j(it,[["__scopeId","data-v-7e7250c3"]]),lt={class:"player-list"},ct={class:"player-list-header"},ut={class:"player-count"},dt={class:"player-rank"},vt={class:"player-info"},mt={class:"player-name"},gt={key:0,class:"drawer-badge"},ht={key:1,class:"host-badge"},wt={class:"player-score"},ft=["onClick"],_t={key:0,class:"winner-banner"},pt={class:"winner-text"},yt={class:"winner-name"},bt={class:"winner-score"},Rt=X({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:a}){const v=a,d=Q(),s=Z(),i=z(),{playerRankings:p,winner:h}=Re(),y=T(()=>p.value),C=I(!1);function G(o){return d.participants.find(g=>g.user_id===o)?.nickname||"æœªçŸ¥ç©å®¶"}function b(o){return i.user?.id===o}function W(o){return d.currentRoom?.host_id===o}function R(o){return s.currentRound?.drawer_id===o||d.currentRoom?.current_drawer_id===o}function k(o){return d.isHost&&!b(o)}async function f(o,r){if(!(C.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${r} å—ï¼Ÿ`))){C.value=!0;try{const $=await d.kickPlayer(o);$.success?v("player-kicked",o):alert($.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch($){console.error("è¸¢äººå¤±æ•—:",$),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{C.value=!1}}}return(o,r)=>(u(),c("div",lt,[e("div",ct,[e("span",ut,"ç©å®¶ ("+w(y.value.length)+")",1)]),(u(!0),c(B,null,A(y.value,(g,$)=>(u(),c("div",{key:g.id,class:L(["player-item",{"is-current":b(g.user_id)},{"is-drawer":R(g.user_id)}])},[e("div",dt,w($+1),1),e("div",{class:L(["player-avatar",{drawing:R(g.user_id)}])},w(G(g.user_id).charAt(0)),3),e("div",vt,[e("div",mt,[Y(w(G(g.user_id))+" ",1),R(g.user_id)?(u(),c("span",gt,"âœï¸")):M("",!0),W(g.user_id)?(u(),c("span",ht,"ğŸ‘‘")):M("",!0)]),e("div",wt,w(g.score)+" åˆ†",1)]),k(g.user_id)?(u(),c("button",{key:0,class:"kick-btn",onClick:N=>f(g.user_id,G(g.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,ft)):M("",!0)],2))),128)),t.showWinner&&l(h)?(u(),c("div",_t,[r[1]||(r[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",pt,[r[0]||(r[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",yt,w(G(l(h).user_id)),1),e("div",bt,w(l(h).score)+" åˆ†",1)])])):M("",!0)]))}}),be=j(Rt,[["__scopeId","data-v-984c1c4a"]]),kt={class:"round-summary"},Ct={class:"summary-card"},$t={key:0,class:"selection-waiting-banner"},St={class:"waiting-text"},Ft={class:"next-drawer-name"},Dt={class:"summary-header"},xt={class:"summary-title"},Wt={class:"round-info"},Tt={class:"answer-reveal"},It={class:"answer-text"},Gt={class:"drawer-section"},Mt={class:"drawer-info"},Vt={class:"drawer-name"},Lt={key:0,class:"drawer-score"},Nt={class:"guessers-section"},Et={key:0,class:"no-guessers"},Bt={key:1,class:"guessers-list"},Pt={class:"guesser-rank"},At={class:"guesser-name"},Ht={class:"guesser-score"},Ot={key:1,class:"rating-section"},zt={class:"star-rating"},Ut=["onMouseenter","onClick","disabled"],qt={class:"rating-info"},Jt={key:0,class:"rated-text"},Kt={key:1,class:"rate-hint"},Yt={key:2,class:"average-rating"},Xt={class:"avg-score"},jt={class:"avg-stars"},Qt={class:"avg-count"},Zt={key:3,class:"next-drawer-info"},es={class:"next-drawer-name-display"},ts={key:4,class:"game-ending-info"},ss=X({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:a}){const v=t,d=a,s=z(),i=I(0),p=I(0),h=I(!1),y=I([]),C=T(()=>s.user?.id===v.drawerId),G=T(()=>y.value.length===0?0:y.value.reduce((r,g)=>r+g.rating,0)/y.value.length),b=T(()=>y.value.length);async function W(o){if(!(h.value||C.value||!s.user))try{const{error:r}=await J.from("drawing_ratings").upsert({round_id:v.roundId,rater_id:s.user.id,drawer_id:v.drawerId,rating:o},{onConflict:"round_id,rater_id"});if(r)throw r;i.value=o,h.value=!0,d("rating-submitted",o)}catch(r){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",r)}}async function R(){try{const{data:o,error:r}=await J.from("drawing_ratings").select("rater_id, rating").eq("round_id",v.roundId);if(r)throw r;if(y.value=o||[],s.user){const g=y.value.find($=>$.rater_id===s.user.id);g&&(i.value=g.rating,h.value=!0)}}catch(o){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",o)}}function k(){const o=J.channel(`ratings:${v.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${v.roundId}`},()=>{R()}).subscribe();return()=>{J.removeChannel(o)}}let f=null;return ie(()=>{R(),f=k()}),le(()=>{f&&f()}),K(()=>v.roundId,()=>{R()}),(o,r)=>(u(),c("div",kt,[e("div",Ct,[t.isWaitingForSelection?(u(),c("div",$t,[r[2]||(r[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",St,[e("span",Ft,w(t.nextDrawerName),1),r[1]||(r[1]=Y(" æ­£åœ¨é¸è©... ",-1))]),r[3]||(r[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",Dt,[e("h2",xt,w(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Wt,"ç¬¬ "+w(t.roundNumber)+" / "+w(t.totalRounds)+" è¼ª",1)]),e("div",Tt,[r[4]||(r[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",It,w(t.correctAnswer),1)]),e("div",Gt,[e("div",Mt,[r[5]||(r[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Vt,w(t.drawerName),1),t.drawerScore>0?(u(),c("span",Lt,"+"+w(t.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",Nt,[r[6]||(r[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(u(),c("div",Et," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(u(),c("div",Bt,[(u(!0),c(B,null,A(t.correctGuessers,(g,$)=>(u(),c("div",{key:g.userId,class:"guesser-item"},[e("span",Pt,w($+1),1),e("span",At,w(g.name),1),e("span",Ht,"+"+w(g.score),1)]))),128))]))]),C.value?M("",!0):(u(),c("div",Ot,[r[7]||(r[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",zt,[(u(),c(B,null,A(5,g=>e("button",{key:g,class:L(["star-btn",{active:g<=(p.value||i.value),selected:g<=i.value}]),onMouseenter:$=>p.value=g,onMouseleave:r[0]||(r[0]=$=>p.value=0),onClick:$=>W(g),disabled:h.value}," â­ ",42,Ut)),64))]),e("div",qt,[h.value?(u(),c("span",Jt,"ä½ çš„è©•åˆ†ï¼š"+w(i.value)+" æ˜Ÿ",1)):(u(),c("span",Kt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),b.value>0?(u(),c("div",Yt,[r[8]||(r[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",Xt,w(G.value.toFixed(1)),1),e("span",jt,w("â­".repeat(Math.round(G.value))),1),e("span",Qt,"("+w(b.value)+" äººå·²è©•)",1)])):M("",!0),t.nextDrawerName&&!t.isLastRound?(u(),c("div",Zt,[r[9]||(r[9]=e("div",{class:"next-drawer-label"},"ä¸‹ä¸€è¼ªç•«æ‰‹",-1)),e("div",es,"âœï¸ "+w(t.nextDrawerName),1)])):M("",!0),t.isLastRound?(u(),c("div",ts,[...r[10]||(r[10]=[e("div",{class:"ending-label"},"ğŸ‰ é€™æ˜¯æœ€å¾Œä¸€è¼ªï¼",-1)])])):M("",!0)])]))}}),ns=j(ss,[["__scopeId","data-v-2a39ef4b"]]);function os(){const t=Z(),a=z(),{calculateGuessScore:v,updatePlayerScore:d}=Re(),s=I(""),i=I(null),p=I(!1),h=T(()=>t.isCurrentDrawer?t.currentWord:null),y=T(()=>t.correctGuesses),C=T(()=>a.user?t.hasGuessed(a.user.id):!1);async function G(){if(!t.currentRound||!a.user)return i.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return i.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return i.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(C.value)return i.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return i.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{p.value=!0,i.value=null;const R=s.value.trim(),k=t.currentWord||"",f=b(R,k),o=f?v(y.value.length):0,{data:r,error:g}=await J.from("guesses").insert({round_id:t.currentRound.id,user_id:a.user.id,guess_text:R,is_correct:f,score_earned:o}).select().single();if(g)throw g;return t.guesses.push(r),f&&a.user&&await d(a.user.id,o),s.value="",{success:!0,isCorrect:f,guess:r}}catch(R){return i.value=R instanceof Error?R.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",R),{success:!1,error:i.value}}finally{p.value=!1}}function b(R,k){const f=R.trim(),o=k.trim();return f===o}function W(){i.value=null}return{guessInput:s,error:i,loading:p,currentWord:h,correctGuesses:y,hasGuessed:C,submitGuess:G,clearError:W}}const rs={class:"game-container"},as={key:0,class:"container margin-top-large"},is={class:"row flex-center"},ls={class:"col-12 col-md-8"},cs={key:1,class:"game-layout"},us={class:"game-sidebar game-players"},ds={class:"player-list-container"},vs={class:"game-main"},ms={key:0,class:"time-display"},gs={key:1,class:"time-display summary"},hs={class:"time-number"},ws={class:"round-info"},fs={class:"round-label"},_s={key:0,class:"phase-label"},ps={key:2,class:"word-display"},ys={class:"word-text"},bs={key:3,class:"word-display"},Rs={class:"drawer-hint"},ks={class:"word-slots"},Cs={key:4,class:"word-display summary-word"},$s={class:"word-text revealed"},Ss={class:"game-content-area"},Fs={class:"game-toolbar disabled"},Ds={class:"game-canvas summary-phase"},xs={class:"game-chat-panel"},Ws={class:"chat-msg system-msg answer-revealed"},Ts={class:"msg-player"},Is={class:"msg-correct"},Gs={class:"game-toolbar"},Ms={class:"game-canvas"},Vs={key:0,class:"time-progress"},Ls={class:"game-chat-panel"},Ns={class:"msg-player"},Es={key:0,class:"msg-correct"},Bs={key:1,class:"msg-text"},Ps={key:0,class:"chat-msg correct-self"},As={class:"chat-input-area"},Hs=["placeholder","disabled"],Os=["disabled"],zs={key:2,class:"container margin-top-large"},Us={class:"row flex-center"},qs={class:"col-12 col-md-8"},Js={class:"card"},Ks={class:"card-body text-center"},Ys=X({__name:"RoomView",setup(t){const a=Ee(),v=Oe(),d=Q(),s=Z(),i=z(),{subscribeRoom:p,unsubscribeRoom:h,subscribeGameState:y}=ce(),{isPlaying:C,isWaiting:G,isFinished:b,timeRemaining:W,isCountingDown:R,isCurrentDrawer:k,drawTime:f,currentRoundNumber:o,totalRounds:r,startGame:g,isDrawing:$,isSummary:N,summaryTimeRemaining:V,startSummaryCountdown:m,stopSummaryCountdown:x,startCountdown:D,stopCountdown:H}=_e(),{hasGuessed:U,guessInput:E,submitGuess:O,loading:Se}=os(),{leaveRoom:Fe}=Ue(),S=T(()=>d.currentRoom),ue=T(()=>Se.value),de=I(null),q=I(null),ee=T(()=>{const _=S.value?.current_drawer_id;return _&&d.participants.find(F=>F.user_id===_)?.nickname||"ç•«å®¶"}),De=T(()=>{if(!S.value||d.participants.length===0)return"";const n=(S.value.current_round||0)%d.participants.length;return d.participants[n]?.nickname||"ä¸‹ä¸€ä½ç•«å®¶"}),ve=T(()=>o.value>=r.value),me=T(()=>[...s.guesses].sort((_,n)=>new Date(_.guessed_at).getTime()-new Date(n.guessed_at).getTime()));function xe(){q.value&&(q.value.scrollTop=q.value.scrollHeight)}K(me,()=>{ze(xe)},{deep:!0}),K(()=>d.participants,_=>{if(!i.user||!S.value)return;!_.some(F=>F.user_id===i.user.id)&&S.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),d.clearRoom(),v.push("/"))},{deep:!0});function te(_){return d.participants.find(F=>F.user_id===_)?.nickname||"æœªçŸ¥ç©å®¶"}const We=T(()=>k.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":U.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Te=T(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),ge=T(()=>s.currentRoundCorrectGuesses.length*5),he=T(()=>s.currentRoundCorrectGuesses.map(_=>({userId:_.user_id,name:te(_.user_id),score:_.score_earned}))),Ie=I(null);function Ge(){!s.currentRound||!s.currentWord||(Ie.value={roundNumber:o.value,answer:s.currentWord,drawerName:ee.value,drawerId:s.currentRound.drawer_id,drawerScore:ge.value,correctGuessers:he.value,roundId:s.currentRound.id})}K(N,(_,n)=>{_&&!n&&o.value>0&&Ge()});function se(_){de.value=_,setTimeout(()=>{de.value=null},3e3)}async function we(){!k.value&&E.value.trim()&&await O()}async function Me(){const _=await g();!_.success&&_.error&&se(_.error)}async function ne(){const _=await Fe();S.value&&h(S.value.code),await v.push("/"),!_.success&&_.error&&se(_.error)}async function Ve(_){if(!s.currentRound)return;const n=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,_);!n.success&&n.error&&se(n.error)}return ie(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",a.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",S.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",i.user?.id);const _=a.params.code;if(_&&!S.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",_),S.value&&i.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",S.value.status),await s.loadCurrentRound(S.value.id),S.value.status==="playing"&&s.currentRound){const n=s.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:n.round_number,startedAt:n.started_at,endedAt:n.ended_at,drawerId:n.drawer_id}),n.drawer_id&&d.setCurrentDrawer(n.drawer_id),n.started_at&&!n.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),s.setRoundStatus("drawing");const F=new Date(n.started_at).getTime(),Le=Date.now(),fe=Math.floor((Le-F)/1e3),oe=Math.max(0,f.value-fe);console.log("[RoomView] å€’è¨ˆæ™‚è¨ˆç®—:",{drawTime:f.value,elapsed:fe,remaining:oe}),oe>0?D(oe):D(0)}else n.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await p(S.value.code,S.value.id,i.user.id,{nickname:i.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(n){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",n)}y(S.value.code,async n=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",n),n.drawerId&&S.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",n.drawerId),d.setCurrentDrawer(n.drawerId)),n.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",n.roundStatus),s.setRoundStatus(n.roundStatus),n.roundStatus==="drawing"&&(x(),s.clearRatings(),D(f.value)),n.roundStatus==="summary"&&(H(),n.isLastRound?d.isHost&&setTimeout(async()=>{const{endGame:F}=_e();await F()},5e3):m())),S.value&&(await d.loadRoom(S.value.id),await s.loadCurrentRound(S.value.id))}),await s.loadAllGuesses(S.value.id)}}),le(()=>{S.value&&h(S.value.code)}),(_,n)=>(u(),c("div",rs,[l(G)?(u(),c("div",as,[e("div",is,[e("div",ls,[P(qe,{room:S.value,participants:l(d).participants,onStartGame:Me,onLeaveRoom:ne},null,8,["room","participants"])])])])):l(C)?(u(),c("div",cs,[e("div",us,[e("div",ds,[P(be,{"show-winner":!1})])]),e("div",vs,[e("div",{class:L(["game-header",{"time-critical":l(W)!==null&&l(W)<=10}])},[l($)&&l(R)&&l(W)!==null?(u(),c("div",ms,[e("span",{class:L(["time-number",{"time-warning":l(W)<=10,"time-critical-pulse":l(W)<=5}])},w(l(W)),3),n[1]||(n[1]=e("span",{class:"time-label"},"ç§’",-1))])):l(N)&&l(V)!==null?(u(),c("div",gs,[e("span",hs,w(l(V)),1),n[2]||(n[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",ws,[e("span",fs,"ç¬¬ "+w(l(o))+" / "+w(l(r))+" è¼ª",1),l(N)?(u(),c("span",_s,"è¼ªæ¬¡çµç®—")):M("",!0)]),l($)&&l(k)&&l(s).currentWord?(u(),c("div",ps,[n[3]||(n[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",ys,w(l(s).currentWord),1)])):l($)?(u(),c("div",bs,[e("span",Rs,"ğŸ¨ "+w(ee.value)+" æ­£åœ¨ç•«",1),e("span",ks,w(Te.value),1)])):l(N)&&l(s).currentWord?(u(),c("div",Cs,[n[4]||(n[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",$s,w(l(s).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:ne,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ss,[l(N)?(u(),c(B,{key:0},[e("div",Fs,[P(ye,{compact:!0})]),e("div",Ds,[P(ns,{"round-number":l(o),"total-rounds":l(r),"correct-answer":l(s).currentWord||"","drawer-name":ee.value,"drawer-id":l(s).currentRound?.drawer_id||"","drawer-score":ge.value,"correct-guessers":he.value,"round-id":l(s).currentRound?.id||"","is-host":l(d).isHost,"is-last-round":ve.value,"next-drawer-name":ve.value?"":De.value,onRatingSubmitted:Ve},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round","next-drawer-name"])]),e("div",xs,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:q},[e("div",Ws,[n[5]||(n[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),n[6]||(n[6]=Y(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,w(l(s).currentWord),1)]),(u(!0),c(B,null,A(l(s).currentRoundCorrectGuesses,F=>(u(),c("div",{key:F.id,class:"chat-msg correct-guess"},[e("span",Ts,w(te(F.user_id)),1),e("span",Is,"çŒœä¸­äº†ï¼ +"+w(F.score_earned),1)]))),128))],512),n[7]||(n[7]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(u(),c(B,{key:1},[e("div",Gs,[P(ye,{compact:!0})]),e("div",Ms,[P(Xe),l(R)&&l(W)!==null?(u(),c("div",Vs,[e("div",{class:L(["time-bar",{"time-warning":l(W)<=10}]),style:ae({width:`${l(W)/l(f)*100}%`})},null,6)])):M("",!0)]),e("div",Ls,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:q},[n[9]||(n[9]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),Y(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(u(!0),c(B,null,A(me.value,F=>(u(),c("div",{key:F.id,class:L(["chat-msg",{"correct-guess":F.is_correct,"wrong-guess":!F.is_correct}])},[e("span",Ns,w(te(F.user_id)),1),F.is_correct?(u(),c("span",Es,"çŒœä¸­äº†ï¼ +"+w(F.score_earned),1)):(u(),c("span",Bs,w(F.guess_text),1))],2))),128)),l(U)?(u(),c("div",Ps,[...n[8]||(n[8]=[e("span",{class:"msg-icon"},"âœ…",-1),Y(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",As,[Be(e("input",{"onUpdate:modelValue":n[0]||(n[0]=F=>He(E)?E.value=F:null),type:"text",placeholder:We.value,maxlength:"32",disabled:ue.value||l(U)||l(k),onKeyup:Ae(we,["enter"]),class:"chat-input-field"},null,40,Hs),[[Pe,l(E)]]),e("button",{onClick:we,disabled:ue.value||l(U)||l(k)||!l(E).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Os)])])],64))])])])):l(b)?(u(),c("div",zs,[e("div",Us,[e("div",qs,[e("div",Js,[e("div",Ks,[n[10]||(n[10]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),P(be,{"show-winner":!0}),e("button",{onClick:ne,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),Qs=j(Ys,[["__scopeId","data-v-7f3322bb"]]);export{Qs as default};
