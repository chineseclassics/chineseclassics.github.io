import{d as ye,u as _e,r as f,f as z,p as he,g as me,c as n,e as t,a as y,q as ge,M as be,H as ke,b as _,i as V,N as we,F as E,m as G,k as N,t as v,s as T,w as Ce,o,K as H,_ as xe}from"./index-C924DiRn.js";import{u as Ae,a as $e}from"./useAIWordGenerator-CnhinQza.js";const Ie={class:"container margin-top-large word-admin"},Ee={class:"row flex-center"},Te={class:"col-12 col-lg-10"},We={class:"card"},Se={class:"card-body"},Me={class:"header-row"},Ve={key:0,class:"alert alert-warning margin-top-small"},De={key:1,class:"alert alert-danger margin-top-small"},Ge={key:2,class:"admin-body"},Ne={class:"panel"},Be={key:0,class:"text-small text-secondary"},Ke={key:1,class:"collection-row"},Le=["value"],Ue={class:"toggle"},Fe=["checked"],je={class:"panel"},qe={class:"form-row"},ze={class:"panel"},He={class:"form-row"},Je=["disabled"],Oe={class:"ai-generate-section"},Pe={class:"ai-buttons-row"},Qe=["disabled"],Re={key:0},Xe={key:1},Ye=["disabled"],Ze={key:0,class:"ai-error-message"},et={key:1,class:"ai-preview"},tt={class:"ai-words-grid"},st=["onClick"],lt={key:0,class:"entry-list"},at={key:0,class:"text-small text-secondary margin-top-small"},nt={key:1,class:"text-small text-secondary margin-top-small"},ot={class:"entry-text-cell"},it=["onKeyup"],ut=["onClick"],rt={class:"entry-text"},dt=["onClick"],ct={class:"entry-source"},vt={key:0,class:"source-tag source-ai"},pt={key:1,class:"source-tag source-manual"},ft={class:"entry-actions"},yt=["onClick"],_t={key:0,class:"alert alert-success margin-top-small"},ht={key:1,class:"alert alert-danger margin-top-small"},mt={class:"modal-body"},gt={key:0},bt={key:1,class:"delete-info"},kt={key:2,class:"delete-info"},wt={class:"modal-footer"},Ct=["disabled"],xt=ye({__name:"WordLibraryAdmin",setup(At){const B=_e(),{collections:k,entriesMap:J,loadingCollections:O,loadingEntries:P,isAdmin:K,refreshAdminStatus:Q,loadCollections:C,loadEntries:g,addEntry:L,updateEntry:R,deleteEntry:X,toggleCollectionActive:Y,addCollection:Z,deleteCollection:ee}=Ae(),{isGenerating:U,error:F,generateWords:te}=$e(),a=f(""),W=f(""),x=f(""),d=f(null),u=f(null),h=f([]),b=f(!1),S=f(null),w=f(""),A=f(!1),M=f(!1),c=z(()=>k.value.find(l=>l.id===a.value)||null),$=z(()=>a.value?J.value[a.value]||[]:[]);he(a,async l=>{l&&await g(l,!0)});function p(){d.value=null,u.value=null}async function se(){p(),await Q(!0),await C({includeInactive:!0}),k.value.length>0&&k.value[0]&&(a.value=k.value[0].id,await g(a.value))}async function le(){p(),await C({includeInactive:!0})}async function ae(){p(),a.value&&await g(a.value,!0)}async function ne(){if(p(),!a.value){u.value="請先選擇主題";return}const l=W.value.trim();if(!l){u.value="請輸入詞條";return}const e=l.split(/[，,]/).map(m=>m.trim()).filter(m=>m.length>0);if(e.length===0){u.value="請輸入有效的詞條";return}b.value=!0;let r=0,s=0,i=0;const D=new Set($.value.map(m=>m.text));for(const m of e){if(D.has(m)){s++;continue}(await L(a.value,m,"manual")).success?(r++,D.add(m)):i++}b.value=!1,W.value="";const I=[];r>0&&I.push(`已添加 ${r} 個詞條`),s>0&&I.push(`跳過 ${s} 個重複詞條`),i>0&&I.push(`${i} 個詞條添加失敗`),I.length>0?d.value=I.join("，"):u.value="沒有成功添加任何詞條",await g(a.value,!0)}async function oe(){if(p(),!c.value){u.value="請先選擇主題";return}const l=await te(c.value.title);if(l){const e=new Set($.value.map(i=>i.text)),r=l.words.filter(i=>!e.has(i)),s=l.words.length-r.length;h.value=r,s>0?d.value=`AI 已生成 ${l.words.length} 個詞條，過濾掉 ${s} 個重複，剩餘 ${r.length} 個待添加`:d.value=`AI 已生成 ${r.length} 個詞條，請預覽後批量添加`}}function ie(l){h.value.splice(l,1)}function ue(){h.value=[]}async function re(){if(p(),!a.value){u.value="請先選擇主題";return}if(h.value.length===0){u.value="沒有可添加的詞條";return}b.value=!0;let l=0,e=0;const r=new Set($.value.map(s=>s.text));for(const s of h.value){if(r.has(s)){e++;continue}(await L(a.value,s,"ai")).success&&(l++,r.add(s))}b.value=!1,h.value=[],e>0?d.value=`已添加 ${l} 個詞條，跳過 ${e} 個重複詞條`:d.value=`已添加 ${l} 個詞條`,await g(a.value,!0)}function de(l){S.value=l.id,w.value=l.text}function j(){S.value=null,w.value=""}async function q(l){if(p(),!a.value)return;const e=await R(l,a.value,w.value);e.success?(d.value="已更新詞條",S.value=null,w.value=""):u.value=e.error||"更新失敗"}async function ce(l){if(p(),!a.value)return;const e=await X(l,a.value);e.success?(d.value="已刪除詞條",await g(a.value,!0)):u.value=e.error||"刪除失敗"}async function ve(){if(p(),!a.value||!c.value)return;const l=!c.value.is_active,e=await Y(a.value,l);e.success?(d.value=l?"主題已啟用":"主題已停用",await C({includeInactive:!0})):u.value=e.error||"更新狀態失敗"}async function pe(){if(p(),!x.value.trim()){u.value="請填寫主題名稱";return}const l=await Z({title:x.value,description:""});l.success&&l.collection?(d.value="已新增主題",x.value="",await C({includeInactive:!0}),a.value=l.collection.id,await g(a.value,!0)):u.value=l.error||"新增主題失敗"}async function fe(){if(p(),!a.value||!c.value)return;M.value=!0;const l=c.value,e=await ee(a.value);if(M.value=!1,A.value=!1,e.success){d.value=`已刪除主題「${l.title}」`,await C({includeInactive:!0});const r=k.value[0];r?(a.value=r.id,await g(a.value,!0)):a.value=""}else u.value=e.error||"刪除主題失敗"}return me(()=>{se()}),(l,e)=>{const r=ke("router-link");return o(),n("div",Ie,[t("div",Ee,[t("div",Te,[t("div",We,[t("div",Se,[t("div",Me,[e[9]||(e[9]=t("div",null,[t("h2",{class:"card-title text-hand-title"},"詞句庫管理"),t("p",{class:"text-secondary"}," 僅限指定管理員：gnoluy@gmail.com、ylzhang@isf.edu.hk ")],-1)),ge(r,{to:"/",class:"paper-btn btn-secondary"},{default:be(()=>[...e[8]||(e[8]=[T("返回首頁",-1)])]),_:1})]),_(B).user?_(K)?y("",!0):(o(),n("div",De," 您沒有詞句庫管理權限，請使用指定管理員郵箱登入。 ")):(o(),n("div",Ve," 請先登入 Google 帳號後再管理詞句庫。 ")),_(B).user&&_(K)?(o(),n("div",Ge,[t("div",Ne,[t("div",{class:"panel-header"},[e[10]||(e[10]=t("div",null,[t("h4",{class:"text-hand-title"},"主題列表"),t("p",{class:"text-small text-secondary"},"可切換主題、啟用 / 停用")],-1)),t("div",{class:"inline-actions"},[t("button",{class:"paper-btn btn-secondary",onClick:le}," 重新載入 ")])]),_(O)?(o(),n("div",Be,"載入主題中...")):(o(),n("div",Ke,[V(t("select",{"onUpdate:modelValue":e[0]||(e[0]=s=>a.value=s),onChange:ae},[(o(!0),n(E,null,G(_(k),s=>(o(),n("option",{key:s.id,value:s.id},v(s.title)+"（"+v(s.entry_count)+" 條） ",9,Le))),128))],544),[[we,a.value]]),t("label",Ue,[t("input",{type:"checkbox",checked:c.value?.is_active,onChange:ve},null,40,Fe),e[11]||(e[11]=t("span",null,"啟用主題",-1))]),a.value?(o(),n("button",{key:0,class:"paper-btn btn-danger btn-small",onClick:e[1]||(e[1]=s=>A.value=!0)}," 刪除主題 ")):y("",!0)]))]),t("div",je,[e[12]||(e[12]=t("div",{class:"panel-header"},[t("h4",{class:"text-hand-title"},"新增主題")],-1)),t("div",qe,[V(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>x.value=s),type:"text",placeholder:"主題名稱",class:"form-input"},null,512),[[N,x.value]]),t("button",{class:"paper-btn btn-primary",onClick:pe}," 新增主題 ")])]),t("div",ze,[e[15]||(e[15]=t("div",{class:"panel-header"},[t("div",null,[t("h4",{class:"text-hand-title"},"條目管理"),t("p",{class:"text-small text-secondary"},"新增詞條後可立即被房間使用")])],-1)),t("div",He,[V(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>W.value=s),type:"text",placeholder:"詞條（必填，可用逗號分隔批量添加）",class:"form-input"},null,512),[[N,W.value]]),t("button",{class:"paper-btn btn-primary",onClick:ne,disabled:b.value},v(b.value?"添加中...":"新增條目"),9,Je)]),t("div",Oe,[t("div",Pe,[t("button",{class:"paper-btn btn-ai",onClick:oe,disabled:_(U)||!c.value},[_(U)?(o(),n("span",Re,"⏳ 生成中...")):(o(),n("span",Xe,"✨ AI 生成詞條"))],8,Qe),h.value.length>0?(o(),n("button",{key:0,class:"paper-btn btn-success",onClick:re,disabled:b.value},v(b.value?"添加中...":`批量添加 ${h.value.length} 條`),9,Ye)):y("",!0)]),_(F)?(o(),n("div",Ze,v(_(F)),1)):y("",!0),h.value.length>0?(o(),n("div",et,[t("div",{class:"ai-preview-header"},[e[13]||(e[13]=t("span",null,"AI 生成預覽（可刪除不需要的詞條）",-1)),t("button",{class:"paper-btn btn-link btn-small",onClick:ue},"清空")]),t("div",tt,[(o(!0),n(E,null,G(h.value,(s,i)=>(o(),n("div",{key:i,class:"ai-word-tag"},[t("span",null,v(s),1),t("button",{class:"tag-remove",onClick:D=>ie(i)},"×",8,st)]))),128))])])):y("",!0)]),a.value?(o(),n("div",lt,[e[14]||(e[14]=t("div",{class:"entry-row entry-header"},[t("span",{class:"entry-text-header"},"詞條"),t("span",{class:"entry-source-header"},"來源"),t("span",{class:"entry-actions-header"},"操作")],-1)),_(P)[a.value]?(o(),n("div",at," 條目載入中... ")):$.value.length===0?(o(),n("div",nt," 尚無詞條，請新增。 ")):(o(!0),n(E,{key:2},G($.value,s=>(o(),n("div",{key:s.id,class:"entry-row"},[t("span",ot,[S.value===s.id?(o(),n(E,{key:0},[V(t("input",{"onUpdate:modelValue":e[4]||(e[4]=i=>w.value=i),type:"text",class:"edit-input",onKeyup:[H(i=>q(s.id),["enter"]),H(j,["escape"])]},null,40,it),[[N,w.value]]),t("button",{class:"icon-btn save-btn",onClick:i=>q(s.id),title:"保存"},"✓",8,ut),t("button",{class:"icon-btn cancel-btn",onClick:j,title:"取消"},"✕")],64)):(o(),n(E,{key:1},[t("span",rt,v(s.text),1),t("button",{class:"icon-btn edit-btn",onClick:i=>de(s),title:"編輯"},"✎",8,dt)],64))]),t("span",ct,[s.category==="ai"?(o(),n("span",vt,"AI")):(o(),n("span",pt,"手動"))]),t("span",ft,[t("button",{class:"paper-btn btn-danger",onClick:i=>ce(s.id)}," 刪除 ",8,yt)])]))),128))])):y("",!0)]),d.value?(o(),n("div",_t,v(d.value),1)):y("",!0),u.value?(o(),n("div",ht,v(u.value),1)):y("",!0)])):y("",!0)])])])]),A.value?(o(),n("div",{key:0,class:"modal-overlay",onClick:e[7]||(e[7]=s=>A.value=!1)},[t("div",{class:"modal-dialog",onClick:e[6]||(e[6]=Ce(()=>{},["stop"]))},[e[21]||(e[21]=t("div",{class:"modal-header"},[t("h3",{class:"text-hand-title"},"確認刪除主題")],-1)),t("div",mt,[e[20]||(e[20]=t("p",{class:"delete-warning"}," ⚠️ 此操作無法撤銷！ ",-1)),c.value?(o(),n("p",gt,[e[16]||(e[16]=T(" 您即將刪除主題「",-1)),t("strong",null,v(c.value.title),1),e[17]||(e[17]=T("」 ",-1))])):y("",!0),c.value&&c.value.entry_count>0?(o(),n("p",bt,[e[18]||(e[18]=T(" 此主題包含 ",-1)),t("strong",null,v(c.value.entry_count),1),e[19]||(e[19]=T(" 個詞條，刪除主題將一併刪除所有詞條。 ",-1))])):(o(),n("p",kt," 此主題目前沒有詞條。 "))]),t("div",wt,[t("button",{class:"paper-btn btn-secondary",onClick:e[5]||(e[5]=s=>A.value=!1)}," 取消 "),t("button",{class:"paper-btn btn-danger",onClick:fe,disabled:M.value},v(M.value?"刪除中...":"確認刪除"),9,Ct)])])])):y("",!0)])}}}),Tt=xe(xt,[["__scopeId","data-v-d3b658fb"]]);export{Tt as default};
