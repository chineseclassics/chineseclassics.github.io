import{l as ie,r as k,d as z,u as P,i as j,m as q,c as g,e,o as f,_ as N,f as $,a as T,n as M,F as H,p as K,q as E,g as Q,t as R,v as Z,b as d,s as B,x as le,y as ce,j as V,z as de,w as ue,A as me}from"./index-gqVaaW0u.js";import{c as I,b as U,d as Y,e as ee,a as ve,u as he,W as ge}from"./useRealtime-Bvvodza_.js";const te=ie("drawing",()=>{const t=k("pen"),o=k("#000000"),l=k(3),s=k(!1),i=k([]);function n(r){t.value=r}function m(r){o.value=r}function _(r){l.value=Math.max(1,Math.min(20,r))}function x(r){i.value.push(r)}function y(){i.value=[]}function b(r){s.value=r}return{tool:t,color:o,lineWidth:l,isDrawing:s,strokes:i,setTool:n,setColor:m,setLineWidth:_,addStroke:x,clearStrokes:y,setDrawing:b}});function J(t,o){const l=t.getBoundingClientRect(),s=t.width/l.width,i=t.height/l.height;let n,m;if(o instanceof MouseEvent)n=o.clientX,m=o.clientY;else if(o instanceof TouchEvent&&o.touches.length>0&&o.touches[0])n=o.touches[0].clientX,m=o.touches[0].clientY;else return null;return{x:(n-l.left)*s,y:(m-l.top)*i}}function oe(t,o){if(!(o.points.length<2)){t.save(),o.tool==="pen"?(t.strokeStyle=o.color,t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round"):o.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),o.points[0]&&t.moveTo(o.points[0].x,o.points[0].y);for(let l=1;l<o.points.length;l++){const s=o.points[l];s&&t.lineTo(s.x,s.y)}t.stroke(),t.restore()}}function X(t,o){const l=t.getContext("2d");l&&(l.clearRect(0,0,t.width,t.height),l.fillStyle="#FFFFFF",l.fillRect(0,0,t.width,t.height),o.forEach(s=>{oe(l,s)}))}function fe(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function se(){const t=te(),o=I(),{sendDrawing:l}=U(),s=k(null),i=k(null),n=k(null),m=k(null);let _=null;const x=50;function y(c){s.value=c;const h=c.getContext("2d",{willReadFrequently:!0});if(!h){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}i.value=h;const a=window.devicePixelRatio||1,G=c.getBoundingClientRect();c.width=G.width*a,c.height=G.height*a,h.scale(a,a),h.canvas.width=G.width,h.canvas.height=G.height,h.fillStyle="#FFFFFF",h.fillRect(0,0,c.width,c.height),s.value&&X(s.value,t.strokes)}function b(c){if(!s.value)return;c.preventDefault(),t.setDrawing(!0);const h=J(s.value,c);h&&(n.value={id:fe(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[h],timestamp:Date.now()},m.value=h)}function r(c){if(!s.value||!i.value||!t.isDrawing||!n.value)return;c.preventDefault();const h=J(s.value,c);if(!h||!m.value)return;const a=i.value;a.save(),n.value.tool==="pen"?(a.strokeStyle=n.value.color,a.lineWidth=n.value.lineWidth,a.lineCap="round",a.lineJoin="round"):n.value.tool==="eraser"&&(a.globalCompositeOperation="destination-out",a.lineWidth=n.value.lineWidth,a.lineCap="round",a.lineJoin="round"),a.beginPath(),a.moveTo(m.value.x,m.value.y),a.lineTo(h.x,h.y),a.stroke(),a.restore(),n.value.points.push(h),m.value=h,_===null&&(_=window.setTimeout(()=>{u(),_=null},x))}function S(){!t.isDrawing||!n.value||(t.setDrawing(!1),_&&(clearTimeout(_),_=null),u(),n.value=null,m.value=null)}async function u(){if(!(!n.value||!o.currentRoom))try{await l(o.currentRoom.code,n.value)}catch(c){console.error("ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",c)}}function w(c){!s.value||!i.value||(t.addStroke(c),oe(i.value,c))}function v(){if(!s.value||!i.value)return;const c=i.value,h=s.value;c.clearRect(0,0,h.width,h.height),c.fillStyle="#FFFFFF",c.fillRect(0,0,h.width,h.height),t.clearStrokes()}function p(c){t.setTool(c)}function D(c){t.setColor(c)}function W(c){t.setLineWidth(c)}function F(){s.value&&X(s.value,t.strokes)}return{canvasRef:s,initCanvas:y,startDrawing:b,draw:r,stopDrawing:S,clearCanvas:v,setTool:p,setColor:D,setLineWidth:W,handleDrawingData:w,redrawStrokes:F}}const _e={class:"drawing-canvas-container"},pe=z({__name:"DrawingCanvas",setup(t){const{initCanvas:o,startDrawing:l,draw:s,stopDrawing:i,handleDrawingData:n}=se(),m=I(),_=P(),{subscribeDrawing:x,unsubscribeRoom:y}=U(),b=k(null);function r(F){l(F)}function S(F){s(F)}function u(){i()}function w(){i()}function v(F){l(F)}function p(F){s(F)}function D(){i()}function W(){!m.currentRoom||!_.user||x(m.currentRoom.code,F=>{n(F)})}return j(()=>{b.value&&o(b.value),W()}),q(()=>{m.currentRoom&&y(m.currentRoom.code)}),(F,c)=>(f(),g("div",_e,[e("canvas",{ref_key:"canvasElement",ref:b,class:"drawing-canvas",onMousedown:r,onMousemove:S,onMouseup:u,onMouseleave:w,onTouchstart:v,onTouchmove:p,onTouchend:D},null,544)]))}}),be=N(pe,[["__scopeId","data-v-e4ccc127"]]),we={class:"drawing-toolbar"},ye={class:"margin-bottom-small"},xe={key:0,class:"margin-bottom-small"},Fe={style:{display:"grid","grid-template-columns":"repeat(6, 1fr)",gap:"4px","margin-top":"0.5rem"}},Ce=["onClick","aria-label"],Re={class:"margin-top-small"},ke={class:"margin-bottom-small"},Se={class:"text-small"},De=z({__name:"DrawingToolbar",setup(t){const o=te(),{setTool:l,setColor:s,setLineWidth:i,clearCanvas:n}=se(),m=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],_=$(()=>o.tool),x=$(()=>o.color),y=$({get:()=>o.lineWidth,set:w=>o.setLineWidth(w)});function b(){i(y.value)}function r(w){l(w)}function S(w){s(w)}function u(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&n()}return(w,v)=>(f(),g("div",we,[e("div",ye,[e("button",{onClick:v[0]||(v[0]=p=>r("pen")),class:M(["paper-btn btn-block margin-bottom-small",_.value==="pen"?"btn-primary":"btn-secondary"]),title:"ç•«ç­†"}," âœï¸ ç•«ç­† ",2),e("button",{onClick:v[1]||(v[1]=p=>r("eraser")),class:M(["paper-btn btn-block",_.value==="eraser"?"btn-danger":"btn-secondary"]),title:"æ©¡çš®æ“¦"}," ğŸ§¹ æ©¡çš®æ“¦ ",2)]),_.value==="pen"?(f(),g("div",xe,[v[4]||(v[4]=e("label",{class:"text-small"},"é¡è‰²",-1)),e("div",Fe,[(f(),g(H,null,K(m,p=>e("div",{key:p,onClick:D=>S(p),style:E({backgroundColor:p,width:"100%",aspectRatio:"1",cursor:"pointer",border:x.value===p?"3px solid var(--border-color)":"1px solid var(--border-light)",borderRadius:"4px",boxSizing:"border-box"}),"aria-label":`é¸æ“‡é¡è‰² ${p}`},null,12,Ce)),64))]),e("div",Re,[v[3]||(v[3]=e("label",{class:"text-small"},"ç•¶å‰é¡è‰²",-1)),e("div",{class:"border",style:E([{width:"100%",height:"50px","margin-top":"0.5rem","border-color":"var(--border-color)"},{backgroundColor:x.value}])},null,4)])])):T("",!0),e("div",ke,[e("label",Se,"ç•«ç­†å¤§å°: "+R(y.value)+"px",1),Q(e("input",{"onUpdate:modelValue":v[2]||(v[2]=p=>y.value=p),onInput:b,type:"range",min:"1",max:"20",class:"margin-top-small"},null,544),[[Z,y.value,void 0,{number:!0}]])]),e("div",null,[e("button",{onClick:u,class:"paper-btn btn-danger btn-block",title:"æ¸…ç©ºç•«å¸ƒ"}," ğŸ—‘ï¸ æ¸…ç©º ")])]))}}),We=N(De,[["__scopeId","data-v-4ab090e3"]]),Te={class:"player-list"},$e={class:"col-2"},Ge={class:"col-8"},Me={class:"text-hand"},Le={key:0,class:"badge warning",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)"}},Ve={key:1,class:"text-small"},Ee={class:"text-small"},ze={key:0,class:"alert alert-success margin-top-medium",style:{"background-color":"var(--color-success)",color:"white","border-color":"var(--color-success)"}},Pe={class:"text-hand-title",style:{color:"white"}},Ie={class:"text-small margin-top-small",style:{color:"white"}},Be=z({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(t){const o=I(),l=Y(),s=P(),{playerRankings:i,winner:n}=ee(),m=$(()=>i.value);function _(r){return o.participants.find(u=>u.user_id===r)?.nickname||"æœªçŸ¥ç©å®¶"}function x(r){return s.user?.id===r}function y(r){return o.currentRoom?.host_id===r}function b(r){return l.currentRound?.drawer_id===r}return(r,S)=>(f(),g("div",Te,[(f(!0),g(H,null,K(m.value,u=>(f(),g("div",{key:u.id,class:M(["row flex-middle margin-bottom-small border-bottom",x(u.user_id)?"border-primary":""]),style:{"padding-bottom":"10px"}},[e("div",$e,[e("div",{class:M(["border",b(u.user_id)?"border-warning":""]),style:E({width:"40px",height:"40px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:b(u.user_id)?"var(--color-warning)":"var(--bg-secondary)",borderColor:b(u.user_id)?"var(--color-warning)":"var(--border-light)",color:"var(--text-primary)"})},R(_(u.user_id).charAt(0)),7)]),e("div",Ge,[e("div",Me,[B(R(_(u.user_id))+" ",1),b(u.user_id)?(f(),g("span",Le," ç•«å®¶ ")):T("",!0),y(u.user_id)?(f(),g("span",Ve,"(æˆ¿ä¸»)")):T("",!0)]),e("div",Ee," å¾—åˆ† "+R(u.score),1)])],2))),128)),t.showWinner&&d(n)?(f(),g("div",ze,[e("div",Pe," ğŸ† ç²å‹è€…ï¼š"+R(_(d(n).user_id)),1),e("div",Ie," ç¸½åˆ†ï¼š"+R(d(n).score)+" åˆ† ",1)])):T("",!0)]))}}),O=N(Be,[["__scopeId","data-v-d3c06d99"]]);function Ne(){const t=Y(),o=P(),{calculateGuessScore:l,updatePlayerScore:s}=ee(),i=k(""),n=k(null),m=k(!1),_=$(()=>t.isCurrentDrawer?t.currentWord:null),x=$(()=>t.correctGuesses),y=$(()=>o.user?t.hasGuessed(o.user.id):!1);async function b(){if(!t.currentRound||!o.user)return n.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!i.value.trim())return n.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(i.value.length>32)return n.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(y.value)return n.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return n.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{m.value=!0,n.value=null;const u=i.value.trim(),w=t.currentWord||"",v=r(u,w),p=v?l(x.value.length):0,{data:D,error:W}=await le.from("guesses").insert({round_id:t.currentRound.id,user_id:o.user.id,guess_text:u,is_correct:v,score_earned:p}).select().single();if(W)throw W;return t.guesses.push(D),v&&o.user&&await s(o.user.id,p),v&&(i.value=""),{success:!0,isCorrect:v,guess:D}}catch(u){return n.value=u instanceof Error?u.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",u),{success:!1,error:n.value}}finally{m.value=!1}}function r(u,w){const v=u.trim(),p=w.trim();return v===p}function S(){n.value=null}return{guessInput:i,error:n,loading:m,currentWord:_,correctGuesses:x,hasGuessed:y,submitGuess:b,clearError:S}}const Ue={class:"container margin-top-small"},Ye={style:{"min-height":"100vh"}},Ae={key:0,class:"row flex-middle flex-spaces margin-bottom-small"},Je={class:"col-6"},Xe={class:"row flex-middle"},Oe={class:"text-hand-title",style:{margin:"0","margin-right":"1rem","font-size":"1.5rem"}},je={class:"text-small",style:{"white-space":"nowrap"}},qe={style:{"font-family":"monospace","font-weight":"bold"}},He={class:"col-6 text-right"},Ke={class:"row flex-middle flex-right",style:{gap:"0.5rem"}},Qe={key:0,class:"badge",style:{"background-color":"var(--color-success)",color:"white","font-family":"var(--font-head)","font-size":"1.1rem",padding:"0.5rem 1rem"}},Ze={key:1,class:"margin-bottom-small"},et={class:"text-hand-title"},tt={class:"text-small"},ot={style:{"font-family":"monospace"}},st={key:2,class:"row flex-center"},nt={class:"col-12 col-md-8"},rt={key:3,class:"row room-layout room-playing"},at={class:"col-12 col-md-3 room-column"},it={class:"card room-card player-card"},lt={class:"card-body player-body"},ct={class:"player-scroll"},dt={class:"col-12 col-md-6 room-column"},ut={class:"card room-card canvas-card"},mt={class:"card-body canvas-card-body"},vt={class:"canvas-paper canvas-wrapper"},ht={key:0,class:"margin-top-small"},gt={class:"progress"},ft={class:"row margin-top-small guess-chat-row"},_t={class:"col-12 col-md-8"},pt={class:"card room-card guess-card"},bt={class:"card-body guess-card-body"},wt={class:"border margin-bottom-small",style:{"min-height":"60px","max-height":"100px","overflow-y":"auto",padding:"0.5rem",background:"#f4f4f4"}},yt={key:0,class:"text-center text-hand"},xt={key:1,class:"text-center",style:{color:"#41b883"}},Ft={key:2,class:"text-center text-small"},Ct={key:0},Rt={class:"col-8"},kt=["disabled"],St={class:"col-4"},Dt=["disabled"],Wt={class:"col-12 col-md-3 room-column"},Tt={class:"card room-card"},$t={class:"card-body"},Gt={key:4,class:"row flex-center"},Mt={class:"col-12 col-md-8"},Lt={class:"card"},Vt={class:"card-body text-center"},Pt=z({__name:"RoomView",setup(t){const o=ce(),l=I(),s=Y(),i=P(),{subscribeRoom:n,subscribeGuesses:m,unsubscribeRoom:_}=U(),{isPlaying:x,isWaiting:y,isFinished:b,timeRemaining:r,isCountingDown:S,formattedTime:u,isCurrentDrawer:w,drawTime:v,startGame:p}=ve(),{hasGuessed:D,guessInput:W,submitGuess:F,loading:c}=Ne(),{leaveRoom:h}=he(),a=$(()=>l.currentRoom),G=$(()=>c.value);async function ne(){await F()}async function re(){(await p()).success}async function A(){(await h()).success}return j(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",o.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",a.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",i.user?.id);const L=o.params.code;L&&!a.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",L),a.value&&i.user?(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",a.value.status),await s.loadCurrentRound(a.value.id),n(a.value.code,a.value.id,i.user.id,{nickname:i.profile?.display_name||"ç©å®¶"}),s.currentRound&&m(a.value.code,s.currentRound.id)):console.warn("[RoomView] æ²’æœ‰æˆ¿é–“æˆ–ç”¨æˆ¶:",{hasRoom:!!a.value,hasUser:!!i.user})}),q(()=>{a.value&&_(a.value.code)}),(L,C)=>(f(),g("div",Ue,[e("div",Ye,[d(x)?(f(),g("div",Ae,[e("div",Je,[e("div",Xe,[e("h1",Oe,R(a.value?.name||"éŠæˆ²æˆ¿é–“"),1),e("div",je,[C[1]||(C[1]=B(" æˆ¿é–“ç¢¼ï¼š",-1)),e("span",qe,R(a.value?.code),1)])])]),e("div",He,[e("div",Ke,[d(w)&&d(s).currentWord?(f(),g("div",Qe," ğŸ¯ "+R(d(s).currentWord),1)):T("",!0),d(S)?(f(),g("div",{key:1,class:M(["badge",d(r)&&d(r)<=10?"badge-danger":"badge-secondary"]),style:E({fontSize:"1.2rem",fontFamily:"var(--font-head)",fontWeight:"bold",backgroundColor:d(r)&&d(r)<=10?"var(--color-danger)":"var(--color-secondary)",color:"white",padding:"0.5rem 1rem"})}," â±ï¸ "+R(d(u)),7)):T("",!0),e("button",{onClick:A,class:"paper-btn btn-small btn-danger",title:"é›¢é–‹æˆ¿é–“",style:{padding:"0.3rem 0.6rem"}}," âœ• é›¢é–‹ ")])])])):(f(),g("div",Ze,[e("h1",et,R(a.value?.name||"éŠæˆ²æˆ¿é–“"),1),e("div",tt,[C[2]||(C[2]=B(" æˆ¿é–“ç¢¼ï¼š",-1)),e("span",ot,R(a.value?.code),1)])])),d(y)?(f(),g("div",st,[e("div",nt,[V(ge,{room:a.value,participants:d(l).participants,onStartGame:re,onLeaveRoom:A},null,8,["room","participants"])])])):d(x)?(f(),g("div",rt,[e("div",at,[e("div",it,[e("div",lt,[C[3]||(C[3]=e("h4",{class:"card-title text-hand-title"},"ç©å®¶åˆ—è¡¨",-1)),e("div",ct,[V(O,{"show-winner":!1})])])])]),e("div",dt,[e("div",ut,[e("div",mt,[e("div",vt,[V(be,{class:"canvas-surface"})])])]),d(S)&&d(r)!==null?(f(),g("div",ht,[e("div",gt,[e("div",{class:M(["bar",d(r)<=10?"bar-danger":"bar-success"]),style:E({width:`${d(r)/d(v)*100}%`,backgroundColor:d(r)<=10?"var(--color-danger)":"var(--color-secondary)"})},null,6)])])):T("",!0),e("div",ft,[e("div",_t,[e("div",pt,[e("div",bt,[C[4]||(C[4]=e("h5",{class:"text-hand-title"},"ç­”æ¡ˆ",-1)),e("div",wt,[d(w)?(f(),g("div",yt," ğŸ¨ ä½ æ˜¯ç•«å®¶ï¼Œé–‹å§‹ç•«ç•«å§ï¼ ")):d(D)?(f(),g("div",xt," âœ… å·²çŒœä¸­ï¼ ")):(f(),g("div",Ft," ä»”ç´°çœ‹ç•«ï¼ŒçŒœçŒœæ˜¯ä»€éº¼è©èª "))]),d(w)?T("",!0):(f(),g("div",Ct,[e("form",{onSubmit:ue(ne,["prevent"]),class:"row flex-middle"},[e("div",Rt,[Q(e("input",{"onUpdate:modelValue":C[0]||(C[0]=ae=>me(W)?W.value=ae:null),type:"text",placeholder:"è¼¸å…¥ä½ çš„ç­”æ¡ˆ...",maxlength:"32",disabled:G.value||d(D)},null,8,kt),[[Z,d(W)]])]),e("div",St,[e("button",{type:"submit",disabled:G.value||d(D)||!d(W).trim(),class:"paper-btn btn-primary btn-block"},R(G.value?"æäº¤ä¸­...":d(D)?"å·²çŒœä¸­":"æäº¤"),9,Dt)])],32)]))])])]),C[5]||(C[5]=de('<div class="col-12 col-md-4"><div class="card room-card chat-card"><div class="card-body chat-card-body"><h5 class="text-hand-title">èŠå¤©å®¤</h5><div class="border" style="min-height:60px;max-height:100px;overflow-y:auto;padding:0.5rem;background:#f4f4f4;"><div class="text-center text-small">èŠå¤©åŠŸèƒ½å³å°‡æ¨å‡º</div></div></div></div></div>',1))])]),e("div",Wt,[e("div",Tt,[e("div",$t,[V(We)])])])])):d(b)?(f(),g("div",Gt,[e("div",Mt,[e("div",Lt,[e("div",Vt,[C[6]||(C[6]=e("h2",{class:"card-title text-hand-title"},"éŠæˆ²çµæŸ",-1)),V(O,{"show-winner":!0})])])])])):T("",!0)])]))}});export{Pt as default};
