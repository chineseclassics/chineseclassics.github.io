import{l as Ae,r as T,u as J,f as x,d as Q,h as j,i as de,m as ve,c as u,e,o as d,_ as Z,n as N,a as W,F as U,p as q,q as ce,t as h,b as l,s as te,x as X,y as ze,j as H,g as He,v as Oe,z as Ue,A as qe,k as Je,B as Ke}from"./index-ZqzqBOXY.js";import{b as se,a as me,c as ne,d as $e,e as Ce,u as Ye,W as Xe}from"./WaitingLobby-CX4PriNt.js";const ge=Ae("drawing",()=>{const t=T("pen"),n=T("#000000"),v=T(3),c=T(!1),s=T([]);function m(y){t.value=y}function M(y){n.value=y}function b(y){v.value=Math.max(1,Math.min(20,y))}function F(y){s.value.push(y)}function G(){s.value=[]}function I(y){c.value=y}return{tool:t,color:n,lineWidth:v,isDrawing:c,strokes:s,setTool:m,setColor:M,setLineWidth:b,addStroke:F,clearStrokes:G,setDrawing:I}});function De(t,n){const v=t.getBoundingClientRect();let c,s;if(n instanceof MouseEvent)c=n.clientX,s=n.clientY;else if(n instanceof TouchEvent&&n.touches.length>0&&n.touches[0])c=n.touches[0].clientX,s=n.touches[0].clientY;else return null;return{x:c-v.left,y:s-v.top}}function ue(t,n){if(t.save(),n.tool==="fill"){n.canvasSize&&(t.fillStyle=n.color,t.fillRect(0,0,n.canvasSize.width,n.canvasSize.height)),t.restore();return}if(n.points.length<2){t.restore();return}n.tool==="pen"?(t.strokeStyle=n.color,t.lineWidth=n.lineWidth,t.lineCap="round",t.lineJoin="round"):n.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=n.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),n.points[0]&&t.moveTo(n.points[0].x,n.points[0].y);for(let v=1;v<n.points.length;v++){const c=n.points[v];c&&t.lineTo(c.x,c.y)}t.stroke(),t.restore()}function Se(t,n){const v=t.getContext("2d");if(!v)return;const c=t.getBoundingClientRect();v.clearRect(0,0,t.width,t.height),v.fillStyle="#FFFFFF",v.fillRect(0,0,c.width,c.height),n.forEach(s=>{ue(v,s)})}function ke(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const L=T(null),B=T(null),E=T(null),O=T(null);function xe(){const t=ge(),n=se(),v=J(),{sendDrawing:c}=me(),s=x(()=>!v.user||!n.currentRoom?!1:n.currentRoom.current_drawer_id===v.user.id);let m=null;const M=50;function b(o){console.log("[useDrawing] initCanvas è¢«èª¿ç”¨"),L.value=o;const p=o.getContext("2d",{willReadFrequently:!0});if(!p){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}B.value=p;const w=window.devicePixelRatio||1,z=o.getBoundingClientRect();o.width=z.width*w,o.height=z.height*w,p.scale(w,w),p.fillStyle="#FFFFFF",p.fillRect(0,0,z.width,z.height),t.clearStrokes(),console.log("[useDrawing] Canvas åˆå§‹åŒ–å®Œæˆï¼Œç­†è§¸å·²æ¸…ç©º"),new ResizeObserver(()=>{if(!L.value||!B.value)return;const V=L.value.getBoundingClientRect(),P=window.devicePixelRatio||1;L.value.width=V.width*P,L.value.height=V.height*P,B.value.scale(P,P),B.value.fillStyle="#FFFFFF",B.value.fillRect(0,0,V.width,V.height),Se(L.value,t.strokes)}).observe(o)}function F(o){if(!L.value)return;if(!s.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}o.preventDefault(),t.setDrawing(!0);const p=De(L.value,o);p&&(E.value={id:ke(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[p],timestamp:Date.now()},O.value=p)}function G(o){if(!L.value||!B.value||!t.isDrawing||!E.value)return;o.preventDefault();const p=De(L.value,o);if(!p||!O.value)return;const w=B.value;w.save(),E.value.tool==="pen"?(w.strokeStyle=E.value.color,w.lineWidth=E.value.lineWidth,w.lineCap="round",w.lineJoin="round"):E.value.tool==="eraser"&&(w.globalCompositeOperation="destination-out",w.lineWidth=E.value.lineWidth,w.lineCap="round",w.lineJoin="round"),w.beginPath(),w.moveTo(O.value.x,O.value.y),w.lineTo(p.x,p.y),w.stroke(),w.restore(),E.value.points.push(p),O.value=p,m===null&&(m=window.setTimeout(()=>{y(),m=null},M))}function I(){!t.isDrawing||!E.value||(t.setDrawing(!1),m&&(clearTimeout(m),m=null),y(),E.value=null,O.value=null)}async function y(){if(!(!E.value||!n.currentRoom||!v.user))try{const o={...E.value,userId:v.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",o.id),await c(n.currentRoom.code,o)}catch(o){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",o)}}function C(o){if(!(!L.value||!B.value)){if(o.userId&&v.user&&o.userId===v.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",o.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",o.id,o.tool),t.addStroke(o),ue(B.value,o)}}function R(){if(console.log("[useDrawing] clearCanvasLocal è¢«èª¿ç”¨"),!L.value||!B.value){console.warn("[useDrawing] clearCanvasLocal: canvas æˆ– ctx ä¸å­˜åœ¨");return}const o=B.value,w=L.value.getBoundingClientRect();console.log("[useDrawing] æ¸…ç©ºç•«å¸ƒï¼Œå°ºå¯¸:",w.width,"x",w.height),o.clearRect(0,0,w.width,w.height),o.fillStyle="#FFFFFF",o.fillRect(0,0,w.width,w.height),t.clearStrokes(),console.log("[useDrawing] ç•«å¸ƒå·²æ¸…ç©º")}async function D(){if(console.log("[useDrawing] clearCanvas è¢«èª¿ç”¨"),!L.value||!B.value||!n.currentRoom||!v.user){console.warn("[useDrawing] clearCanvas: ç¼ºå°‘å¿…è¦æ¢ä»¶");return}const o=L.value.getBoundingClientRect(),p={id:ke(),tool:"fill",color:"#FFFFFF",lineWidth:0,points:[],timestamp:Date.now(),canvasSize:{width:o.width,height:o.height}};ue(B.value,p),t.addStroke(p);try{const w={...p,userId:v.user.id};await c(n.currentRoom.code,w),console.log("[useDrawing] æ¸…ç©ºç•«å¸ƒç­†è§¸å·²å»£æ’­")}catch(w){console.error("[useDrawing] å»£æ’­æ¸…ç©ºç­†è§¸å¤±æ•—:",w)}}function f(o){t.setTool(o)}function r(o){t.setColor(o)}function i(o){t.setLineWidth(o)}function g(){L.value&&Se(L.value,t.strokes)}return{canvasRef:L,initCanvas:b,startDrawing:F,draw:G,stopDrawing:I,clearCanvas:D,clearCanvasLocal:R,setTool:f,setColor:r,setLineWidth:i,handleDrawingData:C,redrawStrokes:g}}const je={class:"drawing-canvas-container"},Qe=Q({__name:"DrawingCanvas",setup(t,{expose:n}){const{initCanvas:v,startDrawing:c,draw:s,stopDrawing:m,handleDrawingData:M}=xe(),b=se(),F=J(),G=ge(),I=ne(),{subscribeDrawing:y}=me(),C=T(null);function R(){if(console.log("[DrawingCanvas] localClearCanvas è¢«èª¿ç”¨"),!C.value){console.warn("[DrawingCanvas] canvas å…ƒç´ ä¸å­˜åœ¨");return}const $=C.value,V=$.getContext("2d");if(!V){console.warn("[DrawingCanvas] ç„¡æ³•ç²å– ctx");return}const P=$.getBoundingClientRect(),A=window.devicePixelRatio||1;$.width=P.width*A,$.height=P.height*A,V.scale(A,A),V.fillStyle="#FFFFFF",V.fillRect(0,0,P.width,P.height),G.clearStrokes(),console.log("[DrawingCanvas] ç•«å¸ƒå·²æ¸…ç©º")}j(()=>I.currentRound?.id,($,V)=>{console.log("[DrawingCanvas] watch currentRound.id:",{oldRoundId:V,newRoundId:$}),$&&$!==V&&(console.log("[DrawingCanvas] æ–°è¼ªæ¬¡é–‹å§‹ï¼Œæ¸…ç©ºç•«å¸ƒ"),R())}),n({clearCanvas:R});function D($){c($)}function f($){s($)}function r(){m()}function i(){m()}function g($){c($)}function o($){s($)}function p(){m()}let w=null;function z(){!b.currentRoom||!F.user||(w=y(b.currentRoom.code,$=>{M($)}))}return de(()=>{console.log("[DrawingCanvas] onMounted - çµ„ä»¶æ›è¼‰"),C.value&&v(C.value),z()}),ve(()=>{w&&(w(),w=null)}),($,V)=>(d(),u("div",je,[e("canvas",{ref_key:"canvasElement",ref:C,class:"drawing-canvas",onMousedown:D,onMousemove:f,onMouseup:r,onMouseleave:i,onTouchstart:g,onTouchmove:o,onTouchend:p},null,544)]))}}),Ze=Z(Qe,[["__scopeId","data-v-38d12a7b"]]),et={class:"toolbar-section"},tt={key:0,class:"tool-label"},st={key:0,class:"tool-label"},nt={key:0,class:"toolbar-section colors-section"},ot=["onClick","title"],rt={class:"toolbar-section size-section"},at={class:"size-dots"},it=["onClick","title"],lt={class:"toolbar-section"},ct={key:0,class:"tool-label"},ut=Q({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const n=ge(),{setTool:v,setColor:c,setLineWidth:s,clearCanvas:m}=xe(),M=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],b=x(()=>n.tool),F=x(()=>n.color),G=x(()=>n.lineWidth);function I(D){v(D)}function y(D){c(D)}function C(D){n.setLineWidth(D),s(D)}async function R(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&await m()}return(D,f)=>(d(),u("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",et,[e("button",{onClick:f[0]||(f[0]=r=>I("pen")),class:N(["tool-btn",{active:b.value==="pen"}]),title:"ç•«ç­†"},[f[2]||(f[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?W("",!0):(d(),u("span",tt,"ç•«ç­†"))],2),e("button",{onClick:f[1]||(f[1]=r=>I("eraser")),class:N(["tool-btn",{active:b.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[f[3]||(f[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?W("",!0):(d(),u("span",st,"æ©¡çš®æ“¦"))],2)]),b.value==="pen"?(d(),u("div",nt,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(d(),u(U,null,q(M,r=>e("div",{key:r,onClick:i=>y(r),class:N(["color-cell",{selected:F.value===r}]),style:ce({backgroundColor:r}),title:r},null,14,ot)),64))],2)])):W("",!0),e("div",rt,[e("div",at,[(d(),u(U,null,q([2,5,10,15],r=>e("div",{key:r,onClick:i=>C(r),class:N(["size-dot",{active:G.value===r}]),style:ce({width:`${r+8}px`,height:`${r+8}px`}),title:`${r}px`},null,14,it)),64))])]),e("div",lt,[e("button",{onClick:R,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[f[4]||(f[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?W("",!0):(d(),u("span",ct,"æ¸…ç©º"))])])],2))}}),dt=Z(ut,[["__scopeId","data-v-74596782"]]),vt={class:"player-list"},mt={class:"player-list-header"},gt={class:"player-count"},wt={class:"player-rank"},ht={class:"player-info"},ft={class:"player-name"},_t={key:0,class:"drawer-badge"},pt={key:1,class:"host-badge"},yt={class:"player-score"},Rt=["onClick"],bt={key:0,class:"winner-banner"},Ct={class:"winner-text"},Dt={class:"winner-name"},St={class:"winner-score"},kt=Q({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:n}){const v=n,c=se(),s=ne(),m=J(),{playerRankings:M,winner:b}=$e(),F=x(()=>M.value),G=T(!1);function I(r){return c.participants.find(g=>g.user_id===r)?.nickname||"æœªçŸ¥ç©å®¶"}function y(r){return m.user?.id===r}function C(r){return c.currentRoom?.host_id===r}function R(r){return s.currentRound?.drawer_id===r||c.currentRoom?.current_drawer_id===r}function D(r){return c.isHost&&!y(r)}async function f(r,i){if(!(G.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${i} å—ï¼Ÿ`))){G.value=!0;try{const o=await c.kickPlayer(r);o.success?v("player-kicked",r):alert(o.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(o){console.error("è¸¢äººå¤±æ•—:",o),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{G.value=!1}}}return(r,i)=>(d(),u("div",vt,[e("div",mt,[e("span",gt,"ç©å®¶ ("+h(F.value.length)+")",1)]),(d(!0),u(U,null,q(F.value,(g,o)=>(d(),u("div",{key:g.id,class:N(["player-item",{"is-current":y(g.user_id)},{"is-drawer":R(g.user_id)}])},[e("div",wt,h(o+1),1),e("div",{class:N(["player-avatar",{drawing:R(g.user_id)}])},h(I(g.user_id).charAt(0)),3),e("div",ht,[e("div",ft,[te(h(I(g.user_id))+" ",1),R(g.user_id)?(d(),u("span",_t,"âœï¸")):W("",!0),C(g.user_id)?(d(),u("span",pt,"ğŸ‘‘")):W("",!0)]),e("div",yt,h(g.score)+" åˆ†",1)]),D(g.user_id)?(d(),u("button",{key:0,class:"kick-btn",onClick:p=>f(g.user_id,I(g.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,Rt)):W("",!0)],2))),128)),t.showWinner&&l(b)?(d(),u("div",bt,[i[1]||(i[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Ct,[i[0]||(i[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",Dt,h(I(l(b).user_id)),1),e("div",St,h(l(b).score)+" åˆ†",1)])])):W("",!0)]))}}),Fe=Z(kt,[["__scopeId","data-v-984c1c4a"]]),Ft={class:"round-summary"},$t={class:"summary-card"},xt={key:0,class:"selection-waiting-banner"},Wt={class:"waiting-text"},Tt={class:"next-drawer-name"},It={class:"summary-header"},Mt={class:"summary-title"},Gt={class:"round-info"},Lt={class:"answer-reveal"},Vt={class:"answer-text"},Nt={class:"drawer-section"},Bt={class:"drawer-info"},Et={class:"drawer-name"},Pt={key:0,class:"drawer-score"},At={class:"guessers-section"},zt={key:0,class:"no-guessers"},Ht={key:1,class:"guessers-list"},Ot={class:"guesser-rank"},Ut={class:"guesser-name"},qt={class:"guesser-score"},Jt={key:1,class:"rating-section"},Kt={class:"star-rating"},Yt=["onMouseenter","onClick","disabled"],Xt={class:"rating-info"},jt={key:0,class:"rated-text"},Qt={key:1,class:"rate-hint"},Zt={key:2,class:"average-rating"},es={class:"avg-score"},ts={class:"avg-stars"},ss={class:"avg-count"},ns={key:3,class:"next-drawer-info"},os={class:"next-drawer-name-display"},rs={key:4,class:"game-ending-info"},as=Q({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:n}){const v=t,c=n,s=J(),m=T(0),M=T(0),b=T(!1),F=T([]),G=x(()=>s.user?.id===v.drawerId),I=x(()=>F.value.length===0?0:F.value.reduce((i,g)=>i+g.rating,0)/F.value.length),y=x(()=>F.value.length);async function C(r){if(!(b.value||G.value||!s.user))try{const{error:i}=await X.from("drawing_ratings").upsert({round_id:v.roundId,rater_id:s.user.id,drawer_id:v.drawerId,rating:r},{onConflict:"round_id,rater_id"});if(i)throw i;m.value=r,b.value=!0,c("rating-submitted",r)}catch(i){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",i)}}async function R(){try{const{data:r,error:i}=await X.from("drawing_ratings").select("rater_id, rating").eq("round_id",v.roundId);if(i)throw i;if(F.value=r||[],s.user){const g=F.value.find(o=>o.rater_id===s.user.id);g&&(m.value=g.rating,b.value=!0)}}catch(r){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",r)}}function D(){const r=X.channel(`ratings:${v.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${v.roundId}`},()=>{R()}).subscribe();return()=>{X.removeChannel(r)}}let f=null;return de(()=>{R(),f=D()}),ve(()=>{f&&f()}),j(()=>v.roundId,()=>{R()}),(r,i)=>(d(),u("div",Ft,[e("div",$t,[t.isWaitingForSelection?(d(),u("div",xt,[i[2]||(i[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Wt,[e("span",Tt,h(t.nextDrawerName),1),i[1]||(i[1]=te(" æ­£åœ¨é¸è©... ",-1))]),i[3]||(i[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):W("",!0),e("div",It,[e("h2",Mt,h(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Gt,"ç¬¬ "+h(t.roundNumber)+" / "+h(t.totalRounds)+" è¼ª",1)]),e("div",Lt,[i[4]||(i[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Vt,h(t.correctAnswer),1)]),e("div",Nt,[e("div",Bt,[i[5]||(i[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Et,h(t.drawerName),1),t.drawerScore>0?(d(),u("span",Pt,"+"+h(t.drawerScore)+" åˆ†",1)):W("",!0)])]),e("div",At,[i[6]||(i[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(d(),u("div",zt," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(d(),u("div",Ht,[(d(!0),u(U,null,q(t.correctGuessers,(g,o)=>(d(),u("div",{key:g.userId,class:"guesser-item"},[e("span",Ot,h(o+1),1),e("span",Ut,h(g.name),1),e("span",qt,"+"+h(g.score),1)]))),128))]))]),G.value?W("",!0):(d(),u("div",Jt,[i[7]||(i[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Kt,[(d(),u(U,null,q(5,g=>e("button",{key:g,class:N(["star-btn",{active:g<=(M.value||m.value),selected:g<=m.value}]),onMouseenter:o=>M.value=g,onMouseleave:i[0]||(i[0]=o=>M.value=0),onClick:o=>C(g),disabled:b.value}," â­ ",42,Yt)),64))]),e("div",Xt,[b.value?(d(),u("span",jt,"ä½ çš„è©•åˆ†ï¼š"+h(m.value)+" æ˜Ÿ",1)):(d(),u("span",Qt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),y.value>0?(d(),u("div",Zt,[i[8]||(i[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",es,h(I.value.toFixed(1)),1),e("span",ts,h("â­".repeat(Math.round(I.value))),1),e("span",ss,"("+h(y.value)+" äººå·²è©•)",1)])):W("",!0),t.nextDrawerName&&!t.isLastRound?(d(),u("div",ns,[i[9]||(i[9]=e("div",{class:"next-drawer-label"},"ä¸‹ä¸€è¼ªç•«æ‰‹",-1)),e("div",os,"âœï¸ "+h(t.nextDrawerName),1)])):W("",!0),t.isLastRound?(d(),u("div",rs,[...i[10]||(i[10]=[e("div",{class:"ending-label"},"ğŸ‰ é€™æ˜¯æœ€å¾Œä¸€è¼ªï¼",-1)])])):W("",!0)])]))}}),is=Z(as,[["__scopeId","data-v-2a39ef4b"]]);function ls(){const t=ne(),n=J(),{calculateGuessScore:v,updatePlayerScore:c}=$e(),s=T(""),m=T(null),M=T(!1),b=x(()=>t.isCurrentDrawer?t.currentWord:null),F=x(()=>t.correctGuesses),G=x(()=>n.user?t.hasGuessed(n.user.id):!1);async function I(){if(!t.currentRound||!n.user)return m.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return m.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return m.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(G.value)return m.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return m.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{M.value=!0,m.value=null;const R=s.value.trim(),D=t.currentWord||"",f=y(R,D),r=f?v(F.value.length):0,{data:i,error:g}=await X.from("guesses").insert({round_id:t.currentRound.id,user_id:n.user.id,guess_text:R,is_correct:f,score_earned:r}).select().single();if(g)throw g;return t.guesses.push(i),f&&n.user&&await c(n.user.id,r),s.value="",{success:!0,isCorrect:f,guess:i}}catch(R){return m.value=R instanceof Error?R.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",R),{success:!1,error:m.value}}finally{M.value=!1}}function y(R,D){const f=R.trim(),r=D.trim();return f===r}function C(){m.value=null}return{guessInput:s,error:m,loading:M,currentWord:b,correctGuesses:F,hasGuessed:G,submitGuess:I,clearError:C}}const cs={class:"game-container"},us={key:0,class:"container margin-top-large"},ds={class:"row flex-center"},vs={class:"col-12 col-md-8"},ms={key:1,class:"game-layout"},gs={class:"game-sidebar game-players"},ws={class:"player-list-container"},hs={class:"game-main"},fs={key:0,class:"time-display"},_s={key:1,class:"time-display summary"},ps={class:"time-number"},ys={class:"round-info"},Rs={class:"round-label"},bs={key:0,class:"phase-label"},Cs={key:2,class:"word-display"},Ds={class:"word-text"},Ss={key:3,class:"word-display"},ks={class:"drawer-hint"},Fs={class:"word-slots"},$s={key:4,class:"word-display summary-word"},xs={class:"word-text revealed"},Ws={class:"game-content-area"},Ts={class:"game-canvas"},Is={key:0,class:"time-progress"},Ms={key:1,class:"summary-overlay"},Gs={class:"game-chat-panel"},Ls={class:"msg-player"},Vs={key:0,class:"msg-correct"},Ns={key:1,class:"msg-text"},Bs={key:0,class:"chat-msg correct-self"},Es={class:"chat-input-area"},Ps=["placeholder","disabled"],As=["disabled"],zs={key:2,class:"container margin-top-large"},Hs={class:"row flex-center"},Os={class:"col-12 col-md-8"},Us={class:"card"},qs={class:"card-body text-center"},Js=Q({__name:"RoomView",setup(t){const n=ze(),v=Je(),c=se(),s=ne(),m=J(),{subscribeRoom:M,unsubscribeRoom:b,subscribeGameState:F}=me(),{isPlaying:G,isWaiting:I,isFinished:y,timeRemaining:C,isCountingDown:R,isCurrentDrawer:D,drawTime:f,currentRoundNumber:r,totalRounds:i,startGame:g,isDrawing:o,isSummary:p,summaryTimeRemaining:w,startSummaryCountdown:z,stopSummaryCountdown:$,startCountdown:V,stopCountdown:P}=Ce(),{hasGuessed:A,guessInput:K,submitGuess:We,loading:Te}=ls(),{leaveRoom:Ie}=Ye(),k=x(()=>c.currentRoom),we=x(()=>Te.value),he=T(null),ee=T(null),oe=x(()=>{const _=k.value?.current_drawer_id;return _&&c.participants.find(S=>S.user_id===_)?.nickname||"ç•«å®¶"}),Me=x(()=>{if(!k.value||c.participants.length===0)return"";const a=(k.value.current_round||0)%c.participants.length;return c.participants[a]?.nickname||"ä¸‹ä¸€ä½ç•«å®¶"}),fe=x(()=>r.value>=i.value),_e=x(()=>[...s.guesses].sort((_,a)=>new Date(_.guessed_at).getTime()-new Date(a.guessed_at).getTime()));function Ge(){ee.value&&(ee.value.scrollTop=ee.value.scrollHeight)}j(_e,()=>{Ke(Ge)},{deep:!0}),j(()=>c.participants,_=>{if(!m.user||!k.value)return;!_.some(S=>S.user_id===m.user.id)&&k.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),c.clearRoom(),v.push("/"))},{deep:!0});function pe(_){return c.participants.find(S=>S.user_id===_)?.nickname||"æœªçŸ¥ç©å®¶"}const Le=x(()=>D.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":A.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ve=x(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),ye=x(()=>s.currentRoundCorrectGuesses.length*5),Re=x(()=>s.currentRoundCorrectGuesses.map(_=>({userId:_.user_id,name:pe(_.user_id),score:_.score_earned}))),Ne=T(null);function Be(){!s.currentRound||!s.currentWord||(Ne.value={roundNumber:r.value,answer:s.currentWord,drawerName:oe.value,drawerId:s.currentRound.drawer_id,drawerScore:ye.value,correctGuessers:Re.value,roundId:s.currentRound.id})}j(p,(_,a)=>{_&&!a&&r.value>0&&Be()});function re(_){he.value=_,setTimeout(()=>{he.value=null},3e3)}async function be(){!D.value&&K.value.trim()&&await We()}async function Ee(){const _=await g();!_.success&&_.error&&re(_.error)}async function ae(){const _=await Ie();k.value&&b(k.value.code),await v.push("/"),!_.success&&_.error&&re(_.error)}async function Pe(_){if(!s.currentRound)return;const a=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,_);!a.success&&a.error&&re(a.error)}return de(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",n.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",k.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",m.user?.id);const _=n.params.code;if(_&&!k.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",_),k.value&&m.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",k.value.status),await s.loadCurrentRound(k.value.id),k.value.status==="playing"&&s.currentRound){const a=s.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:a.round_number,startedAt:a.started_at,endedAt:a.ended_at,drawerId:a.drawer_id}),a.drawer_id&&c.setCurrentDrawer(a.drawer_id),a.started_at&&!a.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),s.setRoundStatus("drawing");const S=new Date(a.started_at).getTime(),ie=Date.now(),le=Math.floor((ie-S)/1e3),Y=Math.max(0,f.value-le);console.log("[RoomView] åˆ·æ–°æ¢å¾©å€’è¨ˆæ™‚:",Y,"ç§’"),V(Y)}else a.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await M(k.value.code,k.value.id,m.user.id,{nickname:m.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(a){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",a)}F(k.value.code,async a=>{if(console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",a),a.drawerId&&k.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",a.drawerId),c.setCurrentDrawer(a.drawerId)),a.roundStatus){if(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",a.roundStatus),s.setRoundStatus(a.roundStatus),a.roundStatus==="drawing"){$(),s.clearRatings();let S=f.value;if(a.startedAt){const ie=new Date(a.startedAt).getTime(),le=Date.now(),Y=Math.floor((le-ie)/1e3);S=Math.max(0,f.value-Y),console.log("[RoomView] æ ¹æ“šæœå‹™å™¨æ™‚é–“è¨ˆç®—å‰©é¤˜æ™‚é–“:",S,"ç§’ (elapsed:",Y,"ç§’)")}console.log("[RoomView] é–‹å§‹å€’è¨ˆæ™‚:",S,"ç§’"),V(S)}a.roundStatus==="summary"&&(P(),a.isLastRound?c.isHost&&setTimeout(async()=>{const{endGame:S}=Ce();await S()},5e3):z())}k.value&&(await c.loadRoom(k.value.id),await s.loadCurrentRound(k.value.id))}),await s.loadAllGuesses(k.value.id)}}),ve(()=>{k.value&&b(k.value.code)}),(_,a)=>(d(),u("div",cs,[l(I)?(d(),u("div",us,[e("div",ds,[e("div",vs,[H(Xe,{room:k.value,participants:l(c).participants,onStartGame:Ee,onLeaveRoom:ae},null,8,["room","participants"])])])])):l(G)?(d(),u("div",ms,[e("div",gs,[e("div",ws,[H(Fe,{"show-winner":!1})])]),e("div",hs,[e("div",{class:N(["game-header",{"time-critical":l(C)!==null&&l(C)<=10}])},[l(o)&&l(R)&&l(C)!==null?(d(),u("div",fs,[e("span",{class:N(["time-number",{"time-warning":l(C)<=10,"time-critical-pulse":l(C)<=5}])},h(l(C)),3),a[1]||(a[1]=e("span",{class:"time-label"},"ç§’",-1))])):l(p)&&l(w)!==null?(d(),u("div",_s,[e("span",ps,h(l(w)),1),a[2]||(a[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):W("",!0),e("div",ys,[e("span",Rs,"ç¬¬ "+h(l(r))+" / "+h(l(i))+" è¼ª",1),l(p)?(d(),u("span",bs,"è¼ªæ¬¡çµç®—")):W("",!0)]),l(o)&&l(D)&&l(s).currentWord?(d(),u("div",Cs,[a[3]||(a[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",Ds,h(l(s).currentWord),1)])):l(o)?(d(),u("div",Ss,[e("span",ks,"ğŸ¨ "+h(oe.value)+" æ­£åœ¨ç•«",1),e("span",Fs,h(Ve.value),1)])):l(p)&&l(s).currentWord?(d(),u("div",$s,[a[4]||(a[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",xs,h(l(s).currentWord),1)])):W("",!0),e("button",{class:"leave-btn",onClick:ae,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ws,[e("div",{class:N(["game-toolbar",{disabled:l(p)}])},[H(dt,{compact:!0})],2),e("div",Ts,[H(Ze),!l(p)&&l(R)&&l(C)!==null?(d(),u("div",Is,[e("div",{class:N(["time-bar",{"time-warning":l(C)<=10}]),style:ce({width:`${l(C)/l(f)*100}%`})},null,6)])):W("",!0),l(p)?(d(),u("div",Ms,[H(is,{"round-number":l(r),"total-rounds":l(i),"correct-answer":l(s).currentWord||"","drawer-name":oe.value,"drawer-id":l(s).currentRound?.drawer_id||"","drawer-score":ye.value,"correct-guessers":Re.value,"round-id":l(s).currentRound?.id||"","is-host":l(c).isHost,"is-last-round":fe.value,"next-drawer-name":fe.value?"":Me.value,onRatingSubmitted:Pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round","next-drawer-name"])])):W("",!0)]),e("div",Gs,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:ee},[a[6]||(a[6]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),te(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(d(!0),u(U,null,q(_e.value,S=>(d(),u("div",{key:S.id,class:N(["chat-msg",{"correct-guess":S.is_correct,"wrong-guess":!S.is_correct}])},[e("span",Ls,h(pe(S.user_id)),1),S.is_correct?(d(),u("span",Vs,"çŒœä¸­äº†ï¼ +"+h(S.score_earned),1)):(d(),u("span",Ns,h(S.guess_text),1))],2))),128)),l(A)?(d(),u("div",Bs,[...a[5]||(a[5]=[e("span",{class:"msg-icon"},"âœ…",-1),te(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):W("",!0)],512),e("div",Es,[He(e("input",{"onUpdate:modelValue":a[0]||(a[0]=S=>qe(K)?K.value=S:null),type:"text",placeholder:Le.value,maxlength:"32",disabled:we.value||l(A)||l(D),onKeyup:Ue(be,["enter"]),class:"chat-input-field"},null,40,Ps),[[Oe,l(K)]]),e("button",{onClick:be,disabled:we.value||l(A)||l(D)||!l(K).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,As)])])])])])):l(y)?(d(),u("div",zs,[e("div",Hs,[e("div",Os,[e("div",Us,[e("div",qs,[a[7]||(a[7]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),H(Fe,{"show-winner":!0}),e("button",{onClick:ae,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):W("",!0)]))}}),Xs=Z(Js,[["__scopeId","data-v-473f4aca"]]);export{Xs as default};
