import{l as X,r as k,f as _,u as P,x as v,m as re,d as te,c as j,e as R,a as I,t as x,s as F,F as ne,p as oe,b as q,o as C,_ as se}from"./index-D55TnuIM.js";const $=X("room",()=>{const t=k(null),h=k([]),o=k(!1),a=k(null),g=_(()=>{const s=P();return t.value?.host_id===s.user?.id});async function y(s){try{o.value=!0,a.value=null;const e=P();if(!e.user)throw new Error("請先登入");if(!e.profile&&e.user)try{await e.loadUserProfile(e.user.id,!1)}catch(u){console.warn("載入用戶資料時發生錯誤（非關鍵）:",u)}if(s.words.length<6)throw new Error("至少需要 6 個詞語");if(s.settings.rounds>s.words.length)throw new Error("輪數不能超過詞語總數");let r=null,n=0;const l=10;for(;n<l&&!r;){n++;const d={code:Math.floor(1e5+Math.random()*9e5).toString(),name:s.name,host_id:e.user.id,words:s.words,word_count:s.words.length,status:"waiting",settings:s.settings,current_round:0,current_drawer_id:null},{data:E,error:N}=await v.from("game_rooms").insert(d).select().single();if(N){if(N.code==="23505")continue;throw new Error(N.message||"插入房間失敗")}if(E){r=E;break}}if(!r)throw new Error("無法生成唯一房間碼，請重試");const c={room_id:r.id,user_id:e.user.id,nickname:e.profile?.display_name||"房主",score:0};try{const{error:u}=await v.from("room_participants").insert(c);u&&console.error("創建參與記錄錯誤:",u)}catch(u){console.error("創建參與記錄時發生錯誤:",u)}try{const{data:u,error:d}=await v.from("room_participants").select("*").eq("room_id",r.id).order("joined_at",{ascending:!0});d?console.error("載入參與者列表失敗:",d):u&&(h.value=u)}catch(u){console.error("載入參與者列表時發生錯誤:",u)}return t.value=r,{success:!0,room:r}}catch(e){return a.value=e instanceof Error?e.message:"創建房間失敗",console.error("創建房間錯誤:",e),{success:!1,error:a.value}}finally{o.value=!1}}async function S(s,e){try{o.value=!0,a.value=null;const r=P();if(!r.user)throw new Error("請先登入");if(!/^\d{6}$/.test(s))throw new Error("房間碼必須是 6 位數字");if(!e||e.trim().length===0)throw new Error("請輸入暱稱");if(e.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:n,error:l}=await v.from("game_rooms").select("*").eq("code",s).single();if(l||!n)throw new Error("房間不存在");if(n.status!=="waiting")throw new Error("房間已開始或已結束");const{data:c}=await v.from("room_participants").select("*").eq("room_id",n.id).eq("user_id",r.user.id).maybeSingle();if(c)return t.value=n,await p(n.id),{success:!0,room:n};const{error:u}=await v.from("room_participants").insert({room_id:n.id,user_id:r.user.id,nickname:e.trim(),score:0});if(u){if(u.code==="23505"||u.message.includes("duplicate"))return t.value=n,await p(n.id),{success:!0,room:n};throw u}return t.value=n,await p(n.id),{success:!0,room:n}}catch(r){return a.value=r instanceof Error?r.message:"加入房間失敗",console.error("加入房間錯誤:",r),{success:!1,error:a.value}}finally{o.value=!1}}async function b(){try{if(!t.value)return{success:!0};o.value=!0,a.value=null;const s=P();if(!s.user)throw new Error("請先登入");const{error:e}=await v.from("room_participants").delete().eq("room_id",t.value.id).eq("user_id",s.user.id);if(e)throw new Error(`刪除參與記錄失敗: ${e.message||"未知錯誤"}`);if(g.value){const{error:r}=await v.from("game_rooms").update({status:"finished"}).eq("id",t.value.id);r&&console.error("關閉房間失敗:",r)}return t.value=null,h.value=[],{success:!0}}catch(s){return a.value=s instanceof Error?s.message:"離開房間失敗",console.error("離開房間錯誤:",s),t.value=null,h.value=[],{success:!1,error:a.value}}finally{o.value=!1}}async function p(s){try{const{data:e,error:r}=await v.from("room_participants").select("*").eq("room_id",s).order("joined_at",{ascending:!0});if(r)throw r;h.value=e||[]}catch(e){console.error("載入參與者錯誤:",e)}}async function i(s){try{o.value=!0,a.value=null;const{data:e,error:r}=await v.from("game_rooms").select("*").eq("id",s).single();if(r)throw r;return t.value=e,await p(s),{success:!0,room:e}}catch(e){return a.value=e instanceof Error?e.message:"載入房間失敗",console.error("載入房間錯誤:",e),{success:!1,error:a.value}}finally{o.value=!1}}async function w(s){try{if(!t.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:t.value.id,oldStatus:t.value.status,newStatus:s});const{error:e}=await v.from("game_rooms").update({status:s}).eq("id",t.value.id);if(e)throw e;if(t.value){const r=t.value.status;t.value.status=s,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:r,newStatus:t.value.status})}return{success:!0}}catch(e){return a.value=e instanceof Error?e.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",e),{success:!1,error:a.value}}}function m(){t.value=null,h.value=[],a.value=null}return{currentRoom:t,participants:h,loading:o,error:a,isHost:g,createRoom:y,joinRoom:S,leaveRoom:b,loadParticipants:p,loadRoom:i,updateRoomStatus:w,clearRoom:m}});function ae(){const t=$(),h=_(()=>t.currentRoom),o=_(()=>t.participants),a=_(()=>t.isHost),g=_(()=>!h.value||h.value.status!=="waiting"||!a.value?!1:o.value.length>=2);async function y(p){return await t.createRoom(p)}async function S(p,i){return await t.joinRoom(p,i)}async function b(){return await t.leaveRoom()}return{currentRoom:h,participants:o,isHost:a,canStartGame:g,loading:_(()=>t.loading),error:_(()=>t.error),createRoom:y,joinRoom:S,leaveRoom:b}}const K=100,V=50,z=10,J=100,Q=[1,.8,.6,.4,.2];function ce(){const t=$();function h(i){const w=Math.min(i,Q.length-1),m=Q[w]??0;return Math.round(K*m)}function o(i){return i===0?0:V+i*z}async function a(i,w){if(!t.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:m,error:s}=await v.from("room_participants").select("score").eq("room_id",t.currentRoom.id).eq("user_id",i).single();if(s)throw s;const e=(m?.score||0)+w,{error:r}=await v.from("room_participants").update({score:e}).eq("room_id",t.currentRoom.id).eq("user_id",i);if(r)throw r;const n=t.participants.findIndex(l=>l.user_id===i);return n!==-1&&t.participants[n]&&(t.participants[n].score=e),!0}catch(m){return console.error("更新玩家分數錯誤:",m),!1}}async function g(i,w){const m=o(w);return m===0?!0:await a(i,m)}function y(){if(!t.participants||t.participants.length===0)return null;const i=[...t.participants].sort((w,m)=>m.score-w.score);return i.length===1||i[0]&&i[1]&&i[0].score>i[1].score?{user_id:i[0]?.user_id||"",score:i[0]?.score||0}:{user_id:i[0]?.user_id||"",score:i[0]?.score||0}}const S=_(()=>!t.participants||t.participants.length===0?[]:[...t.participants].sort((w,m)=>m.score!==w.score?m.score-w.score:new Date(w.joined_at).getTime()-new Date(m.joined_at).getTime()).map((w,m)=>({id:w.id,user_id:w.user_id,score:w.score,rank:m+1}))),b=_(()=>t.currentRoom?.status!=="finished"?null:y());function p(){return J}return{GUESS_BASE_SCORE:K,DRAWING_BASE_SCORE:V,DRAWING_BONUS_PER_GUESS:z,WINNER_BONUS:J,calculateGuessScore:h,calculateDrawingScore:o,calculateWinner:y,updatePlayerScore:a,updateDrawerScore:g,playerRankings:S,winner:b,getWinnerBonus:p}}const Y=X("game",()=>{const t=$(),h=P(),o=k(null),a=k(null),g=k([]),y=_(()=>g.value.filter(e=>e.is_correct));async function S(e){try{const{data:r,error:n}=await v.from("game_rounds").select("*").eq("room_id",e).order("round_number",{ascending:!1}).limit(1).single();if(n&&n.code!=="PGRST116")throw n;return r&&(o.value=r,a.value=r.word_text,await b(r.id)),{success:!0,round:r}}catch(r){return console.error("載入當前輪次錯誤:",r),{success:!1,error:r instanceof Error?r.message:"載入輪次失敗"}}}async function b(e){try{const{data:r,error:n}=await v.from("guesses").select("*").eq("round_id",e).order("guessed_at",{ascending:!0});if(n)throw n;g.value=r||[]}catch(r){console.error("載入猜測記錄錯誤:",r)}}async function p(e,r,n,l){try{if(!t.currentRoom)throw new Error("沒有當前房間");const c=(t.currentRoom.current_round||0)+1,{data:u,error:d}=await v.from("game_rounds").insert({room_id:e,round_number:c,drawer_id:r,word_text:n,word_source:l}).select().single();if(d)throw d;return o.value=u,a.value=n,g.value=[],await v.from("game_rooms").update({current_round:c,current_drawer_id:r}).eq("id",e),{success:!0,round:u}}catch(c){return console.error("創建輪次錯誤:",c),{success:!1,error:c instanceof Error?c.message:"創建輪次失敗"}}}function i(e){return g.value.some(r=>r.user_id===e&&r.is_correct)}const w=_(()=>!o.value||!h.user?!1:o.value.drawer_id===h.user.id);async function m(){if(!o.value||!t.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const e=y.value.length,{updateDrawerScore:r}=ce();await r(o.value.drawer_id,e);const{error:n}=await v.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",o.value.id);if(n)throw n;return{success:!0}}catch(e){return console.error("結束輪次錯誤:",e),{success:!1,error:e instanceof Error?e.message:"結束輪次失敗"}}}function s(){o.value=null,a.value=null,g.value=[]}return{currentRound:o,currentWord:a,guesses:g,correctGuesses:y,isCurrentDrawer:w,loadCurrentRound:S,loadGuesses:b,createRound:p,hasGuessed:i,endRound:m,clearGame:s}});function ie(){const t=$(),h=Y(),o=k(null),a=k(!1);let g=null;const y=_(()=>t.currentRoom?.status||"waiting"),S=_(()=>y.value==="playing"),b=_(()=>y.value==="waiting"),p=_(()=>y.value==="finished"),i=_(()=>h.currentRound),w=_(()=>t.currentRoom?.current_round||0),m=_(()=>t.currentRoom?.settings.rounds||0),s=_(()=>t.currentRoom?.settings.draw_time||60),e=_(()=>h.isCurrentDrawer);function r(f){g&&clearInterval(g),o.value=f,a.value=!0,g=window.setInterval(()=>{o.value!==null&&o.value>0?o.value--:(n(),S.value&&i.value&&t.isHost&&d())},1e3)}function n(){g&&(clearInterval(g),g=null),a.value=!1}function l(){n(),o.value=null}async function c(){if(!t.currentRoom)return{success:!1,error:"沒有當前房間"};if(t.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(t.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const f=await t.updateRoomStatus("playing");return f.success?await u():f}catch(f){return console.error("開始遊戲錯誤:",f),{success:!1,error:f instanceof Error?f.message:"開始遊戲失敗"}}}async function u(){if(!t.currentRoom)return{success:!1,error:"沒有當前房間"};const f=t.currentRoom.words,G=t.currentRoom.current_round||0;if(G>=f.length||G>=m.value)return await E(),{success:!1,error:"所有輪次已完成"};try{const M=f[G],ee=G%t.participants.length,L=t.participants[ee];if(!L||!M)throw new Error("無法選擇畫家或詞語");const H=await h.createRound(t.currentRoom.id,L.user_id,M.text,M.source);return H.success&&H.round&&r(s.value),H}catch(M){return console.error("開始下一輪錯誤:",M),{success:!1,error:M instanceof Error?M.message:"開始下一輪失敗"}}}async function d(){if(!i.value||!t.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!t.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{n();const f=await h.endRound();return f.success?(t.currentRoom.current_round||0)>=m.value?(await E(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await u()},2e3),{success:!0,gameEnded:!1}):f}catch(f){return console.error("結束輪次錯誤:",f),{success:!1,error:f instanceof Error?f.message:"結束輪次失敗"}}}async function E(){if(!t.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await t.updateRoomStatus("finished"),{success:!0}}catch(f){return console.error("結束遊戲錯誤:",f),{success:!1,error:f instanceof Error?f.message:"結束遊戲失敗"}}}async function N(){if(!i.value||!t.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.value)return{success:!1,error:"只有畫家可以跳過詞語"};try{return n(),await u()}catch(f){return console.error("跳過詞語錯誤:",f),{success:!1,error:f instanceof Error?f.message:"跳過詞語失敗"}}}const Z=_(()=>{if(o.value===null)return"--:--";const f=Math.floor(o.value/60),G=o.value%60;return`${f.toString().padStart(2,"0")}:${G.toString().padStart(2,"0")}`});return re(()=>{n()}),{gameStatus:y,isPlaying:S,isWaiting:b,isFinished:p,currentRound:i,currentRoundNumber:w,totalRounds:m,drawTime:s,isCurrentDrawer:e,timeRemaining:o,isCountingDown:a,formattedTime:Z,startGame:c,startNextRound:u,endRound:d,endGame:E,skipWord:N,startCountdown:r,stopCountdown:n,resetCountdown:l}}const ue={class:"waiting-lobby"},le={class:"card"},de={class:"card-body"},fe={class:"margin-bottom-medium"},me={class:"card-title text-hand-title"},ge={class:"text-small"},we={style:{"font-family":"monospace"}},he={class:"text-small margin-top-small"},ve={class:"margin-bottom-medium"},_e={class:"text-hand-title"},pe={class:"margin-top-small"},Re={style:{"flex-shrink":"0","margin-right":"0.75rem"}},ye={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},be={style:{flex:"1"}},Se={class:"text-hand",style:{"font-weight":"500"}},Ee={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},xe={class:"margin-bottom-medium text-small"},ke=["disabled"],qe={key:1,class:"text-small text-center margin-bottom-small"},Ge=["disabled"],Te={key:0,class:"alert alert-danger margin-top-medium"},De=te({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(t,{emit:h}){const o=t,a=h,{isHost:g,canStartGame:y,leaveRoom:S,loading:b,error:p}=ae(),{startGame:i}=ie();function w(r){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[r||""]||r||"未知"}function m(r){return o.room?.host_id===r}async function s(){(await i()).success&&a("startGame")}async function e(){(await S()).success&&a("leaveRoom")}return(r,n)=>(C(),j("div",ue,[R("div",le,[R("div",de,[R("div",fe,[R("h2",me,x(t.room?.name),1),R("div",ge,[n[0]||(n[0]=F(" 房間碼：",-1)),R("span",we,x(t.room?.code),1)]),R("div",he," 狀態："+x(w(t.room?.status)),1)]),R("div",ve,[R("h4",_e,"玩家列表 ("+x(t.participants.length)+")",1),R("div",pe,[(C(!0),j(ne,null,oe(t.participants,l=>(C(),j("div",{key:l.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[R("div",Re,[R("div",ye,x(l.nickname.charAt(0).toUpperCase()),1)]),R("div",be,[R("div",Se,[F(x(l.nickname)+" ",1),m(l.user_id)?(C(),j("span",Ee," 房主 ")):I("",!0)])])]))),128))])]),R("div",xe,[R("div",null,"繪畫時間："+x(t.room?.settings.draw_time)+" 秒",1),R("div",null,"輪數："+x(t.room?.settings.rounds)+" 輪",1),R("div",null,"詞語總數："+x(t.room?.word_count)+" 個",1)]),R("div",null,[q(g)&&q(y)?(C(),j("button",{key:0,onClick:s,disabled:q(b),class:"paper-btn btn-primary btn-block margin-bottom-small"},x(q(b)?"開始中...":"開始遊戲"),9,ke)):q(g)?(C(),j("div",qe," 至少需要 2 個玩家才能開始遊戲 ")):I("",!0),R("button",{onClick:e,disabled:q(b),class:"paper-btn btn-secondary btn-block"},x(q(b)?"離開中...":"離開房間"),9,Ge)]),q(p)?(C(),j("div",Te,x(q(p)),1)):I("",!0)])])]))}}),Me=se(De,[["__scopeId","data-v-769c8ad1"]]),T=new Map,D=k("disconnected"),U=new Map,W=new Set,A=new Map;function O(...t){}function B(...t){console.warn("[Realtime]",...t)}function je(){const t=$(),h=Y();function o(e){const r=`room:${e}`;if(T.has(r))return T.get(r);const n=v.channel(r,{config:{presence:{key:"user"},broadcast:{self:!1}}});return T.set(r,n),n}function a(e){const r=A.get(e);r&&(clearTimeout(r),A.delete(e))}function g(e,r,n,l,c){e==="SUBSCRIBED"?(D.value="connected",a(n),r.track({user_id:l,...c}).catch(u=>{B("Presence track 失敗:",u)})):e==="CHANNEL_ERROR"||e==="TIMED_OUT"?(D.value="disconnected",B("訂閱失敗:",e),y(n,l,c)):e==="CLOSED"&&(D.value="disconnected")}function y(e,r,n,l=0){if(l>=3){B("重連失敗次數過多，停止重連");return}a(e);const c=Math.min(1e3*Math.pow(2,l),1e4),u=window.setTimeout(()=>{const d=T.get(`room:${e}`);d&&d.state!=="joined"&&d.subscribe(E=>{E==="SUBSCRIBED"?g(E,d,e,r,n):(E==="CHANNEL_ERROR"||E==="TIMED_OUT")&&y(e,r,n,l+1)})},c);A.set(e,u)}function S(e,r,n,l){if(!e||!r){B("缺少 roomCode 或 roomId");return}const c=o(e),u=c.state;return u==="joined"?(D.value="connected",c):u==="joining"?c:W.has(e)?(D.value="connecting",c.subscribe(d=>{g(d,c,e,n,l)}),c):(c.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${r}`},async d=>{O("房間狀態變化:",d.eventType),t.currentRoom&&await t.loadRoom(t.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${r}`},async d=>{O("參與者變化:",d.eventType),await t.loadParticipants(r)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${r}`},async d=>{O("輪次變化:",d.eventType),t.currentRoom&&await h.loadCurrentRound(t.currentRoom.id)}).on("broadcast",{event:"drawing"},d=>{const E=U.get(e);E&&d.payload?.stroke&&E.forEach(N=>N(d.payload.stroke))}).on("presence",{event:"sync"},()=>{const d=c.presenceState();O("Presence 同步，在線:",Object.keys(d).length)}),W.add(e),D.value="connecting",c.subscribe(d=>{g(d,c,e,n,l)}),c)}function b(e,r){return U.has(e)||U.set(e,new Set),U.get(e).add(r),()=>{U.get(e)?.delete(r)}}function p(e,r){const n=o(e),l=`guesses:${r}`;return n[l]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${r}`},async c=>{O("猜測記錄變化:",c.eventType),await h.loadGuesses(r)}),n[l]=!0),n}async function i(e,r){const n=o(e),l=n.state;if(l!=="joined")return B("Channel 未連接，狀態:",l),{error:"Channel 未連接"};try{const c=await n.send({type:"broadcast",event:"drawing",payload:{stroke:r}});return c==="error"?(B("發送失敗"),{error:"發送失敗"}):c}catch(c){return B("發送錯誤:",c),{error:c instanceof Error?c.message:"發送失敗"}}}function w(e){const r=`room:${e}`,n=T.get(r);a(e),n&&(v.removeChannel(n),T.delete(r)),U.delete(e),W.delete(e)}function m(){A.forEach((e,r)=>a(r)),T.forEach(e=>v.removeChannel(e)),T.clear(),U.clear(),W.clear()}function s(){return D.value}return{connectionStatus:D,subscribeRoom:S,subscribeDrawing:b,subscribeGuesses:p,sendDrawing:i,unsubscribeRoom:w,unsubscribeAll:m,getConnectionStatus:s}}export{Me as W,ie as a,je as b,$ as c,Y as d,ce as e,ae as u};
