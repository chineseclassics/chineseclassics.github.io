import{l as de,r as C,f as _,u as Y,x as p,m as ge,d as we,c as K,e as b,a as re,t as A,s as se,F as ve,p as he,b as j,o as F,_ as _e}from"./index-CWBVMItY.js";const X=de("room",()=>{const e=C(null),g=C([]),s=C(!1),u=C(null),w=_(()=>{const r=Y();return e.value?.host_id===r.user?.id});async function S(r){try{s.value=!0,u.value=null;const t=Y();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(c){console.warn("載入用戶資料時發生錯誤（非關鍵）:",c)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");if(r.settings.rounds>r.words.length)throw new Error("輪數不能超過詞語總數");let n=null,a=0;const l=10;for(;a<l&&!n;){a++;const I={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:d,error:E}=await p.from("game_rooms").insert(I).select().single();if(E){if(E.code==="23505")continue;throw new Error(E.message||"插入房間失敗")}if(d){n=d;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const N={room_id:n.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:c}=await p.from("room_participants").insert(N);c&&console.error("創建參與記錄錯誤:",c)}catch(c){console.error("創建參與記錄時發生錯誤:",c)}try{const{data:c,error:I}=await p.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});I?console.error("載入參與者列表失敗:",I):c&&(g.value=c)}catch(c){console.error("載入參與者列表時發生錯誤:",c)}return e.value=n,{success:!0,room:n}}catch(t){return u.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:u.value}}finally{s.value=!1}}async function x(r,t){try{s.value=!0,u.value=null;const n=Y();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:a,error:l}=await p.from("game_rooms").select("*").eq("code",r).single();if(l||!a)throw new Error("房間不存在");if(a.status!=="waiting")throw new Error("房間已開始或已結束");const{data:N}=await p.from("room_participants").select("*").eq("room_id",a.id).eq("user_id",n.user.id).maybeSingle();if(N)return e.value=a,await h(a.id),{success:!0,room:a};const{error:c}=await p.from("room_participants").insert({room_id:a.id,user_id:n.user.id,nickname:t.trim(),score:0});if(c){if(c.code==="23505"||c.message.includes("duplicate"))return e.value=a,await h(a.id),{success:!0,room:a};throw c}return e.value=a,await h(a.id),{success:!0,room:a}}catch(n){return u.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:u.value}}finally{s.value=!1}}async function G(){try{if(!e.value)return{success:!0};s.value=!0,u.value=null;const r=Y();if(!r.user)throw new Error("請先登入");const{error:t}=await p.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(w.value){const{error:n}=await p.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,g.value=[],{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,g.value=[],{success:!1,error:u.value}}finally{s.value=!1}}async function h(r){try{const{data:t,error:n}=await p.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(n)throw n;g.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function i(r){try{s.value=!0,u.value=null;const{data:t,error:n}=await p.from("game_rooms").select("*").eq("id",r).single();if(n)throw n;return e.value=t,await h(r),{success:!0,room:t}}catch(t){return u.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:u.value}}finally{s.value=!1}}async function m(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await p.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(e.value){const n=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:u.value}}}async function R(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await p.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:u.value}}}function q(){e.value=null,g.value=[],u.value=null}function P(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function k(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!w.value)return{success:!1,error:"只有房主可以踢人"};const t=Y();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};s.value=!0,u.value=null;const{data:n,error:a}=await p.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(a)throw new Error(a.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await h(e.value.id),{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:u.value}}finally{s.value=!1}}return{currentRoom:e,participants:g,loading:s,error:u,isHost:w,createRoom:S,joinRoom:x,leaveRoom:G,kickPlayer:k,loadParticipants:h,loadRoom:i,updateRoomStatus:m,updateRoomDrawer:R,setCurrentDrawer:P,clearRoom:q}});function pe(){const e=X(),g=_(()=>e.currentRoom),s=_(()=>e.participants),u=_(()=>e.isHost),w=_(()=>!g.value||g.value.status!=="waiting"||!u.value?!1:s.value.length>=2);async function S(h){return await e.createRoom(h)}async function x(h,i){return await e.joinRoom(h,i)}async function G(){return await e.leaveRoom()}return{currentRoom:g,participants:s,isHost:u,canStartGame:w,loading:_(()=>e.loading),error:_(()=>e.error),createRoom:S,joinRoom:x,leaveRoom:G}}const ae=100,ce=50,ue=10,ie=100,le=[1,.8,.6,.4,.2];function Re(){const e=X();function g(i){const m=Math.min(i,le.length-1),R=le[m]??0;return Math.round(ae*R)}function s(i){return i===0?0:ce+i*ue}async function u(i,m){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:R,error:q}=await p.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",i).single();if(q)throw q;const P=(R?.score||0)+m,{error:k}=await p.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",i);if(k)throw k;const r=e.participants.findIndex(t=>t.user_id===i);return r!==-1&&e.participants[r]&&(e.participants[r].score=P),!0}catch(R){return console.error("更新玩家分數錯誤:",R),!1}}async function w(i,m){const R=s(m);return R===0?!0:await u(i,R)}function S(){if(!e.participants||e.participants.length===0)return null;const i=[...e.participants].sort((m,R)=>R.score-m.score);return i.length===1||i[0]&&i[1]&&i[0].score>i[1].score?{user_id:i[0]?.user_id||"",score:i[0]?.score||0}:{user_id:i[0]?.user_id||"",score:i[0]?.score||0}}const x=_(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((m,R)=>R.score!==m.score?R.score-m.score:new Date(m.joined_at).getTime()-new Date(R.joined_at).getTime()).map((m,R)=>({id:m.id,user_id:m.user_id,score:m.score,rank:R+1}))),G=_(()=>e.currentRoom?.status!=="finished"?null:S());function h(){return ie}return{GUESS_BASE_SCORE:ae,DRAWING_BASE_SCORE:ce,DRAWING_BONUS_PER_GUESS:ue,WINNER_BONUS:ie,calculateGuessScore:g,calculateDrawingScore:s,calculateWinner:S,updatePlayerScore:u,updateDrawerScore:w,playerRankings:x,winner:G,getWinnerBonus:h}}const fe=de("game",()=>{const e=X(),g=Y(),s=C(null),u=C(null),w=C([]),S=_(()=>w.value.filter(f=>f.is_correct)),x=_(()=>s.value?w.value.filter(f=>f.round_id===s.value.id):[]),G=_(()=>x.value.filter(f=>f.is_correct)),h=C("drawing"),i=C([]),m=C([]),R=_(()=>m.value.length===0?0:m.value.reduce((o,y)=>o+y.rating,0)/m.value.length);function q(f){h.value=f}function P(f){i.value=f}function k(f){const o=m.value.findIndex(y=>y.rater_id===f.rater_id);o>=0?m.value[o]=f:m.value.push(f)}function r(){m.value=[]}async function t(f){try{const{data:o,error:y}=await p.from("game_rounds").select("*").eq("room_id",f).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(y)throw y;if(o){if(s.value=o,u.value=o.word_text,o.status){const D=h.value==="selecting",T=o.status==="completed";D&&T||(h.value=o.status)}o.word_options&&Array.isArray(o.word_options)&&(i.value=o.word_options),await n(o.id)}return{success:!0,round:o}}catch(o){return console.error("載入當前輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入輪次失敗"}}}async function n(f){try{const{data:o,error:y}=await p.from("guesses").select("*").eq("round_id",f).order("guessed_at",{ascending:!0});if(y)throw y;const D=o||[],T=new Set(w.value.map(H=>H.id)),O=D.filter(H=>!T.has(H.id));O.length>0&&(w.value=[...w.value,...O])}catch(o){console.error("載入猜測記錄錯誤:",o)}}async function a(f){try{const{data:o,error:y}=await p.from("game_rounds").select("id").eq("room_id",f);if(y)throw y;if(!o||o.length===0){w.value=[];return}const D=o.map(H=>H.id),{data:T,error:O}=await p.from("guesses").select("*").in("round_id",D).order("guessed_at",{ascending:!0});if(O)throw O;w.value=T||[]}catch(o){console.error("載入所有猜測記錄錯誤:",o)}}async function l(f,o,y,D){try{if(!e.currentRoom)throw new Error("沒有當前房間");const T=(e.currentRoom.current_round||0)+1,{data:O,error:H}=await p.from("game_rounds").insert({room_id:f,round_number:T,drawer_id:o,word_text:y,word_source:D}).select().single();if(H)throw H;return s.value=O,u.value=y,await p.from("game_rooms").update({current_round:T,current_drawer_id:o}).eq("id",f),{success:!0,round:O}}catch(T){return console.error("創建輪次錯誤:",T),{success:!1,error:T instanceof Error?T.message:"創建輪次失敗"}}}function N(f){return s.value?w.value.some(o=>o.round_id===s.value.id&&o.user_id===f&&o.is_correct):!1}const c=_(()=>!s.value||!g.user?!1:s.value.drawer_id===g.user.id);async function I(){if(!s.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const f=S.value.length,{updateDrawerScore:o}=Re();await o(s.value.drawer_id,f);const{error:y}=await p.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",s.value.id);if(y)throw y;return{success:!0}}catch(f){return console.error("結束輪次錯誤:",f),{success:!1,error:f instanceof Error?f.message:"結束輪次失敗"}}}function d(){s.value=null,u.value=null,w.value=[],h.value="drawing",i.value=[],m.value=[]}async function E(f,o,y){if(!g.user)return{success:!1,error:"用戶未登錄"};try{const{data:D,error:T}=await p.from("drawing_ratings").upsert({round_id:f,rater_id:g.user.id,drawer_id:o,rating:y},{onConflict:"round_id,rater_id"}).select().single();if(T)throw T;return D&&k(D),{success:!0,rating:D}}catch(D){return console.error("提交評分錯誤:",D),{success:!1,error:D instanceof Error?D.message:"提交評分失敗"}}}async function J(f){try{const{data:o,error:y}=await p.from("drawing_ratings").select("*").eq("round_id",f);if(y)throw y;return m.value=o||[],{success:!0,ratings:o}}catch(o){return console.error("載入評分錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入評分失敗"}}}return{currentRound:s,currentWord:u,guesses:w,correctGuesses:S,currentRoundGuesses:x,currentRoundCorrectGuesses:G,isCurrentDrawer:c,roundStatus:h,wordOptions:i,ratings:m,averageRating:R,loadCurrentRound:t,loadGuesses:n,loadAllGuesses:a,createRound:l,hasGuessed:N,endRound:I,clearGame:d,setRoundStatus:q,setWordOptions:P,addRating:k,clearRatings:r,submitRating:E,loadRatings:J}}),W=new Map,L=C("disconnected"),V=new Map,Z=new Set,ee=new Map;function z(...e){}function $(...e){console.warn("[Realtime]",...e)}function te(){const e=X(),g=fe();function s(r){const t=`room:${r}`;if(W.has(t))return W.get(t);const n=p.channel(t,{config:{presence:{key:"user"},broadcast:{self:!1}}});return W.set(t,n),n}function u(r){const t=ee.get(r);t&&(clearTimeout(t),ee.delete(r))}function w(r,t,n,a,l){r==="SUBSCRIBED"?(L.value="connected",u(n),t.track({user_id:a,...l}).catch(N=>{$("Presence track 失敗:",N)})):r==="CHANNEL_ERROR"||r==="TIMED_OUT"?(L.value="disconnected",$("訂閱失敗:",r),S(n,a,l)):r==="CLOSED"&&(L.value="disconnected")}function S(r,t,n,a=0){if(a>=3){$("重連失敗次數過多，停止重連");return}u(r);const l=Math.min(1e3*Math.pow(2,a),1e4),N=window.setTimeout(()=>{const c=W.get(`room:${r}`);c&&c.state!=="joined"&&c.subscribe(I=>{I==="SUBSCRIBED"?w(I,c,r,t,n):(I==="CHANNEL_ERROR"||I==="TIMED_OUT")&&S(r,t,n,a+1)})},l);ee.set(r,N)}function x(r,t,n,a){return new Promise((l,N)=>{if(!r||!t){$("缺少 roomCode 或 roomId"),N(new Error("缺少 roomCode 或 roomId"));return}const c=s(r),I=c.state;if(I==="joined"){L.value="connected",l(c);return}if(I==="joining"){const d=setInterval(()=>{const E=c.state;E==="joined"?(clearInterval(d),l(c)):(E==="closed"||E==="errored")&&(clearInterval(d),N(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(d),c.state!=="joined"&&N(new Error("連接超時"))},5e3);return}if(Z.has(r)){L.value="connecting",c.subscribe(d=>{w(d,c,r,n,a),d==="SUBSCRIBED"?l(c):(d==="CHANNEL_ERROR"||d==="TIMED_OUT")&&N(new Error(`訂閱失敗: ${d}`))});return}c.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async d=>{z("房間狀態變化:",d.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async d=>{z("參與者變化:",d.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async d=>{z("輪次變化:",d.eventType,d.new),e.currentRoom&&await g.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async d=>{const E=d.new;E&&g.currentRound&&await g.loadGuesses(E.round_id)}).on("broadcast",{event:"drawing"},d=>{const E=V.get(r);E&&d.payload?.stroke&&E.forEach(J=>J(d.payload.stroke))}).on("presence",{event:"sync"},()=>{const d=c.presenceState();z("Presence 同步，在線:",Object.keys(d).length)}),Z.add(r),L.value="connecting",c.subscribe(d=>{w(d,c,r,n,a),d==="SUBSCRIBED"?l(c):(d==="CHANNEL_ERROR"||d==="TIMED_OUT")&&N(new Error(`訂閱失敗: ${d}`))})})}function G(r,t){return V.has(r)||V.set(r,new Set),V.get(r).add(t),()=>{V.get(r)?.delete(t)}}function h(r,t){const n=s(r),a=`guesses:${t}`;return n[a]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${t}`},async l=>{z("收到新猜測記錄:",l.eventType,l.new),await g.loadGuesses(t)}),n[a]=!0),n}function i(r,t){const n=s(r),a=`gameState:${r}`;return n[a]||(n.on("broadcast",{event:"game_state"},l=>{z("收到遊戲狀態廣播:",l.payload),t(l.payload)}),n[a]=!0),n}async function m(r,t){const n=s(r),a=n.state;if(a!=="joined")return $("Channel 未連接，狀態:",a,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{z("廣播遊戲狀態:",t);const l=await n.send({type:"broadcast",event:"game_state",payload:t});return l==="error"?($("發送遊戲狀態失敗"),{error:"發送失敗"}):l}catch(l){return $("發送遊戲狀態錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}async function R(r,t){const n=s(r),a=n.state;if(a!=="joined")return $("Channel 未連接，無法發送繪畫數據，狀態:",a),{error:"Channel 未連接"};try{const l=await n.send({type:"broadcast",event:"drawing",payload:{stroke:t}});return l==="error"?($("發送失敗"),{error:"發送失敗"}):l}catch(l){return $("發送錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}function q(r){const t=`room:${r}`,n=W.get(t);u(r),n&&(p.removeChannel(n),W.delete(t)),V.delete(r),Z.delete(r)}function P(){ee.forEach((r,t)=>u(t)),W.forEach(r=>p.removeChannel(r)),W.clear(),V.clear(),Z.clear()}function k(){return L.value}return{connectionStatus:L,subscribeRoom:x,subscribeDrawing:G,subscribeGuesses:h,subscribeGameState:i,sendDrawing:R,broadcastGameState:m,unsubscribeRoom:q,unsubscribeAll:P,getConnectionStatus:k}}const ne=3;function ye(){const e=X(),g=fe();te();const s=C(null),u=C(!1);let w=null;const S=C(null);let x=null;const G=C(new Set),h=_(()=>e.currentRoom?.status||"waiting"),i=_(()=>h.value==="playing"),m=_(()=>h.value==="waiting"),R=_(()=>h.value==="finished"),q=_(()=>g.roundStatus),P=_(()=>q.value==="drawing"),k=_(()=>q.value==="summary"),r=_(()=>g.currentRound),t=_(()=>e.currentRoom?.current_round||0),n=_(()=>e.currentRoom?.settings.rounds||0),a=_(()=>e.currentRoom?.settings.draw_time||60),l=_(()=>g.isCurrentDrawer);function N(v){w&&clearInterval(w),s.value=v,u.value=!0,w=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(c(),i.value&&r.value&&e.isHost&&D())},1e3)}function c(){w&&(clearInterval(w),w=null),u.value=!1}function I(){c(),s.value=null}function d(){x&&clearInterval(x),S.value=ne,console.log("[useGame] 開始總結倒計時:",ne,"秒"),x=window.setInterval(async()=>{S.value!==null&&S.value>0?S.value--:(E(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await T()))},1e3)}function E(){x&&(clearInterval(x),x=null),S.value=null}function J(){if(!e.currentRoom)return null;const v=e.currentRoom.words;if(v.length===0)return null;const U=[];for(let M=0;M<v.length;M++)G.value.has(M)||U.push(M);let B=0;if(U.length>0){const M=Math.floor(Math.random()*U.length);B=U[M]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),G.value.clear(),B=Math.floor(Math.random()*v.length);return G.value.add(B),v[B]??null}async function f(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{G.value.clear();const v=await e.updateRoomStatus("playing");return v.success?await o():v}catch(v){return console.error("開始遊戲錯誤:",v),{success:!1,error:v instanceof Error?v.message:"開始遊戲失敗"}}}async function o(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const v=e.currentRoom.current_round||0,U=v+1;if(v>=n.value)return await O(),{success:!1,error:"所有輪次已完成"};try{const B=(U-1)%e.participants.length,M=e.participants[B];if(console.log("[startDrawingPhase] 第",U,"輪，畫家:",M?.nickname),!M)throw new Error("無法選擇畫家");const Q=J();if(!Q)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",Q.text),await e.updateRoomDrawer(M.user_id);const oe=await g.createRound(e.currentRoom.id,M.user_id,Q.text,Q.source);if(!oe.success||!oe.round)throw new Error("創建輪次失敗");g.setRoundStatus("drawing"),g.clearRatings();const{broadcastGameState:me}=te();return await me(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:M.user_id,drawerName:M.nickname,roundNumber:U}),N(a.value),{success:!0,drawerId:M.user_id,word:Q.text}}catch(B){return console.error("開始繪畫階段錯誤:",B),{success:!1,error:B instanceof Error?B.message:"開始繪畫階段失敗"}}}async function y(){return await o()}async function D(){if(!r.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{c();const v=await g.endRound();if(!v.success)return v;g.setRoundStatus("summary");const{broadcastGameState:U}=te();return await U(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0}),(e.currentRoom.current_round||0)>=n.value?(setTimeout(async()=>{await O()},ne*1e3),{success:!0,gameEnded:!0}):(d(),{success:!0,gameEnded:!1})}catch(v){return console.error("結束輪次錯誤:",v),{success:!1,error:v instanceof Error?v.message:"結束輪次失敗"}}}async function T(){return e.currentRoom?(E(),(e.currentRoom.current_round||0)>=n.value?(await O(),{success:!0,gameEnded:!0}):(await o(),{success:!0,gameEnded:!1})):{success:!1,error:"沒有當前房間"}}async function O(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return c(),await e.updateRoomStatus("finished"),{success:!0}}catch(v){return console.error("結束遊戲錯誤:",v),{success:!1,error:v instanceof Error?v.message:"結束遊戲失敗"}}}const H=_(()=>{if(s.value===null)return"--:--";const v=Math.floor(s.value/60),U=s.value%60;return`${v.toString().padStart(2,"0")}:${U.toString().padStart(2,"0")}`});return ge(()=>{c(),E()}),{gameStatus:h,isPlaying:i,isWaiting:m,isFinished:R,currentRound:r,currentRoundNumber:t,totalRounds:n,drawTime:a,isCurrentDrawer:l,timeRemaining:s,isCountingDown:u,formattedTime:H,roundStatus:q,isDrawing:P,isSummary:k,summaryTimeRemaining:S,startGame:f,startNextRound:y,startDrawingPhase:o,endRound:D,continueToNextRound:T,endGame:O,startCountdown:N,stopCountdown:c,startSummaryCountdown:d,stopSummaryCountdown:E,resetCountdown:I}}const Se={class:"waiting-lobby"},Ee={class:"card"},be={class:"card-body"},xe={class:"margin-bottom-medium"},Ge={class:"card-title text-hand-title"},ke={class:"text-small"},Ne={style:{"font-family":"monospace"}},De={class:"text-small margin-top-small"},Te={class:"margin-bottom-medium"},Ie={class:"text-hand-title"},qe={class:"margin-top-small"},Ce={style:{"flex-shrink":"0","margin-right":"0.75rem"}},Me={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},Oe={style:{flex:"1"}},Ue={class:"text-hand",style:{"font-weight":"500"}},Pe={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},Ae={class:"margin-bottom-medium text-small"},Be=["disabled"],He={key:1,class:"text-small text-center margin-bottom-small"},$e=["disabled"],je={key:0,class:"alert alert-danger margin-top-medium"},We=we({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:g}){const s=e,u=g,{isHost:w,canStartGame:S,leaveRoom:x,loading:G,error:h}=pe(),{startGame:i}=ye();function m(k){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[k||""]||k||"未知"}function R(k){return s.room?.host_id===k}async function q(){(await i()).success&&u("startGame")}async function P(){(await x()).success&&u("leaveRoom")}return(k,r)=>(F(),K("div",Se,[b("div",Ee,[b("div",be,[b("div",xe,[b("h2",Ge,A(e.room?.name),1),b("div",ke,[r[0]||(r[0]=se(" 房間碼：",-1)),b("span",Ne,A(e.room?.code),1)]),b("div",De," 狀態："+A(m(e.room?.status)),1)]),b("div",Te,[b("h4",Ie,"玩家列表 ("+A(e.participants.length)+")",1),b("div",qe,[(F(!0),K(ve,null,he(e.participants,t=>(F(),K("div",{key:t.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[b("div",Ce,[b("div",Me,A(t.nickname.charAt(0).toUpperCase()),1)]),b("div",Oe,[b("div",Ue,[se(A(t.nickname)+" ",1),R(t.user_id)?(F(),K("span",Pe," 房主 ")):re("",!0)])])]))),128))])]),b("div",Ae,[b("div",null,"繪畫時間："+A(e.room?.settings.draw_time)+" 秒",1),b("div",null,"輪數："+A(e.room?.settings.rounds)+" 輪",1),b("div",null,"詞語總數："+A(e.room?.word_count)+" 個",1)]),b("div",null,[j(w)&&j(S)?(F(),K("button",{key:0,onClick:q,disabled:j(G),class:"paper-btn btn-primary btn-block margin-bottom-small"},A(j(G)?"開始中...":"開始遊戲"),9,Be)):j(w)?(F(),K("div",He," 至少需要 2 個玩家才能開始遊戲 ")):re("",!0),b("button",{onClick:P,disabled:j(G),class:"paper-btn btn-secondary btn-block"},A(j(G)?"離開中...":"離開房間"),9,$e)]),j(h)?(F(),K("div",je,A(j(h)),1)):re("",!0)])])]))}}),Ke=_e(We,[["__scopeId","data-v-769c8ad1"]]);export{Ke as W,ye as a,te as b,X as c,fe as d,Re as e,pe as u};
