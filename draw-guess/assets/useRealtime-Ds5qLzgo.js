import{l as X,r as G,f as p,u as P,x as _,m as te,d as ne,c as M,e as y,a as L,t as x,s as F,F as oe,p as se,b as D,o as j,_ as ae}from"./index-D0J_V9w0.js";const $=X("room",()=>{const t=G(null),f=G([]),i=G(!1),o=G(null),w=p(()=>{const s=P();return t.value?.host_id===s.user?.id});async function v(s){try{i.value=!0,o.value=null;const e=P();if(!e.user)throw new Error("請先登入");if(!e.profile&&e.user)try{await e.loadUserProfile(e.user.id,!1)}catch(m){console.warn("載入用戶資料時發生錯誤（非關鍵）:",m)}if(s.words.length<6)throw new Error("至少需要 6 個詞語");if(s.settings.rounds>s.words.length)throw new Error("輪數不能超過詞語總數");let r=null,n=0;const c=10;for(;n<c&&!r;){n++;const l={code:Math.floor(1e5+Math.random()*9e5).toString(),name:s.name,host_id:e.user.id,words:s.words,word_count:s.words.length,status:"waiting",settings:s.settings,current_round:0,current_drawer_id:null},{data:E,error:q}=await _.from("game_rooms").insert(l).select().single();if(q){if(q.code==="23505")continue;throw new Error(q.message||"插入房間失敗")}if(E){r=E;break}}if(!r)throw new Error("無法生成唯一房間碼，請重試");const a={room_id:r.id,user_id:e.user.id,nickname:e.profile?.display_name||"房主",score:0};try{const{error:m}=await _.from("room_participants").insert(a);m&&console.error("創建參與記錄錯誤:",m)}catch(m){console.error("創建參與記錄時發生錯誤:",m)}try{const{data:m,error:l}=await _.from("room_participants").select("*").eq("room_id",r.id).order("joined_at",{ascending:!0});l?console.error("載入參與者列表失敗:",l):m&&(f.value=m)}catch(m){console.error("載入參與者列表時發生錯誤:",m)}return t.value=r,{success:!0,room:r}}catch(e){return o.value=e instanceof Error?e.message:"創建房間失敗",console.error("創建房間錯誤:",e),{success:!1,error:o.value}}finally{i.value=!1}}async function S(s,e){try{i.value=!0,o.value=null;const r=P();if(!r.user)throw new Error("請先登入");if(!/^\d{6}$/.test(s))throw new Error("房間碼必須是 6 位數字");if(!e||e.trim().length===0)throw new Error("請輸入暱稱");if(e.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:n,error:c}=await _.from("game_rooms").select("*").eq("code",s).single();if(c||!n)throw new Error("房間不存在");if(n.status!=="waiting")throw new Error("房間已開始或已結束");const{data:a}=await _.from("room_participants").select("*").eq("room_id",n.id).eq("user_id",r.user.id).maybeSingle();if(a)return t.value=n,await R(n.id),{success:!0,room:n};const{error:m}=await _.from("room_participants").insert({room_id:n.id,user_id:r.user.id,nickname:e.trim(),score:0});if(m){if(m.code==="23505"||m.message.includes("duplicate"))return t.value=n,await R(n.id),{success:!0,room:n};throw m}return t.value=n,await R(n.id),{success:!0,room:n}}catch(r){return o.value=r instanceof Error?r.message:"加入房間失敗",console.error("加入房間錯誤:",r),{success:!1,error:o.value}}finally{i.value=!1}}async function b(){try{if(!t.value)return{success:!0};i.value=!0,o.value=null;const s=P();if(!s.user)throw new Error("請先登入");const{error:e}=await _.from("room_participants").delete().eq("room_id",t.value.id).eq("user_id",s.user.id);if(e)throw new Error(`刪除參與記錄失敗: ${e.message||"未知錯誤"}`);if(w.value){const{error:r}=await _.from("game_rooms").update({status:"finished"}).eq("id",t.value.id);r&&console.error("關閉房間失敗:",r)}return t.value=null,f.value=[],{success:!0}}catch(s){return o.value=s instanceof Error?s.message:"離開房間失敗",console.error("離開房間錯誤:",s),t.value=null,f.value=[],{success:!1,error:o.value}}finally{i.value=!1}}async function R(s){try{const{data:e,error:r}=await _.from("room_participants").select("*").eq("room_id",s).order("joined_at",{ascending:!0});if(r)throw r;f.value=e||[]}catch(e){console.error("載入參與者錯誤:",e)}}async function u(s){try{i.value=!0,o.value=null;const{data:e,error:r}=await _.from("game_rooms").select("*").eq("id",s).single();if(r)throw r;return t.value=e,await R(s),{success:!0,room:e}}catch(e){return o.value=e instanceof Error?e.message:"載入房間失敗",console.error("載入房間錯誤:",e),{success:!1,error:o.value}}finally{i.value=!1}}async function d(s){try{if(!t.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:t.value.id,oldStatus:t.value.status,newStatus:s});const{error:e}=await _.from("game_rooms").update({status:s}).eq("id",t.value.id);if(e)throw e;if(t.value){const r=t.value.status;t.value.status=s,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:r,newStatus:t.value.status})}return{success:!0}}catch(e){return o.value=e instanceof Error?e.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",e),{success:!1,error:o.value}}}function g(){t.value=null,f.value=[],o.value=null}return{currentRoom:t,participants:f,loading:i,error:o,isHost:w,createRoom:v,joinRoom:S,leaveRoom:b,loadParticipants:R,loadRoom:u,updateRoomStatus:d,clearRoom:g}});function ce(){const t=$(),f=p(()=>t.currentRoom),i=p(()=>t.participants),o=p(()=>t.isHost),w=p(()=>!f.value||f.value.status!=="waiting"||!o.value?!1:i.value.length>=2);async function v(R){return await t.createRoom(R)}async function S(R,u){return await t.joinRoom(R,u)}async function b(){return await t.leaveRoom()}return{currentRoom:f,participants:i,isHost:o,canStartGame:w,loading:p(()=>t.loading),error:p(()=>t.error),createRoom:v,joinRoom:S,leaveRoom:b}}const K=100,V=50,z=10,J=100,Q=[1,.8,.6,.4,.2];function Y(){const t=$();function f(u){const d=Math.min(u,Q.length-1),g=Q[d]??0;return Math.round(K*g)}function i(u){return u===0?0:V+u*z}async function o(u,d){if(!t.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:g,error:s}=await _.from("room_participants").select("score").eq("room_id",t.currentRoom.id).eq("user_id",u).single();if(s)throw s;const e=(g?.score||0)+d,{error:r}=await _.from("room_participants").update({score:e}).eq("room_id",t.currentRoom.id).eq("user_id",u);if(r)throw r;const n=t.participants.findIndex(c=>c.user_id===u);return n!==-1&&t.participants[n]&&(t.participants[n].score=e),!0}catch(g){return console.error("更新玩家分數錯誤:",g),!1}}async function w(u,d){const g=i(d);return g===0?!0:await o(u,g)}function v(){if(!t.participants||t.participants.length===0)return null;const u=[...t.participants].sort((d,g)=>g.score-d.score);return u.length===1||u[0]&&u[1]&&u[0].score>u[1].score?{user_id:u[0]?.user_id||"",score:u[0]?.score||0}:{user_id:u[0]?.user_id||"",score:u[0]?.score||0}}const S=p(()=>!t.participants||t.participants.length===0?[]:[...t.participants].sort((d,g)=>g.score!==d.score?g.score-d.score:new Date(d.joined_at).getTime()-new Date(g.joined_at).getTime()).map((d,g)=>({id:d.id,user_id:d.user_id,score:d.score,rank:g+1}))),b=p(()=>t.currentRoom?.status!=="finished"?null:v());function R(){return J}return{GUESS_BASE_SCORE:K,DRAWING_BASE_SCORE:V,DRAWING_BONUS_PER_GUESS:z,WINNER_BONUS:J,calculateGuessScore:f,calculateDrawingScore:i,calculateWinner:v,updatePlayerScore:o,updateDrawerScore:w,playerRankings:S,winner:b,getWinnerBonus:R}}const Z=X("game",()=>{const t=$(),f=P(),i=G(null),o=G(null),w=G([]),v=p(()=>w.value.filter(e=>e.is_correct));async function S(e){try{const{data:r,error:n}=await _.from("game_rounds").select("*").eq("room_id",e).order("round_number",{ascending:!1}).limit(1).single();if(n&&n.code!=="PGRST116")throw n;return r&&(i.value=r,o.value=r.word_text,await b(r.id)),{success:!0,round:r}}catch(r){return console.error("載入當前輪次錯誤:",r),{success:!1,error:r instanceof Error?r.message:"載入輪次失敗"}}}async function b(e){try{const{data:r,error:n}=await _.from("guesses").select("*").eq("round_id",e).order("guessed_at",{ascending:!0});if(n)throw n;w.value=r||[]}catch(r){console.error("載入猜測記錄錯誤:",r)}}async function R(e,r,n,c){try{if(!t.currentRoom)throw new Error("沒有當前房間");const a=(t.currentRoom.current_round||0)+1,{data:m,error:l}=await _.from("game_rounds").insert({room_id:e,round_number:a,drawer_id:r,word_text:n,word_source:c}).select().single();if(l)throw l;return i.value=m,o.value=n,w.value=[],await _.from("game_rooms").update({current_round:a,current_drawer_id:r}).eq("id",e),{success:!0,round:m}}catch(a){return console.error("創建輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"創建輪次失敗"}}}function u(e){return w.value.some(r=>r.user_id===e&&r.is_correct)}const d=p(()=>!i.value||!f.user?!1:i.value.drawer_id===f.user.id);async function g(){if(!i.value||!t.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const e=v.value.length,{updateDrawerScore:r}=Y();await r(i.value.drawer_id,e);const{error:n}=await _.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",i.value.id);if(n)throw n;return{success:!0}}catch(e){return console.error("結束輪次錯誤:",e),{success:!1,error:e instanceof Error?e.message:"結束輪次失敗"}}}function s(){i.value=null,o.value=null,w.value=[]}return{currentRound:i,currentWord:o,guesses:w,correctGuesses:v,isCurrentDrawer:d,loadCurrentRound:S,loadGuesses:b,createRound:R,hasGuessed:u,endRound:g,clearGame:s}});function ie(){const t=$(),f=Z(),{updateDrawerScore:i}=Y(),o=G(null),w=G(!1);let v=null;const S=p(()=>t.currentRoom?.status||"waiting"),b=p(()=>S.value==="playing"),R=p(()=>S.value==="waiting"),u=p(()=>S.value==="finished"),d=p(()=>f.currentRound),g=p(()=>t.currentRoom?.current_round||0),s=p(()=>t.currentRoom?.settings.rounds||0),e=p(()=>t.currentRoom?.settings.draw_time||60),r=p(()=>f.isCurrentDrawer);function n(h){v&&clearInterval(v),o.value=h,w.value=!0,v=window.setInterval(()=>{o.value!==null&&o.value>0?o.value--:(c(),b.value&&d.value&&E())},1e3)}function c(){v&&(clearInterval(v),v=null),w.value=!1}function a(){c(),o.value=null}async function m(){if(!t.currentRoom)return{success:!1,error:"沒有當前房間"};if(t.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(t.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const h=await t.updateRoomStatus("playing");return h.success?await l():h}catch(h){return console.error("開始遊戲錯誤:",h),{success:!1,error:h instanceof Error?h.message:"開始遊戲失敗"}}}async function l(){if(!t.currentRoom)return{success:!1,error:"沒有當前房間"};const h=t.currentRoom.words,k=t.currentRoom.current_round||0;if(k>=h.length||k>=s.value)return await q(),{success:!1,error:"所有輪次已完成"};try{const T=h[k],re=k%t.participants.length,H=t.participants[re];if(!H||!T)throw new Error("無法選擇畫家或詞語");const I=await f.createRound(t.currentRoom.id,H.user_id,T.text,T.source);return I.success&&I.round&&n(e.value),I}catch(T){return console.error("開始下一輪錯誤:",T),{success:!1,error:T instanceof Error?T.message:"開始下一輪失敗"}}}async function E(){if(!d.value||!t.currentRoom)return{success:!1,error:"沒有當前輪次"};try{c();const h=f.correctGuesses.length;await i(d.value.drawer_id,h);const k=await f.endRound();return k.success?(t.currentRoom.current_round||0)>=s.value?(await q(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await l()},2e3),{success:!0,gameEnded:!1}):k}catch(h){return console.error("結束輪次錯誤:",h),{success:!1,error:h instanceof Error?h.message:"結束輪次失敗"}}}async function q(){if(!t.currentRoom)return{success:!1,error:"沒有當前房間"};try{return c(),await t.updateRoomStatus("finished"),{success:!0}}catch(h){return console.error("結束遊戲錯誤:",h),{success:!1,error:h instanceof Error?h.message:"結束遊戲失敗"}}}const ee=p(()=>{if(o.value===null)return"--:--";const h=Math.floor(o.value/60),k=o.value%60;return`${h.toString().padStart(2,"0")}:${k.toString().padStart(2,"0")}`});return te(()=>{c()}),{gameStatus:S,isPlaying:b,isWaiting:R,isFinished:u,currentRound:d,currentRoundNumber:g,totalRounds:s,drawTime:e,isCurrentDrawer:r,timeRemaining:o,isCountingDown:w,formattedTime:ee,startGame:m,startNextRound:l,endRound:E,endGame:q,startCountdown:n,stopCountdown:c,resetCountdown:a}}const ue={class:"waiting-lobby"},le={class:"card"},de={class:"card-body"},me={class:"margin-bottom-medium"},fe={class:"card-title text-hand-title"},ge={class:"text-small"},we={style:{"font-family":"monospace"}},he={class:"text-small margin-top-small"},ve={class:"margin-bottom-medium"},_e={class:"text-hand-title"},pe={class:"margin-top-small"},Re={style:{"flex-shrink":"0","margin-right":"0.75rem"}},ye={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},be={style:{flex:"1"}},Se={class:"text-hand",style:{"font-weight":"500"}},Ee={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},xe={class:"margin-bottom-medium text-small"},ke=["disabled"],Ge={key:1,class:"text-small text-center margin-bottom-small"},qe=["disabled"],De={key:0,class:"alert alert-danger margin-top-medium"},Te=ne({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(t,{emit:f}){const i=t,o=f,{isHost:w,canStartGame:v,leaveRoom:S,loading:b,error:R}=ce(),{startGame:u}=ie();function d(r){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[r||""]||r||"未知"}function g(r){return i.room?.host_id===r}async function s(){(await u()).success&&o("startGame")}async function e(){(await S()).success&&o("leaveRoom")}return(r,n)=>(j(),M("div",ue,[y("div",le,[y("div",de,[y("div",me,[y("h2",fe,x(t.room?.name),1),y("div",ge,[n[0]||(n[0]=F(" 房間碼：",-1)),y("span",we,x(t.room?.code),1)]),y("div",he," 狀態："+x(d(t.room?.status)),1)]),y("div",ve,[y("h4",_e,"玩家列表 ("+x(t.participants.length)+")",1),y("div",pe,[(j(!0),M(oe,null,se(t.participants,c=>(j(),M("div",{key:c.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[y("div",Re,[y("div",ye,x(c.nickname.charAt(0).toUpperCase()),1)]),y("div",be,[y("div",Se,[F(x(c.nickname)+" ",1),g(c.user_id)?(j(),M("span",Ee," 房主 ")):L("",!0)])])]))),128))])]),y("div",xe,[y("div",null,"繪畫時間："+x(t.room?.settings.draw_time)+" 秒",1),y("div",null,"輪數："+x(t.room?.settings.rounds)+" 輪",1),y("div",null,"詞語總數："+x(t.room?.word_count)+" 個",1)]),y("div",null,[D(w)&&D(v)?(j(),M("button",{key:0,onClick:s,disabled:D(b),class:"paper-btn btn-primary btn-block margin-bottom-small"},x(D(b)?"開始中...":"開始遊戲"),9,ke)):D(w)?(j(),M("div",Ge," 至少需要 2 個玩家才能開始遊戲 ")):L("",!0),y("button",{onClick:e,disabled:D(b),class:"paper-btn btn-secondary btn-block"},x(D(b)?"離開中...":"離開房間"),9,qe)]),D(R)?(j(),M("div",De,x(D(R)),1)):L("",!0)])])]))}}),Ce=ae(Te,[["__scopeId","data-v-769c8ad1"]]),N=new Map,C=G("disconnected"),U=new Map,A=new Set,W=new Map;function O(...t){}function B(...t){console.warn("[Realtime]",...t)}function Me(){const t=$(),f=Z();function i(e){const r=`room:${e}`;if(N.has(r))return N.get(r);const n=_.channel(r,{config:{presence:{key:"user"},broadcast:{self:!1}}});return N.set(r,n),n}function o(e){const r=W.get(e);r&&(clearTimeout(r),W.delete(e))}function w(e,r,n,c,a){e==="SUBSCRIBED"?(C.value="connected",o(n),r.track({user_id:c,...a}).catch(m=>{B("Presence track 失敗:",m)})):e==="CHANNEL_ERROR"||e==="TIMED_OUT"?(C.value="disconnected",B("訂閱失敗:",e),v(n,c,a)):e==="CLOSED"&&(C.value="disconnected")}function v(e,r,n,c=0){if(c>=3){B("重連失敗次數過多，停止重連");return}o(e);const a=Math.min(1e3*Math.pow(2,c),1e4),m=window.setTimeout(()=>{const l=N.get(`room:${e}`);l&&l.state!=="joined"&&l.subscribe(E=>{E==="SUBSCRIBED"?w(E,l,e,r,n):(E==="CHANNEL_ERROR"||E==="TIMED_OUT")&&v(e,r,n,c+1)})},a);W.set(e,m)}function S(e,r,n,c){if(!e||!r){B("缺少 roomCode 或 roomId");return}const a=i(e),m=a.state;return m==="joined"?(C.value="connected",a):m==="joining"?a:A.has(e)?(C.value="connecting",a.subscribe(l=>{w(l,a,e,n,c)}),a):(a.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${r}`},async l=>{O("房間狀態變化:",l.eventType),t.currentRoom&&await t.loadRoom(t.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${r}`},async l=>{O("參與者變化:",l.eventType),await t.loadParticipants(r)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${r}`},async l=>{O("輪次變化:",l.eventType),t.currentRoom&&await f.loadCurrentRound(t.currentRoom.id)}).on("broadcast",{event:"drawing"},l=>{const E=U.get(e);E&&l.payload?.stroke&&E.forEach(q=>q(l.payload.stroke))}).on("presence",{event:"sync"},()=>{const l=a.presenceState();O("Presence 同步，在線:",Object.keys(l).length)}),A.add(e),C.value="connecting",a.subscribe(l=>{w(l,a,e,n,c)}),a)}function b(e,r){return U.has(e)||U.set(e,new Set),U.get(e).add(r),()=>{U.get(e)?.delete(r)}}function R(e,r){const n=i(e),c=`guesses:${r}`;return n[c]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${r}`},async a=>{O("猜測記錄變化:",a.eventType),await f.loadGuesses(r)}),n[c]=!0),n}async function u(e,r){const n=i(e),c=n.state;if(c!=="joined")return B("Channel 未連接，狀態:",c),{error:"Channel 未連接"};try{const a=await n.send({type:"broadcast",event:"drawing",payload:{stroke:r}});return a==="error"?(B("發送失敗"),{error:"發送失敗"}):a}catch(a){return B("發送錯誤:",a),{error:a instanceof Error?a.message:"發送失敗"}}}function d(e){const r=`room:${e}`,n=N.get(r);o(e),n&&(_.removeChannel(n),N.delete(r)),U.delete(e),A.delete(e)}function g(){W.forEach((e,r)=>o(r)),N.forEach(e=>_.removeChannel(e)),N.clear(),U.clear(),A.clear()}function s(){return C.value}return{connectionStatus:C,subscribeRoom:S,subscribeDrawing:b,subscribeGuesses:R,sendDrawing:u,unsubscribeRoom:d,unsubscribeAll:g,getConnectionStatus:s}}export{Ce as W,ie as a,Me as b,$ as c,Z as d,Y as e,ce as u};
