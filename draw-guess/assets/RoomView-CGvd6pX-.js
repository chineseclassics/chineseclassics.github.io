import{l as Ee,r as T,u as O,f as I,d as K,i as ae,m as ie,c as l,e,o as c,_ as Y,n as L,a as M,F as P,p as z,q as re,t as f,b as a,s as J,h as j,x as q,y as Le,j as H,g as Ne,v as Be,z as Pe,A as Ae,k as He,B as ze}from"./index-DwjqItcE.js";import{b as X,a as le,c as ce,d as Re,e as ne,u as Oe,W as Ue}from"./WaitingLobby-Bx0zzeH4.js";const be=Ee("drawing",()=>{const s=T("pen"),i=T("#000000"),m=T(3),v=T(!1),t=T([]);function d(b){s.value=b}function _(b){i.value=b}function g(b){m.value=Math.max(1,Math.min(20,b))}function R(b){t.value.push(b)}function $(){t.value=[]}function F(b){v.value=b}return{tool:s,color:i,lineWidth:m,isDrawing:v,strokes:t,setTool:d,setColor:_,setLineWidth:g,addStroke:R,clearStrokes:$,setDrawing:F}});function fe(s,i){const m=s.getBoundingClientRect();let v,t;if(i instanceof MouseEvent)v=i.clientX,t=i.clientY;else if(i instanceof TouchEvent&&i.touches.length>0&&i.touches[0])v=i.touches[0].clientX,t=i.touches[0].clientY;else return null;return{x:v-m.left,y:t-m.top}}function Ce(s,i){if(!(i.points.length<2)){s.save(),i.tool==="pen"?(s.strokeStyle=i.color,s.lineWidth=i.lineWidth,s.lineCap="round",s.lineJoin="round"):i.tool==="eraser"&&(s.globalCompositeOperation="destination-out",s.lineWidth=i.lineWidth,s.lineCap="round",s.lineJoin="round"),s.beginPath(),i.points[0]&&s.moveTo(i.points[0].x,i.points[0].y);for(let m=1;m<i.points.length;m++){const v=i.points[m];v&&s.lineTo(v.x,v.y)}s.stroke(),s.restore()}}function oe(s,i){const m=s.getContext("2d");if(!m)return;const v=s.getBoundingClientRect();m.clearRect(0,0,s.width,s.height),m.fillStyle="#FFFFFF",m.fillRect(0,0,v.width,v.height),i.forEach(t=>{Ce(m,t)})}function qe(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ke(){const s=be(),i=X(),m=O(),{sendDrawing:v}=le(),t=I(()=>!m.user||!i.currentRoom?!1:i.currentRoom.current_drawer_id===m.user.id),d=T(null),_=T(null),g=T(null),R=T(null);let $=null;const F=50;function b(w){d.value=w;const D=w.getContext("2d",{willReadFrequently:!0});if(!D){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}_.value=D;const W=window.devicePixelRatio||1,A=w.getBoundingClientRect();w.width=A.width*W,w.height=A.height*W,D.scale(W,W),D.fillStyle="#FFFFFF",D.fillRect(0,0,A.width,A.height),d.value&&oe(d.value,s.strokes),new ResizeObserver(()=>{if(!d.value||!_.value)return;const B=d.value.getBoundingClientRect(),N=window.devicePixelRatio||1;d.value.width=B.width*N,d.value.height=B.height*N,_.value.scale(N,N),_.value.fillStyle="#FFFFFF",_.value.fillRect(0,0,B.width,B.height),oe(d.value,s.strokes)}).observe(w)}function E(w){if(!d.value)return;if(!t.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}w.preventDefault(),s.setDrawing(!0);const D=fe(d.value,w);D&&(g.value={id:qe(),tool:s.tool,color:s.color,lineWidth:s.lineWidth,points:[D],timestamp:Date.now()},R.value=D)}function C(w){if(!d.value||!_.value||!s.isDrawing||!g.value)return;w.preventDefault();const D=fe(d.value,w);if(!D||!R.value)return;const W=_.value;W.save(),g.value.tool==="pen"?(W.strokeStyle=g.value.color,W.lineWidth=g.value.lineWidth,W.lineCap="round",W.lineJoin="round"):g.value.tool==="eraser"&&(W.globalCompositeOperation="destination-out",W.lineWidth=g.value.lineWidth,W.lineCap="round",W.lineJoin="round"),W.beginPath(),W.moveTo(R.value.x,R.value.y),W.lineTo(D.x,D.y),W.stroke(),W.restore(),g.value.points.push(D),R.value=D,$===null&&($=window.setTimeout(()=>{h(),$=null},F))}function x(){!s.isDrawing||!g.value||(s.setDrawing(!1),$&&(clearTimeout($),$=null),h(),g.value=null,R.value=null)}async function h(){if(!(!g.value||!i.currentRoom||!m.user))try{const w={...g.value,userId:m.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",w.id),await v(i.currentRoom.code,w)}catch(w){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",w)}}function r(w){if(!(!d.value||!_.value)){if(w.userId&&m.user&&w.userId===m.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",w.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",w.id),s.addStroke(w),Ce(_.value,w)}}function n(){if(!d.value||!_.value)return;const w=_.value,D=d.value;w.clearRect(0,0,D.width,D.height),w.fillStyle="#FFFFFF",w.fillRect(0,0,D.width,D.height),s.clearStrokes()}function u(w){s.setTool(w)}function y(w){s.setColor(w)}function V(w){s.setLineWidth(w)}function G(){d.value&&oe(d.value,s.strokes)}return{canvasRef:d,initCanvas:b,startDrawing:E,draw:C,stopDrawing:x,clearCanvas:n,setTool:u,setColor:y,setLineWidth:V,handleDrawingData:r,redrawStrokes:G}}const Je={class:"drawing-canvas-container"},Ke=K({__name:"DrawingCanvas",setup(s){const{initCanvas:i,startDrawing:m,draw:v,stopDrawing:t,handleDrawingData:d,clearCanvas:_}=ke(),g=X(),R=O(),{subscribeDrawing:$}=le(),F=T(null);function b(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),_()}function E(G){m(G)}function C(G){v(G)}function x(){t()}function h(){t()}function r(G){m(G)}function n(G){v(G)}function u(){t()}let y=null;function V(){!g.currentRoom||!R.user||(y=$(g.currentRoom.code,G=>{d(G)}))}return ae(()=>{F.value&&i(F.value),V(),window.addEventListener("clearCanvas",b)}),ie(()=>{y&&(y(),y=null),window.removeEventListener("clearCanvas",b)}),(G,w)=>(c(),l("div",Je,[e("canvas",{ref_key:"canvasElement",ref:F,class:"drawing-canvas",onMousedown:E,onMousemove:C,onMouseup:x,onMouseleave:h,onTouchstart:r,onTouchmove:n,onTouchend:u},null,544)]))}}),Ye=Y(Ke,[["__scopeId","data-v-f29d9704"]]),Xe={class:"toolbar-section"},je={key:0,class:"tool-label"},Qe={key:0,class:"tool-label"},Ze={key:0,class:"toolbar-section colors-section"},es=["onClick","title"],ss={class:"toolbar-section size-section"},ts={class:"size-dots"},ns=["onClick","title"],os={class:"toolbar-section"},rs={key:0,class:"tool-label"},as=K({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(s){const i=be(),{setTool:m,setColor:v,setLineWidth:t,clearCanvas:d}=ke(),_=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],g=I(()=>i.tool),R=I(()=>i.color),$=I(()=>i.lineWidth);function F(x){m(x)}function b(x){v(x)}function E(x){i.setLineWidth(x),t(x)}function C(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&d()}return(x,h)=>(c(),l("div",{class:L(["drawing-toolbar",{"toolbar-compact":s.compact}])},[e("div",Xe,[e("button",{onClick:h[0]||(h[0]=r=>F("pen")),class:L(["tool-btn",{active:g.value==="pen"}]),title:"ç•«ç­†"},[h[2]||(h[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),s.compact?M("",!0):(c(),l("span",je,"ç•«ç­†"))],2),e("button",{onClick:h[1]||(h[1]=r=>F("eraser")),class:L(["tool-btn",{active:g.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[h[3]||(h[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),s.compact?M("",!0):(c(),l("span",Qe,"æ©¡çš®æ“¦"))],2)]),g.value==="pen"?(c(),l("div",Ze,[e("div",{class:L(["color-grid",{"color-grid-compact":s.compact}])},[(c(),l(P,null,z(_,r=>e("div",{key:r,onClick:n=>b(r),class:L(["color-cell",{selected:R.value===r}]),style:re({backgroundColor:r}),title:r},null,14,es)),64))],2)])):M("",!0),e("div",ss,[e("div",ts,[(c(),l(P,null,z([2,5,10,15],r=>e("div",{key:r,onClick:n=>E(r),class:L(["size-dot",{active:$.value===r}]),style:re({width:`${r+8}px`,height:`${r+8}px`}),title:`${r}px`},null,14,ns)),64))])]),e("div",os,[e("button",{onClick:C,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[h[4]||(h[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),s.compact?M("",!0):(c(),l("span",rs,"æ¸…ç©º"))])])],2))}}),pe=Y(as,[["__scopeId","data-v-7e7250c3"]]),is={class:"player-list"},ls={class:"player-list-header"},cs={class:"player-count"},us={class:"player-rank"},ds={class:"player-info"},vs={class:"player-name"},ms={key:0,class:"drawer-badge"},gs={key:1,class:"host-badge"},hs={class:"player-score"},ws=["onClick"],_s={key:0,class:"winner-banner"},fs={class:"winner-text"},ps={class:"winner-name"},ys={class:"winner-score"},Rs=K({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(s,{emit:i}){const m=i,v=X(),t=ce(),d=O(),{playerRankings:_,winner:g}=Re(),R=I(()=>_.value),$=T(!1);function F(r){return v.participants.find(u=>u.user_id===r)?.nickname||"æœªçŸ¥ç©å®¶"}function b(r){return d.user?.id===r}function E(r){return v.currentRoom?.host_id===r}function C(r){return t.currentRound?.drawer_id===r||v.currentRoom?.current_drawer_id===r}function x(r){return v.isHost&&!b(r)}async function h(r,n){if(!($.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${n} å—ï¼Ÿ`))){$.value=!0;try{const y=await v.kickPlayer(r);y.success?m("player-kicked",r):alert(y.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(y){console.error("è¸¢äººå¤±æ•—:",y),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{$.value=!1}}}return(r,n)=>(c(),l("div",is,[e("div",ls,[e("span",cs,"ç©å®¶ ("+f(R.value.length)+")",1)]),(c(!0),l(P,null,z(R.value,(u,y)=>(c(),l("div",{key:u.id,class:L(["player-item",{"is-current":b(u.user_id)},{"is-drawer":C(u.user_id)}])},[e("div",us,f(y+1),1),e("div",{class:L(["player-avatar",{drawing:C(u.user_id)}])},f(F(u.user_id).charAt(0)),3),e("div",ds,[e("div",vs,[J(f(F(u.user_id))+" ",1),C(u.user_id)?(c(),l("span",ms,"âœï¸")):M("",!0),E(u.user_id)?(c(),l("span",gs,"ğŸ‘‘")):M("",!0)]),e("div",hs,f(u.score)+" åˆ†",1)]),x(u.user_id)?(c(),l("button",{key:0,class:"kick-btn",onClick:V=>h(u.user_id,F(u.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,ws)):M("",!0)],2))),128)),s.showWinner&&a(g)?(c(),l("div",_s,[n[1]||(n[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",fs,[n[0]||(n[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",ps,f(F(a(g).user_id)),1),e("div",ys,f(a(g).score)+" åˆ†",1)])])):M("",!0)]))}}),ye=Y(Rs,[["__scopeId","data-v-984c1c4a"]]),bs={class:"round-summary"},Cs={class:"summary-card"},ks={key:0,class:"selection-waiting-banner"},$s={class:"waiting-text"},Ss={class:"next-drawer-name"},Fs={class:"summary-header"},Ds={class:"summary-title"},Ws={class:"round-info"},Ts={class:"answer-reveal"},xs={class:"answer-text"},Gs={class:"drawer-section"},Is={class:"drawer-info"},Ms={class:"drawer-name"},Vs={key:0,class:"drawer-score"},Es={class:"guessers-section"},Ls={key:0,class:"no-guessers"},Ns={key:1,class:"guessers-list"},Bs={class:"guesser-rank"},Ps={class:"guesser-name"},As={class:"guesser-score"},Hs={key:1,class:"rating-section"},zs={class:"star-rating"},Os=["onMouseenter","onClick","disabled"],Us={class:"rating-info"},qs={key:0,class:"rated-text"},Js={key:1,class:"rate-hint"},Ks={key:2,class:"average-rating"},Ys={class:"avg-score"},Xs={class:"avg-stars"},js={class:"avg-count"},Qs=K({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(s,{emit:i}){const m=s,v=i,t=O(),d=T(0),_=T(0),g=T(!1),R=T([]),$=I(()=>t.user?.id===m.drawerId),F=I(()=>R.value.length===0?0:R.value.reduce((n,u)=>n+u.rating,0)/R.value.length),b=I(()=>R.value.length);async function E(r){if(!(g.value||$.value||!t.user))try{const{error:n}=await q.from("drawing_ratings").upsert({round_id:m.roundId,rater_id:t.user.id,drawer_id:m.drawerId,rating:r},{onConflict:"round_id,rater_id"});if(n)throw n;d.value=r,g.value=!0,v("rating-submitted",r)}catch(n){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",n)}}async function C(){try{const{data:r,error:n}=await q.from("drawing_ratings").select("rater_id, rating").eq("round_id",m.roundId);if(n)throw n;if(R.value=r||[],t.user){const u=R.value.find(y=>y.rater_id===t.user.id);u&&(d.value=u.rating,g.value=!0)}}catch(r){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",r)}}function x(){const r=q.channel(`ratings:${m.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${m.roundId}`},()=>{C()}).subscribe();return()=>{q.removeChannel(r)}}let h=null;return ae(()=>{C(),h=x()}),ie(()=>{h&&h()}),j(()=>m.roundId,()=>{C()}),(r,n)=>(c(),l("div",bs,[e("div",Cs,[s.isWaitingForSelection?(c(),l("div",ks,[n[2]||(n[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",$s,[e("span",Ss,f(s.nextDrawerName),1),n[1]||(n[1]=J(" æ­£åœ¨é¸è©... ",-1))]),n[3]||(n[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",Fs,[e("h2",Ds,f(s.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Ws,"ç¬¬ "+f(s.roundNumber)+" / "+f(s.totalRounds)+" è¼ª",1)]),e("div",Ts,[n[4]||(n[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",xs,f(s.correctAnswer),1)]),e("div",Gs,[e("div",Is,[n[5]||(n[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Ms,f(s.drawerName),1),s.drawerScore>0?(c(),l("span",Vs,"+"+f(s.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",Es,[n[6]||(n[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),s.correctGuessers.length===0?(c(),l("div",Ls," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(c(),l("div",Ns,[(c(!0),l(P,null,z(s.correctGuessers,(u,y)=>(c(),l("div",{key:u.userId,class:"guesser-item"},[e("span",Bs,f(y+1),1),e("span",Ps,f(u.name),1),e("span",As,"+"+f(u.score),1)]))),128))]))]),$.value?M("",!0):(c(),l("div",Hs,[n[7]||(n[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",zs,[(c(),l(P,null,z(5,u=>e("button",{key:u,class:L(["star-btn",{active:u<=(_.value||d.value),selected:u<=d.value}]),onMouseenter:y=>_.value=u,onMouseleave:n[0]||(n[0]=y=>_.value=0),onClick:y=>E(u),disabled:g.value}," â­ ",42,Os)),64))]),e("div",Us,[g.value?(c(),l("span",qs,"ä½ çš„è©•åˆ†ï¼š"+f(d.value)+" æ˜Ÿ",1)):(c(),l("span",Js,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),b.value>0?(c(),l("div",Ks,[n[8]||(n[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",Ys,f(F.value.toFixed(1)),1),e("span",Xs,f("â­".repeat(Math.round(F.value))),1),e("span",js,"("+f(b.value)+" äººå·²è©•)",1)])):M("",!0)])]))}}),Zs=Y(Qs,[["__scopeId","data-v-64089556"]]);function et(){const s=ce(),i=O(),m=X(),{calculateGuessScore:v,updatePlayerScore:t}=Re(),d=T(""),_=T(null),g=T(!1),R=I(()=>s.isCurrentDrawer?s.currentWord:null),$=I(()=>s.correctGuesses),F=I(()=>i.user?s.hasGuessed(i.user.id):!1);async function b(){if(!s.currentRound||!i.user)return _.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!d.value.trim())return _.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(d.value.length>32)return _.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(F.value)return _.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(s.isCurrentDrawer)return _.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{g.value=!0,_.value=null;const h=d.value.trim(),r=s.currentWord||"",n=E(h,r),u=n?v($.value.length):0,{data:y,error:V}=await q.from("guesses").insert({round_id:s.currentRound.id,user_id:i.user.id,guess_text:h,is_correct:n,score_earned:u}).select().single();if(V)throw V;s.guesses.push(y),n&&i.user&&await t(i.user.id,u);const G=C();return d.value="",{success:!0,isCorrect:n,guess:y,allGuessersCorrect:G}}catch(h){return _.value=h instanceof Error?h.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",h),{success:!1,error:_.value}}finally{g.value=!1}}function E(h,r){const n=h.trim(),u=r.trim();return n===u}function C(){if(!s.currentRound)return!1;const h=s.currentRound.drawer_id,n=m.participants.filter(V=>V.user_id!==h);if(n.length===0)return!1;const u=new Set(s.currentRoundCorrectGuesses.map(V=>V.user_id)),y=n.every(V=>u.has(V.user_id));return console.log("[useGuessing] æª¢æŸ¥æ‰€æœ‰äººçŒœå°:",{guessersCount:n.length,correctCount:u.size,allCorrect:y}),y}function x(){_.value=null}return{guessInput:d,error:_,loading:g,currentWord:R,correctGuesses:$,hasGuessed:F,submitGuess:b,clearError:x}}const st={class:"game-container"},tt={key:0,class:"container margin-top-large"},nt={class:"row flex-center"},ot={class:"col-12 col-md-8"},rt={key:1,class:"game-layout"},at={class:"game-sidebar game-players"},it={class:"player-list-container"},lt={class:"game-main"},ct={key:0,class:"time-display"},ut={key:1,class:"time-display summary"},dt={class:"time-number"},vt={class:"round-info"},mt={class:"round-label"},gt={key:0,class:"phase-label"},ht={key:2,class:"word-display"},wt={class:"word-text"},_t={key:3,class:"word-display"},ft={class:"drawer-hint"},pt={class:"word-slots"},yt={key:4,class:"word-display summary-word"},Rt={class:"word-text revealed"},bt={class:"game-content-area"},Ct={class:"game-toolbar disabled"},kt={class:"game-canvas summary-phase"},$t={class:"game-chat-panel"},St={class:"chat-msg system-msg answer-revealed"},Ft={class:"msg-player"},Dt={class:"msg-correct"},Wt={class:"game-toolbar"},Tt={class:"game-canvas"},xt={key:0,class:"time-progress"},Gt={class:"game-chat-panel"},It={class:"msg-player"},Mt={key:0,class:"msg-correct"},Vt={key:1,class:"msg-text"},Et={key:0,class:"chat-msg correct-self"},Lt={class:"chat-input-area"},Nt=["placeholder","disabled"],Bt=["disabled"],Pt={key:2,class:"container margin-top-large"},At={class:"row flex-center"},Ht={class:"col-12 col-md-8"},zt={class:"card"},Ot={class:"card-body text-center"},Ut=K({__name:"RoomView",setup(s){const i=Le(),m=He(),v=X(),t=ce(),d=O(),{subscribeRoom:_,unsubscribeRoom:g,subscribeGameState:R,broadcastAllGuessed:$}=le(),{isPlaying:F,isWaiting:b,isFinished:E,timeRemaining:C,isCountingDown:x,isCurrentDrawer:h,drawTime:r,currentRoundNumber:n,totalRounds:u,startGame:y,isDrawing:V,isSummary:G,summaryTimeRemaining:w,startSummaryCountdown:D,stopSummaryCountdown:W,startCountdown:A,stopCountdown:ue}=ne(),{hasGuessed:B,guessInput:N,submitGuess:$e,loading:Se}=et(),{leaveRoom:Fe}=Oe(),S=I(()=>v.currentRoom),de=I(()=>Se.value),ve=T(null),U=T(null),Q=I(()=>{const p=S.value?.current_drawer_id;return p&&v.participants.find(k=>k.user_id===p)?.nickname||"ç•«å®¶"}),me=I(()=>[...t.guesses].sort((p,o)=>new Date(p.guessed_at).getTime()-new Date(o.guessed_at).getTime()));function De(){U.value&&(U.value.scrollTop=U.value.scrollHeight)}j(me,()=>{ze(De)},{deep:!0}),j(()=>v.participants,p=>{if(!d.user||!S.value)return;!p.some(k=>k.user_id===d.user.id)&&S.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),v.clearRoom(),m.push("/"))},{deep:!0});function Z(p){return v.participants.find(k=>k.user_id===p)?.nickname||"æœªçŸ¥ç©å®¶"}const We=I(()=>h.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":B.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Te=I(()=>t.currentWord?t.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),ge=I(()=>t.currentRoundCorrectGuesses.length*5),he=I(()=>t.currentRoundCorrectGuesses.map(p=>({userId:p.user_id,name:Z(p.user_id),score:p.score_earned}))),xe=T(null);function Ge(){!t.currentRound||!t.currentWord||(xe.value={roundNumber:n.value,answer:t.currentWord,drawerName:Q.value,drawerId:t.currentRound.drawer_id,drawerScore:ge.value,correctGuessers:he.value,roundId:t.currentRound.id})}j(G,(p,o)=>{p&&!o&&n.value>0&&Ge()});function ee(p){ve.value=p,setTimeout(()=>{ve.value=null},3e3)}async function we(){if(!h.value&&N.value.trim()){const p=await $e();p.success&&p.allGuessersCorrect&&S.value&&(console.log("[RoomView] æ‰€æœ‰äººéƒ½çŒœå°äº†ï¼Œå»£æ’­äº‹ä»¶"),await $(S.value.code))}}async function Ie(){const p=await y();!p.success&&p.error&&ee(p.error)}async function se(){const p=await Fe();S.value&&g(S.value.code),await m.push("/"),!p.success&&p.error&&ee(p.error)}async function Me(p){if(!t.currentRound)return;const o=await t.submitRating(t.currentRound.id,t.currentRound.drawer_id,p);!o.success&&o.error&&ee(o.error)}return ae(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",i.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",S.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",d.user?.id);const p=i.params.code;if(p&&!S.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",p),S.value&&d.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",S.value.status),await t.loadCurrentRound(S.value.id),S.value.status==="playing"&&t.currentRound){const o=t.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:o.round_number,startedAt:o.started_at,endedAt:o.ended_at,drawerId:o.drawer_id}),o.drawer_id&&v.setCurrentDrawer(o.drawer_id),o.started_at&&!o.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),t.setRoundStatus("drawing"),window.dispatchEvent(new CustomEvent("clearCanvas"));const k=new Date(o.started_at).getTime(),Ve=Date.now(),_e=Math.floor((Ve-k)/1e3),te=Math.max(0,r.value-_e);console.log("[RoomView] å€’è¨ˆæ™‚è¨ˆç®—:",{drawTime:r.value,elapsed:_e,remaining:te}),te>0?A(te):A(0)}else o.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await _(S.value.code,S.value.id,d.user.id,{nickname:d.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(o){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",o)}R(S.value.code,async o=>{if(console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",o),o.allGuessed&&v.isHost){console.log("[RoomView] æˆ¿ä¸»æ”¶åˆ°æ‰€æœ‰äººçŒœå°äº‹ä»¶ï¼Œæå‰çµæŸè¼ªæ¬¡");const{endRound:k}=ne();await k();return}o.drawerId&&S.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",o.drawerId),v.setCurrentDrawer(o.drawerId)),o.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",o.roundStatus),t.setRoundStatus(o.roundStatus),o.roundStatus==="drawing"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),W(),t.clearRatings(),A(r.value)),o.roundStatus==="summary"&&(ue(),o.isLastRound?v.isHost&&setTimeout(async()=>{const{endGame:k}=ne();await k()},3e3):D())),S.value&&(await v.loadRoom(S.value.id),await t.loadCurrentRound(S.value.id))}),await t.loadAllGuesses(S.value.id)}}),ie(()=>{S.value&&g(S.value.code)}),(p,o)=>(c(),l("div",st,[a(b)?(c(),l("div",tt,[e("div",nt,[e("div",ot,[H(Ue,{room:S.value,participants:a(v).participants,onStartGame:Ie,onLeaveRoom:se},null,8,["room","participants"])])])])):a(F)?(c(),l("div",rt,[e("div",at,[e("div",it,[H(ye,{"show-winner":!1})])]),e("div",lt,[e("div",{class:L(["game-header",{"time-critical":a(C)!==null&&a(C)<=10}])},[a(V)&&a(x)&&a(C)!==null?(c(),l("div",ct,[e("span",{class:L(["time-number",{"time-warning":a(C)<=10,"time-critical-pulse":a(C)<=5}])},f(a(C)),3),o[1]||(o[1]=e("span",{class:"time-label"},"ç§’",-1))])):a(G)&&a(w)!==null?(c(),l("div",ut,[e("span",dt,f(a(w)),1),o[2]||(o[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",vt,[e("span",mt,"ç¬¬ "+f(a(n))+" / "+f(a(u))+" è¼ª",1),a(G)?(c(),l("span",gt,"è¼ªæ¬¡çµç®—")):M("",!0)]),a(V)&&a(h)&&a(t).currentWord?(c(),l("div",ht,[o[3]||(o[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",wt,f(a(t).currentWord),1)])):a(V)?(c(),l("div",_t,[e("span",ft,"ğŸ¨ "+f(Q.value)+" æ­£åœ¨ç•«",1),e("span",pt,f(Te.value),1)])):a(G)&&a(t).currentWord?(c(),l("div",yt,[o[4]||(o[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",Rt,f(a(t).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:se,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",bt,[a(G)?(c(),l(P,{key:0},[e("div",Ct,[H(pe,{compact:!0})]),e("div",kt,[H(Zs,{"round-number":a(n),"total-rounds":a(u),"correct-answer":a(t).currentWord||"","drawer-name":Q.value,"drawer-id":a(t).currentRound?.drawer_id||"","drawer-score":ge.value,"correct-guessers":he.value,"round-id":a(t).currentRound?.id||"","is-host":a(v).isHost,"is-last-round":a(n)>=a(u),onRatingSubmitted:Me},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",$t,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[e("div",St,[o[5]||(o[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),o[6]||(o[6]=J(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,f(a(t).currentWord),1)]),(c(!0),l(P,null,z(a(t).currentRoundCorrectGuesses,k=>(c(),l("div",{key:k.id,class:"chat-msg correct-guess"},[e("span",Ft,f(Z(k.user_id)),1),e("span",Dt,"çŒœä¸­äº†ï¼ +"+f(k.score_earned),1)]))),128))],512),o[7]||(o[7]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(c(),l(P,{key:1},[e("div",Wt,[H(pe,{compact:!0})]),e("div",Tt,[H(Ye),a(x)&&a(C)!==null?(c(),l("div",xt,[e("div",{class:L(["time-bar",{"time-warning":a(C)<=10}]),style:re({width:`${a(C)/a(r)*100}%`})},null,6)])):M("",!0)]),e("div",Gt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[o[9]||(o[9]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),J(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(c(!0),l(P,null,z(me.value,k=>(c(),l("div",{key:k.id,class:L(["chat-msg",{"correct-guess":k.is_correct,"wrong-guess":!k.is_correct}])},[e("span",It,f(Z(k.user_id)),1),k.is_correct?(c(),l("span",Mt,"çŒœä¸­äº†ï¼ +"+f(k.score_earned),1)):(c(),l("span",Vt,f(k.guess_text),1))],2))),128)),a(B)?(c(),l("div",Et,[...o[8]||(o[8]=[e("span",{class:"msg-icon"},"âœ…",-1),J(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",Lt,[Ne(e("input",{"onUpdate:modelValue":o[0]||(o[0]=k=>Ae(N)?N.value=k:null),type:"text",placeholder:We.value,maxlength:"32",disabled:de.value||a(B)||a(h),onKeyup:Pe(we,["enter"]),class:"chat-input-field"},null,40,Nt),[[Be,a(N)]]),e("button",{onClick:we,disabled:de.value||a(B)||a(h)||!a(N).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Bt)])])],64))])])])):a(E)?(c(),l("div",Pt,[e("div",At,[e("div",Ht,[e("div",zt,[e("div",Ot,[o[10]||(o[10]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),H(ye,{"show-winner":!0}),e("button",{onClick:se,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),Kt=Y(Ut,[["__scopeId","data-v-c0ac909f"]]);export{Kt as default};
