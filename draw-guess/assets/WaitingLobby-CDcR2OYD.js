const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-WLMX7o8f.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as dr,f as y,y as Pe,c as z,o as Y,z as Gr,a as be,e as T,A as Tr,B as Ue,r as O,u as ge,E as S,L as Be,h as Ar,t as j,s as ue,n as Ke,F as Fe,m as xr,b as se,_ as Pr}from"./index-WLMX7o8f.js";const Dr=["width","height","fill","transform"],Mr={key:0},Nr=T("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),qr=[Nr],Or={key:1},kr=T("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Hr=T("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Br=[kr,Hr],Ur={key:2},$r=T("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Wr=[$r],Lr={key:3},Zr=T("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Vr=[Zr],jr={key:4},zr=T("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Yr=[zr],Kr={key:5},Fr=T("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Jr=[Fr],Qr={name:"PhPaintBrush"},Bt=dr({...Qr,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const c=e,s=Pe("weight","regular"),a=Pe("size","1em"),M=Pe("color","currentColor"),G=Pe("mirrored",!1),v=y(()=>c.weight??s),L=y(()=>c.size??a),B=y(()=>c.color??M),b=y(()=>c.mirrored!==void 0?c.mirrored?"scale(-1, 1)":void 0:G?"scale(-1, 1)":void 0);return(E,I)=>(Y(),z("svg",Tr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:L.value,height:L.value,fill:B.value,transform:b.value},E.$attrs),[Gr(E.$slots,"default"),v.value==="bold"?(Y(),z("g",Mr,qr)):v.value==="duotone"?(Y(),z("g",Or,Br)):v.value==="fill"?(Y(),z("g",Ur,Wr)):v.value==="light"?(Y(),z("g",Lr,Vr)):v.value==="regular"?(Y(),z("g",jr,Yr)):v.value==="thin"?(Y(),z("g",Kr,Jr)):be("",!0)],16,Dr))}}),Ge=Ue("room",()=>{const e=O(null),c=O([]),s=O(!1),a=O(null),M=y(()=>{const t=ge();return e.value?.host_id===t.user?.id});async function G(t){try{s.value=!0,a.value=null;const r=ge();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch($){console.warn("載入用戶資料時發生錯誤（非關鍵）:",$)}const l=t.gameMode||"classic";if(l==="classic"&&t.words.length<6)throw new Error("至少需要 6 個詞語");let m=null,H=0;const N=10;for(;H<N&&!m;){H++;const F={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null,game_mode:l,single_round_mode:t.singleRoundMode||!1,is_final_round:!1},{data:oe,error:n}=await S.from("game_rooms").insert(F).select().single();if(n){if(n.code==="23505")continue;throw new Error(n.message||"插入房間失敗")}if(oe){m=oe;break}}if(!m)throw new Error("無法生成唯一房間碼，請重試");const h={room_id:m.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:$}=await S.from("room_participants").insert(h);$&&console.error("創建參與記錄錯誤:",$)}catch($){console.error("創建參與記錄時發生錯誤:",$)}try{const{data:$,error:F}=await S.from("room_participants").select("*").eq("room_id",m.id).order("joined_at",{ascending:!0});F?console.error("載入參與者列表失敗:",F):$&&(c.value=$)}catch($){console.error("載入參與者列表時發生錯誤:",$)}return e.value=m,{success:!0,room:m}}catch(r){return a.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:a.value}}finally{s.value=!1}}async function v(t,r){try{s.value=!0,a.value=null;const l=ge();if(!l.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:m,error:H}=await S.from("game_rooms").select("*").eq("code",t).single();if(H||!m)throw new Error("房間不存在");if(m.status!=="waiting")throw new Error("房間已開始或已結束");const{data:N}=await S.from("room_participants").select("*").eq("room_id",m.id).eq("user_id",l.user.id).maybeSingle();if(N)return e.value=m,await B(m.id),{success:!0,room:m};const{error:h}=await S.from("room_participants").insert({room_id:m.id,user_id:l.user.id,nickname:r.trim(),score:0});if(h){if(h.code==="23505"||h.message.includes("duplicate"))return e.value=m,await B(m.id),{success:!0,room:m};throw h}return e.value=m,await B(m.id),{success:!0,room:m}}catch(l){return a.value=l instanceof Error?l.message:"加入房間失敗",console.error("加入房間錯誤:",l),{success:!1,error:a.value}}finally{s.value=!1}}async function L(){try{if(!e.value)return{success:!0};s.value=!0,a.value=null;const t=ge();if(!t.user)throw new Error("請先登入");const{error:r}=await S.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(M.value){const{error:l}=await S.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);l&&console.error("關閉房間失敗:",l)}return e.value=null,c.value=[],{success:!0}}catch(t){return a.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,c.value=[],{success:!1,error:a.value}}finally{s.value=!1}}async function B(t){try{const{data:r,error:l}=await S.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(l)throw l;c.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function b(t){try{s.value=!0,a.value=null;const{data:r,error:l}=await S.from("game_rooms").select("*").eq("id",t).single();if(l)throw l;return e.value=r,await B(t),{success:!0,room:r}}catch(r){return a.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:a.value}}finally{s.value=!1}}async function E(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await S.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(t==="finished"&&e.value&&await I(),e.value){const l=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:l,newStatus:e.value.status})}return{success:!0}}catch(r){return a.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:a.value}}}async function I(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:t,error:r}=await S.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(r){console.error("獲取參與者錯誤:",r);return}if(!t||t.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const l=t.map(h=>h.user_id),{data:m,error:H}=await S.from("users").select("id, user_type").in("id",l);if(H){console.error("獲取用戶信息錯誤:",H);return}const N=new Set(m?.filter(h=>h.user_type==="registered").map(h=>h.id)||[]);for(const h of t){if(!N.has(h.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${h.user_id} 的積分累積`);continue}if(h.score>0){const{error:$}=await S.rpc("accumulate_user_score",{user_id_param:h.user_id,score_to_add:h.score});if($){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",$);const{data:F,error:oe}=await S.from("users").select("total_score").eq("id",h.user_id).single();if(oe){console.error(`[RoomStore] 獲取用戶 ${h.user_id} 總積分錯誤:`,oe);continue}const n=(F?.total_score||0)+h.score,{error:u}=await S.from("users").update({total_score:n}).eq("id",h.user_id);u?console.error(`[RoomStore] 更新用戶 ${h.user_id} 總積分錯誤:`,u):console.log(`[RoomStore] 用戶 ${h.user_id} 積分已累積: +${h.score} (總積分: ${n})`)}else console.log(`[RoomStore] 用戶 ${h.user_id} 積分已累積: +${h.score}`)}}}catch(t){console.error("[RoomStore] 累積積分錯誤:",t)}}async function k(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await S.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return a.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:a.value}}}async function P(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:t});const r={...e.value.settings,...t},{error:l}=await S.from("game_rooms").update({settings:r}).eq("id",e.value.id);if(l)throw l;return e.value&&(e.value.settings=r,console.log("[RoomStore] 房間設置已更新:",r)),{success:!0}}catch(r){return a.value=r instanceof Error?r.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",r),{success:!1,error:a.value}}}function q(){e.value=null,c.value=[],a.value=null}function i(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function R(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!M.value)return{success:!1,error:"只有房主可以踢人"};const r=ge();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};s.value=!0,a.value=null;const{data:l,error:m}=await S.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(m)throw new Error(m.message);if(l&&!l.success)throw new Error(l.error||"踢出玩家失敗");return await B(e.value.id),{success:!0}}catch(r){return a.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:a.value}}finally{s.value=!1}}async function f(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:t});const{error:r}=await S.from("game_rooms").update({is_final_round:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.is_final_round=t,console.log("[RoomStore] 最後一局標記已更新:",t)),{success:!0}}catch(r){return a.value=r instanceof Error?r.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",r),{success:!1,error:a.value}}}return{currentRoom:e,participants:c,loading:s,error:a,isHost:M,createRoom:G,joinRoom:v,leaveRoom:L,kickPlayer:R,loadParticipants:B,loadRoom:b,updateRoomStatus:E,updateRoomDrawer:k,updateRoomSettings:P,setCurrentDrawer:i,setFinalRound:f,clearRoom:q}});function Xr(){const e=Ge(),c=y(()=>e.currentRoom),s=y(()=>e.participants),a=y(()=>e.isHost),M=y(()=>c.value&&c.value.game_mode==="storyboard"?3:2),G=y(()=>!c.value||c.value.status!=="waiting"||!a.value?!1:s.value.length>=M.value);async function v(b){return await e.createRoom(b)}async function L(b,E){return await e.joinRoom(b,E)}async function B(){return await e.leaveRoom()}return{currentRoom:c,participants:s,isHost:a,canStartGame:G,minPlayersRequired:M,loading:y(()=>e.loading),error:y(()=>e.error),createRoom:v,joinRoom:L,leaveRoom:B}}const Je=100,Qe=50,Xe=10,et=10,er=100,rr=[1,.8,.6,.4,.2];function rt(){const e=Ge();function c(b){const E=Math.min(b,rr.length-1),I=rr[E]??0;return Math.round(Je*I)}function s(b,E=0){if(b===0)return 0;const I=b*Xe,k=Math.round(E*et);return Qe+I+k}async function a(b,E,I=0){const k=s(E,I);return k===0?!0:await M(b,k)}async function M(b,E){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:I,error:k}=await S.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",b).single();if(k)throw k;const P=(I?.score||0)+E,{error:q}=await S.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",b);if(q)throw q;const i=e.participants.findIndex(R=>R.user_id===b);return i!==-1&&e.participants[i]&&(e.participants[i].score=P),!0}catch(I){return console.error("更新玩家分數錯誤:",I),!1}}function G(){if(!e.participants||e.participants.length===0)return null;const b=[...e.participants].sort((E,I)=>I.score-E.score);return b.length===1||b[0]&&b[1]&&b[0].score>b[1].score?{user_id:b[0]?.user_id||"",score:b[0]?.score||0}:{user_id:b[0]?.user_id||"",score:b[0]?.score||0}}const v=y(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((E,I)=>I.score!==E.score?I.score-E.score:new Date(E.joined_at).getTime()-new Date(I.joined_at).getTime()).map((E,I)=>({id:E.id,user_id:E.user_id,score:E.score,rank:I+1}))),L=y(()=>e.currentRoom?.status!=="finished"?null:G());function B(){return er}return{GUESS_BASE_SCORE:Je,DRAWING_BASE_SCORE:Qe,DRAWING_BONUS_PER_GUESS:Xe,WINNER_BONUS:er,calculateGuessScore:c,calculateDrawingScore:s,calculateWinner:G,updatePlayerScore:M,updateDrawerScore:a,playerRankings:v,winner:L,getWinnerBonus:B}}const mr=Ue("game",()=>{const e=Ge(),c=ge(),s=O(null),a=O(null),M=O(0),G=O([]),v=y(()=>G.value.filter(d=>d.is_correct)),L=y(()=>s.value?G.value.filter(d=>d.round_id===s.value.id):[]),B=y(()=>L.value.filter(d=>d.is_correct)),b=O("drawing"),E=O([]),I=O([]),k=O(!1),P=O([]),q=O([]),i=y(()=>I.value.length===0?0:I.value.reduce((w,g)=>w+g.rating,0)/I.value.length);function R(d){b.value=d}function f(d){E.value=d}function t(d){const w=I.value.findIndex(g=>g.rater_id===d.rater_id);w>=0?I.value[w]=d:I.value.push(d)}function r(){I.value=[]}function l(){if(k.value||!a.value)return null;const d=a.value,w=d.length,g=[];for(let K=0;K<w;K++)P.value.includes(K)||g.push(K);if(g.length===0)return null;const W=Math.floor(Math.random()*g.length),Z=g[W];if(Z===void 0)return null;const J=d[Z];return J?(P.value.push(Z),q.value.push(J),k.value=!0,{index:Z,char:J}):null}function m(d,w,g=[]){k.value=d,P.value=w,q.value=g}function H(d){M.value=d}function N(){k.value=!1,P.value=[],q.value=[]}async function h(d,w=!1){try{const{data:g,error:W}=await S.from("game_rounds").select("*").eq("room_id",d).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(W)throw W;return g&&(s.value=g,w||c.user&&g.drawer_id===c.user.id?a.value=g.word_text:a.value=null,g.word_options&&Array.isArray(g.word_options)&&(E.value=g.word_options),g.hint_given!==void 0&&(k.value=g.hint_given),g.revealed_indices&&Array.isArray(g.revealed_indices)&&(P.value=g.revealed_indices),await $(g.id)),{success:!0,round:g}}catch(g){return console.error("載入當前輪次錯誤:",g),{success:!1,error:g instanceof Error?g.message:"載入輪次失敗"}}}async function $(d){try{const{data:w,error:g}=await S.from("guesses").select("*").eq("round_id",d).order("guessed_at",{ascending:!0});if(g)throw g;const W=w||[],Z=new Set(G.value.map(K=>K.id)),J=W.filter(K=>!Z.has(K.id));J.length>0&&(G.value=[...G.value,...J])}catch(w){console.error("載入猜測記錄錯誤:",w)}}async function F(d){try{const{data:w,error:g}=await S.from("game_rounds").select("id").eq("room_id",d);if(g)throw g;if(!w||w.length===0){G.value=[];return}const W=w.map(K=>K.id),{data:Z,error:J}=await S.from("guesses").select("*").in("round_id",W).order("guessed_at",{ascending:!0});if(J)throw J;G.value=Z||[]}catch(w){console.error("載入所有猜測記錄錯誤:",w)}}async function oe(d,w,g,W){try{if(!e.currentRoom)throw new Error("沒有當前房間");const Z=(e.currentRoom.current_round||0)+1,{data:J,error:K}=await S.from("game_rounds").insert({room_id:d,round_number:Z,drawer_id:w,word_text:g,word_source:W}).select().single();if(K)throw K;return s.value=J,a.value=g,await S.from("game_rooms").update({current_round:Z,current_drawer_id:w}).eq("id",d),{success:!0,round:J}}catch(Z){return console.error("創建輪次錯誤:",Z),{success:!1,error:Z instanceof Error?Z.message:"創建輪次失敗"}}}function n(d){return s.value?G.value.some(w=>w.round_id===s.value.id&&w.user_id===d&&w.is_correct):!1}const u=y(()=>!s.value||!c.user?!1:s.value.drawer_id===c.user.id);async function _(){if(!s.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const d=v.value.length,w=i.value,{updateDrawerScore:g}=rt();console.log("[endRound] 猜中人數:",d,"平均評分:",w),await g(s.value.drawer_id,d,w);const{error:W}=await S.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",s.value.id);if(W)throw W;return{success:!0}}catch(d){return console.error("結束輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束輪次失敗"}}}function D(){s.value=null,a.value=null,M.value=0,G.value=[],b.value="drawing",E.value=[],I.value=[],k.value=!1,P.value=[],q.value=[]}async function X(d,w,g){if(!c.user)return{success:!1,error:"用戶未登錄"};try{const{data:W,error:Z}=await S.from("drawing_ratings").upsert({round_id:d,rater_id:c.user.id,drawer_id:w,rating:g},{onConflict:"round_id,rater_id"}).select().single();if(Z)throw Z;return W&&t(W),{success:!0,rating:W}}catch(W){return console.error("提交評分錯誤:",W),{success:!1,error:W instanceof Error?W.message:"提交評分失敗"}}}async function ee(d){try{const{data:w,error:g}=await S.from("drawing_ratings").select("*").eq("round_id",d);if(g)throw g;return I.value=w||[],{success:!0,ratings:w}}catch(w){return console.error("載入評分錯誤:",w),{success:!1,error:w instanceof Error?w.message:"載入評分失敗"}}}return{currentRound:s,currentWord:a,currentWordLength:M,guesses:G,correctGuesses:v,currentRoundGuesses:L,currentRoundCorrectGuesses:B,isCurrentDrawer:u,roundStatus:b,wordOptions:E,ratings:I,averageRating:i,hintGiven:k,revealedIndices:P,revealedChars:q,loadCurrentRound:h,loadGuesses:$,loadAllGuesses:F,createRound:oe,hasGuessed:n,endRound:_,clearGame:D,setRoundStatus:R,setWordOptions:f,addRating:t,clearRatings:r,submitRating:X,loadRatings:ee,giveHint:l,setHintState:m,setWordLength:H,resetHint:N}});function tr(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function or(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function nr(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function Ut(e){return e.trim().length===0}function $t(e,c=100){return e.length>c}const tt=Ue("story",()=>{const e=ge(),c=O([]),s=O([]),a=O([]),M=O("setup"),G=O(!1),v=O(null),L=y(()=>{const n=c.value.filter(u=>u.itemType==="text");return n.length===0?null:n[n.length-1]}),B=y(()=>{if(c.value.length===0)return null;const n=c.value[0];return n&&n.itemType==="text"?n.content:null}),b=y(()=>e.user&&s.value.find(n=>n.userId===e.user.id)||null),E=y(()=>e.user&&a.value.find(n=>n.voterId===e.user.id)||null),I=y(()=>{const n=new Map;for(const u of s.value)n.set(u.id,0);for(const u of a.value){const _=n.get(u.submissionId)||0;n.set(u.submissionId,_+1)}return n}),k=y(()=>{if(s.value.length===0)return null;let n=-1,u=[];for(const _ of s.value){const D=I.value.get(_.id)||0;D>n?(n=D,u=[_]):D===n&&u.push(_)}return u.length>0?u[0]:null});async function P(n){try{G.value=!0,v.value=null;const{data:u,error:_}=await S.from("story_chains").select("*").eq("room_id",n).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(_)throw new Error(_.message);return c.value=(u||[]).map(D=>tr(D)),console.log("[StoryStore] 故事鏈已載入:",c.value.length,"項"),{success:!0,data:c.value}}catch(u){return v.value=u instanceof Error?u.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",u),{success:!1,error:v.value}}finally{G.value=!1}}async function q(n){try{G.value=!0,v.value=null;const u={room_id:n.roomId,round_number:n.roundNumber,item_type:n.itemType,content:n.content,author_id:n.authorId,author_name:n.authorName},{data:_,error:D}=await S.from("story_chains").insert(u).select().single();if(D)throw new Error(D.message);const X=tr(_);return c.value.push(X),console.log("[StoryStore] 故事鏈項目已添加:",X),{success:!0,data:X}}catch(u){return v.value=u instanceof Error?u.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",u),{success:!1,error:v.value}}finally{G.value=!1}}async function i(n,u,_,D){return q({roomId:n,roundNumber:0,itemType:"text",content:u,authorId:_,authorName:D})}async function R(n,u,_,D){return q({roomId:n,roundNumber:-1,itemType:"text",content:u,authorId:_,authorName:D})}async function f(n){try{G.value=!0,v.value=null;const{data:u,error:_}=await S.from("story_submissions").select("*").eq("round_id",n).order("created_at",{ascending:!0});if(_)throw new Error(_.message);return s.value=(u||[]).map(D=>or(D)),console.log("[StoryStore] 句子提交已載入:",s.value.length,"項"),{success:!0,data:s.value}}catch(u){return v.value=u instanceof Error?u.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",u),{success:!1,error:v.value}}finally{G.value=!1}}async function t(n,u){if(!e.user)return{success:!1,error:"用戶未登錄"};try{G.value=!0,v.value=null;const _={round_id:n,user_id:e.user.id,sentence:u.trim(),vote_count:0,is_winner:!1},{data:D,error:X}=await S.from("story_submissions").upsert(_,{onConflict:"round_id,user_id"}).select().single();if(X)throw new Error(X.message);const ee=or(D),d=s.value.findIndex(w=>w.roundId===n&&w.userId===e.user.id);return d>=0?s.value[d]=ee:s.value.push(ee),console.log("[StoryStore] 句子已提交:",ee),{success:!0,data:ee}}catch(_){return v.value=_ instanceof Error?_.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",_),{success:!1,error:v.value}}finally{G.value=!1}}async function r(n){try{const{error:u}=await S.from("story_submissions").update({is_winner:!0}).eq("id",n);if(u)throw new Error(u.message);const _=s.value.find(D=>D.id===n);return _&&(_.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",n),{success:!0}}catch(u){return v.value=u instanceof Error?u.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",u),{success:!1,error:v.value}}}async function l(n){try{G.value=!0,v.value=null;const{data:u,error:_}=await S.from("story_votes").select("*").eq("round_id",n);if(_)throw new Error(_.message);return a.value=(u||[]).map(D=>nr(D)),console.log("[StoryStore] 投票記錄已載入:",a.value.length,"項"),{success:!0,data:a.value}}catch(u){return v.value=u instanceof Error?u.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",u),{success:!1,error:v.value}}finally{G.value=!1}}async function m(n,u){if(!e.user)return{success:!1,error:"用戶未登錄"};try{G.value=!0,v.value=null;const _={round_id:n,voter_id:e.user.id,submission_id:u},{data:D,error:X}=await S.from("story_votes").upsert(_,{onConflict:"round_id,voter_id"}).select().single();if(X)throw new Error(X.message);const ee=nr(D),d=a.value.findIndex(w=>w.roundId===n&&w.voterId===e.user.id);return d>=0?a.value[d]=ee:a.value.push(ee),console.log("[StoryStore] 投票已記錄:",ee),{success:!0,data:ee}}catch(_){return v.value=_ instanceof Error?_.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",_),{success:!1,error:v.value}}finally{G.value=!1}}function H(n){M.value=n,console.log("[StoryStore] 階段已更新:",n)}function N(){s.value=[],a.value=[],console.log("[StoryStore] 輪次數據已清除")}function h(){c.value=[],s.value=[],a.value=[],M.value="setup",v.value=null,console.log("[StoryStore] 所有故事數據已清除")}function $(n){c.value.some(_=>_.id===n.id)||(c.value.push(n),console.log("[StoryStore] 本地添加故事鏈項目:",n))}function F(n){const u=s.value.findIndex(_=>_.id===n.id);u>=0?s.value[u]=n:s.value.push(n),console.log("[StoryStore] 本地添加句子提交:",n)}function oe(n){const u=a.value.findIndex(_=>_.roundId===n.roundId&&_.voterId===n.voterId);u>=0?a.value[u]=n:a.value.push(n),console.log("[StoryStore] 本地添加投票記錄:",n)}return{storyChain:c,submissions:s,votes:a,currentPhase:M,loading:G,error:v,latestSentence:L,storyOpening:B,mySubmission:b,myVote:E,voteCounts:I,winningSubmission:k,loadStoryChain:P,addStoryChainItem:q,addStoryOpening:i,addStoryEnding:R,addStoryChainItemLocal:$,loadSubmissions:f,submitSentence:t,markWinningSubmission:r,addSubmissionLocal:F,loadVotes:l,castVote:m,addVoteLocal:oe,setPhase:H,clearRoundData:N,clearAll:h}}),ce=new Map,ie=O("disconnected"),me=new Map,Ie=new Map,Ce=new Set;function ae(...e){}function te(...e){console.warn("[Realtime]",...e)}function le(){const e=Ge(),c=mr();function s(i){const R=`room:${i}`;if(ce.has(R))return ce.get(R);const f=S.channel(R,{config:{presence:{key:"user"},broadcast:{self:!0}}});return ce.set(R,f),f}function a(i,R,f,t,r){i==="SUBSCRIBED"?(ie.value="connected",R.track({user_id:t,...r}).catch(l=>{te("Presence track 失敗:",l)})):i==="CHANNEL_ERROR"||i==="TIMED_OUT"?(ie.value="disconnected",te("訂閱失敗:",i)):i==="CLOSED"&&(ie.value="disconnected")}function M(i,R,f,t){return new Promise((r,l)=>{if(!i||!R){te("缺少 roomCode 或 roomId"),l(new Error("缺少 roomCode 或 roomId"));return}const m=s(i),H=m.state;if(H==="joined"){ie.value="connected",r(m);return}if(H==="joining"){const N=setInterval(()=>{const h=m.state;h==="joined"?(clearInterval(N),r(m)):(h==="closed"||h==="errored")&&(clearInterval(N),l(new Error(`連接失敗: ${h}`)))},100);setTimeout(()=>{clearInterval(N),m.state!=="joined"&&(te("subscribeRoom - 連接超時"),l(new Error("連接超時")))},1e4);return}if(Ce.has(i)){ie.value="connecting",m.subscribe(N=>{a(N,m,i,f,t),N==="SUBSCRIBED"?r(m):(N==="CHANNEL_ERROR"||N==="TIMED_OUT")&&l(new Error(`訂閱失敗: ${N}`))});return}G(m,i,R),Ce.add(i),ie.value="connecting",m.subscribe(N=>{a(N,m,i,f,t),N==="SUBSCRIBED"?r(m):(N==="CHANNEL_ERROR"||N==="TIMED_OUT")&&l(new Error(`訂閱失敗: ${N}`))})})}function G(i,R,f){i.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${f}`},async t=>{ae("房間狀態變化:",t.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${f}`},async t=>{ae("參與者變化:",t.eventType),await e.loadParticipants(f)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${f}`},async t=>{if(ae("輪次變化:",t.eventType,t.new),e.currentRoom){const r=t.new,l=c.currentRound?.id;l?t.eventType==="INSERT"&&r?.id!==l?(ae("輪次變化：新輪次 INSERT",{newId:r?.id,currentId:l}),await c.loadCurrentRound(e.currentRoom.id)):t.eventType:await c.loadCurrentRound(e.currentRoom.id)}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async t=>{const r=t.new;if(r&&c.currentRound&&(await c.loadGuesses(r.round_id),r.is_correct&&e.isHost&&c.roundStatus==="drawing")){const l=c.currentRound.drawer_id,m=e.participants.filter(h=>h.user_id!==l),H=new Set(c.currentRoundCorrectGuesses.map(h=>h.user_id));if(m.length>0&&m.every(h=>H.has(h.user_id))){const{useGame:h}=await Be(async()=>{const{useGame:F}=await Promise.resolve().then(()=>nt);return{useGame:F}},void 0),{endRound:$}=h();await $()}}}).on("broadcast",{event:"drawing"},t=>{const r=me.get(R);r&&t.payload?.stroke&&(ae("分發給",r.size,"個回調"),r.forEach(l=>l(t.payload.stroke)))}).on("broadcast",{event:"game_state"},t=>{ae("收到 game_state 廣播:",t.payload);const r=Ie.get(R);r&&t.payload&&(ae("分發給",r.size,"個遊戲狀態回調"),r.forEach(l=>l(t.payload)))}).on("presence",{event:"sync"},()=>{const t=i.presenceState();ae("Presence 同步，在線:",Object.keys(t).length)})}function v(i,R){return me.has(i)||me.set(i,new Set),me.get(i).add(R),()=>{me.get(i)?.delete(R)}}function L(i,R){const f=s(i),t=`guesses:${R}`;return f[t]||(f.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${R}`},async r=>{ae("收到新猜測記錄:",r.eventType,r.new),await c.loadGuesses(R)}),f[t]=!0),f}function B(i,R){return Ie.has(i)||Ie.set(i,new Set),Ie.get(i).add(R),()=>{Ie.get(i)?.delete(R)}}async function b(i,R){const f=s(i),t=f.state;if(t!=="joined")return te("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{ae("廣播遊戲狀態:",R);const r=await f.send({type:"broadcast",event:"game_state",payload:R});return r==="error"?(te("發送遊戲狀態失敗"),{error:"發送失敗"}):r}catch(r){return te("發送遊戲狀態錯誤:",r),{error:r instanceof Error?r.message:"發送失敗"}}}async function E(i,R){const f=s(i),t=f.state;if(t!=="joined")return te("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const r=await f.send({type:"broadcast",event:"drawing",payload:{stroke:R}});return r==="error"?(te("發送失敗"),{error:"發送失敗"}):r}catch(r){return te("發送錯誤:",r),{error:r instanceof Error?r.message:"發送失敗"}}}function I(i){const R=`room:${i}`,f=ce.get(R);f&&(S.removeChannel(f),ce.delete(R)),me.delete(i),Ce.delete(i)}async function k(i,R,f,t){const r=`room:${i}`,l=ce.get(r);if(!l){try{await M(i,R,f,t)}catch(H){te("連接恢復：重新訂閱失敗:",H)}return}const m=l.state;if(m==="joined"){ie.value="connected";return}if(m!=="joining"&&(m==="errored"||m==="closed")){try{S.removeChannel(l)}catch(H){te("移除異常 Channel 失敗:",H)}ce.delete(r),Ce.delete(i);try{await M(i,R,f,t)}catch(H){te("連接恢復：重新訂閱失敗:",H)}}}function P(){ce.forEach(i=>S.removeChannel(i)),ce.clear(),me.clear(),Ce.clear()}function q(){return ie.value}return{connectionStatus:ie,subscribeRoom:M,subscribeDrawing:v,subscribeGuesses:L,subscribeGameState:B,sendDrawing:E,broadcastGameState:b,unsubscribeRoom:I,unsubscribeAll:P,getConnectionStatus:q,checkAndRestoreConnection:k}}const sr=6,ar=60,ur=60,cr=60,ot=5,qe=10,Oe=5,ke=2,ir=3,_e=O(null),He=O(!1);let pe=null;const fe=O(null);let ye=null;const De=O(new Set),lr=O("setup"),Se=O(null);let Re=null;function fr(){const e=Ge(),c=mr(),s=tt();le();const a=_e,M=He,G=fe,v=y(()=>e.currentRoom?.status||"waiting"),L=y(()=>v.value==="playing"),B=y(()=>v.value==="waiting"),b=y(()=>v.value==="finished"),E=y(()=>c.roundStatus),I=y(()=>E.value==="drawing"),k=y(()=>E.value==="summary"),P=y(()=>e.currentRoom?.game_mode==="storyboard"),q=lr,i=Se,R=y(()=>P.value&&q.value==="drawing"),f=y(()=>P.value&&q.value==="writing"),t=y(()=>P.value&&q.value==="voting"),r=y(()=>P.value&&q.value==="summary"),l=y(()=>P.value&&q.value==="setup"),m=y(()=>P.value&&q.value==="ending"),H=y(()=>c.currentRound),N=y(()=>e.currentRoom?.current_round||0),h=y(()=>e.currentRoom?.settings.rounds||0),$=y(()=>e.currentRoom?.settings.draw_time||60),F=y(()=>c.isCurrentDrawer);function oe(o){console.log("[useGame] startCountdown 開始，時長:",o,"秒"),pe&&clearInterval(pe),_e.value=o,He.value=!0,pe=window.setInterval(()=>{_e.value!==null&&_e.value>0?_e.value--:(n(),L.value&&H.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),g()))},1e3)}function n(){pe&&(clearInterval(pe),pe=null),He.value=!1}function u(){n(),_e.value=null}function _(){console.log("[useGame] startSummaryCountdown 開始"),ye&&clearInterval(ye),fe.value=sr,console.log("[useGame] 開始總結倒計時:",sr,"秒"),ye=window.setInterval(async()=>{fe.value!==null&&fe.value>0?(fe.value--,console.log("[useGame] 總結倒計時:",fe.value)):(D(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await W()))},1e3)}function D(){console.log("[useGame] stopSummaryCountdown"),ye&&(clearInterval(ye),ye=null),fe.value=null}function X(){if(!e.currentRoom)return null;const o=e.currentRoom.words;if(o.length===0)return null;const p=[];for(let x=0;x<o.length;x++)De.value.has(x)||p.push(x);let C=0;if(p.length>0){const x=Math.floor(Math.random()*p.length);C=p[x]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),De.value.clear(),C=Math.floor(Math.random()*o.length);return De.value.add(C),o[C]??null}async function ee(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{De.value.clear();const o=e.participants.length,p=await e.updateRoomSettings({rounds:o});if(!p.success)return p;console.log("[useGame] 輪數已自動設定為房間人數:",o);const C=await e.updateRoomStatus("playing");if(!C.success)return C;if(P.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),de("setup"),s.clearAll();const{broadcastGameState:A}=le();return await A(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await d()}catch(o){return console.error("開始遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"開始遊戲失敗"}}}async function d(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const p=(e.currentRoom.current_round||0)+1;try{const C=(p-1)%e.participants.length,x=e.participants[C];if(console.log("[startDrawingPhase] 第",p,"輪，畫家:",x?.nickname),!x)throw new Error("無法選擇畫家");let A=null;if(P.value){const ne=s.latestSentence;ne?(A={text:ne.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",A.text)):(A={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(A=X(),!A)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",A.text)}await e.updateRoomDrawer(x.user_id);const U=await c.createRound(e.currentRoom.id,x.user_id,A.text,A.source);if(!U.success||!U.round)throw new Error("創建輪次失敗");const{broadcastGameState:re}=le();return P.value?await re(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:x.user_id,drawerName:x.nickname,roundNumber:p,startedAt:U.round.started_at}):await re(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],wordLength:A.text.length,drawerId:x.user_id,drawerName:x.nickname,roundNumber:p,startedAt:U.round.started_at}),{success:!0,drawerId:x.user_id,word:A.text}}catch(C){return console.error("開始繪畫階段錯誤:",C),{success:!1,error:C instanceof Error?C.message:"開始繪畫階段失敗"}}}async function w(){return await d()}async function g(){if(!H.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const o=await c.endRound();if(!o.success)return o;const p=!1,{broadcastGameState:C}=le();return await C(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:p}),{success:!0,gameEnded:p}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}async function W(){return e.currentRoom?e.isHost?(await d(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function Z(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await e.updateRoomStatus("finished"),{success:!0}}catch(o){return console.error("結束遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束遊戲失敗"}}}async function J(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(E.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),D(),await d()}catch(o){return console.error("下一局錯誤:",o),{success:!1,error:o instanceof Error?o.message:"下一局失敗"}}}const K=y(()=>{if(a.value===null)return"--:--";const o=Math.floor(a.value/60),p=a.value%60;return`${o.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`});function de(o){console.log("[useGame] 設置分鏡模式階段:",o),lr.value=o,s.setPhase(o)}function gr(o,p){console.log("[useGame] 開始分鏡模式倒計時:",o,"秒"),Re&&clearInterval(Re),Se.value=o,Re=window.setInterval(()=>{Se.value!==null&&Se.value>0?Se.value--:(Te(),p&&p())},1e3)}function Te(){Re&&(clearInterval(Re),Re=null)}function vr(){Te(),Se.value=null}async function wr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),de("drawing"),s.clearRoundData();const{broadcastGameState:o}=le();return await o(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString()}),{success:!0}}async function hr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const o=new Date().toISOString(),{error:p}=await S.from("game_rooms").update({storyboard_phase:"writing",updated_at:o}).eq("id",e.currentRoom.id);p&&console.error("[useGame] 更新數據庫失敗:",p),de("writing");const{broadcastGameState:C}=le();return await C(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:o}),{success:!0}}async function _r(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const o=new Date().toISOString(),{error:p}=await S.from("game_rooms").update({storyboard_phase:"voting",updated_at:o}).eq("id",e.currentRoom.id);p&&console.error("[useGame] 更新數據庫失敗:",p),de("voting");const{broadcastGameState:C}=le();return await C(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:o}),{success:!0}}async function pr(o){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const p=new Date().toISOString(),{error:C}=await S.from("game_rooms").update({storyboard_phase:"summary",updated_at:p}).eq("id",e.currentRoom.id);C&&console.error("[useGame] 更新數據庫失敗:",C),de("summary");const{broadcastGameState:x}=le();return await x(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:p,storyboardRoundResult:o?{winningSentence:o.winningSentence||"故事繼續發展中...",winnerName:o.winnerName||"",winnerId:o.winnerId||"",winnerVoteCount:o.winnerVoteCount||0,drawerScore:o.drawerScore||0,screenwriterScore:o.screenwriterScore||0}:void 0}),{success:!0}}async function yr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:o}=await S.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);o&&console.error("[useGame] 更新數據庫失敗:",o),de("ending");const{broadcastGameState:p}=le();return await p(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function $e(){const o=s.submissions,p=s.votes;if(o.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const C=new Map;for(const V of o)C.set(V.id,0);for(const V of p){const Q=C.get(V.submissionId)||0;C.set(V.submissionId,Q+1)}let x=-1,A=[];for(const V of o){const Q=C.get(V.id)||0;Q>x?(x=Q,A=[V]):Q===x&&A.push(V)}const U=A.length>1;if(A.length===1)return console.log("[useGame] 唯一最高票勝出:",A[0]?.sentence),{submission:A[0]||null,voteCount:x,hasTie:!1};const re=Math.floor(Math.random()*A.length),ne=A[re]||null;return console.log("[useGame] 平票隨機選擇勝出:",ne?.sentence,"(共",A.length,"個平票)"),{submission:ne,voteCount:x,hasTie:U}}async function Sr(o){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!c.currentRound)return{success:!1,error:"沒有當前輪次"};const p=c.currentRound.round_number,C=c.currentRound.drawer_id,A=e.participants.find(U=>U.user_id===C)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",p);try{const{submission:U,voteCount:re,hasTie:ne}=$e();let V,Q,we;U?(V=U.sentence,Q=U.userId,we=e.participants.find(he=>he.user_id===Q)?.nickname||"編劇",await s.markWinningSubmission(U.id),console.log("[useGame] 勝出句子:",V,"作者:",we,"票數:",re,"平票:",ne)):(V="故事繼續發展中...",Q=C,we=A,console.log("[useGame] 沒有提交，使用默認句子"));let Ae="/placeholder-image.png";if(o)try{const Ee=await new Promise(he=>{o.toBlob(he,"image/png",.9)});if(Ee){const{supabase:he}=await Be(async()=>{const{supabase:Ne}=await import("./index-WLMX7o8f.js").then(Cr=>Cr.O);return{supabase:Ne}},__vite__mapDeps([0,1])),Ir=Date.now(),ze=`storyboard/${e.currentRoom.id}/round_${p}_${Ir}.png`,{error:Ye}=await he.storage.from("canvas-snapshots").upload(ze,Ee,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(Ye)console.error("[useGame] 截圖上傳失敗:",Ye);else{const{data:Ne}=he.storage.from("canvas-snapshots").getPublicUrl(ze);Ae=Ne.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Ae)}}}catch(Ee){console.error("[useGame] 截圖上傳錯誤:",Ee)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await s.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:p,itemType:"image",content:Ae,authorId:C,authorName:A}),await s.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:p,itemType:"text",content:V,authorId:Q,authorName:we}),console.log("[useGame] Story_Chain 已更新");const Ve=s.votes.length;let xe=0;U&&(xe=qe,await ve(Q,xe),console.log("[useGame] 編劇勝出得分:",xe,"分給",we));const Me=Oe+Ve*ke;await ve(C,Me),console.log("[useGame] 畫家得分:",Me,"分給",A,"(投票人數:",Ve,")");const je={success:!0,winningSentence:V,winnerName:we,winnerId:Q,winnerVoteCount:re,drawerScore:Me,screenwriterScore:xe,imageUrl:Ae};return console.log("[useGame] 輪次結算完成:",je),je}catch(U){return console.error("[useGame] 輪次結算錯誤:",U),{success:!1,error:U instanceof Error?U.message:"輪次結算失敗"}}}function Rr(){const o=document.querySelector("canvas.drawing-canvas");return o||document.querySelector("canvas")||null}function br(o){switch(o){case"drawing":return ar;case"writing":return ur;case"voting":return cr;default:return 0}}function We(){return qe}function Le(o){return Oe+o*ke}function Ze(o){return Math.round(o*ir)}async function Er(o,p,C,x=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const A=We();console.log("[useGame] 編劇勝出得分:",A,"分給",o),await ve(o,A);const U=Le(C);if(console.log("[useGame] 畫家得分:",U,"分給",p,"(投票人數:",C,")"),await ve(p,U),x>0){const re=Ze(x);console.log("[useGame] 評星加分:",re,"分給",p,"(平均評星:",x,")"),await ve(p,re)}return{success:!0}}catch(A){return console.error("[useGame] 計算分鏡模式得分錯誤:",A),{success:!1,error:A instanceof Error?A.message:"計算得分失敗"}}}async function ve(o,p){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:C}=await Be(async()=>{const{supabase:V}=await import("./index-WLMX7o8f.js").then(Q=>Q.O);return{supabase:V}},__vite__mapDeps([0,1])),{data:x,error:A}=await C.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",o).single();if(A)throw A;const U=(x?.score||0)+p,{error:re}=await C.from("room_participants").update({score:U}).eq("room_id",e.currentRoom.id).eq("user_id",o);if(re)throw re;const ne=e.participants.findIndex(V=>V.user_id===o);return ne!==-1&&e.participants[ne]&&(e.participants[ne].score=U),console.log("[useGame] 玩家",o,"得分更新為",U),!0}catch(C){return console.error("[useGame] 更新玩家分數錯誤:",C),!1}}return Ar(()=>{n(),D(),Te()}),{gameStatus:v,isPlaying:L,isWaiting:B,isFinished:b,currentRound:H,currentRoundNumber:N,totalRounds:h,drawTime:$,isCurrentDrawer:F,timeRemaining:a,isCountingDown:M,formattedTime:K,roundStatus:E,isDrawing:I,isSummary:k,summaryTimeRemaining:G,isStoryboardMode:P,storyboardPhase:q,storyboardTimeRemaining:i,isStoryboardDrawing:R,isStoryboardWriting:f,isStoryboardVoting:t,isStoryboardSummary:r,isStoryboardSetup:l,isStoryboardEnding:m,startGame:ee,newGame:J,startNextRound:w,startDrawingPhase:d,endRound:g,continueToNextRound:W,endGame:Z,startCountdown:oe,stopCountdown:n,startSummaryCountdown:_,stopSummaryCountdown:D,resetCountdown:u,setStoryboardPhase:de,startStoryboardCountdown:gr,stopStoryboardCountdown:Te,resetStoryboardCountdown:vr,enterStoryboardDrawingPhase:wr,enterStoryboardWritingPhase:hr,enterStoryboardVotingPhase:_r,enterStoryboardSummaryPhase:pr,enterStoryboardEndingPhase:yr,getStoryboardPhaseDuration:br,calculateWinningSentence:$e,finalizeStoryboardRound:Sr,getCanvasElement:Rr,calculateScreenwriterWinScore:We,calculateDirectorScore:Le,calculateRatingBonus:Ze,calculateStoryboardRoundScores:Er,updateStoryboardPlayerScore:ve,STORYBOARD_DRAWING_TIME:ar,STORYBOARD_WRITING_TIME:ur,STORYBOARD_VOTING_TIME:cr,STORYBOARD_SUMMARY_TIME:ot,SCREENWRITER_WIN_SCORE:qe,DIRECTOR_BASE_SCORE:Oe,DIRECTOR_VOTE_BONUS:ke,RATING_BONUS_MULTIPLIER:ir}}const nt=Object.freeze(Object.defineProperty({__proto__:null,useGame:fr},Symbol.toStringTag,{value:"Module"})),st={class:"waiting-lobby"},at={class:"card"},ut={class:"card-body"},ct={class:"room-info text-center margin-bottom-medium"},it={class:"card-title text-hand-title"},lt={class:"room-details"},dt={class:"detail-item margin-bottom-small"},mt={class:"badge badge-secondary room-code-badge"},ft={class:"detail-row"},gt={class:"detail-item"},vt={class:"badge"},wt={class:"detail-item"},ht={class:"players-section margin-bottom-medium"},_t={class:"text-hand-title margin-bottom-small"},pt={class:"players-list"},yt={class:"player-avatar"},St={class:"player-info"},Rt={class:"player-name"},bt={key:0,class:"badge badge-warning"},Et={class:"room-settings margin-bottom-medium"},It={class:"setting-item"},Ct={class:"setting-value"},Gt={class:"setting-item"},Tt={class:"setting-label"},At={class:"setting-value"},xt={key:0,class:"setting-item"},Pt={class:"setting-value"},Dt={class:"lobby-actions"},Mt=["disabled"],Nt={key:1,class:"alert alert-warning text-center"},qt=["disabled"],Ot={key:0,class:"alert alert-danger margin-top-small"},kt=dr({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:c}){const s=e,a=c,{isHost:M,canStartGame:G,minPlayersRequired:v,leaveRoom:L,loading:B,error:b}=Xr(),{startGame:E}=fr(),I=y(()=>{const f=s.room?.settings.rounds||0,t=s.participants.length,r=f>0?f:t;return r>0?r:1});function k(f){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[f||""]||f||"未知"}function P(f){return{classic:"傳統模式",storyboard:"分鏡接龍"}[f||""]||"傳統模式"}function q(f){return s.room?.host_id===f}async function i(){(await E()).success&&a("startGame")}async function R(){(await L()).success&&a("leaveRoom")}return(f,t)=>(Y(),z("div",st,[T("div",at,[T("div",ut,[T("div",ct,[T("h2",it,j(e.room?.name),1),T("div",lt,[T("div",dt,[t[0]||(t[0]=ue(" 房間碼：",-1)),T("span",mt,j(e.room?.code),1)]),T("div",ft,[T("div",gt,[t[1]||(t[1]=ue(" 狀態：",-1)),T("span",vt,j(k(e.room?.status)),1)]),T("div",wt,[t[2]||(t[2]=ue(" 模式：",-1)),T("span",{class:Ke(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},j(P(e.room?.game_mode)),3)])])])]),T("div",ht,[T("h4",_t,"玩家列表 ("+j(e.participants.length)+")",1),T("div",pt,[(Y(!0),z(Fe,null,xr(e.participants,r=>(Y(),z("div",{key:r.id,class:Ke(["player-item",{"is-host":q(r.user_id)}])},[T("div",yt,j(r.nickname.charAt(0).toUpperCase()),1),T("div",St,[T("div",Rt,[ue(j(r.nickname)+" ",1),q(r.user_id)?(Y(),z("span",bt," 房主 ")):be("",!0)])])],2))),128))])]),T("div",Et,[T("div",It,[t[4]||(t[4]=T("span",{class:"setting-label"},"繪畫時間：",-1)),T("span",Ct,[T("strong",null,j(e.room?.settings.draw_time),1),t[3]||(t[3]=ue("秒",-1))])]),T("div",Gt,[T("span",Tt,j(e.room?.game_mode==="storyboard"?"每場鏡數":"每局輪數")+"：",1),T("span",At,[T("strong",null,j(I.value),1),ue(j(e.room?.game_mode==="storyboard"?"鏡":"輪"),1)])]),e.room?.game_mode!=="storyboard"?(Y(),z("div",xt,[t[6]||(t[6]=T("span",{class:"setting-label"},"詞語總數：",-1)),T("span",Pt,[T("strong",null,j(e.room?.word_count),1),t[5]||(t[5]=ue("個",-1))])])):be("",!0)]),T("div",Dt,[se(M)&&se(G)?(Y(),z("button",{key:0,disabled:se(B),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:i},j(se(B)?"開始中":"開始遊戲"),9,Mt)):se(M)?(Y(),z("div",Nt,[ue(" 至少需要 "+j(se(v))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(Y(),z(Fe,{key:0},[ue(" （分鏡接龍模式） ")],64)):be("",!0)])):be("",!0),T("button",{disabled:se(B),class:"paper-btn btn-secondary btn-block",onClick:R},j(se(B)?"離開中":"離開房間"),9,qt)]),se(b)?(Y(),z("div",Ot,j(se(b)),1)):be("",!0)])])]))}}),Wt=Pr(kt,[["__scopeId","data-v-ec12b121"]]);export{Bt as I,Wt as W,le as a,Ge as b,mr as c,rt as d,tt as e,Ut as f,fr as g,$t as i,Xr as u};
