import{l as we,r as G,f as _,u as F,x as R,m as ye,d as Se,c as $,e as k,a as ne,t as M,s as ie,F as Ee,p as be,b as B,o as j,_ as xe}from"./index-XOY1qjoi.js";const z=we("room",()=>{const e=G(null),f=G([]),u=G(!1),a=G(null),p=_(()=>{const r=F();return e.value?.host_id===r.user?.id});async function E(r){try{u.value=!0,a.value=null;const t=F();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(i){console.warn("載入用戶資料時發生錯誤（非關鍵）:",i)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");if(r.settings.rounds>r.words.length)throw new Error("輪數不能超過詞語總數");let n=null,c=0;const m=10;for(;c<m&&!n;){c++;const D={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:o,error:s}=await R.from("game_rooms").insert(D).select().single();if(s){if(s.code==="23505")continue;throw new Error(s.message||"插入房間失敗")}if(o){n=o;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const T={room_id:n.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:i}=await R.from("room_participants").insert(T);i&&console.error("創建參與記錄錯誤:",i)}catch(i){console.error("創建參與記錄時發生錯誤:",i)}try{const{data:i,error:D}=await R.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});D?console.error("載入參與者列表失敗:",D):i&&(f.value=i)}catch(i){console.error("載入參與者列表時發生錯誤:",i)}return e.value=n,{success:!0,room:n}}catch(t){return a.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:a.value}}finally{u.value=!1}}async function S(r,t){try{u.value=!0,a.value=null;const n=F();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:c,error:m}=await R.from("game_rooms").select("*").eq("code",r).single();if(m||!c)throw new Error("房間不存在");if(c.status!=="waiting")throw new Error("房間已開始或已結束");const{data:T}=await R.from("room_participants").select("*").eq("room_id",c.id).eq("user_id",n.user.id).maybeSingle();if(T)return e.value=c,await g(c.id),{success:!0,room:c};const{error:i}=await R.from("room_participants").insert({room_id:c.id,user_id:n.user.id,nickname:t.trim(),score:0});if(i){if(i.code==="23505"||i.message.includes("duplicate"))return e.value=c,await g(c.id),{success:!0,room:c};throw i}return e.value=c,await g(c.id),{success:!0,room:c}}catch(n){return a.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:a.value}}finally{u.value=!1}}async function y(){try{if(!e.value)return{success:!0};u.value=!0,a.value=null;const r=F();if(!r.user)throw new Error("請先登入");const{error:t}=await R.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(p.value){const{error:n}=await R.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,f.value=[],{success:!0}}catch(r){return a.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,f.value=[],{success:!1,error:a.value}}finally{u.value=!1}}async function g(r){try{const{data:t,error:n}=await R.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(n)throw n;f.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function l(r){try{u.value=!0,a.value=null;const{data:t,error:n}=await R.from("game_rooms").select("*").eq("id",r).single();if(n)throw n;return e.value=t,await g(r),{success:!0,room:t}}catch(t){return a.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:a.value}}finally{u.value=!1}}async function v(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await R.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(e.value){const n=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(t){return a.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:a.value}}}async function h(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await R.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return a.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:a.value}}}function C(){e.value=null,f.value=[],a.value=null}function q(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function b(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!p.value)return{success:!1,error:"只有房主可以踢人"};const t=F();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};u.value=!0,a.value=null;const{data:n,error:c}=await R.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(c)throw new Error(c.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await g(e.value.id),{success:!0}}catch(t){return a.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:a.value}}finally{u.value=!1}}return{currentRoom:e,participants:f,loading:u,error:a,isHost:p,createRoom:E,joinRoom:S,leaveRoom:y,kickPlayer:b,loadParticipants:g,loadRoom:l,updateRoomStatus:v,updateRoomDrawer:h,setCurrentDrawer:q,clearRoom:C}});function ke(){const e=z(),f=_(()=>e.currentRoom),u=_(()=>e.participants),a=_(()=>e.isHost),p=_(()=>!f.value||f.value.status!=="waiting"||!a.value?!1:u.value.length>=2);async function E(g){return await e.createRoom(g)}async function S(g,l){return await e.joinRoom(g,l)}async function y(){return await e.leaveRoom()}return{currentRoom:f,participants:u,isHost:a,canStartGame:p,loading:_(()=>e.loading),error:_(()=>e.error),createRoom:E,joinRoom:S,leaveRoom:y}}const ue=100,le=50,de=10,fe=100,me=[1,.8,.6,.4,.2];function Te(){const e=z();function f(l){const v=Math.min(l,me.length-1),h=me[v]??0;return Math.round(ue*h)}function u(l){return l===0?0:le+l*de}async function a(l,v){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:h,error:C}=await R.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",l).single();if(C)throw C;const q=(h?.score||0)+v,{error:b}=await R.from("room_participants").update({score:q}).eq("room_id",e.currentRoom.id).eq("user_id",l);if(b)throw b;const r=e.participants.findIndex(t=>t.user_id===l);return r!==-1&&e.participants[r]&&(e.participants[r].score=q),!0}catch(h){return console.error("更新玩家分數錯誤:",h),!1}}async function p(l,v){const h=u(v);return h===0?!0:await a(l,h)}function E(){if(!e.participants||e.participants.length===0)return null;const l=[...e.participants].sort((v,h)=>h.score-v.score);return l.length===1||l[0]&&l[1]&&l[0].score>l[1].score?{user_id:l[0]?.user_id||"",score:l[0]?.score||0}:{user_id:l[0]?.user_id||"",score:l[0]?.score||0}}const S=_(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((v,h)=>h.score!==v.score?h.score-v.score:new Date(v.joined_at).getTime()-new Date(h.joined_at).getTime()).map((v,h)=>({id:v.id,user_id:v.user_id,score:v.score,rank:h+1}))),y=_(()=>e.currentRoom?.status!=="finished"?null:E());function g(){return fe}return{GUESS_BASE_SCORE:ue,DRAWING_BASE_SCORE:le,DRAWING_BONUS_PER_GUESS:de,WINNER_BONUS:fe,calculateGuessScore:f,calculateDrawingScore:u,calculateWinner:E,updatePlayerScore:a,updateDrawerScore:p,playerRankings:S,winner:y,getWinnerBonus:g}}const ve=we("game",()=>{const e=z(),f=F(),u=G(null),a=G(null),p=G([]),E=_(()=>p.value.filter(o=>o.is_correct)),S=G("drawing"),y=G([]),g=G([]),l=_(()=>g.value.length===0?0:g.value.reduce((s,w)=>s+w.rating,0)/g.value.length);function v(o){S.value=o}function h(o){y.value=o}function C(o){const s=g.value.findIndex(w=>w.rater_id===o.rater_id);s>=0?g.value[s]=o:g.value.push(o)}function q(){g.value=[]}async function b(o){try{const{data:s,error:w}=await R.from("game_rounds").select("*").eq("room_id",o).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(w)throw w;if(s){if(u.value=s,a.value=s.word_text,s.status){const N=S.value==="selecting",O=s.status==="completed";N&&O||(S.value=s.status)}s.word_options&&Array.isArray(s.word_options)&&(y.value=s.word_options),await r(s.id)}return{success:!0,round:s}}catch(s){return console.error("載入當前輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入輪次失敗"}}}async function r(o){try{const{data:s,error:w}=await R.from("guesses").select("*").eq("round_id",o).order("guessed_at",{ascending:!0});if(w)throw w;p.value=s||[]}catch(s){console.error("載入猜測記錄錯誤:",s)}}async function t(o,s,w,N){try{if(!e.currentRoom)throw new Error("沒有當前房間");const O=(e.currentRoom.current_round||0)+1,{data:H,error:Y}=await R.from("game_rounds").insert({room_id:o,round_number:O,drawer_id:s,word_text:w,word_source:N}).select().single();if(Y)throw Y;return u.value=H,a.value=w,p.value=[],await R.from("game_rooms").update({current_round:O,current_drawer_id:s}).eq("id",o),{success:!0,round:H}}catch(O){return console.error("創建輪次錯誤:",O),{success:!1,error:O instanceof Error?O.message:"創建輪次失敗"}}}function n(o){return p.value.some(s=>s.user_id===o&&s.is_correct)}const c=_(()=>!u.value||!f.user?!1:u.value.drawer_id===f.user.id);async function m(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const o=E.value.length,{updateDrawerScore:s}=Te();await s(u.value.drawer_id,o);const{error:w}=await R.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",u.value.id);if(w)throw w;return{success:!0}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}function T(){u.value=null,a.value=null,p.value=[],S.value="drawing",y.value=[],g.value=[]}async function i(o,s,w){if(!f.user)return{success:!1,error:"用戶未登錄"};try{const{data:N,error:O}=await R.from("drawing_ratings").upsert({round_id:o,rater_id:f.user.id,drawer_id:s,rating:w},{onConflict:"round_id,rater_id"}).select().single();if(O)throw O;return N&&C(N),{success:!0,rating:N}}catch(N){return console.error("提交評分錯誤:",N),{success:!1,error:N instanceof Error?N.message:"提交評分失敗"}}}async function D(o){try{const{data:s,error:w}=await R.from("drawing_ratings").select("*").eq("round_id",o);if(w)throw w;return g.value=s||[],{success:!0,ratings:s}}catch(s){return console.error("載入評分錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入評分失敗"}}}return{currentRound:u,currentWord:a,guesses:p,correctGuesses:E,isCurrentDrawer:c,roundStatus:S,wordOptions:y,ratings:g,averageRating:l,loadCurrentRound:b,loadGuesses:r,createRound:t,hasGuessed:n,endRound:m,clearGame:T,setRoundStatus:v,setWordOptions:h,addRating:C,clearRatings:q,submitRating:i,loadRatings:D}}),P=new Map,A=G("disconnected"),L=new Map,X=new Set,Z=new Map;function K(...e){}function U(...e){console.warn("[Realtime]",...e)}function ee(){const e=z(),f=ve();function u(r){const t=`room:${r}`;if(P.has(t))return P.get(t);const n=R.channel(t,{config:{presence:{key:"user"},broadcast:{self:!1}}});return P.set(t,n),n}function a(r){const t=Z.get(r);t&&(clearTimeout(t),Z.delete(r))}function p(r,t,n,c,m){r==="SUBSCRIBED"?(A.value="connected",a(n),t.track({user_id:c,...m}).catch(T=>{U("Presence track 失敗:",T)})):r==="CHANNEL_ERROR"||r==="TIMED_OUT"?(A.value="disconnected",U("訂閱失敗:",r),E(n,c,m)):r==="CLOSED"&&(A.value="disconnected")}function E(r,t,n,c=0){if(c>=3){U("重連失敗次數過多，停止重連");return}a(r);const m=Math.min(1e3*Math.pow(2,c),1e4),T=window.setTimeout(()=>{const i=P.get(`room:${r}`);i&&i.state!=="joined"&&i.subscribe(D=>{D==="SUBSCRIBED"?p(D,i,r,t,n):(D==="CHANNEL_ERROR"||D==="TIMED_OUT")&&E(r,t,n,c+1)})},m);Z.set(r,T)}function S(r,t,n,c){return new Promise((m,T)=>{if(!r||!t){U("缺少 roomCode 或 roomId"),T(new Error("缺少 roomCode 或 roomId"));return}const i=u(r),D=i.state;if(D==="joined"){A.value="connected",m(i);return}if(D==="joining"){const o=setInterval(()=>{const s=i.state;s==="joined"?(clearInterval(o),m(i)):(s==="closed"||s==="errored")&&(clearInterval(o),T(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(o),i.state!=="joined"&&T(new Error("連接超時"))},5e3);return}if(X.has(r)){A.value="connecting",i.subscribe(o=>{p(o,i,r,n,c),o==="SUBSCRIBED"?m(i):(o==="CHANNEL_ERROR"||o==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${o}`))});return}i.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async o=>{K("房間狀態變化:",o.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async o=>{K("參與者變化:",o.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async o=>{K("輪次變化:",o.eventType),e.currentRoom&&await f.loadCurrentRound(e.currentRoom.id)}).on("broadcast",{event:"drawing"},o=>{const s=L.get(r);s&&o.payload?.stroke&&s.forEach(w=>w(o.payload.stroke))}).on("presence",{event:"sync"},()=>{const o=i.presenceState();K("Presence 同步，在線:",Object.keys(o).length)}),X.add(r),A.value="connecting",i.subscribe(o=>{p(o,i,r,n,c),o==="SUBSCRIBED"?m(i):(o==="CHANNEL_ERROR"||o==="TIMED_OUT")&&T(new Error(`訂閱失敗: ${o}`))})})}function y(r,t){return L.has(r)||L.set(r,new Set),L.get(r).add(t),()=>{L.get(r)?.delete(t)}}function g(r,t){const n=u(r),c=`guesses:${t}`;return n[c]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${t}`},async m=>{K("猜測記錄變化:",m.eventType),await f.loadGuesses(t)}),n[c]=!0),n}function l(r,t){const n=u(r),c=`gameState:${r}`;return n[c]||(n.on("broadcast",{event:"game_state"},m=>{K("收到遊戲狀態廣播:",m.payload),t(m.payload)}),n[c]=!0),n}async function v(r,t){const n=u(r),c=n.state;if(c!=="joined")return U("Channel 未連接，狀態:",c,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{K("廣播遊戲狀態:",t);const m=await n.send({type:"broadcast",event:"game_state",payload:t});return m==="error"?(U("發送遊戲狀態失敗"),{error:"發送失敗"}):m}catch(m){return U("發送遊戲狀態錯誤:",m),{error:m instanceof Error?m.message:"發送失敗"}}}async function h(r,t){const n=u(r),c=n.state;if(c!=="joined")return U("Channel 未連接，無法發送繪畫數據，狀態:",c),{error:"Channel 未連接"};try{const m=await n.send({type:"broadcast",event:"drawing",payload:{stroke:t}});return m==="error"?(U("發送失敗"),{error:"發送失敗"}):m}catch(m){return U("發送錯誤:",m),{error:m instanceof Error?m.message:"發送失敗"}}}function C(r){const t=`room:${r}`,n=P.get(t);a(r),n&&(R.removeChannel(n),P.delete(t)),L.delete(r),X.delete(r)}function q(){Z.forEach((r,t)=>a(t)),P.forEach(r=>R.removeChannel(r)),P.clear(),L.clear(),X.clear()}function b(){return A.value}return{connectionStatus:A,subscribeRoom:S,subscribeDrawing:y,subscribeGuesses:g,subscribeGameState:l,sendDrawing:h,broadcastGameState:v,unsubscribeRoom:C,unsubscribeAll:q,getConnectionStatus:b}}const De=15,ge=8;function Ie(){const e=z(),f=ve(),u=F();ee();const a=G(null),p=G(!1);let E=null;const S=G(null);let y=null;const g=G(null);let l=null;const v=_(()=>e.currentRoom?.status||"waiting"),h=_(()=>v.value==="playing"),C=_(()=>v.value==="waiting"),q=_(()=>v.value==="finished"),b=_(()=>f.roundStatus),r=_(()=>b.value==="selecting"),t=_(()=>b.value==="drawing"),n=_(()=>b.value==="summary"),c=_(()=>f.currentRound),m=_(()=>e.currentRoom?.current_round||0),T=_(()=>e.currentRoom?.settings.rounds||0),i=_(()=>e.currentRoom?.settings.draw_time||60),D=_(()=>f.wordOptions),o=_(()=>f.isCurrentDrawer);function s(d){E&&clearInterval(E),a.value=d,p.value=!0,E=window.setInterval(()=>{a.value!==null&&a.value>0?a.value--:(w(),h.value&&c.value&&e.isHost&&ae())},1e3)}function w(){E&&(clearInterval(E),E=null),p.value=!1}function N(){w(),a.value=null}function O(){y&&clearInterval(y),S.value=De,y=window.setInterval(()=>{if(S.value!==null&&S.value>0)S.value--;else{H();const I=e.currentRoom?.current_drawer_id===u.user?.id;if(r.value&&I&&D.value.length>0){console.log("[useGame] 選詞超時，畫家自動選擇第一個詞");const x=D.value[0];x&&oe(x)}}},1e3)}function H(){y&&(clearInterval(y),y=null),S.value=null}function Y(){l&&clearInterval(l),g.value=ge,console.log("[useGame] 開始總結倒計時:",ge,"秒"),l=window.setInterval(async()=>{g.value!==null&&g.value>0?g.value--:(re(),console.log("[useGame] 總結倒計時結束, isSummary:",n.value,"isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await ce()))},1e3)}function re(){l&&(clearInterval(l),l=null),g.value=null}function he(){if(!e.currentRoom)return[];const d=e.currentRoom.words,I=e.currentRoom.current_round||0,x=d.slice(I);if(x.length===0)return[];const W=[...x].sort(()=>Math.random()-.5);return W.slice(0,Math.min(3,W.length)).map(Q=>({text:Q.text,source:Q.source}))}async function _e(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const d=await e.updateRoomStatus("playing");return d.success?await J():d}catch(d){return console.error("開始遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"開始遊戲失敗"}}}async function J(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const d=e.currentRoom.current_round||0,I=d+1;if(d>=T.value)return await te(),{success:!1,error:"所有輪次已完成"};try{const x=(I-1)%e.participants.length,W=e.participants[x];if(console.log("[startSelectionPhase] 下一輪:",I,"畫家索引:",x,"畫家:",W?.nickname),!W)throw new Error("無法選擇畫家");const V=he();if(V.length===0)throw new Error("沒有可用的詞語");f.setWordOptions(V),f.setRoundStatus("selecting"),f.clearRatings(),await e.updateRoomDrawer(W.user_id);const{broadcastGameState:Q}=ee();return await Q(e.currentRoom.code,{roundStatus:"selecting",wordOptions:V,drawerId:W.user_id}),O(),{success:!0,drawerId:W.user_id,options:V}}catch(x){return console.error("開始選詞階段錯誤:",x),{success:!1,error:x instanceof Error?x.message:"開始選詞階段失敗"}}}async function oe(d){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const I=e.currentRoom.current_drawer_id;if(!I)return{success:!1,error:"沒有當前畫家"};if(I!==u.user?.id)return console.log("[selectWord] 非畫家嘗試選詞，忽略"),{success:!1,error:"只有畫家可以選詞"};if(f.roundStatus!=="selecting")return console.log("[selectWord] 當前不是選詞階段，忽略"),{success:!1,error:"當前不是選詞階段"};H(),console.log("[selectWord] 畫家選擇詞語:",d.text);try{const x=await f.createRound(e.currentRoom.id,I,d.text,d.source);if(x.success&&x.round){f.setRoundStatus("drawing"),f.setWordOptions([]);const{broadcastGameState:W}=ee();await W(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:I}),s(i.value)}return x}catch(x){return console.error("選擇詞語錯誤:",x),{success:!1,error:x instanceof Error?x.message:"選擇詞語失敗"}}}async function se(){return await J()}async function ae(){if(!c.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{w();const d=await f.endRound();if(!d.success)return d;f.setRoundStatus("summary");const{broadcastGameState:I}=ee();return await I(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0}),Y(),{success:!0,gameEnded:!1}}catch(d){return console.error("結束輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束輪次失敗"}}}async function ce(){return e.currentRoom?(re(),(e.currentRoom.current_round||0)>=T.value?(await te(),{success:!0,gameEnded:!0}):(await J(),{success:!0,gameEnded:!1})):{success:!1,error:"沒有當前房間"}}async function te(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return w(),await e.updateRoomStatus("finished"),{success:!0}}catch(d){return console.error("結束遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束遊戲失敗"}}}async function pe(){if(!c.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!o.value)return{success:!1,error:"只有畫家可以跳過詞語"};try{return w(),await se()}catch(d){return console.error("跳過詞語錯誤:",d),{success:!1,error:d instanceof Error?d.message:"跳過詞語失敗"}}}const Re=_(()=>{if(a.value===null)return"--:--";const d=Math.floor(a.value/60),I=a.value%60;return`${d.toString().padStart(2,"0")}:${I.toString().padStart(2,"0")}`});return ye(()=>{w(),H(),re()}),{gameStatus:v,isPlaying:h,isWaiting:C,isFinished:q,currentRound:c,currentRoundNumber:m,totalRounds:T,drawTime:i,isCurrentDrawer:o,timeRemaining:a,isCountingDown:p,formattedTime:Re,roundStatus:b,isSelecting:r,isDrawing:t,isSummary:n,wordOptions:D,selectionTimeRemaining:S,summaryTimeRemaining:g,startGame:_e,startNextRound:se,startSelectionPhase:J,selectWord:oe,endRound:ae,continueToNextRound:ce,endGame:te,skipWord:pe,startCountdown:s,stopCountdown:w,stopSelectionCountdown:H,resetCountdown:N}}const Ge={class:"waiting-lobby"},Ce={class:"card"},Ne={class:"card-body"},Oe={class:"margin-bottom-medium"},qe={class:"card-title text-hand-title"},Me={class:"text-small"},We={style:{"font-family":"monospace"}},Ue={class:"text-small margin-top-small"},Be={class:"margin-bottom-medium"},Pe={class:"text-hand-title"},Ae={class:"margin-top-small"},He={style:{"flex-shrink":"0","margin-right":"0.75rem"}},$e={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},je={style:{flex:"1"}},Le={class:"text-hand",style:{"font-weight":"500"}},Ke={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},Fe={class:"margin-bottom-medium text-small"},Ve=["disabled"],ze={key:1,class:"text-small text-center margin-bottom-small"},Ye=["disabled"],Je={key:0,class:"alert alert-danger margin-top-medium"},Qe=Se({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:f}){const u=e,a=f,{isHost:p,canStartGame:E,leaveRoom:S,loading:y,error:g}=ke(),{startGame:l}=Ie();function v(b){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[b||""]||b||"未知"}function h(b){return u.room?.host_id===b}async function C(){(await l()).success&&a("startGame")}async function q(){(await S()).success&&a("leaveRoom")}return(b,r)=>(j(),$("div",Ge,[k("div",Ce,[k("div",Ne,[k("div",Oe,[k("h2",qe,M(e.room?.name),1),k("div",Me,[r[0]||(r[0]=ie(" 房間碼：",-1)),k("span",We,M(e.room?.code),1)]),k("div",Ue," 狀態："+M(v(e.room?.status)),1)]),k("div",Be,[k("h4",Pe,"玩家列表 ("+M(e.participants.length)+")",1),k("div",Ae,[(j(!0),$(Ee,null,be(e.participants,t=>(j(),$("div",{key:t.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[k("div",He,[k("div",$e,M(t.nickname.charAt(0).toUpperCase()),1)]),k("div",je,[k("div",Le,[ie(M(t.nickname)+" ",1),h(t.user_id)?(j(),$("span",Ke," 房主 ")):ne("",!0)])])]))),128))])]),k("div",Fe,[k("div",null,"繪畫時間："+M(e.room?.settings.draw_time)+" 秒",1),k("div",null,"輪數："+M(e.room?.settings.rounds)+" 輪",1),k("div",null,"詞語總數："+M(e.room?.word_count)+" 個",1)]),k("div",null,[B(p)&&B(E)?(j(),$("button",{key:0,onClick:C,disabled:B(y),class:"paper-btn btn-primary btn-block margin-bottom-small"},M(B(y)?"開始中...":"開始遊戲"),9,Ve)):B(p)?(j(),$("div",ze," 至少需要 2 個玩家才能開始遊戲 ")):ne("",!0),k("button",{onClick:q,disabled:B(y),class:"paper-btn btn-secondary btn-block"},M(B(y)?"離開中...":"離開房間"),9,Ye)]),B(g)?(j(),$("div",Je,M(B(g)),1)):ne("",!0)])])]))}}),Ze=xe(Qe,[["__scopeId","data-v-769c8ad1"]]);export{Ze as W,Ie as a,ee as b,z as c,ve as d,Te as e,ke as u};
