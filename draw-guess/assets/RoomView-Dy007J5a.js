import{l as Pe,r as T,u as J,f as W,d as j,h as Y,i as ie,m as le,c as l,e,o as c,_ as Q,n as N,a as S,F as U,p as q,q as ae,t as _,b as n,s as X,x as K,y as Ae,j as O,g as He,v as Oe,z as ze,A as Ue,k as qe,B as Je}from"./index-C6Clf7-G.js";import{b as te,a as ce,c as se,d as ke,e as ye,u as Ke,W as Ye}from"./WaitingLobby-Can0zPx3.js";const ue=Pe("drawing",()=>{const t=T("pen"),a=T("#000000"),d=T(3),u=T(!1),s=T([]);function m(C){t.value=C}function x(C){a.value=C}function $(C){d.value=Math.max(1,Math.min(20,C))}function F(C){s.value.push(C)}function I(){s.value=[]}function L(C){u.value=C}return{tool:t,color:a,lineWidth:d,isDrawing:u,strokes:s,setTool:m,setColor:x,setLineWidth:$,addStroke:F,clearStrokes:I,setDrawing:L}});function Re(t,a){const d=t.getBoundingClientRect();let u,s;if(a instanceof MouseEvent)u=a.clientX,s=a.clientY;else if(a instanceof TouchEvent&&a.touches.length>0&&a.touches[0])u=a.touches[0].clientX,s=a.touches[0].clientY;else return null;return{x:u-d.left,y:s-d.top}}function De(t,a){if(!(a.points.length<2)){t.save(),a.tool==="pen"?(t.strokeStyle=a.color,t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"):a.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),a.points[0]&&t.moveTo(a.points[0].x,a.points[0].y);for(let d=1;d<a.points.length;d++){const u=a.points[d];u&&t.lineTo(u.x,u.y)}t.stroke(),t.restore()}}function be(t,a){const d=t.getContext("2d");if(!d)return;const u=t.getBoundingClientRect();d.clearRect(0,0,t.width,t.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,u.width,u.height),a.forEach(s=>{De(d,s)})}function Xe(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const M=T(null),P=T(null),E=T(null),z=T(null);function $e(){const t=ue(),a=te(),d=J(),{sendDrawing:u}=ce(),s=W(()=>!d.user||!a.currentRoom?!1:a.currentRoom.current_drawer_id===d.user.id);let m=null;const x=50;function $(r){console.log("[useDrawing] initCanvas è¢«èª¿ç”¨"),M.value=r;const w=r.getContext("2d",{willReadFrequently:!0});if(!w){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}P.value=w;const y=window.devicePixelRatio||1,B=r.getBoundingClientRect();r.width=B.width*y,r.height=B.height*y,w.scale(y,y),w.fillStyle="#FFFFFF",w.fillRect(0,0,B.width,B.height),t.clearStrokes(),console.log("[useDrawing] Canvas åˆå§‹åŒ–å®Œæˆï¼Œç­†è§¸å·²æ¸…ç©º"),new ResizeObserver(()=>{if(!M.value||!P.value)return;const b=M.value.getBoundingClientRect(),V=window.devicePixelRatio||1;M.value.width=b.width*V,M.value.height=b.height*V,P.value.scale(V,V),P.value.fillStyle="#FFFFFF",P.value.fillRect(0,0,b.width,b.height),be(M.value,t.strokes)}).observe(r)}function F(r){if(!M.value)return;if(!s.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}r.preventDefault(),t.setDrawing(!0);const w=Re(M.value,r);w&&(E.value={id:Xe(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[w],timestamp:Date.now()},z.value=w)}function I(r){if(!M.value||!P.value||!t.isDrawing||!E.value)return;r.preventDefault();const w=Re(M.value,r);if(!w||!z.value)return;const y=P.value;y.save(),E.value.tool==="pen"?(y.strokeStyle=E.value.color,y.lineWidth=E.value.lineWidth,y.lineCap="round",y.lineJoin="round"):E.value.tool==="eraser"&&(y.globalCompositeOperation="destination-out",y.lineWidth=E.value.lineWidth,y.lineCap="round",y.lineJoin="round"),y.beginPath(),y.moveTo(z.value.x,z.value.y),y.lineTo(w.x,w.y),y.stroke(),y.restore(),E.value.points.push(w),z.value=w,m===null&&(m=window.setTimeout(()=>{C(),m=null},x))}function L(){!t.isDrawing||!E.value||(t.setDrawing(!1),m&&(clearTimeout(m),m=null),C(),E.value=null,z.value=null)}async function C(){if(!(!E.value||!a.currentRoom||!d.user))try{const r={...E.value,userId:d.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",r.id),await u(a.currentRoom.code,r)}catch(r){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",r)}}function k(r){if(!M.value||!P.value)return;if(r.userId&&d.user&&r.userId===d.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„æ•¸æ“š");return}if("type"in r&&r.type==="clear"){console.log("[handleDrawingData] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒæŒ‡ä»¤"),f();return}const w=r;console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",w.id),t.addStroke(w),De(P.value,w)}function f(){if(console.log("[useDrawing] clearCanvasLocal è¢«èª¿ç”¨"),!M.value||!P.value){console.warn("[useDrawing] clearCanvasLocal: canvas æˆ– ctx ä¸å­˜åœ¨");return}const r=P.value,y=M.value.getBoundingClientRect();console.log("[useDrawing] æ¸…ç©ºç•«å¸ƒï¼Œå°ºå¯¸:",y.width,"x",y.height),r.clearRect(0,0,y.width,y.height),r.fillStyle="#FFFFFF",r.fillRect(0,0,y.width,y.height),t.clearStrokes(),console.log("[useDrawing] ç•«å¸ƒå·²æ¸…ç©º")}async function R(){if(console.log("[useDrawing] clearCanvas è¢«èª¿ç”¨"),f(),s.value&&a.currentRoom&&d.user){console.log("[useDrawing] ç•«å®¶æ¸…ç©ºç•«å¸ƒï¼Œå»£æ’­çµ¦å…¶ä»–ç©å®¶");try{await u(a.currentRoom.code,{type:"clear",userId:d.user.id})}catch(r){console.error("[useDrawing] å»£æ’­æ¸…ç©ºæŒ‡ä»¤å¤±æ•—:",r)}}}function h(r){t.setTool(r)}function v(r){t.setColor(r)}function i(r){t.setLineWidth(r)}function g(){M.value&&be(M.value,t.strokes)}return{canvasRef:M,initCanvas:$,startDrawing:F,draw:I,stopDrawing:L,clearCanvas:R,clearCanvasLocal:f,setTool:h,setColor:v,setLineWidth:i,handleDrawingData:k,redrawStrokes:g}}const je={class:"drawing-canvas-container"},Qe=j({__name:"DrawingCanvas",setup(t,{expose:a}){const{initCanvas:d,startDrawing:u,draw:s,stopDrawing:m,handleDrawingData:x}=$e(),$=te(),F=J(),I=ue(),L=se(),{subscribeDrawing:C}=ce(),k=T(null);function f(){if(console.log("[DrawingCanvas] localClearCanvas è¢«èª¿ç”¨"),!k.value){console.warn("[DrawingCanvas] canvas å…ƒç´ ä¸å­˜åœ¨");return}const b=k.value,V=b.getContext("2d");if(!V){console.warn("[DrawingCanvas] ç„¡æ³•ç²å– ctx");return}const H=b.getBoundingClientRect(),A=window.devicePixelRatio||1;b.width=H.width*A,b.height=H.height*A,V.scale(A,A),V.fillStyle="#FFFFFF",V.fillRect(0,0,H.width,H.height),I.clearStrokes(),console.log("[DrawingCanvas] ç•«å¸ƒå·²æ¸…ç©º")}Y(()=>L.currentRound?.id,(b,V)=>{console.log("[DrawingCanvas] watch currentRound.id:",{oldRoundId:V,newRoundId:b}),b&&b!==V&&(console.log("[DrawingCanvas] æ–°è¼ªæ¬¡é–‹å§‹ï¼Œæ¸…ç©ºç•«å¸ƒ"),f())});function R(){console.log("[DrawingCanvas] æ”¶åˆ° clearCanvas äº‹ä»¶"),f()}a({clearCanvas:f});function h(b){u(b)}function v(b){s(b)}function i(){m()}function g(){m()}function r(b){u(b)}function w(b){s(b)}function y(){m()}let B=null;function Z(){!$.currentRoom||!F.user||(B=C($.currentRoom.code,b=>{x(b)}))}return ie(()=>{console.log("[DrawingCanvas] onMounted - çµ„ä»¶æ›è¼‰"),k.value&&d(k.value),Z(),window.addEventListener("clearCanvas",R)}),le(()=>{B&&(B(),B=null),window.removeEventListener("clearCanvas",R)}),(b,V)=>(c(),l("div",je,[e("canvas",{ref_key:"canvasElement",ref:k,class:"drawing-canvas",onMousedown:h,onMousemove:v,onMouseup:i,onMouseleave:g,onTouchstart:r,onTouchmove:w,onTouchend:y},null,544)]))}}),Ze=Q(Qe,[["__scopeId","data-v-30a728c0"]]),et={class:"toolbar-section"},tt={key:0,class:"tool-label"},st={key:0,class:"tool-label"},nt={key:0,class:"toolbar-section colors-section"},ot=["onClick","title"],rt={class:"toolbar-section size-section"},at={class:"size-dots"},it=["onClick","title"],lt={class:"toolbar-section"},ct={key:0,class:"tool-label"},ut=j({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const a=ue(),{setTool:d,setColor:u,setLineWidth:s}=$e(),m=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],x=W(()=>a.tool),$=W(()=>a.color),F=W(()=>a.lineWidth);function I(f){d(f)}function L(f){u(f)}function C(f){a.setLineWidth(f),s(f)}function k(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&window.dispatchEvent(new Event("clearCanvas"))}return(f,R)=>(c(),l("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",et,[e("button",{onClick:R[0]||(R[0]=h=>I("pen")),class:N(["tool-btn",{active:x.value==="pen"}]),title:"ç•«ç­†"},[R[2]||(R[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?S("",!0):(c(),l("span",tt,"ç•«ç­†"))],2),e("button",{onClick:R[1]||(R[1]=h=>I("eraser")),class:N(["tool-btn",{active:x.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[R[3]||(R[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?S("",!0):(c(),l("span",st,"æ©¡çš®æ“¦"))],2)]),x.value==="pen"?(c(),l("div",nt,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(c(),l(U,null,q(m,h=>e("div",{key:h,onClick:v=>L(h),class:N(["color-cell",{selected:$.value===h}]),style:ae({backgroundColor:h}),title:h},null,14,ot)),64))],2)])):S("",!0),e("div",rt,[e("div",at,[(c(),l(U,null,q([2,5,10,15],h=>e("div",{key:h,onClick:v=>C(h),class:N(["size-dot",{active:F.value===h}]),style:ae({width:`${h+8}px`,height:`${h+8}px`}),title:`${h}px`},null,14,it)),64))])]),e("div",lt,[e("button",{onClick:k,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[R[4]||(R[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?S("",!0):(c(),l("span",ct,"æ¸…ç©º"))])])],2))}}),dt=Q(ut,[["__scopeId","data-v-5236cf8c"]]),vt={class:"player-list"},mt={class:"player-list-header"},gt={class:"player-count"},wt={class:"player-rank"},ht={class:"player-info"},ft={class:"player-name"},_t={key:0,class:"drawer-badge"},pt={key:1,class:"host-badge"},yt={class:"player-score"},Rt=["onClick"],bt={key:0,class:"winner-banner"},Ct={class:"winner-text"},kt={class:"winner-name"},Dt={class:"winner-score"},$t=j({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:a}){const d=a,u=te(),s=se(),m=J(),{playerRankings:x,winner:$}=ke(),F=W(()=>x.value),I=T(!1);function L(v){return u.participants.find(g=>g.user_id===v)?.nickname||"æœªçŸ¥ç©å®¶"}function C(v){return m.user?.id===v}function k(v){return u.currentRoom?.host_id===v}function f(v){return s.currentRound?.drawer_id===v||u.currentRoom?.current_drawer_id===v}function R(v){return u.isHost&&!C(v)}async function h(v,i){if(!(I.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${i} å—ï¼Ÿ`))){I.value=!0;try{const r=await u.kickPlayer(v);r.success?d("player-kicked",v):alert(r.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(r){console.error("è¸¢äººå¤±æ•—:",r),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{I.value=!1}}}return(v,i)=>(c(),l("div",vt,[e("div",mt,[e("span",gt,"ç©å®¶ ("+_(F.value.length)+")",1)]),(c(!0),l(U,null,q(F.value,(g,r)=>(c(),l("div",{key:g.id,class:N(["player-item",{"is-current":C(g.user_id)},{"is-drawer":f(g.user_id)}])},[e("div",wt,_(r+1),1),e("div",{class:N(["player-avatar",{drawing:f(g.user_id)}])},_(L(g.user_id).charAt(0)),3),e("div",ht,[e("div",ft,[X(_(L(g.user_id))+" ",1),f(g.user_id)?(c(),l("span",_t,"âœï¸")):S("",!0),k(g.user_id)?(c(),l("span",pt,"ğŸ‘‘")):S("",!0)]),e("div",yt,_(g.score)+" åˆ†",1)]),R(g.user_id)?(c(),l("button",{key:0,class:"kick-btn",onClick:w=>h(g.user_id,L(g.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,Rt)):S("",!0)],2))),128)),t.showWinner&&n($)?(c(),l("div",bt,[i[1]||(i[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Ct,[i[0]||(i[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",kt,_(L(n($).user_id)),1),e("div",Dt,_(n($).score)+" åˆ†",1)])])):S("",!0)]))}}),Ce=Q($t,[["__scopeId","data-v-984c1c4a"]]),St={class:"round-summary"},Ft={class:"summary-card"},xt={key:0,class:"selection-waiting-banner"},Wt={class:"waiting-text"},Tt={class:"next-drawer-name"},It={class:"summary-header"},Gt={class:"summary-title"},Lt={class:"round-info"},Mt={class:"answer-reveal"},Vt={class:"answer-text"},Nt={class:"drawer-section"},Et={class:"drawer-info"},Bt={class:"drawer-name"},Pt={key:0,class:"drawer-score"},At={class:"guessers-section"},Ht={key:0,class:"no-guessers"},Ot={key:1,class:"guessers-list"},zt={class:"guesser-rank"},Ut={class:"guesser-name"},qt={class:"guesser-score"},Jt={key:1,class:"rating-section"},Kt={class:"star-rating"},Yt=["onMouseenter","onClick","disabled"],Xt={class:"rating-info"},jt={key:0,class:"rated-text"},Qt={key:1,class:"rate-hint"},Zt={key:2,class:"average-rating"},es={class:"avg-score"},ts={class:"avg-stars"},ss={class:"avg-count"},ns={key:3,class:"next-drawer-info"},os={class:"next-drawer-name-display"},rs={key:4,class:"game-ending-info"},as=j({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:a}){const d=t,u=a,s=J(),m=T(0),x=T(0),$=T(!1),F=T([]),I=W(()=>s.user?.id===d.drawerId),L=W(()=>F.value.length===0?0:F.value.reduce((i,g)=>i+g.rating,0)/F.value.length),C=W(()=>F.value.length);async function k(v){if(!($.value||I.value||!s.user))try{const{error:i}=await K.from("drawing_ratings").upsert({round_id:d.roundId,rater_id:s.user.id,drawer_id:d.drawerId,rating:v},{onConflict:"round_id,rater_id"});if(i)throw i;m.value=v,$.value=!0,u("rating-submitted",v)}catch(i){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",i)}}async function f(){try{const{data:v,error:i}=await K.from("drawing_ratings").select("rater_id, rating").eq("round_id",d.roundId);if(i)throw i;if(F.value=v||[],s.user){const g=F.value.find(r=>r.rater_id===s.user.id);g&&(m.value=g.rating,$.value=!0)}}catch(v){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",v)}}function R(){const v=K.channel(`ratings:${d.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${d.roundId}`},()=>{f()}).subscribe();return()=>{K.removeChannel(v)}}let h=null;return ie(()=>{f(),h=R()}),le(()=>{h&&h()}),Y(()=>d.roundId,()=>{f()}),(v,i)=>(c(),l("div",St,[e("div",Ft,[t.isWaitingForSelection?(c(),l("div",xt,[i[2]||(i[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Wt,[e("span",Tt,_(t.nextDrawerName),1),i[1]||(i[1]=X(" æ­£åœ¨é¸è©... ",-1))]),i[3]||(i[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):S("",!0),e("div",It,[e("h2",Gt,_(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Lt,"ç¬¬ "+_(t.roundNumber)+" / "+_(t.totalRounds)+" è¼ª",1)]),e("div",Mt,[i[4]||(i[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Vt,_(t.correctAnswer),1)]),e("div",Nt,[e("div",Et,[i[5]||(i[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Bt,_(t.drawerName),1),t.drawerScore>0?(c(),l("span",Pt,"+"+_(t.drawerScore)+" åˆ†",1)):S("",!0)])]),e("div",At,[i[6]||(i[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(c(),l("div",Ht," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(c(),l("div",Ot,[(c(!0),l(U,null,q(t.correctGuessers,(g,r)=>(c(),l("div",{key:g.userId,class:"guesser-item"},[e("span",zt,_(r+1),1),e("span",Ut,_(g.name),1),e("span",qt,"+"+_(g.score),1)]))),128))]))]),I.value?S("",!0):(c(),l("div",Jt,[i[7]||(i[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Kt,[(c(),l(U,null,q(5,g=>e("button",{key:g,class:N(["star-btn",{active:g<=(x.value||m.value),selected:g<=m.value}]),onMouseenter:r=>x.value=g,onMouseleave:i[0]||(i[0]=r=>x.value=0),onClick:r=>k(g),disabled:$.value}," â­ ",42,Yt)),64))]),e("div",Xt,[$.value?(c(),l("span",jt,"ä½ çš„è©•åˆ†ï¼š"+_(m.value)+" æ˜Ÿ",1)):(c(),l("span",Qt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),C.value>0?(c(),l("div",Zt,[i[8]||(i[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",es,_(L.value.toFixed(1)),1),e("span",ts,_("â­".repeat(Math.round(L.value))),1),e("span",ss,"("+_(C.value)+" äººå·²è©•)",1)])):S("",!0),t.nextDrawerName&&!t.isLastRound?(c(),l("div",ns,[i[9]||(i[9]=e("div",{class:"next-drawer-label"},"ä¸‹ä¸€è¼ªç•«æ‰‹",-1)),e("div",os,"âœï¸ "+_(t.nextDrawerName),1)])):S("",!0),t.isLastRound?(c(),l("div",rs,[...i[10]||(i[10]=[e("div",{class:"ending-label"},"ğŸ‰ é€™æ˜¯æœ€å¾Œä¸€è¼ªï¼",-1)])])):S("",!0)])]))}}),is=Q(as,[["__scopeId","data-v-2a39ef4b"]]);function ls(){const t=se(),a=J(),{calculateGuessScore:d,updatePlayerScore:u}=ke(),s=T(""),m=T(null),x=T(!1),$=W(()=>t.isCurrentDrawer?t.currentWord:null),F=W(()=>t.correctGuesses),I=W(()=>a.user?t.hasGuessed(a.user.id):!1);async function L(){if(!t.currentRound||!a.user)return m.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return m.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return m.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(I.value)return m.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return m.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{x.value=!0,m.value=null;const f=s.value.trim(),R=t.currentWord||"",h=C(f,R),v=h?d(F.value.length):0,{data:i,error:g}=await K.from("guesses").insert({round_id:t.currentRound.id,user_id:a.user.id,guess_text:f,is_correct:h,score_earned:v}).select().single();if(g)throw g;return t.guesses.push(i),h&&a.user&&await u(a.user.id,v),s.value="",{success:!0,isCorrect:h,guess:i}}catch(f){return m.value=f instanceof Error?f.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",f),{success:!1,error:m.value}}finally{x.value=!1}}function C(f,R){const h=f.trim(),v=R.trim();return h===v}function k(){m.value=null}return{guessInput:s,error:m,loading:x,currentWord:$,correctGuesses:F,hasGuessed:I,submitGuess:L,clearError:k}}const cs={class:"game-container"},us={key:0,class:"container margin-top-large"},ds={class:"row flex-center"},vs={class:"col-12 col-md-8"},ms={key:1,class:"game-layout"},gs={class:"game-sidebar game-players"},ws={class:"player-list-container"},hs={class:"game-main"},fs={key:0,class:"time-display"},_s={key:1,class:"time-display summary"},ps={class:"time-number"},ys={class:"round-info"},Rs={class:"round-label"},bs={key:0,class:"phase-label"},Cs={key:2,class:"word-display"},ks={class:"word-text"},Ds={key:3,class:"word-display"},$s={class:"drawer-hint"},Ss={class:"word-slots"},Fs={key:4,class:"word-display summary-word"},xs={class:"word-text revealed"},Ws={class:"game-content-area"},Ts={class:"game-canvas"},Is={key:0,class:"time-progress"},Gs={key:1,class:"summary-overlay"},Ls={class:"game-chat-panel"},Ms={key:0,class:"chat-msg system-msg answer-revealed"},Vs={key:1,class:"chat-msg system-msg"},Ns={class:"msg-player"},Es={key:0,class:"msg-correct"},Bs={key:1,class:"msg-text"},Ps={key:2,class:"chat-msg correct-self"},As={class:"chat-input-area"},Hs={key:0,type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"},Os=["placeholder","disabled"],zs=["disabled"],Us={key:2,class:"container margin-top-large"},qs={class:"row flex-center"},Js={class:"col-12 col-md-8"},Ks={class:"card"},Ys={class:"card-body text-center"},Xs=j({__name:"RoomView",setup(t){const a=Ae(),d=qe(),u=te(),s=se(),m=J(),{subscribeRoom:x,unsubscribeRoom:$,subscribeGameState:F}=ce(),{isPlaying:I,isWaiting:L,isFinished:C,timeRemaining:k,isCountingDown:f,isCurrentDrawer:R,drawTime:h,currentRoundNumber:v,totalRounds:i,startGame:g,isDrawing:r,isSummary:w,summaryTimeRemaining:y,startSummaryCountdown:B,stopSummaryCountdown:Z,startCountdown:b,stopCountdown:V}=ye(),{hasGuessed:H,guessInput:A,submitGuess:Se,loading:Fe}=ls(),{leaveRoom:xe}=Ke(),D=W(()=>u.currentRoom),de=W(()=>Fe.value),ve=T(null),ee=T(null),ne=W(()=>{const p=D.value?.current_drawer_id;return p&&u.participants.find(G=>G.user_id===p)?.nickname||"ç•«å®¶"}),We=W(()=>{if(!D.value||u.participants.length===0)return"";const o=(D.value.current_round||0)%u.participants.length;return u.participants[o]?.nickname||"ä¸‹ä¸€ä½ç•«å®¶"}),me=W(()=>v.value>=i.value),ge=W(()=>[...s.guesses].sort((p,o)=>new Date(p.guessed_at).getTime()-new Date(o.guessed_at).getTime()));function Te(){ee.value&&(ee.value.scrollTop=ee.value.scrollHeight)}Y(ge,()=>{Je(Te)},{deep:!0}),Y(()=>u.participants,p=>{if(!m.user||!D.value)return;!p.some(G=>G.user_id===m.user.id)&&D.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),u.clearRoom(),d.push("/"))},{deep:!0});function we(p){return u.participants.find(G=>G.user_id===p)?.nickname||"æœªçŸ¥ç©å®¶"}const Ie=W(()=>R.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":H.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ge=W(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),he=W(()=>s.currentRoundCorrectGuesses.length*5),fe=W(()=>s.currentRoundCorrectGuesses.map(p=>({userId:p.user_id,name:we(p.user_id),score:p.score_earned}))),Le=T(null);function Me(){!s.currentRound||!s.currentWord||(Le.value={roundNumber:v.value,answer:s.currentWord,drawerName:ne.value,drawerId:s.currentRound.drawer_id,drawerScore:he.value,correctGuessers:fe.value,roundId:s.currentRound.id})}Y(w,(p,o)=>{p&&!o&&v.value>0&&Me()});function oe(p){ve.value=p,setTimeout(()=>{ve.value=null},3e3)}async function _e(){!R.value&&A.value.trim()&&await Se()}async function Ve(){const p=await g();!p.success&&p.error&&oe(p.error)}async function re(){const p=await xe();D.value&&$(D.value.code),await d.push("/"),!p.success&&p.error&&oe(p.error)}async function Ne(p){if(!s.currentRound)return;const o=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,p);!o.success&&o.error&&oe(o.error)}return ie(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",a.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",D.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",m.user?.id);const p=a.params.code;if(p&&!D.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",p),D.value&&m.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",D.value.status),await s.loadCurrentRound(D.value.id),D.value.status==="playing"&&s.currentRound){const o=s.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:o.round_number,startedAt:o.started_at,endedAt:o.ended_at,drawerId:o.drawer_id}),o.drawer_id&&u.setCurrentDrawer(o.drawer_id),o.started_at&&!o.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),s.setRoundStatus("drawing");const G=new Date(o.started_at).getTime(),Ee=Date.now(),Be=Math.floor((Ee-G)/1e3),pe=Math.max(0,h.value-Be);console.log("[RoomView] åˆ·æ–°æ¢å¾©å€’è¨ˆæ™‚:",pe,"ç§’"),b(pe)}else o.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await x(D.value.code,D.value.id,m.user.id,{nickname:m.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(o){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",o)}F(D.value.code,async o=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",o),o.drawerId&&D.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",o.drawerId),u.setCurrentDrawer(o.drawerId)),o.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",o.roundStatus),s.setRoundStatus(o.roundStatus),o.roundStatus==="drawing"&&(Z(),s.clearRatings(),console.log("[RoomView] é–‹å§‹å€’è¨ˆæ™‚:",h.value,"ç§’"),b(h.value)),o.roundStatus==="summary"&&(V(),o.isLastRound?u.isHost&&setTimeout(async()=>{const{endGame:G}=ye();await G()},5e3):B())),D.value&&(await u.loadRoom(D.value.id),await s.loadCurrentRound(D.value.id))}),await s.loadAllGuesses(D.value.id)}}),le(()=>{D.value&&$(D.value.code)}),(p,o)=>(c(),l("div",cs,[n(L)?(c(),l("div",us,[e("div",ds,[e("div",vs,[O(Ye,{room:D.value,participants:n(u).participants,onStartGame:Ve,onLeaveRoom:re},null,8,["room","participants"])])])])):n(I)?(c(),l("div",ms,[e("div",gs,[e("div",ws,[O(Ce,{"show-winner":!1})])]),e("div",hs,[e("div",{class:N(["game-header",{"time-critical":n(k)!==null&&n(k)<=10}])},[n(r)&&n(f)&&n(k)!==null?(c(),l("div",fs,[e("span",{class:N(["time-number",{"time-warning":n(k)<=10,"time-critical-pulse":n(k)<=5}])},_(n(k)),3),o[1]||(o[1]=e("span",{class:"time-label"},"ç§’",-1))])):n(w)&&n(y)!==null?(c(),l("div",_s,[e("span",ps,_(n(y)),1),o[2]||(o[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):S("",!0),e("div",ys,[e("span",Rs,"ç¬¬ "+_(n(v))+" / "+_(n(i))+" è¼ª",1),n(w)?(c(),l("span",bs,"è¼ªæ¬¡çµç®—")):S("",!0)]),n(r)&&n(R)&&n(s).currentWord?(c(),l("div",Cs,[o[3]||(o[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",ks,_(n(s).currentWord),1)])):n(r)?(c(),l("div",Ds,[e("span",$s,"ğŸ¨ "+_(ne.value)+" æ­£åœ¨ç•«",1),e("span",Ss,_(Ge.value),1)])):n(w)&&n(s).currentWord?(c(),l("div",Fs,[o[4]||(o[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",xs,_(n(s).currentWord),1)])):S("",!0),e("button",{class:"leave-btn",onClick:re,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ws,[e("div",{class:N(["game-toolbar",{disabled:n(w)}])},[O(dt,{compact:!0})],2),e("div",Ts,[O(Ze),!n(w)&&n(f)&&n(k)!==null?(c(),l("div",Is,[e("div",{class:N(["time-bar",{"time-warning":n(k)<=10}]),style:ae({width:`${n(k)/n(h)*100}%`})},null,6)])):S("",!0),n(w)?(c(),l("div",Gs,[O(is,{"round-number":n(v),"total-rounds":n(i),"correct-answer":n(s).currentWord||"","drawer-name":ne.value,"drawer-id":n(s).currentRound?.drawer_id||"","drawer-score":he.value,"correct-guessers":fe.value,"round-id":n(s).currentRound?.id||"","is-host":n(u).isHost,"is-last-round":me.value,"next-drawer-name":me.value?"":We.value,onRatingSubmitted:Ne},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round","next-drawer-name"])])):S("",!0)]),e("div",Ls,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:ee},[n(w)?(c(),l("div",Ms,[o[5]||(o[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),o[6]||(o[6]=X(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,_(n(s).currentWord),1)])):S("",!0),n(w)?S("",!0):(c(),l("div",Vs,[...o[7]||(o[7]=[e("span",{class:"msg-icon"},"ğŸ®",-1),X(" éŠæˆ²é–‹å§‹ï¼ ",-1)])])),(c(!0),l(U,null,q(n(w)?n(s).currentRoundCorrectGuesses:ge.value,G=>(c(),l("div",{key:G.id,class:N(["chat-msg",{"correct-guess":G.is_correct,"wrong-guess":!G.is_correct}])},[e("span",Ns,_(we(G.user_id)),1),G.is_correct?(c(),l("span",Es,"çŒœä¸­äº†ï¼ +"+_(G.score_earned),1)):(c(),l("span",Bs,_(G.guess_text),1))],2))),128)),!n(w)&&n(H)?(c(),l("div",Ps,[...o[8]||(o[8]=[e("span",{class:"msg-icon"},"âœ…",-1),X(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):S("",!0)],512),e("div",As,[n(w)?(c(),l("input",Hs)):He((c(),l("input",{key:1,"onUpdate:modelValue":o[0]||(o[0]=G=>Ue(A)?A.value=G:null),type:"text",placeholder:Ie.value,maxlength:"32",disabled:de.value||n(H)||n(R),onKeyup:ze(_e,["enter"]),class:"chat-input-field"},null,40,Os)),[[Oe,n(A)]]),e("button",{onClick:_e,disabled:n(w)||de.value||n(H)||n(R)||!n(A).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,zs)])])])])])):n(C)?(c(),l("div",Us,[e("div",qs,[e("div",Js,[e("div",Ks,[e("div",Ys,[o[9]||(o[9]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),O(Ce,{"show-winner":!0}),e("button",{onClick:re,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):S("",!0)]))}}),Zs=Q(Xs,[["__scopeId","data-v-029b8972"]]);export{Zs as default};
