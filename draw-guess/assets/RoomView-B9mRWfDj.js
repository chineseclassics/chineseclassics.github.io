import{l as He,r as W,u as q,d as J,i as se,m as te,c as a,e,o as r,_ as K,f as G,n as N,a as M,F as L,p as O,q as ce,t as m,b as n,s as U,h as ee,x as Q,y as ze,j as B,z as ye,A as Ue,g as qe,v as Je,B as Ke,C as Ye,k as Xe,D as je}from"./index-CbPMNV7V.js";import{c as ne,b as ue,d as de,e as $e,a as Qe,u as Ze,W as es}from"./WaitingLobby-BaYSbauT.js";const Ce=He("drawing",()=>{const t=W("pen"),c=W("#000000"),v=W(3),w=W(!1),s=W([]);function l(k){t.value=k}function f(k){c.value=k}function g(k){v.value=Math.max(1,Math.min(20,k))}function R(k){s.value.push(k)}function T(){s.value=[]}function F(k){w.value=k}return{tool:t,color:c,lineWidth:v,isDrawing:w,strokes:s,setTool:l,setColor:f,setLineWidth:g,addStroke:R,clearStrokes:T,setDrawing:F}});function be(t,c){const v=t.getBoundingClientRect();let w,s;if(c instanceof MouseEvent)w=c.clientX,s=c.clientY;else if(c instanceof TouchEvent&&c.touches.length>0&&c.touches[0])w=c.touches[0].clientX,s=c.touches[0].clientY;else return null;return{x:w-v.left,y:s-v.top}}function Se(t,c){if(!(c.points.length<2)){t.save(),c.tool==="pen"?(t.strokeStyle=c.color,t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"):c.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),c.points[0]&&t.moveTo(c.points[0].x,c.points[0].y);for(let v=1;v<c.points.length;v++){const w=c.points[v];w&&t.lineTo(w.x,w.y)}t.stroke(),t.restore()}}function ie(t,c){const v=t.getContext("2d");if(!v)return;const w=t.getBoundingClientRect();v.clearRect(0,0,t.width,t.height),v.fillStyle="#FFFFFF",v.fillRect(0,0,w.width,w.height),c.forEach(s=>{Se(v,s)})}function ss(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Fe(){const t=Ce(),c=ne(),v=q(),{sendDrawing:w}=ue(),s=W(null),l=W(null),f=W(null),g=W(null);let R=null;const T=50;function F(d){s.value=d;const C=d.getContext("2d",{willReadFrequently:!0});if(!C){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}l.value=C;const I=window.devicePixelRatio||1,P=d.getBoundingClientRect();d.width=P.width*I,d.height=P.height*I,C.scale(I,I),C.fillStyle="#FFFFFF",C.fillRect(0,0,P.width,P.height),s.value&&ie(s.value,t.strokes),new ResizeObserver(()=>{if(!s.value||!l.value)return;const A=s.value.getBoundingClientRect(),H=window.devicePixelRatio||1;s.value.width=A.width*H,s.value.height=A.height*H,l.value.scale(H,H),l.value.fillStyle="#FFFFFF",l.value.fillRect(0,0,A.width,A.height),ie(s.value,t.strokes)}).observe(d)}function k(d){if(!s.value)return;d.preventDefault(),t.setDrawing(!0);const C=be(s.value,d);C&&(f.value={id:ss(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[C],timestamp:Date.now()},g.value=C)}function $(d){if(!s.value||!l.value||!t.isDrawing||!f.value)return;d.preventDefault();const C=be(s.value,d);if(!C||!g.value)return;const I=l.value;I.save(),f.value.tool==="pen"?(I.strokeStyle=f.value.color,I.lineWidth=f.value.lineWidth,I.lineCap="round",I.lineJoin="round"):f.value.tool==="eraser"&&(I.globalCompositeOperation="destination-out",I.lineWidth=f.value.lineWidth,I.lineCap="round",I.lineJoin="round"),I.beginPath(),I.moveTo(g.value.x,g.value.y),I.lineTo(C.x,C.y),I.stroke(),I.restore(),f.value.points.push(C),g.value=C,R===null&&(R=window.setTimeout(()=>{b(),R=null},T))}function _(){!t.isDrawing||!f.value||(t.setDrawing(!1),R&&(clearTimeout(R),R=null),b(),f.value=null,g.value=null)}async function b(){if(!(!f.value||!c.currentRoom||!v.user))try{const d={...f.value,userId:v.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",d.id),await w(c.currentRoom.code,d)}catch(d){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",d)}}function y(d){if(!(!s.value||!l.value)){if(d.userId&&v.user&&d.userId===v.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",d.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",d.id),t.addStroke(d),Se(l.value,d)}}function i(){if(!s.value||!l.value)return;const d=l.value,C=s.value;d.clearRect(0,0,C.width,C.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,C.width,C.height),t.clearStrokes()}function u(d){t.setTool(d)}function h(d){t.setColor(d)}function x(d){t.setLineWidth(d)}function V(){s.value&&ie(s.value,t.strokes)}return{canvasRef:s,initCanvas:F,startDrawing:k,draw:$,stopDrawing:_,clearCanvas:i,setTool:u,setColor:h,setLineWidth:x,handleDrawingData:y,redrawStrokes:V}}const ts={class:"drawing-canvas-container"},ns=J({__name:"DrawingCanvas",setup(t){const{initCanvas:c,startDrawing:v,draw:w,stopDrawing:s,handleDrawingData:l,clearCanvas:f}=Fe(),g=ne(),R=q(),{subscribeDrawing:T}=ue(),F=W(null);function k(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),f()}function $(d){v(d)}function _(d){w(d)}function b(){s()}function y(){s()}function i(d){v(d)}function u(d){w(d)}function h(){s()}let x=null;function V(){!g.currentRoom||!R.user||(x=T(g.currentRoom.code,d=>{l(d)}))}return se(()=>{F.value&&c(F.value),V(),window.addEventListener("clearCanvas",k)}),te(()=>{x&&(x(),x=null),window.removeEventListener("clearCanvas",k)}),(d,C)=>(r(),a("div",ts,[e("canvas",{ref_key:"canvasElement",ref:F,class:"drawing-canvas",onMousedown:$,onMousemove:_,onMouseup:b,onMouseleave:y,onTouchstart:i,onTouchmove:u,onTouchend:h},null,544)]))}}),os=K(ns,[["__scopeId","data-v-f29d9704"]]),rs={class:"toolbar-section"},as={key:0,class:"tool-label"},is={key:0,class:"tool-label"},ls={key:0,class:"toolbar-section colors-section"},cs=["onClick","title"],us={class:"toolbar-section size-section"},ds={class:"size-dots"},vs=["onClick","title"],ms={class:"toolbar-section"},ws={key:0,class:"tool-label"},hs=J({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const c=Ce(),{setTool:v,setColor:w,setLineWidth:s,clearCanvas:l}=Fe(),f=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],g=G(()=>c.tool),R=G(()=>c.color),T=G(()=>c.lineWidth);function F(b){v(b)}function k(b){w(b)}function $(b){c.setLineWidth(b),s(b)}function _(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&l()}return(b,y)=>(r(),a("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",rs,[e("button",{onClick:y[0]||(y[0]=i=>F("pen")),class:N(["tool-btn",{active:g.value==="pen"}]),title:"ç•«ç­†"},[y[2]||(y[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?M("",!0):(r(),a("span",as,"ç•«ç­†"))],2),e("button",{onClick:y[1]||(y[1]=i=>F("eraser")),class:N(["tool-btn",{active:g.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[y[3]||(y[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?M("",!0):(r(),a("span",is,"æ©¡çš®æ“¦"))],2)]),g.value==="pen"?(r(),a("div",ls,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(r(),a(L,null,O(f,i=>e("div",{key:i,onClick:u=>k(i),class:N(["color-cell",{selected:R.value===i}]),style:ce({backgroundColor:i}),title:i},null,14,cs)),64))],2)])):M("",!0),e("div",us,[e("div",ds,[(r(),a(L,null,O([2,5,10,15],i=>e("div",{key:i,onClick:u=>$(i),class:N(["size-dot",{active:T.value===i}]),style:ce({width:`${i+8}px`,height:`${i+8}px`}),title:`${i}px`},null,14,vs)),64))])]),e("div",ms,[e("button",{onClick:_,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[y[4]||(y[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?M("",!0):(r(),a("span",ws,"æ¸…ç©º"))])])],2))}}),le=K(hs,[["__scopeId","data-v-7e7250c3"]]),gs={class:"player-list"},_s={class:"player-list-header"},fs={class:"player-count"},ps={class:"player-rank"},ys={class:"player-info"},bs={class:"player-name"},Rs={key:0,class:"drawer-badge"},ks={key:1,class:"host-badge"},$s={class:"player-score"},Cs=["onClick"],Ss={key:0,class:"winner-banner"},Fs={class:"winner-text"},Ds={class:"winner-name"},Ws={class:"winner-score"},xs=J({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:c}){const v=c,w=ne(),s=de(),l=q(),{playerRankings:f,winner:g}=$e(),R=G(()=>f.value),T=W(!1);function F(i){return w.participants.find(h=>h.user_id===i)?.nickname||"æœªçŸ¥ç©å®¶"}function k(i){return l.user?.id===i}function $(i){return w.currentRoom?.host_id===i}function _(i){return s.currentRound?.drawer_id===i}function b(i){return w.isHost&&!k(i)}async function y(i,u){if(!(T.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${u} å—ï¼Ÿ`))){T.value=!0;try{const x=await w.kickPlayer(i);x.success?v("player-kicked",i):alert(x.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(x){console.error("è¸¢äººå¤±æ•—:",x),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{T.value=!1}}}return(i,u)=>(r(),a("div",gs,[e("div",_s,[e("span",fs,"ç©å®¶ ("+m(R.value.length)+")",1)]),(r(!0),a(L,null,O(R.value,(h,x)=>(r(),a("div",{key:h.id,class:N(["player-item",{"is-current":k(h.user_id)},{"is-drawer":_(h.user_id)}])},[e("div",ps,m(x+1),1),e("div",{class:N(["player-avatar",{drawing:_(h.user_id)}])},m(F(h.user_id).charAt(0)),3),e("div",ys,[e("div",bs,[U(m(F(h.user_id))+" ",1),_(h.user_id)?(r(),a("span",Rs,"âœï¸")):M("",!0),$(h.user_id)?(r(),a("span",ks,"ğŸ‘‘")):M("",!0)]),e("div",$s,m(h.score)+" åˆ†",1)]),b(h.user_id)?(r(),a("button",{key:0,class:"kick-btn",onClick:V=>y(h.user_id,F(h.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,Cs)):M("",!0)],2))),128)),t.showWinner&&n(g)?(r(),a("div",Ss,[u[1]||(u[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Fs,[u[0]||(u[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",Ds,m(F(n(g).user_id)),1),e("div",Ws,m(n(g).score)+" åˆ†",1)])])):M("",!0)]))}}),Re=K(xs,[["__scopeId","data-v-846d90e2"]]),Is={class:"word-selection"},Ts={key:0,class:"waiting-overlay"},Gs={class:"waiting-card"},Ms={class:"waiting-title"},Ns={key:1,class:"selection-card"},Vs={class:"selection-header"},Ls={class:"round-info"},Es={class:"countdown-section"},Bs={class:"countdown-number"},Os={class:"countdown-text"},Ps={class:"word-options"},As=["onClick","disabled"],Hs={class:"word-text"},zs={key:0,class:"word-source"},Us={class:"selection-footer"},qs=["disabled"],Js=J({__name:"WordSelection",props:{wordOptions:{},roundNumber:{},totalRounds:{},selectionTime:{},isWaiting:{type:Boolean}},emits:["word-selected"],setup(t,{emit:c}){const v=t,w=c,s=W(null),l=W(!1),f=W(v.selectionTime);let g=null;function R($){l.value||(s.value=$)}function T(){!s.value||l.value||(l.value=!0,w("word-selected",s.value),g&&clearInterval(g))}function F(){if(l.value)return;const $=Math.floor(Math.random()*v.wordOptions.length),_=v.wordOptions[$];_&&(s.value=_.text,l.value=!0,w("word-selected",_.text))}function k(){f.value=v.selectionTime,g=window.setInterval(()=>{f.value>0?f.value--:(g&&clearInterval(g),F())},1e3)}return se(()=>{k()}),te(()=>{g&&clearInterval(g)}),($,_)=>(r(),a("div",Is,[t.isWaiting?(r(),a("div",Ts,[e("div",Gs,[_[0]||(_[0]=e("div",{class:"waiting-icon"},"â³",-1)),e("h2",Ms,"å·²é¸æ“‡ã€Œ"+m(s.value)+"ã€",1),_[1]||(_[1]=e("p",{class:"waiting-text"},"è«‹ç¨ç­‰ï¼Œå…¶ä»–ç©å®¶æ­£åœ¨æŸ¥çœ‹çµæœ...",-1)),_[2]||(_[2]=e("div",{class:"waiting-spinner"},null,-1))])])):(r(),a("div",Ns,[e("div",Vs,[_[3]||(_[3]=e("h2",{class:"selection-title"},"ğŸ¨ è¼ªåˆ°ä½ ç•«ç•«äº†ï¼",-1)),e("div",Ls,"ç¬¬ "+m(t.roundNumber)+" / "+m(t.totalRounds)+" è¼ª",1)]),e("div",Es,[e("div",{class:N(["countdown-ring",{warning:f.value<=5}])},[e("span",Bs,m(f.value),1)],2),e("div",Os,m(f.value<=5?"å³å°‡è‡ªå‹•é¸æ“‡ï¼":"è«‹é¸æ“‡ä¸€å€‹è©èª"),1)]),e("div",Ps,[(r(!0),a(L,null,O(t.wordOptions,(b,y)=>(r(),a("button",{key:y,class:N(["word-option",{selected:s.value===b.text}]),onClick:i=>R(b.text),disabled:l.value},[e("span",Hs,m(b.text),1),b.source==="custom"?(r(),a("span",zs,"è‡ªè¨‚")):M("",!0)],10,As))),128))]),e("div",Us,[e("button",{class:"confirm-btn",disabled:!s.value||l.value,onClick:T},m(l.value?"å·²é¸æ“‡":"ç¢ºèªé¸æ“‡"),9,qs)])]))]))}}),Ks=K(Js,[["__scopeId","data-v-5ef0827f"]]),Ys={class:"round-summary"},Xs={class:"summary-card"},js={key:0,class:"selection-waiting-banner"},Qs={class:"waiting-text"},Zs={class:"next-drawer-name"},et={class:"summary-header"},st={class:"summary-title"},tt={class:"round-info"},nt={class:"answer-reveal"},ot={class:"answer-text"},rt={class:"drawer-section"},at={class:"drawer-info"},it={class:"drawer-name"},lt={key:0,class:"drawer-score"},ct={class:"guessers-section"},ut={key:0,class:"no-guessers"},dt={key:1,class:"guessers-list"},vt={class:"guesser-rank"},mt={class:"guesser-name"},wt={class:"guesser-score"},ht={key:1,class:"rating-section"},gt={class:"star-rating"},_t=["onMouseenter","onClick","disabled"],ft={class:"rating-info"},pt={key:0,class:"rated-text"},yt={key:1,class:"rate-hint"},bt={key:2,class:"average-rating"},Rt={class:"avg-score"},kt={class:"avg-stars"},$t={class:"avg-count"},Ct=J({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:c}){const v=t,w=c,s=q(),l=W(0),f=W(0),g=W(!1),R=W([]),T=G(()=>s.user?.id===v.drawerId),F=G(()=>R.value.length===0?0:R.value.reduce((u,h)=>u+h.rating,0)/R.value.length),k=G(()=>R.value.length);async function $(i){if(!(g.value||T.value||!s.user))try{const{error:u}=await Q.from("drawing_ratings").upsert({round_id:v.roundId,rater_id:s.user.id,drawer_id:v.drawerId,rating:i},{onConflict:"round_id,rater_id"});if(u)throw u;l.value=i,g.value=!0,w("rating-submitted",i)}catch(u){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",u)}}async function _(){try{const{data:i,error:u}=await Q.from("drawing_ratings").select("rater_id, rating").eq("round_id",v.roundId);if(u)throw u;if(R.value=i||[],s.user){const h=R.value.find(x=>x.rater_id===s.user.id);h&&(l.value=h.rating,g.value=!0)}}catch(i){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",i)}}function b(){const i=Q.channel(`ratings:${v.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${v.roundId}`},()=>{_()}).subscribe();return()=>{Q.removeChannel(i)}}let y=null;return se(()=>{_(),y=b()}),te(()=>{y&&y()}),ee(()=>v.roundId,()=>{_()}),(i,u)=>(r(),a("div",Ys,[e("div",Xs,[t.isWaitingForSelection?(r(),a("div",js,[u[2]||(u[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Qs,[e("span",Zs,m(t.nextDrawerName),1),u[1]||(u[1]=U(" æ­£åœ¨é¸è©... ",-1))]),u[3]||(u[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",et,[e("h2",st,m(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",tt,"ç¬¬ "+m(t.roundNumber)+" / "+m(t.totalRounds)+" è¼ª",1)]),e("div",nt,[u[4]||(u[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",ot,m(t.correctAnswer),1)]),e("div",rt,[e("div",at,[u[5]||(u[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",it,m(t.drawerName),1),t.drawerScore>0?(r(),a("span",lt,"+"+m(t.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",ct,[u[6]||(u[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(r(),a("div",ut," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(r(),a("div",dt,[(r(!0),a(L,null,O(t.correctGuessers,(h,x)=>(r(),a("div",{key:h.userId,class:"guesser-item"},[e("span",vt,m(x+1),1),e("span",mt,m(h.name),1),e("span",wt,"+"+m(h.score),1)]))),128))]))]),T.value?M("",!0):(r(),a("div",ht,[u[7]||(u[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",gt,[(r(),a(L,null,O(5,h=>e("button",{key:h,class:N(["star-btn",{active:h<=(f.value||l.value),selected:h<=l.value}]),onMouseenter:x=>f.value=h,onMouseleave:u[0]||(u[0]=x=>f.value=0),onClick:x=>$(h),disabled:g.value}," â­ ",42,_t)),64))]),e("div",ft,[g.value?(r(),a("span",pt,"ä½ çš„è©•åˆ†ï¼š"+m(l.value)+" æ˜Ÿ",1)):(r(),a("span",yt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),k.value>0?(r(),a("div",bt,[u[8]||(u[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",Rt,m(F.value.toFixed(1)),1),e("span",kt,m("â­".repeat(Math.round(F.value))),1),e("span",$t,"("+m(k.value)+" äººå·²è©•)",1)])):M("",!0)])]))}}),ke=K(Ct,[["__scopeId","data-v-64089556"]]);function St(){const t=de(),c=q(),{calculateGuessScore:v,updatePlayerScore:w}=$e(),s=W(""),l=W(null),f=W(!1),g=G(()=>t.isCurrentDrawer?t.currentWord:null),R=G(()=>t.correctGuesses),T=G(()=>c.user?t.hasGuessed(c.user.id):!1);async function F(){if(!t.currentRound||!c.user)return l.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return l.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return l.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(T.value)return l.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return l.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{f.value=!0,l.value=null;const _=s.value.trim(),b=t.currentWord||"",y=k(_,b),i=y?v(R.value.length):0,{data:u,error:h}=await Q.from("guesses").insert({round_id:t.currentRound.id,user_id:c.user.id,guess_text:_,is_correct:y,score_earned:i}).select().single();if(h)throw h;return t.guesses.push(u),y&&c.user&&await w(c.user.id,i),s.value="",{success:!0,isCorrect:y,guess:u}}catch(_){return l.value=_ instanceof Error?_.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",_),{success:!1,error:l.value}}finally{f.value=!1}}function k(_,b){const y=_.trim(),i=b.trim();return y===i}function $(){l.value=null}return{guessInput:s,error:l,loading:f,currentWord:g,correctGuesses:R,hasGuessed:T,submitGuess:F,clearError:$}}const Ft={class:"game-container"},Dt={key:0,class:"container margin-top-large"},Wt={class:"row flex-center"},xt={class:"col-12 col-md-8"},It={key:1,class:"game-layout"},Tt={class:"game-sidebar game-players"},Gt={class:"player-list-container"},Mt={class:"game-main"},Nt={key:0,class:"time-display"},Vt={key:1,class:"time-display selecting"},Lt={class:"time-number time-warning"},Et={key:2,class:"time-display summary"},Bt={class:"time-number"},Ot={class:"round-info"},Pt={class:"round-label"},At={key:0,class:"phase-label"},Ht={key:1,class:"phase-label"},zt={key:3,class:"word-display"},Ut={class:"word-text"},qt={key:4,class:"word-display"},Jt={class:"word-slots"},Kt={key:5,class:"word-display"},Yt={class:"word-slots"},Xt={key:6,class:"word-display summary-word"},jt={class:"word-text revealed"},Qt={class:"game-content-area"},Zt={class:"game-toolbar disabled"},en={class:"game-canvas selection-phase"},sn={key:2,class:"first-round-waiting"},tn={class:"waiting-card"},nn={class:"waiting-title"},on={class:"game-chat-panel"},rn={class:"game-toolbar disabled"},an={class:"game-canvas summary-phase"},ln={class:"game-chat-panel"},cn={class:"chat-msg system-msg answer-revealed"},un={class:"msg-player"},dn={class:"msg-correct"},vn={class:"game-toolbar"},mn={class:"game-canvas"},wn={key:0,class:"time-progress"},hn={class:"game-chat-panel"},gn={class:"msg-player"},_n={key:0,class:"msg-correct"},fn={key:1,class:"msg-text"},pn={key:0,class:"chat-msg correct-self"},yn={class:"chat-input-area"},bn=["placeholder","disabled"],Rn=["disabled"],kn={key:2,class:"container margin-top-large"},$n={class:"row flex-center"},Cn={class:"col-12 col-md-8"},Sn={class:"card"},Fn={class:"card-body text-center"},Dn=J({__name:"RoomView",setup(t){const c=ze(),v=Xe(),w=ne(),s=de(),l=q(),{subscribeRoom:f,unsubscribeRoom:g,subscribeGameState:R}=ue(),{isPlaying:T,isWaiting:F,isFinished:k,timeRemaining:$,isCountingDown:_,isCurrentDrawer:b,drawTime:y,currentRoundNumber:i,totalRounds:u,startGame:h,skipWord:x,isSelecting:V,isDrawing:d,isSummary:C,wordOptions:I,selectionTimeRemaining:P,summaryTimeRemaining:oe,isWaitingAfterSelection:A,selectWord:H,stopSelectionCountdown:De,startSelectionCountdown:We,startSummaryCountdown:xe,stopSummaryCountdown:Ie,startCountdown:Te}=Qe(),{hasGuessed:Z,guessInput:Y,submitGuess:Ge,loading:Me}=St(),{leaveRoom:Ne}=Ze(),D=G(()=>w.currentRoom),ve=G(()=>Me.value),me=W(null),z=W(null),X=G(()=>{const p=D.value?.current_drawer_id;return p&&w.participants.find(S=>S.user_id===p)?.nickname||"ç•«å®¶"}),we=G(()=>!D.value||!l.user?!1:D.value.current_drawer_id===l.user.id),he=G(()=>[...s.guesses].sort((p,o)=>new Date(p.guessed_at).getTime()-new Date(o.guessed_at).getTime()));function Ve(){z.value&&(z.value.scrollTop=z.value.scrollHeight)}ee(he,()=>{je(Ve)},{deep:!0}),ee(()=>w.participants,p=>{if(!l.user||!D.value)return;!p.some(S=>S.user_id===l.user.id)&&D.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),w.clearRoom(),v.push("/"))},{deep:!0});function re(p){return w.participants.find(S=>S.user_id===p)?.nickname||"æœªçŸ¥ç©å®¶"}const Le=G(()=>b.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":Z.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ee=G(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),ge=G(()=>s.currentRoundCorrectGuesses.length*5),_e=G(()=>s.currentRoundCorrectGuesses.map(p=>({userId:p.user_id,name:re(p.user_id),score:p.score_earned}))),E=W(null);function Be(){!s.currentRound||!s.currentWord||(E.value={roundNumber:i.value,answer:s.currentWord,drawerName:X.value,drawerId:s.currentRound.drawer_id,drawerScore:ge.value,correctGuessers:_e.value,roundId:s.currentRound.id})}ee(V,(p,o)=>{p&&!o&&i.value>0&&Be()});function j(p){me.value=p,setTimeout(()=>{me.value=null},3e3)}async function fe(){!b.value&&Y.value.trim()&&await Ge()}async function Oe(){const p=await h();!p.success&&p.error&&j(p.error)}async function ae(){const p=await Ne();D.value&&g(D.value.code),await v.push("/"),!p.success&&p.error&&j(p.error)}async function Pe(){const p=await x();!p.success&&p.error&&j(p.error)}async function Ae(p){const o=I.value.find(S=>S.text===p);if(o){const S=await H(o);!S.success&&S.error&&j(S.error)}}async function pe(p){if(!s.currentRound)return;const o=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,p);!o.success&&o.error&&j(o.error)}return se(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",c.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",D.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",l.user?.id);const p=c.params.code;if(p&&!D.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",p),D.value&&l.user){console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",D.value.status),await s.loadCurrentRound(D.value.id);try{await f(D.value.code,D.value.id,l.user.id,{nickname:l.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(o){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",o)}R(D.value.code,async o=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",o),o.drawerId&&D.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",o.drawerId),w.setCurrentDrawer(o.drawerId)),o.wordOptions!==void 0&&(console.log("[RoomView] æ›´æ–°è©èªé¸é …:",o.wordOptions.length,"å€‹"),s.setWordOptions(o.wordOptions)),o.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",o.roundStatus,"ç•¶å‰ç”¨æˆ¶æ˜¯å¦æ˜¯ç•«å®¶:",D.value?.current_drawer_id===l.user?.id),s.setRoundStatus(o.roundStatus),o.roundStatus==="selecting"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),Ie(),We()),o.roundStatus==="drawing"&&(De(),Te(y.value)),o.roundStatus==="summary"&&xe()),D.value&&(await w.loadRoom(D.value.id),await s.loadCurrentRound(D.value.id))}),await s.loadAllGuesses(D.value.id)}}),te(()=>{D.value&&g(D.value.code)}),(p,o)=>(r(),a("div",Ft,[n(F)?(r(),a("div",Dt,[e("div",Wt,[e("div",xt,[B(es,{room:D.value,participants:n(w).participants,onStartGame:Oe,onLeaveRoom:ae},null,8,["room","participants"])])])])):n(T)?(r(),a("div",It,[e("div",Tt,[e("div",Gt,[B(Re,{"show-winner":!1})])]),e("div",Mt,[e("div",{class:N(["game-header",{"time-critical":n($)!==null&&n($)<=10}])},[n(d)&&n(_)&&n($)!==null?(r(),a("div",Nt,[e("span",{class:N(["time-number",{"time-warning":n($)<=10,"time-critical-pulse":n($)<=5}])},m(n($)),3),o[1]||(o[1]=e("span",{class:"time-label"},"ç§’",-1))])):n(V)&&n(P)!==null?(r(),a("div",Vt,[e("span",Lt,m(n(P)),1),o[2]||(o[2]=e("span",{class:"time-label"},"ç§’é¸è©",-1))])):n(C)&&n(oe)!==null?(r(),a("div",Et,[e("span",Bt,m(n(oe)),1),o[3]||(o[3]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",Ot,[e("span",Pt,"ç¬¬ "+m(n(i)+(n(V)?1:0))+" / "+m(n(u))+" è¼ª",1),n(V)?(r(),a("span",At,"é¸è©ä¸­")):n(C)?(r(),a("span",Ht,"è¼ªæ¬¡çµç®—")):M("",!0)]),n(d)&&n(b)&&n(s).currentWord?(r(),a("div",zt,[o[4]||(o[4]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",Ut,m(n(s).currentWord),1),e("button",{class:"skip-btn",onClick:Pe,title:"è·³éæ­¤è©"},"è·³é")])):n(d)?(r(),a("div",qt,[e("span",Jt,m(Ee.value),1)])):n(V)?(r(),a("div",Kt,[e("span",Yt,m(we.value?"è«‹é¸æ“‡è¦ç•«çš„è©èª":`${X.value} æ­£åœ¨é¸è©...`),1)])):n(C)&&n(s).currentWord?(r(),a("div",Xt,[o[5]||(o[5]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",jt,m(n(s).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:ae,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Qt,[n(V)?(r(),a(L,{key:0},[e("div",Zt,[B(le,{compact:!0})]),e("div",en,[we.value?(r(),ye(Ks,{key:0,"word-options":n(I),"round-number":n(i)+1,"total-rounds":n(u),"selection-time":5,"is-waiting":n(A),onWordSelected:Ae},null,8,["word-options","round-number","total-rounds","is-waiting"])):E.value?(r(),ye(ke,{key:1,"round-number":E.value.roundNumber,"total-rounds":n(u),"correct-answer":E.value.answer,"drawer-name":E.value.drawerName,"drawer-id":E.value.drawerId,"drawer-score":E.value.drawerScore,"correct-guessers":E.value.correctGuessers,"round-id":E.value.roundId,"is-host":n(w).isHost,"is-last-round":!1,"is-waiting-for-selection":!0,"next-drawer-name":X.value,onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","next-drawer-name"])):(r(),a("div",sn,[e("div",tn,[o[6]||(o[6]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("h2",nn,m(X.value)+" æ­£åœ¨é¸è©...",1),o[7]||(o[7]=Ue('<p class="waiting-hint" data-v-43185934>ç¬¬ä¸€è¼ªå³å°‡é–‹å§‹</p><div class="waiting-dots" data-v-43185934><span class="dot" data-v-43185934></span><span class="dot" data-v-43185934></span><span class="dot" data-v-43185934></span></div>',2))])]))]),e("div",on,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[...o[8]||(o[8]=[e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"â³"),U(" ç­‰å¾…ç•«å®¶é¸è©... ")],-1)])],512),o[9]||(o[9]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ç­‰å¾…é¸è©...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):n(C)?(r(),a(L,{key:1},[e("div",rn,[B(le,{compact:!0})]),e("div",an,[B(ke,{"round-number":n(i),"total-rounds":n(u),"correct-answer":n(s).currentWord||"","drawer-name":X.value,"drawer-id":n(s).currentRound?.drawer_id||"","drawer-score":ge.value,"correct-guessers":_e.value,"round-id":n(s).currentRound?.id||"","is-host":n(w).isHost,"is-last-round":n(i)>=n(u),onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",ln,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[e("div",cn,[o[10]||(o[10]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),o[11]||(o[11]=U(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,m(n(s).currentWord),1)]),(r(!0),a(L,null,O(n(s).currentRoundCorrectGuesses,S=>(r(),a("div",{key:S.id,class:"chat-msg correct-guess"},[e("span",un,m(re(S.user_id)),1),e("span",dn,"çŒœä¸­äº†ï¼ +"+m(S.score_earned),1)]))),128))],512),o[12]||(o[12]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(r(),a(L,{key:2},[e("div",vn,[B(le,{compact:!0})]),e("div",mn,[B(os),n(_)&&n($)!==null?(r(),a("div",wn,[e("div",{class:N(["time-bar",{"time-warning":n($)<=10}]),style:ce({width:`${n($)/n(y)*100}%`})},null,6)])):M("",!0)]),e("div",hn,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[o[14]||(o[14]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),U(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(r(!0),a(L,null,O(he.value,S=>(r(),a("div",{key:S.id,class:N(["chat-msg",{"correct-guess":S.is_correct,"wrong-guess":!S.is_correct}])},[e("span",gn,m(re(S.user_id)),1),S.is_correct?(r(),a("span",_n,"çŒœä¸­äº†ï¼ +"+m(S.score_earned),1)):(r(),a("span",fn,m(S.guess_text),1))],2))),128)),n(Z)?(r(),a("div",pn,[...o[13]||(o[13]=[e("span",{class:"msg-icon"},"âœ…",-1),U(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",yn,[qe(e("input",{"onUpdate:modelValue":o[0]||(o[0]=S=>Ye(Y)?Y.value=S:null),type:"text",placeholder:Le.value,maxlength:"32",disabled:ve.value||n(Z)||n(b),onKeyup:Ke(fe,["enter"]),class:"chat-input-field"},null,40,bn),[[Je,n(Y)]]),e("button",{onClick:fe,disabled:ve.value||n(Z)||n(b)||!n(Y).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Rn)])])],64))])])])):n(k)?(r(),a("div",kn,[e("div",$n,[e("div",Cn,[e("div",Sn,[e("div",Fn,[o[15]||(o[15]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),B(Re,{"show-winner":!0}),e("button",{onClick:ae,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),In=K(Dn,[["__scopeId","data-v-43185934"]]);export{In as default};
