import{l as Pe,r as W,u as K,f as x,d as Q,h as X,i as ie,m as le,c as l,e,o as c,_ as Z,n as L,a as $,F as q,p as J,q as ae,t as f,b as o,s as j,x as Y,y as Ae,j as z,g as He,v as Oe,z as ze,A as Ue,k as qe,B as Je}from"./index-DcW6eHL5.js";import{b as te,a as ce,c as se,d as ke,e as ye,u as Ke,W as Ye}from"./WaitingLobby-cJ9db-Bg.js";const ue=Pe("drawing",()=>{const t=W("pen"),a=W("#000000"),m=W(3),u=W(!1),n=W([]);function g(b){t.value=b}function F(b){a.value=b}function D(b){m.value=Math.max(1,Math.min(20,b))}function S(b){n.value.push(b)}function T(){n.value=[]}function G(b){u.value=b}return{tool:t,color:a,lineWidth:m,isDrawing:u,strokes:n,setTool:g,setColor:F,setLineWidth:D,addStroke:S,clearStrokes:T,setDrawing:G}});function Re(t,a){const m=t.getBoundingClientRect();let u,n;if(a instanceof MouseEvent)u=a.clientX,n=a.clientY;else if(a instanceof TouchEvent&&a.touches.length>0&&a.touches[0])u=a.touches[0].clientX,n=a.touches[0].clientY;else return null;return{x:u-m.left,y:n-m.top}}function De(t,a){if(!(a.points.length<2)){t.save(),a.tool==="pen"?(t.strokeStyle=a.color,t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"):a.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),a.points[0]&&t.moveTo(a.points[0].x,a.points[0].y);for(let m=1;m<a.points.length;m++){const u=a.points[m];u&&t.lineTo(u.x,u.y)}t.stroke(),t.restore()}}function be(t,a){const m=t.getContext("2d");if(!m)return;const u=t.getBoundingClientRect();m.clearRect(0,0,t.width,t.height),m.fillStyle="#FFFFFF",m.fillRect(0,0,u.width,u.height),a.forEach(n=>{De(m,n)})}function Xe(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const M=W(null),V=W(null),N=W(null),U=W(null);function $e(){const t=ue(),a=te(),m=K(),{sendDrawing:u}=ce(),n=x(()=>!m.user||!a.currentRoom?!1:a.currentRoom.current_drawer_id===m.user.id);let g=null;const F=50;function D(s){console.log("[useDrawing] initCanvas è¢«èª¿ç”¨"),M.value=s;const h=s.getContext("2d",{willReadFrequently:!0});if(!h){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}V.value=h;const v=window.devicePixelRatio||1,P=s.getBoundingClientRect();s.width=P.width*v,s.height=P.height*v,h.scale(v,v),h.fillStyle="#FFFFFF",h.fillRect(0,0,P.width,P.height),t.clearStrokes(),console.log("[useDrawing] Canvas åˆå§‹åŒ–å®Œæˆï¼Œç­†è§¸å·²æ¸…ç©º"),new ResizeObserver(()=>{if(!M.value||!V.value)return;const H=M.value.getBoundingClientRect(),R=window.devicePixelRatio||1;M.value.width=H.width*R,M.value.height=H.height*R,V.value.scale(R,R),V.value.fillStyle="#FFFFFF",V.value.fillRect(0,0,H.width,H.height),be(M.value,t.strokes)}).observe(s)}function S(s){if(!M.value)return;if(!n.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}s.preventDefault(),t.setDrawing(!0);const h=Re(M.value,s);h&&(N.value={id:Xe(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[h],timestamp:Date.now()},U.value=h)}function T(s){if(!M.value||!V.value||!t.isDrawing||!N.value)return;s.preventDefault();const h=Re(M.value,s);if(!h||!U.value)return;const v=V.value;v.save(),N.value.tool==="pen"?(v.strokeStyle=N.value.color,v.lineWidth=N.value.lineWidth,v.lineCap="round",v.lineJoin="round"):N.value.tool==="eraser"&&(v.globalCompositeOperation="destination-out",v.lineWidth=N.value.lineWidth,v.lineCap="round",v.lineJoin="round"),v.beginPath(),v.moveTo(U.value.x,U.value.y),v.lineTo(h.x,h.y),v.stroke(),v.restore(),N.value.points.push(h),U.value=h,g===null&&(g=window.setTimeout(()=>{b(),g=null},F))}function G(){!t.isDrawing||!N.value||(t.setDrawing(!1),g&&(clearTimeout(g),g=null),b(),N.value=null,U.value=null)}async function b(){if(!(!N.value||!a.currentRoom||!m.user))try{const s={...N.value,userId:m.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",s.id),await u(a.currentRoom.code,s)}catch(s){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",s)}}function C(s){if(!(!M.value||!V.value)){if(s.userId&&m.user&&s.userId===m.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",s.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",s.id),t.addStroke(s),De(V.value,s)}}function _(){if(console.log("[useDrawing] clearCanvas è¢«èª¿ç”¨, canvasRef:",!!M.value,"ctxRef:",!!V.value),!M.value||!V.value){console.warn("[useDrawing] clearCanvas: canvas æˆ– ctx ä¸å­˜åœ¨ï¼Œç„¡æ³•æ¸…ç©º");return}const s=V.value,v=M.value.getBoundingClientRect();console.log("[useDrawing] æ¸…ç©ºç•«å¸ƒï¼Œå°ºå¯¸:",v.width,"x",v.height),s.clearRect(0,0,v.width,v.height),s.fillStyle="#FFFFFF",s.fillRect(0,0,v.width,v.height),t.clearStrokes(),console.log("[useDrawing] ç•«å¸ƒå·²æ¸…ç©ºï¼Œstrokes æ•¸é‡:",t.strokes.length)}function y(s){t.setTool(s)}function w(s){t.setColor(s)}function d(s){t.setLineWidth(s)}function i(){M.value&&be(M.value,t.strokes)}return{canvasRef:M,initCanvas:D,startDrawing:S,draw:T,stopDrawing:G,clearCanvas:_,setTool:y,setColor:w,setLineWidth:d,handleDrawingData:C,redrawStrokes:i}}const je={class:"drawing-canvas-container"},Qe=Q({__name:"DrawingCanvas",setup(t,{expose:a}){const{initCanvas:m,startDrawing:u,draw:n,stopDrawing:g,handleDrawingData:F}=$e(),D=te(),S=K(),T=ue(),G=se(),{subscribeDrawing:b}=ce(),C=W(null);function _(){if(console.log("[DrawingCanvas] localClearCanvas è¢«èª¿ç”¨"),!C.value){console.warn("[DrawingCanvas] canvas å…ƒç´ ä¸å­˜åœ¨");return}const R=C.value,E=R.getContext("2d");if(!E){console.warn("[DrawingCanvas] ç„¡æ³•ç²å– ctx");return}const A=R.getBoundingClientRect(),B=window.devicePixelRatio||1;R.width=A.width*B,R.height=A.height*B,E.scale(B,B),E.fillStyle="#FFFFFF",E.fillRect(0,0,A.width,A.height),T.clearStrokes(),console.log("[DrawingCanvas] ç•«å¸ƒå·²æ¸…ç©º")}X(()=>G.currentRound?.id,(R,E)=>{console.log("[DrawingCanvas] watch currentRound.id:",{oldRoundId:E,newRoundId:R}),R&&R!==E&&(console.log("[DrawingCanvas] æ–°è¼ªæ¬¡é–‹å§‹ï¼Œæ¸…ç©ºç•«å¸ƒ"),_())});function y(){console.log("[DrawingCanvas] æ”¶åˆ° clearCanvas äº‹ä»¶"),_()}a({clearCanvas:_});function w(R){u(R)}function d(R){n(R)}function i(){g()}function s(){g()}function h(R){u(R)}function v(R){n(R)}function P(){g()}let O=null;function H(){!D.currentRoom||!S.user||(O=b(D.currentRoom.code,R=>{F(R)}))}return ie(()=>{console.log("[DrawingCanvas] onMounted - çµ„ä»¶æ›è¼‰"),C.value&&m(C.value),H(),window.addEventListener("clearCanvas",y)}),le(()=>{O&&(O(),O=null),window.removeEventListener("clearCanvas",y)}),(R,E)=>(c(),l("div",je,[e("canvas",{ref_key:"canvasElement",ref:C,class:"drawing-canvas",onMousedown:w,onMousemove:d,onMouseup:i,onMouseleave:s,onTouchstart:h,onTouchmove:v,onTouchend:P},null,544)]))}}),Ze=Z(Qe,[["__scopeId","data-v-30a728c0"]]),et={class:"toolbar-section"},tt={key:0,class:"tool-label"},st={key:0,class:"tool-label"},nt={key:0,class:"toolbar-section colors-section"},ot=["onClick","title"],rt={class:"toolbar-section size-section"},at={class:"size-dots"},it=["onClick","title"],lt={class:"toolbar-section"},ct={key:0,class:"tool-label"},ut=Q({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const a=ue(),{setTool:m,setColor:u,setLineWidth:n}=$e(),g=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],F=x(()=>a.tool),D=x(()=>a.color),S=x(()=>a.lineWidth);function T(_){m(_)}function G(_){u(_)}function b(_){a.setLineWidth(_),n(_)}function C(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&window.dispatchEvent(new Event("clearCanvas"))}return(_,y)=>(c(),l("div",{class:L(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",et,[e("button",{onClick:y[0]||(y[0]=w=>T("pen")),class:L(["tool-btn",{active:F.value==="pen"}]),title:"ç•«ç­†"},[y[2]||(y[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?$("",!0):(c(),l("span",tt,"ç•«ç­†"))],2),e("button",{onClick:y[1]||(y[1]=w=>T("eraser")),class:L(["tool-btn",{active:F.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[y[3]||(y[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?$("",!0):(c(),l("span",st,"æ©¡çš®æ“¦"))],2)]),F.value==="pen"?(c(),l("div",nt,[e("div",{class:L(["color-grid",{"color-grid-compact":t.compact}])},[(c(),l(q,null,J(g,w=>e("div",{key:w,onClick:d=>G(w),class:L(["color-cell",{selected:D.value===w}]),style:ae({backgroundColor:w}),title:w},null,14,ot)),64))],2)])):$("",!0),e("div",rt,[e("div",at,[(c(),l(q,null,J([2,5,10,15],w=>e("div",{key:w,onClick:d=>b(w),class:L(["size-dot",{active:S.value===w}]),style:ae({width:`${w+8}px`,height:`${w+8}px`}),title:`${w}px`},null,14,it)),64))])]),e("div",lt,[e("button",{onClick:C,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[y[4]||(y[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?$("",!0):(c(),l("span",ct,"æ¸…ç©º"))])])],2))}}),dt=Z(ut,[["__scopeId","data-v-5236cf8c"]]),vt={class:"player-list"},mt={class:"player-list-header"},gt={class:"player-count"},wt={class:"player-rank"},ht={class:"player-info"},ft={class:"player-name"},_t={key:0,class:"drawer-badge"},pt={key:1,class:"host-badge"},yt={class:"player-score"},Rt=["onClick"],bt={key:0,class:"winner-banner"},Ct={class:"winner-text"},kt={class:"winner-name"},Dt={class:"winner-score"},$t=Q({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:a}){const m=a,u=te(),n=se(),g=K(),{playerRankings:F,winner:D}=ke(),S=x(()=>F.value),T=W(!1);function G(d){return u.participants.find(s=>s.user_id===d)?.nickname||"æœªçŸ¥ç©å®¶"}function b(d){return g.user?.id===d}function C(d){return u.currentRoom?.host_id===d}function _(d){return n.currentRound?.drawer_id===d||u.currentRoom?.current_drawer_id===d}function y(d){return u.isHost&&!b(d)}async function w(d,i){if(!(T.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${i} å—ï¼Ÿ`))){T.value=!0;try{const h=await u.kickPlayer(d);h.success?m("player-kicked",d):alert(h.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(h){console.error("è¸¢äººå¤±æ•—:",h),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{T.value=!1}}}return(d,i)=>(c(),l("div",vt,[e("div",mt,[e("span",gt,"ç©å®¶ ("+f(S.value.length)+")",1)]),(c(!0),l(q,null,J(S.value,(s,h)=>(c(),l("div",{key:s.id,class:L(["player-item",{"is-current":b(s.user_id)},{"is-drawer":_(s.user_id)}])},[e("div",wt,f(h+1),1),e("div",{class:L(["player-avatar",{drawing:_(s.user_id)}])},f(G(s.user_id).charAt(0)),3),e("div",ht,[e("div",ft,[j(f(G(s.user_id))+" ",1),_(s.user_id)?(c(),l("span",_t,"âœï¸")):$("",!0),C(s.user_id)?(c(),l("span",pt,"ğŸ‘‘")):$("",!0)]),e("div",yt,f(s.score)+" åˆ†",1)]),y(s.user_id)?(c(),l("button",{key:0,class:"kick-btn",onClick:v=>w(s.user_id,G(s.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,Rt)):$("",!0)],2))),128)),t.showWinner&&o(D)?(c(),l("div",bt,[i[1]||(i[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Ct,[i[0]||(i[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",kt,f(G(o(D).user_id)),1),e("div",Dt,f(o(D).score)+" åˆ†",1)])])):$("",!0)]))}}),Ce=Z($t,[["__scopeId","data-v-984c1c4a"]]),St={class:"round-summary"},Ft={class:"summary-card"},xt={key:0,class:"selection-waiting-banner"},Wt={class:"waiting-text"},Tt={class:"next-drawer-name"},It={class:"summary-header"},Gt={class:"summary-title"},Mt={class:"round-info"},Lt={class:"answer-reveal"},Vt={class:"answer-text"},Nt={class:"drawer-section"},Et={class:"drawer-info"},Bt={class:"drawer-name"},Pt={key:0,class:"drawer-score"},At={class:"guessers-section"},Ht={key:0,class:"no-guessers"},Ot={key:1,class:"guessers-list"},zt={class:"guesser-rank"},Ut={class:"guesser-name"},qt={class:"guesser-score"},Jt={key:1,class:"rating-section"},Kt={class:"star-rating"},Yt=["onMouseenter","onClick","disabled"],Xt={class:"rating-info"},jt={key:0,class:"rated-text"},Qt={key:1,class:"rate-hint"},Zt={key:2,class:"average-rating"},es={class:"avg-score"},ts={class:"avg-stars"},ss={class:"avg-count"},ns={key:3,class:"next-drawer-info"},os={class:"next-drawer-name-display"},rs={key:4,class:"game-ending-info"},as=Q({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:a}){const m=t,u=a,n=K(),g=W(0),F=W(0),D=W(!1),S=W([]),T=x(()=>n.user?.id===m.drawerId),G=x(()=>S.value.length===0?0:S.value.reduce((i,s)=>i+s.rating,0)/S.value.length),b=x(()=>S.value.length);async function C(d){if(!(D.value||T.value||!n.user))try{const{error:i}=await Y.from("drawing_ratings").upsert({round_id:m.roundId,rater_id:n.user.id,drawer_id:m.drawerId,rating:d},{onConflict:"round_id,rater_id"});if(i)throw i;g.value=d,D.value=!0,u("rating-submitted",d)}catch(i){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",i)}}async function _(){try{const{data:d,error:i}=await Y.from("drawing_ratings").select("rater_id, rating").eq("round_id",m.roundId);if(i)throw i;if(S.value=d||[],n.user){const s=S.value.find(h=>h.rater_id===n.user.id);s&&(g.value=s.rating,D.value=!0)}}catch(d){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",d)}}function y(){const d=Y.channel(`ratings:${m.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${m.roundId}`},()=>{_()}).subscribe();return()=>{Y.removeChannel(d)}}let w=null;return ie(()=>{_(),w=y()}),le(()=>{w&&w()}),X(()=>m.roundId,()=>{_()}),(d,i)=>(c(),l("div",St,[e("div",Ft,[t.isWaitingForSelection?(c(),l("div",xt,[i[2]||(i[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Wt,[e("span",Tt,f(t.nextDrawerName),1),i[1]||(i[1]=j(" æ­£åœ¨é¸è©... ",-1))]),i[3]||(i[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):$("",!0),e("div",It,[e("h2",Gt,f(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Mt,"ç¬¬ "+f(t.roundNumber)+" / "+f(t.totalRounds)+" è¼ª",1)]),e("div",Lt,[i[4]||(i[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Vt,f(t.correctAnswer),1)]),e("div",Nt,[e("div",Et,[i[5]||(i[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Bt,f(t.drawerName),1),t.drawerScore>0?(c(),l("span",Pt,"+"+f(t.drawerScore)+" åˆ†",1)):$("",!0)])]),e("div",At,[i[6]||(i[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(c(),l("div",Ht," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(c(),l("div",Ot,[(c(!0),l(q,null,J(t.correctGuessers,(s,h)=>(c(),l("div",{key:s.userId,class:"guesser-item"},[e("span",zt,f(h+1),1),e("span",Ut,f(s.name),1),e("span",qt,"+"+f(s.score),1)]))),128))]))]),T.value?$("",!0):(c(),l("div",Jt,[i[7]||(i[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Kt,[(c(),l(q,null,J(5,s=>e("button",{key:s,class:L(["star-btn",{active:s<=(F.value||g.value),selected:s<=g.value}]),onMouseenter:h=>F.value=s,onMouseleave:i[0]||(i[0]=h=>F.value=0),onClick:h=>C(s),disabled:D.value}," â­ ",42,Yt)),64))]),e("div",Xt,[D.value?(c(),l("span",jt,"ä½ çš„è©•åˆ†ï¼š"+f(g.value)+" æ˜Ÿ",1)):(c(),l("span",Qt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),b.value>0?(c(),l("div",Zt,[i[8]||(i[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",es,f(G.value.toFixed(1)),1),e("span",ts,f("â­".repeat(Math.round(G.value))),1),e("span",ss,"("+f(b.value)+" äººå·²è©•)",1)])):$("",!0),t.nextDrawerName&&!t.isLastRound?(c(),l("div",ns,[i[9]||(i[9]=e("div",{class:"next-drawer-label"},"ä¸‹ä¸€è¼ªç•«æ‰‹",-1)),e("div",os,"âœï¸ "+f(t.nextDrawerName),1)])):$("",!0),t.isLastRound?(c(),l("div",rs,[...i[10]||(i[10]=[e("div",{class:"ending-label"},"ğŸ‰ é€™æ˜¯æœ€å¾Œä¸€è¼ªï¼",-1)])])):$("",!0)])]))}}),is=Z(as,[["__scopeId","data-v-2a39ef4b"]]);function ls(){const t=se(),a=K(),{calculateGuessScore:m,updatePlayerScore:u}=ke(),n=W(""),g=W(null),F=W(!1),D=x(()=>t.isCurrentDrawer?t.currentWord:null),S=x(()=>t.correctGuesses),T=x(()=>a.user?t.hasGuessed(a.user.id):!1);async function G(){if(!t.currentRound||!a.user)return g.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!n.value.trim())return g.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(n.value.length>32)return g.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(T.value)return g.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return g.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{F.value=!0,g.value=null;const _=n.value.trim(),y=t.currentWord||"",w=b(_,y),d=w?m(S.value.length):0,{data:i,error:s}=await Y.from("guesses").insert({round_id:t.currentRound.id,user_id:a.user.id,guess_text:_,is_correct:w,score_earned:d}).select().single();if(s)throw s;return t.guesses.push(i),w&&a.user&&await u(a.user.id,d),n.value="",{success:!0,isCorrect:w,guess:i}}catch(_){return g.value=_ instanceof Error?_.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",_),{success:!1,error:g.value}}finally{F.value=!1}}function b(_,y){const w=_.trim(),d=y.trim();return w===d}function C(){g.value=null}return{guessInput:n,error:g,loading:F,currentWord:D,correctGuesses:S,hasGuessed:T,submitGuess:G,clearError:C}}const cs={class:"game-container"},us={key:0,class:"container margin-top-large"},ds={class:"row flex-center"},vs={class:"col-12 col-md-8"},ms={key:1,class:"game-layout"},gs={class:"game-sidebar game-players"},ws={class:"player-list-container"},hs={class:"game-main"},fs={key:0,class:"time-display"},_s={key:1,class:"time-display summary"},ps={class:"time-number"},ys={class:"round-info"},Rs={class:"round-label"},bs={key:0,class:"phase-label"},Cs={key:2,class:"word-display"},ks={class:"word-text"},Ds={key:3,class:"word-display"},$s={class:"drawer-hint"},Ss={class:"word-slots"},Fs={key:4,class:"word-display summary-word"},xs={class:"word-text revealed"},Ws={class:"game-content-area"},Ts={class:"game-canvas"},Is={key:0,class:"time-progress"},Gs={key:1,class:"summary-overlay"},Ms={class:"game-chat-panel"},Ls={key:0,class:"chat-msg system-msg answer-revealed"},Vs={key:1,class:"chat-msg system-msg"},Ns={class:"msg-player"},Es={key:0,class:"msg-correct"},Bs={key:1,class:"msg-text"},Ps={key:2,class:"chat-msg correct-self"},As={class:"chat-input-area"},Hs={key:0,type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"},Os=["placeholder","disabled"],zs=["disabled"],Us={key:2,class:"container margin-top-large"},qs={class:"row flex-center"},Js={class:"col-12 col-md-8"},Ks={class:"card"},Ys={class:"card-body text-center"},Xs=Q({__name:"RoomView",setup(t){const a=Ae(),m=qe(),u=te(),n=se(),g=K(),{subscribeRoom:F,unsubscribeRoom:D,subscribeGameState:S}=ce(),{isPlaying:T,isWaiting:G,isFinished:b,timeRemaining:C,isCountingDown:_,isCurrentDrawer:y,drawTime:w,currentRoundNumber:d,totalRounds:i,startGame:s,isDrawing:h,isSummary:v,summaryTimeRemaining:P,startSummaryCountdown:O,stopSummaryCountdown:H,startCountdown:R,stopCountdown:E}=ye(),{hasGuessed:A,guessInput:B,submitGuess:Se,loading:Fe}=ls(),{leaveRoom:xe}=Ke(),k=x(()=>u.currentRoom),de=x(()=>Fe.value),ve=W(null),ee=W(null),ne=x(()=>{const p=k.value?.current_drawer_id;return p&&u.participants.find(I=>I.user_id===p)?.nickname||"ç•«å®¶"}),We=x(()=>{if(!k.value||u.participants.length===0)return"";const r=(k.value.current_round||0)%u.participants.length;return u.participants[r]?.nickname||"ä¸‹ä¸€ä½ç•«å®¶"}),me=x(()=>d.value>=i.value),ge=x(()=>[...n.guesses].sort((p,r)=>new Date(p.guessed_at).getTime()-new Date(r.guessed_at).getTime()));function Te(){ee.value&&(ee.value.scrollTop=ee.value.scrollHeight)}X(ge,()=>{Je(Te)},{deep:!0}),X(()=>u.participants,p=>{if(!g.user||!k.value)return;!p.some(I=>I.user_id===g.user.id)&&k.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),u.clearRoom(),m.push("/"))},{deep:!0});function we(p){return u.participants.find(I=>I.user_id===p)?.nickname||"æœªçŸ¥ç©å®¶"}const Ie=x(()=>y.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":A.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ge=x(()=>n.currentWord?n.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),he=x(()=>n.currentRoundCorrectGuesses.length*5),fe=x(()=>n.currentRoundCorrectGuesses.map(p=>({userId:p.user_id,name:we(p.user_id),score:p.score_earned}))),Me=W(null);function Le(){!n.currentRound||!n.currentWord||(Me.value={roundNumber:d.value,answer:n.currentWord,drawerName:ne.value,drawerId:n.currentRound.drawer_id,drawerScore:he.value,correctGuessers:fe.value,roundId:n.currentRound.id})}X(v,(p,r)=>{p&&!r&&d.value>0&&Le()});function oe(p){ve.value=p,setTimeout(()=>{ve.value=null},3e3)}async function _e(){!y.value&&B.value.trim()&&await Se()}async function Ve(){const p=await s();!p.success&&p.error&&oe(p.error)}async function re(){const p=await xe();k.value&&D(k.value.code),await m.push("/"),!p.success&&p.error&&oe(p.error)}async function Ne(p){if(!n.currentRound)return;const r=await n.submitRating(n.currentRound.id,n.currentRound.drawer_id,p);!r.success&&r.error&&oe(r.error)}return ie(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",a.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",k.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",g.user?.id);const p=a.params.code;if(p&&!k.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",p),k.value&&g.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",k.value.status),await n.loadCurrentRound(k.value.id),k.value.status==="playing"&&n.currentRound){const r=n.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:r.round_number,startedAt:r.started_at,endedAt:r.ended_at,drawerId:r.drawer_id}),r.drawer_id&&u.setCurrentDrawer(r.drawer_id),r.started_at&&!r.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),n.setRoundStatus("drawing");const I=new Date(r.started_at).getTime(),Ee=Date.now(),Be=Math.floor((Ee-I)/1e3),pe=Math.max(0,w.value-Be);console.log("[RoomView] åˆ·æ–°æ¢å¾©å€’è¨ˆæ™‚:",pe,"ç§’"),R(pe)}else r.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await F(k.value.code,k.value.id,g.user.id,{nickname:g.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(r){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",r)}S(k.value.code,async r=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",r),r.drawerId&&k.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",r.drawerId),u.setCurrentDrawer(r.drawerId)),r.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",r.roundStatus),n.setRoundStatus(r.roundStatus),r.roundStatus==="drawing"&&(H(),n.clearRatings(),console.log("[RoomView] é–‹å§‹å€’è¨ˆæ™‚:",w.value,"ç§’"),R(w.value)),r.roundStatus==="summary"&&(E(),r.isLastRound?u.isHost&&setTimeout(async()=>{const{endGame:I}=ye();await I()},5e3):O())),k.value&&(await u.loadRoom(k.value.id),await n.loadCurrentRound(k.value.id))}),await n.loadAllGuesses(k.value.id)}}),le(()=>{k.value&&D(k.value.code)}),(p,r)=>(c(),l("div",cs,[o(G)?(c(),l("div",us,[e("div",ds,[e("div",vs,[z(Ye,{room:k.value,participants:o(u).participants,onStartGame:Ve,onLeaveRoom:re},null,8,["room","participants"])])])])):o(T)?(c(),l("div",ms,[e("div",gs,[e("div",ws,[z(Ce,{"show-winner":!1})])]),e("div",hs,[e("div",{class:L(["game-header",{"time-critical":o(C)!==null&&o(C)<=10}])},[o(h)&&o(_)&&o(C)!==null?(c(),l("div",fs,[e("span",{class:L(["time-number",{"time-warning":o(C)<=10,"time-critical-pulse":o(C)<=5}])},f(o(C)),3),r[1]||(r[1]=e("span",{class:"time-label"},"ç§’",-1))])):o(v)&&o(P)!==null?(c(),l("div",_s,[e("span",ps,f(o(P)),1),r[2]||(r[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):$("",!0),e("div",ys,[e("span",Rs,"ç¬¬ "+f(o(d))+" / "+f(o(i))+" è¼ª",1),o(v)?(c(),l("span",bs,"è¼ªæ¬¡çµç®—")):$("",!0)]),o(h)&&o(y)&&o(n).currentWord?(c(),l("div",Cs,[r[3]||(r[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",ks,f(o(n).currentWord),1)])):o(h)?(c(),l("div",Ds,[e("span",$s,"ğŸ¨ "+f(ne.value)+" æ­£åœ¨ç•«",1),e("span",Ss,f(Ge.value),1)])):o(v)&&o(n).currentWord?(c(),l("div",Fs,[r[4]||(r[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",xs,f(o(n).currentWord),1)])):$("",!0),e("button",{class:"leave-btn",onClick:re,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Ws,[e("div",{class:L(["game-toolbar",{disabled:o(v)}])},[z(dt,{compact:!0})],2),e("div",Ts,[z(Ze),!o(v)&&o(_)&&o(C)!==null?(c(),l("div",Is,[e("div",{class:L(["time-bar",{"time-warning":o(C)<=10}]),style:ae({width:`${o(C)/o(w)*100}%`})},null,6)])):$("",!0),o(v)?(c(),l("div",Gs,[z(is,{"round-number":o(d),"total-rounds":o(i),"correct-answer":o(n).currentWord||"","drawer-name":ne.value,"drawer-id":o(n).currentRound?.drawer_id||"","drawer-score":he.value,"correct-guessers":fe.value,"round-id":o(n).currentRound?.id||"","is-host":o(u).isHost,"is-last-round":me.value,"next-drawer-name":me.value?"":We.value,onRatingSubmitted:Ne},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round","next-drawer-name"])])):$("",!0)]),e("div",Ms,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:ee},[o(v)?(c(),l("div",Ls,[r[5]||(r[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),r[6]||(r[6]=j(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,f(o(n).currentWord),1)])):$("",!0),o(v)?$("",!0):(c(),l("div",Vs,[...r[7]||(r[7]=[e("span",{class:"msg-icon"},"ğŸ®",-1),j(" éŠæˆ²é–‹å§‹ï¼ ",-1)])])),(c(!0),l(q,null,J(o(v)?o(n).currentRoundCorrectGuesses:ge.value,I=>(c(),l("div",{key:I.id,class:L(["chat-msg",{"correct-guess":I.is_correct,"wrong-guess":!I.is_correct}])},[e("span",Ns,f(we(I.user_id)),1),I.is_correct?(c(),l("span",Es,"çŒœä¸­äº†ï¼ +"+f(I.score_earned),1)):(c(),l("span",Bs,f(I.guess_text),1))],2))),128)),!o(v)&&o(A)?(c(),l("div",Ps,[...r[8]||(r[8]=[e("span",{class:"msg-icon"},"âœ…",-1),j(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):$("",!0)],512),e("div",As,[o(v)?(c(),l("input",Hs)):He((c(),l("input",{key:1,"onUpdate:modelValue":r[0]||(r[0]=I=>Ue(B)?B.value=I:null),type:"text",placeholder:Ie.value,maxlength:"32",disabled:de.value||o(A)||o(y),onKeyup:ze(_e,["enter"]),class:"chat-input-field"},null,40,Os)),[[Oe,o(B)]]),e("button",{onClick:_e,disabled:o(v)||de.value||o(A)||o(y)||!o(B).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,zs)])])])])])):o(b)?(c(),l("div",Us,[e("div",qs,[e("div",Js,[e("div",Ks,[e("div",Ys,[r[9]||(r[9]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),z(Ce,{"show-winner":!0}),e("button",{onClick:re,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):$("",!0)]))}}),Zs=Z(Xs,[["__scopeId","data-v-029b8972"]]);export{Zs as default};
