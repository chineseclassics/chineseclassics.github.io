import{l as He,r as W,u as q,d as J,i as se,m as te,c as i,e,o as r,_ as K,f as L,n as N,a as M,F as E,p as O,q as ce,t as v,b as o,s as U,h as ee,x as Q,y as Ae,j as B,z as ye,A as ze,g as Ue,v as qe,B as Je,C as Ke,k as Ye,D as Xe}from"./index-BdoKqGY1.js";import{c as ne,b as ue,d as de,e as $e,a as je,u as Qe,W as Ze}from"./WaitingLobby-DkcpMbnB.js";const Ce=He("drawing",()=>{const t=W("pen"),c=W("#000000"),d=W(3),m=W(!1),s=W([]);function l(R){t.value=R}function f(R){c.value=R}function w(R){d.value=Math.max(1,Math.min(20,R))}function k(R){s.value.push(R)}function x(){s.value=[]}function S(R){m.value=R}return{tool:t,color:c,lineWidth:d,isDrawing:m,strokes:s,setTool:l,setColor:f,setLineWidth:w,addStroke:k,clearStrokes:x,setDrawing:S}});function be(t,c){const d=t.getBoundingClientRect();let m,s;if(c instanceof MouseEvent)m=c.clientX,s=c.clientY;else if(c instanceof TouchEvent&&c.touches.length>0&&c.touches[0])m=c.touches[0].clientX,s=c.touches[0].clientY;else return null;return{x:m-d.left,y:s-d.top}}function Se(t,c){if(!(c.points.length<2)){t.save(),c.tool==="pen"?(t.strokeStyle=c.color,t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"):c.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=c.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),c.points[0]&&t.moveTo(c.points[0].x,c.points[0].y);for(let d=1;d<c.points.length;d++){const m=c.points[d];m&&t.lineTo(m.x,m.y)}t.stroke(),t.restore()}}function ie(t,c){const d=t.getContext("2d");if(!d)return;const m=t.getBoundingClientRect();d.clearRect(0,0,t.width,t.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,m.width,m.height),c.forEach(s=>{Se(d,s)})}function es(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Fe(){const t=Ce(),c=ne(),d=q(),{sendDrawing:m}=ue(),s=W(null),l=W(null),f=W(null),w=W(null);let k=null;const x=50;function S(n){s.value=n;const g=n.getContext("2d",{willReadFrequently:!0});if(!g){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}l.value=g;const G=window.devicePixelRatio||1,P=n.getBoundingClientRect();n.width=P.width*G,n.height=P.height*G,g.scale(G,G),g.fillStyle="#FFFFFF",g.fillRect(0,0,P.width,P.height),s.value&&ie(s.value,t.strokes),new ResizeObserver(()=>{if(!s.value||!l.value)return;const H=s.value.getBoundingClientRect(),A=window.devicePixelRatio||1;s.value.width=H.width*A,s.value.height=H.height*A,l.value.scale(A,A),l.value.fillStyle="#FFFFFF",l.value.fillRect(0,0,H.width,H.height),ie(s.value,t.strokes)}).observe(n)}function R(n){if(!s.value)return;n.preventDefault(),t.setDrawing(!0);const g=be(s.value,n);g&&(f.value={id:es(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[g],timestamp:Date.now()},w.value=g)}function F(n){if(!s.value||!l.value||!t.isDrawing||!f.value)return;n.preventDefault();const g=be(s.value,n);if(!g||!w.value)return;const G=l.value;G.save(),f.value.tool==="pen"?(G.strokeStyle=f.value.color,G.lineWidth=f.value.lineWidth,G.lineCap="round",G.lineJoin="round"):f.value.tool==="eraser"&&(G.globalCompositeOperation="destination-out",G.lineWidth=f.value.lineWidth,G.lineCap="round",G.lineJoin="round"),G.beginPath(),G.moveTo(w.value.x,w.value.y),G.lineTo(g.x,g.y),G.stroke(),G.restore(),f.value.points.push(g),w.value=g,k===null&&(k=window.setTimeout(()=>{b(),k=null},x))}function y(){!t.isDrawing||!f.value||(t.setDrawing(!1),k&&(clearTimeout(k),k=null),b(),f.value=null,w.value=null)}async function b(){if(!(!f.value||!c.currentRoom||!d.user))try{const n={...f.value,userId:d.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",n.id),await m(c.currentRoom.code,n)}catch(n){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",n)}}function p(n){if(!(!s.value||!l.value)){if(n.userId&&d.user&&n.userId===d.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",n.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",n.id),t.addStroke(n),Se(l.value,n)}}function u(){if(!s.value||!l.value)return;const n=l.value,g=s.value;n.clearRect(0,0,g.width,g.height),n.fillStyle="#FFFFFF",n.fillRect(0,0,g.width,g.height),t.clearStrokes()}function I(n){t.setTool(n)}function $(n){t.setColor(n)}function C(n){t.setLineWidth(n)}function h(){s.value&&ie(s.value,t.strokes)}return{canvasRef:s,initCanvas:S,startDrawing:R,draw:F,stopDrawing:y,clearCanvas:u,setTool:I,setColor:$,setLineWidth:C,handleDrawingData:p,redrawStrokes:h}}const ss={class:"drawing-canvas-container"},ts=J({__name:"DrawingCanvas",setup(t){const{initCanvas:c,startDrawing:d,draw:m,stopDrawing:s,handleDrawingData:l,clearCanvas:f}=Fe(),w=ne(),k=q(),{subscribeDrawing:x}=ue(),S=W(null);function R(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),f()}function F(n){d(n)}function y(n){m(n)}function b(){s()}function p(){s()}function u(n){d(n)}function I(n){m(n)}function $(){s()}let C=null;function h(){!w.currentRoom||!k.user||(C=x(w.currentRoom.code,n=>{l(n)}))}return se(()=>{S.value&&c(S.value),h(),window.addEventListener("clearCanvas",R)}),te(()=>{C&&(C(),C=null),window.removeEventListener("clearCanvas",R)}),(n,g)=>(r(),i("div",ss,[e("canvas",{ref_key:"canvasElement",ref:S,class:"drawing-canvas",onMousedown:F,onMousemove:y,onMouseup:b,onMouseleave:p,onTouchstart:u,onTouchmove:I,onTouchend:$},null,544)]))}}),ns=K(ts,[["__scopeId","data-v-f29d9704"]]),os={class:"toolbar-section"},rs={key:0,class:"tool-label"},as={key:0,class:"tool-label"},is={key:0,class:"toolbar-section colors-section"},ls=["onClick","title"],cs={class:"toolbar-section size-section"},us={class:"size-dots"},ds=["onClick","title"],vs={class:"toolbar-section"},ms={key:0,class:"tool-label"},hs=J({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const c=Ce(),{setTool:d,setColor:m,setLineWidth:s,clearCanvas:l}=Fe(),f=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],w=L(()=>c.tool),k=L(()=>c.color),x=L(()=>c.lineWidth);function S(b){d(b)}function R(b){m(b)}function F(b){c.setLineWidth(b),s(b)}function y(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&l()}return(b,p)=>(r(),i("div",{class:N(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",os,[e("button",{onClick:p[0]||(p[0]=u=>S("pen")),class:N(["tool-btn",{active:w.value==="pen"}]),title:"ç•«ç­†"},[p[2]||(p[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?M("",!0):(r(),i("span",rs,"ç•«ç­†"))],2),e("button",{onClick:p[1]||(p[1]=u=>S("eraser")),class:N(["tool-btn",{active:w.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[p[3]||(p[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?M("",!0):(r(),i("span",as,"æ©¡çš®æ“¦"))],2)]),w.value==="pen"?(r(),i("div",is,[e("div",{class:N(["color-grid",{"color-grid-compact":t.compact}])},[(r(),i(E,null,O(f,u=>e("div",{key:u,onClick:I=>R(u),class:N(["color-cell",{selected:k.value===u}]),style:ce({backgroundColor:u}),title:u},null,14,ls)),64))],2)])):M("",!0),e("div",cs,[e("div",us,[(r(),i(E,null,O([2,5,10,15],u=>e("div",{key:u,onClick:I=>F(u),class:N(["size-dot",{active:x.value===u}]),style:ce({width:`${u+8}px`,height:`${u+8}px`}),title:`${u}px`},null,14,ds)),64))])]),e("div",vs,[e("button",{onClick:y,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[p[4]||(p[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?M("",!0):(r(),i("span",ms,"æ¸…ç©º"))])])],2))}}),le=K(hs,[["__scopeId","data-v-7e7250c3"]]),ws={class:"player-list"},fs={class:"player-list-header"},_s={class:"player-count"},gs={class:"player-rank"},ps={class:"player-info"},ys={class:"player-name"},bs={key:0,class:"drawer-badge"},ks={key:1,class:"host-badge"},Rs={class:"player-score"},$s=["onClick"],Cs={key:0,class:"winner-banner"},Ss={class:"winner-text"},Fs={class:"winner-name"},Ds={class:"winner-score"},Ws=J({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:c}){const d=c,m=ne(),s=de(),l=q(),{playerRankings:f,winner:w}=$e(),k=L(()=>f.value),x=W(!1);function S(u){return m.participants.find($=>$.user_id===u)?.nickname||"æœªçŸ¥ç©å®¶"}function R(u){return l.user?.id===u}function F(u){return m.currentRoom?.host_id===u}function y(u){return s.currentRound?.drawer_id===u}function b(u){return m.isHost&&!R(u)}async function p(u,I){if(!(x.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${I} å—ï¼Ÿ`))){x.value=!0;try{const C=await m.kickPlayer(u);C.success?d("player-kicked",u):alert(C.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(C){console.error("è¸¢äººå¤±æ•—:",C),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{x.value=!1}}}return(u,I)=>(r(),i("div",ws,[e("div",fs,[e("span",_s,"ç©å®¶ ("+v(k.value.length)+")",1)]),(r(!0),i(E,null,O(k.value,($,C)=>(r(),i("div",{key:$.id,class:N(["player-item",{"is-current":R($.user_id)},{"is-drawer":y($.user_id)}])},[e("div",gs,v(C+1),1),e("div",{class:N(["player-avatar",{drawing:y($.user_id)}])},v(S($.user_id).charAt(0)),3),e("div",ps,[e("div",ys,[U(v(S($.user_id))+" ",1),y($.user_id)?(r(),i("span",bs,"âœï¸")):M("",!0),F($.user_id)?(r(),i("span",ks,"ğŸ‘‘")):M("",!0)]),e("div",Rs,v($.score)+" åˆ†",1)]),b($.user_id)?(r(),i("button",{key:0,class:"kick-btn",onClick:h=>p($.user_id,S($.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,$s)):M("",!0)],2))),128)),t.showWinner&&o(w)?(r(),i("div",Cs,[I[1]||(I[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",Ss,[I[0]||(I[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",Fs,v(S(o(w).user_id)),1),e("div",Ds,v(o(w).score)+" åˆ†",1)])])):M("",!0)]))}}),ke=K(Ws,[["__scopeId","data-v-846d90e2"]]),xs={class:"word-selection"},Is={class:"selection-card"},Ts={class:"selection-header"},Gs={class:"round-info"},Ms={class:"countdown-section"},Ls={class:"countdown-number"},Ns={class:"countdown-text"},Es={class:"word-options"},Vs=["onClick","disabled"],Bs={class:"word-text"},Os={key:0,class:"word-source"},Ps={class:"selection-footer"},Hs=["disabled"],As=J({__name:"WordSelection",props:{wordOptions:{},roundNumber:{},totalRounds:{},selectionTime:{}},emits:["word-selected"],setup(t,{emit:c}){const d=t,m=c,s=W(null),l=W(!1),f=W(d.selectionTime);let w=null;function k(F){l.value||(s.value=F)}function x(){!s.value||l.value||(l.value=!0,m("word-selected",s.value),w&&clearInterval(w))}function S(){if(l.value)return;const F=Math.floor(Math.random()*d.wordOptions.length),y=d.wordOptions[F];y&&(s.value=y.text,l.value=!0,m("word-selected",y.text))}function R(){f.value=d.selectionTime,w=window.setInterval(()=>{f.value>0?f.value--:(w&&clearInterval(w),S())},1e3)}return se(()=>{R()}),te(()=>{w&&clearInterval(w)}),(F,y)=>(r(),i("div",xs,[e("div",Is,[e("div",Ts,[y[0]||(y[0]=e("h2",{class:"selection-title"},"ğŸ¨ è¼ªåˆ°ä½ ç•«ç•«äº†ï¼",-1)),e("div",Gs,"ç¬¬ "+v(t.roundNumber)+" / "+v(t.totalRounds)+" è¼ª",1)]),e("div",Ms,[e("div",{class:N(["countdown-ring",{warning:f.value<=5}])},[e("span",Ls,v(f.value),1)],2),e("div",Ns,v(f.value<=5?"å³å°‡è‡ªå‹•é¸æ“‡ï¼":"è«‹é¸æ“‡ä¸€å€‹è©èª"),1)]),e("div",Es,[(r(!0),i(E,null,O(t.wordOptions,(b,p)=>(r(),i("button",{key:p,class:N(["word-option",{selected:s.value===b.text}]),onClick:u=>k(b.text),disabled:l.value},[e("span",Bs,v(b.text),1),b.source==="custom"?(r(),i("span",Os,"è‡ªè¨‚")):M("",!0)],10,Vs))),128))]),e("div",Ps,[e("button",{class:"confirm-btn",disabled:!s.value||l.value,onClick:x},v(l.value?"å·²é¸æ“‡":"ç¢ºèªé¸æ“‡"),9,Hs)])])]))}}),zs=K(As,[["__scopeId","data-v-00208fc2"]]),Us={class:"round-summary"},qs={class:"summary-card"},Js={key:0,class:"selection-waiting-banner"},Ks={class:"waiting-text"},Ys={class:"next-drawer-name"},Xs={class:"summary-header"},js={class:"summary-title"},Qs={class:"round-info"},Zs={class:"answer-reveal"},et={class:"answer-text"},st={class:"drawer-section"},tt={class:"drawer-info"},nt={class:"drawer-name"},ot={key:0,class:"drawer-score"},rt={class:"guessers-section"},at={key:0,class:"no-guessers"},it={key:1,class:"guessers-list"},lt={class:"guesser-rank"},ct={class:"guesser-name"},ut={class:"guesser-score"},dt={key:1,class:"rating-section"},vt={class:"star-rating"},mt=["onMouseenter","onClick","disabled"],ht={class:"rating-info"},wt={key:0,class:"rated-text"},ft={key:1,class:"rate-hint"},_t={key:2,class:"average-rating"},gt={class:"avg-score"},pt={class:"avg-stars"},yt={class:"avg-count"},bt={key:3,class:"summary-footer"},kt={key:0,class:"countdown"},Rt=J({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["next-round","rating-submitted"],setup(t,{emit:c}){const d=t,m=c,s=q(),l=W(0),f=W(0),w=W(!1),k=W([]),x=W(8);let S=null;const R=L(()=>s.user?.id===d.drawerId),F=L(()=>k.value.length===0?0:k.value.reduce((h,n)=>h+n.rating,0)/k.value.length),y=L(()=>k.value.length);async function b(C){if(!(w.value||R.value||!s.user))try{const{error:h}=await Q.from("drawing_ratings").upsert({round_id:d.roundId,rater_id:s.user.id,drawer_id:d.drawerId,rating:C},{onConflict:"round_id,rater_id"});if(h)throw h;l.value=C,w.value=!0,m("rating-submitted",C)}catch(h){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",h)}}async function p(){try{const{data:C,error:h}=await Q.from("drawing_ratings").select("rater_id, rating").eq("round_id",d.roundId);if(h)throw h;if(k.value=C||[],s.user){const n=k.value.find(g=>g.rater_id===s.user.id);n&&(l.value=n.rating,w.value=!0)}}catch(C){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",C)}}function u(){const C=Q.channel(`ratings:${d.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${d.roundId}`},()=>{p()}).subscribe();return()=>{Q.removeChannel(C)}}function I(){S=window.setInterval(()=>{x.value>0?x.value--:(S&&clearInterval(S),d.isHost&&m("next-round"))},1e3)}let $=null;return se(()=>{p(),$=u(),I()}),te(()=>{S&&clearInterval(S),$&&$()}),ee(()=>d.roundId,()=>{p(),x.value=8}),(C,h)=>(r(),i("div",Us,[e("div",qs,[t.isWaitingForSelection?(r(),i("div",Js,[h[3]||(h[3]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",Ks,[e("span",Ys,v(t.nextDrawerName),1),h[2]||(h[2]=U(" æ­£åœ¨é¸è©... ",-1))]),h[4]||(h[4]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",Xs,[e("h2",js,v(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Qs,"ç¬¬ "+v(t.roundNumber)+" / "+v(t.totalRounds)+" è¼ª",1)]),e("div",Zs,[h[5]||(h[5]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",et,v(t.correctAnswer),1)]),e("div",st,[e("div",tt,[h[6]||(h[6]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",nt,v(t.drawerName),1),t.drawerScore>0?(r(),i("span",ot,"+"+v(t.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",rt,[h[7]||(h[7]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(r(),i("div",at," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(r(),i("div",it,[(r(!0),i(E,null,O(t.correctGuessers,(n,g)=>(r(),i("div",{key:n.userId,class:"guesser-item"},[e("span",lt,v(g+1),1),e("span",ct,v(n.name),1),e("span",ut,"+"+v(n.score),1)]))),128))]))]),R.value?M("",!0):(r(),i("div",dt,[h[8]||(h[8]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",vt,[(r(),i(E,null,O(5,n=>e("button",{key:n,class:N(["star-btn",{active:n<=(f.value||l.value),selected:n<=l.value}]),onMouseenter:g=>f.value=n,onMouseleave:h[0]||(h[0]=g=>f.value=0),onClick:g=>b(n),disabled:w.value}," â­ ",42,mt)),64))]),e("div",ht,[w.value?(r(),i("span",wt,"ä½ çš„è©•åˆ†ï¼š"+v(l.value)+" æ˜Ÿ",1)):(r(),i("span",ft,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),y.value>0?(r(),i("div",_t,[h[9]||(h[9]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",gt,v(F.value.toFixed(1)),1),e("span",pt,v("â­".repeat(Math.round(F.value))),1),e("span",yt,"("+v(y.value)+" äººå·²è©•)",1)])):M("",!0),t.isWaitingForSelection?M("",!0):(r(),i("div",bt,[x.value>0?(r(),i("div",kt,v(x.value)+" ç§’å¾Œè‡ªå‹•é€²å…¥ä¸‹ä¸€è¼ª ",1)):M("",!0),t.isHost?(r(),i("button",{key:1,class:"next-btn",onClick:h[1]||(h[1]=n=>C.$emit("next-round"))},v(t.isLastRound?"æŸ¥çœ‹çµæœ":"ä¸‹ä¸€è¼ª"),1)):M("",!0)]))])]))}}),Re=K(Rt,[["__scopeId","data-v-23450531"]]);function $t(){const t=de(),c=q(),{calculateGuessScore:d,updatePlayerScore:m}=$e(),s=W(""),l=W(null),f=W(!1),w=L(()=>t.isCurrentDrawer?t.currentWord:null),k=L(()=>t.correctGuesses),x=L(()=>c.user?t.hasGuessed(c.user.id):!1);async function S(){if(!t.currentRound||!c.user)return l.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return l.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return l.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(x.value)return l.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return l.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{f.value=!0,l.value=null;const y=s.value.trim(),b=t.currentWord||"",p=R(y,b),u=p?d(k.value.length):0,{data:I,error:$}=await Q.from("guesses").insert({round_id:t.currentRound.id,user_id:c.user.id,guess_text:y,is_correct:p,score_earned:u}).select().single();if($)throw $;return t.guesses.push(I),p&&c.user&&await m(c.user.id,u),s.value="",{success:!0,isCorrect:p,guess:I}}catch(y){return l.value=y instanceof Error?y.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",y),{success:!1,error:l.value}}finally{f.value=!1}}function R(y,b){const p=y.trim(),u=b.trim();return p===u}function F(){l.value=null}return{guessInput:s,error:l,loading:f,currentWord:w,correctGuesses:k,hasGuessed:x,submitGuess:S,clearError:F}}const Ct={class:"game-container"},St={key:0,class:"container margin-top-large"},Ft={class:"row flex-center"},Dt={class:"col-12 col-md-8"},Wt={key:1,class:"game-layout"},xt={class:"game-sidebar game-players"},It={class:"player-list-container"},Tt={class:"game-main"},Gt={key:0,class:"time-display"},Mt={key:1,class:"time-display selecting"},Lt={class:"time-number time-warning"},Nt={key:2,class:"time-display summary"},Et={class:"time-number"},Vt={class:"round-info"},Bt={class:"round-label"},Ot={key:0,class:"phase-label"},Pt={key:1,class:"phase-label"},Ht={key:3,class:"word-display"},At={class:"word-text"},zt={key:4,class:"word-display"},Ut={class:"word-slots"},qt={key:5,class:"word-display"},Jt={class:"word-slots"},Kt={key:6,class:"word-display summary-word"},Yt={class:"word-text revealed"},Xt={class:"game-content-area"},jt={class:"game-toolbar disabled"},Qt={class:"game-canvas selection-phase"},Zt={key:2,class:"first-round-waiting"},en={class:"waiting-card"},sn={class:"waiting-title"},tn={class:"game-chat-panel"},nn={class:"game-toolbar disabled"},on={class:"game-canvas summary-phase"},rn={class:"game-chat-panel"},an={class:"chat-msg system-msg answer-revealed"},ln={class:"msg-player"},cn={class:"msg-correct"},un={class:"game-toolbar"},dn={class:"game-canvas"},vn={key:0,class:"time-progress"},mn={class:"game-chat-panel"},hn={class:"msg-player"},wn={key:0,class:"msg-correct"},fn={key:1,class:"msg-text"},_n={key:0,class:"chat-msg correct-self"},gn={class:"chat-input-area"},pn=["placeholder","disabled"],yn=["disabled"],bn={key:2,class:"container margin-top-large"},kn={class:"row flex-center"},Rn={class:"col-12 col-md-8"},$n={class:"card"},Cn={class:"card-body text-center"},Sn=J({__name:"RoomView",setup(t){const c=Ae(),d=Ye(),m=ne(),s=de(),l=q(),{subscribeRoom:f,unsubscribeRoom:w,subscribeGameState:k}=ue(),{isPlaying:x,isWaiting:S,isFinished:R,timeRemaining:F,isCountingDown:y,isCurrentDrawer:b,drawTime:p,currentRoundNumber:u,totalRounds:I,startGame:$,skipWord:C,isSelecting:h,isDrawing:n,isSummary:g,wordOptions:G,selectionTimeRemaining:P,summaryTimeRemaining:oe,selectWord:H,stopSelectionCountdown:A,startSelectionCountdown:De,startSummaryCountdown:We,stopSummaryCountdown:xe,startCountdown:Ie}=je(),{hasGuessed:Z,guessInput:Y,submitGuess:Te,loading:Ge}=$t(),{leaveRoom:Me}=Qe(),T=L(()=>m.currentRoom),ve=L(()=>Ge.value),me=W(null),z=W(null),X=L(()=>{const _=T.value?.current_drawer_id;return _&&m.participants.find(D=>D.user_id===_)?.nickname||"ç•«å®¶"}),he=L(()=>!T.value||!l.user?!1:T.value.current_drawer_id===l.user.id),we=L(()=>[...s.guesses].sort((_,a)=>new Date(_.guessed_at).getTime()-new Date(a.guessed_at).getTime()));function Le(){z.value&&(z.value.scrollTop=z.value.scrollHeight)}ee(we,()=>{Xe(Le)},{deep:!0}),ee(()=>m.participants,_=>{if(!l.user||!T.value)return;!_.some(D=>D.user_id===l.user.id)&&T.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),m.clearRoom(),d.push("/"))},{deep:!0});function re(_){return m.participants.find(D=>D.user_id===_)?.nickname||"æœªçŸ¥ç©å®¶"}const Ne=L(()=>b.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":Z.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Ee=L(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),fe=L(()=>s.currentRoundCorrectGuesses.length*5),_e=L(()=>s.currentRoundCorrectGuesses.map(_=>({userId:_.user_id,name:re(_.user_id),score:_.score_earned}))),V=W(null);function Ve(){!s.currentRound||!s.currentWord||(V.value={roundNumber:u.value,answer:s.currentWord,drawerName:X.value,drawerId:s.currentRound.drawer_id,drawerScore:fe.value,correctGuessers:_e.value,roundId:s.currentRound.id})}ee(h,(_,a)=>{_&&!a&&u.value>0&&Ve()});function j(_){me.value=_,setTimeout(()=>{me.value=null},3e3)}async function ge(){!b.value&&Y.value.trim()&&await Te()}async function Be(){const _=await $();!_.success&&_.error&&j(_.error)}async function ae(){const _=await Me();T.value&&w(T.value.code),await d.push("/"),!_.success&&_.error&&j(_.error)}async function Oe(){const _=await C();!_.success&&_.error&&j(_.error)}async function Pe(_){const a=G.value.find(D=>D.text===_);if(a){const D=await H(a);!D.success&&D.error&&j(D.error)}}async function pe(_){if(!s.currentRound)return;const a=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,_);!a.success&&a.error&&j(a.error)}return se(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",c.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",T.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",l.user?.id);const _=c.params.code;if(_&&!T.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",_),T.value&&l.user){console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",T.value.status),await s.loadCurrentRound(T.value.id);try{await f(T.value.code,T.value.id,l.user.id,{nickname:l.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(a){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",a)}k(T.value.code,async a=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",a),a.roundStatus&&(s.setRoundStatus(a.roundStatus),a.roundStatus==="selecting"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),xe(),De()),a.roundStatus==="drawing"&&(A(),Ie(p.value)),a.roundStatus==="summary"&&We()),a.wordOptions!==void 0&&s.setWordOptions(a.wordOptions),a.drawerId&&T.value&&m.setCurrentDrawer(a.drawerId),T.value&&(await m.loadRoom(T.value.id),await s.loadCurrentRound(T.value.id))}),await s.loadAllGuesses(T.value.id)}}),te(()=>{T.value&&w(T.value.code)}),(_,a)=>(r(),i("div",Ct,[o(S)?(r(),i("div",St,[e("div",Ft,[e("div",Dt,[B(Ze,{room:T.value,participants:o(m).participants,onStartGame:Be,onLeaveRoom:ae},null,8,["room","participants"])])])])):o(x)?(r(),i("div",Wt,[e("div",xt,[e("div",It,[B(ke,{"show-winner":!1})])]),e("div",Tt,[e("div",{class:N(["game-header",{"time-critical":o(F)!==null&&o(F)<=10}])},[o(n)&&o(y)&&o(F)!==null?(r(),i("div",Gt,[e("span",{class:N(["time-number",{"time-warning":o(F)<=10,"time-critical-pulse":o(F)<=5}])},v(o(F)),3),a[1]||(a[1]=e("span",{class:"time-label"},"ç§’",-1))])):o(h)&&o(P)!==null?(r(),i("div",Mt,[e("span",Lt,v(o(P)),1),a[2]||(a[2]=e("span",{class:"time-label"},"ç§’é¸è©",-1))])):o(g)&&o(oe)!==null?(r(),i("div",Nt,[e("span",Et,v(o(oe)),1),a[3]||(a[3]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",Vt,[e("span",Bt,"ç¬¬ "+v(o(u)+(o(h)?1:0))+" / "+v(o(I))+" è¼ª",1),o(h)?(r(),i("span",Ot,"é¸è©ä¸­")):o(g)?(r(),i("span",Pt,"è¼ªæ¬¡çµç®—")):M("",!0)]),o(n)&&o(b)&&o(s).currentWord?(r(),i("div",Ht,[a[4]||(a[4]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",At,v(o(s).currentWord),1),e("button",{class:"skip-btn",onClick:Oe,title:"è·³éæ­¤è©"},"è·³é")])):o(n)?(r(),i("div",zt,[e("span",Ut,v(Ee.value),1)])):o(h)?(r(),i("div",qt,[e("span",Jt,v(he.value?"è«‹é¸æ“‡è¦ç•«çš„è©èª":`${X.value} æ­£åœ¨é¸è©...`),1)])):o(g)&&o(s).currentWord?(r(),i("div",Kt,[a[5]||(a[5]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",Yt,v(o(s).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:ae,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Xt,[o(h)?(r(),i(E,{key:0},[e("div",jt,[B(le,{compact:!0})]),e("div",Qt,[he.value?(r(),ye(zs,{key:0,"word-options":o(G),"round-number":o(u)+1,"total-rounds":o(I),"selection-time":15,onWordSelected:Pe},null,8,["word-options","round-number","total-rounds"])):V.value?(r(),ye(Re,{key:1,"round-number":V.value.roundNumber,"total-rounds":o(I),"correct-answer":V.value.answer,"drawer-name":V.value.drawerName,"drawer-id":V.value.drawerId,"drawer-score":V.value.drawerScore,"correct-guessers":V.value.correctGuessers,"round-id":V.value.roundId,"is-host":o(m).isHost,"is-last-round":!1,"is-waiting-for-selection":!0,"next-drawer-name":X.value,onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","next-drawer-name"])):(r(),i("div",Zt,[e("div",en,[a[6]||(a[6]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("h2",sn,v(X.value)+" æ­£åœ¨é¸è©...",1),a[7]||(a[7]=ze('<p class="waiting-hint" data-v-c6493638>ç¬¬ä¸€è¼ªå³å°‡é–‹å§‹</p><div class="waiting-dots" data-v-c6493638><span class="dot" data-v-c6493638></span><span class="dot" data-v-c6493638></span><span class="dot" data-v-c6493638></span></div>',2))])]))]),e("div",tn,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[...a[8]||(a[8]=[e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"â³"),U(" ç­‰å¾…ç•«å®¶é¸è©... ")],-1)])],512),a[9]||(a[9]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ç­‰å¾…é¸è©...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):o(g)?(r(),i(E,{key:1},[e("div",nn,[B(le,{compact:!0})]),e("div",on,[B(Re,{"round-number":o(u),"total-rounds":o(I),"correct-answer":o(s).currentWord||"","drawer-name":X.value,"drawer-id":o(s).currentRound?.drawer_id||"","drawer-score":fe.value,"correct-guessers":_e.value,"round-id":o(s).currentRound?.id||"","is-host":o(m).isHost,"is-last-round":o(u)>=o(I),onRatingSubmitted:pe},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",rn,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[e("div",an,[a[10]||(a[10]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),a[11]||(a[11]=U(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,v(o(s).currentWord),1)]),(r(!0),i(E,null,O(o(s).currentRoundCorrectGuesses,D=>(r(),i("div",{key:D.id,class:"chat-msg correct-guess"},[e("span",ln,v(re(D.user_id)),1),e("span",cn,"çŒœä¸­äº†ï¼ +"+v(D.score_earned),1)]))),128))],512),a[12]||(a[12]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(r(),i(E,{key:2},[e("div",un,[B(le,{compact:!0})]),e("div",dn,[B(ns),o(y)&&o(F)!==null?(r(),i("div",vn,[e("div",{class:N(["time-bar",{"time-warning":o(F)<=10}]),style:ce({width:`${o(F)/o(p)*100}%`})},null,6)])):M("",!0)]),e("div",mn,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:z},[a[14]||(a[14]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),U(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(r(!0),i(E,null,O(we.value,D=>(r(),i("div",{key:D.id,class:N(["chat-msg",{"correct-guess":D.is_correct,"wrong-guess":!D.is_correct}])},[e("span",hn,v(re(D.user_id)),1),D.is_correct?(r(),i("span",wn,"çŒœä¸­äº†ï¼ +"+v(D.score_earned),1)):(r(),i("span",fn,v(D.guess_text),1))],2))),128)),o(Z)?(r(),i("div",_n,[...a[13]||(a[13]=[e("span",{class:"msg-icon"},"âœ…",-1),U(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",gn,[Ue(e("input",{"onUpdate:modelValue":a[0]||(a[0]=D=>Ke(Y)?Y.value=D:null),type:"text",placeholder:Ne.value,maxlength:"32",disabled:ve.value||o(Z)||o(b),onKeyup:Je(ge,["enter"]),class:"chat-input-field"},null,40,pn),[[qe,o(Y)]]),e("button",{onClick:ge,disabled:ve.value||o(Z)||o(b)||!o(Y).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,yn)])])],64))])])])):o(R)?(r(),i("div",bn,[e("div",kn,[e("div",Rn,[e("div",$n,[e("div",Cn,[a[15]||(a[15]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),B(ke,{"show-winner":!0}),e("button",{onClick:ae,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),Wn=K(Sn,[["__scopeId","data-v-c6493638"]]);export{Wn as default};
