import{l as le,r as k,u as E,d as P,i as Q,m as Z,c as m,e as t,o as g,_ as B,f as M,n as G,a as T,F as A,p as J,q as X,t as x,b as _,s as O,x as ce,y as ue,j as V,z as de,g as ve,v as he,A as fe,B as me}from"./index-D33YqNns.js";import{c as N,b as q,d as z,e as ee,a as ge,u as pe,W as _e}from"./useRealtime-DhrfCrA7.js";const te=le("drawing",()=>{const e=k("pen"),s=k("#000000"),a=k(3),d=k(!1),o=k([]);function i(u){e.value=u}function l(u){s.value=u}function f(u){a.value=Math.max(1,Math.min(20,u))}function y(u){o.value.push(u)}function F(){o.value=[]}function C(u){d.value=u}return{tool:e,color:s,lineWidth:a,isDrawing:d,strokes:o,setTool:i,setColor:l,setLineWidth:f,addStroke:y,clearStrokes:F,setDrawing:C}});function H(e,s){const a=e.getBoundingClientRect(),d=e.width/a.width,o=e.height/a.height;let i,l;if(s instanceof MouseEvent)i=s.clientX,l=s.clientY;else if(s instanceof TouchEvent&&s.touches.length>0&&s.touches[0])i=s.touches[0].clientX,l=s.touches[0].clientY;else return null;return{x:(i-a.left)*d,y:(l-a.top)*o}}function se(e,s){if(!(s.points.length<2)){e.save(),s.tool==="pen"?(e.strokeStyle=s.color,e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"):s.tool==="eraser"&&(e.globalCompositeOperation="destination-out",e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"),e.beginPath(),s.points[0]&&e.moveTo(s.points[0].x,s.points[0].y);for(let a=1;a<s.points.length;a++){const d=s.points[a];d&&e.lineTo(d.x,d.y)}e.stroke(),e.restore()}}function K(e,s){const a=e.getContext("2d");a&&(a.clearRect(0,0,e.width,e.height),a.fillStyle="#FFFFFF",a.fillRect(0,0,e.width,e.height),s.forEach(d=>{se(a,d)}))}function we(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function oe(){const e=te(),s=N(),a=E(),{sendDrawing:d}=q(),o=k(null),i=k(null),l=k(null),f=k(null);let y=null;const F=50;function C(n){o.value=n;const c=n.getContext("2d",{willReadFrequently:!0});if(!c){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}i.value=c;const p=window.devicePixelRatio||1,L=n.getBoundingClientRect();n.width=L.width*p,n.height=L.height*p,c.scale(p,p),c.fillStyle="#FFFFFF",c.fillRect(0,0,L.width,L.height),o.value&&K(o.value,e.strokes)}function u(n){if(!o.value)return;n.preventDefault(),e.setDrawing(!0);const c=H(o.value,n);c&&(l.value={id:we(),tool:e.tool,color:e.color,lineWidth:e.lineWidth,points:[c],timestamp:Date.now()},f.value=c)}function D(n){if(!o.value||!i.value||!e.isDrawing||!l.value)return;n.preventDefault();const c=H(o.value,n);if(!c||!f.value)return;const p=i.value;p.save(),l.value.tool==="pen"?(p.strokeStyle=l.value.color,p.lineWidth=l.value.lineWidth,p.lineCap="round",p.lineJoin="round"):l.value.tool==="eraser"&&(p.globalCompositeOperation="destination-out",p.lineWidth=l.value.lineWidth,p.lineCap="round",p.lineJoin="round"),p.beginPath(),p.moveTo(f.value.x,f.value.y),p.lineTo(c.x,c.y),p.stroke(),p.restore(),l.value.points.push(c),f.value=c,y===null&&(y=window.setTimeout(()=>{w(),y=null},F))}function r(){!e.isDrawing||!l.value||(e.setDrawing(!1),y&&(clearTimeout(y),y=null),w(),l.value=null,f.value=null)}async function w(){if(!(!l.value||!s.currentRoom||!a.user))try{const n={...l.value,userId:a.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",n.id),await d(s.currentRoom.code,n)}catch(n){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",n)}}function h(n){if(!(!o.value||!i.value)){if(n.userId&&a.user&&n.userId===a.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",n.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",n.id),e.addStroke(n),se(i.value,n)}}function v(){if(!o.value||!i.value)return;const n=i.value,c=o.value;n.clearRect(0,0,c.width,c.height),n.fillStyle="#FFFFFF",n.fillRect(0,0,c.width,c.height),e.clearStrokes()}function $(n){e.setTool(n)}function W(n){e.setColor(n)}function R(n){e.setLineWidth(n)}function I(){o.value&&K(o.value,e.strokes)}return{canvasRef:o,initCanvas:C,startDrawing:u,draw:D,stopDrawing:r,clearCanvas:v,setTool:$,setColor:W,setLineWidth:R,handleDrawingData:h,redrawStrokes:I}}const ye={class:"drawing-canvas-container"},be=P({__name:"DrawingCanvas",setup(e){const{initCanvas:s,startDrawing:a,draw:d,stopDrawing:o,handleDrawingData:i}=oe(),l=N(),f=E(),{subscribeDrawing:y}=q(),F=k(null);function C(R){a(R)}function u(R){d(R)}function D(){o()}function r(){o()}function w(R){a(R)}function h(R){d(R)}function v(){o()}let $=null;function W(){!l.currentRoom||!f.user||($=y(l.currentRoom.code,R=>{i(R)}))}return Q(()=>{F.value&&s(F.value),W()}),Z(()=>{$&&($(),$=null)}),(R,I)=>(g(),m("div",ye,[t("canvas",{ref_key:"canvasElement",ref:F,class:"drawing-canvas",onMousedown:C,onMousemove:u,onMouseup:D,onMouseleave:r,onTouchstart:w,onTouchmove:h,onTouchend:v},null,544)]))}}),Fe=B(be,[["__scopeId","data-v-f81bcfc2"]]),Ce={class:"toolbar-section"},Se={key:0,class:"tool-label"},De={key:0,class:"tool-label"},Re={key:0,class:"toolbar-section colors-section"},ke=["onClick","title"],$e={class:"toolbar-section size-section"},We={class:"size-dots"},Te=["onClick","title"],xe={class:"toolbar-section"},Ge={key:0,class:"tool-label"},Me=P({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(e){const s=te(),{setTool:a,setColor:d,setLineWidth:o,clearCanvas:i}=oe(),l=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],f=M(()=>s.tool),y=M(()=>s.color),F=M(()=>s.lineWidth);function C(w){a(w)}function u(w){d(w)}function D(w){s.setLineWidth(w),o(w)}function r(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&i()}return(w,h)=>(g(),m("div",{class:G(["drawing-toolbar",{"toolbar-compact":e.compact}])},[t("div",Ce,[t("button",{onClick:h[0]||(h[0]=v=>C("pen")),class:G(["tool-btn",{active:f.value==="pen"}]),title:"ç•«ç­†"},[h[2]||(h[2]=t("span",{class:"tool-icon"},"âœï¸",-1)),e.compact?T("",!0):(g(),m("span",Se,"ç•«ç­†"))],2),t("button",{onClick:h[1]||(h[1]=v=>C("eraser")),class:G(["tool-btn",{active:f.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[h[3]||(h[3]=t("span",{class:"tool-icon"},"ğŸ§¹",-1)),e.compact?T("",!0):(g(),m("span",De,"æ©¡çš®æ“¦"))],2)]),f.value==="pen"?(g(),m("div",Re,[t("div",{class:G(["color-grid",{"color-grid-compact":e.compact}])},[(g(),m(A,null,J(l,v=>t("div",{key:v,onClick:$=>u(v),class:G(["color-cell",{selected:y.value===v}]),style:X({backgroundColor:v}),title:v},null,14,ke)),64))],2)])):T("",!0),t("div",$e,[t("div",We,[(g(),m(A,null,J([2,5,10,15],v=>t("div",{key:v,onClick:$=>D(v),class:G(["size-dot",{active:F.value===v}]),style:X({width:`${v+8}px`,height:`${v+8}px`}),title:`${v}px`},null,14,Te)),64))])]),t("div",xe,[t("button",{onClick:r,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[h[4]||(h[4]=t("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),e.compact?T("",!0):(g(),m("span",Ge,"æ¸…ç©º"))])])],2))}}),Le=B(Me,[["__scopeId","data-v-7e7250c3"]]),Ve={class:"player-list"},Ee={class:"player-list-header"},Ie={class:"player-count"},Pe={class:"player-rank"},Be={class:"player-info"},Ne={class:"player-name"},Ue={key:0,class:"drawer-badge"},Ye={key:1,class:"host-badge"},Ae={class:"player-score"},Je={key:0,class:"winner-banner"},Xe={class:"winner-text"},Oe={class:"winner-name"},qe={class:"winner-score"},ze=P({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(e){const s=N(),a=z(),d=E(),{playerRankings:o,winner:i}=ee(),l=M(()=>o.value);function f(u){return s.participants.find(r=>r.user_id===u)?.nickname||"æœªçŸ¥ç©å®¶"}function y(u){return d.user?.id===u}function F(u){return s.currentRoom?.host_id===u}function C(u){return a.currentRound?.drawer_id===u}return(u,D)=>(g(),m("div",Ve,[t("div",Ee,[t("span",Ie,"ç©å®¶ ("+x(l.value.length)+")",1)]),(g(!0),m(A,null,J(l.value,(r,w)=>(g(),m("div",{key:r.id,class:G(["player-item",{"is-current":y(r.user_id)},{"is-drawer":C(r.user_id)}])},[t("div",Pe,x(w+1),1),t("div",{class:G(["player-avatar",{drawing:C(r.user_id)}])},x(f(r.user_id).charAt(0)),3),t("div",Be,[t("div",Ne,[O(x(f(r.user_id))+" ",1),C(r.user_id)?(g(),m("span",Ue,"âœï¸")):T("",!0),F(r.user_id)?(g(),m("span",Ye,"ğŸ‘‘")):T("",!0)]),t("div",Ae,x(r.score)+" åˆ†",1)])],2))),128)),e.showWinner&&_(i)?(g(),m("div",Je,[D[1]||(D[1]=t("div",{class:"winner-icon"},"ğŸ†",-1)),t("div",Xe,[D[0]||(D[0]=t("div",{class:"winner-title"},"ç²å‹è€…",-1)),t("div",Oe,x(f(_(i).user_id)),1),t("div",qe,x(_(i).score)+" åˆ†",1)])])):T("",!0)]))}}),j=B(ze,[["__scopeId","data-v-4094673d"]]);function He(){const e=z(),s=E(),{calculateGuessScore:a,updatePlayerScore:d}=ee(),o=k(""),i=k(null),l=k(!1),f=M(()=>e.isCurrentDrawer?e.currentWord:null),y=M(()=>e.correctGuesses),F=M(()=>s.user?e.hasGuessed(s.user.id):!1);async function C(){if(!e.currentRound||!s.user)return i.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!o.value.trim())return i.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(o.value.length>32)return i.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(F.value)return i.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(e.isCurrentDrawer)return i.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{l.value=!0,i.value=null;const r=o.value.trim(),w=e.currentWord||"",h=u(r,w),v=h?a(y.value.length):0,{data:$,error:W}=await ce.from("guesses").insert({round_id:e.currentRound.id,user_id:s.user.id,guess_text:r,is_correct:h,score_earned:v}).select().single();if(W)throw W;return e.guesses.push($),h&&s.user&&await d(s.user.id,v),h&&(o.value=""),{success:!0,isCorrect:h,guess:$}}catch(r){return i.value=r instanceof Error?r.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",r),{success:!1,error:i.value}}finally{l.value=!1}}function u(r,w){const h=r.trim(),v=w.trim();return h===v}function D(){i.value=null}return{guessInput:o,error:i,loading:l,currentWord:f,correctGuesses:y,hasGuessed:F,submitGuess:C,clearError:D}}const Ke={class:"game-container"},je={key:0,class:"container margin-top-large"},Qe={class:"row flex-center"},Ze={class:"col-12 col-md-8"},et={key:1,class:"game-layout"},tt={class:"game-sidebar game-players"},st={class:"player-list-container"},ot={class:"game-main"},nt={class:"game-header"},at={key:0,class:"word-display"},it={class:"word-text"},rt={key:1,class:"word-display"},lt={class:"game-canvas-area"},ct={class:"game-toolbar"},ut={class:"game-canvas"},dt={key:0,class:"time-progress"},vt={class:"game-bottom"},ht={class:"game-answer"},ft={class:"answer-messages"},mt={key:0,class:"answer-info"},gt={class:"answer-info"},pt={class:"answer-input"},_t=["placeholder","disabled"],wt={key:2,class:"container margin-top-large"},yt={class:"row flex-center"},bt={class:"col-12 col-md-8"},Ft={class:"card"},Ct={class:"card-body text-center"},St=P({__name:"RoomView",setup(e){const s=ue(),a=N(),d=z(),o=E(),{subscribeRoom:i,subscribeGuesses:l,unsubscribeRoom:f}=q(),{isPlaying:y,isWaiting:F,isFinished:C,timeRemaining:u,isCountingDown:D,isCurrentDrawer:r,drawTime:w,startGame:h,skipWord:v}=ge(),{hasGuessed:$,guessInput:W,submitGuess:R,loading:I}=He(),{leaveRoom:n}=pe(),c=M(()=>a.currentRoom),p=M(()=>I.value),L=k(null);function U(b){L.value=b,setTimeout(()=>{L.value=null},3e3)}async function ne(){!r.value&&W.value.trim()&&await R()}async function ae(){const b=await h();!b.success&&b.error&&U(b.error)}async function Y(){const b=await n();!b.success&&b.error&&U(b.error)}async function ie(){const b=await v();!b.success&&b.error&&U(b.error)}return Q(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",s.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",c.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",o.user?.id);const b=s.params.code;b&&!c.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",b),c.value&&o.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",c.value.status),await d.loadCurrentRound(c.value.id),i(c.value.code,c.value.id,o.user.id,{nickname:o.profile?.display_name||"ç©å®¶"}),d.currentRound&&l(c.value.code,d.currentRound.id))}),Z(()=>{c.value&&f(c.value.code)}),(b,S)=>(g(),m("div",Ke,[_(F)?(g(),m("div",je,[t("div",Qe,[t("div",Ze,[V(_e,{room:c.value,participants:_(a).participants,onStartGame:ae,onLeaveRoom:Y},null,8,["room","participants"])])])])):_(y)?(g(),m("div",et,[t("div",tt,[t("div",st,[V(j,{"show-winner":!1})])]),t("div",ot,[t("div",nt,[_(r)&&_(d).currentWord?(g(),m("div",at,[S[1]||(S[1]=t("span",{class:"word-label"},"æç¤º",-1)),t("span",it,x(_(d).currentWord),1),t("button",{class:"skip-btn",onClick:ie,title:"è·³éæ­¤è©"},"è·³é")])):(g(),m("div",rt,[...S[2]||(S[2]=[t("span",{class:"word-hint"},"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ",-1)])])),t("button",{class:"leave-btn",onClick:Y,title:"é›¢é–‹æˆ¿é–“"},"âœ•")]),t("div",lt,[t("div",ct,[V(Le,{compact:!0})]),t("div",ut,[V(Fe),_(D)&&_(u)!==null?(g(),m("div",dt,[t("div",{class:G(["time-bar",{"time-warning":_(u)<=10}]),style:X({width:`${_(u)/_(w)*100}%`})},null,6)])):T("",!0)])]),t("div",vt,[t("div",ht,[S[5]||(S[5]=t("div",{class:"answer-header"},"ç­”æ¡ˆ",-1)),t("div",ft,[_(r)?(g(),m("div",mt,[...S[3]||(S[3]=[t("span",{class:"info-icon"},"â„¹ï¸",-1),O(" ç­‰å¾…ç©å®¶åŠ å…¥ ",-1)])])):T("",!0),t("div",gt,[S[4]||(S[4]=t("span",{class:"info-icon"},"âœï¸",-1)),O(" "+x(_(r)?"è¼ªåˆ°ä½ äº†ï¼":"è¼¸å…¥ä½ çš„ç­”æ¡ˆ"),1)])]),t("div",pt,[ve(t("input",{"onUpdate:modelValue":S[0]||(S[0]=re=>me(W)?W.value=re:null),type:"text",placeholder:_(r)?"è¼ªåˆ°ä½ äº†":"è¼¸å…¥ç­”æ¡ˆ...",maxlength:"32",disabled:p.value||_($)||_(r),onKeyup:fe(ne,["enter"])},null,40,_t),[[he,_(W)]])])]),S[6]||(S[6]=de('<div class="game-chat" data-v-130c8fc7><div class="chat-header" data-v-130c8fc7>èŠå¤©å®¤</div><div class="chat-messages" data-v-130c8fc7><div class="chat-msg" data-v-130c8fc7><span class="chat-icon" data-v-130c8fc7>â„¹ï¸</span> æ­¡è¿ä¾†åˆ°éŠæˆ²ï¼</div></div><div class="chat-input" data-v-130c8fc7><input type="text" placeholder="è«‹ç™»å…¥ä»¥ç™¼é€è¨Šæ¯" disabled data-v-130c8fc7></div></div>',1))])])])):_(C)?(g(),m("div",wt,[t("div",yt,[t("div",bt,[t("div",Ft,[t("div",Ct,[S[7]||(S[7]=t("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),V(j,{"show-winner":!0}),t("button",{onClick:Y,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):T("",!0)]))}}),kt=B(St,[["__scopeId","data-v-130c8fc7"]]);export{kt as default};
