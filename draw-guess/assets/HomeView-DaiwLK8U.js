import{d as q,u as N,c as a,a as y,b as n,e,t as m,o as l,_ as z,r as $,f as E,g as Z,w as ee,h as L,v as A,F as X,i as Y,j as te,k as M,l as G,m as re}from"./index-DIkyrYAd.js";import{u as B,a as de,I as ue,W as ce}from"./WaitingLobby-CfhVPgdu.js";import{u as se}from"./useWordLibrary-BJsoKiib.js";const me={class:"user-auth"},ve={key:0},pe=["disabled"],_e={key:1},be={class:"user-info-card border margin-bottom-small"},he={class:"row flex-middle margin-bottom-small"},ge={class:"col-8"},fe={class:"row flex-middle"},ye={class:"col-auto"},we=["src","alt"],$e={key:1,class:"user-avatar border user-avatar-placeholder"},ke={class:"col"},xe={class:"text-hand user-name"},Ce={class:"text-small user-status"},Se={class:"col-4 text-right"},Re=["disabled"],Ve={key:0,class:"user-stats-inline"},We={class:"stats-row"},He={class:"stat-item"},Te={class:"stat-value"},Ee={key:2,class:"alert alert-danger margin-top-small"},Le=q({__name:"UserAuth",setup(F){const i=N();async function u(){const _=await i.signInWithGoogle();_&&!_.success&&console.error("Google 登入失敗:",_.error)}async function x(){const _=await i.signOut();_.success||console.error("登出失敗:",_.error)}function k(_){return _.toLocaleString("zh-TW")}return(_,c)=>(l(),a("div",me,[n(i).isAuthenticated?(l(),a("div",_e,[e("div",be,[e("div",he,[e("div",ge,[e("div",fe,[e("div",ye,[n(i).profile?.avatar_url?(l(),a("img",{key:0,src:n(i).profile.avatar_url,alt:n(i).profile.display_name,class:"user-avatar border"},null,8,we)):(l(),a("div",$e,m(n(i).profile?.display_name?.charAt(0)||"?"),1))]),e("div",ke,[e("div",xe,m(n(i).profile?.display_name||"用戶"),1),e("div",Ce,m(n(i).isAnonymous?"匿名遊玩":"已登入"),1)])])]),e("div",Se,[e("button",{onClick:x,disabled:n(i).loading,class:"paper-btn btn-small"},m(n(i).loading?"處理中...":"登出"),9,Re)])]),n(i).isRegistered&&n(i).profile?(l(),a("div",Ve,[e("div",We,[e("div",He,[c[0]||(c[0]=e("span",{class:"stat-label"},"總積分",-1)),e("span",Te,m(k(n(i).profile.total_score||0)),1)])]),c[1]||(c[1]=e("div",{class:"gamification-placeholder margin-top-small"},null,-1))])):y("",!0)])])):(l(),a("div",ve,[y("",!0),e("button",{onClick:u,disabled:n(i).loading,class:"paper-btn btn-primary btn-block"},m(n(i).loading?"處理中...":"Google 登入"),9,pe)])),n(i).error?(l(),a("div",Ee,m(n(i).error),1)):y("",!0)]))}}),Ae=z(Le,[["__scopeId","data-v-7ac95212"]]),Ue={class:"room-create"},je={class:"card"},Ge={class:"card-body"},qe={class:"form-group"},ze={class:"form-group"},Fe={key:0,class:"text-small text-secondary"},Je={key:1,class:"word-library-grid"},Me={class:"word-card-header"},Ne={class:"word-title"},Be={class:"word-desc"},De={class:"badge badge-warning"},Oe={class:"word-card-actions"},Ie=["onClick"],Pe=["onClick"],Ke={key:0,class:"word-entry-list"},Qe={key:0,class:"text-small text-secondary"},Xe={key:1},Ye={class:"checkbox"},Ze=["checked","onChange"],et={class:"entry-text"},tt={key:0,class:"entry-tag"},st={class:"entry-actions"},ot=["disabled","onClick"],nt=["onClick"],at=["onClick"],lt={key:2,class:"text-small info-hint"},it={class:"form-group"},rt={class:"text-small"},dt={key:0,class:"text-small",style:{color:"#e8590c"}},ut={class:"margin-top-medium"},ct={class:"form-group"},mt={class:"form-group"},vt={key:0,class:"alert alert-danger margin-top-small"},pt={class:"row flex-spaces margin-top-medium"},_t=["disabled"],bt=q({__name:"RoomCreate",emits:["cancel","created"],setup(F,{emit:i}){const u=i,{createRoom:x,loading:k}=B(),{collections:_,entriesMap:c,loadingCollections:b,loadingEntries:U,loadCollections:C,loadEntries:g}=se(),r=$({name:"",wordsText:"",settings:{draw_time:60,rounds:0,word_count_per_round:1,hints_count:2}}),d=$(null),w=$(null),S=$(null),f=$({}),R=$(new Set);function h(o){return o.split(/[，,\n]/).map(t=>t.trim()).filter(t=>t.length>0)}function v(){d.value=null}const V=E(()=>h(r.value.wordsText)),W=E(()=>{const o=new Set,t=[];for(const s of V.value)o.has(s)||(o.add(s),t.push(s));return t}),T=E(()=>W.value.length),D=E(()=>r.value.wordsText.length),O=E(()=>r.value.name.trim().length>0&&r.value.name.length<=50&&T.value>=6&&D.value<=600&&W.value.every(o=>o.length>=1&&o.length<=32));function I(){const o=new Set(W.value);R.value=new Set([...R.value].filter(t=>o.has(t)))}function oe(o,t){return f.value[o]?.has(t)??!1}function ne(o,t){const s=f.value[o]||new Set;s.has(t)?s.delete(t):s.add(t),f.value={...f.value,[o]:s}}function P(o){return(f.value[o]?.size||0)>0}function J(o){if(f.value[o]){const t={...f.value};delete t[o],f.value=t}}function K(o){const t=o.map(j=>j.trim()).filter(Boolean),s=W.value,p=new Set(s),H=[...s];t.forEach(j=>{p.has(j)||(p.add(j),H.push(j))}),r.value.wordsText=H.join(`
`),R.value=new Set([...R.value,...t]),I(),w.value=`已加入 ${t.length} 個詞條`}async function ae(o){if(S.value===o){S.value=null;return}S.value=o,await g(o)}async function le(o){const t=c.value[o]||await g(o),s=f.value[o];if(!s||s.size===0)return;const p=t?.filter(H=>s.has(H.id)).map(H=>H.text)||[];K(p),J(o)}async function Q(o){const s=(c.value[o]||await g(o)||[]).map(p=>p.text);K(s),J(o)}Z(()=>{C()});async function ie(){if(!O.value){d.value="請檢查表單輸入";return}d.value=null,I();try{const o=W.value.map(s=>({text:s,source:R.value.has(s)?"wordlist":"custom"})),t=await x({name:r.value.name.trim(),words:o,settings:r.value.settings});t.success&&t.room?u("created",t.room.code):(d.value=t.error||"創建房間失敗",console.error("創建房間失敗:",t.error))}catch(o){d.value=o instanceof Error?o.message:"創建房間時發生錯誤",console.error("創建房間異常:",o)}}return(o,t)=>(l(),a("div",Ue,[e("div",je,[e("div",Ge,[t[13]||(t[13]=e("h2",{class:"card-title text-hand-title"},"創建房間",-1)),e("form",{onSubmit:ee(ie,["prevent"])},[e("div",qe,[t[5]||(t[5]=e("label",null,"房間名稱",-1)),L(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>r.value.name=s),type:"text",placeholder:"輸入房間名稱",maxlength:"50",required:""},null,512),[[A,r.value.name]])]),e("div",ze,[t[6]||(t[6]=e("label",{class:"library-label"},"主題詞句庫",-1)),n(b)?(l(),a("div",Fe,"詞句庫載入中...")):(l(),a("div",Je,[(l(!0),a(X,null,Y(n(_),s=>(l(),a("div",{key:s.id,class:"word-card"},[e("div",Me,[e("div",null,[e("div",Ne,m(s.title),1),e("div",Be,m(s.description),1)]),e("span",De,m(s.entry_count)+" 條",1)]),e("div",Oe,[e("button",{type:"button",class:"paper-btn btn-secondary btn-small",onClick:p=>Q(s.id)}," 一鍵加入全部 ",8,Ie),e("button",{type:"button",class:"paper-btn btn-primary btn-small",onClick:p=>ae(s.id)},m(S.value===s.id?"收起預覽":"展開預覽"),9,Pe)]),S.value===s.id?(l(),a("div",Ke,[n(U)[s.id]?(l(),a("div",Qe,"詞條載入中...")):(l(),a("div",Xe,[(l(!0),a(X,null,Y(n(c)[s.id]||[],p=>(l(),a("div",{key:p.id,class:"entry-chip"},[e("label",Ye,[e("input",{type:"checkbox",checked:oe(s.id,p.id),onChange:H=>ne(s.id,p.id)},null,40,Ze),e("span",et,m(p.text),1),p.category?(l(),a("span",tt,m(p.category),1)):y("",!0)])]))),128)),e("div",st,[e("button",{type:"button",class:"paper-btn btn-primary btn-small",disabled:!P(s.id),onClick:p=>le(s.id)}," 加入已勾選 ",8,ot),e("button",{type:"button",class:"paper-btn btn-secondary btn-small",onClick:p=>Q(s.id)}," 全部加入 ",8,nt),P(s.id)?(l(),a("button",{key:0,type:"button",class:"paper-btn btn-link btn-small",onClick:p=>J(s.id)}," 清除勾選 ",8,at)):y("",!0)])]))])):y("",!0)]))),128))])),w.value?(l(),a("div",lt,m(w.value),1)):y("",!0),t[7]||(t[7]=e("div",{class:"text-small text-secondary margin-top-small"}," 勾選或一鍵加入後，詞條會自動寫入下方自定義詞語框，可自行刪改。 ",-1))]),e("div",it,[t[8]||(t[8]=e("label",null,"自定義詞語（至少 6 個，每個 1-32 字符，最多 600 字符）",-1)),L(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=s=>r.value.wordsText=s),rows:"6",placeholder:`輸入詞語，用逗號（，或,）或換行分隔
例如：春天，友誼，勇氣`,onInput:v},null,544),[[A,r.value.wordsText]]),e("div",rt," 已輸入 "+m(T.value)+" 個詞語，"+m(D.value)+" / 600 字符 ",1),T.value<6?(l(),a("div",dt," 還需要 "+m(6-T.value)+" 個詞語 ",1)):y("",!0)]),e("div",ut,[t[11]||(t[11]=e("h4",{class:"text-hand-title"},"遊戲設置",-1)),e("div",ct,[t[9]||(t[9]=e("label",null,"繪畫時間（秒）",-1)),L(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>r.value.settings.draw_time=s),type:"number",min:"60",max:"180",required:""},null,512),[[A,r.value.settings.draw_time,void 0,{number:!0}]])]),e("div",mt,[t[10]||(t[10]=e("label",null,"提示數量",-1)),L(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>r.value.settings.hints_count=s),type:"number",min:"0",max:"5",required:""},null,512),[[A,r.value.settings.hints_count,void 0,{number:!0}]])]),t[12]||(t[12]=e("div",{class:"alert alert-secondary margin-top-small"},[e("strong",null,"輪數說明："),te("遊戲開始時，輪數會自動設定為房間人數，確保每個人都有一次機會畫畫。 ")],-1))]),d.value?(l(),a("div",vt,m(d.value),1)):y("",!0),e("div",pt,[e("button",{type:"submit",disabled:n(k)||!O.value,class:"paper-btn btn-primary"},m(n(k)?"創建中...":"創建房間"),9,_t),e("button",{type:"button",onClick:t[4]||(t[4]=s=>o.$emit("cancel")),class:"paper-btn btn-secondary"}," 取消 ")])],32)])])]))}}),ht=z(bt,[["__scopeId","data-v-fa9cc0c8"]]),gt={class:"room-join"},ft={class:"card"},yt={class:"card-body"},wt={class:"form-group"},$t={class:"form-group"},kt={key:0,class:"alert alert-danger"},xt={class:"row flex-spaces margin-top-medium"},Ct=["disabled"],St=q({__name:"RoomJoin",emits:["cancel","joined"],setup(F,{emit:i}){const u=i,{joinRoom:x,loading:k}=B(),_=N(),c=$({code:"",nickname:_.profile?.display_name||""}),b=$(null);function U(r){const d=r.target;c.value.code=d.value.replace(/\D/g,"").slice(0,6),b.value=null}const C=E(()=>c.value.code.length===6&&c.value.nickname.trim().length>0&&c.value.nickname.length<=20);async function g(){if(!C.value){b.value="請檢查表單輸入";return}b.value=null;const r=await x(c.value.code,c.value.nickname.trim());r.success?u("joined"):b.value=r.error||"加入房間失敗"}return(r,d)=>(l(),a("div",gt,[e("div",ft,[e("div",yt,[d[6]||(d[6]=e("h2",{class:"card-title text-hand-title"},"加入房間",-1)),e("form",{onSubmit:ee(g,["prevent"])},[e("div",wt,[d[3]||(d[3]=e("label",null,"房間碼",-1)),L(e("input",{"onUpdate:modelValue":d[0]||(d[0]=w=>c.value.code=w),type:"text",class:"text-center",style:{"font-size":"2rem","letter-spacing":"0.5rem"},placeholder:"000000",maxlength:"6",pattern:"[0-9]{6}",required:"",onInput:U},null,544),[[A,c.value.code]]),d[4]||(d[4]=e("div",{class:"text-small"}," 輸入 6 位數字房間碼 ",-1))]),e("div",$t,[d[5]||(d[5]=e("label",null,"暱稱",-1)),L(e("input",{"onUpdate:modelValue":d[1]||(d[1]=w=>c.value.nickname=w),type:"text",placeholder:"輸入您的暱稱",maxlength:"20",required:""},null,512),[[A,c.value.nickname]])]),b.value?(l(),a("div",kt,m(b.value),1)):y("",!0),e("div",xt,[e("button",{type:"submit",disabled:n(k)||!C.value,class:"paper-btn btn-primary"},m(n(k)?"加入中...":"加入房間"),9,Ct),e("button",{type:"button",onClick:d[2]||(d[2]=w=>r.$emit("cancel")),class:"paper-btn btn-secondary"}," 取消 ")])],32)])])]))}}),Rt=z(St,[["__scopeId","data-v-35f98c69"]]),Vt={class:"container margin-top-large"},Wt={class:"row flex-center"},Ht={class:"col-12 col-md-8 col-lg-6"},Tt={class:"text-center margin-bottom-medium"},Et={class:"text-hand-title",style:{"font-size":"2.25rem","margin-bottom":"1rem",display:"flex","align-items":"center","justify-content":"center",gap:"0.5rem"}},Lt={class:"margin-bottom-medium"},At={key:0,class:"margin-bottom-medium"},Ut={key:1,class:"margin-bottom-medium"},jt={key:2},Gt={key:0,class:"margin-bottom-medium"},qt={key:1,class:"margin-bottom-medium"},zt={key:2,class:"home-actions"},Ft={key:0,class:"margin-top-small"},Jt={key:3,class:"home-actions"},Mt=q({__name:"HomeView",setup(F){const i=re(),{currentRoom:u,participants:x,leaveRoom:k,isHost:_}=B(),{subscribeRoom:c}=de(),b=N(),{isAdmin:U,refreshAdminStatus:C}=se(),g=$(!1),r=$(!1);function d(h){g.value=!1,u.value&&i.push(`/room/${u.value.code}`)}function w(){r.value=!1,u.value&&i.push(`/room/${u.value.code}`)}function S(){console.log("[HomeView] 收到遊戲開始事件"),u.value&&i.push(`/room/${u.value.code}`)}async function f(){(await k()).success&&(g.value=!1,r.value=!1)}M(()=>u.value,h=>{h&&b.user&&c(h.code,h.id,b.user.id,{nickname:b.profile?.display_name||"玩家"})},{immediate:!0}),M(()=>u.value?.status,async(h,v)=>{if(console.log("[HomeView] 房間狀態變化:",{oldStatus:v,newStatus:h,currentRoute:i.currentRoute.value.name,isHost:_.value}),u.value&&(h==="playing"||h==="finished")){const V=i.currentRoute.value;if(V.name!=="room"||V.params.code!==u.value.code){console.log("[HomeView] 準備跳轉到 RoomView:",u.value.code,"(isHost:",_.value,")");const W=`/room/${u.value.code}`;try{await i.push(W),console.log("[HomeView] 路由跳轉成功")}catch(T){console.error("[HomeView] 路由跳轉錯誤:",T)}}else console.log("[HomeView] 已在 RoomView，無需跳轉")}}),Z(()=>{b.profile?.email&&C(!0)}),M(()=>b.profile?.email,h=>{h&&C(!0)});function R(){i.push("/word-library")}return(h,v)=>(l(),a("div",Vt,[e("div",Wt,[e("div",Ht,[e("div",Tt,[e("h1",Et,[G(n(ue),{size:32,weight:"duotone",style:{color:"var(--color-primary)"}}),v[4]||(v[4]=te(" 你畫我猜 ",-1))])]),e("div",Lt,[G(Ae)]),n(u)&&n(u).status==="waiting"?(l(),a("div",At,[G(ce,{room:n(u),participants:n(x),onStartGame:S,onLeaveRoom:f},null,8,["room","participants"])])):n(u)&&(n(u).status==="playing"||n(u).status==="finished")?(l(),a("div",Ut,[...v[5]||(v[5]=[e("div",{class:"text-center"},[e("p",{class:"text-hand"},"正在跳轉到遊戲房間...")],-1)])])):(l(),a("div",jt,[g.value?(l(),a("div",Gt,[G(ht,{onCreated:d,onCancel:v[0]||(v[0]=()=>{console.log("取消創建房間"),g.value=!1})})])):r.value?(l(),a("div",qt,[G(Rt,{onJoined:w,onCancel:v[1]||(v[1]=V=>r.value=!1)})])):n(b).isRegistered?(l(),a("div",zt,[e("button",{onClick:v[2]||(v[2]=V=>g.value=!0),class:"paper-btn btn-primary btn-block margin-bottom-small"}," 創建房間 "),e("button",{onClick:v[3]||(v[3]=V=>r.value=!0),class:"paper-btn btn-secondary btn-block"}," 加入房間 "),n(U)?(l(),a("div",Ft,[e("button",{class:"paper-btn btn-warning btn-block",onClick:R}," 詞句庫管理（管理員） ")])):y("",!0)])):(l(),a("div",Jt,[...v[6]||(v[6]=[e("div",{class:"alert alert-info text-center"},[e("p",{class:"text-hand"},"請使用 Google 登入以創建或加入房間")],-1)])]))]))])])]))}}),Ot=z(Mt,[["__scopeId","data-v-365ba7d2"]]);export{Ot as default};
