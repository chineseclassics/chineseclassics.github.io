import{d as G,u as O,c as n,a as f,b as o,e,t as c,o as l,_ as q,r as w,f as T,g as Z,w as ee,h as A,v as H,F as X,i as Y,j as te,k as B,l as U,m as re}from"./index-Cgq7LTIg.js";import{u as D,a as de,I as ue,W as ce}from"./WaitingLobby-CIPicYG9.js";import{u as se}from"./useWordLibrary-C4uz0owF.js";const me={class:"user-auth"},ve={key:0},_e=["disabled"],pe={key:1},he={class:"user-info-card border margin-bottom-small"},be={class:"row flex-middle margin-bottom-small"},fe={class:"col-8"},ge={class:"row flex-middle"},ye={class:"col-auto"},$e=["src","alt"],ke={key:1,class:"user-avatar border user-avatar-placeholder"},we={class:"col"},xe={class:"text-hand user-name"},Ce={class:"text-small user-status"},Se={class:"col-4 text-right"},Re=["disabled"],Ve={key:0,class:"user-stats-inline"},We={class:"stats-row"},Te={class:"stat-item"},Ae={class:"stat-value"},He={key:2,class:"alert alert-danger margin-top-small"},Le=G({__name:"UserAuth",setup(F){const i=O();async function m(){const b=await i.signInWithGoogle();b&&!b.success&&console.error("Google 登入失敗:",b.error)}async function C(){const b=await i.signOut();b.success||console.error("登出失敗:",b.error)}function x(b){return b.toLocaleString("zh-TW")}return(b,_)=>(l(),n("div",me,[o(i).isAuthenticated?(l(),n("div",pe,[e("div",he,[e("div",be,[e("div",fe,[e("div",ge,[e("div",ye,[o(i).profile?.avatar_url?(l(),n("img",{key:0,src:o(i).profile.avatar_url,alt:o(i).profile.display_name,class:"user-avatar border"},null,8,$e)):(l(),n("div",ke,c(o(i).profile?.display_name?.charAt(0)||"?"),1))]),e("div",we,[e("div",xe,c(o(i).profile?.display_name||"用戶"),1),e("div",Ce,c(o(i).isAnonymous?"匿名遊玩":"已登入"),1)])])]),e("div",Se,[e("button",{onClick:C,disabled:o(i).loading,class:"paper-btn btn-small"},c(o(i).loading?"處理中...":"登出"),9,Re)])]),o(i).isRegistered&&o(i).profile?(l(),n("div",Ve,[e("div",We,[e("div",Te,[_[0]||(_[0]=e("span",{class:"stat-label"},"總積分",-1)),e("span",Ae,c(x(o(i).profile.total_score||0)),1)])]),_[1]||(_[1]=e("div",{class:"gamification-placeholder margin-top-small"},null,-1))])):f("",!0)])])):(l(),n("div",ve,[f("",!0),e("button",{onClick:m,disabled:o(i).loading,class:"paper-btn btn-primary btn-block"},c(o(i).loading?"處理中...":"Google 登入"),9,_e)])),o(i).error?(l(),n("div",He,c(o(i).error),1)):f("",!0)]))}}),Ee=q(Le,[["__scopeId","data-v-7ac95212"]]),Ue={class:"room-create"},je={class:"card"},ze={class:"card-body"},Ge={class:"form-group"},qe={class:"form-group"},Fe={key:0,class:"text-small text-secondary"},Ne={key:1,class:"word-library-grid"},Je={class:"word-card-header"},Me={class:"word-title"},Be={class:"word-desc"},Oe={class:"badge badge-warning"},De={class:"word-card-actions"},Ie=["onClick"],Pe=["onClick"],Ke={key:0,class:"word-entry-list"},Qe={key:0,class:"text-small text-secondary"},Xe={key:1},Ye={class:"checkbox"},Ze=["checked","onChange"],et={class:"entry-text"},tt={key:0,class:"entry-tag"},st={class:"entry-actions"},ot=["disabled","onClick"],at=["onClick"],nt=["onClick"],lt={key:2,class:"text-small info-hint"},it={class:"form-group"},rt={class:"text-small"},dt={key:0,class:"text-small",style:{color:"#e8590c"}},ut={class:"margin-top-medium"},ct={class:"form-group"},mt={class:"form-group"},vt={key:0,class:"alert alert-danger margin-top-small"},_t={class:"row flex-spaces margin-top-medium"},pt=["disabled"],ht=G({__name:"RoomCreate",emits:["cancel","created"],setup(F,{emit:i}){const m=i,{createRoom:C,loading:x}=D(),{collections:b,entriesMap:_,loadingCollections:r,loadingEntries:L,loadCollections:S,loadEntries:g}=se(),d=w({name:"",wordsText:"",settings:{draw_time:60,rounds:0,word_count_per_round:1,hints_count:2}}),u=w(null),$=w(null),R=w(null),y=w({}),V=w(new Set);function N(a){return a.split(/[，,\n]/).map(t=>t.trim()).filter(t=>t.length>0)}function J(){u.value=null}const p=T(()=>N(d.value.wordsText)),v=T(()=>{const a=new Set,t=[];for(const s of p.value)a.has(s)||(a.add(s),t.push(s));return t}),k=T(()=>v.value.length),j=T(()=>d.value.wordsText.length),z=T(()=>d.value.name.trim().length>0&&d.value.name.length<=50&&k.value>=6&&j.value<=600&&v.value.every(a=>a.length>=1&&a.length<=32));function I(){const a=new Set(v.value);V.value=new Set([...V.value].filter(t=>a.has(t)))}function oe(a,t){return y.value[a]?.has(t)??!1}function ae(a,t){const s=y.value[a]||new Set;s.has(t)?s.delete(t):s.add(t),y.value={...y.value,[a]:s}}function P(a){return(y.value[a]?.size||0)>0}function M(a){if(y.value[a]){const t={...y.value};delete t[a],y.value=t}}function K(a){const t=a.map(E=>E.trim()).filter(Boolean),s=v.value,h=new Set(s),W=[...s];t.forEach(E=>{h.has(E)||(h.add(E),W.push(E))}),d.value.wordsText=W.join(`
`),V.value=new Set([...V.value,...t]),I(),$.value=`已加入 ${t.length} 個詞條`}async function ne(a){if(R.value===a){R.value=null;return}R.value=a,await g(a)}async function le(a){const t=_.value[a]||await g(a),s=y.value[a];if(!s||s.size===0)return;const h=t?.filter(W=>s.has(W.id)).map(W=>W.text)||[];K(h),M(a)}async function Q(a){const s=(_.value[a]||await g(a)||[]).map(h=>h.text);K(s),M(a)}Z(()=>{S()});async function ie(){if(!z.value){u.value="請檢查表單輸入";return}u.value=null,I();try{const a=v.value.map(s=>({text:s,source:V.value.has(s)?"wordlist":"custom"})),t=await C({name:d.value.name.trim(),words:a,settings:d.value.settings});t.success&&t.room?m("created",t.room.code):(u.value=t.error||"創建房間失敗",console.error("創建房間失敗:",t.error))}catch(a){u.value=a instanceof Error?a.message:"創建房間時發生錯誤",console.error("創建房間異常:",a)}}return(a,t)=>(l(),n("div",Ue,[e("div",je,[e("div",ze,[t[13]||(t[13]=e("h2",{class:"card-title text-hand-title"},"創建房間",-1)),e("form",{onSubmit:ee(ie,["prevent"])},[e("div",Ge,[t[5]||(t[5]=e("label",null,"房間主題",-1)),A(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>d.value.name=s),type:"text",placeholder:"輸入房間主題（例如：古代作家、紅樓夢等）",maxlength:"50",required:""},null,512),[[H,d.value.name]])]),e("div",qe,[t[6]||(t[6]=e("label",{class:"library-label"},"主題詞句庫",-1)),o(r)?(l(),n("div",Fe,"詞句庫載入中...")):(l(),n("div",Ne,[(l(!0),n(X,null,Y(o(b),s=>(l(),n("div",{key:s.id,class:"word-card"},[e("div",Je,[e("div",null,[e("div",Me,c(s.title),1),e("div",Be,c(s.description),1)]),e("span",Oe,c(s.entry_count)+" 條",1)]),e("div",De,[e("button",{type:"button",class:"paper-btn btn-secondary btn-small",onClick:h=>Q(s.id)}," 一鍵加入全部 ",8,Ie),e("button",{type:"button",class:"paper-btn btn-primary btn-small",onClick:h=>ne(s.id)},c(R.value===s.id?"收起預覽":"展開預覽"),9,Pe)]),R.value===s.id?(l(),n("div",Ke,[o(L)[s.id]?(l(),n("div",Qe,"詞條載入中...")):(l(),n("div",Xe,[(l(!0),n(X,null,Y(o(_)[s.id]||[],h=>(l(),n("div",{key:h.id,class:"entry-chip"},[e("label",Ye,[e("input",{type:"checkbox",checked:oe(s.id,h.id),onChange:W=>ae(s.id,h.id)},null,40,Ze),e("span",et,c(h.text),1),h.category?(l(),n("span",tt,c(h.category),1)):f("",!0)])]))),128)),e("div",st,[e("button",{type:"button",class:"paper-btn btn-primary btn-small",disabled:!P(s.id),onClick:h=>le(s.id)}," 加入已勾選 ",8,ot),e("button",{type:"button",class:"paper-btn btn-secondary btn-small",onClick:h=>Q(s.id)}," 全部加入 ",8,at),P(s.id)?(l(),n("button",{key:0,type:"button",class:"paper-btn btn-link btn-small",onClick:h=>M(s.id)}," 清除勾選 ",8,nt)):f("",!0)])]))])):f("",!0)]))),128))])),$.value?(l(),n("div",lt,c($.value),1)):f("",!0),t[7]||(t[7]=e("div",{class:"text-small text-secondary margin-top-small"}," 勾選或一鍵加入後，詞條會自動寫入下方自定義詞語框，可自行刪改。 ",-1))]),e("div",it,[t[8]||(t[8]=e("label",null,"自定義詞語（至少 6 個，每個 1-32 字符，最多 600 字符）",-1)),A(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=s=>d.value.wordsText=s),rows:"6",placeholder:`輸入詞語，用逗號（，或,）或換行分隔
例如：春天，友誼，勇氣`,onInput:J},null,544),[[H,d.value.wordsText]]),e("div",rt," 已輸入 "+c(k.value)+" 個詞語，"+c(j.value)+" / 600 字符 ",1),k.value<6?(l(),n("div",dt," 還需要 "+c(6-k.value)+" 個詞語 ",1)):f("",!0)]),e("div",ut,[t[11]||(t[11]=e("h4",{class:"text-hand-title"},"遊戲設置",-1)),e("div",ct,[t[9]||(t[9]=e("label",null,"繪畫時間（秒）",-1)),A(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>d.value.settings.draw_time=s),type:"number",min:"60",max:"180",required:""},null,512),[[H,d.value.settings.draw_time,void 0,{number:!0}]])]),e("div",mt,[t[10]||(t[10]=e("label",null,"提示數量",-1)),A(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>d.value.settings.hints_count=s),type:"number",min:"0",max:"5",required:""},null,512),[[H,d.value.settings.hints_count,void 0,{number:!0}]])]),t[12]||(t[12]=e("div",{class:"alert alert-secondary margin-top-small"},[e("strong",null,"輪數說明："),te("遊戲開始時，輪數會自動設定為房間人數，確保每個人都有一次機會畫畫。 ")],-1))]),u.value?(l(),n("div",vt,c(u.value),1)):f("",!0),e("div",_t,[e("button",{type:"submit",disabled:o(x)||!z.value,class:"paper-btn btn-primary"},c(o(x)?"創建中...":"創建房間"),9,pt),e("button",{type:"button",onClick:t[4]||(t[4]=s=>a.$emit("cancel")),class:"paper-btn btn-secondary"}," 取消 ")])],32)])])]))}}),bt=q(ht,[["__scopeId","data-v-83960cb7"]]),ft={class:"room-join"},gt={class:"card"},yt={class:"card-body"},$t={class:"form-group"},kt={class:"form-group"},wt={key:0,class:"alert alert-danger"},xt={class:"row flex-spaces margin-top-medium"},Ct=["disabled"],St=G({__name:"RoomJoin",emits:["cancel","joined"],setup(F,{emit:i}){const m=i,{joinRoom:C,loading:x}=D(),b=O(),_=w({code:"",nickname:b.profile?.display_name||""}),r=w(null);function L(d){const u=d.target;_.value.code=u.value.replace(/\D/g,"").slice(0,6),r.value=null}const S=T(()=>_.value.code.length===6&&_.value.nickname.trim().length>0&&_.value.nickname.length<=20);async function g(){if(!S.value){r.value="請檢查表單輸入";return}r.value=null;const d=await C(_.value.code,_.value.nickname.trim());d.success?m("joined"):r.value=d.error||"加入房間失敗"}return(d,u)=>(l(),n("div",ft,[e("div",gt,[e("div",yt,[u[6]||(u[6]=e("h2",{class:"card-title text-hand-title"},"加入房間",-1)),e("form",{onSubmit:ee(g,["prevent"])},[e("div",$t,[u[3]||(u[3]=e("label",null,"房間碼",-1)),A(e("input",{"onUpdate:modelValue":u[0]||(u[0]=$=>_.value.code=$),type:"text",class:"text-center",style:{"font-size":"2rem","letter-spacing":"0.5rem"},placeholder:"000000",maxlength:"6",pattern:"[0-9]{6}",required:"",onInput:L},null,544),[[H,_.value.code]]),u[4]||(u[4]=e("div",{class:"text-small"}," 輸入 6 位數字房間碼 ",-1))]),e("div",kt,[u[5]||(u[5]=e("label",null,"暱稱",-1)),A(e("input",{"onUpdate:modelValue":u[1]||(u[1]=$=>_.value.nickname=$),type:"text",placeholder:"輸入您的暱稱",maxlength:"20",required:""},null,512),[[H,_.value.nickname]])]),r.value?(l(),n("div",wt,c(r.value),1)):f("",!0),e("div",xt,[e("button",{type:"submit",disabled:o(x)||!S.value,class:"paper-btn btn-primary"},c(o(x)?"加入中...":"加入房間"),9,Ct),e("button",{type:"button",onClick:u[2]||(u[2]=$=>d.$emit("cancel")),class:"paper-btn btn-secondary"}," 取消 ")])],32)])])]))}}),Rt=q(St,[["__scopeId","data-v-35f98c69"]]),Vt={class:"container margin-top-large"},Wt={class:"row flex-center"},Tt={class:"col-12 col-lg-10"},At={class:"text-center margin-bottom-large"},Ht={class:"text-hand-title",style:{"font-size":"2.25rem","margin-bottom":"1rem",display:"flex","align-items":"center","justify-content":"center",gap:"0.5rem"}},Lt={key:0,class:"home-main-layout"},Et={class:"home-auth-section"},Ut={key:1,class:"margin-bottom-medium"},jt={key:2,class:"margin-bottom-medium"},zt={key:3},Gt={key:0,class:"margin-bottom-medium"},qt={key:1,class:"margin-bottom-medium"},Ft={key:2,class:"home-main-layout"},Nt={class:"home-user-section"},Jt={class:"user-info-card"},Mt={class:"user-header"},Bt=["src","alt"],Ot={key:1,class:"user-avatar user-avatar-placeholder"},Dt={class:"user-details"},It={class:"user-name"},Pt={class:"user-status"},Kt={key:0,class:"user-stats"},Qt={class:"stat-item"},Xt={class:"stat-value"},Yt={class:"user-actions"},Zt=["disabled"],es={class:"home-actions-section"},ts={class:"actions-card"},ss={class:"actions-buttons"},os={key:3,class:"home-main-layout"},as=G({__name:"HomeView",setup(F){const i=re(),{currentRoom:m,participants:C,leaveRoom:x,isHost:b}=D(),{subscribeRoom:_}=de(),r=O(),{isAdmin:L,refreshAdminStatus:S}=se(),g=w(!1),d=w(!1);function u(p){g.value=!1,m.value&&i.push(`/room/${m.value.code}`)}function $(){d.value=!1,m.value&&i.push(`/room/${m.value.code}`)}function R(){console.log("[HomeView] 收到遊戲開始事件"),m.value&&i.push(`/room/${m.value.code}`)}async function y(){(await x()).success&&(g.value=!1,d.value=!1)}B(()=>m.value,p=>{p&&r.user&&_(p.code,p.id,r.user.id,{nickname:r.profile?.display_name||"玩家"})},{immediate:!0}),B(()=>m.value?.status,async(p,v)=>{if(console.log("[HomeView] 房間狀態變化:",{oldStatus:v,newStatus:p,currentRoute:i.currentRoute.value.name,isHost:b.value}),m.value&&(p==="playing"||p==="finished")){const k=i.currentRoute.value;if(k.name!=="room"||k.params.code!==m.value.code){console.log("[HomeView] 準備跳轉到 RoomView:",m.value.code,"(isHost:",b.value,")");const j=`/room/${m.value.code}`;try{await i.push(j),console.log("[HomeView] 路由跳轉成功")}catch(z){console.error("[HomeView] 路由跳轉錯誤:",z)}}else console.log("[HomeView] 已在 RoomView，無需跳轉")}}),Z(()=>{r.profile?.email&&S(!0)}),B(()=>r.profile?.email,p=>{p&&S(!0)});function V(){i.push("/word-library")}async function N(){const p=await r.signOut();p.success||console.error("登出失敗:",p.error)}function J(p){return p.toLocaleString("zh-TW")}return(p,v)=>(l(),n("div",Vt,[e("div",Wt,[e("div",Tt,[e("div",At,[e("h1",Ht,[U(o(ue),{size:32,weight:"duotone",style:{color:"var(--color-primary)"}}),v[4]||(v[4]=te(" 你畫我猜 ",-1))])]),o(r).isAuthenticated?f("",!0):(l(),n("div",Lt,[e("div",Et,[U(Ee)])])),o(m)&&o(m).status==="waiting"?(l(),n("div",Ut,[U(ce,{room:o(m),participants:o(C),onStartGame:R,onLeaveRoom:y},null,8,["room","participants"])])):o(m)&&(o(m).status==="playing"||o(m).status==="finished")?(l(),n("div",jt,[...v[5]||(v[5]=[e("div",{class:"text-center"},[e("p",{class:"text-hand"},"正在跳轉到遊戲房間...")],-1)])])):(l(),n("div",zt,[g.value?(l(),n("div",Gt,[U(bt,{onCreated:u,onCancel:v[0]||(v[0]=()=>{console.log("取消創建房間"),g.value=!1})})])):d.value?(l(),n("div",qt,[U(Rt,{onJoined:$,onCancel:v[1]||(v[1]=k=>d.value=!1)})])):o(r).isRegistered?(l(),n("div",Ft,[e("div",Nt,[e("div",Jt,[e("div",Mt,[o(r).profile?.avatar_url?(l(),n("img",{key:0,src:o(r).profile.avatar_url,alt:o(r).profile.display_name,class:"user-avatar"},null,8,Bt)):(l(),n("div",Ot,c(o(r).profile?.display_name?.charAt(0)||"?"),1)),e("div",Dt,[e("div",It,c(o(r).profile?.display_name||"用戶"),1),e("div",Pt,c(o(r).isAnonymous?"匿名遊玩":"已登入"),1)])]),o(r).isRegistered&&o(r).profile?(l(),n("div",Kt,[e("div",Qt,[v[6]||(v[6]=e("span",{class:"stat-label"},"總積分",-1)),e("span",Xt,c(J(o(r).profile.total_score||0)),1)])])):f("",!0),e("div",Yt,[e("button",{onClick:N,disabled:o(r).loading,class:"paper-btn btn-small btn-block"},c(o(r).loading?"處理中...":"登出"),9,Zt)])])]),e("div",es,[e("div",ts,[e("div",ss,[e("button",{onClick:v[2]||(v[2]=k=>g.value=!0),class:"paper-btn btn-primary btn-block margin-bottom-small"}," 創建房間 "),e("button",{onClick:v[3]||(v[3]=k=>d.value=!0),class:"paper-btn btn-secondary btn-block margin-bottom-small"}," 加入房間 "),o(L)?(l(),n("button",{key:0,class:"paper-btn btn-warning btn-block",onClick:V}," 詞句庫管理 ")):f("",!0)])])])])):(l(),n("div",os,[...v[7]||(v[7]=[e("div",{class:"home-auth-section"},[e("div",{class:"alert alert-info text-center"},[e("p",{class:"text-hand"},"請使用 Google 登入以創建或加入房間")])],-1)])]))]))])])]))}}),rs=q(as,[["__scopeId","data-v-d1066e42"]]);export{rs as default};
