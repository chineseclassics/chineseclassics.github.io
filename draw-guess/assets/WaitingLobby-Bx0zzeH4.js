import{l as ge,r as M,f as R,u as Q,x as y,m as he,d as _e,c as L,e as T,a as ne,t as H,s as ce,F as pe,p as Re,b as P,o as K,_ as ye}from"./index-DwjqItcE.js";const Z=ge("room",()=>{const r=M(null),v=M([]),a=M(!1),u=M(null),h=R(()=>{const o=Q();return r.value?.host_id===o.user?.id});async function k(o){try{a.value=!0,u.value=null;const e=Q();if(!e.user)throw new Error("請先登入");if(!e.profile&&e.user)try{await e.loadUserProfile(e.user.id,!1)}catch(w){console.warn("載入用戶資料時發生錯誤（非關鍵）:",w)}if(o.words.length<6)throw new Error("至少需要 6 個詞語");if(o.settings.rounds>o.words.length)throw new Error("輪數不能超過詞語總數");let t=null,n=0;const g=10;for(;n<g&&!t;){n++;const p={code:Math.floor(1e5+Math.random()*9e5).toString(),name:o.name,host_id:e.user.id,words:o.words,word_count:o.words.length,status:"waiting",settings:o.settings,current_round:0,current_drawer_id:null},{data:O,error:d}=await y.from("game_rooms").insert(p).select().single();if(d){if(d.code==="23505")continue;throw new Error(d.message||"插入房間失敗")}if(O){t=O;break}}if(!t)throw new Error("無法生成唯一房間碼，請重試");const l={room_id:t.id,user_id:e.user.id,nickname:e.profile?.display_name||"房主",score:0};try{const{error:w}=await y.from("room_participants").insert(l);w&&console.error("創建參與記錄錯誤:",w)}catch(w){console.error("創建參與記錄時發生錯誤:",w)}try{const{data:w,error:p}=await y.from("room_participants").select("*").eq("room_id",t.id).order("joined_at",{ascending:!0});p?console.error("載入參與者列表失敗:",p):w&&(v.value=w)}catch(w){console.error("載入參與者列表時發生錯誤:",w)}return r.value=t,{success:!0,room:t}}catch(e){return u.value=e instanceof Error?e.message:"創建房間失敗",console.error("創建房間錯誤:",e),{success:!1,error:u.value}}finally{a.value=!1}}async function q(o,e){try{a.value=!0,u.value=null;const t=Q();if(!t.user)throw new Error("請先登入");if(!/^\d{6}$/.test(o))throw new Error("房間碼必須是 6 位數字");if(!e||e.trim().length===0)throw new Error("請輸入暱稱");if(e.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:n,error:g}=await y.from("game_rooms").select("*").eq("code",o).single();if(g||!n)throw new Error("房間不存在");if(n.status!=="waiting")throw new Error("房間已開始或已結束");const{data:l}=await y.from("room_participants").select("*").eq("room_id",n.id).eq("user_id",t.user.id).maybeSingle();if(l)return r.value=n,await b(n.id),{success:!0,room:n};const{error:w}=await y.from("room_participants").insert({room_id:n.id,user_id:t.user.id,nickname:e.trim(),score:0});if(w){if(w.code==="23505"||w.message.includes("duplicate"))return r.value=n,await b(n.id),{success:!0,room:n};throw w}return r.value=n,await b(n.id),{success:!0,room:n}}catch(t){return u.value=t instanceof Error?t.message:"加入房間失敗",console.error("加入房間錯誤:",t),{success:!1,error:u.value}}finally{a.value=!1}}async function I(){try{if(!r.value)return{success:!0};a.value=!0,u.value=null;const o=Q();if(!o.user)throw new Error("請先登入");const{error:e}=await y.from("room_participants").delete().eq("room_id",r.value.id).eq("user_id",o.user.id);if(e)throw new Error(`刪除參與記錄失敗: ${e.message||"未知錯誤"}`);if(h.value){const{error:t}=await y.from("game_rooms").update({status:"finished"}).eq("id",r.value.id);t&&console.error("關閉房間失敗:",t)}return r.value=null,v.value=[],{success:!0}}catch(o){return u.value=o instanceof Error?o.message:"離開房間失敗",console.error("離開房間錯誤:",o),r.value=null,v.value=[],{success:!1,error:u.value}}finally{a.value=!1}}async function b(o){try{const{data:e,error:t}=await y.from("room_participants").select("*").eq("room_id",o).order("joined_at",{ascending:!0});if(t)throw t;v.value=e||[]}catch(e){console.error("載入參與者錯誤:",e)}}async function f(o){try{a.value=!0,u.value=null;const{data:e,error:t}=await y.from("game_rooms").select("*").eq("id",o).single();if(t)throw t;return r.value=e,await b(o),{success:!0,room:e}}catch(e){return u.value=e instanceof Error?e.message:"載入房間失敗",console.error("載入房間錯誤:",e),{success:!1,error:u.value}}finally{a.value=!1}}async function m(o){try{if(!r.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:r.value.id,oldStatus:r.value.status,newStatus:o});const{error:e}=await y.from("game_rooms").update({status:o}).eq("id",r.value.id);if(e)throw e;if(r.value){const t=r.value.status;r.value.status=o,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:t,newStatus:r.value.status})}return{success:!0}}catch(e){return u.value=e instanceof Error?e.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",e),{success:!1,error:u.value}}}async function _(o){try{if(!r.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:r.value.id,drawerId:o});const{error:e}=await y.from("game_rooms").update({current_drawer_id:o}).eq("id",r.value.id);if(e)throw e;return r.value&&(r.value.current_drawer_id=o,console.log("[RoomStore] 當前畫家已更新:",o)),{success:!0}}catch(e){return u.value=e instanceof Error?e.message:"更新畫家失敗",console.error("更新畫家錯誤:",e),{success:!1,error:u.value}}}function N(){r.value=null,v.value=[],u.value=null}function U(o){r.value&&(r.value.current_drawer_id=o,console.log("[RoomStore] 本地更新當前畫家:",o))}async function E(o){try{if(!r.value)return{success:!1,error:"沒有當前房間"};if(!h.value)return{success:!1,error:"只有房主可以踢人"};const e=Q();if(o===e.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,u.value=null;const{data:t,error:n}=await y.rpc("kick_player",{p_room_id:r.value.id,p_target_user_id:o});if(n)throw new Error(n.message);if(t&&!t.success)throw new Error(t.error||"踢出玩家失敗");return await b(r.value.id),{success:!0}}catch(e){return u.value=e instanceof Error?e.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",e),{success:!1,error:u.value}}finally{a.value=!1}}return{currentRoom:r,participants:v,loading:a,error:u,isHost:h,createRoom:k,joinRoom:q,leaveRoom:I,kickPlayer:E,loadParticipants:b,loadRoom:f,updateRoomStatus:m,updateRoomDrawer:_,setCurrentDrawer:U,clearRoom:N}});function Se(){const r=Z(),v=R(()=>r.currentRoom),a=R(()=>r.participants),u=R(()=>r.isHost),h=R(()=>!v.value||v.value.status!=="waiting"||!u.value?!1:a.value.length>=2);async function k(b){return await r.createRoom(b)}async function q(b,f){return await r.joinRoom(b,f)}async function I(){return await r.leaveRoom()}return{currentRoom:v,participants:a,isHost:u,canStartGame:h,loading:R(()=>r.loading),error:R(()=>r.error),createRoom:k,joinRoom:q,leaveRoom:I}}const ue=100,ie=50,le=10,be=10,de=100,fe=[1,.8,.6,.4,.2];function Ee(){const r=Z();function v(f){const m=Math.min(f,fe.length-1),_=fe[m]??0;return Math.round(ue*_)}function a(f,m=0){if(f===0)return 0;const _=f*le,N=Math.round(m*be);return ie+_+N}async function u(f,m,_=0){const N=a(m,_);return N===0?!0:await h(f,N)}async function h(f,m){if(!r.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:_,error:N}=await y.from("room_participants").select("score").eq("room_id",r.currentRoom.id).eq("user_id",f).single();if(N)throw N;const U=(_?.score||0)+m,{error:E}=await y.from("room_participants").update({score:U}).eq("room_id",r.currentRoom.id).eq("user_id",f);if(E)throw E;const o=r.participants.findIndex(e=>e.user_id===f);return o!==-1&&r.participants[o]&&(r.participants[o].score=U),!0}catch(_){return console.error("更新玩家分數錯誤:",_),!1}}function k(){if(!r.participants||r.participants.length===0)return null;const f=[...r.participants].sort((m,_)=>_.score-m.score);return f.length===1||f[0]&&f[1]&&f[0].score>f[1].score?{user_id:f[0]?.user_id||"",score:f[0]?.score||0}:{user_id:f[0]?.user_id||"",score:f[0]?.score||0}}const q=R(()=>!r.participants||r.participants.length===0?[]:[...r.participants].sort((m,_)=>_.score!==m.score?_.score-m.score:new Date(m.joined_at).getTime()-new Date(_.joined_at).getTime()).map((m,_)=>({id:m.id,user_id:m.user_id,score:m.score,rank:_+1}))),I=R(()=>r.currentRoom?.status!=="finished"?null:k());function b(){return de}return{GUESS_BASE_SCORE:ue,DRAWING_BASE_SCORE:ie,DRAWING_BONUS_PER_GUESS:le,WINNER_BONUS:de,calculateGuessScore:v,calculateDrawingScore:a,calculateWinner:k,updatePlayerScore:h,updateDrawerScore:u,playerRankings:q,winner:I,getWinnerBonus:b}}const we=ge("game",()=>{const r=Z(),v=Q(),a=M(null),u=M(null),h=M([]),k=R(()=>h.value.filter(i=>i.is_correct)),q=R(()=>a.value?h.value.filter(i=>i.round_id===a.value.id):[]),I=R(()=>q.value.filter(i=>i.is_correct)),b=M("drawing"),f=M([]),m=M([]),_=R(()=>m.value.length===0?0:m.value.reduce((s,S)=>s+S.rating,0)/m.value.length);function N(i){b.value=i}function U(i){f.value=i}function E(i){const s=m.value.findIndex(S=>S.rater_id===i.rater_id);s>=0?m.value[s]=i:m.value.push(i)}function o(){m.value=[]}async function e(i){try{const{data:s,error:S}=await y.from("game_rounds").select("*").eq("room_id",i).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(S)throw S;return s&&(a.value=s,u.value=s.word_text,s.word_options&&Array.isArray(s.word_options)&&(f.value=s.word_options),await t(s.id)),{success:!0,round:s}}catch(s){return console.error("載入當前輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入輪次失敗"}}}async function t(i){try{const{data:s,error:S}=await y.from("guesses").select("*").eq("round_id",i).order("guessed_at",{ascending:!0});if(S)throw S;const D=s||[],c=new Set(h.value.map(x=>x.id)),G=D.filter(x=>!c.has(x.id));G.length>0&&(h.value=[...h.value,...G])}catch(s){console.error("載入猜測記錄錯誤:",s)}}async function n(i){try{const{data:s,error:S}=await y.from("game_rounds").select("id").eq("room_id",i);if(S)throw S;if(!s||s.length===0){h.value=[];return}const D=s.map(x=>x.id),{data:c,error:G}=await y.from("guesses").select("*").in("round_id",D).order("guessed_at",{ascending:!0});if(G)throw G;h.value=c||[]}catch(s){console.error("載入所有猜測記錄錯誤:",s)}}async function g(i,s,S,D){try{if(!r.currentRoom)throw new Error("沒有當前房間");const c=(r.currentRoom.current_round||0)+1,{data:G,error:x}=await y.from("game_rounds").insert({room_id:i,round_number:c,drawer_id:s,word_text:S,word_source:D}).select().single();if(x)throw x;return a.value=G,u.value=S,await y.from("game_rooms").update({current_round:c,current_drawer_id:s}).eq("id",i),{success:!0,round:G}}catch(c){return console.error("創建輪次錯誤:",c),{success:!1,error:c instanceof Error?c.message:"創建輪次失敗"}}}function l(i){return a.value?h.value.some(s=>s.round_id===a.value.id&&s.user_id===i&&s.is_correct):!1}const w=R(()=>!a.value||!v.user?!1:a.value.drawer_id===v.user.id);async function p(){if(!a.value||!r.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const i=k.value.length,s=_.value,{updateDrawerScore:S}=Ee();console.log("[endRound] 猜中人數:",i,"平均評分:",s),await S(a.value.drawer_id,i,s);const{error:D}=await y.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(D)throw D;return{success:!0}}catch(i){return console.error("結束輪次錯誤:",i),{success:!1,error:i instanceof Error?i.message:"結束輪次失敗"}}}function O(){a.value=null,u.value=null,h.value=[],b.value="drawing",f.value=[],m.value=[]}async function d(i,s,S){if(!v.user)return{success:!1,error:"用戶未登錄"};try{const{data:D,error:c}=await y.from("drawing_ratings").upsert({round_id:i,rater_id:v.user.id,drawer_id:s,rating:S},{onConflict:"round_id,rater_id"}).select().single();if(c)throw c;return D&&E(D),{success:!0,rating:D}}catch(D){return console.error("提交評分錯誤:",D),{success:!1,error:D instanceof Error?D.message:"提交評分失敗"}}}async function A(i){try{const{data:s,error:S}=await y.from("drawing_ratings").select("*").eq("round_id",i);if(S)throw S;return m.value=s||[],{success:!0,ratings:s}}catch(s){return console.error("載入評分錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入評分失敗"}}}return{currentRound:a,currentWord:u,guesses:h,correctGuesses:k,currentRoundGuesses:q,currentRoundCorrectGuesses:I,isCurrentDrawer:w,roundStatus:b,wordOptions:f,ratings:m,averageRating:_,loadCurrentRound:e,loadGuesses:t,loadAllGuesses:n,createRound:g,hasGuessed:l,endRound:p,clearGame:O,setRoundStatus:N,setWordOptions:U,addRating:E,clearRatings:o,submitRating:d,loadRatings:A}}),j=new Map,W=M("disconnected"),F=new Map,ee=new Set,re=new Map;function $(...r){}function B(...r){console.warn("[Realtime]",...r)}function oe(){const r=Z(),v=we();function a(e){const t=`room:${e}`;if(j.has(t))return j.get(t);const n=y.channel(t,{config:{presence:{key:"user"},broadcast:{self:!0}}});return j.set(t,n),n}function u(e){const t=re.get(e);t&&(clearTimeout(t),re.delete(e))}function h(e,t,n,g,l){e==="SUBSCRIBED"?(W.value="connected",u(n),t.track({user_id:g,...l}).catch(w=>{B("Presence track 失敗:",w)})):e==="CHANNEL_ERROR"||e==="TIMED_OUT"?(W.value="disconnected",B("訂閱失敗:",e),k(n,g,l)):e==="CLOSED"&&(W.value="disconnected")}function k(e,t,n,g=0){if(g>=3){B("重連失敗次數過多，停止重連");return}u(e);const l=Math.min(1e3*Math.pow(2,g),1e4),w=window.setTimeout(()=>{const p=j.get(`room:${e}`);p&&p.state!=="joined"&&p.subscribe(O=>{O==="SUBSCRIBED"?h(O,p,e,t,n):(O==="CHANNEL_ERROR"||O==="TIMED_OUT")&&k(e,t,n,g+1)})},l);re.set(e,w)}function q(e,t,n,g){return new Promise((l,w)=>{if(!e||!t){B("缺少 roomCode 或 roomId"),w(new Error("缺少 roomCode 或 roomId"));return}const p=a(e),O=p.state;if(O==="joined"){W.value="connected",l(p);return}if(O==="joining"){const d=setInterval(()=>{const A=p.state;A==="joined"?(clearInterval(d),l(p)):(A==="closed"||A==="errored")&&(clearInterval(d),w(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(d),p.state!=="joined"&&w(new Error("連接超時"))},5e3);return}if(ee.has(e)){W.value="connecting",p.subscribe(d=>{h(d,p,e,n,g),d==="SUBSCRIBED"?l(p):(d==="CHANNEL_ERROR"||d==="TIMED_OUT")&&w(new Error(`訂閱失敗: ${d}`))});return}p.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async d=>{$("房間狀態變化:",d.eventType),r.currentRoom&&await r.loadRoom(r.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async d=>{$("參與者變化:",d.eventType),await r.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async d=>{$("輪次變化:",d.eventType,d.new),r.currentRoom&&await v.loadCurrentRound(r.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async d=>{const A=d.new;A&&v.currentRound&&await v.loadGuesses(A.round_id)}).on("broadcast",{event:"drawing"},d=>{const A=F.get(e);A&&d.payload?.stroke&&A.forEach(i=>i(d.payload.stroke))}).on("presence",{event:"sync"},()=>{const d=p.presenceState();$("Presence 同步，在線:",Object.keys(d).length)}),ee.add(e),W.value="connecting",p.subscribe(d=>{h(d,p,e,n,g),d==="SUBSCRIBED"?l(p):(d==="CHANNEL_ERROR"||d==="TIMED_OUT")&&w(new Error(`訂閱失敗: ${d}`))})})}function I(e,t){return F.has(e)||F.set(e,new Set),F.get(e).add(t),()=>{F.get(e)?.delete(t)}}function b(e,t){const n=a(e),g=`guesses:${t}`;return n[g]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${t}`},async l=>{$("收到新猜測記錄:",l.eventType,l.new),await v.loadGuesses(t)}),n[g]=!0),n}function f(e,t){const n=a(e),g=`gameState:${e}`;return n[g]||(n.on("broadcast",{event:"game_state"},l=>{$("收到遊戲狀態廣播:",l.payload),t(l.payload)}),n.on("broadcast",{event:"all_guessed"},l=>{$("收到所有人猜對廣播:",l.payload),t({...l.payload,allGuessed:!0})}),n[g]=!0),n}async function m(e,t){const n=a(e),g=n.state;if(g!=="joined")return B("Channel 未連接，狀態:",g,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{$("廣播遊戲狀態:",t);const l=await n.send({type:"broadcast",event:"game_state",payload:t});return l==="error"?(B("發送遊戲狀態失敗"),{error:"發送失敗"}):l}catch(l){return B("發送遊戲狀態錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}async function _(e){const t=a(e);if(t.state!=="joined")return B("Channel 未連接，無法廣播所有人猜對"),{error:"Channel 未連接"};try{$("廣播所有人猜對事件");const g=await t.send({type:"broadcast",event:"all_guessed",payload:{timestamp:Date.now()}});return g==="error"?(B("發送所有人猜對事件失敗"),{error:"發送失敗"}):g}catch(g){return B("發送所有人猜對事件錯誤:",g),{error:g instanceof Error?g.message:"發送失敗"}}}async function N(e,t){const n=a(e),g=n.state;if(g!=="joined")return B("Channel 未連接，無法發送繪畫數據，狀態:",g),{error:"Channel 未連接"};try{const l=await n.send({type:"broadcast",event:"drawing",payload:{stroke:t}});return l==="error"?(B("發送失敗"),{error:"發送失敗"}):l}catch(l){return B("發送錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}function U(e){const t=`room:${e}`,n=j.get(t);u(e),n&&(y.removeChannel(n),j.delete(t)),F.delete(e),ee.delete(e)}function E(){re.forEach((e,t)=>u(t)),j.forEach(e=>y.removeChannel(e)),j.clear(),F.clear(),ee.clear()}function o(){return W.value}return{connectionStatus:W,subscribeRoom:q,subscribeDrawing:I,subscribeGuesses:b,subscribeGameState:f,sendDrawing:N,broadcastGameState:m,broadcastAllGuessed:_,unsubscribeRoom:U,unsubscribeAll:E,getConnectionStatus:o}}const me=3,z=M(null),se=M(!1);let Y=null;const V=M(null);let J=null;const te=M(new Set);function xe(){const r=Z(),v=we();oe();const a=z,u=se,h=V,k=R(()=>r.currentRoom?.status||"waiting"),q=R(()=>k.value==="playing"),I=R(()=>k.value==="waiting"),b=R(()=>k.value==="finished"),f=R(()=>v.roundStatus),m=R(()=>f.value==="drawing"),_=R(()=>f.value==="summary"),N=R(()=>v.currentRound),U=R(()=>r.currentRoom?.current_round||0),E=R(()=>r.currentRoom?.settings.rounds||0),o=R(()=>r.currentRoom?.settings.draw_time||60),e=R(()=>v.isCurrentDrawer);function t(c){console.log("[useGame] startCountdown 開始，時長:",c,"秒"),Y&&clearInterval(Y),z.value=c,se.value=!0,Y=window.setInterval(()=>{z.value!==null&&z.value>0?z.value--:(n(),q.value&&N.value&&r.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),i()))},1e3)}function n(){Y&&(clearInterval(Y),Y=null),se.value=!1}function g(){n(),z.value=null}function l(){console.log("[useGame] startSummaryCountdown 開始"),J&&clearInterval(J),V.value=me,console.log("[useGame] 開始總結倒計時:",me,"秒"),J=window.setInterval(async()=>{V.value!==null&&V.value>0?(V.value--,console.log("[useGame] 總結倒計時:",V.value)):(w(),console.log("[useGame] 總結倒計時結束, isHost:",r.isHost),r.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await s()))},1e3)}function w(){console.log("[useGame] stopSummaryCountdown"),J&&(clearInterval(J),J=null),V.value=null}function p(){if(!r.currentRoom)return null;const c=r.currentRoom.words;if(c.length===0)return null;const G=[];for(let C=0;C<c.length;C++)te.value.has(C)||G.push(C);let x=0;if(G.length>0){const C=Math.floor(Math.random()*G.length);x=G[C]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),te.value.clear(),x=Math.floor(Math.random()*c.length);return te.value.add(x),c[x]??null}async function O(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};if(r.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(r.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{te.value.clear();const c=await r.updateRoomStatus("playing");return c.success?await d():c}catch(c){return console.error("開始遊戲錯誤:",c),{success:!1,error:c instanceof Error?c.message:"開始遊戲失敗"}}}async function d(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};if(!r.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const c=r.currentRoom.current_round||0,G=c+1;if(c>=E.value)return await S(),{success:!1,error:"所有輪次已完成"};try{const x=(G-1)%r.participants.length,C=r.participants[x];if(console.log("[startDrawingPhase] 第",G,"輪，畫家:",C?.nickname),!C)throw new Error("無法選擇畫家");const X=p();if(!X)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",X.text),await r.updateRoomDrawer(C.user_id);const ae=await v.createRound(r.currentRoom.id,C.user_id,X.text,X.source);if(!ae.success||!ae.round)throw new Error("創建輪次失敗");const{broadcastGameState:ve}=oe();return await ve(r.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:C.user_id,drawerName:C.nickname,roundNumber:G}),{success:!0,drawerId:C.user_id,word:X.text}}catch(x){return console.error("開始繪畫階段錯誤:",x),{success:!1,error:x instanceof Error?x.message:"開始繪畫階段失敗"}}}async function A(){return await d()}async function i(){if(!N.value||!r.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!r.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const c=await v.endRound();if(!c.success)return c;const x=(r.currentRoom.current_round||0)>=E.value,{broadcastGameState:C}=oe();return await C(r.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:r.currentRoom.current_drawer_id??void 0,isLastRound:x}),{success:!0,gameEnded:x}}catch(c){return console.error("結束輪次錯誤:",c),{success:!1,error:c instanceof Error?c.message:"結束輪次失敗"}}}async function s(){return r.currentRoom?r.isHost?(r.currentRoom.current_round||0)>=E.value?(await S(),{success:!0,gameEnded:!0}):(await d(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function S(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await r.updateRoomStatus("finished"),{success:!0}}catch(c){return console.error("結束遊戲錯誤:",c),{success:!1,error:c instanceof Error?c.message:"結束遊戲失敗"}}}const D=R(()=>{if(a.value===null)return"--:--";const c=Math.floor(a.value/60),G=a.value%60;return`${c.toString().padStart(2,"0")}:${G.toString().padStart(2,"0")}`});return he(()=>{n(),w()}),{gameStatus:k,isPlaying:q,isWaiting:I,isFinished:b,currentRound:N,currentRoundNumber:U,totalRounds:E,drawTime:o,isCurrentDrawer:e,timeRemaining:a,isCountingDown:u,formattedTime:D,roundStatus:f,isDrawing:m,isSummary:_,summaryTimeRemaining:h,startGame:O,startNextRound:A,startDrawingPhase:d,endRound:i,continueToNextRound:s,endGame:S,startCountdown:t,stopCountdown:n,startSummaryCountdown:l,stopSummaryCountdown:w,resetCountdown:g}}const Ge={class:"waiting-lobby"},Ne={class:"card"},Te={class:"card-body"},ke={class:"margin-bottom-medium"},De={class:"card-title text-hand-title"},Ie={class:"text-small"},Ce={style:{"font-family":"monospace"}},qe={class:"text-small margin-top-small"},Me={class:"margin-bottom-medium"},Oe={class:"text-hand-title"},Ue={class:"margin-top-small"},Ae={style:{"flex-shrink":"0","margin-right":"0.75rem"}},Be={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},He={style:{flex:"1"}},Pe={class:"text-hand",style:{"font-weight":"500"}},$e={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},je={class:"margin-bottom-medium text-small"},We=["disabled"],Le={key:1,class:"text-small text-center margin-bottom-small"},Ke=["disabled"],Fe={key:0,class:"alert alert-danger margin-top-medium"},Ve=_e({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(r,{emit:v}){const a=r,u=v,{isHost:h,canStartGame:k,leaveRoom:q,loading:I,error:b}=Se(),{startGame:f}=xe();function m(E){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[E||""]||E||"未知"}function _(E){return a.room?.host_id===E}async function N(){(await f()).success&&u("startGame")}async function U(){(await q()).success&&u("leaveRoom")}return(E,o)=>(K(),L("div",Ge,[T("div",Ne,[T("div",Te,[T("div",ke,[T("h2",De,H(r.room?.name),1),T("div",Ie,[o[0]||(o[0]=ce(" 房間碼：",-1)),T("span",Ce,H(r.room?.code),1)]),T("div",qe," 狀態："+H(m(r.room?.status)),1)]),T("div",Me,[T("h4",Oe,"玩家列表 ("+H(r.participants.length)+")",1),T("div",Ue,[(K(!0),L(pe,null,Re(r.participants,e=>(K(),L("div",{key:e.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[T("div",Ae,[T("div",Be,H(e.nickname.charAt(0).toUpperCase()),1)]),T("div",He,[T("div",Pe,[ce(H(e.nickname)+" ",1),_(e.user_id)?(K(),L("span",$e," 房主 ")):ne("",!0)])])]))),128))])]),T("div",je,[T("div",null,"繪畫時間："+H(r.room?.settings.draw_time)+" 秒",1),T("div",null,"輪數："+H(r.room?.settings.rounds)+" 輪",1),T("div",null,"詞語總數："+H(r.room?.word_count)+" 個",1)]),T("div",null,[P(h)&&P(k)?(K(),L("button",{key:0,onClick:N,disabled:P(I),class:"paper-btn btn-primary btn-block margin-bottom-small"},H(P(I)?"開始中...":"開始遊戲"),9,We)):P(h)?(K(),L("div",Le," 至少需要 2 個玩家才能開始遊戲 ")):ne("",!0),T("button",{onClick:U,disabled:P(I),class:"paper-btn btn-secondary btn-block"},H(P(I)?"離開中...":"離開房間"),9,Ke)]),P(b)?(K(),L("div",Fe,H(P(b)),1)):ne("",!0)])])]))}}),Ye=ye(Ve,[["__scopeId","data-v-769c8ad1"]]);export{Ye as W,oe as a,Z as b,we as c,Ee as d,xe as e,Se as u};
