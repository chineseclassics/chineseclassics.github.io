import{m as F,r as k,f as S,u as j,x as b,B as X,j as K,d as J,c as M,e as D,a as O,t as T,s as W,F as Q,p as Z,b as N,o as $,_ as ee}from"./index-n5SAw-Xl.js";const A=F("room",()=>{const e=k(null),v=k([]),u=k(!1),s=k(null),h=S(()=>{const a=j();return e.value?.host_id===a.user?.id});async function E(a){try{u.value=!0,s.value=null;const r=j();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(_){console.warn("載入用戶資料時發生錯誤（非關鍵）:",_)}if(a.words.length<6)throw new Error("至少需要 6 個詞語");if(a.settings.rounds>a.words.length)throw new Error("輪數不能超過詞語總數");let t=null,c=0;const w=10;for(;c<w&&!t;){c++;const q={code:Math.floor(1e5+Math.random()*9e5).toString(),name:a.name,host_id:r.user.id,words:a.words,word_count:a.words.length,status:"waiting",settings:a.settings,current_round:0,current_drawer_id:null},{data:P,error:n}=await b.from("game_rooms").insert(q).select().single();if(n){if(n.code==="23505")continue;throw new Error(n.message||"插入房間失敗")}if(P){t=P;break}}if(!t)throw new Error("無法生成唯一房間碼，請重試");const x={room_id:t.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:_}=await b.from("room_participants").insert(x);_&&console.error("創建參與記錄錯誤:",_)}catch(_){console.error("創建參與記錄時發生錯誤:",_)}try{const{data:_,error:q}=await b.from("room_participants").select("*").eq("room_id",t.id).order("joined_at",{ascending:!0});q?console.error("載入參與者列表失敗:",q):_&&(v.value=_)}catch(_){console.error("載入參與者列表時發生錯誤:",_)}return e.value=t,{success:!0,room:t}}catch(r){return s.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:s.value}}finally{u.value=!1}}async function R(a,r){try{u.value=!0,s.value=null;const t=j();if(!t.user)throw new Error("請先登入");if(!/^\d{6}$/.test(a))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:c,error:w}=await b.from("game_rooms").select("*").eq("code",a).single();if(w||!c)throw new Error("房間不存在");if(c.status!=="waiting")throw new Error("房間已開始或已結束");const{data:x}=await b.from("room_participants").select("*").eq("room_id",c.id).eq("user_id",t.user.id).maybeSingle();if(x)return e.value=c,await f(c.id),{success:!0,room:c};const{error:_}=await b.from("room_participants").insert({room_id:c.id,user_id:t.user.id,nickname:r.trim(),score:0});if(_){if(_.code==="23505"||_.message.includes("duplicate"))return e.value=c,await f(c.id),{success:!0,room:c};throw _}return e.value=c,await f(c.id),{success:!0,room:c}}catch(t){return s.value=t instanceof Error?t.message:"加入房間失敗",console.error("加入房間錯誤:",t),{success:!1,error:s.value}}finally{u.value=!1}}async function y(){try{if(!e.value)return{success:!0};u.value=!0,s.value=null;const a=j();if(!a.user)throw new Error("請先登入");const{error:r}=await b.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",a.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(h.value){const{error:t}=await b.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);t&&console.error("關閉房間失敗:",t)}return e.value=null,v.value=[],{success:!0}}catch(a){return s.value=a instanceof Error?a.message:"離開房間失敗",console.error("離開房間錯誤:",a),e.value=null,v.value=[],{success:!1,error:s.value}}finally{u.value=!1}}async function f(a){try{const{data:r,error:t}=await b.from("room_participants").select("*").eq("room_id",a).order("joined_at",{ascending:!0});if(t)throw t;v.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function d(a){try{u.value=!0,s.value=null;const{data:r,error:t}=await b.from("game_rooms").select("*").eq("id",a).single();if(t)throw t;return e.value=r,await f(a),{success:!0,room:r}}catch(r){return s.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:s.value}}finally{u.value=!1}}async function m(a){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:a});const{error:r}=await b.from("game_rooms").update({status:a}).eq("id",e.value.id);if(r)throw r;if(e.value){const t=e.value.status;e.value.status=a,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:t,newStatus:e.value.status})}return{success:!0}}catch(r){return s.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:s.value}}}function g(){e.value=null,v.value=[],s.value=null}return{currentRoom:e,participants:v,loading:u,error:s,isHost:h,createRoom:E,joinRoom:R,leaveRoom:y,loadParticipants:f,loadRoom:d,updateRoomStatus:m,clearRoom:g}});function re(){const e=A(),v=S(()=>e.currentRoom),u=S(()=>e.participants),s=S(()=>e.isHost),h=S(()=>!v.value||v.value.status!=="waiting"||!s.value?!1:u.value.length>=2);async function E(f){return await e.createRoom(f)}async function R(f,d){return await e.joinRoom(f,d)}async function y(){return await e.leaveRoom()}return{currentRoom:v,participants:u,isHost:s,canStartGame:h,loading:S(()=>e.loading),error:S(()=>e.error),createRoom:E,joinRoom:R,leaveRoom:y}}const Y=F("game",()=>{const e=A(),v=j(),u=k(null),s=k(null),h=k([]),E=S(()=>h.value.filter(r=>r.is_correct));async function R(r){try{const{data:t,error:c}=await b.from("game_rounds").select("*").eq("room_id",r).order("round_number",{ascending:!1}).limit(1).single();if(c&&c.code!=="PGRST116")throw c;return t&&(u.value=t,s.value=t.word_text,await y(t.id)),{success:!0,round:t}}catch(t){return console.error("載入當前輪次錯誤:",t),{success:!1,error:t instanceof Error?t.message:"載入輪次失敗"}}}async function y(r){try{const{data:t,error:c}=await b.from("guesses").select("*").eq("round_id",r).order("guessed_at",{ascending:!0});if(c)throw c;h.value=t||[]}catch(t){console.error("載入猜測記錄錯誤:",t)}}async function f(r,t,c,w){try{if(!e.currentRoom)throw new Error("沒有當前房間");const x=(e.currentRoom.current_round||0)+1,{data:_,error:q}=await b.from("game_rounds").insert({room_id:r,round_number:x,drawer_id:t,word_text:c,word_source:w}).select().single();if(q)throw q;return u.value=_,s.value=c,h.value=[],await b.from("game_rooms").update({current_round:x,current_drawer_id:t}).eq("id",r),{success:!0,round:_}}catch(x){return console.error("創建輪次錯誤:",x),{success:!1,error:x instanceof Error?x.message:"創建輪次失敗"}}}function d(r){return h.value.some(t=>t.user_id===r&&t.is_correct)}const m=S(()=>!u.value||!v.user?!1:u.value.drawer_id===v.user.id);async function g(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const r=E.value.length,{useScoring:t}=await X(async()=>{const{useScoring:x}=await Promise.resolve().then(()=>te);return{useScoring:x}},void 0),{updateDrawerScore:c}=t();await c(u.value.drawer_id,r);const{error:w}=await b.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",u.value.id);if(w)throw w;return{success:!0}}catch(r){return console.error("結束輪次錯誤:",r),{success:!1,error:r instanceof Error?r.message:"結束輪次失敗"}}}function a(){u.value=null,s.value=null,h.value=[]}return{currentRound:u,currentWord:s,guesses:h,correctGuesses:E,isCurrentDrawer:m,loadCurrentRound:R,loadGuesses:y,createRound:f,hasGuessed:d,endRound:g,clearGame:a}}),L=100,H=50,I=10,C=100,V=[1,.8,.6,.4,.2];function z(){const e=A();function v(d){const m=Math.min(d,V.length-1),g=V[m]??0;return Math.round(L*g)}function u(d){return d===0?0:H+d*I}async function s(d,m){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:g,error:a}=await b.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",d).single();if(a)throw a;const r=(g?.score||0)+m,{error:t}=await b.from("room_participants").update({score:r}).eq("room_id",e.currentRoom.id).eq("user_id",d);if(t)throw t;const c=e.participants.findIndex(w=>w.user_id===d);return c!==-1&&e.participants[c]&&(e.participants[c].score=r),!0}catch(g){return console.error("更新玩家分數錯誤:",g),!1}}async function h(d,m){const g=u(m);return g===0?!0:await s(d,g)}function E(){if(!e.participants||e.participants.length===0)return null;const d=[...e.participants].sort((m,g)=>g.score-m.score);return d.length===1||d[0]&&d[1]&&d[0].score>d[1].score?{user_id:d[0]?.user_id||"",score:d[0]?.score||0}:{user_id:d[0]?.user_id||"",score:d[0]?.score||0}}const R=S(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((m,g)=>g.score!==m.score?g.score-m.score:new Date(m.joined_at).getTime()-new Date(g.joined_at).getTime()).map((m,g)=>({id:m.id,user_id:m.user_id,score:m.score,rank:g+1}))),y=S(()=>e.currentRoom?.status!=="finished"?null:E());function f(){return C}return{GUESS_BASE_SCORE:L,DRAWING_BASE_SCORE:H,DRAWING_BONUS_PER_GUESS:I,WINNER_BONUS:C,calculateGuessScore:v,calculateDrawingScore:u,calculateWinner:E,updatePlayerScore:s,updateDrawerScore:h,playerRankings:R,winner:y,getWinnerBonus:f}}const te=Object.freeze(Object.defineProperty({__proto__:null,useScoring:z},Symbol.toStringTag,{value:"Module"}));function oe(){const e=A(),v=Y(),{updateDrawerScore:u}=z(),s=k(null),h=k(!1);let E=null;const R=S(()=>e.currentRoom?.status||"waiting"),y=S(()=>R.value==="playing"),f=S(()=>R.value==="waiting"),d=S(()=>R.value==="finished"),m=S(()=>v.currentRound),g=S(()=>e.currentRoom?.current_round||0),a=S(()=>e.currentRoom?.settings.rounds||0),r=S(()=>e.currentRoom?.settings.draw_time||60),t=S(()=>v.isCurrentDrawer);function c(o){E&&clearInterval(E),s.value=o,h.value=!0,E=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(w(),y.value&&m.value&&P())},1e3)}function w(){E&&(clearInterval(E),E=null),h.value=!1}function x(){w(),s.value=null}async function _(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const o=await e.updateRoomStatus("playing");return o.success?await q():o}catch(o){return console.error("開始遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"開始遊戲失敗"}}}async function q(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const o=e.currentRoom.words,l=e.currentRoom.current_round||0;if(l>=o.length||l>=a.value)return await n(),{success:!1,error:"所有輪次已完成"};try{const p=o[l],G=l%e.participants.length,U=e.participants[G];if(!U||!p)throw new Error("無法選擇畫家或詞語");const B=await v.createRound(e.currentRoom.id,U.user_id,p.text,p.source);return B.success&&B.round&&c(r.value),B}catch(p){return console.error("開始下一輪錯誤:",p),{success:!1,error:p instanceof Error?p.message:"開始下一輪失敗"}}}async function P(){if(!m.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{w();const o=v.correctGuesses.length;await u(m.value.drawer_id,o);const l=await v.endRound();return l.success?(e.currentRoom.current_round||0)>=a.value?(await n(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await q()},2e3),{success:!0,gameEnded:!1}):l}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}async function n(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return w(),await e.updateRoomStatus("finished"),{success:!0}}catch(o){return console.error("結束遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束遊戲失敗"}}}const i=S(()=>{if(s.value===null)return"--:--";const o=Math.floor(s.value/60),l=s.value%60;return`${o.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`});return K(()=>{w()}),{gameStatus:R,isPlaying:y,isWaiting:f,isFinished:d,currentRound:m,currentRoundNumber:g,totalRounds:a,drawTime:r,isCurrentDrawer:t,timeRemaining:s,isCountingDown:h,formattedTime:i,startGame:_,startNextRound:q,endRound:P,endGame:n,startCountdown:c,stopCountdown:w,resetCountdown:x}}const ne={class:"waiting-lobby"},se={class:"card"},ae={class:"card-body"},ce={class:"margin-bottom-medium"},ie={class:"card-title text-hand-title"},ue={class:"text-small"},le={style:{"font-family":"monospace"}},de={class:"text-small margin-top-small"},me={class:"margin-bottom-medium"},fe={class:"text-hand-title"},ve={class:"margin-top-small"},ge={class:"col-2"},we={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-secondary)","border-color":"var(--border-light)",color:"var(--text-primary)"}},_e={class:"col-10"},he={class:"text-hand"},pe={key:0,class:"text-small"},Re={class:"margin-bottom-medium text-small"},ye=["disabled"],be={key:1,class:"text-small text-center margin-bottom-small"},Se=["disabled"],Ee={key:0,class:"alert alert-danger margin-top-medium"},xe=J({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:v}){const u=e,s=v,{isHost:h,canStartGame:E,leaveRoom:R,loading:y,error:f}=re(),{startGame:d}=oe();function m(t){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[t||""]||t||"未知"}function g(t){return u.room?.host_id===t}async function a(){(await d()).success&&s("startGame")}async function r(){(await R()).success&&s("leaveRoom")}return(t,c)=>($(),M("div",ne,[D("div",se,[D("div",ae,[D("div",ce,[D("h2",ie,T(e.room?.name),1),D("div",ue,[c[0]||(c[0]=W(" 房間碼：",-1)),D("span",le,T(e.room?.code),1)]),D("div",de," 狀態："+T(m(e.room?.status)),1)]),D("div",me,[D("h4",fe,"玩家列表 ("+T(e.participants.length)+")",1),D("div",ve,[($(!0),M(Q,null,Z(e.participants,w=>($(),M("div",{key:w.id,class:"row flex-middle margin-bottom-small border-bottom",style:{"padding-bottom":"10px"}},[D("div",ge,[D("div",we,T(w.nickname.charAt(0)),1)]),D("div",_e,[D("div",he,[W(T(w.nickname)+" ",1),g(w.user_id)?($(),M("span",pe," (房主) ")):O("",!0)])])]))),128))])]),D("div",Re,[D("div",null,"繪畫時間："+T(e.room?.settings.draw_time)+" 秒",1),D("div",null,"輪數："+T(e.room?.settings.rounds)+" 輪",1),D("div",null,"詞語總數："+T(e.room?.word_count)+" 個",1)]),D("div",null,[N(h)&&N(E)?($(),M("button",{key:0,onClick:a,disabled:N(y),class:"paper-btn btn-primary btn-block margin-bottom-small"},T(N(y)?"開始中...":"開始遊戲"),9,ye)):N(h)?($(),M("div",be," 至少需要 2 個玩家才能開始遊戲 ")):O("",!0),D("button",{onClick:r,disabled:N(y),class:"paper-btn btn-secondary btn-block"},T(N(y)?"離開中...":"離開房間"),9,Se)]),N(f)?($(),M("div",Ee,T(N(f)),1)):O("",!0)])])]))}}),Ge=ee(xe,[["__scopeId","data-v-f6bc683c"]]);function qe(){const e=A(),v=Y(),u=k(new Map),s=k("disconnected"),h=3,E=1e3,R=k(new Map),y=k(new Map);function f(n){const i=`room:${n}`;if(u.value.has(i))return u.value.get(i);const o=b.channel(i,{config:{presence:{key:"user"}}});return u.value.set(i,o),o}function d(n,i){const o=f(n);return o.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${i}`},async l=>{console.log("房間狀態變化:",l),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}),o}function m(n,i){const o=f(n);return o.on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${i}`},async l=>{console.log("參與者變化:",l),await e.loadParticipants(i)}),o}function g(n,i){const o=f(n);return o.on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${i}`},async l=>{console.log("輪次變化:",l),e.currentRoom&&await v.loadCurrentRound(e.currentRoom.id)}),o}function a(n,i){const o=f(n);return o.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${i}`},async l=>{console.log("猜測記錄變化:",l),await v.loadGuesses(i)}).subscribe(),o}function r(n,i){const o=f(n);return o.on("broadcast",{event:"drawing"},l=>{console.log("收到繪畫數據:",l),i(l.payload.stroke)}).subscribe(),o}async function t(n,i){try{const o=f(n);if(s.value==="disconnected")return console.warn("Realtime 未連接，無法發送繪畫數據"),{error:"連接未建立"};const l=await o.send({type:"broadcast",event:"drawing",payload:{stroke:i}});return l==="error"?(console.error("發送繪畫數據失敗"),{error:"發送失敗"}):l}catch(o){return console.error("發送繪畫數據錯誤:",o),{error:o instanceof Error?o.message:"發送失敗"}}}function c(n,i,o){const l=f(n);return l.on("presence",{event:"sync"},()=>{const p=l.presenceState();console.log("Presence 狀態:",p)}).on("presence",{event:"join"},({key:p,newPresences:G})=>{console.log("玩家加入:",p,G)}).on("presence",{event:"leave"},({key:p,leftPresences:G})=>{console.log("玩家離開:",p,G)}),l}function w(n,i,o,l){if(!n||!i)return;const p=f(n);return d(n,i),m(n,i),g(n,i),c(n),p.on("system",{},G=>{console.log("Realtime 系統狀態:",G),G.status==="ok"?(s.value="connected",R.value.set(n,0),x(n)):G.status==="error"&&(s.value="disconnected",console.warn("Realtime 連接錯誤，嘗試重試"),_(n,i,o,l))}),p.subscribe(async G=>{console.log("Realtime 訂閱狀態:",G),G==="SUBSCRIBED"?(s.value="connected",R.value.set(n,0),x(n),await p.track({user_id:o,...l})):(G==="CHANNEL_ERROR"||G==="TIMED_OUT")&&(s.value="disconnected",console.warn("Realtime 訂閱失敗，嘗試重試"),_(n,i,o,l))}),p}function x(n){const i=y.value.get(n);i&&(clearTimeout(i),y.value.delete(n))}function _(n,i,o,l){const p=R.value.get(n)||0;if(p>=h){console.error(`Realtime 連接失敗，已達到最大重試次數 (${h})`),s.value="disconnected";return}x(n);const G=window.setTimeout(()=>{console.log(`嘗試重新連接 Realtime (${p+1}/${h})`),R.value.set(n,p+1),q(n),w(n,i,o,l)},E*(p+1));y.value.set(n,G)}function q(n){const i=`room:${n}`,o=u.value.get(i);o&&(b.removeChannel(o),u.value.delete(i)),x(n),R.value.delete(n)}function P(){u.value.forEach((n,i)=>{b.removeChannel(n),x(i)}),u.value.clear(),R.value.clear(),y.value.clear()}return K(()=>{P()}),{connectionStatus:s,subscribeRoom:w,subscribeDrawing:r,subscribeGuesses:a,sendDrawing:t,unsubscribeRoom:q,unsubscribeAll:P}}export{Ge as W,oe as a,qe as b,A as c,Y as d,z as e,re as u};
