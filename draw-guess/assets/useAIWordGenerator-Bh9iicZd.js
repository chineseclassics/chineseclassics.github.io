import{u as j,f as A,r as g,E as d}from"./index-Bxy-BNNa.js";const u=g([]),l=g({}),S=g(!1),C=g({}),p=g(null),c=g(!1);function J(){const a=j(),n=A(()=>c.value);async function o(e=!1){if(!a.profile?.email)return c.value=!1,!1;if(c.value&&!e)return!0;const{data:r,error:t}=await d.from("word_library_admins").select("email").eq("email",a.profile.email).maybeSingle();return t?(console.warn("[WordLibrary] 檢查管理員權限失敗:",t),c.value=!1,!1):(c.value=!!r,c.value)}async function _(e={}){try{S.value=!0,p.value=null;let r=d.from("word_collections").select("id, slug, title, description, entry_count, is_active").order("title",{ascending:!0});e.includeInactive||(r=r.eq("is_active",!0));const{data:t,error:s}=await r;if(s)throw s;return u.value=t||[],u.value}catch(r){return p.value=r instanceof Error?r.message:"載入詞句庫失敗",[]}finally{S.value=!1}}async function T(e,r=!1){if(!r&&l.value[e])return l.value[e];C.value[e]=!0;try{const{data:t,error:s}=await d.from("word_entries").select("id, collection_id, text, category").eq("collection_id",e).order("text",{ascending:!0});if(s)throw s;return l.value[e]=t||[],l.value[e]}catch(t){return p.value=t instanceof Error?t.message:"載入詞句條目失敗",l.value[e]=[],[]}finally{C.value[e]=!1}}async function y(e){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const r=e.slug||e.title.trim().toLowerCase().replace(/\s+/g,"-"),t={title:e.title.trim(),slug:r,description:e.description?.trim()||null},{data:s,error:i}=await d.from("word_collections").insert(t).select("id, slug, title, description, entry_count, is_active").single();return i?{success:!1,error:i.message||"新增主題失敗"}:(u.value=[...u.value,s],{success:!0,collection:s})}async function x(e,r,t){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const s=r.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{data:i,error:h}=await d.from("word_entries").insert({collection_id:e,text:s,category:t?.trim()||null}).select("id, collection_id, text, category").single();if(h)return{success:!1,error:h.message||"新增條目失敗"};const w=i,P=l.value[e]||[];return l.value[e]=[...P,w],u.value=u.value.map(E=>E.id===e?{...E,entry_count:(E.entry_count||0)+1}:E),{success:!0,entry:w}}async function m(e,r,t){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const s=t.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{error:i}=await d.from("word_entries").update({text:s}).eq("id",e);if(i)return{success:!1,error:i.message||"更新失敗"};const h=l.value[r]||[];return l.value[r]=h.map(w=>w.id===e?{...w,text:s}:w),{success:!0}}async function L(e,r){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await d.from("word_entries").delete().eq("id",e);if(t)return{success:!1,error:t.message||"刪除失敗"};const s=l.value[r]||[];return l.value[r]=s.filter(i=>i.id!==e),u.value=u.value.map(i=>i.id===r?{...i,entry_count:Math.max(0,(i.entry_count||1)-1)}:i),{success:!0}}async function v(e,r){if(await o(),!c.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await d.from("word_collections").update({is_active:r}).eq("id",e);return t?{success:!1,error:t.message||"更新狀態失敗"}:(u.value=u.value.map(s=>s.id===e?{...s,is_active:r}:s),{success:!0})}return{collections:u,entriesMap:l,loadingCollections:S,loadingEntries:C,error:p,isAdmin:n,refreshAdminStatus:o,loadCollections:_,loadEntries:T,addCollection:y,addEntry:x,updateEntry:m,deleteEntry:L,toggleCollectionActive:v}}const R="ai-word-generator-rate-limit",W=10,N=300*1e3,k=3e4,M=g(!1),f=g(null);function q(){try{const a=localStorage.getItem(R);if(a)return JSON.parse(a)}catch{}return{calls:[]}}function b(a){try{localStorage.setItem(R,JSON.stringify(a))}catch{}}function D(a){const o=Date.now()-N;return a.filter(_=>_>o)}function O(){const a=q(),n=D(a.calls);n.length!==a.calls.length&&b({calls:n});const o=Math.max(0,W-n.length);return{isLimited:n.length>=W,remainingCalls:o}}function U(){const a=q(),n=D(a.calls);n.push(Date.now()),b({calls:n})}function I(a){return a.map(n=>n.trim()).filter(n=>n.length>0).join("，")}function F(){const a=A(()=>O()),n=A(()=>a.value.isLimited),o=A(()=>a.value.remainingCalls);async function _(y){if(!y||y.trim().length===0)return f.value="請先輸入房間主題",null;const{isLimited:x}=O();if(x)return f.value="請求次數已達上限，請 5 分鐘後再試",null;M.value=!0,f.value=null;try{U();const m=new Promise((r,t)=>{setTimeout(()=>t(new Error("TIMEOUT")),k)}),L=d.functions.invoke("generate-words",{body:{theme:y.trim()}}),{data:v,error:e}=await Promise.race([L,m]);if(e)throw e;return!v||!v.success?(f.value=v?.error||"AI 服務暫時不可用，請稍後再試或手動輸入詞語",null):{words:v.words||[],isThemeAdjusted:v.isThemeAdjusted||!1,adjustedTheme:v.adjustedTheme}}catch(m){return m instanceof Error?m.message==="TIMEOUT"?f.value="AI 服務響應超時，請稍後再試":m.message.includes("network")||m.message.includes("fetch")?f.value="網絡連接失敗，請檢查網絡後重試":f.value="AI 服務暫時不可用，請稍後再試或手動輸入詞語":f.value="AI 服務暫時不可用，請稍後再試或手動輸入詞語",null}finally{M.value=!1}}function T(){localStorage.removeItem(R)}return{isGenerating:M,isRateLimited:n,remainingCalls:o,error:f,generateWords:_,formatWordsForInput:I,resetRateLimit:T}}export{F as a,I as f,J as u};
