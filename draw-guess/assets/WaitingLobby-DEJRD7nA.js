import{k as $,r as D,f as w,u as j,s as p,z as J,l as K,d as Q,c as N,e as v,a as W,t as S,x as M,F as X,m as Y,b as G,o as k,_ as Z}from"./index-BT9wtV9k.js";const T=$("room",()=>{const r=D(null),l=D([]),c=D(!1),s=D(null),_=w(()=>{const n=j();return r.value?.host_id===n.user?.id});async function h(n){try{c.value=!0,s.value=null;const e=j();if(!e.user)throw new Error("請先登入");if(!e.profile&&e.user)try{await e.loadUserProfile(e.user.id,!1)}catch(f){console.warn("載入用戶資料時發生錯誤（非關鍵）:",f)}if(n.words.length<6)throw new Error("至少需要 6 個詞語");if(n.settings.rounds>n.words.length)throw new Error("輪數不能超過詞語總數");let t=null,o=0;const m=10;for(;o<m&&!t;){o++;const x={code:Math.floor(1e5+Math.random()*9e5).toString(),name:n.name,host_id:e.user.id,words:n.words,word_count:n.words.length,status:"waiting",settings:n.settings,current_round:0,current_drawer_id:null},{data:P,error:C}=await p.from("game_rooms").insert(x).select().single();if(C){if(C.code==="23505")continue;throw new Error(C.message||"插入房間失敗")}if(P){t=P;break}}if(!t)throw new Error("無法生成唯一房間碼，請重試");const E={room_id:t.id,user_id:e.user.id,nickname:e.profile?.display_name||"房主",score:0};try{const{error:f}=await p.from("room_participants").insert(E);f&&console.error("創建參與記錄錯誤:",f)}catch(f){console.error("創建參與記錄時發生錯誤:",f)}try{const{data:f,error:x}=await p.from("room_participants").select("*").eq("room_id",t.id).order("joined_at",{ascending:!0});x?console.error("載入參與者列表失敗:",x):f&&(l.value=f)}catch(f){console.error("載入參與者列表時發生錯誤:",f)}return r.value=t,{success:!0,room:t}}catch(e){return s.value=e instanceof Error?e.message:"創建房間失敗",console.error("創建房間錯誤:",e),{success:!1,error:s.value}}finally{c.value=!1}}async function R(n,e){try{c.value=!0,s.value=null;const t=j();if(!t.user)throw new Error("請先登入");if(!/^\d{6}$/.test(n))throw new Error("房間碼必須是 6 位數字");if(!e||e.trim().length===0)throw new Error("請輸入暱稱");if(e.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:o,error:m}=await p.from("game_rooms").select("*").eq("code",n).single();if(m||!o)throw new Error("房間不存在");if(o.status!=="waiting")throw new Error("房間已開始或已結束");const{data:E}=await p.from("room_participants").select("*").eq("room_id",o.id).eq("user_id",t.user.id).maybeSingle();if(E)return r.value=o,await g(o.id),{success:!0,room:o};const{error:f}=await p.from("room_participants").insert({room_id:o.id,user_id:t.user.id,nickname:e.trim(),score:0});if(f){if(f.code==="23505"||f.message.includes("duplicate"))return r.value=o,await g(o.id),{success:!0,room:o};throw f}return r.value=o,await g(o.id),{success:!0,room:o}}catch(t){return s.value=t instanceof Error?t.message:"加入房間失敗",console.error("加入房間錯誤:",t),{success:!1,error:s.value}}finally{c.value=!1}}async function y(){try{if(!r.value)return{success:!0};c.value=!0,s.value=null;const n=j();if(!n.user)throw new Error("請先登入");const{error:e}=await p.from("room_participants").delete().eq("room_id",r.value.id).eq("user_id",n.user.id);if(e)throw new Error(`刪除參與記錄失敗: ${e.message||"未知錯誤"}`);if(_.value){const{error:t}=await p.from("game_rooms").update({status:"finished"}).eq("id",r.value.id);t&&console.error("關閉房間失敗:",t)}return r.value=null,l.value=[],{success:!0}}catch(n){return s.value=n instanceof Error?n.message:"離開房間失敗",console.error("離開房間錯誤:",n),r.value=null,l.value=[],{success:!1,error:s.value}}finally{c.value=!1}}async function g(n){try{const{data:e,error:t}=await p.from("room_participants").select("*").eq("room_id",n).order("joined_at",{ascending:!0});if(t)throw t;l.value=e||[]}catch(e){console.error("載入參與者錯誤:",e)}}async function a(n){try{c.value=!0,s.value=null;const{data:e,error:t}=await p.from("game_rooms").select("*").eq("id",n).single();if(t)throw t;return r.value=e,await g(n),{success:!0,room:e}}catch(e){return s.value=e instanceof Error?e.message:"載入房間失敗",console.error("載入房間錯誤:",e),{success:!1,error:s.value}}finally{c.value=!1}}async function i(n){try{if(!r.value)throw new Error("沒有當前房間");const{error:e}=await p.from("game_rooms").update({status:n}).eq("id",r.value.id);if(e)throw e;return r.value&&(r.value.status=n),{success:!0}}catch(e){return s.value=e instanceof Error?e.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",e),{success:!1,error:s.value}}}function u(){r.value=null,l.value=[],s.value=null}return{currentRoom:r,participants:l,loading:c,error:s,isHost:_,createRoom:h,joinRoom:R,leaveRoom:y,loadParticipants:g,loadRoom:a,updateRoomStatus:i,clearRoom:u}});function rr(){const r=T(),l=w(()=>r.currentRoom),c=w(()=>r.participants),s=w(()=>r.isHost),_=w(()=>!l.value||l.value.status!=="waiting"||!s.value?!1:c.value.length>=2);async function h(g){return await r.createRoom(g)}async function R(g,a){return await r.joinRoom(g,a)}async function y(){return await r.leaveRoom()}return{currentRoom:l,participants:c,isHost:s,canStartGame:_,loading:w(()=>r.loading),error:w(()=>r.error),createRoom:h,joinRoom:R,leaveRoom:y}}const er=$("game",()=>{const r=T(),l=j(),c=D(null),s=D(null),_=D([]),h=w(()=>_.value.filter(e=>e.is_correct));async function R(e){try{const{data:t,error:o}=await p.from("game_rounds").select("*").eq("room_id",e).order("round_number",{ascending:!1}).limit(1).single();if(o&&o.code!=="PGRST116")throw o;return t&&(c.value=t,s.value=t.word_text,await y(t.id)),{success:!0,round:t}}catch(t){return console.error("載入當前輪次錯誤:",t),{success:!1,error:t instanceof Error?t.message:"載入輪次失敗"}}}async function y(e){try{const{data:t,error:o}=await p.from("guesses").select("*").eq("round_id",e).order("guessed_at",{ascending:!0});if(o)throw o;_.value=t||[]}catch(t){console.error("載入猜測記錄錯誤:",t)}}async function g(e,t,o,m){try{if(!r.currentRoom)throw new Error("沒有當前房間");const E=(r.currentRoom.current_round||0)+1,{data:f,error:x}=await p.from("game_rounds").insert({room_id:e,round_number:E,drawer_id:t,word_text:o,word_source:m}).select().single();if(x)throw x;return c.value=f,s.value=o,_.value=[],await p.from("game_rooms").update({current_round:E,current_drawer_id:t}).eq("id",e),{success:!0,round:f}}catch(E){return console.error("創建輪次錯誤:",E),{success:!1,error:E instanceof Error?E.message:"創建輪次失敗"}}}function a(e){return _.value.some(t=>t.user_id===e&&t.is_correct)}const i=w(()=>!c.value||!l.user?!1:c.value.drawer_id===l.user.id);async function u(){if(!c.value||!r.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const e=h.value.length,{useScoring:t}=await J(async()=>{const{useScoring:E}=await Promise.resolve().then(()=>tr);return{useScoring:E}},void 0),{updateDrawerScore:o}=t();await o(c.value.drawer_id,e);const{error:m}=await p.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",c.value.id);if(m)throw m;return{success:!0}}catch(e){return console.error("結束輪次錯誤:",e),{success:!1,error:e instanceof Error?e.message:"結束輪次失敗"}}}function n(){c.value=null,s.value=null,_.value=[]}return{currentRound:c,currentWord:s,guesses:_,correctGuesses:h,isCurrentDrawer:i,loadCurrentRound:R,loadGuesses:y,createRound:g,hasGuessed:a,endRound:u,clearGame:n}}),U=100,A=50,B=10,L=100,H=[1,.8,.6,.4,.2];function V(){const r=T();function l(a){const i=Math.min(a,H.length-1),u=H[i]??0;return Math.round(U*u)}function c(a){return a===0?0:A+a*B}async function s(a,i){if(!r.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:u,error:n}=await p.from("room_participants").select("score").eq("room_id",r.currentRoom.id).eq("user_id",a).single();if(n)throw n;const e=(u?.score||0)+i,{error:t}=await p.from("room_participants").update({score:e}).eq("room_id",r.currentRoom.id).eq("user_id",a);if(t)throw t;const o=r.participants.findIndex(m=>m.user_id===a);return o!==-1&&r.participants[o]&&(r.participants[o].score=e),!0}catch(u){return console.error("更新玩家分數錯誤:",u),!1}}async function _(a,i){const u=c(i);return u===0?!0:await s(a,u)}function h(){if(!r.participants||r.participants.length===0)return null;const a=[...r.participants].sort((i,u)=>u.score-i.score);return a.length===1||a[0]&&a[1]&&a[0].score>a[1].score?{user_id:a[0]?.user_id||"",score:a[0]?.score||0}:{user_id:a[0]?.user_id||"",score:a[0]?.score||0}}const R=w(()=>!r.participants||r.participants.length===0?[]:[...r.participants].sort((i,u)=>u.score!==i.score?u.score-i.score:new Date(i.joined_at).getTime()-new Date(u.joined_at).getTime()).map((i,u)=>({id:i.id,user_id:i.user_id,score:i.score,rank:u+1}))),y=w(()=>r.currentRoom?.status!=="finished"?null:h());function g(){return L}return{GUESS_BASE_SCORE:U,DRAWING_BASE_SCORE:A,DRAWING_BONUS_PER_GUESS:B,WINNER_BONUS:L,calculateGuessScore:l,calculateDrawingScore:c,calculateWinner:h,updatePlayerScore:s,updateDrawerScore:_,playerRankings:R,winner:y,getWinnerBonus:g}}const tr=Object.freeze(Object.defineProperty({__proto__:null,useScoring:V},Symbol.toStringTag,{value:"Module"}));function or(){const r=T(),l=er(),{updateDrawerScore:c}=V(),s=D(null),_=D(!1);let h=null;const R=w(()=>r.currentRoom?.status||"waiting"),y=w(()=>R.value==="playing"),g=w(()=>R.value==="waiting"),a=w(()=>R.value==="finished"),i=w(()=>l.currentRound),u=w(()=>r.currentRoom?.current_round||0),n=w(()=>r.currentRoom?.settings.rounds||0),e=w(()=>r.currentRoom?.settings.draw_time||60),t=w(()=>l.isCurrentDrawer);function o(d){h&&clearInterval(h),s.value=d,_.value=!0,h=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(m(),y.value&&i.value&&P())},1e3)}function m(){h&&(clearInterval(h),h=null),_.value=!1}function E(){m(),s.value=null}async function f(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};if(r.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(r.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const d=await r.updateRoomStatus("playing");return d.success?await x():d}catch(d){return console.error("開始遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"開始遊戲失敗"}}}async function x(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};const d=r.currentRoom.words,b=r.currentRoom.current_round||0;if(b>=d.length||b>=n.value)return await C(),{success:!1,error:"所有輪次已完成"};try{const q=d[b],z=b%r.participants.length,O=r.participants[z];if(!O||!q)throw new Error("無法選擇畫家或詞語");const I=await l.createRound(r.currentRoom.id,O.user_id,q.text,q.source);return I.success&&I.round&&o(e.value),I}catch(q){return console.error("開始下一輪錯誤:",q),{success:!1,error:q instanceof Error?q.message:"開始下一輪失敗"}}}async function P(){if(!i.value||!r.currentRoom)return{success:!1,error:"沒有當前輪次"};try{m();const d=l.correctGuesses.length;await c(i.value.drawer_id,d);const b=await l.endRound();return b.success?(r.currentRoom.current_round||0)>=n.value?(await C(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await x()},2e3),{success:!0,gameEnded:!1}):b}catch(d){return console.error("結束輪次錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束輪次失敗"}}}async function C(){if(!r.currentRoom)return{success:!1,error:"沒有當前房間"};try{return m(),await r.updateRoomStatus("finished"),{success:!0}}catch(d){return console.error("結束遊戲錯誤:",d),{success:!1,error:d instanceof Error?d.message:"結束遊戲失敗"}}}const F=w(()=>{if(s.value===null)return"--:--";const d=Math.floor(s.value/60),b=s.value%60;return`${d.toString().padStart(2,"0")}:${b.toString().padStart(2,"0")}`});return K(()=>{m()}),{gameStatus:R,isPlaying:y,isWaiting:g,isFinished:a,currentRound:i,currentRoundNumber:u,totalRounds:n,drawTime:e,isCurrentDrawer:t,timeRemaining:s,isCountingDown:_,formattedTime:F,startGame:f,startNextRound:x,endRound:P,endGame:C,startCountdown:o,stopCountdown:m,resetCountdown:E}}const sr={class:"waiting-lobby"},nr={class:"card-minimal"},ar={class:"mb-6"},cr={class:"text-xl font-light text-text-primary mb-2"},ir={class:"text-sm text-text-secondary"},ur={class:"font-mono text-text-primary"},lr={class:"text-sm text-text-secondary mt-1"},dr={class:"text-text-primary"},mr={class:"mb-6"},fr={class:"text-sm font-medium text-text-primary mb-3"},wr={class:"space-y-2"},_r={class:"w-8 h-8 rounded-full bg-bg-secondary border-thin border-border-light flex items-center justify-center text-text-secondary text-sm"},vr={class:"flex-1"},hr={class:"text-sm text-text-primary"},gr={key:0,class:"text-xs text-text-secondary ml-2"},pr={class:"mb-6 text-sm text-text-secondary"},yr={class:"space-y-3"},Rr=["disabled"],Er={key:1,class:"text-sm text-text-secondary text-center"},Sr=["disabled"],xr={key:0,class:"mt-4 text-sm text-red-600 bg-red-50 p-2 rounded-minimal border-thin border-red-200"},br=Q({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(r,{emit:l}){const c=r,s=l,{isHost:_,canStartGame:h,leaveRoom:R,loading:y,error:g}=rr(),{startGame:a}=or();function i(t){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[t||""]||t||"未知"}function u(t){return c.room?.host_id===t}async function n(){(await a()).success&&s("startGame")}async function e(){(await R()).success&&s("leaveRoom")}return(t,o)=>(k(),N("div",sr,[v("div",nr,[v("div",ar,[v("h2",cr,S(r.room?.name),1),v("div",ir,[o[0]||(o[0]=M(" 房間碼：",-1)),v("span",ur,S(r.room?.code),1)]),v("div",lr,[o[1]||(o[1]=M(" 狀態：",-1)),v("span",dr,S(i(r.room?.status)),1)])]),v("div",mr,[v("h3",fr," 玩家列表 ("+S(r.participants.length)+") ",1),v("div",wr,[(k(!0),N(X,null,Y(r.participants,m=>(k(),N("div",{key:m.id,class:"flex items-center gap-3 p-2 rounded-minimal border-thin border-border-light"},[v("div",_r,S(m.nickname.charAt(0)),1),v("div",vr,[v("div",hr,[M(S(m.nickname)+" ",1),u(m.user_id)?(k(),N("span",gr," (房主) ")):W("",!0)])])]))),128))])]),v("div",pr,[v("div",null,"繪畫時間："+S(r.room?.settings.draw_time)+" 秒",1),v("div",null,"輪數："+S(r.room?.settings.rounds)+" 輪",1),v("div",null,"詞語總數："+S(r.room?.word_count)+" 個",1)]),v("div",yr,[G(_)&&G(h)?(k(),N("button",{key:0,onClick:n,disabled:G(y),class:"btn-minimal w-full"},S(G(y)?"開始中...":"開始遊戲"),9,Rr)):G(_)?(k(),N("div",Er," 至少需要 2 個玩家才能開始遊戲 ")):W("",!0),v("button",{onClick:e,disabled:G(y),class:"btn-minimal w-full"},S(G(y)?"離開中...":"離開房間"),9,Sr)]),G(g)?(k(),N("div",xr,S(G(g)),1)):W("",!0)])]))}}),Dr=Z(br,[["__scopeId","data-v-501d8817"]]);export{Dr as W,or as a,T as b,er as c,V as d,rr as u};
