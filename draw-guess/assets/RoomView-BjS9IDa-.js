import{m as re,r as S,d as E,u as P,i as O,j as q,c as f,e,o as _,_ as N,f as $,a as T,n as L,F as H,p as K,q as z,g as Q,t as k,v as Z,b as u,s as B,x as le,y as ce,k as M,z as de,w as ue,A as he}from"./index-rfaaJL8p.js";import{c as V,b as U,d as Y,e as ee,a as me,u as ve,W as fe}from"./useRealtime-CdN57ZkP.js";const te=re("drawing",()=>{const t=S("pen"),s=S("#000000"),r=S(3),o=S(!1),l=S([]);function n(i){t.value=i}function h(i){s.value=i}function g(i){r.value=Math.max(1,Math.min(20,i))}function w(i){l.value.push(i)}function y(){l.value=[]}function x(i){o.value=i}return{tool:t,color:s,lineWidth:r,isDrawing:o,strokes:l,setTool:n,setColor:h,setLineWidth:g,addStroke:w,clearStrokes:y,setDrawing:x}});function J(t,s){const r=t.getBoundingClientRect(),o=t.width/r.width,l=t.height/r.height;let n,h;if(s instanceof MouseEvent)n=s.clientX,h=s.clientY;else if(s instanceof TouchEvent&&s.touches.length>0&&s.touches[0])n=s.touches[0].clientX,h=s.touches[0].clientY;else return null;return{x:(n-r.left)*o,y:(h-r.top)*l}}function se(t,s){if(!(s.points.length<2)){t.save(),s.tool==="pen"?(t.strokeStyle=s.color,t.lineWidth=s.lineWidth,t.lineCap="round",t.lineJoin="round"):s.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=s.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),s.points[0]&&t.moveTo(s.points[0].x,s.points[0].y);for(let r=1;r<s.points.length;r++){const o=s.points[r];o&&t.lineTo(o.x,o.y)}t.stroke(),t.restore()}}function X(t,s){const r=t.getContext("2d");r&&(r.clearRect(0,0,t.width,t.height),r.fillStyle="#FFFFFF",r.fillRect(0,0,t.width,t.height),s.forEach(o=>{se(r,o)}))}function _e(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function oe(){const t=te(),s=V(),{sendDrawing:r}=U(),o=S(null),l=S(null),n=S(null),h=S(null);let g=null;const w=50;function y(c){o.value=c;const v=c.getContext("2d",{willReadFrequently:!0});if(!v){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}l.value=v;const a=window.devicePixelRatio||1,G=c.getBoundingClientRect();c.width=G.width*a,c.height=G.height*a,v.scale(a,a),v.canvas.width=G.width,v.canvas.height=G.height,v.fillStyle="#FFFFFF",v.fillRect(0,0,c.width,c.height),o.value&&X(o.value,t.strokes)}function x(c){if(!o.value)return;c.preventDefault(),t.setDrawing(!0);const v=J(o.value,c);v&&(n.value={id:_e(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[v],timestamp:Date.now()},h.value=v)}function i(c){if(!o.value||!l.value||!t.isDrawing||!n.value)return;c.preventDefault();const v=J(o.value,c);if(!v||!h.value)return;const a=l.value;a.save(),n.value.tool==="pen"?(a.strokeStyle=n.value.color,a.lineWidth=n.value.lineWidth,a.lineCap="round",a.lineJoin="round"):n.value.tool==="eraser"&&(a.globalCompositeOperation="destination-out",a.lineWidth=n.value.lineWidth,a.lineCap="round",a.lineJoin="round"),a.beginPath(),a.moveTo(h.value.x,h.value.y),a.lineTo(v.x,v.y),a.stroke(),a.restore(),n.value.points.push(v),h.value=v,g===null&&(g=window.setTimeout(()=>{d(),g=null},w))}function R(){!t.isDrawing||!n.value||(t.setDrawing(!1),g&&(clearTimeout(g),g=null),d(),n.value=null,h.value=null)}async function d(){if(!(!n.value||!s.currentRoom))try{await r(s.currentRoom.code,n.value)}catch(c){console.error("ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",c)}}function b(c){!o.value||!l.value||(t.addStroke(c),se(l.value,c))}function m(){if(!o.value||!l.value)return;const c=l.value,v=o.value;c.clearRect(0,0,v.width,v.height),c.fillStyle="#FFFFFF",c.fillRect(0,0,v.width,v.height),t.clearStrokes()}function p(c){t.setTool(c)}function D(c){t.setColor(c)}function W(c){t.setLineWidth(c)}function F(){o.value&&X(o.value,t.strokes)}return{canvasRef:o,initCanvas:y,startDrawing:x,draw:i,stopDrawing:R,clearCanvas:m,setTool:p,setColor:D,setLineWidth:W,handleDrawingData:b,redrawStrokes:F}}const ge={class:"drawing-canvas-container"},pe=E({__name:"DrawingCanvas",setup(t){const{initCanvas:s,startDrawing:r,draw:o,stopDrawing:l,handleDrawingData:n}=oe(),h=V(),g=P(),{subscribeDrawing:w,unsubscribeRoom:y}=U(),x=S(null);function i(F){r(F)}function R(F){o(F)}function d(){l()}function b(){l()}function m(F){r(F)}function p(F){o(F)}function D(){l()}function W(){!h.currentRoom||!g.user||w(h.currentRoom.code,F=>{n(F)})}return O(()=>{x.value&&s(x.value),W()}),q(()=>{h.currentRoom&&y(h.currentRoom.code)}),(F,c)=>(_(),f("div",ge,[e("canvas",{ref_key:"canvasElement",ref:x,class:"drawing-canvas",onMousedown:i,onMousemove:R,onMouseup:d,onMouseleave:b,onTouchstart:m,onTouchmove:p,onTouchend:D},null,544)]))}}),be=N(pe,[["__scopeId","data-v-c0c7c5de"]]),we={class:"drawing-toolbar"},ye={class:"margin-bottom-small"},xe={key:0,class:"margin-bottom-small"},Fe={class:"row",style:{"margin-top":"0.5rem"}},Ce=["onClick","aria-label"],ke={class:"margin-top-small"},Se={class:"margin-bottom-small"},Re={class:"text-small"},De=E({__name:"DrawingToolbar",setup(t){const s=te(),{setTool:r,setColor:o,setLineWidth:l,clearCanvas:n}=oe(),h=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],g=$(()=>s.tool),w=$(()=>s.color),y=$({get:()=>s.lineWidth,set:b=>s.setLineWidth(b)});function x(){l(y.value)}function i(b){r(b)}function R(b){o(b)}function d(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&n()}return(b,m)=>(_(),f("div",we,[e("div",ye,[e("button",{onClick:m[0]||(m[0]=p=>i("pen")),class:L(["paper-btn btn-block margin-bottom-small",g.value==="pen"?"btn-primary":"btn-secondary"]),title:"ç•«ç­†"}," âœï¸ ç•«ç­† ",2),e("button",{onClick:m[1]||(m[1]=p=>i("eraser")),class:L(["paper-btn btn-block",g.value==="eraser"?"btn-danger":"btn-secondary"]),title:"æ©¡çš®æ“¦"}," ğŸ§¹ æ©¡çš®æ“¦ ",2)]),g.value==="pen"?(_(),f("div",xe,[m[4]||(m[4]=e("label",{class:"text-small"},"é¡è‰²",-1)),e("div",Fe,[(_(),f(H,null,K(h,p=>e("div",{key:p,onClick:D=>R(p),class:L(["col-3",w.value===p?"border":""]),style:z({backgroundColor:p,width:"30px",height:"30px",cursor:"pointer",border:w.value===p?"3px solid #41403e":"1px solid #ddd",margin:"2px"}),"aria-label":`é¸æ“‡é¡è‰² ${p}`},null,14,Ce)),64))]),e("div",ke,[m[3]||(m[3]=e("label",{class:"text-small"},"ç•¶å‰é¡è‰²",-1)),e("div",{class:"border",style:z([{width:"100%",height:"50px","margin-top":"0.5rem"},{backgroundColor:w.value}])},null,4)])])):T("",!0),e("div",Se,[e("label",Re,"ç•«ç­†å¤§å°: "+k(y.value)+"px",1),Q(e("input",{"onUpdate:modelValue":m[2]||(m[2]=p=>y.value=p),onInput:x,type:"range",min:"1",max:"20",class:"margin-top-small"},null,544),[[Z,y.value,void 0,{number:!0}]])]),e("div",null,[e("button",{onClick:d,class:"paper-btn btn-danger btn-block",title:"æ¸…ç©ºç•«å¸ƒ"}," ğŸ—‘ï¸ æ¸…ç©º ")])]))}}),We=N(De,[["__scopeId","data-v-4f30b3df"]]),Te={class:"player-list"},$e={class:"col-2"},Ge={class:"col-8"},Le={class:"text-hand"},Me={key:0,class:"badge warning"},Ee={key:1,class:"text-small"},Pe={class:"text-small"},Ve={key:0,class:"alert alert-success margin-top-medium"},Ie={class:"text-hand-title"},ze={class:"text-small margin-top-small"},Be=E({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(t){const s=V(),r=Y(),o=P(),{playerRankings:l,winner:n}=ee(),h=$(()=>l.value);function g(i){return s.participants.find(d=>d.user_id===i)?.nickname||"æœªçŸ¥ç©å®¶"}function w(i){return o.user?.id===i}function y(i){return s.currentRoom?.host_id===i}function x(i){return r.currentRound?.drawer_id===i}return(i,R)=>(_(),f("div",Te,[(_(!0),f(H,null,K(h.value,d=>(_(),f("div",{key:d.id,class:L(["row flex-middle margin-bottom-small border-bottom",w(d.user_id)?"border-primary":""]),style:{"padding-bottom":"10px"}},[e("div",$e,[e("div",{class:L(["border",x(d.user_id)?"border-warning":""]),style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center",background:"#f4f4f4"}},k(g(d.user_id).charAt(0)),3)]),e("div",Ge,[e("div",Le,[B(k(g(d.user_id))+" ",1),x(d.user_id)?(_(),f("span",Me,"ç•«å®¶")):T("",!0),y(d.user_id)?(_(),f("span",Ee,"(æˆ¿ä¸»)")):T("",!0)]),e("div",Pe," å¾—åˆ† "+k(d.score),1)])],2))),128)),t.showWinner&&u(n)?(_(),f("div",Ve,[e("div",Ie," ğŸ† ç²å‹è€…ï¼š"+k(g(u(n).user_id)),1),e("div",ze," ç¸½åˆ†ï¼š"+k(u(n).score)+" åˆ† ",1)])):T("",!0)]))}}),j=N(Be,[["__scopeId","data-v-4abe9d45"]]);function Ne(){const t=Y(),s=P(),{calculateGuessScore:r,updatePlayerScore:o}=ee(),l=S(""),n=S(null),h=S(!1),g=$(()=>t.isCurrentDrawer?t.currentWord:null),w=$(()=>t.correctGuesses),y=$(()=>s.user?t.hasGuessed(s.user.id):!1);async function x(){if(!t.currentRound||!s.user)return n.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!l.value.trim())return n.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(l.value.length>32)return n.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(y.value)return n.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return n.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{h.value=!0,n.value=null;const d=l.value.trim(),b=t.currentWord||"",m=i(d,b),p=m?r(w.value.length):0,{data:D,error:W}=await le.from("guesses").insert({round_id:t.currentRound.id,user_id:s.user.id,guess_text:d,is_correct:m,score_earned:p}).select().single();if(W)throw W;return t.guesses.push(D),m&&s.user&&await o(s.user.id,p),m&&(l.value=""),{success:!0,isCorrect:m,guess:D}}catch(d){return n.value=d instanceof Error?d.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",d),{success:!1,error:n.value}}finally{h.value=!1}}function i(d,b){const m=d.trim(),p=b.trim();return m===p}function R(){n.value=null}return{guessInput:l,error:n,loading:h,currentWord:g,correctGuesses:w,hasGuessed:y,submitGuess:x,clearError:R}}const Ue={class:"container margin-top-small"},Ye={style:{"min-height":"100vh"}},Ae={key:0,class:"row flex-middle flex-spaces margin-bottom-small"},Je={class:"col-6"},Xe={class:"row flex-middle"},je={class:"text-hand-title",style:{margin:"0","margin-right":"1rem"}},Oe={class:"text-small"},qe={style:{"font-family":"monospace"}},He={class:"col-6 text-right"},Ke={class:"row flex-middle flex-right"},Qe={key:0,class:"badge success margin-right-small"},Ze={key:1,class:"margin-bottom-small"},et={class:"text-hand-title"},tt={class:"text-small"},st={style:{"font-family":"monospace"}},ot={key:2,class:"row flex-center"},nt={class:"col-12 col-md-8"},it={key:3},at={class:"row"},rt={class:"col-12 col-md-3"},lt={class:"card"},ct={class:"card-body"},dt={style:{"max-height":"400px","overflow-y":"auto"}},ut={class:"col-12 col-md-6"},ht={class:"card"},mt={class:"card-body",style:{padding:"1rem"}},vt={class:"canvas-paper",style:{"min-height":"400px",display:"flex","align-items":"center","justify-content":"center",padding:"1rem"}},ft={key:0,class:"margin-top-small"},_t={class:"progress"},gt={class:"row margin-top-small"},pt={class:"col-12 col-md-8"},bt={class:"card"},wt={class:"card-body"},yt={class:"border margin-bottom-small",style:{"min-height":"60px","max-height":"100px","overflow-y":"auto",padding:"0.5rem",background:"#f4f4f4"}},xt={key:0,class:"text-center text-hand"},Ft={key:1,class:"text-center",style:{color:"#41b883"}},Ct={key:2,class:"text-center text-small"},kt={key:0},St={class:"col-8"},Rt=["disabled"],Dt={class:"col-4"},Wt=["disabled"],Tt={class:"col-12 col-md-3"},$t={class:"card"},Gt={class:"card-body"},Lt={key:4,class:"row flex-center"},Mt={class:"col-12 col-md-8"},Et={class:"card"},Pt={class:"card-body text-center"},zt=E({__name:"RoomView",setup(t){const s=ce(),r=V(),o=Y(),l=P(),{subscribeRoom:n,subscribeGuesses:h,unsubscribeRoom:g}=U(),{isPlaying:w,isWaiting:y,isFinished:x,timeRemaining:i,isCountingDown:R,formattedTime:d,isCurrentDrawer:b,drawTime:m,startGame:p}=me(),{hasGuessed:D,guessInput:W,submitGuess:F,loading:c}=Ne(),{leaveRoom:v}=ve(),a=$(()=>r.currentRoom),G=$(()=>c.value);async function ne(){await F()}async function ie(){(await p()).success}async function A(){(await v()).success}return O(async()=>{s.params.code&&a.value,a.value&&l.user&&(await o.loadCurrentRound(a.value.id),n(a.value.code,a.value.id,l.user.id,{nickname:l.profile?.display_name||"ç©å®¶"}),o.currentRound&&h(a.value.code,o.currentRound.id))}),q(()=>{a.value&&g(a.value.code)}),(I,C)=>(_(),f("div",Ue,[e("div",Ye,[u(w)?(_(),f("div",Ae,[e("div",Je,[e("div",Xe,[e("h1",je,k(a.value?.name||"éŠæˆ²æˆ¿é–“"),1),e("div",Oe,[C[1]||(C[1]=B(" æˆ¿é–“ç¢¼ï¼š",-1)),e("span",qe,k(a.value?.code),1)])])]),e("div",He,[e("div",Ke,[u(b)&&u(o).currentWord?(_(),f("div",Qe,k(u(o).currentWord),1)):T("",!0),u(R)?(_(),f("div",{key:1,class:L(["badge margin-right-small",u(i)&&u(i)<=10?"badge-danger":"badge-secondary"]),style:{"font-size":"1.2rem","font-family":"var(--font-head)"}},k(u(d)),3)):T("",!0),e("button",{onClick:A,class:"paper-btn btn-small",title:"é›¢é–‹æˆ¿é–“"}," âœ• ")])])])):(_(),f("div",Ze,[e("h1",et,k(a.value?.name||"éŠæˆ²æˆ¿é–“"),1),e("div",tt,[C[2]||(C[2]=B(" æˆ¿é–“ç¢¼ï¼š",-1)),e("span",st,k(a.value?.code),1)])])),u(y)?(_(),f("div",ot,[e("div",nt,[M(fe,{room:a.value,participants:u(r).participants,onStartGame:ie,onLeaveRoom:A},null,8,["room","participants"])])])):u(w)?(_(),f("div",it,[e("div",at,[e("div",rt,[e("div",lt,[e("div",ct,[C[3]||(C[3]=e("h4",{class:"card-title text-hand-title"},"ç©å®¶åˆ—è¡¨",-1)),e("div",dt,[M(j,{"show-winner":!1})])])])]),e("div",ut,[e("div",ht,[e("div",mt,[e("div",vt,[M(be,{style:{width:"100%",height:"100%","max-width":"100%","max-height":"100%"}})])])]),u(R)&&u(i)!==null?(_(),f("div",ft,[e("div",_t,[e("div",{class:L(["bar",u(i)<=10?"bar-danger":"bar-success"]),style:z({width:`${u(i)/u(m)*100}%`})},null,6)])])):T("",!0),e("div",gt,[e("div",pt,[e("div",bt,[e("div",wt,[C[4]||(C[4]=e("h5",{class:"text-hand-title"},"ç­”æ¡ˆ",-1)),e("div",yt,[u(b)?(_(),f("div",xt," è¼ªåˆ°ä½ äº†ï¼ ")):u(D)?(_(),f("div",Ft," å·²çŒœä¸­ï¼ ")):(_(),f("div",Ct," ç­‰å¾…ç©å®¶åŠ å…¥... "))]),u(b)?T("",!0):(_(),f("div",kt,[e("form",{onSubmit:ue(ne,["prevent"]),class:"row flex-middle"},[e("div",St,[Q(e("input",{"onUpdate:modelValue":C[0]||(C[0]=ae=>he(W)?W.value=ae:null),type:"text",placeholder:"è¼ªåˆ°ä½ äº†",maxlength:"32",disabled:G.value||u(D)},null,8,Rt),[[Z,u(W)]])]),e("div",Dt,[e("button",{type:"submit",disabled:G.value||u(D)||!u(W).trim(),class:"paper-btn btn-primary btn-block"},k(G.value?"æäº¤ä¸­...":u(D)?"å·²çŒœä¸­":"æäº¤"),9,Wt)])],32)]))])])]),C[5]||(C[5]=de('<div class="col-12 col-md-4"><div class="card"><div class="card-body"><h5 class="text-hand-title">èŠå¤©å®¤</h5><div class="border" style="min-height:60px;max-height:100px;overflow-y:auto;padding:0.5rem;background:#f4f4f4;"><div class="text-center text-small">èŠå¤©åŠŸèƒ½å³å°‡æ¨å‡º</div></div></div></div></div>',1))])]),e("div",Tt,[e("div",$t,[e("div",Gt,[M(We)])])])])])):u(x)?(_(),f("div",Lt,[e("div",Mt,[e("div",Et,[e("div",Pt,[C[6]||(C[6]=e("h2",{class:"card-title text-hand-title"},"éŠæˆ²çµæŸ",-1)),M(j,{"show-winner":!0})])])])])):T("",!0)])]))}});export{zt as default};
