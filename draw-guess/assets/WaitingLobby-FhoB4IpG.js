import{l as de,r as C,f as p,u as Y,x as R,m as ge,d as we,c as K,e as G,a as re,t as A,s as se,F as ve,p as he,b as j,o as F,_ as _e}from"./index-RTQFg-in.js";const X=de("room",()=>{const e=C(null),g=C([]),s=C(!1),u=C(null),w=p(()=>{const r=Y();return e.value?.host_id===r.user?.id});async function S(r){try{s.value=!0,u.value=null;const t=Y();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(c){console.warn("載入用戶資料時發生錯誤（非關鍵）:",c)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");if(r.settings.rounds>r.words.length)throw new Error("輪數不能超過詞語總數");let n=null,a=0;const d=10;for(;a<d&&!n;){a++;const q={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:f,error:x}=await R.from("game_rooms").insert(q).select().single();if(x){if(x.code==="23505")continue;throw new Error(x.message||"插入房間失敗")}if(f){n=f;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const D={room_id:n.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:c}=await R.from("room_participants").insert(D);c&&console.error("創建參與記錄錯誤:",c)}catch(c){console.error("創建參與記錄時發生錯誤:",c)}try{const{data:c,error:q}=await R.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});q?console.error("載入參與者列表失敗:",q):c&&(g.value=c)}catch(c){console.error("載入參與者列表時發生錯誤:",c)}return e.value=n,{success:!0,room:n}}catch(t){return u.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:u.value}}finally{s.value=!1}}async function N(r,t){try{s.value=!0,u.value=null;const n=Y();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:a,error:d}=await R.from("game_rooms").select("*").eq("code",r).single();if(d||!a)throw new Error("房間不存在");if(a.status!=="waiting")throw new Error("房間已開始或已結束");const{data:D}=await R.from("room_participants").select("*").eq("room_id",a.id).eq("user_id",n.user.id).maybeSingle();if(D)return e.value=a,await h(a.id),{success:!0,room:a};const{error:c}=await R.from("room_participants").insert({room_id:a.id,user_id:n.user.id,nickname:t.trim(),score:0});if(c){if(c.code==="23505"||c.message.includes("duplicate"))return e.value=a,await h(a.id),{success:!0,room:a};throw c}return e.value=a,await h(a.id),{success:!0,room:a}}catch(n){return u.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:u.value}}finally{s.value=!1}}async function k(){try{if(!e.value)return{success:!0};s.value=!0,u.value=null;const r=Y();if(!r.user)throw new Error("請先登入");const{error:t}=await R.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(w.value){const{error:n}=await R.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,g.value=[],{success:!0}}catch(r){return u.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,g.value=[],{success:!1,error:u.value}}finally{s.value=!1}}async function h(r){try{const{data:t,error:n}=await R.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(n)throw n;g.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function l(r){try{s.value=!0,u.value=null;const{data:t,error:n}=await R.from("game_rooms").select("*").eq("id",r).single();if(n)throw n;return e.value=t,await h(r),{success:!0,room:t}}catch(t){return u.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:u.value}}finally{s.value=!1}}async function m(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await R.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(e.value){const n=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:u.value}}}async function _(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await R.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:u.value}}}function b(){e.value=null,g.value=[],u.value=null}function O(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function T(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!w.value)return{success:!1,error:"只有房主可以踢人"};const t=Y();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};s.value=!0,u.value=null;const{data:n,error:a}=await R.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(a)throw new Error(a.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await h(e.value.id),{success:!0}}catch(t){return u.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:u.value}}finally{s.value=!1}}return{currentRoom:e,participants:g,loading:s,error:u,isHost:w,createRoom:S,joinRoom:N,leaveRoom:k,kickPlayer:T,loadParticipants:h,loadRoom:l,updateRoomStatus:m,updateRoomDrawer:_,setCurrentDrawer:O,clearRoom:b}});function pe(){const e=X(),g=p(()=>e.currentRoom),s=p(()=>e.participants),u=p(()=>e.isHost),w=p(()=>!g.value||g.value.status!=="waiting"||!u.value?!1:s.value.length>=2);async function S(h){return await e.createRoom(h)}async function N(h,l){return await e.joinRoom(h,l)}async function k(){return await e.leaveRoom()}return{currentRoom:g,participants:s,isHost:u,canStartGame:w,loading:p(()=>e.loading),error:p(()=>e.error),createRoom:S,joinRoom:N,leaveRoom:k}}const ae=100,ce=50,ue=10,Re=10,ie=100,le=[1,.8,.6,.4,.2];function ye(){const e=X();function g(l){const m=Math.min(l,le.length-1),_=le[m]??0;return Math.round(ae*_)}function s(l,m=0){if(l===0)return 0;const _=l*ue,b=Math.round(m*Re);return ce+_+b}async function u(l,m,_=0){const b=s(m,_);return b===0?!0:await w(l,b)}async function w(l,m){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:_,error:b}=await R.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",l).single();if(b)throw b;const O=(_?.score||0)+m,{error:T}=await R.from("room_participants").update({score:O}).eq("room_id",e.currentRoom.id).eq("user_id",l);if(T)throw T;const r=e.participants.findIndex(t=>t.user_id===l);return r!==-1&&e.participants[r]&&(e.participants[r].score=O),!0}catch(_){return console.error("更新玩家分數錯誤:",_),!1}}function S(){if(!e.participants||e.participants.length===0)return null;const l=[...e.participants].sort((m,_)=>_.score-m.score);return l.length===1||l[0]&&l[1]&&l[0].score>l[1].score?{user_id:l[0]?.user_id||"",score:l[0]?.score||0}:{user_id:l[0]?.user_id||"",score:l[0]?.score||0}}const N=p(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((m,_)=>_.score!==m.score?_.score-m.score:new Date(m.joined_at).getTime()-new Date(_.joined_at).getTime()).map((m,_)=>({id:m.id,user_id:m.user_id,score:m.score,rank:_+1}))),k=p(()=>e.currentRoom?.status!=="finished"?null:S());function h(){return ie}return{GUESS_BASE_SCORE:ae,DRAWING_BASE_SCORE:ce,DRAWING_BONUS_PER_GUESS:ue,WINNER_BONUS:ie,calculateGuessScore:g,calculateDrawingScore:s,calculateWinner:S,updatePlayerScore:w,updateDrawerScore:u,playerRankings:N,winner:k,getWinnerBonus:h}}const fe=de("game",()=>{const e=X(),g=Y(),s=C(null),u=C(null),w=C([]),S=p(()=>w.value.filter(i=>i.is_correct)),N=p(()=>s.value?w.value.filter(i=>i.round_id===s.value.id):[]),k=p(()=>N.value.filter(i=>i.is_correct)),h=C("drawing"),l=C([]),m=C([]),_=p(()=>m.value.length===0?0:m.value.reduce((o,y)=>o+y.rating,0)/m.value.length);function b(i){h.value=i}function O(i){l.value=i}function T(i){const o=m.value.findIndex(y=>y.rater_id===i.rater_id);o>=0?m.value[o]=i:m.value.push(i)}function r(){m.value=[]}async function t(i){try{const{data:o,error:y}=await R.from("game_rounds").select("*").eq("room_id",i).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(y)throw y;if(o){if(s.value=o,u.value=o.word_text,o.status){const E=h.value==="selecting",I=o.status==="completed";E&&I||(h.value=o.status)}o.word_options&&Array.isArray(o.word_options)&&(l.value=o.word_options),await n(o.id)}return{success:!0,round:o}}catch(o){return console.error("載入當前輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入輪次失敗"}}}async function n(i){try{const{data:o,error:y}=await R.from("guesses").select("*").eq("round_id",i).order("guessed_at",{ascending:!0});if(y)throw y;const E=o||[],I=new Set(w.value.map(H=>H.id)),B=E.filter(H=>!I.has(H.id));B.length>0&&(w.value=[...w.value,...B])}catch(o){console.error("載入猜測記錄錯誤:",o)}}async function a(i){try{const{data:o,error:y}=await R.from("game_rounds").select("id").eq("room_id",i);if(y)throw y;if(!o||o.length===0){w.value=[];return}const E=o.map(H=>H.id),{data:I,error:B}=await R.from("guesses").select("*").in("round_id",E).order("guessed_at",{ascending:!0});if(B)throw B;w.value=I||[]}catch(o){console.error("載入所有猜測記錄錯誤:",o)}}async function d(i,o,y,E){try{if(!e.currentRoom)throw new Error("沒有當前房間");const I=(e.currentRoom.current_round||0)+1,{data:B,error:H}=await R.from("game_rounds").insert({room_id:i,round_number:I,drawer_id:o,word_text:y,word_source:E}).select().single();if(H)throw H;return s.value=B,u.value=y,await R.from("game_rooms").update({current_round:I,current_drawer_id:o}).eq("id",i),{success:!0,round:B}}catch(I){return console.error("創建輪次錯誤:",I),{success:!1,error:I instanceof Error?I.message:"創建輪次失敗"}}}function D(i){return s.value?w.value.some(o=>o.round_id===s.value.id&&o.user_id===i&&o.is_correct):!1}const c=p(()=>!s.value||!g.user?!1:s.value.drawer_id===g.user.id);async function q(){if(!s.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const i=S.value.length,o=_.value,{updateDrawerScore:y}=ye();console.log("[endRound] 猜中人數:",i,"平均評分:",o),await y(s.value.drawer_id,i,o);const{error:E}=await R.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",s.value.id);if(E)throw E;return{success:!0}}catch(i){return console.error("結束輪次錯誤:",i),{success:!1,error:i instanceof Error?i.message:"結束輪次失敗"}}}function f(){s.value=null,u.value=null,w.value=[],h.value="drawing",l.value=[],m.value=[]}async function x(i,o,y){if(!g.user)return{success:!1,error:"用戶未登錄"};try{const{data:E,error:I}=await R.from("drawing_ratings").upsert({round_id:i,rater_id:g.user.id,drawer_id:o,rating:y},{onConflict:"round_id,rater_id"}).select().single();if(I)throw I;return E&&T(E),{success:!0,rating:E}}catch(E){return console.error("提交評分錯誤:",E),{success:!1,error:E instanceof Error?E.message:"提交評分失敗"}}}async function J(i){try{const{data:o,error:y}=await R.from("drawing_ratings").select("*").eq("round_id",i);if(y)throw y;return m.value=o||[],{success:!0,ratings:o}}catch(o){return console.error("載入評分錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入評分失敗"}}}return{currentRound:s,currentWord:u,guesses:w,correctGuesses:S,currentRoundGuesses:N,currentRoundCorrectGuesses:k,isCurrentDrawer:c,roundStatus:h,wordOptions:l,ratings:m,averageRating:_,loadCurrentRound:t,loadGuesses:n,loadAllGuesses:a,createRound:d,hasGuessed:D,endRound:q,clearGame:f,setRoundStatus:b,setWordOptions:O,addRating:T,clearRatings:r,submitRating:x,loadRatings:J}}),W=new Map,L=C("disconnected"),V=new Map,Z=new Set,ee=new Map;function z(...e){}function $(...e){console.warn("[Realtime]",...e)}function te(){const e=X(),g=fe();function s(r){const t=`room:${r}`;if(W.has(t))return W.get(t);const n=R.channel(t,{config:{presence:{key:"user"},broadcast:{self:!1}}});return W.set(t,n),n}function u(r){const t=ee.get(r);t&&(clearTimeout(t),ee.delete(r))}function w(r,t,n,a,d){r==="SUBSCRIBED"?(L.value="connected",u(n),t.track({user_id:a,...d}).catch(D=>{$("Presence track 失敗:",D)})):r==="CHANNEL_ERROR"||r==="TIMED_OUT"?(L.value="disconnected",$("訂閱失敗:",r),S(n,a,d)):r==="CLOSED"&&(L.value="disconnected")}function S(r,t,n,a=0){if(a>=3){$("重連失敗次數過多，停止重連");return}u(r);const d=Math.min(1e3*Math.pow(2,a),1e4),D=window.setTimeout(()=>{const c=W.get(`room:${r}`);c&&c.state!=="joined"&&c.subscribe(q=>{q==="SUBSCRIBED"?w(q,c,r,t,n):(q==="CHANNEL_ERROR"||q==="TIMED_OUT")&&S(r,t,n,a+1)})},d);ee.set(r,D)}function N(r,t,n,a){return new Promise((d,D)=>{if(!r||!t){$("缺少 roomCode 或 roomId"),D(new Error("缺少 roomCode 或 roomId"));return}const c=s(r),q=c.state;if(q==="joined"){L.value="connected",d(c);return}if(q==="joining"){const f=setInterval(()=>{const x=c.state;x==="joined"?(clearInterval(f),d(c)):(x==="closed"||x==="errored")&&(clearInterval(f),D(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(f),c.state!=="joined"&&D(new Error("連接超時"))},5e3);return}if(Z.has(r)){L.value="connecting",c.subscribe(f=>{w(f,c,r,n,a),f==="SUBSCRIBED"?d(c):(f==="CHANNEL_ERROR"||f==="TIMED_OUT")&&D(new Error(`訂閱失敗: ${f}`))});return}c.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${t}`},async f=>{z("房間狀態變化:",f.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${t}`},async f=>{z("參與者變化:",f.eventType),await e.loadParticipants(t)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${t}`},async f=>{z("輪次變化:",f.eventType,f.new),e.currentRoom&&await g.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async f=>{const x=f.new;x&&g.currentRound&&await g.loadGuesses(x.round_id)}).on("broadcast",{event:"drawing"},f=>{const x=V.get(r);x&&f.payload?.stroke&&x.forEach(J=>J(f.payload.stroke))}).on("presence",{event:"sync"},()=>{const f=c.presenceState();z("Presence 同步，在線:",Object.keys(f).length)}),Z.add(r),L.value="connecting",c.subscribe(f=>{w(f,c,r,n,a),f==="SUBSCRIBED"?d(c):(f==="CHANNEL_ERROR"||f==="TIMED_OUT")&&D(new Error(`訂閱失敗: ${f}`))})})}function k(r,t){return V.has(r)||V.set(r,new Set),V.get(r).add(t),()=>{V.get(r)?.delete(t)}}function h(r,t){const n=s(r),a=`guesses:${t}`;return n[a]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${t}`},async d=>{z("收到新猜測記錄:",d.eventType,d.new),await g.loadGuesses(t)}),n[a]=!0),n}function l(r,t){const n=s(r),a=`gameState:${r}`;return n[a]||(n.on("broadcast",{event:"game_state"},d=>{z("收到遊戲狀態廣播:",d.payload),t(d.payload)}),n[a]=!0),n}async function m(r,t){const n=s(r),a=n.state;if(a!=="joined")return $("Channel 未連接，狀態:",a,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{z("廣播遊戲狀態:",t);const d=await n.send({type:"broadcast",event:"game_state",payload:t});return d==="error"?($("發送遊戲狀態失敗"),{error:"發送失敗"}):d}catch(d){return $("發送遊戲狀態錯誤:",d),{error:d instanceof Error?d.message:"發送失敗"}}}async function _(r,t){const n=s(r),a=n.state;if(a!=="joined")return $("Channel 未連接，無法發送繪畫數據，狀態:",a),{error:"Channel 未連接"};try{const d=await n.send({type:"broadcast",event:"drawing",payload:{stroke:t}});return d==="error"?($("發送失敗"),{error:"發送失敗"}):d}catch(d){return $("發送錯誤:",d),{error:d instanceof Error?d.message:"發送失敗"}}}function b(r){const t=`room:${r}`,n=W.get(t);u(r),n&&(R.removeChannel(n),W.delete(t)),V.delete(r),Z.delete(r)}function O(){ee.forEach((r,t)=>u(t)),W.forEach(r=>R.removeChannel(r)),W.clear(),V.clear(),Z.clear()}function T(){return L.value}return{connectionStatus:L,subscribeRoom:N,subscribeDrawing:k,subscribeGuesses:h,subscribeGameState:l,sendDrawing:_,broadcastGameState:m,unsubscribeRoom:b,unsubscribeAll:O,getConnectionStatus:T}}const ne=3;function Se(){const e=X(),g=fe();te();const s=C(null),u=C(!1);let w=null;const S=C(null);let N=null;const k=C(new Set),h=p(()=>e.currentRoom?.status||"waiting"),l=p(()=>h.value==="playing"),m=p(()=>h.value==="waiting"),_=p(()=>h.value==="finished"),b=p(()=>g.roundStatus),O=p(()=>b.value==="drawing"),T=p(()=>b.value==="summary"),r=p(()=>g.currentRound),t=p(()=>e.currentRoom?.current_round||0),n=p(()=>e.currentRoom?.settings.rounds||0),a=p(()=>e.currentRoom?.settings.draw_time||60),d=p(()=>g.isCurrentDrawer);function D(v){w&&clearInterval(w),s.value=v,u.value=!0,w=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(c(),l.value&&r.value&&e.isHost&&E())},1e3)}function c(){w&&(clearInterval(w),w=null),u.value=!1}function q(){c(),s.value=null}function f(){N&&clearInterval(N),S.value=ne,console.log("[useGame] 開始總結倒計時:",ne,"秒"),N=window.setInterval(async()=>{S.value!==null&&S.value>0?S.value--:(x(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await I()))},1e3)}function x(){N&&(clearInterval(N),N=null),S.value=null}function J(){if(!e.currentRoom)return null;const v=e.currentRoom.words;if(v.length===0)return null;const U=[];for(let M=0;M<v.length;M++)k.value.has(M)||U.push(M);let P=0;if(U.length>0){const M=Math.floor(Math.random()*U.length);P=U[M]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),k.value.clear(),P=Math.floor(Math.random()*v.length);return k.value.add(P),v[P]??null}async function i(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{k.value.clear();const v=await e.updateRoomStatus("playing");return v.success?await o():v}catch(v){return console.error("開始遊戲錯誤:",v),{success:!1,error:v instanceof Error?v.message:"開始遊戲失敗"}}}async function o(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const v=e.currentRoom.current_round||0,U=v+1;if(v>=n.value)return await B(),{success:!1,error:"所有輪次已完成"};try{const P=(U-1)%e.participants.length,M=e.participants[P];if(console.log("[startDrawingPhase] 第",U,"輪，畫家:",M?.nickname),!M)throw new Error("無法選擇畫家");const Q=J();if(!Q)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",Q.text),await e.updateRoomDrawer(M.user_id);const oe=await g.createRound(e.currentRoom.id,M.user_id,Q.text,Q.source);if(!oe.success||!oe.round)throw new Error("創建輪次失敗");g.setRoundStatus("drawing"),g.clearRatings();const{broadcastGameState:me}=te();return await me(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:M.user_id,drawerName:M.nickname,roundNumber:U}),D(a.value),{success:!0,drawerId:M.user_id,word:Q.text}}catch(P){return console.error("開始繪畫階段錯誤:",P),{success:!1,error:P instanceof Error?P.message:"開始繪畫階段失敗"}}}async function y(){return await o()}async function E(){if(!r.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{c();const v=await g.endRound();if(!v.success)return v;g.setRoundStatus("summary");const{broadcastGameState:U}=te();return await U(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0}),(e.currentRoom.current_round||0)>=n.value?(setTimeout(async()=>{await B()},ne*1e3),{success:!0,gameEnded:!0}):(f(),{success:!0,gameEnded:!1})}catch(v){return console.error("結束輪次錯誤:",v),{success:!1,error:v instanceof Error?v.message:"結束輪次失敗"}}}async function I(){return e.currentRoom?(x(),(e.currentRoom.current_round||0)>=n.value?(await B(),{success:!0,gameEnded:!0}):(await o(),{success:!0,gameEnded:!1})):{success:!1,error:"沒有當前房間"}}async function B(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return c(),await e.updateRoomStatus("finished"),{success:!0}}catch(v){return console.error("結束遊戲錯誤:",v),{success:!1,error:v instanceof Error?v.message:"結束遊戲失敗"}}}const H=p(()=>{if(s.value===null)return"--:--";const v=Math.floor(s.value/60),U=s.value%60;return`${v.toString().padStart(2,"0")}:${U.toString().padStart(2,"0")}`});return ge(()=>{c(),x()}),{gameStatus:h,isPlaying:l,isWaiting:m,isFinished:_,currentRound:r,currentRoundNumber:t,totalRounds:n,drawTime:a,isCurrentDrawer:d,timeRemaining:s,isCountingDown:u,formattedTime:H,roundStatus:b,isDrawing:O,isSummary:T,summaryTimeRemaining:S,startGame:i,startNextRound:y,startDrawingPhase:o,endRound:E,continueToNextRound:I,endGame:B,startCountdown:D,stopCountdown:c,startSummaryCountdown:f,stopSummaryCountdown:x,resetCountdown:q}}const Ee={class:"waiting-lobby"},be={class:"card"},xe={class:"card-body"},Ge={class:"margin-bottom-medium"},Ne={class:"card-title text-hand-title"},ke={class:"text-small"},Te={style:{"font-family":"monospace"}},De={class:"text-small margin-top-small"},Ie={class:"margin-bottom-medium"},qe={class:"text-hand-title"},Ce={class:"margin-top-small"},Me={style:{"flex-shrink":"0","margin-right":"0.75rem"}},Oe={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},Be={style:{flex:"1"}},Ue={class:"text-hand",style:{"font-weight":"500"}},Ae={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},Pe={class:"margin-bottom-medium text-small"},He=["disabled"],$e={key:1,class:"text-small text-center margin-bottom-small"},je=["disabled"],We={key:0,class:"alert alert-danger margin-top-medium"},Le=we({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:g}){const s=e,u=g,{isHost:w,canStartGame:S,leaveRoom:N,loading:k,error:h}=pe(),{startGame:l}=Se();function m(T){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[T||""]||T||"未知"}function _(T){return s.room?.host_id===T}async function b(){(await l()).success&&u("startGame")}async function O(){(await N()).success&&u("leaveRoom")}return(T,r)=>(F(),K("div",Ee,[G("div",be,[G("div",xe,[G("div",Ge,[G("h2",Ne,A(e.room?.name),1),G("div",ke,[r[0]||(r[0]=se(" 房間碼：",-1)),G("span",Te,A(e.room?.code),1)]),G("div",De," 狀態："+A(m(e.room?.status)),1)]),G("div",Ie,[G("h4",qe,"玩家列表 ("+A(e.participants.length)+")",1),G("div",Ce,[(F(!0),K(ve,null,he(e.participants,t=>(F(),K("div",{key:t.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[G("div",Me,[G("div",Oe,A(t.nickname.charAt(0).toUpperCase()),1)]),G("div",Be,[G("div",Ue,[se(A(t.nickname)+" ",1),_(t.user_id)?(F(),K("span",Ae," 房主 ")):re("",!0)])])]))),128))])]),G("div",Pe,[G("div",null,"繪畫時間："+A(e.room?.settings.draw_time)+" 秒",1),G("div",null,"輪數："+A(e.room?.settings.rounds)+" 輪",1),G("div",null,"詞語總數："+A(e.room?.word_count)+" 個",1)]),G("div",null,[j(w)&&j(S)?(F(),K("button",{key:0,onClick:b,disabled:j(k),class:"paper-btn btn-primary btn-block margin-bottom-small"},A(j(k)?"開始中...":"開始遊戲"),9,He)):j(w)?(F(),K("div",$e," 至少需要 2 個玩家才能開始遊戲 ")):re("",!0),G("button",{onClick:O,disabled:j(k),class:"paper-btn btn-secondary btn-block"},A(j(k)?"離開中...":"離開房間"),9,je)]),j(h)?(F(),K("div",We,A(j(h)),1)):re("",!0)])])]))}}),Fe=_e(Le,[["__scopeId","data-v-769c8ad1"]]);export{Fe as W,Se as a,te as b,X as c,fe as d,ye as e,pe as u};
