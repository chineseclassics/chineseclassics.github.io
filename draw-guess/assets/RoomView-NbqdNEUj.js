import{m as ee,r as R,d as M,u as P,i as A,j as J,c as x,e as s,o as p,_ as I,f as W,a as F,n as G,F as j,p as N,g as X,t as b,v as O,q as te,s as se,b as l,w as ne,x as oe,y as q,z as re,k as T}from"./index-BxYlqVDm.js";import{c as L,b as V,d as B,e as H,a as ie,u as ae,W as le}from"./useRealtime-CNrGbF0R.js";const K=ee("drawing",()=>{const e=R("pen"),t=R("#000000"),i=R(3),o=R(!1),a=R([]);function n(c){e.value=c}function u(c){t.value=c}function h(c){i.value=Math.max(1,Math.min(20,c))}function w(c){a.value.push(c)}function y(){a.value=[]}function S(c){o.value=c}return{tool:e,color:t,lineWidth:i,isDrawing:o,strokes:a,setTool:n,setColor:u,setLineWidth:h,addStroke:w,clearStrokes:y,setDrawing:S}});function z(e,t){const i=e.getBoundingClientRect(),o=e.width/i.width,a=e.height/i.height;let n,u;if(t instanceof MouseEvent)n=t.clientX,u=t.clientY;else if(t instanceof TouchEvent&&t.touches.length>0&&t.touches[0])n=t.touches[0].clientX,u=t.touches[0].clientY;else return null;return{x:(n-i.left)*o,y:(u-i.top)*a}}function Q(e,t){if(!(t.points.length<2)){e.save(),t.tool==="pen"?(e.strokeStyle=t.color,e.lineWidth=t.lineWidth,e.lineCap="round",e.lineJoin="round"):t.tool==="eraser"&&(e.globalCompositeOperation="destination-out",e.lineWidth=t.lineWidth,e.lineCap="round",e.lineJoin="round"),e.beginPath(),t.points[0]&&e.moveTo(t.points[0].x,t.points[0].y);for(let i=1;i<t.points.length;i++){const o=t.points[i];o&&e.lineTo(o.x,o.y)}e.stroke(),e.restore()}}function U(e,t){const i=e.getContext("2d");i&&(i.clearRect(0,0,e.width,e.height),i.fillStyle="#FFFFFF",i.fillRect(0,0,e.width,e.height),t.forEach(o=>{Q(i,o)}))}function ue(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Z(){const e=K(),t=L(),{sendDrawing:i}=V(),o=R(null),a=R(null),n=R(null),u=R(null);let h=null;const w=50;function y(d){o.value=d;const f=d.getContext("2d",{willReadFrequently:!0});if(!f){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}a.value=f;const _=window.devicePixelRatio||1,E=d.getBoundingClientRect();d.width=E.width*_,d.height=E.height*_,f.scale(_,_),f.canvas.width=E.width,f.canvas.height=E.height,f.fillStyle="#FFFFFF",f.fillRect(0,0,d.width,d.height),o.value&&U(o.value,e.strokes)}function S(d){if(!o.value)return;d.preventDefault(),e.setDrawing(!0);const f=z(o.value,d);f&&(n.value={id:ue(),tool:e.tool,color:e.color,lineWidth:e.lineWidth,points:[f],timestamp:Date.now()},u.value=f)}function c(d){if(!o.value||!a.value||!e.isDrawing||!n.value)return;d.preventDefault();const f=z(o.value,d);if(!f||!u.value)return;const _=a.value;_.save(),n.value.tool==="pen"?(_.strokeStyle=n.value.color,_.lineWidth=n.value.lineWidth,_.lineCap="round",_.lineJoin="round"):n.value.tool==="eraser"&&(_.globalCompositeOperation="destination-out",_.lineWidth=n.value.lineWidth,_.lineCap="round",_.lineJoin="round"),_.beginPath(),_.moveTo(u.value.x,u.value.y),_.lineTo(f.x,f.y),_.stroke(),_.restore(),n.value.points.push(f),u.value=f,h===null&&(h=window.setTimeout(()=>{r(),h=null},w))}function $(){!e.isDrawing||!n.value||(e.setDrawing(!1),h&&(clearTimeout(h),h=null),r(),n.value=null,u.value=null)}async function r(){if(!(!n.value||!t.currentRoom))try{await i(t.currentRoom.code,n.value)}catch(d){console.error("ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",d)}}function m(d){!o.value||!a.value||(e.addStroke(d),Q(a.value,d))}function v(){if(!o.value||!a.value)return;const d=a.value,f=o.value;d.clearRect(0,0,f.width,f.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,f.width,f.height),e.clearStrokes()}function g(d){e.setTool(d)}function D(d){e.setColor(d)}function C(d){e.setLineWidth(d)}function k(){o.value&&U(o.value,e.strokes)}return{canvasRef:o,initCanvas:y,startDrawing:S,draw:c,stopDrawing:$,clearCanvas:v,setTool:g,setColor:D,setLineWidth:C,handleDrawingData:m,redrawStrokes:k}}const ce={class:"drawing-canvas-container"},de=M({__name:"DrawingCanvas",setup(e){const{initCanvas:t,startDrawing:i,draw:o,stopDrawing:a,handleDrawingData:n}=Z(),u=L(),h=P(),{subscribeDrawing:w,unsubscribeRoom:y}=V(),S=R(null);function c(k){i(k)}function $(k){o(k)}function r(){a()}function m(){a()}function v(k){i(k)}function g(k){o(k)}function D(){a()}function C(){!u.currentRoom||!h.user||w(u.currentRoom.code,k=>{n(k)})}return A(()=>{S.value&&t(S.value),C()}),J(()=>{u.currentRoom&&y(u.currentRoom.code)}),(k,d)=>(p(),x("div",ce,[s("canvas",{ref_key:"canvasElement",ref:S,class:"drawing-canvas",onMousedown:c,onMousemove:$,onMouseup:r,onMouseleave:m,onTouchstart:v,onTouchmove:g,onTouchend:D},null,544)]))}}),me=I(de,[["__scopeId","data-v-fad5efac"]]),fe={class:"drawing-toolbar"},he={class:"flex gap-2 mb-4"},ve={key:0,class:"mb-4"},_e={class:"flex gap-2 flex-wrap"},xe=["onClick","aria-label"],pe={class:"mb-4"},ge={class:"block text-xs text-text-secondary mb-2"},be=M({__name:"DrawingToolbar",setup(e){const t=K(),{setTool:i,setColor:o,setLineWidth:a,clearCanvas:n}=Z(),u=["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#808080"],h=W(()=>t.tool),w=W(()=>t.color),y=W({get:()=>t.lineWidth,set:m=>t.setLineWidth(m)});function S(){a(y.value)}function c(m){i(m)}function $(m){o(m)}function r(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&n()}return(m,v)=>(p(),x("div",fe,[s("div",he,[s("button",{onClick:v[0]||(v[0]=g=>c("pen")),class:G(["btn-minimal px-3 py-2",h.value==="pen"?"bg-bg-secondary border-border-medium":""])}," ç•«ç­† ",2),s("button",{onClick:v[1]||(v[1]=g=>c("eraser")),class:G(["btn-minimal px-3 py-2",h.value==="eraser"?"bg-bg-secondary border-border-medium":""])}," æ©¡çš®æ“¦ ",2)]),h.value==="pen"?(p(),x("div",ve,[v[3]||(v[3]=s("label",{class:"block text-xs text-text-secondary mb-2"},"é¡è‰²",-1)),s("div",_e,[(p(),x(j,null,N(u,g=>s("button",{key:g,onClick:D=>$(g),class:G(["w-8 h-8 rounded-minimal border-thin transition-all",w.value===g?"border-border-medium scale-110":"border-border-light"]),style:te({backgroundColor:g}),"aria-label":`é¸æ“‡é¡è‰² ${g}`},null,14,xe)),64))])])):F("",!0),s("div",pe,[s("label",ge," ç²—ç´°: "+b(y.value)+"px ",1),X(s("input",{"onUpdate:modelValue":v[2]||(v[2]=g=>y.value=g),onInput:S,type:"range",min:"1",max:"20",class:"w-full"},null,544),[[O,y.value,void 0,{number:!0}]])]),s("button",{onClick:r,class:"btn-minimal w-full"}," æ¸…ç©ºç•«å¸ƒ ")]))}}),we=I(be,[["__scopeId","data-v-dfbdc695"]]);function ye(){const e=B(),t=P(),{calculateGuessScore:i,updatePlayerScore:o}=H(),a=R(""),n=R(null),u=R(!1),h=W(()=>e.isCurrentDrawer?e.currentWord:null),w=W(()=>e.correctGuesses),y=W(()=>t.user?e.hasGuessed(t.user.id):!1);async function S(){if(!e.currentRound||!t.user)return n.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!a.value.trim())return n.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(a.value.length>32)return n.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(y.value)return n.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(e.isCurrentDrawer)return n.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{u.value=!0,n.value=null;const r=a.value.trim(),m=e.currentWord||"",v=c(r,m),g=v?i(w.value.length):0,{data:D,error:C}=await se.from("guesses").insert({round_id:e.currentRound.id,user_id:t.user.id,guess_text:r,is_correct:v,score_earned:g}).select().single();if(C)throw C;return e.guesses.push(D),v&&t.user&&await o(t.user.id,g),v&&(a.value=""),{success:!0,isCorrect:v,guess:D}}catch(r){return n.value=r instanceof Error?r.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",r),{success:!1,error:n.value}}finally{u.value=!1}}function c(r,m){const v=r.trim(),g=m.trim();return v===g}function $(){n.value=null}return{guessInput:a,error:n,loading:u,currentWord:h,correctGuesses:w,hasGuessed:y,submitGuess:S,clearError:$}}const $e={class:"guessing-panel"},Ce={class:"card-minimal"},Se={key:0,class:"mb-4 p-3 bg-bg-secondary rounded-minimal"},ke={class:"text-lg font-medium text-text-primary"},Re={key:1,class:"mb-4"},Fe=["disabled"],De=["disabled"],We={class:"text-xs text-text-secondary mt-1"},Te={key:2,class:"mb-4 text-sm text-red-600 bg-red-50 p-2 rounded-minimal border-thin border-red-200"},Ge={key:3,class:"mb-4"},Me={class:"text-sm font-medium text-text-primary mb-2"},Le={class:"space-y-2 max-h-48 overflow-y-auto"},Ee={class:"w-6 h-6 rounded-full bg-bg-secondary border-thin border-border-light flex items-center justify-center text-xs text-text-secondary"},Pe={class:"flex-1 text-sm text-text-primary"},Ie={class:"text-xs text-text-secondary"},je=M({__name:"GuessingPanel",setup(e){const{guessInput:t,error:i,loading:o,currentWord:a,correctGuesses:n,hasGuessed:u,submitGuess:h,clearError:w}=ye(),y=L();function S($){return y.participants.find(m=>m.user_id===$)?.nickname||"æœªçŸ¥ç©å®¶"}async function c(){await h()}return($,r)=>(p(),x("div",$e,[s("div",Ce,[l(a)?(p(),x("div",Se,[r[2]||(r[2]=s("div",{class:"text-xs text-text-secondary mb-1"},"æ‚¨è¦ç•«çš„è©èª",-1)),s("div",ke,b(l(a)),1)])):(p(),x("div",Re,[r[3]||(r[3]=s("label",{class:"block text-sm text-text-secondary mb-2"},"è¼¸å…¥æ‚¨çš„çŒœæ¸¬",-1)),s("form",{onSubmit:ne(c,["prevent"]),class:"flex gap-2"},[X(s("input",{"onUpdate:modelValue":r[0]||(r[0]=m=>oe(t)?t.value=m:null),type:"text",class:"input-minimal flex-1",placeholder:"è¼¸å…¥è©èª...",maxlength:"32",disabled:l(o)||l(u),onInput:r[1]||(r[1]=(...m)=>l(w)&&l(w)(...m))},null,40,Fe),[[O,l(t)]]),s("button",{type:"submit",disabled:l(o)||l(u)||!l(t).trim(),class:"btn-minimal px-4"},b(l(o)?"æäº¤ä¸­...":l(u)?"å·²çŒœä¸­":"æäº¤"),9,De)],32),s("div",We,b(l(t).length)+" / 32 å­—ç¬¦ ",1)])),l(i)?(p(),x("div",Te,b(l(i)),1)):F("",!0),l(n).length>0?(p(),x("div",Ge,[s("h3",Me," å·²çŒœä¸­ ("+b(l(n).length)+") ",1),s("div",Le,[(p(!0),x(j,null,N(l(n),(m,v)=>(p(),x("div",{key:m.id,class:"flex items-center gap-2 p-2 rounded-minimal border-thin border-border-light"},[s("div",Ee,b(v+1),1),s("div",Pe,b(S(m.user_id)),1),s("div",Ie," +"+b(m.score_earned)+" åˆ† ",1)]))),128))])])):F("",!0),F("",!0)])]))}}),Ne=I(je,[["__scopeId","data-v-3286644a"]]),Ve={class:"player-list"},Be={class:"card-minimal"},ze={class:"space-y-2"},Ue={class:"flex-1 min-w-0"},Ye={class:"flex items-center gap-2"},Ae={class:"w-6 h-6 rounded-full bg-bg-secondary border-thin border-border-light flex items-center justify-center text-xs text-text-secondary"},Je={class:"text-sm text-text-primary truncate"},Xe={key:0,class:"text-xs text-text-secondary ml-1"},Oe={key:1,class:"text-xs text-text-secondary ml-1"},qe={class:"inline-block"},He={key:0,class:"mt-4 p-3 bg-yellow-50 border-thin border-yellow-200 rounded-minimal"},Ke={class:"text-sm font-medium text-yellow-800 text-center"},Qe={class:"text-xs text-yellow-600 text-center mt-1"},Ze=M({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(e){const t=L(),i=B(),o=P(),{playerRankings:a,winner:n}=H(),u=W(()=>a.value);function h(c){return t.participants.find(r=>r.user_id===c)?.nickname||"æœªçŸ¥ç©å®¶"}function w(c){return o.user?.id===c}function y(c){return t.currentRoom?.host_id===c}function S(c){return i.currentRound?.drawer_id===c}return(c,$)=>(p(),x("div",Ve,[s("div",Be,[$[1]||($[1]=s("h3",{class:"text-sm font-medium text-text-primary mb-3"}," ç©å®¶æ’è¡Œæ¦œ ",-1)),s("div",ze,[(p(!0),x(j,null,N(u.value,(r,m)=>(p(),x("div",{key:r.id,class:G(["flex items-center gap-3 p-2 rounded-minimal border-thin transition-all",w(r.user_id)?"border-border-medium bg-bg-secondary":"border-border-light"])},[s("div",{class:G(["w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium",m===0?"bg-yellow-100 text-yellow-800":"bg-bg-secondary text-text-secondary"])},b(r.rank),3),s("div",Ue,[s("div",Ye,[s("div",Ae,b(h(r.user_id).charAt(0)),1),s("div",Je,[q(b(h(r.user_id))+" ",1),y(r.user_id)?(p(),x("span",Xe," (æˆ¿ä¸») ")):F("",!0),S(r.user_id)?(p(),x("span",Oe," (ç•«å®¶) ")):F("",!0)])])]),(p(),x("div",{key:`score-${r.user_id}-${r.score}`,class:"text-sm font-medium text-text-primary transition-all duration-300 score-update"},[s("span",qe,b(r.score),1),$[0]||($[0]=s("span",{class:"text-text-secondary ml-1"},"åˆ†",-1))]))],2))),128))]),e.showWinner&&l(n)?(p(),x("div",He,[s("div",Ke," ğŸ† ç²å‹è€…ï¼š"+b(h(l(n).user_id)),1),s("div",Qe," ç¸½åˆ†ï¼š"+b(l(n).score)+" åˆ† ",1)])):F("",!0)])]))}}),Y=I(Ze,[["__scopeId","data-v-c48c7659"]]),et={class:"min-h-screen bg-bg-primary"},tt={class:"container mx-auto p-4 h-screen flex flex-col"},st={class:"mb-4"},nt={class:"flex items-center justify-between mb-2"},ot={class:"text-2xl font-light text-text-primary"},rt={class:"text-sm text-text-secondary"},it={class:"font-mono"},at={key:0,class:"ml-4"},lt={key:0,class:"flex-1 flex items-center justify-center"},ut={key:1,class:"flex-1 flex gap-4 min-h-0"},ct={class:"flex-1 flex gap-4 min-w-0"},dt={class:"flex-1 flex flex-col min-w-0"},mt={class:"flex-shrink-0"},ft={class:"flex-shrink-0 flex flex-col gap-4"},ht={key:2,class:"flex-1 flex items-center justify-center"},vt={class:"text-center"},pt=M({__name:"RoomView",setup(e){const t=re(),i=L(),o=B(),a=P(),{subscribeRoom:n,subscribeGuesses:u,unsubscribeRoom:h}=V(),{isPlaying:w,isWaiting:y,isFinished:S,currentRoundNumber:c,totalRounds:$,timeRemaining:r,isCountingDown:m,formattedTime:v,startGame:g}=ie(),{leaveRoom:D}=ae(),C=W(()=>i.currentRoom);async function k(){(await g()).success}async function d(){(await D()).success}return A(async()=>{t.params.code&&C.value,C.value&&a.user&&(await o.loadCurrentRound(C.value.id),n(C.value.code,C.value.id,a.user.id,{nickname:a.profile?.display_name||"ç©å®¶"}),o.currentRound&&u(C.value.code,o.currentRound.id))}),J(()=>{C.value&&h(C.value.code)}),(f,_)=>(p(),x("div",et,[s("div",tt,[s("div",st,[s("div",nt,[s("h1",ot,b(C.value?.name||"éŠæˆ²æˆ¿é–“"),1),l(w)&&l(m)?(p(),x("div",{key:0,class:G(["text-lg font-mono",l(r)&&l(r)<=10?"text-red-600":"text-text-primary"])},b(l(v)),3)):F("",!0)]),s("div",rt,[_[0]||(_[0]=q(" æˆ¿é–“ç¢¼ï¼š",-1)),s("span",it,b(C.value?.code),1),l(w)?(p(),x("span",at," ç¬¬ "+b(l(c))+" / "+b(l($))+" è¼ª ",1)):F("",!0)])]),l(y)?(p(),x("div",lt,[T(le,{room:C.value,participants:l(i).participants,onStartGame:k,onLeaveRoom:d},null,8,["room","participants"])])):l(w)?(p(),x("div",ut,[s("div",ct,[s("div",dt,[T(me,{class:"flex-1"})]),s("div",mt,[T(we)])]),s("div",ft,[T(Ne),T(Y,{"show-winner":!1})])])):l(S)?(p(),x("div",ht,[s("div",vt,[_[1]||(_[1]=s("h2",{class:"text-2xl font-light text-text-primary mb-4"},"éŠæˆ²çµæŸ",-1)),T(Y,{"show-winner":!0})])])):F("",!0)])]))}});export{pt as default};
