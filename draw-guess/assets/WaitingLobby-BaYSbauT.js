import{l as _e,r as q,f as _,u as X,x as R,m as be,d as xe,c as V,e as G,a as ae,t as U,s as de,F as Te,p as Ge,b as j,o as z,_ as Ie}from"./index-CbPMNV7V.js";const ee=_e("room",()=>{const e=q(null),l=q([]),c=q(!1),s=q(null),h=_(()=>{const t=X();return e.value?.host_id===t.user?.id});async function E(t){try{c.value=!0,s.value=null;const r=X();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(i){console.warn("載入用戶資料時發生錯誤（非關鍵）:",i)}if(t.words.length<6)throw new Error("至少需要 6 個詞語");if(t.settings.rounds>t.words.length)throw new Error("輪數不能超過詞語總數");let n=null,a=0;const m=10;for(;a<m&&!n;){a++;const k={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null},{data:w,error:D}=await R.from("game_rooms").insert(k).select().single();if(D){if(D.code==="23505")continue;throw new Error(D.message||"插入房間失敗")}if(w){n=w;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const x={room_id:n.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:i}=await R.from("room_participants").insert(x);i&&console.error("創建參與記錄錯誤:",i)}catch(i){console.error("創建參與記錄時發生錯誤:",i)}try{const{data:i,error:k}=await R.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});k?console.error("載入參與者列表失敗:",k):i&&(l.value=i)}catch(i){console.error("載入參與者列表時發生錯誤:",i)}return e.value=n,{success:!0,room:n}}catch(r){return s.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:s.value}}finally{c.value=!1}}async function I(t,r){try{c.value=!0,s.value=null;const n=X();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:a,error:m}=await R.from("game_rooms").select("*").eq("code",t).single();if(m||!a)throw new Error("房間不存在");if(a.status!=="waiting")throw new Error("房間已開始或已結束");const{data:x}=await R.from("room_participants").select("*").eq("room_id",a.id).eq("user_id",n.user.id).maybeSingle();if(x)return e.value=a,await p(a.id),{success:!0,room:a};const{error:i}=await R.from("room_participants").insert({room_id:a.id,user_id:n.user.id,nickname:r.trim(),score:0});if(i){if(i.code==="23505"||i.message.includes("duplicate"))return e.value=a,await p(a.id),{success:!0,room:a};throw i}return e.value=a,await p(a.id),{success:!0,room:a}}catch(n){return s.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:s.value}}finally{c.value=!1}}async function b(){try{if(!e.value)return{success:!0};c.value=!0,s.value=null;const t=X();if(!t.user)throw new Error("請先登入");const{error:r}=await R.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(h.value){const{error:n}=await R.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,l.value=[],{success:!0}}catch(t){return s.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,l.value=[],{success:!1,error:s.value}}finally{c.value=!1}}async function p(t){try{const{data:r,error:n}=await R.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(n)throw n;l.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function d(t){try{c.value=!0,s.value=null;const{data:r,error:n}=await R.from("game_rooms").select("*").eq("id",t).single();if(n)throw n;return e.value=r,await p(t),{success:!0,room:r}}catch(r){return s.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:s.value}}finally{c.value=!1}}async function u(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await R.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(e.value){const n=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(r){return s.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:s.value}}}async function v(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await R.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return s.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:s.value}}}function O(){e.value=null,l.value=[],s.value=null}function P(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function N(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!h.value)return{success:!1,error:"只有房主可以踢人"};const r=X();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};c.value=!0,s.value=null;const{data:n,error:a}=await R.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(a)throw new Error(a.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await p(e.value.id),{success:!0}}catch(r){return s.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:s.value}}finally{c.value=!1}}return{currentRoom:e,participants:l,loading:c,error:s,isHost:h,createRoom:E,joinRoom:I,leaveRoom:b,kickPlayer:N,loadParticipants:p,loadRoom:d,updateRoomStatus:u,updateRoomDrawer:v,setCurrentDrawer:P,clearRoom:O}});function Ne(){const e=ee(),l=_(()=>e.currentRoom),c=_(()=>e.participants),s=_(()=>e.isHost),h=_(()=>!l.value||l.value.status!=="waiting"||!s.value?!1:c.value.length>=2);async function E(p){return await e.createRoom(p)}async function I(p,d){return await e.joinRoom(p,d)}async function b(){return await e.leaveRoom()}return{currentRoom:l,participants:c,isHost:s,canStartGame:h,loading:_(()=>e.loading),error:_(()=>e.error),createRoom:E,joinRoom:I,leaveRoom:b}}const fe=100,me=50,we=10,ge=100,ve=[1,.8,.6,.4,.2];function ke(){const e=ee();function l(d){const u=Math.min(d,ve.length-1),v=ve[u]??0;return Math.round(fe*v)}function c(d){return d===0?0:me+d*we}async function s(d,u){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:v,error:O}=await R.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",d).single();if(O)throw O;const P=(v?.score||0)+u,{error:N}=await R.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",d);if(N)throw N;const t=e.participants.findIndex(r=>r.user_id===d);return t!==-1&&e.participants[t]&&(e.participants[t].score=P),!0}catch(v){return console.error("更新玩家分數錯誤:",v),!1}}async function h(d,u){const v=c(u);return v===0?!0:await s(d,v)}function E(){if(!e.participants||e.participants.length===0)return null;const d=[...e.participants].sort((u,v)=>v.score-u.score);return d.length===1||d[0]&&d[1]&&d[0].score>d[1].score?{user_id:d[0]?.user_id||"",score:d[0]?.score||0}:{user_id:d[0]?.user_id||"",score:d[0]?.score||0}}const I=_(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((u,v)=>v.score!==u.score?v.score-u.score:new Date(u.joined_at).getTime()-new Date(v.joined_at).getTime()).map((u,v)=>({id:u.id,user_id:u.user_id,score:u.score,rank:v+1}))),b=_(()=>e.currentRoom?.status!=="finished"?null:E());function p(){return ge}return{GUESS_BASE_SCORE:fe,DRAWING_BASE_SCORE:me,DRAWING_BONUS_PER_GUESS:we,WINNER_BONUS:ge,calculateGuessScore:l,calculateDrawingScore:c,calculateWinner:E,updatePlayerScore:s,updateDrawerScore:h,playerRankings:I,winner:b,getWinnerBonus:p}}const pe=_e("game",()=>{const e=ee(),l=X(),c=q(null),s=q(null),h=q([]),E=_(()=>h.value.filter(f=>f.is_correct)),I=_(()=>c.value?h.value.filter(f=>f.round_id===c.value.id):[]),b=_(()=>I.value.filter(f=>f.is_correct)),p=q("drawing"),d=q([]),u=q([]),v=_(()=>u.value.length===0?0:u.value.reduce((o,y)=>o+y.rating,0)/u.value.length);function O(f){p.value=f}function P(f){d.value=f}function N(f){const o=u.value.findIndex(y=>y.rater_id===f.rater_id);o>=0?u.value[o]=f:u.value.push(f)}function t(){u.value=[]}async function r(f){try{const{data:o,error:y}=await R.from("game_rounds").select("*").eq("room_id",f).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(y)throw y;if(o){if(c.value=o,s.value=o.word_text,o.status){const C=p.value==="selecting",T=o.status==="completed";C&&T||(p.value=o.status)}o.word_options&&Array.isArray(o.word_options)&&(d.value=o.word_options),await n(o.id)}return{success:!0,round:o}}catch(o){return console.error("載入當前輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入輪次失敗"}}}async function n(f){try{const{data:o,error:y}=await R.from("guesses").select("*").eq("round_id",f).order("guessed_at",{ascending:!0});if(y)throw y;const C=o||[],T=new Set(h.value.map(A=>A.id)),$=C.filter(A=>!T.has(A.id));$.length>0&&(h.value=[...h.value,...$])}catch(o){console.error("載入猜測記錄錯誤:",o)}}async function a(f){try{const{data:o,error:y}=await R.from("game_rounds").select("id").eq("room_id",f);if(y)throw y;if(!o||o.length===0){h.value=[];return}const C=o.map(A=>A.id),{data:T,error:$}=await R.from("guesses").select("*").in("round_id",C).order("guessed_at",{ascending:!0});if($)throw $;h.value=T||[]}catch(o){console.error("載入所有猜測記錄錯誤:",o)}}async function m(f,o,y,C){try{if(!e.currentRoom)throw new Error("沒有當前房間");const T=(e.currentRoom.current_round||0)+1,{data:$,error:A}=await R.from("game_rounds").insert({room_id:f,round_number:T,drawer_id:o,word_text:y,word_source:C}).select().single();if(A)throw A;return c.value=$,s.value=y,await R.from("game_rooms").update({current_round:T,current_drawer_id:o}).eq("id",f),{success:!0,round:$}}catch(T){return console.error("創建輪次錯誤:",T),{success:!1,error:T instanceof Error?T.message:"創建輪次失敗"}}}function x(f){return c.value?h.value.some(o=>o.round_id===c.value.id&&o.user_id===f&&o.is_correct):!1}const i=_(()=>!c.value||!l.user?!1:c.value.drawer_id===l.user.id);async function k(){if(!c.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const f=E.value.length,{updateDrawerScore:o}=ke();await o(c.value.drawer_id,f);const{error:y}=await R.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",c.value.id);if(y)throw y;return{success:!0}}catch(f){return console.error("結束輪次錯誤:",f),{success:!1,error:f instanceof Error?f.message:"結束輪次失敗"}}}function w(){c.value=null,s.value=null,h.value=[],p.value="drawing",d.value=[],u.value=[]}async function D(f,o,y){if(!l.user)return{success:!1,error:"用戶未登錄"};try{const{data:C,error:T}=await R.from("drawing_ratings").upsert({round_id:f,rater_id:l.user.id,drawer_id:o,rating:y},{onConflict:"round_id,rater_id"}).select().single();if(T)throw T;return C&&N(C),{success:!0,rating:C}}catch(C){return console.error("提交評分錯誤:",C),{success:!1,error:C instanceof Error?C.message:"提交評分失敗"}}}async function Y(f){try{const{data:o,error:y}=await R.from("drawing_ratings").select("*").eq("round_id",f);if(y)throw y;return u.value=o||[],{success:!0,ratings:o}}catch(o){return console.error("載入評分錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入評分失敗"}}}return{currentRound:c,currentWord:s,guesses:h,correctGuesses:E,currentRoundGuesses:I,currentRoundCorrectGuesses:b,isCurrentDrawer:i,roundStatus:p,wordOptions:d,ratings:u,averageRating:v,loadCurrentRound:r,loadGuesses:n,loadAllGuesses:a,createRound:m,hasGuessed:x,endRound:k,clearGame:w,setRoundStatus:O,setWordOptions:P,addRating:N,clearRatings:t,submitRating:D,loadRatings:Y}}),L=new Map,F=q("disconnected"),J=new Map,te=new Set,ne=new Map;function Q(...e){}function B(...e){console.warn("[Realtime]",...e)}function oe(){const e=ee(),l=pe();function c(t){const r=`room:${t}`;if(L.has(r))return L.get(r);const n=R.channel(r,{config:{presence:{key:"user"},broadcast:{self:!1}}});return L.set(r,n),n}function s(t){const r=ne.get(t);r&&(clearTimeout(r),ne.delete(t))}function h(t,r,n,a,m){t==="SUBSCRIBED"?(F.value="connected",s(n),r.track({user_id:a,...m}).catch(x=>{B("Presence track 失敗:",x)})):t==="CHANNEL_ERROR"||t==="TIMED_OUT"?(F.value="disconnected",B("訂閱失敗:",t),E(n,a,m)):t==="CLOSED"&&(F.value="disconnected")}function E(t,r,n,a=0){if(a>=3){B("重連失敗次數過多，停止重連");return}s(t);const m=Math.min(1e3*Math.pow(2,a),1e4),x=window.setTimeout(()=>{const i=L.get(`room:${t}`);i&&i.state!=="joined"&&i.subscribe(k=>{k==="SUBSCRIBED"?h(k,i,t,r,n):(k==="CHANNEL_ERROR"||k==="TIMED_OUT")&&E(t,r,n,a+1)})},m);ne.set(t,x)}function I(t,r,n,a){return new Promise((m,x)=>{if(!t||!r){B("缺少 roomCode 或 roomId"),x(new Error("缺少 roomCode 或 roomId"));return}const i=c(t),k=i.state;if(k==="joined"){F.value="connected",m(i);return}if(k==="joining"){const w=setInterval(()=>{const D=i.state;D==="joined"?(clearInterval(w),m(i)):(D==="closed"||D==="errored")&&(clearInterval(w),x(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(w),i.state!=="joined"&&x(new Error("連接超時"))},5e3);return}if(te.has(t)){F.value="connecting",i.subscribe(w=>{h(w,i,t,n,a),w==="SUBSCRIBED"?m(i):(w==="CHANNEL_ERROR"||w==="TIMED_OUT")&&x(new Error(`訂閱失敗: ${w}`))});return}i.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${r}`},async w=>{Q("房間狀態變化:",w.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${r}`},async w=>{Q("參與者變化:",w.eventType),await e.loadParticipants(r)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${r}`},async w=>{Q("輪次變化:",w.eventType,w.new),e.currentRoom&&await l.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async w=>{const D=w.new;D&&l.currentRound&&await l.loadGuesses(D.round_id)}).on("broadcast",{event:"drawing"},w=>{const D=J.get(t);D&&w.payload?.stroke&&D.forEach(Y=>Y(w.payload.stroke))}).on("presence",{event:"sync"},()=>{const w=i.presenceState();Q("Presence 同步，在線:",Object.keys(w).length)}),te.add(t),F.value="connecting",i.subscribe(w=>{h(w,i,t,n,a),w==="SUBSCRIBED"?m(i):(w==="CHANNEL_ERROR"||w==="TIMED_OUT")&&x(new Error(`訂閱失敗: ${w}`))})})}function b(t,r){return J.has(t)||J.set(t,new Set),J.get(t).add(r),()=>{J.get(t)?.delete(r)}}function p(t,r){const n=c(t),a=`guesses:${r}`;return n[a]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${r}`},async m=>{Q("收到新猜測記錄:",m.eventType,m.new),await l.loadGuesses(r)}),n[a]=!0),n}function d(t,r){const n=c(t),a=`gameState:${t}`;return n[a]||(n.on("broadcast",{event:"game_state"},m=>{Q("收到遊戲狀態廣播:",m.payload),r(m.payload)}),n[a]=!0),n}async function u(t,r){const n=c(t),a=n.state;if(a!=="joined")return B("Channel 未連接，狀態:",a,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{Q("廣播遊戲狀態:",r);const m=await n.send({type:"broadcast",event:"game_state",payload:r});return m==="error"?(B("發送遊戲狀態失敗"),{error:"發送失敗"}):m}catch(m){return B("發送遊戲狀態錯誤:",m),{error:m instanceof Error?m.message:"發送失敗"}}}async function v(t,r){const n=c(t),a=n.state;if(a!=="joined")return B("Channel 未連接，無法發送繪畫數據，狀態:",a),{error:"Channel 未連接"};try{const m=await n.send({type:"broadcast",event:"drawing",payload:{stroke:r}});return m==="error"?(B("發送失敗"),{error:"發送失敗"}):m}catch(m){return B("發送錯誤:",m),{error:m instanceof Error?m.message:"發送失敗"}}}function O(t){const r=`room:${t}`,n=L.get(r);s(t),n&&(R.removeChannel(n),L.delete(r)),J.delete(t),te.delete(t)}function P(){ne.forEach((t,r)=>s(r)),L.forEach(t=>R.removeChannel(t)),L.clear(),J.clear(),te.clear()}function N(){return F.value}return{connectionStatus:F,subscribeRoom:I,subscribeDrawing:b,subscribeGuesses:p,subscribeGameState:d,sendDrawing:v,broadcastGameState:u,unsubscribeRoom:O,unsubscribeAll:P,getConnectionStatus:N}}const he=5,se=3;function De(){const e=ee(),l=pe(),c=X();oe();const s=q(null),h=q(!1);let E=null;const I=q(null);let b=null,p=null;const d=q(!1),u=q(null);let v=null;const O=_(()=>e.currentRoom?.status||"waiting"),P=_(()=>O.value==="playing"),N=_(()=>O.value==="waiting"),t=_(()=>O.value==="finished"),r=_(()=>l.roundStatus),n=_(()=>r.value==="selecting"),a=_(()=>r.value==="drawing"),m=_(()=>r.value==="summary"),x=_(()=>l.currentRound),i=_(()=>e.currentRoom?.current_round||0),k=_(()=>e.currentRoom?.settings.rounds||0),w=_(()=>e.currentRoom?.settings.draw_time||60),D=_(()=>l.wordOptions),Y=_(()=>l.isCurrentDrawer);function f(g){E&&clearInterval(E),s.value=g,h.value=!0,E=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(o(),P.value&&x.value&&e.isHost&&ie())},1e3)}function o(){E&&(clearInterval(E),E=null),h.value=!1}function y(){o(),s.value=null}function C(){if(!(e.currentRoom?.current_drawer_id===c.user?.id)){console.log("[useGame] 非畫家，不啟動選詞倒計時");return}b&&clearInterval(b),I.value=he,console.log("[useGame] 畫家開始選詞倒計時:",he,"秒"),b=window.setInterval(()=>{if(I.value!==null&&I.value>0)I.value--;else if(T(),n.value&&D.value.length>0){console.log("[useGame] 選詞超時，畫家自動選擇第一個詞");const S=D.value[0];S&&ce(S)}},1e3)}function T(){b&&(clearInterval(b),b=null),I.value=null}function $(){v&&clearInterval(v),u.value=se,console.log("[useGame] 開始總結倒計時:",se,"秒"),v=window.setInterval(async()=>{u.value!==null&&u.value>0?u.value--:(A(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await le()))},1e3)}function A(){v&&(clearInterval(v),v=null),u.value=null}function Re(){if(!e.currentRoom)return[];const g=e.currentRoom.words,M=e.currentRoom.current_round||0,S=g.slice(M);if(S.length===0)return[];const W=[...S].sort(()=>Math.random()-.5);return W.slice(0,Math.min(3,W.length)).map(H=>({text:H.text,source:H.source}))}async function ye(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const g=await e.updateRoomStatus("playing");return g.success?await Z():g}catch(g){return console.error("開始遊戲錯誤:",g),{success:!1,error:g instanceof Error?g.message:"開始遊戲失敗"}}}async function Z(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const g=e.currentRoom.current_round||0,M=g+1;if(g>=k.value)return await re(),{success:!1,error:"所有輪次已完成"};try{const S=(M-1)%e.participants.length,W=e.participants[S];if(console.log("[startSelectionPhase] 下一輪:",M,"畫家索引:",S,"畫家:",W?.nickname),!W)throw new Error("無法選擇畫家");const K=Re();if(K.length===0)throw new Error("沒有可用的詞語");l.setWordOptions(K),l.setRoundStatus("selecting"),l.clearRatings(),await e.updateRoomDrawer(W.user_id);const{broadcastGameState:H}=oe();return await H(e.currentRoom.code,{roundStatus:"selecting",wordOptions:K,drawerId:W.user_id,drawerName:W.nickname,roundNumber:M}),p=Date.now(),C(),{success:!0,drawerId:W.user_id,options:K}}catch(S){return console.error("開始選詞階段錯誤:",S),{success:!1,error:S instanceof Error?S.message:"開始選詞階段失敗"}}}async function ce(g){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const M=e.currentRoom.current_drawer_id;if(!M)return{success:!1,error:"沒有當前畫家"};if(M!==c.user?.id)return console.log("[selectWord] 非畫家嘗試選詞，忽略"),{success:!1,error:"只有畫家可以選詞"};if(l.roundStatus!=="selecting")return console.log("[selectWord] 當前不是選詞階段，忽略"),{success:!1,error:"當前不是選詞階段"};T(),console.log("[selectWord] 畫家選擇詞語:",g.text);try{const S=await l.createRound(e.currentRoom.id,M,g.text,g.source);if(S.success&&S.round){let W=0;if(p){const H=(Date.now()-p)/1e3;W=Math.max(0,se-H),console.log(`[selectWord] 已過 ${H.toFixed(1)}秒，需等待 ${W.toFixed(1)}秒`)}W>0&&(d.value=!0,await new Promise(H=>setTimeout(H,W*1e3)),d.value=!1),l.setRoundStatus("drawing"),l.setWordOptions([]);const{broadcastGameState:K}=oe();await K(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:M}),f(w.value)}return S}catch(S){return console.error("選擇詞語錯誤:",S),{success:!1,error:S instanceof Error?S.message:"選擇詞語失敗"}}}async function ue(){return await Z()}async function ie(){if(!x.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{o();const g=await l.endRound();if(!g.success)return g;if((e.currentRoom.current_round||0)>=k.value){l.setRoundStatus("summary");const{broadcastGameState:S}=oe();return await S(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0}),setTimeout(async()=>{await re()},se*1e3),{success:!0,gameEnded:!0}}return await Z(),{success:!0,gameEnded:!1}}catch(g){return console.error("結束輪次錯誤:",g),{success:!1,error:g instanceof Error?g.message:"結束輪次失敗"}}}async function le(){return e.currentRoom?(A(),(e.currentRoom.current_round||0)>=k.value?(await re(),{success:!0,gameEnded:!0}):(await Z(),{success:!0,gameEnded:!1})):{success:!1,error:"沒有當前房間"}}async function re(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return o(),await e.updateRoomStatus("finished"),{success:!0}}catch(g){return console.error("結束遊戲錯誤:",g),{success:!1,error:g instanceof Error?g.message:"結束遊戲失敗"}}}async function Se(){if(!x.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!Y.value)return{success:!1,error:"只有畫家可以跳過詞語"};try{return o(),await ue()}catch(g){return console.error("跳過詞語錯誤:",g),{success:!1,error:g instanceof Error?g.message:"跳過詞語失敗"}}}const Ee=_(()=>{if(s.value===null)return"--:--";const g=Math.floor(s.value/60),M=s.value%60;return`${g.toString().padStart(2,"0")}:${M.toString().padStart(2,"0")}`});return be(()=>{o(),T(),A()}),{gameStatus:O,isPlaying:P,isWaiting:N,isFinished:t,currentRound:x,currentRoundNumber:i,totalRounds:k,drawTime:w,isCurrentDrawer:Y,timeRemaining:s,isCountingDown:h,formattedTime:Ee,roundStatus:r,isSelecting:n,isDrawing:a,isSummary:m,wordOptions:D,selectionTimeRemaining:I,summaryTimeRemaining:u,isWaitingAfterSelection:d,startGame:ye,startNextRound:ue,startSelectionPhase:Z,selectWord:ce,endRound:ie,continueToNextRound:le,endGame:re,skipWord:Se,startCountdown:f,stopCountdown:o,startSelectionCountdown:C,stopSelectionCountdown:T,startSummaryCountdown:$,stopSummaryCountdown:A,resetCountdown:y}}const Ce={class:"waiting-lobby"},Oe={class:"card"},qe={class:"card-body"},Me={class:"margin-bottom-medium"},We={class:"card-title text-hand-title"},Pe={class:"text-small"},Ae={style:{"font-family":"monospace"}},Ue={class:"text-small margin-top-small"},$e={class:"margin-bottom-medium"},Be={class:"text-hand-title"},He={class:"margin-top-small"},je={style:{"flex-shrink":"0","margin-right":"0.75rem"}},Le={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},Fe={style:{flex:"1"}},Ke={class:"text-hand",style:{"font-weight":"500"}},Ve={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},ze={class:"margin-bottom-medium text-small"},Je=["disabled"],Qe={key:1,class:"text-small text-center margin-bottom-small"},Xe=["disabled"],Ye={key:0,class:"alert alert-danger margin-top-medium"},Ze=xe({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:l}){const c=e,s=l,{isHost:h,canStartGame:E,leaveRoom:I,loading:b,error:p}=Ne(),{startGame:d}=De();function u(N){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[N||""]||N||"未知"}function v(N){return c.room?.host_id===N}async function O(){(await d()).success&&s("startGame")}async function P(){(await I()).success&&s("leaveRoom")}return(N,t)=>(z(),V("div",Ce,[G("div",Oe,[G("div",qe,[G("div",Me,[G("h2",We,U(e.room?.name),1),G("div",Pe,[t[0]||(t[0]=de(" 房間碼：",-1)),G("span",Ae,U(e.room?.code),1)]),G("div",Ue," 狀態："+U(u(e.room?.status)),1)]),G("div",$e,[G("h4",Be,"玩家列表 ("+U(e.participants.length)+")",1),G("div",He,[(z(!0),V(Te,null,Ge(e.participants,r=>(z(),V("div",{key:r.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[G("div",je,[G("div",Le,U(r.nickname.charAt(0).toUpperCase()),1)]),G("div",Fe,[G("div",Ke,[de(U(r.nickname)+" ",1),v(r.user_id)?(z(),V("span",Ve," 房主 ")):ae("",!0)])])]))),128))])]),G("div",ze,[G("div",null,"繪畫時間："+U(e.room?.settings.draw_time)+" 秒",1),G("div",null,"輪數："+U(e.room?.settings.rounds)+" 輪",1),G("div",null,"詞語總數："+U(e.room?.word_count)+" 個",1)]),G("div",null,[j(h)&&j(E)?(z(),V("button",{key:0,onClick:O,disabled:j(b),class:"paper-btn btn-primary btn-block margin-bottom-small"},U(j(b)?"開始中...":"開始遊戲"),9,Je)):j(h)?(z(),V("div",Qe," 至少需要 2 個玩家才能開始遊戲 ")):ae("",!0),G("button",{onClick:P,disabled:j(b),class:"paper-btn btn-secondary btn-block"},U(j(b)?"離開中...":"離開房間"),9,Xe)]),j(p)?(z(),V("div",Ye,U(j(p)),1)):ae("",!0)])])]))}}),rr=Ie(Ze,[["__scopeId","data-v-769c8ad1"]]);export{rr as W,De as a,oe as b,ee as c,pe as d,ke as e,Ne as u};
