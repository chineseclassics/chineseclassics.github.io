import{l as ge,r as O,f as p,u as Q,x as R,C as he,m as pe,d as Re,c as L,e as N,a as ne,t as U,s as ce,F as ye,p as Se,b as B,o as W,_ as be}from"./index-CnLhJgAY.js";const Z=ge("room",()=>{const e=O(null),w=O([]),c=O(!1),l=O(null),v=p(()=>{const t=Q();return e.value?.host_id===t.user?.id});async function T(t){try{c.value=!0,l.value=null;const r=Q();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(u){console.warn("載入用戶資料時發生錯誤（非關鍵）:",u)}if(t.words.length<6)throw new Error("至少需要 6 個詞語");if(t.settings.rounds>t.words.length)throw new Error("輪數不能超過詞語總數");let n=null,s=0;const f=10;for(;s<f&&!n;){s++;const D={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null},{data:m,error:b}=await R.from("game_rooms").insert(D).select().single();if(b){if(b.code==="23505")continue;throw new Error(b.message||"插入房間失敗")}if(m){n=m;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const I={room_id:n.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:u}=await R.from("room_participants").insert(I);u&&console.error("創建參與記錄錯誤:",u)}catch(u){console.error("創建參與記錄時發生錯誤:",u)}try{const{data:u,error:D}=await R.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});D?console.error("載入參與者列表失敗:",D):u&&(w.value=u)}catch(u){console.error("載入參與者列表時發生錯誤:",u)}return e.value=n,{success:!0,room:n}}catch(r){return l.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:l.value}}finally{c.value=!1}}async function M(t,r){try{c.value=!0,l.value=null;const n=Q();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:s,error:f}=await R.from("game_rooms").select("*").eq("code",t).single();if(f||!s)throw new Error("房間不存在");if(s.status!=="waiting")throw new Error("房間已開始或已結束");const{data:I}=await R.from("room_participants").select("*").eq("room_id",s.id).eq("user_id",n.user.id).maybeSingle();if(I)return e.value=s,await S(s.id),{success:!0,room:s};const{error:u}=await R.from("room_participants").insert({room_id:s.id,user_id:n.user.id,nickname:r.trim(),score:0});if(u){if(u.code==="23505"||u.message.includes("duplicate"))return e.value=s,await S(s.id),{success:!0,room:s};throw u}return e.value=s,await S(s.id),{success:!0,room:s}}catch(n){return l.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:l.value}}finally{c.value=!1}}async function C(){try{if(!e.value)return{success:!0};c.value=!0,l.value=null;const t=Q();if(!t.user)throw new Error("請先登入");const{error:r}=await R.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(v.value){const{error:n}=await R.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,w.value=[],{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,w.value=[],{success:!1,error:l.value}}finally{c.value=!1}}async function S(t){try{const{data:r,error:n}=await R.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(n)throw n;w.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function d(t){try{c.value=!0,l.value=null;const{data:r,error:n}=await R.from("game_rooms").select("*").eq("id",t).single();if(n)throw n;return e.value=r,await S(t),{success:!0,room:r}}catch(r){return l.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:l.value}}finally{c.value=!1}}async function g(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await R.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(e.value){const n=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(r){return l.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:l.value}}}async function _(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await R.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return l.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:l.value}}}function k(){e.value=null,w.value=[],l.value=null}function P(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function G(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!v.value)return{success:!1,error:"只有房主可以踢人"};const r=Q();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};c.value=!0,l.value=null;const{data:n,error:s}=await R.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(s)throw new Error(s.message);if(n&&!n.success)throw new Error(n.error||"踢出玩家失敗");return await S(e.value.id),{success:!0}}catch(r){return l.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:l.value}}finally{c.value=!1}}return{currentRoom:e,participants:w,loading:c,error:l,isHost:v,createRoom:T,joinRoom:M,leaveRoom:C,kickPlayer:G,loadParticipants:S,loadRoom:d,updateRoomStatus:g,updateRoomDrawer:_,setCurrentDrawer:P,clearRoom:k}});function Ee(){const e=Z(),w=p(()=>e.currentRoom),c=p(()=>e.participants),l=p(()=>e.isHost),v=p(()=>!w.value||w.value.status!=="waiting"||!l.value?!1:c.value.length>=2);async function T(S){return await e.createRoom(S)}async function M(S,d){return await e.joinRoom(S,d)}async function C(){return await e.leaveRoom()}return{currentRoom:w,participants:c,isHost:l,canStartGame:v,loading:p(()=>e.loading),error:p(()=>e.error),createRoom:T,joinRoom:M,leaveRoom:C}}const ue=100,ie=50,le=10,Ge=10,de=100,me=[1,.8,.6,.4,.2];function xe(){const e=Z();function w(d){const g=Math.min(d,me.length-1),_=me[g]??0;return Math.round(ue*_)}function c(d,g=0){if(d===0)return 0;const _=d*le,k=Math.round(g*Ge);return ie+_+k}async function l(d,g,_=0){const k=c(g,_);return k===0?!0:await v(d,k)}async function v(d,g){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:_,error:k}=await R.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",d).single();if(k)throw k;const P=(_?.score||0)+g,{error:G}=await R.from("room_participants").update({score:P}).eq("room_id",e.currentRoom.id).eq("user_id",d);if(G)throw G;const t=e.participants.findIndex(r=>r.user_id===d);return t!==-1&&e.participants[t]&&(e.participants[t].score=P),!0}catch(_){return console.error("更新玩家分數錯誤:",_),!1}}function T(){if(!e.participants||e.participants.length===0)return null;const d=[...e.participants].sort((g,_)=>_.score-g.score);return d.length===1||d[0]&&d[1]&&d[0].score>d[1].score?{user_id:d[0]?.user_id||"",score:d[0]?.score||0}:{user_id:d[0]?.user_id||"",score:d[0]?.score||0}}const M=p(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((g,_)=>_.score!==g.score?_.score-g.score:new Date(g.joined_at).getTime()-new Date(_.joined_at).getTime()).map((g,_)=>({id:g.id,user_id:g.user_id,score:g.score,rank:_+1}))),C=p(()=>e.currentRoom?.status!=="finished"?null:T());function S(){return de}return{GUESS_BASE_SCORE:ue,DRAWING_BASE_SCORE:ie,DRAWING_BONUS_PER_GUESS:le,WINNER_BONUS:de,calculateGuessScore:w,calculateDrawingScore:c,calculateWinner:T,updatePlayerScore:v,updateDrawerScore:l,playerRankings:M,winner:C,getWinnerBonus:S}}const we=ge("game",()=>{const e=Z(),w=Q(),c=O(null),l=O(null),v=O([]),T=p(()=>v.value.filter(i=>i.is_correct)),M=p(()=>c.value?v.value.filter(i=>i.round_id===c.value.id):[]),C=p(()=>M.value.filter(i=>i.is_correct)),S=O("drawing"),d=O([]),g=O([]),_=p(()=>g.value.length===0?0:g.value.reduce((o,h)=>o+h.rating,0)/g.value.length);function k(i){S.value=i}function P(i){d.value=i}function G(i){const o=g.value.findIndex(h=>h.rater_id===i.rater_id);o>=0?g.value[o]=i:g.value.push(i)}function t(){g.value=[]}async function r(i){try{const{data:o,error:h}=await R.from("game_rounds").select("*").eq("room_id",i).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(h)throw h;return o&&(c.value=o,l.value=o.word_text,o.word_options&&Array.isArray(o.word_options)&&(d.value=o.word_options),await n(o.id)),{success:!0,round:o}}catch(o){return console.error("載入當前輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入輪次失敗"}}}async function n(i){try{const{data:o,error:h}=await R.from("guesses").select("*").eq("round_id",i).order("guessed_at",{ascending:!0});if(h)throw h;const y=o||[],a=new Set(v.value.map(x=>x.id)),E=y.filter(x=>!a.has(x.id));E.length>0&&(v.value=[...v.value,...E])}catch(o){console.error("載入猜測記錄錯誤:",o)}}async function s(i){try{const{data:o,error:h}=await R.from("game_rounds").select("id").eq("room_id",i);if(h)throw h;if(!o||o.length===0){v.value=[];return}const y=o.map(x=>x.id),{data:a,error:E}=await R.from("guesses").select("*").in("round_id",y).order("guessed_at",{ascending:!0});if(E)throw E;v.value=a||[]}catch(o){console.error("載入所有猜測記錄錯誤:",o)}}async function f(i,o,h,y){try{if(!e.currentRoom)throw new Error("沒有當前房間");const a=(e.currentRoom.current_round||0)+1,{data:E,error:x}=await R.from("game_rounds").insert({room_id:i,round_number:a,drawer_id:o,word_text:h,word_source:y}).select().single();if(x)throw x;return c.value=E,l.value=h,await R.from("game_rooms").update({current_round:a,current_drawer_id:o}).eq("id",i),{success:!0,round:E}}catch(a){return console.error("創建輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"創建輪次失敗"}}}function I(i){return c.value?v.value.some(o=>o.round_id===c.value.id&&o.user_id===i&&o.is_correct):!1}const u=p(()=>!c.value||!w.user?!1:c.value.drawer_id===w.user.id);async function D(){if(!c.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const i=T.value.length,o=_.value,{updateDrawerScore:h}=xe();console.log("[endRound] 猜中人數:",i,"平均評分:",o),await h(c.value.drawer_id,i,o);const{error:y}=await R.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",c.value.id);if(y)throw y;return{success:!0}}catch(i){return console.error("結束輪次錯誤:",i),{success:!1,error:i instanceof Error?i.message:"結束輪次失敗"}}}function m(){c.value=null,l.value=null,v.value=[],S.value="drawing",d.value=[],g.value=[]}async function b(i,o,h){if(!w.user)return{success:!1,error:"用戶未登錄"};try{const{data:y,error:a}=await R.from("drawing_ratings").upsert({round_id:i,rater_id:w.user.id,drawer_id:o,rating:h},{onConflict:"round_id,rater_id"}).select().single();if(a)throw a;return y&&G(y),{success:!0,rating:y}}catch(y){return console.error("提交評分錯誤:",y),{success:!1,error:y instanceof Error?y.message:"提交評分失敗"}}}async function j(i){try{const{data:o,error:h}=await R.from("drawing_ratings").select("*").eq("round_id",i);if(h)throw h;return g.value=o||[],{success:!0,ratings:o}}catch(o){return console.error("載入評分錯誤:",o),{success:!1,error:o instanceof Error?o.message:"載入評分失敗"}}}return{currentRound:c,currentWord:l,guesses:v,correctGuesses:T,currentRoundGuesses:M,currentRoundCorrectGuesses:C,isCurrentDrawer:u,roundStatus:S,wordOptions:d,ratings:g,averageRating:_,loadCurrentRound:r,loadGuesses:n,loadAllGuesses:s,createRound:f,hasGuessed:I,endRound:D,clearGame:m,setRoundStatus:k,setWordOptions:P,addRating:G,clearRatings:t,submitRating:b,loadRatings:j}}),H=new Map,$=O("disconnected"),z=new Map,ee=new Set,re=new Map;function K(...e){}function A(...e){console.warn("[Realtime]",...e)}function oe(){const e=Z(),w=we();function c(t){const r=`room:${t}`;if(H.has(r))return H.get(r);const n=R.channel(r,{config:{presence:{key:"user"},broadcast:{self:!0}}});return H.set(r,n),n}function l(t){const r=re.get(t);r&&(clearTimeout(r),re.delete(t))}function v(t,r,n,s,f){t==="SUBSCRIBED"?($.value="connected",l(n),r.track({user_id:s,...f}).catch(I=>{A("Presence track 失敗:",I)})):t==="CHANNEL_ERROR"||t==="TIMED_OUT"?($.value="disconnected",A("訂閱失敗:",t),T(n,s,f)):t==="CLOSED"&&($.value="disconnected")}function T(t,r,n,s=0){if(s>=3){A("重連失敗次數過多，停止重連");return}l(t);const f=Math.min(1e3*Math.pow(2,s),1e4),I=window.setTimeout(()=>{const u=H.get(`room:${t}`);u&&u.state!=="joined"&&u.subscribe(D=>{D==="SUBSCRIBED"?v(D,u,t,r,n):(D==="CHANNEL_ERROR"||D==="TIMED_OUT")&&T(t,r,n,s+1)})},f);re.set(t,I)}function M(t,r,n,s){return new Promise((f,I)=>{if(!t||!r){A("缺少 roomCode 或 roomId"),I(new Error("缺少 roomCode 或 roomId"));return}const u=c(t),D=u.state;if(D==="joined"){$.value="connected",f(u);return}if(D==="joining"){const m=setInterval(()=>{const b=u.state;b==="joined"?(clearInterval(m),f(u)):(b==="closed"||b==="errored")&&(clearInterval(m),I(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(m),u.state!=="joined"&&I(new Error("連接超時"))},5e3);return}if(ee.has(t)){$.value="connecting",u.subscribe(m=>{v(m,u,t,n,s),m==="SUBSCRIBED"?f(u):(m==="CHANNEL_ERROR"||m==="TIMED_OUT")&&I(new Error(`訂閱失敗: ${m}`))});return}u.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${r}`},async m=>{K("房間狀態變化:",m.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${r}`},async m=>{K("參與者變化:",m.eventType),await e.loadParticipants(r)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${r}`},async m=>{K("輪次變化:",m.eventType,m.new),e.currentRoom&&await w.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async m=>{const b=m.new;if(b&&w.currentRound&&(await w.loadGuesses(b.round_id),b.is_correct&&e.isHost&&w.roundStatus==="drawing")){const j=w.currentRound.drawer_id,i=e.participants.filter(y=>y.user_id!==j),o=new Set(w.currentRoundCorrectGuesses.map(y=>y.user_id));if(i.length>0&&i.every(y=>o.has(y.user_id))){const{useGame:y}=await he(async()=>{const{useGame:E}=await Promise.resolve().then(()=>ke);return{useGame:E}},void 0),{endRound:a}=y();await a()}}}).on("broadcast",{event:"drawing"},m=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(m));const b=z.get(t);b&&m.payload?.stroke?(console.log("[Realtime] 分發給",b.size,"個回調"),b.forEach(j=>j(m.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",b?.size,"stroke:",m.payload?.stroke)}).on("presence",{event:"sync"},()=>{const m=u.presenceState();K("Presence 同步，在線:",Object.keys(m).length)}),ee.add(t),$.value="connecting",u.subscribe(m=>{v(m,u,t,n,s),m==="SUBSCRIBED"?f(u):(m==="CHANNEL_ERROR"||m==="TIMED_OUT")&&I(new Error(`訂閱失敗: ${m}`))})})}function C(t,r){return z.has(t)||z.set(t,new Set),z.get(t).add(r),()=>{z.get(t)?.delete(r)}}function S(t,r){const n=c(t),s=`guesses:${r}`;return n[s]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${r}`},async f=>{K("收到新猜測記錄:",f.eventType,f.new),await w.loadGuesses(r)}),n[s]=!0),n}function d(t,r){const n=c(t),s=`gameState:${t}`;return n[s]||(n.on("broadcast",{event:"game_state"},f=>{K("收到遊戲狀態廣播:",f.payload),r(f.payload)}),n[s]=!0),n}async function g(t,r){const n=c(t),s=n.state;if(s!=="joined")return A("Channel 未連接，狀態:",s,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{K("廣播遊戲狀態:",r);const f=await n.send({type:"broadcast",event:"game_state",payload:r});return f==="error"?(A("發送遊戲狀態失敗"),{error:"發送失敗"}):f}catch(f){return A("發送遊戲狀態錯誤:",f),{error:f instanceof Error?f.message:"發送失敗"}}}async function _(t,r){const n=c(t),s=n.state;if(s!=="joined")return A("Channel 未連接，無法發送繪畫數據，狀態:",s),{error:"Channel 未連接"};try{const f=await n.send({type:"broadcast",event:"drawing",payload:{stroke:r}});return f==="error"?(A("發送失敗"),{error:"發送失敗"}):f}catch(f){return A("發送錯誤:",f),{error:f instanceof Error?f.message:"發送失敗"}}}function k(t){const r=`room:${t}`,n=H.get(r);l(t),n&&(R.removeChannel(n),H.delete(r)),z.delete(t),ee.delete(t)}function P(){re.forEach((t,r)=>l(r)),H.forEach(t=>R.removeChannel(t)),H.clear(),z.clear(),ee.clear()}function G(){return $.value}return{connectionStatus:$,subscribeRoom:M,subscribeDrawing:C,subscribeGuesses:S,subscribeGameState:d,sendDrawing:_,broadcastGameState:g,unsubscribeRoom:k,unsubscribeAll:P,getConnectionStatus:G}}const fe=6,F=O(null),se=O(!1);let J=null;const V=O(null);let Y=null;const te=O(new Set);function ve(){const e=Z(),w=we();oe();const c=F,l=se,v=V,T=p(()=>e.currentRoom?.status||"waiting"),M=p(()=>T.value==="playing"),C=p(()=>T.value==="waiting"),S=p(()=>T.value==="finished"),d=p(()=>w.roundStatus),g=p(()=>d.value==="drawing"),_=p(()=>d.value==="summary"),k=p(()=>w.currentRound),P=p(()=>e.currentRoom?.current_round||0),G=p(()=>e.currentRoom?.settings.rounds||0),t=p(()=>e.currentRoom?.settings.draw_time||60),r=p(()=>w.isCurrentDrawer);function n(a){console.log("[useGame] startCountdown 開始，時長:",a,"秒"),J&&clearInterval(J),F.value=a,se.value=!0,J=window.setInterval(()=>{F.value!==null&&F.value>0?F.value--:(s(),M.value&&k.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),i()))},1e3)}function s(){J&&(clearInterval(J),J=null),se.value=!1}function f(){s(),F.value=null}function I(){console.log("[useGame] startSummaryCountdown 開始"),Y&&clearInterval(Y),V.value=fe,console.log("[useGame] 開始總結倒計時:",fe,"秒"),Y=window.setInterval(async()=>{V.value!==null&&V.value>0?(V.value--,console.log("[useGame] 總結倒計時:",V.value)):(u(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await o()))},1e3)}function u(){console.log("[useGame] stopSummaryCountdown"),Y&&(clearInterval(Y),Y=null),V.value=null}function D(){if(!e.currentRoom)return null;const a=e.currentRoom.words;if(a.length===0)return null;const E=[];for(let q=0;q<a.length;q++)te.value.has(q)||E.push(q);let x=0;if(E.length>0){const q=Math.floor(Math.random()*E.length);x=E[q]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),te.value.clear(),x=Math.floor(Math.random()*a.length);return te.value.add(x),a[x]??null}async function m(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{te.value.clear();const a=await e.updateRoomStatus("playing");return a.success?await b():a}catch(a){return console.error("開始遊戲錯誤:",a),{success:!1,error:a instanceof Error?a.message:"開始遊戲失敗"}}}async function b(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const a=e.currentRoom.current_round||0,E=a+1;if(a>=G.value)return await h(),{success:!1,error:"所有輪次已完成"};try{const x=(E-1)%e.participants.length,q=e.participants[x];if(console.log("[startDrawingPhase] 第",E,"輪，畫家:",q?.nickname),!q)throw new Error("無法選擇畫家");const X=D();if(!X)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",X.text),await e.updateRoomDrawer(q.user_id);const ae=await w.createRound(e.currentRoom.id,q.user_id,X.text,X.source);if(!ae.success||!ae.round)throw new Error("創建輪次失敗");const{broadcastGameState:_e}=oe();return await _e(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:q.user_id,drawerName:q.nickname,roundNumber:E}),{success:!0,drawerId:q.user_id,word:X.text}}catch(x){return console.error("開始繪畫階段錯誤:",x),{success:!1,error:x instanceof Error?x.message:"開始繪畫階段失敗"}}}async function j(){return await b()}async function i(){if(!k.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const a=await w.endRound();if(!a.success)return a;const x=(e.currentRoom.current_round||0)>=G.value,{broadcastGameState:q}=oe();return await q(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:x}),{success:!0,gameEnded:x}}catch(a){return console.error("結束輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"結束輪次失敗"}}}async function o(){return e.currentRoom?e.isHost?(e.currentRoom.current_round||0)>=G.value?(await h(),{success:!0,gameEnded:!0}):(await b(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function h(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return s(),await e.updateRoomStatus("finished"),{success:!0}}catch(a){return console.error("結束遊戲錯誤:",a),{success:!1,error:a instanceof Error?a.message:"結束遊戲失敗"}}}const y=p(()=>{if(c.value===null)return"--:--";const a=Math.floor(c.value/60),E=c.value%60;return`${a.toString().padStart(2,"0")}:${E.toString().padStart(2,"0")}`});return pe(()=>{s(),u()}),{gameStatus:T,isPlaying:M,isWaiting:C,isFinished:S,currentRound:k,currentRoundNumber:P,totalRounds:G,drawTime:t,isCurrentDrawer:r,timeRemaining:c,isCountingDown:l,formattedTime:y,roundStatus:d,isDrawing:g,isSummary:_,summaryTimeRemaining:v,startGame:m,startNextRound:j,startDrawingPhase:b,endRound:i,continueToNextRound:o,endGame:h,startCountdown:n,stopCountdown:s,startSummaryCountdown:I,stopSummaryCountdown:u,resetCountdown:f}}const ke=Object.freeze(Object.defineProperty({__proto__:null,useGame:ve},Symbol.toStringTag,{value:"Module"})),Ne={class:"waiting-lobby"},Te={class:"card"},Ie={class:"card-body"},Ce={class:"margin-bottom-medium"},De={class:"card-title text-hand-title"},qe={class:"text-small"},Me={style:{"font-family":"monospace"}},Oe={class:"text-small margin-top-small"},Pe={class:"margin-bottom-medium"},Ue={class:"text-hand-title"},Ae={class:"margin-top-small"},Be={style:{"flex-shrink":"0","margin-right":"0.75rem"}},He={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},$e={style:{flex:"1"}},je={class:"text-hand",style:{"font-weight":"500"}},Le={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},We={class:"margin-bottom-medium text-small"},ze=["disabled"],Ke={key:1,class:"text-small text-center margin-bottom-small"},Ve=["disabled"],Fe={key:0,class:"alert alert-danger margin-top-medium"},Je=Re({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:w}){const c=e,l=w,{isHost:v,canStartGame:T,leaveRoom:M,loading:C,error:S}=Ee(),{startGame:d}=ve();function g(G){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[G||""]||G||"未知"}function _(G){return c.room?.host_id===G}async function k(){(await d()).success&&l("startGame")}async function P(){(await M()).success&&l("leaveRoom")}return(G,t)=>(W(),L("div",Ne,[N("div",Te,[N("div",Ie,[N("div",Ce,[N("h2",De,U(e.room?.name),1),N("div",qe,[t[0]||(t[0]=ce(" 房間碼：",-1)),N("span",Me,U(e.room?.code),1)]),N("div",Oe," 狀態："+U(g(e.room?.status)),1)]),N("div",Pe,[N("h4",Ue,"玩家列表 ("+U(e.participants.length)+")",1),N("div",Ae,[(W(!0),L(ye,null,Se(e.participants,r=>(W(),L("div",{key:r.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[N("div",Be,[N("div",He,U(r.nickname.charAt(0).toUpperCase()),1)]),N("div",$e,[N("div",je,[ce(U(r.nickname)+" ",1),_(r.user_id)?(W(),L("span",Le," 房主 ")):ne("",!0)])])]))),128))])]),N("div",We,[N("div",null,"繪畫時間："+U(e.room?.settings.draw_time)+" 秒",1),N("div",null,"輪數："+U(e.room?.settings.rounds)+" 輪",1),N("div",null,"詞語總數："+U(e.room?.word_count)+" 個",1)]),N("div",null,[B(v)&&B(T)?(W(),L("button",{key:0,onClick:k,disabled:B(C),class:"paper-btn btn-primary btn-block margin-bottom-small"},U(B(C)?"開始中...":"開始遊戲"),9,ze)):B(v)?(W(),L("div",Ke," 至少需要 2 個玩家才能開始遊戲 ")):ne("",!0),N("button",{onClick:P,disabled:B(C),class:"paper-btn btn-secondary btn-block"},U(B(C)?"離開中...":"離開房間"),9,Ve)]),B(S)?(W(),L("div",Fe,U(B(S)),1)):ne("",!0)])])]))}}),Qe=be(Je,[["__scopeId","data-v-769c8ad1"]]);export{Qe as W,oe as a,Z as b,we as c,xe as d,ve as e,Ee as u};
