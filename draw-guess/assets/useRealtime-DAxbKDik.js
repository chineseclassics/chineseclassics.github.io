import{l as Y,r as k,f as b,u as A,x as y,m as z,d as Q,c as $,e as S,a as O,t as T,s as W,F as Z,p as C,b as M,o as U,_ as ee}from"./index-CfZPCy1Z.js";const B=Y("room",()=>{const e=k(null),g=k([]),u=k(!1),s=k(null),_=b(()=>{const c=A();return e.value?.host_id===c.user?.id});async function p(c){try{u.value=!0,s.value=null;const t=A();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(h){console.warn("載入用戶資料時發生錯誤（非關鍵）:",h)}if(c.words.length<6)throw new Error("至少需要 6 個詞語");if(c.settings.rounds>c.words.length)throw new Error("輪數不能超過詞語總數");let n=null,i=0;const R=10;for(;i<R&&!n;){i++;const D={code:Math.floor(1e5+Math.random()*9e5).toString(),name:c.name,host_id:t.user.id,words:c.words,word_count:c.words.length,status:"waiting",settings:c.settings,current_round:0,current_drawer_id:null},{data:P,error:j}=await y.from("game_rooms").insert(D).select().single();if(j){if(j.code==="23505")continue;throw new Error(j.message||"插入房間失敗")}if(P){n=P;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const G={room_id:n.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:h}=await y.from("room_participants").insert(G);h&&console.error("創建參與記錄錯誤:",h)}catch(h){console.error("創建參與記錄時發生錯誤:",h)}try{const{data:h,error:D}=await y.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});D?console.error("載入參與者列表失敗:",D):h&&(g.value=h)}catch(h){console.error("載入參與者列表時發生錯誤:",h)}return e.value=n,{success:!0,room:n}}catch(t){return s.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:s.value}}finally{u.value=!1}}async function E(c,t){try{u.value=!0,s.value=null;const n=A();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(c))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:i,error:R}=await y.from("game_rooms").select("*").eq("code",c).single();if(R||!i)throw new Error("房間不存在");if(i.status!=="waiting")throw new Error("房間已開始或已結束");const{data:G}=await y.from("room_participants").select("*").eq("room_id",i.id).eq("user_id",n.user.id).maybeSingle();if(G)return e.value=i,await w(i.id),{success:!0,room:i};const{error:h}=await y.from("room_participants").insert({room_id:i.id,user_id:n.user.id,nickname:t.trim(),score:0});if(h){if(h.code==="23505"||h.message.includes("duplicate"))return e.value=i,await w(i.id),{success:!0,room:i};throw h}return e.value=i,await w(i.id),{success:!0,room:i}}catch(n){return s.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:s.value}}finally{u.value=!1}}async function x(){try{if(!e.value)return{success:!0};u.value=!0,s.value=null;const c=A();if(!c.user)throw new Error("請先登入");const{error:t}=await y.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",c.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(_.value){const{error:n}=await y.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,g.value=[],{success:!0}}catch(c){return s.value=c instanceof Error?c.message:"離開房間失敗",console.error("離開房間錯誤:",c),e.value=null,g.value=[],{success:!1,error:s.value}}finally{u.value=!1}}async function w(c){try{const{data:t,error:n}=await y.from("room_participants").select("*").eq("room_id",c).order("joined_at",{ascending:!0});if(n)throw n;g.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function l(c){try{u.value=!0,s.value=null;const{data:t,error:n}=await y.from("game_rooms").select("*").eq("id",c).single();if(n)throw n;return e.value=t,await w(c),{success:!0,room:t}}catch(t){return s.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:s.value}}finally{u.value=!1}}async function d(c){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:c});const{error:t}=await y.from("game_rooms").update({status:c}).eq("id",e.value.id);if(t)throw t;if(e.value){const n=e.value.status;e.value.status=c,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(t){return s.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:s.value}}}function v(){e.value=null,g.value=[],s.value=null}return{currentRoom:e,participants:g,loading:u,error:s,isHost:_,createRoom:p,joinRoom:E,leaveRoom:x,loadParticipants:w,loadRoom:l,updateRoomStatus:d,clearRoom:v}});function re(){const e=B(),g=b(()=>e.currentRoom),u=b(()=>e.participants),s=b(()=>e.isHost),_=b(()=>!g.value||g.value.status!=="waiting"||!s.value?!1:u.value.length>=2);async function p(w){return await e.createRoom(w)}async function E(w,l){return await e.joinRoom(w,l)}async function x(){return await e.leaveRoom()}return{currentRoom:g,participants:u,isHost:s,canStartGame:_,loading:b(()=>e.loading),error:b(()=>e.error),createRoom:p,joinRoom:E,leaveRoom:x}}const H=100,I=50,F=10,V=100,K=[1,.8,.6,.4,.2];function J(){const e=B();function g(l){const d=Math.min(l,K.length-1),v=K[d]??0;return Math.round(H*v)}function u(l){return l===0?0:I+l*F}async function s(l,d){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:v,error:c}=await y.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",l).single();if(c)throw c;const t=(v?.score||0)+d,{error:n}=await y.from("room_participants").update({score:t}).eq("room_id",e.currentRoom.id).eq("user_id",l);if(n)throw n;const i=e.participants.findIndex(R=>R.user_id===l);return i!==-1&&e.participants[i]&&(e.participants[i].score=t),!0}catch(v){return console.error("更新玩家分數錯誤:",v),!1}}async function _(l,d){const v=u(d);return v===0?!0:await s(l,v)}function p(){if(!e.participants||e.participants.length===0)return null;const l=[...e.participants].sort((d,v)=>v.score-d.score);return l.length===1||l[0]&&l[1]&&l[0].score>l[1].score?{user_id:l[0]?.user_id||"",score:l[0]?.score||0}:{user_id:l[0]?.user_id||"",score:l[0]?.score||0}}const E=b(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((d,v)=>v.score!==d.score?v.score-d.score:new Date(d.joined_at).getTime()-new Date(v.joined_at).getTime()).map((d,v)=>({id:d.id,user_id:d.user_id,score:d.score,rank:v+1}))),x=b(()=>e.currentRoom?.status!=="finished"?null:p());function w(){return V}return{GUESS_BASE_SCORE:H,DRAWING_BASE_SCORE:I,DRAWING_BONUS_PER_GUESS:F,WINNER_BONUS:V,calculateGuessScore:g,calculateDrawingScore:u,calculateWinner:p,updatePlayerScore:s,updateDrawerScore:_,playerRankings:E,winner:x,getWinnerBonus:w}}const X=Y("game",()=>{const e=B(),g=A(),u=k(null),s=k(null),_=k([]),p=b(()=>_.value.filter(t=>t.is_correct));async function E(t){try{const{data:n,error:i}=await y.from("game_rounds").select("*").eq("room_id",t).order("round_number",{ascending:!1}).limit(1).single();if(i&&i.code!=="PGRST116")throw i;return n&&(u.value=n,s.value=n.word_text,await x(n.id)),{success:!0,round:n}}catch(n){return console.error("載入當前輪次錯誤:",n),{success:!1,error:n instanceof Error?n.message:"載入輪次失敗"}}}async function x(t){try{const{data:n,error:i}=await y.from("guesses").select("*").eq("round_id",t).order("guessed_at",{ascending:!0});if(i)throw i;_.value=n||[]}catch(n){console.error("載入猜測記錄錯誤:",n)}}async function w(t,n,i,R){try{if(!e.currentRoom)throw new Error("沒有當前房間");const G=(e.currentRoom.current_round||0)+1,{data:h,error:D}=await y.from("game_rounds").insert({room_id:t,round_number:G,drawer_id:n,word_text:i,word_source:R}).select().single();if(D)throw D;return u.value=h,s.value=i,_.value=[],await y.from("game_rooms").update({current_round:G,current_drawer_id:n}).eq("id",t),{success:!0,round:h}}catch(G){return console.error("創建輪次錯誤:",G),{success:!1,error:G instanceof Error?G.message:"創建輪次失敗"}}}function l(t){return _.value.some(n=>n.user_id===t&&n.is_correct)}const d=b(()=>!u.value||!g.user?!1:u.value.drawer_id===g.user.id);async function v(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const t=p.value.length,{updateDrawerScore:n}=J();await n(u.value.drawer_id,t);const{error:i}=await y.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",u.value.id);if(i)throw i;return{success:!0}}catch(t){return console.error("結束輪次錯誤:",t),{success:!1,error:t instanceof Error?t.message:"結束輪次失敗"}}}function c(){u.value=null,s.value=null,_.value=[]}return{currentRound:u,currentWord:s,guesses:_,correctGuesses:p,isCurrentDrawer:d,loadCurrentRound:E,loadGuesses:x,createRound:w,hasGuessed:l,endRound:v,clearGame:c}});function te(){const e=B(),g=X(),{updateDrawerScore:u}=J(),s=k(null),_=k(!1);let p=null;const E=b(()=>e.currentRoom?.status||"waiting"),x=b(()=>E.value==="playing"),w=b(()=>E.value==="waiting"),l=b(()=>E.value==="finished"),d=b(()=>g.currentRound),v=b(()=>e.currentRoom?.current_round||0),c=b(()=>e.currentRoom?.settings.rounds||0),t=b(()=>e.currentRoom?.settings.draw_time||60),n=b(()=>g.isCurrentDrawer);function i(r){p&&clearInterval(p),s.value=r,_.value=!0,p=window.setInterval(()=>{s.value!==null&&s.value>0?s.value--:(R(),x.value&&d.value&&P())},1e3)}function R(){p&&(clearInterval(p),p=null),_.value=!1}function G(){R(),s.value=null}async function h(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const r=await e.updateRoomStatus("playing");return r.success?await D():r}catch(r){return console.error("開始遊戲錯誤:",r),{success:!1,error:r instanceof Error?r.message:"開始遊戲失敗"}}}async function D(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const r=e.currentRoom.words,o=e.currentRoom.current_round||0;if(o>=r.length||o>=c.value)return await j(),{success:!1,error:"所有輪次已完成"};try{const a=r[o],m=o%e.participants.length,f=e.participants[m];if(!f||!a)throw new Error("無法選擇畫家或詞語");const q=await g.createRound(e.currentRoom.id,f.user_id,a.text,a.source);return q.success&&q.round&&i(t.value),q}catch(a){return console.error("開始下一輪錯誤:",a),{success:!1,error:a instanceof Error?a.message:"開始下一輪失敗"}}}async function P(){if(!d.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{R();const r=g.correctGuesses.length;await u(d.value.drawer_id,r);const o=await g.endRound();return o.success?(e.currentRoom.current_round||0)>=c.value?(await j(),{success:!0,gameEnded:!0}):(setTimeout(async()=>{await D()},2e3),{success:!0,gameEnded:!1}):o}catch(r){return console.error("結束輪次錯誤:",r),{success:!1,error:r instanceof Error?r.message:"結束輪次失敗"}}}async function j(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return R(),await e.updateRoomStatus("finished"),{success:!0}}catch(r){return console.error("結束遊戲錯誤:",r),{success:!1,error:r instanceof Error?r.message:"結束遊戲失敗"}}}const L=b(()=>{if(s.value===null)return"--:--";const r=Math.floor(s.value/60),o=s.value%60;return`${r.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`});return z(()=>{R()}),{gameStatus:E,isPlaying:x,isWaiting:w,isFinished:l,currentRound:d,currentRoundNumber:v,totalRounds:c,drawTime:t,isCurrentDrawer:n,timeRemaining:s,isCountingDown:_,formattedTime:L,startGame:h,startNextRound:D,endRound:P,endGame:j,startCountdown:i,stopCountdown:R,resetCountdown:G}}const ne={class:"waiting-lobby"},se={class:"card"},oe={class:"card-body"},ae={class:"margin-bottom-medium"},ce={class:"card-title text-hand-title"},ie={class:"text-small"},ue={style:{"font-family":"monospace"}},le={class:"text-small margin-top-small"},de={class:"margin-bottom-medium"},fe={class:"text-hand-title"},me={class:"margin-top-small"},ge={style:{"flex-shrink":"0","margin-right":"0.75rem"}},we={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},ve={style:{flex:"1"}},he={class:"text-hand",style:{"font-weight":"500"}},_e={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},pe={class:"margin-bottom-medium text-small"},Re=["disabled"],ye={key:1,class:"text-small text-center margin-bottom-small"},be=["disabled"],Se={key:0,class:"alert alert-danger margin-top-medium"},Ee=Q({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:g}){const u=e,s=g,{isHost:_,canStartGame:p,leaveRoom:E,loading:x,error:w}=re(),{startGame:l}=te();function d(n){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[n||""]||n||"未知"}function v(n){return u.room?.host_id===n}async function c(){(await l()).success&&s("startGame")}async function t(){(await E()).success&&s("leaveRoom")}return(n,i)=>(U(),$("div",ne,[S("div",se,[S("div",oe,[S("div",ae,[S("h2",ce,T(e.room?.name),1),S("div",ie,[i[0]||(i[0]=W(" 房間碼：",-1)),S("span",ue,T(e.room?.code),1)]),S("div",le," 狀態："+T(d(e.room?.status)),1)]),S("div",de,[S("h4",fe,"玩家列表 ("+T(e.participants.length)+")",1),S("div",me,[(U(!0),$(Z,null,C(e.participants,R=>(U(),$("div",{key:R.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[S("div",ge,[S("div",we,T(R.nickname.charAt(0).toUpperCase()),1)]),S("div",ve,[S("div",he,[W(T(R.nickname)+" ",1),v(R.user_id)?(U(),$("span",_e," 房主 ")):O("",!0)])])]))),128))])]),S("div",pe,[S("div",null,"繪畫時間："+T(e.room?.settings.draw_time)+" 秒",1),S("div",null,"輪數："+T(e.room?.settings.rounds)+" 輪",1),S("div",null,"詞語總數："+T(e.room?.word_count)+" 個",1)]),S("div",null,[M(_)&&M(p)?(U(),$("button",{key:0,onClick:c,disabled:M(x),class:"paper-btn btn-primary btn-block margin-bottom-small"},T(M(x)?"開始中...":"開始遊戲"),9,Re)):M(_)?(U(),$("div",ye," 至少需要 2 個玩家才能開始遊戲 ")):O("",!0),S("button",{onClick:t,disabled:M(x),class:"paper-btn btn-secondary btn-block"},T(M(x)?"離開中...":"離開房間"),9,be)]),M(w)?(U(),$("div",Se,T(M(w)),1)):O("",!0)])])]))}}),De=ee(Ee,[["__scopeId","data-v-769c8ad1"]]);function ke(){const e=B(),g=X(),u=k(new Map),s=k("disconnected"),_=k(new Set),p=k(new Set),E=3,x=1e3,w=k(new Map),l=k(new Map);function d(r){const o=`room:${r}`;if(u.value.has(o))return u.value.get(o);const a=y.channel(o,{config:{presence:{key:"user"}}});return u.value.set(o,a),a}function v(r,o){const a=d(r);return a.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${o}`},async m=>{console.log("房間狀態變化:",m),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}),a}function c(r,o){const a=d(r);return a.on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${o}`},async m=>{console.log("參與者變化:",m),await e.loadParticipants(o)}),a}function t(r,o){const a=d(r);return a.on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${o}`},async m=>{console.log("輪次變化:",m),e.currentRoom&&await g.loadCurrentRound(e.currentRoom.id)}),a}function n(r,o){const a=d(r);return a.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${o}`},async m=>{console.log("猜測記錄變化:",m),await g.loadGuesses(o)}).subscribe(),a}function i(r,o){const a=d(r),m=a.state;return console.log("[subscribeDrawing] 訂閱繪畫數據，roomCode:",r,"channelState:",m),a.on("broadcast",{event:"drawing"},f=>{console.log("[subscribeDrawing] 收到繪畫數據:",f),f.payload?.stroke&&o(f.payload.stroke)}),m!=="joined"&&m!=="joining"&&(console.log("[subscribeDrawing] Channel 未訂閱，正在訂閱..."),a.subscribe(f=>{console.log("[subscribeDrawing] 訂閱狀態:",f)})),a}async function R(r,o){try{const a=d(r),m=a.state;console.log("[sendDrawing] 發送繪畫數據，roomCode:",r,"channelState:",m),m!=="joined"&&(console.warn("[sendDrawing] Channel 未連接，狀態:",m),m!=="joining"&&a.subscribe(),await new Promise(q=>setTimeout(q,100)));const f=await a.send({type:"broadcast",event:"drawing",payload:{stroke:o}});return console.log("[sendDrawing] 發送結果:",f),f==="error"?(console.warn("[sendDrawing] 發送繪畫數據失敗，channel 可能未連接"),{error:"發送失敗，請檢查網絡連接"}):f}catch(a){return console.warn("[sendDrawing] 發送繪畫數據錯誤:",a),{error:a instanceof Error?a.message:"發送失敗"}}}function G(r,o,a){const m=d(r);return m.on("presence",{event:"sync"},()=>{const f=m.presenceState();console.log("Presence 狀態:",f)}).on("presence",{event:"join"},({key:f,newPresences:q})=>{console.log("玩家加入:",f,q)}).on("presence",{event:"leave"},({key:f,leftPresences:q})=>{console.log("玩家離開:",f,q)}),m}function h(r,o,a,m){if(!r||!o)return;const f=d(r),q=f.state;return _.value.has(r)||(v(r,o),c(r,o),t(r,o),G(r),f.on("system",{},N=>{console.log("Realtime 系統狀態:",N),N.status==="ok"?(s.value="connected",w.value.set(r,0),D(r)):N.status==="error"&&(s.value="disconnected",console.warn("Realtime 連接錯誤，嘗試重試"),P(r,o,a,m))}),_.value.add(r)),q==="joined"?(s.value="connected",w.value.set(r,0),D(r),p.value.has(r)||(f.track({user_id:a,...m}),p.value.add(r)),f):(f.subscribe(async N=>{console.log("Realtime 訂閱狀態:",N),N==="SUBSCRIBED"?(s.value="connected",w.value.set(r,0),D(r),p.value.has(r)||(await f.track({user_id:a,...m}),p.value.add(r))):N==="CHANNEL_ERROR"||N==="TIMED_OUT"?(s.value="disconnected",console.warn("Realtime 訂閱失敗，嘗試重試，狀態:",N),P(r,o,a,m)):N==="CLOSED"?e.currentRoom&&e.currentRoom.code===r?(s.value="disconnected",console.warn("Realtime 連接關閉，但用戶仍在房間中，嘗試重試"),P(r,o,a,m)):(s.value="disconnected",console.log("Realtime 連接正常關閉（用戶已離開房間）")):N==="JOINED"&&(s.value="connecting")}),f)}function D(r){const o=l.value.get(r);o&&(clearTimeout(o),l.value.delete(r))}function P(r,o,a,m){const f=w.value.get(r)||0;if(f>=E){console.error(`Realtime 連接失敗，已達到最大重試次數 (${E})`),s.value="disconnected";return}D(r);const q=window.setTimeout(()=>{console.log(`嘗試重新連接 Realtime (${f+1}/${E})`),w.value.set(r,f+1),j(r),h(r,o,a,m)},x*(f+1));l.value.set(r,q)}function j(r){const o=`room:${r}`,a=u.value.get(o);a&&(y.removeChannel(a),u.value.delete(o)),D(r),w.value.delete(r),_.value.delete(r),p.value.delete(r)}function L(){u.value.forEach((r,o)=>{y.removeChannel(r),D(o)}),u.value.clear(),w.value.clear(),l.value.clear()}return z(()=>{L()}),{connectionStatus:s,subscribeRoom:h,subscribeDrawing:i,subscribeGuesses:n,sendDrawing:R,unsubscribeRoom:j,unsubscribeAll:L}}export{De as W,te as a,ke as b,B as c,X as d,J as e,re as u};
