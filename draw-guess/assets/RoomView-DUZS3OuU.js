import{l as ae,r as D,d as E,u as P,i as K,m as j,c as m,e as t,o as p,_ as B,f as x,n as T,a as $,F as Y,p as A,q as J,t as W,b as _,s as U,x as ie,y as re,j as V,z as le,g as ce,v as ue,A as de,B as ve}from"./index-BngxKEU3.js";import{c as I,b as X,d as O,e as Q,a as he,u as fe,W as me}from"./useRealtime-D-XQtIPi.js";const Z=ae("drawing",()=>{const e=D("pen"),s=D("#000000"),l=D(3),o=D(!1),r=D([]);function n(u){e.value=u}function d(u){s.value=u}function f(u){l.value=Math.max(1,Math.min(20,u))}function C(u){r.value.push(u)}function R(){r.value=[]}function y(u){o.value=u}return{tool:e,color:s,lineWidth:l,isDrawing:o,strokes:r,setTool:n,setColor:d,setLineWidth:f,addStroke:C,clearStrokes:R,setDrawing:y}});function q(e,s){const l=e.getBoundingClientRect(),o=e.width/l.width,r=e.height/l.height;let n,d;if(s instanceof MouseEvent)n=s.clientX,d=s.clientY;else if(s instanceof TouchEvent&&s.touches.length>0&&s.touches[0])n=s.touches[0].clientX,d=s.touches[0].clientY;else return null;return{x:(n-l.left)*o,y:(d-l.top)*r}}function ee(e,s){if(!(s.points.length<2)){e.save(),s.tool==="pen"?(e.strokeStyle=s.color,e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"):s.tool==="eraser"&&(e.globalCompositeOperation="destination-out",e.lineWidth=s.lineWidth,e.lineCap="round",e.lineJoin="round"),e.beginPath(),s.points[0]&&e.moveTo(s.points[0].x,s.points[0].y);for(let l=1;l<s.points.length;l++){const o=s.points[l];o&&e.lineTo(o.x,o.y)}e.stroke(),e.restore()}}function z(e,s){const l=e.getContext("2d");l&&(l.clearRect(0,0,e.width,e.height),l.fillStyle="#FFFFFF",l.fillRect(0,0,e.width,e.height),s.forEach(o=>{ee(l,o)}))}function pe(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function te(){const e=Z(),s=I(),{sendDrawing:l}=X(),o=D(null),r=D(null),n=D(null),d=D(null);let f=null;const C=50;function R(c){o.value=c;const i=c.getContext("2d",{willReadFrequently:!0});if(!i){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}r.value=i;const g=window.devicePixelRatio||1,L=c.getBoundingClientRect();c.width=L.width*g,c.height=L.height*g,i.scale(g,g),i.canvas.width=L.width,i.canvas.height=L.height,i.fillStyle="#FFFFFF",i.fillRect(0,0,c.width,c.height),o.value&&z(o.value,e.strokes)}function y(c){if(!o.value)return;c.preventDefault(),e.setDrawing(!0);const i=q(o.value,c);i&&(n.value={id:pe(),tool:e.tool,color:e.color,lineWidth:e.lineWidth,points:[i],timestamp:Date.now()},d.value=i)}function u(c){if(!o.value||!r.value||!e.isDrawing||!n.value)return;c.preventDefault();const i=q(o.value,c);if(!i||!d.value)return;const g=r.value;g.save(),n.value.tool==="pen"?(g.strokeStyle=n.value.color,g.lineWidth=n.value.lineWidth,g.lineCap="round",g.lineJoin="round"):n.value.tool==="eraser"&&(g.globalCompositeOperation="destination-out",g.lineWidth=n.value.lineWidth,g.lineCap="round",g.lineJoin="round"),g.beginPath(),g.moveTo(d.value.x,d.value.y),g.lineTo(i.x,i.y),g.stroke(),g.restore(),n.value.points.push(i),d.value=i,f===null&&(f=window.setTimeout(()=>{a(),f=null},C))}function F(){!e.isDrawing||!n.value||(e.setDrawing(!1),f&&(clearTimeout(f),f=null),a(),n.value=null,d.value=null)}async function a(){if(!(!n.value||!s.currentRoom))try{await l(s.currentRoom.code,n.value)}catch(c){console.error("ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",c)}}function w(c){!o.value||!r.value||(e.addStroke(c),ee(r.value,c))}function h(){if(!o.value||!r.value)return;const c=r.value,i=o.value;c.clearRect(0,0,i.width,i.height),c.fillStyle="#FFFFFF",c.fillRect(0,0,i.width,i.height),e.clearStrokes()}function v(c){e.setTool(c)}function k(c){e.setColor(c)}function G(c){e.setLineWidth(c)}function S(){o.value&&z(o.value,e.strokes)}return{canvasRef:o,initCanvas:R,startDrawing:y,draw:u,stopDrawing:F,clearCanvas:h,setTool:v,setColor:k,setLineWidth:G,handleDrawingData:w,redrawStrokes:S}}const ge={class:"drawing-canvas-container"},_e=E({__name:"DrawingCanvas",setup(e){const{initCanvas:s,startDrawing:l,draw:o,stopDrawing:r,handleDrawingData:n}=te(),d=I(),f=P(),{subscribeDrawing:C,unsubscribeRoom:R}=X(),y=D(null);function u(S){l(S)}function F(S){o(S)}function a(){r()}function w(){r()}function h(S){l(S)}function v(S){o(S)}function k(){r()}function G(){!d.currentRoom||!f.user||C(d.currentRoom.code,S=>{n(S)})}return K(()=>{y.value&&s(y.value),G()}),j(()=>{d.currentRoom&&R(d.currentRoom.code)}),(S,c)=>(p(),m("div",ge,[t("canvas",{ref_key:"canvasElement",ref:y,class:"drawing-canvas",onMousedown:u,onMousemove:F,onMouseup:a,onMouseleave:w,onTouchstart:h,onTouchmove:v,onTouchend:k},null,544)]))}}),we=B(_e,[["__scopeId","data-v-e4ccc127"]]),ye={class:"toolbar-section"},be={key:0,class:"tool-label"},Fe={key:0,class:"tool-label"},Ce={key:0,class:"toolbar-section colors-section"},Re=["onClick","title"],Se={class:"toolbar-section size-section"},ke={class:"size-dots"},De=["onClick","title"],$e={class:"toolbar-section"},We={key:0,class:"tool-label"},Te=E({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(e){const s=Z(),{setTool:l,setColor:o,setLineWidth:r,clearCanvas:n}=te(),d=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],f=x(()=>s.tool),C=x(()=>s.color),R=x(()=>s.lineWidth);function y(w){l(w)}function u(w){o(w)}function F(w){s.setLineWidth(w),r(w)}function a(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&n()}return(w,h)=>(p(),m("div",{class:T(["drawing-toolbar",{"toolbar-compact":e.compact}])},[t("div",ye,[t("button",{onClick:h[0]||(h[0]=v=>y("pen")),class:T(["tool-btn",{active:f.value==="pen"}]),title:"ç•«ç­†"},[h[2]||(h[2]=t("span",{class:"tool-icon"},"âœï¸",-1)),e.compact?$("",!0):(p(),m("span",be,"ç•«ç­†"))],2),t("button",{onClick:h[1]||(h[1]=v=>y("eraser")),class:T(["tool-btn",{active:f.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[h[3]||(h[3]=t("span",{class:"tool-icon"},"ğŸ§¹",-1)),e.compact?$("",!0):(p(),m("span",Fe,"æ©¡çš®æ“¦"))],2)]),f.value==="pen"?(p(),m("div",Ce,[t("div",{class:T(["color-grid",{"color-grid-compact":e.compact}])},[(p(),m(Y,null,A(d,v=>t("div",{key:v,onClick:k=>u(v),class:T(["color-cell",{selected:C.value===v}]),style:J({backgroundColor:v}),title:v},null,14,Re)),64))],2)])):$("",!0),t("div",Se,[t("div",ke,[(p(),m(Y,null,A([2,5,10,15],v=>t("div",{key:v,onClick:k=>F(v),class:T(["size-dot",{active:R.value===v}]),style:J({width:`${v+8}px`,height:`${v+8}px`}),title:`${v}px`},null,14,De)),64))])]),t("div",$e,[t("button",{onClick:a,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[h[4]||(h[4]=t("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),e.compact?$("",!0):(p(),m("span",We,"æ¸…ç©º"))])])],2))}}),xe=B(Te,[["__scopeId","data-v-7e7250c3"]]),Ge={class:"player-list"},Le={class:"player-list-header"},Me={class:"player-count"},Ve={class:"player-rank"},Ee={class:"player-info"},Pe={class:"player-name"},Be={key:0,class:"drawer-badge"},Ie={key:1,class:"host-badge"},Ne={class:"player-score"},Ye={key:0,class:"winner-banner"},Ae={class:"winner-text"},Je={class:"winner-name"},Ue={class:"winner-score"},Xe=E({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(e){const s=I(),l=O(),o=P(),{playerRankings:r,winner:n}=Q(),d=x(()=>r.value);function f(u){return s.participants.find(a=>a.user_id===u)?.nickname||"æœªçŸ¥ç©å®¶"}function C(u){return o.user?.id===u}function R(u){return s.currentRoom?.host_id===u}function y(u){return l.currentRound?.drawer_id===u}return(u,F)=>(p(),m("div",Ge,[t("div",Le,[t("span",Me,"ç©å®¶ ("+W(d.value.length)+")",1)]),(p(!0),m(Y,null,A(d.value,(a,w)=>(p(),m("div",{key:a.id,class:T(["player-item",{"is-current":C(a.user_id)},{"is-drawer":y(a.user_id)}])},[t("div",Ve,W(w+1),1),t("div",{class:T(["player-avatar",{drawing:y(a.user_id)}])},W(f(a.user_id).charAt(0)),3),t("div",Ee,[t("div",Pe,[U(W(f(a.user_id))+" ",1),y(a.user_id)?(p(),m("span",Be,"âœï¸")):$("",!0),R(a.user_id)?(p(),m("span",Ie,"ğŸ‘‘")):$("",!0)]),t("div",Ne,W(a.score)+" åˆ†",1)])],2))),128)),e.showWinner&&_(n)?(p(),m("div",Ye,[F[1]||(F[1]=t("div",{class:"winner-icon"},"ğŸ†",-1)),t("div",Ae,[F[0]||(F[0]=t("div",{class:"winner-title"},"ç²å‹è€…",-1)),t("div",Je,W(f(_(n).user_id)),1),t("div",Ue,W(_(n).score)+" åˆ†",1)])])):$("",!0)]))}}),H=B(Xe,[["__scopeId","data-v-4094673d"]]);function Oe(){const e=O(),s=P(),{calculateGuessScore:l,updatePlayerScore:o}=Q(),r=D(""),n=D(null),d=D(!1),f=x(()=>e.isCurrentDrawer?e.currentWord:null),C=x(()=>e.correctGuesses),R=x(()=>s.user?e.hasGuessed(s.user.id):!1);async function y(){if(!e.currentRound||!s.user)return n.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!r.value.trim())return n.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(r.value.length>32)return n.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(R.value)return n.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(e.isCurrentDrawer)return n.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{d.value=!0,n.value=null;const a=r.value.trim(),w=e.currentWord||"",h=u(a,w),v=h?l(C.value.length):0,{data:k,error:G}=await ie.from("guesses").insert({round_id:e.currentRound.id,user_id:s.user.id,guess_text:a,is_correct:h,score_earned:v}).select().single();if(G)throw G;return e.guesses.push(k),h&&s.user&&await o(s.user.id,v),h&&(r.value=""),{success:!0,isCorrect:h,guess:k}}catch(a){return n.value=a instanceof Error?a.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",a),{success:!1,error:n.value}}finally{d.value=!1}}function u(a,w){const h=a.trim(),v=w.trim();return h===v}function F(){n.value=null}return{guessInput:r,error:n,loading:d,currentWord:f,correctGuesses:C,hasGuessed:R,submitGuess:y,clearError:F}}const qe={class:"game-container"},ze={key:0,class:"container margin-top-large"},He={class:"row flex-center"},Ke={class:"col-12 col-md-8"},je={key:1,class:"game-layout"},Qe={class:"game-sidebar game-players"},Ze={class:"player-list-container"},et={class:"game-main"},tt={class:"game-header"},st={key:0,class:"word-display"},ot={class:"word-text"},nt={key:1,class:"word-display"},at={class:"game-canvas-area"},it={class:"game-toolbar"},rt={class:"game-canvas"},lt={key:0,class:"time-progress"},ct={class:"game-bottom"},ut={class:"game-answer"},dt={class:"answer-messages"},vt={key:0,class:"answer-info"},ht={class:"answer-info"},ft={class:"answer-input"},mt=["placeholder","disabled"],pt={key:2,class:"container margin-top-large"},gt={class:"row flex-center"},_t={class:"col-12 col-md-8"},wt={class:"card"},yt={class:"card-body text-center"},bt=E({__name:"RoomView",setup(e){const s=re(),l=I(),o=O(),r=P(),{subscribeRoom:n,subscribeGuesses:d,unsubscribeRoom:f}=X(),{isPlaying:C,isWaiting:R,isFinished:y,timeRemaining:u,isCountingDown:F,isCurrentDrawer:a,drawTime:w,startGame:h}=he(),{hasGuessed:v,guessInput:k,submitGuess:G,loading:S}=Oe(),{leaveRoom:c}=fe(),i=x(()=>l.currentRoom),g=x(()=>S.value);async function L(){!a.value&&k.value.trim()&&await G()}async function se(){(await h()).success}async function N(){(await c()).success}function oe(){console.log("è·³éè©èª")}return K(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",s.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",i.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",r.user?.id);const M=s.params.code;M&&!i.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",M),i.value&&r.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",i.value.status),await o.loadCurrentRound(i.value.id),n(i.value.code,i.value.id,r.user.id,{nickname:r.profile?.display_name||"ç©å®¶"}),o.currentRound&&d(i.value.code,o.currentRound.id))}),j(()=>{i.value&&f(i.value.code)}),(M,b)=>(p(),m("div",qe,[_(R)?(p(),m("div",ze,[t("div",He,[t("div",Ke,[V(me,{room:i.value,participants:_(l).participants,onStartGame:se,onLeaveRoom:N},null,8,["room","participants"])])])])):_(C)?(p(),m("div",je,[t("div",Qe,[t("div",Ze,[V(H,{"show-winner":!1})])]),t("div",et,[t("div",tt,[_(a)&&_(o).currentWord?(p(),m("div",st,[b[1]||(b[1]=t("span",{class:"word-label"},"æç¤º",-1)),t("span",ot,W(_(o).currentWord),1),t("button",{class:"skip-btn",onClick:oe,title:"è·³éæ­¤è©"},"è·³é")])):(p(),m("div",nt,[...b[2]||(b[2]=[t("span",{class:"word-hint"},"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ",-1)])])),t("button",{class:"leave-btn",onClick:N,title:"é›¢é–‹æˆ¿é–“"},"âœ•")]),t("div",at,[t("div",it,[V(xe,{compact:!0})]),t("div",rt,[V(we),_(F)&&_(u)!==null?(p(),m("div",lt,[t("div",{class:T(["time-bar",{"time-warning":_(u)<=10}]),style:J({width:`${_(u)/_(w)*100}%`})},null,6)])):$("",!0)])]),t("div",ct,[t("div",ut,[b[5]||(b[5]=t("div",{class:"answer-header"},"ç­”æ¡ˆ",-1)),t("div",dt,[_(a)?(p(),m("div",vt,[...b[3]||(b[3]=[t("span",{class:"info-icon"},"â„¹ï¸",-1),U(" ç­‰å¾…ç©å®¶åŠ å…¥ ",-1)])])):$("",!0),t("div",ht,[b[4]||(b[4]=t("span",{class:"info-icon"},"âœï¸",-1)),U(" "+W(_(a)?"è¼ªåˆ°ä½ äº†ï¼":"è¼¸å…¥ä½ çš„ç­”æ¡ˆ"),1)])]),t("div",ft,[ce(t("input",{"onUpdate:modelValue":b[0]||(b[0]=ne=>ve(k)?k.value=ne:null),type:"text",placeholder:_(a)?"è¼ªåˆ°ä½ äº†":"è¼¸å…¥ç­”æ¡ˆ...",maxlength:"32",disabled:g.value||_(v)||_(a),onKeyup:de(L,["enter"])},null,40,mt),[[ue,_(k)]])])]),b[6]||(b[6]=le('<div class="game-chat" data-v-258aa2e0><div class="chat-header" data-v-258aa2e0>èŠå¤©å®¤</div><div class="chat-messages" data-v-258aa2e0><div class="chat-msg" data-v-258aa2e0><span class="chat-icon" data-v-258aa2e0>â„¹ï¸</span> æ­¡è¿ä¾†åˆ°éŠæˆ²ï¼</div></div><div class="chat-input" data-v-258aa2e0><input type="text" placeholder="è«‹ç™»å…¥ä»¥ç™¼é€è¨Šæ¯" disabled data-v-258aa2e0></div></div>',1))])])])):_(y)?(p(),m("div",pt,[t("div",gt,[t("div",_t,[t("div",wt,[t("div",yt,[b[7]||(b[7]=t("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),V(H,{"show-winner":!0}),t("button",{onClick:N,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):$("",!0)]))}}),Rt=B(bt,[["__scopeId","data-v-258aa2e0"]]);export{Rt as default};
