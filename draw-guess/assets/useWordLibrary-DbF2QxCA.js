import{u as A,f as S,r as l,s as o}from"./index-CtMWR567.js";const n=l([]),i=l({}),d=l(!1),m=l({}),v=l(null),u=l(!1);function M(){const g=A(),w=S(()=>u.value);async function c(e=!1){if(!g.profile?.email)return u.value=!1,!1;if(u.value&&!e)return!0;const{data:r,error:t}=await o.from("word_library_admins").select("email").eq("email",g.profile.email).maybeSingle();return t?(console.warn("[WordLibrary] 檢查管理員權限失敗:",t),u.value=!1,!1):(u.value=!!r,u.value)}async function p(e={}){try{d.value=!0,v.value=null;let r=o.from("word_collections").select("id, slug, title, description, entry_count, is_active").order("title",{ascending:!0});e.includeInactive||(r=r.eq("is_active",!0));const{data:t,error:s}=await r;if(s)throw s;return n.value=t||[],n.value}catch(r){return v.value=r instanceof Error?r.message:"載入詞句庫失敗",[]}finally{d.value=!1}}async function E(e,r=!1){if(!r&&i.value[e])return i.value[e];m.value[e]=!0;try{const{data:t,error:s}=await o.from("word_entries").select("id, collection_id, text, category").eq("collection_id",e).order("text",{ascending:!0});if(s)throw s;return i.value[e]=t||[],i.value[e]}catch(t){return v.value=t instanceof Error?t.message:"載入詞句條目失敗",i.value[e]=[],[]}finally{m.value[e]=!1}}async function h(e){if(await c(),!u.value)return{success:!1,error:"您沒有管理員權限"};const r=e.slug||e.title.trim().toLowerCase().replace(/\s+/g,"-"),t={title:e.title.trim(),slug:r,description:e.description?.trim()||null},{data:s,error:a}=await o.from("word_collections").insert(t).select("id, slug, title, description, entry_count, is_active").single();return a?{success:!1,error:a.message||"新增主題失敗"}:(n.value=[...n.value,s],{success:!0,collection:s})}async function x(e,r,t){if(await c(),!u.value)return{success:!1,error:"您沒有管理員權限"};const s=r.trim();if(!s)return{success:!1,error:"詞句不可為空"};const{data:a,error:y}=await o.from("word_entries").insert({collection_id:e,text:s,category:t?.trim()||null}).select("id, collection_id, text, category").single();if(y)return{success:!1,error:y.message||"新增條目失敗"};const _=a,C=i.value[e]||[];return i.value[e]=[...C,_],n.value=n.value.map(f=>f.id===e?{...f,entry_count:(f.entry_count||0)+1}:f),{success:!0,entry:_}}async function q(e,r){if(await c(),!u.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await o.from("word_entries").delete().eq("id",e);if(t)return{success:!1,error:t.message||"刪除失敗"};const s=i.value[r]||[];return i.value[r]=s.filter(a=>a.id!==e),n.value=n.value.map(a=>a.id===r?{...a,entry_count:Math.max(0,(a.entry_count||1)-1)}:a),{success:!0}}async function b(e,r){if(await c(),!u.value)return{success:!1,error:"您沒有管理員權限"};const{error:t}=await o.from("word_collections").update({is_active:r}).eq("id",e);return t?{success:!1,error:t.message||"更新狀態失敗"}:(n.value=n.value.map(s=>s.id===e?{...s,is_active:r}:s),{success:!0})}return{collections:n,entriesMap:i,loadingCollections:d,loadingEntries:m,error:v,isAdmin:w,refreshAdminStatus:c,loadCollections:p,loadEntries:E,addCollection:h,addEntry:x,deleteEntry:q,toggleCollectionActive:b}}export{M as u};
