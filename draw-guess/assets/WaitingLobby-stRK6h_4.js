const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C5eGgDbh.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as lr,f as S,x as Ae,c as j,o as z,y as Tr,a as Se,e as I,z as xr,A as He,r as U,u as de,D as h,K as Oe,h as Mr,t as F,q as se,n as ze,F as Ye,l as Nr,b as ne,_ as Pr}from"./index-C5eGgDbh.js";const Dr=["width","height","fill","transform"],qr={key:0},kr=I("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),Or=[kr],Hr={key:1},$r=I("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Br=I("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Ur=[$r,Br],Wr={key:2},Zr=I("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Lr=[Zr],Vr={key:3},jr=I("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),zr=[jr],Yr={key:4},Kr=I("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Fr=[Kr],Xr={key:5},Jr=I("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Qr=[Jr],et={name:"PhPaintBrush"},Wt=lr({...et,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const g=e,a=Ae("weight","regular"),d=Ae("size","1em"),A=Ae("color","currentColor"),M=Ae("mirrored",!1),w=S(()=>g.weight??a),Z=S(()=>g.size??d),D=S(()=>g.color??A),R=S(()=>g.mirrored!==void 0?g.mirrored?"scale(-1, 1)":void 0:M?"scale(-1, 1)":void 0);return(_,G)=>(z(),j("svg",xr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:Z.value,height:Z.value,fill:D.value,transform:R.value},_.$attrs),[Tr(_.$slots,"default"),w.value==="bold"?(z(),j("g",qr,Or)):w.value==="duotone"?(z(),j("g",Hr,Ur)):w.value==="fill"?(z(),j("g",Wr,Lr)):w.value==="light"?(z(),j("g",Vr,zr)):w.value==="regular"?(z(),j("g",Yr,Fr)):w.value==="thin"?(z(),j("g",Xr,Qr)):Se("",!0)],16,Dr))}}),Ee=He("room",()=>{const e=U(null),g=U([]),a=U(!1),d=U(null),A=S(()=>{const r=de();return e.value?.host_id===r.user?.id});async function M(r){try{a.value=!0,d.value=null;const t=de();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(E){console.warn("載入用戶資料時發生錯誤（非關鍵）:",E)}const l=r.gameMode||"classic";if(l==="classic"&&r.words.length<6)throw new Error("至少需要 6 個詞語");let p=null,C=0;const H=10;for(;C<H&&!p;){C++;const $={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null,game_mode:l,single_round_mode:r.singleRoundMode||!1,is_final_round:!1},{data:V,error:n}=await h.from("game_rooms").insert($).select().single();if(n){if(n.code==="23505")continue;throw new Error(n.message||"插入房間失敗")}if(V){p=V;break}}if(!p)throw new Error("無法生成唯一房間碼，請重試");const s={room_id:p.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:E}=await h.from("room_participants").insert(s);E&&console.error("創建參與記錄錯誤:",E)}catch(E){console.error("創建參與記錄時發生錯誤:",E)}try{const{data:E,error:$}=await h.from("room_participants").select("*").eq("room_id",p.id).order("joined_at",{ascending:!0});$?console.error("載入參與者列表失敗:",$):E&&(g.value=E)}catch(E){console.error("載入參與者列表時發生錯誤:",E)}return e.value=p,{success:!0,room:p}}catch(t){return d.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:d.value}}finally{a.value=!1}}async function w(r,t){try{a.value=!0,d.value=null;const l=de();if(!l.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:p,error:C}=await h.from("game_rooms").select("*").eq("code",r).single();if(C||!p)throw new Error("房間不存在");if(p.status!=="waiting")throw new Error("房間已開始或已結束");const{data:H}=await h.from("room_participants").select("*").eq("room_id",p.id).eq("user_id",l.user.id).maybeSingle();if(H)return e.value=p,await D(p.id),{success:!0,room:p};const{error:s}=await h.from("room_participants").insert({room_id:p.id,user_id:l.user.id,nickname:t.trim(),score:0});if(s){if(s.code==="23505"||s.message.includes("duplicate"))return e.value=p,await D(p.id),{success:!0,room:p};throw s}return e.value=p,await D(p.id),{success:!0,room:p}}catch(l){return d.value=l instanceof Error?l.message:"加入房間失敗",console.error("加入房間錯誤:",l),{success:!1,error:d.value}}finally{a.value=!1}}async function Z(){try{if(!e.value)return{success:!0};a.value=!0,d.value=null;const r=de();if(!r.user)throw new Error("請先登入");const{error:t}=await h.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(A.value){const{error:l}=await h.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);l&&console.error("關閉房間失敗:",l)}return e.value=null,g.value=[],{success:!0}}catch(r){return d.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,g.value=[],{success:!1,error:d.value}}finally{a.value=!1}}async function D(r){try{const{data:t,error:l}=await h.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(l)throw l;g.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function R(r){try{a.value=!0,d.value=null;const{data:t,error:l}=await h.from("game_rooms").select("*").eq("id",r).single();if(l)throw l;return e.value=t,await D(r),{success:!0,room:t}}catch(t){return d.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:d.value}}finally{a.value=!1}}async function _(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await h.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(r==="finished"&&e.value&&await G(),e.value){const l=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:l,newStatus:e.value.status})}return{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:d.value}}}async function G(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:r,error:t}=await h.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(t){console.error("獲取參與者錯誤:",t);return}if(!r||r.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const l=r.map(s=>s.user_id),{data:p,error:C}=await h.from("users").select("id, user_type").in("id",l);if(C){console.error("獲取用戶信息錯誤:",C);return}const H=new Set(p?.filter(s=>s.user_type==="registered").map(s=>s.id)||[]);for(const s of r){if(!H.has(s.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${s.user_id} 的積分累積`);continue}if(s.score>0){const{error:E}=await h.rpc("accumulate_user_score",{user_id_param:s.user_id,score_to_add:s.score});if(E){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",E);const{data:$,error:V}=await h.from("users").select("total_score").eq("id",s.user_id).single();if(V){console.error(`[RoomStore] 獲取用戶 ${s.user_id} 總積分錯誤:`,V);continue}const n=($?.total_score||0)+s.score,{error:m}=await h.from("users").update({total_score:n}).eq("id",s.user_id);m?console.error(`[RoomStore] 更新用戶 ${s.user_id} 總積分錯誤:`,m):console.log(`[RoomStore] 用戶 ${s.user_id} 積分已累積: +${s.score} (總積分: ${n})`)}else console.log(`[RoomStore] 用戶 ${s.user_id} 積分已累積: +${s.score}`)}}}catch(r){console.error("[RoomStore] 累積積分錯誤:",r)}}async function q(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await h.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:d.value}}}async function O(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:r});const t={...e.value.settings,...r},{error:l}=await h.from("game_rooms").update({settings:t}).eq("id",e.value.id);if(l)throw l;return e.value&&(e.value.settings=t,console.log("[RoomStore] 房間設置已更新:",t)),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",t),{success:!1,error:d.value}}}function W(){e.value=null,g.value=[],d.value=null}function Y(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function i(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!A.value)return{success:!1,error:"只有房主可以踢人"};const t=de();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};a.value=!0,d.value=null;const{data:l,error:p}=await h.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(p)throw new Error(p.message);if(l&&!l.success)throw new Error(l.error||"踢出玩家失敗");return await D(e.value.id),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:d.value}}finally{a.value=!1}}async function f(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:r});const{error:t}=await h.from("game_rooms").update({is_final_round:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.is_final_round=r,console.log("[RoomStore] 最後一局標記已更新:",r)),{success:!0}}catch(t){return d.value=t instanceof Error?t.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",t),{success:!1,error:d.value}}}return{currentRoom:e,participants:g,loading:a,error:d,isHost:A,createRoom:M,joinRoom:w,leaveRoom:Z,kickPlayer:i,loadParticipants:D,loadRoom:R,updateRoomStatus:_,updateRoomDrawer:q,updateRoomSettings:O,setCurrentDrawer:Y,setFinalRound:f,clearRoom:W}});function rt(){const e=Ee(),g=S(()=>e.currentRoom),a=S(()=>e.participants),d=S(()=>e.isHost),A=S(()=>g.value&&g.value.game_mode==="storyboard"?3:2),M=S(()=>!g.value||g.value.status!=="waiting"||!d.value?!1:a.value.length>=A.value);async function w(R){return await e.createRoom(R)}async function Z(R,_){return await e.joinRoom(R,_)}async function D(){return await e.leaveRoom()}return{currentRoom:g,participants:a,isHost:d,canStartGame:M,minPlayersRequired:A,loading:S(()=>e.loading),error:S(()=>e.error),createRoom:w,joinRoom:Z,leaveRoom:D}}const Ke=100,Fe=50,Xe=10,tt=10,Je=100,Qe=[1,.8,.6,.4,.2];function ot(){const e=Ee();function g(R){const _=Math.min(R,Qe.length-1),G=Qe[_]??0;return Math.round(Ke*G)}function a(R,_=0){if(R===0)return 0;const G=R*Xe,q=Math.round(_*tt);return Fe+G+q}async function d(R,_,G=0){const q=a(_,G);return q===0?!0:await A(R,q)}async function A(R,_){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:G,error:q}=await h.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",R).single();if(q)throw q;const O=(G?.score||0)+_,{error:W}=await h.from("room_participants").update({score:O}).eq("room_id",e.currentRoom.id).eq("user_id",R);if(W)throw W;const Y=e.participants.findIndex(i=>i.user_id===R);return Y!==-1&&e.participants[Y]&&(e.participants[Y].score=O),!0}catch(G){return console.error("更新玩家分數錯誤:",G),!1}}function M(){if(!e.participants||e.participants.length===0)return null;const R=[...e.participants].sort((_,G)=>G.score-_.score);return R.length===1||R[0]&&R[1]&&R[0].score>R[1].score?{user_id:R[0]?.user_id||"",score:R[0]?.score||0}:{user_id:R[0]?.user_id||"",score:R[0]?.score||0}}const w=S(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((_,G)=>G.score!==_.score?G.score-_.score:new Date(_.joined_at).getTime()-new Date(G.joined_at).getTime()).map((_,G)=>({id:_.id,user_id:_.user_id,score:_.score,rank:G+1}))),Z=S(()=>e.currentRoom?.status!=="finished"?null:M());function D(){return Je}return{GUESS_BASE_SCORE:Ke,DRAWING_BASE_SCORE:Fe,DRAWING_BONUS_PER_GUESS:Xe,WINNER_BONUS:Je,calculateGuessScore:g,calculateDrawingScore:a,calculateWinner:M,updatePlayerScore:A,updateDrawerScore:d,playerRankings:w,winner:Z,getWinnerBonus:D}}const dr=He("game",()=>{const e=Ee(),g=de(),a=U(null),d=U(null),A=U([]),M=S(()=>A.value.filter(u=>u.is_correct)),w=S(()=>a.value?A.value.filter(u=>u.round_id===a.value.id):[]),Z=S(()=>w.value.filter(u=>u.is_correct)),D=U("drawing"),R=U([]),_=U([]),G=U(!1),q=U([]),O=S(()=>_.value.length===0?0:_.value.reduce((c,T)=>c+T.rating,0)/_.value.length);function W(u){D.value=u}function Y(u){R.value=u}function i(u){const c=_.value.findIndex(T=>T.rater_id===u.rater_id);c>=0?_.value[c]=u:_.value.push(u)}function f(){_.value=[]}function r(){if(G.value||!d.value)return null;const u=d.value.length,c=[];for(let k=0;k<u;k++)q.value.includes(k)||c.push(k);if(c.length===0)return null;const T=Math.floor(Math.random()*c.length),N=c[T];return N===void 0?null:(q.value.push(N),G.value=!0,N)}function t(u,c){G.value=u,q.value=c}function l(){G.value=!1,q.value=[]}async function p(u){try{const{data:c,error:T}=await h.from("game_rounds").select("*").eq("room_id",u).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(T)throw T;return c&&(a.value=c,d.value=c.word_text,c.word_options&&Array.isArray(c.word_options)&&(R.value=c.word_options),c.hint_given!==void 0&&(G.value=c.hint_given),c.revealed_indices&&Array.isArray(c.revealed_indices)&&(q.value=c.revealed_indices),await C(c.id)),{success:!0,round:c}}catch(c){return console.error("載入當前輪次錯誤:",c),{success:!1,error:c instanceof Error?c.message:"載入輪次失敗"}}}async function C(u){try{const{data:c,error:T}=await h.from("guesses").select("*").eq("round_id",u).order("guessed_at",{ascending:!0});if(T)throw T;const N=c||[],k=new Set(A.value.map(ee=>ee.id)),Q=N.filter(ee=>!k.has(ee.id));Q.length>0&&(A.value=[...A.value,...Q])}catch(c){console.error("載入猜測記錄錯誤:",c)}}async function H(u){try{const{data:c,error:T}=await h.from("game_rounds").select("id").eq("room_id",u);if(T)throw T;if(!c||c.length===0){A.value=[];return}const N=c.map(ee=>ee.id),{data:k,error:Q}=await h.from("guesses").select("*").in("round_id",N).order("guessed_at",{ascending:!0});if(Q)throw Q;A.value=k||[]}catch(c){console.error("載入所有猜測記錄錯誤:",c)}}async function s(u,c,T,N){try{if(!e.currentRoom)throw new Error("沒有當前房間");const k=(e.currentRoom.current_round||0)+1,{data:Q,error:ee}=await h.from("game_rounds").insert({room_id:u,round_number:k,drawer_id:c,word_text:T,word_source:N}).select().single();if(ee)throw ee;return a.value=Q,d.value=T,await h.from("game_rooms").update({current_round:k,current_drawer_id:c}).eq("id",u),{success:!0,round:Q}}catch(k){return console.error("創建輪次錯誤:",k),{success:!1,error:k instanceof Error?k.message:"創建輪次失敗"}}}function E(u){return a.value?A.value.some(c=>c.round_id===a.value.id&&c.user_id===u&&c.is_correct):!1}const $=S(()=>!a.value||!g.user?!1:a.value.drawer_id===g.user.id);async function V(){if(!a.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const u=M.value.length,c=O.value,{updateDrawerScore:T}=ot();console.log("[endRound] 猜中人數:",u,"平均評分:",c),await T(a.value.drawer_id,u,c);const{error:N}=await h.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",a.value.id);if(N)throw N;return{success:!0}}catch(u){return console.error("結束輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"結束輪次失敗"}}}function n(){a.value=null,d.value=null,A.value=[],D.value="drawing",R.value=[],_.value=[],G.value=!1,q.value=[]}async function m(u,c,T){if(!g.user)return{success:!1,error:"用戶未登錄"};try{const{data:N,error:k}=await h.from("drawing_ratings").upsert({round_id:u,rater_id:g.user.id,drawer_id:c,rating:T},{onConflict:"round_id,rater_id"}).select().single();if(k)throw k;return N&&i(N),{success:!0,rating:N}}catch(N){return console.error("提交評分錯誤:",N),{success:!1,error:N instanceof Error?N.message:"提交評分失敗"}}}async function v(u){try{const{data:c,error:T}=await h.from("drawing_ratings").select("*").eq("round_id",u);if(T)throw T;return _.value=c||[],{success:!0,ratings:c}}catch(c){return console.error("載入評分錯誤:",c),{success:!1,error:c instanceof Error?c.message:"載入評分失敗"}}}return{currentRound:a,currentWord:d,guesses:A,correctGuesses:M,currentRoundGuesses:w,currentRoundCorrectGuesses:Z,isCurrentDrawer:$,roundStatus:D,wordOptions:R,ratings:_,averageRating:O,hintGiven:G,revealedIndices:q,loadCurrentRound:p,loadGuesses:C,loadAllGuesses:H,createRound:s,hasGuessed:E,endRound:V,clearGame:n,setRoundStatus:W,setWordOptions:Y,addRating:i,clearRatings:f,submitRating:m,loadRatings:v,giveHint:r,setHintState:t,resetHint:l}});function er(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function rr(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function tr(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}function Zt(e){return e.trim().length===0}function Lt(e,g=100){return e.length>g}const nt=He("story",()=>{const e=de(),g=U([]),a=U([]),d=U([]),A=U("setup"),M=U(!1),w=U(null),Z=S(()=>{const n=g.value.filter(m=>m.itemType==="text");return n.length===0?null:n[n.length-1]}),D=S(()=>{if(g.value.length===0)return null;const n=g.value[0];return n&&n.itemType==="text"?n.content:null}),R=S(()=>e.user&&a.value.find(n=>n.userId===e.user.id)||null),_=S(()=>e.user&&d.value.find(n=>n.voterId===e.user.id)||null),G=S(()=>{const n=new Map;for(const m of a.value)n.set(m.id,0);for(const m of d.value){const v=n.get(m.submissionId)||0;n.set(m.submissionId,v+1)}return n}),q=S(()=>{if(a.value.length===0)return null;let n=-1,m=[];for(const v of a.value){const u=G.value.get(v.id)||0;u>n?(n=u,m=[v]):u===n&&m.push(v)}return m.length>0?m[0]:null});async function O(n){try{M.value=!0,w.value=null;const{data:m,error:v}=await h.from("story_chains").select("*").eq("room_id",n).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return g.value=(m||[]).map(u=>er(u)),console.log("[StoryStore] 故事鏈已載入:",g.value.length,"項"),{success:!0,data:g.value}}catch(m){return w.value=m instanceof Error?m.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",m),{success:!1,error:w.value}}finally{M.value=!1}}async function W(n){try{M.value=!0,w.value=null;const m={room_id:n.roomId,round_number:n.roundNumber,item_type:n.itemType,content:n.content,author_id:n.authorId,author_name:n.authorName},{data:v,error:u}=await h.from("story_chains").insert(m).select().single();if(u)throw new Error(u.message);const c=er(v);return g.value.push(c),console.log("[StoryStore] 故事鏈項目已添加:",c),{success:!0,data:c}}catch(m){return w.value=m instanceof Error?m.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",m),{success:!1,error:w.value}}finally{M.value=!1}}async function Y(n,m,v,u){return W({roomId:n,roundNumber:0,itemType:"text",content:m,authorId:v,authorName:u})}async function i(n,m,v,u){return W({roomId:n,roundNumber:-1,itemType:"text",content:m,authorId:v,authorName:u})}async function f(n){try{M.value=!0,w.value=null;const{data:m,error:v}=await h.from("story_submissions").select("*").eq("round_id",n).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return a.value=(m||[]).map(u=>rr(u)),console.log("[StoryStore] 句子提交已載入:",a.value.length,"項"),{success:!0,data:a.value}}catch(m){return w.value=m instanceof Error?m.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",m),{success:!1,error:w.value}}finally{M.value=!1}}async function r(n,m){if(!e.user)return{success:!1,error:"用戶未登錄"};try{M.value=!0,w.value=null;const v={round_id:n,user_id:e.user.id,sentence:m.trim(),vote_count:0,is_winner:!1},{data:u,error:c}=await h.from("story_submissions").upsert(v,{onConflict:"round_id,user_id"}).select().single();if(c)throw new Error(c.message);const T=rr(u),N=a.value.findIndex(k=>k.roundId===n&&k.userId===e.user.id);return N>=0?a.value[N]=T:a.value.push(T),console.log("[StoryStore] 句子已提交:",T),{success:!0,data:T}}catch(v){return w.value=v instanceof Error?v.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",v),{success:!1,error:w.value}}finally{M.value=!1}}async function t(n){try{const{error:m}=await h.from("story_submissions").update({is_winner:!0}).eq("id",n);if(m)throw new Error(m.message);const v=a.value.find(u=>u.id===n);return v&&(v.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",n),{success:!0}}catch(m){return w.value=m instanceof Error?m.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",m),{success:!1,error:w.value}}}async function l(n){try{M.value=!0,w.value=null;const{data:m,error:v}=await h.from("story_votes").select("*").eq("round_id",n);if(v)throw new Error(v.message);return d.value=(m||[]).map(u=>tr(u)),console.log("[StoryStore] 投票記錄已載入:",d.value.length,"項"),{success:!0,data:d.value}}catch(m){return w.value=m instanceof Error?m.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",m),{success:!1,error:w.value}}finally{M.value=!1}}async function p(n,m){if(!e.user)return{success:!1,error:"用戶未登錄"};try{M.value=!0,w.value=null;const v={round_id:n,voter_id:e.user.id,submission_id:m},{data:u,error:c}=await h.from("story_votes").upsert(v,{onConflict:"round_id,voter_id"}).select().single();if(c)throw new Error(c.message);const T=tr(u),N=d.value.findIndex(k=>k.roundId===n&&k.voterId===e.user.id);return N>=0?d.value[N]=T:d.value.push(T),console.log("[StoryStore] 投票已記錄:",T),{success:!0,data:T}}catch(v){return w.value=v instanceof Error?v.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",v),{success:!1,error:w.value}}finally{M.value=!1}}function C(n){A.value=n,console.log("[StoryStore] 階段已更新:",n)}function H(){a.value=[],d.value=[],console.log("[StoryStore] 輪次數據已清除")}function s(){g.value=[],a.value=[],d.value=[],A.value="setup",w.value=null,console.log("[StoryStore] 所有故事數據已清除")}function E(n){g.value.some(v=>v.id===n.id)||(g.value.push(n),console.log("[StoryStore] 本地添加故事鏈項目:",n))}function $(n){const m=a.value.findIndex(v=>v.id===n.id);m>=0?a.value[m]=n:a.value.push(n),console.log("[StoryStore] 本地添加句子提交:",n)}function V(n){const m=d.value.findIndex(v=>v.roundId===n.roundId&&v.voterId===n.voterId);m>=0?d.value[m]=n:d.value.push(n),console.log("[StoryStore] 本地添加投票記錄:",n)}return{storyChain:g,submissions:a,votes:d,currentPhase:A,loading:M,error:w,latestSentence:Z,storyOpening:D,mySubmission:R,myVote:_,voteCounts:G,winningSubmission:q,loadStoryChain:O,addStoryChainItem:W,addStoryOpening:Y,addStoryEnding:i,addStoryChainItemLocal:E,loadSubmissions:f,submitSentence:r,markWinningSubmission:t,addSubmissionLocal:$,loadVotes:l,castVote:p,addVoteLocal:V,setPhase:C,clearRoundData:H,clearAll:s}}),te=new Map,oe=U("disconnected"),ie=new Map,be=new Set,Te=new Map,ve=new Map,st=10,or=1e3,at=3e4;function ce(...e){}function J(...e){console.warn("[Realtime]",...e)}function ct(){const e=navigator.userAgent;return/^((?!chrome|android).)*safari/i.test(e)}function ae(){const e=Ee(),g=dr();function a(i){const f=`room:${i}`;if(te.has(f))return te.get(f);const r=h.channel(f,{config:{presence:{key:"user"},broadcast:{self:!0}}});return te.set(f,r),r}function d(i){const f=Te.get(i);f&&(clearTimeout(f),Te.delete(i))}function A(i,f,r,t,l){if(i==="SUBSCRIBED")oe.value="connected",d(r),ve.set(r,0),(async(C=3)=>{for(let H=0;H<C;H++)try{await f.track({user_id:t,...l}),ce("Presence track 成功");return}catch(s){J(`Presence track 失敗 (嘗試 ${H+1}/${C}):`,s),H<C-1&&await new Promise(E=>setTimeout(E,500*(H+1)))}})();else if(i==="CHANNEL_ERROR"||i==="TIMED_OUT"){oe.value="disconnected";const p=ve.get(r)||0;J("訂閱失敗:",i,"(嘗試次數:",p,", 瀏覽器:",navigator.userAgent.slice(0,50),")"),M(r,t,l)}else i==="CLOSED"&&(oe.value="disconnected")}function M(i,f,r){const t=ve.get(i)||0;if(t>=st){J(`重連失敗次數過多 (${t} 次)，停止重連。請刷新頁面重試。`),oe.value="disconnected";return}d(i),ve.set(i,t+1);const l=ct()?or*1.5:or,p=Math.min(l*Math.pow(1.5,t),at),C=window.setTimeout(async()=>{const H=`room:${i}`;let s=te.get(H),E=!1;if(s){const $=s.state;if($==="errored"||$==="closed"){try{h.removeChannel(s)}catch(V){J("移除舊 Channel 失敗:",V)}te.delete(H),be.delete(i),s=void 0,E=!0}}if(!s||E){try{s=h.channel(H,{config:{presence:{key:"user"},broadcast:{self:!0}}}),te.set(H,s),oe.value="connecting",s.subscribe($=>{A($,s,i,f,r)})}catch($){J("重建 Channel 失敗:",$),M(i,f,r)}return}s.state!=="joined"&&(oe.value="connecting",s.subscribe($=>{A($,s,i,f,r)}))},p);Te.set(i,C)}function w(i,f,r,t){return new Promise((l,p)=>{if(!i||!f){J("缺少 roomCode 或 roomId"),p(new Error("缺少 roomCode 或 roomId"));return}const C=a(i),H=C.state;if(H==="joined"){oe.value="connected",l(C);return}if(H==="joining"){const s=setInterval(()=>{const E=C.state;E==="joined"?(clearInterval(s),l(C)):(E==="closed"||E==="errored")&&(clearInterval(s),p(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(s),C.state!=="joined"&&p(new Error("連接超時"))},5e3);return}if(be.has(i)){oe.value="connecting",C.subscribe(s=>{A(s,C,i,r,t),s==="SUBSCRIBED"?l(C):(s==="CHANNEL_ERROR"||s==="TIMED_OUT")&&p(new Error(`訂閱失敗: ${s}`))});return}C.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${f}`},async s=>{ce("房間狀態變化:",s.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${f}`},async s=>{ce("參與者變化:",s.eventType),await e.loadParticipants(f)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${f}`},async s=>{ce("輪次變化:",s.eventType,s.new),e.currentRoom&&await g.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async s=>{const E=s.new;if(E&&g.currentRound&&(await g.loadGuesses(E.round_id),E.is_correct&&e.isHost&&g.roundStatus==="drawing")){const $=g.currentRound.drawer_id,V=e.participants.filter(v=>v.user_id!==$),n=new Set(g.currentRoundCorrectGuesses.map(v=>v.user_id));if(V.length>0&&V.every(v=>n.has(v.user_id))){const{useGame:v}=await Oe(async()=>{const{useGame:c}=await Promise.resolve().then(()=>it);return{useGame:c}},void 0),{endRound:u}=v();await u()}}}).on("broadcast",{event:"drawing"},s=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(s));const E=ie.get(i);E&&s.payload?.stroke?(console.log("[Realtime] 分發給",E.size,"個回調"),E.forEach($=>$(s.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",E?.size,"stroke:",s.payload?.stroke)}).on("presence",{event:"sync"},()=>{const s=C.presenceState();ce("Presence 同步，在線:",Object.keys(s).length)}),be.add(i),oe.value="connecting",C.subscribe(s=>{A(s,C,i,r,t),s==="SUBSCRIBED"?l(C):(s==="CHANNEL_ERROR"||s==="TIMED_OUT")&&p(new Error(`訂閱失敗: ${s}`))})})}function Z(i,f){return ie.has(i)||ie.set(i,new Set),ie.get(i).add(f),()=>{ie.get(i)?.delete(f)}}function D(i,f){const r=a(i),t=`guesses:${f}`;return r[t]||(r.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${f}`},async l=>{ce("收到新猜測記錄:",l.eventType,l.new),await g.loadGuesses(f)}),r[t]=!0),r}function R(i,f){const r=a(i),t=`gameState:${i}`;return r[t]||(r.on("broadcast",{event:"game_state"},l=>{ce("收到遊戲狀態廣播:",l.payload),f(l.payload)}),r[t]=!0),r}async function _(i,f){const r=a(i),t=r.state;if(t!=="joined")return J("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{ce("廣播遊戲狀態:",f);const l=await r.send({type:"broadcast",event:"game_state",payload:f});return l==="error"?(J("發送遊戲狀態失敗"),{error:"發送失敗"}):l}catch(l){return J("發送遊戲狀態錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}async function G(i,f){const r=a(i),t=r.state;if(t!=="joined")return J("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const l=await r.send({type:"broadcast",event:"drawing",payload:{stroke:f}});return l==="error"?(J("發送失敗"),{error:"發送失敗"}):l}catch(l){return J("發送錯誤:",l),{error:l instanceof Error?l.message:"發送失敗"}}}function q(i){const f=`room:${i}`,r=te.get(f);d(i),ve.delete(i),r&&(h.removeChannel(r),te.delete(f)),ie.delete(i),be.delete(i)}async function O(i,f,r,t){const l=`room:${i}`,p=te.get(l);if(!p){await w(i,f,r,t);return}p.state!=="joined"&&(ve.set(i,0),M(i,r,t))}function W(){Te.forEach((i,f)=>d(f)),te.forEach(i=>h.removeChannel(i)),te.clear(),ie.clear(),be.clear()}function Y(){return oe.value}return{connectionStatus:oe,subscribeRoom:w,subscribeDrawing:Z,subscribeGuesses:D,subscribeGameState:R,sendDrawing:G,broadcastGameState:_,unsubscribeRoom:q,unsubscribeAll:W,getConnectionStatus:Y,checkAndRestoreConnection:O}}const nr=6,sr=60,ar=60,cr=60,ut=5,Pe=10,De=5,qe=2,ur=3,we=U(null),ke=U(!1);let he=null;const le=U(null);let _e=null;const xe=U(new Set),ir=U("setup"),pe=U(null);let ye=null;function mr(){const e=Ee(),g=dr(),a=nt();ae();const d=we,A=ke,M=le,w=S(()=>e.currentRoom?.status||"waiting"),Z=S(()=>w.value==="playing"),D=S(()=>w.value==="waiting"),R=S(()=>w.value==="finished"),_=S(()=>g.roundStatus),G=S(()=>_.value==="drawing"),q=S(()=>_.value==="summary"),O=S(()=>e.currentRoom?.game_mode==="storyboard"),W=ir,Y=pe,i=S(()=>O.value&&W.value==="drawing"),f=S(()=>O.value&&W.value==="writing"),r=S(()=>O.value&&W.value==="voting"),t=S(()=>O.value&&W.value==="summary"),l=S(()=>O.value&&W.value==="setup"),p=S(()=>O.value&&W.value==="ending"),C=S(()=>g.currentRound),H=S(()=>e.currentRoom?.current_round||0),s=S(()=>e.currentRoom?.settings.rounds||0),E=S(()=>e.currentRoom?.settings.draw_time||60),$=S(()=>g.isCurrentDrawer);function V(o){console.log("[useGame] startCountdown 開始，時長:",o,"秒"),he&&clearInterval(he),we.value=o,ke.value=!0,he=window.setInterval(()=>{we.value!==null&&we.value>0?we.value--:(n(),Z.value&&C.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),Q()))},1e3)}function n(){he&&(clearInterval(he),he=null),ke.value=!1}function m(){n(),we.value=null}function v(){console.log("[useGame] startSummaryCountdown 開始"),_e&&clearInterval(_e),le.value=nr,console.log("[useGame] 開始總結倒計時:",nr,"秒"),_e=window.setInterval(async()=>{le.value!==null&&le.value>0?(le.value--,console.log("[useGame] 總結倒計時:",le.value)):(u(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await ee()))},1e3)}function u(){console.log("[useGame] stopSummaryCountdown"),_e&&(clearInterval(_e),_e=null),le.value=null}function c(){if(!e.currentRoom)return null;const o=e.currentRoom.words;if(o.length===0)return null;const y=[];for(let P=0;P<o.length;P++)xe.value.has(P)||y.push(P);let b=0;if(y.length>0){const P=Math.floor(Math.random()*y.length);b=y[P]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),xe.value.clear(),b=Math.floor(Math.random()*o.length);return xe.value.add(b),o[b]??null}async function T(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{xe.value.clear();const o=e.participants.length,y=await e.updateRoomSettings({rounds:o});if(!y.success)return y;console.log("[useGame] 輪數已自動設定為房間人數:",o);const b=await e.updateRoomStatus("playing");if(!b.success)return b;if(O.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),ue("setup"),a.clearAll();const{broadcastGameState:x}=ae();return await x(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await N()}catch(o){return console.error("開始遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"開始遊戲失敗"}}}async function N(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const y=(e.currentRoom.current_round||0)+1;try{const b=(y-1)%e.participants.length,P=e.participants[b];if(console.log("[startDrawingPhase] 第",y,"輪，畫家:",P?.nickname),!P)throw new Error("無法選擇畫家");let x=null;if(O.value){const re=a.latestSentence;re?(x={text:re.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",x.text)):(x={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(x=c(),!x)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",x.text)}await e.updateRoomDrawer(P.user_id);const B=await g.createRound(e.currentRoom.id,P.user_id,x.text,x.source);if(!B.success||!B.round)throw new Error("創建輪次失敗");const{broadcastGameState:X}=ae();return O.value?await X(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:P.user_id,drawerName:P.nickname,roundNumber:y,startedAt:B.round.started_at}):await X(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:P.user_id,drawerName:P.nickname,roundNumber:y,startedAt:B.round.started_at}),{success:!0,drawerId:P.user_id,word:x.text}}catch(b){return console.error("開始繪畫階段錯誤:",b),{success:!1,error:b instanceof Error?b.message:"開始繪畫階段失敗"}}}async function k(){return await N()}async function Q(){if(!C.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const o=await g.endRound();if(!o.success)return o;const y=!1,{broadcastGameState:b}=ae();return await b(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:y}),{success:!0,gameEnded:y}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}async function ee(){return e.currentRoom?e.isHost?(await N(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function fr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return n(),await e.updateRoomStatus("finished"),{success:!0}}catch(o){return console.error("結束遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束遊戲失敗"}}}async function gr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(_.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),u(),await N()}catch(o){return console.error("下一局錯誤:",o),{success:!1,error:o instanceof Error?o.message:"下一局失敗"}}}const vr=S(()=>{if(d.value===null)return"--:--";const o=Math.floor(d.value/60),y=d.value%60;return`${o.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`});function ue(o){console.log("[useGame] 設置分鏡模式階段:",o),ir.value=o,a.setPhase(o)}function wr(o,y){console.log("[useGame] 開始分鏡模式倒計時:",o,"秒"),ye&&clearInterval(ye),pe.value=o,ye=window.setInterval(()=>{pe.value!==null&&pe.value>0?pe.value--:(Ie(),y&&y())},1e3)}function Ie(){ye&&(clearInterval(ye),ye=null)}function hr(){Ie(),pe.value=null}async function _r(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),ue("drawing"),a.clearRoundData();const{broadcastGameState:o}=ae();return await o(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString()}),{success:!0}}async function pr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段");const o=new Date().toISOString(),{error:y}=await h.from("game_rooms").update({storyboard_phase:"writing",updated_at:o}).eq("id",e.currentRoom.id);y&&console.error("[useGame] 更新數據庫失敗:",y),ue("writing");const{broadcastGameState:b}=ae();return await b(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:o}),{success:!0}}async function yr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段");const o=new Date().toISOString(),{error:y}=await h.from("game_rooms").update({storyboard_phase:"voting",updated_at:o}).eq("id",e.currentRoom.id);y&&console.error("[useGame] 更新數據庫失敗:",y),ue("voting");const{broadcastGameState:b}=ae();return await b(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:o}),{success:!0}}async function Sr(o){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段");const y=new Date().toISOString(),{error:b}=await h.from("game_rooms").update({storyboard_phase:"summary",updated_at:y}).eq("id",e.currentRoom.id);b&&console.error("[useGame] 更新數據庫失敗:",b),ue("summary");const{broadcastGameState:P}=ae();return await P(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary",startedAt:y,storyboardRoundResult:o?{winningSentence:o.winningSentence||"故事繼續發展中...",winnerName:o.winnerName||"",winnerId:o.winnerId||"",winnerVoteCount:o.winnerVoteCount||0,drawerScore:o.drawerScore||0,screenwriterScore:o.screenwriterScore||0}:void 0}),{success:!0}}async function Rr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段");const{error:o}=await h.from("game_rooms").update({storyboard_phase:"ending",updated_at:new Date().toISOString()}).eq("id",e.currentRoom.id);o&&console.error("[useGame] 更新數據庫失敗:",o),ue("ending");const{broadcastGameState:y}=ae();return await y(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function $e(){const o=a.submissions,y=a.votes;if(o.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const b=new Map;for(const L of o)b.set(L.id,0);for(const L of y){const K=b.get(L.submissionId)||0;b.set(L.submissionId,K+1)}let P=-1,x=[];for(const L of o){const K=b.get(L.id)||0;K>P?(P=K,x=[L]):K===P&&x.push(L)}const B=x.length>1;if(x.length===1)return console.log("[useGame] 唯一最高票勝出:",x[0]?.sentence),{submission:x[0]||null,voteCount:P,hasTie:!1};const X=Math.floor(Math.random()*x.length),re=x[X]||null;return console.log("[useGame] 平票隨機選擇勝出:",re?.sentence,"(共",x.length,"個平票)"),{submission:re,voteCount:P,hasTie:B}}async function br(o){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!g.currentRound)return{success:!1,error:"沒有當前輪次"};const y=g.currentRound.round_number,b=g.currentRound.drawer_id,x=e.participants.find(B=>B.user_id===b)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",y);try{const{submission:B,voteCount:X,hasTie:re}=$e();let L,K,fe;B?(L=B.sentence,K=B.userId,fe=e.participants.find(ge=>ge.user_id===K)?.nickname||"編劇",await a.markWinningSubmission(B.id),console.log("[useGame] 勝出句子:",L,"作者:",fe,"票數:",X,"平票:",re)):(L="故事繼續發展中...",K=b,fe=x,console.log("[useGame] 沒有提交，使用默認句子"));let Ge="/placeholder-image.png";if(o)try{const Re=await new Promise(ge=>{o.toBlob(ge,"image/png",.9)});if(Re){const{supabase:ge}=await Oe(async()=>{const{supabase:Ne}=await import("./index-C5eGgDbh.js").then(Ar=>Ar.O);return{supabase:Ne}},__vite__mapDeps([0,1])),Cr=Date.now(),Ve=`storyboard/${e.currentRoom.id}/round_${y}_${Cr}.png`,{error:je}=await ge.storage.from("canvas-snapshots").upload(Ve,Re,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(je)console.error("[useGame] 截圖上傳失敗:",je);else{const{data:Ne}=ge.storage.from("canvas-snapshots").getPublicUrl(Ve);Ge=Ne.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Ge)}}}catch(Re){console.error("[useGame] 截圖上傳錯誤:",Re)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:y,itemType:"image",content:Ge,authorId:b,authorName:x}),await a.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:y,itemType:"text",content:L,authorId:K,authorName:fe}),console.log("[useGame] Story_Chain 已更新");const Ze=a.votes.length;let Ce=0;B&&(Ce=Pe,await me(K,Ce),console.log("[useGame] 編劇勝出得分:",Ce,"分給",fe));const Me=De+Ze*qe;await me(b,Me),console.log("[useGame] 畫家得分:",Me,"分給",x,"(投票人數:",Ze,")");const Le={success:!0,winningSentence:L,winnerName:fe,winnerId:K,winnerVoteCount:X,drawerScore:Me,screenwriterScore:Ce,imageUrl:Ge};return console.log("[useGame] 輪次結算完成:",Le),Le}catch(B){return console.error("[useGame] 輪次結算錯誤:",B),{success:!1,error:B instanceof Error?B.message:"輪次結算失敗"}}}function Er(){const o=document.querySelector("canvas.drawing-canvas");return o||document.querySelector("canvas")||null}function Ir(o){switch(o){case"drawing":return sr;case"writing":return ar;case"voting":return cr;default:return 0}}function Be(){return Pe}function Ue(o){return De+o*qe}function We(o){return Math.round(o*ur)}async function Gr(o,y,b,P=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const x=Be();console.log("[useGame] 編劇勝出得分:",x,"分給",o),await me(o,x);const B=Ue(b);if(console.log("[useGame] 畫家得分:",B,"分給",y,"(投票人數:",b,")"),await me(y,B),P>0){const X=We(P);console.log("[useGame] 評星加分:",X,"分給",y,"(平均評星:",P,")"),await me(y,X)}return{success:!0}}catch(x){return console.error("[useGame] 計算分鏡模式得分錯誤:",x),{success:!1,error:x instanceof Error?x.message:"計算得分失敗"}}}async function me(o,y){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:b}=await Oe(async()=>{const{supabase:L}=await import("./index-C5eGgDbh.js").then(K=>K.O);return{supabase:L}},__vite__mapDeps([0,1])),{data:P,error:x}=await b.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",o).single();if(x)throw x;const B=(P?.score||0)+y,{error:X}=await b.from("room_participants").update({score:B}).eq("room_id",e.currentRoom.id).eq("user_id",o);if(X)throw X;const re=e.participants.findIndex(L=>L.user_id===o);return re!==-1&&e.participants[re]&&(e.participants[re].score=B),console.log("[useGame] 玩家",o,"得分更新為",B),!0}catch(b){return console.error("[useGame] 更新玩家分數錯誤:",b),!1}}return Mr(()=>{n(),u(),Ie()}),{gameStatus:w,isPlaying:Z,isWaiting:D,isFinished:R,currentRound:C,currentRoundNumber:H,totalRounds:s,drawTime:E,isCurrentDrawer:$,timeRemaining:d,isCountingDown:A,formattedTime:vr,roundStatus:_,isDrawing:G,isSummary:q,summaryTimeRemaining:M,isStoryboardMode:O,storyboardPhase:W,storyboardTimeRemaining:Y,isStoryboardDrawing:i,isStoryboardWriting:f,isStoryboardVoting:r,isStoryboardSummary:t,isStoryboardSetup:l,isStoryboardEnding:p,startGame:T,newGame:gr,startNextRound:k,startDrawingPhase:N,endRound:Q,continueToNextRound:ee,endGame:fr,startCountdown:V,stopCountdown:n,startSummaryCountdown:v,stopSummaryCountdown:u,resetCountdown:m,setStoryboardPhase:ue,startStoryboardCountdown:wr,stopStoryboardCountdown:Ie,resetStoryboardCountdown:hr,enterStoryboardDrawingPhase:_r,enterStoryboardWritingPhase:pr,enterStoryboardVotingPhase:yr,enterStoryboardSummaryPhase:Sr,enterStoryboardEndingPhase:Rr,getStoryboardPhaseDuration:Ir,calculateWinningSentence:$e,finalizeStoryboardRound:br,getCanvasElement:Er,calculateScreenwriterWinScore:Be,calculateDirectorScore:Ue,calculateRatingBonus:We,calculateStoryboardRoundScores:Gr,updateStoryboardPlayerScore:me,STORYBOARD_DRAWING_TIME:sr,STORYBOARD_WRITING_TIME:ar,STORYBOARD_VOTING_TIME:cr,STORYBOARD_SUMMARY_TIME:ut,SCREENWRITER_WIN_SCORE:Pe,DIRECTOR_BASE_SCORE:De,DIRECTOR_VOTE_BONUS:qe,RATING_BONUS_MULTIPLIER:ur}}const it=Object.freeze(Object.defineProperty({__proto__:null,useGame:mr},Symbol.toStringTag,{value:"Module"})),lt={class:"waiting-lobby"},dt={class:"card"},mt={class:"card-body"},ft={class:"room-info text-center margin-bottom-medium"},gt={class:"card-title text-hand-title"},vt={class:"room-details"},wt={class:"detail-item margin-bottom-small"},ht={class:"badge badge-secondary room-code-badge"},_t={class:"detail-item margin-bottom-small"},pt={class:"badge"},yt={class:"detail-item"},St={class:"players-section margin-bottom-medium"},Rt={class:"text-hand-title margin-bottom-small"},bt={class:"players-list"},Et={class:"player-avatar"},It={class:"player-info"},Gt={class:"player-name"},Ct={key:0,class:"badge badge-warning"},At={class:"room-settings margin-bottom-medium"},Tt={class:"setting-item"},xt={class:"setting-value"},Mt={class:"setting-item"},Nt={class:"setting-value"},Pt={key:0,class:"setting-item"},Dt={class:"setting-value"},qt={class:"lobby-actions"},kt=["disabled"],Ot={key:1,class:"alert alert-warning text-center"},Ht=["disabled"],$t={key:0,class:"alert alert-danger margin-top-small"},Bt=lr({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:g}){const a=e,d=g,{isHost:A,canStartGame:M,minPlayersRequired:w,leaveRoom:Z,loading:D,error:R}=rt(),{startGame:_}=mr(),G=S(()=>{const f=a.room?.settings.rounds||0,r=a.participants.length,t=f>0?f:r;return t>0?t:1});function q(f){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[f||""]||f||"未知"}function O(f){return{classic:"傳統模式",storyboard:"分鏡接龍"}[f||""]||"傳統模式"}function W(f){return a.room?.host_id===f}async function Y(){(await _()).success&&d("startGame")}async function i(){(await Z()).success&&d("leaveRoom")}return(f,r)=>(z(),j("div",lt,[I("div",dt,[I("div",mt,[I("div",ft,[I("h2",gt,F(e.room?.name),1),I("div",vt,[I("div",wt,[r[0]||(r[0]=se(" 房間碼：",-1)),I("span",ht,F(e.room?.code),1)]),I("div",_t,[r[1]||(r[1]=se(" 狀態：",-1)),I("span",pt,F(q(e.room?.status)),1)]),I("div",yt,[r[2]||(r[2]=se(" 模式：",-1)),I("span",{class:ze(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},F(O(e.room?.game_mode)),3)])])]),I("div",St,[I("h4",Rt,"玩家列表 ("+F(e.participants.length)+")",1),I("div",bt,[(z(!0),j(Ye,null,Nr(e.participants,t=>(z(),j("div",{key:t.id,class:ze(["player-item",{"is-host":W(t.user_id)}])},[I("div",Et,F(t.nickname.charAt(0).toUpperCase()),1),I("div",It,[I("div",Gt,[se(F(t.nickname)+" ",1),W(t.user_id)?(z(),j("span",Ct," 房主 ")):Se("",!0)])])],2))),128))])]),I("div",At,[I("div",Tt,[r[4]||(r[4]=I("span",{class:"setting-label"},"繪畫時間：",-1)),I("span",xt,[I("strong",null,F(e.room?.settings.draw_time),1),r[3]||(r[3]=se("秒",-1))])]),I("div",Mt,[r[6]||(r[6]=I("span",{class:"setting-label"},"每局輪數：",-1)),I("span",Nt,[I("strong",null,F(G.value),1),r[5]||(r[5]=se("輪",-1))])]),e.room?.game_mode!=="storyboard"?(z(),j("div",Pt,[r[8]||(r[8]=I("span",{class:"setting-label"},"詞語總數：",-1)),I("span",Dt,[I("strong",null,F(e.room?.word_count),1),r[7]||(r[7]=se("個",-1))])])):Se("",!0)]),I("div",qt,[ne(A)&&ne(M)?(z(),j("button",{key:0,disabled:ne(D),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:Y},F(ne(D)?"開始中":"開始遊戲"),9,kt)):ne(A)?(z(),j("div",Ot,[se(" 至少需要 "+F(ne(w))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(z(),j(Ye,{key:0},[se(" （分鏡接龍模式） ")],64)):Se("",!0)])):Se("",!0),I("button",{disabled:ne(D),class:"paper-btn btn-secondary btn-block",onClick:i},F(ne(D)?"離開中":"離開房間"),9,Ht)]),ne(R)?(z(),j("div",$t,F(ne(R)),1)):Se("",!0)])])]))}}),Vt=Pr(Bt,[["__scopeId","data-v-04a7dc58"]]);export{Wt as I,Vt as W,ae as a,Ee as b,dr as c,ot as d,nt as e,Zt as f,mr as g,Lt as i,rt as u};
