import{m as ie,r as $,d as j,u as z,i as H,j as K,c as x,e,o as p,_ as U,f as T,a as W,n as L,F as V,p as B,q as E,g as Q,v as Z,t as D,s as N,b as h,x as le,y as de,k as M,w as ue,z as ce}from"./index-BfZJnn8O.js";import{c as P,b as Y,d as J,e as ee,a as he,u as fe,W as me}from"./useRealtime-DsgLV2IV.js";const te=ie("drawing",()=>{const t=$("pen"),n=$("#000000"),i=$(3),s=$(!1),l=$([]);function o(a){t.value=a}function f(a){n.value=a}function b(a){i.value=Math.max(1,Math.min(20,a))}function w(a){l.value.push(a)}function k(){l.value=[]}function g(a){s.value=a}return{tool:t,color:n,lineWidth:i,isDrawing:s,strokes:l,setTool:o,setColor:f,setLineWidth:b,addStroke:w,clearStrokes:k,setDrawing:g}});function A(t,n){const i=t.getBoundingClientRect(),s=t.width/i.width,l=t.height/i.height;let o,f;if(n instanceof MouseEvent)o=n.clientX,f=n.clientY;else if(n instanceof TouchEvent&&n.touches.length>0&&n.touches[0])o=n.touches[0].clientX,f=n.touches[0].clientY;else return null;return{x:(o-i.left)*s,y:(f-i.top)*l}}function ne(t,n){if(!(n.points.length<2)){t.save(),n.tool==="pen"?(t.strokeStyle=n.color,t.lineWidth=n.lineWidth,t.lineCap="round",t.lineJoin="round"):n.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=n.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),n.points[0]&&t.moveTo(n.points[0].x,n.points[0].y);for(let i=1;i<n.points.length;i++){const s=n.points[i];s&&t.lineTo(s.x,s.y)}t.stroke(),t.restore()}}function O(t,n){const i=t.getContext("2d");i&&(i.clearRect(0,0,t.width,t.height),i.fillStyle="#FFFFFF",i.fillRect(0,0,t.width,t.height),n.forEach(s=>{ne(i,s)}))}function ve(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function se(){const t=te(),n=P(),{sendDrawing:i}=Y(),s=$(null),l=$(null),o=$(null),f=$(null);let b=null;const w=50;function k(d){s.value=d;const v=d.getContext("2d",{willReadFrequently:!0});if(!v){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}l.value=v;const r=window.devicePixelRatio||1,G=d.getBoundingClientRect();d.width=G.width*r,d.height=G.height*r,v.scale(r,r),v.canvas.width=G.width,v.canvas.height=G.height,v.fillStyle="#FFFFFF",v.fillRect(0,0,d.width,d.height),s.value&&O(s.value,t.strokes)}function g(d){if(!s.value)return;d.preventDefault(),t.setDrawing(!0);const v=A(s.value,d);v&&(o.value={id:ve(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[v],timestamp:Date.now()},f.value=v)}function a(d){if(!s.value||!l.value||!t.isDrawing||!o.value)return;d.preventDefault();const v=A(s.value,d);if(!v||!f.value)return;const r=l.value;r.save(),o.value.tool==="pen"?(r.strokeStyle=o.value.color,r.lineWidth=o.value.lineWidth,r.lineCap="round",r.lineJoin="round"):o.value.tool==="eraser"&&(r.globalCompositeOperation="destination-out",r.lineWidth=o.value.lineWidth,r.lineCap="round",r.lineJoin="round"),r.beginPath(),r.moveTo(f.value.x,f.value.y),r.lineTo(v.x,v.y),r.stroke(),r.restore(),o.value.points.push(v),f.value=v,b===null&&(b=window.setTimeout(()=>{c(),b=null},w))}function S(){!t.isDrawing||!o.value||(t.setDrawing(!1),b&&(clearTimeout(b),b=null),c(),o.value=null,f.value=null)}async function c(){if(!(!o.value||!n.currentRoom))try{await i(n.currentRoom.code,o.value)}catch(d){console.error("ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",d)}}function R(d){!s.value||!l.value||(t.addStroke(d),ne(l.value,d))}function _(){if(!s.value||!l.value)return;const d=l.value,v=s.value;d.clearRect(0,0,v.width,v.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,v.width,v.height),t.clearStrokes()}function u(d){t.setTool(d)}function m(d){t.setColor(d)}function F(d){t.setLineWidth(d)}function C(){s.value&&O(s.value,t.strokes)}return{canvasRef:s,initCanvas:k,startDrawing:g,draw:a,stopDrawing:S,clearCanvas:_,setTool:u,setColor:m,setLineWidth:F,handleDrawingData:R,redrawStrokes:C}}const xe={class:"drawing-canvas-container"},pe=j({__name:"DrawingCanvas",setup(t){const{initCanvas:n,startDrawing:i,draw:s,stopDrawing:l,handleDrawingData:o}=se(),f=P(),b=z(),{subscribeDrawing:w,unsubscribeRoom:k}=Y(),g=$(null);function a(C){i(C)}function S(C){s(C)}function c(){l()}function R(){l()}function _(C){i(C)}function u(C){s(C)}function m(){l()}function F(){!f.currentRoom||!b.user||w(f.currentRoom.code,C=>{o(C)})}return H(()=>{g.value&&n(g.value),F()}),K(()=>{f.currentRoom&&k(f.currentRoom.code)}),(C,d)=>(p(),x("div",xe,[e("canvas",{ref_key:"canvasElement",ref:g,class:"drawing-canvas",onMousedown:a,onMousemove:S,onMouseup:c,onMouseleave:R,onTouchstart:_,onTouchmove:u,onTouchend:m},null,544)]))}}),ge=U(pe,[["__scopeId","data-v-1ad80f86"]]),be={class:"drawing-toolbar"},_e={class:"flex flex-col gap-1 p-2"},we={key:0,class:"p-2"},ye={class:"grid grid-cols-4 gap-1 mb-2"},ke=["onClick","aria-label"],Fe={class:"mt-2"},Ce={class:"p-2"},Se={class:"flex flex-col items-center gap-2"},Re={class:"text-xs text-text-secondary"},De={class:"flex flex-col items-center gap-1 mt-2"},$e=j({__name:"DrawingToolbar",setup(t){const n=te(),{setTool:i,setColor:s,setLineWidth:l,clearCanvas:o}=se(),f=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],b=[{min:1,max:5,size:4},{min:6,max:10,size:8},{min:11,max:15,size:12},{min:16,max:20,size:16}],w=T(()=>n.tool),k=T(()=>n.color),g=T({get:()=>n.lineWidth,set:_=>n.setLineWidth(_)});function a(){l(g.value)}function S(_){i(_)}function c(_){s(_)}function R(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&o()}return(_,u)=>(p(),x("div",be,[e("div",_e,[e("button",{onClick:u[0]||(u[0]=m=>S("pen")),class:L(["w-12 h-12 rounded-hand flex items-center justify-center transition-all font-hand",w.value==="pen"?"bg-accent-soft-blue text-text-primary shadow-hand":"bg-paper-bg-dark text-text-primary hover:bg-accent-warm"]),title:"ç•«ç­†"},[...u[3]||(u[3]=[e("i",{class:"fas fa-pencil-alt text-lg"},null,-1)])],2),e("button",{onClick:u[1]||(u[1]=m=>S("eraser")),class:L(["w-12 h-12 rounded-hand flex items-center justify-center transition-all font-hand",w.value==="eraser"?"bg-accent-soft-pink text-text-primary shadow-hand":"bg-paper-bg-dark text-text-primary hover:bg-accent-warm"]),title:"æ©¡çš®æ“¦"},[...u[4]||(u[4]=[e("i",{class:"fas fa-eraser text-lg"},null,-1)])],2)]),u[6]||(u[6]=e("div",{class:"border-t border-hand border-border-hand my-2"},null,-1)),w.value==="pen"?(p(),x("div",we,[e("div",ye,[(p(),x(V,null,B(f,m=>e("button",{key:m,onClick:F=>c(m),class:L(["w-8 h-8 rounded-hand border-hand transition-all",k.value===m?"border-border-hand scale-110 shadow-hand":"border-border-hand-light hover:scale-105"]),style:E({backgroundColor:m}),"aria-label":`é¸æ“‡é¡è‰² ${m}`},null,14,ke)),64))]),e("div",Fe,[e("div",{class:"w-full h-12 rounded-hand border-hand border-border-hand shadow-hand-inset",style:E({backgroundColor:k.value})},null,4)])])):W("",!0),u[7]||(u[7]=e("div",{class:"border-t border-hand border-border-hand my-2"},null,-1)),e("div",Ce,[e("div",Se,[Q(e("input",{"onUpdate:modelValue":u[2]||(u[2]=m=>g.value=m),onInput:a,type:"range",min:"1",max:"20",orient:"vertical",class:"w-2 h-32 vertical-slider"},null,544),[[Z,g.value,void 0,{number:!0}]]),e("div",Re,D(g.value)+"px",1)]),e("div",De,[(p(),x(V,null,B(b,(m,F)=>e("div",{key:F,class:L(["rounded-full border-2 transition-all",g.value>=m.min&&g.value<=m.max?"border-blue-500 bg-blue-500":"border-gray-300 dark:border-gray-600 bg-gray-200 dark:bg-gray-700"]),style:E({width:`${m.size}px`,height:`${m.size}px`})},null,6)),64))])]),u[8]||(u[8]=e("div",{class:"border-t border-hand border-border-hand my-2"},null,-1)),e("div",{class:"p-2"},[e("button",{onClick:R,class:"w-full px-3 py-2 bg-accent-soft-pink hover:bg-accent-soft-pink/80 text-text-primary rounded-hand text-sm font-hand shadow-hand transition-all hover:shadow-hand-lg",title:"æ¸…ç©ºç•«å¸ƒ"},[...u[5]||(u[5]=[e("i",{class:"fas fa-trash-alt mr-1"},null,-1),N(" æ¸…ç©º ",-1)])])])]))}}),We=U($e,[["__scopeId","data-v-f7cb00ce"]]),Te={class:"player-list"},Ge={class:"space-y-2"},Le={class:"flex-1 min-w-0"},Me={class:"flex items-center gap-1.5"},Ee={class:"text-sm text-text-primary truncate font-medium"},je={key:0,class:"fas fa-pencil-alt text-xs text-yellow-600 flex-shrink-0",title:"ç•«å®¶"},ze={key:1,class:"text-xs text-text-secondary flex-shrink-0",title:"æˆ¿ä¸»"},Pe={class:"text-xs text-text-secondary"},Ie={key:0,class:"mt-4 p-3 bg-accent-warm/30 border-hand border-accent-warm rounded-hand-lg"},Ve={class:"text-sm font-hand-title text-text-primary text-center"},Be={class:"text-xs text-text-secondary text-center mt-1 font-hand"},Ne=j({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(t){const n=P(),i=J(),s=z(),{playerRankings:l,winner:o}=ee(),f=T(()=>l.value);function b(a){return n.participants.find(c=>c.user_id===a)?.nickname||"æœªçŸ¥ç©å®¶"}function w(a){return s.user?.id===a}function k(a){return n.currentRoom?.host_id===a}function g(a){return i.currentRound?.drawer_id===a}return(a,S)=>(p(),x("div",Te,[e("div",Ge,[(p(!0),x(V,null,B(f.value,c=>(p(),x("div",{key:c.id,class:L(["flex items-center gap-2 p-2 rounded-hand transition-all",w(c.user_id)?"bg-accent-soft-blue/30 border-hand border-accent-soft-blue":"bg-paper-bg-dark border-hand border-border-hand-light"])},[e("div",{class:L(["w-10 h-10 rounded-full flex items-center justify-center text-sm font-hand flex-shrink-0",g(c.user_id)?"bg-accent-warm text-text-primary":"bg-paper-bg-dark text-text-primary"])},D(b(c.user_id).charAt(0)),3),e("div",Le,[e("div",Me,[e("div",Ee,D(b(c.user_id)),1),g(c.user_id)?(p(),x("i",je)):W("",!0),k(c.user_id)?(p(),x("span",ze," (æˆ¿ä¸») ")):W("",!0)]),e("div",Pe," å¾—åˆ† "+D(c.score),1)])],2))),128)),t.showWinner&&h(o)?(p(),x("div",Ie,[e("div",Ve," ğŸ† ç²å‹è€…ï¼š"+D(b(h(o).user_id)),1),e("div",Be," ç¸½åˆ†ï¼š"+D(h(o).score)+" åˆ† ",1)])):W("",!0)])]))}}),q=U(Ne,[["__scopeId","data-v-08956aa1"]]);function Ue(){const t=J(),n=z(),{calculateGuessScore:i,updatePlayerScore:s}=ee(),l=$(""),o=$(null),f=$(!1),b=T(()=>t.isCurrentDrawer?t.currentWord:null),w=T(()=>t.correctGuesses),k=T(()=>n.user?t.hasGuessed(n.user.id):!1);async function g(){if(!t.currentRound||!n.user)return o.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!l.value.trim())return o.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(l.value.length>32)return o.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(k.value)return o.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return o.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{f.value=!0,o.value=null;const c=l.value.trim(),R=t.currentWord||"",_=a(c,R),u=_?i(w.value.length):0,{data:m,error:F}=await le.from("guesses").insert({round_id:t.currentRound.id,user_id:n.user.id,guess_text:c,is_correct:_,score_earned:u}).select().single();if(F)throw F;return t.guesses.push(m),_&&n.user&&await s(n.user.id,u),_&&(l.value=""),{success:!0,isCorrect:_,guess:m}}catch(c){return o.value=c instanceof Error?c.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",c),{success:!1,error:o.value}}finally{f.value=!1}}function a(c,R){const _=c.trim(),u=R.trim();return _===u}function S(){o.value=null}return{guessInput:l,error:o,loading:f,currentWord:b,correctGuesses:w,hasGuessed:k,submitGuess:g,clearError:S}}const Ye={class:"min-h-screen bg-paper-bg"},Je={class:"container mx-auto p-4 h-screen flex flex-col"},Xe={key:0,class:"mb-4 flex items-center justify-between"},Ae={class:"flex items-center gap-4"},Oe={class:"text-xl font-hand-title text-text-primary"},qe={class:"text-sm text-text-secondary"},He={class:"font-mono"},Ke={class:"flex items-center gap-2"},Qe={key:1,class:"px-3 py-1.5 bg-accent-soft-blue text-text-primary rounded-hand text-sm font-hand-title shadow-hand"},Ze={key:1,class:"mb-4"},et={class:"flex items-center justify-between mb-2"},tt={class:"text-2xl font-hand-title text-text-primary"},nt={class:"text-sm text-text-secondary"},st={class:"font-mono"},ot={key:2,class:"flex-1 flex items-center justify-center"},rt={key:3,class:"flex-1 flex gap-4 min-h-0 overflow-hidden"},at={class:"flex-shrink-0 w-64 panel-hand overflow-hidden flex flex-col"},it={class:"flex-1 overflow-y-auto p-2"},lt={class:"flex-1 flex flex-col min-w-0 min-h-0"},dt={class:"flex-1 panel-hand overflow-hidden flex items-center justify-center p-4"},ut={key:0,class:"mt-2 h-2 bg-paper-bg-dark rounded-hand overflow-hidden border-hand border-border-hand-light"},ct={class:"mt-2 flex gap-4"},ht={class:"flex-1 panel-hand p-3 flex flex-col"},ft={class:"bg-paper-bg-dark rounded-hand p-2 mb-2 min-h-[60px] max-h-[100px] overflow-y-auto text-xs text-text-secondary flex-1"},mt={key:0,class:"text-center text-text-primary font-medium"},vt={key:1,class:"text-center text-green-600"},xt={key:2,class:"text-center text-text-secondary"},pt={key:0,class:"space-y-2"},gt=["disabled"],bt=["disabled"],_t={class:"flex-shrink-0 w-20 panel-hand overflow-y-auto"},wt={key:4,class:"flex-1 flex items-center justify-center"},yt={class:"text-center"},Ct=j({__name:"RoomView",setup(t){const n=de(),i=P(),s=J(),l=z(),{subscribeRoom:o,subscribeGuesses:f,unsubscribeRoom:b}=Y(),{isPlaying:w,isWaiting:k,isFinished:g,timeRemaining:a,isCountingDown:S,formattedTime:c,isCurrentDrawer:R,drawTime:_,startGame:u}=he(),{hasGuessed:m,guessInput:F,submitGuess:C,loading:d}=Ue(),{leaveRoom:v}=fe(),r=T(()=>i.currentRoom),G=T(()=>d.value);async function oe(){await C()}async function re(){(await u()).success}async function X(){(await v()).success}return H(async()=>{n.params.code&&r.value,r.value&&l.user&&(await s.loadCurrentRound(r.value.id),o(r.value.code,r.value.id,l.user.id,{nickname:l.profile?.display_name||"ç©å®¶"}),s.currentRound&&f(r.value.code,s.currentRound.id))}),K(()=>{r.value&&b(r.value.code)}),(I,y)=>(p(),x("div",Ye,[e("div",Je,[h(w)?(p(),x("div",Xe,[e("div",Ae,[e("h1",Oe,D(r.value?.name||"éŠæˆ²æˆ¿é–“"),1),e("div",qe,[y[1]||(y[1]=N(" æˆ¿é–“ç¢¼ï¼š",-1)),e("span",He,D(r.value?.code),1)])]),e("div",Ke,[W("",!0),h(R)&&h(s).currentWord?(p(),x("div",Qe,D(h(s).currentWord),1)):W("",!0),W("",!0),h(S)?(p(),x("div",{key:3,class:L(["text-lg font-hand-title px-3 py-1.5 rounded-hand",h(a)&&h(a)<=10?"bg-accent-soft-pink/50 text-text-primary shadow-hand":"bg-paper-bg-dark text-text-primary shadow-hand-inset"])},D(h(c)),3)):W("",!0),W("",!0),e("button",{onClick:X,class:"btn-minimal text-sm px-2 py-1.5",title:"é›¢é–‹æˆ¿é–“"},[...y[4]||(y[4]=[e("i",{class:"fas fa-times"},null,-1)])])])])):(p(),x("div",Ze,[e("div",et,[e("h1",tt,D(r.value?.name||"éŠæˆ²æˆ¿é–“"),1)]),e("div",nt,[y[5]||(y[5]=N(" æˆ¿é–“ç¢¼ï¼š",-1)),e("span",st,D(r.value?.code),1)])])),h(k)?(p(),x("div",ot,[M(me,{room:r.value,participants:h(i).participants,onStartGame:re,onLeaveRoom:X},null,8,["room","participants"])])):h(w)?(p(),x("div",rt,[e("div",at,[y[6]||(y[6]=e("div",{class:"p-3 border-b border-hand border-border-hand"},[e("h3",{class:"text-sm font-hand text-text-primary"},"ç©å®¶åˆ—è¡¨")],-1)),e("div",it,[M(q,{"show-winner":!1})])]),e("div",lt,[e("div",dt,[M(ge,{class:"w-full h-full max-w-full max-h-full"})]),h(S)&&h(a)!==null?(p(),x("div",ut,[e("div",{class:L(["h-full transition-all duration-1000 rounded-hand",h(a)<=10?"bg-accent-soft-pink":"bg-accent-soft-blue"]),style:E({width:`${h(a)/h(_)*100}%`})},null,6)])):W("",!0),e("div",ct,[e("div",ht,[y[7]||(y[7]=e("button",{class:"btn-hand text-sm mb-2 self-start"},"ç­”æ¡ˆ",-1)),e("div",ft,[h(R)?(p(),x("div",mt," è¼ªåˆ°ä½ äº†ï¼ ")):h(m)?(p(),x("div",vt," å·²çŒœä¸­ï¼ ")):(p(),x("div",xt," ç­‰å¾…ç©å®¶åŠ å…¥... "))]),h(R)?W("",!0):(p(),x("div",pt,[e("form",{onSubmit:ue(oe,["prevent"]),class:"flex gap-2"},[Q(e("input",{"onUpdate:modelValue":y[0]||(y[0]=ae=>ce(F)?F.value=ae:null),type:"text",class:"input-minimal flex-1 text-sm",placeholder:"è¼ªåˆ°ä½ äº†",maxlength:"32",disabled:G.value||h(m)},null,8,gt),[[Z,h(F)]]),e("button",{type:"submit",disabled:G.value||h(m)||!h(F).trim(),class:"btn-minimal px-3 py-1.5 text-sm"},D(G.value?"æäº¤ä¸­...":h(m)?"å·²çŒœä¸­":"æäº¤"),9,bt)],32)]))]),y[8]||(y[8]=e("div",{class:"w-64 panel-hand p-3 flex flex-col"},[e("button",{class:"btn-hand text-sm mb-2 self-start"},"èŠå¤©å®¤"),e("div",{class:"bg-paper-bg-dark rounded-hand p-2 mb-2 min-h-[60px] max-h-[100px] overflow-y-auto text-xs text-text-secondary flex-1"},[e("div",{class:"text-center text-text-secondary"},"èŠå¤©åŠŸèƒ½å³å°‡æ¨å‡º")])],-1))])]),e("div",_t,[M(We)])])):h(g)?(p(),x("div",wt,[e("div",yt,[y[9]||(y[9]=e("h2",{class:"text-2xl font-hand-title text-text-primary mb-4"},"éŠæˆ²çµæŸ",-1)),M(q,{"show-winner":!0})])])):W("",!0)])]))}});export{Ct as default};
