import{l as Ie,r as I,u as z,f as G,d as Y,i as re,m as ae,c as l,e,o as c,_ as X,n as E,a as M,F as B,p as H,q as oe,t as _,b as o,s as K,h as j,x as J,y as Ge,j as P,g as Me,v as Le,z as Ee,A as Ve,k as Ne,B as Be}from"./index-B968t1Rz.js";import{c as Q,b as ie,d as le,e as pe,a as ge,u as Pe,W as He}from"./WaitingLobby-DJBJ2njt.js";const ye=Ie("drawing",()=>{const s=I("pen"),r=I("#000000"),d=I(3),v=I(!1),t=I([]);function a(b){s.value=b}function p(b){r.value=b}function g(b){d.value=Math.max(1,Math.min(20,b))}function y(b){t.value.push(b)}function C(){t.value=[]}function S(b){v.value=b}return{tool:s,color:r,lineWidth:d,isDrawing:v,strokes:t,setTool:a,setColor:p,setLineWidth:g,addStroke:y,clearStrokes:C,setDrawing:S}});function _e(s,r){const d=s.getBoundingClientRect();let v,t;if(r instanceof MouseEvent)v=r.clientX,t=r.clientY;else if(r instanceof TouchEvent&&r.touches.length>0&&r.touches[0])v=r.touches[0].clientX,t=r.touches[0].clientY;else return null;return{x:v-d.left,y:t-d.top}}function be(s,r){if(!(r.points.length<2)){s.save(),r.tool==="pen"?(s.strokeStyle=r.color,s.lineWidth=r.lineWidth,s.lineCap="round",s.lineJoin="round"):r.tool==="eraser"&&(s.globalCompositeOperation="destination-out",s.lineWidth=r.lineWidth,s.lineCap="round",s.lineJoin="round"),s.beginPath(),r.points[0]&&s.moveTo(r.points[0].x,r.points[0].y);for(let d=1;d<r.points.length;d++){const v=r.points[d];v&&s.lineTo(v.x,v.y)}s.stroke(),s.restore()}}function ne(s,r){const d=s.getContext("2d");if(!d)return;const v=s.getBoundingClientRect();d.clearRect(0,0,s.width,s.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,v.width,v.height),r.forEach(t=>{be(d,t)})}function Ae(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Re(){const s=ye(),r=Q(),d=z(),{sendDrawing:v}=ie(),t=G(()=>!d.user||!r.currentRoom?!1:r.currentRoom.current_drawer_id===d.user.id),a=I(null),p=I(null),g=I(null),y=I(null);let C=null;const S=50;function b(h){a.value=h;const F=h.getContext("2d",{willReadFrequently:!0});if(!F){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}p.value=F;const W=window.devicePixelRatio||1,A=h.getBoundingClientRect();h.width=A.width*W,h.height=A.height*W,F.scale(W,W),F.fillStyle="#FFFFFF",F.fillRect(0,0,A.width,A.height),a.value&&ne(a.value,s.strokes),new ResizeObserver(()=>{if(!a.value||!p.value)return;const N=a.value.getBoundingClientRect(),O=window.devicePixelRatio||1;a.value.width=N.width*O,a.value.height=N.height*O,p.value.scale(O,O),p.value.fillStyle="#FFFFFF",p.value.fillRect(0,0,N.width,N.height),ne(a.value,s.strokes)}).observe(h)}function D(h){if(!a.value)return;if(!t.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}h.preventDefault(),s.setDrawing(!0);const F=_e(a.value,h);F&&(g.value={id:Ae(),tool:s.tool,color:s.color,lineWidth:s.lineWidth,points:[F],timestamp:Date.now()},y.value=F)}function R(h){if(!a.value||!p.value||!s.isDrawing||!g.value)return;h.preventDefault();const F=_e(a.value,h);if(!F||!y.value)return;const W=p.value;W.save(),g.value.tool==="pen"?(W.strokeStyle=g.value.color,W.lineWidth=g.value.lineWidth,W.lineCap="round",W.lineJoin="round"):g.value.tool==="eraser"&&(W.globalCompositeOperation="destination-out",W.lineWidth=g.value.lineWidth,W.lineCap="round",W.lineJoin="round"),W.beginPath(),W.moveTo(y.value.x,y.value.y),W.lineTo(F.x,F.y),W.stroke(),W.restore(),g.value.points.push(F),y.value=F,C===null&&(C=window.setTimeout(()=>{f(),C=null},S))}function k(){!s.isDrawing||!g.value||(s.setDrawing(!1),C&&(clearTimeout(C),C=null),f(),g.value=null,y.value=null)}async function f(){if(!(!g.value||!r.currentRoom||!d.user))try{const h={...g.value,userId:d.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",h.id),await v(r.currentRoom.code,h)}catch(h){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",h)}}function n(h){if(!(!a.value||!p.value)){if(h.userId&&d.user&&h.userId===d.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",h.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",h.id),s.addStroke(h),be(p.value,h)}}function i(){if(!a.value||!p.value)return;const h=p.value,F=a.value;h.clearRect(0,0,F.width,F.height),h.fillStyle="#FFFFFF",h.fillRect(0,0,F.width,F.height),s.clearStrokes()}function m(h){s.setTool(h)}function $(h){s.setColor(h)}function V(h){s.setLineWidth(h)}function L(){a.value&&ne(a.value,s.strokes)}return{canvasRef:a,initCanvas:b,startDrawing:D,draw:R,stopDrawing:k,clearCanvas:i,setTool:m,setColor:$,setLineWidth:V,handleDrawingData:n,redrawStrokes:L}}const Oe={class:"drawing-canvas-container"},ze=Y({__name:"DrawingCanvas",setup(s){const{initCanvas:r,startDrawing:d,draw:v,stopDrawing:t,handleDrawingData:a,clearCanvas:p}=Re(),g=Q(),y=z(),{subscribeDrawing:C}=ie(),S=I(null);function b(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),p()}function D(L){d(L)}function R(L){v(L)}function k(){t()}function f(){t()}function n(L){d(L)}function i(L){v(L)}function m(){t()}let $=null;function V(){!g.currentRoom||!y.user||($=C(g.currentRoom.code,L=>{a(L)}))}return re(()=>{S.value&&r(S.value),V(),window.addEventListener("clearCanvas",b)}),ae(()=>{$&&($(),$=null),window.removeEventListener("clearCanvas",b)}),(L,h)=>(c(),l("div",Oe,[e("canvas",{ref_key:"canvasElement",ref:S,class:"drawing-canvas",onMousedown:D,onMousemove:R,onMouseup:k,onMouseleave:f,onTouchstart:n,onTouchmove:i,onTouchend:m},null,544)]))}}),Ue=X(ze,[["__scopeId","data-v-f29d9704"]]),qe={class:"toolbar-section"},Je={key:0,class:"tool-label"},Ke={key:0,class:"tool-label"},Ye={key:0,class:"toolbar-section colors-section"},Xe=["onClick","title"],je={class:"toolbar-section size-section"},Qe={class:"size-dots"},Ze=["onClick","title"],es={class:"toolbar-section"},ss={key:0,class:"tool-label"},ts=Y({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(s){const r=ye(),{setTool:d,setColor:v,setLineWidth:t,clearCanvas:a}=Re(),p=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],g=G(()=>r.tool),y=G(()=>r.color),C=G(()=>r.lineWidth);function S(k){d(k)}function b(k){v(k)}function D(k){r.setLineWidth(k),t(k)}function R(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&a()}return(k,f)=>(c(),l("div",{class:E(["drawing-toolbar",{"toolbar-compact":s.compact}])},[e("div",qe,[e("button",{onClick:f[0]||(f[0]=n=>S("pen")),class:E(["tool-btn",{active:g.value==="pen"}]),title:"ç•«ç­†"},[f[2]||(f[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),s.compact?M("",!0):(c(),l("span",Je,"ç•«ç­†"))],2),e("button",{onClick:f[1]||(f[1]=n=>S("eraser")),class:E(["tool-btn",{active:g.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[f[3]||(f[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),s.compact?M("",!0):(c(),l("span",Ke,"æ©¡çš®æ“¦"))],2)]),g.value==="pen"?(c(),l("div",Ye,[e("div",{class:E(["color-grid",{"color-grid-compact":s.compact}])},[(c(),l(B,null,H(p,n=>e("div",{key:n,onClick:i=>b(n),class:E(["color-cell",{selected:y.value===n}]),style:oe({backgroundColor:n}),title:n},null,14,Xe)),64))],2)])):M("",!0),e("div",je,[e("div",Qe,[(c(),l(B,null,H([2,5,10,15],n=>e("div",{key:n,onClick:i=>D(n),class:E(["size-dot",{active:C.value===n}]),style:oe({width:`${n+8}px`,height:`${n+8}px`}),title:`${n}px`},null,14,Ze)),64))])]),e("div",es,[e("button",{onClick:R,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[f[4]||(f[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),s.compact?M("",!0):(c(),l("span",ss,"æ¸…ç©º"))])])],2))}}),fe=X(ts,[["__scopeId","data-v-7e7250c3"]]),ns={class:"player-list"},os={class:"player-list-header"},rs={class:"player-count"},as={class:"player-rank"},is={class:"player-info"},ls={class:"player-name"},cs={key:0,class:"drawer-badge"},us={key:1,class:"host-badge"},ds={class:"player-score"},vs=["onClick"],ms={key:0,class:"winner-banner"},hs={class:"winner-text"},gs={class:"winner-name"},_s={class:"winner-score"},fs=Y({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(s,{emit:r}){const d=r,v=Q(),t=le(),a=z(),{playerRankings:p,winner:g}=pe(),y=G(()=>p.value),C=I(!1);function S(n){return v.participants.find(m=>m.user_id===n)?.nickname||"æœªçŸ¥ç©å®¶"}function b(n){return a.user?.id===n}function D(n){return v.currentRoom?.host_id===n}function R(n){return t.currentRound?.drawer_id===n||v.currentRoom?.current_drawer_id===n}function k(n){return v.isHost&&!b(n)}async function f(n,i){if(!(C.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${i} å—ï¼Ÿ`))){C.value=!0;try{const $=await v.kickPlayer(n);$.success?d("player-kicked",n):alert($.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch($){console.error("è¸¢äººå¤±æ•—:",$),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{C.value=!1}}}return(n,i)=>(c(),l("div",ns,[e("div",os,[e("span",rs,"ç©å®¶ ("+_(y.value.length)+")",1)]),(c(!0),l(B,null,H(y.value,(m,$)=>(c(),l("div",{key:m.id,class:E(["player-item",{"is-current":b(m.user_id)},{"is-drawer":R(m.user_id)}])},[e("div",as,_($+1),1),e("div",{class:E(["player-avatar",{drawing:R(m.user_id)}])},_(S(m.user_id).charAt(0)),3),e("div",is,[e("div",ls,[K(_(S(m.user_id))+" ",1),R(m.user_id)?(c(),l("span",cs,"âœï¸")):M("",!0),D(m.user_id)?(c(),l("span",us,"ğŸ‘‘")):M("",!0)]),e("div",ds,_(m.score)+" åˆ†",1)]),k(m.user_id)?(c(),l("button",{key:0,class:"kick-btn",onClick:V=>f(m.user_id,S(m.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,vs)):M("",!0)],2))),128)),s.showWinner&&o(g)?(c(),l("div",ms,[i[1]||(i[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",hs,[i[0]||(i[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",gs,_(S(o(g).user_id)),1),e("div",_s,_(o(g).score)+" åˆ†",1)])])):M("",!0)]))}}),we=X(fs,[["__scopeId","data-v-984c1c4a"]]),ws={class:"round-summary"},ps={class:"summary-card"},ys={key:0,class:"selection-waiting-banner"},bs={class:"waiting-text"},Rs={class:"next-drawer-name"},ks={class:"summary-header"},Cs={class:"summary-title"},$s={class:"round-info"},Ss={class:"answer-reveal"},Fs={class:"answer-text"},Ds={class:"drawer-section"},Ws={class:"drawer-info"},xs={class:"drawer-name"},Ts={key:0,class:"drawer-score"},Is={class:"guessers-section"},Gs={key:0,class:"no-guessers"},Ms={key:1,class:"guessers-list"},Ls={class:"guesser-rank"},Es={class:"guesser-name"},Vs={class:"guesser-score"},Ns={key:1,class:"rating-section"},Bs={class:"star-rating"},Ps=["onMouseenter","onClick","disabled"],Hs={class:"rating-info"},As={key:0,class:"rated-text"},Os={key:1,class:"rate-hint"},zs={key:2,class:"average-rating"},Us={class:"avg-score"},qs={class:"avg-stars"},Js={class:"avg-count"},Ks=Y({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(s,{emit:r}){const d=s,v=r,t=z(),a=I(0),p=I(0),g=I(!1),y=I([]),C=G(()=>t.user?.id===d.drawerId),S=G(()=>y.value.length===0?0:y.value.reduce((i,m)=>i+m.rating,0)/y.value.length),b=G(()=>y.value.length);async function D(n){if(!(g.value||C.value||!t.user))try{const{error:i}=await J.from("drawing_ratings").upsert({round_id:d.roundId,rater_id:t.user.id,drawer_id:d.drawerId,rating:n},{onConflict:"round_id,rater_id"});if(i)throw i;a.value=n,g.value=!0,v("rating-submitted",n)}catch(i){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",i)}}async function R(){try{const{data:n,error:i}=await J.from("drawing_ratings").select("rater_id, rating").eq("round_id",d.roundId);if(i)throw i;if(y.value=n||[],t.user){const m=y.value.find($=>$.rater_id===t.user.id);m&&(a.value=m.rating,g.value=!0)}}catch(n){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",n)}}function k(){const n=J.channel(`ratings:${d.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${d.roundId}`},()=>{R()}).subscribe();return()=>{J.removeChannel(n)}}let f=null;return re(()=>{R(),f=k()}),ae(()=>{f&&f()}),j(()=>d.roundId,()=>{R()}),(n,i)=>(c(),l("div",ws,[e("div",ps,[s.isWaitingForSelection?(c(),l("div",ys,[i[2]||(i[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",bs,[e("span",Rs,_(s.nextDrawerName),1),i[1]||(i[1]=K(" æ­£åœ¨é¸è©... ",-1))]),i[3]||(i[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",ks,[e("h2",Cs,_(s.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",$s,"ç¬¬ "+_(s.roundNumber)+" / "+_(s.totalRounds)+" è¼ª",1)]),e("div",Ss,[i[4]||(i[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Fs,_(s.correctAnswer),1)]),e("div",Ds,[e("div",Ws,[i[5]||(i[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",xs,_(s.drawerName),1),s.drawerScore>0?(c(),l("span",Ts,"+"+_(s.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",Is,[i[6]||(i[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),s.correctGuessers.length===0?(c(),l("div",Gs," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(c(),l("div",Ms,[(c(!0),l(B,null,H(s.correctGuessers,(m,$)=>(c(),l("div",{key:m.userId,class:"guesser-item"},[e("span",Ls,_($+1),1),e("span",Es,_(m.name),1),e("span",Vs,"+"+_(m.score),1)]))),128))]))]),C.value?M("",!0):(c(),l("div",Ns,[i[7]||(i[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Bs,[(c(),l(B,null,H(5,m=>e("button",{key:m,class:E(["star-btn",{active:m<=(p.value||a.value),selected:m<=a.value}]),onMouseenter:$=>p.value=m,onMouseleave:i[0]||(i[0]=$=>p.value=0),onClick:$=>D(m),disabled:g.value}," â­ ",42,Ps)),64))]),e("div",Hs,[g.value?(c(),l("span",As,"ä½ çš„è©•åˆ†ï¼š"+_(a.value)+" æ˜Ÿ",1)):(c(),l("span",Os,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),b.value>0?(c(),l("div",zs,[i[8]||(i[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",Us,_(S.value.toFixed(1)),1),e("span",qs,_("â­".repeat(Math.round(S.value))),1),e("span",Js,"("+_(b.value)+" äººå·²è©•)",1)])):M("",!0)])]))}}),Ys=X(Ks,[["__scopeId","data-v-64089556"]]);function Xs(){const s=le(),r=z(),{calculateGuessScore:d,updatePlayerScore:v}=pe(),t=I(""),a=I(null),p=I(!1),g=G(()=>s.isCurrentDrawer?s.currentWord:null),y=G(()=>s.correctGuesses),C=G(()=>r.user?s.hasGuessed(r.user.id):!1);async function S(){if(!s.currentRound||!r.user)return a.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!t.value.trim())return a.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(t.value.length>32)return a.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(C.value)return a.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(s.isCurrentDrawer)return a.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{p.value=!0,a.value=null;const R=t.value.trim(),k=s.currentWord||"",f=b(R,k),n=f?d(y.value.length):0,{data:i,error:m}=await J.from("guesses").insert({round_id:s.currentRound.id,user_id:r.user.id,guess_text:R,is_correct:f,score_earned:n}).select().single();if(m)throw m;return s.guesses.push(i),f&&r.user&&await v(r.user.id,n),t.value="",{success:!0,isCorrect:f,guess:i}}catch(R){return a.value=R instanceof Error?R.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",R),{success:!1,error:a.value}}finally{p.value=!1}}function b(R,k){const f=R.trim(),n=k.trim();return f===n}function D(){a.value=null}return{guessInput:t,error:a,loading:p,currentWord:g,correctGuesses:y,hasGuessed:C,submitGuess:S,clearError:D}}const js={class:"game-container"},Qs={key:0,class:"container margin-top-large"},Zs={class:"row flex-center"},et={class:"col-12 col-md-8"},st={key:1,class:"game-layout"},tt={class:"game-sidebar game-players"},nt={class:"player-list-container"},ot={class:"game-main"},rt={key:0,class:"time-display"},at={key:1,class:"time-display summary"},it={class:"time-number"},lt={class:"round-info"},ct={class:"round-label"},ut={key:0,class:"phase-label"},dt={key:2,class:"word-display"},vt={class:"word-text"},mt={key:3,class:"word-display"},ht={class:"drawer-hint"},gt={class:"word-slots"},_t={key:4,class:"word-display summary-word"},ft={class:"word-text revealed"},wt={class:"game-content-area"},pt={class:"game-toolbar disabled"},yt={class:"game-canvas summary-phase"},bt={class:"game-chat-panel"},Rt={class:"chat-msg system-msg answer-revealed"},kt={class:"msg-player"},Ct={class:"msg-correct"},$t={class:"game-toolbar"},St={class:"game-canvas"},Ft={key:0,class:"time-progress"},Dt={class:"game-chat-panel"},Wt={class:"msg-player"},xt={key:0,class:"msg-correct"},Tt={key:1,class:"msg-text"},It={key:0,class:"chat-msg correct-self"},Gt={class:"chat-input-area"},Mt=["placeholder","disabled"],Lt=["disabled"],Et={key:2,class:"container margin-top-large"},Vt={class:"row flex-center"},Nt={class:"col-12 col-md-8"},Bt={class:"card"},Pt={class:"card-body text-center"},Ht=Y({__name:"RoomView",setup(s){const r=Ge(),d=Ne(),v=Q(),t=le(),a=z(),{subscribeRoom:p,unsubscribeRoom:g,subscribeGameState:y}=ie(),{isPlaying:C,isWaiting:S,isFinished:b,timeRemaining:D,isCountingDown:R,isCurrentDrawer:k,drawTime:f,currentRoundNumber:n,totalRounds:i,startGame:m,isDrawing:$,isSummary:V,summaryTimeRemaining:L,startSummaryCountdown:h,stopSummaryCountdown:F,startCountdown:W,stopCountdown:A}=ge(),{hasGuessed:U,guessInput:N,submitGuess:O,loading:ke}=Xs(),{leaveRoom:Ce}=Pe(),x=G(()=>v.currentRoom),ce=G(()=>ke.value),ue=I(null),q=I(null),Z=G(()=>{const w=x.value?.current_drawer_id;return w&&v.participants.find(T=>T.user_id===w)?.nickname||"ç•«å®¶"}),de=G(()=>[...t.guesses].sort((w,u)=>new Date(w.guessed_at).getTime()-new Date(u.guessed_at).getTime()));function $e(){q.value&&(q.value.scrollTop=q.value.scrollHeight)}j(de,()=>{Be($e)},{deep:!0}),j(()=>v.participants,w=>{if(!a.user||!x.value)return;!w.some(T=>T.user_id===a.user.id)&&x.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),v.clearRoom(),d.push("/"))},{deep:!0});function ee(w){return v.participants.find(T=>T.user_id===w)?.nickname||"æœªçŸ¥ç©å®¶"}const Se=G(()=>k.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":U.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),Fe=G(()=>t.currentWord?t.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),ve=G(()=>t.currentRoundCorrectGuesses.length*5),me=G(()=>t.currentRoundCorrectGuesses.map(w=>({userId:w.user_id,name:ee(w.user_id),score:w.score_earned}))),De=I(null);function We(){!t.currentRound||!t.currentWord||(De.value={roundNumber:n.value,answer:t.currentWord,drawerName:Z.value,drawerId:t.currentRound.drawer_id,drawerScore:ve.value,correctGuessers:me.value,roundId:t.currentRound.id})}j(V,(w,u)=>{w&&!u&&n.value>0&&We()});function se(w){ue.value=w,setTimeout(()=>{ue.value=null},3e3)}async function he(){!k.value&&N.value.trim()&&await O()}async function xe(){const w=await m();!w.success&&w.error&&se(w.error)}async function te(){const w=await Ce();x.value&&g(x.value.code),await d.push("/"),!w.success&&w.error&&se(w.error)}async function Te(w){if(!t.currentRound)return;const u=await t.submitRating(t.currentRound.id,t.currentRound.drawer_id,w);!u.success&&u.error&&se(u.error)}return re(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",r.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",x.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",a.user?.id);const w=r.params.code;if(w&&!x.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",w),x.value&&a.user){console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",x.value.status),await t.loadCurrentRound(x.value.id);try{await p(x.value.code,x.value.id,a.user.id,{nickname:a.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(u){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",u)}y(x.value.code,async u=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",u),u.drawerId&&x.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",u.drawerId),v.setCurrentDrawer(u.drawerId)),u.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",u.roundStatus),t.setRoundStatus(u.roundStatus),u.roundStatus==="drawing"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),F(),t.clearRatings(),W(f.value)),u.roundStatus==="summary"&&(A(),u.isLastRound?v.isHost&&setTimeout(async()=>{const{endGame:T}=ge();await T()},3e3):h())),x.value&&(await v.loadRoom(x.value.id),await t.loadCurrentRound(x.value.id))}),await t.loadAllGuesses(x.value.id)}}),ae(()=>{x.value&&g(x.value.code)}),(w,u)=>(c(),l("div",js,[o(S)?(c(),l("div",Qs,[e("div",Zs,[e("div",et,[P(He,{room:x.value,participants:o(v).participants,onStartGame:xe,onLeaveRoom:te},null,8,["room","participants"])])])])):o(C)?(c(),l("div",st,[e("div",tt,[e("div",nt,[P(we,{"show-winner":!1})])]),e("div",ot,[e("div",{class:E(["game-header",{"time-critical":o(D)!==null&&o(D)<=10}])},[o($)&&o(R)&&o(D)!==null?(c(),l("div",rt,[e("span",{class:E(["time-number",{"time-warning":o(D)<=10,"time-critical-pulse":o(D)<=5}])},_(o(D)),3),u[1]||(u[1]=e("span",{class:"time-label"},"ç§’",-1))])):o(V)&&o(L)!==null?(c(),l("div",at,[e("span",it,_(o(L)),1),u[2]||(u[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",lt,[e("span",ct,"ç¬¬ "+_(o(n))+" / "+_(o(i))+" è¼ª",1),o(V)?(c(),l("span",ut,"è¼ªæ¬¡çµç®—")):M("",!0)]),o($)&&o(k)&&o(t).currentWord?(c(),l("div",dt,[u[3]||(u[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",vt,_(o(t).currentWord),1)])):o($)?(c(),l("div",mt,[e("span",ht,"ğŸ¨ "+_(Z.value)+" æ­£åœ¨ç•«",1),e("span",gt,_(Fe.value),1)])):o(V)&&o(t).currentWord?(c(),l("div",_t,[u[4]||(u[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",ft,_(o(t).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:te,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",wt,[o(V)?(c(),l(B,{key:0},[e("div",pt,[P(fe,{compact:!0})]),e("div",yt,[P(Ys,{"round-number":o(n),"total-rounds":o(i),"correct-answer":o(t).currentWord||"","drawer-name":Z.value,"drawer-id":o(t).currentRound?.drawer_id||"","drawer-score":ve.value,"correct-guessers":me.value,"round-id":o(t).currentRound?.id||"","is-host":o(v).isHost,"is-last-round":o(n)>=o(i),onRatingSubmitted:Te},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",bt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:q},[e("div",Rt,[u[5]||(u[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),u[6]||(u[6]=K(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,_(o(t).currentWord),1)]),(c(!0),l(B,null,H(o(t).currentRoundCorrectGuesses,T=>(c(),l("div",{key:T.id,class:"chat-msg correct-guess"},[e("span",kt,_(ee(T.user_id)),1),e("span",Ct,"çŒœä¸­äº†ï¼ +"+_(T.score_earned),1)]))),128))],512),u[7]||(u[7]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(c(),l(B,{key:1},[e("div",$t,[P(fe,{compact:!0})]),e("div",St,[P(Ue),o(R)&&o(D)!==null?(c(),l("div",Ft,[e("div",{class:E(["time-bar",{"time-warning":o(D)<=10}]),style:oe({width:`${o(D)/o(f)*100}%`})},null,6)])):M("",!0)]),e("div",Dt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:q},[u[9]||(u[9]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),K(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(c(!0),l(B,null,H(de.value,T=>(c(),l("div",{key:T.id,class:E(["chat-msg",{"correct-guess":T.is_correct,"wrong-guess":!T.is_correct}])},[e("span",Wt,_(ee(T.user_id)),1),T.is_correct?(c(),l("span",xt,"çŒœä¸­äº†ï¼ +"+_(T.score_earned),1)):(c(),l("span",Tt,_(T.guess_text),1))],2))),128)),o(U)?(c(),l("div",It,[...u[8]||(u[8]=[e("span",{class:"msg-icon"},"âœ…",-1),K(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",Gt,[Me(e("input",{"onUpdate:modelValue":u[0]||(u[0]=T=>Ve(N)?N.value=T:null),type:"text",placeholder:Se.value,maxlength:"32",disabled:ce.value||o(U)||o(k),onKeyup:Ee(he,["enter"]),class:"chat-input-field"},null,40,Mt),[[Le,o(N)]]),e("button",{onClick:he,disabled:ce.value||o(U)||o(k)||!o(N).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Lt)])])],64))])])])):o(b)?(c(),l("div",Et,[e("div",Vt,[e("div",Nt,[e("div",Bt,[e("div",Pt,[u[10]||(u[10]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),P(we,{"show-winner":!0}),e("button",{onClick:te,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),zt=X(Ht,[["__scopeId","data-v-0893e226"]]);export{zt as default};
