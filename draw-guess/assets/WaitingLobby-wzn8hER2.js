const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DwjNSdXf.js","assets/index-CvwmVB8L.css"])))=>i.map(i=>d[i]);
import{d as cr,f as y,x as Ge,c as j,o as z,y as Cr,a as Se,e as E,z as Tr,A as ke,r as U,u as de,D as b,K as Oe,h as xr,t as Y,q as oe,n as je,F as ze,l as Ar,b as re,_ as Pr}from"./index-DwjNSdXf.js";const Mr=["width","height","fill","transform"],Nr={key:0},Dr=E("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),qr=[Dr],Or={key:1},kr=E("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),Hr=E("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Br=[kr,Hr],Ur={key:2},$r=E("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Wr=[$r],Zr={key:3},Lr=E("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Vr=[Lr],jr={key:4},zr=E("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Kr=[zr],Yr={key:5},Fr=E("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Jr=[Fr],Qr={name:"PhPaintBrush"},Ot=cr({...Qr,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const d=e,s=Ge("weight","regular"),c=Ge("size","1em"),C=Ge("color","currentColor"),P=Ge("mirrored",!1),w=y(()=>d.weight??s),Z=y(()=>d.size??c),D=y(()=>d.color??C),S=y(()=>d.mirrored!==void 0?d.mirrored?"scale(-1, 1)":void 0:P?"scale(-1, 1)":void 0);return(h,I)=>(z(),j("svg",Tr({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:Z.value,height:Z.value,fill:D.value,transform:S.value},h.$attrs),[Cr(h.$slots,"default"),w.value==="bold"?(z(),j("g",Nr,qr)):w.value==="duotone"?(z(),j("g",Or,Br)):w.value==="fill"?(z(),j("g",Ur,Wr)):w.value==="light"?(z(),j("g",Zr,Vr)):w.value==="regular"?(z(),j("g",jr,Kr)):w.value==="thin"?(z(),j("g",Yr,Jr)):Se("",!0)],16,Mr))}}),Re=ke("room",()=>{const e=U(null),d=U([]),s=U(!1),c=U(null),C=y(()=>{const t=de();return e.value?.host_id===t.user?.id});async function P(t){try{s.value=!0,c.value=null;const r=de();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(H){console.warn("載入用戶資料時發生錯誤（非關鍵）:",H)}const _=t.gameMode||"classic";if(_==="classic"&&t.words.length<6)throw new Error("至少需要 6 個詞語");let f=null,$=0;const R=10;for(;$<R&&!f;){$++;const V={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null,game_mode:_,single_round_mode:t.singleRoundMode||!1,is_final_round:!1},{data:F,error:o}=await b.from("game_rooms").insert(V).select().single();if(o){if(o.code==="23505")continue;throw new Error(o.message||"插入房間失敗")}if(F){f=F;break}}if(!f)throw new Error("無法生成唯一房間碼，請重試");const p={room_id:f.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:H}=await b.from("room_participants").insert(p);H&&console.error("創建參與記錄錯誤:",H)}catch(H){console.error("創建參與記錄時發生錯誤:",H)}try{const{data:H,error:V}=await b.from("room_participants").select("*").eq("room_id",f.id).order("joined_at",{ascending:!0});V?console.error("載入參與者列表失敗:",V):H&&(d.value=H)}catch(H){console.error("載入參與者列表時發生錯誤:",H)}return e.value=f,{success:!0,room:f}}catch(r){return c.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:c.value}}finally{s.value=!1}}async function w(t,r){try{s.value=!0,c.value=null;const _=de();if(!_.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:f,error:$}=await b.from("game_rooms").select("*").eq("code",t).single();if($||!f)throw new Error("房間不存在");if(f.status!=="waiting")throw new Error("房間已開始或已結束");const{data:R}=await b.from("room_participants").select("*").eq("room_id",f.id).eq("user_id",_.user.id).maybeSingle();if(R)return e.value=f,await D(f.id),{success:!0,room:f};const{error:p}=await b.from("room_participants").insert({room_id:f.id,user_id:_.user.id,nickname:r.trim(),score:0});if(p){if(p.code==="23505"||p.message.includes("duplicate"))return e.value=f,await D(f.id),{success:!0,room:f};throw p}return e.value=f,await D(f.id),{success:!0,room:f}}catch(_){return c.value=_ instanceof Error?_.message:"加入房間失敗",console.error("加入房間錯誤:",_),{success:!1,error:c.value}}finally{s.value=!1}}async function Z(){try{if(!e.value)return{success:!0};s.value=!0,c.value=null;const t=de();if(!t.user)throw new Error("請先登入");const{error:r}=await b.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(C.value){const{error:_}=await b.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);_&&console.error("關閉房間失敗:",_)}return e.value=null,d.value=[],{success:!0}}catch(t){return c.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,d.value=[],{success:!1,error:c.value}}finally{s.value=!1}}async function D(t){try{const{data:r,error:_}=await b.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(_)throw _;d.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function S(t){try{s.value=!0,c.value=null;const{data:r,error:_}=await b.from("game_rooms").select("*").eq("id",t).single();if(_)throw _;return e.value=r,await D(t),{success:!0,room:r}}catch(r){return c.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:c.value}}finally{s.value=!1}}async function h(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await b.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(t==="finished"&&e.value&&await I(),e.value){const _=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:_,newStatus:e.value.status})}return{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:c.value}}}async function I(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:t,error:r}=await b.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(r){console.error("獲取參與者錯誤:",r);return}if(!t||t.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const _=t.map(p=>p.user_id),{data:f,error:$}=await b.from("users").select("id, user_type").in("id",_);if($){console.error("獲取用戶信息錯誤:",$);return}const R=new Set(f?.filter(p=>p.user_type==="registered").map(p=>p.id)||[]);for(const p of t){if(!R.has(p.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${p.user_id} 的積分累積`);continue}if(p.score>0){const{error:H}=await b.rpc("accumulate_user_score",{user_id_param:p.user_id,score_to_add:p.score});if(H){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",H);const{data:V,error:F}=await b.from("users").select("total_score").eq("id",p.user_id).single();if(F){console.error(`[RoomStore] 獲取用戶 ${p.user_id} 總積分錯誤:`,F);continue}const o=(V?.total_score||0)+p.score,{error:a}=await b.from("users").update({total_score:o}).eq("id",p.user_id);a?console.error(`[RoomStore] 更新用戶 ${p.user_id} 總積分錯誤:`,a):console.log(`[RoomStore] 用戶 ${p.user_id} 積分已累積: +${p.score} (總積分: ${o})`)}else console.log(`[RoomStore] 用戶 ${p.user_id} 積分已累積: +${p.score}`)}}}catch(t){console.error("[RoomStore] 累積積分錯誤:",t)}}async function O(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await b.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:c.value}}}async function k(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:t});const r={...e.value.settings,...t},{error:_}=await b.from("game_rooms").update({settings:r}).eq("id",e.value.id);if(_)throw _;return e.value&&(e.value.settings=r,console.log("[RoomStore] 房間設置已更新:",r)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",r),{success:!1,error:c.value}}}function W(){e.value=null,d.value=[],c.value=null}function l(t){e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 本地更新當前畫家:",t))}async function g(t){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!C.value)return{success:!1,error:"只有房主可以踢人"};const r=de();if(t===r.user?.id)return{success:!1,error:"不能踢出自己"};s.value=!0,c.value=null;const{data:_,error:f}=await b.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:t});if(f)throw new Error(f.message);if(_&&!_.success)throw new Error(_.error||"踢出玩家失敗");return await D(e.value.id),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",r),{success:!1,error:c.value}}finally{s.value=!1}}async function m(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 設置最後一局標記:",{roomId:e.value.id,isFinal:t});const{error:r}=await b.from("game_rooms").update({is_final_round:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.is_final_round=t,console.log("[RoomStore] 最後一局標記已更新:",t)),{success:!0}}catch(r){return c.value=r instanceof Error?r.message:"設置最後一局標記失敗",console.error("設置最後一局標記錯誤:",r),{success:!1,error:c.value}}}return{currentRoom:e,participants:d,loading:s,error:c,isHost:C,createRoom:P,joinRoom:w,leaveRoom:Z,kickPlayer:g,loadParticipants:D,loadRoom:S,updateRoomStatus:h,updateRoomDrawer:O,updateRoomSettings:k,setCurrentDrawer:l,setFinalRound:m,clearRoom:W}});function Xr(){const e=Re(),d=y(()=>e.currentRoom),s=y(()=>e.participants),c=y(()=>e.isHost),C=y(()=>d.value&&d.value.game_mode==="storyboard"?3:2),P=y(()=>!d.value||d.value.status!=="waiting"||!c.value?!1:s.value.length>=C.value);async function w(S){return await e.createRoom(S)}async function Z(S,h){return await e.joinRoom(S,h)}async function D(){return await e.leaveRoom()}return{currentRoom:d,participants:s,isHost:c,canStartGame:P,minPlayersRequired:C,loading:y(()=>e.loading),error:y(()=>e.error),createRoom:w,joinRoom:Z,leaveRoom:D}}const Ke=100,Ye=50,Fe=10,et=10,Je=100,Qe=[1,.8,.6,.4,.2];function rt(){const e=Re();function d(S){const h=Math.min(S,Qe.length-1),I=Qe[h]??0;return Math.round(Ke*I)}function s(S,h=0){if(S===0)return 0;const I=S*Fe,O=Math.round(h*et);return Ye+I+O}async function c(S,h,I=0){const O=s(h,I);return O===0?!0:await C(S,O)}async function C(S,h){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:I,error:O}=await b.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",S).single();if(O)throw O;const k=(I?.score||0)+h,{error:W}=await b.from("room_participants").update({score:k}).eq("room_id",e.currentRoom.id).eq("user_id",S);if(W)throw W;const l=e.participants.findIndex(g=>g.user_id===S);return l!==-1&&e.participants[l]&&(e.participants[l].score=k),!0}catch(I){return console.error("更新玩家分數錯誤:",I),!1}}function P(){if(!e.participants||e.participants.length===0)return null;const S=[...e.participants].sort((h,I)=>I.score-h.score);return S.length===1||S[0]&&S[1]&&S[0].score>S[1].score?{user_id:S[0]?.user_id||"",score:S[0]?.score||0}:{user_id:S[0]?.user_id||"",score:S[0]?.score||0}}const w=y(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((h,I)=>I.score!==h.score?I.score-h.score:new Date(h.joined_at).getTime()-new Date(I.joined_at).getTime()).map((h,I)=>({id:h.id,user_id:h.user_id,score:h.score,rank:I+1}))),Z=y(()=>e.currentRoom?.status!=="finished"?null:P());function D(){return Je}return{GUESS_BASE_SCORE:Ke,DRAWING_BASE_SCORE:Ye,DRAWING_BONUS_PER_GUESS:Fe,WINNER_BONUS:Je,calculateGuessScore:d,calculateDrawingScore:s,calculateWinner:P,updatePlayerScore:C,updateDrawerScore:c,playerRankings:w,winner:Z,getWinnerBonus:D}}const ir=ke("game",()=>{const e=Re(),d=de(),s=U(null),c=U(null),C=U([]),P=y(()=>C.value.filter(u=>u.is_correct)),w=y(()=>s.value?C.value.filter(u=>u.round_id===s.value.id):[]),Z=y(()=>w.value.filter(u=>u.is_correct)),D=U("drawing"),S=U([]),h=U([]),I=U(!1),O=U([]),k=y(()=>h.value.length===0?0:h.value.reduce((i,G)=>i+G.rating,0)/h.value.length);function W(u){D.value=u}function l(u){S.value=u}function g(u){const i=h.value.findIndex(G=>G.rater_id===u.rater_id);i>=0?h.value[i]=u:h.value.push(u)}function m(){h.value=[]}function t(){if(I.value||!c.value)return null;const u=c.value.length,i=[];for(let q=0;q<u;q++)O.value.includes(q)||i.push(q);if(i.length===0)return null;const G=Math.floor(Math.random()*i.length),M=i[G];return M===void 0?null:(O.value.push(M),I.value=!0,M)}function r(u,i){I.value=u,O.value=i}function _(){I.value=!1,O.value=[]}async function f(u){try{const{data:i,error:G}=await b.from("game_rounds").select("*").eq("room_id",u).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(G)throw G;return i&&(s.value=i,c.value=i.word_text,i.word_options&&Array.isArray(i.word_options)&&(S.value=i.word_options),await $(i.id)),{success:!0,round:i}}catch(i){return console.error("載入當前輪次錯誤:",i),{success:!1,error:i instanceof Error?i.message:"載入輪次失敗"}}}async function $(u){try{const{data:i,error:G}=await b.from("guesses").select("*").eq("round_id",u).order("guessed_at",{ascending:!0});if(G)throw G;const M=i||[],q=new Set(C.value.map(X=>X.id)),Q=M.filter(X=>!q.has(X.id));Q.length>0&&(C.value=[...C.value,...Q])}catch(i){console.error("載入猜測記錄錯誤:",i)}}async function R(u){try{const{data:i,error:G}=await b.from("game_rounds").select("id").eq("room_id",u);if(G)throw G;if(!i||i.length===0){C.value=[];return}const M=i.map(X=>X.id),{data:q,error:Q}=await b.from("guesses").select("*").in("round_id",M).order("guessed_at",{ascending:!0});if(Q)throw Q;C.value=q||[]}catch(i){console.error("載入所有猜測記錄錯誤:",i)}}async function p(u,i,G,M){try{if(!e.currentRoom)throw new Error("沒有當前房間");const q=(e.currentRoom.current_round||0)+1,{data:Q,error:X}=await b.from("game_rounds").insert({room_id:u,round_number:q,drawer_id:i,word_text:G,word_source:M}).select().single();if(X)throw X;return s.value=Q,c.value=G,await b.from("game_rooms").update({current_round:q,current_drawer_id:i}).eq("id",u),{success:!0,round:Q}}catch(q){return console.error("創建輪次錯誤:",q),{success:!1,error:q instanceof Error?q.message:"創建輪次失敗"}}}function H(u){return s.value?C.value.some(i=>i.round_id===s.value.id&&i.user_id===u&&i.is_correct):!1}const V=y(()=>!s.value||!d.user?!1:s.value.drawer_id===d.user.id);async function F(){if(!s.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const u=P.value.length,i=k.value,{updateDrawerScore:G}=rt();console.log("[endRound] 猜中人數:",u,"平均評分:",i),await G(s.value.drawer_id,u,i);const{error:M}=await b.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",s.value.id);if(M)throw M;return{success:!0}}catch(u){return console.error("結束輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"結束輪次失敗"}}}function o(){s.value=null,c.value=null,C.value=[],D.value="drawing",S.value=[],h.value=[],I.value=!1,O.value=[]}async function a(u,i,G){if(!d.user)return{success:!1,error:"用戶未登錄"};try{const{data:M,error:q}=await b.from("drawing_ratings").upsert({round_id:u,rater_id:d.user.id,drawer_id:i,rating:G},{onConflict:"round_id,rater_id"}).select().single();if(q)throw q;return M&&g(M),{success:!0,rating:M}}catch(M){return console.error("提交評分錯誤:",M),{success:!1,error:M instanceof Error?M.message:"提交評分失敗"}}}async function v(u){try{const{data:i,error:G}=await b.from("drawing_ratings").select("*").eq("round_id",u);if(G)throw G;return h.value=i||[],{success:!0,ratings:i}}catch(i){return console.error("載入評分錯誤:",i),{success:!1,error:i instanceof Error?i.message:"載入評分失敗"}}}return{currentRound:s,currentWord:c,guesses:C,correctGuesses:P,currentRoundGuesses:w,currentRoundCorrectGuesses:Z,isCurrentDrawer:V,roundStatus:D,wordOptions:S,ratings:h,averageRating:k,hintGiven:I,revealedIndices:O,loadCurrentRound:f,loadGuesses:$,loadAllGuesses:R,createRound:p,hasGuessed:H,endRound:F,clearGame:o,setRoundStatus:W,setWordOptions:l,addRating:g,clearRatings:m,submitRating:a,loadRatings:v,giveHint:t,setHintState:r,resetHint:_}});function Xe(e){return{id:e.id,roomId:e.room_id,roundNumber:e.round_number,itemType:e.item_type,content:e.content,authorId:e.author_id,authorName:e.author_name,createdAt:e.created_at}}function er(e){return{id:e.id,roundId:e.round_id,userId:e.user_id,sentence:e.sentence,voteCount:e.vote_count,isWinner:e.is_winner,createdAt:e.created_at,updatedAt:e.updated_at}}function rr(e){return{id:e.id,roundId:e.round_id,voterId:e.voter_id,submissionId:e.submission_id,createdAt:e.created_at}}const tt=ke("story",()=>{const e=de(),d=U([]),s=U([]),c=U([]),C=U("setup"),P=U(!1),w=U(null),Z=y(()=>{const o=d.value.filter(a=>a.itemType==="text");return o.length===0?null:o[o.length-1]}),D=y(()=>{if(d.value.length===0)return null;const o=d.value[0];return o&&o.itemType==="text"?o.content:null}),S=y(()=>e.user&&s.value.find(o=>o.userId===e.user.id)||null),h=y(()=>e.user&&c.value.find(o=>o.voterId===e.user.id)||null),I=y(()=>{const o=new Map;for(const a of s.value)o.set(a.id,0);for(const a of c.value){const v=o.get(a.submissionId)||0;o.set(a.submissionId,v+1)}return o}),O=y(()=>{if(s.value.length===0)return null;let o=-1,a=[];for(const v of s.value){const u=I.value.get(v.id)||0;u>o?(o=u,a=[v]):u===o&&a.push(v)}return a.length>0?a[0]:null});async function k(o){try{P.value=!0,w.value=null;const{data:a,error:v}=await b.from("story_chains").select("*").eq("room_id",o).order("round_number",{ascending:!0}).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return d.value=(a||[]).map(u=>Xe(u)),console.log("[StoryStore] 故事鏈已載入:",d.value.length,"項"),{success:!0,data:d.value}}catch(a){return w.value=a instanceof Error?a.message:"載入故事鏈失敗",console.error("[StoryStore] 載入故事鏈錯誤:",a),{success:!1,error:w.value}}finally{P.value=!1}}async function W(o){try{P.value=!0,w.value=null;const a={room_id:o.roomId,round_number:o.roundNumber,item_type:o.itemType,content:o.content,author_id:o.authorId,author_name:o.authorName},{data:v,error:u}=await b.from("story_chains").insert(a).select().single();if(u)throw new Error(u.message);const i=Xe(v);return d.value.push(i),console.log("[StoryStore] 故事鏈項目已添加:",i),{success:!0,data:i}}catch(a){return w.value=a instanceof Error?a.message:"添加故事鏈項目失敗",console.error("[StoryStore] 添加故事鏈項目錯誤:",a),{success:!1,error:w.value}}finally{P.value=!1}}async function l(o,a,v,u){return W({roomId:o,roundNumber:0,itemType:"text",content:a,authorId:v,authorName:u})}async function g(o,a,v,u){return W({roomId:o,roundNumber:-1,itemType:"text",content:a,authorId:v,authorName:u})}async function m(o){try{P.value=!0,w.value=null;const{data:a,error:v}=await b.from("story_submissions").select("*").eq("round_id",o).order("created_at",{ascending:!0});if(v)throw new Error(v.message);return s.value=(a||[]).map(u=>er(u)),console.log("[StoryStore] 句子提交已載入:",s.value.length,"項"),{success:!0,data:s.value}}catch(a){return w.value=a instanceof Error?a.message:"載入句子提交失敗",console.error("[StoryStore] 載入句子提交錯誤:",a),{success:!1,error:w.value}}finally{P.value=!1}}async function t(o,a){if(!e.user)return{success:!1,error:"用戶未登錄"};try{P.value=!0,w.value=null;const v={round_id:o,user_id:e.user.id,sentence:a.trim(),vote_count:0,is_winner:!1},{data:u,error:i}=await b.from("story_submissions").upsert(v,{onConflict:"round_id,user_id"}).select().single();if(i)throw new Error(i.message);const G=er(u),M=s.value.findIndex(q=>q.roundId===o&&q.userId===e.user.id);return M>=0?s.value[M]=G:s.value.push(G),console.log("[StoryStore] 句子已提交:",G),{success:!0,data:G}}catch(v){return w.value=v instanceof Error?v.message:"提交句子失敗",console.error("[StoryStore] 提交句子錯誤:",v),{success:!1,error:w.value}}finally{P.value=!1}}async function r(o){try{const{error:a}=await b.from("story_submissions").update({is_winner:!0}).eq("id",o);if(a)throw new Error(a.message);const v=s.value.find(u=>u.id===o);return v&&(v.isWinner=!0),console.log("[StoryStore] 勝出句子已標記:",o),{success:!0}}catch(a){return w.value=a instanceof Error?a.message:"標記勝出句子失敗",console.error("[StoryStore] 標記勝出句子錯誤:",a),{success:!1,error:w.value}}}async function _(o){try{P.value=!0,w.value=null;const{data:a,error:v}=await b.from("story_votes").select("*").eq("round_id",o);if(v)throw new Error(v.message);return c.value=(a||[]).map(u=>rr(u)),console.log("[StoryStore] 投票記錄已載入:",c.value.length,"項"),{success:!0,data:c.value}}catch(a){return w.value=a instanceof Error?a.message:"載入投票記錄失敗",console.error("[StoryStore] 載入投票記錄錯誤:",a),{success:!1,error:w.value}}finally{P.value=!1}}async function f(o,a){if(!e.user)return{success:!1,error:"用戶未登錄"};try{P.value=!0,w.value=null;const v={round_id:o,voter_id:e.user.id,submission_id:a},{data:u,error:i}=await b.from("story_votes").upsert(v,{onConflict:"round_id,voter_id"}).select().single();if(i)throw new Error(i.message);const G=rr(u),M=c.value.findIndex(q=>q.roundId===o&&q.voterId===e.user.id);return M>=0?c.value[M]=G:c.value.push(G),console.log("[StoryStore] 投票已記錄:",G),{success:!0,data:G}}catch(v){return w.value=v instanceof Error?v.message:"投票失敗",console.error("[StoryStore] 投票錯誤:",v),{success:!1,error:w.value}}finally{P.value=!1}}function $(o){C.value=o,console.log("[StoryStore] 階段已更新:",o)}function R(){s.value=[],c.value=[],console.log("[StoryStore] 輪次數據已清除")}function p(){d.value=[],s.value=[],c.value=[],C.value="setup",w.value=null,console.log("[StoryStore] 所有故事數據已清除")}function H(o){d.value.some(v=>v.id===o.id)||(d.value.push(o),console.log("[StoryStore] 本地添加故事鏈項目:",o))}function V(o){const a=s.value.findIndex(v=>v.id===o.id);a>=0?s.value[a]=o:s.value.push(o),console.log("[StoryStore] 本地添加句子提交:",o)}function F(o){const a=c.value.findIndex(v=>v.roundId===o.roundId&&v.voterId===o.voterId);a>=0?c.value[a]=o:c.value.push(o),console.log("[StoryStore] 本地添加投票記錄:",o)}return{storyChain:d,submissions:s,votes:c,currentPhase:C,loading:P,error:w,latestSentence:Z,storyOpening:D,mySubmission:S,myVote:h,voteCounts:I,winningSubmission:O,loadStoryChain:k,addStoryChainItem:W,addStoryOpening:l,addStoryEnding:g,addStoryChainItemLocal:H,loadSubmissions:m,submitSentence:t,markWinningSubmission:r,addSubmissionLocal:V,loadVotes:_,castVote:f,addVoteLocal:F,setPhase:$,clearRoundData:R,clearAll:p}}),se=new Map,ae=U("disconnected"),ce=new Map,Ce=new Set,Te=new Map;function ie(...e){}function te(...e){console.warn("[Realtime]",...e)}function ne(){const e=Re(),d=ir();function s(l){const g=`room:${l}`;if(se.has(g))return se.get(g);const m=b.channel(g,{config:{presence:{key:"user"},broadcast:{self:!0}}});return se.set(g,m),m}function c(l){const g=Te.get(l);g&&(clearTimeout(g),Te.delete(l))}function C(l,g,m,t,r){l==="SUBSCRIBED"?(ae.value="connected",c(m),g.track({user_id:t,...r}).catch(_=>{te("Presence track 失敗:",_)})):l==="CHANNEL_ERROR"||l==="TIMED_OUT"?(ae.value="disconnected",te("訂閱失敗:",l),P(m,t,r)):l==="CLOSED"&&(ae.value="disconnected")}function P(l,g,m,t=0){if(t>=3){te("重連失敗次數過多，停止重連");return}c(l);const r=Math.min(1e3*Math.pow(2,t),1e4),_=window.setTimeout(()=>{const f=se.get(`room:${l}`);f&&f.state!=="joined"&&f.subscribe($=>{$==="SUBSCRIBED"?C($,f,l,g,m):($==="CHANNEL_ERROR"||$==="TIMED_OUT")&&P(l,g,m,t+1)})},r);Te.set(l,_)}function w(l,g,m,t){return new Promise((r,_)=>{if(!l||!g){te("缺少 roomCode 或 roomId"),_(new Error("缺少 roomCode 或 roomId"));return}const f=s(l),$=f.state;if($==="joined"){ae.value="connected",r(f);return}if($==="joining"){const R=setInterval(()=>{const p=f.state;p==="joined"?(clearInterval(R),r(f)):(p==="closed"||p==="errored")&&(clearInterval(R),_(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(R),f.state!=="joined"&&_(new Error("連接超時"))},5e3);return}if(Ce.has(l)){ae.value="connecting",f.subscribe(R=>{C(R,f,l,m,t),R==="SUBSCRIBED"?r(f):(R==="CHANNEL_ERROR"||R==="TIMED_OUT")&&_(new Error(`訂閱失敗: ${R}`))});return}f.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${g}`},async R=>{ie("房間狀態變化:",R.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${g}`},async R=>{ie("參與者變化:",R.eventType),await e.loadParticipants(g)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${g}`},async R=>{ie("輪次變化:",R.eventType,R.new),e.currentRoom&&await d.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async R=>{const p=R.new;if(p&&d.currentRound&&(await d.loadGuesses(p.round_id),p.is_correct&&e.isHost&&d.roundStatus==="drawing")){const H=d.currentRound.drawer_id,V=e.participants.filter(a=>a.user_id!==H),F=new Set(d.currentRoundCorrectGuesses.map(a=>a.user_id));if(V.length>0&&V.every(a=>F.has(a.user_id))){const{useGame:a}=await Oe(async()=>{const{useGame:u}=await Promise.resolve().then(()=>ot);return{useGame:u}},void 0),{endRound:v}=a();await v()}}}).on("broadcast",{event:"drawing"},R=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(R));const p=ce.get(l);p&&R.payload?.stroke?(console.log("[Realtime] 分發給",p.size,"個回調"),p.forEach(H=>H(R.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",p?.size,"stroke:",R.payload?.stroke)}).on("presence",{event:"sync"},()=>{const R=f.presenceState();ie("Presence 同步，在線:",Object.keys(R).length)}),Ce.add(l),ae.value="connecting",f.subscribe(R=>{C(R,f,l,m,t),R==="SUBSCRIBED"?r(f):(R==="CHANNEL_ERROR"||R==="TIMED_OUT")&&_(new Error(`訂閱失敗: ${R}`))})})}function Z(l,g){return ce.has(l)||ce.set(l,new Set),ce.get(l).add(g),()=>{ce.get(l)?.delete(g)}}function D(l,g){const m=s(l),t=`guesses:${g}`;return m[t]||(m.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${g}`},async r=>{ie("收到新猜測記錄:",r.eventType,r.new),await d.loadGuesses(g)}),m[t]=!0),m}function S(l,g){const m=s(l),t=`gameState:${l}`;return m[t]||(m.on("broadcast",{event:"game_state"},r=>{ie("收到遊戲狀態廣播:",r.payload),g(r.payload)}),m[t]=!0),m}async function h(l,g){const m=s(l),t=m.state;if(t!=="joined")return te("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{ie("廣播遊戲狀態:",g);const r=await m.send({type:"broadcast",event:"game_state",payload:g});return r==="error"?(te("發送遊戲狀態失敗"),{error:"發送失敗"}):r}catch(r){return te("發送遊戲狀態錯誤:",r),{error:r instanceof Error?r.message:"發送失敗"}}}async function I(l,g){const m=s(l),t=m.state;if(t!=="joined")return te("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const r=await m.send({type:"broadcast",event:"drawing",payload:{stroke:g}});return r==="error"?(te("發送失敗"),{error:"發送失敗"}):r}catch(r){return te("發送錯誤:",r),{error:r instanceof Error?r.message:"發送失敗"}}}function O(l){const g=`room:${l}`,m=se.get(g);c(l),m&&(b.removeChannel(m),se.delete(g)),ce.delete(l),Ce.delete(l)}function k(){Te.forEach((l,g)=>c(g)),se.forEach(l=>b.removeChannel(l)),se.clear(),ce.clear(),Ce.clear()}function W(){return ae.value}return{connectionStatus:ae,subscribeRoom:w,subscribeDrawing:Z,subscribeGuesses:D,subscribeGameState:S,sendDrawing:I,broadcastGameState:h,unsubscribeRoom:O,unsubscribeAll:k,getConnectionStatus:W}}const tr=6,or=60,nr=60,sr=60,Me=10,Ne=5,De=2,ar=3,ve=U(null),qe=U(!1);let we=null;const le=U(null);let he=null;const xe=U(new Set),ur=U("setup"),_e=U(null);let pe=null;function lr(){const e=Re(),d=ir(),s=tt();ne();const c=ve,C=qe,P=le,w=y(()=>e.currentRoom?.status||"waiting"),Z=y(()=>w.value==="playing"),D=y(()=>w.value==="waiting"),S=y(()=>w.value==="finished"),h=y(()=>d.roundStatus),I=y(()=>h.value==="drawing"),O=y(()=>h.value==="summary"),k=y(()=>e.currentRoom?.game_mode==="storyboard"),W=ur,l=_e,g=y(()=>k.value&&W.value==="drawing"),m=y(()=>k.value&&W.value==="writing"),t=y(()=>k.value&&W.value==="voting"),r=y(()=>k.value&&W.value==="summary"),_=y(()=>k.value&&W.value==="setup"),f=y(()=>k.value&&W.value==="ending"),$=y(()=>d.currentRound),R=y(()=>e.currentRoom?.current_round||0),p=y(()=>e.currentRoom?.settings.rounds||0),H=y(()=>e.currentRoom?.settings.draw_time||60),V=y(()=>d.isCurrentDrawer);function F(n){console.log("[useGame] startCountdown 開始，時長:",n,"秒"),we&&clearInterval(we),ve.value=n,qe.value=!0,we=window.setInterval(()=>{ve.value!==null&&ve.value>0?ve.value--:(o(),Z.value&&$.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),Q()))},1e3)}function o(){we&&(clearInterval(we),we=null),qe.value=!1}function a(){o(),ve.value=null}function v(){console.log("[useGame] startSummaryCountdown 開始"),he&&clearInterval(he),le.value=tr,console.log("[useGame] 開始總結倒計時:",tr,"秒"),he=window.setInterval(async()=>{le.value!==null&&le.value>0?(le.value--,console.log("[useGame] 總結倒計時:",le.value)):(u(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await X()))},1e3)}function u(){console.log("[useGame] stopSummaryCountdown"),he&&(clearInterval(he),he=null),le.value=null}function i(){if(!e.currentRoom)return null;const n=e.currentRoom.words;if(n.length===0)return null;const T=[];for(let N=0;N<n.length;N++)xe.value.has(N)||T.push(N);let A=0;if(T.length>0){const N=Math.floor(Math.random()*T.length);A=T[N]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),xe.value.clear(),A=Math.floor(Math.random()*n.length);return xe.value.add(A),n[A]??null}async function G(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{xe.value.clear();const n=e.participants.length,T=await e.updateRoomSettings({rounds:n});if(!T.success)return T;console.log("[useGame] 輪數已自動設定為房間人數:",n);const A=await e.updateRoomStatus("playing");if(!A.success)return A;if(k.value){console.log("[useGame] 分鏡模式：進入故事設定階段"),ue("setup"),s.clearAll();const{broadcastGameState:x}=ne();return await x(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"setup"}),{success:!0,isStoryboardSetup:!0}}return await M()}catch(n){return console.error("開始遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"開始遊戲失敗"}}}async function M(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const T=(e.currentRoom.current_round||0)+1;try{const A=(T-1)%e.participants.length,N=e.participants[A];if(console.log("[startDrawingPhase] 第",T,"輪，畫家:",N?.nickname),!N)throw new Error("無法選擇畫家");let x=null;if(k.value){const ee=s.latestSentence;ee?(x={text:ee.content,source:"custom"},console.log("[startDrawingPhase] 分鏡模式：使用故事句子作為題目:",x.text)):(x={text:"故事開始...",source:"custom"},console.log("[startDrawingPhase] 分鏡模式：沒有故事句子，使用佔位符"))}else{if(x=i(),!x)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 傳統模式：分配詞語:",x.text)}await e.updateRoomDrawer(N.user_id);const B=await d.createRound(e.currentRoom.id,N.user_id,x.text,x.source);if(!B.success||!B.round)throw new Error("創建輪次失敗");const{broadcastGameState:J}=ne();return k.value?await J(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",drawerId:N.user_id,drawerName:N.nickname,roundNumber:T,startedAt:B.round.started_at}):await J(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:N.user_id,drawerName:N.nickname,roundNumber:T,startedAt:B.round.started_at}),{success:!0,drawerId:N.user_id,word:x.text}}catch(A){return console.error("開始繪畫階段錯誤:",A),{success:!1,error:A instanceof Error?A.message:"開始繪畫階段失敗"}}}async function q(){return await M()}async function Q(){if(!$.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const n=await d.endRound();if(!n.success)return n;const T=!1,{broadcastGameState:A}=ne();return await A(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:T}),{success:!0,gameEnded:T}}catch(n){return console.error("結束輪次錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束輪次失敗"}}}async function X(){return e.currentRoom?e.isHost?(await M(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function dr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return o(),await e.updateRoomStatus("finished"),{success:!0}}catch(n){return console.error("結束遊戲錯誤:",n),{success:!1,error:n instanceof Error?n.message:"結束遊戲失敗"}}}async function mr(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(h.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),u(),await M()}catch(n){return console.error("下一局錯誤:",n),{success:!1,error:n instanceof Error?n.message:"下一局失敗"}}}const fr=y(()=>{if(c.value===null)return"--:--";const n=Math.floor(c.value/60),T=c.value%60;return`${n.toString().padStart(2,"0")}:${T.toString().padStart(2,"0")}`});function ue(n){console.log("[useGame] 設置分鏡模式階段:",n),ur.value=n,s.setPhase(n)}function gr(n,T){console.log("[useGame] 開始分鏡模式倒計時:",n,"秒"),pe&&clearInterval(pe),_e.value=n,pe=window.setInterval(()=>{_e.value!==null&&_e.value>0?_e.value--:(be(),T&&T())},1e3)}function be(){pe&&(clearInterval(pe),pe=null)}function vr(){be(),_e.value=null}async function wr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式繪畫階段"),ue("drawing"),s.clearRoundData();const{broadcastGameState:n}=ne();return await n(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"drawing",startedAt:new Date().toISOString()}),{success:!0}}async function hr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式編劇階段"),ue("writing");const{broadcastGameState:n}=ne();return await n(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"writing",startedAt:new Date().toISOString()}),{success:!0}}async function _r(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式投票階段"),ue("voting");const{broadcastGameState:n}=ne();return await n(e.currentRoom.code,{roundStatus:"drawing",storyboardPhase:"voting",startedAt:new Date().toISOString()}),{success:!0}}async function pr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式結算階段"),ue("summary");const{broadcastGameState:n}=ne();return await n(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"summary"}),{success:!0}}async function yr(){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以控制階段"};console.log("[useGame] 進入分鏡模式故事結局階段"),ue("ending");const{broadcastGameState:n}=ne();return await n(e.currentRoom.code,{roundStatus:"summary",storyboardPhase:"ending"}),{success:!0}}function He(){const n=s.submissions,T=s.votes;if(n.length===0)return console.log("[useGame] 沒有任何提交，使用默認句子"),{submission:null,voteCount:0,hasTie:!1};const A=new Map;for(const L of n)A.set(L.id,0);for(const L of T){const K=A.get(L.submissionId)||0;A.set(L.submissionId,K+1)}let N=-1,x=[];for(const L of n){const K=A.get(L.id)||0;K>N?(N=K,x=[L]):K===N&&x.push(L)}const B=x.length>1;if(x.length===1)return console.log("[useGame] 唯一最高票勝出:",x[0]?.sentence),{submission:x[0]||null,voteCount:N,hasTie:!1};const J=Math.floor(Math.random()*x.length),ee=x[J]||null;return console.log("[useGame] 平票隨機選擇勝出:",ee?.sentence,"(共",x.length,"個平票)"),{submission:ee,voteCount:N,hasTie:B}}async function Sr(n){if(!e.currentRoom||!e.isHost)return{success:!1,error:"只有房主可以執行結算"};if(!d.currentRound)return{success:!1,error:"沒有當前輪次"};const T=d.currentRound.round_number,A=d.currentRound.drawer_id,x=e.participants.find(B=>B.user_id===A)?.nickname||"畫家";console.log("[useGame] 開始分鏡模式輪次結算，輪次:",T);try{const{submission:B,voteCount:J,hasTie:ee}=He();let L,K,fe;B?(L=B.sentence,K=B.userId,fe=e.participants.find(ge=>ge.user_id===K)?.nickname||"編劇",await s.markWinningSubmission(B.id),console.log("[useGame] 勝出句子:",L,"作者:",fe,"票數:",J,"平票:",ee)):(L="故事繼續發展中...",K=A,fe=x,console.log("[useGame] 沒有提交，使用默認句子"));let Ee="/placeholder-image.png";if(n)try{const ye=await new Promise(ge=>{n.toBlob(ge,"image/png",.9)});if(ye){const{supabase:ge}=await Oe(async()=>{const{supabase:Pe}=await import("./index-DwjNSdXf.js").then(Gr=>Gr.O);return{supabase:Pe}},__vite__mapDeps([0,1])),Ir=Date.now(),Le=`storyboard/${e.currentRoom.id}/round_${T}_${Ir}.png`,{error:Ve}=await ge.storage.from("canvas-snapshots").upload(Le,ye,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(Ve)console.error("[useGame] 截圖上傳失敗:",Ve);else{const{data:Pe}=ge.storage.from("canvas-snapshots").getPublicUrl(Le);Ee=Pe.publicUrl,console.log("[useGame] 畫布截圖上傳成功:",Ee)}}}catch(ye){console.error("[useGame] 截圖上傳錯誤:",ye)}else console.warn("[useGame] 沒有畫布元素，使用佔位圖");await s.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:T,itemType:"image",content:Ee,authorId:A,authorName:x}),await s.addStoryChainItem({roomId:e.currentRoom.id,roundNumber:T,itemType:"text",content:L,authorId:K,authorName:fe}),console.log("[useGame] Story_Chain 已更新");const We=s.votes.length;let Ie=0;B&&(Ie=Me,await me(K,Ie),console.log("[useGame] 編劇勝出得分:",Ie,"分給",fe));const Ae=Ne+We*De;await me(A,Ae),console.log("[useGame] 畫家得分:",Ae,"分給",x,"(投票人數:",We,")");const Ze={success:!0,winningSentence:L,winnerName:fe,winnerId:K,winnerVoteCount:J,drawerScore:Ae,screenwriterScore:Ie,imageUrl:Ee};return console.log("[useGame] 輪次結算完成:",Ze),Ze}catch(B){return console.error("[useGame] 輪次結算錯誤:",B),{success:!1,error:B instanceof Error?B.message:"輪次結算失敗"}}}function Rr(){const n=document.querySelector("canvas.drawing-canvas");return n||document.querySelector("canvas")||null}function br(n){switch(n){case"drawing":return or;case"writing":return nr;case"voting":return sr;default:return 0}}function Be(){return Me}function Ue(n){return Ne+n*De}function $e(n){return Math.round(n*ar)}async function Er(n,T,A,N=0){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{const x=Be();console.log("[useGame] 編劇勝出得分:",x,"分給",n),await me(n,x);const B=Ue(A);if(console.log("[useGame] 畫家得分:",B,"分給",T,"(投票人數:",A,")"),await me(T,B),N>0){const J=$e(N);console.log("[useGame] 評星加分:",J,"分給",T,"(平均評星:",N,")"),await me(T,J)}return{success:!0}}catch(x){return console.error("[useGame] 計算分鏡模式得分錯誤:",x),{success:!1,error:x instanceof Error?x.message:"計算得分失敗"}}}async function me(n,T){if(!e.currentRoom)return console.error("[useGame] 沒有當前房間"),!1;try{const{supabase:A}=await Oe(async()=>{const{supabase:L}=await import("./index-DwjNSdXf.js").then(K=>K.O);return{supabase:L}},__vite__mapDeps([0,1])),{data:N,error:x}=await A.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",n).single();if(x)throw x;const B=(N?.score||0)+T,{error:J}=await A.from("room_participants").update({score:B}).eq("room_id",e.currentRoom.id).eq("user_id",n);if(J)throw J;const ee=e.participants.findIndex(L=>L.user_id===n);return ee!==-1&&e.participants[ee]&&(e.participants[ee].score=B),console.log("[useGame] 玩家",n,"得分更新為",B),!0}catch(A){return console.error("[useGame] 更新玩家分數錯誤:",A),!1}}return xr(()=>{o(),u(),be()}),{gameStatus:w,isPlaying:Z,isWaiting:D,isFinished:S,currentRound:$,currentRoundNumber:R,totalRounds:p,drawTime:H,isCurrentDrawer:V,timeRemaining:c,isCountingDown:C,formattedTime:fr,roundStatus:h,isDrawing:I,isSummary:O,summaryTimeRemaining:P,isStoryboardMode:k,storyboardPhase:W,storyboardTimeRemaining:l,isStoryboardDrawing:g,isStoryboardWriting:m,isStoryboardVoting:t,isStoryboardSummary:r,isStoryboardSetup:_,isStoryboardEnding:f,startGame:G,newGame:mr,startNextRound:q,startDrawingPhase:M,endRound:Q,continueToNextRound:X,endGame:dr,startCountdown:F,stopCountdown:o,startSummaryCountdown:v,stopSummaryCountdown:u,resetCountdown:a,setStoryboardPhase:ue,startStoryboardCountdown:gr,stopStoryboardCountdown:be,resetStoryboardCountdown:vr,enterStoryboardDrawingPhase:wr,enterStoryboardWritingPhase:hr,enterStoryboardVotingPhase:_r,enterStoryboardSummaryPhase:pr,enterStoryboardEndingPhase:yr,getStoryboardPhaseDuration:br,calculateWinningSentence:He,finalizeStoryboardRound:Sr,getCanvasElement:Rr,calculateScreenwriterWinScore:Be,calculateDirectorScore:Ue,calculateRatingBonus:$e,calculateStoryboardRoundScores:Er,updateStoryboardPlayerScore:me,STORYBOARD_DRAWING_TIME:or,STORYBOARD_WRITING_TIME:nr,STORYBOARD_VOTING_TIME:sr,SCREENWRITER_WIN_SCORE:Me,DIRECTOR_BASE_SCORE:Ne,DIRECTOR_VOTE_BONUS:De,RATING_BONUS_MULTIPLIER:ar}}const ot=Object.freeze(Object.defineProperty({__proto__:null,useGame:lr},Symbol.toStringTag,{value:"Module"})),nt={class:"waiting-lobby"},st={class:"card"},at={class:"card-body"},ut={class:"room-info text-center margin-bottom-medium"},ct={class:"card-title text-hand-title"},it={class:"room-details"},lt={class:"detail-item margin-bottom-small"},dt={class:"badge badge-secondary room-code-badge"},mt={class:"detail-item margin-bottom-small"},ft={class:"badge"},gt={class:"detail-item"},vt={class:"players-section margin-bottom-medium"},wt={class:"text-hand-title margin-bottom-small"},ht={class:"players-list"},_t={class:"player-avatar"},pt={class:"player-info"},yt={class:"player-name"},St={key:0,class:"badge badge-warning"},Rt={class:"room-settings margin-bottom-medium"},bt={class:"setting-item"},Et={class:"setting-value"},It={class:"setting-item"},Gt={class:"setting-value"},Ct={class:"setting-item"},Tt={class:"setting-value"},xt={class:"lobby-actions"},At=["disabled"],Pt={key:1,class:"alert alert-warning text-center"},Mt=["disabled"],Nt={key:0,class:"alert alert-danger margin-top-small"},Dt=cr({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:d}){const s=e,c=d,{isHost:C,canStartGame:P,minPlayersRequired:w,leaveRoom:Z,loading:D,error:S}=Xr(),{startGame:h}=lr(),I=y(()=>{const m=s.room?.settings.rounds||0,t=s.participants.length,r=m>0?m:t;return r>0?r:1});function O(m){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[m||""]||m||"未知"}function k(m){return{classic:"傳統模式",storyboard:"分鏡接龍"}[m||""]||"傳統模式"}function W(m){return s.room?.host_id===m}async function l(){(await h()).success&&c("startGame")}async function g(){(await Z()).success&&c("leaveRoom")}return(m,t)=>(z(),j("div",nt,[E("div",st,[E("div",at,[E("div",ut,[E("h2",ct,Y(e.room?.name),1),E("div",it,[E("div",lt,[t[0]||(t[0]=oe(" 房間碼：",-1)),E("span",dt,Y(e.room?.code),1)]),E("div",mt,[t[1]||(t[1]=oe(" 狀態：",-1)),E("span",ft,Y(O(e.room?.status)),1)]),E("div",gt,[t[2]||(t[2]=oe(" 模式：",-1)),E("span",{class:je(["badge",e.room?.game_mode==="storyboard"?"badge-success":"badge-primary"])},Y(k(e.room?.game_mode)),3)])])]),E("div",vt,[E("h4",wt,"玩家列表 ("+Y(e.participants.length)+")",1),E("div",ht,[(z(!0),j(ze,null,Ar(e.participants,r=>(z(),j("div",{key:r.id,class:je(["player-item",{"is-host":W(r.user_id)}])},[E("div",_t,Y(r.nickname.charAt(0).toUpperCase()),1),E("div",pt,[E("div",yt,[oe(Y(r.nickname)+" ",1),W(r.user_id)?(z(),j("span",St," 房主 ")):Se("",!0)])])],2))),128))])]),E("div",Rt,[E("div",bt,[t[4]||(t[4]=E("span",{class:"setting-label"},"繪畫時間：",-1)),E("span",Et,[E("strong",null,Y(e.room?.settings.draw_time),1),t[3]||(t[3]=oe("秒",-1))])]),E("div",It,[t[6]||(t[6]=E("span",{class:"setting-label"},"每局輪數：",-1)),E("span",Gt,[E("strong",null,Y(I.value),1),t[5]||(t[5]=oe("輪",-1))])]),E("div",Ct,[t[8]||(t[8]=E("span",{class:"setting-label"},"詞語總數：",-1)),E("span",Tt,[E("strong",null,Y(e.room?.word_count),1),t[7]||(t[7]=oe("個",-1))])])]),E("div",xt,[re(C)&&re(P)?(z(),j("button",{key:0,disabled:re(D),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:l},Y(re(D)?"開始中":"開始遊戲"),9,At)):re(C)?(z(),j("div",Pt,[oe(" 至少需要 "+Y(re(w))+" 個玩家才能開始遊戲 ",1),e.room?.game_mode==="storyboard"?(z(),j(ze,{key:0},[oe(" （分鏡接龍模式） ")],64)):Se("",!0)])):Se("",!0),E("button",{disabled:re(D),class:"paper-btn btn-secondary btn-block",onClick:g},Y(re(D)?"離開中":"離開房間"),9,Mt)]),re(S)?(z(),j("div",Nt,Y(re(S)),1)):Se("",!0)])])]))}}),kt=Pr(Dt,[["__scopeId","data-v-69e12be6"]]);export{Ot as I,kt as W,ne as a,Re as b,ir as c,rt as d,tt as e,lr as f,Xr as u};
