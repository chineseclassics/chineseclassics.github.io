import{l as fe,r as S,u as B,d as A,i as ne,m as oe,c as h,e as t,o as f,_ as J,f as T,n as L,a as x,F as z,p as U,q as K,t as W,b as c,s as O,x as me,y as ge,j as I,g as pe,v as _e,z as we,A as ye,k as be}from"./index-CVvD-iu2.js";import{c as Y,b as Q,d as Z,e as re,a as Fe,u as Ce,W as ke}from"./useRealtime-Bjpgzr1v.js";const ie=fe("drawing",()=>{const e=S("pen"),n=S("#000000"),a=S(3),u=S(!1),s=S([]);function o(v){e.value=v}function d(v){n.value=v}function _(v){a.value=Math.max(1,Math.min(20,v))}function b(v){s.value.push(v)}function R(){s.value=[]}function D(v){u.value=v}return{tool:e,color:n,lineWidth:a,isDrawing:u,strokes:s,setTool:o,setColor:d,setLineWidth:_,addStroke:b,clearStrokes:R,setDrawing:D}});function te(e,n){const a=e.getBoundingClientRect();let u,s;if(n instanceof MouseEvent)u=n.clientX,s=n.clientY;else if(n instanceof TouchEvent&&n.touches.length>0&&n.touches[0])u=n.touches[0].clientX,s=n.touches[0].clientY;else return null;return{x:u-a.left,y:s-a.top}}function ae(e,n){if(!(n.points.length<2)){e.save(),n.tool==="pen"?(e.strokeStyle=n.color,e.lineWidth=n.lineWidth,e.lineCap="round",e.lineJoin="round"):n.tool==="eraser"&&(e.globalCompositeOperation="destination-out",e.lineWidth=n.lineWidth,e.lineCap="round",e.lineJoin="round"),e.beginPath(),n.points[0]&&e.moveTo(n.points[0].x,n.points[0].y);for(let a=1;a<n.points.length;a++){const u=n.points[a];u&&e.lineTo(u.x,u.y)}e.stroke(),e.restore()}}function q(e,n){const a=e.getContext("2d");if(!a)return;const u=e.getBoundingClientRect();a.clearRect(0,0,e.width,e.height),a.fillStyle="#FFFFFF",a.fillRect(0,0,u.width,u.height),n.forEach(s=>{ae(a,s)})}function Re(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function le(){const e=ie(),n=Y(),a=B(),{sendDrawing:u}=Q(),s=S(null),o=S(null),d=S(null),_=S(null);let b=null;const R=50;function D(r){s.value=r;const w=r.getContext("2d",{willReadFrequently:!0});if(!w){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}o.value=w;const i=window.devicePixelRatio||1,E=r.getBoundingClientRect();r.width=E.width*i,r.height=E.height*i,w.scale(i,i),w.fillStyle="#FFFFFF",w.fillRect(0,0,E.width,E.height),s.value&&q(s.value,e.strokes),new ResizeObserver(()=>{if(!s.value||!o.value)return;const V=s.value.getBoundingClientRect(),P=window.devicePixelRatio||1;s.value.width=V.width*P,s.value.height=V.height*P,o.value.scale(P,P),o.value.fillStyle="#FFFFFF",o.value.fillRect(0,0,V.width,V.height),q(s.value,e.strokes)}).observe(r)}function v(r){if(!s.value)return;r.preventDefault(),e.setDrawing(!0);const w=te(s.value,r);w&&(d.value={id:Re(),tool:e.tool,color:e.color,lineWidth:e.lineWidth,points:[w],timestamp:Date.now()},_.value=w)}function F(r){if(!s.value||!o.value||!e.isDrawing||!d.value)return;r.preventDefault();const w=te(s.value,r);if(!w||!_.value)return;const i=o.value;i.save(),d.value.tool==="pen"?(i.strokeStyle=d.value.color,i.lineWidth=d.value.lineWidth,i.lineCap="round",i.lineJoin="round"):d.value.tool==="eraser"&&(i.globalCompositeOperation="destination-out",i.lineWidth=d.value.lineWidth,i.lineCap="round",i.lineJoin="round"),i.beginPath(),i.moveTo(_.value.x,_.value.y),i.lineTo(w.x,w.y),i.stroke(),i.restore(),d.value.points.push(w),_.value=w,b===null&&(b=window.setTimeout(()=>{m(),b=null},R))}function l(){!e.isDrawing||!d.value||(e.setDrawing(!1),b&&(clearTimeout(b),b=null),m(),d.value=null,_.value=null)}async function m(){if(!(!d.value||!n.currentRoom||!a.user))try{const r={...d.value,userId:a.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",r.id),await u(n.currentRoom.code,r)}catch(r){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",r)}}function p(r){if(!(!s.value||!o.value)){if(r.userId&&a.user&&r.userId===a.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",r.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",r.id),e.addStroke(r),ae(o.value,r)}}function g(){if(!s.value||!o.value)return;const r=o.value,w=s.value;r.clearRect(0,0,w.width,w.height),r.fillStyle="#FFFFFF",r.fillRect(0,0,w.width,w.height),e.clearStrokes()}function $(r){e.setTool(r)}function M(r){e.setColor(r)}function C(r){e.setLineWidth(r)}function N(){s.value&&q(s.value,e.strokes)}return{canvasRef:s,initCanvas:D,startDrawing:v,draw:F,stopDrawing:l,clearCanvas:g,setTool:$,setColor:M,setLineWidth:C,handleDrawingData:p,redrawStrokes:N}}const De={class:"drawing-canvas-container"},Se=A({__name:"DrawingCanvas",setup(e){const{initCanvas:n,startDrawing:a,draw:u,stopDrawing:s,handleDrawingData:o}=le(),d=Y(),_=B(),{subscribeDrawing:b}=Q(),R=S(null);function D(C){a(C)}function v(C){u(C)}function F(){s()}function l(){s()}function m(C){a(C)}function p(C){u(C)}function g(){s()}let $=null;function M(){!d.currentRoom||!_.user||($=b(d.currentRoom.code,C=>{o(C)}))}return ne(()=>{R.value&&n(R.value),M()}),oe(()=>{$&&($(),$=null)}),(C,N)=>(f(),h("div",De,[t("canvas",{ref_key:"canvasElement",ref:R,class:"drawing-canvas",onMousedown:D,onMousemove:v,onMouseup:F,onMouseleave:l,onTouchstart:m,onTouchmove:p,onTouchend:g},null,544)]))}}),We=J(Se,[["__scopeId","data-v-e71ea6a0"]]),$e={class:"toolbar-section"},Te={key:0,class:"tool-label"},xe={key:0,class:"tool-label"},Me={key:0,class:"toolbar-section colors-section"},Ge=["onClick","title"],Le={class:"toolbar-section size-section"},Ee={class:"size-dots"},Ve=["onClick","title"],Pe={class:"toolbar-section"},Ie={key:0,class:"tool-label"},Be=A({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(e){const n=ie(),{setTool:a,setColor:u,setLineWidth:s,clearCanvas:o}=le(),d=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],_=T(()=>n.tool),b=T(()=>n.color),R=T(()=>n.lineWidth);function D(m){a(m)}function v(m){u(m)}function F(m){n.setLineWidth(m),s(m)}function l(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&o()}return(m,p)=>(f(),h("div",{class:L(["drawing-toolbar",{"toolbar-compact":e.compact}])},[t("div",$e,[t("button",{onClick:p[0]||(p[0]=g=>D("pen")),class:L(["tool-btn",{active:_.value==="pen"}]),title:"ç•«ç­†"},[p[2]||(p[2]=t("span",{class:"tool-icon"},"âœï¸",-1)),e.compact?x("",!0):(f(),h("span",Te,"ç•«ç­†"))],2),t("button",{onClick:p[1]||(p[1]=g=>D("eraser")),class:L(["tool-btn",{active:_.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[p[3]||(p[3]=t("span",{class:"tool-icon"},"ğŸ§¹",-1)),e.compact?x("",!0):(f(),h("span",xe,"æ©¡çš®æ“¦"))],2)]),_.value==="pen"?(f(),h("div",Me,[t("div",{class:L(["color-grid",{"color-grid-compact":e.compact}])},[(f(),h(z,null,U(d,g=>t("div",{key:g,onClick:$=>v(g),class:L(["color-cell",{selected:b.value===g}]),style:K({backgroundColor:g}),title:g},null,14,Ge)),64))],2)])):x("",!0),t("div",Le,[t("div",Ee,[(f(),h(z,null,U([2,5,10,15],g=>t("div",{key:g,onClick:$=>F(g),class:L(["size-dot",{active:R.value===g}]),style:K({width:`${g+8}px`,height:`${g+8}px`}),title:`${g}px`},null,14,Ve)),64))])]),t("div",Pe,[t("button",{onClick:l,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[p[4]||(p[4]=t("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),e.compact?x("",!0):(f(),h("span",Ie,"æ¸…ç©º"))])])],2))}}),Ne=J(Be,[["__scopeId","data-v-7e7250c3"]]),Oe={class:"player-list"},ze={class:"player-list-header"},Ue={class:"player-count"},Ae={class:"player-rank"},Je={class:"player-info"},Ye={class:"player-name"},He={key:0,class:"drawer-badge"},Xe={key:1,class:"host-badge"},je={class:"player-score"},qe={key:0,class:"winner-banner"},Ke={class:"winner-text"},Qe={class:"winner-name"},Ze={class:"winner-score"},et=A({__name:"PlayerList",props:{showWinner:{type:Boolean}},setup(e){const n=Y(),a=Z(),u=B(),{playerRankings:s,winner:o}=re(),d=T(()=>s.value);function _(v){return n.participants.find(l=>l.user_id===v)?.nickname||"æœªçŸ¥ç©å®¶"}function b(v){return u.user?.id===v}function R(v){return n.currentRoom?.host_id===v}function D(v){return a.currentRound?.drawer_id===v}return(v,F)=>(f(),h("div",Oe,[t("div",ze,[t("span",Ue,"ç©å®¶ ("+W(d.value.length)+")",1)]),(f(!0),h(z,null,U(d.value,(l,m)=>(f(),h("div",{key:l.id,class:L(["player-item",{"is-current":b(l.user_id)},{"is-drawer":D(l.user_id)}])},[t("div",Ae,W(m+1),1),t("div",{class:L(["player-avatar",{drawing:D(l.user_id)}])},W(_(l.user_id).charAt(0)),3),t("div",Je,[t("div",Ye,[O(W(_(l.user_id))+" ",1),D(l.user_id)?(f(),h("span",He,"âœï¸")):x("",!0),R(l.user_id)?(f(),h("span",Xe,"ğŸ‘‘")):x("",!0)]),t("div",je,W(l.score)+" åˆ†",1)])],2))),128)),e.showWinner&&c(o)?(f(),h("div",qe,[F[1]||(F[1]=t("div",{class:"winner-icon"},"ğŸ†",-1)),t("div",Ke,[F[0]||(F[0]=t("div",{class:"winner-title"},"ç²å‹è€…",-1)),t("div",Qe,W(_(c(o).user_id)),1),t("div",Ze,W(c(o).score)+" åˆ†",1)])])):x("",!0)]))}}),se=J(et,[["__scopeId","data-v-4094673d"]]);function tt(){const e=Z(),n=B(),{calculateGuessScore:a,updatePlayerScore:u}=re(),s=S(""),o=S(null),d=S(!1),_=T(()=>e.isCurrentDrawer?e.currentWord:null),b=T(()=>e.correctGuesses),R=T(()=>n.user?e.hasGuessed(n.user.id):!1);async function D(){if(!e.currentRound||!n.user)return o.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return o.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return o.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(R.value)return o.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(e.isCurrentDrawer)return o.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{d.value=!0,o.value=null;const l=s.value.trim(),m=e.currentWord||"",p=v(l,m),g=p?a(b.value.length):0,{data:$,error:M}=await me.from("guesses").insert({round_id:e.currentRound.id,user_id:n.user.id,guess_text:l,is_correct:p,score_earned:g}).select().single();if(M)throw M;return e.guesses.push($),p&&n.user&&await u(n.user.id,g),p&&(s.value=""),{success:!0,isCorrect:p,guess:$}}catch(l){return o.value=l instanceof Error?l.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",l),{success:!1,error:o.value}}finally{d.value=!1}}function v(l,m){const p=l.trim(),g=m.trim();return p===g}function F(){o.value=null}return{guessInput:s,error:o,loading:d,currentWord:_,correctGuesses:b,hasGuessed:R,submitGuess:D,clearError:F}}const st={class:"game-container"},nt={key:0,class:"container margin-top-large"},ot={class:"row flex-center"},rt={class:"col-12 col-md-8"},it={key:1,class:"game-layout"},at={class:"game-sidebar game-players"},lt={class:"player-list-container"},ct={class:"game-main"},ut={class:"game-header"},dt={key:0,class:"time-display"},vt={key:1,class:"word-display"},ht={class:"word-text"},ft={key:2,class:"word-display"},mt={class:"word-slots"},gt={class:"game-content-area"},pt={class:"game-toolbar"},_t={class:"game-canvas"},wt={key:0,class:"time-progress"},yt={class:"game-chat-panel"},bt={key:0,class:"chat-msg word-hint-msg"},Ft={class:"msg-player"},Ct={key:0,class:"msg-correct"},kt={key:1,class:"msg-text"},Rt={key:1,class:"chat-msg correct-self"},Dt={class:"chat-input-area"},St=["placeholder","disabled"],Wt=["disabled"],$t={key:2,class:"container margin-top-large"},Tt={class:"row flex-center"},xt={class:"col-12 col-md-8"},Mt={class:"card"},Gt={class:"card-body text-center"},Lt=A({__name:"RoomView",setup(e){const n=ge(),a=be(),u=Y(),s=Z(),o=B(),{subscribeRoom:d,subscribeGuesses:_,unsubscribeRoom:b}=Q(),{isPlaying:R,isWaiting:D,isFinished:v,timeRemaining:F,isCountingDown:l,isCurrentDrawer:m,drawTime:p,startGame:g,skipWord:$}=Fe(),{hasGuessed:M,guessInput:C,submitGuess:N,loading:r}=tt(),{leaveRoom:w}=Ce(),i=T(()=>u.currentRoom),E=T(()=>r.value),H=S(null),V=S(null),P=T(()=>[...s.guesses].sort((y,k)=>new Date(y.guessed_at).getTime()-new Date(k.guessed_at).getTime()));function ce(y){return u.participants.find(G=>G.user_id===y)?.nickname||"æœªçŸ¥ç©å®¶"}const ue=T(()=>m.value?"ä½ æ˜¯ç•«å®¶ï¼Œè«‹ç•«ç•«...":M.value?"ä½ å·²çŒœä¸­ï¼":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),de=T(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ");function X(y){H.value=y,setTimeout(()=>{H.value=null},3e3)}async function ee(){!m.value&&C.value.trim()&&await N()}async function ve(){const y=await g();!y.success&&y.error&&X(y.error)}async function j(){const y=await w();i.value&&b(i.value.code),await a.push("/"),!y.success&&y.error&&X(y.error)}async function he(){const y=await $();!y.success&&y.error&&X(y.error)}return ne(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",n.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",i.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",o.user?.id);const y=n.params.code;y&&!i.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",y),i.value&&o.user&&(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",i.value.status),await s.loadCurrentRound(i.value.id),d(i.value.code,i.value.id,o.user.id,{nickname:o.profile?.display_name||"ç©å®¶"}),s.currentRound&&_(i.value.code,s.currentRound.id))}),oe(()=>{i.value&&b(i.value.code)}),(y,k)=>(f(),h("div",st,[c(D)?(f(),h("div",nt,[t("div",ot,[t("div",rt,[I(ke,{room:i.value,participants:c(u).participants,onStartGame:ve,onLeaveRoom:j},null,8,["room","participants"])])])])):c(R)?(f(),h("div",it,[t("div",at,[t("div",lt,[I(se,{"show-winner":!1})])]),t("div",ct,[t("div",ut,[c(l)&&c(F)!==null?(f(),h("div",dt,[t("span",{class:L(["time-number",{"time-warning":c(F)<=10}])},W(c(F)),3)])):x("",!0),c(m)&&c(s).currentWord?(f(),h("div",vt,[k[1]||(k[1]=t("span",{class:"word-label"},"ä½ çš„è©èª",-1)),t("span",ht,W(c(s).currentWord),1),t("button",{class:"skip-btn",onClick:he,title:"è·³éæ­¤è©"},"è·³é")])):(f(),h("div",ft,[t("span",mt,W(de.value),1)])),t("button",{class:"leave-btn",onClick:j,title:"é›¢é–‹æˆ¿é–“"},"âœ•")]),t("div",gt,[t("div",pt,[I(Ne,{compact:!0})]),t("div",_t,[I(We),c(l)&&c(F)!==null?(f(),h("div",wt,[t("div",{class:L(["time-bar",{"time-warning":c(F)<=10}]),style:K({width:`${c(F)/c(p)*100}%`})},null,6)])):x("",!0)]),t("div",yt,[t("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:V},[k[5]||(k[5]=t("div",{class:"chat-msg system-msg"},[t("span",{class:"msg-icon"},"ğŸ®"),O(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),c(m)&&c(s).currentWord?(f(),h("div",bt,[k[2]||(k[2]=t("span",{class:"msg-icon"},"ğŸ¨",-1)),k[3]||(k[3]=O(" ä½ è¦ç•«ï¼š",-1)),t("strong",null,W(c(s).currentWord),1)])):x("",!0),(f(!0),h(z,null,U(P.value,G=>(f(),h("div",{key:G.id,class:L(["chat-msg",{"correct-guess":G.is_correct,"wrong-guess":!G.is_correct}])},[t("span",Ft,W(ce(G.user_id)),1),G.is_correct?(f(),h("span",Ct,"çŒœä¸­äº†ï¼ +"+W(G.score_earned),1)):(f(),h("span",kt,W(G.guess_text),1))],2))),128)),c(M)?(f(),h("div",Rt,[...k[4]||(k[4]=[t("span",{class:"msg-icon"},"âœ…",-1),O(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):x("",!0)],512),t("div",Dt,[pe(t("input",{"onUpdate:modelValue":k[0]||(k[0]=G=>ye(C)?C.value=G:null),type:"text",placeholder:ue.value,maxlength:"32",disabled:E.value||c(M)||c(m),onKeyup:we(ee,["enter"]),class:"chat-input-field"},null,40,St),[[_e,c(C)]]),t("button",{onClick:ee,disabled:E.value||c(M)||c(m)||!c(C).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Wt)])])])])])):c(v)?(f(),h("div",$t,[t("div",Tt,[t("div",xt,[t("div",Mt,[t("div",Gt,[k[6]||(k[6]=t("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),I(se,{"show-winner":!0}),t("button",{onClick:j,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):x("",!0)]))}}),Pt=J(Lt,[["__scopeId","data-v-4c7a9ab1"]]);export{Pt as default};
