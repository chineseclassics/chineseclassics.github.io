import{l as xe,r as x,u as O,d as K,i as oe,m as re,c as l,e,o as c,_ as Y,f as G,n as E,a as M,F as N,p as P,q as ne,t as g,b as o,s as J,h as X,x as q,y as Te,j as B,g as Ie,v as Ge,z as Me,A as Ee,k as Le,B as Ve}from"./index-RTQFg-in.js";import{c as j,b as ae,d as ie,e as fe,a as Ne,u as Be,W as Pe}from"./WaitingLobby-FhoB4IpG.js";const we=xe("drawing",()=>{const t=x("pen"),r=x("#000000"),m=x(3),v=x(!1),s=x([]);function d(b){t.value=b}function f(b){r.value=b}function w(b){m.value=Math.max(1,Math.min(20,b))}function y(b){s.value.push(b)}function T(){s.value=[]}function S(b){v.value=b}return{tool:t,color:r,lineWidth:m,isDrawing:v,strokes:s,setTool:d,setColor:f,setLineWidth:w,addStroke:y,clearStrokes:T,setDrawing:S}});function he(t,r){const m=t.getBoundingClientRect();let v,s;if(r instanceof MouseEvent)v=r.clientX,s=r.clientY;else if(r instanceof TouchEvent&&r.touches.length>0&&r.touches[0])v=r.touches[0].clientX,s=r.touches[0].clientY;else return null;return{x:v-m.left,y:s-m.top}}function pe(t,r){if(!(r.points.length<2)){t.save(),r.tool==="pen"?(t.strokeStyle=r.color,t.lineWidth=r.lineWidth,t.lineCap="round",t.lineJoin="round"):r.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=r.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),r.points[0]&&t.moveTo(r.points[0].x,r.points[0].y);for(let m=1;m<r.points.length;m++){const v=r.points[m];v&&t.lineTo(v.x,v.y)}t.stroke(),t.restore()}}function te(t,r){const m=t.getContext("2d");if(!m)return;const v=t.getBoundingClientRect();m.clearRect(0,0,t.width,t.height),m.fillStyle="#FFFFFF",m.fillRect(0,0,v.width,v.height),r.forEach(s=>{pe(m,s)})}function He(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ye(){const t=we(),r=j(),m=O(),{sendDrawing:v}=ae(),s=x(null),d=x(null),f=x(null),w=x(null);let y=null;const T=50;function S(i){s.value=i;const $=i.getContext("2d",{willReadFrequently:!0});if(!$){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}d.value=$;const D=window.devicePixelRatio||1,H=i.getBoundingClientRect();i.width=H.width*D,i.height=H.height*D,$.scale(D,D),$.fillStyle="#FFFFFF",$.fillRect(0,0,H.width,H.height),s.value&&te(s.value,t.strokes),new ResizeObserver(()=>{if(!s.value||!d.value)return;const V=s.value.getBoundingClientRect(),A=window.devicePixelRatio||1;s.value.width=V.width*A,s.value.height=V.height*A,d.value.scale(A,A),d.value.fillStyle="#FFFFFF",d.value.fillRect(0,0,V.width,V.height),te(s.value,t.strokes)}).observe(i)}function b(i){if(!s.value)return;i.preventDefault(),t.setDrawing(!0);const $=he(s.value,i);$&&(f.value={id:He(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[$],timestamp:Date.now()},w.value=$)}function F(i){if(!s.value||!d.value||!t.isDrawing||!f.value)return;i.preventDefault();const $=he(s.value,i);if(!$||!w.value)return;const D=d.value;D.save(),f.value.tool==="pen"?(D.strokeStyle=f.value.color,D.lineWidth=f.value.lineWidth,D.lineCap="round",D.lineJoin="round"):f.value.tool==="eraser"&&(D.globalCompositeOperation="destination-out",D.lineWidth=f.value.lineWidth,D.lineCap="round",D.lineJoin="round"),D.beginPath(),D.moveTo(w.value.x,w.value.y),D.lineTo($.x,$.y),D.stroke(),D.restore(),f.value.points.push($),w.value=$,y===null&&(y=window.setTimeout(()=>{R(),y=null},T))}function k(){!t.isDrawing||!f.value||(t.setDrawing(!1),y&&(clearTimeout(y),y=null),R(),f.value=null,w.value=null)}async function R(){if(!(!f.value||!r.currentRoom||!m.user))try{const i={...f.value,userId:m.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",i.id),await v(r.currentRoom.code,i)}catch(i){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",i)}}function p(i){if(!(!s.value||!d.value)){if(i.userId&&m.user&&i.userId===m.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",i.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",i.id),t.addStroke(i),pe(d.value,i)}}function n(){if(!s.value||!d.value)return;const i=d.value,$=s.value;i.clearRect(0,0,$.width,$.height),i.fillStyle="#FFFFFF",i.fillRect(0,0,$.width,$.height),t.clearStrokes()}function a(i){t.setTool(i)}function h(i){t.setColor(i)}function C(i){t.setLineWidth(i)}function L(){s.value&&te(s.value,t.strokes)}return{canvasRef:s,initCanvas:S,startDrawing:b,draw:F,stopDrawing:k,clearCanvas:n,setTool:a,setColor:h,setLineWidth:C,handleDrawingData:p,redrawStrokes:L}}const Ae={class:"drawing-canvas-container"},Oe=K({__name:"DrawingCanvas",setup(t){const{initCanvas:r,startDrawing:m,draw:v,stopDrawing:s,handleDrawingData:d,clearCanvas:f}=ye(),w=j(),y=O(),{subscribeDrawing:T}=ae(),S=x(null);function b(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),f()}function F(i){m(i)}function k(i){v(i)}function R(){s()}function p(){s()}function n(i){m(i)}function a(i){v(i)}function h(){s()}let C=null;function L(){!w.currentRoom||!y.user||(C=T(w.currentRoom.code,i=>{d(i)}))}return oe(()=>{S.value&&r(S.value),L(),window.addEventListener("clearCanvas",b)}),re(()=>{C&&(C(),C=null),window.removeEventListener("clearCanvas",b)}),(i,$)=>(c(),l("div",Ae,[e("canvas",{ref_key:"canvasElement",ref:S,class:"drawing-canvas",onMousedown:F,onMousemove:k,onMouseup:R,onMouseleave:p,onTouchstart:n,onTouchmove:a,onTouchend:h},null,544)]))}}),ze=Y(Oe,[["__scopeId","data-v-f29d9704"]]),Ue={class:"toolbar-section"},qe={key:0,class:"tool-label"},Je={key:0,class:"tool-label"},Ke={key:0,class:"toolbar-section colors-section"},Ye=["onClick","title"],Xe={class:"toolbar-section size-section"},je={class:"size-dots"},Qe=["onClick","title"],Ze={class:"toolbar-section"},es={key:0,class:"tool-label"},ss=K({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const r=we(),{setTool:m,setColor:v,setLineWidth:s,clearCanvas:d}=ye(),f=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],w=G(()=>r.tool),y=G(()=>r.color),T=G(()=>r.lineWidth);function S(R){m(R)}function b(R){v(R)}function F(R){r.setLineWidth(R),s(R)}function k(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&d()}return(R,p)=>(c(),l("div",{class:E(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",Ue,[e("button",{onClick:p[0]||(p[0]=n=>S("pen")),class:E(["tool-btn",{active:w.value==="pen"}]),title:"ç•«ç­†"},[p[2]||(p[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?M("",!0):(c(),l("span",qe,"ç•«ç­†"))],2),e("button",{onClick:p[1]||(p[1]=n=>S("eraser")),class:E(["tool-btn",{active:w.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[p[3]||(p[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?M("",!0):(c(),l("span",Je,"æ©¡çš®æ“¦"))],2)]),w.value==="pen"?(c(),l("div",Ke,[e("div",{class:E(["color-grid",{"color-grid-compact":t.compact}])},[(c(),l(N,null,P(f,n=>e("div",{key:n,onClick:a=>b(n),class:E(["color-cell",{selected:y.value===n}]),style:ne({backgroundColor:n}),title:n},null,14,Ye)),64))],2)])):M("",!0),e("div",Xe,[e("div",je,[(c(),l(N,null,P([2,5,10,15],n=>e("div",{key:n,onClick:a=>F(n),class:E(["size-dot",{active:T.value===n}]),style:ne({width:`${n+8}px`,height:`${n+8}px`}),title:`${n}px`},null,14,Qe)),64))])]),e("div",Ze,[e("button",{onClick:k,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[p[4]||(p[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?M("",!0):(c(),l("span",es,"æ¸…ç©º"))])])],2))}}),ge=Y(ss,[["__scopeId","data-v-7e7250c3"]]),ts={class:"player-list"},ns={class:"player-list-header"},os={class:"player-count"},rs={class:"player-rank"},as={class:"player-info"},is={class:"player-name"},ls={key:0,class:"drawer-badge"},cs={key:1,class:"host-badge"},us={class:"player-score"},ds=["onClick"],vs={key:0,class:"winner-banner"},ms={class:"winner-text"},hs={class:"winner-name"},gs={class:"winner-score"},_s=K({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:r}){const m=r,v=j(),s=ie(),d=O(),{playerRankings:f,winner:w}=fe(),y=G(()=>f.value),T=x(!1);function S(n){return v.participants.find(h=>h.user_id===n)?.nickname||"æœªçŸ¥ç©å®¶"}function b(n){return d.user?.id===n}function F(n){return v.currentRoom?.host_id===n}function k(n){return s.currentRound?.drawer_id===n||v.currentRoom?.current_drawer_id===n}function R(n){return v.isHost&&!b(n)}async function p(n,a){if(!(T.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${a} å—ï¼Ÿ`))){T.value=!0;try{const C=await v.kickPlayer(n);C.success?m("player-kicked",n):alert(C.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch(C){console.error("è¸¢äººå¤±æ•—:",C),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{T.value=!1}}}return(n,a)=>(c(),l("div",ts,[e("div",ns,[e("span",os,"ç©å®¶ ("+g(y.value.length)+")",1)]),(c(!0),l(N,null,P(y.value,(h,C)=>(c(),l("div",{key:h.id,class:E(["player-item",{"is-current":b(h.user_id)},{"is-drawer":k(h.user_id)}])},[e("div",rs,g(C+1),1),e("div",{class:E(["player-avatar",{drawing:k(h.user_id)}])},g(S(h.user_id).charAt(0)),3),e("div",as,[e("div",is,[J(g(S(h.user_id))+" ",1),k(h.user_id)?(c(),l("span",ls,"âœï¸")):M("",!0),F(h.user_id)?(c(),l("span",cs,"ğŸ‘‘")):M("",!0)]),e("div",us,g(h.score)+" åˆ†",1)]),R(h.user_id)?(c(),l("button",{key:0,class:"kick-btn",onClick:L=>p(h.user_id,S(h.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,ds)):M("",!0)],2))),128)),t.showWinner&&o(w)?(c(),l("div",vs,[a[1]||(a[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",ms,[a[0]||(a[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",hs,g(S(o(w).user_id)),1),e("div",gs,g(o(w).score)+" åˆ†",1)])])):M("",!0)]))}}),_e=Y(_s,[["__scopeId","data-v-984c1c4a"]]),fs={class:"round-summary"},ws={class:"summary-card"},ps={key:0,class:"selection-waiting-banner"},ys={class:"waiting-text"},bs={class:"next-drawer-name"},Rs={class:"summary-header"},ks={class:"summary-title"},Cs={class:"round-info"},$s={class:"answer-reveal"},Ss={class:"answer-text"},Fs={class:"drawer-section"},Ds={class:"drawer-info"},Ws={class:"drawer-name"},xs={key:0,class:"drawer-score"},Ts={class:"guessers-section"},Is={key:0,class:"no-guessers"},Gs={key:1,class:"guessers-list"},Ms={class:"guesser-rank"},Es={class:"guesser-name"},Ls={class:"guesser-score"},Vs={key:1,class:"rating-section"},Ns={class:"star-rating"},Bs=["onMouseenter","onClick","disabled"],Ps={class:"rating-info"},Hs={key:0,class:"rated-text"},As={key:1,class:"rate-hint"},Os={key:2,class:"average-rating"},zs={class:"avg-score"},Us={class:"avg-stars"},qs={class:"avg-count"},Js=K({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:r}){const m=t,v=r,s=O(),d=x(0),f=x(0),w=x(!1),y=x([]),T=G(()=>s.user?.id===m.drawerId),S=G(()=>y.value.length===0?0:y.value.reduce((a,h)=>a+h.rating,0)/y.value.length),b=G(()=>y.value.length);async function F(n){if(!(w.value||T.value||!s.user))try{const{error:a}=await q.from("drawing_ratings").upsert({round_id:m.roundId,rater_id:s.user.id,drawer_id:m.drawerId,rating:n},{onConflict:"round_id,rater_id"});if(a)throw a;d.value=n,w.value=!0,v("rating-submitted",n)}catch(a){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",a)}}async function k(){try{const{data:n,error:a}=await q.from("drawing_ratings").select("rater_id, rating").eq("round_id",m.roundId);if(a)throw a;if(y.value=n||[],s.user){const h=y.value.find(C=>C.rater_id===s.user.id);h&&(d.value=h.rating,w.value=!0)}}catch(n){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",n)}}function R(){const n=q.channel(`ratings:${m.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${m.roundId}`},()=>{k()}).subscribe();return()=>{q.removeChannel(n)}}let p=null;return oe(()=>{k(),p=R()}),re(()=>{p&&p()}),X(()=>m.roundId,()=>{k()}),(n,a)=>(c(),l("div",fs,[e("div",ws,[t.isWaitingForSelection?(c(),l("div",ps,[a[2]||(a[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",ys,[e("span",bs,g(t.nextDrawerName),1),a[1]||(a[1]=J(" æ­£åœ¨é¸è©... ",-1))]),a[3]||(a[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",Rs,[e("h2",ks,g(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Cs,"ç¬¬ "+g(t.roundNumber)+" / "+g(t.totalRounds)+" è¼ª",1)]),e("div",$s,[a[4]||(a[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Ss,g(t.correctAnswer),1)]),e("div",Fs,[e("div",Ds,[a[5]||(a[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Ws,g(t.drawerName),1),t.drawerScore>0?(c(),l("span",xs,"+"+g(t.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",Ts,[a[6]||(a[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(c(),l("div",Is," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(c(),l("div",Gs,[(c(!0),l(N,null,P(t.correctGuessers,(h,C)=>(c(),l("div",{key:h.userId,class:"guesser-item"},[e("span",Ms,g(C+1),1),e("span",Es,g(h.name),1),e("span",Ls,"+"+g(h.score),1)]))),128))]))]),T.value?M("",!0):(c(),l("div",Vs,[a[7]||(a[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Ns,[(c(),l(N,null,P(5,h=>e("button",{key:h,class:E(["star-btn",{active:h<=(f.value||d.value),selected:h<=d.value}]),onMouseenter:C=>f.value=h,onMouseleave:a[0]||(a[0]=C=>f.value=0),onClick:C=>F(h),disabled:w.value}," â­ ",42,Bs)),64))]),e("div",Ps,[w.value?(c(),l("span",Hs,"ä½ çš„è©•åˆ†ï¼š"+g(d.value)+" æ˜Ÿ",1)):(c(),l("span",As,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),b.value>0?(c(),l("div",Os,[a[8]||(a[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",zs,g(S.value.toFixed(1)),1),e("span",Us,g("â­".repeat(Math.round(S.value))),1),e("span",qs,"("+g(b.value)+" äººå·²è©•)",1)])):M("",!0)])]))}}),Ks=Y(Js,[["__scopeId","data-v-64089556"]]);function Ys(){const t=ie(),r=O(),{calculateGuessScore:m,updatePlayerScore:v}=fe(),s=x(""),d=x(null),f=x(!1),w=G(()=>t.isCurrentDrawer?t.currentWord:null),y=G(()=>t.correctGuesses),T=G(()=>r.user?t.hasGuessed(r.user.id):!1);async function S(){if(!t.currentRound||!r.user)return d.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return d.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return d.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(T.value)return d.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return d.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{f.value=!0,d.value=null;const k=s.value.trim(),R=t.currentWord||"",p=b(k,R),n=p?m(y.value.length):0,{data:a,error:h}=await q.from("guesses").insert({round_id:t.currentRound.id,user_id:r.user.id,guess_text:k,is_correct:p,score_earned:n}).select().single();if(h)throw h;return t.guesses.push(a),p&&r.user&&await v(r.user.id,n),s.value="",{success:!0,isCorrect:p,guess:a}}catch(k){return d.value=k instanceof Error?k.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",k),{success:!1,error:d.value}}finally{f.value=!1}}function b(k,R){const p=k.trim(),n=R.trim();return p===n}function F(){d.value=null}return{guessInput:s,error:d,loading:f,currentWord:w,correctGuesses:y,hasGuessed:T,submitGuess:S,clearError:F}}const Xs={class:"game-container"},js={key:0,class:"container margin-top-large"},Qs={class:"row flex-center"},Zs={class:"col-12 col-md-8"},et={key:1,class:"game-layout"},st={class:"game-sidebar game-players"},tt={class:"player-list-container"},nt={class:"game-main"},ot={key:0,class:"time-display"},rt={key:1,class:"time-display summary"},at={class:"time-number"},it={class:"round-info"},lt={class:"round-label"},ct={key:0,class:"phase-label"},ut={key:2,class:"word-display"},dt={class:"word-text"},vt={key:3,class:"word-display"},mt={class:"drawer-hint"},ht={class:"word-slots"},gt={key:4,class:"word-display summary-word"},_t={class:"word-text revealed"},ft={class:"game-content-area"},wt={class:"game-toolbar disabled"},pt={class:"game-canvas summary-phase"},yt={class:"game-chat-panel"},bt={class:"chat-msg system-msg answer-revealed"},Rt={class:"msg-player"},kt={class:"msg-correct"},Ct={class:"game-toolbar"},$t={class:"game-canvas"},St={key:0,class:"time-progress"},Ft={class:"game-chat-panel"},Dt={class:"msg-player"},Wt={key:0,class:"msg-correct"},xt={key:1,class:"msg-text"},Tt={key:0,class:"chat-msg correct-self"},It={class:"chat-input-area"},Gt=["placeholder","disabled"],Mt=["disabled"],Et={key:2,class:"container margin-top-large"},Lt={class:"row flex-center"},Vt={class:"col-12 col-md-8"},Nt={class:"card"},Bt={class:"card-body text-center"},Pt=K({__name:"RoomView",setup(t){const r=Te(),m=Le(),v=j(),s=ie(),d=O(),{subscribeRoom:f,unsubscribeRoom:w,subscribeGameState:y}=ae(),{isPlaying:T,isWaiting:S,isFinished:b,timeRemaining:F,isCountingDown:k,isCurrentDrawer:R,drawTime:p,currentRoundNumber:n,totalRounds:a,startGame:h,isDrawing:C,isSummary:L,summaryTimeRemaining:i,startSummaryCountdown:$,stopSummaryCountdown:D,startCountdown:H}=Ne(),{hasGuessed:z,guessInput:V,submitGuess:A,loading:be}=Ys(),{leaveRoom:Re}=Be(),W=G(()=>v.currentRoom),le=G(()=>be.value),ce=x(null),U=x(null),Q=G(()=>{const _=W.value?.current_drawer_id;return _&&v.participants.find(I=>I.user_id===_)?.nickname||"ç•«å®¶"}),ue=G(()=>[...s.guesses].sort((_,u)=>new Date(_.guessed_at).getTime()-new Date(u.guessed_at).getTime()));function ke(){U.value&&(U.value.scrollTop=U.value.scrollHeight)}X(ue,()=>{Ve(ke)},{deep:!0}),X(()=>v.participants,_=>{if(!d.user||!W.value)return;!_.some(I=>I.user_id===d.user.id)&&W.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),v.clearRoom(),m.push("/"))},{deep:!0});function Z(_){return v.participants.find(I=>I.user_id===_)?.nickname||"æœªçŸ¥ç©å®¶"}const Ce=G(()=>R.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":z.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),$e=G(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),de=G(()=>s.currentRoundCorrectGuesses.length*5),ve=G(()=>s.currentRoundCorrectGuesses.map(_=>({userId:_.user_id,name:Z(_.user_id),score:_.score_earned}))),Se=x(null);function Fe(){!s.currentRound||!s.currentWord||(Se.value={roundNumber:n.value,answer:s.currentWord,drawerName:Q.value,drawerId:s.currentRound.drawer_id,drawerScore:de.value,correctGuessers:ve.value,roundId:s.currentRound.id})}X(L,(_,u)=>{_&&!u&&n.value>0&&Fe()});function ee(_){ce.value=_,setTimeout(()=>{ce.value=null},3e3)}async function me(){!R.value&&V.value.trim()&&await A()}async function De(){const _=await h();!_.success&&_.error&&ee(_.error)}async function se(){const _=await Re();W.value&&w(W.value.code),await m.push("/"),!_.success&&_.error&&ee(_.error)}async function We(_){if(!s.currentRound)return;const u=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,_);!u.success&&u.error&&ee(u.error)}return oe(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",r.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",W.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",d.user?.id);const _=r.params.code;if(_&&!W.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",_),W.value&&d.user){console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",W.value.status),await s.loadCurrentRound(W.value.id);try{await f(W.value.code,W.value.id,d.user.id,{nickname:d.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(u){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",u)}y(W.value.code,async u=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",u,"æ˜¯å¦æˆ¿ä¸»:",v.isHost),u.drawerId&&W.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",u.drawerId),v.setCurrentDrawer(u.drawerId)),u.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",u.roundStatus),s.setRoundStatus(u.roundStatus),v.isHost?u.roundStatus==="drawing"&&window.dispatchEvent(new CustomEvent("clearCanvas")):(u.roundStatus==="drawing"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),D(),H(p.value)),u.roundStatus==="summary"&&$())),W.value&&(await v.loadRoom(W.value.id),await s.loadCurrentRound(W.value.id))}),await s.loadAllGuesses(W.value.id)}}),re(()=>{W.value&&w(W.value.code)}),(_,u)=>(c(),l("div",Xs,[o(S)?(c(),l("div",js,[e("div",Qs,[e("div",Zs,[B(Pe,{room:W.value,participants:o(v).participants,onStartGame:De,onLeaveRoom:se},null,8,["room","participants"])])])])):o(T)?(c(),l("div",et,[e("div",st,[e("div",tt,[B(_e,{"show-winner":!1})])]),e("div",nt,[e("div",{class:E(["game-header",{"time-critical":o(F)!==null&&o(F)<=10}])},[o(C)&&o(k)&&o(F)!==null?(c(),l("div",ot,[e("span",{class:E(["time-number",{"time-warning":o(F)<=10,"time-critical-pulse":o(F)<=5}])},g(o(F)),3),u[1]||(u[1]=e("span",{class:"time-label"},"ç§’",-1))])):o(L)&&o(i)!==null?(c(),l("div",rt,[e("span",at,g(o(i)),1),u[2]||(u[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",it,[e("span",lt,"ç¬¬ "+g(o(n))+" / "+g(o(a))+" è¼ª",1),o(L)?(c(),l("span",ct,"è¼ªæ¬¡çµç®—")):M("",!0)]),o(C)&&o(R)&&o(s).currentWord?(c(),l("div",ut,[u[3]||(u[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",dt,g(o(s).currentWord),1)])):o(C)?(c(),l("div",vt,[e("span",mt,"ğŸ¨ "+g(Q.value)+" æ­£åœ¨ç•«",1),e("span",ht,g($e.value),1)])):o(L)&&o(s).currentWord?(c(),l("div",gt,[u[4]||(u[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",_t,g(o(s).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:se,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",ft,[o(L)?(c(),l(N,{key:0},[e("div",wt,[B(ge,{compact:!0})]),e("div",pt,[B(Ks,{"round-number":o(n),"total-rounds":o(a),"correct-answer":o(s).currentWord||"","drawer-name":Q.value,"drawer-id":o(s).currentRound?.drawer_id||"","drawer-score":de.value,"correct-guessers":ve.value,"round-id":o(s).currentRound?.id||"","is-host":o(v).isHost,"is-last-round":o(n)>=o(a),onRatingSubmitted:We},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",yt,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[e("div",bt,[u[5]||(u[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),u[6]||(u[6]=J(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,g(o(s).currentWord),1)]),(c(!0),l(N,null,P(o(s).currentRoundCorrectGuesses,I=>(c(),l("div",{key:I.id,class:"chat-msg correct-guess"},[e("span",Rt,g(Z(I.user_id)),1),e("span",kt,"çŒœä¸­äº†ï¼ +"+g(I.score_earned),1)]))),128))],512),u[7]||(u[7]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(c(),l(N,{key:1},[e("div",Ct,[B(ge,{compact:!0})]),e("div",$t,[B(ze),o(k)&&o(F)!==null?(c(),l("div",St,[e("div",{class:E(["time-bar",{"time-warning":o(F)<=10}]),style:ne({width:`${o(F)/o(p)*100}%`})},null,6)])):M("",!0)]),e("div",Ft,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:U},[u[9]||(u[9]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),J(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(c(!0),l(N,null,P(ue.value,I=>(c(),l("div",{key:I.id,class:E(["chat-msg",{"correct-guess":I.is_correct,"wrong-guess":!I.is_correct}])},[e("span",Dt,g(Z(I.user_id)),1),I.is_correct?(c(),l("span",Wt,"çŒœä¸­äº†ï¼ +"+g(I.score_earned),1)):(c(),l("span",xt,g(I.guess_text),1))],2))),128)),o(z)?(c(),l("div",Tt,[...u[8]||(u[8]=[e("span",{class:"msg-icon"},"âœ…",-1),J(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",It,[Ie(e("input",{"onUpdate:modelValue":u[0]||(u[0]=I=>Ee(V)?V.value=I:null),type:"text",placeholder:Ce.value,maxlength:"32",disabled:le.value||o(z)||o(R),onKeyup:Me(me,["enter"]),class:"chat-input-field"},null,40,Gt),[[Ge,o(V)]]),e("button",{onClick:me,disabled:le.value||o(z)||o(R)||!o(V).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Mt)])])],64))])])])):o(b)?(c(),l("div",Et,[e("div",Lt,[e("div",Vt,[e("div",Nt,[e("div",Bt,[u[10]||(u[10]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),B(_e,{"show-winner":!0}),e("button",{onClick:se,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),Ot=Y(Pt,[["__scopeId","data-v-bed90a17"]]);export{Ot as default};
