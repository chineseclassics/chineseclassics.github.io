import{d as _e,f as y,q as ne,c as N,o as D,s as ye,a as ie,e as w,x as Se,y as he,r as T,u as re,B as p,H as Ee,h as be,t as U,m as Y,F as Ce,j as Ge,b as L,n as Ae,_ as Ie}from"./index-Bg7Q6id3.js";const Me=["width","height","fill","transform"],ke={key:0},Te=w("path",{d:"M236,32a12,12,0,0,0-12-12c-44.78,0-90,48.54-115.9,82a64,64,0,0,0-80,62c0,12-3.1,22.71-9.23,31.76A43,43,0,0,1,9.4,206.05a11.88,11.88,0,0,0-4.91,13.38A12.07,12.07,0,0,0,16.11,228h76A64,64,0,0,0,154,148C187.49,122.05,236,76.8,236,32ZM209.62,46.39c-4,12.92-13.15,27.49-26.92,42.91-3,3.39-6.16,6.7-9.35,9.89a104.31,104.31,0,0,0-16.5-16.51c3.19-3.19,6.49-6.32,9.88-9.35C182.15,59.55,196.71,50.43,209.62,46.39ZM92.07,204H42a80.17,80.17,0,0,0,10.14-40,40,40,0,1,1,40,40Zm38.18-91.32c3.12-3.93,6.55-8.09,10.23-12.35a80.52,80.52,0,0,1,15.23,15.24c-4.26,3.68-8.42,7.11-12.35,10.23A64.43,64.43,0,0,0,130.25,112.68Z"},null,-1),qe=[Te],xe={key:1},Ne=w("path",{d:"M224,32c0,32.81-31.64,67.43-58.64,91.05A84.39,84.39,0,0,0,133,90.64C156.57,63.64,191.19,32,224,32Z",opacity:"0.2"},null,-1),De=w("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),He=[Ne,De],Pe={key:2},$e=w("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM124.42,113.55q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),Ue=[$e],Oe={key:3},Be=w("path",{d:"M224,26c-20.8,0-44.11,11.41-69.3,33.9C136.62,76.06,121,94.9,110.3,109A58,58,0,0,0,34,164c0,32.07-20.43,46.39-21.35,47A6,6,0,0,0,16,222H92a58,58,0,0,0,55-76.3c14.08-10.67,32.92-26.32,49.08-44.4C218.59,76.11,230,52.8,230,32A6,6,0,0,0,224,26ZM92,210H30.65C37.92,200.85,46,185.78,46,164a46,46,0,1,1,46,46Zm29.49-95.91c3.6-4.67,7.88-10,12.71-15.69a78.17,78.17,0,0,1,23.4,23.4c-5.67,4.83-11,9.11-15.69,12.71A58.38,58.38,0,0,0,121.49,114.09Zm45.2-.3a90.24,90.24,0,0,0-24.48-24.48C163.05,66.46,191,42,217.56,38.44,214,65,189.54,93,166.69,113.79Z"},null,-1),Ze=[Be],je={key:4},Le=w("path",{d:"M232,32a8,8,0,0,0-8-8c-44.08,0-89.31,49.71-114.43,82.63A60,60,0,0,0,32,164c0,30.88-19.54,44.73-20.47,45.37A8,8,0,0,0,16,224H92a60,60,0,0,0,57.37-77.57C182.3,121.31,232,76.08,232,32ZM92,208H34.63C41.38,198.41,48,183.92,48,164a44,44,0,1,1,44,44Zm32.42-94.45q5.14-6.66,10.09-12.55A76.23,76.23,0,0,1,155,121.49q-5.9,4.94-12.55,10.09A60.54,60.54,0,0,0,124.42,113.55Zm42.7-2.68a92.57,92.57,0,0,0-22-22c31.78-34.53,55.75-45,69.9-47.91C212.17,55.12,201.65,79.09,167.12,110.87Z"},null,-1),We=[Le],ze={key:5},Ve=w("path",{d:"M224,28c-20.29,0-43.16,11.24-68,33.4-18.47,16.49-34.39,35.83-45,49.93A56,56,0,0,0,36,164c0,33.22-21.26,48-22.22,48.68A4,4,0,0,0,16,220H92a56,56,0,0,0,52.67-75c14.11-10.63,33.44-26.55,49.93-45C216.76,75.16,228,52.29,228,32A4,4,0,0,0,224,28ZM92,212H26.35C33.91,203.69,44,188.08,44,164a48,48,0,1,1,48,48Zm26.52-97.31c4.13-5.44,9.32-12,15.29-18.9a80.08,80.08,0,0,1,26.4,26.4c-6.94,6-13.46,11.16-18.9,15.29A56.32,56.32,0,0,0,118.52,114.69Zm47.77,2.14a88.17,88.17,0,0,0-27.12-27.12C161,65.43,191.26,38.63,219.82,36.18,217.37,64.74,190.57,95,166.29,116.83Z"},null,-1),Fe=[Ve],Ke={name:"PhPaintBrush"},Tr=_e({...Ke,props:{weight:{type:String},size:{type:[String,Number]},color:{type:String},mirrored:{type:Boolean}},setup(e){const m=e,u=ne("weight","regular"),l=ne("size","1em"),S=ne("color","currentColor"),I=ne("mirrored",!1),A=y(()=>m.weight??u),M=y(()=>m.size??l),C=y(()=>m.color??S),d=y(()=>m.mirrored!==void 0?m.mirrored?"scale(-1, 1)":void 0:I?"scale(-1, 1)":void 0);return(g,h)=>(D(),N("svg",Se({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256",width:M.value,height:M.value,fill:C.value,transform:d.value},g.$attrs),[ye(g.$slots,"default"),A.value==="bold"?(D(),N("g",ke,qe)):A.value==="duotone"?(D(),N("g",xe,He)):A.value==="fill"?(D(),N("g",Pe,Ue)):A.value==="light"?(D(),N("g",Oe,Ze)):A.value==="regular"?(D(),N("g",je,We)):A.value==="thin"?(D(),N("g",ze,Fe)):ie("",!0)],16,Me))}}),oe=he("room",()=>{const e=T(null),m=T([]),u=T(!1),l=T(null),S=y(()=>{const r=re();return e.value?.host_id===r.user?.id});async function I(r){try{u.value=!0,l.value=null;const t=re();if(!t.user)throw new Error("請先登入");if(!t.profile&&t.user)try{await t.loadUserProfile(t.user.id,!1)}catch(n){console.warn("載入用戶資料時發生錯誤（非關鍵）:",n)}if(r.words.length<6)throw new Error("至少需要 6 個詞語");let a=null,_=0;const R=10;for(;_<R&&!a;){_++;const E={code:Math.floor(1e5+Math.random()*9e5).toString(),name:r.name,host_id:t.user.id,words:r.words,word_count:r.words.length,status:"waiting",settings:r.settings,current_round:0,current_drawer_id:null},{data:P,error:x}=await p.from("game_rooms").insert(E).select().single();if(x){if(x.code==="23505")continue;throw new Error(x.message||"插入房間失敗")}if(P){a=P;break}}if(!a)throw new Error("無法生成唯一房間碼，請重試");const k={room_id:a.id,user_id:t.user.id,nickname:t.profile?.display_name||"房主",score:0};try{const{error:n}=await p.from("room_participants").insert(k);n&&console.error("創建參與記錄錯誤:",n)}catch(n){console.error("創建參與記錄時發生錯誤:",n)}try{const{data:n,error:E}=await p.from("room_participants").select("*").eq("room_id",a.id).order("joined_at",{ascending:!0});E?console.error("載入參與者列表失敗:",E):n&&(m.value=n)}catch(n){console.error("載入參與者列表時發生錯誤:",n)}return e.value=a,{success:!0,room:a}}catch(t){return l.value=t instanceof Error?t.message:"創建房間失敗",console.error("創建房間錯誤:",t),{success:!1,error:l.value}}finally{u.value=!1}}async function A(r,t){try{u.value=!0,l.value=null;const a=re();if(!a.user)throw new Error("請先登入");if(!/^\d{6}$/.test(r))throw new Error("房間碼必須是 6 位數字");if(!t||t.trim().length===0)throw new Error("請輸入暱稱");if(t.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:_,error:R}=await p.from("game_rooms").select("*").eq("code",r).single();if(R||!_)throw new Error("房間不存在");if(_.status!=="waiting")throw new Error("房間已開始或已結束");const{data:k}=await p.from("room_participants").select("*").eq("room_id",_.id).eq("user_id",a.user.id).maybeSingle();if(k)return e.value=_,await C(_.id),{success:!0,room:_};const{error:n}=await p.from("room_participants").insert({room_id:_.id,user_id:a.user.id,nickname:t.trim(),score:0});if(n){if(n.code==="23505"||n.message.includes("duplicate"))return e.value=_,await C(_.id),{success:!0,room:_};throw n}return e.value=_,await C(_.id),{success:!0,room:_}}catch(a){return l.value=a instanceof Error?a.message:"加入房間失敗",console.error("加入房間錯誤:",a),{success:!1,error:l.value}}finally{u.value=!1}}async function M(){try{if(!e.value)return{success:!0};u.value=!0,l.value=null;const r=re();if(!r.user)throw new Error("請先登入");const{error:t}=await p.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",r.user.id);if(t)throw new Error(`刪除參與記錄失敗: ${t.message||"未知錯誤"}`);if(S.value){const{error:a}=await p.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);a&&console.error("關閉房間失敗:",a)}return e.value=null,m.value=[],{success:!0}}catch(r){return l.value=r instanceof Error?r.message:"離開房間失敗",console.error("離開房間錯誤:",r),e.value=null,m.value=[],{success:!1,error:l.value}}finally{u.value=!1}}async function C(r){try{const{data:t,error:a}=await p.from("room_participants").select("*").eq("room_id",r).order("joined_at",{ascending:!0});if(a)throw a;m.value=t||[]}catch(t){console.error("載入參與者錯誤:",t)}}async function d(r){try{u.value=!0,l.value=null;const{data:t,error:a}=await p.from("game_rooms").select("*").eq("id",r).single();if(a)throw a;return e.value=t,await C(r),{success:!0,room:t}}catch(t){return l.value=t instanceof Error?t.message:"載入房間失敗",console.error("載入房間錯誤:",t),{success:!1,error:l.value}}finally{u.value=!1}}async function g(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:r});const{error:t}=await p.from("game_rooms").update({status:r}).eq("id",e.value.id);if(t)throw t;if(r==="finished"&&e.value&&await h(),e.value){const a=e.value.status;e.value.status=r,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:a,newStatus:e.value.status})}return{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",t),{success:!1,error:l.value}}}async function h(){if(e.value)try{console.log("[RoomStore] 開始累積積分到用戶賬戶");const{data:r,error:t}=await p.from("room_participants").select("user_id, score").eq("room_id",e.value.id);if(t){console.error("獲取參與者錯誤:",t);return}if(!r||r.length===0){console.log("[RoomStore] 沒有參與者需要累積積分");return}const a=r.map(n=>n.user_id),{data:_,error:R}=await p.from("users").select("id, user_type").in("id",a);if(R){console.error("獲取用戶信息錯誤:",R);return}const k=new Set(_?.filter(n=>n.user_type==="registered").map(n=>n.id)||[]);for(const n of r){if(!k.has(n.user_id)){console.log(`[RoomStore] 跳過匿名用戶 ${n.user_id} 的積分累積`);continue}if(n.score>0){const{error:E}=await p.rpc("accumulate_user_score",{user_id_param:n.user_id,score_to_add:n.score});if(E){console.warn("[RoomStore] RPC 函數不存在，使用傳統方式累積積分:",E);const{data:P,error:x}=await p.from("users").select("total_score").eq("id",n.user_id).single();if(x){console.error(`[RoomStore] 獲取用戶 ${n.user_id} 總積分錯誤:`,x);continue}const j=(P?.total_score||0)+n.score,{error:V}=await p.from("users").update({total_score:j}).eq("id",n.user_id);V?console.error(`[RoomStore] 更新用戶 ${n.user_id} 總積分錯誤:`,V):console.log(`[RoomStore] 用戶 ${n.user_id} 積分已累積: +${n.score} (總積分: ${j})`)}else console.log(`[RoomStore] 用戶 ${n.user_id} 積分已累積: +${n.score}`)}}}catch(r){console.error("[RoomStore] 累積積分錯誤:",r)}}async function b(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:r});const{error:t}=await p.from("game_rooms").update({current_drawer_id:r}).eq("id",e.value.id);if(t)throw t;return e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 當前畫家已更新:",r)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新畫家失敗",console.error("更新畫家錯誤:",t),{success:!1,error:l.value}}}async function q(r){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間設置:",{roomId:e.value.id,settings:r});const t={...e.value.settings,...r},{error:a}=await p.from("game_rooms").update({settings:t}).eq("id",e.value.id);if(a)throw a;return e.value&&(e.value.settings=t,console.log("[RoomStore] 房間設置已更新:",t)),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"更新房間設置失敗",console.error("更新房間設置錯誤:",t),{success:!1,error:l.value}}}function H(){e.value=null,m.value=[],l.value=null}function c(r){e.value&&(e.value.current_drawer_id=r,console.log("[RoomStore] 本地更新當前畫家:",r))}async function i(r){try{if(!e.value)return{success:!1,error:"沒有當前房間"};if(!S.value)return{success:!1,error:"只有房主可以踢人"};const t=re();if(r===t.user?.id)return{success:!1,error:"不能踢出自己"};u.value=!0,l.value=null;const{data:a,error:_}=await p.rpc("kick_player",{p_room_id:e.value.id,p_target_user_id:r});if(_)throw new Error(_.message);if(a&&!a.success)throw new Error(a.error||"踢出玩家失敗");return await C(e.value.id),{success:!0}}catch(t){return l.value=t instanceof Error?t.message:"踢出玩家失敗",console.error("踢出玩家錯誤:",t),{success:!1,error:l.value}}finally{u.value=!1}}return{currentRoom:e,participants:m,loading:u,error:l,isHost:S,createRoom:I,joinRoom:A,leaveRoom:M,kickPlayer:i,loadParticipants:C,loadRoom:d,updateRoomStatus:g,updateRoomDrawer:b,updateRoomSettings:q,setCurrentDrawer:c,clearRoom:H}});function Je(){const e=oe(),m=y(()=>e.currentRoom),u=y(()=>e.participants),l=y(()=>e.isHost),S=y(()=>!m.value||m.value.status!=="waiting"||!l.value?!1:u.value.length>=2);async function I(C){return await e.createRoom(C)}async function A(C,d){return await e.joinRoom(C,d)}async function M(){return await e.leaveRoom()}return{currentRoom:m,participants:u,isHost:l,canStartGame:S,loading:y(()=>e.loading),error:y(()=>e.error),createRoom:I,joinRoom:A,leaveRoom:M}}const de=100,fe=50,me=10,Ye=10,ge=100,we=[1,.8,.6,.4,.2];function Qe(){const e=oe();function m(d){const g=Math.min(d,we.length-1),h=we[g]??0;return Math.round(de*h)}function u(d,g=0){if(d===0)return 0;const h=d*me,b=Math.round(g*Ye);return fe+h+b}async function l(d,g,h=0){const b=u(g,h);return b===0?!0:await S(d,b)}async function S(d,g){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:h,error:b}=await p.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",d).single();if(b)throw b;const q=(h?.score||0)+g,{error:H}=await p.from("room_participants").update({score:q}).eq("room_id",e.currentRoom.id).eq("user_id",d);if(H)throw H;const c=e.participants.findIndex(i=>i.user_id===d);return c!==-1&&e.participants[c]&&(e.participants[c].score=q),!0}catch(h){return console.error("更新玩家分數錯誤:",h),!1}}function I(){if(!e.participants||e.participants.length===0)return null;const d=[...e.participants].sort((g,h)=>h.score-g.score);return d.length===1||d[0]&&d[1]&&d[0].score>d[1].score?{user_id:d[0]?.user_id||"",score:d[0]?.score||0}:{user_id:d[0]?.user_id||"",score:d[0]?.score||0}}const A=y(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((g,h)=>h.score!==g.score?h.score-g.score:new Date(g.joined_at).getTime()-new Date(h.joined_at).getTime()).map((g,h)=>({id:g.id,user_id:g.user_id,score:g.score,rank:h+1}))),M=y(()=>e.currentRoom?.status!=="finished"?null:I());function C(){return ge}return{GUESS_BASE_SCORE:de,DRAWING_BASE_SCORE:fe,DRAWING_BONUS_PER_GUESS:me,WINNER_BONUS:ge,calculateGuessScore:m,calculateDrawingScore:u,calculateWinner:I,updatePlayerScore:S,updateDrawerScore:l,playerRankings:A,winner:M,getWinnerBonus:C}}const pe=he("game",()=>{const e=oe(),m=re(),u=T(null),l=T(null),S=T([]),I=y(()=>S.value.filter(o=>o.is_correct)),A=y(()=>u.value?S.value.filter(o=>o.round_id===u.value.id):[]),M=y(()=>A.value.filter(o=>o.is_correct)),C=T("drawing"),d=T([]),g=T([]),h=T(!1),b=T([]),q=y(()=>g.value.length===0?0:g.value.reduce((s,f)=>s+f.rating,0)/g.value.length);function H(o){C.value=o}function c(o){d.value=o}function i(o){const s=g.value.findIndex(f=>f.rater_id===o.rater_id);s>=0?g.value[s]=o:g.value.push(o)}function r(){g.value=[]}function t(){if(h.value||!l.value)return null;const o=l.value.length,s=[];for(let G=0;G<o;G++)b.value.includes(G)||s.push(G);if(s.length===0)return null;const f=Math.floor(Math.random()*s.length),v=s[f];return v===void 0?null:(b.value.push(v),h.value=!0,v)}function a(o,s){h.value=o,b.value=s}function _(){h.value=!1,b.value=[]}async function R(o){try{const{data:s,error:f}=await p.from("game_rounds").select("*").eq("room_id",o).order("round_number",{ascending:!1}).limit(1).maybeSingle();if(f)throw f;return s&&(u.value=s,l.value=s.word_text,s.word_options&&Array.isArray(s.word_options)&&(d.value=s.word_options),await k(s.id)),{success:!0,round:s}}catch(s){return console.error("載入當前輪次錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入輪次失敗"}}}async function k(o){try{const{data:s,error:f}=await p.from("guesses").select("*").eq("round_id",o).order("guessed_at",{ascending:!0});if(f)throw f;const v=s||[],G=new Set(S.value.map(B=>B.id)),$=v.filter(B=>!G.has(B.id));$.length>0&&(S.value=[...S.value,...$])}catch(s){console.error("載入猜測記錄錯誤:",s)}}async function n(o){try{const{data:s,error:f}=await p.from("game_rounds").select("id").eq("room_id",o);if(f)throw f;if(!s||s.length===0){S.value=[];return}const v=s.map(B=>B.id),{data:G,error:$}=await p.from("guesses").select("*").in("round_id",v).order("guessed_at",{ascending:!0});if($)throw $;S.value=G||[]}catch(s){console.error("載入所有猜測記錄錯誤:",s)}}async function E(o,s,f,v){try{if(!e.currentRoom)throw new Error("沒有當前房間");const G=(e.currentRoom.current_round||0)+1,{data:$,error:B}=await p.from("game_rounds").insert({room_id:o,round_number:G,drawer_id:s,word_text:f,word_source:v}).select().single();if(B)throw B;return u.value=$,l.value=f,await p.from("game_rooms").update({current_round:G,current_drawer_id:s}).eq("id",o),{success:!0,round:$}}catch(G){return console.error("創建輪次錯誤:",G),{success:!1,error:G instanceof Error?G.message:"創建輪次失敗"}}}function P(o){return u.value?S.value.some(s=>s.round_id===u.value.id&&s.user_id===o&&s.is_correct):!1}const x=y(()=>!u.value||!m.user?!1:u.value.drawer_id===m.user.id);async function j(){if(!u.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const o=I.value.length,s=q.value,{updateDrawerScore:f}=Qe();console.log("[endRound] 猜中人數:",o,"平均評分:",s),await f(u.value.drawer_id,o,s);const{error:v}=await p.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",u.value.id);if(v)throw v;return{success:!0}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}function V(){u.value=null,l.value=null,S.value=[],C.value="drawing",d.value=[],g.value=[],h.value=!1,b.value=[]}async function O(o,s,f){if(!m.user)return{success:!1,error:"用戶未登錄"};try{const{data:v,error:G}=await p.from("drawing_ratings").upsert({round_id:o,rater_id:m.user.id,drawer_id:s,rating:f},{onConflict:"round_id,rater_id"}).select().single();if(G)throw G;return v&&i(v),{success:!0,rating:v}}catch(v){return console.error("提交評分錯誤:",v),{success:!1,error:v instanceof Error?v.message:"提交評分失敗"}}}async function te(o){try{const{data:s,error:f}=await p.from("drawing_ratings").select("*").eq("round_id",o);if(f)throw f;return g.value=s||[],{success:!0,ratings:s}}catch(s){return console.error("載入評分錯誤:",s),{success:!1,error:s instanceof Error?s.message:"載入評分失敗"}}}return{currentRound:u,currentWord:l,guesses:S,correctGuesses:I,currentRoundGuesses:A,currentRoundCorrectGuesses:M,isCurrentDrawer:x,roundStatus:C,wordOptions:d,ratings:g,averageRating:q,hintGiven:h,revealedIndices:b,loadCurrentRound:R,loadGuesses:k,loadAllGuesses:n,createRound:E,hasGuessed:P,endRound:j,clearGame:V,setRoundStatus:H,setWordOptions:c,addRating:i,clearRatings:r,submitRating:O,loadRatings:te,giveHint:t,setHintState:a,resetHint:_}}),W=new Map,z=T("disconnected"),F=new Map,se=new Set,ae=new Map;function K(...e){}function Z(...e){console.warn("[Realtime]",...e)}function ue(){const e=oe(),m=pe();function u(c){const i=`room:${c}`;if(W.has(i))return W.get(i);const r=p.channel(i,{config:{presence:{key:"user"},broadcast:{self:!0}}});return W.set(i,r),r}function l(c){const i=ae.get(c);i&&(clearTimeout(i),ae.delete(c))}function S(c,i,r,t,a){c==="SUBSCRIBED"?(z.value="connected",l(r),i.track({user_id:t,...a}).catch(_=>{Z("Presence track 失敗:",_)})):c==="CHANNEL_ERROR"||c==="TIMED_OUT"?(z.value="disconnected",Z("訂閱失敗:",c),I(r,t,a)):c==="CLOSED"&&(z.value="disconnected")}function I(c,i,r,t=0){if(t>=3){Z("重連失敗次數過多，停止重連");return}l(c);const a=Math.min(1e3*Math.pow(2,t),1e4),_=window.setTimeout(()=>{const R=W.get(`room:${c}`);R&&R.state!=="joined"&&R.subscribe(k=>{k==="SUBSCRIBED"?S(k,R,c,i,r):(k==="CHANNEL_ERROR"||k==="TIMED_OUT")&&I(c,i,r,t+1)})},a);ae.set(c,_)}function A(c,i,r,t){return new Promise((a,_)=>{if(!c||!i){Z("缺少 roomCode 或 roomId"),_(new Error("缺少 roomCode 或 roomId"));return}const R=u(c),k=R.state;if(k==="joined"){z.value="connected",a(R);return}if(k==="joining"){const n=setInterval(()=>{const E=R.state;E==="joined"?(clearInterval(n),a(R)):(E==="closed"||E==="errored")&&(clearInterval(n),_(new Error("連接失敗")))},100);setTimeout(()=>{clearInterval(n),R.state!=="joined"&&_(new Error("連接超時"))},5e3);return}if(se.has(c)){z.value="connecting",R.subscribe(n=>{S(n,R,c,r,t),n==="SUBSCRIBED"?a(R):(n==="CHANNEL_ERROR"||n==="TIMED_OUT")&&_(new Error(`訂閱失敗: ${n}`))});return}R.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${i}`},async n=>{K("房間狀態變化:",n.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${i}`},async n=>{K("參與者變化:",n.eventType),await e.loadParticipants(i)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${i}`},async n=>{K("輪次變化:",n.eventType,n.new),e.currentRoom&&await m.loadCurrentRound(e.currentRoom.id)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses"},async n=>{const E=n.new;if(E&&m.currentRound&&(await m.loadGuesses(E.round_id),E.is_correct&&e.isHost&&m.roundStatus==="drawing")){const P=m.currentRound.drawer_id,x=e.participants.filter(O=>O.user_id!==P),j=new Set(m.currentRoundCorrectGuesses.map(O=>O.user_id));if(x.length>0&&x.every(O=>j.has(O.user_id))){const{useGame:O}=await Ee(async()=>{const{useGame:o}=await Promise.resolve().then(()=>Xe);return{useGame:o}},void 0),{endRound:te}=O();await te()}}}).on("broadcast",{event:"drawing"},n=>{console.log("[Realtime] 收到 drawing 廣播:",JSON.stringify(n));const E=F.get(c);E&&n.payload?.stroke?(console.log("[Realtime] 分發給",E.size,"個回調"),E.forEach(P=>P(n.payload.stroke))):console.log("[Realtime] 沒有回調或 stroke 為空, callbacks:",E?.size,"stroke:",n.payload?.stroke)}).on("presence",{event:"sync"},()=>{const n=R.presenceState();K("Presence 同步，在線:",Object.keys(n).length)}),se.add(c),z.value="connecting",R.subscribe(n=>{S(n,R,c,r,t),n==="SUBSCRIBED"?a(R):(n==="CHANNEL_ERROR"||n==="TIMED_OUT")&&_(new Error(`訂閱失敗: ${n}`))})})}function M(c,i){return F.has(c)||F.set(c,new Set),F.get(c).add(i),()=>{F.get(c)?.delete(i)}}function C(c,i){const r=u(c),t=`guesses:${i}`;return r[t]||(r.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${i}`},async a=>{K("收到新猜測記錄:",a.eventType,a.new),await m.loadGuesses(i)}),r[t]=!0),r}function d(c,i){const r=u(c),t=`gameState:${c}`;return r[t]||(r.on("broadcast",{event:"game_state"},a=>{K("收到遊戲狀態廣播:",a.payload),i(a.payload)}),r[t]=!0),r}async function g(c,i){const r=u(c),t=r.state;if(t!=="joined")return Z("Channel 未連接，狀態:",t,"- 狀態將通過數據庫同步"),{warning:"Channel 未連接"};try{K("廣播遊戲狀態:",i);const a=await r.send({type:"broadcast",event:"game_state",payload:i});return a==="error"?(Z("發送遊戲狀態失敗"),{error:"發送失敗"}):a}catch(a){return Z("發送遊戲狀態錯誤:",a),{error:a instanceof Error?a.message:"發送失敗"}}}async function h(c,i){const r=u(c),t=r.state;if(t!=="joined")return Z("Channel 未連接，無法發送繪畫數據，狀態:",t),{error:"Channel 未連接"};try{const a=await r.send({type:"broadcast",event:"drawing",payload:{stroke:i}});return a==="error"?(Z("發送失敗"),{error:"發送失敗"}):a}catch(a){return Z("發送錯誤:",a),{error:a instanceof Error?a.message:"發送失敗"}}}function b(c){const i=`room:${c}`,r=W.get(i);l(c),r&&(p.removeChannel(r),W.delete(i)),F.delete(c),se.delete(c)}function q(){ae.forEach((c,i)=>l(i)),W.forEach(c=>p.removeChannel(c)),W.clear(),F.clear(),se.clear()}function H(){return z.value}return{connectionStatus:z,subscribeRoom:A,subscribeDrawing:M,subscribeGuesses:C,subscribeGameState:d,sendDrawing:h,broadcastGameState:g,unsubscribeRoom:b,unsubscribeAll:q,getConnectionStatus:H}}const ve=6,Q=T(null),le=T(!1);let X=null;const J=T(null);let ee=null;const ce=T(new Set);function Re(){const e=oe(),m=pe();ue();const u=Q,l=le,S=J,I=y(()=>e.currentRoom?.status||"waiting"),A=y(()=>I.value==="playing"),M=y(()=>I.value==="waiting"),C=y(()=>I.value==="finished"),d=y(()=>m.roundStatus),g=y(()=>d.value==="drawing"),h=y(()=>d.value==="summary"),b=y(()=>m.currentRound),q=y(()=>e.currentRoom?.current_round||0),H=y(()=>e.currentRoom?.settings.rounds||0),c=y(()=>e.currentRoom?.settings.draw_time||60),i=y(()=>m.isCurrentDrawer);function r(o){console.log("[useGame] startCountdown 開始，時長:",o,"秒"),X&&clearInterval(X),Q.value=o,le.value=!0,X=window.setInterval(()=>{Q.value!==null&&Q.value>0?Q.value--:(t(),A.value&&b.value&&e.isHost&&(console.log("[useGame] 倒計時結束，房主執行 endRound"),x()))},1e3)}function t(){X&&(clearInterval(X),X=null),le.value=!1}function a(){t(),Q.value=null}function _(){console.log("[useGame] startSummaryCountdown 開始"),ee&&clearInterval(ee),J.value=ve,console.log("[useGame] 開始總結倒計時:",ve,"秒"),ee=window.setInterval(async()=>{J.value!==null&&J.value>0?(J.value--,console.log("[useGame] 總結倒計時:",J.value)):(R(),console.log("[useGame] 總結倒計時結束, isHost:",e.isHost),e.isHost&&(console.log("[useGame] 房主執行 continueToNextRound"),await j()))},1e3)}function R(){console.log("[useGame] stopSummaryCountdown"),ee&&(clearInterval(ee),ee=null),J.value=null}function k(){if(!e.currentRoom)return null;const o=e.currentRoom.words;if(o.length===0)return null;const s=[];for(let v=0;v<o.length;v++)ce.value.has(v)||s.push(v);let f=0;if(s.length>0){const v=Math.floor(Math.random()*s.length);f=s[v]??0}else console.log("[useGame] 所有詞語都用過了，重置並重新選擇"),ce.value.clear(),f=Math.floor(Math.random()*o.length);return ce.value.add(f),o[f]??null}async function n(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{ce.value.clear();const o=e.participants.length,s=await e.updateRoomSettings({rounds:o});if(!s.success)return s;console.log("[useGame] 輪數已自動設定為房間人數:",o);const f=await e.updateRoomStatus("playing");return f.success?await E():f}catch(o){return console.error("開始遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"開始遊戲失敗"}}}async function E(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以發起新輪次"};const s=(e.currentRoom.current_round||0)+1;try{const f=(s-1)%e.participants.length,v=e.participants[f];if(console.log("[startDrawingPhase] 第",s,"輪，畫家:",v?.nickname),!v)throw new Error("無法選擇畫家");const G=k();if(!G)throw new Error("沒有可用的詞語");console.log("[startDrawingPhase] 分配詞語:",G.text),await e.updateRoomDrawer(v.user_id);const $=await m.createRound(e.currentRoom.id,v.user_id,G.text,G.source);if(!$.success||!$.round)throw new Error("創建輪次失敗");const{broadcastGameState:B}=ue();return await B(e.currentRoom.code,{roundStatus:"drawing",wordOptions:[],drawerId:v.user_id,drawerName:v.nickname,roundNumber:s,startedAt:$.round.started_at}),{success:!0,drawerId:v.user_id,word:G.text}}catch(f){return console.error("開始繪畫階段錯誤:",f),{success:!1,error:f instanceof Error?f.message:"開始繪畫階段失敗"}}}async function P(){return await E()}async function x(){if(!b.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{const o=await m.endRound();if(!o.success)return o;const s=!1,{broadcastGameState:f}=ue();return await f(e.currentRoom.code,{roundStatus:"summary",wordOptions:[],drawerId:e.currentRoom.current_drawer_id??void 0,isLastRound:s}),{success:!0,gameEnded:s}}catch(o){return console.error("結束輪次錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束輪次失敗"}}}async function j(){return e.currentRoom?e.isHost?(await E(),{success:!0,gameEnded:!1}):{success:!1,error:"只有房主可以發起下一輪"}:{success:!1,error:"沒有當前房間"}}async function V(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return t(),await e.updateRoomStatus("finished"),{success:!0}}catch(o){return console.error("結束遊戲錯誤:",o),{success:!1,error:o instanceof Error?o.message:"結束遊戲失敗"}}}async function O(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(!e.isHost)return{success:!1,error:"只有房主可以開始下一局"};if(e.currentRoom.status!=="playing")return{success:!1,error:"房間狀態不正確"};if(d.value!=="summary")return{success:!1,error:"只能在總結階段開始下一局"};try{return console.log("[useGame] 開始下一局，直接進入下一輪繪畫"),R(),await E()}catch(o){return console.error("下一局錯誤:",o),{success:!1,error:o instanceof Error?o.message:"下一局失敗"}}}const te=y(()=>{if(u.value===null)return"--:--";const o=Math.floor(u.value/60),s=u.value%60;return`${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`});return be(()=>{t(),R()}),{gameStatus:I,isPlaying:A,isWaiting:M,isFinished:C,currentRound:b,currentRoundNumber:q,totalRounds:H,drawTime:c,isCurrentDrawer:i,timeRemaining:u,isCountingDown:l,formattedTime:te,roundStatus:d,isDrawing:g,isSummary:h,summaryTimeRemaining:S,startGame:n,newGame:O,startNextRound:P,startDrawingPhase:E,endRound:x,continueToNextRound:j,endGame:V,startCountdown:r,stopCountdown:t,startSummaryCountdown:_,stopSummaryCountdown:R,resetCountdown:a}}const Xe=Object.freeze(Object.defineProperty({__proto__:null,useGame:Re},Symbol.toStringTag,{value:"Module"})),er={class:"waiting-lobby"},rr={class:"card"},tr={class:"card-body"},or={class:"room-info text-center margin-bottom-medium"},nr={class:"card-title text-hand-title"},sr={class:"room-details"},ar={class:"detail-item margin-bottom-small"},cr={class:"badge badge-secondary room-code-badge"},ir={class:"detail-item"},ur={class:"badge"},lr={class:"players-section margin-bottom-medium"},dr={class:"text-hand-title margin-bottom-small"},fr={class:"players-list"},mr={class:"player-avatar"},gr={class:"player-info"},wr={class:"player-name"},vr={key:0,class:"badge badge-warning"},_r={class:"room-settings margin-bottom-medium"},hr={class:"setting-item"},pr={class:"setting-value"},Rr={class:"setting-item"},yr={class:"setting-value"},Sr={class:"setting-item"},Er={class:"setting-value"},br={class:"lobby-actions"},Cr=["disabled"],Gr={key:1,class:"alert alert-warning text-center"},Ar=["disabled"],Ir={key:0,class:"alert alert-danger margin-top-small"},Mr=_e({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:m}){const u=e,l=m,{isHost:S,canStartGame:I,leaveRoom:A,loading:M,error:C}=Je(),{startGame:d}=Re(),g=y(()=>{const c=u.room?.settings.rounds||0,i=u.participants.length,r=c>0?c:i;return r>0?r:1});function h(c){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[c||""]||c||"未知"}function b(c){return u.room?.host_id===c}async function q(){(await d()).success&&l("startGame")}async function H(){(await A()).success&&l("leaveRoom")}return(c,i)=>(D(),N("div",er,[w("div",rr,[w("div",tr,[w("div",or,[w("h2",nr,U(e.room?.name),1),w("div",sr,[w("div",ar,[i[0]||(i[0]=Y(" 房間碼：",-1)),w("span",cr,U(e.room?.code),1)]),w("div",ir,[i[1]||(i[1]=Y(" 狀態：",-1)),w("span",ur,U(h(e.room?.status)),1)])])]),w("div",lr,[w("h4",dr,"玩家列表 ("+U(e.participants.length)+")",1),w("div",fr,[(D(!0),N(Ce,null,Ge(e.participants,r=>(D(),N("div",{key:r.id,class:Ae(["player-item",{"is-host":b(r.user_id)}])},[w("div",mr,U(r.nickname.charAt(0).toUpperCase()),1),w("div",gr,[w("div",wr,[Y(U(r.nickname)+" ",1),b(r.user_id)?(D(),N("span",vr," 房主 ")):ie("",!0)])])],2))),128))])]),w("div",_r,[w("div",hr,[i[3]||(i[3]=w("span",{class:"setting-label"},"繪畫時間：",-1)),w("span",pr,[w("strong",null,U(e.room?.settings.draw_time),1),i[2]||(i[2]=Y("秒",-1))])]),w("div",Rr,[i[5]||(i[5]=w("span",{class:"setting-label"},"每局輪數：",-1)),w("span",yr,[w("strong",null,U(g.value),1),i[4]||(i[4]=Y("輪",-1))])]),w("div",Sr,[i[7]||(i[7]=w("span",{class:"setting-label"},"詞語總數：",-1)),w("span",Er,[w("strong",null,U(e.room?.word_count),1),i[6]||(i[6]=Y("個",-1))])])]),w("div",br,[L(S)&&L(I)?(D(),N("button",{key:0,disabled:L(M),class:"paper-btn btn-primary btn-block margin-bottom-small",onClick:q},U(L(M)?"開始中":"開始遊戲"),9,Cr)):L(S)?(D(),N("div",Gr," 至少需要 2 個玩家才能開始遊戲 ")):ie("",!0),w("button",{disabled:L(M),class:"paper-btn btn-secondary btn-block",onClick:H},U(L(M)?"離開中":"離開房間"),9,Ar)]),L(C)?(D(),N("div",Ir,U(L(C)),1)):ie("",!0)])])]))}}),qr=Ie(Mr,[["__scopeId","data-v-e80d1c96"]]);export{Tr as I,qr as W,ue as a,oe as b,pe as c,Qe as d,Re as e,Je as u};
