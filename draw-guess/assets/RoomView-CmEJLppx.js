import{l as Ve,r as I,u as z,f as G,d as Y,i as ae,m as ie,c,e,o as u,_ as X,n as E,a as M,F as B,p as A,q as re,t as _,b as r,s as K,h as j,x as J,y as Ee,j as P,g as Le,v as Ne,z as Be,A as Pe,k as Ae,B as He}from"./index-DSqarXUE.js";import{b as Q,a as le,c as ce,d as Re,e as we,u as Oe,W as ze}from"./WaitingLobby-B5hYm543.js";const be=Ve("drawing",()=>{const t=I("pen"),a=I("#000000"),d=I(3),v=I(!1),s=I([]);function i(R){t.value=R}function p(R){a.value=R}function g(R){d.value=Math.max(1,Math.min(20,R))}function y(R){s.value.push(R)}function k(){s.value=[]}function D(R){v.value=R}return{tool:t,color:a,lineWidth:d,isDrawing:v,strokes:s,setTool:i,setColor:p,setLineWidth:g,addStroke:y,clearStrokes:k,setDrawing:D}});function fe(t,a){const d=t.getBoundingClientRect();let v,s;if(a instanceof MouseEvent)v=a.clientX,s=a.clientY;else if(a instanceof TouchEvent&&a.touches.length>0&&a.touches[0])v=a.touches[0].clientX,s=a.touches[0].clientY;else return null;return{x:v-d.left,y:s-d.top}}function Ce(t,a){if(!(a.points.length<2)){t.save(),a.tool==="pen"?(t.strokeStyle=a.color,t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"):a.tool==="eraser"&&(t.globalCompositeOperation="destination-out",t.lineWidth=a.lineWidth,t.lineCap="round",t.lineJoin="round"),t.beginPath(),a.points[0]&&t.moveTo(a.points[0].x,a.points[0].y);for(let d=1;d<a.points.length;d++){const v=a.points[d];v&&t.lineTo(v.x,v.y)}t.stroke(),t.restore()}}function oe(t,a){const d=t.getContext("2d");if(!d)return;const v=t.getBoundingClientRect();d.clearRect(0,0,t.width,t.height),d.fillStyle="#FFFFFF",d.fillRect(0,0,v.width,v.height),a.forEach(s=>{Ce(d,s)})}function Ue(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ke(){const t=be(),a=Q(),d=z(),{sendDrawing:v}=le(),s=G(()=>!d.user||!a.currentRoom?!1:a.currentRoom.current_drawer_id===d.user.id),i=I(null),p=I(null),g=I(null),y=I(null);let k=null;const D=50;function R(h){i.value=h;const W=h.getContext("2d",{willReadFrequently:!0});if(!W){console.error("ç„¡æ³•ç²å– Canvas ä¸Šä¸‹æ–‡");return}p.value=W;const S=window.devicePixelRatio||1,H=h.getBoundingClientRect();h.width=H.width*S,h.height=H.height*S,W.scale(S,S),W.fillStyle="#FFFFFF",W.fillRect(0,0,H.width,H.height),i.value&&oe(i.value,t.strokes),new ResizeObserver(()=>{if(!i.value||!p.value)return;const N=i.value.getBoundingClientRect(),O=window.devicePixelRatio||1;i.value.width=N.width*O,i.value.height=N.height*O,p.value.scale(O,O),p.value.fillStyle="#FFFFFF",p.value.fillRect(0,0,N.width,N.height),oe(i.value,t.strokes)}).observe(h)}function x(h){if(!i.value)return;if(!s.value){console.log("[useDrawing] éç•«å®¶ä¸èƒ½ç¹ªç•«");return}h.preventDefault(),t.setDrawing(!0);const W=fe(i.value,h);W&&(g.value={id:Ue(),tool:t.tool,color:t.color,lineWidth:t.lineWidth,points:[W],timestamp:Date.now()},y.value=W)}function b(h){if(!i.value||!p.value||!t.isDrawing||!g.value)return;h.preventDefault();const W=fe(i.value,h);if(!W||!y.value)return;const S=p.value;S.save(),g.value.tool==="pen"?(S.strokeStyle=g.value.color,S.lineWidth=g.value.lineWidth,S.lineCap="round",S.lineJoin="round"):g.value.tool==="eraser"&&(S.globalCompositeOperation="destination-out",S.lineWidth=g.value.lineWidth,S.lineCap="round",S.lineJoin="round"),S.beginPath(),S.moveTo(y.value.x,y.value.y),S.lineTo(W.x,W.y),S.stroke(),S.restore(),g.value.points.push(W),y.value=W,k===null&&(k=window.setTimeout(()=>{w(),k=null},D))}function C(){!t.isDrawing||!g.value||(t.setDrawing(!1),k&&(clearTimeout(k),k=null),w(),g.value=null,y.value=null)}async function w(){if(!(!g.value||!a.currentRoom||!d.user))try{const h={...g.value,userId:d.user.id};console.log("[sendStrokeData] ç™¼é€ç­†è§¸æ•¸æ“š:",h.id),await v(a.currentRoom.code,h)}catch(h){console.error("[sendStrokeData] ç™¼é€ç¹ªç•«æ•¸æ“šå¤±æ•—:",h)}}function o(h){if(!(!i.value||!p.value)){if(h.userId&&d.user&&h.userId===d.user.id){console.log("[handleDrawingData] å¿½ç•¥è‡ªå·±çš„ç­†è§¸:",h.id);return}console.log("[handleDrawingData] æ¥æ”¶åˆ°å…¶ä»–ç©å®¶çš„ç­†è§¸:",h.id),t.addStroke(h),Ce(p.value,h)}}function l(){if(!i.value||!p.value)return;const h=p.value,W=i.value;h.clearRect(0,0,W.width,W.height),h.fillStyle="#FFFFFF",h.fillRect(0,0,W.width,W.height),t.clearStrokes()}function m(h){t.setTool(h)}function $(h){t.setColor(h)}function L(h){t.setLineWidth(h)}function V(){i.value&&oe(i.value,t.strokes)}return{canvasRef:i,initCanvas:R,startDrawing:x,draw:b,stopDrawing:C,clearCanvas:l,setTool:m,setColor:$,setLineWidth:L,handleDrawingData:o,redrawStrokes:V}}const qe={class:"drawing-canvas-container"},Je=Y({__name:"DrawingCanvas",setup(t){const{initCanvas:a,startDrawing:d,draw:v,stopDrawing:s,handleDrawingData:i,clearCanvas:p}=ke(),g=Q(),y=z(),{subscribeDrawing:k}=le(),D=I(null);function R(){console.log("[DrawingCanvas] æ”¶åˆ°æ¸…ç©ºç•«å¸ƒäº‹ä»¶"),p()}function x(V){d(V)}function b(V){v(V)}function C(){s()}function w(){s()}function o(V){d(V)}function l(V){v(V)}function m(){s()}let $=null;function L(){!g.currentRoom||!y.user||($=k(g.currentRoom.code,V=>{i(V)}))}return ae(()=>{D.value&&a(D.value),L(),window.addEventListener("clearCanvas",R)}),ie(()=>{$&&($(),$=null),window.removeEventListener("clearCanvas",R)}),(V,h)=>(u(),c("div",qe,[e("canvas",{ref_key:"canvasElement",ref:D,class:"drawing-canvas",onMousedown:x,onMousemove:b,onMouseup:C,onMouseleave:w,onTouchstart:o,onTouchmove:l,onTouchend:m},null,544)]))}}),Ke=X(Je,[["__scopeId","data-v-f29d9704"]]),Ye={class:"toolbar-section"},Xe={key:0,class:"tool-label"},je={key:0,class:"tool-label"},Qe={key:0,class:"toolbar-section colors-section"},Ze=["onClick","title"],et={class:"toolbar-section size-section"},tt={class:"size-dots"},st=["onClick","title"],nt={class:"toolbar-section"},ot={key:0,class:"tool-label"},rt=Y({__name:"DrawingToolbar",props:{compact:{type:Boolean}},setup(t){const a=be(),{setTool:d,setColor:v,setLineWidth:s,clearCanvas:i}=ke(),p=["#000000","#FFFFFF","#808080","#C0C0C0","#FF0000","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#8000FF","#FF00FF","#FF0080","#800000","#804000","#808000","#008000","#008080","#000080","#800080","#400040"],g=G(()=>a.tool),y=G(()=>a.color),k=G(()=>a.lineWidth);function D(C){d(C)}function R(C){v(C)}function x(C){a.setLineWidth(C),s(C)}function b(){confirm("ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒå—ï¼Ÿ")&&i()}return(C,w)=>(u(),c("div",{class:E(["drawing-toolbar",{"toolbar-compact":t.compact}])},[e("div",Ye,[e("button",{onClick:w[0]||(w[0]=o=>D("pen")),class:E(["tool-btn",{active:g.value==="pen"}]),title:"ç•«ç­†"},[w[2]||(w[2]=e("span",{class:"tool-icon"},"âœï¸",-1)),t.compact?M("",!0):(u(),c("span",Xe,"ç•«ç­†"))],2),e("button",{onClick:w[1]||(w[1]=o=>D("eraser")),class:E(["tool-btn",{active:g.value==="eraser",eraser:!0}]),title:"æ©¡çš®æ“¦"},[w[3]||(w[3]=e("span",{class:"tool-icon"},"ğŸ§¹",-1)),t.compact?M("",!0):(u(),c("span",je,"æ©¡çš®æ“¦"))],2)]),g.value==="pen"?(u(),c("div",Qe,[e("div",{class:E(["color-grid",{"color-grid-compact":t.compact}])},[(u(),c(B,null,A(p,o=>e("div",{key:o,onClick:l=>R(o),class:E(["color-cell",{selected:y.value===o}]),style:re({backgroundColor:o}),title:o},null,14,Ze)),64))],2)])):M("",!0),e("div",et,[e("div",tt,[(u(),c(B,null,A([2,5,10,15],o=>e("div",{key:o,onClick:l=>x(o),class:E(["size-dot",{active:k.value===o}]),style:re({width:`${o+8}px`,height:`${o+8}px`}),title:`${o}px`},null,14,st)),64))])]),e("div",nt,[e("button",{onClick:b,class:"tool-btn clear-btn",title:"æ¸…ç©ºç•«å¸ƒ"},[w[4]||(w[4]=e("span",{class:"tool-icon"},"ğŸ—‘ï¸",-1)),t.compact?M("",!0):(u(),c("span",ot,"æ¸…ç©º"))])])],2))}}),pe=X(rt,[["__scopeId","data-v-7e7250c3"]]),at={class:"player-list"},it={class:"player-list-header"},lt={class:"player-count"},ct={class:"player-rank"},ut={class:"player-info"},dt={class:"player-name"},vt={key:0,class:"drawer-badge"},mt={key:1,class:"host-badge"},ht={class:"player-score"},gt=["onClick"],_t={key:0,class:"winner-banner"},wt={class:"winner-text"},ft={class:"winner-name"},pt={class:"winner-score"},yt=Y({__name:"PlayerList",props:{showWinner:{type:Boolean}},emits:["player-kicked"],setup(t,{emit:a}){const d=a,v=Q(),s=ce(),i=z(),{playerRankings:p,winner:g}=Re(),y=G(()=>p.value),k=I(!1);function D(o){return v.participants.find(m=>m.user_id===o)?.nickname||"æœªçŸ¥ç©å®¶"}function R(o){return i.user?.id===o}function x(o){return v.currentRoom?.host_id===o}function b(o){return s.currentRound?.drawer_id===o||v.currentRoom?.current_drawer_id===o}function C(o){return v.isHost&&!R(o)}async function w(o,l){if(!(k.value||!window.confirm(`ç¢ºå®šè¦è¸¢å‡º ${l} å—ï¼Ÿ`))){k.value=!0;try{const $=await v.kickPlayer(o);$.success?d("player-kicked",o):alert($.error||"è¸¢å‡ºç©å®¶å¤±æ•—")}catch($){console.error("è¸¢äººå¤±æ•—:",$),alert("è¸¢å‡ºç©å®¶å¤±æ•—")}finally{k.value=!1}}}return(o,l)=>(u(),c("div",at,[e("div",it,[e("span",lt,"ç©å®¶ ("+_(y.value.length)+")",1)]),(u(!0),c(B,null,A(y.value,(m,$)=>(u(),c("div",{key:m.id,class:E(["player-item",{"is-current":R(m.user_id)},{"is-drawer":b(m.user_id)}])},[e("div",ct,_($+1),1),e("div",{class:E(["player-avatar",{drawing:b(m.user_id)}])},_(D(m.user_id).charAt(0)),3),e("div",ut,[e("div",dt,[K(_(D(m.user_id))+" ",1),b(m.user_id)?(u(),c("span",vt,"âœï¸")):M("",!0),x(m.user_id)?(u(),c("span",mt,"ğŸ‘‘")):M("",!0)]),e("div",ht,_(m.score)+" åˆ†",1)]),C(m.user_id)?(u(),c("button",{key:0,class:"kick-btn",onClick:L=>w(m.user_id,D(m.user_id)),title:"è¸¢å‡ºç©å®¶"}," âœ• ",8,gt)):M("",!0)],2))),128)),t.showWinner&&r(g)?(u(),c("div",_t,[l[1]||(l[1]=e("div",{class:"winner-icon"},"ğŸ†",-1)),e("div",wt,[l[0]||(l[0]=e("div",{class:"winner-title"},"ç²å‹è€…",-1)),e("div",ft,_(D(r(g).user_id)),1),e("div",pt,_(r(g).score)+" åˆ†",1)])])):M("",!0)]))}}),ye=X(yt,[["__scopeId","data-v-984c1c4a"]]),Rt={class:"round-summary"},bt={class:"summary-card"},Ct={key:0,class:"selection-waiting-banner"},kt={class:"waiting-text"},$t={class:"next-drawer-name"},St={class:"summary-header"},Ft={class:"summary-title"},Dt={class:"round-info"},Wt={class:"answer-reveal"},Tt={class:"answer-text"},xt={class:"drawer-section"},It={class:"drawer-info"},Gt={class:"drawer-name"},Mt={key:0,class:"drawer-score"},Vt={class:"guessers-section"},Et={key:0,class:"no-guessers"},Lt={key:1,class:"guessers-list"},Nt={class:"guesser-rank"},Bt={class:"guesser-name"},Pt={class:"guesser-score"},At={key:1,class:"rating-section"},Ht={class:"star-rating"},Ot=["onMouseenter","onClick","disabled"],zt={class:"rating-info"},Ut={key:0,class:"rated-text"},qt={key:1,class:"rate-hint"},Jt={key:2,class:"average-rating"},Kt={class:"avg-score"},Yt={class:"avg-stars"},Xt={class:"avg-count"},jt=Y({__name:"RoundSummary",props:{roundNumber:{},totalRounds:{},correctAnswer:{},drawerName:{},drawerId:{},drawerScore:{},correctGuessers:{},roundId:{},isHost:{type:Boolean},isLastRound:{type:Boolean},isWaitingForSelection:{type:Boolean},nextDrawerName:{}},emits:["rating-submitted"],setup(t,{emit:a}){const d=t,v=a,s=z(),i=I(0),p=I(0),g=I(!1),y=I([]),k=G(()=>s.user?.id===d.drawerId),D=G(()=>y.value.length===0?0:y.value.reduce((l,m)=>l+m.rating,0)/y.value.length),R=G(()=>y.value.length);async function x(o){if(!(g.value||k.value||!s.user))try{const{error:l}=await J.from("drawing_ratings").upsert({round_id:d.roundId,rater_id:s.user.id,drawer_id:d.drawerId,rating:o},{onConflict:"round_id,rater_id"});if(l)throw l;i.value=o,g.value=!0,v("rating-submitted",o)}catch(l){console.error("æäº¤è©•åˆ†éŒ¯èª¤:",l)}}async function b(){try{const{data:o,error:l}=await J.from("drawing_ratings").select("rater_id, rating").eq("round_id",d.roundId);if(l)throw l;if(y.value=o||[],s.user){const m=y.value.find($=>$.rater_id===s.user.id);m&&(i.value=m.rating,g.value=!0)}}catch(o){console.error("è¼‰å…¥è©•åˆ†éŒ¯èª¤:",o)}}function C(){const o=J.channel(`ratings:${d.roundId}`).on("postgres_changes",{event:"*",schema:"public",table:"drawing_ratings",filter:`round_id=eq.${d.roundId}`},()=>{b()}).subscribe();return()=>{J.removeChannel(o)}}let w=null;return ae(()=>{b(),w=C()}),ie(()=>{w&&w()}),j(()=>d.roundId,()=>{b()}),(o,l)=>(u(),c("div",Rt,[e("div",bt,[t.isWaitingForSelection?(u(),c("div",Ct,[l[2]||(l[2]=e("div",{class:"waiting-icon"},[e("span",{class:"pencil-animate"},"âœï¸")],-1)),e("div",kt,[e("span",$t,_(t.nextDrawerName),1),l[1]||(l[1]=K(" æ­£åœ¨é¸è©... ",-1))]),l[3]||(l[3]=e("div",{class:"waiting-dots"},[e("span",{class:"dot"}),e("span",{class:"dot"}),e("span",{class:"dot"})],-1))])):M("",!0),e("div",St,[e("h2",Ft,_(t.isWaitingForSelection?"ğŸ“‹ ä¸Šä¸€è¼ªå›é¡§":"ğŸ¨ è¼ªæ¬¡çµæŸ"),1),e("div",Dt,"ç¬¬ "+_(t.roundNumber)+" / "+_(t.totalRounds)+" è¼ª",1)]),e("div",Wt,[l[4]||(l[4]=e("div",{class:"answer-label"},"æ­£ç¢ºç­”æ¡ˆ",-1)),e("div",Tt,_(t.correctAnswer),1)]),e("div",xt,[e("div",It,[l[5]||(l[5]=e("span",{class:"drawer-label"},"ç•«å®¶",-1)),e("span",Gt,_(t.drawerName),1),t.drawerScore>0?(u(),c("span",Mt,"+"+_(t.drawerScore)+" åˆ†",1)):M("",!0)])]),e("div",Vt,[l[6]||(l[6]=e("div",{class:"section-title"},"çŒœä¸­çš„ç©å®¶",-1)),t.correctGuessers.length===0?(u(),c("div",Et," æ²’æœ‰äººçŒœä¸­ ğŸ˜¢ ")):(u(),c("div",Lt,[(u(!0),c(B,null,A(t.correctGuessers,(m,$)=>(u(),c("div",{key:m.userId,class:"guesser-item"},[e("span",Nt,_($+1),1),e("span",Bt,_(m.name),1),e("span",Pt,"+"+_(m.score),1)]))),128))]))]),k.value?M("",!0):(u(),c("div",At,[l[7]||(l[7]=e("div",{class:"section-title"},"ç‚ºé€™å¹…ç•«è©•åˆ†",-1)),e("div",Ht,[(u(),c(B,null,A(5,m=>e("button",{key:m,class:E(["star-btn",{active:m<=(p.value||i.value),selected:m<=i.value}]),onMouseenter:$=>p.value=m,onMouseleave:l[0]||(l[0]=$=>p.value=0),onClick:$=>x(m),disabled:g.value}," â­ ",42,Ot)),64))]),e("div",zt,[g.value?(u(),c("span",Ut,"ä½ çš„è©•åˆ†ï¼š"+_(i.value)+" æ˜Ÿ",1)):(u(),c("span",qt,"é»æ“Šæ˜Ÿæ˜Ÿè©•åˆ†"))])])),R.value>0?(u(),c("div",Jt,[l[8]||(l[8]=e("span",{class:"avg-label"},"å¹³å‡è©•åˆ†",-1)),e("span",Kt,_(D.value.toFixed(1)),1),e("span",Yt,_("â­".repeat(Math.round(D.value))),1),e("span",Xt,"("+_(R.value)+" äººå·²è©•)",1)])):M("",!0)])]))}}),Qt=X(jt,[["__scopeId","data-v-64089556"]]);function Zt(){const t=ce(),a=z(),{calculateGuessScore:d,updatePlayerScore:v}=Re(),s=I(""),i=I(null),p=I(!1),g=G(()=>t.isCurrentDrawer?t.currentWord:null),y=G(()=>t.correctGuesses),k=G(()=>a.user?t.hasGuessed(a.user.id):!1);async function D(){if(!t.currentRound||!a.user)return i.value="ç„¡æ³•æäº¤çŒœæ¸¬",{success:!1,error:"ç„¡æ³•æäº¤çŒœæ¸¬"};if(!s.value.trim())return i.value="è«‹è¼¸å…¥çŒœæ¸¬",{success:!1,error:"è«‹è¼¸å…¥çŒœæ¸¬"};if(s.value.length>32)return i.value="çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦",{success:!1,error:"çŒœæ¸¬ä¸èƒ½è¶…é 32 å€‹å­—ç¬¦"};if(k.value)return i.value="æ‚¨å·²ç¶“çŒœä¸­äº†",{success:!1,error:"æ‚¨å·²ç¶“çŒœä¸­äº†"};if(t.isCurrentDrawer)return i.value="ç•«å®¶ä¸èƒ½çŒœæ¸¬",{success:!1,error:"ç•«å®¶ä¸èƒ½çŒœæ¸¬"};try{p.value=!0,i.value=null;const b=s.value.trim(),C=t.currentWord||"",w=R(b,C),o=w?d(y.value.length):0,{data:l,error:m}=await J.from("guesses").insert({round_id:t.currentRound.id,user_id:a.user.id,guess_text:b,is_correct:w,score_earned:o}).select().single();if(m)throw m;return t.guesses.push(l),w&&a.user&&await v(a.user.id,o),s.value="",{success:!0,isCorrect:w,guess:l}}catch(b){return i.value=b instanceof Error?b.message:"æäº¤çŒœæ¸¬å¤±æ•—",console.error("æäº¤çŒœæ¸¬éŒ¯èª¤:",b),{success:!1,error:i.value}}finally{p.value=!1}}function R(b,C){const w=b.trim(),o=C.trim();return w===o}function x(){i.value=null}return{guessInput:s,error:i,loading:p,currentWord:g,correctGuesses:y,hasGuessed:k,submitGuess:D,clearError:x}}const es={class:"game-container"},ts={key:0,class:"container margin-top-large"},ss={class:"row flex-center"},ns={class:"col-12 col-md-8"},os={key:1,class:"game-layout"},rs={class:"game-sidebar game-players"},as={class:"player-list-container"},is={class:"game-main"},ls={key:0,class:"time-display"},cs={key:1,class:"time-display summary"},us={class:"time-number"},ds={class:"round-info"},vs={class:"round-label"},ms={key:0,class:"phase-label"},hs={key:2,class:"word-display"},gs={class:"word-text"},_s={key:3,class:"word-display"},ws={class:"drawer-hint"},fs={class:"word-slots"},ps={key:4,class:"word-display summary-word"},ys={class:"word-text revealed"},Rs={class:"game-content-area"},bs={class:"game-toolbar disabled"},Cs={class:"game-canvas summary-phase"},ks={class:"game-chat-panel"},$s={class:"chat-msg system-msg answer-revealed"},Ss={class:"msg-player"},Fs={class:"msg-correct"},Ds={class:"game-toolbar"},Ws={class:"game-canvas"},Ts={key:0,class:"time-progress"},xs={class:"game-chat-panel"},Is={class:"msg-player"},Gs={key:0,class:"msg-correct"},Ms={key:1,class:"msg-text"},Vs={key:0,class:"chat-msg correct-self"},Es={class:"chat-input-area"},Ls=["placeholder","disabled"],Ns=["disabled"],Bs={key:2,class:"container margin-top-large"},Ps={class:"row flex-center"},As={class:"col-12 col-md-8"},Hs={class:"card"},Os={class:"card-body text-center"},zs=Y({__name:"RoomView",setup(t){const a=Ee(),d=Ae(),v=Q(),s=ce(),i=z(),{subscribeRoom:p,unsubscribeRoom:g,subscribeGameState:y}=le(),{isPlaying:k,isWaiting:D,isFinished:R,timeRemaining:x,isCountingDown:b,isCurrentDrawer:C,drawTime:w,currentRoundNumber:o,totalRounds:l,startGame:m,isDrawing:$,isSummary:L,summaryTimeRemaining:V,startSummaryCountdown:h,stopSummaryCountdown:W,startCountdown:S,stopCountdown:H}=we(),{hasGuessed:U,guessInput:N,submitGuess:O,loading:$e}=Zt(),{leaveRoom:Se}=Oe(),T=G(()=>v.currentRoom),ue=G(()=>$e.value),de=I(null),q=I(null),Z=G(()=>{const f=T.value?.current_drawer_id;return f&&v.participants.find(F=>F.user_id===f)?.nickname||"ç•«å®¶"}),ve=G(()=>[...s.guesses].sort((f,n)=>new Date(f.guessed_at).getTime()-new Date(n.guessed_at).getTime()));function Fe(){q.value&&(q.value.scrollTop=q.value.scrollHeight)}j(ve,()=>{He(Fe)},{deep:!0}),j(()=>v.participants,f=>{if(!i.user||!T.value)return;!f.some(F=>F.user_id===i.user.id)&&T.value&&(console.log("[RoomView] æª¢æ¸¬åˆ°è¢«è¸¢å‡ºæˆ¿é–“"),alert("ä½ å·²è¢«æˆ¿ä¸»è¸¢å‡ºæˆ¿é–“"),v.clearRoom(),d.push("/"))},{deep:!0});function ee(f){return v.participants.find(F=>F.user_id===f)?.nickname||"æœªçŸ¥ç©å®¶"}const De=G(()=>C.value?"ä½ æ˜¯ç•«å®¶ï¼Œä¸èƒ½æ‰“å­—å“¦~":U.value?"ä½ å·²çŒœä¸­ï¼ç­‰å¾…å…¶ä»–äºº...":"è¼¸å…¥ä½ çš„çŒœæ¸¬..."),We=G(()=>s.currentWord?s.currentWord.split("").map(()=>"_").join(" "):"çŒœçŒœç•«çš„æ˜¯ä»€éº¼ï¼Ÿ"),me=G(()=>s.currentRoundCorrectGuesses.length*5),he=G(()=>s.currentRoundCorrectGuesses.map(f=>({userId:f.user_id,name:ee(f.user_id),score:f.score_earned}))),Te=I(null);function xe(){!s.currentRound||!s.currentWord||(Te.value={roundNumber:o.value,answer:s.currentWord,drawerName:Z.value,drawerId:s.currentRound.drawer_id,drawerScore:me.value,correctGuessers:he.value,roundId:s.currentRound.id})}j(L,(f,n)=>{f&&!n&&o.value>0&&xe()});function te(f){de.value=f,setTimeout(()=>{de.value=null},3e3)}async function ge(){!C.value&&N.value.trim()&&await O()}async function Ie(){const f=await m();!f.success&&f.error&&te(f.error)}async function se(){const f=await Se();T.value&&g(T.value.code),await d.push("/"),!f.success&&f.error&&te(f.error)}async function Ge(f){if(!s.currentRound)return;const n=await s.submitRating(s.currentRound.id,s.currentRound.drawer_id,f);!n.success&&n.error&&te(n.error)}return ae(async()=>{console.log("[RoomView] onMounted é–‹å§‹"),console.log("[RoomView] è·¯ç”±åƒæ•¸:",a.params),console.log("[RoomView] ç•¶å‰æˆ¿é–“:",T.value),console.log("[RoomView] ç•¶å‰ç”¨æˆ¶:",i.user?.id);const f=a.params.code;if(f&&!T.value&&console.log("[RoomView] å¾è·¯ç”±åƒæ•¸è¼‰å…¥æˆ¿é–“:",f),T.value&&i.user){if(console.log("[RoomView] æˆ¿é–“ç‹€æ…‹:",T.value.status),await s.loadCurrentRound(T.value.id),T.value.status==="playing"&&s.currentRound){const n=s.currentRound;if(console.log("[RoomView] æª¢æ¸¬åˆ°é€²è¡Œä¸­çš„è¼ªæ¬¡:",{roundNumber:n.round_number,startedAt:n.started_at,endedAt:n.ended_at,drawerId:n.drawer_id}),n.drawer_id&&v.setCurrentDrawer(n.drawer_id),n.started_at&&!n.ended_at){console.log("[RoomView] è¼ªæ¬¡é€²è¡Œä¸­ï¼Œåˆå§‹åŒ–ç¹ªç•«éšæ®µ"),s.setRoundStatus("drawing"),window.dispatchEvent(new CustomEvent("clearCanvas"));const F=new Date(n.started_at).getTime(),Me=Date.now(),_e=Math.floor((Me-F)/1e3),ne=Math.max(0,w.value-_e);console.log("[RoomView] å€’è¨ˆæ™‚è¨ˆç®—:",{drawTime:w.value,elapsed:_e,remaining:ne}),ne>0?S(ne):S(0)}else n.ended_at&&console.log("[RoomView] è¼ªæ¬¡å·²çµæŸï¼Œå¯èƒ½æ˜¯ç¸½çµéšæ®µ")}try{await p(T.value.code,T.value.id,i.user.id,{nickname:i.profile?.display_name||"ç©å®¶"}),console.log("[RoomView] Realtime Channel é€£æ¥æˆåŠŸ")}catch(n){console.error("[RoomView] Realtime Channel é€£æ¥å¤±æ•—:",n)}y(T.value.code,async n=>{console.log("[RoomView] æ”¶åˆ°éŠæˆ²ç‹€æ…‹å»£æ’­:",n),n.drawerId&&T.value&&(console.log("[RoomView] æ›´æ–°ç•«å®¶ ID:",n.drawerId),v.setCurrentDrawer(n.drawerId)),n.roundStatus&&(console.log("[RoomView] æ›´æ–°è¼ªæ¬¡ç‹€æ…‹:",n.roundStatus),s.setRoundStatus(n.roundStatus),n.roundStatus==="drawing"&&(window.dispatchEvent(new CustomEvent("clearCanvas")),W(),s.clearRatings(),S(w.value)),n.roundStatus==="summary"&&(H(),n.isLastRound?v.isHost&&setTimeout(async()=>{const{endGame:F}=we();await F()},3e3):h())),T.value&&(await v.loadRoom(T.value.id),await s.loadCurrentRound(T.value.id))}),await s.loadAllGuesses(T.value.id)}}),ie(()=>{T.value&&g(T.value.code)}),(f,n)=>(u(),c("div",es,[r(D)?(u(),c("div",ts,[e("div",ss,[e("div",ns,[P(ze,{room:T.value,participants:r(v).participants,onStartGame:Ie,onLeaveRoom:se},null,8,["room","participants"])])])])):r(k)?(u(),c("div",os,[e("div",rs,[e("div",as,[P(ye,{"show-winner":!1})])]),e("div",is,[e("div",{class:E(["game-header",{"time-critical":r(x)!==null&&r(x)<=10}])},[r($)&&r(b)&&r(x)!==null?(u(),c("div",ls,[e("span",{class:E(["time-number",{"time-warning":r(x)<=10,"time-critical-pulse":r(x)<=5}])},_(r(x)),3),n[1]||(n[1]=e("span",{class:"time-label"},"ç§’",-1))])):r(L)&&r(V)!==null?(u(),c("div",cs,[e("span",us,_(r(V)),1),n[2]||(n[2]=e("span",{class:"time-label"},"ç§’å¾Œç¹¼çºŒ",-1))])):M("",!0),e("div",ds,[e("span",vs,"ç¬¬ "+_(r(o))+" / "+_(r(l))+" è¼ª",1),r(L)?(u(),c("span",ms,"è¼ªæ¬¡çµç®—")):M("",!0)]),r($)&&r(C)&&r(s).currentWord?(u(),c("div",hs,[n[3]||(n[3]=e("span",{class:"word-label"},"ä½ çš„è©èª",-1)),e("span",gs,_(r(s).currentWord),1)])):r($)?(u(),c("div",_s,[e("span",ws,"ğŸ¨ "+_(Z.value)+" æ­£åœ¨ç•«",1),e("span",fs,_(We.value),1)])):r(L)&&r(s).currentWord?(u(),c("div",ps,[n[4]||(n[4]=e("span",{class:"word-label"},"ç­”æ¡ˆæ˜¯",-1)),e("span",ys,_(r(s).currentWord),1)])):M("",!0),e("button",{class:"leave-btn",onClick:se,title:"é›¢é–‹æˆ¿é–“"},"âœ•")],2),e("div",Rs,[r(L)?(u(),c(B,{key:0},[e("div",bs,[P(pe,{compact:!0})]),e("div",Cs,[P(Qt,{"round-number":r(o),"total-rounds":r(l),"correct-answer":r(s).currentWord||"","drawer-name":Z.value,"drawer-id":r(s).currentRound?.drawer_id||"","drawer-score":me.value,"correct-guessers":he.value,"round-id":r(s).currentRound?.id||"","is-host":r(v).isHost,"is-last-round":r(o)>=r(l),onRatingSubmitted:Ge},null,8,["round-number","total-rounds","correct-answer","drawer-name","drawer-id","drawer-score","correct-guessers","round-id","is-host","is-last-round"])]),e("div",ks,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:q},[e("div",$s,[n[5]||(n[5]=e("span",{class:"msg-icon"},"ğŸ¯",-1)),n[6]||(n[6]=K(" ç­”æ¡ˆæ˜¯ï¼š",-1)),e("strong",null,_(r(s).currentWord),1)]),(u(!0),c(B,null,A(r(s).currentRoundCorrectGuesses,F=>(u(),c("div",{key:F.id,class:"chat-msg correct-guess"},[e("span",Ss,_(ee(F.user_id)),1),e("span",Fs,"çŒœä¸­äº†ï¼ +"+_(F.score_earned),1)]))),128))],512),n[7]||(n[7]=e("div",{class:"chat-input-area"},[e("input",{type:"text",placeholder:"ä¸‹ä¸€è¼ªå³å°‡é–‹å§‹...",disabled:"",class:"chat-input-field"}),e("button",{disabled:"",class:"chat-send-btn"},"ç™¼é€")],-1))])],64)):(u(),c(B,{key:1},[e("div",Ds,[P(pe,{compact:!0})]),e("div",Ws,[P(Ke),r(b)&&r(x)!==null?(u(),c("div",Ts,[e("div",{class:E(["time-bar",{"time-warning":r(x)<=10}]),style:re({width:`${r(x)/r(w)*100}%`})},null,6)])):M("",!0)]),e("div",xs,[e("div",{class:"chat-messages-container",ref_key:"chatMessagesRef",ref:q},[n[9]||(n[9]=e("div",{class:"chat-msg system-msg"},[e("span",{class:"msg-icon"},"ğŸ®"),K(" éŠæˆ²é–‹å§‹ï¼ ")],-1)),(u(!0),c(B,null,A(ve.value,F=>(u(),c("div",{key:F.id,class:E(["chat-msg",{"correct-guess":F.is_correct,"wrong-guess":!F.is_correct}])},[e("span",Is,_(ee(F.user_id)),1),F.is_correct?(u(),c("span",Gs,"çŒœä¸­äº†ï¼ +"+_(F.score_earned),1)):(u(),c("span",Ms,_(F.guess_text),1))],2))),128)),r(U)?(u(),c("div",Vs,[...n[8]||(n[8]=[e("span",{class:"msg-icon"},"âœ…",-1),K(" ä½ å·²çŒœä¸­ç­”æ¡ˆï¼ ",-1)])])):M("",!0)],512),e("div",Es,[Le(e("input",{"onUpdate:modelValue":n[0]||(n[0]=F=>Pe(N)?N.value=F:null),type:"text",placeholder:De.value,maxlength:"32",disabled:ue.value||r(U)||r(C),onKeyup:Be(ge,["enter"]),class:"chat-input-field"},null,40,Ls),[[Ne,r(N)]]),e("button",{onClick:ge,disabled:ue.value||r(U)||r(C)||!r(N).trim(),class:"chat-send-btn"}," ç™¼é€ ",8,Ns)])])],64))])])])):r(R)?(u(),c("div",Bs,[e("div",Ps,[e("div",As,[e("div",Hs,[e("div",Os,[n[10]||(n[10]=e("h2",{class:"card-title text-hand-title"},"ğŸ‰ éŠæˆ²çµæŸ",-1)),P(ye,{"show-winner":!0}),e("button",{onClick:se,class:"paper-btn btn-primary margin-top-medium"}," è¿”å›é¦–é  ")])])])])])):M("",!0)]))}}),Js=X(zs,[["__scopeId","data-v-8ae4f241"]]);export{Js as default};
