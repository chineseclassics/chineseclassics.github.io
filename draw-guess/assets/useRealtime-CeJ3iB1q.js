import{l as de,r as k,f as h,u as K,x as p,m as he,d as _e,c as P,e as E,a as Z,t as G,s as se,F as pe,p as Re,b as I,o as B,_ as ye}from"./index-IMa4u1GL.js";const V=de("room",()=>{const e=k(null),f=k([]),c=k(!1),i=k(null),w=h(()=>{const t=K();return e.value?.host_id===t.user?.id});async function S(t){try{c.value=!0,i.value=null;const r=K();if(!r.user)throw new Error("請先登入");if(!r.profile&&r.user)try{await r.loadUserProfile(r.user.id,!1)}catch(s){console.warn("載入用戶資料時發生錯誤（非關鍵）:",s)}if(t.words.length<6)throw new Error("至少需要 6 個詞語");if(t.settings.rounds>t.words.length)throw new Error("輪數不能超過詞語總數");let n=null,o=0;const d=10;for(;o<d&&!n;){o++;const x={code:Math.floor(1e5+Math.random()*9e5).toString(),name:t.name,host_id:r.user.id,words:t.words,word_count:t.words.length,status:"waiting",settings:t.settings,current_round:0,current_drawer_id:null},{data:O,error:W}=await p.from("game_rooms").insert(x).select().single();if(W){if(W.code==="23505")continue;throw new Error(W.message||"插入房間失敗")}if(O){n=O;break}}if(!n)throw new Error("無法生成唯一房間碼，請重試");const D={room_id:n.id,user_id:r.user.id,nickname:r.profile?.display_name||"房主",score:0};try{const{error:s}=await p.from("room_participants").insert(D);s&&console.error("創建參與記錄錯誤:",s)}catch(s){console.error("創建參與記錄時發生錯誤:",s)}try{const{data:s,error:x}=await p.from("room_participants").select("*").eq("room_id",n.id).order("joined_at",{ascending:!0});x?console.error("載入參與者列表失敗:",x):s&&(f.value=s)}catch(s){console.error("載入參與者列表時發生錯誤:",s)}return e.value=n,{success:!0,room:n}}catch(r){return i.value=r instanceof Error?r.message:"創建房間失敗",console.error("創建房間錯誤:",r),{success:!1,error:i.value}}finally{c.value=!1}}async function b(t,r){try{c.value=!0,i.value=null;const n=K();if(!n.user)throw new Error("請先登入");if(!/^\d{6}$/.test(t))throw new Error("房間碼必須是 6 位數字");if(!r||r.trim().length===0)throw new Error("請輸入暱稱");if(r.length>20)throw new Error("暱稱不能超過 20 個字符");const{data:o,error:d}=await p.from("game_rooms").select("*").eq("code",t).single();if(d||!o)throw new Error("房間不存在");if(o.status!=="waiting")throw new Error("房間已開始或已結束");const{data:D}=await p.from("room_participants").select("*").eq("room_id",o.id).eq("user_id",n.user.id).maybeSingle();if(D)return e.value=o,await m(o.id),{success:!0,room:o};const{error:s}=await p.from("room_participants").insert({room_id:o.id,user_id:n.user.id,nickname:r.trim(),score:0});if(s){if(s.code==="23505"||s.message.includes("duplicate"))return e.value=o,await m(o.id),{success:!0,room:o};throw s}return e.value=o,await m(o.id),{success:!0,room:o}}catch(n){return i.value=n instanceof Error?n.message:"加入房間失敗",console.error("加入房間錯誤:",n),{success:!1,error:i.value}}finally{c.value=!1}}async function R(){try{if(!e.value)return{success:!0};c.value=!0,i.value=null;const t=K();if(!t.user)throw new Error("請先登入");const{error:r}=await p.from("room_participants").delete().eq("room_id",e.value.id).eq("user_id",t.user.id);if(r)throw new Error(`刪除參與記錄失敗: ${r.message||"未知錯誤"}`);if(w.value){const{error:n}=await p.from("game_rooms").update({status:"finished"}).eq("id",e.value.id);n&&console.error("關閉房間失敗:",n)}return e.value=null,f.value=[],{success:!0}}catch(t){return i.value=t instanceof Error?t.message:"離開房間失敗",console.error("離開房間錯誤:",t),e.value=null,f.value=[],{success:!1,error:i.value}}finally{c.value=!1}}async function m(t){try{const{data:r,error:n}=await p.from("room_participants").select("*").eq("room_id",t).order("joined_at",{ascending:!0});if(n)throw n;f.value=r||[]}catch(r){console.error("載入參與者錯誤:",r)}}async function l(t){try{c.value=!0,i.value=null;const{data:r,error:n}=await p.from("game_rooms").select("*").eq("id",t).single();if(n)throw n;return e.value=r,await m(t),{success:!0,room:r}}catch(r){return i.value=r instanceof Error?r.message:"載入房間失敗",console.error("載入房間錯誤:",r),{success:!1,error:i.value}}finally{c.value=!1}}async function v(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新房間狀態:",{roomId:e.value.id,oldStatus:e.value.status,newStatus:t});const{error:r}=await p.from("game_rooms").update({status:t}).eq("id",e.value.id);if(r)throw r;if(e.value){const n=e.value.status;e.value.status=t,console.log("[RoomStore] 房間狀態已更新:",{oldStatus:n,newStatus:e.value.status})}return{success:!0}}catch(r){return i.value=r instanceof Error?r.message:"更新房間狀態失敗",console.error("更新房間狀態錯誤:",r),{success:!1,error:i.value}}}async function _(t){try{if(!e.value)throw new Error("沒有當前房間");console.log("[RoomStore] 更新當前畫家:",{roomId:e.value.id,drawerId:t});const{error:r}=await p.from("game_rooms").update({current_drawer_id:t}).eq("id",e.value.id);if(r)throw r;return e.value&&(e.value.current_drawer_id=t,console.log("[RoomStore] 當前畫家已更新:",t)),{success:!0}}catch(r){return i.value=r instanceof Error?r.message:"更新畫家失敗",console.error("更新畫家錯誤:",r),{success:!1,error:i.value}}}function q(){e.value=null,f.value=[],i.value=null}return{currentRoom:e,participants:f,loading:c,error:i,isHost:w,createRoom:S,joinRoom:b,leaveRoom:R,loadParticipants:m,loadRoom:l,updateRoomStatus:v,updateRoomDrawer:_,clearRoom:q}});function Se(){const e=V(),f=h(()=>e.currentRoom),c=h(()=>e.participants),i=h(()=>e.isHost),w=h(()=>!f.value||f.value.status!=="waiting"||!i.value?!1:c.value.length>=2);async function S(m){return await e.createRoom(m)}async function b(m,l){return await e.joinRoom(m,l)}async function R(){return await e.leaveRoom()}return{currentRoom:f,participants:c,isHost:i,canStartGame:w,loading:h(()=>e.loading),error:h(()=>e.error),createRoom:S,joinRoom:b,leaveRoom:R}}const ae=100,ce=50,ie=10,ue=100,le=[1,.8,.6,.4,.2];function be(){const e=V();function f(l){const v=Math.min(l,le.length-1),_=le[v]??0;return Math.round(ae*_)}function c(l){return l===0?0:ce+l*ie}async function i(l,v){if(!e.currentRoom)return console.error("沒有當前房間"),!1;try{const{data:_,error:q}=await p.from("room_participants").select("score").eq("room_id",e.currentRoom.id).eq("user_id",l).single();if(q)throw q;const t=(_?.score||0)+v,{error:r}=await p.from("room_participants").update({score:t}).eq("room_id",e.currentRoom.id).eq("user_id",l);if(r)throw r;const n=e.participants.findIndex(o=>o.user_id===l);return n!==-1&&e.participants[n]&&(e.participants[n].score=t),!0}catch(_){return console.error("更新玩家分數錯誤:",_),!1}}async function w(l,v){const _=c(v);return _===0?!0:await i(l,_)}function S(){if(!e.participants||e.participants.length===0)return null;const l=[...e.participants].sort((v,_)=>_.score-v.score);return l.length===1||l[0]&&l[1]&&l[0].score>l[1].score?{user_id:l[0]?.user_id||"",score:l[0]?.score||0}:{user_id:l[0]?.user_id||"",score:l[0]?.score||0}}const b=h(()=>!e.participants||e.participants.length===0?[]:[...e.participants].sort((v,_)=>_.score!==v.score?_.score-v.score:new Date(v.joined_at).getTime()-new Date(_.joined_at).getTime()).map((v,_)=>({id:v.id,user_id:v.user_id,score:v.score,rank:_+1}))),R=h(()=>e.currentRoom?.status!=="finished"?null:S());function m(){return ue}return{GUESS_BASE_SCORE:ae,DRAWING_BASE_SCORE:ce,DRAWING_BONUS_PER_GUESS:ie,WINNER_BONUS:ue,calculateGuessScore:f,calculateDrawingScore:c,calculateWinner:S,updatePlayerScore:i,updateDrawerScore:w,playerRankings:b,winner:R,getWinnerBonus:m}}const fe=de("game",()=>{const e=V(),f=K(),c=k(null),i=k(null),w=k([]),S=h(()=>w.value.filter(g=>g.is_correct)),b=k("drawing"),R=k([]),m=k([]),l=h(()=>m.value.length===0?0:m.value.reduce((a,y)=>a+y.rating,0)/m.value.length);function v(g){b.value=g}function _(g){R.value=g}function q(g){const a=m.value.findIndex(y=>y.rater_id===g.rater_id);a>=0?m.value[a]=g:m.value.push(g)}function t(){m.value=[]}async function r(g){try{const{data:a,error:y}=await p.from("game_rounds").select("*").eq("room_id",g).order("round_number",{ascending:!1}).limit(1).single();if(y&&y.code!=="PGRST116")throw y;return a&&(c.value=a,i.value=a.word_text,await n(a.id)),{success:!0,round:a}}catch(a){return console.error("載入當前輪次錯誤:",a),{success:!1,error:a instanceof Error?a.message:"載入輪次失敗"}}}async function n(g){try{const{data:a,error:y}=await p.from("guesses").select("*").eq("round_id",g).order("guessed_at",{ascending:!0});if(y)throw y;w.value=a||[]}catch(a){console.error("載入猜測記錄錯誤:",a)}}async function o(g,a,y,M){try{if(!e.currentRoom)throw new Error("沒有當前房間");const N=(e.currentRoom.current_round||0)+1,{data:z,error:A}=await p.from("game_rounds").insert({room_id:g,round_number:N,drawer_id:a,word_text:y,word_source:M}).select().single();if(A)throw A;return c.value=z,i.value=y,w.value=[],await p.from("game_rooms").update({current_round:N,current_drawer_id:a}).eq("id",g),{success:!0,round:z}}catch(N){return console.error("創建輪次錯誤:",N),{success:!1,error:N instanceof Error?N.message:"創建輪次失敗"}}}function d(g){return w.value.some(a=>a.user_id===g&&a.is_correct)}const D=h(()=>!c.value||!f.user?!1:c.value.drawer_id===f.user.id);async function s(){if(!c.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};try{const g=S.value.length,{updateDrawerScore:a}=be();await a(c.value.drawer_id,g);const{error:y}=await p.from("game_rounds").update({ended_at:new Date().toISOString()}).eq("id",c.value.id);if(y)throw y;return{success:!0}}catch(g){return console.error("結束輪次錯誤:",g),{success:!1,error:g instanceof Error?g.message:"結束輪次失敗"}}}function x(){c.value=null,i.value=null,w.value=[],b.value="drawing",R.value=[],m.value=[]}async function O(g,a,y){if(!f.user)return{success:!1,error:"用戶未登錄"};try{const{data:M,error:N}=await p.from("drawing_ratings").upsert({round_id:g,rater_id:f.user.id,drawer_id:a,rating:y},{onConflict:"round_id,rater_id"}).select().single();if(N)throw N;return M&&q(M),{success:!0,rating:M}}catch(M){return console.error("提交評分錯誤:",M),{success:!1,error:M instanceof Error?M.message:"提交評分失敗"}}}async function W(g){try{const{data:a,error:y}=await p.from("drawing_ratings").select("*").eq("round_id",g);if(y)throw y;return m.value=a||[],{success:!0,ratings:a}}catch(a){return console.error("載入評分錯誤:",a),{success:!1,error:a instanceof Error?a.message:"載入評分失敗"}}}return{currentRound:c,currentWord:i,guesses:w,correctGuesses:S,isCurrentDrawer:D,roundStatus:b,wordOptions:R,ratings:m,averageRating:l,loadCurrentRound:r,loadGuesses:n,createRound:o,hasGuessed:d,endRound:s,clearGame:x,setRoundStatus:v,setWordOptions:_,addRating:q,clearRatings:t,submitRating:O,loadRatings:W}}),Ee=15,xe=8;function Te(){const e=V(),f=fe(),c=k(null),i=k(!1);let w=null;const S=k(null);let b=null;const R=k(null);let m=null;const l=h(()=>e.currentRoom?.status||"waiting"),v=h(()=>l.value==="playing"),_=h(()=>l.value==="waiting"),q=h(()=>l.value==="finished"),t=h(()=>f.roundStatus),r=h(()=>t.value==="selecting"),n=h(()=>t.value==="drawing"),o=h(()=>t.value==="summary"),d=h(()=>f.currentRound),D=h(()=>e.currentRoom?.current_round||0),s=h(()=>e.currentRoom?.settings.rounds||0),x=h(()=>e.currentRoom?.settings.draw_time||60),O=h(()=>f.wordOptions),W=h(()=>f.isCurrentDrawer);function g(u){w&&clearInterval(w),c.value=u,i.value=!0,w=window.setInterval(()=>{c.value!==null&&c.value>0?c.value--:(a(),v.value&&d.value&&e.isHost&&te())},1e3)}function a(){w&&(clearInterval(w),w=null),i.value=!1}function y(){a(),c.value=null}function M(){b&&clearInterval(b),S.value=Ee,b=window.setInterval(()=>{if(S.value!==null&&S.value>0)S.value--;else if(N(),r.value&&e.isHost&&O.value.length>0){const u=O.value[0];u&&ee(u)}},1e3)}function N(){b&&(clearInterval(b),b=null),S.value=null}function z(){m&&clearInterval(m),R.value=xe,m=window.setInterval(()=>{R.value!==null&&R.value>0?R.value--:(A(),o.value&&e.isHost&&ne())},1e3)}function A(){m&&(clearInterval(m),m=null),R.value=null}function me(){if(!e.currentRoom)return[];const u=e.currentRoom.words,T=e.currentRoom.current_round||0,C=u.slice(T);if(C.length===0)return[];const L=[...C].sort(()=>Math.random()-.5);return L.slice(0,Math.min(3,L.length)).map(oe=>({text:oe.text,source:oe.source}))}async function ge(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};if(e.currentRoom.status!=="waiting")return{success:!1,error:"房間狀態不正確"};if(e.participants.length<2)return{success:!1,error:"至少需要 2 個玩家才能開始遊戲"};try{const u=await e.updateRoomStatus("playing");return u.success?await Y():u}catch(u){return console.error("開始遊戲錯誤:",u),{success:!1,error:u instanceof Error?u.message:"開始遊戲失敗"}}}async function Y(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};const u=e.currentRoom.current_round||0;if(u>=s.value)return await X(),{success:!1,error:"所有輪次已完成"};try{const T=u%e.participants.length,C=e.participants[T];if(!C)throw new Error("無法選擇畫家");const L=me();if(L.length===0)throw new Error("沒有可用的詞語");return f.setWordOptions(L),f.setRoundStatus("selecting"),f.clearRatings(),await e.updateRoomDrawer(C.user_id),M(),{success:!0,drawerId:C.user_id,options:L}}catch(T){return console.error("開始選詞階段錯誤:",T),{success:!1,error:T instanceof Error?T.message:"開始選詞階段失敗"}}}async function ee(u){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};N();try{const T=e.currentRoom.current_drawer_id;if(!T)throw new Error("沒有當前畫家");const C=await f.createRound(e.currentRoom.id,T,u.text,u.source);return C.success&&C.round&&(f.setRoundStatus("drawing"),f.setWordOptions([]),g(x.value)),C}catch(T){return console.error("選擇詞語錯誤:",T),{success:!1,error:T instanceof Error?T.message:"選擇詞語失敗"}}}async function re(){return await Y()}async function te(){if(!d.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!e.isHost)return{success:!1,error:"只有房主可以結束輪次"};try{a();const u=await f.endRound();return u.success?(f.setRoundStatus("summary"),z(),{success:!0,gameEnded:!1}):u}catch(u){return console.error("結束輪次錯誤:",u),{success:!1,error:u instanceof Error?u.message:"結束輪次失敗"}}}async function ne(){return e.currentRoom?(A(),(e.currentRoom.current_round||0)>=s.value?(await X(),{success:!0,gameEnded:!0}):(await Y(),{success:!0,gameEnded:!1})):{success:!1,error:"沒有當前房間"}}async function X(){if(!e.currentRoom)return{success:!1,error:"沒有當前房間"};try{return a(),await e.updateRoomStatus("finished"),{success:!0}}catch(u){return console.error("結束遊戲錯誤:",u),{success:!1,error:u instanceof Error?u.message:"結束遊戲失敗"}}}async function we(){if(!d.value||!e.currentRoom)return{success:!1,error:"沒有當前輪次"};if(!W.value)return{success:!1,error:"只有畫家可以跳過詞語"};try{return a(),await re()}catch(u){return console.error("跳過詞語錯誤:",u),{success:!1,error:u instanceof Error?u.message:"跳過詞語失敗"}}}const ve=h(()=>{if(c.value===null)return"--:--";const u=Math.floor(c.value/60),T=c.value%60;return`${u.toString().padStart(2,"0")}:${T.toString().padStart(2,"0")}`});return he(()=>{a(),N(),A()}),{gameStatus:l,isPlaying:v,isWaiting:_,isFinished:q,currentRound:d,currentRoundNumber:D,totalRounds:s,drawTime:x,isCurrentDrawer:W,timeRemaining:c,isCountingDown:i,formattedTime:ve,roundStatus:t,isSelecting:r,isDrawing:n,isSummary:o,wordOptions:O,selectionTimeRemaining:S,summaryTimeRemaining:R,startGame:ge,startNextRound:re,startSelectionPhase:Y,selectWord:ee,endRound:te,continueToNextRound:ne,endGame:X,skipWord:we,startCountdown:g,stopCountdown:a,resetCountdown:y}}const ke={class:"waiting-lobby"},qe={class:"card"},De={class:"card-body"},Ne={class:"margin-bottom-medium"},Ge={class:"card-title text-hand-title"},Me={class:"text-small"},Oe={style:{"font-family":"monospace"}},Ce={class:"text-small margin-top-small"},Ie={class:"margin-bottom-medium"},We={class:"text-hand-title"},Ue={class:"margin-top-small"},je={style:{"flex-shrink":"0","margin-right":"0.75rem"}},Pe={class:"border",style:{width:"40px",height:"40px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","background-color":"var(--bg-card)","border-color":"var(--border-light)",color:"var(--text-primary)","font-weight":"bold"}},Be={style:{flex:"1"}},He={class:"text-hand",style:{"font-weight":"500"}},$e={key:0,class:"badge",style:{"background-color":"var(--color-warning)",color:"var(--text-primary)","font-size":"0.75rem",padding:"0.1rem 0.4rem","margin-left":"0.5rem"}},Ae={class:"margin-bottom-medium text-small"},Le=["disabled"],Fe={key:1,class:"text-small text-center margin-bottom-small"},Ke=["disabled"],Ve={key:0,class:"alert alert-danger margin-top-medium"},ze=_e({__name:"WaitingLobby",props:{room:{},participants:{}},emits:["startGame","leaveRoom"],setup(e,{emit:f}){const c=e,i=f,{isHost:w,canStartGame:S,leaveRoom:b,loading:R,error:m}=Se(),{startGame:l}=Te();function v(r){return{waiting:"等待中",playing:"遊戲中",finished:"已結束"}[r||""]||r||"未知"}function _(r){return c.room?.host_id===r}async function q(){(await l()).success&&i("startGame")}async function t(){(await b()).success&&i("leaveRoom")}return(r,n)=>(B(),P("div",ke,[E("div",qe,[E("div",De,[E("div",Ne,[E("h2",Ge,G(e.room?.name),1),E("div",Me,[n[0]||(n[0]=se(" 房間碼：",-1)),E("span",Oe,G(e.room?.code),1)]),E("div",Ce," 狀態："+G(v(e.room?.status)),1)]),E("div",Ie,[E("h4",We,"玩家列表 ("+G(e.participants.length)+")",1),E("div",Ue,[(B(!0),P(pe,null,Re(e.participants,o=>(B(),P("div",{key:o.id,class:"row flex-middle margin-bottom-small",style:{padding:"0.5rem",background:"var(--bg-secondary)","border-radius":"8px"}},[E("div",je,[E("div",Pe,G(o.nickname.charAt(0).toUpperCase()),1)]),E("div",Be,[E("div",He,[se(G(o.nickname)+" ",1),_(o.user_id)?(B(),P("span",$e," 房主 ")):Z("",!0)])])]))),128))])]),E("div",Ae,[E("div",null,"繪畫時間："+G(e.room?.settings.draw_time)+" 秒",1),E("div",null,"輪數："+G(e.room?.settings.rounds)+" 輪",1),E("div",null,"詞語總數："+G(e.room?.word_count)+" 個",1)]),E("div",null,[I(w)&&I(S)?(B(),P("button",{key:0,onClick:q,disabled:I(R),class:"paper-btn btn-primary btn-block margin-bottom-small"},G(I(R)?"開始中...":"開始遊戲"),9,Le)):I(w)?(B(),P("div",Fe," 至少需要 2 個玩家才能開始遊戲 ")):Z("",!0),E("button",{onClick:t,disabled:I(R),class:"paper-btn btn-secondary btn-block"},G(I(R)?"離開中...":"離開房間"),9,Ke)]),I(m)?(B(),P("div",Ve,G(I(m)),1)):Z("",!0)])])]))}}),Qe=ye(ze,[["__scopeId","data-v-769c8ad1"]]),U=new Map,j=k("disconnected"),H=new Map,J=new Set,Q=new Map;function F(...e){}function $(...e){console.warn("[Realtime]",...e)}function Xe(){const e=V(),f=fe();function c(t){const r=`room:${t}`;if(U.has(r))return U.get(r);const n=p.channel(r,{config:{presence:{key:"user"},broadcast:{self:!1}}});return U.set(r,n),n}function i(t){const r=Q.get(t);r&&(clearTimeout(r),Q.delete(t))}function w(t,r,n,o,d){t==="SUBSCRIBED"?(j.value="connected",i(n),r.track({user_id:o,...d}).catch(D=>{$("Presence track 失敗:",D)})):t==="CHANNEL_ERROR"||t==="TIMED_OUT"?(j.value="disconnected",$("訂閱失敗:",t),S(n,o,d)):t==="CLOSED"&&(j.value="disconnected")}function S(t,r,n,o=0){if(o>=3){$("重連失敗次數過多，停止重連");return}i(t);const d=Math.min(1e3*Math.pow(2,o),1e4),D=window.setTimeout(()=>{const s=U.get(`room:${t}`);s&&s.state!=="joined"&&s.subscribe(x=>{x==="SUBSCRIBED"?w(x,s,t,r,n):(x==="CHANNEL_ERROR"||x==="TIMED_OUT")&&S(t,r,n,o+1)})},d);Q.set(t,D)}function b(t,r,n,o){if(!t||!r){$("缺少 roomCode 或 roomId");return}const d=c(t),D=d.state;return D==="joined"?(j.value="connected",d):D==="joining"?d:J.has(t)?(j.value="connecting",d.subscribe(s=>{w(s,d,t,n,o)}),d):(d.on("postgres_changes",{event:"*",schema:"public",table:"game_rooms",filter:`id=eq.${r}`},async s=>{F("房間狀態變化:",s.eventType),e.currentRoom&&await e.loadRoom(e.currentRoom.id)}).on("postgres_changes",{event:"*",schema:"public",table:"room_participants",filter:`room_id=eq.${r}`},async s=>{F("參與者變化:",s.eventType),await e.loadParticipants(r)}).on("postgres_changes",{event:"*",schema:"public",table:"game_rounds",filter:`room_id=eq.${r}`},async s=>{F("輪次變化:",s.eventType),e.currentRoom&&await f.loadCurrentRound(e.currentRoom.id)}).on("broadcast",{event:"drawing"},s=>{const x=H.get(t);x&&s.payload?.stroke&&x.forEach(O=>O(s.payload.stroke))}).on("presence",{event:"sync"},()=>{const s=d.presenceState();F("Presence 同步，在線:",Object.keys(s).length)}),J.add(t),j.value="connecting",d.subscribe(s=>{w(s,d,t,n,o)}),d)}function R(t,r){return H.has(t)||H.set(t,new Set),H.get(t).add(r),()=>{H.get(t)?.delete(r)}}function m(t,r){const n=c(t),o=`guesses:${r}`;return n[o]||(n.on("postgres_changes",{event:"INSERT",schema:"public",table:"guesses",filter:`round_id=eq.${r}`},async d=>{F("猜測記錄變化:",d.eventType),await f.loadGuesses(r)}),n[o]=!0),n}async function l(t,r){const n=c(t),o=n.state;if(o!=="joined")return $("Channel 未連接，狀態:",o),{error:"Channel 未連接"};try{const d=await n.send({type:"broadcast",event:"drawing",payload:{stroke:r}});return d==="error"?($("發送失敗"),{error:"發送失敗"}):d}catch(d){return $("發送錯誤:",d),{error:d instanceof Error?d.message:"發送失敗"}}}function v(t){const r=`room:${t}`,n=U.get(r);i(t),n&&(p.removeChannel(n),U.delete(r)),H.delete(t),J.delete(t)}function _(){Q.forEach((t,r)=>i(r)),U.forEach(t=>p.removeChannel(t)),U.clear(),H.clear(),J.clear()}function q(){return j.value}return{connectionStatus:j,subscribeRoom:b,subscribeDrawing:R,subscribeGuesses:m,sendDrawing:l,unsubscribeRoom:v,unsubscribeAll:_,getConnectionStatus:q}}export{Qe as W,Te as a,Xe as b,V as c,fe as d,be as e,Se as u};
