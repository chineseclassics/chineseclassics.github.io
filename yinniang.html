<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš±å¨˜ï½œæ–‡å­—RPG</title>
    <meta name="description" content="éš±å¨˜ï¼šæ–‡å­—RPGï¼‹äº’å‹•å¼æ•…äº‹ï¼‹å“æ ¼ä¿®é¤Šã€‚é«”é©—è¶éš±å¨˜åœ¨ç¾ˆçµ†èˆ‡è¶…è„«ä¹‹é–“çš„æŠ‰æ“‡ã€‚">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        ink: '#111827',
                        paper: '#FAFAFA',
                    }
                },
                fontFamily: {
                    sans: ['Noto Sans TC','ui-sans-serif','system-ui']
                }
            },
            darkMode: false
        }
    </script>
    <style>
        .story-text { white-space: pre-wrap; line-height: 1.9; }
        .soft-card { box-shadow: 0 10px 25px rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.05); }
        .meter { height: 10px; background: #ECECF6; border-radius: 9999px; overflow: hidden; }
        .meter > span { display:block; height: 100%; background: linear-gradient(90deg, #6366f1, #5D5CDE); }
        .chip { font-size: 12px; padding: 2px 8px; border-radius: 9999px; background: rgba(93,92,222,.12); color: #4F46E5; }
        .fade-in { animation: fadein .3s ease; }
        @keyframes fadein { from {opacity: 0; transform: translateY(4px);} to {opacity:1; transform: none;} }
        .choice-btn:hover{ transform: translateY(-2px); }
        .grid-auto { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .75rem; }
        @media (min-width: 1024px){ .grid-auto{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .voices-box { border-left: 3px solid #5D5CDE; background: #F6F7FF; border-radius: 12px; padding: 10px 12px; }
        .voice-line { font-size: 14px; color: #374151; margin: 4px 0; }
        .debate-pill { border:1px solid #E5E7EB; border-radius:12px; padding:10px 12px; cursor:pointer; background:#fff; transition:all .2s ease; }
        .debate-pill:hover { border-color:#5D5CDE; box-shadow:0 4px 10px rgba(93,92,222,0.15); transform: translateY(-1px); }
        .debate-selected { border-color:#5D5CDE; background:rgba(93,92,222,0.08); }
        .opt-voice { display:flex; align-items:center; gap:8px; font-size:13px; color:#374151; margin-bottom:6px; }
        .opt-voice .icon { font-size:16px; }
        .opt-quote { font-size:12px; color:#6B7280; }
        .opt-check { font-size:11px; padding:2px 6px; border-radius:9999px; background:#EEF2FF; color:#3730A3; display:inline-block; margin-top:6px; }
        .opt-check.red { background:#FEE2E2; color:#991B1B; }
        .skip-typing { position: relative; display:inline-flex; align-items:center; gap:6px; padding:4px 10px; font-size:12px; border-radius:8px; background:#EEF2FF; color:#3730A3; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-white text-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-6 lg:py-8">
        <header class="mb-4 lg:mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-indigo-500 flex items-center justify-center text-white text-xl">å¿</div>
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold tracking-wide">éš±å¨˜</h1>
                    <p class="text-sm text-gray-500">æ–‡å­—RPGï½œæ€æƒ³å…§é–£ Ã— å…«å¾·ä¸€æ™º</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnSave" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm">ä¿å­˜</button>
                <button id="btnShare" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm">æ–°æ¨™ç±¤é–‹å•Ÿ</button>
                <button id="btnReset" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm">é‡æ–°é–‹å§‹</button>
                <button id="btnHelp" class="px-3 py-2 rounded-lg bg-primary text-white text-sm">ç©æ³•èªªæ˜</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
            <!-- å·¦ï¼šä¸»æ•…äº‹ -->
            <section class="lg:col-span-2 p-4 lg:p-6 rounded-2xl bg-white soft-card">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span id="chapterChip" class="chip">ç¬¬ä¸€ç« ï¼šåˆå¿ƒä¹‹å•</span>
                        <span class="text-sm text-gray-500" id="chapterMeta">å¹´é½¡ï¼š10æ­²ï½œå ´æ™¯ 1</span>
                    </div>
                    <div class="text-sm text-gray-500" id="statusHint">è«‹é–±è®€æƒ…ç¯€ä¸¦é¸æ“‡</div>
                </div>

                <article id="storyContent" class="story-text text-[15.5px] leading-8"></article>

                <div id="choiceArea" class="mt-4 grid-auto"></div>
            </section>

            <!-- å³ï¼šæ•¸å€¼é¢æ¿ -->
            <aside class="space-y-4">
                <div class="p-4 rounded-2xl bg-white soft-card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold">æ€æƒ³å…§é–£</h3>
                        <span class="text-xs text-gray-500">äº”é‡å…§å¿ƒè²éŸ³</span>
                    </div>
                    <div id="voicesPanel" class="space-y-3"></div>
                </div>

                <div class="p-4 rounded-2xl bg-white soft-card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold">å…«å¾·ä¸€æ™º</h3>
                        <span class="text-xs text-gray-500">å“æ ¼ä¿®é¤Š</span>
                    </div>
                    <div id="virtuesPanel" class="space-y-3"></div>
                </div>

                <div class="p-4 rounded-2xl bg-white soft-card">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold">è©å½™ç­†è¨˜</h3>
                        <span class="text-xs text-gray-500">å·²å­¸è©å½™</span>
                    </div>
                    <div id="wordsPanel" class="text-sm text-gray-700">ï¼ˆæš«ç„¡ï¼‰</div>
                </div>
            </aside>
        </main>
    </div>

    <script>
    // --- éŠæˆ²ç‹€æ…‹ ---
    const gameState = {
        chapter: 1,
        scene: 'scene1',
        voices: {
            filialPiety: 30,    // å­å¥³ä¹‹å¿ƒ
            masterTraining: 40, // å¸«é–€ä¹‹è¨“
            tenderness: 20,     // æŸ”æƒ…ä¹‹æ„
            loyalty: 10,        // å¿ ç¾©ä¹‹å¿µ
            seekingDao: 15      // å±±æ°´æ±‚é“
        },
        virtues: {
            loyalty: 30,        // å¿ 
            filialPiety: 40,    // å­
            benevolence: 20,    // ä»
            love: 25,           // æ„›
            propriety: 35,      // ç¦®
            righteousness: 30,  // ç¾©
            harmony: 40,        // å’Œ
            peace: 35,          // å¹³
            wisdom: 30          // æ™º
        },
        relationships: { father: 50, husband: 0, liuChangyi: 0, weiShuai: 30 },
        learnedWords: [],
        unlockedEndings: [],
        achievements: [],
        flags: {}
    };

    // è²éŸ³â†’å“æ ¼ é—œè¯è¡¨ï¼ˆç°¡åŒ–ç‰ˆï¼‰
    const voiceVirtueMap = {
        filialPiety: { primary: ['filialPiety'], secondary: ['propriety'] },
        masterTraining: { primary: ['propriety'], secondary: ['righteousness'] },
        tenderness: { primary: ['love'], secondary: ['benevolence'] },
        loyalty: { primary: ['loyalty'], secondary: ['righteousness'] },
        seekingDao: { primary: ['peace'], secondary: ['wisdom','harmony'] },
    };

    // ç«‹å ´/å¿ƒæ³•å…ƒæ•¸æ“š
    const voiceMeta = {
        filialPiety: { icon:'ğŸ’', name:'å­å¥³ä¹‹å¿ƒ', quotes:['çˆ¶è¦ªæ¶•æ³£åœ¨å…ˆï¼Œè±ˆå¯å†æ†‚ï¼Ÿ','è¶æ°é–€ç¬¬ä¸å¯å¢œã€‚'] },
        masterTraining: { icon:'âš¡', name:'å¸«é–€ä¹‹è¨“', quotes:['æƒ…æ„Ÿåªæœƒå½±éŸ¿åˆ€çš„æº–ç¢ºæ€§ã€‚','æ”¶æŸå¿ƒçŒ¿ï¼Œä¸€å¿µåˆ°åº•ã€‚'] },
        tenderness: { icon:'ğŸ’•', name:'æŸ”æƒ…ä¹‹æ„', quotes:['è‹¥èƒ½å®ˆä»–ä¸€ç›ç‡ˆç«ï¼Œä¹Ÿå¥½ã€‚','ä»–ä¹Ÿæœƒé€—å­©å­ç¬‘â€¦â€¦'] },
        loyalty: { icon:'âš”ï¸', name:'å¿ ç¾©ä¹‹å¿µ', quotes:['äººå„è¦ªå…¶ä¸»ï¼Œæ—¢å—å…¶è¨—ä¾¿ç›¡è²¬ã€‚','æ¨èº«è­·ä¸»ï¼Œç¾©æ‰€ç•¶ç„¶ã€‚'] },
        seekingDao: { icon:'ğŸŒŠ', name:'å±±æ°´æ±‚é“', quotes:['ç·£èµ·ç·£æ»…ï¼Œä½•å¦¨å°‹å±±æ°´ï¼Ÿ','è§€ä¸€æ¯ä¹‹é–“ä¹‹ç©ºã€‚'] }
    };

    let selectedVoice = null;          // æœ¬å›åˆç«‹å ´
    const voiceTempBonus = 10;         // æœ¬å›åˆè‡¨æ™‚åŠ æˆ
    gameState.unlockedThoughts = gameState.unlockedThoughts || [];
    gameState.equippedThoughts = gameState.equippedThoughts || [];
    const thoughtDefs = {
        bloodBond: { id:'bloodBond', name:'è¡€è„ˆç›¸é€£', effect:'+5 å­/ç¦® æª¢å®šï¼Œ-5 æ™º æª¢å®š', bonus:(type,kind)=> (type==='filialPiety'||type==='propriety')?5 : (type==='wisdom'?-5:0) },
        ruthlessBlade: { id:'ruthlessBlade', name:'ç„¡æƒ…åˆºæ®º', effect:'+10 ç´…æª¢ï¼Œ-5 ä» æª¢å®š', bonus:(type,kind)=> (kind==='red'?10:0) + (type==='benevolence'?-5:0) },
        heartsInTune: { id:'heartsInTune', name:'å¿ƒæ„ç›¸é€š', effect:'+5 æ„›/ä» æª¢å®šï¼Œ-5 ç¦® æª¢å®š', bonus:(type,kind)=> (type==='love'||type==='benevolence')?5 : (type==='propriety'?-5:0) },
        selflessGuard: { id:'selflessGuard', name:'æ¨èº«è­·ä¸»', effect:'+5 å¿ /ç¾© æª¢å®šï¼Œ-5 å¹³ æª¢å®š', bonus:(type,kind)=> (type==='loyalty'||type==='righteousness')?5 : (type==='peace'?-5:0) },
        beyondWorld: { id:'beyondWorld', name:'è¶…è„«å¡µç·£', effect:'+5 æ™º/å¹³ æª¢å®šï¼Œ-5 å¿ /å­ æª¢å®š', bonus:(type,kind)=> (type==='wisdom'||type==='peace')?5 : ((type==='loyalty'||type==='filialPiety')?-5:0) }
    };

    function ensureThoughtModal(){
        if(document.getElementById('thoughtModal')) return;
        const wrap = document.createElement('div');
        wrap.id = 'thoughtModal';
        wrap.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden';
        wrap.innerHTML = `
            <div class="max-w-3xl w-full rounded-2xl bg-white p-6 soft-card">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xl font-bold">å¿ƒæ³•ï¼ˆæ€ç¶­å¡ï¼‰</h3>
                    <button id="btnCloseThought" class="px-3 py-1 rounded bg-gray-100">é—œé–‰</button>
                </div>
                <div class="text-sm text-gray-600 mb-3">å¯è£å‚™ 2 å¼µã€‚å·²è£å‚™ï¼š<span id="thoughtEquippedCount">0</span>/2</div>
                <div id="thoughtList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                <div class="mt-4 flex items-center justify-end gap-2">
                    <button id="btnClearThoughts" class="px-4 py-2 rounded bg-gray-100">æ¸…ç©ºè£å‚™</button>
                    <button id="btnSaveThoughts" class="px-4 py-2 rounded bg-primary text-white">ä¿å­˜é…ç½®</button>
                </div>
            </div>`;
        document.body.appendChild(wrap);
        document.getElementById('btnCloseThought').onclick = ()=> wrap.classList.add('hidden');
        document.getElementById('btnClearThoughts').onclick = ()=> { gameState.equippedThoughts = []; renderThoughtModal(); };
        document.getElementById('btnSaveThoughts').onclick = ()=> wrap.classList.add('hidden');
    }

    function openThoughtModal(){ ensureThoughtModal(); renderThoughtModal(); document.getElementById('thoughtModal').classList.remove('hidden'); }

    function renderThoughtModal(){
        const list = document.getElementById('thoughtList');
        const cnt = document.getElementById('thoughtEquippedCount');
        if(!list || !cnt) return;
        cnt.textContent = (gameState.equippedThoughts||[]).length;
        const all = (gameState.unlockedThoughts && gameState.unlockedThoughts.length>0) ? gameState.unlockedThoughts : Object.keys(thoughtDefs);
        list.innerHTML = all.map(id => {
            const t = thoughtDefs[id];
            const equipped = (gameState.equippedThoughts||[]).includes(id);
            return `<div class="p-3 border rounded-xl ${equipped?'border-primary bg-primary/5':''}">
                        <div class="font-semibold">${t.name}</div>
                        <div class="text-xs text-gray-600 mb-2">${t.effect}</div>
                        <button data-id="${id}" class="px-3 py-1 rounded ${equipped?'bg-gray-200':'bg-primary text-white'}">
                            ${equipped?'å·²è£å‚™':'è£å‚™'}
                        </button>
                    </div>`; 
        }).join('');
        // ç¶å®šæŒ‰éˆ•
        list.querySelectorAll('button[data-id]').forEach(btn => {
            btn.onclick = ()=>{
                const id = btn.getAttribute('data-id');
                const idx = (gameState.equippedThoughts||[]).indexOf(id);
                if(idx>=0){ gameState.equippedThoughts.splice(idx,1); }
                else {
                    if((gameState.equippedThoughts||[]).length>=2){ alert('æœ€å¤šè£å‚™ 2 å¼µå¿ƒæ³•'); return; }
                    gameState.equippedThoughts.push(id);
                }
                renderThoughtModal();
            };
        });
    }

    function evaluateThoughtUnlocksAtChapterEnd(){
        // æ•™å­¸ç›®çš„ï¼šå…ˆç°¡åŒ–ç‚ºç« æœ«è´ˆé€2å¼µç¤ºä¾‹å¡
        const newly = [];
        if(gameState.chapter === 2){
            ['ruthlessBlade','heartsInTune'].forEach(id=>{
                if(!gameState.unlockedThoughts.includes(id)){ gameState.unlockedThoughts.push(id); newly.push(id); }
            });
        }
        if(gameState.chapter === 5){
            ['selflessGuard','beyondWorld'].forEach(id=>{
                if(!gameState.unlockedThoughts.includes(id)){ gameState.unlockedThoughts.push(id); newly.push(id); }
            });
        }
        return newly;
    }

    async function renderTypingForVoicesBox(){
        // æ‰¾åˆ°å·²æ¸²æŸ“çš„ voices-box
        const voicesBox = storyContent.querySelector('.voices-box');
        if(!voicesBox) return;
        
        // ç²å–æ‰€æœ‰ voice-line
        const voiceLines = Array.from(voicesBox.querySelectorAll('.voice-line'));
        if(!voiceLines.length) return;
        
        // éš±è—åŸæœ‰å…§å®¹ï¼Œæº–å‚™æ‰“å­—æ©Ÿæ•ˆæœ
        voiceLines.forEach(line => {
            line.style.opacity = '0';
            line.style.visibility = 'hidden';
        });
        
        // æ·»åŠ è·³éæŒ‰éˆ•
        const skipBtn = document.createElement('button');
        skipBtn.className = 'skip-typing float-right mb-2';
        skipBtn.innerHTML = 'â­ï¸ ç•¥éå…§å¿ƒè¾¯è«–';
        skipBtn.onclick = () => {
            // ç«‹å³é¡¯ç¤ºæ‰€æœ‰è²éŸ³
            voiceLines.forEach(line => {
                line.style.opacity = '1';
                line.style.visibility = 'visible';
            });
            skipBtn.style.display = 'none';
            // 1ç§’å¾Œé¡¯ç¤ºé¸é …
            setTimeout(() => {
                const scene = scenes[gameState.scene];
                if(scene && scene.choices) renderChoicesForScene(scene);
            }, 500);
        };
        voicesBox.parentNode.insertBefore(skipBtn, voicesBox);
        
        // é€æ¢æ‰“å­—é¡¯ç¤º
        let totalDelay = 0;
        for(let i = 0; i < voiceLines.length; i++){
            const originalLine = voiceLines[i];
            const originalText = originalLine.textContent;
            
            setTimeout(() => {
                if(skipBtn.style.display === 'none') return; // å·²è·³é
                
                // é¡¯ç¤ºé€™ä¸€è¡Œä¸¦é–‹å§‹æ‰“å­—
                originalLine.style.visibility = 'visible';
                originalLine.style.opacity = '1';
                originalLine.textContent = ''; // æ¸…ç©ºæ–‡æœ¬
                
                // æ‰“å­—æ•ˆæœ
                let charIndex = 0;
                const typeInterval = setInterval(() => {
                    if(charIndex < originalText.length){
                        originalLine.textContent += originalText[charIndex];
                        charIndex++;
                    } else {
                        clearInterval(typeInterval);
                    }
                }, 60); // æ¯å­—60ms
                
            }, totalDelay);
            
            totalDelay += 300 + (originalText.length * 60); // é–“éš”300ms + æ‰“å­—æ™‚é–“
        }
        
        // æ‰€æœ‰è²éŸ³æ’­æ”¾å®Œç•¢å¾Œï¼Œéš±è—è·³éæŒ‰éˆ•ä¸¦é¡¯ç¤ºé¸é …
        setTimeout(() => {
            if(skipBtn.style.display !== 'none'){
                skipBtn.style.display = 'none';
                const scene = scenes[gameState.scene];
                if(scene && scene.choices) renderChoicesForScene(scene);
            }
        }, totalDelay + 500);
    }

    function renderChoicesForScene(scene) {
        if (!scene.choices) return;
        
        // ç›´æ¥ä½¿ç”¨ choiceAreaï¼Œå®ƒå·²ç¶“æœ‰ grid-auto é¡
        Object.entries(scene.choices).forEach(([key, c]) => {
            const available = isChoiceAvailable(c);
            const btn = document.createElement('button');
            btn.className = 'choice-btn fade-in text-left p-3 rounded-xl border bg-white text-[14px]';
            
            if(available){
                btn.classList.add('border-gray-200','hover:border-primary/60','hover:shadow-md');
                const checkPill = c.check ? `<span class="opt-check ${c.check.kind==='red'?'red':''}">${c.check.title||'æª¢å®š'} DC${c.check.dc||55}</span>` : '';
                const checkRow = c.check ? `<div class="mt-1 text-right">${checkPill}</div>` : '';
                // åªé¡¯ç¤ºè¡Œå‹•æ¨™é¡Œï¼Œä¸é¡¯ç¤ºå…§å¿ƒè²éŸ³æ¨™ç±¤
                btn.innerHTML = `<div class="font-medium">${c.label}</div>${checkRow}`;
                
                btn.onclick = () => {
                    selectedVoice = c.voice || null; // å…§éƒ¨é‚è¼¯ä»ä½¿ç”¨voice
                    if(c.check){
                        const res = computeSimpleCheck(c.check);
                        const tip = document.createElement('div');
                        tip.className = 'mt-2 text-xs text-gray-500';
                        tip.textContent = `${c.check.title||'æª¢å®š'}ï¼š${res.success?'é€šé':'æœªé€šé'}ï¼ˆç¸½åˆ† ${res.total} / éœ€æ±‚ ${res.dc}ï¼Œé¡å‹ ${res.kind==='red'?'ç´…æª¢':'ç™½æª¢'}ï¼‰`;
                        storyContent.appendChild(tip);
                    }
                    applyChoice(key);
                    selectedVoice = null;
                };
            } else {
                btn.classList.add('border-dashed','border-gray-300','text-gray-400','cursor-not-allowed');
                const hint = c.lockedHint ? ` <span class="text-xs">ï¼ˆ${c.lockedHint}ï¼‰</span>` : ' <span class="text-xs">ï¼ˆæœªè§£é–ï¼‰</span>';
                btn.innerHTML = `<div class="font-medium mb-1">${c.label}${hint}</div>`;
                btn.disabled = true;
                btn.setAttribute('aria-disabled','true');
            }
            choiceArea.appendChild(btn);
        });
    }

    function computeSimpleCheck(check){
        if(!check) return { result:'ç•¥é' };
        const virtueVal = clamp(gameState.virtues[check.type] || 0);
        const voiceBonus = selectedVoice ? voiceTempBonus : 0;
        let thoughtBonus = 0;
        (gameState.equippedThoughts||[]).forEach(id=>{
            const th = thoughtDefs[id];
            if(th && typeof th.bonus === 'function') thoughtBonus += th.bonus(check.type, check.kind);
        });
        const total = virtueVal + voiceBonus + thoughtBonus;
        const success = total >= (check.dc||55);
        return { success, total, dc: check.dc||55, kind: check.kind||'white' };
    }

    const chapterTitles = {
        1: 'ç¬¬ä¸€ç« ï¼šåˆå¿ƒä¹‹å•',
        2: 'ç¬¬äºŒç« ï¼šå¸«é–€å¡‘é€ ',
        3: 'ç¬¬ä¸‰ç« ï¼šè¦ªæƒ…å›æ­¸',
        4: 'ç¬¬å››ç« ï¼šä¸–ä¿—æ·é–',
        5: 'ç¬¬äº”ç« ï¼šå¿ èª è€ƒé©—',
        6: 'ç¬¬å…­ç« ï¼šè­·ä¸»æ±ºæˆ°',
        7: 'ç¬¬ä¸ƒç« ï¼šçµ‚æ¥µé¸æ“‡'
    };

    // ç« ç¯€èˆ‡é¸é …ï¼ˆä¸ƒç« ç²¾ç°¡ä¸»ç·šï¼‰
    const scenes = {
        scene1: {
            title: 'åˆå¿ƒä¹‹å•',
            markdown: `ä½ å¹´åƒ…åæ­²ï¼Œèˆ‡çˆ¶è¦ªè¶é‹’å±…æ–¼é­åšã€‚åˆåå¾®é¢¨è‡ªå¸‚è‚†ç©¿å ‚è€Œå…¥ï¼Œç°·éˆé¢¨éˆ´æ¸…è„†ã€‚\n\nä¸€åé¢å®¹å†·æ·¡çš„å°¼å§‘ç«‹æ–¼é–€æª»ä¹‹å¤–ï¼Œè¡£è¥Ÿç´ ç™½å¦‚éœœï¼Œçœ¼ç¥å»å¦‚åˆ€ï¼Œç›´ç›´ç©¿éä½ èˆ‡çˆ¶è¦ªä¹‹é–“ã€‚å¥¹è¨€è¾­ä¸å¤šï¼Œåªé“ï¼šã€æ­¤å¥³éª¨ç›¸æ¸…å³»ï¼Œå¯æˆå™¨ã€‚å€Ÿå»ä¸‰äº”è¼‰ï¼Œæ•™å·²æˆã€‚ã€\n\nçˆ¶è¦ªæ²‰é»˜ï¼ŒæŒ‡ç¯€åœ¨æ¡ˆå‡ ä¸Šè¼•å©ï¼Œåƒæ˜¯æ”€ç·£å¿ƒäº‹è€Œä¸å¾—è‘—åŠ›ã€‚ä½ ä¸çŸ¥é€™ä¸€å©æœƒæ±ºå®šå¹¾å¤šå‘½é‹çš„éš™ã€‚\n\nå°±åœ¨é€™çŸ­çŸ­ä¸€ç¬ï¼Œä¸‰ç¨®å…§å¿ƒçš„è²éŸ³ç›¸ç¹¼æµ®ç¾ï¼š\n\n<div class=\"voices-box\">\n<div class=\"voice-line\">ğŸ’ å­å¥³ä¹‹å¿ƒï¼šã€çˆ¶è¦ªæ¶•æ³£åœ¨å…ˆï¼Œå¥³å…’è±ˆå¯ä½¿å…¶æ›´æ†‚ï¼Ÿã€</div>\n<div class=\"voice-line\">ğŸ’• æŸ”æƒ…ä¹‹æ„ï¼šã€è‹¥èƒ½ç•™åœ¨èº«é‚Šï¼Œå®ˆä»–ä¸€ç›ç‡ˆç«ï¼Œä¹Ÿå¥½ã€‚ã€</div>\n<div class=\"voice-line\">ğŸŒŠ å±±æ°´æ±‚é“ï¼šã€ç·£èµ·ç·£æ»…ï¼Œä½•å¦¨è‡ªæ­¤å°‹å±±æ°´ï¼Ÿã€</div>\n</div>\n\nä½ æœƒå¦‚ä½•é¸æ“‡ï¼Ÿ`,
            choices: {
                A: {
                    label: 'é¸æ“‡Aã€æ¥å—çˆ¶æ¬Šã€‘ï¼šã€Œçˆ¶è¦ªèªªä»€éº¼å°±æ˜¯ä»€éº¼ï¼Œå¥³å…’æ‡‰è©²è½è©±ã€',
                    voiceChanges: { filialPiety: +40, seekingDao: -10 },
                    virtueChanges: { filialPiety: +10, propriety: +8 },
                    relationshipChanges: { father: +20 },
                    unlockedWords: ['æ‚…ä¹‹','å±'],
                    virtueCheck: { type: 'filialPiety', difficulty: 30, successBonus: { filialPiety: +2 }, failurePenalty: { filialPiety: -1 } },
                    setFlags: { obeyFatherAtStart: true },
                    next: 'scene1_resultA'
                },
                B: {
                    label: 'é¸æ“‡Bã€å¥½å¥‡å¤–ç•Œã€‘ï¼šã€Œæˆ‘æƒ³çŸ¥é“å¤–é¢çš„ä¸–ç•Œæ˜¯ä»€éº¼æ¨£å­ã€',
                    voiceChanges: { seekingDao: +30, filialPiety: -10 },
                    virtueChanges: { wisdom: +8, peace: +5, harmony: +3, filialPiety: -8, propriety: -5 },
                    relationshipChanges: { father: -10 },
                    unlockedWords: ['é©šé§­','å½±éŸ¿'],
                    virtueCheck: { type: 'wisdom', difficulty: 25, successBonus: { wisdom: +3, peace: +2 }, failurePenalty: { wisdom: -2 } },
                    setFlags: { curiousWorld: true },
                    next: 'scene1_resultB'
                },
                C: {
                    label: 'é¸æ“‡Cã€è¢«å‹•æ¥å—ã€‘ï¼šã€Œæˆ‘ä¸çŸ¥é“...éš¨ä¾¿å§ã€',
                    voiceChanges: {},
                    virtueChanges: { harmony: +5, peace: +3, wisdom: -3 },
                    relationshipChanges: {},
                    unlockedWords: [],
                    next: 'scene1_resultC'
                }
            }
        },
        scene1_resultA: {
            title: 'å›æ‡‰çˆ¶è¦ª',
            markdown: `ä½ ä½é ­æ‡‰å…ï¼Œçˆ¶è¦ªé¬†äº†å£æ°£ã€‚å°¼å§‘å†·å†·é»é ­ã€‚\n\nä½ æ„Ÿåˆ°ä¸€è‚¡æ²‰ç”¸ç”¸çš„è²¬ä»»è½å›è‚©ä¸Šã€‚`,
            endOfChapter: true,
            nextChapter: 'scene2_1'
        },
        scene1_resultB: {
            title: 'æœ›å‘é æ–¹',
            markdown: `ä½ æœ›å‘é–€å¤–çš„é•·è¡—ï¼Œå¾®é¢¨æ‹‚é¢ã€‚çˆ¶è¦ªçš„çœ‰é ­æ›´æ·±ï¼Œä½†ä½ çŸ¥é“ï¼Œå¥½å¥‡å·²åœ¨å¿ƒä¸­ç”Ÿæ ¹ã€‚`,
            endOfChapter: true,
            nextChapter: 'scene2_1'
        },
        scene1_resultC: {
            title: 'éš¨æ³¢é€æµ',
            markdown: `ä½ æ²’æœ‰æ˜ç¢ºè¡¨æ…‹ï¼Œä»»ç”±å¤§äººå€‘æ±ºå®šã€‚é‚£ä¸€åˆ»ï¼Œä½ çš„å¿ƒåƒè¢«æ°´éœ§è£¹ä½ï¼Œç„¡æ‚²ç„¡å–œã€‚`,
            endOfChapter: true,
            nextChapter: 'scene2_1'
        },

        // ç¬¬äºŒç« ï¼šå¸«é–€å¡‘é€ 
        scene2_1: {
            title: 'æ—¥å¸¸ä¿®ç·´ä¸­çš„è‡ªæˆ‘åæ€',
            markdown: `å¸«é–€è¨“ç·´åš´è‹›ã€‚ç™½çŸ³å ´åœ°é¢¨è²å¦‚åˆƒï¼Œæœ¨äººæ¨ä¸Šåˆ€ç—•äº¤éŒ¯ã€‚ä½ æ¡åˆ€ç«‹å®šï¼Œè‡‚è†€å› é•·æ—¥æ®æ–«è€Œå¾®é¡«ã€‚å¸«çˆ¶æ­¥å±¥ç„¡è²ï¼Œçœ¼ç¥è½åœ¨ä½ æŒ‡è™ä¹‹é–“çš„æ±—ç ä¸Šã€‚\n\nä½ å¿½è€Œæ€å¿–ï¼šæˆ‘ç©¶ç«Ÿåœ¨æˆç‚ºä»€éº¼ï¼Ÿæ˜¯å¥¹æ‰‹ä¸­çš„å™¨ï¼Œé‚„æ˜¯è‡ªæˆ‘ä¹‹ä¸»ï¼Ÿ\n\n<div class=\"voices-box\">\n<div class=\"voice-line\">âš¡ å¸«é–€ä¹‹è¨“ï¼šã€æ”¶æŸå¿ƒçŒ¿ï¼Œåˆ€é ˆä¸€å¿µåˆ°åº•ã€‚ã€</div>\n<div class=\"voice-line\">ğŸŒŠ å±±æ°´æ±‚é“ï¼šã€ä¸€å¿µåˆ°åº•è€…ï¼Œæˆ–ç‚ºåŸ·ã€‚ä½•ä¸è§€ä¸€æ¯ä¹‹é–“çš„ç©ºï¼Ÿã€</div>\n<div class=\"voice-line\">ğŸ’• æŸ”æƒ…ä¹‹æ„ï¼šã€æŒ‡ç¯€æ³›ç™½äº†ï¼Œç–¼ã€‚å¯ä»¥æ…¢ä¸€äº›å—ï¼Ÿã€</div>\n</div>`,
            choices: {
                A: {
                    label: 'ã€å®Œå…¨é †å¾ã€‘ï¼šã€Œå¸«çˆ¶çš„è©±å°±æ˜¯çœŸç†ã€',
                    voiceChanges: { masterTraining: +35, seekingDao: -15 },
                    virtueChanges: { loyalty: +8, propriety: +5, benevolence: -10, wisdom: -8 },
                    unlockedWords: ['æ•™å·²æˆ'],
                    setFlags: { absoluteObedience: true },
                    next: 'scene2_2'
                },
                B: {
                    label: 'ã€æš—ä¸­è³ªç–‘ã€‘ï¼šã€Œæ®ºæˆ®çœŸçš„æ˜¯å”¯ä¸€çš„æ–¹æ³•å—ï¼Ÿã€',
                    voiceChanges: { seekingDao: +25, masterTraining: -10 },
                    virtueChanges: { wisdom: +10, benevolence: +8, righteousness: +5, loyalty: -5 },
                    unlockedWords: ['æ‡‡è©°'],
                    setFlags: { questionedDoctrine: true },
                    next: 'scene2_2'
                }
            }
        },
        scene2_2: {
            title: 'é¦–æ¬¡æ®ºäººä»»å‹™',
            markdown: `ä½ æ¥åˆ°é¦–æ¬¡æ¸…é™¤ç›®æ¨™çš„ä»»å‹™ã€‚é»ƒæ˜çš„å¸‚é›†äººè²é¼æ²¸ï¼Œç°¾å½±æ–‘é§ã€‚ç›®æ¨™æ”œä¸€å¹¼å…’æ–¼å¸‚ä¸­å¬‰æˆ²ï¼Œå­©ç«¥ä¼åœ¨å…¶è‚©ï¼Œç¬‘è²ç©¿éäººç¾¤ã€‚ä½ çš„æŒ‡å°–ä¸€å†·ï¼Œåˆ€é˜å¾®é³´ã€‚\n\n<div class=\"voices-box\">\n<div class=\"voice-line\">ğŸ’• æŸ”æƒ…ä¹‹æ„ï¼šã€ä»–ä¹Ÿæœƒé€—å­©å­ç¬‘â€¦â€¦ã€</div>\n<div class=\"voice-line\">âš¡ å¸«é–€ä¹‹è¨“ï¼šã€å…ˆæ–·å…¶æ‰€æ„›ï¼Œç„¶å¾Œæ±ºä¹‹ã€‚ã€</div>\n<div class=\"voice-line\">ğŸŒŠ å±±æ°´æ±‚é“ï¼šã€å–„æƒ¡å› æœï¼Œç•¶ç´°æ€é‡ã€‚ã€</div>\n</div>`,
            choices: {
                A: {
                    label: 'ã€æ©Ÿæ¢°åŸ·è¡Œã€‘ï¼šã€Œä¸å»æƒ³ï¼Œåªè¦å®Œæˆä»»å‹™ã€',
                    voice: 'masterTraining',
                    voiceChanges: { masterTraining: +30, seekingDao: -20 },
                    virtueChanges: { loyalty: +5, benevolence: -15, love: -10, peace: -8 },
                    unlockedWords: ['æŒˆ','éƒ½å¸‚'],
                    setFlags: { firstKill: true },
                    next: 'scene2_end'
                },
                B: {
                    label: 'ã€æ€è€ƒæ­£ç¾©ã€‘ï¼šã€Œç†è§£ç‚ºä½•è¦æ®ºæ­¤äººã€',
                    voice: 'seekingDao',
                    voiceChanges: { seekingDao: +30, masterTraining: -5 },
                    virtueChanges: { wisdom: +12, righteousness: +10, benevolence: +5, loyalty: +3 },
                    unlockedWords: ['æ±º','ä¸­'],
                    setFlags: { investigatedTarget: true },
                    next: 'scene2_end',
                    nextIf: [
                        { cond: { flags: { investigatedTarget: true } }, to: 'scene2_end_investigate' }
                    ]
                },
                C: {
                    label: 'ã€æƒ…æ„Ÿæ™æ‰ã€‘ï¼šã€Œè¦‹å…¶èˆ‡å­æˆ²ï¼Œä¸å¿ä¸‹æ‰‹ã€',
                    voice: 'tenderness',
                    voiceChanges: { tenderness: +20, masterTraining: +10 },
                    virtueChanges: { benevolence: +15, love: +10, loyalty: -8, righteousness: -5 },
                    unlockedWords: ['æ¶•æ³£'],
                    setFlags: { mercyShown: true },
                    next: 'scene2_end'
                }
            }
        },
        scene2_end: {
            title: 'äººæ ¼é‡æ§‹æœŸçš„é¤˜éŸ»',
            markdown: `ç„¡è«–çµæœå¦‚ä½•ï¼Œä½ çŸ¥é“è‡ªå·±å·²ä¸å†æ˜¯å¾å‰çš„ä½ ã€‚`,
            endOfChapter: true,
            nextChapter: 'scene3_1'
        },
        scene2_end_investigate: {
            title: 'çœŸç›¸çš„é‡é‡',
            markdown: `ä½ è¿½ç´¢ç›®æ¨™éå¾€ï¼Œç™¼ç¾å…¶ç¢ºæœ‰æƒ¡è·¡ï¼Œå»ä¹Ÿè¦‹åˆ°å…¶å°å¹¼å­çš„æº«æƒ…ã€‚æ­£ç¾©ä¸¦éé»‘ç™½åˆ†æ˜ï¼Œåƒéœ§ä¸­ä¹‹æ©‹ï¼Œæ—¢é€£æ¥ä¹Ÿé®è”½ã€‚é€™ä»½è¤‡é›œä»¤ä½ ä¹…ä¹…ä¸èƒ½é‡‹æ‡·ã€‚`,
            endOfChapter: true,
            nextChapter: 'scene3_1_alt'
        },

        // ç¬¬ä¸‰ç« ï¼šè¦ªæƒ…å›æ­¸
        scene3_1: {
            title: 'å°çˆ¶è¦ªçš„æ…‹åº¦',
            markdown: `æ­¸å®¶é‡è¦‹çˆ¶è¦ªï¼Œä½ å°‡å¦‚ä½•é¢å°ï¼Ÿ`,
            choices: {
                A: { label: 'ã€é‡å›å¥³å…’è§’è‰²ã€‘ï¼šã€Œæˆ‘é‚„æ˜¯çˆ¶è¦ªçš„ä¹–å¥³å…’ã€', voiceChanges: { filialPiety: +25, masterTraining: -10 }, virtueChanges: {}, relationshipChanges: { father: +15 }, unlockedWords: [], next: 'scene3_2' },
                B: { label: 'ã€ä¿æŒè·é›¢ã€‘ï¼šã€Œæˆ‘å·²ä¸æ˜¯ä»¥å‰çš„æˆ‘ã€', voiceChanges: { seekingDao: +30, filialPiety: -15 }, virtueChanges: {}, relationshipChanges: { father: -10 }, unlockedWords: [], next: 'scene3_2' }
            }
        },
        scene3_1_alt: {
            title: 'æ²‰é»˜ä¹‹ä¸‹',
            markdown: `ä½ çŸ¥é“è‡ªå·±æ›¾åœ¨è¡€èˆ‡ç†ä¹‹é–“åšäº†é¸æ“‡ã€‚é‡è¦‹çˆ¶è¦ªæ™‚ï¼Œä»–çš„çšºç´‹åƒæ²³åºŠè£‚ç¸«ï¼Œè—è‘—å¤šå¹´æœªèªªçš„è©±ã€‚ä½ æ˜¯å¦æ­é–‹é®è”½ï¼Ÿ`,
            choices: {
                A: { label: 'ã€ç›´é¢ã€‘å‘Šä¹‹æ‰€è¦‹èˆ‡æ‰€æ€', voiceChanges: { seekingDao: +15, filialPiety: -10 }, virtueChanges: { wisdom: +5 }, relationshipChanges: { father: -5 }, unlockedWords: [], next: 'scene3_2' },
                B: { label: 'ã€éš±å¿ã€‘æš«ä¸”ä¸è¨€', voiceChanges: { filialPiety: +10, tenderness: +5 }, virtueChanges: { harmony: +3 }, relationshipChanges: { father: +5 }, unlockedWords: [], next: 'scene3_2' }
            }
        },
        scene3_2: {
            title: 'ç£¨é¡å°‘å¹´',
            markdown: `é—œæ–¼å©šé…ï¼Œä½ æœƒå¦‚ä½•é¸æ“‡ç£¨é¡å°‘å¹´ï¼Ÿ`,
            choices: {
                A: { label: 'ã€å°‹æ±‚çœŸæ„›ã€‘', voiceChanges: { tenderness: +40, seekingDao: -10 }, virtueChanges: {}, relationshipChanges: { husband: +20 }, unlockedWords: [], next: 'scene3_end' },
                B: { label: 'ã€ç­–ç•¥å®‰æ’ã€‘', voiceChanges: { seekingDao: +20, tenderness: +5 }, virtueChanges: {}, relationshipChanges: { husband: +5 }, unlockedWords: [], next: 'scene3_end' },
                C: { label: 'ã€é †å¾å®‰æ’ã€‘', voiceChanges: { tenderness: +15, seekingDao: +10 }, virtueChanges: {}, relationshipChanges: { husband: +10 }, unlockedWords: [], next: 'scene3_end' }
            }
        },
        scene3_end: {
            title: 'è¦ªæƒ…çš„å›è²',
            markdown: `å®¶åº­ã€æ„›æƒ…èˆ‡è‡ªæˆ‘ä¹‹é–“çš„å¼µåŠ›ï¼Œä»¤ä½ æ„ˆç™¼æ¸…é†’ã€‚`,
            endOfChapter: true,
            nextChapter: 'scene4_1'
        },

        // ç¬¬å››ç« ï¼šä¸–ä¿—æ·é–
        scene4_1: {
            title: 'é¢å°çˆ¶è¦ªå»ä¸–',
            markdown: `çˆ¶è¦ªé›¢ä¸–ä¹‹æ™‚ï¼Œä½ çš„ä¸–ç•Œå†æ¬¡æ”¹è®Šã€‚`,
            choices: {
                A: { label: 'ã€å®¶æ—å¥³å…’ã€‘æ‰¿æ“”å®¶æ—è²¬ä»»', voiceChanges: { filialPiety: +30, loyalty: +15 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene4_2' },
                B: { label: 'ã€ç¨ç«‹è€…ã€‘è¦åŠƒå€‹äººç™¼å±•', voiceChanges: { seekingDao: +30, filialPiety: -20 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene4_2' }
            }
        },
        scene4_2: {
            title: 'é­å¸¥åºœä¸­çš„å®šä½',
            markdown: `åœ¨é­å¸¥åºœï¼Œä½ å¦‚ä½•è‡ªè™•ï¼Ÿ`,
            choices: {
                A: { label: 'ã€å¿ å¿ƒæ•ˆåŠ›ã€‘', voiceChanges: { loyalty: +35, seekingDao: -5 }, virtueChanges: {}, relationshipChanges: { weiShuai: +15 }, unlockedWords: [], next: 'scene4_end' },
                B: { label: 'ã€ä¿æŒæ¸…é†’ã€‘ï¼ˆéœ€æ­¤å‰è³ªç–‘éå¸«é–€ï¼‰', requires:{ flags:{ questionedDoctrine:true } }, lockedHint:'éœ€åœ¨ç¬¬äºŒç« æ›¾æš—ä¸­è³ªç–‘', voiceChanges: { seekingDao: +25, loyalty: -10 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene4_end' },
                C: { label: 'ã€å®¶åº­å„ªå…ˆã€‘ï¼ˆéœ€æŸ”æƒ…â‰¥50ï¼‰', requires:{ voices:{ tenderness:50 } }, lockedHint:'æŸ”æƒ…ä¹‹æ„â‰¥50', voiceChanges: { tenderness: +20, loyalty: -5 }, virtueChanges: {}, relationshipChanges: { husband: +10 }, unlockedWords: [], next: 'scene4_end' }
            }
        },
        scene4_end: {
            title: 'ä¸–ä¿—çš„é‡é‡',
            markdown: `ä½ å­¸æœƒåœ¨ç§©åºèˆ‡è‡ªæˆ‘ä¹‹é–“ç©¿æ¢­ã€‚`,
            endOfChapter: true,
            nextChapter: 'scene5_1'
        },

        // ç¬¬äº”ç« ï¼šå¿ èª è€ƒé©—
        scene5_1: {
            title: 'æ¥å—ä»»å‹™çš„å¿ƒæ…‹',
            markdown: `åˆºæ®ºåŠ‰æ˜Œè£”çš„ä»»å‹™ä¾†è‡¨ã€‚`,
            choices: {
                A: { label: 'ã€è‡£å±¬è·¯ç·šã€‘ç¾©ä¸å®¹è¾­', voiceChanges: { loyalty: +30 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene5_2' },
                B: { label: 'ã€ç¨ç«‹è€…ã€‘å…ˆäº†è§£å…¶äºº', voiceChanges: { seekingDao: +25, loyalty: -15 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene5_2' },
                C: { label: 'ã€å¦»å­è·¯ç·šã€‘æ“”å¿ƒå®¶åº­', voiceChanges: { tenderness: +25, loyalty: -10 }, virtueChanges: {}, relationshipChanges: { husband: +10 }, unlockedWords: [], next: 'scene5_2' }
            }
        },
        scene5_2: {
            title: 'æ…§çœ¼è­˜äºº',
            markdown: `é¢å°åŠ‰æ˜Œè£”çš„å¦èª èˆ‡è­˜è¦‹ï¼Œä½ çš„å¿ èª ä½•å»ä½•å¾ï¼Ÿ`,
            choices: {
                A: { label: 'ã€å …æŒåŸä¸»ã€‘å„ç‚ºå…¶ä¸»', voice:'loyalty', check:{type:'loyalty', dc:60, kind:'red', title:'å¿ ç¾©æª¢å®š'}, voiceChanges: { loyalty: +30, seekingDao: +10 }, virtueChanges: {}, relationshipChanges: { liuChangyi: +10 }, unlockedWords: [], next: 'scene5_3' },
                B: { label: 'ã€ç†æ€§é¸æ“‡ã€‘æŠ•å‘æ›´å€¼å¾—è€…', voice:'seekingDao', check:{type:'wisdom', dc:55, kind:'white', title:'æ´è¦‹æª¢å®š'}, voiceChanges: { seekingDao: +35 }, virtueChanges: {}, relationshipChanges: { liuChangyi: +30, weiShuai: -20 }, unlockedWords: [], next: 'scene5_3' },
                
                // å‹•æ…‹åˆ†æ”¯ï¼šè‹¥æ—©æœŸã€Œå®Œå…¨é †å¾ã€å‰‡æ­¤åˆ»ç”¢ç”Ÿå…§åœ¨æ’•è£‚
                B2: { label: 'ã€ç†æ€§é¸æ“‡ã€‘ï¼ˆè§¸ç™¼å…§å¿ƒæ’•è£‚ï¼‰', requires:{ flags:{ absoluteObedience:true } }, voice:'seekingDao', check:{type:'peace', dc:58, kind:'white', title:'å¿ƒå¢ƒæª¢å®š'}, voiceChanges: { seekingDao: +35 }, virtueChanges: { peace: -5 }, relationshipChanges: { liuChangyi: +20, weiShuai: -10 }, unlockedWords: [], next: 'scene5_conflict' },
                C: { label: 'ã€æ·±åº¦åæ€ã€‘è·³å‡ºå¿ èª æ¡†', voice:'seekingDao', check:{type:'wisdom', dc:60, kind:'white', title:'æŠ½é›¢æª¢å®š'}, voiceChanges: { seekingDao: +40 }, virtueChanges: { loyalty: -10, harmony: +5 }, relationshipChanges: {}, unlockedWords: [], next: 'scene5_3' }
            }
        },
        scene5_conflict: {
            title: 'è£‚ç¸«ä¸­çš„è‡ªç™½',
            markdown: `ä½ è½è¦‹å…©å€‹è‡ªå·±åœ¨èƒ¸è…”å›éŸ¿ï¼šä¸€å€‹è¦æ±‚çµ•å°æœå¾ï¼Œä¸€å€‹è¦æ±‚å¿ æ–¼æ´è¦‹ã€‚æ¯ä¸€æ¬¡å‘¼å¸ï¼Œéƒ½æ˜¯æ‹”æ²³ã€‚ä½ å¿…é ˆé¸æ“‡ã€‚`,
            choices: {
                A: { label: 'ã€å‰²è£‚ã€‘èƒŒé›¢èˆŠåˆ¶', voiceChanges: { seekingDao: +20, masterTraining: -20 }, virtueChanges: { wisdom: +5 }, relationshipChanges: {}, unlockedWords: [], next: 'scene5_end' },
                B: { label: 'ã€å§‘ä¸”éš±å¿ã€‘å†è§€å…¶è®Š', voiceChanges: { masterTraining: +10, seekingDao: +5 }, virtueChanges: { peace: +3 }, relationshipChanges: {}, unlockedWords: [], next: 'scene5_end' }
            }
        },
        scene5_3: {
            title: 'å‰ªé«®æ˜å¿—',
            markdown: `ä½ æ˜¯å¦ä»¥å‰ªé«®ç¤ºæ±ºæ–·ï¼Ÿ`,
            choices: {
                A: { label: 'ã€æ±ºæ–·è¡¨æ…‹ã€‘å‰ªæ–·éå»', voiceChanges: { seekingDao: +30 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene5_end' },
                B: { label: 'ã€æ¬Šå®œä¹‹è¨ˆã€‘ä¿æŒé¤˜åœ°', voiceChanges: { seekingDao: +10, loyalty: +15 }, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'scene5_end' }
            }
        },
        scene5_end: {
            title: 'æŠ‰æ“‡ä¹‹å¾Œ',
            markdown: `ä½ é–‹å§‹ä»¥è‡ªå·±çš„æ–¹å¼è¡¡é‡å–„æƒ¡èˆ‡å¿ èª ã€‚`,
            endOfChapter: true,
            nextChapter: 'scene6_1'
        },

        // ç¬¬å…­ç« ï¼šè­·ä¸»æ±ºæˆ°
        scene6_1: {
            title: 'å°æ±ºç²¾ç²¾å…’',
            markdown: `ç”Ÿæ­»é—œé ­ï¼Œä½ çš„å¿ƒå¦‚æ­¢æ°´ï¼Œæˆ–å¦‚çƒˆç«ã€‚`,
            choices: {
                A: { label: 'ã€ä¸è¨ˆä»£åƒ¹ã€‘æ¨èº«è­·ä¸»', voiceChanges: { seekingDao: +25, loyalty: +20 }, virtueChanges: {}, relationshipChanges: { liuChangyi: +30 }, unlockedWords: [], next: 'scene6_2' },
                B: { label: 'ã€å†·éœæ‡‰å°ã€‘ä»¥æ™ºå–å‹', voiceChanges: { seekingDao: +30 }, virtueChanges: { wisdom: +5 }, relationshipChanges: { liuChangyi: +20 }, unlockedWords: [], next: 'scene6_2' }
            }
        },
        scene6_2: {
            title: 'åŒ–èº«è ›è “',
            markdown: `ä½ å¹¾è¿‘å¿˜æˆ‘ï¼Œå®ˆè­·å…¶äººã€‚`,
            choices: {
                A: { label: 'ã€å®Œå…¨èå…¥ã€‘è¶…è¶Šè‡ªæˆ‘ç•Œé™', voiceChanges: { seekingDao: +40 }, virtueChanges: { peace: +10 }, relationshipChanges: {}, unlockedWords: [], next: 'scene6_end' }
            }
        },
        scene6_end: {
            title: 'ç²¾ç¥çš„æ˜‡è¯',
            markdown: `ä½ è§¸åŠäº†æ›´é«˜çš„å¢ƒç•Œã€‚`,
            endOfChapter: true,
            nextChapter: 'scene7_1'
        },

        // ç¬¬ä¸ƒç« ï¼šçµ‚æ¥µé¸æ“‡ï¼ˆæ ¹æ“šè²éŸ³é«˜ä½çµ¦å‡ºåˆ†æ”¯ï¼‰
        scene7_1: {
            title: 'æœ€å¾Œçš„è‡ªæˆ‘å¯©åˆ¤',
            markdown: `æ‰€æœ‰ç¾ˆçµ†ç™»å³°ä¹‹éš›ï¼Œä½ å°‡åšå‡ºæœ€çµ‚é¸æ“‡ã€‚`,
            choices: {
                A: { label: 'ã€éš¨é«˜æŸ”æƒ…ã€‘èˆ‡å¤«éå‡¡ä¿—å¹¸ç¦', voice:'tenderness', check:{type:'love', dc:58, kind:'white', title:'æƒ…æ„Ÿæª¢å®š'}, requires:{ voices:{ tenderness:70 } }, lockedHint:'éœ€æŸ”æƒ…ä¹‹æ„â‰¥70', voiceChanges: {}, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'ending_evaluate' },
                B: { label: 'ã€éš¨é«˜å¿ ç¾©ã€‘éš¨åŠ‰å…¬å…¥äº¬ç›¡å¿ ', voice:'loyalty', check:{type:'loyalty', dc:62, kind:'red', title:'å¿ èª æª¢å®š'}, requires:{ voices:{ loyalty:70 } }, lockedHint:'éœ€å¿ ç¾©ä¹‹å¿µâ‰¥70', voiceChanges: {}, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'ending_evaluate' },
                C: { label: 'ã€éš¨é«˜å±±æ°´ã€‘è‡ªæ­¤å°‹å±±æ°´è¨ªè‡³äºº', voice:'seekingDao', check:{type:'wisdom', dc:60, kind:'white', title:'æ‚Ÿé“æª¢å®š'}, requires:{ voices:{ seekingDao:70 } }, lockedHint:'éœ€å±±æ°´æ±‚é“â‰¥70', voiceChanges: {}, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'ending_evaluate' },
                D: { label: 'ã€è‡ªå®šä¹‹è·¯ã€‘æˆ‘ä¸å±¬æ–¼ä»»ä½•äºº', voice:'seekingDao', check:{type:'harmony', dc:58, kind:'white', title:'è‡ªæˆ‘å’Œè§£'}, voiceChanges: {}, virtueChanges: {}, relationshipChanges: {}, unlockedWords: [], next: 'ending_evaluate' }
            }
        },
        ending_evaluate: {
            title: 'çµå±€è©•å®šä¸­...',
            markdown: `ç³»çµ±å°‡æ ¹æ“šä½ çš„è²éŸ³åˆ†ä½ˆèˆ‡å“æ ¼ä¿®é¤Šï¼Œçµ¦å‡ºçµå±€èˆ‡å€‹æ€§åŒ–è©•åƒ¹ã€‚`,
            endOfChapter: true
        }
    };

    // --- UI æ¸²æŸ“ ---
    function clamp(v, min=0, max=100){ return Math.max(min, Math.min(max, v)); }

    function renderMeterRow(label, value, colorClass){
        const width = clamp(value) + '%';
        return `
            <div>
                <div class="flex items-center justify-between text-sm mb-1">
                    <span>${label}</span><span class="text-gray-500">${clamp(value)}</span>
                </div>
                <div class="meter"><span style="width:${width}"></span></div>
            </div>
        `;
    }

    function renderVoices(){
        const v = gameState.voices;
        voicesPanel.innerHTML = [
            renderMeterRow('ğŸ’ å­å¥³ä¹‹å¿ƒ', v.filialPiety),
            renderMeterRow('âš¡ å¸«é–€ä¹‹è¨“', v.masterTraining),
            renderMeterRow('ğŸ’• æŸ”æƒ…ä¹‹æ„', v.tenderness),
            renderMeterRow('âš”ï¸ å¿ ç¾©ä¹‹å¿µ', v.loyalty),
            renderMeterRow('ğŸŒŠ å±±æ°´æ±‚é“', v.seekingDao),
        ].join('');
    }

    function renderVirtues(){
        const t = gameState.virtues;
        virtuesPanel.innerHTML = [
            renderMeterRow('å¿ ', t.loyalty),
            renderMeterRow('å­', t.filialPiety),
            renderMeterRow('ä»', t.benevolence),
            renderMeterRow('æ„›', t.love),
            renderMeterRow('ç¦®', t.propriety),
            renderMeterRow('ç¾©', t.righteousness),
            renderMeterRow('å’Œ', t.harmony),
            renderMeterRow('å¹³', t.peace),
            renderMeterRow('æ™º', t.wisdom),
        ].join('');
    }

    function renderWords(){
        wordsPanel.textContent = gameState.learnedWords.length ? gameState.learnedWords.join('ã€') : 'ï¼ˆæš«ç„¡ï¼‰';
    }

    function isChoiceAvailable(choice){
        const req = choice && choice.requires;
        if(!req) return true;
        if(req.voices){
            for(const [k,minv] of Object.entries(req.voices)){
                if((gameState.voices[k]||0) < minv) return false;
            }
        }
        if(req.virtues){
            for(const [k,minv] of Object.entries(req.virtues)){
                if((gameState.virtues[k]||0) < minv) return false;
            }
        }
        if(req.flags){
            for(const [k,need] of Object.entries(req.flags)){
                const v = !!gameState.flags[k];
                if(need===true && !v) return false;
                if(need===false && v) return false;
            }
        }
        return true;
    }

    function renderScene(){
        const scene = scenes[gameState.scene];
        if(!scene) return;
        
        // æ›´æ–°ç« ç¯€ä¿¡æ¯
        const chapterLabel = chapterTitles[gameState.chapter] || '';
        chapterChip.textContent = chapterLabel || 'ç« ç¯€';
        const age = gameState.chapter <= 1 ? '10æ­²' : (gameState.chapter === 2 ? '15æ­²å‰å¾Œ' : (gameState.chapter === 3 ? '15æ­²' : (gameState.chapter >= 4 && gameState.chapter <= 6 ? 'æˆå¹´' : 'æœªçŸ¥')));
        chapterMeta.textContent = `å¹´é½¡ï¼š${age}ï½œç« ç¯€ ${gameState.chapter}`;
        
        // æ¸²æŸ“æ•…äº‹å…§å®¹
        storyContent.innerHTML = marked.parse(`### ${scene.title}\n\n${scene.markdown}`);
        choiceArea.innerHTML = ''; // æ¸…ç©ºé¸é …å€åŸŸ
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å…§å¿ƒè²éŸ³éœ€è¦æ‰“å­—æ©Ÿæ•ˆæœ
        const hasVoicesBox = scene.markdown.includes('voices-box');
        if(hasVoicesBox && !gameState.flags.debatePlayed){
            // å°ç¾æœ‰çš„ voices-box æ‡‰ç”¨æ‰“å­—æ©Ÿæ•ˆæœ
            renderTypingForVoicesBox();
            gameState.flags.debatePlayed = true;
        } else if(scene.choices) {
            // ç›´æ¥é¡¯ç¤ºé¸é …
            renderChoicesForScene(scene);
        } else if(scene.endOfChapter) {
            // ç« ç¯€çµæŸè™•ç†
            choiceArea.innerHTML = '';
            if (gameState.scene === 'ending_evaluate') {
                // ç›´æ¥è¨ˆç®—çµå±€
                computeAndShowEnding();
            } else {
                // ç« æœ«ï¼šè©•ä¼°å¿ƒæ³•è§£é–
                const newly = evaluateThoughtUnlocksAtChapterEnd();
                const btnThought = document.createElement('button');
                btnThought.className = 'mt-3 px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 mr-2';
                btnThought.textContent = 'ç®¡ç†å¿ƒæ³•ï¼ˆæ€ç¶­å¡ï¼‰';
                btnThought.onclick = () => openThoughtModal();
                choiceArea.appendChild(btnThought);

                const btnNext = document.createElement('button');
                btnNext.className = 'mt-3 px-4 py-2 rounded-lg bg-primary text-white mr-2';
                btnNext.textContent = (gameState.chapter < 7) ? 'é€²å…¥ä¸‹ä¸€ç« ' : 'æŸ¥çœ‹çµå±€';
                btnNext.onclick = () => gotoNextChapter();
                choiceArea.appendChild(btnNext);

                const btnRestart = document.createElement('button');
                btnRestart.className = 'mt-3 px-4 py-2 rounded-lg bg-gray-100 text-gray-800';
                btnRestart.textContent = 'é‡æ–°é–‹å§‹';
                btnRestart.onclick = () => resetGame();
                choiceArea.appendChild(btnRestart);
                
                // è‹¥å‰›è§£é–æ–°å¿ƒæ³•ï¼Œè‡ªå‹•æ‰“é–‹ä¸€æ¬¡
                if (newly && newly.length > 0) {
                    setTimeout(openThoughtModal, 100);
                }
            }
        }
    }

    // --- è¦å‰‡èˆ‡è¨ˆç®— ---
    function addVirtueChange(key, delta){
        gameState.virtues[key] = clamp((gameState.virtues[key] || 0) + delta);
    }

    function applyVoiceRelationBonuses(voiceDeltaMap){
        for(const [voiceKey, delta] of Object.entries(voiceDeltaMap || {})){
            if(delta <= 0) continue; // åªå°æå‡æä¾›åŠ æˆ
            const map = voiceVirtueMap[voiceKey];
            if(!map) continue;
            const steps = Math.floor(delta / 10);
            if(steps <= 0) continue;
            // ä¸»è¦ +3/10é»
            map.primary.forEach(pk => addVirtueChange(pk, steps * 3));
            // æ¬¡è¦ +1/10é»
            map.secondary.forEach(sk => addVirtueChange(sk, steps * 1));
        }
    }

    function applyVirtueChanges(changes){
        Object.entries(changes || {}).forEach(([k, d]) => addVirtueChange(k, d));
    }

    function applyRelationshipChanges(changes){
        Object.entries(changes || {}).forEach(([k, d]) => {
            gameState.relationships[k] = clamp((gameState.relationships[k] || 0) + d, 0, 100);
        });
    }

    function addWords(words){
        (words || []).forEach(w => {
            if(!gameState.learnedWords.includes(w)) gameState.learnedWords.push(w);
        });
    }

    // ç°¡åŒ–ç‰ˆæª¢å®šï¼šæˆåŠŸç‡ = (å°æ‡‰å“æ ¼/100) Ã— 0.8
    function runVirtueCheck(cfg){
        if(!cfg) return null;
        const base = 0.8;
        const value = clamp(gameState.virtues[cfg.type] || 0);
        const successRate = Math.min(0.95, (value / 100) * base);
        const success = Math.random() < successRate;
        const bigSuccess = success && Math.random() < 0.12;
        const bigFail = !success && Math.random() < 0.12;
        if(bigSuccess){ // å¤§æˆåŠŸï¼šå“æ ¼+2ï¼ˆè‹¥æŒ‡å®šï¼‰ï¼Œå†å°å¹…å…¨åŸŸå›é¥‹
            Object.entries(cfg.successBonus || {}).forEach(([k,d]) => addVirtueChange(k, d + 2));
            addVirtueChange(cfg.type, 1);
            return { result: 'å¤§æˆåŠŸ', rate: successRate };
        } else if(success){
            Object.entries(cfg.successBonus || {}).forEach(([k,d]) => addVirtueChange(k, d));
            return { result: 'æˆåŠŸ', rate: successRate };
        } else if(bigFail){
            Object.entries(cfg.failurePenalty || {}).forEach(([k,d]) => addVirtueChange(k, d - 2));
            addVirtueChange(cfg.type, -1);
            return { result: 'å¤§å¤±æ•—', rate: successRate };
        } else {
            Object.entries(cfg.failurePenalty || {}).forEach(([k,d]) => addVirtueChange(k, d));
            return { result: 'å¤±æ•—', rate: successRate };
        }
    }

    function applyChoice(key){
        const scene = scenes[gameState.scene];
        if(!scene || !scene.choices || !scene.choices[key]) return;
        const c = scene.choices[key];

        // 1) è²éŸ³è®ŠåŒ–
        Object.entries(c.voiceChanges || {}).forEach(([k, d]) => {
            gameState.voices[k] = clamp((gameState.voices[k] || 0) + d, 0, 100);
        });

        // 2) è²éŸ³â†’å“æ ¼åŠ æˆï¼ˆæŒ‰10é»éšæ¢¯ï¼‰
        applyVoiceRelationBonuses(c.voiceChanges);

        // 3) ç›´æ¥çš„å“æ ¼è®ŠåŒ–
        applyVirtueChanges(c.virtueChanges);

        // 4) äººéš›é—œä¿‚
        applyRelationshipChanges(c.relationshipChanges);

        // 5) è©å½™
        addWords(c.unlockedWords);

        // 6) æª¢å®š
        const checkInfo = runVirtueCheck(c.virtueCheck);

        // 7) æ——æ¨™
        if(c.setFlags){
            Object.entries(c.setFlags).forEach(([k,v])=>{ gameState.flags[k]=v; });
        }

        // æ›´æ–°é¢æ¿
        renderVoices();
        renderVirtues();
        renderWords();

        // é€²å…¥å¾ŒçºŒå ´æ™¯
        // ä¾æ¢ä»¶è·³è½‰ï¼šæ”¯æŒ nextã€nextAltã€nextIf
        let nextScene = c.next;
        if(c.nextIf){
            // nextIf: [{cond:{voices:{...}, virtues:{...}, flags:{...}}, to:'sceneX'}]
            for(const rule of c.nextIf){
                if(matchCondition(rule.cond)) { nextScene = rule.to; break; }
            }
        }
        if(!nextScene && c.nextAlt) nextScene = c.nextAlt;
        gameState.scene = nextScene;
        
        // æ¸…ç©ºè¾¯è«–æ’­æ”¾æ¨™è¨˜ï¼Œè®“ä¸‹ä¸€å€‹å ´æ™¯å¯ä»¥é‡æ–°æ’­æ”¾è¾¯è«–
        gameState.flags.debatePlayed = false;
        
        renderScene();

        // åœ¨æ•…äº‹å€å¡Šè¿½åŠ ä¸€æ¬¡æª¢å®šçµæœæç¤º
        if(checkInfo){
            const hint = document.createElement('div');
            hint.className = 'mt-3 text-sm text-gray-600';
            hint.textContent = `å“æ ¼æª¢å®šï¼ˆ${c.virtueCheck.type}ï¼‰ï¼š${checkInfo.result}`;
            storyContent.appendChild(hint);
        }
    }

    function matchCondition(req){
        if(!req) return false;
        if(req.voices){
            for(const [k,minv] of Object.entries(req.voices)){
                if((gameState.voices[k]||0) < minv) return false;
            }
        }
        if(req.virtues){
            for(const [k,minv] of Object.entries(req.virtues)){
                if((gameState.virtues[k]||0) < minv) return false;
            }
        }
        if(req.flags){
            for(const [k,need] of Object.entries(req.flags)){
                const v = !!gameState.flags[k];
                if(need===true && !v) return false;
                if(need===false && v) return false;
            }
        }
        return true;
    }

    function resetGame(){
        gameState.chapter = 1;
        gameState.scene = 'scene1';
        gameState.voices = { filialPiety:30, masterTraining:40, tenderness:20, loyalty:10, seekingDao:15 };
        gameState.virtues = { loyalty:30, filialPiety:40, benevolence:20, love:25, propriety:35, righteousness:30, harmony:40, peace:35, wisdom:30 };
        gameState.relationships = { father:50, husband:0, liuChangyi:0, weiShuai:30 };
        gameState.learnedWords = [];
        gameState.unlockedEndings = gameState.unlockedEndings || [];
        gameState.achievements = gameState.achievements || [];
        gameState.flags = {}; // æ¸…ç©ºæ‰€æœ‰æ——æ¨™ï¼ŒåŒ…æ‹¬debatePlayed
        renderVoices();
        renderVirtues();
        renderWords();
        renderScene();
    }

    function gotoNextChapter(){
        const scene = scenes[gameState.scene];
        if(scene && scene.nextChapter){
            gameState.chapter = Math.min(7, gameState.chapter + 1);
            gameState.scene = scene.nextChapter;
            renderScene();
        } else if (gameState.chapter < 7) {
            gameState.chapter += 1;
            // ä¿å®ˆfallback
            const fallback = {2:'scene2_1',3:'scene3_1',4:'scene4_1',5:'scene5_1',6:'scene6_1',7:'scene7_1'};
            gameState.scene = fallback[gameState.chapter] || 'scene7_1';
            renderScene();
        } else {
            gameState.scene = 'scene7_1';
            renderScene();
        }
    }

    // --- çµå±€èˆ‡è©•åƒ¹ ---
    const endingDefs = {
        solo: {
            filialPiety: { id: 'å­-è¶æ°ä¸­èˆˆ', title: 'è¶æ°ä¸­èˆˆ', desc: 'ä½ ä»¥å®¶æ—ç‚ºé‡ï¼Œé‡æŒ¯è¶æ°é–€åº­ã€‚', cond: (v)=> v.filialPiety>=85 },
            masterTraining: { id: 'å¸«-ç„¡æƒ…æ®ºå™¨', title: 'ç„¡æƒ…æ®ºå™¨', desc: 'ä½ æ³¯æ»…äººæ€§ï¼Œæˆç‚ºå†·é…·å·¥å…·ã€‚', cond: (v)=> v.masterTraining>=85 },
            tenderness: { id: 'æƒ…-å¹³å‡¡å¹¸ç¦', title: 'å¹³å‡¡å¹¸ç¦', desc: 'ä½ é¸æ“‡èˆ‡ç£¨é¡å°‘å¹´éå¹³å‡¡ç”Ÿæ´»ã€‚', cond: (v)=> v.tenderness>=80 && v.masterTraining<=40 },
            loyalty: { id: 'å¿ -ä¸€ä»£åè‡£', title: 'ä¸€ä»£åè‡£', desc: 'ä½ è¼”ä½è³¢ä¸»ï¼Œå»ºåŠŸç«‹æ¥­ã€‚', cond: (v)=> v.loyalty>=85 },
            seekingDao: { id: 'é“-è¶…è„«è–è€…', title: 'è¶…è„«è–è€…', desc: 'ä½ å¾¹åº•å‡ºä¸–ï¼Œç‰©æˆ‘å…©å¿˜ã€‚', cond: (v)=> v.seekingDao>=90 }
        },
        duo: {
            xiao_qing: { id:'å­æƒ…ä¸¦é‡', title:'è³¢æ¯å…¸ç¯„', desc:'æ—¢å­é †çˆ¶æ¯ï¼Œäº¦ç¶“ç‡Ÿå©šå§»ã€‚', cond:(v)=> v.filialPiety>=70 && v.tenderness>=70 },
            shi_zhong: { id:'å¿ èª æ®ºå™¨', title:'å¸ç‹é·¹çŠ¬', desc:'æ—¢å—å¸«é–€ä¹‹æ§ï¼Œäº¦ç‚ºå¸ç‹ä¹‹åˆƒã€‚', cond:(v)=> v.masterTraining>=70 && v.loyalty>=70 },
            qing_dao: { id:'æƒ…æ·±é“é ', title:'ç¥ä»™çœ·ä¾¶', desc:'æ„›æƒ…èˆ‡è¶…è„«å…¼å¾—ï¼Œçµä¼´å±±æ—ã€‚', cond:(v)=> v.tenderness>=70 && v.seekingDao>=70 },
            zhong_dao: { id:'ä¿ é“åˆä¸€', title:'ä¿ è–å‚³èªª', desc:'è¡Œä¿ ä»—ç¾©ï¼Œè€Œä¸å—æ‹˜æŸã€‚', cond:(v)=> v.loyalty>=70 && v.seekingDao>=70 },
            xiao_zhong: { id:'å®¶åœ‹æƒ…æ‡·', title:'è­·åœ‹å­å¥³', desc:'å¿ å­å…©å…¨ï¼Œè­·åœ‹å®‰æ°‘ã€‚', cond:(v)=> v.filialPiety>=70 && v.loyalty>=70 },
            xiao_dao: { id:'å­é“åˆæµ', title:'å®¶æ—ä»™å§‘', desc:'å®ˆè­·å®¶æ—äº¦æ±‚è¶…è„«ã€‚', cond:(v)=> v.filialPiety>=70 && v.seekingDao>=70 && v.tenderness<=30 }
        },
        conflict: {
            split: { id:'å…§å¿ƒåˆ†è£‚', title:'äººæ ¼ç ´ç¢', desc:'ç„¡æ³•èª¿å’Œè¡çªï¼Œæœ€çµ‚å´©æ½°ã€‚', cond:(v)=> (v.filialPiety>=80 && v.seekingDao>=80) || (v.tenderness>=80 && v.masterTraining>=80) },
            struggle: { id:'æ°¸æ†æ™æ‰', title:'çŸ›ç›¾è¡Œè€…', desc:'çµ‚èº«æ–æ“ºæ–¼å¤šé‡åƒ¹å€¼ã€‚', cond:(v)=> [v.filialPiety,v.tenderness,v.loyalty,v.seekingDao,v.masterTraining].filter(x=>x>=60 && x<=80).length>=3 },
            rebirth: { id:'æ··æ²Œé‡ç”Ÿ', title:'æ¶…æ§ƒæ–°ç”Ÿ', desc:'å·¨è®Šå¾Œé “æ‚Ÿï¼ŒåŒ…å®¹ä¸¦è¶…è¶Šã€‚', cond:(v)=> v.seekingDao>=85 && (v.masterTraining>=70 || v.loyalty>=70) }
        }
    };

    function pickEnding(){
        const v = gameState.voices;
        // 1) å„ªå…ˆå–®è²éŸ³ä¸»å°
        for(const k of ['seekingDao','filialPiety','masterTraining','tenderness','loyalty']){
            const def = (k==='seekingDao'? endingDefs.solo.seekingDao : k==='filialPiety'? endingDefs.solo.filialPiety : k==='masterTraining'? endingDefs.solo.masterTraining : k==='tenderness'? endingDefs.solo.tenderness : endingDefs.solo.loyalty);
            if(def.cond(v)) return def;
        }
        // 2) çµ„åˆ
        for(const key of Object.keys(endingDefs.duo)){
            const def = endingDefs.duo[key];
            if(def.cond(v)) return def;
        }
        // 3) è¡çª
        for(const key of Object.keys(endingDefs.conflict)){
            const def = endingDefs.conflict[key];
            if(def.cond(v)) return def;
        }
        // 4) é»˜èªï¼šçŸ›ç›¾è¡Œè€…
        return endingDefs.conflict.struggle;
    }

    function buildVirtueEvaluation(){
        const t = gameState.virtues;
        const good = [];
        const warn = [];
        const map = {
            loyalty: 'å¿ ', filialPiety:'å­', benevolence:'ä»', love:'æ„›', propriety:'ç¦®', righteousness:'ç¾©', harmony:'å’Œ', peace:'å¹³', wisdom:'æ™º'
        };
        Object.entries(t).forEach(([k,v])=>{
            if(v>=80) good.push(`${map[k]}ï¼šå„ªç§€`);
            if(v<=40) warn.push(`${map[k]}ï¼šä¸è¶³`);
        });
        // çµ„åˆè©•èªï¼ˆç¤ºä¾‹ï¼‰
        const combos = [];
        if(t.filialPiety>=80 && t.propriety>=80) combos.push('çŸ¥ç¦®å­é †ï¼Œä»¥å¾·ç«‹èº«');
        if(t.loyalty>=80 && t.righteousness>=80) combos.push('å¿ ç¾©é›™å…¨ï¼Œå¿ƒæ‡·å¤©ä¸‹');
        if(t.benevolence>=80 && t.love>=80) combos.push('æ…ˆæ„›ä¸¦æ¿Ÿï¼Œå¤§æ„›ç„¡ç–†');
        if(t.peace>=80 && t.wisdom>=80) combos.push('å¿ƒå¦‚æ­¢æ°´ï¼Œæ´è¦‹ç¹å¾®');
        return { good, warn, combos };
    }

    function computeAndShowEnding(){
        const ending = pickEnding();
        const evalv = buildVirtueEvaluation();
        showEndingModal(ending, evalv);
        // è¨˜éŒ„è§£é–
        if(!gameState.unlockedEndings.includes(ending.id)) gameState.unlockedEndings.push(ending.id);
    }

    // --- UIï¼šçµå±€å½ˆçª— ---
    function ensureEndingModal(){
        if(document.getElementById('endingModal')) return;
        const wrap = document.createElement('div');
        wrap.id = 'endingModal';
        wrap.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 hidden';
        wrap.innerHTML = `
            <div class="max-w-2xl w-full rounded-2xl bg-white p-6 soft-card">
                <h3 id="endingTitle" class="text-2xl font-bold mb-2"></h3>
                <p id="endingDesc" class="text-gray-700 mb-4"></p>
                <div class="bg-gray-50 rounded-xl p-4 mb-4">
                    <div class="font-semibold mb-2">å€‹æ€§åŒ–å“æ ¼è©•åƒ¹</div>
                    <div id="endingEval" class="text-sm text-gray-700 space-y-1"></div>
                </div>
                <div class="flex items-center gap-2 justify-end">
                    <button id="btnAgain" class="px-4 py-2 rounded-lg bg-gray-100">å†ä¾†ä¸€æ¬¡</button>
                    <button id="btnCloseEnding" class="px-4 py-2 rounded-lg bg-primary text-white">æ”¶ä¸‹æ­¤çµå±€</button>
                </div>
            </div>`;
        document.body.appendChild(wrap);
        document.getElementById('btnCloseEnding').onclick = ()=>{ wrap.classList.add('hidden'); };
        document.getElementById('btnAgain').onclick = ()=>{ wrap.classList.add('hidden'); resetGame(); };
    }

    function showEndingModal(ending, evalv){
        ensureEndingModal();
        const wrap = document.getElementById('endingModal');
        document.getElementById('endingTitle').textContent = ending.title;
        document.getElementById('endingDesc').textContent = ending.desc;
        const evalBox = document.getElementById('endingEval');
        evalBox.innerHTML = '';
        if(evalv.good.length){
            const p = document.createElement('div');
            p.textContent = 'å„ªç§€ï¼š' + evalv.good.join('ã€');
            evalBox.appendChild(p);
        }
        if(evalv.warn.length){
            const p = document.createElement('div');
            p.textContent = 'ä¸è¶³ï¼š' + evalv.warn.join('ã€');
            evalBox.appendChild(p);
        }
        if(evalv.combos.length){
            const p = document.createElement('div');
            p.textContent = 'ç¶œåˆè©•èªï¼š' + evalv.combos.join('ï¼›');
            evalBox.appendChild(p);
        }
        wrap.classList.remove('hidden');
    }

    // --- URL é€²åº¦ä¿å­˜/é‚„åŸï¼ˆåŒæº iframe å…§å¯ç”¨æ–¼åˆ†äº«ï¼‰---
    function encodeState(){
        const minimal = { chapter: gameState.chapter, scene: gameState.scene, voices: gameState.voices, virtues: gameState.virtues, relationships: gameState.relationships, learnedWords: gameState.learnedWords };
        return btoa(unescape(encodeURIComponent(JSON.stringify(minimal))));
    }
    function decodeState(s){
        try { return JSON.parse(decodeURIComponent(escape(atob(s)))); } catch(e){ return null; }
    }
    function saveToHash(){
        const token = encodeState();
        try { location.hash = 's=' + token; } catch(e){}
    }
    function loadFromHash(){
        if(location.hash && location.hash.startsWith('#s=')){
            const token = location.hash.slice(3);
            const data = decodeState(token);
            if(data && data.voices && data.virtues){
                Object.assign(gameState, data);
            }
        }
    }

    // DOM å…ƒç´ å¼•ç”¨
    const voicesPanel = document.getElementById('voicesPanel');
    const virtuesPanel = document.getElementById('virtuesPanel');
    const wordsPanel = document.getElementById('wordsPanel');
    const storyContent = document.getElementById('storyContent');
    const choiceArea = document.getElementById('choiceArea');
    const chapterChip = document.getElementById('chapterChip');
    const chapterMeta = document.getElementById('chapterMeta');
    const btnReset = document.getElementById('btnReset');
    const btnSave = document.getElementById('btnSave');
    const btnShare = document.getElementById('btnShare');
    const btnHelp = document.getElementById('btnHelp');

    // ç¶å®šäº‹ä»¶è™•ç†å™¨
    btnReset.onclick = resetGame;
    btnHelp.onclick = () => {
        alert('ç©æ³•ï¼šé–±è®€æƒ…ç¯€ï¼Œæ–¼é¸é …ä¸­åšæ±ºå®šã€‚\næ¯æ¬¡é¸æ“‡æœƒæ”¹è®Šã€Œæ€æƒ³å…§é–£ã€èˆ‡ã€Œå…«å¾·ä¸€æ™ºã€æ•¸å€¼ï¼Œä¸¦å¯èƒ½è§¸ç™¼ç°¡åŒ–æª¢å®šã€‚\næœ¬ç‰ˆæœ¬å·²å®Œæˆä¸ƒç« ä¸»ç·šèˆ‡å¤šçµå±€ï¼Œçµå°¾æä¾›å€‹æ€§åŒ–å“æ ¼è©•åƒ¹ã€‚');
    };
    btnSave.onclick = () => { saveToHash(); alert('é€²åº¦å·²å¯«å…¥ç¶²å€ï¼Œè¤‡è£½è©²é€£çµå¯åˆ†äº«/ä¿å­˜ã€‚'); };
    btnShare.onclick = () => { const url = location.origin + location.pathname + location.hash; window.open(url, '_blank'); };

    // åˆå§‹åŒ–
    loadFromHash();
    renderVoices();
    renderVirtues();
    renderWords();
    renderScene();
    </script>
</body>
</html>


