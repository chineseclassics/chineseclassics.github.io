<!DOCTYPE html><html lang="zh-TW"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶éš±å¨˜å‚³ - æ–‡å­—è§’è‰²æ‰®æ¼”éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'bg-light': '#FFFFFF',
                        'bg-dark': '#181818'
                    }
                }
            }
        }
    </script>
    <style>
        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #5D5CDE transparent;
        }
        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #5D5CDE;
            border-radius: 3px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .combat-target {
            transition: all 0.3s ease;
        }
        .combat-target:hover {
            transform: scale(1.1);
        }
        .hit-effect {
            animation: hitFlash 0.3s ease;
        }
        @keyframes hitFlash {
            0% { background-color: #ef4444; }
            100% { background-color: transparent; }
        }
        .ancient-text {
            font-family: serif;
            line-height: 1.8;
        }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="app" class="min-h-screen">
        <main class="max-w-5xl mx-auto p-4">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6" id="gameContent">
                    <!-- æ•…äº‹èˆ‡äº’å‹•å…§å®¹æœƒæ’å…¥åœ¨æ­¤ -->
                </div>
                <aside id="statsPanel" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">è§’è‰²å±¬æ€§</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>ç•¶å‰ç­‰ç´š:</span>
                            <span id="modalLevel">1</span>
                        </div>
                        <div class="flex justify-between">
                            <span>ç¶“é©—å€¼:</span>
                            <span id="modalExp">0/100</span>
                        </div>
                        <div class="text-sm text-gray-500">ç‹€æ…‹ï¼š<span id="playerLevel">ç­‰ç´š: 1</span></div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>æƒ…æ„Ÿç¾ˆçµ†:</span>
                                <span id="emotionValue">50</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="emotionBar" class="bg-pink-500 h-2 rounded-full" style="width: 50%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>æ±Ÿæ¹–è²æœ›:</span>
                                <span id="reputationValue">50</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="reputationBar" class="bg-yellow-500 h-2 rounded-full" style="width: 50%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>å…§å¿ƒå¹³éœ:</span>
                                <span id="peaceValue">50</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="peaceBar" class="bg-blue-500 h-2 rounded-full" style="width: 50%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>æ­¦å­¸é€ è©£:</span>
                                <span id="skillValue">50</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div id="skillBar" class="bg-red-500 h-2 rounded-full" style="width: 50%"></div>
                            </div>
                        </div>
                        <h4 class="font-bold mt-4 mb-2">æˆ°é¬¥å±¬æ€§</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>æ”»æ“ŠåŠ›: <span id="attackValue">5</span></div>
                            <div>é˜²ç¦¦åŠ›: <span id="defenseValue">5</span></div>
                            <div>ç”Ÿå‘½å€¼: <span id="healthValue">5/5</span></div>
                            <div>æ³•è¡“å€¼: <span id="magicValue">5/5</span></div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Game State
        let gameState = {
            currentChapter: 1,
            currentScene: 0,
            level: 1,
            exp: 0,
            expToNext: 100,
            stats: {
                emotion: 50,      // æƒ…æ„Ÿç¾ˆçµ†
                reputation: 50,   // æ±Ÿæ¹–è²æœ›
                peace: 50,        // å…§å¿ƒå¹³éœ
                skill: 50         // æ­¦å­¸é€ è©£
            },
            combat: {
                attack: 5,        // æ”»æ“ŠåŠ›
                defense: 5,       // é˜²ç¦¦åŠ›
                health: 5,        // ç•¶å‰ç”Ÿå‘½å€¼
                magic: 5,         // ç•¶å‰æ³•è¡“å€¼
                maxHealth: 5,     // æœ€å¤§ç”Ÿå‘½å€¼
                maxMagic: 5       // æœ€å¤§æ³•è¡“å€¼
            },
            choices: [],          // è¨˜éŒ„æ‰€æœ‰é¸æ“‡
            unlockedChapters: [1], // å·²è§£é–çš„ç« ç¯€
            flags: {
                hasHornDagger: false,
                hairTokenSent: false,
                defeatedJingjing: false,
                defeatedKongkong: false
            }
        };

        // Chapter Data
        const chapters = {
            1: {
                title: "ç¬¬ä¸€ç« ï¼šç«¥å¹´æŠ‰æ“‡",
                scenes: [
                    {
                        text: `è²å…ƒå¹´é–“ï¼Œé­åšå¤§å°‡è¶é‹’åºœä¸­ã€‚åæ­²çš„å¦³æ­£åœ¨é™¢ä¸­ç¿’å­—ï¼Œç­†ä¸‹å­—è·¡å·¥æ•´ç§€éº—ã€‚å¿½ç„¶ï¼Œä¸€ä½ç¥ç§˜çš„å°¼å§‘å‡ºç¾åœ¨é–€å‰ï¼Œå‘çˆ¶è¦ªä¹é£Ÿã€‚

å¥¹çœ‹å‘å¦³ï¼Œçœ¼ä¸­é–ƒçˆè‘—å¥‡ç•°çš„å…‰èŠ’ï¼š"æ–½ä¸»ï¼Œå¯å¦å°‡æ­¤å¥³äº¤äºˆè²§å°¼æ•™å°ï¼Ÿ"

çˆ¶è¦ªè¶é‹’å‹ƒç„¶å¤§æ€’ï¼š"å¦–å°¼ä¼‘å¾—èƒ¡è¨€ï¼"

å°¼å§‘æ·¡ç„¶ä¸€ç¬‘ï¼š"ä»»æ†‘æ–½ä¸»å°‡å¥³å…’é–åœ¨éµæ«ƒä¸­ï¼Œè²§å°¼ä¹Ÿèƒ½å°‡å¥¹å¸¶èµ°ã€‚"

æ­¤æ™‚çš„å¦³ï¼Œå¿ƒä¸­æ¹§èµ·ä»€éº¼æƒ³æ³•ï¼Ÿ`,
                        choices: [
                            {
                                text: "ä¸»å‹•èµ°å‘å°¼å§‘ï¼Œå¥½å¥‡å¥¹çš„ä¾†æ­·",
                                effects: { emotion: -5, reputation: +5, peace: -10, skill: +5 },
                                combat: { attack: +1 },
                                exp: 20,
                                next: 1
                            },
                            {
                                text: "èº²åœ¨çˆ¶è¦ªèº«å¾Œï¼Œéœè§€å…¶è®Š",
                                effects: { emotion: +5, reputation: 0, peace: +5, skill: 0 },
                                combat: { defense: +1 },
                                exp: 10,
                                next: 1
                            },
                            {
                                text: "å¤§è²æ–¥è²¬å°¼å§‘ï¼Œè¦å¥¹ç«‹å³é›¢é–‹",
                                effects: { emotion: +10, reputation: -5, peace: -5, skill: 0 },
                                combat: { health: +1, maxHealth: +1 },
                                exp: 15,
                                next: 1
                            }
                        ]
                    },
                    {
                        text: `å¤œæ·±äººéœï¼Œå¦³èººåœ¨åºŠä¸Šï¼Œå»ç™¼ç¾é‚£å€‹å°¼å§‘ç«Ÿç„¶å‡ºç¾åœ¨å¦³çš„æˆ¿é–“è£¡ã€‚

"å­©å­ï¼Œè·Ÿæˆ‘èµ°å§ã€‚æˆ‘å°‡æ•™å¦³é€™ä¸–é–“æœ€ç²¾å¦™çš„æ­¦è—ã€‚"å¥¹çš„è²éŸ³å¦‚çµ²å¦‚ç¸·ï¼Œå¸¶è‘—ä¸å®¹æŠ—æ‹’çš„åŠ›é‡ã€‚

å¦³æ„Ÿåˆ°ä¸€é™£çœ©æšˆï¼Œæ„è­˜æ¼¸æ¼¸æ¨¡ç³Š...`,
                        choices: [
                            {
                                text: "åŠªåŠ›ä¿æŒæ¸…é†’ï¼Œè©¦åœ–åæŠ—",
                                effects: { emotion: 0, reputation: +5, peace: -5, skill: +10 },
                                combat: { magic: +1, maxMagic: +1 },
                                exp: 25,
                                next: "chapter2"
                            },
                            {
                                text: "é †å¾åœ°é–‰ä¸Šçœ¼ç›ï¼Œæ¥å—å‘½é‹",
                                effects: { emotion: +5, reputation: 0, peace: +10, skill: 0 },
                                combat: { defense: +1 },
                                exp: 20,
                                next: "chapter2"
                            }
                        ]
                    }
                ]
            },
            2: {
                title: "ç¬¬äºŒç« ï¼šå±±ä¸­ä¿®è¡Œ",
                scenes: [
                    {
                        text: `äº”å¹´ä¾†ï¼Œå¦³åœ¨æ·±å±±çŸ³ç©´ä¸­ä¿®è¡Œã€‚å¸«çˆ¶æ•™å°å¦³åŠè¡“ã€è¼•åŠŸï¼Œæ›´é‡è¦çš„æ˜¯æ®ºæˆ®ä¹‹æŠ€ã€‚

ä»Šæ—¥ï¼Œå¸«çˆ¶æŒ‡è‘—å±±ä¸­çš„ä¸€åªéˆçŒ¿èªªé“ï¼š"å»ï¼Œå–å®ƒçš„æ€§å‘½ã€‚"

å¦³æ‰‹æŒå¯¶åŠï¼Œçœ‹è‘—é‚£åªç„¡è¾œçš„çŒ¿çŒ´ï¼Œç‰ æ­£åœ¨æ¨¹ä¸Šå¬‰æˆ²ï¼Œæ¯«ç„¡é˜²å‚™...`,
                        choices: [
                            {
                                text: "æ¯«ä¸çŒ¶è±«åœ°å‡ºæ‰‹",
                                effects: { emotion: -10, reputation: +10, peace: -15, skill: +15 },
                                combat: { attack: +2 },
                                exp: 30,
                                next: 1
                            },
                            {
                                text: "å¿ƒå­˜æ†æ†«ï¼Œæ•…æ„åé›¢è¦å®³",
                                effects: { emotion: +10, reputation: -5, peace: +10, skill: +5 },
                                combat: { magic: +1, maxMagic: +1 },
                                exp: 25,
                                next: 1
                            },
                            {
                                text: "è³ªç–‘å¸«çˆ¶çš„æ•™å°",
                                effects: { emotion: +5, reputation: 0, peace: +5, skill: 0 },
                                combat: { defense: +1 },
                                exp: 20,
                                next: 1
                            }
                        ]
                    },
                    {
                        text: `å¸«çˆ¶çœ‹å‡ºäº†å¦³çš„å¿ƒæ€ï¼Œå†·å†·èªªé“ï¼š"å¿ƒå­˜ä»æ…ˆï¼Œå¦‚ä½•èƒ½æˆå¤§å™¨ï¼Ÿä»Šæ—¥å¦³éœ€è¦é€šéæœ€çµ‚è©¦ç…‰ã€‚"

èªªç½·ï¼Œå¥¹å¬ä¾†äº†å¦³çš„å…©ä½å¸«å§ã€‚å¥¹å€‘èº«å½¢çŸ¯å¥ï¼Œçœ¼ç¥å†·æ¼ ï¼Œæ‰‹ä¸­å„æŒåˆ©åˆƒã€‚

"æ“Šæ•—å¥¹å€‘ï¼Œè­‰æ˜å¦³çš„å¯¦åŠ›ï¼"`,
                        choices: [
                            {
                                text: "é–‹å§‹æˆ°é¬¥è©¦ç…‰",
                                effects: {},
                                exp: 0,
                                next: "combat"
                            }
                        ]
                    }
                ]
            },
            3: {
                title: "ç¬¬ä¸‰ç« ï¼šå›æ­¸å¡µä¸–",
                scenes: [
                    {
                        text: `äº”å¹´å¾Œï¼Œå¦³è¢«å¸«çˆ¶é€å›å®¶ä¸­ã€‚çˆ¶è¦ªè¶é‹’çœ‹åˆ°å¦³ï¼Œæ—¢å–œåˆé©šã€‚å¦³å·²ä¸å†æ˜¯ç•¶å¹´é‚£å€‹å¤©çœŸçš„å­©å­ã€‚

æŸæ—¥ï¼Œä¸€å€‹ç£¨é¡çš„å°‘å¹´ä¾†åˆ°åºœä¸­ã€‚ä»–èº«ææ¸…ç˜¦ï¼Œé›™æ‰‹éˆå·§ï¼Œå°ˆæ³¨åœ°æ‰“ç£¨è‘—éŠ…é¡ã€‚é™½å…‰ç‘åœ¨ä»–çš„è‡‰ä¸Šï¼Œæ˜ å‡ºæº«å’Œçš„ç¬‘å®¹ã€‚

å¦³çœ‹è‘—ä»–ï¼Œå¿ƒä¸­æ¹§èµ·ä¸€ç¨®å¾æœªæœ‰éçš„æ„Ÿè¦º...`,
                        choices: [
                            {
                                text: "ä¸»å‹•èˆ‡ä»–äº¤è«‡",
                                effects: { emotion: +15, reputation: 0, peace: +10, skill: 0 },
                                exp: 20,
                                next: 1
                            },
                            {
                                text: "é»˜é»˜è§€å¯Ÿï¼Œä¿æŒè·é›¢",
                                effects: { emotion: +5, reputation: +5, peace: +5, skill: 0 },
                                exp: 15,
                                next: 1
                            },
                            {
                                text: "å°‡ä»–è¦–ç‚ºæ™®é€šå·¥åŒ ï¼Œæ¼ ä¸é—œå¿ƒ",
                                effects: { emotion: -5, reputation: +5, peace: -5, skill: +5 },
                                exp: 10,
                                next: 1
                            }
                        ]
                    },
                    {
                        text: `å¦³å°çˆ¶è¦ªèªªï¼š"æ­¤äººå¯èˆ‡æˆ‘ç‚ºå¤«ã€‚"

çˆ¶è¦ªå¤§é©šï¼Œä½†çœ‹åˆ°å¦³å …å®šçš„çœ¼ç¥ï¼Œä¸æ•¢åå°ã€‚

å©šå¾Œçš„æ—¥å­å¹³éœè€Œæº«é¦¨ï¼Œä½†å¦³å¿…é ˆåŸ·è¡Œä¸€äº›æš—æ®ºä»»å‹™...`,
                        choices: [
                            {
                                text: "æ¥å—åˆºæ®ºå¤§åƒšçš„ä»»å‹™",
                                effects: { emotion: -5, reputation: +10, peace: -10, skill: +5 },
                                exp: 25,
                                next: "vocab_quiz"
                            },
                            {
                                text: "å…ˆå‘ä¸ˆå¤«å¦ç™½èº«ä»½",
                                effects: { emotion: +10, reputation: -5, peace: +5, skill: 0 },
                                exp: 20,
                                next: 2
                            }
                        ]
                    },
                    {
                        text: `ä¸ˆå¤«è½äº†å¦³çš„å¦ç™½ï¼Œæ²‰é»˜è‰¯ä¹…ã€‚æœ€å¾Œä»–æ¡ä½å¦³çš„æ‰‹ï¼š"ç„¡è«–å¦³æ˜¯èª°ï¼Œå¦³éƒ½æ˜¯æˆ‘çš„å¦»å­ã€‚"

é€™ä»½ä¿¡ä»»è®“å¦³å…§å¿ƒæº«æš–ï¼Œä½†åŒæ™‚ä¹Ÿè®“æ¥ä¸‹ä¾†çš„ä»»å‹™è®Šå¾—æ›´åŠ æ²‰é‡...`,
                        choices: [
                            {
                                text: "é–‹å§‹åŸ·è¡Œä»»å‹™",
                                effects: { emotion: +5, reputation: 0, peace: -5, skill: +5 },
                                exp: 30,
                                next: "punctuation_quiz"
                            }
                        ]
                    }
                ]
            },
            4: {
                title: "ç¬¬å››ç« ï¼šå¿ èª è€ƒé©—",
                scenes: [
                    {
                        text: `å…ƒå’Œå¹´é–“ï¼Œé­å¸¥èˆ‡é™³è¨±ç¯€åº¦ä½¿åŠ‰æ˜Œè£”ä¸å’Œã€‚æŸæ—¥ï¼Œé­å¸¥å¬å¦³å‰ä¾†ï¼š

"éš±å¨˜ï¼Œå¦³çš„æ­¦è—æˆ‘æ—©æœ‰è€³èã€‚ç¾åœ¨æœ‰ä¸€å€‹ä»»å‹™éœ€è¦å¦³ä¾†å®Œæˆâ€”â€”åˆºæ®ºåŠ‰æ˜Œè£”ã€‚"

å¦³çŸ¥é“é€™æ˜¯ä¸€å€‹é‡å¤§çš„æŠ‰æ“‡ï¼Œå°‡æ±ºå®šå¦³ä»Šå¾Œçš„å‘½é‹...`,
                        choices: [
                            {
                                text: "æ¯«ä¸çŒ¶è±«åœ°æ¥å—ä»»å‹™",
                                effects: { emotion: -5, reputation: +15, peace: -10, skill: +10 },
                                exp: 30,
                                next: 1
                            },
                            {
                                text: "è¡¨é¢æ¥å—ï¼Œå¿ƒä¸­å»æœ‰æ‰€ä¿ç•™",
                                effects: { emotion: +5, reputation: +5, peace: 0, skill: +5 },
                                exp: 25,
                                next: 1
                            },
                            {
                                text: "ç›´æ¥æ‹’çµ•é€™å€‹ä»»å‹™",
                                effects: { emotion: +10, reputation: -15, peace: +15, skill: 0 },
                                exp: 20,
                                next: 1
                            }
                        ]
                    },
                    {
                        text: `å¦³ä¾†åˆ°è¨±æ˜Œï¼Œæº–å‚™åŸ·è¡Œä»»å‹™ã€‚ä½†åŠ‰æ˜Œè£”ä¼¼ä¹æ—©å·²çŸ¥æ›‰å¦³çš„ä¾†æ„ã€‚

ä»–æ´¾è¡™å°‡åœ¨åŸåŒ—ç­‰å€™ï¼Œèªªé“ï¼š"æˆ‘æ¬²ç›¸è¦‹ï¼Œæ•…é ç›¸ç¥—è¿ä¹Ÿã€‚"

é¢å°é€™ä½èƒ½å¤ é çŸ¥æœªä¾†çš„ç¥äººï¼Œå¦³å¦‚ä½•é¸æ“‡ï¼Ÿ`,
                        choices: [
                            {
                                text: "ä½©æœå…¶ç¥æ©Ÿå¦™ç®—ï¼Œæ±ºå®šæŠ•é ",
                                effects: { emotion: +10, reputation: +20, peace: +20, skill: +10 },
                                exp: 50,
                                next: "hair_token"
                            },
                            {
                                text: "ä¾ç„¶å˜—è©¦å®Œæˆåˆºæ®ºä»»å‹™",
                                effects: { emotion: -10, reputation: +10, peace: -20, skill: +15 },
                                exp: 40,
                                next: "chapter5"
                            },
                            {
                                text: "é¸æ“‡ä¸­ç«‹ï¼Œè§€å¯Ÿå½¢å‹¢",
                                effects: { emotion: +5, reputation: 0, peace: +10, skill: +5 },
                                exp: 30,
                                next: "chapter5"
                            }
                        ]
                    }
                ]
            },
            5: {
                title: "ç¬¬äº”ç« ï¼šäººç”ŸæŠ‰æ“‡",
                scenes: [
                    {
                        text: `å…ƒå’Œå…«å¹´ï¼ŒåŠ‰æ˜Œè£”å³å°‡å…¥äº¬è¦²è¦‹ã€‚å¦³ç«™åœ¨äººç”Ÿçš„åå­—è·¯å£ã€‚

å›é¦–å¾€æ˜”ï¼Œå¾åæ­²è¢«å°¼å§‘å¸¶èµ°ï¼Œåˆ°å¦‚ä»Šçš„æ±Ÿæ¹–å‚³å¥‡ï¼Œå¦³ç¶“æ­·äº†å¤ªå¤šæ„›æ¨æƒ…ä»‡ã€ç”Ÿæ­»é›¢åˆ¥...

ç¾åœ¨ï¼Œæ˜¯æ™‚å€™åšå‡ºæœ€çµ‚çš„é¸æ“‡äº†ã€‚`,
                        choices: [
                            {
                                text: "è·Ÿéš¨åŠ‰æ˜Œè£”å…¥äº¬ï¼Œç¹¼çºŒä»•é€”",
                                effects: { emotion: +10, reputation: +20, peace: 0, skill: +5 },
                                exp: 40,
                                next: "ending"
                            },
                            {
                                text: "å°‹å±±è¨ªæ°´ï¼Œè¿½å°‹è‡³äºº",
                                effects: { emotion: 0, reputation: -10, peace: +30, skill: +10 },
                                exp: 50,
                                next: "ending"
                            },
                            {
                                text: "å›æ­¸å¹³å‡¡ï¼Œèˆ‡å¤«å›éæ™®é€šç”Ÿæ´»",
                                effects: { emotion: +30, reputation: -20, peace: +20, skill: -5 },
                                exp: 35,
                                next: "ending"
                            }
                        ]
                    }
                ]
            }
        };

        // Quiz Data
        const vocabQuiz = {
            title: "æ–‡è¨€è©èªè€ƒé©—",
            subtitle: "åœ¨åŸ·è¡Œä»»å‹™å‰ï¼Œå…ˆæ¸¬è©¦å¦³å°æ–‡è¨€æ–‡çš„ç†è§£",
            questions: [
                {
                    word: "æ±",
                    options: ["ä½ ", "æˆ‘", "ä»–", "å¥¹"],
                    correct: 0
                },
                {
                    word: "åº¦",
                    options: ["æ¸¬é‡", "ä¼°è¨ˆ", "ç©¿è¶Š", "è§’åº¦"],
                    correct: 1
                },
                {
                    word: "å±",
                    options: ["å†å–", "è©¢å•", "å“­æ³£", "æ­Œå”±"],
                    correct: 0
                },
                {
                    word: "ä¼",
                    options: ["ç«™ç«‹", "è¡Œèµ°", "è—åŒ¿", "æ”»æ“Š"],
                    correct: 2
                },
                {
                    word: "å¦‚æ˜¯",
                    options: ["åƒé€™æ¨£", "é€™éº¼", "å¦‚æœ", "æ˜¯å¦"],
                    correct: 1
                },
                {
                    word: "æ¬»",
                    options: ["å¿½ç„¶", "ç·©æ…¢", "å®‰éœ", "çŒ›çƒˆ"],
                    correct: 0
                },
                {
                    word: "åµŒç©º",
                    options: ["æ´ç©´å‡¹é™·è™•", "åŸé–€", "å±‹æ¨‘", "å±±é ‚"],
                    correct: 0
                },
                {
                    word: "æ·çŒ±",
                    options: ["æ•æ·çš„çŒ¿çŒ´", "æ€¥ä¿ƒçš„è…³æ­¥", "å¿«é€Ÿçš„åˆ€æ³•", "è¼•ç›ˆçš„è¡£ç‰©"],
                    correct: 0
                },
                {
                    word: "ç¾Šè§’åŒ•é¦–",
                    options: ["çŸ­åŒ•ï¼ŒæŸ„ä¼¼ç¾Šè§’", "é•·åŠ", "æ–§é‰", "é£›é¢"],
                    correct: 0
                },
                {
                    word: "ç‘",
                    options: ["å¤©é»‘ã€å…¥å¤œ", "é»æ˜", "åˆæ™‚", "æ—¥ä¸­"],
                    correct: 0
                },
                {
                    word: "åº¦å…¶é–€éš™",
                    options: ["å¾é–€ç¸«ç©¿é", "é‡é–€å¯¬", "ä¿®é–€ç¸«", "çœ‹é–€å¤–"],
                    correct: 0
                }
            ]
        };

        const punctuationQuiz = {
            title: "æ–·å¥ç·´ç¿’",
            subtitle: "æ­£ç¢ºç†è§£æ–‡è¨€æ–‡çš„å¥è®€",
            text: "å—ä»¥ç¾Šè§’åŒ•é¦–ï¼Œåˆ€å»£ä¸‰å¯¸ã€‚é‚ç™½æ—¥åˆºå…¶äººæ–¼éƒ½å¸‚ï¼Œäººè«èƒ½è¦‹ã€‚ä»¥é¦–å…¥å›Šï¼Œè¿”ä¸»äººèˆï¼Œä»¥è—¥åŒ–ä¹‹ç‚ºæ°´ã€‚äº”å¹´ï¼Œåˆæ›°:ã€æŸå¤§åƒšæœ‰ç½ªï¼Œç„¡æ•…å®³äººè‹¥å¹²ï¼Œå¤œå¯å…¥å…¶å®¤ï¼Œæ±ºå…¶é¦–ä¾†ã€‚ã€åˆæ”œåŒ•é¦–å…¥å®¤ï¼Œåº¦å…¶é–€éš™ï¼Œç„¡æœ‰éšœç¤™ï¼Œä¼ä¹‹æ¨‘ä¸Šã€‚è‡³ç‘ï¼Œ",
            correctPunctuation: [
                "å—ä»¥ç¾Šè§’åŒ•é¦–ï¼Œåˆ€å»£ä¸‰å¯¸ã€‚",
                "é‚ç™½æ—¥åˆºå…¶äººæ–¼éƒ½å¸‚ï¼Œäººè«èƒ½è¦‹ã€‚",
                "ä»¥é¦–å…¥å›Šï¼Œè¿”ä¸»äººèˆï¼Œä»¥è—¥åŒ–ä¹‹ç‚ºæ°´ã€‚",
                "äº”å¹´ï¼Œåˆæ›°:ã€æŸå¤§åƒšæœ‰ç½ªï¼Œç„¡æ•…å®³äººè‹¥å¹²ï¼Œå¤œå¯å…¥å…¶å®¤ï¼Œæ±ºå…¶é¦–ä¾†ã€‚ã€",
                "åˆæ”œåŒ•é¦–å…¥å®¤ï¼Œåº¦å…¶é–€éš™ï¼Œç„¡æœ‰éšœç¤™ï¼Œä¼ä¹‹æ¨‘ä¸Šã€‚",
                "è‡³ç‘ï¼Œ"
            ]
        };

        // Combat Game for Chapter 2
        function startCombatGame() {
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="combat-arena">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">æ­¦å­¸è©¦ç…‰</h3>
                        <div class="flex items-center gap-4 text-sm">
                            <div>ç”Ÿå‘½å€¼: <span id="playerHealth" class="text-green-600 font-bold">100</span></div>
                            <div>å¾—åˆ†: <span id="combatScore" class="text-blue-600 font-bold">0</span></div>
                            <div>æ™‚é–“: <span id="combatTime" class="text-red-600 font-bold">30</span>s</div>
                        </div>
                    </div>
                    <div id="combatTargets" class="grid grid-cols-3 gap-2 mb-2" style="height: 260px;">
                        <!-- 9 cells will be inserted here -->
                    </div>
                    <div class="text-center text-xs text-gray-600 dark:text-gray-400">æ“Šæ•—æ•µæ–¹ç›®æ¨™åŠ åˆ†ï¼Œèª¤æ“Šç„¡è¾œæ‰£åˆ†ã€‚</div>
                </div>
            `;

            let health = 100;
            let score = 0;
            let timeLeft = 30;
            let gameActive = true;

            const targets = ['ğŸ¥·', 'âš”ï¸', 'ğŸ…', 'ğŸº']; // å¯æ“Šæ•—çš„ç›®æ¨™
            const innocents = ['ğŸ°', 'ğŸ¦†']; // ç„¡è¾œçš„å°å‹•ç‰©

            function spawnTarget() {
                if (!gameActive) return;

                const targetsContainer = document.getElementById('combatTargets');
                const isInnocent = Math.random() < 0.2;
                const targetType = isInnocent ? 
                    innocents[Math.floor(Math.random() * innocents.length)] : 
                    targets[Math.floor(Math.random() * targets.length)];

                const targetDiv = document.createElement('div');
                targetDiv.className = `combat-target cursor-pointer text-4xl text-center p-2 rounded-lg border ${isInnocent ? 'border-green-300' : 'border-red-300'} hover:shadow`;
                targetDiv.innerHTML = targetType;
                targetDiv.dataset.innocent = isInnocent;

                const position = Math.floor(Math.random() * 9);
                const cells = targetsContainer.children;
                if (cells[position]) {
                    cells[position].innerHTML = '';
                    cells[position].appendChild(targetDiv);
                } else {
                    targetsContainer.appendChild(targetDiv);
                }

                targetDiv.addEventListener('click', () => {
                    if (!gameActive) return;
                    
                    targetDiv.classList.add('hit-effect');
                    if (isInnocent) {
                        health = Math.max(0, health - 20);
                        score = Math.max(0, score - 5);
                        updateCombatStats();
                        if (health <= 0) {
                            endCombat(false);
                            return;
                        }
                    } else {
                        score += 8;
                        updateCombatStats();
                    }
                    
                    setTimeout(() => {
                        targetDiv.remove();
                    }, 300);
                });

                // Auto remove after 1.5 seconds
                setTimeout(() => {
                    if (targetDiv.parentNode && gameActive) {
                        targetDiv.remove();
                    }
                }, 1500);
            }

            function updateCombatStats() {
                document.getElementById('playerHealth').textContent = health;
                document.getElementById('combatScore').textContent = score;
                document.getElementById('combatTime').textContent = timeLeft;
            }

            function endCombat(success) {
                gameActive = false;
                clearInterval(targetInterval);
                clearInterval(timeInterval);
                const message = success ? 
                    `è©¦ç…‰æˆåŠŸï¼å¦³çš„å¾—åˆ†ï¼š${score}\nå¸«çˆ¶å–å‡ºä¸€æŸ„ã€ç¾Šè§’åŒ•é¦–ã€æˆäºˆå¦³ï¼Œä¸¦å›‘ä»¥ç§˜è¡“ï¼šã€è‹¥äº‹æˆï¼Œå–é¦–ä»¥è—¥åŒ–ä¹‹ç‚ºæ°´ï¼Œå‹¿ç•™ç—•è·¡ã€‚ã€` : 
                    `è©¦ç…‰çµæŸã€‚å¦³çš„å¾—åˆ†ï¼š${score}`;
                
                setTimeout(() => {
                    showCustomAlert(message, () => {
                        // Award experience and stats based on performance
                        const expGain = Math.max(30, Math.floor(score / 2));
                        const combatGain = Math.max(1, Math.floor(score / 20));
                        
                        gainExp(expGain);
                        adjustStats({ skill: Math.floor(score / 12), peace: success ? 5 : -5 });
                        adjustCombat({ 
                            attack: combatGain, 
                            defense: combatGain,
                            health: combatGain,
                            maxHealth: combatGain
                        });
                        if (success) {
                            gameState.flags.hasHornDagger = true;
                        }
                        // Continue to next chapter
                        proceedToNextChapter();
                        
                    });
                }, 500);
            }

            // Initialize grid
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'aspect-square border border-gray-300 dark:border-gray-600 rounded flex items-center justify-center';
                document.getElementById('combatTargets').appendChild(cell);
            }

            // Game loop
            const targetInterval = setInterval(spawnTarget, 700);
            const timeInterval = setInterval(() => {
                timeLeft--;
                updateCombatStats();
                if (timeLeft <= 0) {
                    clearInterval(targetInterval);
                    clearInterval(timeInterval);
                    endCombat(score >= 40);
                }
            }, 1000);
        }

        // Vocabulary Quiz
        function startVocabQuiz() {
            let currentQuestion = 0;
            let score = 0;
            
            function displayQuestion() {
                if (currentQuestion >= vocabQuiz.questions.length) {
                    endQuiz();
                    return;
                }
                
                const question = vocabQuiz.questions[currentQuestion];
                const content = document.getElementById('gameContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <h3 class="text-2xl font-bold mb-4 text-center">${vocabQuiz.title}</h3>
                        <p class="text-center mb-6 text-gray-600 dark:text-gray-400">${vocabQuiz.subtitle}</p>
                        <div class="mb-6 text-center">
                            <div class="text-lg mb-2">é¡Œç›® ${currentQuestion + 1} / ${vocabQuiz.questions.length}</div>
                            <div class="text-3xl font-bold mb-4">"${question.word}" çš„æ„æ€æ˜¯ï¼Ÿ</div>
                        </div>
                        <div class="space-y-3">
                            ${question.options.map((option, index) => `
                                <button class="w-full p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white transition-colors"
                                        onclick="answerQuestion(${index})">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            window.answerQuestion = (answerIndex) => {
                const question = vocabQuiz.questions[currentQuestion];
                if (answerIndex === question.correct) {
                    score++;
                    showCustomAlert("æ­£ç¢ºï¼", () => {
                        currentQuestion++;
                        displayQuestion();
                    });
                } else {
                    showCustomAlert(`éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${question.options[question.correct]}`, () => {
                        currentQuestion++;
                        displayQuestion();
                    });
                }
            };
            
            function endQuiz() {
                const expGain = score * 10;
                const statGain = score * 2;
                
                gainExp(expGain);
                adjustStats({ skill: statGain, reputation: Math.floor(statGain/2) });
                
                showCustomAlert(`æ¸¬é©—å®Œæˆï¼æ­£ç¢ºç‡ï¼š${score}/${vocabQuiz.questions.length}`, () => {
                    proceedToNextChapter();
                });
            }
            
            displayQuestion();
        }

        // Punctuation Quiz  
        function startPunctuationQuiz() {
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="fade-in">
                    <h3 class="text-2xl font-bold mb-4 text-center">${punctuationQuiz.title}</h3>
                    <p class="text-center mb-6 text-gray-600 dark:text-gray-400">${punctuationQuiz.subtitle}</p>
                    <div class="mb-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg ancient-text">
                        <div class="text-lg leading-relaxed">${punctuationQuiz.text}</div>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-bold mb-2">æ­£ç¢ºçš„æ–·å¥æ‡‰è©²æ˜¯ï¼š</h4>
                        <div id="punctuationOptions" class="space-y-2">
                            ${punctuationQuiz.correctPunctuation.map((sentence, index) => `
                                <div class="p-2 bg-white dark:bg-gray-800 rounded border">
                                    ${index + 1}. ${sentence}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="text-center">
                        <button onclick="completePunctuationQuiz()" class="px-6 py-3 bg-primary text-white rounded-lg hover:opacity-90">
                            å®Œæˆç·´ç¿’
                        </button>
                    </div>
                </div>
            `;
            
            window.completePunctuationQuiz = () => {
                const expGain = 40;
                const statGain = 8;
                
                gainExp(expGain);
                adjustStats({ skill: statGain, peace: 5 });
                
                showCustomAlert("æ–·å¥ç·´ç¿’å®Œæˆï¼å°å¤æ–‡çš„ç†è§£æ›´æ·±äº†ã€‚", () => {
                    proceedToNextChapter();
                });
            };
        }

        // Utility Functions
        function showCustomAlert(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:opacity-90 rounded">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store onConfirm function globally
            if (onConfirm) {
                window.tempConfirmHandler = onConfirm;
                modal.querySelector('button').onclick = () => {
                    modal.remove();
                    window.tempConfirmHandler();
                    delete window.tempConfirmHandler;
                };
            } else {
                modal.querySelector('button').onclick = () => modal.remove();
            }
        }

        // Side Missions and Boss Fights
        function startHairTokenMission() {
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="fade-in">
                    <h3 class="text-2xl font-bold mb-4 text-center">å‰ªé«®ç´…ç¶ƒé€ä¿¡</h3>
                    <p class="ancient-text mb-4">åŠ‰æ˜Œè£”é“ï¼šã€Œå½¼æœªçŸ¥æ±å¿ƒï¼Œå¿…ä½¿äººç¹¼è‡³ã€‚ä»Šå®µè«‹å‰ªé«®ï¼Œç¹«ä¹‹ä»¥ç´…ç¶ƒï¼Œé€æ–¼é­å¸¥æ•å‰ï¼Œä»¥è¡¨ä¸å›ã€‚ã€</p>
                    <p class="mb-4">è«‹åœ¨ 5 ç§’å…§æŒ‰ä¸‹ã€Œå‰ªé«®ã€èˆ‡ã€Œé€é”ã€å…©å€‹æŒ‰éˆ•ï¼Œå®ŒæˆæŠ•èª å„€å¼ã€‚</p>
                    <div class="flex gap-3 justify-center">
                        <button id="btnCut" class="px-4 py-2 bg-primary text-white rounded">å‰ªé«®</button>
                        <button id="btnDeliver" class="px-4 py-2 bg-primary text-white rounded" disabled>é€é”</button>
                    </div>
                    <div class="text-center mt-3">å‰©é¤˜æ™‚é–“ï¼š<span id="hairTimer" class="font-bold text-red-500">5</span> ç§’</div>
                </div>
            `;
            let cut = false;
            let delivered = false;
            let timeLeft = 5;
            const timerEl = document.getElementById('hairTimer');
            const timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    if (cut && delivered) {
                        gameState.flags.hairTokenSent = true;
                        gainExp(30);
                        adjustStats({ reputation: 10, peace: 5 });
                        showCustomAlert("ç´…ç¶ƒä¿¡ç‰©å·²é€è‡³é­å¸¥æ•å‰ã€‚å¤œæ·±ï¼Œé¢¨éå¹¡å‹•ï¼Œæ©Ÿé‹’æš—è½‰ã€‚", () => {
                            // è§¸ç™¼ç²¾ç²¾å…’ä¾†è¥²
                            startJingjingFight();
                        });
                    } else {
                        showCustomAlert("çŒ¶è±«æœªæ±ºï¼Œäº‹æ©Ÿå·²é€ã€‚åŠ‰å…¬ä»é¡˜ç›¸ç•™ï¼Œç„¶é¢¨æ³¢å°‡æ›´éšªã€‚", () => {
                            proceedToNextChapter();
                        });
                    }
                }
            }, 1000);
            document.getElementById('btnCut').onclick = () => {
                cut = true;
                document.getElementById('btnDeliver').disabled = false;
            };
            document.getElementById('btnDeliver').onclick = () => {
                if (!cut) return;
                delivered = true;
                timeLeft = Math.max(0, timeLeft); // allow immediate success if time just hit 0
            };
        }

        function startJingjingFight() {
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="fade-in">
                    <h3 class="text-2xl font-bold mb-4 text-center">å¤œåŠå°æ±ºï¼šç²¾ç²¾å…’</h3>
                    <p class="ancient-text mb-4">æ˜¯å¤œï¼Œç´…ç™½äºŒå¹¡é£„ç„¶å¦‚æ“ŠåºŠå››éš…ã€‚å¿½èé‡å¢œï¼Œä¸€äººè‡ªç©ºè€Œè¸£ï¼Œèº«é¦–ç•°è™•â€”â€”ç²¾ç²¾å…’è‡³ï¼</p>
                    <div class="text-center mb-4">é»æ“Šå‡ºç¾çš„ç›®æ¨™ä»¥å‡ºæ‰‹ï¼Œèª¤æ“Šç„¡è¾œå°‡æ‰£åˆ†ã€‚</div>
                    <div class="grid grid-cols-3 gap-4 mb-6" id="jjGrid"></div>
                    <div class="text-center">
                        <div>å¾—åˆ†ï¼š<span id="jjScore" class="font-bold text-blue-500">0</span></div>
                        <div>æ™‚é–“ï¼š<span id="jjTime" class="font-bold text-red-500">20</span> ç§’</div>
                    </div>
                </div>
            `;
            let score = 0;
            let timeLeft = 20;
            const grid = document.getElementById('jjGrid');
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'aspect-square border border-gray-300 dark:border-gray-600 rounded flex items-center justify-center text-5xl cursor-pointer';
                grid.appendChild(cell);
            }
            const targets = ['ğŸ¥·','âš”ï¸'];
            const innocents = ['ğŸ¦†','ğŸ°'];
            function spawn() {
                const cells = Array.from(grid.children);
                const cell = cells[Math.floor(Math.random()*cells.length)];
                const innocent = Math.random() < 0.25;
                const el = document.createElement('div');
                el.textContent = innocent ? innocents[Math.floor(Math.random()*innocents.length)] : targets[Math.floor(Math.random()*targets.length)];
                el.dataset.innocent = innocent ? '1' : '0';
                cell.innerHTML = '';
                cell.appendChild(el);
                el.onclick = () => {
                    if (el.dataset.innocent === '1') { score -= 5; } else { score += 10; }
                    document.getElementById('jjScore').textContent = score;
                    el.remove();
                };
                setTimeout(() => { if (el.parentNode) el.remove(); }, 1200);
            }
            const spawner = setInterval(spawn, 600);
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('jjTime').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(spawner);
                    clearInterval(timer);
                    gameState.flags.defeatedJingjing = score >= 40;
                    const ok = gameState.flags.defeatedJingjing;
                    gainExp(Math.max(30, Math.floor(score/2)));
                    adjustStats({ skill: ok ? 10 : 4, peace: ok ? 5 : -5, reputation: 5 });
                    showCustomAlert(ok ? "ç²¾ç²¾å…’å·²æ–ƒã€‚ä»¥è—¥åŒ–ä¹‹ç‚ºæ°´ï¼Œæ¯›é«®ä¸å­˜ã€‚" : "ç²¾ç²¾å…’éå»ï¼ŒåŠ‰å…¬ä»ä¿æ±å‘¨å…¨ã€‚", () => {
                        startKongkongStealth();
                    });
                }
            }, 1000);
        }

        function startKongkongStealth() {
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="fade-in">
                    <h3 class="text-2xl font-bold mb-4 text-center">å¦™æ‰‹ç©ºç©ºå…’</h3>
                    <p class="ancient-text mb-4">æ¬¡å¤œï¼Œå¦™æ‰‹ç©ºç©ºå…’è‡³ã€‚æ­¤äººç¥è¡“è«æ¸¬ï¼Œé¬¼è«èƒ½èº¡å…¶è¹¤ã€‚è«‹åœ¨å¹¡å½±æ–å‹•é–“ï¼Œåƒ…æ–¼ç´…å¹¡äº®èµ·æ™‚å‡ºæ‰‹ï¼Œå‹¿èª¤ã€‚ä¸‰æ¬¡èª¤æ“Šå°‡å¤±æ•—ã€‚</p>
                    <div class="text-center mb-4">ç´…ç‡ˆå‡ºæ‰‹ï¼ˆ+10ï¼‰ï¼Œç™½ç‡ˆèª¤æ“Šï¼ˆ-1 æ¬¡æ©Ÿæœƒï¼‰ã€‚</div>
                    <div class="flex items-center justify-center gap-6 mb-4">
                        <div id="redLamp" class="w-16 h-16 rounded-full bg-red-200"></div>
                        <div id="whiteLamp" class="w-16 h-16 rounded-full bg-gray-200"></div>
                    </div>
                    <div class="text-center">å‰©é¤˜æ©Ÿæœƒï¼š<span id="kkLives" class="font-bold">3</span>ï½œå¾—åˆ†ï¼š<span id="kkScore" class="font-bold">0</span></div>
                    <div class="text-center mt-2">æ™‚é–“ï¼š<span id="kkTime" class="font-bold text-red-500">20</span> ç§’</div>
                </div>
            `;
            let lives = 3;
            let score = 0;
            let timeLeft = 20;
            const red = document.getElementById('redLamp');
            const white = document.getElementById('whiteLamp');
            function cycle() {
                const showRed = Math.random() < 0.5;
                red.style.backgroundColor = showRed ? '#ef4444' : '#fecaca';
                white.style.backgroundColor = showRed ? '#e5e7eb' : '#ffffff';
            }
            const cycler = setInterval(cycle, 700);
            function clickHandler() {
                if (red.style.backgroundColor === 'rgb(239, 68, 68)') {
                    score += 10; document.getElementById('kkScore').textContent = score;
                } else {
                    lives--; document.getElementById('kkLives').textContent = lives;
                    if (lives <= 0) finish();
                }
            }
            red.onclick = clickHandler; white.onclick = clickHandler;
            const timer = setInterval(() => {
                timeLeft--; document.getElementById('kkTime').textContent = timeLeft;
                if (timeLeft <= 0) finish();
            }, 1000);
            function finish() {
                clearInterval(cycler); clearInterval(timer);
                red.onclick = null; white.onclick = null;
                const ok = score >= 40 && lives > 0;
                gameState.flags.defeatedKongkong = ok;
                gainExp(Math.max(40, Math.floor(score/2)));
                adjustStats({ skill: ok ? 12 : 6, reputation: ok ? 10 : 5, peace: ok ? 6 : -6 });
                showCustomAlert(ok ? "å¦™æ‰‹ç©ºç©ºå…’äº¦æ–ƒã€‚åŠ‰å…¬æ­æ›°ï¼šã€å„è¦ªå…¶ä¸»ï¼Œäººä¹‹å¸¸äº‹ã€‚ã€ä»Šå¾Œç„¡ç›¸ç–‘çŸ£ã€‚" : "ç©ºç©ºå…’å»ï¼Œé¢¨è²æ›´æ€¥ã€‚ç„¶åŠ‰å…¬å¯¬åšï¼Œä»åŠ åº‡è­·ã€‚", () => {
                    unlockChapter(5);
                    goToChapter(5);
                });
            }
        }

        function adjustStats(changes) {
            for (const [stat, change] of Object.entries(changes)) {
                gameState.stats[stat] = Math.max(0, Math.min(100, gameState.stats[stat] + change));
            }
            updateUI();
        }

        function adjustCombat(changes) {
            for (const [stat, change] of Object.entries(changes)) {
                if (stat === 'health' || stat === 'magic') {
                    gameState.combat[stat] = Math.max(0, Math.min(gameState.combat[`max${stat.charAt(0).toUpperCase() + stat.slice(1)}`], gameState.combat[stat] + change));
                } else {
                    gameState.combat[stat] = Math.max(1, Math.min(gameState.level + 9, gameState.combat[stat] + change));
                }
            }
            updateUI();
        }

        function gainExp(amount) {
            gameState.exp += amount;
            checkLevelUp();
            updateUI();
        }

        function checkLevelUp() {
            while (gameState.exp >= gameState.expToNext && gameState.level < 10) {
                gameState.exp -= gameState.expToNext;
                gameState.level++;
                gameState.expToNext = Math.floor(gameState.expToNext * 1.2);
                
                // Level up bonuses
                adjustCombat({ 
                    attack: 1, 
                    defense: 1, 
                    maxHealth: 1, 
                    maxMagic: 1,
                    health: 1,
                    magic: 1
                });
                
                showCustomAlert(`æ­å–œï¼ç­‰ç´šæå‡è‡³ ${gameState.level} ç´šï¼æ‰€æœ‰èƒ½åŠ›å€¼æå‡ï¼`, null);
            }
        }

        function updateUI() {
            document.getElementById('playerLevel').textContent = `ç­‰ç´š: ${gameState.level}`;
            document.getElementById('modalLevel').textContent = gameState.level;
            document.getElementById('modalExp').textContent = `${gameState.exp}/${gameState.expToNext}`;
            
            // Update stat bars
            const stats = ['emotion', 'reputation', 'peace', 'skill'];
            stats.forEach(stat => {
                const value = gameState.stats[stat];
                document.getElementById(`${stat}Value`).textContent = value;
                document.getElementById(`${stat}Bar`).style.width = `${value}%`;
            });

            // Update combat stats
            document.getElementById('attackValue').textContent = gameState.combat.attack;
            document.getElementById('defenseValue').textContent = gameState.combat.defense;
            document.getElementById('healthValue').textContent = `${gameState.combat.health}/${gameState.combat.maxHealth}`;
            document.getElementById('magicValue').textContent = `${gameState.combat.magic}/${gameState.combat.maxMagic}`;

            // Update chapter buttons
            document.querySelectorAll('.chapter-btn').forEach(btn => {
                const chapter = parseInt(btn.dataset.chapter);
                btn.disabled = !gameState.unlockedChapters.includes(chapter);
            });
        }

        function unlockChapter(chapterNum) {
            if (!gameState.unlockedChapters.includes(chapterNum)) {
                gameState.unlockedChapters.push(chapterNum);
                updateUI();
            }
        }

        function displayScene(chapter, scene) {
            const chapterData = chapters[chapter];
            const sceneData = chapterData.scenes[scene];
            
            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-3xl font-bold mb-6 text-primary">${chapterData.title}</h2>
                    <div class="prose dark:prose-invert max-w-none mb-6">
                        <p class="text-lg leading-relaxed whitespace-pre-line ancient-text">${sceneData.text}</p>
                    </div>
                    <div class="space-y-3">
                        ${sceneData.choices.map((choice, index) => `
                            <button class="choice-btn w-full text-left p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-primary hover:text-white transition-colors"
                                    onclick="makeChoice(${chapter}, ${scene}, ${index})">
                                ${choice.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function makeChoice(chapter, scene, choiceIndex) {
            const sceneData = chapters[chapter].scenes[scene];
            const choice = sceneData.choices[choiceIndex];
            
            // Record choice
            gameState.choices.push({
                chapter,
                scene,
                choice: choiceIndex,
                text: choice.text
            });

            // Apply effects
            if (choice.effects) {
                adjustStats(choice.effects);
            }
            
            if (choice.combat) {
                adjustCombat(choice.combat);
            }
            
            if (choice.exp) {
                gainExp(choice.exp);
            }

            // Handle next action
            if (choice.next === "combat") {
                startCombatGame();
            } else if (choice.next === "vocab_quiz") {
                startVocabQuiz();
            } else if (choice.next === "punctuation_quiz") {
                startPunctuationQuiz();
            } else if (choice.next === "hair_token") {
                startHairTokenMission();
            } else if (choice.next === "fight_jingjing") {
                startJingjingFight();
            } else if (choice.next === "fight_kongkong") {
                startKongkongStealth();
            } else if (choice.next === "ending") {
                showEnding();
            } else if (typeof choice.next === "string" && choice.next.startsWith("chapter")) {
                const nextChapter = parseInt(choice.next.replace("chapter", ""));
                unlockChapter(nextChapter);
                goToChapter(nextChapter);
            } else if (typeof choice.next === "number") {
                gameState.currentScene = choice.next;
                displayScene(chapter, choice.next);
            }
        }

        function goToChapter(chapterNum) {
            if (!gameState.unlockedChapters.includes(chapterNum)) {
                showCustomAlert("æ­¤ç« ç¯€å°šæœªè§£é–ï¼", null);
                return;
            }
            
            gameState.currentChapter = chapterNum;
            gameState.currentScene = 0;
            displayScene(chapterNum, 0);
        }

        function proceedToNextChapter() {
            const nextChapter = gameState.currentChapter + 1;
            if (nextChapter <= 5) {
                unlockChapter(nextChapter);
                goToChapter(nextChapter);
            } else {
                showEnding();
            }
        }

        function showEnding() {
            const { emotion, reputation, peace, skill } = gameState.stats;
            let ending = "";
            
            if (peace >= 70) {
                ending = `
                    <h3 class="text-2xl font-bold text-green-600 mb-4">é€é™å±±æ°´çš„çµå±€</h3>
                    <p class="ancient-text">å¦³é¸æ“‡äº†é é›¢å¡µä¸–ï¼Œå°‹å±±è¨ªæ°´ã€‚åœ¨æ·±å±±ä¸­ï¼Œå¦³æ‰¾åˆ°äº†å…§å¿ƒçš„å¹³éœï¼Œæˆç‚ºäº†ä¸€ä»£å®—å¸«ã€‚å¾Œä¸–å‚³èªªï¼Œæ™‚æœ‰äººåœ¨åå±±å¤§å·ä¸­è¦‹åˆ°ä¸€ä½é£„é€¸çš„å¥³å­ï¼Œèº«æ³•å¦‚ä»™ï¼Œä¾¿æ˜¯è¶éš±å¨˜çš„å‚³èªªã€‚</p>
                `;
            } else if (reputation >= 70 && emotion >= 60) {
                ending = `
                    <h3 class="text-2xl font-bold text-yellow-600 mb-4">å¿ ç¾©é›™å…¨çš„çµå±€</h3>
                    <p class="ancient-text">å¦³æˆç‚ºäº†ä¸€ä»£åå°‡ï¼Œæ—¢æœ‰é«˜è¶…æ­¦è—ï¼Œåˆæœ‰å¿ ç¾©ä¹‹å¿ƒã€‚å¦³çš„å‚³å¥‡æ•…äº‹è¢«å¾Œä¸–å‚³é Œï¼Œæˆç‚ºæ­¦æ—ä¸­äººäººæ•¬ä»°çš„æ¥·æ¨¡ã€‚</p>
                `;
            } else if (emotion >= 70) {
                ending = `
                    <h3 class="text-2xl font-bold text-pink-600 mb-4">æƒ…æ·±ç¾©é‡çš„çµå±€</h3>
                    <p class="ancient-text">å¦³é¸æ“‡äº†æ„›æƒ…å’Œå®¶åº­ï¼Œèˆ‡ç£¨é¡å°‘å¹´éä¸Šäº†å¹³å‡¡è€Œå¹¸ç¦çš„ç”Ÿæ´»ã€‚é›–ç„¶æ±Ÿæ¹–ä¸Šå°‘äº†ä¸€ä½å‚³å¥‡ï¼Œä½†å¦³æ‰¾åˆ°äº†å±¬æ–¼è‡ªå·±çš„å¹¸ç¦ã€‚</p>
                `;
            } else if (skill >= 80) {
                ending = `
                    <h3 class="text-2xl font-bold text-red-600 mb-4">æ­¦å­¸è‡³å°Šçš„çµå±€</h3>
                    <p class="ancient-text">å¦³æˆç‚ºäº†æ±Ÿæ¹–ä¸Šæœ€é ‚å°–çš„åˆºå®¢ï¼Œæ­¦åŠŸè“‹ä¸–ã€‚ä½†å…§å¿ƒçš„å­¤ç¨ä¹Ÿå¦‚å½±éš¨å½¢ã€‚å¦³æ˜¯æ±Ÿæ¹–çš„å‚³èªªï¼Œä¹Ÿæ˜¯å­¤ç¨çš„ç‹è€…ã€‚</p>
                `;
            } else {
                ending = `
                    <h3 class="text-2xl font-bold text-gray-600 mb-4">å¹³å‡¡äººç”Ÿçš„çµå±€</h3>
                    <p class="ancient-text">å¦³é¸æ“‡äº†å¹³å‡¡çš„ç”Ÿæ´»ï¼Œé›–ç„¶æ²’æœ‰é©šå¤©å‹•åœ°çš„å‚³å¥‡ï¼Œä½†ä¹Ÿæ²’æœ‰å¤ªå¤šçš„ç—›è‹¦ã€‚åœ¨å¹³éœä¸­åº¦éäº†ä¸€ç”Ÿã€‚</p>
                `;
            }

            const content = document.getElementById('gameContent');
            content.innerHTML = `
                <div class="fade-in text-center">
                    <h2 class="text-4xl font-bold mb-8 text-primary">è¶éš±å¨˜å‚³ - å®Œ</h2>
                    ${ending}
                    <div class="mt-8 p-6 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <h4 class="text-xl font-bold mb-4">æœ€çµ‚å±¬æ€§</h4>
                        <div class="grid grid-cols-2 gap-4 text-left">
                            <div>ç­‰ç´š: ${gameState.level}</div>
                            <div>ç¶“é©—å€¼: ${gameState.exp}</div>
                            <div>æƒ…æ„Ÿç¾ˆçµ†: ${emotion}</div>
                            <div>æ±Ÿæ¹–è²æœ›: ${reputation}</div>
                            <div>å…§å¿ƒå¹³éœ: ${peace}</div>
                            <div>æ­¦å­¸é€ è©£: ${skill}</div>
                            <div>æ”»æ“ŠåŠ›: ${gameState.combat.attack}</div>
                            <div>é˜²ç¦¦åŠ›: ${gameState.combat.defense}</div>
                            <div>ç¾Šè§’åŒ•é¦–ï¼š${gameState.flags.hasHornDagger ? 'å·²ç²' : 'æœªå¾—'}</div>
                            <div>å‰ªé«®ç´…ç¶ƒï¼š${gameState.flags.hairTokenSent ? 'å·²é€é”' : 'æœªé€é”'}</div>
                        </div>
                    </div>
                    <button onclick="location.reload()" class="mt-6 px-8 py-3 bg-primary text-white rounded-lg hover:opacity-90">
                        é‡æ–°é–‹å§‹éŠæˆ²
                    </button>
                </div>
            `;
        }

        // Event Listenersï¼ˆå·²æ”¹ç‚ºå³å´å¸¸é§å±¬æ€§é¢æ¿ï¼Œç„¡éœ€å½ˆçª—ï¼‰

        // Initialize Game
        function initGame() {
            updateUI();
            displayScene(1, 0);
        }

        // Start the game
        initGame();
    </script>

</body></html>