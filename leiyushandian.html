<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雷雨 - 躲避閃電遊戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes flash {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        @keyframes screenFlash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }
        
        /* 全局色彩變量 - 改用劇作《雷雨》意象配色方案 */
        :root {
            /* 主色調 */
            --thunder-deep: #0A1620; /* 雷暴深空 */
            --wood-brown: #2B1E1A; /* 朽木暗棕 */
            --iron-gray: #3A3A3A; /* 鐵鏽灰 */
            
            /* 輔助色調 */
            --lightning-white: #E0EBF5; /* 閃電冷白 */
            --rain-blue: #1D2B3F; /* 陰雨墨藍 */
            --moss-green: #394D3B; /* 苔蘚綠 */
            
            /* 點綴色 */
            --electric-yellow: #FFE74C; /* 硫磺電光 */
            --blood-rust: #6B2A2A; /* 血鏽紅 */
            --deep-desire: #2A3D5C; /* 暗潮靛青 */
            
            /* 保留的交互色 */
            --thunder-blue: #1D2B3F; /* 替換為陰雨墨藍 */
            --thunder-blue-light: #2A3D5C; /* 替換為暗潮靛青 */
            --thunder-blue-dark: #0A1620; /* 替換為雷暴深空 */
            --thunder-blue-bright: #E0EBF5; /* 替換為閃電冷白 */
            --thunder-blue-accent: #2A3D5C; /* 替換為暗潮靛青 */
            --thunder-blue-deep: #0A1620; /* 替換為雷暴深空 */
            --storm-gray: #3A3A3A; /* 替換為鐵鏽灰 */
            --storm-gray-light: #4A5055; /* 稍微淺一些的鐵鏽灰 */
            --storm-gray-dark: #2B1E1A; /* 替換為朽木暗棕 */
            --lightning-blue: #E0EBF5; /* 替換為閃電冷白 */
            --accent-color: #2A3D5C; /* 替換為暗潮靛青 */
            --neon-blue: #E0EBF5; /* 替換為閃電冷白 */
            --neon-blue-glow: #FFE74C; /* 替換為硫磺電光 */
        }
        
        /* 霓虹燈效果 - 使用藍白色電流配色 */
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 5px rgba(160, 220, 255, 0.4), 0 0 10px rgba(120, 190, 255, 0.3); }
            50% { text-shadow: 0 0 10px rgba(160, 220, 255, 0.9), 0 0 20px rgba(120, 190, 255, 0.7), 0 0 30px rgba(255, 255, 255, 0.5), 0 0 40px rgba(70, 150, 255, 0.6); }
        }
        
        .neon-text {
            color: #a0e8ff;
            animation: neonPulse 2s infinite;
            letter-spacing: 1px;
        }
        
        /* UI主題適配 */
        .bg-primary {
            background-color: var(--deep-desire) !important;
        }
        .text-primary {
            color: var(--electric-yellow) !important;
        }
        .border-primary {
            border-color: var(--electric-yellow) !important;
        }
        
        /* 調整主要按鈕樣式 */
        .character-btn, #restart-btn {
            background-color: var(--deep-desire) !important;
            background-image: linear-gradient(to bottom right, var(--deep-desire), var(--thunder-deep)) !important;
            border: 1px solid var(--rain-blue) !important;
            box-shadow: 0 2px 10px rgba(10, 22, 32, 0.5) !important;
        }
        
        /* 自定義其他色彩覆蓋 */
        .bg-blue-900 {
            background-color: var(--thunder-deep) !important;
        }
        .border-blue-500 {
            border-color: var(--electric-yellow) !important;
        }
        .text-blue-300 {
            color: var(--lightning-white) !important;
        }
        .bg-yellow-700, .text-yellow-200 {
            color: var(--electric-yellow) !important;
        }
        .text-yellow-300 {
            color: var(--electric-yellow) !important;
        }
        
        /* 暗色模式調整 */
        .dark .bg-gray-800 {
            background-color: var(--thunder-deep) !important;
        }
        .dark .bg-gray-900 {
            background-color: var(--wood-brown) !important;
        }
        .dark .border-blue-500 {
            border-color: var(--deep-desire) !important;
        }
        .dark .text-blue-300 {
            color: var(--lightning-white) !important;
        }
        @keyframes strongShake {
            0%, 100% { transform: translateX(0); }
            10%, 50%, 90% { transform: translateX(-10px); }
            30%, 70% { transform: translateX(10px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes blinkCursor {
            0%, 100% { border-right-color: transparent; }
            50% { border-right-color: white; }
        }
        @keyframes rainDrop {
            0% { transform: translateY(-100%); opacity: 0.7; }
            100% { transform: translateY(100vh); opacity: 0.4; }
        }
        /* 經典台詞動畫 - 改為藍白色電流效果 */
        @keyframes quoteGlow {
            0%, 100% { text-shadow: 0 0 5px rgba(120, 190, 255, 0.5); }
            50% { text-shadow: 0 0 15px rgba(160, 220, 255, 0.8), 0 0 20px rgba(120, 190, 255, 0.6), 0 0 30px rgba(255, 255, 255, 0.6); }
        }
        @keyframes quoteBoxGlow {
            0%, 100% { box-shadow: inset 0 0 8px rgba(70, 140, 255, 0.3); }
            50% { box-shadow: inset 0 0 15px rgba(100, 170, 255, 0.5), 0 0 10px rgba(200, 225, 255, 0.4), 0 0 30px rgba(60, 120, 200, 0.3); }
        }
        @keyframes lightningGlow {
            0%, 100% { text-shadow: 0 0 5px rgba(160, 220, 255, 0.7), 0 0 10px rgba(255, 255, 255, 0.3); }
            50% { text-shadow: 0 0 10px rgba(100, 170, 255, 0.9), 0 0 20px rgba(160, 220, 255, 0.8), 0 0 30px rgba(255, 255, 255, 0.6), 0 0 40px rgba(70, 150, 255, 0.6); }
        }
        .lightning-glow {
            animation: lightningGlow 2s infinite ease-in-out;
        }
        @keyframes quotePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .quote-highlight {
            animation: quoteBoxGlow 2s infinite ease-in-out;
        }
        .animate-quote-text {
            animation: quoteGlow 2s infinite ease-in-out;
        }
        .shadow-text {
            text-shadow: 0 0 10px rgba(255, 231, 76, 0.7), 0 0 20px rgba(107, 42, 42, 0.4);
        }
        .pulse-quote {
            animation: quotePulse 2s infinite ease-in-out;
        }
        .lightning-flash {
            animation: flash 0.3s ease-in-out;
        }
        .screen-flash {
            animation: screenFlash 0.5s ease-in-out;
        }
        .strong-shake {
            animation: strongShake 0.8s ease-in-out;
        }
        .animate-fade-in {
            animation: fadeIn 1s ease-out;
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        .dark .game-canvas {
            filter: brightness(0.9) contrast(1.1);
        }
        .character {
            transition: left 0.1s ease-out;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
            background-color: var(--thunder-deep);
        }
        
        /* 縱向遊戲布局 - 極限優化以完全避免滾動 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden !important;
            touch-action: manipulation;
            background-color: var(--thunder-deep);
            overscroll-behavior: none;
            position: fixed;
            inset: 0;
            width: 100%;
        }
        
        /* 添加下雨動畫 */
        @keyframes rainfall {
            0% { opacity: 0.7; transform: translateY(-5px); }
            100% { opacity: 0.5; transform: translateY(600px); }
        }
        
        .rain-drop {
            position: absolute;
            width: 1.5px;
            height: 15px;
            background: linear-gradient(to bottom, rgba(200,220,255,0.9), rgba(180,200,255,0.7));
            transform: rotate(10deg);
            animation: rainfall 1s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        .big-rain-drop {
            width: 2px;
            height: 20px;
            opacity: 0.8;
        }
        
        #rain-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
            position: absolute;
            inset: 0;
        }
        
        footer {
            flex-shrink: 0;
            padding: 1px 0;
            height: auto;
            font-size: 0.65rem;
            line-height: 1;
        }
        
        .game-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 0;
            min-height: 0;
            width: 100%;
        }
        
        .game-container {
            position: relative;
            width: min(98%, 410px);
            height: min(98%, calc(98vh - 20px));
            aspect-ratio: 9/16;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* 極小屏幕優化 */
        @media (max-height: 500px) {
            .game-container {
                height: min(99%, calc(99vh - 12px));
                border-radius: 0.25rem;
            }
            
            footer {
                padding: 0;
                font-size: 0.6rem;
            }
            
            /* 極小的元素間距 */
            #start-screen, #game-over {
                padding: 1px !important;
            }
            
            /* 移除開始屏幕和結束屏幕的元素間距 */
            #start-screen .max-w-md, #game-over .max-w-md {
                margin-bottom: 1px !important;
                padding: 1px !important;
            }
            
            #start-screen .mb-4, #game-over .mb-4,
            #start-screen .mb-3, #game-over .mb-3,
            #start-screen .mb-2, #game-over .mb-2 {
                margin-bottom: 1px !important;
            }
            
            #start-screen .px-4, #game-over .px-4 {
                padding-left: 2px !important;
                padding-right: 2px !important;
            }
            
            #start-screen .py-3, #game-over .py-3,
            #start-screen .py-2, #game-over .py-2,
            #start-screen .py-1, #game-over .py-1 {
                padding-top: 1px !important;
                padding-bottom: 1px !important;
            }
        }
        
        /* 橫屏模式優化 */
        @media (orientation: landscape) and (max-height: 450px) {
            .game-container {
                height: 99vh;
                width: calc(99vh * 9/16);
                max-width: min(65vw, 410px);
                border-radius: 0.25rem;
            }
            
            /* 減小角色選擇網格間距 */
            #start-screen .gap-2 {
                gap: 0.25rem !important;
            }
            
            /* 減小角色按鈕內部間距 */
            .character-btn {
                padding: 0.25rem !important;
            }
        }
        
        /* 狀態提示欄 */
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            z-index: 20;
        }
        
        .quote-bubble {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            max-width: 80%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .typewriter-cursor {
            border-right: 2px solid white;
            animation: blinkCursor 0.7s infinite;
        }
        
        .rain-drop {
            position: absolute;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(200,220,255,0.5));
            width: 1px;
            height: 15px;
            animation: rainDrop linear;
            pointer-events: none;
        }
        
        .button-highlight:active {
            transform: scale(0.98);
            box-shadow: 0 0 10px 3px rgba(255, 255, 100, 0.4);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-800 dark:text-gray-200 transition-colors">
    <div id="app-container" class="pt-0.5 pb-0.5">
        <!-- 移除顶部标题 -->

        <div class="game-wrapper">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden game-container">
                <!-- 遊戲界面 -->
                <div id="game-container" class="w-full h-full relative">
                    <canvas id="game-canvas" class="game-canvas absolute top-0 left-0 w-full h-full"></canvas>
                    
                    <!-- 背景音樂 -->
                    <audio id="background-music" loop preload="auto">
                        <source src="https://chineseclassics.github.io/sound/leiyu/leiyu.mp3" type="audio/mpeg">
                        您的瀏覽器不支持音頻播放。
                    </audio>
                    
                    <!-- 音樂控制按鈕 -->
                    <button id="music-toggle" class="absolute top-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-gray-900 to-gray-800 text-white rounded-full border border-blue-500 border-opacity-30 shadow-lg flex items-center justify-center hover:from-gray-800 hover:to-gray-700 transition-all duration-300">
                        <svg id="music-on-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0 11.249 11.249 0 010 15.788.75.75 0 11-1.06-1.06 9.749 9.749 0 000-13.668.75.75 0 010-1.06z" />
                            <path d="M16.024 9.106a.75.75 0 01.976.04 4.5 4.5 0 010 6.708.75.75 0 11-1.051-1.071 3 3 0 000-4.566.75.75 0 01.075-1.111z" />
                        </svg>
                        <svg id="music-off-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden">
                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                        </svg>
                    </button>
                    
                    <div id="character" class="character absolute bottom-6 h-16 w-16 transform -translate-x-1/2 hidden">
                        <img id="character-img" src="" alt="角色" class="w-full h-full">
                    </div>
                    
                    <!-- 背景雨滴容器 -->
                    <div id="rain-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
                    
                    <!-- 狀態欄 -->
                    <div id="status-bar" class="status-bar hidden">
                        <div>
                            <span class="font-medium">分數: </span>
                            <span id="score" class="font-bold text-primary">0</span>
                        </div>
                        <div>
                            <span class="font-medium">難度: </span>
                            <span id="level" class="font-bold text-primary">1</span>
                        </div>
                    </div>
                    
                    <!-- 雨滴背景效果 -->
                    <div id="rain-effect"></div>
                
                    <!-- 開始界面 - 完全重新設計，使用Flexbox精確控制佈局 -->
                    <div id="start-screen" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-60 text-white overflow-hidden">
                        <!-- 使用固定高度容器和Flexbox進行精確內容分配 -->
                        <div class="relative h-full w-full max-w-xl flex flex-col justify-between py-2">
                            <!-- 頂部標題區 - 炫酷設計，添加 mt-10 向下移動更多 -->
                            <div class="mt-10 mb-3 relative">
                                <!-- 閃電背景效果 -->
                                <div class="absolute inset-0 overflow-hidden">
                                    <div class="absolute top-0 left-1/4 w-8 h-20 opacity-20">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div class="absolute top-5 right-1/4 w-6 h-14 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- 閃電邊框效果 -->
                                <div class="px-3 py-3 bg-gradient-to-br from-blue-900 to-indigo-900 rounded-lg border border-blue-400 border-opacity-40 mx-auto max-w-md shadow-lg relative overflow-hidden">
                                    <!-- 脈衝光暈效果 -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-500 opacity-20 animate-pulse"></div>
                                    
                                    <!-- 閃電裝飾 -->
                                    <div class="absolute -left-2 top-1/2 transform -translate-y-1/2 rotate-45 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700" class="w-14 h-14">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div class="absolute -right-2 top-1/2 transform -translate-y-1/2 -rotate-45 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700" class="w-14 h-14">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    
                                    <!-- 標題文本 -->
                                    <h1 class="text-2xl font-bold text-center neon-text tracking-wide lightning-glow animate-pulse-quote relative z-10">躲避《雷雨》閃電！</h1>
                                    <p class="text-sm text-center text-blue-100 mt-2 relative z-10">《雷雨》是曹禺的經典悲劇，講述周家三十年間的家庭悲劇。你將扮演劇中角色躲避命運的閃電！</p>
                                </div>
                            </div>
                            
                            <!-- 中間內容區 - 優化垂直排版 -->
                            <div class="flex flex-col space-y-3">
                                <!-- 角色選擇區 - 卡片設計 -->
                                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-lg border border-blue-500 border-opacity-30 overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-800 to-indigo-900 px-3 py-1.5">
                                        <h2 class="text-sm font-bold tracking-wide text-center relative neon-text inline-flex items-center justify-center w-full">
                                            <span class="absolute left-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                                                </svg>
                                            </span>
                                            選擇《雷雨》角色
                                            <span class="absolute right-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                                                </svg>
                                            </span>
                                        </h2>
                                    </div>
                                    
                                    <!-- 角色選擇 - 採用3列佈局，改進視覺設計 -->
                                    <div class="grid grid-cols-3 gap-1.5 w-full p-2">
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="周樸園" data-quote="我的家庭是我認為最圓滿、最有秩序的家庭。" data-act="一幕" data-ability="威權力場" data-activation="空格鍵/長按" data-cooldown="30秒冷卻">
                                            <span class="font-bold text-blue-50">周樸園</span>
                                            <span class="text-[10px] text-blue-200">富商</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-yellow-700 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                威權力場
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="周萍" data-quote="我恨這種不自然的關係！" data-act="二幕" data-ability="優柔瞬移" data-activation="空格鍵/長按" data-cooldown="20秒冷卻">
                                            <span class="font-bold text-blue-50">周萍</span>
                                            <span class="text-[10px] text-blue-200">長子</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-blue-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                優柔瞬移
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="周沖" data-quote="爸爸，這是不公平的！" data-act="一幕" data-ability="青春衝刺" data-activation="空格鍵/長按" data-cooldown="15秒冷卻">
                                            <span class="font-bold text-blue-50">周沖</span>
                                            <span class="text-[10px] text-blue-200">次子</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-green-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                青春衝刺
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="魯侍萍" data-quote="命，不公平的命指使我來的！" data-act="二幕" data-ability="隱忍堅韌" data-activation="空格鍵/長按" data-cooldown="60秒冷卻">
                                            <span class="font-bold text-blue-50">魯侍萍</span>
                                            <span class="text-[10px] text-blue-200">前妻</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-purple-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                隱忍堅韌
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="繁漪" data-quote="熱極了，悶極了，這裡真是再也不能住的。" data-act="一幕" data-ability="情感庇護" data-activation="空格鍵/長按" data-cooldown="25秒冷卻">
                                            <span class="font-bold text-blue-50">繁漪</span>
                                            <span class="text-[10px] text-blue-200">現妻</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-red-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                情感庇護
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="四鳳" data-quote="讓天上的雷劈了我吧！" data-act="四幕" data-ability="預知閃避" data-activation="空格鍵/長按" data-cooldown="40秒冷卻">
                                            <span class="font-bold text-blue-50">四鳳</span>
                                            <span class="text-[10px] text-blue-200">女僕</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-amber-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                預知閃避
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- 控制說明放在角色區域下方 - 改進排版設計 -->
                                    <div class="px-3 py-2 bg-gradient-to-r from-gray-900 to-gray-800 border-t border-blue-900 border-opacity-40">
                                        <div class="text-[10px] text-blue-200 grid grid-cols-2 gap-1">
                                            <div class="flex flex-col items-center">
                                                <span class="font-medium text-blue-300 mb-1 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 mr-1 text-yellow-300">
                                                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
                                                    </svg>
                                                    電腦
                                                </span>
                                                <div class="text-left w-full">
                                                    <div>• 方向鍵/A/D鍵移動</div>
                                                    <div>• 空格鍵激活能力</div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <span class="font-medium text-blue-300 mb-1 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 mr-1 text-yellow-300">
                                                        <path fill-rule="evenodd" d="M3.5 2A1.5 1.5 0 005 3.5V4h10v-.5A1.5 1.5 0 0016.5 2h-13zM6 8V6h8v2H6zM5 9.5A1.5 1.5 0 006.5 11h7a1.5 1.5 0 001.5-1.5V9H5v.5zm2 4.5h6v2H7v-2z" clip-rule="evenodd" />
                                                    </svg>
                                                    手機
                                                </span>
                                                <div class="text-left w-full">
                                                    <div>• 點擊左右移動</div>
                                                    <div>• 長按/雙擊激活能力</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 角色能力懸停氣泡 - 升級版設計，確保其在遊戲框架內完整顯示 -->
                                    <div class="hidden absolute z-10 w-52 bg-gradient-to-br from-gray-900 to-indigo-950 text-white p-2.5 rounded-lg shadow-xl border border-blue-500 border-opacity-30 pointer-events-none" id="ability-tooltip">
                                        <div class="flex justify-between items-center">
                                            <div class="text-sm font-bold text-primary ability-name"></div>
                                            <div class="text-[8px] px-1.5 py-0.5 bg-blue-600 bg-opacity-70 rounded-md ability-activation"></div>
                                        </div>
                                        <div class="text-[10px] mt-1.5 text-gray-200 ability-desc"></div>
                                        <div class="text-[9px] mt-1 italic text-blue-300 ability-note"></div>
                                        <div class="mt-1.5 flex justify-between items-center text-[9px]">
                                            <div class="text-yellow-300 ability-cooldown"></div>
                                            <div class="text-white px-1.5 py-0.5 bg-primary bg-opacity-50 rounded-sm ability-usage"></div>
                                        </div>
                                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30"></div>
                                    </div>
                                </div>
                                
                                <!-- 道具區 - 卡片設計 -->
                                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-lg border border-blue-500 border-opacity-30 overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-800 to-indigo-900 px-3 py-1.5">
                                        <h3 class="text-sm font-bold tracking-wide text-center relative neon-text inline-flex items-center justify-center w-full">
                                            <span class="absolute left-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V9.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15.211 6.276a1 1 0 000-1.788l-4.764-2.382a1 1 0 00-.894 0L4.789 4.488a1 1 0 000 1.788l4.764 2.382a1 1 0 00.894 0l4.764-2.382zM4.447 8.342A1 1 0 003 9.236V15a1 1 0 00.553.894l4 2A1 1 0 009 17v-5.764a1 1 0 00-.553-.894l-4-2z" />
                                                </svg>
                                            </span>
                                            《雷雨》意象道具
                                            <span class="absolute right-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V9.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15.211 6.276a1 1 0 000-1.788l-4.764-2.382a1 1 0 00-.894 0L4.789 4.488a1 1 0 000 1.788l4.764 2.382a1 1 0 00.894 0l4.764-2.382zM4.447 8.342A1 1 0 003 9.236V15a1 1 0 00.553.894l4 2A1 1 0 009 17v-5.764a1 1 0 00-.553-.894l-4-2z" />
                                                </svg>
                                            </span>
                                        </h3>
                                    </div>
                                    
                                    <div class="p-2">
                                        <!-- 使用比之前更簡潔的標題 -->
                                        <!-- 移除道具收集指南標題 -->
                                        
                                        <!-- 統一道具詳情顯示區域 -->
                                        <div class="flex flex-col space-y-2">
                                            <!-- 移除道具詳情顯示區域 -->
                                            
                                            <!-- 道具網格 - 上下分類加分和減分道具，不使用左右分隔 -->
                                            <div class="flex flex-col space-y-1.5">
                                                <!-- 加分道具區塊 -->
                                                <div class="bg-gray-800 bg-opacity-60 px-2 py-1 rounded-t-md">
                                                    <p class="text-[9px] text-green-400 text-center font-semibold">加分道具</p>
                                                </div>
                                                <!-- 加分道具網格 -->
                                                <div class="grid grid-cols-6 gap-0.5 text-center mb-2">
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="umbrella" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">☂️</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">雨傘</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+30</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="letter" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">✉</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">信件</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+20</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="window" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">🪟</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">窗戶</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+25</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="fan" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">🪭</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">摺扇</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+40</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="tigerShoes" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">👟</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">虎頭鞋</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+35</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="photo" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">🖼️</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">照片</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+50</div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 減分道具區塊 -->
                                                <div class="bg-gray-800 bg-opacity-60 px-2 py-1 rounded-t-md">
                                                    <p class="text-[9px] text-red-400 text-center font-semibold">減分道具</p>
                                                </div>
                                                <!-- 減分道具網格 -->
                                                <div class="grid grid-cols-6 gap-0.5 text-center">
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="medicine" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">💊</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">藥</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-15</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="oldHouse" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">🏚️</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">老房子</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-20</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="oldSofa" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">🛋️</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">老沙發</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-25</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="clock" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">⏰</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">時鐘</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-30</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="ghost" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">👻</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">鬼魂</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-40</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="check" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">💸</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">支票</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-45</div>
                                                    </div>
                                                </div>
                                            </div>
                                            

                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                    
                                    <!-- 彈出道具詳情的容器 -->
                                    <div id="item-detail-popup" class="hidden fixed top-0 left-0 right-0 bottom-0 z-[9999] flex items-center justify-center">
                                        <div class="absolute inset-0 bg-black bg-opacity-70"></div>
                                        <div class="relative bg-gray-800 rounded shadow-xl mx-4 border border-gray-700 transform transition-all w-[250px] max-h-[85%] overflow-auto">
                                            <div class="p-2">
                                                <div class="flex items-center mb-1">
                                                    <div id="popup-icon" class="w-6 h-6 rounded-full flex items-center justify-center mr-2"></div>
                                                    <h3 id="popup-title" class="text-sm font-bold text-white"></h3>
                                                    <button id="close-popup" class="ml-auto text-gray-400 hover:text-white p-1">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                                                    </button>
                                                </div>
                                                <div class="space-y-1">
                                                    <p id="popup-desc" class="text-xs text-gray-300"></p>
                                                    <div class="border-t border-gray-700 my-1 pt-1">
                                                        <p id="popup-quote" class="text-[10px] italic text-blue-300"></p>
                                                    </div>
                                                    <div>
                                                        <p id="popup-symbolism" class="text-[10px] text-gray-400"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 在意象道具說明區域的下方添加書院中文經典AI實驗室署名 -->
                                    <div class="text-center text-xs text-gray-500 dark:text-gray-400 mt-2 mb-2">
                                        書院中文經典AI實驗室
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 遊戲結束界面 -->
                    <div id="game-over" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-70 text-white hidden p-4 overflow-auto">
                        <h2 class="text-xl sm:text-2xl font-bold mb-2">雷擊！</h2>
                        <p class="text-lg mb-3">難逃命運的悲劇...</p>
                        <div class="px-5 py-4 bg-gray-800 bg-opacity-70 rounded-lg mb-3 w-full max-w-xs pulse-quote border border-blue-400 border-opacity-40 shadow-lg">
                            <div class="flex items-center justify-between mb-3">
                                <span id="act-indicator" class="text-xs bg-blue-700 bg-opacity-70 px-3 py-1 rounded-md shadow-md text-blue-100 font-medium">第一幕</span>
                                <span class="text-xs font-semibold text-blue-200">《雷雨》經典台詞</span>
                            </div>
                            <div class="quote-container relative p-4 rounded-lg bg-black bg-opacity-60 overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-full opacity-30">
                                    <!-- 藍色閃電背景圖案 -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-full h-full">
                                        <path d="M20,0 L5,30 L15,30 L0,60 L30,20 L20,20 Z" fill="rgba(180,220,255,0.8)" transform="translate(10,20) scale(0.8)"></path>
                                        <path d="M20,0 L5,30 L15,30 L0,60 L30,20 L20,20 Z" fill="rgba(140,200,255,0.8)" transform="translate(60,10) scale(0.6)"></path>
                                        <path d="M15,0 L5,25 L12,28 L0,50 L25,15 L15,15 Z" fill="rgba(100,180,255,0.7)" transform="translate(35,35) scale(0.5) rotate(30)"></path>
                                    </svg>
                                </div>
                                <p id="quote-character" class="text-sm text-blue-200 text-center mb-3 font-bold"></p>
                                <p id="character-quote" class="text-base italic text-center mb-2 min-h-[3.5rem] font-medium text-blue-50 tracking-wide leading-relaxed lightning-glow neon-text">"命運的記號，早已經刻在我的額上。"</p>
                                <div class="quote-highlight absolute top-0 left-0 w-full h-full rounded-lg" style="box-shadow: inset 0 0 15px rgba(100, 180, 255, 0.5), inset 0 0 30px rgba(70, 150, 255, 0.4); pointer-events: none;"></div>
                            </div>
                            <p id="character-analysis" class="text-sm text-blue-200 text-center mt-3 font-medium"></p>
                        </div>
                        <div class="px-4 py-3 bg-gray-800 bg-opacity-60 rounded-lg mb-4 w-full max-w-xs border border-blue-600 border-opacity-20">
                            <p id="plot-summary" class="text-xs text-center text-blue-100">《雷雨》開始時，故事發生在周樸園家中，一場雷雨即將來臨，暗示著將要發生的劇變。</p>
                        </div>
                        
                        <!-- 道具系統展示移除 -->
                        
                        <div class="text-center mb-4 w-full max-w-xs">
                            <p class="text-base">你的分數: <span id="final-score" class="font-bold text-primary">0</span></p>
                            <p class="text-base">最高分數: <span id="high-score" class="font-bold text-primary">0</span></p>
                        </div>
                        <button id="restart-btn" class="sound-btn button-highlight bg-blue-700 text-white font-bold py-2 px-6 rounded-full hover:bg-opacity-90 text-base transition-all neon-text">再試一次</button>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        // 檢測暗黑模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 遊戲邏輯
        document.addEventListener('DOMContentLoaded', function() {
            // 創建音頻上下文 - 初始化一次全局音頻上下文
            let audioContext;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('不支持音頻API:', e);
            }
            
            // 立即初始化音頻上下文 - 通過用戶交互解鎖
            document.addEventListener('click', function initAudio() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('AudioContext resumed successfully');
                    });
                }
                document.removeEventListener('click', initAudio);
            }, {once: true});
            
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const characterElement = document.getElementById('character');
            const characterImg = document.getElementById('character-img');
            const scoreElement = document.getElementById('score');
            const levelElement = document.getElementById('level');
            const startScreen = document.getElementById('start-screen');
            const gameOverScreen = document.getElementById('game-over');
            const finalScoreElement = document.getElementById('final-score');
            const highScoreElement = document.getElementById('high-score');
            const restartBtn = document.getElementById('restart-btn');
            const characterButtons = document.querySelectorAll('.character-btn');
            const gameContainer = document.getElementById('game-container');
            const rainContainer = document.getElementById('rain-container');
            const statusBar = document.getElementById('status-bar');
            
            let gameWidth, gameHeight;
            let characterWidth = 60;
            let characterHeight = 80;
            let characterX = 0;
            let character = '';
            let characterAbility = '';
            let score = 0;
            let level = 1;
            let lightning = [];
            let isGameRunning = false;
            let animationFrameId = null;
            let highScore = 0;
            let currentQuoteBubble = null;
            let frameCount = 0; // 用於控制分數增長速度的計數器
            
            // 角色技能相關變量
            let abilityActive = false;        // 技能是否激活
            let abilityCooldown = false;      // 技能是否在冷卻中
            let abilityDuration = 0;          // 技能持續時間計時器
            let abilityCooldownTime = 0;      // 技能冷卻計時器
            let invincible = false;           // 無敵狀態
            
            // 遊戲道具
            let items = [];                   // 掉落的道具
            let activeEffects = {};           // 激活的效果
            
            // 雨滴效果計時器
            let rainInterval;
            let raindropsCount = 0;
            const MAX_RAINDROPS = 80;
            
            // 背景音樂控制
            const backgroundMusic = document.getElementById('background-music');
            const musicToggle = document.getElementById('music-toggle');
            const musicOnIcon = document.getElementById('music-on-icon');
            const musicOffIcon = document.getElementById('music-off-icon');
            let isMusicPlaying = false;
            
            // 音樂控制函數
            function toggleMusic() {
                if (isMusicPlaying) {
                    backgroundMusic.pause();
                    musicOnIcon.classList.add('hidden');
                    musicOffIcon.classList.remove('hidden');
                    isMusicPlaying = false;
                } else {
                    // 嘗試播放音樂，如果失敗則靜默處理
                    backgroundMusic.play().then(() => {
                        musicOnIcon.classList.remove('hidden');
                        musicOffIcon.classList.add('hidden');
                        isMusicPlaying = true;
                    }).catch(error => {
                        console.log('無法播放背景音樂:', error);
                        // 如果自動播放被阻止，顯示提示
                        showMusicAlert();
                    });
                }
            }
            
            // 顯示音樂播放提示
            function showMusicAlert() {
                const alert = document.createElement('div');
                alert.className = 'fixed top-20 left-4 bg-gradient-to-br from-gray-900 to-gray-800 text-white p-3 rounded-lg border border-blue-500 border-opacity-30 shadow-lg z-50 text-sm max-w-xs';
                alert.innerHTML = `
                    <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2 text-yellow-300 flex-shrink-0 mt-0.5">
                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06z" />
                        </svg>
                        <div>
                            <div class="font-medium">背景音樂提示</div>
                            <div class="text-xs text-gray-300 mt-1">請點擊音樂按鈕啟用背景音樂</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(alert);
                
                // 3秒後自動消失
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 3000);
            }
            
            // 初始化音樂控制
            musicToggle.addEventListener('click', toggleMusic);
            
            // 設置音樂默認音量
            backgroundMusic.volume = 0.3;
            
            // 當遊戲開始時嘗試播放背景音樂
            function startBackgroundMusic() {
                if (!isMusicPlaying) {
                    backgroundMusic.play().then(() => {
                        musicOnIcon.classList.remove('hidden');
                        musicOffIcon.classList.add('hidden');
                        isMusicPlaying = true;
                    }).catch(error => {
                        console.log('遊戲開始時無法自動播放音樂:', error);
                    });
                }
            }
            
            // 當遊戲結束時淡出音樂
            function fadeOutMusic() {
                if (isMusicPlaying && backgroundMusic) {
                    const fadeOutInterval = setInterval(() => {
                        if (backgroundMusic.volume > 0.05) {
                            backgroundMusic.volume -= 0.05;
                        } else {
                            backgroundMusic.pause();
                            backgroundMusic.volume = 0.3; // 重置音量為默認值
                            musicOnIcon.classList.add('hidden');
                            musicOffIcon.classList.remove('hidden');
                            isMusicPlaying = false;
                            clearInterval(fadeOutInterval);
                        }
                    }, 100);
                }
            }
            
            // 雷聲音效集
            const thunderSounds = [
                { frequency: [100, 30], type: 'sawtooth', duration: 0.5, volume: 0.2 },
                { frequency: [50, 20], type: 'square', duration: 0.6, volume: 0.15 },
                { frequency: [80, 15], type: 'triangle', duration: 0.4, volume: 0.25 },
                { frequency: [150, 40], type: 'sawtooth', duration: 0.3, volume: 0.18 },
                { frequency: [60, 10], type: 'square', duration: 0.7, volume: 0.22 }
            ];
            
            // 創建雨滴 - 不再使用，已被移除
            function createRaindrops() {
                // 功能已被移除，不執行任何操作
                return;
            }
            
            // 播放雷聲音效 - 擴展支持各角色專屬能力音效
            function playThunderSound(type = 'random') {
                if (!audioContext) return;
                
                try {
                    // 選擇音效類型
                    let soundProfile;
                    if (type === 'random') {
                        soundProfile = thunderSounds[Math.floor(Math.random() * thunderSounds.length)];
                    } else if (type === 'button') {
                        // 按鈕音效 - 更短更響亮
                        soundProfile = {
                            frequency: [120, 50],
                            type: 'triangle',
                            duration: 0.15,
                            volume: 0.12
                        };
                    } else if (type === 'big') {
                        // 大雷音效 - 更低沉更長
                        soundProfile = {
                            frequency: [80, 20],
                            type: 'sawtooth',
                            duration: 0.8,
                            volume: 0.25
                        };
                    } else if (type === 'death') {
                        // 死亡雷擊音效 - 更震撼
                        soundProfile = {
                            frequency: [60, 10],
                            type: 'sawtooth',
                            duration: 1.0,
                            volume: 0.3
                        };
                    } 
                    // 角色能力專屬音效
                    else if (type === 'ability_周樸園') {
                        // 威權力場 - 深沉威嚴的音效
                        soundProfile = {
                            frequency: [60, 40],
                            type: 'square',
                            duration: 0.6,
                            volume: 0.22,
                            // 添加連續低音效果
                            pulseCount: 3,
                            pulseInterval: 0.15
                        };
                    } else if (type === 'ability_周萍') {
                        // 優柔瞬移 - 短促的瞬移音效
                        soundProfile = {
                            frequency: [180, 300],
                            type: 'sine',
                            duration: 0.3,
                            volume: 0.15
                        };
                    } else if (type === 'ability_周沖') {
                        // 青春衝刺 - 充滿活力、高頻的衝刺音效
                        soundProfile = {
                            frequency: [220, 350],
                            type: 'triangle',
                            duration: 0.35,
                            volume: 0.18
                        };
                    } else if (type === 'ability_魯侍萍') {
                        // 隱忍堅韌 - 堅定、持久的護盾音效
                        soundProfile = {
                            frequency: [90, 120],
                            type: 'sine',
                            duration: 0.5,
                            volume: 0.2
                        };
                    } else if (type === 'ability_繁漪') {
                        // 情感庇護 - 情感化、波動的音效
                        soundProfile = {
                            frequency: [150, 180],
                            type: 'sine',
                            duration: 0.4,
                            volume: 0.18,
                            // 情感波動效果
                            modulation: true
                        };
                    } else if (type === 'ability_四鳳') {
                        // 預知閃避 - 神秘、預見性的音效
                        soundProfile = {
                            frequency: [200, 150],
                            type: 'sine',
                            duration: 0.5,
                            volume: 0.16,
                            // 預知特效 - 由高到低的音調
                            reverse: true,
                            echo: true
                        };
                    }
                    
                    // 創建音效
                    const oscillator = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    oscillator.type = soundProfile.type;
                    
                    // 處理特殊音效屬性
                    if (soundProfile.reverse) {
                        // 反向頻率變化（從高到低）
                        oscillator.frequency.setValueAtTime(soundProfile.frequency[0], audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(soundProfile.frequency[1], audioContext.currentTime + soundProfile.duration);
                    } else {
                        // 標準頻率變化（從低到高）
                        oscillator.frequency.setValueAtTime(soundProfile.frequency[0], audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(soundProfile.frequency[1], audioContext.currentTime + soundProfile.duration);
                    }
                    
                    // 情感波動效果
                    if (soundProfile.modulation) {
                        const modulator = audioContext.createOscillator();
                        const modulatorGain = audioContext.createGain();
                        
                        modulator.frequency.value = 8; // 波動速度
                        modulatorGain.gain.value = 30; // 波動強度
                        
                        modulator.connect(modulatorGain);
                        modulatorGain.connect(oscillator.frequency);
                        modulator.start();
                        modulator.stop(audioContext.currentTime + soundProfile.duration);
                    }
                    
                    gain.gain.setValueAtTime(soundProfile.volume, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + soundProfile.duration);
                    
                    oscillator.connect(gain);
                    
                    // 添加迴聲效果
                    if (soundProfile.echo) {
                        const delay = audioContext.createDelay();
                        const echoGain = audioContext.createGain();
                        
                        delay.delayTime.value = 0.2;
                        echoGain.gain.value = 0.3;
                        
                        gain.connect(delay);
                        delay.connect(echoGain);
                        echoGain.connect(audioContext.destination);
                    }
                    
                    gain.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + soundProfile.duration);
                    
                    // 處理脈衝音效（如周樸園的威權力場）
                    if (soundProfile.pulseCount && soundProfile.pulseInterval) {
                        let pulseCount = soundProfile.pulseCount;
                        const interval = soundProfile.pulseInterval;
                        const baseFreq = soundProfile.frequency[0];
                        
                        // 播放額外的脈衝音效
                        for (let i = 1; i < pulseCount; i++) {
                            setTimeout(() => {
                                const pulseOsc = audioContext.createOscillator();
                                const pulseGain = audioContext.createGain();
                                
                                pulseOsc.type = soundProfile.type;
                                pulseOsc.frequency.value = baseFreq * (1 - i * 0.1);
                                
                                pulseGain.gain.setValueAtTime(soundProfile.volume * 0.7, audioContext.currentTime);
                                pulseGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + soundProfile.duration * 0.7);
                                
                                pulseOsc.connect(pulseGain);
                                pulseGain.connect(audioContext.destination);
                                
                                pulseOsc.start();
                                pulseOsc.stop(audioContext.currentTime + soundProfile.duration * 0.7);
                            }, i * interval * 1000);
                        }
                    }
                } catch (e) {
                    console.log('音效播放失敗:', e);
                }
            }
            
            // 播放環境雷聲
            function playAmbientThunder() {
                if (isGameRunning) {
                    // 隨機決定是否播放
                    if (Math.random() < 0.1) {
                        playThunderSound('random');
                        
                        // 閃爍屏幕
                        if (Math.random() < 0.5) {
                            gameContainer.classList.add('screen-flash');
                            setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
                        }
                    }
                    setTimeout(playAmbientThunder, 5000 + Math.random() * 7000); // 每5-12秒嘗試播放一次
                }
            }
            
            // 為所有按鈕添加雷聲音效
            function addThunderSoundToButtons() {
                const buttons = document.querySelectorAll('.sound-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        playThunderSound('button');
                    });
                });
            }
            
            // 調整畫布大小為容器大小
            function resizeCanvas() {
                const container = document.getElementById('game-container');
                gameWidth = container.clientWidth;
                gameHeight = container.clientHeight;
                canvas.width = gameWidth;
                canvas.height = gameHeight;
                
                // 角色位置初始化
                if (isGameRunning && characterElement) {
                    characterX = gameWidth / 2;
                    characterElement.style.left = `${characterX}px`;
                    
                    // 更新台詞氣泡位置
                    updateQuoteBubblePosition();
                }
            }
            
            // 更新台詞氣泡位置
            function updateQuoteBubblePosition() {
                if (currentQuoteBubble && characterElement) {
                    currentQuoteBubble.style.left = `${characterX}px`;
                    currentQuoteBubble.style.bottom = `${characterHeight + 10}px`;
                }
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // 生成角色圖像
            function generateCharacterImage(name) {
                const colors = {
                    '周樸園': '#336699',
                    '周萍': '#3399CC',
                    '周沖': '#66CCFF',
                    '魯侍萍': '#CC6699',
                    '繁漪': '#FF6666',
                    '四鳳': '#FFCC66'
                };
                
                const canvas = document.createElement('canvas');
                canvas.width = 60;
                canvas.height = 80;
                const ctx = canvas.getContext('2d');
                
                // 繪製身體
                ctx.fillStyle = colors[name] || '#5D5CDE';
                ctx.beginPath();
                ctx.ellipse(30, 25, 15, 15, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(20, 40);
                ctx.quadraticCurveTo(30, 30, 40, 40);
                ctx.lineTo(40, 65);
                ctx.lineTo(20, 65);
                ctx.closePath();
                ctx.fill();
                
                // 繪製名字
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(name, 30, 55);
                
                return canvas.toDataURL();
            }
            
            // 獲取角色能力
            function getCharacterAbility(characterName) {
                const abilities = {
                    '周樸園': '威權力場',
                    '周萍': '優柔瞬移',
                    '周沖': '青春衝刺',
                    '魯侍萍': '隱忍堅韌',
                    '繁漪': '情感庇護',
                    '四鳳': '預知閃避'
                };
                
                return abilities[characterName] || '';
            }
            
            // 《雷雨》主題道具定義 - 簡化為只有加分和減分兩種效果
            const gameItems = [
                // 加分道具 - 積極意象，代表正向力量
                {
                    id: 'umbrella',
                    name: '雨傘',
                    description: '獲得30分，象徵尋求短暫避難，在《雷雨》中是希望的象徵',
                    pointValue: 30, // 加分值
                    color: '#000000',
                    symbol: '☂',
                    storyText: '「這場大雨，沒有一把傘能遮得住。」——繁漪',
                    effect: 'addPoints',
                    rarity: 0.7, // 較少出現
                    isPositive: true // 標記為積極道具
                },
                {
                    id: 'letter',
                    name: '信件',
                    description: '獲得20分，象徵真相的揭示和人物間的溝通',
                    pointValue: 20,
                    color: '#4CAF50',
                    symbol: '✉',
                    storyText: '「那信是寫給你的，你的未來還要靠它。」——魯侍萍',
                    effect: 'addPoints',
                    rarity: 1.0,
                    isPositive: true
                },
                {
                    id: 'window',
                    name: '窗戶',
                    description: '獲得25分，象徵對自由的渴望和對外界的嚮往',
                    pointValue: 25,
                    color: '#2196F3',
                    symbol: '⎚',
                    storyText: '「我希望我今天變成火山的口，熱熱烈烈地冒一次，什麼我都燒個乾淨！」——繁漪',
                    effect: 'addPoints',
                    rarity: 0.8,
                    isPositive: true
                },
                {
                    id: 'fan',
                    name: '摺扇',
                    description: '獲得40分，象徵繁漪對生活的熱情與渴望',
                    pointValue: 40,
                    color: '#E91E63',
                    symbol: '扇',
                    storyText: '「我要呼吸，我要光明，我要生活，我要自由！」——繁漪',
                    effect: 'addPoints',
                    rarity: 0.6, // 較稀有因分數高
                    isPositive: true
                },
                {
                    id: 'tigerShoes',
                    name: '繡花虎頭鞋',
                    description: '獲得35分，象徵母愛的堅韌力量',
                    pointValue: 35,
                    color: '#FF9800',
                    symbol: '👟',
                    storyText: '「我這些年的苦不是你那錢就算得清的！」——魯侍萍',
                    effect: 'addPoints',
                    rarity: 0.7,
                    isPositive: true
                },
                {
                    id: 'photo',
                    name: '家庭照片',
                    description: '獲得50分，象徵真相被揭露帶來的解脫',
                    pointValue: 50,
                    color: '#FF5722',
                    symbol: '🖼',
                    storyText: '「有些秘密，即使掩蓋三十年，還是會被雷雨沖刷出來。」——周樸園',
                    effect: 'addPoints',
                    rarity: 0.5, // 非常稀有，因為分數最高
                    isPositive: true
                },
                
                // 減分道具 - 消極意象，代表負面力量
                {
                    id: 'medicine',
                    name: '藥',
                    description: '減少15分，象徵周樸園用來控制繁漪的工具',
                    pointValue: -15, 
                    color: '#00BCD4',
                    symbol: '⚕',
                    storyText: '「繁漪，當了母親的人，處處應當替子女著想，就是自己不保重身體，也應當替孩子做個服從的榜樣。」——周樸園',
                    effect: 'subtractPoints',
                    rarity: 0.9,
                    isPositive: false // 標記為消極道具
                },
                {
                    id: 'oldHouse',
                    name: '老房子',
                    description: '減少20分，象徵禁錮人性的封建家庭',
                    pointValue: -20,
                    color: '#795548',
                    symbol: '⌂',
                    storyText: '「周家的空氣滿是罪惡，這些年我看見了他們所做的壞事！」——繁漪',
                    effect: 'subtractPoints',
                    rarity: 0.8,
                    isPositive: false
                },
                {
                    id: 'oldSofa',
                    name: '老沙發',
                    description: '減少25分，象徵表面舒適實則窒息的生活',
                    pointValue: -25,
                    color: '#8D6E63',
                    symbol: '∏',
                    storyText: '「這老房子永遠是這樣悶氣，傢俱都發了黴，人們也是鬼裏鬼氣的！」——繁漪',
                    effect: 'subtractPoints',
                    rarity: 0.75,
                    isPositive: false
                },
                {
                    id: 'clock',
                    name: '時鐘',
                    description: '減少30分，象徵命運的不可逆轉和時間的壓迫',
                    pointValue: -30,
                    color: '#3F51B5',
                    symbol: '⏱',
                    storyText: '「時鐘的滴答聲加劇緊迫感，預示悲劇的不可逆轉。」',
                    effect: 'subtractPoints',
                    rarity: 0.7,
                    isPositive: false
                },
                {
                    id: 'ghost',
                    name: '鬼魂',
                    description: '減少40分，象徵家庭被過去罪惡纏繞的恐懼',
                    pointValue: -40,
                    color: '#673AB7',
                    symbol: '👻',
                    storyText: '「我現在心裏很亂，你不知道這屋子鬧鬼麼？」——周萍',
                    effect: 'subtractPoints',
                    rarity: 0.6, // 較稀有因為扣分高
                    isPositive: false
                },
                {
                    id: 'check',
                    name: '支票',
                    description: '減少45分，象徵周樸園試圖用金錢掩蓋罪惡的虛偽',
                    pointValue: -45,
                    color: '#4CAF50',
                    symbol: '💵',
                    storyText: '「你父親是什麼樣的人？他做盡了壞事弄錢，他自然可以行善！」——繁漪',
                    effect: 'subtractPoints',
                    rarity: 0.5, // 非常稀有，因為扣分最高
                    isPositive: false
                }
            ];
            
            // 根據稀有度從道具中選擇一個
            function selectRandomItem() {
                // 先按照稀有度對道具進行過濾
                const availableItems = [];
                
                for (const item of gameItems) {
                    // 稀有度決定物品被選中的機率
                    if (Math.random() <= (item.rarity || 1.0)) {
                        availableItems.push(item);
                    }
                }
                
                // 如果沒有道具通過稀有度篩選，選擇一個默認道具
                if (availableItems.length === 0) {
                    return gameItems[1]; // 返回蟋蟀護符作為默認
                }
                
                // 從可用道具中隨機選擇一個
                return availableItems[Math.floor(Math.random() * availableItems.length)];
            }
            
            // 初始化遊戲
            function initGame(selectedCharacter) {
                character = selectedCharacter;
                characterAbility = getCharacterAbility(selectedCharacter);
                characterImg.src = generateCharacterImage(character);
                characterElement.classList.remove('hidden');
                
                // 重置遊戲狀態
                score = 0;
                level = 1;
                lightning = [];
                items = [];
                activeEffects = {};
                invincible = false;
                abilityActive = false;
                abilityCooldown = false;
                
                // 特殊能力初始化
                characterWidth = 60;
                characterHeight = 80;
                
                // 設置角色位置
                characterX = gameWidth / 2;
                if (characterElement) {
                    characterElement.style.left = `${characterX}px`;
                }
                
                // 更新UI
                scoreElement.textContent = score;
                levelElement.textContent = level;
                
                // 隱藏開始屏幕
                startScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
                
                // 啟動雨效果
                createRainEffect();
                
                // 顯示風暴來臨提示畫面
                showStormWarningScreen();
            }
            
            // 創建雨滴效果
            function createRainEffect() {
                // 功能被移除，不再創建雨滴效果
                console.log("雨滴效果已被移除");
            }

            // 顯示風暴來臨提示畫面 - 大幅改進以顯示更自然的烏雲
            function showStormWarningScreen() {
                // 創建提示畫面
                const warningScreen = document.createElement('div');
                warningScreen.id = 'storm-warning-screen';
                warningScreen.className = 'absolute inset-0 flex flex-col items-center justify-center z-40';
                
                // 雷聲效果
                playThunderSound('big');
                
                // 閃爍背景效果 - 更暗的動態背景
                const flashBackground = document.createElement('div');
                flashBackground.className = 'absolute inset-0 bg-gradient-to-b from-[#0a0d15] to-[#1a1e27] z-0';
                
                // 雲霧效果容器
                const cloudEffect = document.createElement('div');
                cloudEffect.className = 'absolute inset-0 z-10 overflow-hidden';
                
                // 添加更自然的雲背景樣式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes darkCloudMove {
                        0% { transform: translate(0, 0); }
                        50% { transform: translate(-5%, 2%); }
                        100% { transform: translate(0, 0); }
                    }
                    
                    @keyframes darkCloudPulse {
                        0%, 100% { opacity: 0.6; }
                        50% { opacity: 0.8; }
                    }
                    
                    .dark-cloud {
                        position: absolute;
                        background: radial-gradient(ellipse at center, rgba(40, 45, 55, 0.9) 0%, rgba(20, 25, 35, 0.7) 70%, rgba(10, 15, 25, 0) 100%);
                        border-radius: 50%;
                        filter: blur(20px);
                        animation: darkCloudMove 8s ease-in-out infinite, darkCloudPulse 10s ease-in-out infinite;
                    }
                `;
                document.head.appendChild(style);
                
                // 創建多個不規則雲層，以獲得更自然的效果
                function createCloud(size, posX, posY, delay, duration, color) {
                    const cloud = document.createElement('div');
                    cloud.className = 'dark-cloud';
                    cloud.style.width = `${size}px`;
                    cloud.style.height = `${size * 0.6}px`;
                    cloud.style.left = `${posX}%`;
                    cloud.style.top = `${posY}%`;
                    cloud.style.backgroundColor = color || 'rgba(30, 35, 45, 0.9)';
                    cloud.style.animationDelay = `${delay}s`;
                    cloud.style.animationDuration = `${duration}s`;
                    return cloud;
                }
                
                // 創建多層雲
                const cloudLayers = [
                    // 大型背景雲
                    createCloud(500, 10, 20, 0, 20, 'rgba(20, 25, 35, 0.8)'),
                    createCloud(400, 60, 10, 2, 15, 'rgba(20, 22, 30, 0.8)'),
                    createCloud(450, 30, 40, 1, 18, 'rgba(15, 20, 30, 0.7)'),
                    createCloud(350, 70, 30, 3, 16, 'rgba(25, 30, 40, 0.7)'),
                    
                    // 中型雲層
                    createCloud(300, 20, 15, 2, 12, 'rgba(30, 35, 45, 0.8)'),
                    createCloud(280, 50, 25, 1, 14, 'rgba(25, 30, 40, 0.8)'),
                    createCloud(320, 80, 20, 3, 13, 'rgba(20, 25, 35, 0.8)'),
                    
                    // 小型前景雲
                    createCloud(200, 30, 35, 0.5, 10, 'rgba(35, 40, 50, 0.9)'),
                    createCloud(180, 70, 45, 1.5, 9, 'rgba(30, 35, 45, 0.9)'),
                    createCloud(150, 40, 50, 2.5, 8, 'rgba(40, 45, 55, 0.9)'),
                ];
                
                // 添加所有雲層
                cloudLayers.forEach(cloud => {
                    cloudEffect.appendChild(cloud);
                });
                
                // 創建閃電元素 - 更多樣化的閃電
                for (let i = 0; i < 8; i++) {
                    const lightning = document.createElement('div');
                    lightning.className = 'absolute z-20';
                    
                    // 更隨機的位置和角度
                    lightning.style.left = `${Math.random() * 100}%`;
                    lightning.style.top = `${Math.random() * 60}%`;
                    lightning.style.transform = `rotate(${Math.random() * 40 - 20}deg) scale(${0.7 + Math.random() * 0.6})`;
                    
                    // 隨機選擇閃電顏色 - 藍白或黃白
                    const isBlue = Math.random() > 0.7;
                    const lightningColor = isBlue ? 'rgba(180,220,255,0.9)' : 'rgba(255,255,230,0.9)';
                    const glowColor = isBlue ? 'rgba(100,170,255,0.4)' : 'rgba(255,240,180,0.4)';
                    
                    // 更複雜的閃電SVG路徑
                    lightning.innerHTML = `
                        <svg width="40" height="120" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg">
                            <filter id="glow${i}" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="3" result="blur" />
                                <feComposite in="SourceGraphic" in2="blur" operator="over" />
                            </filter>
                            <path d="M20,0 L8,40 L18,45 L5,85 L15,90 L0,120 L38,75 L25,70 L35,40 L22,35 Z" 
                                  fill="${lightningColor}" 
                                  filter="url(#glow${i})"
                                  stroke="${glowColor}" 
                                  stroke-width="3" />
                        </svg>
                    `;
                    lightning.style.opacity = '0';
                    
                    // 隨機閃爍序列 - 更自然的閃電效果
                    setTimeout(() => {
                        // 多次閃爍
                        const flashCount = Math.floor(Math.random() * 3) + 1;
                        for (let j = 0; j < flashCount; j++) {
                            setTimeout(() => {
                                lightning.style.opacity = '1';
                                // 亮起時間隨機
                                setTimeout(() => {
                                    lightning.style.opacity = '0';
                                }, 50 + Math.random() * 100);
                            }, j * 200);
                        }
                        
                        // 播放雷聲
                        if (Math.random() > 0.5) {
                            playThunderSound('random');
                        }
                    }, 500 + Math.random() * 3000);
                    
                    cloudEffect.appendChild(lightning);
                }
                
                // 創建提示文字容器
                const textContainer = document.createElement('div');
                textContainer.className = 'relative z-30 px-8 py-6 bg-black bg-opacity-40 rounded-lg text-center max-w-md';
                
                // 引用來源
                const quoteSource = document.createElement('div');
                quoteSource.className = 'text-xs text-yellow-300 mb-2';
                quoteSource.textContent = '——繁漪，《雷雨》';
                
                // 提示文字（初始為空，將使用打字機效果填充）- 减小字體確保在一行
                const warningText = document.createElement('p');
                warningText.id = 'warning-text';
                warningText.className = 'text-xl font-bold whitespace-nowrap';
                
                // 組合元素
                textContainer.appendChild(warningText);
                textContainer.appendChild(quoteSource);
                warningScreen.appendChild(flashBackground);
                warningScreen.appendChild(cloudEffect);
                warningScreen.appendChild(textContainer);
                
                // 添加到遊戲容器
                gameContainer.appendChild(warningScreen);
                
                // 應用打字機效果
                // 注意這裡不再包含引號
                const warningPhrase = '小心，現在風暴就要起來了！';
                typewriterEffect(warningText, warningPhrase, 100, () => {
                    // 打字效果完成後，延遲一段時間後開始遊戲
                    setTimeout(() => {
                        warningScreen.classList.add('animate-fade-out');
                        setTimeout(() => {
                            warningScreen.remove();
                            // 正式開始遊戲
                            startActualGame();
                        }, 1000);
                    }, 2000);
                });
                
                // 添加淡出動畫
                const fadeOutStyle = document.createElement('style');
                fadeOutStyle.textContent = `
                    .animate-fade-out {
                        animation: fadeOut 1s forwards;
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(fadeOutStyle);
            }
            
            // 正式開始遊戲
            function startActualGame() {
                // 記錄遊戲開始時間
                gameStartTime = Date.now();
                
                // 開始遊戲
                isGameRunning = true;
                statusBar.classList.remove('hidden');
                
                // 創建能力指示器
                createAbilityIndicator();
                
                // 開始遊戲循環
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                
                // 雨滴效果已被移除
                
                // 啟動環境雷聲
                playAmbientThunder();
                
                // 開始大雷聲
                playThunderSound('big');
                
                // 開始播放背景音樂
                startBackgroundMusic();
                
                // 顯示角色台詞氣泡
                showCharacterQuoteBubble();
                
                gameLoop();
            }
            
            // 創建能力指示器
            function createAbilityIndicator() {
                // 移除舊的指示器（如果有）
                const oldIndicator = document.getElementById('ability-indicator');
                if (oldIndicator) {
                    oldIndicator.remove();
                }
                
                // 創建新的指示器 - 改進視覺樣式和排版
                const indicator = document.createElement('div');
                indicator.id = 'ability-indicator';
                indicator.className = 'absolute top-2 right-2 p-2.5 rounded-lg bg-gradient-to-br from-gray-900 to-gray-800 text-white text-xs z-20 border border-blue-500 border-opacity-30 shadow-lg';
                
                // 獲取技能相關參數顯示
                const cooldownTime = getAbilityCooldown();
                const cooldownSeconds = Math.ceil(cooldownTime / 60);
                const durationTime = getAbilityDuration();
                const durationSeconds = Math.ceil(durationTime / 60);
                
                // 設置技能激活方式提示
                let activationTip = '空格鍵/長按激活';
                if (characterAbility === '隱忍堅韌') {
                    activationTip = '空格鍵激活免疫';
                }
                
                // 獲取技能圖標 - 為不同技能設置特定圖標
                let abilityIcon = '';
                switch(characterAbility) {
                    case '威權力場':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-yellow-300"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>';
                        break;
                    case '優柔瞬移':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-blue-300"><path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" /></svg>';
                        break;
                    case '青春衝刺':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-cyan-300"><path fill-rule="evenodd" d="M8.25 3.75H19.5a.75.75 0 01.75.75v11.25a.75.75 0 01-1.5 0V6.31L5.03 20.03a.75.75 0 01-1.06-1.06L17.69 5.25H8.25a.75.75 0 010-1.5z" clip-rule="evenodd" /></svg>';
                        break;
                    case '隱忍堅韌':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-purple-300"><path fill-rule="evenodd" d="M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.75.75 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.39-.223-2.73-.635-3.985a.75.75 0 00-.722-.516l-.143.001c-2.996 0-5.717-1.17-7.734-3.08zm3.094 8.016a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>';
                        break;
                    case '情感庇護':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-pink-300"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>';
                        break;
                    case '預知閃避':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-amber-300"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" /><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd" /></svg>';
                        break;
                    default:
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-blue-300"><path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" /></svg>';
                }
                
                // 技能名稱和狀態 - 完全重新設計的指示器
                indicator.innerHTML = `
                    <div class="flex items-center justify-between mb-1.5">
                        <div class="flex items-center font-bold text-sm text-primary">
                            ${abilityIcon}
                            <span>${characterAbility}</span>
                        </div>
                        <span id="ability-status" class="ml-1.5 px-2 py-0.5 bg-gradient-to-r from-blue-600 to-blue-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap">就緒</span>
                    </div>
                    
                    <div class="relative">
                        <!-- 冷卻/持續時間條 - 添加閃爍邊框 -->
                        <div id="ability-cooldown" class="w-full h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-700 shadow-inner">
                            <div id="ability-cooldown-bar" class="h-full bg-gradient-to-r from-primary to-blue-400 w-full rounded-full relative overflow-hidden transition-all duration-300">
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-primary-light to-transparent opacity-30 cooldown-shine"></div>
                            </div>
                        </div>
                        
                        <!-- 倒計時顯示 -->
                        <div id="ability-timer" class="absolute right-0 -top-5 text-[9px] text-gray-300 font-bold"></div>
                    </div>
                    
                    <div class="flex justify-between items-center mt-1.5 text-[9px] text-gray-300">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-2.5 h-2.5 mr-0.5 text-gray-400">
                                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd" />
                            </svg>
                            <span>冷卻: ${cooldownSeconds}秒</span>
                        </div>
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-2.5 h-2.5 mr-0.5 text-gray-400">
                                <path fill-rule="evenodd" d="M15.97 2.47a.75.75 0 011.06 0l4.5 4.5a.75.75 0 010 1.06l-4.5 4.5a.75.75 0 11-1.06-1.06l3.22-3.22H7.5a.75.75 0 010-1.5h11.69l-3.22-3.22a.75.75 0 010-1.06zm-7.94 9a.75.75 0 010 1.06l-3.22 3.22H16.5a.75.75 0 010 1.5H4.81l3.22 3.22a.75.75 0 11-1.06 1.06l-4.5-4.5a.75.75 0 010-1.06l4.5-4.5a.75.75 0 011.06 0z" clip-rule="evenodd" />
                            </svg>
                            <span>${activationTip}</span>
                        </div>
                    </div>
                `;
                
                // 添加到遊戲容器
                document.getElementById('game-container').appendChild(indicator);
                
                // 添加閃光動畫
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes cooldownShine {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                    .cooldown-shine {
                        animation: cooldownShine 2s infinite linear;
                    }
                    
                    @keyframes pulseStatus {
                        0%, 100% { opacity: 0.9; }
                        50% { opacity: 1; box-shadow: 0 0 8px rgba(93, 92, 222, 0.5); }
                    }
                    .status-pulse {
                        animation: pulseStatus 2s infinite ease-in-out;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 角色能力說明 - 更新所有能力為主動技能
            const abilityDescriptions = {
                '威權力場': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">威權力場</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">減緩閃電速度40%</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">空格/長按</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">象徵周樸園的專制威嚴 • 30秒冷卻</p>
                        </div>
                    </div>
                `,
                '優柔瞬移': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">優柔瞬移</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">瞬間移動到安全位置</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">空格/長按</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">象徵周萍猶豫逃避的特性 • 20秒冷卻</p>
                        </div>
                    </div>
                `,
                '青春衝刺': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">青春衝刺</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">瞬間爆發式加速</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">空格/長按</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">象徵周沖反抗精神 • 15秒冷卻</p>
                        </div>
                    </div>
                `,
                '隱忍堅韌': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">隱忍堅韌</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">免疫一次閃電傷害</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">空格/長按</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">象徵魯侍萍的堅忍不拔 • 60秒冷卻</p>
                        </div>
                    </div>
                `,
                '情感庇護': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">情感庇護</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">創造短暫護盾減少傷害</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">空格/長按</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">象徵繁漪的情感浪潮 • 25秒冷卻</p>
                        </div>
                    </div>
                `,
                '預知閃避': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">預知閃避</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">增強閃電預警效果</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">空格/長按</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">象徵四鳳對危險的感知 • 40秒冷卻</p>
                        </div>
                    </div>
                `
            };
            
            // 初始化道具信息對象，確保在drawItems使用前定義 - 統一使用emoji與顏色
            window.itemDetails = {
                'oldHouse': {
                    name: '老房子',
                    description: '減少20分，象徵禁錮人性的封建家庭',
                    color: '#F44336', // 統一使用紅色系
                    icon: '🏚️',
                    isPositive: false,
                    pointValue: -20
                },
                'diary': {
                    name: '魯侍萍的日記',
                    description: '獲得35分，象徵真相的揭露雖然痛苦但能帶來解脫',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '📓',
                    isPositive: true,
                    pointValue: 35
                },
                'fan': {
                    name: '摺扇',
                    description: '獲得40分，象徵繁漪對生活的熱情與渴望',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '🪭',
                    isPositive: true,
                    pointValue: 40
                },
                'medicine': {
                    name: '藥',
                    description: '減少15分，象徵周樸園用來控制繁漪的工具',
                    color: '#F44336', // 統一使用紅色系
                    icon: '💊',
                    isPositive: false,
                    pointValue: -15
                },
                'umbrella': {
                    name: '雨傘',
                    description: '獲得30分，象徵尋求短暫避難，在《雷雨》中是希望的象徵',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '☂️',
                    isPositive: true,
                    pointValue: 30
                },
                'clock': {
                    name: '時鐘',
                    description: '減少30分，象徵命運的不可逆轉和時間的壓迫',
                    color: '#F44336', // 統一使用紅色系
                    icon: '⏰',
                    isPositive: false,
                    pointValue: -30
                },
                'cricket': {
                    name: '蟋蟀護符',
                    description: '獲得20分，象徵年輕的反抗精神和生命力',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '🦗',
                    isPositive: true,
                    pointValue: 20
                },
                'photo': {
                    name: '家庭照片',
                    description: '獲得50分，象徵真相被揭露帶來的解脫',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '🖼️',
                    isPositive: true,
                    pointValue: 50
                },
                'oldSofa': {
                    name: '老沙發',
                    description: '減少25分，象徵表面舒適實則窒息的生活',
                    color: '#F44336', // 統一使用紅色系
                    icon: '🛋️',
                    isPositive: false,
                    pointValue: -25
                },
                'tigerShoes': {
                    name: '繡花虎頭鞋',
                    description: '獲得35分，象徵母愛的堅韌力量',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '👟',
                    isPositive: true,
                    pointValue: 35
                },
                'window': {
                    name: '窗戶',
                    description: '獲得25分，象徵對自由的渴望和對外界的嚮往',
                    color: '#4CAF50', // 統一使用綠色系
                    icon: '🪟',
                    isPositive: true,
                    pointValue: 25
                },
                'check': {
                    name: '支票',
                    description: '減少45分，象徵周樸園試圖用金錢掩蓋罪惡的虛偽',
                    color: '#F44336', // 統一使用紅色系
                    icon: '💸',
                    isPositive: false,
                    pointValue: -45
                },
                'ghost': {
                    name: '鬼魂',
                    description: '減少40分，象徵家庭被過去罪惡纏繞的恐懼',
                    color: '#F44336', // 統一使用紅色系
                    icon: '👻',
                    isPositive: false,
                    pointValue: -40
                }
            };
            
            // 重新設計能力提示氣泡，改善顯示問題
            characterButtons.forEach(button => {
                const abilityName = button.getAttribute('data-ability');
                const activationMethod = button.getAttribute('data-activation');
                const cooldown = button.getAttribute('data-cooldown');
                
                button.addEventListener('mouseover', (event) => {
                    // 確保氣泡元素存在
                    const abilityTooltip = document.getElementById('ability-tooltip');
                    if (!abilityTooltip || !abilityName) {
                        console.log('氣泡元素或能力信息不存在');
                        return;
                    }
                    
                    try {
                        // 清理舊內容並重新建立內部結構
                        abilityTooltip.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="text-sm font-bold text-primary ability-name"></div>
                                <div class="text-[8px] px-1.5 py-0.5 bg-blue-600 bg-opacity-70 rounded-md ability-activation"></div>
                            </div>
                            <div class="text-[10px] mt-1.5 text-gray-200 ability-desc"></div>
                            <div class="text-[9px] mt-1 italic text-blue-300 ability-note"></div>
                            <div class="mt-1.5 flex justify-between items-center text-[9px]">
                                <div class="text-yellow-300 ability-cooldown"></div>
                                <div class="text-white px-1.5 py-0.5 bg-primary bg-opacity-50 rounded-sm ability-usage"></div>
                            </div>
                            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30 tooltip-arrow"></div>
                        `;
                        
                        // 獲取更新後的內部元素
                        const nameElement = abilityTooltip.querySelector('.ability-name');
                        const activationElement = abilityTooltip.querySelector('.ability-activation');
                        const cooldownElement = abilityTooltip.querySelector('.ability-cooldown');
                        const descElement = abilityTooltip.querySelector('.ability-desc');
                        const noteElement = abilityTooltip.querySelector('.ability-note');
                        const usageElement = abilityTooltip.querySelector('.ability-usage');
                        const arrowElement = abilityTooltip.querySelector('.tooltip-arrow');
                        
                        // 檢查是否成功獲取所有元素
                        if (!nameElement || !activationElement || !cooldownElement || 
                            !descElement || !noteElement || !arrowElement) {
                            console.log('無法獲取氣泡內部元素');
                            return;
                        }
                        
                        // 填充內容
                        nameElement.textContent = abilityName;
                        
                        // 設置激活方式
                        if (activationMethod) {
                            activationElement.textContent = activationMethod;
                        } else {
                            activationElement.textContent = "被動能力";
                        }
                        
                        // 設置冷卻時間
                        if (cooldown) {
                            cooldownElement.textContent = cooldown;
                        } else {
                            cooldownElement.textContent = "無冷卻";
                        }
                        
                        // 根據不同能力設置詳細信息
                        switch(abilityName) {
                            case '威權力場':
                                descElement.textContent = "減緩閃電速度40%";
                                noteElement.textContent = "象徵周樸園的專制威嚴";
                                usageElement.textContent = "主動激活";
                                break;
                            case '優柔瞬移':
                                descElement.textContent = "瞬間移動到安全位置";
                                noteElement.textContent = "象徵周萍猶豫逃避的特性";
                                usageElement.textContent = "主動激活";
                                break;
                            case '青春衝刺':
                                descElement.textContent = "瞬間爆發式加速";
                                noteElement.textContent = "象徵周沖反抗精神";
                                usageElement.textContent = "主動激活";
                                break;
                            case '隱忍堅韌':
                                descElement.textContent = "免疫一次閃電傷害";
                                noteElement.textContent = "象徵魯侍萍的堅忍不拔";
                                usageElement.textContent = "主動激活";
                                break;
                            case '情感庇護':
                                descElement.textContent = "創造短暫護盾減少傷害";
                                noteElement.textContent = "象徵繁漪的情感浪潮";
                                usageElement.textContent = "主動激活";
                                break;
                            case '預知閃避':
                                descElement.textContent = "增強閃電預警效果";
                                noteElement.textContent = "象徵四鳳對危險的感知";
                                usageElement.textContent = "主動激活";
                                break;
                            default:
                                descElement.textContent = "角色特殊能力";
                                noteElement.textContent = "請查看角色介紹";
                                usageElement.textContent = "-";
                        }
                        
                        // 定位氣泡 - 增強邊界檢測
                        const buttonRect = button.getBoundingClientRect();
                        const tooltipWidth = 208; // w-52 = 13rem = 208px
                        const tooltipHeight = 120; // 略微增加高度確保內容顯示完整
                        const SAFE_MARGIN = 12; // 安全邊距，確保不會緊貼邊緣
                        
                        // 獲取遊戲容器位置
                        const gameContainer = document.querySelector('.game-container');
                        if (!gameContainer) {
                            console.log('找不到遊戲容器');
                            return;
                        }
                        
                        const containerRect = gameContainer.getBoundingClientRect();
                        const gameWidth = containerRect.width;
                        const gameHeight = containerRect.height;
                        
                        // 計算按鈕在容器中的相對位置
                        const buttonLeft = buttonRect.left - containerRect.left;
                        const buttonTop = buttonRect.top - containerRect.top;
                        const buttonRight = buttonLeft + buttonRect.width;
                        const buttonBottom = buttonTop + buttonRect.height;
                        
                        // 初始優先位置：在按鈕上方，水平居中對齊
                        let tooltipLeft = buttonLeft + buttonRect.width/2 - tooltipWidth/2;
                        let tooltipTop = buttonTop - tooltipHeight - SAFE_MARGIN;
                        let position = 'top'; // 預設在上方
                        
                        // 檢查是否會超出上邊界
                        if (tooltipTop < SAFE_MARGIN) {
                            // 如果上方空間不足，改為顯示在按鈕下方
                            tooltipTop = buttonBottom + SAFE_MARGIN;
                            position = 'bottom';
                            
                            // 檢查下方空間是否充足
                            if (tooltipTop + tooltipHeight > gameHeight - SAFE_MARGIN) {
                                // 如果下方也不夠，嘗試放在按鈕左側或右側
                                if (buttonLeft > gameWidth / 2) {
                                    // 按鈕在右半部，嘗試放在左側
                                    tooltipLeft = buttonLeft - tooltipWidth - SAFE_MARGIN;
                                    tooltipTop = buttonTop + buttonRect.height/2 - tooltipHeight/2;
                                    position = 'left';
                                    
                                    // 檢查左側空間
                                    if (tooltipLeft < SAFE_MARGIN) {
                                        // 左側空間也不足，強制放在最靠中間的位置
                                        tooltipLeft = SAFE_MARGIN;
                                        tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                    }
                                } else {
                                    // 按鈕在左半部，嘗試放在右側
                                    tooltipLeft = buttonRight + SAFE_MARGIN;
                                    tooltipTop = buttonTop + buttonRect.height/2 - tooltipHeight/2;
                                    position = 'right';
                                    
                                    // 檢查右側空間
                                    if (tooltipLeft + tooltipWidth > gameWidth - SAFE_MARGIN) {
                                        // 右側空間也不足，強制放在最靠中間的位置
                                        tooltipLeft = gameWidth - tooltipWidth - SAFE_MARGIN;
                                        tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                    }
                                }
                            }
                        }
                        
                        // 確保不超出左右邊界
                        tooltipLeft = Math.max(SAFE_MARGIN, Math.min(gameWidth - tooltipWidth - SAFE_MARGIN, tooltipLeft));
                        
                        // 確保不超出上下邊界
                        tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, tooltipTop));
                        
                        // 根據最終位置設置箭頭
                        switch (position) {
                            case 'top':
                                // 顯示在按鈕上方，箭頭在底部
                                arrowElement.className = 'absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // 調整箭頭水平位置，確保指向按鈕中心
                                const arrowHorizontalOffset = (buttonLeft + buttonRect.width/2) - (tooltipLeft + tooltipWidth/2);
                                if (Math.abs(arrowHorizontalOffset) < tooltipWidth/2 - 15) {
                                    arrowElement.style.left = `calc(50% + ${arrowHorizontalOffset}px)`;
                                } else {
                                    // 如果偏移太大，隱藏箭頭
                                    arrowElement.style.display = 'none';
                                }
                                break;
                                
                            case 'bottom':
                                // 顯示在按鈕下方，箭頭在頂部
                                arrowElement.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-l border-t border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // 調整箭頭水平位置
                                const arrowHorizontalOffsetBottom = (buttonLeft + buttonRect.width/2) - (tooltipLeft + tooltipWidth/2);
                                if (Math.abs(arrowHorizontalOffsetBottom) < tooltipWidth/2 - 15) {
                                    arrowElement.style.left = `calc(50% + ${arrowHorizontalOffsetBottom}px)`;
                                } else {
                                    arrowElement.style.display = 'none';
                                }
                                break;
                                
                            case 'left':
                                // 顯示在按鈕左側，箭頭在右側
                                arrowElement.className = 'absolute right-0 top-1/2 transform translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-t border-r border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // 調整箭頭垂直位置
                                const arrowVerticalOffsetLeft = (buttonTop + buttonRect.height/2) - (tooltipTop + tooltipHeight/2);
                                if (Math.abs(arrowVerticalOffsetLeft) < tooltipHeight/2 - 15) {
                                    arrowElement.style.top = `calc(50% + ${arrowVerticalOffsetLeft}px)`;
                                    arrowElement.style.left = 'auto';
                                } else {
                                    arrowElement.style.display = 'none';
                                }
                                break;
                                
                            case 'right':
                                // 顯示在按鈕右側，箭頭在左側
                                arrowElement.className = 'absolute left-0 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-b border-l border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // 調整箭頭垂直位置
                                const arrowVerticalOffsetRight = (buttonTop + buttonRect.height/2) - (tooltipTop + tooltipHeight/2);
                                if (Math.abs(arrowVerticalOffsetRight) < tooltipHeight/2 - 15) {
                                    arrowElement.style.top = `calc(50% + ${arrowVerticalOffsetRight}px)`;
                                    arrowElement.style.left = 'auto';
                                } else {
                                    arrowElement.style.display = 'none';
                                }
                                break;
                        }
                        
                        // 設置最終位置
                        abilityTooltip.style.left = `${tooltipLeft}px`;
                        abilityTooltip.style.top = `${tooltipTop}px`;
                        
                        // 顯示氣泡
                        abilityTooltip.classList.remove('hidden');
                    } catch (error) {
                        console.error('顯示技能提示時發生錯誤:', error);
                    }
                });
                
                button.addEventListener('mouseout', () => {
                    // 隱藏氣泡
                    const abilityTooltip = document.getElementById('ability-tooltip');
                    if (abilityTooltip) {
                        abilityTooltip.classList.add('hidden');
                    }
                });
                
                button.addEventListener('click', () => {
                    const selectedCharacter = button.getAttribute('data-character');
                    initGame(selectedCharacter);
                });
            });
            
            // 清理周沖的粒子效果和速度線 - 更徹底的清理
            function cleanupSprintEffects() {
                console.log("執行周沖粒子效果清理");
                
                // 立即取消周沖的能力狀態
                if (characterAbility === '青春衝刺' && activeEffects) {
                    activeEffects.youthSprint = false;
                    activeEffects.dashInvincibility = false;
                }
                
                // 清除現有粒子系統
                if (activeEffects && activeEffects.sprintParticles) {
                    try {
                        activeEffects.sprintParticles.stop();
                        activeEffects.sprintParticles = null;
                        delete activeEffects.sprintParticles;
                    } catch (e) {
                        console.error("清理粒子系統時出錯:", e);
                    }
                }
                
                // 移除速度線容器 - 使用更徹底的查找方式
                const speedLinesContainers = document.querySelectorAll('#speed-lines-container, .speed-lines');
                speedLinesContainers.forEach(container => {
                    if (container && container.parentNode) {
                        try {
                            container.remove();
                        } catch (e) {
                            console.error("移除速度線容器時出錯:", e);
                        }
                    }
                });
                
                // 移除所有與衝刺相關的效果
                const sprintEffects = document.querySelectorAll('#sprint-effect, .sprint-effect, .character-decoy');
                sprintEffects.forEach(effect => {
                    if (effect && effect.parentNode) {
                        try {
                            effect.remove();
                        } catch (e) {
                            console.error("移除衝刺效果時出錯:", e);
                        }
                    }
                });
                
                // 移除可能殘留在canvas上的粒子
                const canvasElements = document.querySelectorAll('canvas');
                canvasElements.forEach(canvas => {
                    if (canvas.id !== 'game-canvas') { // 保留主遊戲畫布
                        try {
                            canvas.remove();
                        } catch (e) {
                            console.error("移除粒子畫布時出錯:", e);
                        }
                    }
                });
                
                // 強制刷新地面波效果
                const groundWaves = document.querySelectorAll('[style*="groundWave"]');
                groundWaves.forEach(wave => {
                    if (wave && wave.parentNode) {
                        try {
                            wave.remove();
                        } catch (e) {
                            console.error("移除地面波效果時出錯:", e);
                        }
                    }
                });
            }
            
            // 重新開始遊戲
            restartBtn.addEventListener('click', () => {
                // 清理粒子效果
                cleanupSprintEffects();
                
                // 清理所有可能的特殊效果
                const allEffects = document.querySelectorAll('#pressure-field, #character-shield, #resilience-aura, #timeslow-overlay');
                allEffects.forEach(effect => {
                    if (effect && effect.parentNode) {
                        effect.remove();
                    }
                });
                
                startScreen.classList.remove('hidden');
                gameOverScreen.classList.add('hidden');
                statusBar.classList.add('hidden');
            });
            
            // 禁用角色台詞氣泡顯示功能，避免干擾操作
            function showCharacterQuoteBubble() {
                // 不執行任何操作，完全禁用此功能
                return;
            }
            
            // 收集道具後也不顯示台詞氣泡
            function collectItem(item) {
                // 顯示道具效果提示
                showItemEffectPopup(item);
                
                // 根據道具類型應用加分或減分效果
                if (item.effect === 'addPoints') {
                    // 加分效果
                    score += item.pointValue;
                    
                    // 播放積極音效
                    playThunderSound('button');
                    
                    // 顯示加分動畫
                    showScoreAnimation(item.pointValue, true);
                    
                    // 正面道具收集視覺效果 - 綠色光芒
                    createItemEffect('#4CAF50', 0.4);
                    
                } else if (item.effect === 'subtractPoints') {
                    // 扣分效果
                    score = Math.max(0, score + item.pointValue); // 使用 += 因為 pointValue 已經是負數
                    
                    // 播放消極音效
                    playThunderSound('random');
                    
                    // 顯示扣分動畫
                    showScoreAnimation(item.pointValue, false);
                    
                    // 負面道具收集視覺效果 - 紅色光芒
                    createItemEffect('#F44336', 0.4);
                    
                    // 震動效果
                    gameContainer.classList.add('strong-shake');
                    setTimeout(() => {
                        gameContainer.classList.remove('strong-shake');
                    }, 500);
                }
                
                // 更新分數顯示
                scoreElement.textContent = score;
                
                // 輔助函數：創建道具效果
                function createItemEffect(color, opacity) {
                    const effect = document.createElement('div');
                    effect.className = 'absolute bottom-16 left-1/2 transform -translate-x-1/2 z-5 pointer-events-none';
                    effect.style.width = `${characterWidth * 1.8}px`;
                    effect.style.height = `${characterHeight * 1.5}px`;
                    effect.style.background = `radial-gradient(ellipse at center, ${color}99 0%, ${color}${Math.floor(opacity * 255).toString(16)} 20%, transparent 70%)`;
                    effect.style.borderRadius = '50%';
                    effect.style.animation = 'pulse 1.5s';
                    effect.style.opacity = '0.8';
                    
                    gameContainer.appendChild(effect);
                    
                    // 效果自動移除
                    setTimeout(() => {
                        effect.style.opacity = '0';
                        effect.style.transition = 'opacity 0.5s';
                        setTimeout(() => effect.remove(), 500);
                    }, 1200);
                }
            }
            
            // 《雷雨》原文台詞庫（從附件中獲取）
            const characterQuotes = {
                '周樸園': [
                    { text: "我的家庭是我認為最圓滿、最有秩序的家庭，我的兒子我也認為都還是健全的子弟。", act: "一幕", note: "維護封建家長形象" },
                    { text: "你以為一個人做了一件於心不忍的事就會忘了麼？", act: "二幕", note: "自我辯解" },
                    { text: "繁漪，當了母親的人，處處應當替子女著想，就是自己不保重身體，也應當替孩子做個服從的榜樣。", act: "一幕", note: "強迫繁漪喝藥" },
                    { text: "礦上的工人已經在昨天早上復工，你當代表的反而不知道麼？", act: "二幕", note: "質問魯大海（工人代表）" },
                    { text: "你可以冷靜點。現在你我都是有子女的人，如果你覺得心裏有委屈，這麼大年紀，我們可以先不必哭哭啼啼的。", act: "二幕", note: "面對侍萍時的冷淡" },
                    { text: "這些年我總是留著這些傢俱，為著紀念你。", act: "二幕", note: "對侍萍的虛偽" },
                    { text: "你的生日——四月十八——每年我總記得。", act: "二幕", note: "對侍萍的虛偽懷念" },
                    { text: "從前的恩怨，過了幾十年，又何必再提呢？", act: "二幕", note: "淡化對侍萍的傷害" },
                    { text: "魯貴我現在要辭退的，四鳳也要回家。", act: "三幕", note: "發現真相後的慌亂" },
                    { text: "你——侍萍？", act: "二幕", note: "認出侍萍的震驚" },
                    { text: "我喜歡這舊房子的樣子，我願意總是三十年前的老樣子，這叫我的眼看著舒服一點。", act: "二幕", note: "安於舊日情景" },
                    { text: "我丟了一個兒子，不能再丟第二個了。", act: "四幕", note: "家庭崩潰時的執著" }
                ],
                '繁漪': [
                    { text: "一個女子，你記著，不能受兩代的欺侮，你可以想一想。", act: "四幕", note: "絕望時對周萍的控訴" },
                    { text: "那位專家，克大夫免不了會天天來的，要我吃藥，逼著我吃藥，吃藥，吃藥，吃藥！", act: "一幕", note: "對被壓迫的厭惡" },
                    { text: "熱極了，悶極了，這裏真是再也不能住的。", act: "一幕", note: "暗示壓抑環境" },
                    { text: "我希望我今天變成火山的口，熱熱烈烈地冒一次，什麼我都燒個乾淨！", act: "二幕", note: "反抗宣言" },
                    { text: "我不後悔，我向來做事沒有後悔過。", act: "二幕", note: "情感真誠" },
                    { text: "周家的空氣滿是罪惡，這些年我看見了他們所做的壞事！", act: "三幕", note: "對周家的揭露" },
                    { text: "你欠了我一筆債，你對我負著責任；你不能看見了新的世界，就一個人跑。", act: "二幕", note: "對周萍的控訴" },
                    { text: "我不是他的母親！不是，不是，我也不是周樸園的妻子！", act: "三幕", note: "對身分的否定" },
                    { text: "這老房子永遠是這樣悶氣，傢俱都發了黴，人們也是鬼裏鬼氣的！", act: "一幕", note: "對周家的厭惡" },
                    { text: "你父親是什麼樣的人？他做盡了壞事弄錢，他自然可以行善！", act: "二幕", note: "揭露周樸園的虛偽" },
                    { text: "你既知道這家庭可以悶死人，你怎麼肯一個人走，把我放在家裏？", act: "二幕", note: "對周萍的指責" },
                    { text: "你最對不起的是我，是你曾經引誘的後母！", act: "三幕", note: "對周萍的控訴" },
                    { text: "我在這樣的體面家庭已經十八年啦。周家家庭裡做出的罪惡，我聽過，我見過，我做過。", act: "三幕", note: "揭露家族罪惡" },
                    { text: "我總覺得這房子有點靈氣，它拉著我，不讓我走。", act: "三幕", note: "對命運的感悟" },
                    { text: "沖兒，你該死，該死！你有了這樣的母親，你該死。", act: "四幕", note: "悲劇時刻" },
                    { text: "我只要你說：我——我是你的。", act: "三幕", note: "對周萍的渴求" }
                ],
                '周萍': [
                    { text: "我現在心裏很亂，你不知道這屋子鬧鬼麼？", act: "三幕", note: "內心不安" },
                    { text: "我夠了，我是活厭了的人。", act: "二幕", note: "人生厭倦" },
                    { text: "我要離開這兒，這屋子裏的死氣會把我悶死的！", act: "二幕", note: "渴望離開" },
                    { text: "我的心都死了，我恨極了我自己！", act: "二幕", note: "內心痛苦" },
                    { text: "這些話多少年我對誰也說不出的，然而，奇怪，我忽然跟你說了。", act: "二幕", note: "對繁漪的敞開心扉" },
                    { text: "鳳兒，你以為我這麼自私自利麼？你不應該這樣想我！", act: "三幕", note: "對四鳳的辯解" },
                    { text: "我厭惡這種不自然的關係，我負起我的責任，我承認我那時的錯！", act: "二幕", note: "對繁漪的承認" },
                    { text: "父親的話，向來不能改的。他的意見就是法律！", act: "二幕", note: "對父親的壓制" },
                    { text: "我後悔，我認為我生平做錯一件大事，我對不起自己，對不起弟弟，更對不起父親！", act: "二幕", note: "悔恨" },
                    { text: "四鳳，你饒恕我麼？我並不怨你，我知道早晚是有這麼一天的！", act: "四幕", note: "得知真相後" },
                    { text: "你瘋了！這種字句不是在父親這樣體面的家庭裏說的！", act: "二幕", note: "虛偽維護" },
                    { text: "我要走了，我現在要收拾東西去！", act: "三幕", note: "決定離開" },
                    { text: "爸，你不該生我！", act: "四幕", note: "悲劇頂點" },
                    { text: "我覺得我像在做夢。", act: "三幕", note: "困惑不解" },
                    { text: "我喝酒，胡鬧，我只要離開她，我死都願意。", act: "三幕", note: "絕望逃避" }
                ],
                '魯侍萍': [
                    { text: "命！不公平的命指使我來的！", act: "二幕", note: "認出周樸園時" },
                    { text: "我悶了三十年了！你結了婚，就搬了家，我以為這一輩子也見不著你了！", act: "二幕", note: "對周樸園的控訴" },
                    { text: "周家的空氣滿是罪惡，我的女兒說什麼也不能在這兒多呆！", act: "二幕", note: "保護女兒" },
                    { text: "我的眼淚早哭幹了，我沒有委屈，有的是恨，是悔，是三十年一天一天我自己受的苦！", act: "二幕", note: "控訴命運" },
                    { text: "我這些年的苦不是你那錢就算得清的！", act: "二幕", note: "拒絕補償" },
                    { text: "三十年前，過年三十的晚上我生下你的第二個兒子才三天，你們逼著我冒著大雪出去！", act: "二幕", note: "揭露往事" },
                    { text: "哦，天知道誰犯了罪，誰造這種孽！——他們都是可憐的孩子，不知道自己做的是什麼。", act: "四幕", note: "悲劇頂點" },
                    { text: "我現在老了，嫁給一個下等人，又生了個女孩，境況很不好。", act: "二幕", note: "低微處境" },
                    { text: "這地方怪得很，這屋子我像是在哪兒見過的！", act: "二幕", note: "命運的巧合" },
                    { text: "這是我的報應，我的報應。", act: "四幕", note: "自責" },
                    { text: "天底下地方大得很，怎麼？熬過這幾十年偏偏又把我這個可憐的孩子，放回到他——他的家裡？哦，好不公平的天哪！", act: "三幕", note: "命運諷刺" },
                    { text: "他們都是我的乾淨孩子，他們應當好好地活著，享著福。冤孽是在我心裡頭，苦也應當我一個人嘗。", act: "四幕", note: "母愛" },
                    { text: "人犯了一次罪過，第二次也就自地跟著來。", act: "三幕", note: "悔恨" }
                ],
                '四鳳': [
                    { text: "我死也不能叫媽知道這兒這些事情的！", act: "三幕", note: "隱瞞母親" },
                    { text: "哥哥，這屋子鬧鬼，我怕！", act: "三幕", note: "恐懼" },
                    { text: "老爺的脾氣您可知道，您這樣隨隨便便抹了兩下，皮鞋能擦好嗎？", act: "二幕", note: "對魯貴的提醒" },
                    { text: "媽，您別瞎說，這屋子怎麼會見過？您是想我想的夢裏到過這兒！", act: "二幕", note: "對母親的安慰" },
                    { text: "天氣這樣悶熱，回頭多半下雨。", act: "一幕", note: "預示雷雨" },
                    { text: "跟你縫衣服，燒飯做菜，我都做得好！只要你叫我跟你在一块儿。", act: "三幕", note: "對周萍的愛" },
                    { text: "萍，你不要這樣待我好不好？你明明知道我現在什麼都是你的！", act: "三幕", note: "情感請求" },
                    { text: "那——那天上的雷劈了我。", act: "四幕", note: "得知真相時" },
                    { text: "我答應您，以後我永遠不見周家的人。", act: "三幕", note: "對母親的承諾" },
                    { text: "萍，你帶我走！我不連累你，要是外面因為我，說你的壞話，我立刻就走。", act: "三幕", note: "請求帶走" },
                    { text: "媽，您願意您的女兒急得要死在您的眼前麼？", act: "三幕", note: "對母親的痛苦" },
                    { text: "我想起來，世界大得很，我們可以走，我們只要一塊兒離開這兒。", act: "三幕", note: "逃離願望" },
                    { text: "萍，以後我們永遠在一塊兒了，不分開了。", act: "四幕", note: "悲劇前預示" }
                ],
                '周沖': [
                    { text: "父親對不起您，可是他老了，我是您的將來，我要娶一個頂好的人。", act: "三幕", note: "對母親的承諾" },
                    { text: "有時我就忘了現在，忘了家，忘了你，忘了母親，並且忘了我自己。", act: "三幕", note: "逃避現實" },
                    { text: "我想，我像是在一個冬天的早晨，非常明亮的天空，……在無邊的海上……有一條輕得想海燕似的小帆船。", act: "一幕", note: "理想幻想" },
                    { text: "真的愛情免不了波折，我愛她，她會漸漸地明白我，喜歡我的。", act: "三幕", note: "對四鳳的愛" },
                    { text: "我恨這不平等的社會，我恨只講強權的人，我討厭我的父親，我們都是被壓迫的人，我們是一樣。", act: "三幕", note: "反抗精神" },
                    { text: "界大的很，你應當讀書，你就知道世界上有過許多人跟我們一樣地忍受著痛苦，慢慢地苦幹，以後又得到快樂。", act: "三幕", note: "鼓勵四鳳" },
                    { text: "我認為你的偏見太多。", act: "三幕", note: "對母親的反駁" },
                    { text: "我希望父親允許我把我的教育費分給她一半上學。", act: "三幕", note: "對四鳳的關心" },
                    { text: "爸，您何必這樣強迫呢？", act: "一幕", note: "反對父親" },
                    { text: "不，你把她帶走吧，只要你好好地待她！", act: "三幕", note: "對魯貴的請求" },
                    { text: "再見，我原諒你。我還是願意做你的朋友。", act: "三幕", note: "對魯貴的寬容" },
                    { text: "您不是一個平常的母親，您最大膽，最有想像，又，最同情我的思想的。", act: "一幕", note: "對繁漪的喜愛" },
                    { text: "她是最純潔，最有主張的好孩子，昨天我跟她求婚——", act: "三幕", note: "對母親訴說" },
                    { text: "不，你不要這樣說話，現在的世界是不該存在的。", act: "三幕", note: "理想主義" }
                ]
            };
            
            // 更新角色能力狀態 - 增強版視覺反饋
            function updateAbilityStatus() {
                if (!isGameRunning) return;
                
                const abilityStatus = document.getElementById('ability-status');
                const abilityCooldownBar = document.getElementById('ability-cooldown-bar');
                const abilityTimer = document.getElementById('ability-timer');
                
                if (!abilityStatus || !abilityCooldownBar) return;
                
                if (abilityActive) {
                    // 能力激活狀態
                    abilityStatus.textContent = '生效中';
                    abilityStatus.className = 'ml-1.5 px-2 py-0.5 bg-gradient-to-r from-green-600 to-green-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap status-pulse';
                    
                    // 更新持續時間進度條
                    const percent = abilityDuration / getAbilityDuration() * 100;
                    abilityCooldownBar.style.width = `${percent}%`;
                    abilityCooldownBar.className = 'h-full bg-gradient-to-r from-green-500 to-green-400 rounded-full transition-all duration-300';
                    
                    // 顯示剩餘時間
                    const remainingSeconds = Math.ceil(abilityDuration / 60);
                    if (abilityTimer) {
                        abilityTimer.textContent = `剩餘 ${remainingSeconds}s`;
                        abilityTimer.className = 'absolute right-0 -top-5 text-[9px] text-green-300 font-bold';
                    }
                    
                    // 減少持續時間
                    abilityDuration--;
                    if (abilityDuration <= 0) {
                        deactivateAbility();
                    }
                } else if (abilityCooldown) {
                    // 冷卻狀態
                    abilityStatus.textContent = '冷卻中';
                    abilityStatus.className = 'ml-1.5 px-2 py-0.5 bg-gradient-to-r from-red-600 to-red-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap';
                    
                    // 更新冷卻進度條
                    const percent = (1 - abilityCooldownTime / getAbilityCooldown()) * 100;
                    abilityCooldownBar.style.width = `${percent}%`;
                    abilityCooldownBar.className = 'h-full bg-gradient-to-r from-red-500 to-red-400 rounded-full transition-all duration-300';
                    
                    // 顯示冷卻倒計時
                    const remainingSeconds = Math.ceil(abilityCooldownTime / 60);
                    if (abilityTimer) {
                        abilityTimer.textContent = `冷卻 ${remainingSeconds}s`;
                        abilityTimer.className = 'absolute right-0 -top-5 text-[9px] text-red-300 font-bold';
                    }
                    
                    // 減少冷卻時間
                    abilityCooldownTime--;
                    if (abilityCooldownTime <= 0) {
                        abilityCooldown = false;
                        // 能力就緒時的視覺提示
                        showAbilityReadyNotification();
                    }
                } else {
                    // 就緒狀態
                    abilityStatus.textContent = '就緒';
                    abilityStatus.className = 'ml-1.5 px-2 py-0.5 bg-gradient-to-r from-blue-600 to-blue-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap status-pulse';
                    abilityCooldownBar.style.width = '100%';
                    abilityCooldownBar.className = 'h-full bg-gradient-to-r from-primary to-blue-400 rounded-full transition-all duration-300';
                    
                    // 清除倒計時顯示
                    if (abilityTimer) {
                        abilityTimer.textContent = '';
                    }
                }
            }
            
            // 能力就緒通知
            function showAbilityReadyNotification() {
                const notification = document.createElement('div');
                notification.className = 'absolute top-1/4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-blue-600 to-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-30 text-sm font-bold';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                            <path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <div>${characterAbility} 就緒!</div>
                            <div class="text-xs opacity-80">按空格鍵激活</div>
                        </div>
                    </div>
                `;
                
                gameContainer.appendChild(notification);
                
                // 播放就緒音效
                playThunderSound('button');
                
                // 動畫效果
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    notification.style.transition = 'all 0.5s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 500);
                }, 2000);
            }
            
            // 獲取能力持續時間 - 平衡持續時間
            function getAbilityDuration() {
                switch (characterAbility) {
                    case '威權力場': return 480; // 8秒
                    case '情感庇護': return 180; // 3秒
                    case '青春衝刺': return 240; // 4秒
                    case '優柔瞬移': return 1; // 瞬間效果
                    case '預知閃避': return 720; // 12秒 (大幅延長持續時間)
                    default: return 240; // 4秒
                }
            }
            
            // 獲取能力冷卻時間 - 進一步縮短冷卻時間提升遊戲體驗
            function getAbilityCooldown() {
                switch (characterAbility) {
                    case '威權力場': return 600; // 10秒 (顯著縮短)
                    case '隱忍堅韌': return 900; // 15秒 (顯著縮短)
                    case '優柔瞬移': return 480; // 8秒 (顯著縮短)
                    case '青春衝刺': return 360; // 6秒 (顯著縮短)
                    case '情感庇護': return 480; // 8秒 (顯著縮短)
                    case '預知閃避': return 600; // 10秒 (顯著縮短)
                    default: return 600; // 10秒
                }
            }
            
            // 激活角色能力 - 增強版本
            function activateAbility() {
                if (abilityActive || abilityCooldown) return;
                
                abilityActive = true;
                abilityDuration = getAbilityDuration();
                
                // 根據不同角色應用不同能力效果
                switch (characterAbility) {
                    case '威權力場':
                        // 減緩閃電下落速度 - 效果增強至50%
                        activeEffects.slowLightningFall = true;
                        
                        // 新增功能：威嚴場阻隔道具，負面道具無法接近
                        activeEffects.blockNegativeItems = true;
                        
                        // 視覺效果 - 威嚴光環（改進版）
                        createPressureField(true);
                        
                        // 新增：威嚴場中增強正面道具效果
                        activeEffects.enhancePositiveItems = true;
                        
                        // 音效和震動效果
                        playThunderSound('ability_周樸園');
                        
                        // 顯示效果提示
                        showAbilityEffectHint('減緩閃電50% | 阻隔負面道具', '#FFC107');
                        break;
                        
                    case '優柔瞬移':
                        // 能力改進：玩家可選擇瞬移位置
                        // 創建瞬移選擇器
                        createTeleportSelector();
                        
                        // 顯示效果提示
                        showAbilityEffectHint('選擇瞬移位置 + 短暫無敵', '#3399CC');
                        
                        // 播放特殊音效
                        playThunderSound('ability_周萍');
                        break;
                        
                    case '青春衝刺':
                        // 青春衝刺效果 - 大幅提升速度
                        activeEffects.youthSprint = true;
                        
                        // 新增功能：衝刺過程中暫時無視閃電碰撞
                        activeEffects.dashInvincibility = true;
                        
                        // 清除任何已存在的粒子效果和速度線
                        const oldEffect = document.getElementById('sprint-effect');
                        if (oldEffect) oldEffect.remove();
                        
                        const oldLines = document.getElementById('speed-lines-container');
                        if (oldLines) oldLines.remove();
                        
                        if (activeEffects.sprintParticles) {
                            activeEffects.sprintParticles.stop();
                            delete activeEffects.sprintParticles;
                        }
                        
                        // 現在創建新的粒子效果，只在能力激活時
                        createSprintEffect(true);
                        
                        // 添加地面衝擊波效果
                        createGroundWave();
                        
                        // 播放特殊音效
                        playThunderSound('ability_周沖');
                        
                        // 顯示效果提示
                        showAbilityEffectHint('速度+200% | 衝刺時無視閃電', '#66CCFF');
                        break;
                        
                    case '隱忍堅韌':
                        // 改進：隱忍堅韌提供多重保護
                        activeEffects.damageReduction = true; // 傷害減免
                        activeEffects.oneTimeImmunity = true; // 保留完全免疫
                        
                        // 新增：吸收閃電獲得積分
                        activeEffects.absorbLightning = true;
                        
                        // 視覺效果 - 更強的護盾
                        createResilienceEffect(true);
                        
                        // 播放特殊音效
                        playThunderSound('ability_魯侍萍');
                        
                        // 顯示效果提示
                        showAbilityEffectHint('堅韌之盾 | 閃電傷害轉為積分', '#9C27B0');
                        break;
                        
                    case '情感庇護':
                        // 改進：情感殘影具有吸引閃電的能力
                        activeEffects.createAfterimagePath = true;
                        activeEffects.decoyAttractsLightning = true;
                        
                        // 新增效果：情感力場保護角色
                        activeEffects.emotionalShield = true;
                        
                        // 清除現有殘影
                        const allDecoys = document.querySelectorAll('.character-decoy');
                        allDecoys.forEach(decoy => decoy.remove());
                        
                        // 添加情感護盾視覺效果 - 強化版
                        createShieldEffect('#E91E63', true);
                        
                        // 創建情感粒子系統
                        createEmotionalParticles();
                        
                        // 播放特殊音效
                        playThunderSound('ability_繁漪');
                        
                        // 顯示效果提示
                        showAbilityEffectHint('殘影吸引閃電 | 減少30%傷害', '#E91E63');
                        break;
                        
                    case '預知閃避':
                        // 改進：預知閃避提供時間減緩效果
                        activeEffects.enhancedWarning = true;
                        activeEffects.timeSlowdown = true;
                        
                        // 新增：清除屏幕上當前的所有閃電
                        activeEffects.clearCurrentLightning = true;
                        clearActiveLightning();
                        
                        // 顯示時間減緩視覺效果
                        createTimeslowEffect();
                        
                        // 預覽多個未來閃電位置
                        showAllFutureLightningWarnings(true);
                        
                        // 播放特殊音效
                        playThunderSound('ability_四鳳');
                        
                        // 顯示效果提示
                        showAbilityEffectHint('預見未來 | 時間減緩20%', '#FFCC66');
                        break;
                }
                
                // 主要激活音效（如果未播放特殊音效）
                if (!['威權力場', '優柔瞬移', '青春衝刺', '隱忍堅韌', '情感庇護', '預知閃避'].includes(characterAbility)) {
                    playThunderSound('button');
                }
                
                // 激活時的屏幕效果
                gameContainer.classList.add('screen-flash');
                setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
            }
            
            // 清除當前所有閃電 - 新功能
            function clearActiveLightning() {
                // 標記所有閃電為非活動
                lightning.forEach(bolt => {
                    // 創建消散效果
                    createLightningDissipateEffect(bolt.x, bolt.y, bolt.width, bolt.height);
                    bolt.active = false;
                });
                
                // 清空閃電數組
                lightning = [];
                
                // 播放特殊音效
                playThunderSound('big');
            }
            
            // 創建閃電消散效果
            function createLightningDissipateEffect(x, y, width, height) {
                // 為每個閃電創建消散粒子效果
                const dissipateParticles = new ParticleSystem('game-container', {
                    maxParticles: 30,
                    particleSize: { min: 2, max: 4 },
                    speed: { min: 0.5, max: 2 },
                    colors: ['#FFFF99', '#FFFFFF', '#FFFFCC'],
                    duration: 1000,
                    spread: { x: width, y: height },
                    gravity: 0,
                    friction: 0.98,
                    blendMode: 'screen',
                    shape: 'circle',
                    behavior: 'spiral'
                });
                
                // 在閃電位置啟動粒子效果
                dissipateParticles.start(x + width/2, y + height/2);
                
                // 短時間後停止並移除粒子效果
                setTimeout(() => {
                    if (dissipateParticles) {
                        dissipateParticles.stop();
                    }
                }, 1000);
            }
            
            // 創建瞬移選擇器 - 優柔瞬移能力增強
            function createTeleportSelector() {
                // 創建瞬移選擇容器
                const selectorContainer = document.createElement('div');
                selectorContainer.id = 'teleport-selector';
                selectorContainer.className = 'absolute bottom-0 w-full pointer-events-none z-20';
                selectorContainer.style.height = `${gameHeight - 40}px`;
                
                // 創建3個可能的瞬移位置選項
                const positions = [
                    { x: gameWidth * 0.25, label: '左側' },
                    { x: gameWidth * 0.5, label: '中央' },
                    { x: gameWidth * 0.75, label: '右側' }
                ];
                
                // 在當前位置創建標記
                const currentMarker = document.createElement('div');
                currentMarker.className = 'absolute bottom-0 flex flex-col items-center';
                currentMarker.style.left = `${characterX}px`;
                currentMarker.style.transform = 'translateX(-50%)';
                
                const currentDot = document.createElement('div');
                currentDot.className = 'w-3 h-3 rounded-full bg-blue-400';
                currentMarker.appendChild(currentDot);
                
                // 當前位置文字
                const currentLabel = document.createElement('div');
                currentLabel.className = 'text-xs text-blue-400 mt-1';
                currentLabel.textContent = '當前';
                currentMarker.appendChild(currentLabel);
                
                selectorContainer.appendChild(currentMarker);
                
                // 為每個位置創建標記
                for (const pos of positions) {
                    const marker = document.createElement('div');
                    marker.className = 'absolute bottom-0 flex flex-col items-center';
                    marker.style.left = `${pos.x}px`;
                    marker.style.transform = 'translateX(-50%)';
                    
                    // 創建閃爍的圓點
                    const dot = document.createElement('div');
                    dot.className = 'w-6 h-6 rounded-full bg-blue-500 animate-pulse flex items-center justify-center';
                    dot.innerHTML = `<div class="w-3 h-3 rounded-full bg-white"></div>`;
                    
                    // 創建連接線
                    const line = document.createElement('div');
                    line.className = 'w-1 bg-blue-400 opacity-50';
                    line.style.height = `${gameHeight - 60}px`;
                    line.style.margin = '0 auto';
                    
                    // 創建標籤
                    const label = document.createElement('div');
                    label.className = 'text-sm text-white bg-blue-600 rounded px-2 py-1 mt-2';
                    label.textContent = pos.label;
                    
                    // 添加到標記
                    marker.appendChild(line);
                    marker.appendChild(dot);
                    marker.appendChild(label);
                    
                    // 添加到容器
                    selectorContainer.appendChild(marker);
                    
                    // 閃爍效果
                    let blinkInterval = setInterval(() => {
                        dot.classList.toggle('bg-blue-300');
                        dot.classList.toggle('bg-blue-600');
                    }, 500);
                    
                    // 停止間隔
                    setTimeout(() => clearInterval(blinkInterval), 3000);
                }
                
                // 添加到遊戲容器
                gameContainer.appendChild(selectorContainer);
                
                // 允許點擊選擇瞬移位置
                const teleportOptions = document.createElement('div');
                teleportOptions.className = 'absolute bottom-16 left-0 right-0 flex justify-around items-center z-20';
                
                // 為每個選項創建按鈕
                positions.forEach(pos => {
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-500 transition-all transform hover:scale-105 pointer-events-auto';
                    button.textContent = `傳送到${pos.label}`;
                    
                    // 點擊時執行瞬移
                    button.addEventListener('click', () => {
                        // 執行瞬移
                        const oldPosition = characterX;
                        characterX = pos.x;
                        
                        // 創建殘影效果
                        createEnhancedAfterimage(oldPosition, characterX);
                        
                        // 更新角色位置
                        if (characterElement) {
                            characterElement.style.left = `${characterX}px`;
                            updateQuoteBubblePosition();
                        }
                        
                        // 短暫無敵時間
                        invincible = true;
                        setTimeout(() => {
                            invincible = false;
                        }, 700);
                        
                        // 標記能力為已使用
                        abilityActive = false;
                        abilityCooldown = true;
                        abilityCooldownTime = getAbilityCooldown();
                        
                        // 移除選擇器
                        selectorContainer.remove();
                        teleportOptions.remove();
                    });
                    
                    teleportOptions.appendChild(button);
                });
                
                // 添加到遊戲容器
                gameContainer.appendChild(teleportOptions);
                
                // 設置自動移除的時間
                setTimeout(() => {
                    if (selectorContainer.parentNode) {
                        selectorContainer.remove();
                    }
                    if (teleportOptions.parentNode) {
                        teleportOptions.remove();
                    }
                    
                    // 如果玩家沒選擇，自動選擇當前位置附近安全區域
                    if (abilityActive && characterAbility === '優柔瞬移') {
                        // 自動瞬移到相對安全的位置
                        const safeMargin = characterWidth * 2;
                        const oldPosition = characterX;
                        const newPosition = Math.min(gameWidth - safeMargin, Math.max(safeMargin, characterX + (Math.random() < 0.5 ? -1 : 1) * safeMargin * 2));
                        
                        characterX = newPosition;
                        
                        // 創建殘影效果
                        createEnhancedAfterimage(oldPosition, characterX);
                        
                        // 更新角色位置
                        if (characterElement) {
                            characterElement.style.left = `${characterX}px`;
                            updateQuoteBubblePosition();
                        }
                        
                        // 短暫無敵時間
                        invincible = true;
                        setTimeout(() => {
                            invincible = false;
                        }, 500);
                        
                        // 標記能力為已使用
                        abilityActive = false;
                        abilityCooldown = true;
                        abilityCooldownTime = getAbilityCooldown();
                        
                        // 顯示效果提示
                        showAbilityEffectHint('自動瞬移到安全位置', '#3399CC');
                    }
                }, 3000); // 3秒選擇時間
            }
            
            // 增強版殘影效果（用於優柔瞬移增強版）
            function createEnhancedAfterimage(startX, endX) {
                if (!characterElement) return;
                
                // 創建一系列殘影，從起點到終點
                const steps = 5;
                const delay = 50;
                
                for (let i = 0; i < steps; i++) {
                    setTimeout(() => {
                        const progress = i / (steps - 1);
                        const posX = startX + (endX - startX) * progress;
                        
                        const decoy = document.createElement('div');
                        decoy.className = 'character-decoy absolute bottom-6 h-16 w-16 transform -translate-x-1/2 pointer-events-none';
                        decoy.style.left = `${posX}px`;
                        decoy.style.opacity = `${0.8 - progress * 0.6}`;
                        
                        // 克隆角色圖像
                        const decoyImg = document.createElement('img');
                        decoyImg.src = characterImg.src;
                        decoyImg.className = 'w-full h-full';
                        decoyImg.style.filter = `drop-shadow(0 0 5px #3399CC) hue-rotate(${progress * 20}deg)`;
                        
                        decoy.appendChild(decoyImg);
                        gameContainer.appendChild(decoy);
                        
                        // 淡出效果
                        setTimeout(() => {
                            decoy.style.opacity = '0';
                            decoy.style.transition = 'opacity 0.8s, transform 1s';
                            decoy.style.transform = 'translate(-50%, 10px) scale(0.9)';
                            
                            setTimeout(() => {
                                if (decoy.parentNode) {
                                    decoy.remove();
                                }
                            }, 800);
                        }, 400 + progress * 300);
                    }, i * delay);
                }
                
                // 創建瞬移粒子特效
                const teleportParticles = new ParticleSystem('game-container', {
                    maxParticles: 80,
                    particleSize: { min: 2, max: 6 },
                    speed: { min: 1, max: 3 },
                    colors: ['#3399CC', '#66B2FF', '#99CCFF', '#CCDFFF'],
                    duration: 1000,
                    spread: { x: 40, y: 25 },
                    friction: 0.92,
                    gravity: 0.02,
                    blendMode: 'screen',
                    fadeOut: true,
                    shape: 'circle',
                    emitFromCenter: true,
                    behavior: 'wave'
                });
                
                // 在終點啟動粒子效果
                teleportParticles.start(endX, gameHeight - characterHeight / 2);
                
                // 移除粒子效果
                setTimeout(() => {
                    if (teleportParticles) {
                        teleportParticles.stop();
                    }
                }, 1000);
                
                // 瞬移音效
                playThunderSound('ability_周萍');
            }
            
            // 創建情感粒子系統 - 情感庇護增強效果
            function createEmotionalParticles() {
                if (!characterElement) return;
                
                // 創建情感粒子系統
                const emotionalParticles = new ParticleSystem('game-container', {
                    maxParticles: 100,
                    particleSize: { min: 3, max: 8 },
                    speed: { min: 0.5, max: 2 },
                    colors: ['#FF416C', '#FF4B2B', '#E91E63', '#FFC1E3'],
                    duration: 3000,
                    spread: { x: 50, y: 30 },
                    friction: 0.96,
                    gravity: -0.03, // 微弱上浮
                    blendMode: 'screen',
                    shape: 'circle',
                    rotate: true,
                    behavior: 'wave'
                });
                
                // 保存粒子系統
                activeEffects.emotionalParticles = emotionalParticles;
                
                // 在角色位置啟動粒子系統
                emotionalParticles.start(characterX, gameHeight - characterHeight / 2);
                
                // 更新粒子位置以跟隨角色
                const updateParticlePosition = () => {
                    if (!isGameRunning || !characterElement || !activeEffects.emotionalParticles) return;
                    if (!abilityActive || !activeEffects.emotionalShield) {
                        if (activeEffects.emotionalParticles) {
                            activeEffects.emotionalParticles.stop();
                            delete activeEffects.emotionalParticles;
                        }
                        return;
                    }
                    
                    // 更新粒子系統位置
                    if (activeEffects.emotionalParticles) {
                        activeEffects.emotionalParticles.updatePosition(characterX, gameHeight - characterHeight / 2);
                    }
                    
                    requestAnimationFrame(updateParticlePosition);
                };
                
                requestAnimationFrame(updateParticlePosition);
                
                // 設置殘影生成邏輯
                const createDecoyInterval = setInterval(() => {
                    if (!isGameRunning || !abilityActive || !activeEffects.createAfterimagePath) {
                        clearInterval(createDecoyInterval);
                        return;
                    }
                    
                    // 創建吸引閃電的情感殘影
                    createAttractiveDecoy(characterX, gameHeight - characterHeight);
                }, 800); // 每0.8秒創建一個殘影
                
                // 清理定時器
                setTimeout(() => {
                    clearInterval(createDecoyInterval);
                }, abilityDuration * 1000 / 60);
            }
            
            // 創建吸引閃電的情感殘影
            function createAttractiveDecoy(x, y) {
                if (!characterElement || !activeEffects.decoyAttractsLightning) return;
                
                // 創建一個能夠吸引閃電的殘影
                const decoy = document.createElement('div');
                decoy.className = 'character-decoy attractive-decoy absolute h-16 w-16 transform -translate-x-1/2 pointer-events-none z-5';
                
                // 隨機位置，但離角色不遠
                const offsetX = Math.random() * 200 - 100; // -100 到 100 的偏移
                const decoyX = Math.min(gameWidth - 40, Math.max(40, x + offsetX));
                decoy.style.left = `${decoyX}px`;
                decoy.style.bottom = `${y - gameHeight + 50 + Math.random() * 50}px`; // 稍微浮在空中
                decoy.style.opacity = '0.75';
                
                // 克隆角色圖像
                const decoyImg = document.createElement('img');
                decoyImg.src = characterImg.src;
                decoyImg.className = 'w-full h-full';
                decoyImg.style.filter = 'drop-shadow(0 0 5px #E91E63) brightness(1.2)';
                
                // 添加吸引指示器
                const attractIndicator = document.createElement('div');
                attractIndicator.className = 'absolute inset-0 rounded-full';
                attractIndicator.innerHTML = `
                    <div class="w-full h-full absolute rounded-full animate-ping bg-red-500 opacity-30"></div>
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-6">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E91E63" class="w-5 h-5 animate-pulse">
                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                    </div>
                `;
                
                decoy.appendChild(decoyImg);
                decoy.appendChild(attractIndicator);
                gameContainer.appendChild(decoy);
                
                // 儲存殘影的位置信息，用於閃電吸引
                if (!activeEffects.attractiveDecoys) {
                    activeEffects.attractiveDecoys = [];
                }
                
                // 添加到吸引殘影列表
                const decoyData = { x: decoyX, y: parseFloat(decoy.style.bottom) + characterHeight / 2, element: decoy };
                activeEffects.attractiveDecoys.push(decoyData);
                
                // 創建紅色情感粒子
                const decoyParticles = new ParticleSystem('game-container', {
                    maxParticles: 40,
                    particleSize: { min: 2, max: 4 },
                    speed: { min: 0.3, max: 1.5 },
                    colors: ['#FF416C', '#FF4B2B', '#E91E63', '#FFC1E3'],
                    duration: 2000,
                    spread: { x: 25, y: 25 },
                    friction: 0.98,
                    gravity: -0.01,
                    blendMode: 'screen',
                    shape: 'circle',
                    behavior: 'orbit'
                });
                
                decoyParticles.start(decoyX, gameHeight - parseFloat(decoy.style.bottom) - characterHeight / 2);
                
                // 淡出效果
                setTimeout(() => {
                    // 從吸引殘影列表中移除
                    if (activeEffects.attractiveDecoys) {
                        const index = activeEffects.attractiveDecoys.findIndex(d => d.element === decoy);
                        if (index >= 0) {
                            activeEffects.attractiveDecoys.splice(index, 1);
                        }
                    }
                    
                    // 視覺淡出
                    decoy.style.opacity = '0';
                    decoy.style.transition = 'opacity 0.8s, transform 1s';
                    decoy.style.transform = 'translate(-50%, 20px) scale(0.8)';
                    
                    // 停止粒子系統
                    decoyParticles.stop();
                    
                    // 移除元素
                    setTimeout(() => {
                        if (decoy.parentNode) {
                            decoy.remove();
                        }
                    }, 1000);
                }, 4000); // 持續4秒
            }
            
            // 創建地面衝擊波效果 - 青春衝刺增強
            function createGroundWave() {
                const wave = document.createElement('div');
                wave.className = 'absolute bottom-0 left-0 w-full pointer-events-none';
                wave.style.height = '30px';
                wave.style.background = 'radial-gradient(ellipse at center, rgba(102, 204, 255, 0.7) 0%, rgba(102, 204, 255, 0) 70%)';
                wave.style.transform = 'scaleY(0.3)';
                wave.style.transformOrigin = 'bottom';
                wave.style.animation = 'groundWave 2s linear';
                
                // 添加關鍵幀動畫
                const styleSheet = document.createElement('style');
                styleSheet.textContent = `
                    @keyframes groundWave {
                        0% { transform: scaleY(0.3) scaleX(0.1); opacity: 0.9; }
                        100% { transform: scaleY(0.3) scaleX(3); opacity: 0; }
                    }
                `;
                document.head.appendChild(styleSheet);
                
                gameContainer.appendChild(wave);
                
                // 自動移除
                setTimeout(() => {
                    wave.remove();
                }, 2000);
            }
            
            // 粒子系統基礎類 - 為所有角色技能提供粒子效果基礎
            class ParticleSystem {
                constructor(containerId, options = {}) {
                    this.container = document.getElementById(containerId) || gameContainer;
                    this.particles = [];
                    this.canvas = document.createElement('canvas');
                    this.canvas.className = 'absolute top-0 left-0 w-full h-full pointer-events-none z-10';
                    this.ctx = this.canvas.getContext('2d');
                    this.isActive = false;
                    this.animationId = null;
                    
                    // 設置選項，提供默認值
                    this.options = {
                        maxParticles: options.maxParticles || 100,
                        particleSize: options.particleSize || { min: 2, max: 5 },
                        speed: options.speed || { min: 1, max: 3 },
                        duration: options.duration || 2000, // 粒子存活時間 (毫秒)
                        colors: options.colors || ['#ffffff'],
                        gravity: options.gravity || 0,
                        friction: options.friction || 0.95,
                        spread: options.spread || { x: 10, y: 10 },
                        shape: options.shape || 'circle', // circle, square, or image
                        imageSrc: options.imageSrc || null,
                        fadeOut: options.fadeOut !== undefined ? options.fadeOut : true,
                        rotate: options.rotate || false,
                        blendMode: options.blendMode || 'source-over', // 混合模式
                        emitFromCenter: options.emitFromCenter !== undefined ? options.emitFromCenter : false
                    };
                    
                    // 初始化圖像（如果使用）
                    this.particleImage = null;
                    if (this.options.shape === 'image' && this.options.imageSrc) {
                        this.particleImage = new Image();
                        this.particleImage.src = this.options.imageSrc;
                    }
                    
                    // 為粒子系統設置其他可選特性
                    this.originX = options.originX || 0; // 粒子原點X
                    this.originY = options.originY || 0; // 粒子原點Y
                    this.behavior = options.behavior || 'default'; // 自定義行為
                }
                
                start(x, y) {
                    // 設置粒子發射原點
                    this.originX = x !== undefined ? x : (this.container.clientWidth / 2);
                    this.originY = y !== undefined ? y : (this.container.clientHeight - 100);
                    
                    // 調整canvas大小
                    this.canvas.width = this.container.clientWidth;
                    this.canvas.height = this.container.clientHeight;
                    
                    // 添加canvas到容器
                    this.container.appendChild(this.canvas);
                    
                    // 激活粒子系統
                    this.isActive = true;
                    
                    // 開始動畫循環
                    this.animate();
                }
                
                stop() {
                    this.isActive = false;
                    
                    // 清除動畫
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    
                    // 清空粒子
                    this.particles = [];
                    
                    // 移除canvas
                    if (this.canvas.parentNode) {
                        this.canvas.parentNode.removeChild(this.canvas);
                    }
                }
                
                createParticle() {
                    // 如果達到最大粒子數，不再創建
                    if (this.particles.length >= this.options.maxParticles) return;
                    
                    // 隨機粒子尺寸
                    const size = this.options.particleSize.min + 
                                Math.random() * (this.options.particleSize.max - this.options.particleSize.min);
                    
                    // 發射角度（隨機或定向）
                    const angle = this.options.emitFromCenter ? 
                                Math.random() * Math.PI * 2 : // 360度發射
                                Math.PI + (Math.random() * Math.PI); // 上半部發射 (180-360度)
                    
                    // 隨機速度
                    const speed = this.options.speed.min + 
                                Math.random() * (this.options.speed.max - this.options.speed.min);
                    
                    // 速度分量
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    
                    // 隨機顏色
                    const color = this.options.colors[Math.floor(Math.random() * this.options.colors.length)];
                    
                    // 隨機位置偏移
                    const offsetX = this.options.emitFromCenter ? 0 : (Math.random() * this.options.spread.x * 2 - this.options.spread.x);
                    const offsetY = this.options.emitFromCenter ? 0 : (Math.random() * this.options.spread.y * 2 - this.options.spread.y);
                    
                    // 創建粒子對象
                    const particle = {
                        x: this.originX + offsetX,
                        y: this.originY + offsetY,
                        size: size,
                        vx: vx,
                        vy: vy,
                        color: color,
                        alpha: 1,
                        life: 100, // 生命百分比
                        rotation: Math.random() * 360, // 初始旋轉角度
                        rotationSpeed: (Math.random() - 0.5) * 3, // 旋轉速度
                        createdAt: Date.now()
                    };
                    
                    // 特殊行為的額外屬性
                    if (this.behavior === 'orbit') {
                        particle.orbitRadius = 20 + Math.random() * 30;
                        particle.orbitSpeed = (Math.random() + 0.5) * 0.02;
                        particle.angle = Math.random() * Math.PI * 2;
                    } else if (this.behavior === 'wave') {
                        particle.waveAmplitude = 5 + Math.random() * 10;
                        particle.waveFrequency = 0.05 + Math.random() * 0.05;
                        particle.baseX = particle.x;
                    }
                    
                    this.particles.push(particle);
                }
                
                updateParticles() {
                    const now = Date.now();
                    const duration = this.options.duration;
                    
                    // 更新所有粒子
                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        const p = this.particles[i];
                        
                        // 計算生命時間
                        const elapsed = now - p.createdAt;
                        p.life = Math.max(0, 100 - (elapsed / duration) * 100);
                        
                        // 如果粒子壽命結束，移除
                        if (p.life <= 0) {
                            this.particles.splice(i, 1);
                            continue;
                        }
                        
                        // 特殊行為模式
                        if (this.behavior === 'orbit') {
                            // 軌道行為：圍繞原點旋轉
                            p.angle += p.orbitSpeed;
                            p.x = this.originX + Math.cos(p.angle) * p.orbitRadius;
                            p.y = this.originY + Math.sin(p.angle) * p.orbitRadius;
                            
                            // 逐漸向外擴展
                            p.orbitRadius += 0.1;
                        } else if (this.behavior === 'wave') {
                            // 波浪行為：沿波浪路徑移動
                            p.x = p.baseX + Math.sin(elapsed * p.waveFrequency) * p.waveAmplitude;
                            p.y += p.vy;
                            
                            // 逐漸減小波幅
                            p.waveAmplitude *= 0.99;
                        } else if (this.behavior === 'spiral') {
                            // 螺旋行為：沿螺旋路徑移動
                            p.angle = (p.angle || 0) + 0.05;
                            const radius = 5 + (100 - p.life) * 0.2;
                            p.x = this.originX + Math.cos(p.angle) * radius;
                            p.y = this.originY + Math.sin(p.angle) * radius;
                        } else if (this.behavior === 'attract') {
                            // 吸引行為：粒子向原點移動
                            const dx = this.originX - p.x;
                            const dy = this.originY - p.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            const force = 0.02; // 吸引力
                            
                            if (dist > 1) {
                                p.vx += (dx / dist) * force;
                                p.vy += (dy / dist) * force;
                            }
                            
                            // 應用速度
                            p.x += p.vx;
                            p.y += p.vy;
                            
                            // 應用摩擦力
                            p.vx *= this.options.friction;
                            p.vy *= this.options.friction;
                        } else {
                            // 默認行為：常規物理運動
                            p.x += p.vx;
                            p.y += p.vy;
                            
                            // 應用重力
                            p.vy += this.options.gravity;
                            
                            // 應用摩擦力
                            p.vx *= this.options.friction;
                            p.vy *= this.options.friction;
                        }
                        
                        // 旋轉更新
                        if (this.options.rotate) {
                            p.rotation += p.rotationSpeed;
                        }
                        
                        // 透明度計算（如果啟用了漸隱）
                        if (this.options.fadeOut) {
                            p.alpha = p.life / 100;
                        }
                    }
                }
                
                draw() {
                    // 清空畫布
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // 設置全局混合模式
                    this.ctx.globalCompositeOperation = this.options.blendMode;
                    
                    // 繪製所有粒子
                    for (const p of this.particles) {
                        this.ctx.save();
                        
                        // 設置透明度
                        this.ctx.globalAlpha = p.alpha;
                        
                        // 繪製粒子
                        if (this.options.shape === 'circle') {
                            // 圓形粒子
                            this.ctx.beginPath();
                            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            this.ctx.fillStyle = p.color;
                            this.ctx.fill();
                        } else if (this.options.shape === 'square') {
                            // 方形粒子（帶旋轉）
                            this.ctx.translate(p.x, p.y);
                            this.ctx.rotate(p.rotation * Math.PI / 180);
                            this.ctx.fillStyle = p.color;
                            this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                        } else if (this.options.shape === 'image' && this.particleImage) {
                            // 圖像粒子
                            this.ctx.translate(p.x, p.y);
                            if (this.options.rotate) {
                                this.ctx.rotate(p.rotation * Math.PI / 180);
                            }
                            this.ctx.drawImage(
                                this.particleImage, 
                                -p.size/2, -p.size/2, 
                                p.size, p.size
                            );
                        }
                        
                        this.ctx.restore();
                    }
                    
                    // 重置混合模式
                    this.ctx.globalCompositeOperation = 'source-over';
                }
                
                animate() {
                    if (!this.isActive) return;
                    
                    // 創建新粒子
                    if (this.isActive && this.particles.length < this.options.maxParticles) {
                        const emitRate = Math.min(5, Math.ceil(this.options.maxParticles / 60)); // 每幀發射數量
                        for (let i = 0; i < emitRate; i++) {
                            this.createParticle();
                        }
                    }
                    
                    // 更新所有粒子
                    this.updateParticles();
                    
                    // 繪製粒子
                    this.draw();
                    
                    // 如果系統仍活躍，繼續動畫
                    if (this.isActive) {
                        this.animationId = requestAnimationFrame(() => this.animate());
                    }
                }
                
                // 更新發射位置（用於跟隨角色）
                updatePosition(x, y) {
                    if (x !== undefined) this.originX = x;
                    if (y !== undefined) this.originY = y;
                }
            }
            
            // 青春衝刺效果
            function createSprintEffect() {
                if (!characterElement) return;
                
                // 移除舊效果（如果存在）
                const oldEffect = document.getElementById('sprint-effect');
                if (oldEffect) oldEffect.remove();
                
                // 創建青春衝刺粒子系統
                const sprintParticles = new ParticleSystem('game-container', {
                    maxParticles: 150,
                    particleSize: { min: 2, max: 6 },
                    speed: { min: 1, max: 2.5 },
                    colors: ['#66CCFF', '#4CD2FF', '#00BFFF', '#33F0FF'],
                    duration: 800, // 粒子壽命較短，快速消失
                    spread: { x: 20, y: 15 },
                    friction: 0.92,
                    gravity: 0.05,
                    blendMode: 'screen',
                    fadeOut: true,
                    shape: 'circle',
                    // 特殊參數，指定這是一個速度線效果
                    behavior: 'default'
                });
                
                // 保存粒子系統以便後續使用
                activeEffects.sprintParticles = sprintParticles;
                
                // 開始粒子效果
                sprintParticles.start(characterX, gameHeight - characterHeight);
                
                // 創建後續軌跡（在角色移動時）
                const updateTrail = () => {
                    if (!isGameRunning || !characterElement || !activeEffects.sprintParticles) return;
                    if (!abilityActive || !activeEffects.youthSprint) {
                        // 如果能力不再活躍，停止粒子系統並清理
                        if (activeEffects.sprintParticles) {
                            activeEffects.sprintParticles.stop();
                            delete activeEffects.sprintParticles;
                        }
                        return;
                    }
                    
                    // 更新粒子發射位置來跟隨角色
                    if (activeEffects.sprintParticles) {
                        activeEffects.sprintParticles.updatePosition(characterX, gameHeight - characterHeight * 0.5);
                    }
                    
                    // 繼續更新
                    requestAnimationFrame(updateTrail);
                };
                
                requestAnimationFrame(updateTrail);
                
                // 添加速度線效果 - 使用HTML元素實現額外的視覺強化
                const speedLinesContainer = document.createElement('div');
                speedLinesContainer.id = 'speed-lines-container';
                speedLinesContainer.className = 'absolute inset-0 overflow-hidden pointer-events-none z-5';
                
                // 創建多條速度線
                for (let i = 0; i < 15; i++) {
                    const line = document.createElement('div');
                    line.className = 'absolute';
                    line.style.width = `${1 + Math.random() * 2}px`;
                    line.style.height = `${15 + Math.random() * 30}px`;
                    line.style.backgroundColor = `rgba(100, 255, 200, ${0.3 + Math.random() * 0.4})`;
                    line.style.left = `${Math.random() * 100}%`;
                    line.style.top = `${Math.random() * 100}%`;
                    line.style.transform = `rotate(${-10 + Math.random() * 20}deg)`;
                    line.style.opacity = '0.9';
                    line.style.filter = 'blur(1px)'; // 模糊效果強化速度感
                    line.style.animation = `speedLine ${0.5 + Math.random() * 0.3}s linear infinite`;
                    
                    // 添加關鍵幀動畫
                    const styleSheet = document.createElement('style');
                    styleSheet.textContent = `
                        @keyframes speedLine {
                            0% { transform: translateX(120vw) rotate(${-10 + Math.random() * 20}deg); }
                            100% { transform: translateX(-20vw) rotate(${-10 + Math.random() * 20}deg); }
                        }
                    `;
                    document.head.appendChild(styleSheet);
                    
                    speedLinesContainer.appendChild(line);
                }
                
                characterElement.appendChild(speedLinesContainer);
                
                // 能力結束時清理速度線
                setTimeout(() => {
                    const container = document.getElementById('speed-lines-container');
                    if (container && container.parentNode) {
                        container.remove();
                    }
                }, getAbilityDuration() * 1000 / 60);
            }
            
            // 殘影效果（用於情感庇護和優柔瞬移）
            function createAfterimage(positionX, color = '#E91E63') {
                if (!characterElement) return;
                
                const decoy = document.createElement('div');
                decoy.className = 'character-decoy absolute bottom-6 h-16 w-16 transform -translate-x-1/2 pointer-events-none';
                decoy.style.left = `${positionX}px`;
                decoy.style.opacity = '0.7';
                
                // 克隆角色圖像
                const decoyImg = document.createElement('img');
                decoyImg.src = characterImg.src;
                decoyImg.className = 'w-full h-full';
                decoyImg.style.filter = `drop-shadow(0 0 5px ${color})`;
                
                decoy.appendChild(decoyImg);
                gameContainer.appendChild(decoy);
                
                // 淡出效果
                setTimeout(() => {
                    decoy.style.opacity = '0';
                    decoy.style.transition = 'opacity 0.8s, transform 1s';
                    decoy.style.transform = 'translate(-50%, 10px) scale(0.9)';
                    
                    setTimeout(() => {
                        if (decoy.parentNode) {
                            decoy.remove();
                        }
                    }, 1000);
                }, 300);
            }
            
            // 威嚴力場效果 - 修復位置跟隨問題
            function createPressureField() {
                if (!characterElement) return;
                
                const field = document.createElement('div');
                field.className = 'absolute rounded-full pointer-events-none';
                field.id = 'pressure-field';
                field.style.width = `${gameWidth * 0.6}px`;
                field.style.height = `${gameWidth * 0.6}px`;
                field.style.left = `${characterX}px`;
                field.style.bottom = `${characterHeight - 20}px`;
                field.style.transform = 'translate(-50%, 50%)';
                field.style.background = 'radial-gradient(circle, rgba(255,194,10,0.1) 0%, rgba(255,194,10,0.05) 50%, rgba(255,194,10,0) 80%)';
                field.style.border = '2px solid rgba(255,194,10,0.3)';
                field.style.boxShadow = '0 0 15px rgba(255,194,10,0.2)';
                field.style.animation = 'pulse 2s infinite ease-in-out';
                
                gameContainer.appendChild(field);
                
                // 威權力場位置跟隨系統 - 多重保障機制
                const updateFieldPosition = () => {
                    const field = document.getElementById('pressure-field');
                    if (field && field.parentNode) {
                        field.style.left = `${characterX}px`;
                    }
                };
                
                // 方案1: 監聽角色元素的style屬性變化
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'style') {
                            updateFieldPosition();
                        }
                    });
                });
                
                if (characterElement) {
                    observer.observe(characterElement, { attributes: true });
                }
                
                // 方案2: 使用requestAnimationFrame持續更新（主要方案）
                let isFieldActive = true;
                const animationUpdateField = () => {
                    if (!isFieldActive || !isGameRunning) return;
                    
                    const field = document.getElementById('pressure-field');
                    if (!field) {
                        isFieldActive = false;
                        return;
                    }
                    
                    // 確保威權力場始終跟隨角色
                    if (characterAbility === '威權力場' && abilityActive) {
                        updateFieldPosition();
                        requestAnimationFrame(animationUpdateField);
                    } else {
                        isFieldActive = false;
                    }
                };
                
                // 啟動動畫循環
                requestAnimationFrame(animationUpdateField);
                
                // 方案3: 定期檢查備用方案
                const intervalId = setInterval(() => {
                    if (!isGameRunning || characterAbility !== '威權力場' || !abilityActive) {
                        clearInterval(intervalId);
                        return;
                    }
                    updateFieldPosition();
                }, 100); // 每100ms檢查一次
                
                // 在能力結束時移除力場和監聽器
                setTimeout(() => {
                    const field = document.getElementById('pressure-field');
                    if (field && field.parentNode) {
                        field.style.opacity = '0';
                        field.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (field && field.parentNode) {
                                field.remove();
                            }
                        }, 500);
                    }
                    
                    // 清理所有監聽器和定時器
                    isFieldActive = false;
                    observer.disconnect();
                    clearInterval(intervalId);
                }, abilityDuration * 1000 / 60);
            }
            
            // 隱忍堅韌效果
            function createResilienceEffect() {
                if (!characterElement) return;
                
                const aura = document.createElement('div');
                aura.className = 'absolute rounded-full pointer-events-none';
                aura.id = 'resilience-aura';
                aura.style.width = `${characterWidth * 1.5}px`;
                aura.style.height = `${characterHeight * 1.2}px`;
                aura.style.left = '50%';
                aura.style.top = '50%';
                aura.style.transform = 'translate(-50%, -50%)';
                aura.style.background = 'radial-gradient(ellipse, rgba(156,39,176,0.3) 0%, rgba(156,39,176,0.1) 70%, rgba(156,39,176,0) 100%)';
                aura.style.boxShadow = '0 0 10px rgba(156,39,176,0.5)';
                aura.style.animation = 'pulse 1.5s infinite ease-in-out';
                
                characterElement.appendChild(aura);
            }
            
            // 時間減緩效果
            function createTimeslowEffect() {
                // 全局視覺效果
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 pointer-events-none z-20';
                overlay.id = 'timeslow-overlay';
                overlay.style.background = 'radial-gradient(circle, rgba(255,204,102,0) 20%, rgba(255,204,102,0.1) 100%)';
                overlay.style.backdropFilter = 'contrast(1.05) brightness(1.05)';
                overlay.style.animation = 'pulse 2s infinite ease-in-out';
                
                gameContainer.appendChild(overlay);
                
                // 視覺增強 - 添加時間痕跡粒子
                const addTimeParticles = () => {
                    if (!isGameRunning) return;
                    if (!abilityActive || !activeEffects.timeSlowdown) return;
                    
                    // 在螢幕上隨機添加"時間粒子"
                    const particle = document.createElement('div');
                    particle.className = 'absolute rounded-full pointer-events-none';
                    particle.style.width = '2px';
                    particle.style.height = '2px';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.background = 'rgba(255, 215, 100, 0.8)';
                    particle.style.boxShadow = '0 0 3px rgba(255, 215, 100, 0.5)';
                    
                    gameContainer.appendChild(particle);
                    
                    // 淡出效果
                    setTimeout(() => {
                        particle.style.opacity = '0';
                        particle.style.transition = 'opacity 1s';
                        
                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.remove();
                            }
                        }, 1000);
                    }, 800);
                    
                    // 繼續添加粒子
                    if (abilityActive && activeEffects.timeSlowdown) {
                        setTimeout(addTimeParticles, 100);
                    }
                };
                
                addTimeParticles();
                
                // 在能力結束時移除效果
                setTimeout(() => {
                    const overlay = document.getElementById('timeslow-overlay');
                    if (overlay && overlay.parentNode) {
                        overlay.style.opacity = '0';
                        overlay.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (overlay && overlay.parentNode) {
                                overlay.remove();
                            }
                        }, 500);
                    }
                }, abilityDuration * 1000 / 60);
            }
            
            // 創建護盾視覺效果
            function createShieldEffect(color) {
                if (!characterElement) return;
                
                const shield = document.createElement('div');
                shield.className = 'absolute z-10 pointer-events-none';
                shield.id = 'character-shield';
                shield.style.left = `${characterX}px`;
                shield.style.bottom = '0';
                shield.style.width = `${characterWidth * 2}px`;
                shield.style.height = `${characterHeight * 1.5}px`;
                shield.style.borderRadius = '50%';
                shield.style.transform = 'translateX(-50%)';
                shield.style.background = `radial-gradient(ellipse at center, ${color}44 0%, ${color}22 60%, transparent 80%)`;
                shield.style.boxShadow = `0 0 15px ${color}88`;
                shield.style.opacity = '0.8';
                shield.style.animation = 'pulse 2s infinite';
                
                // 添加到遊戲容器
                gameContainer.appendChild(shield);
                
                // 更新護盾位置的函數
                function updateShieldPosition() {
                    if (shield && shield.parentNode) {
                        shield.style.left = `${characterX}px`;
                    }
                }
                
                // 監聽角色移動以更新護盾位置
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'style') {
                            updateShieldPosition();
                        }
                    });
                });
                
                if (characterElement) {
                    observer.observe(characterElement, { attributes: true });
                }
                
                // 在能力結束時移除護盾
                setTimeout(() => {
                    if (shield && shield.parentNode) {
                        shield.style.opacity = '0';
                        shield.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (shield && shield.parentNode) {
                                shield.remove();
                                observer.disconnect();
                            }
                        }, 500);
                    }
                }, abilityDuration * 1000 / 60); // 轉換為毫秒
            }
            
            // 顯示能力效果提示
            function showAbilityEffectHint(text, color) {
                const hintElement = document.createElement('div');
                hintElement.classList.add('absolute', 'left-1/2', 'top-1/3', 'transform', '-translate-x-1/2', 'bg-black', 'bg-opacity-70', 'px-4', 'py-2', 'rounded-lg', 'text-white', 'text-center', 'z-20', 'text-sm');
                hintElement.innerHTML = `<span style="color:${color};">${characterAbility}:</span> ${text}`;
                
                gameContainer.appendChild(hintElement);
                
                // 淡出效果
                setTimeout(() => {
                    hintElement.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        if (hintElement.parentNode) {
                            hintElement.remove();
                        }
                    }, 500);
                }, 1500);
            }
            
            // 停用角色能力
            function deactivateAbility() {
                abilityActive = false;
                abilityCooldown = true;
                abilityCooldownTime = getAbilityCooldown();
                
                // 移除所有效果
                activeEffects = {};
            }
            
            // 產生隨機道具 - 基於時間的隨機
            function generateItem(deltaTime) {
                // 將每幀概率轉換為基於時間的概率
                // 原來的幀概率: 0.0007 + (level * 0.0002)
                // 轉換為時間概率: 1 - (1 - 原概率)^(deltaTime * 60)
                const baseChance = 0.0007 + (level * 0.0002);
                const timeBasedChance = 1 - Math.pow(1 - baseChance, deltaTime * 60);
                
                if (Math.random() < timeBasedChance) {
                    // 使用稀有度系統選擇道具
                    const itemTemplate = selectRandomItem();
                    
                    // 道具基礎下落速度（像素/秒）
                    const BASE_ITEM_SPEED = 108 + Math.random() * 90;
                    
                    items.push({
                        ...itemTemplate,
                        x: Math.random() * (gameWidth - 40) + 20,
                        y: 0,
                        width: 30,
                        height: 30,
                        active: true,
                        speed: BASE_ITEM_SPEED // 速度現在為像素/秒
                    });
                }
            }
            
            // 更新道具 - 基於時間的移動，增加威權力場阻隔檢查
            function updateItems(deltaTime) {
                if (!characterElement) return;
                
                // 標準化時間差值，避免為零
                const dt = deltaTime || (1/60);
                
                for (let i = 0; i < items.length; i++) {
                    if (items[i].active) {
                        // 檢查威權力場是否阻隔負面道具
                        if (items[i].effect === 'subtractPoints' && 
                            characterAbility === '威權力場' && 
                            abilityActive && 
                            activeEffects.blockNegativeItems) {
                            
                            // 計算道具與角色的距離
                            const itemCenterX = items[i].x + items[i].width / 2;
                            const distanceToCharacter = Math.abs(itemCenterX - characterX);
                            const protectionRadius = gameWidth * 0.3; // 威權力場保護半徑
                            
                            // 如果負面道具進入威權力場範圍，推開它
                            if (distanceToCharacter < protectionRadius) {
                                const pushDirection = itemCenterX < characterX ? -1 : 1;
                                items[i].x += pushDirection * 100 * dt; // 推開道具
                                
                                // 確保道具不會被推出屏幕
                                items[i].x = Math.max(0, Math.min(gameWidth - items[i].width, items[i].x));
                                
                                // 創建視覺效果顯示阻隔
                                if (Math.random() < 0.1) { // 偶爾顯示阻隔效果
                                    createBlockEffect(items[i].x + items[i].width/2, items[i].y + items[i].height/2);
                                }
                            }
                        }
                        
                        // 使用時間差更新位置
                        items[i].y += items[i].speed * dt;
                        
                        // 檢查是否收集道具
                        const characterLeft = characterX - (characterWidth / 2);
                        const characterRight = characterX + (characterWidth / 2);
                        const characterTop = gameHeight - characterHeight;
                        
                        if (items[i].y + items[i].height >= characterTop && 
                            items[i].y <= gameHeight &&
                            items[i].x + items[i].width >= characterLeft && 
                            items[i].x <= characterRight) {
                            
                            // 收集道具
                            collectItem(items[i]);
                            items[i].active = false;
                        }
                        
                        // 移除超出畫面的道具
                        if (items[i].y > gameHeight) {
                            items[i].active = false;
                        }
                    }
                }
                
                // 清理不活躍的道具
                items = items.filter(item => item.active);
            }
            
            // 創建阻隔效果 - 威權力場推開負面道具的視覺效果
            function createBlockEffect(x, y) {
                const effect = document.createElement('div');
                effect.className = 'absolute pointer-events-none z-10';
                effect.style.left = `${x}px`;
                effect.style.top = `${y}px`;
                effect.style.width = '20px';
                effect.style.height = '20px';
                effect.style.transform = 'translate(-50%, -50%)';
                effect.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0.4) 50%, transparent 80%)';
                effect.style.borderRadius = '50%';
                effect.style.animation = 'pulse 0.5s ease-out';
                
                gameContainer.appendChild(effect);
                
                // 自動移除效果
                setTimeout(() => {
                    if (effect.parentNode) {
                        effect.remove();
                    }
                }, 500);
            }
            
            // 收集道具 - 增加威權力場保護效果檢查
            function collectItem(item) {
                // 檢查威權力場是否阻隔負面道具
                if (item.effect === 'subtractPoints' && 
                    characterAbility === '威權力場' && 
                    abilityActive && 
                    activeEffects.blockNegativeItems) {
                    
                    // 威權力場阻隔負面道具
                    showItemEffectPopup({
                        ...item,
                        name: `${item.name} (已阻隔)`,
                        description: '威權力場阻隔了負面道具的影響！',
                        isPositive: true
                    });
                    
                    // 播放威權力場保護音效
                    playThunderSound('ability_周樸園');
                    
                    // 顯示阻隔效果動畫
                    showScoreAnimation('阻隔!', true);
                    
                    // 威權力場阻隔效果 - 金色光芒
                    createItemEffect('#FFD700', 0.6);
                    
                    return; // 直接返回，不應用負面效果
                }
                
                // 顯示道具效果提示
                showItemEffectPopup(item);
                
                // 根據道具類型應用加分或減分效果
                if (item.effect === 'addPoints') {
                    // 加分效果
                    let pointValue = item.pointValue;
                    
                    // 檢查威權力場是否增強正面道具效果
                    if (characterAbility === '威權力場' && 
                        abilityActive && 
                        activeEffects.enhancePositiveItems) {
                        pointValue = Math.floor(pointValue * 1.5); // 增強50%效果
                        
                        // 顯示增強提示
                        setTimeout(() => {
                            showScoreAnimation(`威權加成 +${pointValue - item.pointValue}`, true);
                        }, 500);
                    }
                    
                    score += pointValue;
                    
                    // 播放積極音效
                    playThunderSound('button');
                    
                    // 顯示加分動畫
                    showScoreAnimation(`+${pointValue}`, true);
                    
                    // 正面道具收集視覺效果 - 綠色光芒
                    createItemEffect('#4CAF50', 0.4);
                    
                } else if (item.effect === 'subtractPoints') {
                    // 扣分效果（只有在威權力場未阻隔的情況下才會執行到這裡）
                    score = Math.max(0, score + item.pointValue); // 使用 += 因為 pointValue 已經是負數
                    
                    // 播放消極音效
                    playThunderSound('random');
                    
                    // 顯示扣分動畫
                    showScoreAnimation(item.pointValue, false);
                    
                    // 負面道具收集視覺效果 - 紅色光芒
                    createItemEffect('#F44336', 0.4);
                    
                    // 震動效果
                    gameContainer.classList.add('strong-shake');
                    setTimeout(() => {
                        gameContainer.classList.remove('strong-shake');
                    }, 500);
                }
                
                // 更新分數顯示
                scoreElement.textContent = score;
                
                // 移除之前的台詞氣泡（如果存在）
                if (currentQuoteBubble) {
                    currentQuoteBubble.remove();
                    currentQuoteBubble = null;
                }
                
                // 輔助函數：創建道具效果
                function createItemEffect(color, opacity) {
                    const effect = document.createElement('div');
                    effect.className = 'absolute bottom-16 left-1/2 transform -translate-x-1/2 z-5 pointer-events-none';
                    effect.style.width = `${characterWidth * 1.8}px`;
                    effect.style.height = `${characterHeight * 1.5}px`;
                    effect.style.background = `radial-gradient(ellipse at center, ${color}99 0%, ${color}${Math.floor(opacity * 255).toString(16)} 20%, transparent 70%)`;
                    effect.style.borderRadius = '50%';
                    effect.style.animation = 'pulse 1.5s';
                    effect.style.opacity = '0.8';
                    
                    gameContainer.appendChild(effect);
                    
                    // 效果自動移除
                    setTimeout(() => {
                        effect.style.opacity = '0';
                        effect.style.transition = 'opacity 0.5s';
                        setTimeout(() => effect.remove(), 500);
                    }, 1200);
                }
            }
            
            // 顯示分數變化動畫
            function showScoreAnimation(points, isPositive) {
                const animation = document.createElement('div');
                animation.className = 'absolute z-30 text-lg font-bold';
                animation.style.left = `${characterX}px`;
                animation.style.bottom = `${characterHeight + 20}px`;
                animation.style.transform = 'translate(-50%, 0)';
                animation.style.textShadow = '0 0 3px rgba(0,0,0,0.7)';
                
                if (isPositive) {
                    // 加分動畫
                    animation.style.color = '#4CAF50';
                    animation.innerHTML = `+${points}`;
                } else {
                    // 減分動畫
                    animation.style.color = '#F44336';
                    animation.innerHTML = points; // 已經是負數
                }
                
                // 添加動畫效果
                animation.style.animation = 'scoreFloat 1.5s ease-out forwards';
                
                // 添加CSS動畫
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    @keyframes scoreFloat {
                        0% { transform: translate(-50%, 0); opacity: 1; }
                        100% { transform: translate(-50%, -50px); opacity: 0; }
                    }
                `;
                document.head.appendChild(styleElement);
                
                gameContainer.appendChild(animation);
                
                // 自動移除
                setTimeout(() => {
                    animation.remove();
                }, 1500);
            }
            
            // 顯示道具效果提示 - 更新為展示加分或減分效果
            function showItemEffectPopup(item) {
                const popupElement = document.createElement('div');
                popupElement.classList.add('absolute', 'top-1/4', 'left-1/2', 'transform', '-translate-x-1/2', 'bg-black', 'bg-opacity-80', 'text-white', 'rounded-lg', 'p-3', 'text-center', 'z-30');
                
                // 根據道具是加分還是減分決定顏色和圖標
                const effectColor = item.isPositive ? '#4CAF50' : '#F44336';
                const effectIcon = item.isPositive ? '↑' : '↓';
                const pointsText = item.isPositive ? `+${item.pointValue}` : item.pointValue;
                
                popupElement.innerHTML = `
                    <div class="font-bold text-sm mb-1" style="color: ${item.color}">${item.name} <span style="color: ${effectColor}">${pointsText}</span></div>
                    <div class="text-xs px-2">${item.description}</div>
                    <div class="mt-1 text-xs font-medium rounded-full px-2 py-0.5 inline-block" style="background-color: ${effectColor}30;">
                        ${effectIcon} ${item.isPositive ? '積極意象' : '消極意象'}
                    </div>
                `;
                
                document.getElementById('game-container').appendChild(popupElement);
                
                setTimeout(() => {
                    popupElement.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        if (popupElement.parentNode) {
                            popupElement.remove();
                        }
                    }, 500);
                }, 2500); // 延長顯示時間
            }
            
            // 繪製道具 - 確保與首頁顯示一致
            function drawItems() {
                for (const item of items) {
                    // 使用相同的道具圖標邏輯
                    if(window.itemDetails && window.itemDetails[item.id]) {
                        // 獲取與開始介面一致的道具圖標
                        const itemDetail = window.itemDetails[item.id];
                        
                        // 繪製圓形背景 - 使用與開始介面一致的漸變效果
                        const gradient = ctx.createRadialGradient(
                            item.x + item.width/2, item.y + item.height/2, 0,
                            item.x + item.width/2, item.y + item.height/2, item.width/2
                        );
                        
                        // 從亮到暗的漸變，類似首頁的漸變
                        const lighterColor = adjustColor(item.color, 30);
                        gradient.addColorStop(0, lighterColor);
                        gradient.addColorStop(1, item.color);
                        
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // 繪製道具符號 - 使用相同的符號
                        ctx.fillStyle = 'white';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(itemDetail.icon || item.symbol, item.x + item.width/2, item.y + item.height/2);
                    } else {
                        // 備用方案，保留原有道具繪製方式
                        ctx.fillStyle = item.color;
                        ctx.beginPath();
                        ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // 繪製道具符號
                        ctx.fillStyle = 'white';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(item.symbol, item.x + item.width/2, item.y + item.height/2);
                    }
                    
                    // 發光效果
                    ctx.shadowColor = item.color;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2 - 2, 0, Math.PI * 2);
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // 重置陰影
                    ctx.shadowBlur = 0;
                    ctx.shadowColor = 'transparent';
                }
                
                // 輔助函數：調整顏色亮度 (與彈出詳情中相同)
                function adjustColor(color, percent) {
                    var R = parseInt(color.substring(1,3),16);
                    var G = parseInt(color.substring(3,5),16);
                    var B = parseInt(color.substring(5,7),16);
                
                    R = parseInt(R * (100 + percent) / 100);
                    G = parseInt(G * (100 + percent) / 100);
                    B = parseInt(B * (100 + percent) / 100);
                
                    R = (R<255)?R:255;  
                    G = (G<255)?G:255;  
                    B = (B<255)?B:255;  
                
                    R = Math.max(0, R);
                    G = Math.max(0, G);
                    B = Math.max(0, B);
                
                    var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
                    var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
                    var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
                
                    return "#"+RR+GG+BB;
                }
            }
            
            // 顯示閃電預警 - 為四鳳增強預警效果（使用優化後的顯示方式）
            function showLightningWarning(x, isEnhanced = false) {
                if (!gameContainer) return;
              
                // 創建預警元素
                const warningElement = document.createElement('div');
                warningElement.classList.add('absolute', 'z-10');
                warningElement.style.left = `${x}px`;
                warningElement.style.top = '10px';
                warningElement.style.transform = 'translateX(-50%)';
                
                // 檢查四鳳的預知閃避能力
                if (isEnhanced) {
                    // 增強預警 - 更大、更明顯的閃電 - 使用優化後的顯示方式
                    warningElement.classList.add('w-10', 'h-12'); // 增加圖標尺寸
                    warningElement.innerHTML = `
                        <div class="relative">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 40, 40, 0.95)" class="animate-pulse drop-shadow-lg" style="filter: drop-shadow(0 0 5px rgba(255, 40, 40, 0.8));">
                                <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 text-xs text-red-500 font-bold bg-black bg-opacity-50 px-2 rounded-full whitespace-nowrap">危險區域!</div>
                            <div class="absolute inset-0 rounded-full animate-ping bg-red-500 opacity-30"></div>
                        </div>
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 pointer-events-none">
                            <!-- 優化顯示方式：更明顯的預警路徑 -->
                            <div class="h-96 w-2 bg-gradient-to-b from-red-500 to-transparent animate-pulse"></div>
                            
                            <!-- 優化顯示方式：更明顯的虛線指示 -->
                            <div class="h-96 w-1 absolute top-0 left-1/2 transform -translate-x-1/2" 
                                 style="background: repeating-linear-gradient(to bottom, rgba(255,50,50,1) 0px, rgba(255,50,50,1) 6px, transparent 6px, transparent 12px);"></div>
                                 
                            <!-- 優化顯示方式：顯示箭頭強調危險位置 -->
                            <div class="absolute bottom-12 left-1/2 transform -translate-x-1/2 opacity-90">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 40, 40, 1)" class="w-6 h-6 animate-bounce">
                                    <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z" transform="rotate(90 12 12)" />
                                </svg>
                            </div>
                            
                            <!-- 底部閃電標記 -->
                            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 opacity-80">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 40, 40, 1)" class="w-8 h-8">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                        </div>
                    `;
                    
                    // 播放雷聲作為預警
                    playThunderSound('button');
                    
                    // 更長的預警顯示時間
                    setTimeout(() => {
                        warningElement.style.opacity = '0';
                        warningElement.style.transition = 'opacity 0.6s';
                        setTimeout(() => {
                            if (warningElement.parentNode) {
                                warningElement.remove();
                            }
                        }, 600);
                    }, 1800); // 增加至1800毫秒（比之前長一倍）
                } else {
                    // 普通預警 - 更弱的視覺提示
                    warningElement.classList.add('w-5', 'h-5'); // 更小的圖標
                    warningElement.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 215, 0, 0.7)" class="animate-pulse">
                            <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    `;
                    
                    // 更短的預警顯示時間
                    setTimeout(() => {
                        warningElement.style.opacity = '0';
                        warningElement.style.transition = 'opacity 0.2s';
                        setTimeout(() => {
                            if (warningElement.parentNode) {
                                warningElement.remove();
                            }
                        }, 200);
                    }, 400); // 正常難度維持不變
                }
                
                gameContainer.appendChild(warningElement);
            }
            
            // 四鳳的預知閃避特殊能力 - 顯示所有即將生成的閃電預警
            function showAllFutureLightningWarnings() {
                if (!gameContainer) return;
                
                // 播放預知音效
                playThunderSound('button');
                
                // 首先清除所有现有的预警(包括普通预警)
                const existingWarnings = document.querySelectorAll('.lightning-warning');
                existingWarnings.forEach(warning => {
                    warning.remove();
                });
                
                // 建立閃電預測區域 - 將畫面分為幾個區域
                const sectionCount = 5; // 與閃電生成邏輯相同
                const sectionWidth = gameWidth / sectionCount;
                
                // 產生3-5個未來閃電位置預測
                const predictCount = Math.floor(3 + Math.random() * 3);
                const predictedPositions = [];
                
                // 預測未來可能的閃電位置
                for (let i = 0; i < predictCount; i++) {
                    // 選擇一個隨機區域
                    const section = Math.floor(Math.random() * sectionCount);
                    
                    // 確保不重複顯示在同一區域
                    if (predictedPositions.some(pos => Math.abs(pos.section - section) < 1)) {
                        continue;
                    }
                    
                    // 在該區域內設定一個位置，模擬閃電生成邏輯
                    const offset = (Math.random() * 0.6 + 0.2) * sectionWidth;
                    const lightningX = section * sectionWidth + offset;
                    
                    // 添加到預測位置列表
                    predictedPositions.push({
                        x: lightningX,
                        section: section,
                        delay: 100 + Math.random() * 200 // 隨機延遲顯示
                    });
                }
                
                // 創建視覺效果 - 模糊背景
                const enhancedVisionEffect = document.createElement('div');
                enhancedVisionEffect.className = 'absolute inset-0 z-5 pointer-events-none';
                enhancedVisionEffect.style.background = 'radial-gradient(circle, rgba(255,204,102,0) 0%, rgba(255,204,102,0.1) 100%)';
                enhancedVisionEffect.style.backdropFilter = 'contrast(1.05) saturate(1.1)';
                
                gameContainer.appendChild(enhancedVisionEffect);
                
                // 依次顯示預測的閃電位置
                predictedPositions.forEach((pos, index) => {
                    setTimeout(() => {
                        // 創建特殊的未來閃電預警 - 與一般預警不同，更有未來感
                        const futureWarning = document.createElement('div');
                        futureWarning.className = 'absolute z-9 lightning-warning future-warning'; // 添加类名以便识别和移除
                        futureWarning.style.left = `${pos.x}px`;
                        futureWarning.style.top = '10px';
                        futureWarning.style.transform = 'translateX(-50%)';
                        futureWarning.style.opacity = '0';
                        futureWarning.style.transition = 'opacity 0.5s';
                        
                        // 使用不同的顏色和效果，代表這是預見而非當前威脅
                        futureWarning.innerHTML = `
                            <div class="relative w-7 h-16">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 204, 102, 0.7)" class="w-7 h-7">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <div class="h-10 w-1 bg-gradient-to-b from-yellow-400 to-transparent absolute top-6 left-1/2 transform -translate-x-1/2"></div>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 text-xs text-yellow-400 whitespace-nowrap">預見閃電</div>
                            </div>
                        `;
                        
                        gameContainer.appendChild(futureWarning);
                        
                        // 淡入效果
                        setTimeout(() => {
                            futureWarning.style.opacity = '0.85';
                        }, 50);
                        
                        // 顯示一段時間後淡出
                        setTimeout(() => {
                            futureWarning.style.opacity = '0';
                            setTimeout(() => {
                                if (futureWarning.parentNode) {
                                    futureWarning.remove();
                                }
                            }, 500);
                        }, 3000 + index * 300); // 錯開每個預警的消失時間
                    }, pos.delay);
                });
                
                // 移除背景效果
                setTimeout(() => {
                    enhancedVisionEffect.style.opacity = '0';
                    enhancedVisionEffect.style.transition = 'opacity 0.8s';
                    setTimeout(() => {
                        if (enhancedVisionEffect.parentNode) {
                            enhancedVisionEffect.remove();
                        }
                    }, 800);
                }, 3500);
            }
            
            // 更新遊戲狀態 - 基於時間的更新
            function updateGame(deltaTime) {
                // 標準化時間差值，確保在不同刷新率下遊戲速度一致
                // 如果deltaTime未定義或為零（以防萬一），使用預設值
                const dt = deltaTime || (1/60); // 默認為60 FPS
                
                // 計分器
                frameCount++;
                if (frameCount % 3 === 0) {
                    score++;
                    scoreElement.textContent = score;
                }
                
                // 根據分數調整難度 - 加快難度增長速度
                level = Math.floor(score / 400) + 1;
                levelElement.textContent = level;
                
                // 更新角色能力狀態
                updateAbilityStatus();
                
                // 產生道具 - 使用基於時間的概率
                generateItem(dt);
                
                // 更新道具 - 基於時間移動
                updateItems(dt);
                
                // 獲取遊戲分數階段 - 移除保護期，立即開始高難度
                // 移除開始的保護時間，閃電從一開始就立即生成
                const initialPeriod = score < 120; // 縮短初始適應期
                const moderatePeriod = score < 400; // 降低中等難度期門檻
                
                // 閃電生成機率，大幅提高遊戲難度 - 並根據deltaTime進行調整
                // 這使得無論刷新率多少，生成概率都保持一致
                let baseLightningChance;
                if (initialPeriod) {
                    baseLightningChance = 0.008; // 大幅提高初始難度，遊戲一開始就具有挑戰性
                } else if (moderatePeriod) {
                    baseLightningChance = 0.012 + (level * 0.002); // 加快增長曲線，提高中期難度
                } else {
                    // 高級難度，提高上限和基礎值
                    baseLightningChance = Math.min(0.02 + (level * 0.003), 0.06); // 提高上限和增長速度
                }
                
                // 將每幀概率轉換為時間基礎概率
                // 公式: 1 - (1 - 每幀概率)^(deltaTime * 60)
                // 確保生成率與時間成正比，而不是與幀率成正比
                const lightningChance = 1 - Math.pow(1 - baseLightningChance, dt * 60);
                
                // 確保不會短時間內生成太多閃電
                let adjustedLightningChance = lightningChance;
                if (lightning.length > 3 + level) {
                    adjustedLightningChance *= 0.5; // 已存在較多閃電時減少生成機率
                }
                if (lightning.length > 5 + level) {
                    adjustedLightningChance *= 0.25; // 閃電數量過多時大幅降低生成機率
                }
                
                // 檢查舊雨衣效果（減少閃電生成）
                if (activeEffects.reduceLightningChance) {
                    adjustedLightningChance *= 0.5; // 減少一半閃電生成機率
                }
                
                if (Math.random() < adjustedLightningChance) {
                    // 畫面分為幾個區域，每個區域只生成一個閃電，確保有空隙可逃
                    const sectionCount = 5;
                    const sectionWidth = gameWidth / sectionCount;
                    
                    // 隨機選擇一個區域
                    const section = Math.floor(Math.random() * sectionCount);
                    
                    // 在選中的區域內隨機生成閃電位置，但避免位於區域的最中間位置
                    const offset = (Math.random() * 0.6 + 0.2) * sectionWidth;
                    const lightningX = section * sectionWidth + offset;
                    
                    // 檢查是否顯示閃電預警
                    let showWarning = false;
                    
                    if (characterAbility === '預知閃避') {
                        // 四鳳角色的預警邏輯：只在能力激活時才顯示增強預警，否則不顯示任何預警
                        if (abilityActive && activeEffects.enhancedWarning) {
                            showWarning = true;
                            showLightningWarning(lightningX, true); // 傳入true表示是四鳳的增強預警
                        }
                        // 沒有else部分，確保四鳳未激活能力時不顯示普通預警
                    } else {
                        // 其他角色的預警邏輯：根據級別和隨機概率顯示普通預警
                        if (level >= 2 && Math.random() < 0.55) {
                            showWarning = true;
                            showLightningWarning(lightningX, false);
                        }
                    }
                    
                    // 添加更多閃電變化
                    const width = 8 + Math.random() * (5 + level);
                    const height = 20 + Math.random() * (15 + level * 5);
                    
                    // 設置基礎速度常數 - 這將確保在所有裝置上相同的下落速度
                    // 單位: 像素/秒 - 增加基礎速度和隨機加成
                    const BASE_LIGHTNING_SPEED = 150 + (level * 20) + (Math.random() * 90);
                    let speed = BASE_LIGHTNING_SPEED;
                    
                    // 檢查周樸園的威權力場減速效果
                    if (characterAbility === '威權力場' && activeEffects.slowLightningFall) {
                        speed *= 0.6; // 減慢40%閃電速度
                    }
                    
                    // 檢查道具減速效果
                    if (activeEffects.slowLightning) {
                        speed *= 0.7; // 減慢30%閃電速度
                    }
                    
                    lightning.push({
                        x: lightningX,
                        y: 0,
                        width: width,
                        height: height,
                        speed: speed, // 速度現在為像素/秒
                        active: true,
                        // 添加閃電變化屬性
                        color: Math.random() < 0.2 ? 'blue' : 'yellow', // 偶爾出現藍色閃電
                        branches: Math.floor(Math.random() * 3) + 1, // 分支數量
                        intensity: 0.7 + Math.random() * 0.3, // 閃電強度變化
                        warning: showWarning // 記錄這個閃電是否已顯示過預警
                    });
                }
                
                // 更新閃電位置 - 基於時間移動
                for (let i = 0; i < lightning.length; i++) {
                    if (lightning[i].active) {
                        // 距離 = 速度 × 時間差值 (dt)
                        lightning[i].y += lightning[i].speed * dt;
                        
                        // 檢查是否擊中角色
                        if (characterElement) {
                            const characterLeft = characterX - (characterWidth / 2);
                            const characterRight = characterX + (characterWidth / 2);
                            const characterTop = gameHeight - characterHeight;
                            
                            if (lightning[i].y + lightning[i].height >= characterTop && 
                                lightning[i].y <= gameHeight &&
                                lightning[i].x + lightning[i].width >= characterLeft && 
                                lightning[i].x <= characterRight) {
                                
                                // 檢查是否有無敵狀態
                                if (invincible) {
                                    // 無敵狀態下不受傷害
                                    lightning[i].active = false;
                                    continue;
                                }
                                
                                // 檢查魯侍萍的隱忍堅韌能力
                                if (characterAbility === '隱忍堅韌' && activeEffects.oneTimeImmunity) {
                                    // 消耗一次性免疫
                                    activeEffects.oneTimeImmunity = false;
                                    abilityActive = false;
                                    abilityCooldown = true;
                                    abilityCooldownTime = getAbilityCooldown();
                                    
                                    // 顯示免疫效果
                                    const immunityEffect = document.createElement('div');
                                    immunityEffect.classList.add('absolute', 'inset-0', 'flex', 'items-center', 'justify-center', 'text-white', 'text-xl', 'font-bold', 'z-30');
                                    immunityEffect.innerHTML = '<div class="bg-purple-700 bg-opacity-60 px-4 py-2 rounded">隱忍堅韌 - 免疫!</div>';
                                    gameContainer.appendChild(immunityEffect);
                                    
                                    // 移除閃電和效果
                                    lightning[i].active = false;
                                    setTimeout(() => {
                                        if (immunityEffect.parentNode) {
                                            immunityEffect.remove();
                                        }
                                    }, 1500);
                                    
                                    // 播放特殊音效
                                    playThunderSound('button');
                                    continue;
                                }
                                
                                // 如果沒有免疫，結束遊戲
                                gameOver();
                                return;
                            }
                        }
                        
                        // 移除超出畫面的閃電
                        if (lightning[i].y > gameHeight) {
                            lightning[i].active = false;
                        }
                    }
                }
                
                // 清理不活躍的閃電
                lightning = lightning.filter(l => l.active);
                
                // 更新角色台詞氣泡位置
                updateQuoteBubblePosition();
            }
            
            // 繪製遊戲
            function drawGame() {
                // 清空畫布
                ctx.clearRect(0, 0, gameWidth, gameHeight);
                
                // 繪製陰天背景
                const isDarkMode = document.documentElement.classList.contains('dark');
                const gradient = ctx.createLinearGradient(0, 0, 0, gameHeight);
                
                if (isDarkMode) {
                    gradient.addColorStop(0, '#0a1120'); // 更暗的藍黑色
                    gradient.addColorStop(0.6, '#1a2234'); // 中間區域的深色
                    gradient.addColorStop(1, '#252d3f'); // 底部的過渡色
                } else {
                    gradient.addColorStop(0, '#4b5d78'); // 陰天的灰藍色上層
                    gradient.addColorStop(0.6, '#667788'); // 中間的灰色
                    gradient.addColorStop(1, '#7f8a99'); // 底部較淺的灰色
                }
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, gameWidth, gameHeight);
                
                // 添加動態煙霧效果
                const time = Date.now() / 5000;
                
                // 繪製多層次的雲和煙霧
                function drawClouds(y, size, speed, count, opacity) {
                    const cloudColor = isDarkMode 
                        ? `rgba(25, 33, 46, ${opacity})`
                        : `rgba(80, 92, 110, ${opacity})`;
                    
                    for (let i = 0; i < count; i++) {
                        const offsetX = Math.sin(time * 0.5 + i) * 10; // 添加輕微搖動
                        const cloudX = ((time * speed) * gameWidth + i * (gameWidth / count)) % (gameWidth + 100) - 50 + offsetX;
                        const cloudY = y + Math.sin(time + i * 2) * 10; // 上下輕微浮動
                        
                        ctx.fillStyle = cloudColor;
                        ctx.beginPath();
                        
                        // 畫一組連續的雲朵形狀
                        const cloudWidth = size * (0.8 + Math.sin(i * 0.4) * 0.2); // 變化的雲大小
                        for (let j = 0; j < 5; j++) {
                            const circleX = cloudX + j * (cloudWidth/6);
                            const circleY = cloudY + (j % 2 === 0 ? -5 : 5);
                            const radius = cloudWidth * (0.3 + (j % 3) * 0.1);
                            
                            ctx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                        }
                        
                        ctx.fill();
                    }
                }
                
                // 繪製三層雲層，製造深度感
                drawClouds(30, 55, 0.1, 4, 0.9);  // 最上層大雲
                drawClouds(120, 35, 0.15, 6, 0.7); // 中層雲
                drawClouds(70, 25, 0.2, 5, 0.5);  // 後層小雲
                
                // 繪製雨滴效果
                const rainIntensity = 0.5 + Math.sin(time) * 0.2; // 雨量隨時間變化 - 增加基礎雨量
                const rainCount = Math.floor(rainIntensity * 150); // 雨滴數量 - 增加雨滴密度
                
                const rainColor = isDarkMode 
                    ? 'rgba(130, 160, 210, 0.7)' // 增強不透明度
                    : 'rgba(180, 200, 230, 0.7)';
                
                ctx.strokeStyle = rainColor;
                ctx.lineWidth = 1;
                
                for (let i = 0; i < rainCount; i++) {
                    const rainX = Math.random() * gameWidth;
                    const rainY = (Math.random() * gameHeight * 0.7) + (time * 100 + i * 50) % gameHeight;
                    const rainLength = 10 + Math.random() * 20; // 增加雨滴長度
                    
                    ctx.beginPath();
                    ctx.moveTo(rainX, rainY);
                    ctx.lineTo(rainX - 3, rainY + rainLength); // 增加雨滴傾斜度
                    ctx.stroke();
                }
                
                // 繪製道具
                drawItems();
                
                // 繪製閃電
                for (const bolt of lightning) {
                    // 在畫面上產生閃爍效果
                    if (Math.random() < 0.1) { // 增加閃爍頻率
                        gameContainer.classList.add('screen-flash');
                        setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
                        
                        // 播放閃電音效 - 隨機判斷是否播放
                        if (Math.random() < 0.3) {
                            playThunderSound('random');
                        }
                    }
                    
                    // 閃電的顏色
                    const lightningGradient = ctx.createLinearGradient(
                        bolt.x, bolt.y, 
                        bolt.x + bolt.width, bolt.y + bolt.height
                    );
                    lightningGradient.addColorStop(0, 'rgba(255, 255, 150, 0.9)');
                    lightningGradient.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
                    lightningGradient.addColorStop(1, 'rgba(255, 255, 100, 0.9)');
                    
                    // 繪製更複雜的閃電形狀
                    ctx.beginPath();
                    let currentX = bolt.x;
                    let currentY = bolt.y;
                    const segments = Math.floor(bolt.height / 8); // 更多的分段
                    const segmentHeight = bolt.height / segments;
                    
                    ctx.moveTo(currentX, currentY);
                    
                    // 主閃電路徑
                    for (let i = 0; i < segments; i++) {
                        const direction = i % 2 === 0 ? 1 : -1;
                        const offsetX = direction * (bolt.width * 0.8 + Math.random() * bolt.width * 0.6);
                        
                        currentY += segmentHeight;
                        currentX += offsetX;
                        
                        ctx.lineTo(currentX, currentY);
                        
                        // 隨機添加分支閃電
                        if (Math.random() < 0.3 && i > 0) {
                            const branchLength = segmentHeight * (0.5 + Math.random() * 0.8);
                            const branchX = currentX + direction * bolt.width * (1 + Math.random());
                            const branchY = currentY + branchLength;
                            
                            ctx.moveTo(currentX, currentY);
                            ctx.lineTo(branchX, branchY);
                            ctx.moveTo(currentX, currentY); // 回到主幹
                        }
                    }
                    
                    // 閃電效果
                    canvas.classList.add('lightning-flash');
                    setTimeout(() => canvas.classList.remove('lightning-flash'), 100);
                    
                    // 繪製閃電發光效果
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.lineWidth = 2 + Math.random() * 2;
                    ctx.stroke();
                    
                    // 添加外發光效果
                    ctx.shadowColor = 'rgba(255, 255, 100, 0.8)';
                    ctx.shadowBlur = 20; // 增強光暈效果
                    ctx.lineWidth = 1.5;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.stroke();
                    
                    // 再次描繪閃電核心
                    ctx.shadowBlur = 0;
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 1)';
                    ctx.stroke();
                    
                    // 重置陰影效果
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                }
                
                // 繪製地面和積水效果
                const groundColor = isDarkMode ? '#273449' : '#444e60';
                ctx.fillStyle = groundColor;
                ctx.fillRect(0, gameHeight - 30, gameWidth, 30);
                
                // 繪製積水效果和水坑反射
                ctx.fillStyle = isDarkMode ? 'rgba(30, 50, 70, 0.5)' : 'rgba(50, 70, 90, 0.4)';
                for (let i = 0; i < 12; i++) { // 增加水坑數量
                    const puddleWidth = 30 + Math.random() * 50;
                    const puddleX = (i * (gameWidth / 12) + Math.sin(time + i) * 30) % gameWidth;
                    const puddleHeight = 4 + Math.random() * 3;
                    
                    // 水坑
                    ctx.beginPath();
                    ctx.ellipse(
                        puddleX, 
                        gameHeight - 30 + 2, 
                        puddleWidth / 2, 
                        puddleHeight, 
                        0, 0, Math.PI * 2
                    );
                    ctx.fill();
                    
                    // 偶爾在水坑上添加閃電的反射
                    if (lightning.length > 0 && Math.random() < 0.2) { // 增加反射機率
                        ctx.fillStyle = 'rgba(255, 255, 200, 0.15)'; // 增強反射亮度
                        ctx.beginPath();
                        ctx.ellipse(
                            puddleX, 
                            gameHeight - 30 + 2, 
                            puddleWidth / 3, 
                            puddleHeight / 2, 
                            0, 0, Math.PI * 2
                        );
                        ctx.fill();
                        ctx.fillStyle = isDarkMode ? 'rgba(30, 50, 70, 0.5)' : 'rgba(50, 70, 90, 0.4)';
                    }
                }
            }
            
            // 遊戲循環 - 基於時間的更新
            let lastTime = 0;
            function gameLoop(timestamp) {
                if (!isGameRunning) return;
                
                if (!lastTime) lastTime = timestamp;
                
                // 計算時間差值，轉換為秒
                const deltaTime = (timestamp - lastTime) / 1000;
                lastTime = timestamp;
                
                // 傳入時間差值進行更新
                updateGame(deltaTime);
                drawGame();
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            
            // 《雷雨》劇情階段
            const storyPhases = [
                { 
                    threshold: 0, 
                    name: "第一幕", 
                    description: "《雷雨》開始時，故事發生在周樸園家中，一場雷雨即將來臨，暗示著將要發生的劇變。" 
                },
                { 
                    threshold: 500, 
                    name: "第二幕", 
                    description: "雷雨中，繁漪、周萍和周沖表現出對周樸園專制的不滿，家庭矛盾逐漸顯現。" 
                },
                { 
                    threshold: 1000, 
                    name: "第三幕", 
                    description: "魯侍萍與周家人相認，過去的秘密開始揭露，原來的家庭關係交織成一張悲劇之網。" 
                },
                { 
                    threshold: 1500, 
                    name: "第四幕", 
                    description: "雷雨達到高潮，親子與戀人關係被揭露，周樸園家庭走向崩潰與毀滅。" 
                }
            ];
            
            // 獲取角色相關的台詞和分析（根據劇情階段）
            function getCharacterContent(characterName, storyPhase = null) {
                // 確定當前劇情階段
                const phaseIndex = storyPhase !== null ? storyPhase : Math.min(3, Math.floor(score / 500));
                const phaseName = storyPhases[phaseIndex].name;
                
                // 獲取對應幕數的台詞
                if (characterQuotes[characterName]) {
                    // 找出該角色在當前劇情階段的所有台詞
                    const actQuotes = characterQuotes[characterName].filter(
                        q => q.act.includes(phaseName.charAt(0)) // 比較第幾幕，例如"一幕"、"二幕"等
                    );
                    
                    // 如果找到合適幕數的台詞，就從中隨機選一個
                    if (actQuotes.length > 0) {
                        const randomQuote = actQuotes[Math.floor(Math.random() * actQuotes.length)];
                        return {
                            quote: randomQuote.text,
                            analysis: randomQuote.note || "《雷雨》中的經典台詞",
                            act: randomQuote.act
                        };
                    }
                    
                    // 如果找不到，就從該角色的所有台詞中隨機選一個
                    const randomQuote = characterQuotes[characterName][Math.floor(Math.random() * characterQuotes[characterName].length)];
                    return {
                        quote: randomQuote.text,
                        analysis: randomQuote.note || "《雷雨》中的經典台詞",
                        act: randomQuote.act
                    };
                }
                
                // 默認內容（理論上不會到達）
                return {
                    quote: "命運的記號，早已經刻在我的額上。",
                    analysis: "《雷雨》中的雷電象徵著命運的力量，無法逃避的宿命。",
                    act: phaseName
                };
            }
            
            // 打字機效果函數
            function typewriterEffect(element, text, speed, onComplete = null) {
                let i = 0;
                element.textContent = '';
                element.classList.add('typewriter-cursor');
                
                // 確保一開始就清除文本中的引號
                text = text.replace(/^"/, '').replace(/"$/, '');
                
                // 打字過程中閃爍效果
                const flashEffect = () => {
                    gameContainer.classList.add('screen-flash');
                    setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
                };
                
                function typeChar() {
                    if (i < text.length) {
                        // 每4-5個字符閃爍一下屏幕
                        if (i > 0 && i % 5 === 0) {
                            flashEffect();
                            // 偶爾在打字過程中播放輕微雷聲
                            if (Math.random() < 0.3) {
                                playThunderSound('button');
                            }
                        }
                        
                        element.textContent += text.charAt(i);
                        i++;
                        setTimeout(typeChar, speed);
                    } else {
                        element.classList.remove('typewriter-cursor');
                        // 打字結束後添加特殊效果
                        element.classList.add('animate-quote-text');
                        
                        // 直接使用當前文本添加中文引用符號
                        element.innerHTML = `<span class="text-yellow-300">『</span> ${element.textContent} <span class="text-yellow-300">』</span>`;
                        
                        // 最後的閃爍效果
                        flashEffect();
                        
                        // 播放完成音效
                        playThunderSound('button');
                        
                        if (onComplete) onComplete();
                    }
                }
                
                typeChar();
            }
            
            // 獲取隨機台詞
            function getRandomQuote(characterName) {
                if (!characterQuotes[characterName] || characterQuotes[characterName].length === 0) {
                    return { text: "命運的記號，早已經刻在我的額上。", act: "一幕", note: "默認台詞" };
                }
                
                const quotes = characterQuotes[characterName];
                return quotes[Math.floor(Math.random() * quotes.length)];
            }
            
            // 遊戲結束
            function gameOver() {
                isGameRunning = false;
                
                // 停止雨滴效果
                clearInterval(rainInterval);
                
                // 淡出背景音樂
                fadeOutMusic();
                
                if (score > highScore) {
                    highScore = score;
                }
                
                // 確定劇情階段
                const phaseIndex = Math.min(3, Math.floor(score / 500));
                const currentPhase = storyPhases[phaseIndex];
                
                // 獲取角色隨機台詞
                const randomQuote = getRandomQuote(character);
                
                // 顯示角色相關台詞和劇情階段（暫時隱藏，等待打字機效果完成後顯示）
                document.getElementById('character-quote').textContent = "";
                document.getElementById('quote-character').textContent = character; // 顯示台詞所屬角色
                document.getElementById('character-analysis').textContent = randomQuote.note || "《雷雨》中的經典台詞";
                document.getElementById('act-indicator').textContent = randomQuote.act;
                document.getElementById('plot-summary').textContent = currentPhase.description;
                
                finalScoreElement.textContent = score;
                highScoreElement.textContent = highScore;
                
                // 隱藏角色能力指示器
                const abilityIndicator = document.getElementById('ability-indicator');
                if (abilityIndicator) {
                    abilityIndicator.classList.add('hidden');
                }
                
                // 清除所有閃電預警
                const existingWarnings = document.querySelectorAll('.lightning-warning');
                existingWarnings.forEach(warning => {
                    warning.remove();
                });
                
                // 播放超大雷聲
                playThunderSound('death');
                
                // 閃電擊中效果 - 加強抖動
                gameContainer.classList.add('screen-flash', 'strong-shake');
                
                // 創建閃電擊中動畫
                const strikeEffect = document.createElement('div');
                strikeEffect.classList.add('absolute', 'inset-0', 'z-20');
                strikeEffect.style.background = 'radial-gradient(circle at center, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 70%)';
                strikeEffect.style.animation = 'screenFlash 0.6s ease-out';
                
                gameContainer.appendChild(strikeEffect);
                
                // 移除角色台詞氣泡
                if (currentQuoteBubble && currentQuoteBubble.parentNode) {
                    currentQuoteBubble.remove();
                    currentQuoteBubble = null;
                }
                
                // 清理周沖的粒子效果
                cleanupSprintEffects();
                
                // 移除所有能力視覺效果
                const specialEffects = document.querySelectorAll('#pressure-field, #character-shield, #sprint-effect, #resilience-aura, #timeslow-overlay');
                specialEffects.forEach(effect => {
                    if (effect && effect.parentNode) {
                        effect.remove();
                    }
                });
                
                // 移除速度線容器
                const speedLinesContainer = document.getElementById('speed-lines-container');
                if (speedLinesContainer && speedLinesContainer.parentNode) {
                    speedLinesContainer.remove();
                }
                
                // 隱藏狀態欄
                statusBar.classList.add('hidden');
                
                // 延遲顯示遊戲結束界面以展示特效
                setTimeout(() => {
                    gameContainer.classList.remove('screen-flash', 'strong-shake');
                    if (strikeEffect.parentNode) {
                        strikeEffect.remove();
                    }
                    gameOverScreen.classList.remove('hidden');
                    if (characterElement) {
                        characterElement.classList.add('hidden');
                    }
                    
                    // 隱藏得分信息和重新開始按鈕，直到打字機效果完成
                    const scoreInfo = document.querySelector('#game-over .text-center.mb-4');
                    if (scoreInfo) {
                        scoreInfo.style.display = 'none';
                    }
                    
                    if (restartBtn) {
                        restartBtn.style.display = 'none';
                    }
                    
                    // 應用打字機效果 - 速度設為100毫秒每字符，提供足夠閱讀時間
                    const quoteElement = document.getElementById('character-quote');
                    if (quoteElement) {
                        console.log("Applying typewriter effect with quote:", randomQuote.text);
                        
                        // 先确保文本是空的
                        quoteElement.textContent = "";
                        
                        // 使用打字机效果显示引用（去掉英文引号）
                        typewriterEffect(quoteElement, randomQuote.text, 100, function() {
                            console.log("Typewriter effect completed");
                            // 打字機效果完成後，顯示得分信息
                            setTimeout(() => {
                                if (scoreInfo) {
                                    scoreInfo.style.display = 'block';
                                    scoreInfo.classList.add('animate-fade-in');
                                }
                                
                                // 再等一會兒顯示重新開始按鈕
                                setTimeout(() => {
                                    if (restartBtn) {
                                        restartBtn.style.display = 'inline-block';
                                        restartBtn.classList.add('animate-bounce');
                                        
                                        // 播放雷聲
                                        playThunderSound('button');
                                    }
                                }, 1000);
                            }, 1000);
                        });
                    } else {
                        console.error("Quote element not found!");
                        // 如果找不到引用元素，仍然显示分数和按钮
                        if (scoreInfo) {
                            scoreInfo.style.display = 'block';
                        }
                        if (restartBtn) {
                            restartBtn.style.display = 'inline-block';
                        }
                    }
                }, 800);
            }
            
            // 鍵盤控制
            document.addEventListener('keydown', function(e) {
                if (!isGameRunning || !characterElement) return;
                
                // 基礎移動速度 - 降低以避免移動過快
                let speed = 15;
                
                // 根據角色能力調整速度 - 更適中的加速
                if (characterAbility === '青春衝刺') {
                    speed *= 1.2; // 周沖移動略快
                }
                
                // 青春衝刺能力激活時的速度提升
                if (activeEffects.youthSprint) {
                    speed *= 3.0; // 青春衝刺效果 - 大幅提升速度
                }
                
                // 特殊能力效果調整速度 - 降低加速幅度
                if (activeEffects.speedUp) {
                    speed *= 1.3; // 適度加速
                }
                
                if (activeEffects.dashBoost) {
                    speed *= 1.5; // 適度衝刺
                }
                
                // 情感庇護的加速效果 - 降低加速幅度
                if (characterAbility === '情感庇護' && activeEffects.emotionalSpeed) {
                    speed *= 1.8; // 情感庇護時較快，但不至於太快
                }
                
                if (e.key === 'ArrowLeft' || e.key === 'a') {
                    characterX = Math.max(characterWidth / 2, characterX - speed);
                    characterElement.style.left = `${characterX}px`;
                    updateQuoteBubblePosition();
                    
                    // 繁漪能力的殘影效果
                    if (activeEffects.createAfterimagePath && Math.random() < 0.4) {
                        createAfterimage(characterX + speed, '#E91E63');
                    }
                } else if (e.key === 'ArrowRight' || e.key === 'd') {
                    characterX = Math.min(gameWidth - characterWidth / 2, characterX + speed);
                    characterElement.style.left = `${characterX}px`;
                    updateQuoteBubblePosition();
                    
                    // 繁漪能力的殘影效果
                    if (activeEffects.createAfterimagePath && Math.random() < 0.4) {
                        createAfterimage(characterX - speed, '#E91E63');
                    }
                } else if (e.key === ' ' || e.key === 'Spacebar') {
                    // 空格鍵激活角色能力 - 所有角色都可使用
                    if (!abilityCooldown) {
                        activateAbility();
                    }
                }
                

            });
            
            // 統一觸控事件處理
            let touchStartTime = 0;
            let lastTapTime = 0;
            let touchStartX = 0;
            
            // 觸控開始事件
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!isGameRunning || !characterElement) return;
                
                const currentTime = Date.now();
                touchStartTime = currentTime;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                touchStartX = touch.clientX - rect.left;
                
                // 檢查雙擊 (適用於情感庇護)
                if (currentTime - lastTapTime < 300) {
                    if (characterAbility === '情感庇護' && !abilityCooldown) {
                        activateAbility();
                        return; // 激活能力後不執行移動
                    }
                }
                
                lastTapTime = currentTime;
            });
            
            // 觸控移動事件
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (!isGameRunning || !characterElement) return;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                
                handleMovement(touchX);
            });
            
            // 觸控結束事件
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!isGameRunning || !characterElement) return;
                
                const touchDuration = Date.now() - touchStartTime;
                
                // 長按激活能力 (威權力場和隱忍堅韌)
                if (touchDuration > 500) {
                    if (characterAbility === '威權力場' && !abilityCooldown) {
                        activateAbility();
                    } else if (characterAbility === '隱忍堅韌' && !abilityCooldown && !activeEffects.oneTimeImmunity) {
                        activateAbility();
                    }
                } else if (touchDuration < 200) {
                    // 短點擊進行移動
                    handleMovement(touchStartX);
                }
            });
            
            // 統一移動處理函數
            function handleMovement(targetX) {
                let speed = 15;
                
                // 特殊能力效果調整速度
                if (activeEffects.speedUp) {
                    speed *= 1.5;
                }
                
                if (activeEffects.dashBoost) {
                    speed *= 2;
                }
                
                // 情感庇護的加速效果
                if (characterAbility === '情感庇護' && activeEffects.emotionalSpeed) {
                    speed *= 2.5;
                }
                
                if (targetX < characterX - 10) {
                    // 向左移動
                    characterX = Math.max(characterWidth / 2, characterX - speed);
                } else if (targetX > characterX + 10) {
                    // 向右移動
                    characterX = Math.min(gameWidth - characterWidth / 2, characterX + speed);
                }
                
                characterElement.style.left = `${characterX}px`;
                updateQuoteBubblePosition();
            }
            
            // 統一鼠標點擊控制
            let lastClickTime = 0;
            canvas.addEventListener('click', function(e) {
                if (!isGameRunning || !characterElement) return;
                
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const currentTime = Date.now();
                
                // 檢查雙擊
                if (currentTime - lastClickTime < 300) {
                    if (characterAbility === '情感庇護' && !abilityCooldown) {
                        activateAbility();
                        return; // 激活能力後不執行移動
                    } else if (characterAbility === '威權力場' && !abilityCooldown) {
                        activateAbility();
                        return;
                    } else if (characterAbility === '隱忍堅韌' && !abilityCooldown && !activeEffects.oneTimeImmunity) {
                        activateAbility();
                        return;
                    }
                }
                
                // 單擊移動
                let moveAmount = 40;
                
                // 特殊能力效果調整速度
                if (activeEffects.speedUp || activeEffects.dashBoost || activeEffects.emotionalSpeed) {
                    moveAmount *= 1.5;
                }
                
                if (clickX < characterX - 10) {
                    characterX = Math.max(characterWidth / 2, characterX - moveAmount);
                } else if (clickX > characterX + 10) {
                    characterX = Math.min(gameWidth - characterWidth / 2, characterX + moveAmount);
                }
                
                characterElement.style.left = `${characterX}px`;
                updateQuoteBubblePosition();
                
                lastClickTime = currentTime;
            });
            
            // 為所有按鈕添加雷聲音效
            addThunderSoundToButtons();
            
            // 為道具標籤設置切換功能
            const positiveItemsTab = document.getElementById('positive-items-tab');
            const negativeItemsTab = document.getElementById('negative-items-tab');
            const positiveItems = document.getElementById('positive-items');
            const negativeItems = document.getElementById('negative-items');
            
            if (positiveItemsTab && negativeItemsTab && positiveItems && negativeItems) {
                positiveItemsTab.addEventListener('click', () => {
                    positiveItems.classList.remove('hidden');
                    negativeItems.classList.add('hidden');
                    positiveItemsTab.classList.add('bg-green-700');
                    positiveItemsTab.classList.remove('bg-opacity-40');
                    positiveItemsTab.classList.add('bg-opacity-70');
                    negativeItemsTab.classList.remove('bg-red-700');
                    negativeItemsTab.classList.add('bg-opacity-40');
                    negativeItemsTab.classList.remove('bg-opacity-70');
                });
                
                negativeItemsTab.addEventListener('click', () => {
                    positiveItems.classList.add('hidden');
                    negativeItems.classList.remove('hidden');
                    positiveItemsTab.classList.remove('bg-green-700');
                    positiveItemsTab.classList.add('bg-opacity-40');
                    positiveItemsTab.classList.remove('bg-opacity-70');
                    negativeItemsTab.classList.add('bg-red-700');
                    negativeItemsTab.classList.remove('bg-opacity-40');
                    negativeItemsTab.classList.add('bg-opacity-70');
                });
            }
            
            // 直接在全局定義道具信息，確保在使用前已定義
            window.gameItemDetails = {
                'umbrella': {
                    name: '雨傘',
                    description: '獲得30分，象徵尋求短暫避難，在《雷雨》中是希望的象徵',
                    quote: '「這場大雨，沒有一把傘能遮得住。」——繁漪',
                    symbolism: '暫時逃避命運，但無法避免最終的悲劇',
                    color: '#4CAF50',
                    icon: '☂️',
                    isPositive: true,
                    pointValue: 30
                },
                'cricket': {
                    name: '蟋蟀',
                    description: '獲得20分，象徵年輕的反抗精神和生命力',
                    quote: '「我看見蟋蟀兒...它說：年輕人，造反吧！」——周沖',
                    symbolism: '周沖的反抗精神和對自由的嚮往',
                    color: '#4CAF50',
                    icon: '🦗',
                    isPositive: true,
                    pointValue: 20
                },
                'window': {
                    name: '窗戶',
                    description: '獲得25分，象徵對自由的渴望和對外界的嚮往',
                    quote: '「我希望我今天變成火山的口，熱熱烈烈地冒一次！」——繁漪',
                    symbolism: '對外界自由的渴望，繁漪常常開窗透氣',
                    color: '#4CAF50',
                    icon: '🪟',
                    isPositive: true,
                    pointValue: 25
                },
                'medicine': {
                    name: '藥',
                    description: '減少15分，象徵周樸園用來控制繁漪的工具',
                    quote: '「繁漪，應當替孩子做個服從的榜樣。」——周樸園',
                    symbolism: '周樸園的控制手段，強制繁漪服藥',
                    color: '#F44336',
                    icon: '💊',
                    isPositive: false,
                    pointValue: -15
                },
                'oldHouse': {
                    name: '老房子',
                    description: '減少20分，象徵禁錮人性的封建家庭',
                    quote: '「周家的空氣滿是罪惡，這些年我看見了他們所做的壞事！」——繁漪',
                    symbolism: '周家封建家庭的囚籠，表面光鮮內裡陰暗',
                    color: '#F44336',
                    icon: '🏚️',
                    isPositive: false,
                    pointValue: -20
                },
                'oldSofa': {
                    name: '老沙發',
                    description: '減少25分，象徵表面舒適實則窒息的生活',
                    quote: '「這老房子永遠是這樣悶氣，人們也是鬼裏鬼氣的！」——繁漪',
                    symbolism: '表面舒適的生活，實則是精神禁錮',
                    color: '#F44336',
                    icon: '🛋️',
                    isPositive: false,
                    pointValue: -25
                },
                'fan': {
                    name: '摺扇',
                    description: '獲得40分，象徵繁漪對生活的熱情與渴望',
                    quote: '「我要呼吸，我要光明，我要生活，我要自由！」——繁漪',
                    symbolism: '繁漪對自由的渴望和對禁錮的反抗',
                    color: '#4CAF50',
                    icon: '🪭',
                    isPositive: true,
                    pointValue: 40
                },
                'tigerShoes': {
                    name: '虎頭鞋',
                    description: '獲得35分，象徵母愛的堅韌力量',
                    quote: '「我這些年的苦不是你那錢就算得清的！」——魯侍萍',
                    symbolism: '侍萍母子被遺棄的見證物，母愛的象徵',
                    color: '#4CAF50',
                    icon: '👟',
                    isPositive: true,
                    pointValue: 35
                },
                'photo': {
                    name: '照片',
                    description: '獲得50分，象徵真相被揭露帶來的解脫',
                    quote: '「有些秘密，即使掩蓋三十年，還是會被雷雨沖刷出來。」',
                    symbolism: '家庭秘密的揭露，塵封多年的真相',
                    color: '#4CAF50',
                    icon: '🖼️',
                    isPositive: true,
                    pointValue: 50
                },
                'clock': {
                    name: '時鐘',
                    description: '減少30分，象徵命運的不可逆轉和時間的壓迫',
                    quote: '「時鐘的滴答聲加劇緊迫感，預示悲劇的不可逆轉。」',
                    symbolism: '時間的壓迫與命運的不可逆轉',
                    color: '#F44336',
                    icon: '⏰',
                    isPositive: false,
                    pointValue: -30
                },
                'ghost': {
                    name: '鬼魂',
                    description: '減少40分，象徵家庭被過去罪惡纏繞的恐懼',
                    quote: '「我現在心裏很亂，你不知道這屋子鬧鬼麼？」——周萍',
                    symbolism: '周家被過去罪惡纏繞，內心的恐懼',
                    color: '#F44336',
                    icon: '👻',
                    isPositive: false,
                    pointValue: -40
                },
                'check': {
                    name: '支票',
                    description: '減少45分，象徵周樸園試圖用金錢掩蓋罪惡的虛偽',
                    quote: '「他做盡了壞事弄錢，他自然可以行善！」——繁漪',
                    symbolism: '周樸園試圖用金錢掩蓋過去的罪惡',
                    color: '#F44336',
                    icon: '💸',
                    isPositive: false,
                    pointValue: -45
                }
            };
            
            // 初始化道具顯示功能 - 只保留懸浮氣泡，移除內置顯示區域
            function setupItemDetailsDisplay() {
                // 獲取所有道具圖標元素
                const itemIcons = document.querySelectorAll('.item-icon[data-show-info="true"]');
                
                // 建立懸浮氣泡元素（初始為隱藏）
                const tooltipElement = document.createElement('div');
                tooltipElement.className = 'hidden absolute z-50 w-52 bg-gradient-to-br from-gray-900 to-indigo-950 text-white p-2.5 rounded-lg shadow-xl border border-blue-500 border-opacity-30 pointer-events-none';
                tooltipElement.id = 'item-tooltip';
                
                // 添加箭頭元素
                const arrowElement = document.createElement('div');
                arrowElement.className = 'tooltip-arrow absolute';
                tooltipElement.appendChild(arrowElement);
                
                // 添加到文檔
                document.body.appendChild(tooltipElement);
                
                // 為每個道具圖標添加鼠標事件
                itemIcons.forEach(icon => {
                    const itemId = icon.getAttribute('data-id');
                    
                    // 檢查道具ID是否存在
                    if (!itemId || !window.gameItemDetails[itemId]) {
                        console.warn(`道具ID不存在或數據缺失: ${itemId}`);
                        return;
                    }
                    
                    // 鼠標進入顯示道具詳情
                    icon.addEventListener('mouseenter', (event) => {
                        showItemTooltip(event, itemId); // 顯示懸浮氣泡
                    });
                    
                    // 鼠標移出隱藏氣泡
                    icon.addEventListener('mouseleave', () => {
                        tooltipElement.classList.add('hidden');
                    });
                });
                
                // 顯示懸浮氣泡 - 類似角色能力的氣泡，帶有邊界檢測
                function showItemTooltip(event, itemId) {
                    const item = window.gameItemDetails[itemId];
                    if (!item) return;
                    
                    // 設置氣泡內容
                    tooltipElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-bold ${item.isPositive ? 'text-green-400' : 'text-red-400'}">${item.name}</div>
                            <div class="text-[10px] px-1.5 py-0.5 ${item.isPositive ? 'bg-green-600' : 'bg-red-600'} bg-opacity-70 rounded-md text-white">
                                ${item.isPositive ? '+' : ''}${item.pointValue}
                            </div>
                        </div>
                        <div class="text-[10px] mt-1.5 text-gray-200">${item.description}</div>
                        <div class="text-[9px] mt-1 italic text-blue-300">${item.quote}</div>
                        <div class="text-[9px] mt-1.5 text-gray-400">意象：${item.symbolism}</div>
                        <div class="tooltip-arrow absolute"></div>
                    `;
                    
                    // 獲取箭頭元素
                    const arrowElement = tooltipElement.querySelector('.tooltip-arrow');
                    
                    // 顯示氣泡
                    tooltipElement.classList.remove('hidden');
                    
                    // 獲取遊戲容器和按鈕位置
                    const gameContainer = document.querySelector('.game-container');
                    if (!gameContainer) {
                        console.log('找不到遊戲容器');
                        return;
                    }
                    
                    const containerRect = gameContainer.getBoundingClientRect();
                    const buttonRect = event.currentTarget.getBoundingClientRect();
                    
                    // 設置氣泡尺寸和安全邊距
                    const tooltipWidth = 208; // w-52 = 13rem = 208px
                    const tooltipHeight = 130; // 氣泡高度
                    const SAFE_MARGIN = 12; // 安全邊距
                    
                    // 計算按鈕在容器中的相對位置
                    const buttonLeft = buttonRect.left - containerRect.left;
                    const buttonTop = buttonRect.top - containerRect.top;
                    const buttonRight = buttonLeft + buttonRect.width;
                    const buttonBottom = buttonTop + buttonRect.height;
                    const buttonCenterX = buttonLeft + buttonRect.width/2;
                    const buttonCenterY = buttonTop + buttonRect.height/2;
                    
                    // 獲取容器尺寸
                    const gameWidth = containerRect.width;
                    const gameHeight = containerRect.height;
                    
                    // 默認在按鈕上方顯示
                    let tooltipLeft = buttonCenterX - tooltipWidth/2;
                    let tooltipTop = buttonTop - tooltipHeight - SAFE_MARGIN;
                    let position = 'top'; // 預設在上方
                    
                    // 檢查是否會超出上邊界
                    if (tooltipTop < SAFE_MARGIN) {
                        // 如果上方空間不足，嘗試顯示在按鈕下方
                        tooltipTop = buttonBottom + SAFE_MARGIN;
                        position = 'bottom';
                        
                        // 檢查是否會超出下邊界
                        if (tooltipTop + tooltipHeight > gameHeight - SAFE_MARGIN) {
                            // 如果下方也不夠，嘗試放在左側或右側
                            if (buttonCenterX > gameWidth / 2) {
                                // 按鈕在右半部，嘗試放在左側
                                tooltipLeft = buttonLeft - tooltipWidth - SAFE_MARGIN;
                                tooltipTop = buttonCenterY - tooltipHeight/2;
                                position = 'left';
                                
                                // 檢查左側空間
                                if (tooltipLeft < SAFE_MARGIN) {
                                    // 如果左側空間不足，放在合適的位置
                                    tooltipLeft = SAFE_MARGIN;
                                    tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                }
                            } else {
                                // 按鈕在左半部，嘗試放在右側
                                tooltipLeft = buttonRight + SAFE_MARGIN;
                                tooltipTop = buttonCenterY - tooltipHeight/2;
                                position = 'right';
                                
                                // 檢查右側空間
                                if (tooltipLeft + tooltipWidth > gameWidth - SAFE_MARGIN) {
                                    // 如果右側空間不足，放在合適的位置
                                    tooltipLeft = gameWidth - tooltipWidth - SAFE_MARGIN;
                                    tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                }
                            }
                        }
                    }
                    
                    // 確保不超出左右邊界
                    tooltipLeft = Math.max(SAFE_MARGIN, Math.min(gameWidth - tooltipWidth - SAFE_MARGIN, tooltipLeft));
                    
                    // 確保不超出上下邊界
                    tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, tooltipTop));
                    
                    // 根據位置設置箭頭
                    switch (position) {
                        case 'top':
                            // 顯示在按鈕上方，箭頭在底部
                            arrowElement.className = 'absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // 調整箭頭水平位置
                            const arrowHOffset = (buttonCenterX - (tooltipLeft + tooltipWidth/2));
                            if (Math.abs(arrowHOffset) < tooltipWidth/2 - 15) {
                                arrowElement.style.left = `calc(50% + ${arrowHOffset}px)`;
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                            
                        case 'bottom':
                            // 顯示在按鈕下方，箭頭在頂部
                            arrowElement.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-l border-t border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // 調整箭頭水平位置
                            const arrowHOffsetBottom = (buttonCenterX - (tooltipLeft + tooltipWidth/2));
                            if (Math.abs(arrowHOffsetBottom) < tooltipWidth/2 - 15) {
                                arrowElement.style.left = `calc(50% + ${arrowHOffsetBottom}px)`;
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                            
                        case 'left':
                            // 顯示在按鈕左側，箭頭在右側
                            arrowElement.className = 'absolute right-0 top-1/2 transform translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-t border-r border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // 調整箭頭垂直位置
                            const arrowVOffsetLeft = (buttonCenterY - (tooltipTop + tooltipHeight/2));
                            if (Math.abs(arrowVOffsetLeft) < tooltipHeight/2 - 15) {
                                arrowElement.style.top = `calc(50% + ${arrowVOffsetLeft}px)`;
                                arrowElement.style.left = 'auto';
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                            
                        case 'right':
                            // 顯示在按鈕右側，箭頭在左側
                            arrowElement.className = 'absolute left-0 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-b border-l border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // 調整箭頭垂直位置
                            const arrowVOffsetRight = (buttonCenterY - (tooltipTop + tooltipHeight/2));
                            if (Math.abs(arrowVOffsetRight) < tooltipHeight/2 - 15) {
                                arrowElement.style.top = `calc(50% + ${arrowVOffsetRight}px)`;
                                arrowElement.style.left = 'auto';
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                    }
                    
                    // 設置氣泡位置
                    tooltipElement.style.left = `${tooltipLeft + containerRect.left}px`;
                    tooltipElement.style.top = `${tooltipTop + containerRect.top}px`;
                }
            }
            
            // 在DOM加載完成後初始化
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupItemDetailsDisplay);
            } else {
                setupItemDetailsDisplay();
            }
            
            // 確保即使有延遲也能初始化
            setTimeout(setupItemDetailsDisplay, 500);
            
            // 無論在DOMContentLoaded前還是後
            // 都要確保道具點擊事件已設置
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupItemClickEvents);
            } else {
                setupItemClickEvents();
            }
            
            // 定義setupItemClickEvents函數
            function setupItemClickEvents() {
                // 獲取所有道具圖標和彈出式視窗元素
                const itemIcons = document.querySelectorAll('.item-icon[data-show-info="true"]');
                const itemDetailPopup = document.getElementById('item-detail-popup');
                const popupIcon = document.getElementById('popup-icon');
                const popupTitle = document.getElementById('popup-title');
                const popupDesc = document.getElementById('popup-desc');
                const popupQuote = document.getElementById('popup-quote');
                const popupSymbolism = document.getElementById('popup-symbolism');
                const closePopupBtn = document.getElementById('close-popup');
                
                // 檢查必要元素是否存在
                if (!itemDetailPopup || !popupIcon || !popupTitle || !popupDesc || !popupQuote || !popupSymbolism || !closePopupBtn) {
                    console.warn('彈出視窗元素缺失，無法初始化道具點擊事件');
                    return;
                }
                
                // 為每個道具圖標添加點擊事件
                itemIcons.forEach(icon => {
                    icon.addEventListener('click', function() {
                        const itemId = this.getAttribute('data-id');
                        
                        // 檢查道具ID是否存在
                        if (!itemId || !window.gameItemDetails[itemId]) {
                            console.warn(`道具ID不存在或數據缺失: ${itemId}`);
                            return;
                        }
                        
                        const item = window.gameItemDetails[itemId];
                        
                        // 填充彈出視窗內容
                        popupIcon.innerHTML = `<span class="text-lg">${item.icon}</span>`;
                        popupIcon.style.backgroundColor = item.isPositive ? '#4CAF50' : '#F44336';
                        popupTitle.textContent = `${item.name} (${item.isPositive ? '+' : ''}${item.pointValue})`;
                        popupDesc.textContent = item.description;
                        popupQuote.textContent = item.quote;
                        popupSymbolism.textContent = `意象：${item.symbolism}`;
                        
                        // 顯示彈出視窗
                        itemDetailPopup.classList.remove('hidden');
                    });
                });
                
                // 添加關閉按鈕事件
                closePopupBtn.addEventListener('click', function() {
                    itemDetailPopup.classList.add('hidden');
                });
                
                // 點擊彈出視窗背景也關閉彈出視窗
                itemDetailPopup.addEventListener('click', function(e) {
                    if (e.target === itemDetailPopup) {
                        itemDetailPopup.classList.add('hidden');
                    }
                });
                
                console.log('道具點擊事件初始化完成');
            }
            
            // 同時設置一個定時器，確保道具點擊事件被設置
            setTimeout(setupItemClickEvents, 500);
            
            // 把初始化方法放在全局，以便後續調用
            window.initItemPopups = setupItemClickEvents;
            
            // 輔助函數：調整顏色亮度
            function adjustColor(color, percent) {
                var R = parseInt(color.substring(1,3),16);
                var G = parseInt(color.substring(3,5),16);
                var B = parseInt(color.substring(5,7),16);
            
                R = parseInt(R * (100 + percent) / 100);
                G = parseInt(G * (100 + percent) / 100);
                B = parseInt(B * (100 + percent) / 100);
            
                R = (R<255)?R:255;  
                G = (G<255)?G:255;  
                B = (B<255)?B:255;  
            
                R = Math.max(0, R);
                G = Math.max(0, G);
                B = Math.max(0, B);
            
                var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
                var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
                var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
            
                return "#"+RR+GG+BB;
            }
            });
            
            // 獲取物品的象徵意義
            function getItemSymbolism(itemId) {
                const symbolism = {
                    'umbrella': '暫時逃避命運，但無法避免最終的悲劇',
                    'cricket': '周沖的反抗精神和對自由的嚮往',
                    'clock': '時間的壓迫與命運的不可逆轉',
                    'photo': '家庭秘密的揭露，塵封多年的真相',
                    'diary': '魯侍萍記錄的悲慘歷史和記憶',
                    'fan': '繁漪對自由的渴望和對禁錮的反抗',
                    'oldRaincoat': '侍萍面對厄運時的遮擋與保護',
                    'oldHouse': '周家封建家庭的囚籠，表面光鮮內裡陰暗',
                    'oldSofa': '表面舒適的生活，實則是精神禁錮',
                    'medicine': '周樸園的控制手段，強制繁漪服藥',
                    'tigerShoes': '侍萍母子被遺棄的見證物，命運的痕跡',
                    'window': '對外界自由的渴望，繁漪常常開窗透氣',
                    'check': '周樸園試圖用金錢掩蓋過去的罪惡',
                    'ghost': '周家被過去罪惡纏繞，內心的恐懼'
                };
                
                return symbolism[itemId] || '《雷雨》中的關鍵意象';
            }
            
            // 在遊戲加載完成時初始化項目點擊
            document.addEventListener('DOMContentLoaded', function() {
                // 所有初始化都在前面的代碼中完成
                console.log("Game initialized successfully!");
                
                // 確保道具點擊功能被初始化
                if (typeof initItemPopups === 'function') {
                    initItemPopups();
                }
            });
    </script>
</body>
</html>
