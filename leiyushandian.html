<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·é›¨ - èº²é¿é–ƒé›»éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes flash {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        @keyframes screenFlash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }
        
        /* å…¨å±€è‰²å½©è®Šé‡ - æ”¹ç”¨åŠ‡ä½œã€Šé›·é›¨ã€‹æ„è±¡é…è‰²æ–¹æ¡ˆ */
        :root {
            /* ä¸»è‰²èª¿ */
            --thunder-deep: #0A1620; /* é›·æš´æ·±ç©º */
            --wood-brown: #2B1E1A; /* æœ½æœ¨æš—æ£• */
            --iron-gray: #3A3A3A; /* éµé½ç° */
            
            /* è¼”åŠ©è‰²èª¿ */
            --lightning-white: #E0EBF5; /* é–ƒé›»å†·ç™½ */
            --rain-blue: #1D2B3F; /* é™°é›¨å¢¨è— */
            --moss-green: #394D3B; /* è‹”è˜šç¶  */
            
            /* é»ç¶´è‰² */
            --electric-yellow: #FFE74C; /* ç¡«ç£ºé›»å…‰ */
            --blood-rust: #6B2A2A; /* è¡€é½ç´… */
            --deep-desire: #2A3D5C; /* æš—æ½®é›é’ */
            
            /* ä¿ç•™çš„äº¤äº’è‰² */
            --thunder-blue: #1D2B3F; /* æ›¿æ›ç‚ºé™°é›¨å¢¨è— */
            --thunder-blue-light: #2A3D5C; /* æ›¿æ›ç‚ºæš—æ½®é›é’ */
            --thunder-blue-dark: #0A1620; /* æ›¿æ›ç‚ºé›·æš´æ·±ç©º */
            --thunder-blue-bright: #E0EBF5; /* æ›¿æ›ç‚ºé–ƒé›»å†·ç™½ */
            --thunder-blue-accent: #2A3D5C; /* æ›¿æ›ç‚ºæš—æ½®é›é’ */
            --thunder-blue-deep: #0A1620; /* æ›¿æ›ç‚ºé›·æš´æ·±ç©º */
            --storm-gray: #3A3A3A; /* æ›¿æ›ç‚ºéµé½ç° */
            --storm-gray-light: #4A5055; /* ç¨å¾®æ·ºä¸€äº›çš„éµé½ç° */
            --storm-gray-dark: #2B1E1A; /* æ›¿æ›ç‚ºæœ½æœ¨æš—æ£• */
            --lightning-blue: #E0EBF5; /* æ›¿æ›ç‚ºé–ƒé›»å†·ç™½ */
            --accent-color: #2A3D5C; /* æ›¿æ›ç‚ºæš—æ½®é›é’ */
            --neon-blue: #E0EBF5; /* æ›¿æ›ç‚ºé–ƒé›»å†·ç™½ */
            --neon-blue-glow: #FFE74C; /* æ›¿æ›ç‚ºç¡«ç£ºé›»å…‰ */
        }
        
        /* éœ“è™¹ç‡ˆæ•ˆæœ - ä½¿ç”¨è—ç™½è‰²é›»æµé…è‰² */
        @keyframes neonPulse {
            0%, 100% { text-shadow: 0 0 5px rgba(160, 220, 255, 0.4), 0 0 10px rgba(120, 190, 255, 0.3); }
            50% { text-shadow: 0 0 10px rgba(160, 220, 255, 0.9), 0 0 20px rgba(120, 190, 255, 0.7), 0 0 30px rgba(255, 255, 255, 0.5), 0 0 40px rgba(70, 150, 255, 0.6); }
        }
        
        .neon-text {
            color: #a0e8ff;
            animation: neonPulse 2s infinite;
            letter-spacing: 1px;
        }
        
        /* UIä¸»é¡Œé©é… */
        .bg-primary {
            background-color: var(--deep-desire) !important;
        }
        .text-primary {
            color: var(--electric-yellow) !important;
        }
        .border-primary {
            border-color: var(--electric-yellow) !important;
        }
        
        /* èª¿æ•´ä¸»è¦æŒ‰éˆ•æ¨£å¼ */
        .character-btn, #restart-btn {
            background-color: var(--deep-desire) !important;
            background-image: linear-gradient(to bottom right, var(--deep-desire), var(--thunder-deep)) !important;
            border: 1px solid var(--rain-blue) !important;
            box-shadow: 0 2px 10px rgba(10, 22, 32, 0.5) !important;
        }
        
        /* è‡ªå®šç¾©å…¶ä»–è‰²å½©è¦†è“‹ */
        .bg-blue-900 {
            background-color: var(--thunder-deep) !important;
        }
        .border-blue-500 {
            border-color: var(--electric-yellow) !important;
        }
        .text-blue-300 {
            color: var(--lightning-white) !important;
        }
        .bg-yellow-700, .text-yellow-200 {
            color: var(--electric-yellow) !important;
        }
        .text-yellow-300 {
            color: var(--electric-yellow) !important;
        }
        
        /* æš—è‰²æ¨¡å¼èª¿æ•´ */
        .dark .bg-gray-800 {
            background-color: var(--thunder-deep) !important;
        }
        .dark .bg-gray-900 {
            background-color: var(--wood-brown) !important;
        }
        .dark .border-blue-500 {
            border-color: var(--deep-desire) !important;
        }
        .dark .text-blue-300 {
            color: var(--lightning-white) !important;
        }
        @keyframes strongShake {
            0%, 100% { transform: translateX(0); }
            10%, 50%, 90% { transform: translateX(-10px); }
            30%, 70% { transform: translateX(10px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes blinkCursor {
            0%, 100% { border-right-color: transparent; }
            50% { border-right-color: white; }
        }
        @keyframes rainDrop {
            0% { transform: translateY(-100%); opacity: 0.7; }
            100% { transform: translateY(100vh); opacity: 0.4; }
        }
        /* ç¶“å…¸å°è©å‹•ç•« - æ”¹ç‚ºè—ç™½è‰²é›»æµæ•ˆæœ */
        @keyframes quoteGlow {
            0%, 100% { text-shadow: 0 0 5px rgba(120, 190, 255, 0.5); }
            50% { text-shadow: 0 0 15px rgba(160, 220, 255, 0.8), 0 0 20px rgba(120, 190, 255, 0.6), 0 0 30px rgba(255, 255, 255, 0.6); }
        }
        @keyframes quoteBoxGlow {
            0%, 100% { box-shadow: inset 0 0 8px rgba(70, 140, 255, 0.3); }
            50% { box-shadow: inset 0 0 15px rgba(100, 170, 255, 0.5), 0 0 10px rgba(200, 225, 255, 0.4), 0 0 30px rgba(60, 120, 200, 0.3); }
        }
        @keyframes lightningGlow {
            0%, 100% { text-shadow: 0 0 5px rgba(160, 220, 255, 0.7), 0 0 10px rgba(255, 255, 255, 0.3); }
            50% { text-shadow: 0 0 10px rgba(100, 170, 255, 0.9), 0 0 20px rgba(160, 220, 255, 0.8), 0 0 30px rgba(255, 255, 255, 0.6), 0 0 40px rgba(70, 150, 255, 0.6); }
        }
        .lightning-glow {
            animation: lightningGlow 2s infinite ease-in-out;
        }
        @keyframes quotePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .quote-highlight {
            animation: quoteBoxGlow 2s infinite ease-in-out;
        }
        .animate-quote-text {
            animation: quoteGlow 2s infinite ease-in-out;
        }
        .shadow-text {
            text-shadow: 0 0 10px rgba(255, 231, 76, 0.7), 0 0 20px rgba(107, 42, 42, 0.4);
        }
        .pulse-quote {
            animation: quotePulse 2s infinite ease-in-out;
        }
        .lightning-flash {
            animation: flash 0.3s ease-in-out;
        }
        .screen-flash {
            animation: screenFlash 0.5s ease-in-out;
        }
        .strong-shake {
            animation: strongShake 0.8s ease-in-out;
        }
        .animate-fade-in {
            animation: fadeIn 1s ease-out;
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        .dark .game-canvas {
            filter: brightness(0.9) contrast(1.1);
        }
        .character {
            transition: left 0.1s ease-out;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
            background-color: var(--thunder-deep);
        }
        
        /* ç¸±å‘éŠæˆ²å¸ƒå±€ - æ¥µé™å„ªåŒ–ä»¥å®Œå…¨é¿å…æ»¾å‹• */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden !important;
            touch-action: manipulation;
            background-color: var(--thunder-deep);
            overscroll-behavior: none;
            position: fixed;
            inset: 0;
            width: 100%;
        }
        
        /* æ·»åŠ ä¸‹é›¨å‹•ç•« */
        @keyframes rainfall {
            0% { opacity: 0.7; transform: translateY(-5px); }
            100% { opacity: 0.5; transform: translateY(600px); }
        }
        
        .rain-drop {
            position: absolute;
            width: 1.5px;
            height: 15px;
            background: linear-gradient(to bottom, rgba(200,220,255,0.9), rgba(180,200,255,0.7));
            transform: rotate(10deg);
            animation: rainfall 1s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        .big-rain-drop {
            width: 2px;
            height: 20px;
            opacity: 0.8;
        }
        
        #rain-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
            position: absolute;
            inset: 0;
        }
        
        footer {
            flex-shrink: 0;
            padding: 1px 0;
            height: auto;
            font-size: 0.65rem;
            line-height: 1;
        }
        
        .game-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 0;
            min-height: 0;
            width: 100%;
        }
        
        .game-container {
            position: relative;
            width: min(98%, 410px);
            height: min(98%, calc(98vh - 20px));
            aspect-ratio: 9/16;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* æ¥µå°å±å¹•å„ªåŒ– */
        @media (max-height: 500px) {
            .game-container {
                height: min(99%, calc(99vh - 12px));
                border-radius: 0.25rem;
            }
            
            footer {
                padding: 0;
                font-size: 0.6rem;
            }
            
            /* æ¥µå°çš„å…ƒç´ é–“è· */
            #start-screen, #game-over {
                padding: 1px !important;
            }
            
            /* ç§»é™¤é–‹å§‹å±å¹•å’ŒçµæŸå±å¹•çš„å…ƒç´ é–“è· */
            #start-screen .max-w-md, #game-over .max-w-md {
                margin-bottom: 1px !important;
                padding: 1px !important;
            }
            
            #start-screen .mb-4, #game-over .mb-4,
            #start-screen .mb-3, #game-over .mb-3,
            #start-screen .mb-2, #game-over .mb-2 {
                margin-bottom: 1px !important;
            }
            
            #start-screen .px-4, #game-over .px-4 {
                padding-left: 2px !important;
                padding-right: 2px !important;
            }
            
            #start-screen .py-3, #game-over .py-3,
            #start-screen .py-2, #game-over .py-2,
            #start-screen .py-1, #game-over .py-1 {
                padding-top: 1px !important;
                padding-bottom: 1px !important;
            }
        }
        
        /* æ©«å±æ¨¡å¼å„ªåŒ– */
        @media (orientation: landscape) and (max-height: 450px) {
            .game-container {
                height: 99vh;
                width: calc(99vh * 9/16);
                max-width: min(65vw, 410px);
                border-radius: 0.25rem;
            }
            
            /* æ¸›å°è§’è‰²é¸æ“‡ç¶²æ ¼é–“è· */
            #start-screen .gap-2 {
                gap: 0.25rem !important;
            }
            
            /* æ¸›å°è§’è‰²æŒ‰éˆ•å…§éƒ¨é–“è· */
            .character-btn {
                padding: 0.25rem !important;
            }
        }
        
        /* ç‹€æ…‹æç¤ºæ¬„ */
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            z-index: 20;
        }
        
        .quote-bubble {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            max-width: 80%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .typewriter-cursor {
            border-right: 2px solid white;
            animation: blinkCursor 0.7s infinite;
        }
        
        .rain-drop {
            position: absolute;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(200,220,255,0.5));
            width: 1px;
            height: 15px;
            animation: rainDrop linear;
            pointer-events: none;
        }
        
        .button-highlight:active {
            transform: scale(0.98);
            box-shadow: 0 0 10px 3px rgba(255, 255, 100, 0.4);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-800 dark:text-gray-200 transition-colors">
    <div id="app-container" class="pt-0.5 pb-0.5">
        <!-- ç§»é™¤é¡¶éƒ¨æ ‡é¢˜ -->

        <div class="game-wrapper">
            <div class="bg-gray-100 dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden game-container">
                <!-- éŠæˆ²ç•Œé¢ -->
                <div id="game-container" class="w-full h-full relative">
                    <canvas id="game-canvas" class="game-canvas absolute top-0 left-0 w-full h-full"></canvas>
                    
                    <!-- èƒŒæ™¯éŸ³æ¨‚ -->
                    <audio id="background-music" loop preload="auto">
                        <source src="https://chineseclassics.github.io/sound/leiyu/leiyu.mp3" type="audio/mpeg">
                        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾ã€‚
                    </audio>
                    
                    <!-- éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• -->
                    <button id="music-toggle" class="absolute top-4 left-4 z-50 w-12 h-12 bg-gradient-to-br from-gray-900 to-gray-800 text-white rounded-full border border-blue-500 border-opacity-30 shadow-lg flex items-center justify-center hover:from-gray-800 hover:to-gray-700 transition-all duration-300">
                        <svg id="music-on-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0 11.249 11.249 0 010 15.788.75.75 0 11-1.06-1.06 9.749 9.749 0 000-13.668.75.75 0 010-1.06z" />
                            <path d="M16.024 9.106a.75.75 0 01.976.04 4.5 4.5 0 010 6.708.75.75 0 11-1.051-1.071 3 3 0 000-4.566.75.75 0 01.075-1.111z" />
                        </svg>
                        <svg id="music-off-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden">
                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                        </svg>
                    </button>
                    
                    <div id="character" class="character absolute bottom-6 h-16 w-16 transform -translate-x-1/2 hidden">
                        <img id="character-img" src="" alt="è§’è‰²" class="w-full h-full">
                    </div>
                    
                    <!-- èƒŒæ™¯é›¨æ»´å®¹å™¨ -->
                    <div id="rain-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
                    
                    <!-- ç‹€æ…‹æ¬„ -->
                    <div id="status-bar" class="status-bar hidden">
                        <div>
                            <span class="font-medium">åˆ†æ•¸: </span>
                            <span id="score" class="font-bold text-primary">0</span>
                        </div>
                        <div>
                            <span class="font-medium">é›£åº¦: </span>
                            <span id="level" class="font-bold text-primary">1</span>
                        </div>
                    </div>
                    
                    <!-- é›¨æ»´èƒŒæ™¯æ•ˆæœ -->
                    <div id="rain-effect"></div>
                
                    <!-- é–‹å§‹ç•Œé¢ - å®Œå…¨é‡æ–°è¨­è¨ˆï¼Œä½¿ç”¨Flexboxç²¾ç¢ºæ§åˆ¶ä½ˆå±€ -->
                    <div id="start-screen" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-60 text-white overflow-hidden">
                        <!-- ä½¿ç”¨å›ºå®šé«˜åº¦å®¹å™¨å’ŒFlexboxé€²è¡Œç²¾ç¢ºå…§å®¹åˆ†é… -->
                        <div class="relative h-full w-full max-w-xl flex flex-col justify-between py-2">
                            <!-- é ‚éƒ¨æ¨™é¡Œå€ - ç‚«é…·è¨­è¨ˆï¼Œæ·»åŠ  mt-10 å‘ä¸‹ç§»å‹•æ›´å¤š -->
                            <div class="mt-10 mb-3 relative">
                                <!-- é–ƒé›»èƒŒæ™¯æ•ˆæœ -->
                                <div class="absolute inset-0 overflow-hidden">
                                    <div class="absolute top-0 left-1/4 w-8 h-20 opacity-20">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div class="absolute top-5 right-1/4 w-6 h-14 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- é–ƒé›»é‚Šæ¡†æ•ˆæœ -->
                                <div class="px-3 py-3 bg-gradient-to-br from-blue-900 to-indigo-900 rounded-lg border border-blue-400 border-opacity-40 mx-auto max-w-md shadow-lg relative overflow-hidden">
                                    <!-- è„ˆè¡å…‰æšˆæ•ˆæœ -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-500 opacity-20 animate-pulse"></div>
                                    
                                    <!-- é–ƒé›»è£é£¾ -->
                                    <div class="absolute -left-2 top-1/2 transform -translate-y-1/2 rotate-45 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700" class="w-14 h-14">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div class="absolute -right-2 top-1/2 transform -translate-y-1/2 -rotate-45 opacity-30">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#FFD700" class="w-14 h-14">
                                            <path d="M13 3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    
                                    <!-- æ¨™é¡Œæ–‡æœ¬ -->
                                    <h1 class="text-2xl font-bold text-center neon-text tracking-wide lightning-glow animate-pulse-quote relative z-10">èº²é¿ã€Šé›·é›¨ã€‹é–ƒé›»ï¼</h1>
                                    <p class="text-sm text-center text-blue-100 mt-2 relative z-10">ã€Šé›·é›¨ã€‹æ˜¯æ›¹ç¦ºçš„ç¶“å…¸æ‚²åŠ‡ï¼Œè¬›è¿°å‘¨å®¶ä¸‰åå¹´é–“çš„å®¶åº­æ‚²åŠ‡ã€‚ä½ å°‡æ‰®æ¼”åŠ‡ä¸­è§’è‰²èº²é¿å‘½é‹çš„é–ƒé›»ï¼</p>
                                </div>
                            </div>
                            
                            <!-- ä¸­é–“å…§å®¹å€ - å„ªåŒ–å‚ç›´æ’ç‰ˆ -->
                            <div class="flex flex-col space-y-3">
                                <!-- è§’è‰²é¸æ“‡å€ - å¡ç‰‡è¨­è¨ˆ -->
                                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-lg border border-blue-500 border-opacity-30 overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-800 to-indigo-900 px-3 py-1.5">
                                        <h2 class="text-sm font-bold tracking-wide text-center relative neon-text inline-flex items-center justify-center w-full">
                                            <span class="absolute left-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                                                </svg>
                                            </span>
                                            é¸æ“‡ã€Šé›·é›¨ã€‹è§’è‰²
                                            <span class="absolute right-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                                                </svg>
                                            </span>
                                        </h2>
                                    </div>
                                    
                                    <!-- è§’è‰²é¸æ“‡ - æ¡ç”¨3åˆ—ä½ˆå±€ï¼Œæ”¹é€²è¦–è¦ºè¨­è¨ˆ -->
                                    <div class="grid grid-cols-3 gap-1.5 w-full p-2">
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="å‘¨æ¨¸åœ’" data-quote="æˆ‘çš„å®¶åº­æ˜¯æˆ‘èªç‚ºæœ€åœ“æ»¿ã€æœ€æœ‰ç§©åºçš„å®¶åº­ã€‚" data-act="ä¸€å¹•" data-ability="å¨æ¬ŠåŠ›å ´" data-activation="ç©ºæ ¼éµ/é•·æŒ‰" data-cooldown="30ç§’å†·å»">
                                            <span class="font-bold text-blue-50">å‘¨æ¨¸åœ’</span>
                                            <span class="text-[10px] text-blue-200">å¯Œå•†</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-yellow-700 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                å¨æ¬ŠåŠ›å ´
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="å‘¨è" data-quote="æˆ‘æ¨é€™ç¨®ä¸è‡ªç„¶çš„é—œä¿‚ï¼" data-act="äºŒå¹•" data-ability="å„ªæŸ”ç¬ç§»" data-activation="ç©ºæ ¼éµ/é•·æŒ‰" data-cooldown="20ç§’å†·å»">
                                            <span class="font-bold text-blue-50">å‘¨è</span>
                                            <span class="text-[10px] text-blue-200">é•·å­</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-blue-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                å„ªæŸ”ç¬ç§»
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="å‘¨æ²–" data-quote="çˆ¸çˆ¸ï¼Œé€™æ˜¯ä¸å…¬å¹³çš„ï¼" data-act="ä¸€å¹•" data-ability="é’æ˜¥è¡åˆº" data-activation="ç©ºæ ¼éµ/é•·æŒ‰" data-cooldown="15ç§’å†·å»">
                                            <span class="font-bold text-blue-50">å‘¨æ²–</span>
                                            <span class="text-[10px] text-blue-200">æ¬¡å­</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-green-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                é’æ˜¥è¡åˆº
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="é­¯ä¾è" data-quote="å‘½ï¼Œä¸å…¬å¹³çš„å‘½æŒ‡ä½¿æˆ‘ä¾†çš„ï¼" data-act="äºŒå¹•" data-ability="éš±å¿å …éŸŒ" data-activation="ç©ºæ ¼éµ/é•·æŒ‰" data-cooldown="60ç§’å†·å»">
                                            <span class="font-bold text-blue-50">é­¯ä¾è</span>
                                            <span class="text-[10px] text-blue-200">å‰å¦»</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-purple-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                éš±å¿å …éŸŒ
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="ç¹æ¼ª" data-quote="ç†±æ¥µäº†ï¼Œæ‚¶æ¥µäº†ï¼Œé€™è£¡çœŸæ˜¯å†ä¹Ÿä¸èƒ½ä½çš„ã€‚" data-act="ä¸€å¹•" data-ability="æƒ…æ„Ÿåº‡è­·" data-activation="ç©ºæ ¼éµ/é•·æŒ‰" data-cooldown="25ç§’å†·å»">
                                            <span class="font-bold text-blue-50">ç¹æ¼ª</span>
                                            <span class="text-[10px] text-blue-200">ç¾å¦»</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-red-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                æƒ…æ„Ÿåº‡è­·
                                            </div>
                                        </button>
                                        <button class="character-btn sound-btn button-highlight flex flex-col items-center bg-gradient-to-br from-indigo-800 to-indigo-900 hover:from-indigo-700 hover:to-indigo-800 rounded p-1.5 transition-all text-xs shadow-md transform hover:scale-105" data-character="å››é³³" data-quote="è®“å¤©ä¸Šçš„é›·åŠˆäº†æˆ‘å§ï¼" data-act="å››å¹•" data-ability="é çŸ¥é–ƒé¿" data-activation="ç©ºæ ¼éµ/é•·æŒ‰" data-cooldown="40ç§’å†·å»">
                                            <span class="font-bold text-blue-50">å››é³³</span>
                                            <span class="text-[10px] text-blue-200">å¥³åƒ•</span>
                                            <div class="mt-1 px-1.5 py-0.5 bg-amber-500 bg-opacity-70 rounded-full text-[10px] text-white whitespace-nowrap shadow-sm">
                                                é çŸ¥é–ƒé¿
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- æ§åˆ¶èªªæ˜æ”¾åœ¨è§’è‰²å€åŸŸä¸‹æ–¹ - æ”¹é€²æ’ç‰ˆè¨­è¨ˆ -->
                                    <div class="px-3 py-2 bg-gradient-to-r from-gray-900 to-gray-800 border-t border-blue-900 border-opacity-40">
                                        <div class="text-[10px] text-blue-200 grid grid-cols-2 gap-1">
                                            <div class="flex flex-col items-center">
                                                <span class="font-medium text-blue-300 mb-1 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 mr-1 text-yellow-300">
                                                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
                                                    </svg>
                                                    é›»è…¦
                                                </span>
                                                <div class="text-left w-full">
                                                    <div>â€¢ æ–¹å‘éµ/A/Déµç§»å‹•</div>
                                                    <div>â€¢ ç©ºæ ¼éµæ¿€æ´»èƒ½åŠ›</div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <span class="font-medium text-blue-300 mb-1 flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3 mr-1 text-yellow-300">
                                                        <path fill-rule="evenodd" d="M3.5 2A1.5 1.5 0 005 3.5V4h10v-.5A1.5 1.5 0 0016.5 2h-13zM6 8V6h8v2H6zM5 9.5A1.5 1.5 0 006.5 11h7a1.5 1.5 0 001.5-1.5V9H5v.5zm2 4.5h6v2H7v-2z" clip-rule="evenodd" />
                                                    </svg>
                                                    æ‰‹æ©Ÿ
                                                </span>
                                                <div class="text-left w-full">
                                                    <div>â€¢ é»æ“Šå·¦å³ç§»å‹•</div>
                                                    <div>â€¢ é•·æŒ‰/é›™æ“Šæ¿€æ´»èƒ½åŠ›</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- è§’è‰²èƒ½åŠ›æ‡¸åœæ°£æ³¡ - å‡ç´šç‰ˆè¨­è¨ˆï¼Œç¢ºä¿å…¶åœ¨éŠæˆ²æ¡†æ¶å…§å®Œæ•´é¡¯ç¤º -->
                                    <div class="hidden absolute z-10 w-52 bg-gradient-to-br from-gray-900 to-indigo-950 text-white p-2.5 rounded-lg shadow-xl border border-blue-500 border-opacity-30 pointer-events-none" id="ability-tooltip">
                                        <div class="flex justify-between items-center">
                                            <div class="text-sm font-bold text-primary ability-name"></div>
                                            <div class="text-[8px] px-1.5 py-0.5 bg-blue-600 bg-opacity-70 rounded-md ability-activation"></div>
                                        </div>
                                        <div class="text-[10px] mt-1.5 text-gray-200 ability-desc"></div>
                                        <div class="text-[9px] mt-1 italic text-blue-300 ability-note"></div>
                                        <div class="mt-1.5 flex justify-between items-center text-[9px]">
                                            <div class="text-yellow-300 ability-cooldown"></div>
                                            <div class="text-white px-1.5 py-0.5 bg-primary bg-opacity-50 rounded-sm ability-usage"></div>
                                        </div>
                                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30"></div>
                                    </div>
                                </div>
                                
                                <!-- é“å…·å€ - å¡ç‰‡è¨­è¨ˆ -->
                                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-lg border border-blue-500 border-opacity-30 overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-800 to-indigo-900 px-3 py-1.5">
                                        <h3 class="text-sm font-bold tracking-wide text-center relative neon-text inline-flex items-center justify-center w-full">
                                            <span class="absolute left-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V9.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15.211 6.276a1 1 0 000-1.788l-4.764-2.382a1 1 0 00-.894 0L4.789 4.488a1 1 0 000 1.788l4.764 2.382a1 1 0 00.894 0l4.764-2.382zM4.447 8.342A1 1 0 003 9.236V15a1 1 0 00.553.894l4 2A1 1 0 009 17v-5.764a1 1 0 00-.553-.894l-4-2z" />
                                                </svg>
                                            </span>
                                            ã€Šé›·é›¨ã€‹æ„è±¡é“å…·
                                            <span class="absolute right-0 opacity-40">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                                    <path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V9.236a1 1 0 00-1.447-.894l-4 2a1 1 0 00-.553.894V17zM15.211 6.276a1 1 0 000-1.788l-4.764-2.382a1 1 0 00-.894 0L4.789 4.488a1 1 0 000 1.788l4.764 2.382a1 1 0 00.894 0l4.764-2.382zM4.447 8.342A1 1 0 003 9.236V15a1 1 0 00.553.894l4 2A1 1 0 009 17v-5.764a1 1 0 00-.553-.894l-4-2z" />
                                                </svg>
                                            </span>
                                        </h3>
                                    </div>
                                    
                                    <div class="p-2">
                                        <!-- ä½¿ç”¨æ¯”ä¹‹å‰æ›´ç°¡æ½”çš„æ¨™é¡Œ -->
                                        <!-- ç§»é™¤é“å…·æ”¶é›†æŒ‡å—æ¨™é¡Œ -->
                                        
                                        <!-- çµ±ä¸€é“å…·è©³æƒ…é¡¯ç¤ºå€åŸŸ -->
                                        <div class="flex flex-col space-y-2">
                                            <!-- ç§»é™¤é“å…·è©³æƒ…é¡¯ç¤ºå€åŸŸ -->
                                            
                                            <!-- é“å…·ç¶²æ ¼ - ä¸Šä¸‹åˆ†é¡åŠ åˆ†å’Œæ¸›åˆ†é“å…·ï¼Œä¸ä½¿ç”¨å·¦å³åˆ†éš” -->
                                            <div class="flex flex-col space-y-1.5">
                                                <!-- åŠ åˆ†é“å…·å€å¡Š -->
                                                <div class="bg-gray-800 bg-opacity-60 px-2 py-1 rounded-t-md">
                                                    <p class="text-[9px] text-green-400 text-center font-semibold">åŠ åˆ†é“å…·</p>
                                                </div>
                                                <!-- åŠ åˆ†é“å…·ç¶²æ ¼ -->
                                                <div class="grid grid-cols-6 gap-0.5 text-center mb-2">
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="umbrella" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">â˜‚ï¸</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">é›¨å‚˜</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+30</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="letter" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">âœ‰</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">ä¿¡ä»¶</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+20</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="window" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸªŸ</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">çª—æˆ¶</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+25</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="fan" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸª­</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">æ‘ºæ‰‡</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+40</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="tigerShoes" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸ‘Ÿ</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">è™é ­é‹</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+35</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-green-500 border-opacity-70 relative" data-id="photo" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸ–¼ï¸</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-green-400">ç…§ç‰‡</div>
                                                        <div class="text-[6px] text-green-400 font-bold">+50</div>
                                                    </div>
                                                </div>
                                                
                                                <!-- æ¸›åˆ†é“å…·å€å¡Š -->
                                                <div class="bg-gray-800 bg-opacity-60 px-2 py-1 rounded-t-md">
                                                    <p class="text-[9px] text-red-400 text-center font-semibold">æ¸›åˆ†é“å…·</p>
                                                </div>
                                                <!-- æ¸›åˆ†é“å…·ç¶²æ ¼ -->
                                                <div class="grid grid-cols-6 gap-0.5 text-center">
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="medicine" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸ’Š</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">è—¥</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-15</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="oldHouse" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸšï¸</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">è€æˆ¿å­</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-20</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="oldSofa" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸ›‹ï¸</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">è€æ²™ç™¼</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-25</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="clock" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">â°</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">æ™‚é˜</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-30</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="ghost" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸ‘»</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">é¬¼é­‚</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-40</div>
                                                    </div>
                                                    
                                                    <div class="item-icon bg-gray-900 bg-opacity-80 rounded p-0.5 hover:bg-opacity-60 transition-all cursor-pointer border-t border-red-500 border-opacity-70 relative" data-id="check" data-show-info="true">
                                                        <div class="w-6 h-6 mx-auto rounded-full flex items-center justify-center bg-gradient-to-br from-slate-600 to-slate-800 shadow-inner">
                                                            <span class="text-white text-xs">ğŸ’¸</span>
                                                        </div>
                                                        <div class="text-[7px] font-medium text-red-400">æ”¯ç¥¨</div>
                                                        <div class="text-[6px] text-red-400 font-bold">-45</div>
                                                    </div>
                                                </div>
                                            </div>
                                            

                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                    
                                    <!-- å½ˆå‡ºé“å…·è©³æƒ…çš„å®¹å™¨ -->
                                    <div id="item-detail-popup" class="hidden fixed top-0 left-0 right-0 bottom-0 z-[9999] flex items-center justify-center">
                                        <div class="absolute inset-0 bg-black bg-opacity-70"></div>
                                        <div class="relative bg-gray-800 rounded shadow-xl mx-4 border border-gray-700 transform transition-all w-[250px] max-h-[85%] overflow-auto">
                                            <div class="p-2">
                                                <div class="flex items-center mb-1">
                                                    <div id="popup-icon" class="w-6 h-6 rounded-full flex items-center justify-center mr-2"></div>
                                                    <h3 id="popup-title" class="text-sm font-bold text-white"></h3>
                                                    <button id="close-popup" class="ml-auto text-gray-400 hover:text-white p-1">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                                                    </button>
                                                </div>
                                                <div class="space-y-1">
                                                    <p id="popup-desc" class="text-xs text-gray-300"></p>
                                                    <div class="border-t border-gray-700 my-1 pt-1">
                                                        <p id="popup-quote" class="text-[10px] italic text-blue-300"></p>
                                                    </div>
                                                    <div>
                                                        <p id="popup-symbolism" class="text-[10px] text-gray-400"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- åœ¨æ„è±¡é“å…·èªªæ˜å€åŸŸçš„ä¸‹æ–¹æ·»åŠ æ›¸é™¢ä¸­æ–‡ç¶“å…¸AIå¯¦é©—å®¤ç½²å -->
                                    <div class="text-center text-xs text-gray-500 dark:text-gray-400 mt-2 mb-2">
                                        æ›¸é™¢ä¸­æ–‡ç¶“å…¸AIå¯¦é©—å®¤
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- éŠæˆ²çµæŸç•Œé¢ -->
                    <div id="game-over" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-70 text-white hidden p-4 overflow-auto">
                        <h2 class="text-xl sm:text-2xl font-bold mb-2">é›·æ“Šï¼</h2>
                        <p class="text-lg mb-3">é›£é€ƒå‘½é‹çš„æ‚²åŠ‡...</p>
                        <div class="px-5 py-4 bg-gray-800 bg-opacity-70 rounded-lg mb-3 w-full max-w-xs pulse-quote border border-blue-400 border-opacity-40 shadow-lg">
                            <div class="flex items-center justify-between mb-3">
                                <span id="act-indicator" class="text-xs bg-blue-700 bg-opacity-70 px-3 py-1 rounded-md shadow-md text-blue-100 font-medium">ç¬¬ä¸€å¹•</span>
                                <span class="text-xs font-semibold text-blue-200">ã€Šé›·é›¨ã€‹ç¶“å…¸å°è©</span>
                            </div>
                            <div class="quote-container relative p-4 rounded-lg bg-black bg-opacity-60 overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-full opacity-30">
                                    <!-- è—è‰²é–ƒé›»èƒŒæ™¯åœ–æ¡ˆ -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-full h-full">
                                        <path d="M20,0 L5,30 L15,30 L0,60 L30,20 L20,20 Z" fill="rgba(180,220,255,0.8)" transform="translate(10,20) scale(0.8)"></path>
                                        <path d="M20,0 L5,30 L15,30 L0,60 L30,20 L20,20 Z" fill="rgba(140,200,255,0.8)" transform="translate(60,10) scale(0.6)"></path>
                                        <path d="M15,0 L5,25 L12,28 L0,50 L25,15 L15,15 Z" fill="rgba(100,180,255,0.7)" transform="translate(35,35) scale(0.5) rotate(30)"></path>
                                    </svg>
                                </div>
                                <p id="quote-character" class="text-sm text-blue-200 text-center mb-3 font-bold"></p>
                                <p id="character-quote" class="text-base italic text-center mb-2 min-h-[3.5rem] font-medium text-blue-50 tracking-wide leading-relaxed lightning-glow neon-text">"å‘½é‹çš„è¨˜è™Ÿï¼Œæ—©å·²ç¶“åˆ»åœ¨æˆ‘çš„é¡ä¸Šã€‚"</p>
                                <div class="quote-highlight absolute top-0 left-0 w-full h-full rounded-lg" style="box-shadow: inset 0 0 15px rgba(100, 180, 255, 0.5), inset 0 0 30px rgba(70, 150, 255, 0.4); pointer-events: none;"></div>
                            </div>
                            <p id="character-analysis" class="text-sm text-blue-200 text-center mt-3 font-medium"></p>
                        </div>
                        <div class="px-4 py-3 bg-gray-800 bg-opacity-60 rounded-lg mb-4 w-full max-w-xs border border-blue-600 border-opacity-20">
                            <p id="plot-summary" class="text-xs text-center text-blue-100">ã€Šé›·é›¨ã€‹é–‹å§‹æ™‚ï¼Œæ•…äº‹ç™¼ç”Ÿåœ¨å‘¨æ¨¸åœ’å®¶ä¸­ï¼Œä¸€å ´é›·é›¨å³å°‡ä¾†è‡¨ï¼Œæš—ç¤ºè‘—å°‡è¦ç™¼ç”Ÿçš„åŠ‡è®Šã€‚</p>
                        </div>
                        
                        <!-- é“å…·ç³»çµ±å±•ç¤ºç§»é™¤ -->
                        
                        <div class="text-center mb-4 w-full max-w-xs">
                            <p class="text-base">ä½ çš„åˆ†æ•¸: <span id="final-score" class="font-bold text-primary">0</span></p>
                            <p class="text-base">æœ€é«˜åˆ†æ•¸: <span id="high-score" class="font-bold text-primary">0</span></p>
                        </div>
                        <button id="restart-btn" class="sound-btn button-highlight bg-blue-700 text-white font-bold py-2 px-6 rounded-full hover:bg-opacity-90 text-base transition-all neon-text">å†è©¦ä¸€æ¬¡</button>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        // æª¢æ¸¬æš—é»‘æ¨¡å¼
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // éŠæˆ²é‚è¼¯
        document.addEventListener('DOMContentLoaded', function() {
            // å‰µå»ºéŸ³é »ä¸Šä¸‹æ–‡ - åˆå§‹åŒ–ä¸€æ¬¡å…¨å±€éŸ³é »ä¸Šä¸‹æ–‡
            let audioContext;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('ä¸æ”¯æŒéŸ³é »API:', e);
            }
            
            // ç«‹å³åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡ - é€šéç”¨æˆ¶äº¤äº’è§£é–
            document.addEventListener('click', function initAudio() {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('AudioContext resumed successfully');
                    });
                }
                document.removeEventListener('click', initAudio);
            }, {once: true});
            
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const characterElement = document.getElementById('character');
            const characterImg = document.getElementById('character-img');
            const scoreElement = document.getElementById('score');
            const levelElement = document.getElementById('level');
            const startScreen = document.getElementById('start-screen');
            const gameOverScreen = document.getElementById('game-over');
            const finalScoreElement = document.getElementById('final-score');
            const highScoreElement = document.getElementById('high-score');
            const restartBtn = document.getElementById('restart-btn');
            const characterButtons = document.querySelectorAll('.character-btn');
            const gameContainer = document.getElementById('game-container');
            const rainContainer = document.getElementById('rain-container');
            const statusBar = document.getElementById('status-bar');
            
            let gameWidth, gameHeight;
            let characterWidth = 60;
            let characterHeight = 80;
            let characterX = 0;
            let character = '';
            let characterAbility = '';
            let score = 0;
            let level = 1;
            let lightning = [];
            let isGameRunning = false;
            let animationFrameId = null;
            let highScore = 0;
            let currentQuoteBubble = null;
            let frameCount = 0; // ç”¨æ–¼æ§åˆ¶åˆ†æ•¸å¢é•·é€Ÿåº¦çš„è¨ˆæ•¸å™¨
            
            // è§’è‰²æŠ€èƒ½ç›¸é—œè®Šé‡
            let abilityActive = false;        // æŠ€èƒ½æ˜¯å¦æ¿€æ´»
            let abilityCooldown = false;      // æŠ€èƒ½æ˜¯å¦åœ¨å†·å»ä¸­
            let abilityDuration = 0;          // æŠ€èƒ½æŒçºŒæ™‚é–“è¨ˆæ™‚å™¨
            let abilityCooldownTime = 0;      // æŠ€èƒ½å†·å»è¨ˆæ™‚å™¨
            let invincible = false;           // ç„¡æ•µç‹€æ…‹
            
            // éŠæˆ²é“å…·
            let items = [];                   // æ‰è½çš„é“å…·
            let activeEffects = {};           // æ¿€æ´»çš„æ•ˆæœ
            
            // é›¨æ»´æ•ˆæœè¨ˆæ™‚å™¨
            let rainInterval;
            let raindropsCount = 0;
            const MAX_RAINDROPS = 80;
            
            // èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶
            const backgroundMusic = document.getElementById('background-music');
            const musicToggle = document.getElementById('music-toggle');
            const musicOnIcon = document.getElementById('music-on-icon');
            const musicOffIcon = document.getElementById('music-off-icon');
            let isMusicPlaying = false;
            
            // éŸ³æ¨‚æ§åˆ¶å‡½æ•¸
            function toggleMusic() {
                if (isMusicPlaying) {
                    backgroundMusic.pause();
                    musicOnIcon.classList.add('hidden');
                    musicOffIcon.classList.remove('hidden');
                    isMusicPlaying = false;
                } else {
                    // å˜—è©¦æ’­æ”¾éŸ³æ¨‚ï¼Œå¦‚æœå¤±æ•—å‰‡éœé»˜è™•ç†
                    backgroundMusic.play().then(() => {
                        musicOnIcon.classList.remove('hidden');
                        musicOffIcon.classList.add('hidden');
                        isMusicPlaying = true;
                    }).catch(error => {
                        console.log('ç„¡æ³•æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚:', error);
                        // å¦‚æœè‡ªå‹•æ’­æ”¾è¢«é˜»æ­¢ï¼Œé¡¯ç¤ºæç¤º
                        showMusicAlert();
                    });
                }
            }
            
            // é¡¯ç¤ºéŸ³æ¨‚æ’­æ”¾æç¤º
            function showMusicAlert() {
                const alert = document.createElement('div');
                alert.className = 'fixed top-20 left-4 bg-gradient-to-br from-gray-900 to-gray-800 text-white p-3 rounded-lg border border-blue-500 border-opacity-30 shadow-lg z-50 text-sm max-w-xs';
                alert.innerHTML = `
                    <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2 text-yellow-300 flex-shrink-0 mt-0.5">
                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06z" />
                        </svg>
                        <div>
                            <div class="font-medium">èƒŒæ™¯éŸ³æ¨‚æç¤º</div>
                            <div class="text-xs text-gray-300 mt-1">è«‹é»æ“ŠéŸ³æ¨‚æŒ‰éˆ•å•Ÿç”¨èƒŒæ™¯éŸ³æ¨‚</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(alert);
                
                // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 3000);
            }
            
            // åˆå§‹åŒ–éŸ³æ¨‚æ§åˆ¶
            musicToggle.addEventListener('click', toggleMusic);
            
            // è¨­ç½®éŸ³æ¨‚é»˜èªéŸ³é‡
            backgroundMusic.volume = 0.3;
            
            // ç•¶éŠæˆ²é–‹å§‹æ™‚å˜—è©¦æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
            function startBackgroundMusic() {
                if (!isMusicPlaying) {
                    backgroundMusic.play().then(() => {
                        musicOnIcon.classList.remove('hidden');
                        musicOffIcon.classList.add('hidden');
                        isMusicPlaying = true;
                    }).catch(error => {
                        console.log('éŠæˆ²é–‹å§‹æ™‚ç„¡æ³•è‡ªå‹•æ’­æ”¾éŸ³æ¨‚:', error);
                    });
                }
            }
            
            // ç•¶éŠæˆ²çµæŸæ™‚æ·¡å‡ºéŸ³æ¨‚
            function fadeOutMusic() {
                if (isMusicPlaying && backgroundMusic) {
                    const fadeOutInterval = setInterval(() => {
                        if (backgroundMusic.volume > 0.05) {
                            backgroundMusic.volume -= 0.05;
                        } else {
                            backgroundMusic.pause();
                            backgroundMusic.volume = 0.3; // é‡ç½®éŸ³é‡ç‚ºé»˜èªå€¼
                            musicOnIcon.classList.add('hidden');
                            musicOffIcon.classList.remove('hidden');
                            isMusicPlaying = false;
                            clearInterval(fadeOutInterval);
                        }
                    }, 100);
                }
            }
            
            // é›·è²éŸ³æ•ˆé›†
            const thunderSounds = [
                { frequency: [100, 30], type: 'sawtooth', duration: 0.5, volume: 0.2 },
                { frequency: [50, 20], type: 'square', duration: 0.6, volume: 0.15 },
                { frequency: [80, 15], type: 'triangle', duration: 0.4, volume: 0.25 },
                { frequency: [150, 40], type: 'sawtooth', duration: 0.3, volume: 0.18 },
                { frequency: [60, 10], type: 'square', duration: 0.7, volume: 0.22 }
            ];
            
            // å‰µå»ºé›¨æ»´ - ä¸å†ä½¿ç”¨ï¼Œå·²è¢«ç§»é™¤
            function createRaindrops() {
                // åŠŸèƒ½å·²è¢«ç§»é™¤ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
                return;
            }
            
            // æ’­æ”¾é›·è²éŸ³æ•ˆ - æ“´å±•æ”¯æŒå„è§’è‰²å°ˆå±¬èƒ½åŠ›éŸ³æ•ˆ
            function playThunderSound(type = 'random') {
                if (!audioContext) return;
                
                try {
                    // é¸æ“‡éŸ³æ•ˆé¡å‹
                    let soundProfile;
                    if (type === 'random') {
                        soundProfile = thunderSounds[Math.floor(Math.random() * thunderSounds.length)];
                    } else if (type === 'button') {
                        // æŒ‰éˆ•éŸ³æ•ˆ - æ›´çŸ­æ›´éŸ¿äº®
                        soundProfile = {
                            frequency: [120, 50],
                            type: 'triangle',
                            duration: 0.15,
                            volume: 0.12
                        };
                    } else if (type === 'big') {
                        // å¤§é›·éŸ³æ•ˆ - æ›´ä½æ²‰æ›´é•·
                        soundProfile = {
                            frequency: [80, 20],
                            type: 'sawtooth',
                            duration: 0.8,
                            volume: 0.25
                        };
                    } else if (type === 'death') {
                        // æ­»äº¡é›·æ“ŠéŸ³æ•ˆ - æ›´éœ‡æ’¼
                        soundProfile = {
                            frequency: [60, 10],
                            type: 'sawtooth',
                            duration: 1.0,
                            volume: 0.3
                        };
                    } 
                    // è§’è‰²èƒ½åŠ›å°ˆå±¬éŸ³æ•ˆ
                    else if (type === 'ability_å‘¨æ¨¸åœ’') {
                        // å¨æ¬ŠåŠ›å ´ - æ·±æ²‰å¨åš´çš„éŸ³æ•ˆ
                        soundProfile = {
                            frequency: [60, 40],
                            type: 'square',
                            duration: 0.6,
                            volume: 0.22,
                            // æ·»åŠ é€£çºŒä½éŸ³æ•ˆæœ
                            pulseCount: 3,
                            pulseInterval: 0.15
                        };
                    } else if (type === 'ability_å‘¨è') {
                        // å„ªæŸ”ç¬ç§» - çŸ­ä¿ƒçš„ç¬ç§»éŸ³æ•ˆ
                        soundProfile = {
                            frequency: [180, 300],
                            type: 'sine',
                            duration: 0.3,
                            volume: 0.15
                        };
                    } else if (type === 'ability_å‘¨æ²–') {
                        // é’æ˜¥è¡åˆº - å……æ»¿æ´»åŠ›ã€é«˜é »çš„è¡åˆºéŸ³æ•ˆ
                        soundProfile = {
                            frequency: [220, 350],
                            type: 'triangle',
                            duration: 0.35,
                            volume: 0.18
                        };
                    } else if (type === 'ability_é­¯ä¾è') {
                        // éš±å¿å …éŸŒ - å …å®šã€æŒä¹…çš„è­·ç›¾éŸ³æ•ˆ
                        soundProfile = {
                            frequency: [90, 120],
                            type: 'sine',
                            duration: 0.5,
                            volume: 0.2
                        };
                    } else if (type === 'ability_ç¹æ¼ª') {
                        // æƒ…æ„Ÿåº‡è­· - æƒ…æ„ŸåŒ–ã€æ³¢å‹•çš„éŸ³æ•ˆ
                        soundProfile = {
                            frequency: [150, 180],
                            type: 'sine',
                            duration: 0.4,
                            volume: 0.18,
                            // æƒ…æ„Ÿæ³¢å‹•æ•ˆæœ
                            modulation: true
                        };
                    } else if (type === 'ability_å››é³³') {
                        // é çŸ¥é–ƒé¿ - ç¥ç§˜ã€é è¦‹æ€§çš„éŸ³æ•ˆ
                        soundProfile = {
                            frequency: [200, 150],
                            type: 'sine',
                            duration: 0.5,
                            volume: 0.16,
                            // é çŸ¥ç‰¹æ•ˆ - ç”±é«˜åˆ°ä½çš„éŸ³èª¿
                            reverse: true,
                            echo: true
                        };
                    }
                    
                    // å‰µå»ºéŸ³æ•ˆ
                    const oscillator = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    
                    oscillator.type = soundProfile.type;
                    
                    // è™•ç†ç‰¹æ®ŠéŸ³æ•ˆå±¬æ€§
                    if (soundProfile.reverse) {
                        // åå‘é »ç‡è®ŠåŒ–ï¼ˆå¾é«˜åˆ°ä½ï¼‰
                        oscillator.frequency.setValueAtTime(soundProfile.frequency[0], audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(soundProfile.frequency[1], audioContext.currentTime + soundProfile.duration);
                    } else {
                        // æ¨™æº–é »ç‡è®ŠåŒ–ï¼ˆå¾ä½åˆ°é«˜ï¼‰
                        oscillator.frequency.setValueAtTime(soundProfile.frequency[0], audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(soundProfile.frequency[1], audioContext.currentTime + soundProfile.duration);
                    }
                    
                    // æƒ…æ„Ÿæ³¢å‹•æ•ˆæœ
                    if (soundProfile.modulation) {
                        const modulator = audioContext.createOscillator();
                        const modulatorGain = audioContext.createGain();
                        
                        modulator.frequency.value = 8; // æ³¢å‹•é€Ÿåº¦
                        modulatorGain.gain.value = 30; // æ³¢å‹•å¼·åº¦
                        
                        modulator.connect(modulatorGain);
                        modulatorGain.connect(oscillator.frequency);
                        modulator.start();
                        modulator.stop(audioContext.currentTime + soundProfile.duration);
                    }
                    
                    gain.gain.setValueAtTime(soundProfile.volume, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + soundProfile.duration);
                    
                    oscillator.connect(gain);
                    
                    // æ·»åŠ è¿´è²æ•ˆæœ
                    if (soundProfile.echo) {
                        const delay = audioContext.createDelay();
                        const echoGain = audioContext.createGain();
                        
                        delay.delayTime.value = 0.2;
                        echoGain.gain.value = 0.3;
                        
                        gain.connect(delay);
                        delay.connect(echoGain);
                        echoGain.connect(audioContext.destination);
                    }
                    
                    gain.connect(audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + soundProfile.duration);
                    
                    // è™•ç†è„ˆè¡éŸ³æ•ˆï¼ˆå¦‚å‘¨æ¨¸åœ’çš„å¨æ¬ŠåŠ›å ´ï¼‰
                    if (soundProfile.pulseCount && soundProfile.pulseInterval) {
                        let pulseCount = soundProfile.pulseCount;
                        const interval = soundProfile.pulseInterval;
                        const baseFreq = soundProfile.frequency[0];
                        
                        // æ’­æ”¾é¡å¤–çš„è„ˆè¡éŸ³æ•ˆ
                        for (let i = 1; i < pulseCount; i++) {
                            setTimeout(() => {
                                const pulseOsc = audioContext.createOscillator();
                                const pulseGain = audioContext.createGain();
                                
                                pulseOsc.type = soundProfile.type;
                                pulseOsc.frequency.value = baseFreq * (1 - i * 0.1);
                                
                                pulseGain.gain.setValueAtTime(soundProfile.volume * 0.7, audioContext.currentTime);
                                pulseGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + soundProfile.duration * 0.7);
                                
                                pulseOsc.connect(pulseGain);
                                pulseGain.connect(audioContext.destination);
                                
                                pulseOsc.start();
                                pulseOsc.stop(audioContext.currentTime + soundProfile.duration * 0.7);
                            }, i * interval * 1000);
                        }
                    }
                } catch (e) {
                    console.log('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
                }
            }
            
            // æ’­æ”¾ç’°å¢ƒé›·è²
            function playAmbientThunder() {
                if (isGameRunning) {
                    // éš¨æ©Ÿæ±ºå®šæ˜¯å¦æ’­æ”¾
                    if (Math.random() < 0.1) {
                        playThunderSound('random');
                        
                        // é–ƒçˆå±å¹•
                        if (Math.random() < 0.5) {
                            gameContainer.classList.add('screen-flash');
                            setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
                        }
                    }
                    setTimeout(playAmbientThunder, 5000 + Math.random() * 7000); // æ¯5-12ç§’å˜—è©¦æ’­æ”¾ä¸€æ¬¡
                }
            }
            
            // ç‚ºæ‰€æœ‰æŒ‰éˆ•æ·»åŠ é›·è²éŸ³æ•ˆ
            function addThunderSoundToButtons() {
                const buttons = document.querySelectorAll('.sound-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        playThunderSound('button');
                    });
                });
            }
            
            // èª¿æ•´ç•«å¸ƒå¤§å°ç‚ºå®¹å™¨å¤§å°
            function resizeCanvas() {
                const container = document.getElementById('game-container');
                gameWidth = container.clientWidth;
                gameHeight = container.clientHeight;
                canvas.width = gameWidth;
                canvas.height = gameHeight;
                
                // è§’è‰²ä½ç½®åˆå§‹åŒ–
                if (isGameRunning && characterElement) {
                    characterX = gameWidth / 2;
                    characterElement.style.left = `${characterX}px`;
                    
                    // æ›´æ–°å°è©æ°£æ³¡ä½ç½®
                    updateQuoteBubblePosition();
                }
            }
            
            // æ›´æ–°å°è©æ°£æ³¡ä½ç½®
            function updateQuoteBubblePosition() {
                if (currentQuoteBubble && characterElement) {
                    currentQuoteBubble.style.left = `${characterX}px`;
                    currentQuoteBubble.style.bottom = `${characterHeight + 10}px`;
                }
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // ç”Ÿæˆè§’è‰²åœ–åƒ
            function generateCharacterImage(name) {
                const colors = {
                    'å‘¨æ¨¸åœ’': '#336699',
                    'å‘¨è': '#3399CC',
                    'å‘¨æ²–': '#66CCFF',
                    'é­¯ä¾è': '#CC6699',
                    'ç¹æ¼ª': '#FF6666',
                    'å››é³³': '#FFCC66'
                };
                
                const canvas = document.createElement('canvas');
                canvas.width = 60;
                canvas.height = 80;
                const ctx = canvas.getContext('2d');
                
                // ç¹ªè£½èº«é«”
                ctx.fillStyle = colors[name] || '#5D5CDE';
                ctx.beginPath();
                ctx.ellipse(30, 25, 15, 15, 0, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(20, 40);
                ctx.quadraticCurveTo(30, 30, 40, 40);
                ctx.lineTo(40, 65);
                ctx.lineTo(20, 65);
                ctx.closePath();
                ctx.fill();
                
                // ç¹ªè£½åå­—
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(name, 30, 55);
                
                return canvas.toDataURL();
            }
            
            // ç²å–è§’è‰²èƒ½åŠ›
            function getCharacterAbility(characterName) {
                const abilities = {
                    'å‘¨æ¨¸åœ’': 'å¨æ¬ŠåŠ›å ´',
                    'å‘¨è': 'å„ªæŸ”ç¬ç§»',
                    'å‘¨æ²–': 'é’æ˜¥è¡åˆº',
                    'é­¯ä¾è': 'éš±å¿å …éŸŒ',
                    'ç¹æ¼ª': 'æƒ…æ„Ÿåº‡è­·',
                    'å››é³³': 'é çŸ¥é–ƒé¿'
                };
                
                return abilities[characterName] || '';
            }
            
            // ã€Šé›·é›¨ã€‹ä¸»é¡Œé“å…·å®šç¾© - ç°¡åŒ–ç‚ºåªæœ‰åŠ åˆ†å’Œæ¸›åˆ†å…©ç¨®æ•ˆæœ
            const gameItems = [
                // åŠ åˆ†é“å…· - ç©æ¥µæ„è±¡ï¼Œä»£è¡¨æ­£å‘åŠ›é‡
                {
                    id: 'umbrella',
                    name: 'é›¨å‚˜',
                    description: 'ç²å¾—30åˆ†ï¼Œè±¡å¾µå°‹æ±‚çŸ­æš«é¿é›£ï¼Œåœ¨ã€Šé›·é›¨ã€‹ä¸­æ˜¯å¸Œæœ›çš„è±¡å¾µ',
                    pointValue: 30, // åŠ åˆ†å€¼
                    color: '#000000',
                    symbol: 'â˜‚',
                    storyText: 'ã€Œé€™å ´å¤§é›¨ï¼Œæ²’æœ‰ä¸€æŠŠå‚˜èƒ½é®å¾—ä½ã€‚ã€â€”â€”ç¹æ¼ª',
                    effect: 'addPoints',
                    rarity: 0.7, // è¼ƒå°‘å‡ºç¾
                    isPositive: true // æ¨™è¨˜ç‚ºç©æ¥µé“å…·
                },
                {
                    id: 'letter',
                    name: 'ä¿¡ä»¶',
                    description: 'ç²å¾—20åˆ†ï¼Œè±¡å¾µçœŸç›¸çš„æ­ç¤ºå’Œäººç‰©é–“çš„æºé€š',
                    pointValue: 20,
                    color: '#4CAF50',
                    symbol: 'âœ‰',
                    storyText: 'ã€Œé‚£ä¿¡æ˜¯å¯«çµ¦ä½ çš„ï¼Œä½ çš„æœªä¾†é‚„è¦é å®ƒã€‚ã€â€”â€”é­¯ä¾è',
                    effect: 'addPoints',
                    rarity: 1.0,
                    isPositive: true
                },
                {
                    id: 'window',
                    name: 'çª—æˆ¶',
                    description: 'ç²å¾—25åˆ†ï¼Œè±¡å¾µå°è‡ªç”±çš„æ¸´æœ›å’Œå°å¤–ç•Œçš„åš®å¾€',
                    pointValue: 25,
                    color: '#2196F3',
                    symbol: 'âš',
                    storyText: 'ã€Œæˆ‘å¸Œæœ›æˆ‘ä»Šå¤©è®Šæˆç«å±±çš„å£ï¼Œç†±ç†±çƒˆçƒˆåœ°å†’ä¸€æ¬¡ï¼Œä»€éº¼æˆ‘éƒ½ç‡’å€‹ä¹¾æ·¨ï¼ã€â€”â€”ç¹æ¼ª',
                    effect: 'addPoints',
                    rarity: 0.8,
                    isPositive: true
                },
                {
                    id: 'fan',
                    name: 'æ‘ºæ‰‡',
                    description: 'ç²å¾—40åˆ†ï¼Œè±¡å¾µç¹æ¼ªå°ç”Ÿæ´»çš„ç†±æƒ…èˆ‡æ¸´æœ›',
                    pointValue: 40,
                    color: '#E91E63',
                    symbol: 'æ‰‡',
                    storyText: 'ã€Œæˆ‘è¦å‘¼å¸ï¼Œæˆ‘è¦å…‰æ˜ï¼Œæˆ‘è¦ç”Ÿæ´»ï¼Œæˆ‘è¦è‡ªç”±ï¼ã€â€”â€”ç¹æ¼ª',
                    effect: 'addPoints',
                    rarity: 0.6, // è¼ƒç¨€æœ‰å› åˆ†æ•¸é«˜
                    isPositive: true
                },
                {
                    id: 'tigerShoes',
                    name: 'ç¹¡èŠ±è™é ­é‹',
                    description: 'ç²å¾—35åˆ†ï¼Œè±¡å¾µæ¯æ„›çš„å …éŸŒåŠ›é‡',
                    pointValue: 35,
                    color: '#FF9800',
                    symbol: 'ğŸ‘Ÿ',
                    storyText: 'ã€Œæˆ‘é€™äº›å¹´çš„è‹¦ä¸æ˜¯ä½ é‚£éŒ¢å°±ç®—å¾—æ¸…çš„ï¼ã€â€”â€”é­¯ä¾è',
                    effect: 'addPoints',
                    rarity: 0.7,
                    isPositive: true
                },
                {
                    id: 'photo',
                    name: 'å®¶åº­ç…§ç‰‡',
                    description: 'ç²å¾—50åˆ†ï¼Œè±¡å¾µçœŸç›¸è¢«æ­éœ²å¸¶ä¾†çš„è§£è„«',
                    pointValue: 50,
                    color: '#FF5722',
                    symbol: 'ğŸ–¼',
                    storyText: 'ã€Œæœ‰äº›ç§˜å¯†ï¼Œå³ä½¿æ©è“‹ä¸‰åå¹´ï¼Œé‚„æ˜¯æœƒè¢«é›·é›¨æ²–åˆ·å‡ºä¾†ã€‚ã€â€”â€”å‘¨æ¨¸åœ’',
                    effect: 'addPoints',
                    rarity: 0.5, // éå¸¸ç¨€æœ‰ï¼Œå› ç‚ºåˆ†æ•¸æœ€é«˜
                    isPositive: true
                },
                
                // æ¸›åˆ†é“å…· - æ¶ˆæ¥µæ„è±¡ï¼Œä»£è¡¨è² é¢åŠ›é‡
                {
                    id: 'medicine',
                    name: 'è—¥',
                    description: 'æ¸›å°‘15åˆ†ï¼Œè±¡å¾µå‘¨æ¨¸åœ’ç”¨ä¾†æ§åˆ¶ç¹æ¼ªçš„å·¥å…·',
                    pointValue: -15, 
                    color: '#00BCD4',
                    symbol: 'âš•',
                    storyText: 'ã€Œç¹æ¼ªï¼Œç•¶äº†æ¯è¦ªçš„äººï¼Œè™•è™•æ‡‰ç•¶æ›¿å­å¥³è‘—æƒ³ï¼Œå°±æ˜¯è‡ªå·±ä¸ä¿é‡èº«é«”ï¼Œä¹Ÿæ‡‰ç•¶æ›¿å­©å­åšå€‹æœå¾çš„æ¦œæ¨£ã€‚ã€â€”â€”å‘¨æ¨¸åœ’',
                    effect: 'subtractPoints',
                    rarity: 0.9,
                    isPositive: false // æ¨™è¨˜ç‚ºæ¶ˆæ¥µé“å…·
                },
                {
                    id: 'oldHouse',
                    name: 'è€æˆ¿å­',
                    description: 'æ¸›å°‘20åˆ†ï¼Œè±¡å¾µç¦éŒ®äººæ€§çš„å°å»ºå®¶åº­',
                    pointValue: -20,
                    color: '#795548',
                    symbol: 'âŒ‚',
                    storyText: 'ã€Œå‘¨å®¶çš„ç©ºæ°£æ»¿æ˜¯ç½ªæƒ¡ï¼Œé€™äº›å¹´æˆ‘çœ‹è¦‹äº†ä»–å€‘æ‰€åšçš„å£äº‹ï¼ã€â€”â€”ç¹æ¼ª',
                    effect: 'subtractPoints',
                    rarity: 0.8,
                    isPositive: false
                },
                {
                    id: 'oldSofa',
                    name: 'è€æ²™ç™¼',
                    description: 'æ¸›å°‘25åˆ†ï¼Œè±¡å¾µè¡¨é¢èˆ’é©å¯¦å‰‡çª’æ¯çš„ç”Ÿæ´»',
                    pointValue: -25,
                    color: '#8D6E63',
                    symbol: 'âˆ',
                    storyText: 'ã€Œé€™è€æˆ¿å­æ°¸é æ˜¯é€™æ¨£æ‚¶æ°£ï¼Œå‚¢ä¿±éƒ½ç™¼äº†é»´ï¼Œäººå€‘ä¹Ÿæ˜¯é¬¼è£é¬¼æ°£çš„ï¼ã€â€”â€”ç¹æ¼ª',
                    effect: 'subtractPoints',
                    rarity: 0.75,
                    isPositive: false
                },
                {
                    id: 'clock',
                    name: 'æ™‚é˜',
                    description: 'æ¸›å°‘30åˆ†ï¼Œè±¡å¾µå‘½é‹çš„ä¸å¯é€†è½‰å’Œæ™‚é–“çš„å£“è¿«',
                    pointValue: -30,
                    color: '#3F51B5',
                    symbol: 'â±',
                    storyText: 'ã€Œæ™‚é˜çš„æ»´ç­”è²åŠ åŠ‡ç·Šè¿«æ„Ÿï¼Œé ç¤ºæ‚²åŠ‡çš„ä¸å¯é€†è½‰ã€‚ã€',
                    effect: 'subtractPoints',
                    rarity: 0.7,
                    isPositive: false
                },
                {
                    id: 'ghost',
                    name: 'é¬¼é­‚',
                    description: 'æ¸›å°‘40åˆ†ï¼Œè±¡å¾µå®¶åº­è¢«éå»ç½ªæƒ¡çºç¹çš„ææ‡¼',
                    pointValue: -40,
                    color: '#673AB7',
                    symbol: 'ğŸ‘»',
                    storyText: 'ã€Œæˆ‘ç¾åœ¨å¿ƒè£å¾ˆäº‚ï¼Œä½ ä¸çŸ¥é“é€™å±‹å­é¬§é¬¼éº¼ï¼Ÿã€â€”â€”å‘¨è',
                    effect: 'subtractPoints',
                    rarity: 0.6, // è¼ƒç¨€æœ‰å› ç‚ºæ‰£åˆ†é«˜
                    isPositive: false
                },
                {
                    id: 'check',
                    name: 'æ”¯ç¥¨',
                    description: 'æ¸›å°‘45åˆ†ï¼Œè±¡å¾µå‘¨æ¨¸åœ’è©¦åœ–ç”¨é‡‘éŒ¢æ©è“‹ç½ªæƒ¡çš„è™›å½',
                    pointValue: -45,
                    color: '#4CAF50',
                    symbol: 'ğŸ’µ',
                    storyText: 'ã€Œä½ çˆ¶è¦ªæ˜¯ä»€éº¼æ¨£çš„äººï¼Ÿä»–åšç›¡äº†å£äº‹å¼„éŒ¢ï¼Œä»–è‡ªç„¶å¯ä»¥è¡Œå–„ï¼ã€â€”â€”ç¹æ¼ª',
                    effect: 'subtractPoints',
                    rarity: 0.5, // éå¸¸ç¨€æœ‰ï¼Œå› ç‚ºæ‰£åˆ†æœ€é«˜
                    isPositive: false
                }
            ];
            
            // æ ¹æ“šç¨€æœ‰åº¦å¾é“å…·ä¸­é¸æ“‡ä¸€å€‹
            function selectRandomItem() {
                // å…ˆæŒ‰ç…§ç¨€æœ‰åº¦å°é“å…·é€²è¡Œéæ¿¾
                const availableItems = [];
                
                for (const item of gameItems) {
                    // ç¨€æœ‰åº¦æ±ºå®šç‰©å“è¢«é¸ä¸­çš„æ©Ÿç‡
                    if (Math.random() <= (item.rarity || 1.0)) {
                        availableItems.push(item);
                    }
                }
                
                // å¦‚æœæ²’æœ‰é“å…·é€šéç¨€æœ‰åº¦ç¯©é¸ï¼Œé¸æ“‡ä¸€å€‹é»˜èªé“å…·
                if (availableItems.length === 0) {
                    return gameItems[1]; // è¿”å›èŸ‹èŸ€è­·ç¬¦ä½œç‚ºé»˜èª
                }
                
                // å¾å¯ç”¨é“å…·ä¸­éš¨æ©Ÿé¸æ“‡ä¸€å€‹
                return availableItems[Math.floor(Math.random() * availableItems.length)];
            }
            
            // åˆå§‹åŒ–éŠæˆ²
            function initGame(selectedCharacter) {
                character = selectedCharacter;
                characterAbility = getCharacterAbility(selectedCharacter);
                characterImg.src = generateCharacterImage(character);
                characterElement.classList.remove('hidden');
                
                // é‡ç½®éŠæˆ²ç‹€æ…‹
                score = 0;
                level = 1;
                lightning = [];
                items = [];
                activeEffects = {};
                invincible = false;
                abilityActive = false;
                abilityCooldown = false;
                
                // ç‰¹æ®Šèƒ½åŠ›åˆå§‹åŒ–
                characterWidth = 60;
                characterHeight = 80;
                
                // è¨­ç½®è§’è‰²ä½ç½®
                characterX = gameWidth / 2;
                if (characterElement) {
                    characterElement.style.left = `${characterX}px`;
                }
                
                // æ›´æ–°UI
                scoreElement.textContent = score;
                levelElement.textContent = level;
                
                // éš±è—é–‹å§‹å±å¹•
                startScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
                
                // å•Ÿå‹•é›¨æ•ˆæœ
                createRainEffect();
                
                // é¡¯ç¤ºé¢¨æš´ä¾†è‡¨æç¤ºç•«é¢
                showStormWarningScreen();
            }
            
            // å‰µå»ºé›¨æ»´æ•ˆæœ
            function createRainEffect() {
                // åŠŸèƒ½è¢«ç§»é™¤ï¼Œä¸å†å‰µå»ºé›¨æ»´æ•ˆæœ
                console.log("é›¨æ»´æ•ˆæœå·²è¢«ç§»é™¤");
            }

            // é¡¯ç¤ºé¢¨æš´ä¾†è‡¨æç¤ºç•«é¢ - å¤§å¹…æ”¹é€²ä»¥é¡¯ç¤ºæ›´è‡ªç„¶çš„çƒé›²
            function showStormWarningScreen() {
                // å‰µå»ºæç¤ºç•«é¢
                const warningScreen = document.createElement('div');
                warningScreen.id = 'storm-warning-screen';
                warningScreen.className = 'absolute inset-0 flex flex-col items-center justify-center z-40';
                
                // é›·è²æ•ˆæœ
                playThunderSound('big');
                
                // é–ƒçˆèƒŒæ™¯æ•ˆæœ - æ›´æš—çš„å‹•æ…‹èƒŒæ™¯
                const flashBackground = document.createElement('div');
                flashBackground.className = 'absolute inset-0 bg-gradient-to-b from-[#0a0d15] to-[#1a1e27] z-0';
                
                // é›²éœ§æ•ˆæœå®¹å™¨
                const cloudEffect = document.createElement('div');
                cloudEffect.className = 'absolute inset-0 z-10 overflow-hidden';
                
                // æ·»åŠ æ›´è‡ªç„¶çš„é›²èƒŒæ™¯æ¨£å¼
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes darkCloudMove {
                        0% { transform: translate(0, 0); }
                        50% { transform: translate(-5%, 2%); }
                        100% { transform: translate(0, 0); }
                    }
                    
                    @keyframes darkCloudPulse {
                        0%, 100% { opacity: 0.6; }
                        50% { opacity: 0.8; }
                    }
                    
                    .dark-cloud {
                        position: absolute;
                        background: radial-gradient(ellipse at center, rgba(40, 45, 55, 0.9) 0%, rgba(20, 25, 35, 0.7) 70%, rgba(10, 15, 25, 0) 100%);
                        border-radius: 50%;
                        filter: blur(20px);
                        animation: darkCloudMove 8s ease-in-out infinite, darkCloudPulse 10s ease-in-out infinite;
                    }
                `;
                document.head.appendChild(style);
                
                // å‰µå»ºå¤šå€‹ä¸è¦å‰‡é›²å±¤ï¼Œä»¥ç²å¾—æ›´è‡ªç„¶çš„æ•ˆæœ
                function createCloud(size, posX, posY, delay, duration, color) {
                    const cloud = document.createElement('div');
                    cloud.className = 'dark-cloud';
                    cloud.style.width = `${size}px`;
                    cloud.style.height = `${size * 0.6}px`;
                    cloud.style.left = `${posX}%`;
                    cloud.style.top = `${posY}%`;
                    cloud.style.backgroundColor = color || 'rgba(30, 35, 45, 0.9)';
                    cloud.style.animationDelay = `${delay}s`;
                    cloud.style.animationDuration = `${duration}s`;
                    return cloud;
                }
                
                // å‰µå»ºå¤šå±¤é›²
                const cloudLayers = [
                    // å¤§å‹èƒŒæ™¯é›²
                    createCloud(500, 10, 20, 0, 20, 'rgba(20, 25, 35, 0.8)'),
                    createCloud(400, 60, 10, 2, 15, 'rgba(20, 22, 30, 0.8)'),
                    createCloud(450, 30, 40, 1, 18, 'rgba(15, 20, 30, 0.7)'),
                    createCloud(350, 70, 30, 3, 16, 'rgba(25, 30, 40, 0.7)'),
                    
                    // ä¸­å‹é›²å±¤
                    createCloud(300, 20, 15, 2, 12, 'rgba(30, 35, 45, 0.8)'),
                    createCloud(280, 50, 25, 1, 14, 'rgba(25, 30, 40, 0.8)'),
                    createCloud(320, 80, 20, 3, 13, 'rgba(20, 25, 35, 0.8)'),
                    
                    // å°å‹å‰æ™¯é›²
                    createCloud(200, 30, 35, 0.5, 10, 'rgba(35, 40, 50, 0.9)'),
                    createCloud(180, 70, 45, 1.5, 9, 'rgba(30, 35, 45, 0.9)'),
                    createCloud(150, 40, 50, 2.5, 8, 'rgba(40, 45, 55, 0.9)'),
                ];
                
                // æ·»åŠ æ‰€æœ‰é›²å±¤
                cloudLayers.forEach(cloud => {
                    cloudEffect.appendChild(cloud);
                });
                
                // å‰µå»ºé–ƒé›»å…ƒç´  - æ›´å¤šæ¨£åŒ–çš„é–ƒé›»
                for (let i = 0; i < 8; i++) {
                    const lightning = document.createElement('div');
                    lightning.className = 'absolute z-20';
                    
                    // æ›´éš¨æ©Ÿçš„ä½ç½®å’Œè§’åº¦
                    lightning.style.left = `${Math.random() * 100}%`;
                    lightning.style.top = `${Math.random() * 60}%`;
                    lightning.style.transform = `rotate(${Math.random() * 40 - 20}deg) scale(${0.7 + Math.random() * 0.6})`;
                    
                    // éš¨æ©Ÿé¸æ“‡é–ƒé›»é¡è‰² - è—ç™½æˆ–é»ƒç™½
                    const isBlue = Math.random() > 0.7;
                    const lightningColor = isBlue ? 'rgba(180,220,255,0.9)' : 'rgba(255,255,230,0.9)';
                    const glowColor = isBlue ? 'rgba(100,170,255,0.4)' : 'rgba(255,240,180,0.4)';
                    
                    // æ›´è¤‡é›œçš„é–ƒé›»SVGè·¯å¾‘
                    lightning.innerHTML = `
                        <svg width="40" height="120" viewBox="0 0 40 120" xmlns="http://www.w3.org/2000/svg">
                            <filter id="glow${i}" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="3" result="blur" />
                                <feComposite in="SourceGraphic" in2="blur" operator="over" />
                            </filter>
                            <path d="M20,0 L8,40 L18,45 L5,85 L15,90 L0,120 L38,75 L25,70 L35,40 L22,35 Z" 
                                  fill="${lightningColor}" 
                                  filter="url(#glow${i})"
                                  stroke="${glowColor}" 
                                  stroke-width="3" />
                        </svg>
                    `;
                    lightning.style.opacity = '0';
                    
                    // éš¨æ©Ÿé–ƒçˆåºåˆ— - æ›´è‡ªç„¶çš„é–ƒé›»æ•ˆæœ
                    setTimeout(() => {
                        // å¤šæ¬¡é–ƒçˆ
                        const flashCount = Math.floor(Math.random() * 3) + 1;
                        for (let j = 0; j < flashCount; j++) {
                            setTimeout(() => {
                                lightning.style.opacity = '1';
                                // äº®èµ·æ™‚é–“éš¨æ©Ÿ
                                setTimeout(() => {
                                    lightning.style.opacity = '0';
                                }, 50 + Math.random() * 100);
                            }, j * 200);
                        }
                        
                        // æ’­æ”¾é›·è²
                        if (Math.random() > 0.5) {
                            playThunderSound('random');
                        }
                    }, 500 + Math.random() * 3000);
                    
                    cloudEffect.appendChild(lightning);
                }
                
                // å‰µå»ºæç¤ºæ–‡å­—å®¹å™¨
                const textContainer = document.createElement('div');
                textContainer.className = 'relative z-30 px-8 py-6 bg-black bg-opacity-40 rounded-lg text-center max-w-md';
                
                // å¼•ç”¨ä¾†æº
                const quoteSource = document.createElement('div');
                quoteSource.className = 'text-xs text-yellow-300 mb-2';
                quoteSource.textContent = 'â€”â€”ç¹æ¼ªï¼Œã€Šé›·é›¨ã€‹';
                
                // æç¤ºæ–‡å­—ï¼ˆåˆå§‹ç‚ºç©ºï¼Œå°‡ä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœå¡«å……ï¼‰- å‡å°å­—é«”ç¢ºä¿åœ¨ä¸€è¡Œ
                const warningText = document.createElement('p');
                warningText.id = 'warning-text';
                warningText.className = 'text-xl font-bold whitespace-nowrap';
                
                // çµ„åˆå…ƒç´ 
                textContainer.appendChild(warningText);
                textContainer.appendChild(quoteSource);
                warningScreen.appendChild(flashBackground);
                warningScreen.appendChild(cloudEffect);
                warningScreen.appendChild(textContainer);
                
                // æ·»åŠ åˆ°éŠæˆ²å®¹å™¨
                gameContainer.appendChild(warningScreen);
                
                // æ‡‰ç”¨æ‰“å­—æ©Ÿæ•ˆæœ
                // æ³¨æ„é€™è£¡ä¸å†åŒ…å«å¼•è™Ÿ
                const warningPhrase = 'å°å¿ƒï¼Œç¾åœ¨é¢¨æš´å°±è¦èµ·ä¾†äº†ï¼';
                typewriterEffect(warningText, warningPhrase, 100, () => {
                    // æ‰“å­—æ•ˆæœå®Œæˆå¾Œï¼Œå»¶é²ä¸€æ®µæ™‚é–“å¾Œé–‹å§‹éŠæˆ²
                    setTimeout(() => {
                        warningScreen.classList.add('animate-fade-out');
                        setTimeout(() => {
                            warningScreen.remove();
                            // æ­£å¼é–‹å§‹éŠæˆ²
                            startActualGame();
                        }, 1000);
                    }, 2000);
                });
                
                // æ·»åŠ æ·¡å‡ºå‹•ç•«
                const fadeOutStyle = document.createElement('style');
                fadeOutStyle.textContent = `
                    .animate-fade-out {
                        animation: fadeOut 1s forwards;
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(fadeOutStyle);
            }
            
            // æ­£å¼é–‹å§‹éŠæˆ²
            function startActualGame() {
                // è¨˜éŒ„éŠæˆ²é–‹å§‹æ™‚é–“
                gameStartTime = Date.now();
                
                // é–‹å§‹éŠæˆ²
                isGameRunning = true;
                statusBar.classList.remove('hidden');
                
                // å‰µå»ºèƒ½åŠ›æŒ‡ç¤ºå™¨
                createAbilityIndicator();
                
                // é–‹å§‹éŠæˆ²å¾ªç’°
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                
                // é›¨æ»´æ•ˆæœå·²è¢«ç§»é™¤
                
                // å•Ÿå‹•ç’°å¢ƒé›·è²
                playAmbientThunder();
                
                // é–‹å§‹å¤§é›·è²
                playThunderSound('big');
                
                // é–‹å§‹æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
                startBackgroundMusic();
                
                // é¡¯ç¤ºè§’è‰²å°è©æ°£æ³¡
                showCharacterQuoteBubble();
                
                gameLoop();
            }
            
            // å‰µå»ºèƒ½åŠ›æŒ‡ç¤ºå™¨
            function createAbilityIndicator() {
                // ç§»é™¤èˆŠçš„æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                const oldIndicator = document.getElementById('ability-indicator');
                if (oldIndicator) {
                    oldIndicator.remove();
                }
                
                // å‰µå»ºæ–°çš„æŒ‡ç¤ºå™¨ - æ”¹é€²è¦–è¦ºæ¨£å¼å’Œæ’ç‰ˆ
                const indicator = document.createElement('div');
                indicator.id = 'ability-indicator';
                indicator.className = 'absolute top-2 right-2 p-2.5 rounded-lg bg-gradient-to-br from-gray-900 to-gray-800 text-white text-xs z-20 border border-blue-500 border-opacity-30 shadow-lg';
                
                // ç²å–æŠ€èƒ½ç›¸é—œåƒæ•¸é¡¯ç¤º
                const cooldownTime = getAbilityCooldown();
                const cooldownSeconds = Math.ceil(cooldownTime / 60);
                const durationTime = getAbilityDuration();
                const durationSeconds = Math.ceil(durationTime / 60);
                
                // è¨­ç½®æŠ€èƒ½æ¿€æ´»æ–¹å¼æç¤º
                let activationTip = 'ç©ºæ ¼éµ/é•·æŒ‰æ¿€æ´»';
                if (characterAbility === 'éš±å¿å …éŸŒ') {
                    activationTip = 'ç©ºæ ¼éµæ¿€æ´»å…ç–«';
                }
                
                // ç²å–æŠ€èƒ½åœ–æ¨™ - ç‚ºä¸åŒæŠ€èƒ½è¨­ç½®ç‰¹å®šåœ–æ¨™
                let abilityIcon = '';
                switch(characterAbility) {
                    case 'å¨æ¬ŠåŠ›å ´':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-yellow-300"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>';
                        break;
                    case 'å„ªæŸ”ç¬ç§»':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-blue-300"><path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" /></svg>';
                        break;
                    case 'é’æ˜¥è¡åˆº':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-cyan-300"><path fill-rule="evenodd" d="M8.25 3.75H19.5a.75.75 0 01.75.75v11.25a.75.75 0 01-1.5 0V6.31L5.03 20.03a.75.75 0 01-1.06-1.06L17.69 5.25H8.25a.75.75 0 010-1.5z" clip-rule="evenodd" /></svg>';
                        break;
                    case 'éš±å¿å …éŸŒ':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-purple-300"><path fill-rule="evenodd" d="M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.75.75 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.39-.223-2.73-.635-3.985a.75.75 0 00-.722-.516l-.143.001c-2.996 0-5.717-1.17-7.734-3.08zm3.094 8.016a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>';
                        break;
                    case 'æƒ…æ„Ÿåº‡è­·':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-pink-300"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>';
                        break;
                    case 'é çŸ¥é–ƒé¿':
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-amber-300"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" /><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd" /></svg>';
                        break;
                    default:
                        abilityIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1 text-blue-300"><path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" /></svg>';
                }
                
                // æŠ€èƒ½åç¨±å’Œç‹€æ…‹ - å®Œå…¨é‡æ–°è¨­è¨ˆçš„æŒ‡ç¤ºå™¨
                indicator.innerHTML = `
                    <div class="flex items-center justify-between mb-1.5">
                        <div class="flex items-center font-bold text-sm text-primary">
                            ${abilityIcon}
                            <span>${characterAbility}</span>
                        </div>
                        <span id="ability-status" class="ml-1.5 px-2 py-0.5 bg-gradient-to-r from-blue-600 to-blue-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap">å°±ç·’</span>
                    </div>
                    
                    <div class="relative">
                        <!-- å†·å»/æŒçºŒæ™‚é–“æ¢ - æ·»åŠ é–ƒçˆé‚Šæ¡† -->
                        <div id="ability-cooldown" class="w-full h-2.5 bg-gray-800 rounded-full overflow-hidden border border-gray-700 shadow-inner">
                            <div id="ability-cooldown-bar" class="h-full bg-gradient-to-r from-primary to-blue-400 w-full rounded-full relative overflow-hidden transition-all duration-300">
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-primary-light to-transparent opacity-30 cooldown-shine"></div>
                            </div>
                        </div>
                        
                        <!-- å€’è¨ˆæ™‚é¡¯ç¤º -->
                        <div id="ability-timer" class="absolute right-0 -top-5 text-[9px] text-gray-300 font-bold"></div>
                    </div>
                    
                    <div class="flex justify-between items-center mt-1.5 text-[9px] text-gray-300">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-2.5 h-2.5 mr-0.5 text-gray-400">
                                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd" />
                            </svg>
                            <span>å†·å»: ${cooldownSeconds}ç§’</span>
                        </div>
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-2.5 h-2.5 mr-0.5 text-gray-400">
                                <path fill-rule="evenodd" d="M15.97 2.47a.75.75 0 011.06 0l4.5 4.5a.75.75 0 010 1.06l-4.5 4.5a.75.75 0 11-1.06-1.06l3.22-3.22H7.5a.75.75 0 010-1.5h11.69l-3.22-3.22a.75.75 0 010-1.06zm-7.94 9a.75.75 0 010 1.06l-3.22 3.22H16.5a.75.75 0 010 1.5H4.81l3.22 3.22a.75.75 0 11-1.06 1.06l-4.5-4.5a.75.75 0 010-1.06l4.5-4.5a.75.75 0 011.06 0z" clip-rule="evenodd" />
                            </svg>
                            <span>${activationTip}</span>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°éŠæˆ²å®¹å™¨
                document.getElementById('game-container').appendChild(indicator);
                
                // æ·»åŠ é–ƒå…‰å‹•ç•«
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes cooldownShine {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                    .cooldown-shine {
                        animation: cooldownShine 2s infinite linear;
                    }
                    
                    @keyframes pulseStatus {
                        0%, 100% { opacity: 0.9; }
                        50% { opacity: 1; box-shadow: 0 0 8px rgba(93, 92, 222, 0.5); }
                    }
                    .status-pulse {
                        animation: pulseStatus 2s infinite ease-in-out;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // è§’è‰²èƒ½åŠ›èªªæ˜ - æ›´æ–°æ‰€æœ‰èƒ½åŠ›ç‚ºä¸»å‹•æŠ€èƒ½
            const abilityDescriptions = {
                'å¨æ¬ŠåŠ›å ´': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">å¨æ¬ŠåŠ›å ´</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">æ¸›ç·©é–ƒé›»é€Ÿåº¦40%</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">ç©ºæ ¼/é•·æŒ‰</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">è±¡å¾µå‘¨æ¨¸åœ’çš„å°ˆåˆ¶å¨åš´ â€¢ 30ç§’å†·å»</p>
                        </div>
                    </div>
                `,
                'å„ªæŸ”ç¬ç§»': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">å„ªæŸ”ç¬ç§»</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">ç¬é–“ç§»å‹•åˆ°å®‰å…¨ä½ç½®</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">ç©ºæ ¼/é•·æŒ‰</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">è±¡å¾µå‘¨èçŒ¶è±«é€ƒé¿çš„ç‰¹æ€§ â€¢ 20ç§’å†·å»</p>
                        </div>
                    </div>
                `,
                'é’æ˜¥è¡åˆº': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">é’æ˜¥è¡åˆº</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">ç¬é–“çˆ†ç™¼å¼åŠ é€Ÿ</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">ç©ºæ ¼/é•·æŒ‰</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">è±¡å¾µå‘¨æ²–åæŠ—ç²¾ç¥ â€¢ 15ç§’å†·å»</p>
                        </div>
                    </div>
                `,
                'éš±å¿å …éŸŒ': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">éš±å¿å …éŸŒ</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">å…ç–«ä¸€æ¬¡é–ƒé›»å‚·å®³</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">ç©ºæ ¼/é•·æŒ‰</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">è±¡å¾µé­¯ä¾èçš„å …å¿ä¸æ‹” â€¢ 60ç§’å†·å»</p>
                        </div>
                    </div>
                `,
                'æƒ…æ„Ÿåº‡è­·': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">æƒ…æ„Ÿåº‡è­·</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">å‰µé€ çŸ­æš«è­·ç›¾æ¸›å°‘å‚·å®³</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">ç©ºæ ¼/é•·æŒ‰</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">è±¡å¾µç¹æ¼ªçš„æƒ…æ„Ÿæµªæ½® â€¢ 25ç§’å†·å»</p>
                        </div>
                    </div>
                `,
                'é çŸ¥é–ƒé¿': `
                    <div class="bg-thunder-deep bg-opacity-70 p-2 rounded-lg">
                        <div class="text-center mb-1">
                            <strong class="text-[#ADE2FF] text-xs">é çŸ¥é–ƒé¿</strong>
                        </div>
                        <div class="bg-black bg-opacity-30 rounded-lg p-2">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-[10px] text-lightning-white">å¢å¼·é–ƒé›»é è­¦æ•ˆæœ</p>
                                <span class="text-[9px] bg-gray-800 px-1 rounded">ç©ºæ ¼/é•·æŒ‰</span>
                            </div>
                            <p class="text-[9px] text-yellow-200">è±¡å¾µå››é³³å°å±éšªçš„æ„ŸçŸ¥ â€¢ 40ç§’å†·å»</p>
                        </div>
                    </div>
                `
            };
            
            // åˆå§‹åŒ–é“å…·ä¿¡æ¯å°è±¡ï¼Œç¢ºä¿åœ¨drawItemsä½¿ç”¨å‰å®šç¾© - çµ±ä¸€ä½¿ç”¨emojièˆ‡é¡è‰²
            window.itemDetails = {
                'oldHouse': {
                    name: 'è€æˆ¿å­',
                    description: 'æ¸›å°‘20åˆ†ï¼Œè±¡å¾µç¦éŒ®äººæ€§çš„å°å»ºå®¶åº­',
                    color: '#F44336', // çµ±ä¸€ä½¿ç”¨ç´…è‰²ç³»
                    icon: 'ğŸšï¸',
                    isPositive: false,
                    pointValue: -20
                },
                'diary': {
                    name: 'é­¯ä¾èçš„æ—¥è¨˜',
                    description: 'ç²å¾—35åˆ†ï¼Œè±¡å¾µçœŸç›¸çš„æ­éœ²é›–ç„¶ç—›è‹¦ä½†èƒ½å¸¶ä¾†è§£è„«',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'ğŸ““',
                    isPositive: true,
                    pointValue: 35
                },
                'fan': {
                    name: 'æ‘ºæ‰‡',
                    description: 'ç²å¾—40åˆ†ï¼Œè±¡å¾µç¹æ¼ªå°ç”Ÿæ´»çš„ç†±æƒ…èˆ‡æ¸´æœ›',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'ğŸª­',
                    isPositive: true,
                    pointValue: 40
                },
                'medicine': {
                    name: 'è—¥',
                    description: 'æ¸›å°‘15åˆ†ï¼Œè±¡å¾µå‘¨æ¨¸åœ’ç”¨ä¾†æ§åˆ¶ç¹æ¼ªçš„å·¥å…·',
                    color: '#F44336', // çµ±ä¸€ä½¿ç”¨ç´…è‰²ç³»
                    icon: 'ğŸ’Š',
                    isPositive: false,
                    pointValue: -15
                },
                'umbrella': {
                    name: 'é›¨å‚˜',
                    description: 'ç²å¾—30åˆ†ï¼Œè±¡å¾µå°‹æ±‚çŸ­æš«é¿é›£ï¼Œåœ¨ã€Šé›·é›¨ã€‹ä¸­æ˜¯å¸Œæœ›çš„è±¡å¾µ',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'â˜‚ï¸',
                    isPositive: true,
                    pointValue: 30
                },
                'clock': {
                    name: 'æ™‚é˜',
                    description: 'æ¸›å°‘30åˆ†ï¼Œè±¡å¾µå‘½é‹çš„ä¸å¯é€†è½‰å’Œæ™‚é–“çš„å£“è¿«',
                    color: '#F44336', // çµ±ä¸€ä½¿ç”¨ç´…è‰²ç³»
                    icon: 'â°',
                    isPositive: false,
                    pointValue: -30
                },
                'cricket': {
                    name: 'èŸ‹èŸ€è­·ç¬¦',
                    description: 'ç²å¾—20åˆ†ï¼Œè±¡å¾µå¹´è¼•çš„åæŠ—ç²¾ç¥å’Œç”Ÿå‘½åŠ›',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'ğŸ¦—',
                    isPositive: true,
                    pointValue: 20
                },
                'photo': {
                    name: 'å®¶åº­ç…§ç‰‡',
                    description: 'ç²å¾—50åˆ†ï¼Œè±¡å¾µçœŸç›¸è¢«æ­éœ²å¸¶ä¾†çš„è§£è„«',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'ğŸ–¼ï¸',
                    isPositive: true,
                    pointValue: 50
                },
                'oldSofa': {
                    name: 'è€æ²™ç™¼',
                    description: 'æ¸›å°‘25åˆ†ï¼Œè±¡å¾µè¡¨é¢èˆ’é©å¯¦å‰‡çª’æ¯çš„ç”Ÿæ´»',
                    color: '#F44336', // çµ±ä¸€ä½¿ç”¨ç´…è‰²ç³»
                    icon: 'ğŸ›‹ï¸',
                    isPositive: false,
                    pointValue: -25
                },
                'tigerShoes': {
                    name: 'ç¹¡èŠ±è™é ­é‹',
                    description: 'ç²å¾—35åˆ†ï¼Œè±¡å¾µæ¯æ„›çš„å …éŸŒåŠ›é‡',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'ğŸ‘Ÿ',
                    isPositive: true,
                    pointValue: 35
                },
                'window': {
                    name: 'çª—æˆ¶',
                    description: 'ç²å¾—25åˆ†ï¼Œè±¡å¾µå°è‡ªç”±çš„æ¸´æœ›å’Œå°å¤–ç•Œçš„åš®å¾€',
                    color: '#4CAF50', // çµ±ä¸€ä½¿ç”¨ç¶ è‰²ç³»
                    icon: 'ğŸªŸ',
                    isPositive: true,
                    pointValue: 25
                },
                'check': {
                    name: 'æ”¯ç¥¨',
                    description: 'æ¸›å°‘45åˆ†ï¼Œè±¡å¾µå‘¨æ¨¸åœ’è©¦åœ–ç”¨é‡‘éŒ¢æ©è“‹ç½ªæƒ¡çš„è™›å½',
                    color: '#F44336', // çµ±ä¸€ä½¿ç”¨ç´…è‰²ç³»
                    icon: 'ğŸ’¸',
                    isPositive: false,
                    pointValue: -45
                },
                'ghost': {
                    name: 'é¬¼é­‚',
                    description: 'æ¸›å°‘40åˆ†ï¼Œè±¡å¾µå®¶åº­è¢«éå»ç½ªæƒ¡çºç¹çš„ææ‡¼',
                    color: '#F44336', // çµ±ä¸€ä½¿ç”¨ç´…è‰²ç³»
                    icon: 'ğŸ‘»',
                    isPositive: false,
                    pointValue: -40
                }
            };
            
            // é‡æ–°è¨­è¨ˆèƒ½åŠ›æç¤ºæ°£æ³¡ï¼Œæ”¹å–„é¡¯ç¤ºå•é¡Œ
            characterButtons.forEach(button => {
                const abilityName = button.getAttribute('data-ability');
                const activationMethod = button.getAttribute('data-activation');
                const cooldown = button.getAttribute('data-cooldown');
                
                button.addEventListener('mouseover', (event) => {
                    // ç¢ºä¿æ°£æ³¡å…ƒç´ å­˜åœ¨
                    const abilityTooltip = document.getElementById('ability-tooltip');
                    if (!abilityTooltip || !abilityName) {
                        console.log('æ°£æ³¡å…ƒç´ æˆ–èƒ½åŠ›ä¿¡æ¯ä¸å­˜åœ¨');
                        return;
                    }
                    
                    try {
                        // æ¸…ç†èˆŠå…§å®¹ä¸¦é‡æ–°å»ºç«‹å…§éƒ¨çµæ§‹
                        abilityTooltip.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="text-sm font-bold text-primary ability-name"></div>
                                <div class="text-[8px] px-1.5 py-0.5 bg-blue-600 bg-opacity-70 rounded-md ability-activation"></div>
                            </div>
                            <div class="text-[10px] mt-1.5 text-gray-200 ability-desc"></div>
                            <div class="text-[9px] mt-1 italic text-blue-300 ability-note"></div>
                            <div class="mt-1.5 flex justify-between items-center text-[9px]">
                                <div class="text-yellow-300 ability-cooldown"></div>
                                <div class="text-white px-1.5 py-0.5 bg-primary bg-opacity-50 rounded-sm ability-usage"></div>
                            </div>
                            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30 tooltip-arrow"></div>
                        `;
                        
                        // ç²å–æ›´æ–°å¾Œçš„å…§éƒ¨å…ƒç´ 
                        const nameElement = abilityTooltip.querySelector('.ability-name');
                        const activationElement = abilityTooltip.querySelector('.ability-activation');
                        const cooldownElement = abilityTooltip.querySelector('.ability-cooldown');
                        const descElement = abilityTooltip.querySelector('.ability-desc');
                        const noteElement = abilityTooltip.querySelector('.ability-note');
                        const usageElement = abilityTooltip.querySelector('.ability-usage');
                        const arrowElement = abilityTooltip.querySelector('.tooltip-arrow');
                        
                        // æª¢æŸ¥æ˜¯å¦æˆåŠŸç²å–æ‰€æœ‰å…ƒç´ 
                        if (!nameElement || !activationElement || !cooldownElement || 
                            !descElement || !noteElement || !arrowElement) {
                            console.log('ç„¡æ³•ç²å–æ°£æ³¡å…§éƒ¨å…ƒç´ ');
                            return;
                        }
                        
                        // å¡«å……å…§å®¹
                        nameElement.textContent = abilityName;
                        
                        // è¨­ç½®æ¿€æ´»æ–¹å¼
                        if (activationMethod) {
                            activationElement.textContent = activationMethod;
                        } else {
                            activationElement.textContent = "è¢«å‹•èƒ½åŠ›";
                        }
                        
                        // è¨­ç½®å†·å»æ™‚é–“
                        if (cooldown) {
                            cooldownElement.textContent = cooldown;
                        } else {
                            cooldownElement.textContent = "ç„¡å†·å»";
                        }
                        
                        // æ ¹æ“šä¸åŒèƒ½åŠ›è¨­ç½®è©³ç´°ä¿¡æ¯
                        switch(abilityName) {
                            case 'å¨æ¬ŠåŠ›å ´':
                                descElement.textContent = "æ¸›ç·©é–ƒé›»é€Ÿåº¦40%";
                                noteElement.textContent = "è±¡å¾µå‘¨æ¨¸åœ’çš„å°ˆåˆ¶å¨åš´";
                                usageElement.textContent = "ä¸»å‹•æ¿€æ´»";
                                break;
                            case 'å„ªæŸ”ç¬ç§»':
                                descElement.textContent = "ç¬é–“ç§»å‹•åˆ°å®‰å…¨ä½ç½®";
                                noteElement.textContent = "è±¡å¾µå‘¨èçŒ¶è±«é€ƒé¿çš„ç‰¹æ€§";
                                usageElement.textContent = "ä¸»å‹•æ¿€æ´»";
                                break;
                            case 'é’æ˜¥è¡åˆº':
                                descElement.textContent = "ç¬é–“çˆ†ç™¼å¼åŠ é€Ÿ";
                                noteElement.textContent = "è±¡å¾µå‘¨æ²–åæŠ—ç²¾ç¥";
                                usageElement.textContent = "ä¸»å‹•æ¿€æ´»";
                                break;
                            case 'éš±å¿å …éŸŒ':
                                descElement.textContent = "å…ç–«ä¸€æ¬¡é–ƒé›»å‚·å®³";
                                noteElement.textContent = "è±¡å¾µé­¯ä¾èçš„å …å¿ä¸æ‹”";
                                usageElement.textContent = "ä¸»å‹•æ¿€æ´»";
                                break;
                            case 'æƒ…æ„Ÿåº‡è­·':
                                descElement.textContent = "å‰µé€ çŸ­æš«è­·ç›¾æ¸›å°‘å‚·å®³";
                                noteElement.textContent = "è±¡å¾µç¹æ¼ªçš„æƒ…æ„Ÿæµªæ½®";
                                usageElement.textContent = "ä¸»å‹•æ¿€æ´»";
                                break;
                            case 'é çŸ¥é–ƒé¿':
                                descElement.textContent = "å¢å¼·é–ƒé›»é è­¦æ•ˆæœ";
                                noteElement.textContent = "è±¡å¾µå››é³³å°å±éšªçš„æ„ŸçŸ¥";
                                usageElement.textContent = "ä¸»å‹•æ¿€æ´»";
                                break;
                            default:
                                descElement.textContent = "è§’è‰²ç‰¹æ®Šèƒ½åŠ›";
                                noteElement.textContent = "è«‹æŸ¥çœ‹è§’è‰²ä»‹ç´¹";
                                usageElement.textContent = "-";
                        }
                        
                        // å®šä½æ°£æ³¡ - å¢å¼·é‚Šç•Œæª¢æ¸¬
                        const buttonRect = button.getBoundingClientRect();
                        const tooltipWidth = 208; // w-52 = 13rem = 208px
                        const tooltipHeight = 120; // ç•¥å¾®å¢åŠ é«˜åº¦ç¢ºä¿å…§å®¹é¡¯ç¤ºå®Œæ•´
                        const SAFE_MARGIN = 12; // å®‰å…¨é‚Šè·ï¼Œç¢ºä¿ä¸æœƒç·Šè²¼é‚Šç·£
                        
                        // ç²å–éŠæˆ²å®¹å™¨ä½ç½®
                        const gameContainer = document.querySelector('.game-container');
                        if (!gameContainer) {
                            console.log('æ‰¾ä¸åˆ°éŠæˆ²å®¹å™¨');
                            return;
                        }
                        
                        const containerRect = gameContainer.getBoundingClientRect();
                        const gameWidth = containerRect.width;
                        const gameHeight = containerRect.height;
                        
                        // è¨ˆç®—æŒ‰éˆ•åœ¨å®¹å™¨ä¸­çš„ç›¸å°ä½ç½®
                        const buttonLeft = buttonRect.left - containerRect.left;
                        const buttonTop = buttonRect.top - containerRect.top;
                        const buttonRight = buttonLeft + buttonRect.width;
                        const buttonBottom = buttonTop + buttonRect.height;
                        
                        // åˆå§‹å„ªå…ˆä½ç½®ï¼šåœ¨æŒ‰éˆ•ä¸Šæ–¹ï¼Œæ°´å¹³å±…ä¸­å°é½Š
                        let tooltipLeft = buttonLeft + buttonRect.width/2 - tooltipWidth/2;
                        let tooltipTop = buttonTop - tooltipHeight - SAFE_MARGIN;
                        let position = 'top'; // é è¨­åœ¨ä¸Šæ–¹
                        
                        // æª¢æŸ¥æ˜¯å¦æœƒè¶…å‡ºä¸Šé‚Šç•Œ
                        if (tooltipTop < SAFE_MARGIN) {
                            // å¦‚æœä¸Šæ–¹ç©ºé–“ä¸è¶³ï¼Œæ”¹ç‚ºé¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸‹æ–¹
                            tooltipTop = buttonBottom + SAFE_MARGIN;
                            position = 'bottom';
                            
                            // æª¢æŸ¥ä¸‹æ–¹ç©ºé–“æ˜¯å¦å……è¶³
                            if (tooltipTop + tooltipHeight > gameHeight - SAFE_MARGIN) {
                                // å¦‚æœä¸‹æ–¹ä¹Ÿä¸å¤ ï¼Œå˜—è©¦æ”¾åœ¨æŒ‰éˆ•å·¦å´æˆ–å³å´
                                if (buttonLeft > gameWidth / 2) {
                                    // æŒ‰éˆ•åœ¨å³åŠéƒ¨ï¼Œå˜—è©¦æ”¾åœ¨å·¦å´
                                    tooltipLeft = buttonLeft - tooltipWidth - SAFE_MARGIN;
                                    tooltipTop = buttonTop + buttonRect.height/2 - tooltipHeight/2;
                                    position = 'left';
                                    
                                    // æª¢æŸ¥å·¦å´ç©ºé–“
                                    if (tooltipLeft < SAFE_MARGIN) {
                                        // å·¦å´ç©ºé–“ä¹Ÿä¸è¶³ï¼Œå¼·åˆ¶æ”¾åœ¨æœ€é ä¸­é–“çš„ä½ç½®
                                        tooltipLeft = SAFE_MARGIN;
                                        tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                    }
                                } else {
                                    // æŒ‰éˆ•åœ¨å·¦åŠéƒ¨ï¼Œå˜—è©¦æ”¾åœ¨å³å´
                                    tooltipLeft = buttonRight + SAFE_MARGIN;
                                    tooltipTop = buttonTop + buttonRect.height/2 - tooltipHeight/2;
                                    position = 'right';
                                    
                                    // æª¢æŸ¥å³å´ç©ºé–“
                                    if (tooltipLeft + tooltipWidth > gameWidth - SAFE_MARGIN) {
                                        // å³å´ç©ºé–“ä¹Ÿä¸è¶³ï¼Œå¼·åˆ¶æ”¾åœ¨æœ€é ä¸­é–“çš„ä½ç½®
                                        tooltipLeft = gameWidth - tooltipWidth - SAFE_MARGIN;
                                        tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                    }
                                }
                            }
                        }
                        
                        // ç¢ºä¿ä¸è¶…å‡ºå·¦å³é‚Šç•Œ
                        tooltipLeft = Math.max(SAFE_MARGIN, Math.min(gameWidth - tooltipWidth - SAFE_MARGIN, tooltipLeft));
                        
                        // ç¢ºä¿ä¸è¶…å‡ºä¸Šä¸‹é‚Šç•Œ
                        tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, tooltipTop));
                        
                        // æ ¹æ“šæœ€çµ‚ä½ç½®è¨­ç½®ç®­é ­
                        switch (position) {
                            case 'top':
                                // é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸Šæ–¹ï¼Œç®­é ­åœ¨åº•éƒ¨
                                arrowElement.className = 'absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // èª¿æ•´ç®­é ­æ°´å¹³ä½ç½®ï¼Œç¢ºä¿æŒ‡å‘æŒ‰éˆ•ä¸­å¿ƒ
                                const arrowHorizontalOffset = (buttonLeft + buttonRect.width/2) - (tooltipLeft + tooltipWidth/2);
                                if (Math.abs(arrowHorizontalOffset) < tooltipWidth/2 - 15) {
                                    arrowElement.style.left = `calc(50% + ${arrowHorizontalOffset}px)`;
                                } else {
                                    // å¦‚æœåç§»å¤ªå¤§ï¼Œéš±è—ç®­é ­
                                    arrowElement.style.display = 'none';
                                }
                                break;
                                
                            case 'bottom':
                                // é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸‹æ–¹ï¼Œç®­é ­åœ¨é ‚éƒ¨
                                arrowElement.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-l border-t border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // èª¿æ•´ç®­é ­æ°´å¹³ä½ç½®
                                const arrowHorizontalOffsetBottom = (buttonLeft + buttonRect.width/2) - (tooltipLeft + tooltipWidth/2);
                                if (Math.abs(arrowHorizontalOffsetBottom) < tooltipWidth/2 - 15) {
                                    arrowElement.style.left = `calc(50% + ${arrowHorizontalOffsetBottom}px)`;
                                } else {
                                    arrowElement.style.display = 'none';
                                }
                                break;
                                
                            case 'left':
                                // é¡¯ç¤ºåœ¨æŒ‰éˆ•å·¦å´ï¼Œç®­é ­åœ¨å³å´
                                arrowElement.className = 'absolute right-0 top-1/2 transform translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-t border-r border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // èª¿æ•´ç®­é ­å‚ç›´ä½ç½®
                                const arrowVerticalOffsetLeft = (buttonTop + buttonRect.height/2) - (tooltipTop + tooltipHeight/2);
                                if (Math.abs(arrowVerticalOffsetLeft) < tooltipHeight/2 - 15) {
                                    arrowElement.style.top = `calc(50% + ${arrowVerticalOffsetLeft}px)`;
                                    arrowElement.style.left = 'auto';
                                } else {
                                    arrowElement.style.display = 'none';
                                }
                                break;
                                
                            case 'right':
                                // é¡¯ç¤ºåœ¨æŒ‰éˆ•å³å´ï¼Œç®­é ­åœ¨å·¦å´
                                arrowElement.className = 'absolute left-0 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-b border-l border-blue-500 border-opacity-30 tooltip-arrow';
                                
                                // èª¿æ•´ç®­é ­å‚ç›´ä½ç½®
                                const arrowVerticalOffsetRight = (buttonTop + buttonRect.height/2) - (tooltipTop + tooltipHeight/2);
                                if (Math.abs(arrowVerticalOffsetRight) < tooltipHeight/2 - 15) {
                                    arrowElement.style.top = `calc(50% + ${arrowVerticalOffsetRight}px)`;
                                    arrowElement.style.left = 'auto';
                                } else {
                                    arrowElement.style.display = 'none';
                                }
                                break;
                        }
                        
                        // è¨­ç½®æœ€çµ‚ä½ç½®
                        abilityTooltip.style.left = `${tooltipLeft}px`;
                        abilityTooltip.style.top = `${tooltipTop}px`;
                        
                        // é¡¯ç¤ºæ°£æ³¡
                        abilityTooltip.classList.remove('hidden');
                    } catch (error) {
                        console.error('é¡¯ç¤ºæŠ€èƒ½æç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    }
                });
                
                button.addEventListener('mouseout', () => {
                    // éš±è—æ°£æ³¡
                    const abilityTooltip = document.getElementById('ability-tooltip');
                    if (abilityTooltip) {
                        abilityTooltip.classList.add('hidden');
                    }
                });
                
                button.addEventListener('click', () => {
                    const selectedCharacter = button.getAttribute('data-character');
                    initGame(selectedCharacter);
                });
            });
            
            // æ¸…ç†å‘¨æ²–çš„ç²’å­æ•ˆæœå’Œé€Ÿåº¦ç·š - æ›´å¾¹åº•çš„æ¸…ç†
            function cleanupSprintEffects() {
                console.log("åŸ·è¡Œå‘¨æ²–ç²’å­æ•ˆæœæ¸…ç†");
                
                // ç«‹å³å–æ¶ˆå‘¨æ²–çš„èƒ½åŠ›ç‹€æ…‹
                if (characterAbility === 'é’æ˜¥è¡åˆº' && activeEffects) {
                    activeEffects.youthSprint = false;
                    activeEffects.dashInvincibility = false;
                }
                
                // æ¸…é™¤ç¾æœ‰ç²’å­ç³»çµ±
                if (activeEffects && activeEffects.sprintParticles) {
                    try {
                        activeEffects.sprintParticles.stop();
                        activeEffects.sprintParticles = null;
                        delete activeEffects.sprintParticles;
                    } catch (e) {
                        console.error("æ¸…ç†ç²’å­ç³»çµ±æ™‚å‡ºéŒ¯:", e);
                    }
                }
                
                // ç§»é™¤é€Ÿåº¦ç·šå®¹å™¨ - ä½¿ç”¨æ›´å¾¹åº•çš„æŸ¥æ‰¾æ–¹å¼
                const speedLinesContainers = document.querySelectorAll('#speed-lines-container, .speed-lines');
                speedLinesContainers.forEach(container => {
                    if (container && container.parentNode) {
                        try {
                            container.remove();
                        } catch (e) {
                            console.error("ç§»é™¤é€Ÿåº¦ç·šå®¹å™¨æ™‚å‡ºéŒ¯:", e);
                        }
                    }
                });
                
                // ç§»é™¤æ‰€æœ‰èˆ‡è¡åˆºç›¸é—œçš„æ•ˆæœ
                const sprintEffects = document.querySelectorAll('#sprint-effect, .sprint-effect, .character-decoy');
                sprintEffects.forEach(effect => {
                    if (effect && effect.parentNode) {
                        try {
                            effect.remove();
                        } catch (e) {
                            console.error("ç§»é™¤è¡åˆºæ•ˆæœæ™‚å‡ºéŒ¯:", e);
                        }
                    }
                });
                
                // ç§»é™¤å¯èƒ½æ®˜ç•™åœ¨canvasä¸Šçš„ç²’å­
                const canvasElements = document.querySelectorAll('canvas');
                canvasElements.forEach(canvas => {
                    if (canvas.id !== 'game-canvas') { // ä¿ç•™ä¸»éŠæˆ²ç•«å¸ƒ
                        try {
                            canvas.remove();
                        } catch (e) {
                            console.error("ç§»é™¤ç²’å­ç•«å¸ƒæ™‚å‡ºéŒ¯:", e);
                        }
                    }
                });
                
                // å¼·åˆ¶åˆ·æ–°åœ°é¢æ³¢æ•ˆæœ
                const groundWaves = document.querySelectorAll('[style*="groundWave"]');
                groundWaves.forEach(wave => {
                    if (wave && wave.parentNode) {
                        try {
                            wave.remove();
                        } catch (e) {
                            console.error("ç§»é™¤åœ°é¢æ³¢æ•ˆæœæ™‚å‡ºéŒ¯:", e);
                        }
                    }
                });
            }
            
            // é‡æ–°é–‹å§‹éŠæˆ²
            restartBtn.addEventListener('click', () => {
                // æ¸…ç†ç²’å­æ•ˆæœ
                cleanupSprintEffects();
                
                // æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç‰¹æ®Šæ•ˆæœ
                const allEffects = document.querySelectorAll('#pressure-field, #character-shield, #resilience-aura, #timeslow-overlay');
                allEffects.forEach(effect => {
                    if (effect && effect.parentNode) {
                        effect.remove();
                    }
                });
                
                startScreen.classList.remove('hidden');
                gameOverScreen.classList.add('hidden');
                statusBar.classList.add('hidden');
            });
            
            // ç¦ç”¨è§’è‰²å°è©æ°£æ³¡é¡¯ç¤ºåŠŸèƒ½ï¼Œé¿å…å¹²æ“¾æ“ä½œ
            function showCharacterQuoteBubble() {
                // ä¸åŸ·è¡Œä»»ä½•æ“ä½œï¼Œå®Œå…¨ç¦ç”¨æ­¤åŠŸèƒ½
                return;
            }
            
            // æ”¶é›†é“å…·å¾Œä¹Ÿä¸é¡¯ç¤ºå°è©æ°£æ³¡
            function collectItem(item) {
                // é¡¯ç¤ºé“å…·æ•ˆæœæç¤º
                showItemEffectPopup(item);
                
                // æ ¹æ“šé“å…·é¡å‹æ‡‰ç”¨åŠ åˆ†æˆ–æ¸›åˆ†æ•ˆæœ
                if (item.effect === 'addPoints') {
                    // åŠ åˆ†æ•ˆæœ
                    score += item.pointValue;
                    
                    // æ’­æ”¾ç©æ¥µéŸ³æ•ˆ
                    playThunderSound('button');
                    
                    // é¡¯ç¤ºåŠ åˆ†å‹•ç•«
                    showScoreAnimation(item.pointValue, true);
                    
                    // æ­£é¢é“å…·æ”¶é›†è¦–è¦ºæ•ˆæœ - ç¶ è‰²å…‰èŠ’
                    createItemEffect('#4CAF50', 0.4);
                    
                } else if (item.effect === 'subtractPoints') {
                    // æ‰£åˆ†æ•ˆæœ
                    score = Math.max(0, score + item.pointValue); // ä½¿ç”¨ += å› ç‚º pointValue å·²ç¶“æ˜¯è² æ•¸
                    
                    // æ’­æ”¾æ¶ˆæ¥µéŸ³æ•ˆ
                    playThunderSound('random');
                    
                    // é¡¯ç¤ºæ‰£åˆ†å‹•ç•«
                    showScoreAnimation(item.pointValue, false);
                    
                    // è² é¢é“å…·æ”¶é›†è¦–è¦ºæ•ˆæœ - ç´…è‰²å…‰èŠ’
                    createItemEffect('#F44336', 0.4);
                    
                    // éœ‡å‹•æ•ˆæœ
                    gameContainer.classList.add('strong-shake');
                    setTimeout(() => {
                        gameContainer.classList.remove('strong-shake');
                    }, 500);
                }
                
                // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
                scoreElement.textContent = score;
                
                // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºé“å…·æ•ˆæœ
                function createItemEffect(color, opacity) {
                    const effect = document.createElement('div');
                    effect.className = 'absolute bottom-16 left-1/2 transform -translate-x-1/2 z-5 pointer-events-none';
                    effect.style.width = `${characterWidth * 1.8}px`;
                    effect.style.height = `${characterHeight * 1.5}px`;
                    effect.style.background = `radial-gradient(ellipse at center, ${color}99 0%, ${color}${Math.floor(opacity * 255).toString(16)} 20%, transparent 70%)`;
                    effect.style.borderRadius = '50%';
                    effect.style.animation = 'pulse 1.5s';
                    effect.style.opacity = '0.8';
                    
                    gameContainer.appendChild(effect);
                    
                    // æ•ˆæœè‡ªå‹•ç§»é™¤
                    setTimeout(() => {
                        effect.style.opacity = '0';
                        effect.style.transition = 'opacity 0.5s';
                        setTimeout(() => effect.remove(), 500);
                    }, 1200);
                }
            }
            
            // ã€Šé›·é›¨ã€‹åŸæ–‡å°è©åº«ï¼ˆå¾é™„ä»¶ä¸­ç²å–ï¼‰
            const characterQuotes = {
                'å‘¨æ¨¸åœ’': [
                    { text: "æˆ‘çš„å®¶åº­æ˜¯æˆ‘èªç‚ºæœ€åœ“æ»¿ã€æœ€æœ‰ç§©åºçš„å®¶åº­ï¼Œæˆ‘çš„å…’å­æˆ‘ä¹Ÿèªç‚ºéƒ½é‚„æ˜¯å¥å…¨çš„å­å¼Ÿã€‚", act: "ä¸€å¹•", note: "ç¶­è­·å°å»ºå®¶é•·å½¢è±¡" },
                    { text: "ä½ ä»¥ç‚ºä¸€å€‹äººåšäº†ä¸€ä»¶æ–¼å¿ƒä¸å¿çš„äº‹å°±æœƒå¿˜äº†éº¼ï¼Ÿ", act: "äºŒå¹•", note: "è‡ªæˆ‘è¾¯è§£" },
                    { text: "ç¹æ¼ªï¼Œç•¶äº†æ¯è¦ªçš„äººï¼Œè™•è™•æ‡‰ç•¶æ›¿å­å¥³è‘—æƒ³ï¼Œå°±æ˜¯è‡ªå·±ä¸ä¿é‡èº«é«”ï¼Œä¹Ÿæ‡‰ç•¶æ›¿å­©å­åšå€‹æœå¾çš„æ¦œæ¨£ã€‚", act: "ä¸€å¹•", note: "å¼·è¿«ç¹æ¼ªå–è—¥" },
                    { text: "ç¤¦ä¸Šçš„å·¥äººå·²ç¶“åœ¨æ˜¨å¤©æ—©ä¸Šå¾©å·¥ï¼Œä½ ç•¶ä»£è¡¨çš„åè€Œä¸çŸ¥é“éº¼ï¼Ÿ", act: "äºŒå¹•", note: "è³ªå•é­¯å¤§æµ·ï¼ˆå·¥äººä»£è¡¨ï¼‰" },
                    { text: "ä½ å¯ä»¥å†·éœé»ã€‚ç¾åœ¨ä½ æˆ‘éƒ½æ˜¯æœ‰å­å¥³çš„äººï¼Œå¦‚æœä½ è¦ºå¾—å¿ƒè£æœ‰å§”å±ˆï¼Œé€™éº¼å¤§å¹´ç´€ï¼Œæˆ‘å€‘å¯ä»¥å…ˆä¸å¿…å“­å“­å•¼å•¼çš„ã€‚", act: "äºŒå¹•", note: "é¢å°ä¾èæ™‚çš„å†·æ·¡" },
                    { text: "é€™äº›å¹´æˆ‘ç¸½æ˜¯ç•™è‘—é€™äº›å‚¢ä¿±ï¼Œç‚ºè‘—ç´€å¿µä½ ã€‚", act: "äºŒå¹•", note: "å°ä¾èçš„è™›å½" },
                    { text: "ä½ çš„ç”Ÿæ—¥â€”â€”å››æœˆåå…«â€”â€”æ¯å¹´æˆ‘ç¸½è¨˜å¾—ã€‚", act: "äºŒå¹•", note: "å°ä¾èçš„è™›å½æ‡·å¿µ" },
                    { text: "å¾å‰çš„æ©æ€¨ï¼Œéäº†å¹¾åå¹´ï¼Œåˆä½•å¿…å†æå‘¢ï¼Ÿ", act: "äºŒå¹•", note: "æ·¡åŒ–å°ä¾èçš„å‚·å®³" },
                    { text: "é­¯è²´æˆ‘ç¾åœ¨è¦è¾­é€€çš„ï¼Œå››é³³ä¹Ÿè¦å›å®¶ã€‚", act: "ä¸‰å¹•", note: "ç™¼ç¾çœŸç›¸å¾Œçš„æ…Œäº‚" },
                    { text: "ä½ â€”â€”ä¾èï¼Ÿ", act: "äºŒå¹•", note: "èªå‡ºä¾èçš„éœ‡é©š" },
                    { text: "æˆ‘å–œæ­¡é€™èˆŠæˆ¿å­çš„æ¨£å­ï¼Œæˆ‘é¡˜æ„ç¸½æ˜¯ä¸‰åå¹´å‰çš„è€æ¨£å­ï¼Œé€™å«æˆ‘çš„çœ¼çœ‹è‘—èˆ’æœä¸€é»ã€‚", act: "äºŒå¹•", note: "å®‰æ–¼èˆŠæ—¥æƒ…æ™¯" },
                    { text: "æˆ‘ä¸Ÿäº†ä¸€å€‹å…’å­ï¼Œä¸èƒ½å†ä¸Ÿç¬¬äºŒå€‹äº†ã€‚", act: "å››å¹•", note: "å®¶åº­å´©æ½°æ™‚çš„åŸ·è‘—" }
                ],
                'ç¹æ¼ª': [
                    { text: "ä¸€å€‹å¥³å­ï¼Œä½ è¨˜è‘—ï¼Œä¸èƒ½å—å…©ä»£çš„æ¬ºä¾®ï¼Œä½ å¯ä»¥æƒ³ä¸€æƒ³ã€‚", act: "å››å¹•", note: "çµ•æœ›æ™‚å°å‘¨èçš„æ§è¨´" },
                    { text: "é‚£ä½å°ˆå®¶ï¼Œå…‹å¤§å¤«å…ä¸äº†æœƒå¤©å¤©ä¾†çš„ï¼Œè¦æˆ‘åƒè—¥ï¼Œé€¼è‘—æˆ‘åƒè—¥ï¼Œåƒè—¥ï¼Œåƒè—¥ï¼Œåƒè—¥ï¼", act: "ä¸€å¹•", note: "å°è¢«å£“è¿«çš„å­æƒ¡" },
                    { text: "ç†±æ¥µäº†ï¼Œæ‚¶æ¥µäº†ï¼Œé€™è£çœŸæ˜¯å†ä¹Ÿä¸èƒ½ä½çš„ã€‚", act: "ä¸€å¹•", note: "æš—ç¤ºå£“æŠ‘ç’°å¢ƒ" },
                    { text: "æˆ‘å¸Œæœ›æˆ‘ä»Šå¤©è®Šæˆç«å±±çš„å£ï¼Œç†±ç†±çƒˆçƒˆåœ°å†’ä¸€æ¬¡ï¼Œä»€éº¼æˆ‘éƒ½ç‡’å€‹ä¹¾æ·¨ï¼", act: "äºŒå¹•", note: "åæŠ—å®£è¨€" },
                    { text: "æˆ‘ä¸å¾Œæ‚”ï¼Œæˆ‘å‘ä¾†åšäº‹æ²’æœ‰å¾Œæ‚”éã€‚", act: "äºŒå¹•", note: "æƒ…æ„ŸçœŸèª " },
                    { text: "å‘¨å®¶çš„ç©ºæ°£æ»¿æ˜¯ç½ªæƒ¡ï¼Œé€™äº›å¹´æˆ‘çœ‹è¦‹äº†ä»–å€‘æ‰€åšçš„å£äº‹ï¼", act: "ä¸‰å¹•", note: "å°å‘¨å®¶çš„æ­éœ²" },
                    { text: "ä½ æ¬ äº†æˆ‘ä¸€ç­†å‚µï¼Œä½ å°æˆ‘è² è‘—è²¬ä»»ï¼›ä½ ä¸èƒ½çœ‹è¦‹äº†æ–°çš„ä¸–ç•Œï¼Œå°±ä¸€å€‹äººè·‘ã€‚", act: "äºŒå¹•", note: "å°å‘¨èçš„æ§è¨´" },
                    { text: "æˆ‘ä¸æ˜¯ä»–çš„æ¯è¦ªï¼ä¸æ˜¯ï¼Œä¸æ˜¯ï¼Œæˆ‘ä¹Ÿä¸æ˜¯å‘¨æ¨¸åœ’çš„å¦»å­ï¼", act: "ä¸‰å¹•", note: "å°èº«åˆ†çš„å¦å®š" },
                    { text: "é€™è€æˆ¿å­æ°¸é æ˜¯é€™æ¨£æ‚¶æ°£ï¼Œå‚¢ä¿±éƒ½ç™¼äº†é»´ï¼Œäººå€‘ä¹Ÿæ˜¯é¬¼è£é¬¼æ°£çš„ï¼", act: "ä¸€å¹•", note: "å°å‘¨å®¶çš„å­æƒ¡" },
                    { text: "ä½ çˆ¶è¦ªæ˜¯ä»€éº¼æ¨£çš„äººï¼Ÿä»–åšç›¡äº†å£äº‹å¼„éŒ¢ï¼Œä»–è‡ªç„¶å¯ä»¥è¡Œå–„ï¼", act: "äºŒå¹•", note: "æ­éœ²å‘¨æ¨¸åœ’çš„è™›å½" },
                    { text: "ä½ æ—¢çŸ¥é“é€™å®¶åº­å¯ä»¥æ‚¶æ­»äººï¼Œä½ æ€éº¼è‚¯ä¸€å€‹äººèµ°ï¼ŒæŠŠæˆ‘æ”¾åœ¨å®¶è£ï¼Ÿ", act: "äºŒå¹•", note: "å°å‘¨èçš„æŒ‡è²¬" },
                    { text: "ä½ æœ€å°ä¸èµ·çš„æ˜¯æˆ‘ï¼Œæ˜¯ä½ æ›¾ç¶“å¼•èª˜çš„å¾Œæ¯ï¼", act: "ä¸‰å¹•", note: "å°å‘¨èçš„æ§è¨´" },
                    { text: "æˆ‘åœ¨é€™æ¨£çš„é«”é¢å®¶åº­å·²ç¶“åå…«å¹´å•¦ã€‚å‘¨å®¶å®¶åº­è£¡åšå‡ºçš„ç½ªæƒ¡ï¼Œæˆ‘è½éï¼Œæˆ‘è¦‹éï¼Œæˆ‘åšéã€‚", act: "ä¸‰å¹•", note: "æ­éœ²å®¶æ—ç½ªæƒ¡" },
                    { text: "æˆ‘ç¸½è¦ºå¾—é€™æˆ¿å­æœ‰é»éˆæ°£ï¼Œå®ƒæ‹‰è‘—æˆ‘ï¼Œä¸è®“æˆ‘èµ°ã€‚", act: "ä¸‰å¹•", note: "å°å‘½é‹çš„æ„Ÿæ‚Ÿ" },
                    { text: "æ²–å…’ï¼Œä½ è©²æ­»ï¼Œè©²æ­»ï¼ä½ æœ‰äº†é€™æ¨£çš„æ¯è¦ªï¼Œä½ è©²æ­»ã€‚", act: "å››å¹•", note: "æ‚²åŠ‡æ™‚åˆ»" },
                    { text: "æˆ‘åªè¦ä½ èªªï¼šæˆ‘â€”â€”æˆ‘æ˜¯ä½ çš„ã€‚", act: "ä¸‰å¹•", note: "å°å‘¨èçš„æ¸´æ±‚" }
                ],
                'å‘¨è': [
                    { text: "æˆ‘ç¾åœ¨å¿ƒè£å¾ˆäº‚ï¼Œä½ ä¸çŸ¥é“é€™å±‹å­é¬§é¬¼éº¼ï¼Ÿ", act: "ä¸‰å¹•", note: "å…§å¿ƒä¸å®‰" },
                    { text: "æˆ‘å¤ äº†ï¼Œæˆ‘æ˜¯æ´»å­äº†çš„äººã€‚", act: "äºŒå¹•", note: "äººç”Ÿå­å€¦" },
                    { text: "æˆ‘è¦é›¢é–‹é€™å…’ï¼Œé€™å±‹å­è£çš„æ­»æ°£æœƒæŠŠæˆ‘æ‚¶æ­»çš„ï¼", act: "äºŒå¹•", note: "æ¸´æœ›é›¢é–‹" },
                    { text: "æˆ‘çš„å¿ƒéƒ½æ­»äº†ï¼Œæˆ‘æ¨æ¥µäº†æˆ‘è‡ªå·±ï¼", act: "äºŒå¹•", note: "å…§å¿ƒç—›è‹¦" },
                    { text: "é€™äº›è©±å¤šå°‘å¹´æˆ‘å°èª°ä¹Ÿèªªä¸å‡ºçš„ï¼Œç„¶è€Œï¼Œå¥‡æ€ªï¼Œæˆ‘å¿½ç„¶è·Ÿä½ èªªäº†ã€‚", act: "äºŒå¹•", note: "å°ç¹æ¼ªçš„æ•é–‹å¿ƒæ‰‰" },
                    { text: "é³³å…’ï¼Œä½ ä»¥ç‚ºæˆ‘é€™éº¼è‡ªç§è‡ªåˆ©éº¼ï¼Ÿä½ ä¸æ‡‰è©²é€™æ¨£æƒ³æˆ‘ï¼", act: "ä¸‰å¹•", note: "å°å››é³³çš„è¾¯è§£" },
                    { text: "æˆ‘å­æƒ¡é€™ç¨®ä¸è‡ªç„¶çš„é—œä¿‚ï¼Œæˆ‘è² èµ·æˆ‘çš„è²¬ä»»ï¼Œæˆ‘æ‰¿èªæˆ‘é‚£æ™‚çš„éŒ¯ï¼", act: "äºŒå¹•", note: "å°ç¹æ¼ªçš„æ‰¿èª" },
                    { text: "çˆ¶è¦ªçš„è©±ï¼Œå‘ä¾†ä¸èƒ½æ”¹çš„ã€‚ä»–çš„æ„è¦‹å°±æ˜¯æ³•å¾‹ï¼", act: "äºŒå¹•", note: "å°çˆ¶è¦ªçš„å£“åˆ¶" },
                    { text: "æˆ‘å¾Œæ‚”ï¼Œæˆ‘èªç‚ºæˆ‘ç”Ÿå¹³åšéŒ¯ä¸€ä»¶å¤§äº‹ï¼Œæˆ‘å°ä¸èµ·è‡ªå·±ï¼Œå°ä¸èµ·å¼Ÿå¼Ÿï¼Œæ›´å°ä¸èµ·çˆ¶è¦ªï¼", act: "äºŒå¹•", note: "æ‚”æ¨" },
                    { text: "å››é³³ï¼Œä½ é¥’æ•æˆ‘éº¼ï¼Ÿæˆ‘ä¸¦ä¸æ€¨ä½ ï¼Œæˆ‘çŸ¥é“æ—©æ™šæ˜¯æœ‰é€™éº¼ä¸€å¤©çš„ï¼", act: "å››å¹•", note: "å¾—çŸ¥çœŸç›¸å¾Œ" },
                    { text: "ä½ ç˜‹äº†ï¼é€™ç¨®å­—å¥ä¸æ˜¯åœ¨çˆ¶è¦ªé€™æ¨£é«”é¢çš„å®¶åº­è£èªªçš„ï¼", act: "äºŒå¹•", note: "è™›å½ç¶­è­·" },
                    { text: "æˆ‘è¦èµ°äº†ï¼Œæˆ‘ç¾åœ¨è¦æ”¶æ‹¾æ±è¥¿å»ï¼", act: "ä¸‰å¹•", note: "æ±ºå®šé›¢é–‹" },
                    { text: "çˆ¸ï¼Œä½ ä¸è©²ç”Ÿæˆ‘ï¼", act: "å››å¹•", note: "æ‚²åŠ‡é ‚é»" },
                    { text: "æˆ‘è¦ºå¾—æˆ‘åƒåœ¨åšå¤¢ã€‚", act: "ä¸‰å¹•", note: "å›°æƒ‘ä¸è§£" },
                    { text: "æˆ‘å–é…’ï¼Œèƒ¡é¬§ï¼Œæˆ‘åªè¦é›¢é–‹å¥¹ï¼Œæˆ‘æ­»éƒ½é¡˜æ„ã€‚", act: "ä¸‰å¹•", note: "çµ•æœ›é€ƒé¿" }
                ],
                'é­¯ä¾è': [
                    { text: "å‘½ï¼ä¸å…¬å¹³çš„å‘½æŒ‡ä½¿æˆ‘ä¾†çš„ï¼", act: "äºŒå¹•", note: "èªå‡ºå‘¨æ¨¸åœ’æ™‚" },
                    { text: "æˆ‘æ‚¶äº†ä¸‰åå¹´äº†ï¼ä½ çµäº†å©šï¼Œå°±æ¬äº†å®¶ï¼Œæˆ‘ä»¥ç‚ºé€™ä¸€è¼©å­ä¹Ÿè¦‹ä¸è‘—ä½ äº†ï¼", act: "äºŒå¹•", note: "å°å‘¨æ¨¸åœ’çš„æ§è¨´" },
                    { text: "å‘¨å®¶çš„ç©ºæ°£æ»¿æ˜¯ç½ªæƒ¡ï¼Œæˆ‘çš„å¥³å…’èªªä»€éº¼ä¹Ÿä¸èƒ½åœ¨é€™å…’å¤šå‘†ï¼", act: "äºŒå¹•", note: "ä¿è­·å¥³å…’" },
                    { text: "æˆ‘çš„çœ¼æ·šæ—©å“­å¹¹äº†ï¼Œæˆ‘æ²’æœ‰å§”å±ˆï¼Œæœ‰çš„æ˜¯æ¨ï¼Œæ˜¯æ‚”ï¼Œæ˜¯ä¸‰åå¹´ä¸€å¤©ä¸€å¤©æˆ‘è‡ªå·±å—çš„è‹¦ï¼", act: "äºŒå¹•", note: "æ§è¨´å‘½é‹" },
                    { text: "æˆ‘é€™äº›å¹´çš„è‹¦ä¸æ˜¯ä½ é‚£éŒ¢å°±ç®—å¾—æ¸…çš„ï¼", act: "äºŒå¹•", note: "æ‹’çµ•è£œå„Ÿ" },
                    { text: "ä¸‰åå¹´å‰ï¼Œéå¹´ä¸‰åçš„æ™šä¸Šæˆ‘ç”Ÿä¸‹ä½ çš„ç¬¬äºŒå€‹å…’å­æ‰ä¸‰å¤©ï¼Œä½ å€‘é€¼è‘—æˆ‘å†’è‘—å¤§é›ªå‡ºå»ï¼", act: "äºŒå¹•", note: "æ­éœ²å¾€äº‹" },
                    { text: "å“¦ï¼Œå¤©çŸ¥é“èª°çŠ¯äº†ç½ªï¼Œèª°é€ é€™ç¨®å­½ï¼â€”â€”ä»–å€‘éƒ½æ˜¯å¯æ†çš„å­©å­ï¼Œä¸çŸ¥é“è‡ªå·±åšçš„æ˜¯ä»€éº¼ã€‚", act: "å››å¹•", note: "æ‚²åŠ‡é ‚é»" },
                    { text: "æˆ‘ç¾åœ¨è€äº†ï¼Œå«çµ¦ä¸€å€‹ä¸‹ç­‰äººï¼Œåˆç”Ÿäº†å€‹å¥³å­©ï¼Œå¢ƒæ³å¾ˆä¸å¥½ã€‚", act: "äºŒå¹•", note: "ä½å¾®è™•å¢ƒ" },
                    { text: "é€™åœ°æ–¹æ€ªå¾—å¾ˆï¼Œé€™å±‹å­æˆ‘åƒæ˜¯åœ¨å“ªå…’è¦‹éçš„ï¼", act: "äºŒå¹•", note: "å‘½é‹çš„å·§åˆ" },
                    { text: "é€™æ˜¯æˆ‘çš„å ±æ‡‰ï¼Œæˆ‘çš„å ±æ‡‰ã€‚", act: "å››å¹•", note: "è‡ªè²¬" },
                    { text: "å¤©åº•ä¸‹åœ°æ–¹å¤§å¾—å¾ˆï¼Œæ€éº¼ï¼Ÿç†¬éé€™å¹¾åå¹´åååˆæŠŠæˆ‘é€™å€‹å¯æ†çš„å­©å­ï¼Œæ”¾å›åˆ°ä»–â€”â€”ä»–çš„å®¶è£¡ï¼Ÿå“¦ï¼Œå¥½ä¸å…¬å¹³çš„å¤©å“ªï¼", act: "ä¸‰å¹•", note: "å‘½é‹è«·åˆº" },
                    { text: "ä»–å€‘éƒ½æ˜¯æˆ‘çš„ä¹¾æ·¨å­©å­ï¼Œä»–å€‘æ‡‰ç•¶å¥½å¥½åœ°æ´»è‘—ï¼Œäº«è‘—ç¦ã€‚å†¤å­½æ˜¯åœ¨æˆ‘å¿ƒè£¡é ­ï¼Œè‹¦ä¹Ÿæ‡‰ç•¶æˆ‘ä¸€å€‹äººå˜—ã€‚", act: "å››å¹•", note: "æ¯æ„›" },
                    { text: "äººçŠ¯äº†ä¸€æ¬¡ç½ªéï¼Œç¬¬äºŒæ¬¡ä¹Ÿå°±è‡ªåœ°è·Ÿè‘—ä¾†ã€‚", act: "ä¸‰å¹•", note: "æ‚”æ¨" }
                ],
                'å››é³³': [
                    { text: "æˆ‘æ­»ä¹Ÿä¸èƒ½å«åª½çŸ¥é“é€™å…’é€™äº›äº‹æƒ…çš„ï¼", act: "ä¸‰å¹•", note: "éš±çæ¯è¦ª" },
                    { text: "å“¥å“¥ï¼Œé€™å±‹å­é¬§é¬¼ï¼Œæˆ‘æ€•ï¼", act: "ä¸‰å¹•", note: "ææ‡¼" },
                    { text: "è€çˆºçš„è„¾æ°£æ‚¨å¯çŸ¥é“ï¼Œæ‚¨é€™æ¨£éš¨éš¨ä¾¿ä¾¿æŠ¹äº†å…©ä¸‹ï¼Œçš®é‹èƒ½æ“¦å¥½å—ï¼Ÿ", act: "äºŒå¹•", note: "å°é­¯è²´çš„æé†’" },
                    { text: "åª½ï¼Œæ‚¨åˆ¥çèªªï¼Œé€™å±‹å­æ€éº¼æœƒè¦‹éï¼Ÿæ‚¨æ˜¯æƒ³æˆ‘æƒ³çš„å¤¢è£åˆ°éé€™å…’ï¼", act: "äºŒå¹•", note: "å°æ¯è¦ªçš„å®‰æ…°" },
                    { text: "å¤©æ°£é€™æ¨£æ‚¶ç†±ï¼Œå›é ­å¤šåŠä¸‹é›¨ã€‚", act: "ä¸€å¹•", note: "é ç¤ºé›·é›¨" },
                    { text: "è·Ÿä½ ç¸«è¡£æœï¼Œç‡’é£¯åšèœï¼Œæˆ‘éƒ½åšå¾—å¥½ï¼åªè¦ä½ å«æˆ‘è·Ÿä½ åœ¨ä¸€å—å„¿ã€‚", act: "ä¸‰å¹•", note: "å°å‘¨èçš„æ„›" },
                    { text: "èï¼Œä½ ä¸è¦é€™æ¨£å¾…æˆ‘å¥½ä¸å¥½ï¼Ÿä½ æ˜æ˜çŸ¥é“æˆ‘ç¾åœ¨ä»€éº¼éƒ½æ˜¯ä½ çš„ï¼", act: "ä¸‰å¹•", note: "æƒ…æ„Ÿè«‹æ±‚" },
                    { text: "é‚£â€”â€”é‚£å¤©ä¸Šçš„é›·åŠˆäº†æˆ‘ã€‚", act: "å››å¹•", note: "å¾—çŸ¥çœŸç›¸æ™‚" },
                    { text: "æˆ‘ç­”æ‡‰æ‚¨ï¼Œä»¥å¾Œæˆ‘æ°¸é ä¸è¦‹å‘¨å®¶çš„äººã€‚", act: "ä¸‰å¹•", note: "å°æ¯è¦ªçš„æ‰¿è«¾" },
                    { text: "èï¼Œä½ å¸¶æˆ‘èµ°ï¼æˆ‘ä¸é€£ç´¯ä½ ï¼Œè¦æ˜¯å¤–é¢å› ç‚ºæˆ‘ï¼Œèªªä½ çš„å£è©±ï¼Œæˆ‘ç«‹åˆ»å°±èµ°ã€‚", act: "ä¸‰å¹•", note: "è«‹æ±‚å¸¶èµ°" },
                    { text: "åª½ï¼Œæ‚¨é¡˜æ„æ‚¨çš„å¥³å…’æ€¥å¾—è¦æ­»åœ¨æ‚¨çš„çœ¼å‰éº¼ï¼Ÿ", act: "ä¸‰å¹•", note: "å°æ¯è¦ªçš„ç—›è‹¦" },
                    { text: "æˆ‘æƒ³èµ·ä¾†ï¼Œä¸–ç•Œå¤§å¾—å¾ˆï¼Œæˆ‘å€‘å¯ä»¥èµ°ï¼Œæˆ‘å€‘åªè¦ä¸€å¡Šå…’é›¢é–‹é€™å…’ã€‚", act: "ä¸‰å¹•", note: "é€ƒé›¢é¡˜æœ›" },
                    { text: "èï¼Œä»¥å¾Œæˆ‘å€‘æ°¸é åœ¨ä¸€å¡Šå…’äº†ï¼Œä¸åˆ†é–‹äº†ã€‚", act: "å››å¹•", note: "æ‚²åŠ‡å‰é ç¤º" }
                ],
                'å‘¨æ²–': [
                    { text: "çˆ¶è¦ªå°ä¸èµ·æ‚¨ï¼Œå¯æ˜¯ä»–è€äº†ï¼Œæˆ‘æ˜¯æ‚¨çš„å°‡ä¾†ï¼Œæˆ‘è¦å¨¶ä¸€å€‹é ‚å¥½çš„äººã€‚", act: "ä¸‰å¹•", note: "å°æ¯è¦ªçš„æ‰¿è«¾" },
                    { text: "æœ‰æ™‚æˆ‘å°±å¿˜äº†ç¾åœ¨ï¼Œå¿˜äº†å®¶ï¼Œå¿˜äº†ä½ ï¼Œå¿˜äº†æ¯è¦ªï¼Œä¸¦ä¸”å¿˜äº†æˆ‘è‡ªå·±ã€‚", act: "ä¸‰å¹•", note: "é€ƒé¿ç¾å¯¦" },
                    { text: "æˆ‘æƒ³ï¼Œæˆ‘åƒæ˜¯åœ¨ä¸€å€‹å†¬å¤©çš„æ—©æ™¨ï¼Œéå¸¸æ˜äº®çš„å¤©ç©ºï¼Œâ€¦â€¦åœ¨ç„¡é‚Šçš„æµ·ä¸Šâ€¦â€¦æœ‰ä¸€æ¢è¼•å¾—æƒ³æµ·ç‡•ä¼¼çš„å°å¸†èˆ¹ã€‚", act: "ä¸€å¹•", note: "ç†æƒ³å¹»æƒ³" },
                    { text: "çœŸçš„æ„›æƒ…å…ä¸äº†æ³¢æŠ˜ï¼Œæˆ‘æ„›å¥¹ï¼Œå¥¹æœƒæ¼¸æ¼¸åœ°æ˜ç™½æˆ‘ï¼Œå–œæ­¡æˆ‘çš„ã€‚", act: "ä¸‰å¹•", note: "å°å››é³³çš„æ„›" },
                    { text: "æˆ‘æ¨é€™ä¸å¹³ç­‰çš„ç¤¾æœƒï¼Œæˆ‘æ¨åªè¬›å¼·æ¬Šçš„äººï¼Œæˆ‘è¨å­æˆ‘çš„çˆ¶è¦ªï¼Œæˆ‘å€‘éƒ½æ˜¯è¢«å£“è¿«çš„äººï¼Œæˆ‘å€‘æ˜¯ä¸€æ¨£ã€‚", act: "ä¸‰å¹•", note: "åæŠ—ç²¾ç¥" },
                    { text: "ç•Œå¤§çš„å¾ˆï¼Œä½ æ‡‰ç•¶è®€æ›¸ï¼Œä½ å°±çŸ¥é“ä¸–ç•Œä¸Šæœ‰éè¨±å¤šäººè·Ÿæˆ‘å€‘ä¸€æ¨£åœ°å¿å—è‘—ç—›è‹¦ï¼Œæ…¢æ…¢åœ°è‹¦å¹¹ï¼Œä»¥å¾Œåˆå¾—åˆ°å¿«æ¨‚ã€‚", act: "ä¸‰å¹•", note: "é¼“å‹µå››é³³" },
                    { text: "æˆ‘èªç‚ºä½ çš„åè¦‹å¤ªå¤šã€‚", act: "ä¸‰å¹•", note: "å°æ¯è¦ªçš„åé§" },
                    { text: "æˆ‘å¸Œæœ›çˆ¶è¦ªå…è¨±æˆ‘æŠŠæˆ‘çš„æ•™è‚²è²»åˆ†çµ¦å¥¹ä¸€åŠä¸Šå­¸ã€‚", act: "ä¸‰å¹•", note: "å°å››é³³çš„é—œå¿ƒ" },
                    { text: "çˆ¸ï¼Œæ‚¨ä½•å¿…é€™æ¨£å¼·è¿«å‘¢ï¼Ÿ", act: "ä¸€å¹•", note: "åå°çˆ¶è¦ª" },
                    { text: "ä¸ï¼Œä½ æŠŠå¥¹å¸¶èµ°å§ï¼Œåªè¦ä½ å¥½å¥½åœ°å¾…å¥¹ï¼", act: "ä¸‰å¹•", note: "å°é­¯è²´çš„è«‹æ±‚" },
                    { text: "å†è¦‹ï¼Œæˆ‘åŸè«’ä½ ã€‚æˆ‘é‚„æ˜¯é¡˜æ„åšä½ çš„æœ‹å‹ã€‚", act: "ä¸‰å¹•", note: "å°é­¯è²´çš„å¯¬å®¹" },
                    { text: "æ‚¨ä¸æ˜¯ä¸€å€‹å¹³å¸¸çš„æ¯è¦ªï¼Œæ‚¨æœ€å¤§è†½ï¼Œæœ€æœ‰æƒ³åƒï¼Œåˆï¼Œæœ€åŒæƒ…æˆ‘çš„æ€æƒ³çš„ã€‚", act: "ä¸€å¹•", note: "å°ç¹æ¼ªçš„å–œæ„›" },
                    { text: "å¥¹æ˜¯æœ€ç´”æ½”ï¼Œæœ€æœ‰ä¸»å¼µçš„å¥½å­©å­ï¼Œæ˜¨å¤©æˆ‘è·Ÿå¥¹æ±‚å©šâ€”â€”", act: "ä¸‰å¹•", note: "å°æ¯è¦ªè¨´èªª" },
                    { text: "ä¸ï¼Œä½ ä¸è¦é€™æ¨£èªªè©±ï¼Œç¾åœ¨çš„ä¸–ç•Œæ˜¯ä¸è©²å­˜åœ¨çš„ã€‚", act: "ä¸‰å¹•", note: "ç†æƒ³ä¸»ç¾©" }
                ]
            };
            
            // æ›´æ–°è§’è‰²èƒ½åŠ›ç‹€æ…‹ - å¢å¼·ç‰ˆè¦–è¦ºåé¥‹
            function updateAbilityStatus() {
                if (!isGameRunning) return;
                
                const abilityStatus = document.getElementById('ability-status');
                const abilityCooldownBar = document.getElementById('ability-cooldown-bar');
                const abilityTimer = document.getElementById('ability-timer');
                
                if (!abilityStatus || !abilityCooldownBar) return;
                
                if (abilityActive) {
                    // èƒ½åŠ›æ¿€æ´»ç‹€æ…‹
                    abilityStatus.textContent = 'ç”Ÿæ•ˆä¸­';
                    abilityStatus.className = 'ml-1.5 px-2 py-0.5 bg-gradient-to-r from-green-600 to-green-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap status-pulse';
                    
                    // æ›´æ–°æŒçºŒæ™‚é–“é€²åº¦æ¢
                    const percent = abilityDuration / getAbilityDuration() * 100;
                    abilityCooldownBar.style.width = `${percent}%`;
                    abilityCooldownBar.className = 'h-full bg-gradient-to-r from-green-500 to-green-400 rounded-full transition-all duration-300';
                    
                    // é¡¯ç¤ºå‰©é¤˜æ™‚é–“
                    const remainingSeconds = Math.ceil(abilityDuration / 60);
                    if (abilityTimer) {
                        abilityTimer.textContent = `å‰©é¤˜ ${remainingSeconds}s`;
                        abilityTimer.className = 'absolute right-0 -top-5 text-[9px] text-green-300 font-bold';
                    }
                    
                    // æ¸›å°‘æŒçºŒæ™‚é–“
                    abilityDuration--;
                    if (abilityDuration <= 0) {
                        deactivateAbility();
                    }
                } else if (abilityCooldown) {
                    // å†·å»ç‹€æ…‹
                    abilityStatus.textContent = 'å†·å»ä¸­';
                    abilityStatus.className = 'ml-1.5 px-2 py-0.5 bg-gradient-to-r from-red-600 to-red-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap';
                    
                    // æ›´æ–°å†·å»é€²åº¦æ¢
                    const percent = (1 - abilityCooldownTime / getAbilityCooldown()) * 100;
                    abilityCooldownBar.style.width = `${percent}%`;
                    abilityCooldownBar.className = 'h-full bg-gradient-to-r from-red-500 to-red-400 rounded-full transition-all duration-300';
                    
                    // é¡¯ç¤ºå†·å»å€’è¨ˆæ™‚
                    const remainingSeconds = Math.ceil(abilityCooldownTime / 60);
                    if (abilityTimer) {
                        abilityTimer.textContent = `å†·å» ${remainingSeconds}s`;
                        abilityTimer.className = 'absolute right-0 -top-5 text-[9px] text-red-300 font-bold';
                    }
                    
                    // æ¸›å°‘å†·å»æ™‚é–“
                    abilityCooldownTime--;
                    if (abilityCooldownTime <= 0) {
                        abilityCooldown = false;
                        // èƒ½åŠ›å°±ç·’æ™‚çš„è¦–è¦ºæç¤º
                        showAbilityReadyNotification();
                    }
                } else {
                    // å°±ç·’ç‹€æ…‹
                    abilityStatus.textContent = 'å°±ç·’';
                    abilityStatus.className = 'ml-1.5 px-2 py-0.5 bg-gradient-to-r from-blue-600 to-blue-500 rounded-full text-[9px] font-medium shadow-sm whitespace-nowrap status-pulse';
                    abilityCooldownBar.style.width = '100%';
                    abilityCooldownBar.className = 'h-full bg-gradient-to-r from-primary to-blue-400 rounded-full transition-all duration-300';
                    
                    // æ¸…é™¤å€’è¨ˆæ™‚é¡¯ç¤º
                    if (abilityTimer) {
                        abilityTimer.textContent = '';
                    }
                }
            }
            
            // èƒ½åŠ›å°±ç·’é€šçŸ¥
            function showAbilityReadyNotification() {
                const notification = document.createElement('div');
                notification.className = 'absolute top-1/4 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-blue-600 to-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-30 text-sm font-bold';
                notification.innerHTML = `
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                            <path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 01.359.852L12.982 9.75h7.268a.75.75 0 01.548 1.262l-10.5 11.25a.75.75 0 01-1.272-.71l1.992-7.302H3.75a.75.75 0 01-.548-1.262l10.5-11.25a.75.75 0 01.913-.143z" clip-rule="evenodd" />
                        </svg>
                        <div>
                            <div>${characterAbility} å°±ç·’!</div>
                            <div class="text-xs opacity-80">æŒ‰ç©ºæ ¼éµæ¿€æ´»</div>
                        </div>
                    </div>
                `;
                
                gameContainer.appendChild(notification);
                
                // æ’­æ”¾å°±ç·’éŸ³æ•ˆ
                playThunderSound('button');
                
                // å‹•ç•«æ•ˆæœ
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    notification.style.transition = 'all 0.5s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 500);
                }, 2000);
            }
            
            // ç²å–èƒ½åŠ›æŒçºŒæ™‚é–“ - å¹³è¡¡æŒçºŒæ™‚é–“
            function getAbilityDuration() {
                switch (characterAbility) {
                    case 'å¨æ¬ŠåŠ›å ´': return 480; // 8ç§’
                    case 'æƒ…æ„Ÿåº‡è­·': return 180; // 3ç§’
                    case 'é’æ˜¥è¡åˆº': return 240; // 4ç§’
                    case 'å„ªæŸ”ç¬ç§»': return 1; // ç¬é–“æ•ˆæœ
                    case 'é çŸ¥é–ƒé¿': return 720; // 12ç§’ (å¤§å¹…å»¶é•·æŒçºŒæ™‚é–“)
                    default: return 240; // 4ç§’
                }
            }
            
            // ç²å–èƒ½åŠ›å†·å»æ™‚é–“ - é€²ä¸€æ­¥ç¸®çŸ­å†·å»æ™‚é–“æå‡éŠæˆ²é«”é©—
            function getAbilityCooldown() {
                switch (characterAbility) {
                    case 'å¨æ¬ŠåŠ›å ´': return 600; // 10ç§’ (é¡¯è‘—ç¸®çŸ­)
                    case 'éš±å¿å …éŸŒ': return 900; // 15ç§’ (é¡¯è‘—ç¸®çŸ­)
                    case 'å„ªæŸ”ç¬ç§»': return 480; // 8ç§’ (é¡¯è‘—ç¸®çŸ­)
                    case 'é’æ˜¥è¡åˆº': return 360; // 6ç§’ (é¡¯è‘—ç¸®çŸ­)
                    case 'æƒ…æ„Ÿåº‡è­·': return 480; // 8ç§’ (é¡¯è‘—ç¸®çŸ­)
                    case 'é çŸ¥é–ƒé¿': return 600; // 10ç§’ (é¡¯è‘—ç¸®çŸ­)
                    default: return 600; // 10ç§’
                }
            }
            
            // æ¿€æ´»è§’è‰²èƒ½åŠ› - å¢å¼·ç‰ˆæœ¬
            function activateAbility() {
                if (abilityActive || abilityCooldown) return;
                
                abilityActive = true;
                abilityDuration = getAbilityDuration();
                
                // æ ¹æ“šä¸åŒè§’è‰²æ‡‰ç”¨ä¸åŒèƒ½åŠ›æ•ˆæœ
                switch (characterAbility) {
                    case 'å¨æ¬ŠåŠ›å ´':
                        // æ¸›ç·©é–ƒé›»ä¸‹è½é€Ÿåº¦ - æ•ˆæœå¢å¼·è‡³50%
                        activeEffects.slowLightningFall = true;
                        
                        // æ–°å¢åŠŸèƒ½ï¼šå¨åš´å ´é˜»éš”é“å…·ï¼Œè² é¢é“å…·ç„¡æ³•æ¥è¿‘
                        activeEffects.blockNegativeItems = true;
                        
                        // è¦–è¦ºæ•ˆæœ - å¨åš´å…‰ç’°ï¼ˆæ”¹é€²ç‰ˆï¼‰
                        createPressureField(true);
                        
                        // æ–°å¢ï¼šå¨åš´å ´ä¸­å¢å¼·æ­£é¢é“å…·æ•ˆæœ
                        activeEffects.enhancePositiveItems = true;
                        
                        // éŸ³æ•ˆå’Œéœ‡å‹•æ•ˆæœ
                        playThunderSound('ability_å‘¨æ¨¸åœ’');
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('æ¸›ç·©é–ƒé›»50% | é˜»éš”è² é¢é“å…·', '#FFC107');
                        break;
                        
                    case 'å„ªæŸ”ç¬ç§»':
                        // èƒ½åŠ›æ”¹é€²ï¼šç©å®¶å¯é¸æ“‡ç¬ç§»ä½ç½®
                        // å‰µå»ºç¬ç§»é¸æ“‡å™¨
                        createTeleportSelector();
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('é¸æ“‡ç¬ç§»ä½ç½® + çŸ­æš«ç„¡æ•µ', '#3399CC');
                        
                        // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                        playThunderSound('ability_å‘¨è');
                        break;
                        
                    case 'é’æ˜¥è¡åˆº':
                        // é’æ˜¥è¡åˆºæ•ˆæœ - å¤§å¹…æå‡é€Ÿåº¦
                        activeEffects.youthSprint = true;
                        
                        // æ–°å¢åŠŸèƒ½ï¼šè¡åˆºéç¨‹ä¸­æš«æ™‚ç„¡è¦–é–ƒé›»ç¢°æ’
                        activeEffects.dashInvincibility = true;
                        
                        // æ¸…é™¤ä»»ä½•å·²å­˜åœ¨çš„ç²’å­æ•ˆæœå’Œé€Ÿåº¦ç·š
                        const oldEffect = document.getElementById('sprint-effect');
                        if (oldEffect) oldEffect.remove();
                        
                        const oldLines = document.getElementById('speed-lines-container');
                        if (oldLines) oldLines.remove();
                        
                        if (activeEffects.sprintParticles) {
                            activeEffects.sprintParticles.stop();
                            delete activeEffects.sprintParticles;
                        }
                        
                        // ç¾åœ¨å‰µå»ºæ–°çš„ç²’å­æ•ˆæœï¼Œåªåœ¨èƒ½åŠ›æ¿€æ´»æ™‚
                        createSprintEffect(true);
                        
                        // æ·»åŠ åœ°é¢è¡æ“Šæ³¢æ•ˆæœ
                        createGroundWave();
                        
                        // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                        playThunderSound('ability_å‘¨æ²–');
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('é€Ÿåº¦+200% | è¡åˆºæ™‚ç„¡è¦–é–ƒé›»', '#66CCFF');
                        break;
                        
                    case 'éš±å¿å …éŸŒ':
                        // æ”¹é€²ï¼šéš±å¿å …éŸŒæä¾›å¤šé‡ä¿è­·
                        activeEffects.damageReduction = true; // å‚·å®³æ¸›å…
                        activeEffects.oneTimeImmunity = true; // ä¿ç•™å®Œå…¨å…ç–«
                        
                        // æ–°å¢ï¼šå¸æ”¶é–ƒé›»ç²å¾—ç©åˆ†
                        activeEffects.absorbLightning = true;
                        
                        // è¦–è¦ºæ•ˆæœ - æ›´å¼·çš„è­·ç›¾
                        createResilienceEffect(true);
                        
                        // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                        playThunderSound('ability_é­¯ä¾è');
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('å …éŸŒä¹‹ç›¾ | é–ƒé›»å‚·å®³è½‰ç‚ºç©åˆ†', '#9C27B0');
                        break;
                        
                    case 'æƒ…æ„Ÿåº‡è­·':
                        // æ”¹é€²ï¼šæƒ…æ„Ÿæ®˜å½±å…·æœ‰å¸å¼•é–ƒé›»çš„èƒ½åŠ›
                        activeEffects.createAfterimagePath = true;
                        activeEffects.decoyAttractsLightning = true;
                        
                        // æ–°å¢æ•ˆæœï¼šæƒ…æ„ŸåŠ›å ´ä¿è­·è§’è‰²
                        activeEffects.emotionalShield = true;
                        
                        // æ¸…é™¤ç¾æœ‰æ®˜å½±
                        const allDecoys = document.querySelectorAll('.character-decoy');
                        allDecoys.forEach(decoy => decoy.remove());
                        
                        // æ·»åŠ æƒ…æ„Ÿè­·ç›¾è¦–è¦ºæ•ˆæœ - å¼·åŒ–ç‰ˆ
                        createShieldEffect('#E91E63', true);
                        
                        // å‰µå»ºæƒ…æ„Ÿç²’å­ç³»çµ±
                        createEmotionalParticles();
                        
                        // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                        playThunderSound('ability_ç¹æ¼ª');
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('æ®˜å½±å¸å¼•é–ƒé›» | æ¸›å°‘30%å‚·å®³', '#E91E63');
                        break;
                        
                    case 'é çŸ¥é–ƒé¿':
                        // æ”¹é€²ï¼šé çŸ¥é–ƒé¿æä¾›æ™‚é–“æ¸›ç·©æ•ˆæœ
                        activeEffects.enhancedWarning = true;
                        activeEffects.timeSlowdown = true;
                        
                        // æ–°å¢ï¼šæ¸…é™¤å±å¹•ä¸Šç•¶å‰çš„æ‰€æœ‰é–ƒé›»
                        activeEffects.clearCurrentLightning = true;
                        clearActiveLightning();
                        
                        // é¡¯ç¤ºæ™‚é–“æ¸›ç·©è¦–è¦ºæ•ˆæœ
                        createTimeslowEffect();
                        
                        // é è¦½å¤šå€‹æœªä¾†é–ƒé›»ä½ç½®
                        showAllFutureLightningWarnings(true);
                        
                        // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                        playThunderSound('ability_å››é³³');
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('é è¦‹æœªä¾† | æ™‚é–“æ¸›ç·©20%', '#FFCC66');
                        break;
                }
                
                // ä¸»è¦æ¿€æ´»éŸ³æ•ˆï¼ˆå¦‚æœæœªæ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆï¼‰
                if (!['å¨æ¬ŠåŠ›å ´', 'å„ªæŸ”ç¬ç§»', 'é’æ˜¥è¡åˆº', 'éš±å¿å …éŸŒ', 'æƒ…æ„Ÿåº‡è­·', 'é çŸ¥é–ƒé¿'].includes(characterAbility)) {
                    playThunderSound('button');
                }
                
                // æ¿€æ´»æ™‚çš„å±å¹•æ•ˆæœ
                gameContainer.classList.add('screen-flash');
                setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
            }
            
            // æ¸…é™¤ç•¶å‰æ‰€æœ‰é–ƒé›» - æ–°åŠŸèƒ½
            function clearActiveLightning() {
                // æ¨™è¨˜æ‰€æœ‰é–ƒé›»ç‚ºéæ´»å‹•
                lightning.forEach(bolt => {
                    // å‰µå»ºæ¶ˆæ•£æ•ˆæœ
                    createLightningDissipateEffect(bolt.x, bolt.y, bolt.width, bolt.height);
                    bolt.active = false;
                });
                
                // æ¸…ç©ºé–ƒé›»æ•¸çµ„
                lightning = [];
                
                // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                playThunderSound('big');
            }
            
            // å‰µå»ºé–ƒé›»æ¶ˆæ•£æ•ˆæœ
            function createLightningDissipateEffect(x, y, width, height) {
                // ç‚ºæ¯å€‹é–ƒé›»å‰µå»ºæ¶ˆæ•£ç²’å­æ•ˆæœ
                const dissipateParticles = new ParticleSystem('game-container', {
                    maxParticles: 30,
                    particleSize: { min: 2, max: 4 },
                    speed: { min: 0.5, max: 2 },
                    colors: ['#FFFF99', '#FFFFFF', '#FFFFCC'],
                    duration: 1000,
                    spread: { x: width, y: height },
                    gravity: 0,
                    friction: 0.98,
                    blendMode: 'screen',
                    shape: 'circle',
                    behavior: 'spiral'
                });
                
                // åœ¨é–ƒé›»ä½ç½®å•Ÿå‹•ç²’å­æ•ˆæœ
                dissipateParticles.start(x + width/2, y + height/2);
                
                // çŸ­æ™‚é–“å¾Œåœæ­¢ä¸¦ç§»é™¤ç²’å­æ•ˆæœ
                setTimeout(() => {
                    if (dissipateParticles) {
                        dissipateParticles.stop();
                    }
                }, 1000);
            }
            
            // å‰µå»ºç¬ç§»é¸æ“‡å™¨ - å„ªæŸ”ç¬ç§»èƒ½åŠ›å¢å¼·
            function createTeleportSelector() {
                // å‰µå»ºç¬ç§»é¸æ“‡å®¹å™¨
                const selectorContainer = document.createElement('div');
                selectorContainer.id = 'teleport-selector';
                selectorContainer.className = 'absolute bottom-0 w-full pointer-events-none z-20';
                selectorContainer.style.height = `${gameHeight - 40}px`;
                
                // å‰µå»º3å€‹å¯èƒ½çš„ç¬ç§»ä½ç½®é¸é …
                const positions = [
                    { x: gameWidth * 0.25, label: 'å·¦å´' },
                    { x: gameWidth * 0.5, label: 'ä¸­å¤®' },
                    { x: gameWidth * 0.75, label: 'å³å´' }
                ];
                
                // åœ¨ç•¶å‰ä½ç½®å‰µå»ºæ¨™è¨˜
                const currentMarker = document.createElement('div');
                currentMarker.className = 'absolute bottom-0 flex flex-col items-center';
                currentMarker.style.left = `${characterX}px`;
                currentMarker.style.transform = 'translateX(-50%)';
                
                const currentDot = document.createElement('div');
                currentDot.className = 'w-3 h-3 rounded-full bg-blue-400';
                currentMarker.appendChild(currentDot);
                
                // ç•¶å‰ä½ç½®æ–‡å­—
                const currentLabel = document.createElement('div');
                currentLabel.className = 'text-xs text-blue-400 mt-1';
                currentLabel.textContent = 'ç•¶å‰';
                currentMarker.appendChild(currentLabel);
                
                selectorContainer.appendChild(currentMarker);
                
                // ç‚ºæ¯å€‹ä½ç½®å‰µå»ºæ¨™è¨˜
                for (const pos of positions) {
                    const marker = document.createElement('div');
                    marker.className = 'absolute bottom-0 flex flex-col items-center';
                    marker.style.left = `${pos.x}px`;
                    marker.style.transform = 'translateX(-50%)';
                    
                    // å‰µå»ºé–ƒçˆçš„åœ“é»
                    const dot = document.createElement('div');
                    dot.className = 'w-6 h-6 rounded-full bg-blue-500 animate-pulse flex items-center justify-center';
                    dot.innerHTML = `<div class="w-3 h-3 rounded-full bg-white"></div>`;
                    
                    // å‰µå»ºé€£æ¥ç·š
                    const line = document.createElement('div');
                    line.className = 'w-1 bg-blue-400 opacity-50';
                    line.style.height = `${gameHeight - 60}px`;
                    line.style.margin = '0 auto';
                    
                    // å‰µå»ºæ¨™ç±¤
                    const label = document.createElement('div');
                    label.className = 'text-sm text-white bg-blue-600 rounded px-2 py-1 mt-2';
                    label.textContent = pos.label;
                    
                    // æ·»åŠ åˆ°æ¨™è¨˜
                    marker.appendChild(line);
                    marker.appendChild(dot);
                    marker.appendChild(label);
                    
                    // æ·»åŠ åˆ°å®¹å™¨
                    selectorContainer.appendChild(marker);
                    
                    // é–ƒçˆæ•ˆæœ
                    let blinkInterval = setInterval(() => {
                        dot.classList.toggle('bg-blue-300');
                        dot.classList.toggle('bg-blue-600');
                    }, 500);
                    
                    // åœæ­¢é–“éš”
                    setTimeout(() => clearInterval(blinkInterval), 3000);
                }
                
                // æ·»åŠ åˆ°éŠæˆ²å®¹å™¨
                gameContainer.appendChild(selectorContainer);
                
                // å…è¨±é»æ“Šé¸æ“‡ç¬ç§»ä½ç½®
                const teleportOptions = document.createElement('div');
                teleportOptions.className = 'absolute bottom-16 left-0 right-0 flex justify-around items-center z-20';
                
                // ç‚ºæ¯å€‹é¸é …å‰µå»ºæŒ‰éˆ•
                positions.forEach(pos => {
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-blue-600 text-white rounded-full text-sm hover:bg-blue-500 transition-all transform hover:scale-105 pointer-events-auto';
                    button.textContent = `å‚³é€åˆ°${pos.label}`;
                    
                    // é»æ“Šæ™‚åŸ·è¡Œç¬ç§»
                    button.addEventListener('click', () => {
                        // åŸ·è¡Œç¬ç§»
                        const oldPosition = characterX;
                        characterX = pos.x;
                        
                        // å‰µå»ºæ®˜å½±æ•ˆæœ
                        createEnhancedAfterimage(oldPosition, characterX);
                        
                        // æ›´æ–°è§’è‰²ä½ç½®
                        if (characterElement) {
                            characterElement.style.left = `${characterX}px`;
                            updateQuoteBubblePosition();
                        }
                        
                        // çŸ­æš«ç„¡æ•µæ™‚é–“
                        invincible = true;
                        setTimeout(() => {
                            invincible = false;
                        }, 700);
                        
                        // æ¨™è¨˜èƒ½åŠ›ç‚ºå·²ä½¿ç”¨
                        abilityActive = false;
                        abilityCooldown = true;
                        abilityCooldownTime = getAbilityCooldown();
                        
                        // ç§»é™¤é¸æ“‡å™¨
                        selectorContainer.remove();
                        teleportOptions.remove();
                    });
                    
                    teleportOptions.appendChild(button);
                });
                
                // æ·»åŠ åˆ°éŠæˆ²å®¹å™¨
                gameContainer.appendChild(teleportOptions);
                
                // è¨­ç½®è‡ªå‹•ç§»é™¤çš„æ™‚é–“
                setTimeout(() => {
                    if (selectorContainer.parentNode) {
                        selectorContainer.remove();
                    }
                    if (teleportOptions.parentNode) {
                        teleportOptions.remove();
                    }
                    
                    // å¦‚æœç©å®¶æ²’é¸æ“‡ï¼Œè‡ªå‹•é¸æ“‡ç•¶å‰ä½ç½®é™„è¿‘å®‰å…¨å€åŸŸ
                    if (abilityActive && characterAbility === 'å„ªæŸ”ç¬ç§»') {
                        // è‡ªå‹•ç¬ç§»åˆ°ç›¸å°å®‰å…¨çš„ä½ç½®
                        const safeMargin = characterWidth * 2;
                        const oldPosition = characterX;
                        const newPosition = Math.min(gameWidth - safeMargin, Math.max(safeMargin, characterX + (Math.random() < 0.5 ? -1 : 1) * safeMargin * 2));
                        
                        characterX = newPosition;
                        
                        // å‰µå»ºæ®˜å½±æ•ˆæœ
                        createEnhancedAfterimage(oldPosition, characterX);
                        
                        // æ›´æ–°è§’è‰²ä½ç½®
                        if (characterElement) {
                            characterElement.style.left = `${characterX}px`;
                            updateQuoteBubblePosition();
                        }
                        
                        // çŸ­æš«ç„¡æ•µæ™‚é–“
                        invincible = true;
                        setTimeout(() => {
                            invincible = false;
                        }, 500);
                        
                        // æ¨™è¨˜èƒ½åŠ›ç‚ºå·²ä½¿ç”¨
                        abilityActive = false;
                        abilityCooldown = true;
                        abilityCooldownTime = getAbilityCooldown();
                        
                        // é¡¯ç¤ºæ•ˆæœæç¤º
                        showAbilityEffectHint('è‡ªå‹•ç¬ç§»åˆ°å®‰å…¨ä½ç½®', '#3399CC');
                    }
                }, 3000); // 3ç§’é¸æ“‡æ™‚é–“
            }
            
            // å¢å¼·ç‰ˆæ®˜å½±æ•ˆæœï¼ˆç”¨æ–¼å„ªæŸ”ç¬ç§»å¢å¼·ç‰ˆï¼‰
            function createEnhancedAfterimage(startX, endX) {
                if (!characterElement) return;
                
                // å‰µå»ºä¸€ç³»åˆ—æ®˜å½±ï¼Œå¾èµ·é»åˆ°çµ‚é»
                const steps = 5;
                const delay = 50;
                
                for (let i = 0; i < steps; i++) {
                    setTimeout(() => {
                        const progress = i / (steps - 1);
                        const posX = startX + (endX - startX) * progress;
                        
                        const decoy = document.createElement('div');
                        decoy.className = 'character-decoy absolute bottom-6 h-16 w-16 transform -translate-x-1/2 pointer-events-none';
                        decoy.style.left = `${posX}px`;
                        decoy.style.opacity = `${0.8 - progress * 0.6}`;
                        
                        // å…‹éš†è§’è‰²åœ–åƒ
                        const decoyImg = document.createElement('img');
                        decoyImg.src = characterImg.src;
                        decoyImg.className = 'w-full h-full';
                        decoyImg.style.filter = `drop-shadow(0 0 5px #3399CC) hue-rotate(${progress * 20}deg)`;
                        
                        decoy.appendChild(decoyImg);
                        gameContainer.appendChild(decoy);
                        
                        // æ·¡å‡ºæ•ˆæœ
                        setTimeout(() => {
                            decoy.style.opacity = '0';
                            decoy.style.transition = 'opacity 0.8s, transform 1s';
                            decoy.style.transform = 'translate(-50%, 10px) scale(0.9)';
                            
                            setTimeout(() => {
                                if (decoy.parentNode) {
                                    decoy.remove();
                                }
                            }, 800);
                        }, 400 + progress * 300);
                    }, i * delay);
                }
                
                // å‰µå»ºç¬ç§»ç²’å­ç‰¹æ•ˆ
                const teleportParticles = new ParticleSystem('game-container', {
                    maxParticles: 80,
                    particleSize: { min: 2, max: 6 },
                    speed: { min: 1, max: 3 },
                    colors: ['#3399CC', '#66B2FF', '#99CCFF', '#CCDFFF'],
                    duration: 1000,
                    spread: { x: 40, y: 25 },
                    friction: 0.92,
                    gravity: 0.02,
                    blendMode: 'screen',
                    fadeOut: true,
                    shape: 'circle',
                    emitFromCenter: true,
                    behavior: 'wave'
                });
                
                // åœ¨çµ‚é»å•Ÿå‹•ç²’å­æ•ˆæœ
                teleportParticles.start(endX, gameHeight - characterHeight / 2);
                
                // ç§»é™¤ç²’å­æ•ˆæœ
                setTimeout(() => {
                    if (teleportParticles) {
                        teleportParticles.stop();
                    }
                }, 1000);
                
                // ç¬ç§»éŸ³æ•ˆ
                playThunderSound('ability_å‘¨è');
            }
            
            // å‰µå»ºæƒ…æ„Ÿç²’å­ç³»çµ± - æƒ…æ„Ÿåº‡è­·å¢å¼·æ•ˆæœ
            function createEmotionalParticles() {
                if (!characterElement) return;
                
                // å‰µå»ºæƒ…æ„Ÿç²’å­ç³»çµ±
                const emotionalParticles = new ParticleSystem('game-container', {
                    maxParticles: 100,
                    particleSize: { min: 3, max: 8 },
                    speed: { min: 0.5, max: 2 },
                    colors: ['#FF416C', '#FF4B2B', '#E91E63', '#FFC1E3'],
                    duration: 3000,
                    spread: { x: 50, y: 30 },
                    friction: 0.96,
                    gravity: -0.03, // å¾®å¼±ä¸Šæµ®
                    blendMode: 'screen',
                    shape: 'circle',
                    rotate: true,
                    behavior: 'wave'
                });
                
                // ä¿å­˜ç²’å­ç³»çµ±
                activeEffects.emotionalParticles = emotionalParticles;
                
                // åœ¨è§’è‰²ä½ç½®å•Ÿå‹•ç²’å­ç³»çµ±
                emotionalParticles.start(characterX, gameHeight - characterHeight / 2);
                
                // æ›´æ–°ç²’å­ä½ç½®ä»¥è·Ÿéš¨è§’è‰²
                const updateParticlePosition = () => {
                    if (!isGameRunning || !characterElement || !activeEffects.emotionalParticles) return;
                    if (!abilityActive || !activeEffects.emotionalShield) {
                        if (activeEffects.emotionalParticles) {
                            activeEffects.emotionalParticles.stop();
                            delete activeEffects.emotionalParticles;
                        }
                        return;
                    }
                    
                    // æ›´æ–°ç²’å­ç³»çµ±ä½ç½®
                    if (activeEffects.emotionalParticles) {
                        activeEffects.emotionalParticles.updatePosition(characterX, gameHeight - characterHeight / 2);
                    }
                    
                    requestAnimationFrame(updateParticlePosition);
                };
                
                requestAnimationFrame(updateParticlePosition);
                
                // è¨­ç½®æ®˜å½±ç”Ÿæˆé‚è¼¯
                const createDecoyInterval = setInterval(() => {
                    if (!isGameRunning || !abilityActive || !activeEffects.createAfterimagePath) {
                        clearInterval(createDecoyInterval);
                        return;
                    }
                    
                    // å‰µå»ºå¸å¼•é–ƒé›»çš„æƒ…æ„Ÿæ®˜å½±
                    createAttractiveDecoy(characterX, gameHeight - characterHeight);
                }, 800); // æ¯0.8ç§’å‰µå»ºä¸€å€‹æ®˜å½±
                
                // æ¸…ç†å®šæ™‚å™¨
                setTimeout(() => {
                    clearInterval(createDecoyInterval);
                }, abilityDuration * 1000 / 60);
            }
            
            // å‰µå»ºå¸å¼•é–ƒé›»çš„æƒ…æ„Ÿæ®˜å½±
            function createAttractiveDecoy(x, y) {
                if (!characterElement || !activeEffects.decoyAttractsLightning) return;
                
                // å‰µå»ºä¸€å€‹èƒ½å¤ å¸å¼•é–ƒé›»çš„æ®˜å½±
                const decoy = document.createElement('div');
                decoy.className = 'character-decoy attractive-decoy absolute h-16 w-16 transform -translate-x-1/2 pointer-events-none z-5';
                
                // éš¨æ©Ÿä½ç½®ï¼Œä½†é›¢è§’è‰²ä¸é 
                const offsetX = Math.random() * 200 - 100; // -100 åˆ° 100 çš„åç§»
                const decoyX = Math.min(gameWidth - 40, Math.max(40, x + offsetX));
                decoy.style.left = `${decoyX}px`;
                decoy.style.bottom = `${y - gameHeight + 50 + Math.random() * 50}px`; // ç¨å¾®æµ®åœ¨ç©ºä¸­
                decoy.style.opacity = '0.75';
                
                // å…‹éš†è§’è‰²åœ–åƒ
                const decoyImg = document.createElement('img');
                decoyImg.src = characterImg.src;
                decoyImg.className = 'w-full h-full';
                decoyImg.style.filter = 'drop-shadow(0 0 5px #E91E63) brightness(1.2)';
                
                // æ·»åŠ å¸å¼•æŒ‡ç¤ºå™¨
                const attractIndicator = document.createElement('div');
                attractIndicator.className = 'absolute inset-0 rounded-full';
                attractIndicator.innerHTML = `
                    <div class="w-full h-full absolute rounded-full animate-ping bg-red-500 opacity-30"></div>
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-6">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E91E63" class="w-5 h-5 animate-pulse">
                            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        </svg>
                    </div>
                `;
                
                decoy.appendChild(decoyImg);
                decoy.appendChild(attractIndicator);
                gameContainer.appendChild(decoy);
                
                // å„²å­˜æ®˜å½±çš„ä½ç½®ä¿¡æ¯ï¼Œç”¨æ–¼é–ƒé›»å¸å¼•
                if (!activeEffects.attractiveDecoys) {
                    activeEffects.attractiveDecoys = [];
                }
                
                // æ·»åŠ åˆ°å¸å¼•æ®˜å½±åˆ—è¡¨
                const decoyData = { x: decoyX, y: parseFloat(decoy.style.bottom) + characterHeight / 2, element: decoy };
                activeEffects.attractiveDecoys.push(decoyData);
                
                // å‰µå»ºç´…è‰²æƒ…æ„Ÿç²’å­
                const decoyParticles = new ParticleSystem('game-container', {
                    maxParticles: 40,
                    particleSize: { min: 2, max: 4 },
                    speed: { min: 0.3, max: 1.5 },
                    colors: ['#FF416C', '#FF4B2B', '#E91E63', '#FFC1E3'],
                    duration: 2000,
                    spread: { x: 25, y: 25 },
                    friction: 0.98,
                    gravity: -0.01,
                    blendMode: 'screen',
                    shape: 'circle',
                    behavior: 'orbit'
                });
                
                decoyParticles.start(decoyX, gameHeight - parseFloat(decoy.style.bottom) - characterHeight / 2);
                
                // æ·¡å‡ºæ•ˆæœ
                setTimeout(() => {
                    // å¾å¸å¼•æ®˜å½±åˆ—è¡¨ä¸­ç§»é™¤
                    if (activeEffects.attractiveDecoys) {
                        const index = activeEffects.attractiveDecoys.findIndex(d => d.element === decoy);
                        if (index >= 0) {
                            activeEffects.attractiveDecoys.splice(index, 1);
                        }
                    }
                    
                    // è¦–è¦ºæ·¡å‡º
                    decoy.style.opacity = '0';
                    decoy.style.transition = 'opacity 0.8s, transform 1s';
                    decoy.style.transform = 'translate(-50%, 20px) scale(0.8)';
                    
                    // åœæ­¢ç²’å­ç³»çµ±
                    decoyParticles.stop();
                    
                    // ç§»é™¤å…ƒç´ 
                    setTimeout(() => {
                        if (decoy.parentNode) {
                            decoy.remove();
                        }
                    }, 1000);
                }, 4000); // æŒçºŒ4ç§’
            }
            
            // å‰µå»ºåœ°é¢è¡æ“Šæ³¢æ•ˆæœ - é’æ˜¥è¡åˆºå¢å¼·
            function createGroundWave() {
                const wave = document.createElement('div');
                wave.className = 'absolute bottom-0 left-0 w-full pointer-events-none';
                wave.style.height = '30px';
                wave.style.background = 'radial-gradient(ellipse at center, rgba(102, 204, 255, 0.7) 0%, rgba(102, 204, 255, 0) 70%)';
                wave.style.transform = 'scaleY(0.3)';
                wave.style.transformOrigin = 'bottom';
                wave.style.animation = 'groundWave 2s linear';
                
                // æ·»åŠ é—œéµå¹€å‹•ç•«
                const styleSheet = document.createElement('style');
                styleSheet.textContent = `
                    @keyframes groundWave {
                        0% { transform: scaleY(0.3) scaleX(0.1); opacity: 0.9; }
                        100% { transform: scaleY(0.3) scaleX(3); opacity: 0; }
                    }
                `;
                document.head.appendChild(styleSheet);
                
                gameContainer.appendChild(wave);
                
                // è‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    wave.remove();
                }, 2000);
            }
            
            // ç²’å­ç³»çµ±åŸºç¤é¡ - ç‚ºæ‰€æœ‰è§’è‰²æŠ€èƒ½æä¾›ç²’å­æ•ˆæœåŸºç¤
            class ParticleSystem {
                constructor(containerId, options = {}) {
                    this.container = document.getElementById(containerId) || gameContainer;
                    this.particles = [];
                    this.canvas = document.createElement('canvas');
                    this.canvas.className = 'absolute top-0 left-0 w-full h-full pointer-events-none z-10';
                    this.ctx = this.canvas.getContext('2d');
                    this.isActive = false;
                    this.animationId = null;
                    
                    // è¨­ç½®é¸é …ï¼Œæä¾›é»˜èªå€¼
                    this.options = {
                        maxParticles: options.maxParticles || 100,
                        particleSize: options.particleSize || { min: 2, max: 5 },
                        speed: options.speed || { min: 1, max: 3 },
                        duration: options.duration || 2000, // ç²’å­å­˜æ´»æ™‚é–“ (æ¯«ç§’)
                        colors: options.colors || ['#ffffff'],
                        gravity: options.gravity || 0,
                        friction: options.friction || 0.95,
                        spread: options.spread || { x: 10, y: 10 },
                        shape: options.shape || 'circle', // circle, square, or image
                        imageSrc: options.imageSrc || null,
                        fadeOut: options.fadeOut !== undefined ? options.fadeOut : true,
                        rotate: options.rotate || false,
                        blendMode: options.blendMode || 'source-over', // æ··åˆæ¨¡å¼
                        emitFromCenter: options.emitFromCenter !== undefined ? options.emitFromCenter : false
                    };
                    
                    // åˆå§‹åŒ–åœ–åƒï¼ˆå¦‚æœä½¿ç”¨ï¼‰
                    this.particleImage = null;
                    if (this.options.shape === 'image' && this.options.imageSrc) {
                        this.particleImage = new Image();
                        this.particleImage.src = this.options.imageSrc;
                    }
                    
                    // ç‚ºç²’å­ç³»çµ±è¨­ç½®å…¶ä»–å¯é¸ç‰¹æ€§
                    this.originX = options.originX || 0; // ç²’å­åŸé»X
                    this.originY = options.originY || 0; // ç²’å­åŸé»Y
                    this.behavior = options.behavior || 'default'; // è‡ªå®šç¾©è¡Œç‚º
                }
                
                start(x, y) {
                    // è¨­ç½®ç²’å­ç™¼å°„åŸé»
                    this.originX = x !== undefined ? x : (this.container.clientWidth / 2);
                    this.originY = y !== undefined ? y : (this.container.clientHeight - 100);
                    
                    // èª¿æ•´canvaså¤§å°
                    this.canvas.width = this.container.clientWidth;
                    this.canvas.height = this.container.clientHeight;
                    
                    // æ·»åŠ canvasåˆ°å®¹å™¨
                    this.container.appendChild(this.canvas);
                    
                    // æ¿€æ´»ç²’å­ç³»çµ±
                    this.isActive = true;
                    
                    // é–‹å§‹å‹•ç•«å¾ªç’°
                    this.animate();
                }
                
                stop() {
                    this.isActive = false;
                    
                    // æ¸…é™¤å‹•ç•«
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    
                    // æ¸…ç©ºç²’å­
                    this.particles = [];
                    
                    // ç§»é™¤canvas
                    if (this.canvas.parentNode) {
                        this.canvas.parentNode.removeChild(this.canvas);
                    }
                }
                
                createParticle() {
                    // å¦‚æœé”åˆ°æœ€å¤§ç²’å­æ•¸ï¼Œä¸å†å‰µå»º
                    if (this.particles.length >= this.options.maxParticles) return;
                    
                    // éš¨æ©Ÿç²’å­å°ºå¯¸
                    const size = this.options.particleSize.min + 
                                Math.random() * (this.options.particleSize.max - this.options.particleSize.min);
                    
                    // ç™¼å°„è§’åº¦ï¼ˆéš¨æ©Ÿæˆ–å®šå‘ï¼‰
                    const angle = this.options.emitFromCenter ? 
                                Math.random() * Math.PI * 2 : // 360åº¦ç™¼å°„
                                Math.PI + (Math.random() * Math.PI); // ä¸ŠåŠéƒ¨ç™¼å°„ (180-360åº¦)
                    
                    // éš¨æ©Ÿé€Ÿåº¦
                    const speed = this.options.speed.min + 
                                Math.random() * (this.options.speed.max - this.options.speed.min);
                    
                    // é€Ÿåº¦åˆ†é‡
                    const vx = Math.cos(angle) * speed;
                    const vy = Math.sin(angle) * speed;
                    
                    // éš¨æ©Ÿé¡è‰²
                    const color = this.options.colors[Math.floor(Math.random() * this.options.colors.length)];
                    
                    // éš¨æ©Ÿä½ç½®åç§»
                    const offsetX = this.options.emitFromCenter ? 0 : (Math.random() * this.options.spread.x * 2 - this.options.spread.x);
                    const offsetY = this.options.emitFromCenter ? 0 : (Math.random() * this.options.spread.y * 2 - this.options.spread.y);
                    
                    // å‰µå»ºç²’å­å°è±¡
                    const particle = {
                        x: this.originX + offsetX,
                        y: this.originY + offsetY,
                        size: size,
                        vx: vx,
                        vy: vy,
                        color: color,
                        alpha: 1,
                        life: 100, // ç”Ÿå‘½ç™¾åˆ†æ¯”
                        rotation: Math.random() * 360, // åˆå§‹æ—‹è½‰è§’åº¦
                        rotationSpeed: (Math.random() - 0.5) * 3, // æ—‹è½‰é€Ÿåº¦
                        createdAt: Date.now()
                    };
                    
                    // ç‰¹æ®Šè¡Œç‚ºçš„é¡å¤–å±¬æ€§
                    if (this.behavior === 'orbit') {
                        particle.orbitRadius = 20 + Math.random() * 30;
                        particle.orbitSpeed = (Math.random() + 0.5) * 0.02;
                        particle.angle = Math.random() * Math.PI * 2;
                    } else if (this.behavior === 'wave') {
                        particle.waveAmplitude = 5 + Math.random() * 10;
                        particle.waveFrequency = 0.05 + Math.random() * 0.05;
                        particle.baseX = particle.x;
                    }
                    
                    this.particles.push(particle);
                }
                
                updateParticles() {
                    const now = Date.now();
                    const duration = this.options.duration;
                    
                    // æ›´æ–°æ‰€æœ‰ç²’å­
                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        const p = this.particles[i];
                        
                        // è¨ˆç®—ç”Ÿå‘½æ™‚é–“
                        const elapsed = now - p.createdAt;
                        p.life = Math.max(0, 100 - (elapsed / duration) * 100);
                        
                        // å¦‚æœç²’å­å£½å‘½çµæŸï¼Œç§»é™¤
                        if (p.life <= 0) {
                            this.particles.splice(i, 1);
                            continue;
                        }
                        
                        // ç‰¹æ®Šè¡Œç‚ºæ¨¡å¼
                        if (this.behavior === 'orbit') {
                            // è»Œé“è¡Œç‚ºï¼šåœç¹åŸé»æ—‹è½‰
                            p.angle += p.orbitSpeed;
                            p.x = this.originX + Math.cos(p.angle) * p.orbitRadius;
                            p.y = this.originY + Math.sin(p.angle) * p.orbitRadius;
                            
                            // é€æ¼¸å‘å¤–æ“´å±•
                            p.orbitRadius += 0.1;
                        } else if (this.behavior === 'wave') {
                            // æ³¢æµªè¡Œç‚ºï¼šæ²¿æ³¢æµªè·¯å¾‘ç§»å‹•
                            p.x = p.baseX + Math.sin(elapsed * p.waveFrequency) * p.waveAmplitude;
                            p.y += p.vy;
                            
                            // é€æ¼¸æ¸›å°æ³¢å¹…
                            p.waveAmplitude *= 0.99;
                        } else if (this.behavior === 'spiral') {
                            // èºæ—‹è¡Œç‚ºï¼šæ²¿èºæ—‹è·¯å¾‘ç§»å‹•
                            p.angle = (p.angle || 0) + 0.05;
                            const radius = 5 + (100 - p.life) * 0.2;
                            p.x = this.originX + Math.cos(p.angle) * radius;
                            p.y = this.originY + Math.sin(p.angle) * radius;
                        } else if (this.behavior === 'attract') {
                            // å¸å¼•è¡Œç‚ºï¼šç²’å­å‘åŸé»ç§»å‹•
                            const dx = this.originX - p.x;
                            const dy = this.originY - p.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            const force = 0.02; // å¸å¼•åŠ›
                            
                            if (dist > 1) {
                                p.vx += (dx / dist) * force;
                                p.vy += (dy / dist) * force;
                            }
                            
                            // æ‡‰ç”¨é€Ÿåº¦
                            p.x += p.vx;
                            p.y += p.vy;
                            
                            // æ‡‰ç”¨æ‘©æ“¦åŠ›
                            p.vx *= this.options.friction;
                            p.vy *= this.options.friction;
                        } else {
                            // é»˜èªè¡Œç‚ºï¼šå¸¸è¦ç‰©ç†é‹å‹•
                            p.x += p.vx;
                            p.y += p.vy;
                            
                            // æ‡‰ç”¨é‡åŠ›
                            p.vy += this.options.gravity;
                            
                            // æ‡‰ç”¨æ‘©æ“¦åŠ›
                            p.vx *= this.options.friction;
                            p.vy *= this.options.friction;
                        }
                        
                        // æ—‹è½‰æ›´æ–°
                        if (this.options.rotate) {
                            p.rotation += p.rotationSpeed;
                        }
                        
                        // é€æ˜åº¦è¨ˆç®—ï¼ˆå¦‚æœå•Ÿç”¨äº†æ¼¸éš±ï¼‰
                        if (this.options.fadeOut) {
                            p.alpha = p.life / 100;
                        }
                    }
                }
                
                draw() {
                    // æ¸…ç©ºç•«å¸ƒ
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // è¨­ç½®å…¨å±€æ··åˆæ¨¡å¼
                    this.ctx.globalCompositeOperation = this.options.blendMode;
                    
                    // ç¹ªè£½æ‰€æœ‰ç²’å­
                    for (const p of this.particles) {
                        this.ctx.save();
                        
                        // è¨­ç½®é€æ˜åº¦
                        this.ctx.globalAlpha = p.alpha;
                        
                        // ç¹ªè£½ç²’å­
                        if (this.options.shape === 'circle') {
                            // åœ“å½¢ç²’å­
                            this.ctx.beginPath();
                            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            this.ctx.fillStyle = p.color;
                            this.ctx.fill();
                        } else if (this.options.shape === 'square') {
                            // æ–¹å½¢ç²’å­ï¼ˆå¸¶æ—‹è½‰ï¼‰
                            this.ctx.translate(p.x, p.y);
                            this.ctx.rotate(p.rotation * Math.PI / 180);
                            this.ctx.fillStyle = p.color;
                            this.ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                        } else if (this.options.shape === 'image' && this.particleImage) {
                            // åœ–åƒç²’å­
                            this.ctx.translate(p.x, p.y);
                            if (this.options.rotate) {
                                this.ctx.rotate(p.rotation * Math.PI / 180);
                            }
                            this.ctx.drawImage(
                                this.particleImage, 
                                -p.size/2, -p.size/2, 
                                p.size, p.size
                            );
                        }
                        
                        this.ctx.restore();
                    }
                    
                    // é‡ç½®æ··åˆæ¨¡å¼
                    this.ctx.globalCompositeOperation = 'source-over';
                }
                
                animate() {
                    if (!this.isActive) return;
                    
                    // å‰µå»ºæ–°ç²’å­
                    if (this.isActive && this.particles.length < this.options.maxParticles) {
                        const emitRate = Math.min(5, Math.ceil(this.options.maxParticles / 60)); // æ¯å¹€ç™¼å°„æ•¸é‡
                        for (let i = 0; i < emitRate; i++) {
                            this.createParticle();
                        }
                    }
                    
                    // æ›´æ–°æ‰€æœ‰ç²’å­
                    this.updateParticles();
                    
                    // ç¹ªè£½ç²’å­
                    this.draw();
                    
                    // å¦‚æœç³»çµ±ä»æ´»èºï¼Œç¹¼çºŒå‹•ç•«
                    if (this.isActive) {
                        this.animationId = requestAnimationFrame(() => this.animate());
                    }
                }
                
                // æ›´æ–°ç™¼å°„ä½ç½®ï¼ˆç”¨æ–¼è·Ÿéš¨è§’è‰²ï¼‰
                updatePosition(x, y) {
                    if (x !== undefined) this.originX = x;
                    if (y !== undefined) this.originY = y;
                }
            }
            
            // é’æ˜¥è¡åˆºæ•ˆæœ
            function createSprintEffect() {
                if (!characterElement) return;
                
                // ç§»é™¤èˆŠæ•ˆæœï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const oldEffect = document.getElementById('sprint-effect');
                if (oldEffect) oldEffect.remove();
                
                // å‰µå»ºé’æ˜¥è¡åˆºç²’å­ç³»çµ±
                const sprintParticles = new ParticleSystem('game-container', {
                    maxParticles: 150,
                    particleSize: { min: 2, max: 6 },
                    speed: { min: 1, max: 2.5 },
                    colors: ['#66CCFF', '#4CD2FF', '#00BFFF', '#33F0FF'],
                    duration: 800, // ç²’å­å£½å‘½è¼ƒçŸ­ï¼Œå¿«é€Ÿæ¶ˆå¤±
                    spread: { x: 20, y: 15 },
                    friction: 0.92,
                    gravity: 0.05,
                    blendMode: 'screen',
                    fadeOut: true,
                    shape: 'circle',
                    // ç‰¹æ®Šåƒæ•¸ï¼ŒæŒ‡å®šé€™æ˜¯ä¸€å€‹é€Ÿåº¦ç·šæ•ˆæœ
                    behavior: 'default'
                });
                
                // ä¿å­˜ç²’å­ç³»çµ±ä»¥ä¾¿å¾ŒçºŒä½¿ç”¨
                activeEffects.sprintParticles = sprintParticles;
                
                // é–‹å§‹ç²’å­æ•ˆæœ
                sprintParticles.start(characterX, gameHeight - characterHeight);
                
                // å‰µå»ºå¾ŒçºŒè»Œè·¡ï¼ˆåœ¨è§’è‰²ç§»å‹•æ™‚ï¼‰
                const updateTrail = () => {
                    if (!isGameRunning || !characterElement || !activeEffects.sprintParticles) return;
                    if (!abilityActive || !activeEffects.youthSprint) {
                        // å¦‚æœèƒ½åŠ›ä¸å†æ´»èºï¼Œåœæ­¢ç²’å­ç³»çµ±ä¸¦æ¸…ç†
                        if (activeEffects.sprintParticles) {
                            activeEffects.sprintParticles.stop();
                            delete activeEffects.sprintParticles;
                        }
                        return;
                    }
                    
                    // æ›´æ–°ç²’å­ç™¼å°„ä½ç½®ä¾†è·Ÿéš¨è§’è‰²
                    if (activeEffects.sprintParticles) {
                        activeEffects.sprintParticles.updatePosition(characterX, gameHeight - characterHeight * 0.5);
                    }
                    
                    // ç¹¼çºŒæ›´æ–°
                    requestAnimationFrame(updateTrail);
                };
                
                requestAnimationFrame(updateTrail);
                
                // æ·»åŠ é€Ÿåº¦ç·šæ•ˆæœ - ä½¿ç”¨HTMLå…ƒç´ å¯¦ç¾é¡å¤–çš„è¦–è¦ºå¼·åŒ–
                const speedLinesContainer = document.createElement('div');
                speedLinesContainer.id = 'speed-lines-container';
                speedLinesContainer.className = 'absolute inset-0 overflow-hidden pointer-events-none z-5';
                
                // å‰µå»ºå¤šæ¢é€Ÿåº¦ç·š
                for (let i = 0; i < 15; i++) {
                    const line = document.createElement('div');
                    line.className = 'absolute';
                    line.style.width = `${1 + Math.random() * 2}px`;
                    line.style.height = `${15 + Math.random() * 30}px`;
                    line.style.backgroundColor = `rgba(100, 255, 200, ${0.3 + Math.random() * 0.4})`;
                    line.style.left = `${Math.random() * 100}%`;
                    line.style.top = `${Math.random() * 100}%`;
                    line.style.transform = `rotate(${-10 + Math.random() * 20}deg)`;
                    line.style.opacity = '0.9';
                    line.style.filter = 'blur(1px)'; // æ¨¡ç³Šæ•ˆæœå¼·åŒ–é€Ÿåº¦æ„Ÿ
                    line.style.animation = `speedLine ${0.5 + Math.random() * 0.3}s linear infinite`;
                    
                    // æ·»åŠ é—œéµå¹€å‹•ç•«
                    const styleSheet = document.createElement('style');
                    styleSheet.textContent = `
                        @keyframes speedLine {
                            0% { transform: translateX(120vw) rotate(${-10 + Math.random() * 20}deg); }
                            100% { transform: translateX(-20vw) rotate(${-10 + Math.random() * 20}deg); }
                        }
                    `;
                    document.head.appendChild(styleSheet);
                    
                    speedLinesContainer.appendChild(line);
                }
                
                characterElement.appendChild(speedLinesContainer);
                
                // èƒ½åŠ›çµæŸæ™‚æ¸…ç†é€Ÿåº¦ç·š
                setTimeout(() => {
                    const container = document.getElementById('speed-lines-container');
                    if (container && container.parentNode) {
                        container.remove();
                    }
                }, getAbilityDuration() * 1000 / 60);
            }
            
            // æ®˜å½±æ•ˆæœï¼ˆç”¨æ–¼æƒ…æ„Ÿåº‡è­·å’Œå„ªæŸ”ç¬ç§»ï¼‰
            function createAfterimage(positionX, color = '#E91E63') {
                if (!characterElement) return;
                
                const decoy = document.createElement('div');
                decoy.className = 'character-decoy absolute bottom-6 h-16 w-16 transform -translate-x-1/2 pointer-events-none';
                decoy.style.left = `${positionX}px`;
                decoy.style.opacity = '0.7';
                
                // å…‹éš†è§’è‰²åœ–åƒ
                const decoyImg = document.createElement('img');
                decoyImg.src = characterImg.src;
                decoyImg.className = 'w-full h-full';
                decoyImg.style.filter = `drop-shadow(0 0 5px ${color})`;
                
                decoy.appendChild(decoyImg);
                gameContainer.appendChild(decoy);
                
                // æ·¡å‡ºæ•ˆæœ
                setTimeout(() => {
                    decoy.style.opacity = '0';
                    decoy.style.transition = 'opacity 0.8s, transform 1s';
                    decoy.style.transform = 'translate(-50%, 10px) scale(0.9)';
                    
                    setTimeout(() => {
                        if (decoy.parentNode) {
                            decoy.remove();
                        }
                    }, 1000);
                }, 300);
            }
            
            // å¨åš´åŠ›å ´æ•ˆæœ - ä¿®å¾©ä½ç½®è·Ÿéš¨å•é¡Œ
            function createPressureField() {
                if (!characterElement) return;
                
                const field = document.createElement('div');
                field.className = 'absolute rounded-full pointer-events-none';
                field.id = 'pressure-field';
                field.style.width = `${gameWidth * 0.6}px`;
                field.style.height = `${gameWidth * 0.6}px`;
                field.style.left = `${characterX}px`;
                field.style.bottom = `${characterHeight - 20}px`;
                field.style.transform = 'translate(-50%, 50%)';
                field.style.background = 'radial-gradient(circle, rgba(255,194,10,0.1) 0%, rgba(255,194,10,0.05) 50%, rgba(255,194,10,0) 80%)';
                field.style.border = '2px solid rgba(255,194,10,0.3)';
                field.style.boxShadow = '0 0 15px rgba(255,194,10,0.2)';
                field.style.animation = 'pulse 2s infinite ease-in-out';
                
                gameContainer.appendChild(field);
                
                // å¨æ¬ŠåŠ›å ´ä½ç½®è·Ÿéš¨ç³»çµ± - å¤šé‡ä¿éšœæ©Ÿåˆ¶
                const updateFieldPosition = () => {
                    const field = document.getElementById('pressure-field');
                    if (field && field.parentNode) {
                        field.style.left = `${characterX}px`;
                    }
                };
                
                // æ–¹æ¡ˆ1: ç›£è½è§’è‰²å…ƒç´ çš„styleå±¬æ€§è®ŠåŒ–
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'style') {
                            updateFieldPosition();
                        }
                    });
                });
                
                if (characterElement) {
                    observer.observe(characterElement, { attributes: true });
                }
                
                // æ–¹æ¡ˆ2: ä½¿ç”¨requestAnimationFrameæŒçºŒæ›´æ–°ï¼ˆä¸»è¦æ–¹æ¡ˆï¼‰
                let isFieldActive = true;
                const animationUpdateField = () => {
                    if (!isFieldActive || !isGameRunning) return;
                    
                    const field = document.getElementById('pressure-field');
                    if (!field) {
                        isFieldActive = false;
                        return;
                    }
                    
                    // ç¢ºä¿å¨æ¬ŠåŠ›å ´å§‹çµ‚è·Ÿéš¨è§’è‰²
                    if (characterAbility === 'å¨æ¬ŠåŠ›å ´' && abilityActive) {
                        updateFieldPosition();
                        requestAnimationFrame(animationUpdateField);
                    } else {
                        isFieldActive = false;
                    }
                };
                
                // å•Ÿå‹•å‹•ç•«å¾ªç’°
                requestAnimationFrame(animationUpdateField);
                
                // æ–¹æ¡ˆ3: å®šæœŸæª¢æŸ¥å‚™ç”¨æ–¹æ¡ˆ
                const intervalId = setInterval(() => {
                    if (!isGameRunning || characterAbility !== 'å¨æ¬ŠåŠ›å ´' || !abilityActive) {
                        clearInterval(intervalId);
                        return;
                    }
                    updateFieldPosition();
                }, 100); // æ¯100msæª¢æŸ¥ä¸€æ¬¡
                
                // åœ¨èƒ½åŠ›çµæŸæ™‚ç§»é™¤åŠ›å ´å’Œç›£è½å™¨
                setTimeout(() => {
                    const field = document.getElementById('pressure-field');
                    if (field && field.parentNode) {
                        field.style.opacity = '0';
                        field.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (field && field.parentNode) {
                                field.remove();
                            }
                        }, 500);
                    }
                    
                    // æ¸…ç†æ‰€æœ‰ç›£è½å™¨å’Œå®šæ™‚å™¨
                    isFieldActive = false;
                    observer.disconnect();
                    clearInterval(intervalId);
                }, abilityDuration * 1000 / 60);
            }
            
            // éš±å¿å …éŸŒæ•ˆæœ
            function createResilienceEffect() {
                if (!characterElement) return;
                
                const aura = document.createElement('div');
                aura.className = 'absolute rounded-full pointer-events-none';
                aura.id = 'resilience-aura';
                aura.style.width = `${characterWidth * 1.5}px`;
                aura.style.height = `${characterHeight * 1.2}px`;
                aura.style.left = '50%';
                aura.style.top = '50%';
                aura.style.transform = 'translate(-50%, -50%)';
                aura.style.background = 'radial-gradient(ellipse, rgba(156,39,176,0.3) 0%, rgba(156,39,176,0.1) 70%, rgba(156,39,176,0) 100%)';
                aura.style.boxShadow = '0 0 10px rgba(156,39,176,0.5)';
                aura.style.animation = 'pulse 1.5s infinite ease-in-out';
                
                characterElement.appendChild(aura);
            }
            
            // æ™‚é–“æ¸›ç·©æ•ˆæœ
            function createTimeslowEffect() {
                // å…¨å±€è¦–è¦ºæ•ˆæœ
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 pointer-events-none z-20';
                overlay.id = 'timeslow-overlay';
                overlay.style.background = 'radial-gradient(circle, rgba(255,204,102,0) 20%, rgba(255,204,102,0.1) 100%)';
                overlay.style.backdropFilter = 'contrast(1.05) brightness(1.05)';
                overlay.style.animation = 'pulse 2s infinite ease-in-out';
                
                gameContainer.appendChild(overlay);
                
                // è¦–è¦ºå¢å¼· - æ·»åŠ æ™‚é–“ç—•è·¡ç²’å­
                const addTimeParticles = () => {
                    if (!isGameRunning) return;
                    if (!abilityActive || !activeEffects.timeSlowdown) return;
                    
                    // åœ¨è¢å¹•ä¸Šéš¨æ©Ÿæ·»åŠ "æ™‚é–“ç²’å­"
                    const particle = document.createElement('div');
                    particle.className = 'absolute rounded-full pointer-events-none';
                    particle.style.width = '2px';
                    particle.style.height = '2px';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.background = 'rgba(255, 215, 100, 0.8)';
                    particle.style.boxShadow = '0 0 3px rgba(255, 215, 100, 0.5)';
                    
                    gameContainer.appendChild(particle);
                    
                    // æ·¡å‡ºæ•ˆæœ
                    setTimeout(() => {
                        particle.style.opacity = '0';
                        particle.style.transition = 'opacity 1s';
                        
                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.remove();
                            }
                        }, 1000);
                    }, 800);
                    
                    // ç¹¼çºŒæ·»åŠ ç²’å­
                    if (abilityActive && activeEffects.timeSlowdown) {
                        setTimeout(addTimeParticles, 100);
                    }
                };
                
                addTimeParticles();
                
                // åœ¨èƒ½åŠ›çµæŸæ™‚ç§»é™¤æ•ˆæœ
                setTimeout(() => {
                    const overlay = document.getElementById('timeslow-overlay');
                    if (overlay && overlay.parentNode) {
                        overlay.style.opacity = '0';
                        overlay.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (overlay && overlay.parentNode) {
                                overlay.remove();
                            }
                        }, 500);
                    }
                }, abilityDuration * 1000 / 60);
            }
            
            // å‰µå»ºè­·ç›¾è¦–è¦ºæ•ˆæœ
            function createShieldEffect(color) {
                if (!characterElement) return;
                
                const shield = document.createElement('div');
                shield.className = 'absolute z-10 pointer-events-none';
                shield.id = 'character-shield';
                shield.style.left = `${characterX}px`;
                shield.style.bottom = '0';
                shield.style.width = `${characterWidth * 2}px`;
                shield.style.height = `${characterHeight * 1.5}px`;
                shield.style.borderRadius = '50%';
                shield.style.transform = 'translateX(-50%)';
                shield.style.background = `radial-gradient(ellipse at center, ${color}44 0%, ${color}22 60%, transparent 80%)`;
                shield.style.boxShadow = `0 0 15px ${color}88`;
                shield.style.opacity = '0.8';
                shield.style.animation = 'pulse 2s infinite';
                
                // æ·»åŠ åˆ°éŠæˆ²å®¹å™¨
                gameContainer.appendChild(shield);
                
                // æ›´æ–°è­·ç›¾ä½ç½®çš„å‡½æ•¸
                function updateShieldPosition() {
                    if (shield && shield.parentNode) {
                        shield.style.left = `${characterX}px`;
                    }
                }
                
                // ç›£è½è§’è‰²ç§»å‹•ä»¥æ›´æ–°è­·ç›¾ä½ç½®
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'style') {
                            updateShieldPosition();
                        }
                    });
                });
                
                if (characterElement) {
                    observer.observe(characterElement, { attributes: true });
                }
                
                // åœ¨èƒ½åŠ›çµæŸæ™‚ç§»é™¤è­·ç›¾
                setTimeout(() => {
                    if (shield && shield.parentNode) {
                        shield.style.opacity = '0';
                        shield.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (shield && shield.parentNode) {
                                shield.remove();
                                observer.disconnect();
                            }
                        }, 500);
                    }
                }, abilityDuration * 1000 / 60); // è½‰æ›ç‚ºæ¯«ç§’
            }
            
            // é¡¯ç¤ºèƒ½åŠ›æ•ˆæœæç¤º
            function showAbilityEffectHint(text, color) {
                const hintElement = document.createElement('div');
                hintElement.classList.add('absolute', 'left-1/2', 'top-1/3', 'transform', '-translate-x-1/2', 'bg-black', 'bg-opacity-70', 'px-4', 'py-2', 'rounded-lg', 'text-white', 'text-center', 'z-20', 'text-sm');
                hintElement.innerHTML = `<span style="color:${color};">${characterAbility}:</span> ${text}`;
                
                gameContainer.appendChild(hintElement);
                
                // æ·¡å‡ºæ•ˆæœ
                setTimeout(() => {
                    hintElement.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        if (hintElement.parentNode) {
                            hintElement.remove();
                        }
                    }, 500);
                }, 1500);
            }
            
            // åœç”¨è§’è‰²èƒ½åŠ›
            function deactivateAbility() {
                abilityActive = false;
                abilityCooldown = true;
                abilityCooldownTime = getAbilityCooldown();
                
                // ç§»é™¤æ‰€æœ‰æ•ˆæœ
                activeEffects = {};
            }
            
            // ç”¢ç”Ÿéš¨æ©Ÿé“å…· - åŸºæ–¼æ™‚é–“çš„éš¨æ©Ÿ
            function generateItem(deltaTime) {
                // å°‡æ¯å¹€æ¦‚ç‡è½‰æ›ç‚ºåŸºæ–¼æ™‚é–“çš„æ¦‚ç‡
                // åŸä¾†çš„å¹€æ¦‚ç‡: 0.0007 + (level * 0.0002)
                // è½‰æ›ç‚ºæ™‚é–“æ¦‚ç‡: 1 - (1 - åŸæ¦‚ç‡)^(deltaTime * 60)
                const baseChance = 0.0007 + (level * 0.0002);
                const timeBasedChance = 1 - Math.pow(1 - baseChance, deltaTime * 60);
                
                if (Math.random() < timeBasedChance) {
                    // ä½¿ç”¨ç¨€æœ‰åº¦ç³»çµ±é¸æ“‡é“å…·
                    const itemTemplate = selectRandomItem();
                    
                    // é“å…·åŸºç¤ä¸‹è½é€Ÿåº¦ï¼ˆåƒç´ /ç§’ï¼‰
                    const BASE_ITEM_SPEED = 108 + Math.random() * 90;
                    
                    items.push({
                        ...itemTemplate,
                        x: Math.random() * (gameWidth - 40) + 20,
                        y: 0,
                        width: 30,
                        height: 30,
                        active: true,
                        speed: BASE_ITEM_SPEED // é€Ÿåº¦ç¾åœ¨ç‚ºåƒç´ /ç§’
                    });
                }
            }
            
            // æ›´æ–°é“å…· - åŸºæ–¼æ™‚é–“çš„ç§»å‹•ï¼Œå¢åŠ å¨æ¬ŠåŠ›å ´é˜»éš”æª¢æŸ¥
            function updateItems(deltaTime) {
                if (!characterElement) return;
                
                // æ¨™æº–åŒ–æ™‚é–“å·®å€¼ï¼Œé¿å…ç‚ºé›¶
                const dt = deltaTime || (1/60);
                
                for (let i = 0; i < items.length; i++) {
                    if (items[i].active) {
                        // æª¢æŸ¥å¨æ¬ŠåŠ›å ´æ˜¯å¦é˜»éš”è² é¢é“å…·
                        if (items[i].effect === 'subtractPoints' && 
                            characterAbility === 'å¨æ¬ŠåŠ›å ´' && 
                            abilityActive && 
                            activeEffects.blockNegativeItems) {
                            
                            // è¨ˆç®—é“å…·èˆ‡è§’è‰²çš„è·é›¢
                            const itemCenterX = items[i].x + items[i].width / 2;
                            const distanceToCharacter = Math.abs(itemCenterX - characterX);
                            const protectionRadius = gameWidth * 0.3; // å¨æ¬ŠåŠ›å ´ä¿è­·åŠå¾‘
                            
                            // å¦‚æœè² é¢é“å…·é€²å…¥å¨æ¬ŠåŠ›å ´ç¯„åœï¼Œæ¨é–‹å®ƒ
                            if (distanceToCharacter < protectionRadius) {
                                const pushDirection = itemCenterX < characterX ? -1 : 1;
                                items[i].x += pushDirection * 100 * dt; // æ¨é–‹é“å…·
                                
                                // ç¢ºä¿é“å…·ä¸æœƒè¢«æ¨å‡ºå±å¹•
                                items[i].x = Math.max(0, Math.min(gameWidth - items[i].width, items[i].x));
                                
                                // å‰µå»ºè¦–è¦ºæ•ˆæœé¡¯ç¤ºé˜»éš”
                                if (Math.random() < 0.1) { // å¶çˆ¾é¡¯ç¤ºé˜»éš”æ•ˆæœ
                                    createBlockEffect(items[i].x + items[i].width/2, items[i].y + items[i].height/2);
                                }
                            }
                        }
                        
                        // ä½¿ç”¨æ™‚é–“å·®æ›´æ–°ä½ç½®
                        items[i].y += items[i].speed * dt;
                        
                        // æª¢æŸ¥æ˜¯å¦æ”¶é›†é“å…·
                        const characterLeft = characterX - (characterWidth / 2);
                        const characterRight = characterX + (characterWidth / 2);
                        const characterTop = gameHeight - characterHeight;
                        
                        if (items[i].y + items[i].height >= characterTop && 
                            items[i].y <= gameHeight &&
                            items[i].x + items[i].width >= characterLeft && 
                            items[i].x <= characterRight) {
                            
                            // æ”¶é›†é“å…·
                            collectItem(items[i]);
                            items[i].active = false;
                        }
                        
                        // ç§»é™¤è¶…å‡ºç•«é¢çš„é“å…·
                        if (items[i].y > gameHeight) {
                            items[i].active = false;
                        }
                    }
                }
                
                // æ¸…ç†ä¸æ´»èºçš„é“å…·
                items = items.filter(item => item.active);
            }
            
            // å‰µå»ºé˜»éš”æ•ˆæœ - å¨æ¬ŠåŠ›å ´æ¨é–‹è² é¢é“å…·çš„è¦–è¦ºæ•ˆæœ
            function createBlockEffect(x, y) {
                const effect = document.createElement('div');
                effect.className = 'absolute pointer-events-none z-10';
                effect.style.left = `${x}px`;
                effect.style.top = `${y}px`;
                effect.style.width = '20px';
                effect.style.height = '20px';
                effect.style.transform = 'translate(-50%, -50%)';
                effect.style.background = 'radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0.4) 50%, transparent 80%)';
                effect.style.borderRadius = '50%';
                effect.style.animation = 'pulse 0.5s ease-out';
                
                gameContainer.appendChild(effect);
                
                // è‡ªå‹•ç§»é™¤æ•ˆæœ
                setTimeout(() => {
                    if (effect.parentNode) {
                        effect.remove();
                    }
                }, 500);
            }
            
            // æ”¶é›†é“å…· - å¢åŠ å¨æ¬ŠåŠ›å ´ä¿è­·æ•ˆæœæª¢æŸ¥
            function collectItem(item) {
                // æª¢æŸ¥å¨æ¬ŠåŠ›å ´æ˜¯å¦é˜»éš”è² é¢é“å…·
                if (item.effect === 'subtractPoints' && 
                    characterAbility === 'å¨æ¬ŠåŠ›å ´' && 
                    abilityActive && 
                    activeEffects.blockNegativeItems) {
                    
                    // å¨æ¬ŠåŠ›å ´é˜»éš”è² é¢é“å…·
                    showItemEffectPopup({
                        ...item,
                        name: `${item.name} (å·²é˜»éš”)`,
                        description: 'å¨æ¬ŠåŠ›å ´é˜»éš”äº†è² é¢é“å…·çš„å½±éŸ¿ï¼',
                        isPositive: true
                    });
                    
                    // æ’­æ”¾å¨æ¬ŠåŠ›å ´ä¿è­·éŸ³æ•ˆ
                    playThunderSound('ability_å‘¨æ¨¸åœ’');
                    
                    // é¡¯ç¤ºé˜»éš”æ•ˆæœå‹•ç•«
                    showScoreAnimation('é˜»éš”!', true);
                    
                    // å¨æ¬ŠåŠ›å ´é˜»éš”æ•ˆæœ - é‡‘è‰²å…‰èŠ’
                    createItemEffect('#FFD700', 0.6);
                    
                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ‡‰ç”¨è² é¢æ•ˆæœ
                }
                
                // é¡¯ç¤ºé“å…·æ•ˆæœæç¤º
                showItemEffectPopup(item);
                
                // æ ¹æ“šé“å…·é¡å‹æ‡‰ç”¨åŠ åˆ†æˆ–æ¸›åˆ†æ•ˆæœ
                if (item.effect === 'addPoints') {
                    // åŠ åˆ†æ•ˆæœ
                    let pointValue = item.pointValue;
                    
                    // æª¢æŸ¥å¨æ¬ŠåŠ›å ´æ˜¯å¦å¢å¼·æ­£é¢é“å…·æ•ˆæœ
                    if (characterAbility === 'å¨æ¬ŠåŠ›å ´' && 
                        abilityActive && 
                        activeEffects.enhancePositiveItems) {
                        pointValue = Math.floor(pointValue * 1.5); // å¢å¼·50%æ•ˆæœ
                        
                        // é¡¯ç¤ºå¢å¼·æç¤º
                        setTimeout(() => {
                            showScoreAnimation(`å¨æ¬ŠåŠ æˆ +${pointValue - item.pointValue}`, true);
                        }, 500);
                    }
                    
                    score += pointValue;
                    
                    // æ’­æ”¾ç©æ¥µéŸ³æ•ˆ
                    playThunderSound('button');
                    
                    // é¡¯ç¤ºåŠ åˆ†å‹•ç•«
                    showScoreAnimation(`+${pointValue}`, true);
                    
                    // æ­£é¢é“å…·æ”¶é›†è¦–è¦ºæ•ˆæœ - ç¶ è‰²å…‰èŠ’
                    createItemEffect('#4CAF50', 0.4);
                    
                } else if (item.effect === 'subtractPoints') {
                    // æ‰£åˆ†æ•ˆæœï¼ˆåªæœ‰åœ¨å¨æ¬ŠåŠ›å ´æœªé˜»éš”çš„æƒ…æ³ä¸‹æ‰æœƒåŸ·è¡Œåˆ°é€™è£¡ï¼‰
                    score = Math.max(0, score + item.pointValue); // ä½¿ç”¨ += å› ç‚º pointValue å·²ç¶“æ˜¯è² æ•¸
                    
                    // æ’­æ”¾æ¶ˆæ¥µéŸ³æ•ˆ
                    playThunderSound('random');
                    
                    // é¡¯ç¤ºæ‰£åˆ†å‹•ç•«
                    showScoreAnimation(item.pointValue, false);
                    
                    // è² é¢é“å…·æ”¶é›†è¦–è¦ºæ•ˆæœ - ç´…è‰²å…‰èŠ’
                    createItemEffect('#F44336', 0.4);
                    
                    // éœ‡å‹•æ•ˆæœ
                    gameContainer.classList.add('strong-shake');
                    setTimeout(() => {
                        gameContainer.classList.remove('strong-shake');
                    }, 500);
                }
                
                // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
                scoreElement.textContent = score;
                
                // ç§»é™¤ä¹‹å‰çš„å°è©æ°£æ³¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (currentQuoteBubble) {
                    currentQuoteBubble.remove();
                    currentQuoteBubble = null;
                }
                
                // è¼”åŠ©å‡½æ•¸ï¼šå‰µå»ºé“å…·æ•ˆæœ
                function createItemEffect(color, opacity) {
                    const effect = document.createElement('div');
                    effect.className = 'absolute bottom-16 left-1/2 transform -translate-x-1/2 z-5 pointer-events-none';
                    effect.style.width = `${characterWidth * 1.8}px`;
                    effect.style.height = `${characterHeight * 1.5}px`;
                    effect.style.background = `radial-gradient(ellipse at center, ${color}99 0%, ${color}${Math.floor(opacity * 255).toString(16)} 20%, transparent 70%)`;
                    effect.style.borderRadius = '50%';
                    effect.style.animation = 'pulse 1.5s';
                    effect.style.opacity = '0.8';
                    
                    gameContainer.appendChild(effect);
                    
                    // æ•ˆæœè‡ªå‹•ç§»é™¤
                    setTimeout(() => {
                        effect.style.opacity = '0';
                        effect.style.transition = 'opacity 0.5s';
                        setTimeout(() => effect.remove(), 500);
                    }, 1200);
                }
            }
            
            // é¡¯ç¤ºåˆ†æ•¸è®ŠåŒ–å‹•ç•«
            function showScoreAnimation(points, isPositive) {
                const animation = document.createElement('div');
                animation.className = 'absolute z-30 text-lg font-bold';
                animation.style.left = `${characterX}px`;
                animation.style.bottom = `${characterHeight + 20}px`;
                animation.style.transform = 'translate(-50%, 0)';
                animation.style.textShadow = '0 0 3px rgba(0,0,0,0.7)';
                
                if (isPositive) {
                    // åŠ åˆ†å‹•ç•«
                    animation.style.color = '#4CAF50';
                    animation.innerHTML = `+${points}`;
                } else {
                    // æ¸›åˆ†å‹•ç•«
                    animation.style.color = '#F44336';
                    animation.innerHTML = points; // å·²ç¶“æ˜¯è² æ•¸
                }
                
                // æ·»åŠ å‹•ç•«æ•ˆæœ
                animation.style.animation = 'scoreFloat 1.5s ease-out forwards';
                
                // æ·»åŠ CSSå‹•ç•«
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    @keyframes scoreFloat {
                        0% { transform: translate(-50%, 0); opacity: 1; }
                        100% { transform: translate(-50%, -50px); opacity: 0; }
                    }
                `;
                document.head.appendChild(styleElement);
                
                gameContainer.appendChild(animation);
                
                // è‡ªå‹•ç§»é™¤
                setTimeout(() => {
                    animation.remove();
                }, 1500);
            }
            
            // é¡¯ç¤ºé“å…·æ•ˆæœæç¤º - æ›´æ–°ç‚ºå±•ç¤ºåŠ åˆ†æˆ–æ¸›åˆ†æ•ˆæœ
            function showItemEffectPopup(item) {
                const popupElement = document.createElement('div');
                popupElement.classList.add('absolute', 'top-1/4', 'left-1/2', 'transform', '-translate-x-1/2', 'bg-black', 'bg-opacity-80', 'text-white', 'rounded-lg', 'p-3', 'text-center', 'z-30');
                
                // æ ¹æ“šé“å…·æ˜¯åŠ åˆ†é‚„æ˜¯æ¸›åˆ†æ±ºå®šé¡è‰²å’Œåœ–æ¨™
                const effectColor = item.isPositive ? '#4CAF50' : '#F44336';
                const effectIcon = item.isPositive ? 'â†‘' : 'â†“';
                const pointsText = item.isPositive ? `+${item.pointValue}` : item.pointValue;
                
                popupElement.innerHTML = `
                    <div class="font-bold text-sm mb-1" style="color: ${item.color}">${item.name} <span style="color: ${effectColor}">${pointsText}</span></div>
                    <div class="text-xs px-2">${item.description}</div>
                    <div class="mt-1 text-xs font-medium rounded-full px-2 py-0.5 inline-block" style="background-color: ${effectColor}30;">
                        ${effectIcon} ${item.isPositive ? 'ç©æ¥µæ„è±¡' : 'æ¶ˆæ¥µæ„è±¡'}
                    </div>
                `;
                
                document.getElementById('game-container').appendChild(popupElement);
                
                setTimeout(() => {
                    popupElement.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => {
                        if (popupElement.parentNode) {
                            popupElement.remove();
                        }
                    }, 500);
                }, 2500); // å»¶é•·é¡¯ç¤ºæ™‚é–“
            }
            
            // ç¹ªè£½é“å…· - ç¢ºä¿èˆ‡é¦–é é¡¯ç¤ºä¸€è‡´
            function drawItems() {
                for (const item of items) {
                    // ä½¿ç”¨ç›¸åŒçš„é“å…·åœ–æ¨™é‚è¼¯
                    if(window.itemDetails && window.itemDetails[item.id]) {
                        // ç²å–èˆ‡é–‹å§‹ä»‹é¢ä¸€è‡´çš„é“å…·åœ–æ¨™
                        const itemDetail = window.itemDetails[item.id];
                        
                        // ç¹ªè£½åœ“å½¢èƒŒæ™¯ - ä½¿ç”¨èˆ‡é–‹å§‹ä»‹é¢ä¸€è‡´çš„æ¼¸è®Šæ•ˆæœ
                        const gradient = ctx.createRadialGradient(
                            item.x + item.width/2, item.y + item.height/2, 0,
                            item.x + item.width/2, item.y + item.height/2, item.width/2
                        );
                        
                        // å¾äº®åˆ°æš—çš„æ¼¸è®Šï¼Œé¡ä¼¼é¦–é çš„æ¼¸è®Š
                        const lighterColor = adjustColor(item.color, 30);
                        gradient.addColorStop(0, lighterColor);
                        gradient.addColorStop(1, item.color);
                        
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // ç¹ªè£½é“å…·ç¬¦è™Ÿ - ä½¿ç”¨ç›¸åŒçš„ç¬¦è™Ÿ
                        ctx.fillStyle = 'white';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(itemDetail.icon || item.symbol, item.x + item.width/2, item.y + item.height/2);
                    } else {
                        // å‚™ç”¨æ–¹æ¡ˆï¼Œä¿ç•™åŸæœ‰é“å…·ç¹ªè£½æ–¹å¼
                        ctx.fillStyle = item.color;
                        ctx.beginPath();
                        ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // ç¹ªè£½é“å…·ç¬¦è™Ÿ
                        ctx.fillStyle = 'white';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(item.symbol, item.x + item.width/2, item.y + item.height/2);
                    }
                    
                    // ç™¼å…‰æ•ˆæœ
                    ctx.shadowColor = item.color;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2 - 2, 0, Math.PI * 2);
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // é‡ç½®é™°å½±
                    ctx.shadowBlur = 0;
                    ctx.shadowColor = 'transparent';
                }
                
                // è¼”åŠ©å‡½æ•¸ï¼šèª¿æ•´é¡è‰²äº®åº¦ (èˆ‡å½ˆå‡ºè©³æƒ…ä¸­ç›¸åŒ)
                function adjustColor(color, percent) {
                    var R = parseInt(color.substring(1,3),16);
                    var G = parseInt(color.substring(3,5),16);
                    var B = parseInt(color.substring(5,7),16);
                
                    R = parseInt(R * (100 + percent) / 100);
                    G = parseInt(G * (100 + percent) / 100);
                    B = parseInt(B * (100 + percent) / 100);
                
                    R = (R<255)?R:255;  
                    G = (G<255)?G:255;  
                    B = (B<255)?B:255;  
                
                    R = Math.max(0, R);
                    G = Math.max(0, G);
                    B = Math.max(0, B);
                
                    var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
                    var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
                    var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
                
                    return "#"+RR+GG+BB;
                }
            }
            
            // é¡¯ç¤ºé–ƒé›»é è­¦ - ç‚ºå››é³³å¢å¼·é è­¦æ•ˆæœï¼ˆä½¿ç”¨å„ªåŒ–å¾Œçš„é¡¯ç¤ºæ–¹å¼ï¼‰
            function showLightningWarning(x, isEnhanced = false) {
                if (!gameContainer) return;
              
                // å‰µå»ºé è­¦å…ƒç´ 
                const warningElement = document.createElement('div');
                warningElement.classList.add('absolute', 'z-10');
                warningElement.style.left = `${x}px`;
                warningElement.style.top = '10px';
                warningElement.style.transform = 'translateX(-50%)';
                
                // æª¢æŸ¥å››é³³çš„é çŸ¥é–ƒé¿èƒ½åŠ›
                if (isEnhanced) {
                    // å¢å¼·é è­¦ - æ›´å¤§ã€æ›´æ˜é¡¯çš„é–ƒé›» - ä½¿ç”¨å„ªåŒ–å¾Œçš„é¡¯ç¤ºæ–¹å¼
                    warningElement.classList.add('w-10', 'h-12'); // å¢åŠ åœ–æ¨™å°ºå¯¸
                    warningElement.innerHTML = `
                        <div class="relative">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 40, 40, 0.95)" class="animate-pulse drop-shadow-lg" style="filter: drop-shadow(0 0 5px rgba(255, 40, 40, 0.8));">
                                <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <div class="absolute top-full left-1/2 transform -translate-x-1/2 text-xs text-red-500 font-bold bg-black bg-opacity-50 px-2 rounded-full whitespace-nowrap">å±éšªå€åŸŸ!</div>
                            <div class="absolute inset-0 rounded-full animate-ping bg-red-500 opacity-30"></div>
                        </div>
                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 pointer-events-none">
                            <!-- å„ªåŒ–é¡¯ç¤ºæ–¹å¼ï¼šæ›´æ˜é¡¯çš„é è­¦è·¯å¾‘ -->
                            <div class="h-96 w-2 bg-gradient-to-b from-red-500 to-transparent animate-pulse"></div>
                            
                            <!-- å„ªåŒ–é¡¯ç¤ºæ–¹å¼ï¼šæ›´æ˜é¡¯çš„è™›ç·šæŒ‡ç¤º -->
                            <div class="h-96 w-1 absolute top-0 left-1/2 transform -translate-x-1/2" 
                                 style="background: repeating-linear-gradient(to bottom, rgba(255,50,50,1) 0px, rgba(255,50,50,1) 6px, transparent 6px, transparent 12px);"></div>
                                 
                            <!-- å„ªåŒ–é¡¯ç¤ºæ–¹å¼ï¼šé¡¯ç¤ºç®­é ­å¼·èª¿å±éšªä½ç½® -->
                            <div class="absolute bottom-12 left-1/2 transform -translate-x-1/2 opacity-90">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 40, 40, 1)" class="w-6 h-6 animate-bounce">
                                    <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8-8-8z" transform="rotate(90 12 12)" />
                                </svg>
                            </div>
                            
                            <!-- åº•éƒ¨é–ƒé›»æ¨™è¨˜ -->
                            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 opacity-80">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 40, 40, 1)" class="w-8 h-8">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                        </div>
                    `;
                    
                    // æ’­æ”¾é›·è²ä½œç‚ºé è­¦
                    playThunderSound('button');
                    
                    // æ›´é•·çš„é è­¦é¡¯ç¤ºæ™‚é–“
                    setTimeout(() => {
                        warningElement.style.opacity = '0';
                        warningElement.style.transition = 'opacity 0.6s';
                        setTimeout(() => {
                            if (warningElement.parentNode) {
                                warningElement.remove();
                            }
                        }, 600);
                    }, 1800); // å¢åŠ è‡³1800æ¯«ç§’ï¼ˆæ¯”ä¹‹å‰é•·ä¸€å€ï¼‰
                } else {
                    // æ™®é€šé è­¦ - æ›´å¼±çš„è¦–è¦ºæç¤º
                    warningElement.classList.add('w-5', 'h-5'); // æ›´å°çš„åœ–æ¨™
                    warningElement.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 215, 0, 0.7)" class="animate-pulse">
                            <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    `;
                    
                    // æ›´çŸ­çš„é è­¦é¡¯ç¤ºæ™‚é–“
                    setTimeout(() => {
                        warningElement.style.opacity = '0';
                        warningElement.style.transition = 'opacity 0.2s';
                        setTimeout(() => {
                            if (warningElement.parentNode) {
                                warningElement.remove();
                            }
                        }, 200);
                    }, 400); // æ­£å¸¸é›£åº¦ç¶­æŒä¸è®Š
                }
                
                gameContainer.appendChild(warningElement);
            }
            
            // å››é³³çš„é çŸ¥é–ƒé¿ç‰¹æ®Šèƒ½åŠ› - é¡¯ç¤ºæ‰€æœ‰å³å°‡ç”Ÿæˆçš„é–ƒé›»é è­¦
            function showAllFutureLightningWarnings() {
                if (!gameContainer) return;
                
                // æ’­æ”¾é çŸ¥éŸ³æ•ˆ
                playThunderSound('button');
                
                // é¦–å…ˆæ¸…é™¤æ‰€æœ‰ç°æœ‰çš„é¢„è­¦(åŒ…æ‹¬æ™®é€šé¢„è­¦)
                const existingWarnings = document.querySelectorAll('.lightning-warning');
                existingWarnings.forEach(warning => {
                    warning.remove();
                });
                
                // å»ºç«‹é–ƒé›»é æ¸¬å€åŸŸ - å°‡ç•«é¢åˆ†ç‚ºå¹¾å€‹å€åŸŸ
                const sectionCount = 5; // èˆ‡é–ƒé›»ç”Ÿæˆé‚è¼¯ç›¸åŒ
                const sectionWidth = gameWidth / sectionCount;
                
                // ç”¢ç”Ÿ3-5å€‹æœªä¾†é–ƒé›»ä½ç½®é æ¸¬
                const predictCount = Math.floor(3 + Math.random() * 3);
                const predictedPositions = [];
                
                // é æ¸¬æœªä¾†å¯èƒ½çš„é–ƒé›»ä½ç½®
                for (let i = 0; i < predictCount; i++) {
                    // é¸æ“‡ä¸€å€‹éš¨æ©Ÿå€åŸŸ
                    const section = Math.floor(Math.random() * sectionCount);
                    
                    // ç¢ºä¿ä¸é‡è¤‡é¡¯ç¤ºåœ¨åŒä¸€å€åŸŸ
                    if (predictedPositions.some(pos => Math.abs(pos.section - section) < 1)) {
                        continue;
                    }
                    
                    // åœ¨è©²å€åŸŸå…§è¨­å®šä¸€å€‹ä½ç½®ï¼Œæ¨¡æ“¬é–ƒé›»ç”Ÿæˆé‚è¼¯
                    const offset = (Math.random() * 0.6 + 0.2) * sectionWidth;
                    const lightningX = section * sectionWidth + offset;
                    
                    // æ·»åŠ åˆ°é æ¸¬ä½ç½®åˆ—è¡¨
                    predictedPositions.push({
                        x: lightningX,
                        section: section,
                        delay: 100 + Math.random() * 200 // éš¨æ©Ÿå»¶é²é¡¯ç¤º
                    });
                }
                
                // å‰µå»ºè¦–è¦ºæ•ˆæœ - æ¨¡ç³ŠèƒŒæ™¯
                const enhancedVisionEffect = document.createElement('div');
                enhancedVisionEffect.className = 'absolute inset-0 z-5 pointer-events-none';
                enhancedVisionEffect.style.background = 'radial-gradient(circle, rgba(255,204,102,0) 0%, rgba(255,204,102,0.1) 100%)';
                enhancedVisionEffect.style.backdropFilter = 'contrast(1.05) saturate(1.1)';
                
                gameContainer.appendChild(enhancedVisionEffect);
                
                // ä¾æ¬¡é¡¯ç¤ºé æ¸¬çš„é–ƒé›»ä½ç½®
                predictedPositions.forEach((pos, index) => {
                    setTimeout(() => {
                        // å‰µå»ºç‰¹æ®Šçš„æœªä¾†é–ƒé›»é è­¦ - èˆ‡ä¸€èˆ¬é è­¦ä¸åŒï¼Œæ›´æœ‰æœªä¾†æ„Ÿ
                        const futureWarning = document.createElement('div');
                        futureWarning.className = 'absolute z-9 lightning-warning future-warning'; // æ·»åŠ ç±»åä»¥ä¾¿è¯†åˆ«å’Œç§»é™¤
                        futureWarning.style.left = `${pos.x}px`;
                        futureWarning.style.top = '10px';
                        futureWarning.style.transform = 'translateX(-50%)';
                        futureWarning.style.opacity = '0';
                        futureWarning.style.transition = 'opacity 0.5s';
                        
                        // ä½¿ç”¨ä¸åŒçš„é¡è‰²å’Œæ•ˆæœï¼Œä»£è¡¨é€™æ˜¯é è¦‹è€Œéç•¶å‰å¨è„…
                        futureWarning.innerHTML = `
                            <div class="relative w-7 h-16">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255, 204, 102, 0.7)" class="w-7 h-7">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <div class="h-10 w-1 bg-gradient-to-b from-yellow-400 to-transparent absolute top-6 left-1/2 transform -translate-x-1/2"></div>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 text-xs text-yellow-400 whitespace-nowrap">é è¦‹é–ƒé›»</div>
                            </div>
                        `;
                        
                        gameContainer.appendChild(futureWarning);
                        
                        // æ·¡å…¥æ•ˆæœ
                        setTimeout(() => {
                            futureWarning.style.opacity = '0.85';
                        }, 50);
                        
                        // é¡¯ç¤ºä¸€æ®µæ™‚é–“å¾Œæ·¡å‡º
                        setTimeout(() => {
                            futureWarning.style.opacity = '0';
                            setTimeout(() => {
                                if (futureWarning.parentNode) {
                                    futureWarning.remove();
                                }
                            }, 500);
                        }, 3000 + index * 300); // éŒ¯é–‹æ¯å€‹é è­¦çš„æ¶ˆå¤±æ™‚é–“
                    }, pos.delay);
                });
                
                // ç§»é™¤èƒŒæ™¯æ•ˆæœ
                setTimeout(() => {
                    enhancedVisionEffect.style.opacity = '0';
                    enhancedVisionEffect.style.transition = 'opacity 0.8s';
                    setTimeout(() => {
                        if (enhancedVisionEffect.parentNode) {
                            enhancedVisionEffect.remove();
                        }
                    }, 800);
                }, 3500);
            }
            
            // æ›´æ–°éŠæˆ²ç‹€æ…‹ - åŸºæ–¼æ™‚é–“çš„æ›´æ–°
            function updateGame(deltaTime) {
                // æ¨™æº–åŒ–æ™‚é–“å·®å€¼ï¼Œç¢ºä¿åœ¨ä¸åŒåˆ·æ–°ç‡ä¸‹éŠæˆ²é€Ÿåº¦ä¸€è‡´
                // å¦‚æœdeltaTimeæœªå®šç¾©æˆ–ç‚ºé›¶ï¼ˆä»¥é˜²è¬ä¸€ï¼‰ï¼Œä½¿ç”¨é è¨­å€¼
                const dt = deltaTime || (1/60); // é»˜èªç‚º60 FPS
                
                // è¨ˆåˆ†å™¨
                frameCount++;
                if (frameCount % 3 === 0) {
                    score++;
                    scoreElement.textContent = score;
                }
                
                // æ ¹æ“šåˆ†æ•¸èª¿æ•´é›£åº¦ - åŠ å¿«é›£åº¦å¢é•·é€Ÿåº¦
                level = Math.floor(score / 400) + 1;
                levelElement.textContent = level;
                
                // æ›´æ–°è§’è‰²èƒ½åŠ›ç‹€æ…‹
                updateAbilityStatus();
                
                // ç”¢ç”Ÿé“å…· - ä½¿ç”¨åŸºæ–¼æ™‚é–“çš„æ¦‚ç‡
                generateItem(dt);
                
                // æ›´æ–°é“å…· - åŸºæ–¼æ™‚é–“ç§»å‹•
                updateItems(dt);
                
                // ç²å–éŠæˆ²åˆ†æ•¸éšæ®µ - ç§»é™¤ä¿è­·æœŸï¼Œç«‹å³é–‹å§‹é«˜é›£åº¦
                // ç§»é™¤é–‹å§‹çš„ä¿è­·æ™‚é–“ï¼Œé–ƒé›»å¾ä¸€é–‹å§‹å°±ç«‹å³ç”Ÿæˆ
                const initialPeriod = score < 120; // ç¸®çŸ­åˆå§‹é©æ‡‰æœŸ
                const moderatePeriod = score < 400; // é™ä½ä¸­ç­‰é›£åº¦æœŸé–€æª»
                
                // é–ƒé›»ç”Ÿæˆæ©Ÿç‡ï¼Œå¤§å¹…æé«˜éŠæˆ²é›£åº¦ - ä¸¦æ ¹æ“šdeltaTimeé€²è¡Œèª¿æ•´
                // é€™ä½¿å¾—ç„¡è«–åˆ·æ–°ç‡å¤šå°‘ï¼Œç”Ÿæˆæ¦‚ç‡éƒ½ä¿æŒä¸€è‡´
                let baseLightningChance;
                if (initialPeriod) {
                    baseLightningChance = 0.008; // å¤§å¹…æé«˜åˆå§‹é›£åº¦ï¼ŒéŠæˆ²ä¸€é–‹å§‹å°±å…·æœ‰æŒ‘æˆ°æ€§
                } else if (moderatePeriod) {
                    baseLightningChance = 0.012 + (level * 0.002); // åŠ å¿«å¢é•·æ›²ç·šï¼Œæé«˜ä¸­æœŸé›£åº¦
                } else {
                    // é«˜ç´šé›£åº¦ï¼Œæé«˜ä¸Šé™å’ŒåŸºç¤å€¼
                    baseLightningChance = Math.min(0.02 + (level * 0.003), 0.06); // æé«˜ä¸Šé™å’Œå¢é•·é€Ÿåº¦
                }
                
                // å°‡æ¯å¹€æ¦‚ç‡è½‰æ›ç‚ºæ™‚é–“åŸºç¤æ¦‚ç‡
                // å…¬å¼: 1 - (1 - æ¯å¹€æ¦‚ç‡)^(deltaTime * 60)
                // ç¢ºä¿ç”Ÿæˆç‡èˆ‡æ™‚é–“æˆæ­£æ¯”ï¼Œè€Œä¸æ˜¯èˆ‡å¹€ç‡æˆæ­£æ¯”
                const lightningChance = 1 - Math.pow(1 - baseLightningChance, dt * 60);
                
                // ç¢ºä¿ä¸æœƒçŸ­æ™‚é–“å…§ç”Ÿæˆå¤ªå¤šé–ƒé›»
                let adjustedLightningChance = lightningChance;
                if (lightning.length > 3 + level) {
                    adjustedLightningChance *= 0.5; // å·²å­˜åœ¨è¼ƒå¤šé–ƒé›»æ™‚æ¸›å°‘ç”Ÿæˆæ©Ÿç‡
                }
                if (lightning.length > 5 + level) {
                    adjustedLightningChance *= 0.25; // é–ƒé›»æ•¸é‡éå¤šæ™‚å¤§å¹…é™ä½ç”Ÿæˆæ©Ÿç‡
                }
                
                // æª¢æŸ¥èˆŠé›¨è¡£æ•ˆæœï¼ˆæ¸›å°‘é–ƒé›»ç”Ÿæˆï¼‰
                if (activeEffects.reduceLightningChance) {
                    adjustedLightningChance *= 0.5; // æ¸›å°‘ä¸€åŠé–ƒé›»ç”Ÿæˆæ©Ÿç‡
                }
                
                if (Math.random() < adjustedLightningChance) {
                    // ç•«é¢åˆ†ç‚ºå¹¾å€‹å€åŸŸï¼Œæ¯å€‹å€åŸŸåªç”Ÿæˆä¸€å€‹é–ƒé›»ï¼Œç¢ºä¿æœ‰ç©ºéš™å¯é€ƒ
                    const sectionCount = 5;
                    const sectionWidth = gameWidth / sectionCount;
                    
                    // éš¨æ©Ÿé¸æ“‡ä¸€å€‹å€åŸŸ
                    const section = Math.floor(Math.random() * sectionCount);
                    
                    // åœ¨é¸ä¸­çš„å€åŸŸå…§éš¨æ©Ÿç”Ÿæˆé–ƒé›»ä½ç½®ï¼Œä½†é¿å…ä½æ–¼å€åŸŸçš„æœ€ä¸­é–“ä½ç½®
                    const offset = (Math.random() * 0.6 + 0.2) * sectionWidth;
                    const lightningX = section * sectionWidth + offset;
                    
                    // æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºé–ƒé›»é è­¦
                    let showWarning = false;
                    
                    if (characterAbility === 'é çŸ¥é–ƒé¿') {
                        // å››é³³è§’è‰²çš„é è­¦é‚è¼¯ï¼šåªåœ¨èƒ½åŠ›æ¿€æ´»æ™‚æ‰é¡¯ç¤ºå¢å¼·é è­¦ï¼Œå¦å‰‡ä¸é¡¯ç¤ºä»»ä½•é è­¦
                        if (abilityActive && activeEffects.enhancedWarning) {
                            showWarning = true;
                            showLightningWarning(lightningX, true); // å‚³å…¥trueè¡¨ç¤ºæ˜¯å››é³³çš„å¢å¼·é è­¦
                        }
                        // æ²’æœ‰elseéƒ¨åˆ†ï¼Œç¢ºä¿å››é³³æœªæ¿€æ´»èƒ½åŠ›æ™‚ä¸é¡¯ç¤ºæ™®é€šé è­¦
                    } else {
                        // å…¶ä»–è§’è‰²çš„é è­¦é‚è¼¯ï¼šæ ¹æ“šç´šåˆ¥å’Œéš¨æ©Ÿæ¦‚ç‡é¡¯ç¤ºæ™®é€šé è­¦
                        if (level >= 2 && Math.random() < 0.55) {
                            showWarning = true;
                            showLightningWarning(lightningX, false);
                        }
                    }
                    
                    // æ·»åŠ æ›´å¤šé–ƒé›»è®ŠåŒ–
                    const width = 8 + Math.random() * (5 + level);
                    const height = 20 + Math.random() * (15 + level * 5);
                    
                    // è¨­ç½®åŸºç¤é€Ÿåº¦å¸¸æ•¸ - é€™å°‡ç¢ºä¿åœ¨æ‰€æœ‰è£ç½®ä¸Šç›¸åŒçš„ä¸‹è½é€Ÿåº¦
                    // å–®ä½: åƒç´ /ç§’ - å¢åŠ åŸºç¤é€Ÿåº¦å’Œéš¨æ©ŸåŠ æˆ
                    const BASE_LIGHTNING_SPEED = 150 + (level * 20) + (Math.random() * 90);
                    let speed = BASE_LIGHTNING_SPEED;
                    
                    // æª¢æŸ¥å‘¨æ¨¸åœ’çš„å¨æ¬ŠåŠ›å ´æ¸›é€Ÿæ•ˆæœ
                    if (characterAbility === 'å¨æ¬ŠåŠ›å ´' && activeEffects.slowLightningFall) {
                        speed *= 0.6; // æ¸›æ…¢40%é–ƒé›»é€Ÿåº¦
                    }
                    
                    // æª¢æŸ¥é“å…·æ¸›é€Ÿæ•ˆæœ
                    if (activeEffects.slowLightning) {
                        speed *= 0.7; // æ¸›æ…¢30%é–ƒé›»é€Ÿåº¦
                    }
                    
                    lightning.push({
                        x: lightningX,
                        y: 0,
                        width: width,
                        height: height,
                        speed: speed, // é€Ÿåº¦ç¾åœ¨ç‚ºåƒç´ /ç§’
                        active: true,
                        // æ·»åŠ é–ƒé›»è®ŠåŒ–å±¬æ€§
                        color: Math.random() < 0.2 ? 'blue' : 'yellow', // å¶çˆ¾å‡ºç¾è—è‰²é–ƒé›»
                        branches: Math.floor(Math.random() * 3) + 1, // åˆ†æ”¯æ•¸é‡
                        intensity: 0.7 + Math.random() * 0.3, // é–ƒé›»å¼·åº¦è®ŠåŒ–
                        warning: showWarning // è¨˜éŒ„é€™å€‹é–ƒé›»æ˜¯å¦å·²é¡¯ç¤ºéé è­¦
                    });
                }
                
                // æ›´æ–°é–ƒé›»ä½ç½® - åŸºæ–¼æ™‚é–“ç§»å‹•
                for (let i = 0; i < lightning.length; i++) {
                    if (lightning[i].active) {
                        // è·é›¢ = é€Ÿåº¦ Ã— æ™‚é–“å·®å€¼ (dt)
                        lightning[i].y += lightning[i].speed * dt;
                        
                        // æª¢æŸ¥æ˜¯å¦æ“Šä¸­è§’è‰²
                        if (characterElement) {
                            const characterLeft = characterX - (characterWidth / 2);
                            const characterRight = characterX + (characterWidth / 2);
                            const characterTop = gameHeight - characterHeight;
                            
                            if (lightning[i].y + lightning[i].height >= characterTop && 
                                lightning[i].y <= gameHeight &&
                                lightning[i].x + lightning[i].width >= characterLeft && 
                                lightning[i].x <= characterRight) {
                                
                                // æª¢æŸ¥æ˜¯å¦æœ‰ç„¡æ•µç‹€æ…‹
                                if (invincible) {
                                    // ç„¡æ•µç‹€æ…‹ä¸‹ä¸å—å‚·å®³
                                    lightning[i].active = false;
                                    continue;
                                }
                                
                                // æª¢æŸ¥é­¯ä¾èçš„éš±å¿å …éŸŒèƒ½åŠ›
                                if (characterAbility === 'éš±å¿å …éŸŒ' && activeEffects.oneTimeImmunity) {
                                    // æ¶ˆè€—ä¸€æ¬¡æ€§å…ç–«
                                    activeEffects.oneTimeImmunity = false;
                                    abilityActive = false;
                                    abilityCooldown = true;
                                    abilityCooldownTime = getAbilityCooldown();
                                    
                                    // é¡¯ç¤ºå…ç–«æ•ˆæœ
                                    const immunityEffect = document.createElement('div');
                                    immunityEffect.classList.add('absolute', 'inset-0', 'flex', 'items-center', 'justify-center', 'text-white', 'text-xl', 'font-bold', 'z-30');
                                    immunityEffect.innerHTML = '<div class="bg-purple-700 bg-opacity-60 px-4 py-2 rounded">éš±å¿å …éŸŒ - å…ç–«!</div>';
                                    gameContainer.appendChild(immunityEffect);
                                    
                                    // ç§»é™¤é–ƒé›»å’Œæ•ˆæœ
                                    lightning[i].active = false;
                                    setTimeout(() => {
                                        if (immunityEffect.parentNode) {
                                            immunityEffect.remove();
                                        }
                                    }, 1500);
                                    
                                    // æ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
                                    playThunderSound('button');
                                    continue;
                                }
                                
                                // å¦‚æœæ²’æœ‰å…ç–«ï¼ŒçµæŸéŠæˆ²
                                gameOver();
                                return;
                            }
                        }
                        
                        // ç§»é™¤è¶…å‡ºç•«é¢çš„é–ƒé›»
                        if (lightning[i].y > gameHeight) {
                            lightning[i].active = false;
                        }
                    }
                }
                
                // æ¸…ç†ä¸æ´»èºçš„é–ƒé›»
                lightning = lightning.filter(l => l.active);
                
                // æ›´æ–°è§’è‰²å°è©æ°£æ³¡ä½ç½®
                updateQuoteBubblePosition();
            }
            
            // ç¹ªè£½éŠæˆ²
            function drawGame() {
                // æ¸…ç©ºç•«å¸ƒ
                ctx.clearRect(0, 0, gameWidth, gameHeight);
                
                // ç¹ªè£½é™°å¤©èƒŒæ™¯
                const isDarkMode = document.documentElement.classList.contains('dark');
                const gradient = ctx.createLinearGradient(0, 0, 0, gameHeight);
                
                if (isDarkMode) {
                    gradient.addColorStop(0, '#0a1120'); // æ›´æš—çš„è—é»‘è‰²
                    gradient.addColorStop(0.6, '#1a2234'); // ä¸­é–“å€åŸŸçš„æ·±è‰²
                    gradient.addColorStop(1, '#252d3f'); // åº•éƒ¨çš„éæ¸¡è‰²
                } else {
                    gradient.addColorStop(0, '#4b5d78'); // é™°å¤©çš„ç°è—è‰²ä¸Šå±¤
                    gradient.addColorStop(0.6, '#667788'); // ä¸­é–“çš„ç°è‰²
                    gradient.addColorStop(1, '#7f8a99'); // åº•éƒ¨è¼ƒæ·ºçš„ç°è‰²
                }
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, gameWidth, gameHeight);
                
                // æ·»åŠ å‹•æ…‹ç…™éœ§æ•ˆæœ
                const time = Date.now() / 5000;
                
                // ç¹ªè£½å¤šå±¤æ¬¡çš„é›²å’Œç…™éœ§
                function drawClouds(y, size, speed, count, opacity) {
                    const cloudColor = isDarkMode 
                        ? `rgba(25, 33, 46, ${opacity})`
                        : `rgba(80, 92, 110, ${opacity})`;
                    
                    for (let i = 0; i < count; i++) {
                        const offsetX = Math.sin(time * 0.5 + i) * 10; // æ·»åŠ è¼•å¾®æ–å‹•
                        const cloudX = ((time * speed) * gameWidth + i * (gameWidth / count)) % (gameWidth + 100) - 50 + offsetX;
                        const cloudY = y + Math.sin(time + i * 2) * 10; // ä¸Šä¸‹è¼•å¾®æµ®å‹•
                        
                        ctx.fillStyle = cloudColor;
                        ctx.beginPath();
                        
                        // ç•«ä¸€çµ„é€£çºŒçš„é›²æœµå½¢ç‹€
                        const cloudWidth = size * (0.8 + Math.sin(i * 0.4) * 0.2); // è®ŠåŒ–çš„é›²å¤§å°
                        for (let j = 0; j < 5; j++) {
                            const circleX = cloudX + j * (cloudWidth/6);
                            const circleY = cloudY + (j % 2 === 0 ? -5 : 5);
                            const radius = cloudWidth * (0.3 + (j % 3) * 0.1);
                            
                            ctx.arc(circleX, circleY, radius, 0, Math.PI * 2);
                        }
                        
                        ctx.fill();
                    }
                }
                
                // ç¹ªè£½ä¸‰å±¤é›²å±¤ï¼Œè£½é€ æ·±åº¦æ„Ÿ
                drawClouds(30, 55, 0.1, 4, 0.9);  // æœ€ä¸Šå±¤å¤§é›²
                drawClouds(120, 35, 0.15, 6, 0.7); // ä¸­å±¤é›²
                drawClouds(70, 25, 0.2, 5, 0.5);  // å¾Œå±¤å°é›²
                
                // ç¹ªè£½é›¨æ»´æ•ˆæœ
                const rainIntensity = 0.5 + Math.sin(time) * 0.2; // é›¨é‡éš¨æ™‚é–“è®ŠåŒ– - å¢åŠ åŸºç¤é›¨é‡
                const rainCount = Math.floor(rainIntensity * 150); // é›¨æ»´æ•¸é‡ - å¢åŠ é›¨æ»´å¯†åº¦
                
                const rainColor = isDarkMode 
                    ? 'rgba(130, 160, 210, 0.7)' // å¢å¼·ä¸é€æ˜åº¦
                    : 'rgba(180, 200, 230, 0.7)';
                
                ctx.strokeStyle = rainColor;
                ctx.lineWidth = 1;
                
                for (let i = 0; i < rainCount; i++) {
                    const rainX = Math.random() * gameWidth;
                    const rainY = (Math.random() * gameHeight * 0.7) + (time * 100 + i * 50) % gameHeight;
                    const rainLength = 10 + Math.random() * 20; // å¢åŠ é›¨æ»´é•·åº¦
                    
                    ctx.beginPath();
                    ctx.moveTo(rainX, rainY);
                    ctx.lineTo(rainX - 3, rainY + rainLength); // å¢åŠ é›¨æ»´å‚¾æ–œåº¦
                    ctx.stroke();
                }
                
                // ç¹ªè£½é“å…·
                drawItems();
                
                // ç¹ªè£½é–ƒé›»
                for (const bolt of lightning) {
                    // åœ¨ç•«é¢ä¸Šç”¢ç”Ÿé–ƒçˆæ•ˆæœ
                    if (Math.random() < 0.1) { // å¢åŠ é–ƒçˆé »ç‡
                        gameContainer.classList.add('screen-flash');
                        setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
                        
                        // æ’­æ”¾é–ƒé›»éŸ³æ•ˆ - éš¨æ©Ÿåˆ¤æ–·æ˜¯å¦æ’­æ”¾
                        if (Math.random() < 0.3) {
                            playThunderSound('random');
                        }
                    }
                    
                    // é–ƒé›»çš„é¡è‰²
                    const lightningGradient = ctx.createLinearGradient(
                        bolt.x, bolt.y, 
                        bolt.x + bolt.width, bolt.y + bolt.height
                    );
                    lightningGradient.addColorStop(0, 'rgba(255, 255, 150, 0.9)');
                    lightningGradient.addColorStop(0.5, 'rgba(255, 255, 255, 1)');
                    lightningGradient.addColorStop(1, 'rgba(255, 255, 100, 0.9)');
                    
                    // ç¹ªè£½æ›´è¤‡é›œçš„é–ƒé›»å½¢ç‹€
                    ctx.beginPath();
                    let currentX = bolt.x;
                    let currentY = bolt.y;
                    const segments = Math.floor(bolt.height / 8); // æ›´å¤šçš„åˆ†æ®µ
                    const segmentHeight = bolt.height / segments;
                    
                    ctx.moveTo(currentX, currentY);
                    
                    // ä¸»é–ƒé›»è·¯å¾‘
                    for (let i = 0; i < segments; i++) {
                        const direction = i % 2 === 0 ? 1 : -1;
                        const offsetX = direction * (bolt.width * 0.8 + Math.random() * bolt.width * 0.6);
                        
                        currentY += segmentHeight;
                        currentX += offsetX;
                        
                        ctx.lineTo(currentX, currentY);
                        
                        // éš¨æ©Ÿæ·»åŠ åˆ†æ”¯é–ƒé›»
                        if (Math.random() < 0.3 && i > 0) {
                            const branchLength = segmentHeight * (0.5 + Math.random() * 0.8);
                            const branchX = currentX + direction * bolt.width * (1 + Math.random());
                            const branchY = currentY + branchLength;
                            
                            ctx.moveTo(currentX, currentY);
                            ctx.lineTo(branchX, branchY);
                            ctx.moveTo(currentX, currentY); // å›åˆ°ä¸»å¹¹
                        }
                    }
                    
                    // é–ƒé›»æ•ˆæœ
                    canvas.classList.add('lightning-flash');
                    setTimeout(() => canvas.classList.remove('lightning-flash'), 100);
                    
                    // ç¹ªè£½é–ƒé›»ç™¼å…‰æ•ˆæœ
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.lineWidth = 2 + Math.random() * 2;
                    ctx.stroke();
                    
                    // æ·»åŠ å¤–ç™¼å…‰æ•ˆæœ
                    ctx.shadowColor = 'rgba(255, 255, 100, 0.8)';
                    ctx.shadowBlur = 20; // å¢å¼·å…‰æšˆæ•ˆæœ
                    ctx.lineWidth = 1.5;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.stroke();
                    
                    // å†æ¬¡æç¹ªé–ƒé›»æ ¸å¿ƒ
                    ctx.shadowBlur = 0;
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 1)';
                    ctx.stroke();
                    
                    // é‡ç½®é™°å½±æ•ˆæœ
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                }
                
                // ç¹ªè£½åœ°é¢å’Œç©æ°´æ•ˆæœ
                const groundColor = isDarkMode ? '#273449' : '#444e60';
                ctx.fillStyle = groundColor;
                ctx.fillRect(0, gameHeight - 30, gameWidth, 30);
                
                // ç¹ªè£½ç©æ°´æ•ˆæœå’Œæ°´å‘åå°„
                ctx.fillStyle = isDarkMode ? 'rgba(30, 50, 70, 0.5)' : 'rgba(50, 70, 90, 0.4)';
                for (let i = 0; i < 12; i++) { // å¢åŠ æ°´å‘æ•¸é‡
                    const puddleWidth = 30 + Math.random() * 50;
                    const puddleX = (i * (gameWidth / 12) + Math.sin(time + i) * 30) % gameWidth;
                    const puddleHeight = 4 + Math.random() * 3;
                    
                    // æ°´å‘
                    ctx.beginPath();
                    ctx.ellipse(
                        puddleX, 
                        gameHeight - 30 + 2, 
                        puddleWidth / 2, 
                        puddleHeight, 
                        0, 0, Math.PI * 2
                    );
                    ctx.fill();
                    
                    // å¶çˆ¾åœ¨æ°´å‘ä¸Šæ·»åŠ é–ƒé›»çš„åå°„
                    if (lightning.length > 0 && Math.random() < 0.2) { // å¢åŠ åå°„æ©Ÿç‡
                        ctx.fillStyle = 'rgba(255, 255, 200, 0.15)'; // å¢å¼·åå°„äº®åº¦
                        ctx.beginPath();
                        ctx.ellipse(
                            puddleX, 
                            gameHeight - 30 + 2, 
                            puddleWidth / 3, 
                            puddleHeight / 2, 
                            0, 0, Math.PI * 2
                        );
                        ctx.fill();
                        ctx.fillStyle = isDarkMode ? 'rgba(30, 50, 70, 0.5)' : 'rgba(50, 70, 90, 0.4)';
                    }
                }
            }
            
            // éŠæˆ²å¾ªç’° - åŸºæ–¼æ™‚é–“çš„æ›´æ–°
            let lastTime = 0;
            function gameLoop(timestamp) {
                if (!isGameRunning) return;
                
                if (!lastTime) lastTime = timestamp;
                
                // è¨ˆç®—æ™‚é–“å·®å€¼ï¼Œè½‰æ›ç‚ºç§’
                const deltaTime = (timestamp - lastTime) / 1000;
                lastTime = timestamp;
                
                // å‚³å…¥æ™‚é–“å·®å€¼é€²è¡Œæ›´æ–°
                updateGame(deltaTime);
                drawGame();
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            
            // ã€Šé›·é›¨ã€‹åŠ‡æƒ…éšæ®µ
            const storyPhases = [
                { 
                    threshold: 0, 
                    name: "ç¬¬ä¸€å¹•", 
                    description: "ã€Šé›·é›¨ã€‹é–‹å§‹æ™‚ï¼Œæ•…äº‹ç™¼ç”Ÿåœ¨å‘¨æ¨¸åœ’å®¶ä¸­ï¼Œä¸€å ´é›·é›¨å³å°‡ä¾†è‡¨ï¼Œæš—ç¤ºè‘—å°‡è¦ç™¼ç”Ÿçš„åŠ‡è®Šã€‚" 
                },
                { 
                    threshold: 500, 
                    name: "ç¬¬äºŒå¹•", 
                    description: "é›·é›¨ä¸­ï¼Œç¹æ¼ªã€å‘¨èå’Œå‘¨æ²–è¡¨ç¾å‡ºå°å‘¨æ¨¸åœ’å°ˆåˆ¶çš„ä¸æ»¿ï¼Œå®¶åº­çŸ›ç›¾é€æ¼¸é¡¯ç¾ã€‚" 
                },
                { 
                    threshold: 1000, 
                    name: "ç¬¬ä¸‰å¹•", 
                    description: "é­¯ä¾èèˆ‡å‘¨å®¶äººç›¸èªï¼Œéå»çš„ç§˜å¯†é–‹å§‹æ­éœ²ï¼ŒåŸä¾†çš„å®¶åº­é—œä¿‚äº¤ç¹”æˆä¸€å¼µæ‚²åŠ‡ä¹‹ç¶²ã€‚" 
                },
                { 
                    threshold: 1500, 
                    name: "ç¬¬å››å¹•", 
                    description: "é›·é›¨é”åˆ°é«˜æ½®ï¼Œè¦ªå­èˆ‡æˆ€äººé—œä¿‚è¢«æ­éœ²ï¼Œå‘¨æ¨¸åœ’å®¶åº­èµ°å‘å´©æ½°èˆ‡æ¯€æ»…ã€‚" 
                }
            ];
            
            // ç²å–è§’è‰²ç›¸é—œçš„å°è©å’Œåˆ†æï¼ˆæ ¹æ“šåŠ‡æƒ…éšæ®µï¼‰
            function getCharacterContent(characterName, storyPhase = null) {
                // ç¢ºå®šç•¶å‰åŠ‡æƒ…éšæ®µ
                const phaseIndex = storyPhase !== null ? storyPhase : Math.min(3, Math.floor(score / 500));
                const phaseName = storyPhases[phaseIndex].name;
                
                // ç²å–å°æ‡‰å¹•æ•¸çš„å°è©
                if (characterQuotes[characterName]) {
                    // æ‰¾å‡ºè©²è§’è‰²åœ¨ç•¶å‰åŠ‡æƒ…éšæ®µçš„æ‰€æœ‰å°è©
                    const actQuotes = characterQuotes[characterName].filter(
                        q => q.act.includes(phaseName.charAt(0)) // æ¯”è¼ƒç¬¬å¹¾å¹•ï¼Œä¾‹å¦‚"ä¸€å¹•"ã€"äºŒå¹•"ç­‰
                    );
                    
                    // å¦‚æœæ‰¾åˆ°åˆé©å¹•æ•¸çš„å°è©ï¼Œå°±å¾ä¸­éš¨æ©Ÿé¸ä¸€å€‹
                    if (actQuotes.length > 0) {
                        const randomQuote = actQuotes[Math.floor(Math.random() * actQuotes.length)];
                        return {
                            quote: randomQuote.text,
                            analysis: randomQuote.note || "ã€Šé›·é›¨ã€‹ä¸­çš„ç¶“å…¸å°è©",
                            act: randomQuote.act
                        };
                    }
                    
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±å¾è©²è§’è‰²çš„æ‰€æœ‰å°è©ä¸­éš¨æ©Ÿé¸ä¸€å€‹
                    const randomQuote = characterQuotes[characterName][Math.floor(Math.random() * characterQuotes[characterName].length)];
                    return {
                        quote: randomQuote.text,
                        analysis: randomQuote.note || "ã€Šé›·é›¨ã€‹ä¸­çš„ç¶“å…¸å°è©",
                        act: randomQuote.act
                    };
                }
                
                // é»˜èªå…§å®¹ï¼ˆç†è«–ä¸Šä¸æœƒåˆ°é”ï¼‰
                return {
                    quote: "å‘½é‹çš„è¨˜è™Ÿï¼Œæ—©å·²ç¶“åˆ»åœ¨æˆ‘çš„é¡ä¸Šã€‚",
                    analysis: "ã€Šé›·é›¨ã€‹ä¸­çš„é›·é›»è±¡å¾µè‘—å‘½é‹çš„åŠ›é‡ï¼Œç„¡æ³•é€ƒé¿çš„å®¿å‘½ã€‚",
                    act: phaseName
                };
            }
            
            // æ‰“å­—æ©Ÿæ•ˆæœå‡½æ•¸
            function typewriterEffect(element, text, speed, onComplete = null) {
                let i = 0;
                element.textContent = '';
                element.classList.add('typewriter-cursor');
                
                // ç¢ºä¿ä¸€é–‹å§‹å°±æ¸…é™¤æ–‡æœ¬ä¸­çš„å¼•è™Ÿ
                text = text.replace(/^"/, '').replace(/"$/, '');
                
                // æ‰“å­—éç¨‹ä¸­é–ƒçˆæ•ˆæœ
                const flashEffect = () => {
                    gameContainer.classList.add('screen-flash');
                    setTimeout(() => gameContainer.classList.remove('screen-flash'), 200);
                };
                
                function typeChar() {
                    if (i < text.length) {
                        // æ¯4-5å€‹å­—ç¬¦é–ƒçˆä¸€ä¸‹å±å¹•
                        if (i > 0 && i % 5 === 0) {
                            flashEffect();
                            // å¶çˆ¾åœ¨æ‰“å­—éç¨‹ä¸­æ’­æ”¾è¼•å¾®é›·è²
                            if (Math.random() < 0.3) {
                                playThunderSound('button');
                            }
                        }
                        
                        element.textContent += text.charAt(i);
                        i++;
                        setTimeout(typeChar, speed);
                    } else {
                        element.classList.remove('typewriter-cursor');
                        // æ‰“å­—çµæŸå¾Œæ·»åŠ ç‰¹æ®Šæ•ˆæœ
                        element.classList.add('animate-quote-text');
                        
                        // ç›´æ¥ä½¿ç”¨ç•¶å‰æ–‡æœ¬æ·»åŠ ä¸­æ–‡å¼•ç”¨ç¬¦è™Ÿ
                        element.innerHTML = `<span class="text-yellow-300">ã€</span> ${element.textContent} <span class="text-yellow-300">ã€</span>`;
                        
                        // æœ€å¾Œçš„é–ƒçˆæ•ˆæœ
                        flashEffect();
                        
                        // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
                        playThunderSound('button');
                        
                        if (onComplete) onComplete();
                    }
                }
                
                typeChar();
            }
            
            // ç²å–éš¨æ©Ÿå°è©
            function getRandomQuote(characterName) {
                if (!characterQuotes[characterName] || characterQuotes[characterName].length === 0) {
                    return { text: "å‘½é‹çš„è¨˜è™Ÿï¼Œæ—©å·²ç¶“åˆ»åœ¨æˆ‘çš„é¡ä¸Šã€‚", act: "ä¸€å¹•", note: "é»˜èªå°è©" };
                }
                
                const quotes = characterQuotes[characterName];
                return quotes[Math.floor(Math.random() * quotes.length)];
            }
            
            // éŠæˆ²çµæŸ
            function gameOver() {
                isGameRunning = false;
                
                // åœæ­¢é›¨æ»´æ•ˆæœ
                clearInterval(rainInterval);
                
                // æ·¡å‡ºèƒŒæ™¯éŸ³æ¨‚
                fadeOutMusic();
                
                if (score > highScore) {
                    highScore = score;
                }
                
                // ç¢ºå®šåŠ‡æƒ…éšæ®µ
                const phaseIndex = Math.min(3, Math.floor(score / 500));
                const currentPhase = storyPhases[phaseIndex];
                
                // ç²å–è§’è‰²éš¨æ©Ÿå°è©
                const randomQuote = getRandomQuote(character);
                
                // é¡¯ç¤ºè§’è‰²ç›¸é—œå°è©å’ŒåŠ‡æƒ…éšæ®µï¼ˆæš«æ™‚éš±è—ï¼Œç­‰å¾…æ‰“å­—æ©Ÿæ•ˆæœå®Œæˆå¾Œé¡¯ç¤ºï¼‰
                document.getElementById('character-quote').textContent = "";
                document.getElementById('quote-character').textContent = character; // é¡¯ç¤ºå°è©æ‰€å±¬è§’è‰²
                document.getElementById('character-analysis').textContent = randomQuote.note || "ã€Šé›·é›¨ã€‹ä¸­çš„ç¶“å…¸å°è©";
                document.getElementById('act-indicator').textContent = randomQuote.act;
                document.getElementById('plot-summary').textContent = currentPhase.description;
                
                finalScoreElement.textContent = score;
                highScoreElement.textContent = highScore;
                
                // éš±è—è§’è‰²èƒ½åŠ›æŒ‡ç¤ºå™¨
                const abilityIndicator = document.getElementById('ability-indicator');
                if (abilityIndicator) {
                    abilityIndicator.classList.add('hidden');
                }
                
                // æ¸…é™¤æ‰€æœ‰é–ƒé›»é è­¦
                const existingWarnings = document.querySelectorAll('.lightning-warning');
                existingWarnings.forEach(warning => {
                    warning.remove();
                });
                
                // æ’­æ”¾è¶…å¤§é›·è²
                playThunderSound('death');
                
                // é–ƒé›»æ“Šä¸­æ•ˆæœ - åŠ å¼·æŠ–å‹•
                gameContainer.classList.add('screen-flash', 'strong-shake');
                
                // å‰µå»ºé–ƒé›»æ“Šä¸­å‹•ç•«
                const strikeEffect = document.createElement('div');
                strikeEffect.classList.add('absolute', 'inset-0', 'z-20');
                strikeEffect.style.background = 'radial-gradient(circle at center, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 70%)';
                strikeEffect.style.animation = 'screenFlash 0.6s ease-out';
                
                gameContainer.appendChild(strikeEffect);
                
                // ç§»é™¤è§’è‰²å°è©æ°£æ³¡
                if (currentQuoteBubble && currentQuoteBubble.parentNode) {
                    currentQuoteBubble.remove();
                    currentQuoteBubble = null;
                }
                
                // æ¸…ç†å‘¨æ²–çš„ç²’å­æ•ˆæœ
                cleanupSprintEffects();
                
                // ç§»é™¤æ‰€æœ‰èƒ½åŠ›è¦–è¦ºæ•ˆæœ
                const specialEffects = document.querySelectorAll('#pressure-field, #character-shield, #sprint-effect, #resilience-aura, #timeslow-overlay');
                specialEffects.forEach(effect => {
                    if (effect && effect.parentNode) {
                        effect.remove();
                    }
                });
                
                // ç§»é™¤é€Ÿåº¦ç·šå®¹å™¨
                const speedLinesContainer = document.getElementById('speed-lines-container');
                if (speedLinesContainer && speedLinesContainer.parentNode) {
                    speedLinesContainer.remove();
                }
                
                // éš±è—ç‹€æ…‹æ¬„
                statusBar.classList.add('hidden');
                
                // å»¶é²é¡¯ç¤ºéŠæˆ²çµæŸç•Œé¢ä»¥å±•ç¤ºç‰¹æ•ˆ
                setTimeout(() => {
                    gameContainer.classList.remove('screen-flash', 'strong-shake');
                    if (strikeEffect.parentNode) {
                        strikeEffect.remove();
                    }
                    gameOverScreen.classList.remove('hidden');
                    if (characterElement) {
                        characterElement.classList.add('hidden');
                    }
                    
                    // éš±è—å¾—åˆ†ä¿¡æ¯å’Œé‡æ–°é–‹å§‹æŒ‰éˆ•ï¼Œç›´åˆ°æ‰“å­—æ©Ÿæ•ˆæœå®Œæˆ
                    const scoreInfo = document.querySelector('#game-over .text-center.mb-4');
                    if (scoreInfo) {
                        scoreInfo.style.display = 'none';
                    }
                    
                    if (restartBtn) {
                        restartBtn.style.display = 'none';
                    }
                    
                    // æ‡‰ç”¨æ‰“å­—æ©Ÿæ•ˆæœ - é€Ÿåº¦è¨­ç‚º100æ¯«ç§’æ¯å­—ç¬¦ï¼Œæä¾›è¶³å¤ é–±è®€æ™‚é–“
                    const quoteElement = document.getElementById('character-quote');
                    if (quoteElement) {
                        console.log("Applying typewriter effect with quote:", randomQuote.text);
                        
                        // å…ˆç¡®ä¿æ–‡æœ¬æ˜¯ç©ºçš„
                        quoteElement.textContent = "";
                        
                        // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå¼•ç”¨ï¼ˆå»æ‰è‹±æ–‡å¼•å·ï¼‰
                        typewriterEffect(quoteElement, randomQuote.text, 100, function() {
                            console.log("Typewriter effect completed");
                            // æ‰“å­—æ©Ÿæ•ˆæœå®Œæˆå¾Œï¼Œé¡¯ç¤ºå¾—åˆ†ä¿¡æ¯
                            setTimeout(() => {
                                if (scoreInfo) {
                                    scoreInfo.style.display = 'block';
                                    scoreInfo.classList.add('animate-fade-in');
                                }
                                
                                // å†ç­‰ä¸€æœƒå…’é¡¯ç¤ºé‡æ–°é–‹å§‹æŒ‰éˆ•
                                setTimeout(() => {
                                    if (restartBtn) {
                                        restartBtn.style.display = 'inline-block';
                                        restartBtn.classList.add('animate-bounce');
                                        
                                        // æ’­æ”¾é›·è²
                                        playThunderSound('button');
                                    }
                                }, 1000);
                            }, 1000);
                        });
                    } else {
                        console.error("Quote element not found!");
                        // å¦‚æœæ‰¾ä¸åˆ°å¼•ç”¨å…ƒç´ ï¼Œä»ç„¶æ˜¾ç¤ºåˆ†æ•°å’ŒæŒ‰é’®
                        if (scoreInfo) {
                            scoreInfo.style.display = 'block';
                        }
                        if (restartBtn) {
                            restartBtn.style.display = 'inline-block';
                        }
                    }
                }, 800);
            }
            
            // éµç›¤æ§åˆ¶
            document.addEventListener('keydown', function(e) {
                if (!isGameRunning || !characterElement) return;
                
                // åŸºç¤ç§»å‹•é€Ÿåº¦ - é™ä½ä»¥é¿å…ç§»å‹•éå¿«
                let speed = 15;
                
                // æ ¹æ“šè§’è‰²èƒ½åŠ›èª¿æ•´é€Ÿåº¦ - æ›´é©ä¸­çš„åŠ é€Ÿ
                if (characterAbility === 'é’æ˜¥è¡åˆº') {
                    speed *= 1.2; // å‘¨æ²–ç§»å‹•ç•¥å¿«
                }
                
                // é’æ˜¥è¡åˆºèƒ½åŠ›æ¿€æ´»æ™‚çš„é€Ÿåº¦æå‡
                if (activeEffects.youthSprint) {
                    speed *= 3.0; // é’æ˜¥è¡åˆºæ•ˆæœ - å¤§å¹…æå‡é€Ÿåº¦
                }
                
                // ç‰¹æ®Šèƒ½åŠ›æ•ˆæœèª¿æ•´é€Ÿåº¦ - é™ä½åŠ é€Ÿå¹…åº¦
                if (activeEffects.speedUp) {
                    speed *= 1.3; // é©åº¦åŠ é€Ÿ
                }
                
                if (activeEffects.dashBoost) {
                    speed *= 1.5; // é©åº¦è¡åˆº
                }
                
                // æƒ…æ„Ÿåº‡è­·çš„åŠ é€Ÿæ•ˆæœ - é™ä½åŠ é€Ÿå¹…åº¦
                if (characterAbility === 'æƒ…æ„Ÿåº‡è­·' && activeEffects.emotionalSpeed) {
                    speed *= 1.8; // æƒ…æ„Ÿåº‡è­·æ™‚è¼ƒå¿«ï¼Œä½†ä¸è‡³æ–¼å¤ªå¿«
                }
                
                if (e.key === 'ArrowLeft' || e.key === 'a') {
                    characterX = Math.max(characterWidth / 2, characterX - speed);
                    characterElement.style.left = `${characterX}px`;
                    updateQuoteBubblePosition();
                    
                    // ç¹æ¼ªèƒ½åŠ›çš„æ®˜å½±æ•ˆæœ
                    if (activeEffects.createAfterimagePath && Math.random() < 0.4) {
                        createAfterimage(characterX + speed, '#E91E63');
                    }
                } else if (e.key === 'ArrowRight' || e.key === 'd') {
                    characterX = Math.min(gameWidth - characterWidth / 2, characterX + speed);
                    characterElement.style.left = `${characterX}px`;
                    updateQuoteBubblePosition();
                    
                    // ç¹æ¼ªèƒ½åŠ›çš„æ®˜å½±æ•ˆæœ
                    if (activeEffects.createAfterimagePath && Math.random() < 0.4) {
                        createAfterimage(characterX - speed, '#E91E63');
                    }
                } else if (e.key === ' ' || e.key === 'Spacebar') {
                    // ç©ºæ ¼éµæ¿€æ´»è§’è‰²èƒ½åŠ› - æ‰€æœ‰è§’è‰²éƒ½å¯ä½¿ç”¨
                    if (!abilityCooldown) {
                        activateAbility();
                    }
                }
                

            });
            
            // çµ±ä¸€è§¸æ§äº‹ä»¶è™•ç†
            let touchStartTime = 0;
            let lastTapTime = 0;
            let touchStartX = 0;
            
            // è§¸æ§é–‹å§‹äº‹ä»¶
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (!isGameRunning || !characterElement) return;
                
                const currentTime = Date.now();
                touchStartTime = currentTime;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                touchStartX = touch.clientX - rect.left;
                
                // æª¢æŸ¥é›™æ“Š (é©ç”¨æ–¼æƒ…æ„Ÿåº‡è­·)
                if (currentTime - lastTapTime < 300) {
                    if (characterAbility === 'æƒ…æ„Ÿåº‡è­·' && !abilityCooldown) {
                        activateAbility();
                        return; // æ¿€æ´»èƒ½åŠ›å¾Œä¸åŸ·è¡Œç§»å‹•
                    }
                }
                
                lastTapTime = currentTime;
            });
            
            // è§¸æ§ç§»å‹•äº‹ä»¶
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (!isGameRunning || !characterElement) return;
                
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                
                handleMovement(touchX);
            });
            
            // è§¸æ§çµæŸäº‹ä»¶
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (!isGameRunning || !characterElement) return;
                
                const touchDuration = Date.now() - touchStartTime;
                
                // é•·æŒ‰æ¿€æ´»èƒ½åŠ› (å¨æ¬ŠåŠ›å ´å’Œéš±å¿å …éŸŒ)
                if (touchDuration > 500) {
                    if (characterAbility === 'å¨æ¬ŠåŠ›å ´' && !abilityCooldown) {
                        activateAbility();
                    } else if (characterAbility === 'éš±å¿å …éŸŒ' && !abilityCooldown && !activeEffects.oneTimeImmunity) {
                        activateAbility();
                    }
                } else if (touchDuration < 200) {
                    // çŸ­é»æ“Šé€²è¡Œç§»å‹•
                    handleMovement(touchStartX);
                }
            });
            
            // çµ±ä¸€ç§»å‹•è™•ç†å‡½æ•¸
            function handleMovement(targetX) {
                let speed = 15;
                
                // ç‰¹æ®Šèƒ½åŠ›æ•ˆæœèª¿æ•´é€Ÿåº¦
                if (activeEffects.speedUp) {
                    speed *= 1.5;
                }
                
                if (activeEffects.dashBoost) {
                    speed *= 2;
                }
                
                // æƒ…æ„Ÿåº‡è­·çš„åŠ é€Ÿæ•ˆæœ
                if (characterAbility === 'æƒ…æ„Ÿåº‡è­·' && activeEffects.emotionalSpeed) {
                    speed *= 2.5;
                }
                
                if (targetX < characterX - 10) {
                    // å‘å·¦ç§»å‹•
                    characterX = Math.max(characterWidth / 2, characterX - speed);
                } else if (targetX > characterX + 10) {
                    // å‘å³ç§»å‹•
                    characterX = Math.min(gameWidth - characterWidth / 2, characterX + speed);
                }
                
                characterElement.style.left = `${characterX}px`;
                updateQuoteBubblePosition();
            }
            
            // çµ±ä¸€é¼ æ¨™é»æ“Šæ§åˆ¶
            let lastClickTime = 0;
            canvas.addEventListener('click', function(e) {
                if (!isGameRunning || !characterElement) return;
                
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const currentTime = Date.now();
                
                // æª¢æŸ¥é›™æ“Š
                if (currentTime - lastClickTime < 300) {
                    if (characterAbility === 'æƒ…æ„Ÿåº‡è­·' && !abilityCooldown) {
                        activateAbility();
                        return; // æ¿€æ´»èƒ½åŠ›å¾Œä¸åŸ·è¡Œç§»å‹•
                    } else if (characterAbility === 'å¨æ¬ŠåŠ›å ´' && !abilityCooldown) {
                        activateAbility();
                        return;
                    } else if (characterAbility === 'éš±å¿å …éŸŒ' && !abilityCooldown && !activeEffects.oneTimeImmunity) {
                        activateAbility();
                        return;
                    }
                }
                
                // å–®æ“Šç§»å‹•
                let moveAmount = 40;
                
                // ç‰¹æ®Šèƒ½åŠ›æ•ˆæœèª¿æ•´é€Ÿåº¦
                if (activeEffects.speedUp || activeEffects.dashBoost || activeEffects.emotionalSpeed) {
                    moveAmount *= 1.5;
                }
                
                if (clickX < characterX - 10) {
                    characterX = Math.max(characterWidth / 2, characterX - moveAmount);
                } else if (clickX > characterX + 10) {
                    characterX = Math.min(gameWidth - characterWidth / 2, characterX + moveAmount);
                }
                
                characterElement.style.left = `${characterX}px`;
                updateQuoteBubblePosition();
                
                lastClickTime = currentTime;
            });
            
            // ç‚ºæ‰€æœ‰æŒ‰éˆ•æ·»åŠ é›·è²éŸ³æ•ˆ
            addThunderSoundToButtons();
            
            // ç‚ºé“å…·æ¨™ç±¤è¨­ç½®åˆ‡æ›åŠŸèƒ½
            const positiveItemsTab = document.getElementById('positive-items-tab');
            const negativeItemsTab = document.getElementById('negative-items-tab');
            const positiveItems = document.getElementById('positive-items');
            const negativeItems = document.getElementById('negative-items');
            
            if (positiveItemsTab && negativeItemsTab && positiveItems && negativeItems) {
                positiveItemsTab.addEventListener('click', () => {
                    positiveItems.classList.remove('hidden');
                    negativeItems.classList.add('hidden');
                    positiveItemsTab.classList.add('bg-green-700');
                    positiveItemsTab.classList.remove('bg-opacity-40');
                    positiveItemsTab.classList.add('bg-opacity-70');
                    negativeItemsTab.classList.remove('bg-red-700');
                    negativeItemsTab.classList.add('bg-opacity-40');
                    negativeItemsTab.classList.remove('bg-opacity-70');
                });
                
                negativeItemsTab.addEventListener('click', () => {
                    positiveItems.classList.add('hidden');
                    negativeItems.classList.remove('hidden');
                    positiveItemsTab.classList.remove('bg-green-700');
                    positiveItemsTab.classList.add('bg-opacity-40');
                    positiveItemsTab.classList.remove('bg-opacity-70');
                    negativeItemsTab.classList.add('bg-red-700');
                    negativeItemsTab.classList.remove('bg-opacity-40');
                    negativeItemsTab.classList.add('bg-opacity-70');
                });
            }
            
            // ç›´æ¥åœ¨å…¨å±€å®šç¾©é“å…·ä¿¡æ¯ï¼Œç¢ºä¿åœ¨ä½¿ç”¨å‰å·²å®šç¾©
            window.gameItemDetails = {
                'umbrella': {
                    name: 'é›¨å‚˜',
                    description: 'ç²å¾—30åˆ†ï¼Œè±¡å¾µå°‹æ±‚çŸ­æš«é¿é›£ï¼Œåœ¨ã€Šé›·é›¨ã€‹ä¸­æ˜¯å¸Œæœ›çš„è±¡å¾µ',
                    quote: 'ã€Œé€™å ´å¤§é›¨ï¼Œæ²’æœ‰ä¸€æŠŠå‚˜èƒ½é®å¾—ä½ã€‚ã€â€”â€”ç¹æ¼ª',
                    symbolism: 'æš«æ™‚é€ƒé¿å‘½é‹ï¼Œä½†ç„¡æ³•é¿å…æœ€çµ‚çš„æ‚²åŠ‡',
                    color: '#4CAF50',
                    icon: 'â˜‚ï¸',
                    isPositive: true,
                    pointValue: 30
                },
                'cricket': {
                    name: 'èŸ‹èŸ€',
                    description: 'ç²å¾—20åˆ†ï¼Œè±¡å¾µå¹´è¼•çš„åæŠ—ç²¾ç¥å’Œç”Ÿå‘½åŠ›',
                    quote: 'ã€Œæˆ‘çœ‹è¦‹èŸ‹èŸ€å…’...å®ƒèªªï¼šå¹´è¼•äººï¼Œé€ åå§ï¼ã€â€”â€”å‘¨æ²–',
                    symbolism: 'å‘¨æ²–çš„åæŠ—ç²¾ç¥å’Œå°è‡ªç”±çš„åš®å¾€',
                    color: '#4CAF50',
                    icon: 'ğŸ¦—',
                    isPositive: true,
                    pointValue: 20
                },
                'window': {
                    name: 'çª—æˆ¶',
                    description: 'ç²å¾—25åˆ†ï¼Œè±¡å¾µå°è‡ªç”±çš„æ¸´æœ›å’Œå°å¤–ç•Œçš„åš®å¾€',
                    quote: 'ã€Œæˆ‘å¸Œæœ›æˆ‘ä»Šå¤©è®Šæˆç«å±±çš„å£ï¼Œç†±ç†±çƒˆçƒˆåœ°å†’ä¸€æ¬¡ï¼ã€â€”â€”ç¹æ¼ª',
                    symbolism: 'å°å¤–ç•Œè‡ªç”±çš„æ¸´æœ›ï¼Œç¹æ¼ªå¸¸å¸¸é–‹çª—é€æ°£',
                    color: '#4CAF50',
                    icon: 'ğŸªŸ',
                    isPositive: true,
                    pointValue: 25
                },
                'medicine': {
                    name: 'è—¥',
                    description: 'æ¸›å°‘15åˆ†ï¼Œè±¡å¾µå‘¨æ¨¸åœ’ç”¨ä¾†æ§åˆ¶ç¹æ¼ªçš„å·¥å…·',
                    quote: 'ã€Œç¹æ¼ªï¼Œæ‡‰ç•¶æ›¿å­©å­åšå€‹æœå¾çš„æ¦œæ¨£ã€‚ã€â€”â€”å‘¨æ¨¸åœ’',
                    symbolism: 'å‘¨æ¨¸åœ’çš„æ§åˆ¶æ‰‹æ®µï¼Œå¼·åˆ¶ç¹æ¼ªæœè—¥',
                    color: '#F44336',
                    icon: 'ğŸ’Š',
                    isPositive: false,
                    pointValue: -15
                },
                'oldHouse': {
                    name: 'è€æˆ¿å­',
                    description: 'æ¸›å°‘20åˆ†ï¼Œè±¡å¾µç¦éŒ®äººæ€§çš„å°å»ºå®¶åº­',
                    quote: 'ã€Œå‘¨å®¶çš„ç©ºæ°£æ»¿æ˜¯ç½ªæƒ¡ï¼Œé€™äº›å¹´æˆ‘çœ‹è¦‹äº†ä»–å€‘æ‰€åšçš„å£äº‹ï¼ã€â€”â€”ç¹æ¼ª',
                    symbolism: 'å‘¨å®¶å°å»ºå®¶åº­çš„å›šç± ï¼Œè¡¨é¢å…‰é®®å…§è£¡é™°æš—',
                    color: '#F44336',
                    icon: 'ğŸšï¸',
                    isPositive: false,
                    pointValue: -20
                },
                'oldSofa': {
                    name: 'è€æ²™ç™¼',
                    description: 'æ¸›å°‘25åˆ†ï¼Œè±¡å¾µè¡¨é¢èˆ’é©å¯¦å‰‡çª’æ¯çš„ç”Ÿæ´»',
                    quote: 'ã€Œé€™è€æˆ¿å­æ°¸é æ˜¯é€™æ¨£æ‚¶æ°£ï¼Œäººå€‘ä¹Ÿæ˜¯é¬¼è£é¬¼æ°£çš„ï¼ã€â€”â€”ç¹æ¼ª',
                    symbolism: 'è¡¨é¢èˆ’é©çš„ç”Ÿæ´»ï¼Œå¯¦å‰‡æ˜¯ç²¾ç¥ç¦éŒ®',
                    color: '#F44336',
                    icon: 'ğŸ›‹ï¸',
                    isPositive: false,
                    pointValue: -25
                },
                'fan': {
                    name: 'æ‘ºæ‰‡',
                    description: 'ç²å¾—40åˆ†ï¼Œè±¡å¾µç¹æ¼ªå°ç”Ÿæ´»çš„ç†±æƒ…èˆ‡æ¸´æœ›',
                    quote: 'ã€Œæˆ‘è¦å‘¼å¸ï¼Œæˆ‘è¦å…‰æ˜ï¼Œæˆ‘è¦ç”Ÿæ´»ï¼Œæˆ‘è¦è‡ªç”±ï¼ã€â€”â€”ç¹æ¼ª',
                    symbolism: 'ç¹æ¼ªå°è‡ªç”±çš„æ¸´æœ›å’Œå°ç¦éŒ®çš„åæŠ—',
                    color: '#4CAF50',
                    icon: 'ğŸª­',
                    isPositive: true,
                    pointValue: 40
                },
                'tigerShoes': {
                    name: 'è™é ­é‹',
                    description: 'ç²å¾—35åˆ†ï¼Œè±¡å¾µæ¯æ„›çš„å …éŸŒåŠ›é‡',
                    quote: 'ã€Œæˆ‘é€™äº›å¹´çš„è‹¦ä¸æ˜¯ä½ é‚£éŒ¢å°±ç®—å¾—æ¸…çš„ï¼ã€â€”â€”é­¯ä¾è',
                    symbolism: 'ä¾èæ¯å­è¢«éºæ£„çš„è¦‹è­‰ç‰©ï¼Œæ¯æ„›çš„è±¡å¾µ',
                    color: '#4CAF50',
                    icon: 'ğŸ‘Ÿ',
                    isPositive: true,
                    pointValue: 35
                },
                'photo': {
                    name: 'ç…§ç‰‡',
                    description: 'ç²å¾—50åˆ†ï¼Œè±¡å¾µçœŸç›¸è¢«æ­éœ²å¸¶ä¾†çš„è§£è„«',
                    quote: 'ã€Œæœ‰äº›ç§˜å¯†ï¼Œå³ä½¿æ©è“‹ä¸‰åå¹´ï¼Œé‚„æ˜¯æœƒè¢«é›·é›¨æ²–åˆ·å‡ºä¾†ã€‚ã€',
                    symbolism: 'å®¶åº­ç§˜å¯†çš„æ­éœ²ï¼Œå¡µå°å¤šå¹´çš„çœŸç›¸',
                    color: '#4CAF50',
                    icon: 'ğŸ–¼ï¸',
                    isPositive: true,
                    pointValue: 50
                },
                'clock': {
                    name: 'æ™‚é˜',
                    description: 'æ¸›å°‘30åˆ†ï¼Œè±¡å¾µå‘½é‹çš„ä¸å¯é€†è½‰å’Œæ™‚é–“çš„å£“è¿«',
                    quote: 'ã€Œæ™‚é˜çš„æ»´ç­”è²åŠ åŠ‡ç·Šè¿«æ„Ÿï¼Œé ç¤ºæ‚²åŠ‡çš„ä¸å¯é€†è½‰ã€‚ã€',
                    symbolism: 'æ™‚é–“çš„å£“è¿«èˆ‡å‘½é‹çš„ä¸å¯é€†è½‰',
                    color: '#F44336',
                    icon: 'â°',
                    isPositive: false,
                    pointValue: -30
                },
                'ghost': {
                    name: 'é¬¼é­‚',
                    description: 'æ¸›å°‘40åˆ†ï¼Œè±¡å¾µå®¶åº­è¢«éå»ç½ªæƒ¡çºç¹çš„ææ‡¼',
                    quote: 'ã€Œæˆ‘ç¾åœ¨å¿ƒè£å¾ˆäº‚ï¼Œä½ ä¸çŸ¥é“é€™å±‹å­é¬§é¬¼éº¼ï¼Ÿã€â€”â€”å‘¨è',
                    symbolism: 'å‘¨å®¶è¢«éå»ç½ªæƒ¡çºç¹ï¼Œå…§å¿ƒçš„ææ‡¼',
                    color: '#F44336',
                    icon: 'ğŸ‘»',
                    isPositive: false,
                    pointValue: -40
                },
                'check': {
                    name: 'æ”¯ç¥¨',
                    description: 'æ¸›å°‘45åˆ†ï¼Œè±¡å¾µå‘¨æ¨¸åœ’è©¦åœ–ç”¨é‡‘éŒ¢æ©è“‹ç½ªæƒ¡çš„è™›å½',
                    quote: 'ã€Œä»–åšç›¡äº†å£äº‹å¼„éŒ¢ï¼Œä»–è‡ªç„¶å¯ä»¥è¡Œå–„ï¼ã€â€”â€”ç¹æ¼ª',
                    symbolism: 'å‘¨æ¨¸åœ’è©¦åœ–ç”¨é‡‘éŒ¢æ©è“‹éå»çš„ç½ªæƒ¡',
                    color: '#F44336',
                    icon: 'ğŸ’¸',
                    isPositive: false,
                    pointValue: -45
                }
            };
            
            // åˆå§‹åŒ–é“å…·é¡¯ç¤ºåŠŸèƒ½ - åªä¿ç•™æ‡¸æµ®æ°£æ³¡ï¼Œç§»é™¤å…§ç½®é¡¯ç¤ºå€åŸŸ
            function setupItemDetailsDisplay() {
                // ç²å–æ‰€æœ‰é“å…·åœ–æ¨™å…ƒç´ 
                const itemIcons = document.querySelectorAll('.item-icon[data-show-info="true"]');
                
                // å»ºç«‹æ‡¸æµ®æ°£æ³¡å…ƒç´ ï¼ˆåˆå§‹ç‚ºéš±è—ï¼‰
                const tooltipElement = document.createElement('div');
                tooltipElement.className = 'hidden absolute z-50 w-52 bg-gradient-to-br from-gray-900 to-indigo-950 text-white p-2.5 rounded-lg shadow-xl border border-blue-500 border-opacity-30 pointer-events-none';
                tooltipElement.id = 'item-tooltip';
                
                // æ·»åŠ ç®­é ­å…ƒç´ 
                const arrowElement = document.createElement('div');
                arrowElement.className = 'tooltip-arrow absolute';
                tooltipElement.appendChild(arrowElement);
                
                // æ·»åŠ åˆ°æ–‡æª”
                document.body.appendChild(tooltipElement);
                
                // ç‚ºæ¯å€‹é“å…·åœ–æ¨™æ·»åŠ é¼ æ¨™äº‹ä»¶
                itemIcons.forEach(icon => {
                    const itemId = icon.getAttribute('data-id');
                    
                    // æª¢æŸ¥é“å…·IDæ˜¯å¦å­˜åœ¨
                    if (!itemId || !window.gameItemDetails[itemId]) {
                        console.warn(`é“å…·IDä¸å­˜åœ¨æˆ–æ•¸æ“šç¼ºå¤±: ${itemId}`);
                        return;
                    }
                    
                    // é¼ æ¨™é€²å…¥é¡¯ç¤ºé“å…·è©³æƒ…
                    icon.addEventListener('mouseenter', (event) => {
                        showItemTooltip(event, itemId); // é¡¯ç¤ºæ‡¸æµ®æ°£æ³¡
                    });
                    
                    // é¼ æ¨™ç§»å‡ºéš±è—æ°£æ³¡
                    icon.addEventListener('mouseleave', () => {
                        tooltipElement.classList.add('hidden');
                    });
                });
                
                // é¡¯ç¤ºæ‡¸æµ®æ°£æ³¡ - é¡ä¼¼è§’è‰²èƒ½åŠ›çš„æ°£æ³¡ï¼Œå¸¶æœ‰é‚Šç•Œæª¢æ¸¬
                function showItemTooltip(event, itemId) {
                    const item = window.gameItemDetails[itemId];
                    if (!item) return;
                    
                    // è¨­ç½®æ°£æ³¡å…§å®¹
                    tooltipElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-bold ${item.isPositive ? 'text-green-400' : 'text-red-400'}">${item.name}</div>
                            <div class="text-[10px] px-1.5 py-0.5 ${item.isPositive ? 'bg-green-600' : 'bg-red-600'} bg-opacity-70 rounded-md text-white">
                                ${item.isPositive ? '+' : ''}${item.pointValue}
                            </div>
                        </div>
                        <div class="text-[10px] mt-1.5 text-gray-200">${item.description}</div>
                        <div class="text-[9px] mt-1 italic text-blue-300">${item.quote}</div>
                        <div class="text-[9px] mt-1.5 text-gray-400">æ„è±¡ï¼š${item.symbolism}</div>
                        <div class="tooltip-arrow absolute"></div>
                    `;
                    
                    // ç²å–ç®­é ­å…ƒç´ 
                    const arrowElement = tooltipElement.querySelector('.tooltip-arrow');
                    
                    // é¡¯ç¤ºæ°£æ³¡
                    tooltipElement.classList.remove('hidden');
                    
                    // ç²å–éŠæˆ²å®¹å™¨å’ŒæŒ‰éˆ•ä½ç½®
                    const gameContainer = document.querySelector('.game-container');
                    if (!gameContainer) {
                        console.log('æ‰¾ä¸åˆ°éŠæˆ²å®¹å™¨');
                        return;
                    }
                    
                    const containerRect = gameContainer.getBoundingClientRect();
                    const buttonRect = event.currentTarget.getBoundingClientRect();
                    
                    // è¨­ç½®æ°£æ³¡å°ºå¯¸å’Œå®‰å…¨é‚Šè·
                    const tooltipWidth = 208; // w-52 = 13rem = 208px
                    const tooltipHeight = 130; // æ°£æ³¡é«˜åº¦
                    const SAFE_MARGIN = 12; // å®‰å…¨é‚Šè·
                    
                    // è¨ˆç®—æŒ‰éˆ•åœ¨å®¹å™¨ä¸­çš„ç›¸å°ä½ç½®
                    const buttonLeft = buttonRect.left - containerRect.left;
                    const buttonTop = buttonRect.top - containerRect.top;
                    const buttonRight = buttonLeft + buttonRect.width;
                    const buttonBottom = buttonTop + buttonRect.height;
                    const buttonCenterX = buttonLeft + buttonRect.width/2;
                    const buttonCenterY = buttonTop + buttonRect.height/2;
                    
                    // ç²å–å®¹å™¨å°ºå¯¸
                    const gameWidth = containerRect.width;
                    const gameHeight = containerRect.height;
                    
                    // é»˜èªåœ¨æŒ‰éˆ•ä¸Šæ–¹é¡¯ç¤º
                    let tooltipLeft = buttonCenterX - tooltipWidth/2;
                    let tooltipTop = buttonTop - tooltipHeight - SAFE_MARGIN;
                    let position = 'top'; // é è¨­åœ¨ä¸Šæ–¹
                    
                    // æª¢æŸ¥æ˜¯å¦æœƒè¶…å‡ºä¸Šé‚Šç•Œ
                    if (tooltipTop < SAFE_MARGIN) {
                        // å¦‚æœä¸Šæ–¹ç©ºé–“ä¸è¶³ï¼Œå˜—è©¦é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸‹æ–¹
                        tooltipTop = buttonBottom + SAFE_MARGIN;
                        position = 'bottom';
                        
                        // æª¢æŸ¥æ˜¯å¦æœƒè¶…å‡ºä¸‹é‚Šç•Œ
                        if (tooltipTop + tooltipHeight > gameHeight - SAFE_MARGIN) {
                            // å¦‚æœä¸‹æ–¹ä¹Ÿä¸å¤ ï¼Œå˜—è©¦æ”¾åœ¨å·¦å´æˆ–å³å´
                            if (buttonCenterX > gameWidth / 2) {
                                // æŒ‰éˆ•åœ¨å³åŠéƒ¨ï¼Œå˜—è©¦æ”¾åœ¨å·¦å´
                                tooltipLeft = buttonLeft - tooltipWidth - SAFE_MARGIN;
                                tooltipTop = buttonCenterY - tooltipHeight/2;
                                position = 'left';
                                
                                // æª¢æŸ¥å·¦å´ç©ºé–“
                                if (tooltipLeft < SAFE_MARGIN) {
                                    // å¦‚æœå·¦å´ç©ºé–“ä¸è¶³ï¼Œæ”¾åœ¨åˆé©çš„ä½ç½®
                                    tooltipLeft = SAFE_MARGIN;
                                    tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                }
                            } else {
                                // æŒ‰éˆ•åœ¨å·¦åŠéƒ¨ï¼Œå˜—è©¦æ”¾åœ¨å³å´
                                tooltipLeft = buttonRight + SAFE_MARGIN;
                                tooltipTop = buttonCenterY - tooltipHeight/2;
                                position = 'right';
                                
                                // æª¢æŸ¥å³å´ç©ºé–“
                                if (tooltipLeft + tooltipWidth > gameWidth - SAFE_MARGIN) {
                                    // å¦‚æœå³å´ç©ºé–“ä¸è¶³ï¼Œæ”¾åœ¨åˆé©çš„ä½ç½®
                                    tooltipLeft = gameWidth - tooltipWidth - SAFE_MARGIN;
                                    tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, buttonTop - tooltipHeight/2 + buttonRect.height/2));
                                }
                            }
                        }
                    }
                    
                    // ç¢ºä¿ä¸è¶…å‡ºå·¦å³é‚Šç•Œ
                    tooltipLeft = Math.max(SAFE_MARGIN, Math.min(gameWidth - tooltipWidth - SAFE_MARGIN, tooltipLeft));
                    
                    // ç¢ºä¿ä¸è¶…å‡ºä¸Šä¸‹é‚Šç•Œ
                    tooltipTop = Math.max(SAFE_MARGIN, Math.min(gameHeight - tooltipHeight - SAFE_MARGIN, tooltipTop));
                    
                    // æ ¹æ“šä½ç½®è¨­ç½®ç®­é ­
                    switch (position) {
                        case 'top':
                            // é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸Šæ–¹ï¼Œç®­é ­åœ¨åº•éƒ¨
                            arrowElement.className = 'absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-r border-b border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // èª¿æ•´ç®­é ­æ°´å¹³ä½ç½®
                            const arrowHOffset = (buttonCenterX - (tooltipLeft + tooltipWidth/2));
                            if (Math.abs(arrowHOffset) < tooltipWidth/2 - 15) {
                                arrowElement.style.left = `calc(50% + ${arrowHOffset}px)`;
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                            
                        case 'bottom':
                            // é¡¯ç¤ºåœ¨æŒ‰éˆ•ä¸‹æ–¹ï¼Œç®­é ­åœ¨é ‚éƒ¨
                            arrowElement.className = 'absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-l border-t border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // èª¿æ•´ç®­é ­æ°´å¹³ä½ç½®
                            const arrowHOffsetBottom = (buttonCenterX - (tooltipLeft + tooltipWidth/2));
                            if (Math.abs(arrowHOffsetBottom) < tooltipWidth/2 - 15) {
                                arrowElement.style.left = `calc(50% + ${arrowHOffsetBottom}px)`;
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                            
                        case 'left':
                            // é¡¯ç¤ºåœ¨æŒ‰éˆ•å·¦å´ï¼Œç®­é ­åœ¨å³å´
                            arrowElement.className = 'absolute right-0 top-1/2 transform translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-t border-r border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // èª¿æ•´ç®­é ­å‚ç›´ä½ç½®
                            const arrowVOffsetLeft = (buttonCenterY - (tooltipTop + tooltipHeight/2));
                            if (Math.abs(arrowVOffsetLeft) < tooltipHeight/2 - 15) {
                                arrowElement.style.top = `calc(50% + ${arrowVOffsetLeft}px)`;
                                arrowElement.style.left = 'auto';
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                            
                        case 'right':
                            // é¡¯ç¤ºåœ¨æŒ‰éˆ•å³å´ï¼Œç®­é ­åœ¨å·¦å´
                            arrowElement.className = 'absolute left-0 top-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-gradient-to-br from-gray-900 to-indigo-950 rotate-45 border-b border-l border-blue-500 border-opacity-30 tooltip-arrow';
                            
                            // èª¿æ•´ç®­é ­å‚ç›´ä½ç½®
                            const arrowVOffsetRight = (buttonCenterY - (tooltipTop + tooltipHeight/2));
                            if (Math.abs(arrowVOffsetRight) < tooltipHeight/2 - 15) {
                                arrowElement.style.top = `calc(50% + ${arrowVOffsetRight}px)`;
                                arrowElement.style.left = 'auto';
                            } else {
                                arrowElement.style.display = 'none';
                            }
                            break;
                    }
                    
                    // è¨­ç½®æ°£æ³¡ä½ç½®
                    tooltipElement.style.left = `${tooltipLeft + containerRect.left}px`;
                    tooltipElement.style.top = `${tooltipTop + containerRect.top}px`;
                }
            }
            
            // åœ¨DOMåŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupItemDetailsDisplay);
            } else {
                setupItemDetailsDisplay();
            }
            
            // ç¢ºä¿å³ä½¿æœ‰å»¶é²ä¹Ÿèƒ½åˆå§‹åŒ–
            setTimeout(setupItemDetailsDisplay, 500);
            
            // ç„¡è«–åœ¨DOMContentLoadedå‰é‚„æ˜¯å¾Œ
            // éƒ½è¦ç¢ºä¿é“å…·é»æ“Šäº‹ä»¶å·²è¨­ç½®
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupItemClickEvents);
            } else {
                setupItemClickEvents();
            }
            
            // å®šç¾©setupItemClickEventså‡½æ•¸
            function setupItemClickEvents() {
                // ç²å–æ‰€æœ‰é“å…·åœ–æ¨™å’Œå½ˆå‡ºå¼è¦–çª—å…ƒç´ 
                const itemIcons = document.querySelectorAll('.item-icon[data-show-info="true"]');
                const itemDetailPopup = document.getElementById('item-detail-popup');
                const popupIcon = document.getElementById('popup-icon');
                const popupTitle = document.getElementById('popup-title');
                const popupDesc = document.getElementById('popup-desc');
                const popupQuote = document.getElementById('popup-quote');
                const popupSymbolism = document.getElementById('popup-symbolism');
                const closePopupBtn = document.getElementById('close-popup');
                
                // æª¢æŸ¥å¿…è¦å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!itemDetailPopup || !popupIcon || !popupTitle || !popupDesc || !popupQuote || !popupSymbolism || !closePopupBtn) {
                    console.warn('å½ˆå‡ºè¦–çª—å…ƒç´ ç¼ºå¤±ï¼Œç„¡æ³•åˆå§‹åŒ–é“å…·é»æ“Šäº‹ä»¶');
                    return;
                }
                
                // ç‚ºæ¯å€‹é“å…·åœ–æ¨™æ·»åŠ é»æ“Šäº‹ä»¶
                itemIcons.forEach(icon => {
                    icon.addEventListener('click', function() {
                        const itemId = this.getAttribute('data-id');
                        
                        // æª¢æŸ¥é“å…·IDæ˜¯å¦å­˜åœ¨
                        if (!itemId || !window.gameItemDetails[itemId]) {
                            console.warn(`é“å…·IDä¸å­˜åœ¨æˆ–æ•¸æ“šç¼ºå¤±: ${itemId}`);
                            return;
                        }
                        
                        const item = window.gameItemDetails[itemId];
                        
                        // å¡«å……å½ˆå‡ºè¦–çª—å…§å®¹
                        popupIcon.innerHTML = `<span class="text-lg">${item.icon}</span>`;
                        popupIcon.style.backgroundColor = item.isPositive ? '#4CAF50' : '#F44336';
                        popupTitle.textContent = `${item.name} (${item.isPositive ? '+' : ''}${item.pointValue})`;
                        popupDesc.textContent = item.description;
                        popupQuote.textContent = item.quote;
                        popupSymbolism.textContent = `æ„è±¡ï¼š${item.symbolism}`;
                        
                        // é¡¯ç¤ºå½ˆå‡ºè¦–çª—
                        itemDetailPopup.classList.remove('hidden');
                    });
                });
                
                // æ·»åŠ é—œé–‰æŒ‰éˆ•äº‹ä»¶
                closePopupBtn.addEventListener('click', function() {
                    itemDetailPopup.classList.add('hidden');
                });
                
                // é»æ“Šå½ˆå‡ºè¦–çª—èƒŒæ™¯ä¹Ÿé—œé–‰å½ˆå‡ºè¦–çª—
                itemDetailPopup.addEventListener('click', function(e) {
                    if (e.target === itemDetailPopup) {
                        itemDetailPopup.classList.add('hidden');
                    }
                });
                
                console.log('é“å…·é»æ“Šäº‹ä»¶åˆå§‹åŒ–å®Œæˆ');
            }
            
            // åŒæ™‚è¨­ç½®ä¸€å€‹å®šæ™‚å™¨ï¼Œç¢ºä¿é“å…·é»æ“Šäº‹ä»¶è¢«è¨­ç½®
            setTimeout(setupItemClickEvents, 500);
            
            // æŠŠåˆå§‹åŒ–æ–¹æ³•æ”¾åœ¨å…¨å±€ï¼Œä»¥ä¾¿å¾ŒçºŒèª¿ç”¨
            window.initItemPopups = setupItemClickEvents;
            
            // è¼”åŠ©å‡½æ•¸ï¼šèª¿æ•´é¡è‰²äº®åº¦
            function adjustColor(color, percent) {
                var R = parseInt(color.substring(1,3),16);
                var G = parseInt(color.substring(3,5),16);
                var B = parseInt(color.substring(5,7),16);
            
                R = parseInt(R * (100 + percent) / 100);
                G = parseInt(G * (100 + percent) / 100);
                B = parseInt(B * (100 + percent) / 100);
            
                R = (R<255)?R:255;  
                G = (G<255)?G:255;  
                B = (B<255)?B:255;  
            
                R = Math.max(0, R);
                G = Math.max(0, G);
                B = Math.max(0, B);
            
                var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
                var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
                var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
            
                return "#"+RR+GG+BB;
            }
            });
            
            // ç²å–ç‰©å“çš„è±¡å¾µæ„ç¾©
            function getItemSymbolism(itemId) {
                const symbolism = {
                    'umbrella': 'æš«æ™‚é€ƒé¿å‘½é‹ï¼Œä½†ç„¡æ³•é¿å…æœ€çµ‚çš„æ‚²åŠ‡',
                    'cricket': 'å‘¨æ²–çš„åæŠ—ç²¾ç¥å’Œå°è‡ªç”±çš„åš®å¾€',
                    'clock': 'æ™‚é–“çš„å£“è¿«èˆ‡å‘½é‹çš„ä¸å¯é€†è½‰',
                    'photo': 'å®¶åº­ç§˜å¯†çš„æ­éœ²ï¼Œå¡µå°å¤šå¹´çš„çœŸç›¸',
                    'diary': 'é­¯ä¾èè¨˜éŒ„çš„æ‚²æ…˜æ­·å²å’Œè¨˜æ†¶',
                    'fan': 'ç¹æ¼ªå°è‡ªç”±çš„æ¸´æœ›å’Œå°ç¦éŒ®çš„åæŠ—',
                    'oldRaincoat': 'ä¾èé¢å°å„é‹æ™‚çš„é®æ“‹èˆ‡ä¿è­·',
                    'oldHouse': 'å‘¨å®¶å°å»ºå®¶åº­çš„å›šç± ï¼Œè¡¨é¢å…‰é®®å…§è£¡é™°æš—',
                    'oldSofa': 'è¡¨é¢èˆ’é©çš„ç”Ÿæ´»ï¼Œå¯¦å‰‡æ˜¯ç²¾ç¥ç¦éŒ®',
                    'medicine': 'å‘¨æ¨¸åœ’çš„æ§åˆ¶æ‰‹æ®µï¼Œå¼·åˆ¶ç¹æ¼ªæœè—¥',
                    'tigerShoes': 'ä¾èæ¯å­è¢«éºæ£„çš„è¦‹è­‰ç‰©ï¼Œå‘½é‹çš„ç—•è·¡',
                    'window': 'å°å¤–ç•Œè‡ªç”±çš„æ¸´æœ›ï¼Œç¹æ¼ªå¸¸å¸¸é–‹çª—é€æ°£',
                    'check': 'å‘¨æ¨¸åœ’è©¦åœ–ç”¨é‡‘éŒ¢æ©è“‹éå»çš„ç½ªæƒ¡',
                    'ghost': 'å‘¨å®¶è¢«éå»ç½ªæƒ¡çºç¹ï¼Œå…§å¿ƒçš„ææ‡¼'
                };
                
                return symbolism[itemId] || 'ã€Šé›·é›¨ã€‹ä¸­çš„é—œéµæ„è±¡';
            }
            
            // åœ¨éŠæˆ²åŠ è¼‰å®Œæˆæ™‚åˆå§‹åŒ–é …ç›®é»æ“Š
            document.addEventListener('DOMContentLoaded', function() {
                // æ‰€æœ‰åˆå§‹åŒ–éƒ½åœ¨å‰é¢çš„ä»£ç¢¼ä¸­å®Œæˆ
                console.log("Game initialized successfully!");
                
                // ç¢ºä¿é“å…·é»æ“ŠåŠŸèƒ½è¢«åˆå§‹åŒ–
                if (typeof initItemPopups === 'function') {
                    initItemPopups();
                }
            });
    </script>
</body>
</html>
