<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è©©è©é£›é¢ - å¤ªè™›å¹»å¢ƒ</title>
    
    <!-- å¤–éƒ¨è³‡æº -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
        }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script>
        // #region agent log
        window.addEventListener('error', function(e) {
            fetch('http://127.0.0.1:7242/ingest/68e37887-dcbc-4a22-af54-b314b9cce5eb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    location: 'index.html:global',
                    message: 'Global error caught',
                    data: { message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno },
                    timestamp: Date.now(),
                    sessionId: 'debug-session',
                    runId: 'initial-debug',
                    hypothesisId: '1'
                })
            }).catch(() => {});
        });
        fetch('http://127.0.0.1:7242/ingest/68e37887-dcbc-4a22-af54-b314b9cce5eb', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                location: 'index.html:head',
                message: 'Page loading started',
                data: { vue_global: typeof Vue !== 'undefined' },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'initial-debug',
                hypothesisId: '2'
            })
        }).catch(() => {});
        // #endregion
    </script>
    
    <style>
        :root {
            --primary: #6366f1;
            --accent: #f59e0b;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            background: #050a0f;
            font-family: "LXGW WenKai TC", sans-serif;
            color: white;
            user-select: none;
        }

        #app {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 3D å®¹å™¨ */
        #game-canvas-container {
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        /* UI å±¤ */
        #ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
        }

        .pointer-auto { pointer-events: auto; }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        /* è©©å¥é¡¯ç¤ºå€ */
        .poem-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.85));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        /* é£›é¢æº–å¿ƒ */
        #dart-cursor {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #dart-cursor.locked {
            border: 3px solid var(--primary);
            width: 50px;
            height: 50px;
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        /* æ”åƒé ­é è¦½ï¼ˆå·¦ä¸‹è§’ï¼‰ */
        #video-preview {
            position: absolute;
            bottom: 16px;
            left: 16px;
            width: 140px;
            height: 105px;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid rgba(99, 102, 241, 0.3);
            background: rgba(0, 0, 0, 0.5);
            transform: scaleX(-1);
            z-index: 25;
        }

        /* å–šé†’é€²åº¦æ¢ */
        .wake-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
        }

        /* å‹•ç•« */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-btn {
            transition: all 0.3s ease;
        }
        .mode-btn.active {
            background: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 3D æ¸²æŸ“å®¹å™¨ -->
        <div id="game-canvas-container" ref="canvasContainer"></div>

        <!-- æ‰‹å‹¢æº–å¿ƒ -->
        <div id="dart-cursor" 
             :class="{ 'locked': isHolding }" 
             :style="{ left: cursorX + 'px', top: cursorY + 'px', display: isHandDetected ? 'block' : 'none' }">
            <div v-if="isHolding" class="absolute inset-0 flex items-center justify-center">
                <i class="fas fa-crosshairs text-indigo-400 text-2xl"></i>
            </div>
        </div>

        <!-- ç•¶å‰ç„æº–ç›®æ¨™æç¤ºï¼ˆæŠ“å–å¾Œé¡¯ç¤ºåœ¨é ‚éƒ¨ä¸­å¤®ï¼‰ -->
        <div v-if="isHolding && currentAimTarget" 
             class="fixed top-36 left-1/2 -translate-x-1/2 z-30 text-center pointer-events-none">
            <div class="flex items-center gap-4 bg-indigo-600/30 backdrop-blur-sm px-6 py-3 rounded-2xl border border-indigo-500/50">
                <span class="text-indigo-300 text-sm">ç„æº–</span>
                <span class="text-5xl">{{ currentAimTarget }}</span>
                <span class="text-amber-400 text-sm animate-pulse">âœ‹ æ®å‹•ä¸¦å¼µé–‹</span>
            </div>
        </div>

        <!-- é£›é¢æ‹¿å–æç¤ºï¼ˆåº•éƒ¨ä¸­å¤®ï¼Œåªæœ‰æœªæŠ“å–æ™‚é¡¯ç¤ºï¼‰ -->
        <div v-if="isStarted && !isHolding && gameState === 'ACTIVE'" 
             class="fixed bottom-8 left-1/2 -translate-x-1/2 z-30 pointer-events-none">
            <div class="bg-black/50 backdrop-blur-sm rounded-full px-6 py-3 flex items-center gap-3">
                <span class="text-2xl">ğŸ‘Œ</span>
                <span class="text-amber-400 text-sm">ç§»å‹•åˆ°é£›é¢ä½ç½®ä¸¦æå–</span>
            </div>
        </div>

        <!-- æ”åƒé ­é è¦½ï¼ˆå·¦ä¸‹è§’ï¼‰ -->
        <div id="video-preview">
            <video ref="webcam" class="hidden" playsinline></video>
            <canvas ref="outputCanvas" class="w-full h-full object-cover"></canvas>
        </div>

        <!-- UI å±¤ -->
        <div id="ui-layer" class="p-6">
            <!-- é ‚éƒ¨ç‹€æ…‹ -->
            <div class="flex justify-between items-start">
                <div class="glass-panel px-6 py-3 flex gap-8 items-center pointer-auto">
                    <div class="text-center">
                        <p class="text-xs text-indigo-300 uppercase tracking-wider mb-1">å¾—åˆ†</p>
                        <p class="text-3xl font-bold font-mono">{{ score }}</p>
                    </div>
                    <div class="h-8 w-px bg-white/10"></div>
                    <div class="text-center">
                        <p class="text-xs text-amber-300 uppercase tracking-wider mb-1">é€£æ“Š</p>
                        <p class="text-3xl font-bold font-mono">x{{ combo }}</p>
                    </div>
                </div>

                <div class="flex gap-2 pointer-auto">
                    <button @click="switchMode('fill')" 
                            class="mode-btn glass-panel px-4 py-2 text-sm flex items-center gap-2"
                            :class="{ active: gameMode === 'fill' }">
                        <i class="fas fa-pen-nib"></i> å¡«ç©ºæ¨¡å¼
                    </button>
                    <button @click="switchMode('emoji')" 
                            class="mode-btn glass-panel px-4 py-2 text-sm flex items-center gap-2"
                            :class="{ active: gameMode === 'emoji' }">
                        <i class="fas fa-smile"></i> æ„è±¡æ¨¡å¼
                    </button>
                </div>
            </div>

            <!-- ä¸­é–“ç©ºç™½å€ï¼ˆè®“æ¨™é¶å¯è¦‹ï¼‰ -->
            <div class="flex-1"></div>
            
            <!-- åº•éƒ¨æç¤ºå€åŸŸï¼ˆä¸æ“‹ä½æ¨™é¶ï¼‰ -->
            <div class="pb-24 flex flex-col items-center pointer-none">
                <!-- æç¤ºæ¶ˆæ¯ -->
                <transition enter-active-class="animate__animated animate__fadeInUp"
                            leave-active-class="animate__animated animate__fadeOutDown">
                    <div v-if="feedbackMsg" 
                         class="bg-black/60 backdrop-blur-md px-8 py-4 rounded-full border border-white/20 text-xl font-bold text-amber-400 mb-4">
                        {{ feedbackMsg }}
                    </div>
                </transition>

                <!-- å–šé†’å¼•å° -->
                <div v-if="gameState === 'IDLE'" class="text-center bg-black/40 p-8 rounded-3xl backdrop-blur-sm border border-white/10">
                    <div class="text-6xl mb-4 animate-float">âœ‹</div>
                    <h2 class="text-2xl font-bold mb-2">è«‹å¼µé–‹æ‰‹æŒæ¿€æ´»ç³»çµ±</h2>
                    <p class="text-white/60">è®“æ”åƒé ­è­˜åˆ¥æ‚¨çš„æ‰‹éƒ¨å‹•ä½œ</p>
                    
                    <div class="mt-6 w-64 h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-indigo-500 transition-all duration-100" :style="{ width: wakeProgress + '%' }"></div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨é¡Œç›®å€ï¼ˆé ‚éƒ¨å±…ä¸­ï¼ŒåŠé€æ˜å°å¡ç‰‡ï¼‰ -->
            <div class="absolute top-20 left-1/2 -translate-x-1/2 z-20 pointer-auto">
                <transition enter-active-class="animate__animated animate__fadeInDown">
                    <div v-if="currentPoem && isStarted && !showResult" class="poem-card px-6 py-4 backdrop-blur-xl rounded-2xl max-w-lg text-center">
                        <div class="flex justify-center items-center gap-3 mb-2">
                            <h3 class="text-sm text-indigo-300">ã€Š{{ currentPoem.poem }}ã€‹</h3>
                            <span class="text-xs text-white/40">{{ currentPoem.author }}</span>
                        </div>
                        
                        <div class="text-2xl md:text-3xl leading-relaxed tracking-wider">
                            <template v-if="gameMode === 'fill'">
                                <span v-for="(char, index) in displayVerse" :key="index"
                                      :class="{ 'text-amber-400 border-b-2 border-amber-500/50 px-1 mx-0.5': char === 'â–¢' }">
                                    {{ char }}
                                </span>
                            </template>
                            <template v-else>
                                {{ currentPoem.verse }}
                            </template>
                        </div>

                        <div v-if="gameMode === 'emoji'" class="flex justify-center gap-3 mt-3">
                            <div v-for="i in 3" :key="i" 
                                 class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-xl"
                                 :class="{ 'bg-green-500/20 border-green-500/50': foundEmojis.length >= i }">
                                <span v-if="foundEmojis[i-1]">{{ foundEmojis[i-1] }}</span>
                                <span v-else class="text-white/20">?</span>
                            </div>
                        </div>
                    </div>
                </transition>
            </div>
        </div>

        <!-- çµç®—å½ˆçª— -->
        <transition enter-active-class="animate__animated animate__zoomIn"
                    leave-active-class="animate__animated animate__fadeOut">
            <div v-if="showResult" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-lg">
                <div class="bg-slate-800 p-10 rounded-3xl border border-white/10 text-center max-w-lg shadow-2xl">
                    <div class="text-6xl mb-6">{{ isCorrect ? 'ğŸ‰' : 'ğŸ’¡' }}</div>
                    <h2 class="text-3xl font-bold mb-4" :class="isCorrect ? 'text-green-400' : 'text-amber-400'">
                        {{ isCorrect ? 'æ­£ç¢ºï¼' : 'å¯æƒœäº†' }}
                    </h2>
                    
                    <div class="bg-black/20 p-6 rounded-2xl mb-8 text-left italic leading-relaxed text-white/80">
                        {{ currentPoem.explanation }}
                    </div>
                    
                    <!-- æ‰‹å‹¢æ“ä½œæç¤º -->
                    <div class="flex items-center justify-center gap-3 py-4 px-6 bg-indigo-600/20 rounded-2xl border border-indigo-500/30">
                        <div class="text-4xl animate-pulse">âœ‹</div>
                        <div class="text-left">
                            <p class="text-indigo-300 font-bold">å¼µé–‹æ‰‹æŒ</p>
                            <p class="text-indigo-200/60 text-sm">ç¹¼çºŒä¸‹ä¸€é¡Œ</p>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- åˆå§‹å¼•å°å±¤ -->
        <div v-if="!isStarted" class="absolute inset-0 z-[100] flex items-center justify-center bg-slate-950">
            <div class="text-center">
                <h1 class="text-6xl font-bold mb-4 tracking-tighter">è©©è©é£›é¢</h1>
                <p class="text-indigo-400 text-xl mb-12">POETRY DARTS 3D</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12 text-left max-w-2xl mx-auto px-6">
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-indigo-300 mb-2">âœ‹ å–šé†’èˆ‡ç„æº–</h3>
                        <p class="text-sm text-white/60">å¼µé–‹äº”æŒ‡æ¿€æ´»ç³»çµ±ï¼Œç§»å‹•æ‰‹æŒä¾†æ§åˆ¶ç´…è‰²çš„æº–å¿ƒã€‚</p>
                    </div>
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-indigo-300 mb-2">ğŸ‘Œ æŠ“å–é£›é¢</h3>
                        <p class="text-sm text-white/60">ç•¶æº–å¿ƒé è¿‘é£›é¢æ™‚ï¼Œæåˆæ‹‡æŒ‡èˆ‡é£ŸæŒ‡å³å¯é–å®šæŠ“å–ã€‚</p>
                    </div>
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-indigo-300 mb-2">ğŸš€ å¿«é€ŸæŠ•æ“²</h3>
                        <p class="text-sm text-white/60">ä¿æŒæåˆä¸¦å¿«é€Ÿæ®å‹•æ‰‹è‡‚ï¼Œåœ¨çµ‚é»é¬†é–‹æ‰‹æŒ‡å®ŒæˆæŠ•æ“²ã€‚</p>
                    </div>
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-indigo-300 mb-2">ğŸ¯ å­¸ç¿’æˆé•·</h3>
                        <p class="text-sm text-white/60">åœ¨éŠæˆ²ä¸­è¨˜æ†¶è©©å¥ã€ç†è§£æ„è±¡ï¼Œæ„Ÿå—å¤è©©è©çš„ç‰©ç†é­…åŠ›ã€‚</p>
                    </div>
                </div>
                
                <button @click="startGame" class="pointer-auto bg-indigo-600 hover:bg-indigo-500 text-white px-12 py-5 rounded-full font-bold text-2xl transition-all shadow-2xl shadow-indigo-600/40">
                    é€²å…¥è³½å ´
                </button>
            </div>
        </div>
    </div>

    <!-- æ‡‰ç”¨åˆ‡æ›å™¨ -->
    <script src="/assets/js/taixu-app-switcher.js"></script>
    
    <!-- é‚è¼¯è…³æœ¬ -->
    <script type="module" src="js/app.js"></script>
</body>
</html>

