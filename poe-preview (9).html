<!DOCTYPE html><html lang="zh-tw"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>長干行旅 - 李白詩歌互動游戲</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#8CBF77',
                            light: '#B3E0A1',
                            dark: '#6A8F58',
                        },
                        ink: {
                            DEFAULT: '#2C3E2D',
                            light: '#4A5E4B',
                        },
                        paper: {
                            DEFAULT: '#f4f9ef',
                            light: '#fcfef9',
                            dark: '#e2ecda',
                        },
                        season: {
                            spring: '#7BC950',
                            summer: '#E5A046',
                            autumn: '#B87A71',
                            winter: '#7CAED6',
                        }
                    },
                    fontFamily: {
                        serif: ['LXGW WenKai', '"Noto Serif TC"', 'serif'],
                        display: ['"Noto Serif SC"', 'serif'],
                    },
                }
            }
        };
    </script>
    <style>
        /* 落霞孤鶩文楷 */
@import url('https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css');
/* 思源宋體 (Source Han Serif) */
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700;900&display=swap');
        
        :root {
            --primary: #8CBF77;
            --primary-light: #B3E0A1;
            --primary-dark: #6A8F58;
            --primary-bg: rgba(140, 191, 119, 0.15);
            
            --paper: #f4f9ef;
            --paper-light: #fcfef9;
            --paper-dark: #e2ecda;
            --ink: #2C3E2D;
            --ink-light: #4A5E4B;
            
            --season-spring: #7BC950;
            --season-spring-light: #A8E480;
            --season-summer: #E5A046;
            --season-summer-light: #FFD496;
            --season-autumn: #B87A71;
            --season-autumn-light: #F0B3AA;
            --season-winter: #7CAED6;
            --season-winter-light: #BDDEFF;
            
            --resource-silver: #768A96;
            --resource-rice: #D4B06C;
            --resource-silk: #5D87B7;
            --resource-goods: #689F7C;
            
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
            
            --font-family-serif: 'LXGW WenKai', 'Noto Serif TC', serif;
            --font-family-display: 'Noto Serif SC', serif;
            
            /* 季節主色調 */
            --spring-primary: #7BC950;
            --summer-primary: #E5A046;
            --autumn-primary: #B87A71;
            --winter-primary: #7CAED6;
            
            /* 通知類型色調 */
            --notify-default: #5D5CDE;
            --notify-poem: #E5A046;
            --notify-ending: #B87A71;
            --notify-hint: #7CAED6;
        }
        
        /* 通知系統樣式 */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-width: 90vw;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .notification {
            padding: 12px 15px;
            background-color: var(--paper-light);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            pointer-events: auto;
            border-left: 4px solid var(--notify-default);
            max-width: 300px;
        }
        
        .dark .notification {
            background-color: var(--paper-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.hide {
            transform: translateX(120%);
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: var(--notify-default);
            width: 100%;
            transform-origin: left;
            transform: scaleX(0);
        }
        
        .notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            color: var(--ink);
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            padding-right: 20px;
            color: var(--ink);
        }
        
        .notification-message {
            font-size: 13px;
            line-height: 1.4;
            color: var(--ink-light);
        }
        
        /* 通知類型樣式 */
        .notification.default {
            border-color: var(--notify-default);
        }
        
        .notification.default .notification-progress {
            background-color: var(--notify-default);
        }
        
        .notification.poem {
            border-color: var(--notify-poem);
        }
        
        .notification.poem .notification-progress {
            background-color: var(--notify-poem);
        }
        
        .notification.ending {
            border-color: var(--notify-ending);
        }
        
        .notification.ending .notification-progress {
            background-color: var(--notify-ending);
        }
        
        .notification.hint {
            border-color: var(--notify-hint);
        }
        
        .notification.hint .notification-progress {
            background-color: var(--notify-hint);
        }
        
        /* 通知出場動畫 */
        @keyframes progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }
        
        /* 隱藏滾動條但保留滾動功能 */
        #messages, #history-messages, .message-scrollable {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        #messages::-webkit-scrollbar, 
        #history-messages::-webkit-scrollbar, 
        .message-scrollable::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        
        /* 通知圖標 */
        .notification-icon {
            float: left;
            margin-right: 10px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .notification.default .notification-icon {
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--notify-default);
        }
        
        .notification.poem .notification-icon {
            background-color: rgba(229, 160, 70, 0.1);
            color: var(--notify-poem);
        }
        
        .notification.ending .notification-icon {
            background-color: rgba(184, 122, 113, 0.1);
            color: var(--notify-ending);
        }
        
        .notification.hint .notification-icon {
            background-color: rgba(124, 174, 214, 0.1);
            color: var(--notify-hint);
        }
        
        body {
            font-family: var(--font-family-serif);
            background-color: var(--paper);
            color: var(--ink);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .dark {
            --paper: #1e2720;
            --paper-light: #2d3a30;
            --paper-dark: #151c18;
            --ink: #e6f0ea;
            --ink-light: #c8d6cf;
            --primary: #7CAD69;
            --primary-light: #9CC383;
            --primary-dark: #5A8049;
        }
        
        .title-font {
            font-family: var(--font-family-display);
        }
        
        .btn {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            border-radius: 0.75rem;
            transition-property: all;
            transition-duration: 300ms;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            text-align: center;
            transform-origin: center;
        }
        
        .btn-primary {
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
        }
        
        .btn-secondary {
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: linear-gradient(135deg, #d4a017 0%, #A89B78 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background: linear-gradient(135deg, #E5D2A8 0%, #d4a017 100%);
            transform: translateY(-2px);
        }
        
        .paper-bg {
            background-color: var(--paper-light);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--paper-dark);
            border-radius: 0.75rem;
        }
        
        .dark .paper-bg {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .character-card {
            padding: 1.5rem;
            border-radius: 1rem;
            transition-property: all;
            transition-duration: 300ms;
            cursor: pointer;
            background: linear-gradient(135deg, var(--paper-light) 0%, var(--paper) 100%);
            border: 2px solid var(--paper-dark);
        }
        
        .character-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-4px);
        }
        
        .character-card.selected {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-bg) 0%, transparent 100%);
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            position: relative;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.8) 0%, rgba(252, 252, 252, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all var(--transition-normal);
        }
        
        .dark .resource-item {
            background: linear-gradient(145deg, rgba(45, 45, 55, 0.7) 0%, rgba(35, 35, 45, 0.5) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
        }
        
        .resource-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .resource-icon {
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--primary-bg) 0%, rgba(255, 255, 255, 0.5) 100%);
            box-shadow: 0 2px 6px rgba(140, 191, 119, 0.15);
            border: 1px solid rgba(140, 191, 119, 0.15);
        }
        
        .resource-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .resource-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--ink);
        }
        
        .resource-value {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--ink-light);
        }
        
        @keyframes resource-change-float {
            0% { transform: translateY(0); opacity: 0; }
            20% { transform: translateY(-15px); opacity: 1; }
            80% { transform: translateY(-25px); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        
        .resource-change-indicator {
            position: absolute;
            right: 0.5rem;
            font-weight: bold;
            font-size: 1rem;
            animation: resource-change-float 2s forwards;
            z-index: 10;
        }
        
        .resource-change-indicator.increase {
            color: #16a34a;
        }
        
        .resource-change-indicator.decrease {
            color: #dc2626;
        }
        
        .poem-fragment, .poem-fragment-locked {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
            font-weight: 500;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .poem-fragment {
            background-color: rgba(140, 191, 119, 0.08);
            border: 1px solid rgba(140, 191, 119, 0.25);
            color: var(--ink);
            box-shadow: 0 1px 3px rgba(140, 191, 119, 0.1);
        }
        
        .poem-fragment:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(140, 191, 119, 0.15);
            background-color: rgba(140, 191, 119, 0.12);
        }
        
        .poem-fragment-locked {
            background-color: rgba(100, 100, 100, 0.05);
            border: 1px dashed rgba(150, 150, 150, 0.2);
            color: rgba(100, 100, 100, 0.7);
            opacity: 0.5;
        }
        
        .action-btn {
            padding: 0.6rem;
            border-radius: 0.75rem;
            transition-property: all;
            transition-duration: 300ms;
            text-align: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100px; /* 減少最小高度 */
            max-height: 100px; /* 減少最大高度 */
        }
        
        .action-btn:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-3px);
            border-color: var(--primary);
        }
        
        .action-btn:active {
            transform: translateY(0px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .action-btn.practical {
            background: linear-gradient(145deg, #2A6547 0%, #1A4733 100%); /* 修改為較深的綠色 */
            color: #f5f9f2;
            border: 1px solid rgba(140, 191, 119, 0.4);
        }
        
        .dark .action-btn.practical {
            background: linear-gradient(145deg, #2A6547 0%, #1A4733 100%);
            color: #e5f5e0;
        }
        
        .action-btn.practical .action-icon {
            color: var(--primary-light);
            background-color: rgba(140, 191, 119, 0.08);
        }
        
        .action-btn.poetic {
            background: linear-gradient(145deg, #7D4E57 0%, #5A3940 100%); /* 修改為較深的紫紅色 */
            color: #f9f2f5;
            border: 1px solid rgba(191, 119, 140, 0.3);
            height: 100%; /* 確保與務實動作相同高度 */
        }
        
        .dark .action-btn.poetic {
            background: linear-gradient(145deg, #7D4E57 0%, #5A3940 100%);
            color: #f5e0e8;
        }
        
        .action-btn.poetic .action-icon {
            color: #D388A2;
            background-color: rgba(191, 119, 140, 0.05);
        }
        
        .scene-bg {
            position: relative;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            height: 280px; /* 從 350px 縮小至 280px */
        }
        
        .scene-bg.scene-spring.scene-wife {
            background: linear-gradient(to bottom, #d9f5cb 0%, #f4fcef 100%);
            position: relative;
            overflow: hidden;
        }
        
        .scene-bg.scene-summer.scene-wife {
            background: linear-gradient(to bottom, #ffecda 0%, #fff8e8 100%);
            position: relative;
            overflow: hidden;
        }
        
        .scene-bg.scene-autumn.scene-wife {
            background: linear-gradient(to bottom, #f8ded0 0%, #fbf3e9 100%);
            position: relative;
            overflow: hidden;
        }
        
        .scene-bg.scene-winter.scene-wife {
            background: linear-gradient(to bottom, #e8f0f7 0%, #f5fafd 100%);
            position: relative;
            overflow: hidden;
        }
        
        .season-decoration {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }
        
        .spring-flower {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #ffccd5;
            border-radius: 50%;
            z-index: 1;
            animation: sway-gently 6s ease-in-out infinite;
        }
        
        .grass {
            position: absolute;
            bottom: 40px;
            width: 8px;
            height: 15px;
            background-color: #74b358;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            z-index: 2;
            transform-origin: bottom center;
            animation: grass-sway 4s ease-in-out infinite;
        }
        
        @keyframes grass-sway {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
        
        .fallen-leaf {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #e28743;
            clip-path: polygon(50% 0%, 75% 25%, 100% 50%, 75% 75%, 50% 100%, 25% 75%, 0% 50%, 25% 25%);
            z-index: 2;
            transform: rotate(45deg);
            animation: sway-gently 5s ease-in-out infinite;
        }
        
        .snow-pile {
            position: absolute;
            bottom: 70px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50% 50% 0 0;
            z-index: 2;
        }
        
        .life-element {
            position: absolute;
            z-index: 4;
            pointer-events: none;
        }
        
        .clothes-line {
            position: absolute;
            height: 2px;
            background-color: #9e9e9e;
            z-index: 3;
        }
        
        .hanging-cloth {
            position: absolute;
            width: 15px;
            height: 20px;
            background-color: #e0f2f1;
            border-radius: 2px 2px 8px 8px;
            z-index: 4;
            transform-origin: top center;
            animation: cloth-sway 6s ease-in-out infinite;
        }
        
        @keyframes cloth-sway {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(3deg); }
            75% { transform: rotate(-3deg); }
            100% { transform: rotate(0deg); }
        }
        
        .bird-cage {
            position: absolute;
            width: 30px;
            height: 40px;
            border: 2px solid #8d6e63;
            border-radius: 15px 15px 5px 5px;
            z-index: 4;
            animation: cage-sway 5s ease-in-out infinite;
        }
        
        @keyframes cage-sway {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(2deg); }
            100% { transform: rotate(0deg); }
        }
        
        .cargo-box {
            position: absolute;
            width: 20px;
            height: 15px;
            background-color: #8d6e63;
            z-index: 6;
        }
        
        .scene-bg.scene-spring.scene-husband {
            background: linear-gradient(to bottom, #a1d4ee 0%, #cee9fa 100%);
        }
        
        .scene-bg.scene-summer.scene-husband {
            background: linear-gradient(to bottom, #65a6d4 0%, #a1d9f2 100%);
        }
        
        .scene-bg.scene-autumn.scene-husband {
            background: linear-gradient(to bottom, #7a93c0 0%, #99b5e1 100%);
        }
        
        .scene-bg.scene-winter.scene-husband {
            background: linear-gradient(to bottom, #6f89a8 0%, #b4c5d6 100%);
        }
        
        .ground-wife {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px; /* 進一步從60px降低到40px */
            z-index: 2;
        }
        
        .scene-spring .ground-wife {
            background: linear-gradient(to bottom, #8bc34a60 0%, #8bc34a 100%);
        }
        
        .scene-summer .ground-wife {
            background: linear-gradient(to bottom, #cddc3960 0%, #cddc39 100%);
        }
        
        .scene-autumn .ground-wife {
            background: linear-gradient(to bottom, #ff980060 0%, #ff9800 100%);
        }
        
        .scene-winter .ground-wife {
            background: linear-gradient(to bottom, #cfd8dc60 0%, #cfd8dc 100%);
        }
        
        .water-husband {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            z-index: 2;
        }
        
        .scene-spring .water-husband {
            background: linear-gradient(to bottom, transparent 0%, #64b5f690 50%, #2196f3 100%);
        }
        
        .scene-summer .water-husband {
            background: linear-gradient(to bottom, transparent 0%, #039be590 50%, #0288d1 100%);
        }
        
        .scene-autumn .water-husband {
            background: linear-gradient(to bottom, transparent 0%, #5c6bc090 50%, #3f51b5 100%);
        }
        
        .scene-winter .water-husband {
            background: linear-gradient(to bottom, transparent 0%, #78909c90 50%, #546e7a 100%);
        }
        
        .house {
            position: absolute;
            bottom: 40px; /* 進一步調整至40px，與地面高度一致 */
            right: 80px;
            width: 120px;
            height: 100px;
            z-index: 3;
        }
        
        .house-wall {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            background-color: #d7ccc8;
            border: 1px solid #8d6e63;
        }
        
        .house-roof {
            position: absolute;
            bottom: 60px;
            width: 140px;
            height: 50px;
            left: -10px;
            background-color: #795548;
            clip-path: polygon(0 100%, 50% 0, 100% 100%);
            z-index: 4;
        }
        
        .house-door {
            position: absolute;
            bottom: 0;
            left: 45px;
            width: 30px;
            height: 40px;
            background-color: #5d4037;
        }
        
        .house-window {
            position: absolute;
            bottom: 30px;
            left: 20px;
            width: 20px;
            height: 20px;
            background-color: #efebe9;
            border: 1px solid #5d4037;
        }
        
        .house-window.right {
            left: 80px;
        }
        
        .plum-tree {
            position: absolute;
            bottom: 40px;
            right: 200px;
            z-index: 3;
        }
        
        .tree-trunk {
            position: absolute;
            bottom: 0;
            width: 15px;
            height: 80px;
            background-color: #5d4037;
        }
        
        .tree-branches {
            position: absolute;
            width: 120px;
            height: 90px;
            bottom: 70px;
            left: -50px;
            z-index: 3;
        }
        
        .scene-spring .tree-branches {
            background-color: #a5d6a7;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 20px -10px 0 0 #a5d6a7, -20px -10px 0 0 #a5d6a7, 0 -20px 0 0 #a5d6a7;
        }
        
        .scene-summer .tree-branches {
            background-color: #66bb6a;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 20px -10px 0 0 #66bb6a, -20px -10px 0 0 #66bb6a, 0 -20px 0 0 #66bb6a;
        }
        
        .scene-autumn .tree-branches {
            background-color: #ffb74d;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 20px -10px 0 0 #ffb74d, -20px -10px 0 0 #ffb74d, 0 -20px 0 0 #ffb74d;
        }
        
        .scene-winter .tree-branches {
            background-color: #90a4ae;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 20px -10px 0 0 #90a4ae, -20px -10px 0 0 #90a4ae, 0 -20px 0 0 #90a4ae;
        }
        
        .sun {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            z-index: 1;
        }
        
        .scene-spring .sun {
            background: radial-gradient(circle, #FFE53B 0%, #FF7E00 100%);
            box-shadow: 0 0 20px rgba(255, 238, 59, 0.6);
            top: 30px;
            right: 350px; /* 更進一步向左移動 */
        }
        
        .scene-summer .sun {
            background: radial-gradient(circle, #FFE53B 0%, #FF7E00 100%);
            box-shadow: 0 0 30px rgba(255, 126, 0, 0.8);
            top: 25px;
            right: 370px; /* 更進一步向左移動 */
            width: 70px;
            height: 70px;
        }
        
        .scene-autumn .sun {
            background: radial-gradient(circle, #FFD1A3 0%, #FF9500 100%);
            box-shadow: 0 0 20px rgba(255, 149, 0, 0.6);
            top: 35px;
            right: 360px; /* 更進一步向左移動 */
        }
        
        .scene-winter .sun {
            background: radial-gradient(circle, #F5F7FA 0%, #C3CFE2 100%);
            box-shadow: 0 0 15px rgba(195, 207, 226, 0.5);
            top: 40px;
            right: 380px; /* 更進一步向左移動 */
            width: 50px;
            height: 50px;
        }
        
        .cloud {
            position: absolute;
            background-color: #fff;
            border-radius: 50px;
            z-index: 1;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.1));
            animation: float-cloud linear infinite;
        }
        
        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background-color: inherit;
            border-radius: 50%;
        }
        
        .cloud.large {
            width: 120px;
            height: 45px;
            animation-duration: 60s;
        }
        
        .cloud.large::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 25px;
        }
        
        .cloud.large::after {
            width: 70px;
            height: 70px;
            top: -35px;
            right: 20px;
        }
        
        .cloud.medium {
            width: 100px;
            height: 40px;
            animation-duration: 75s;
        }
        
        .cloud.medium::before {
            width: 45px;
            height: 45px;
            top: -22px;
            left: 20px;
        }
        
        .cloud.medium::after {
            width: 60px;
            height: 60px;
            top: -30px;
            right: 15px;
        }
        
        .cloud.small {
            width: 80px;
            height: 30px;
            animation-duration: 45s;
        }
        
        .cloud.small::before {
            width: 35px;
            height: 35px;
            top: -17px;
            left: 15px;
        }
        
        .cloud.small::after {
            width: 45px;
            height: 45px;
            top: -22px;
            right: 10px;
        }
        
        @keyframes float-cloud {
            0% { transform: translateX(-150px); }
            100% { transform: translateX(calc(100% + 150px)); }
        }
        
        .cherry-blossom {
            position: absolute;
            width: 30px;
            height: 30px;
            z-index: 3;
            animation: sway-gently 8s ease-in-out infinite;
        }
        
        .flower-petals {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
        }
        
        .flower-petal {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #ffd7e5;
            border-radius: 12px 0;
            transform-origin: bottom right;
            top: 50%;
            left: 50%;
            margin-left: -6px;
            margin-top: -6px;
        }
        
        .flower-petal:nth-child(1) { transform: rotate(0deg); }
        .flower-petal:nth-child(2) { transform: rotate(72deg); }
        .flower-petal:nth-child(3) { transform: rotate(144deg); }
        .flower-petal:nth-child(4) { transform: rotate(216deg); }
        .flower-petal:nth-child(5) { transform: rotate(288deg); }
        
        .flower-center {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #ffcc00;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        @keyframes sway-gently {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(3deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(5px) rotate(-3deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        
        .plum-fruit {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #c5e1a5;
            border-radius: 50%;
            z-index: 4;
        }
        
        .merchant-boat {
            position: absolute;
            bottom: 30px;
            left: 100px;
            z-index: 5;
            width: 140px;
            height: 60px;
        }
        
        .boat-body {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 30px;
            background-color: #795548;
            border-radius: 5px 15px 0 0;
        }
        
        .boat-cabin {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 20px;
            background-color: #a1887f;
        }
        
        .boat-sail {
            position: absolute;
            bottom: 30px;
            left: 100px;
            width: 0;
            height: 0;
            border-left: 30px solid transparent;
            border-right: 0px solid transparent;
            border-bottom: 70px solid #efebe9;
            transform: rotate(10deg);
            z-index: 4;
        }
        
        .mountains {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 300px;
            height: 150px;
            z-index: 1;
        }
        
        .mountain {
            position: absolute;
            bottom: 0;
        }
        
        .mountain.left {
            left: 0;
            width: 150px;
            height: 100px;
            clip-path: polygon(0% 100%, 50% 20%, 100% 100%);
        }
        
        .mountain.right {
            right: 0;
            width: 200px;
            height: 150px;
            clip-path: polygon(0% 100%, 40% 30%, 70% 60%, 100% 15%, 100% 100%);
        }
        
        .scene-spring .mountain {
            background: linear-gradient(to top, #8bc34a 30%, #689f38 100%);
        }
        
        .scene-summer .mountain {
            background: linear-gradient(to top, #7cb342 30%, #558b2f 100%);
        }
        
        .scene-autumn .mountain {
            background: linear-gradient(to top, #ff7043 30%, #e64a19 100%);
        }
        
        .scene-winter .mountain {
            background: linear-gradient(to top, #b0bec5 30%, #78909c 100%);
        }
        
        .season-marker {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: absolute;
            top: 0.5rem;
            left: 1rem;
            z-index: 10;
            font-size: 1.2rem;
            padding: 0.25rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        /* 季節文字顏色樣式 */
        .spring { color: var(--spring-primary); }
        .summer { color: var(--summer-primary); }
        .autumn { color: var(--autumn-primary); }
        .winter { color: var(--winter-primary); }
        
        /* 季節轉換動畫 */
        @keyframes season-transition {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* 年份變化效果 */
        .second-year .player-name {
            text-shadow: 0 0 2px var(--primary-light);
        }
        
        .third-year .player-name {
            text-shadow: 0 0 5px var(--primary-light);
        }
        
        /* 歲月流逝視覺線索 */
        .second-year .character-desc::after {
            content: " 歲月悄然改變著容顏。";
            font-style: italic;
            opacity: 0.8;
        }
        
        .third-year .character-desc::after {
            content: " 風霜染鬢，思緒漸深。";
            font-style: italic;
            opacity: 0.8;
        }
        
        .date-display {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: absolute;
            top: 3rem;
            left: 1rem;
            z-index: 10;
            font-size: 1rem;
            color: var(--ink);
        }
        
        .event-marker {
            position: absolute;
            cursor: pointer;
            z-index: 20;
            animation: float-event 8s ease-in-out infinite, pulse-ring 1.5s ease-in-out infinite;
            transition: transform 0.2s ease;
            min-width: 36px;
            min-height: 36px;
            background-color: rgba(106, 143, 88, 0.85);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(106, 143, 88, 0.7), inset 0 0 12px rgba(86, 123, 68, 0.8);
            border: 3px solid rgba(76, 113, 58, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 5px #0a2e10;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            overflow: visible;
        }
        
        .event-marker::before {
            content: "!";
            position: absolute;
            font-weight: bold;
            font-size: 16px;
            z-index: 21;
            text-shadow: 0 0 5px #0a2e10;
            color: #ffd700;
            animation: pulse-content 1.5s ease-in-out infinite;
        }
        
        .event-marker::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            background: linear-gradient(45deg, rgba(76,113,58,0.9), rgba(106,143,88,0.5)) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            animation: rotate-ring 4s linear infinite;
            z-index: 19;
            box-shadow: 0 0 10px rgba(158, 213, 132, 0.4);
        }
        
        @keyframes float-event {
            0% { transform: translateY(0) translateX(0) rotate(0deg); }
            50% { transform: translateY(-10px) translateX(5px) rotate(2deg); }
            100% { transform: translateY(0) translateX(0) rotate(0deg); }
        }
        
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 10px rgba(106, 143, 88, 0.5), inset 0 0 8px rgba(86, 123, 68, 0.6); }
            50% { box-shadow: 0 0 30px rgba(140, 190, 120, 1), inset 0 0 20px rgba(120, 180, 90, 1); filter: brightness(1.2); }
            100% { box-shadow: 0 0 10px rgba(106, 143, 88, 0.5), inset 0 0 8px rgba(86, 123, 68, 0.6); }
        }
        
        @keyframes pulse-content {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.15); }
            100% { opacity: 0.7; transform: scale(1); }
        }
        
        @keyframes rotate-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .event-title {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 30;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .event-marker:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        .event-marker:hover .event-title {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        
        .rare-event-marker {
            animation: float-event-rare 7s ease-in-out infinite;
            background-color: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.7);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        @keyframes float-event-rare {
            0% { transform: translateY(0) translateX(0) rotate(-2deg); }
            50% { transform: translateY(-15px) translateX(-5px) rotate(2deg); }
            100% { transform: translateY(0) translateX(0) rotate(-2deg); }
        }
        
        .special-event-marker {
            background-color: rgba(255, 140, 0, 0.2);
            border-color: rgba(255, 140, 0, 0.7);
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.5);
        }
        
        .weather-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 3;
        }
        
        .weather-particle {
            position: absolute;
            z-index: 5;
        }
        
        .scene-decoration {
            position: absolute;
            z-index: 2;
            pointer-events: none;
        }
        
        .cherry-blossom {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #ffb7c5;
            border-radius: 15px 0 15px 0;
            transform: rotate(45deg);
            opacity: 0.8;
        }
        
        .green-plum {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #a4de7c;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
        }
        
        .roof {
            position: absolute;
            bottom: 100px;
            right: 80px;
            width: 100px;
            height: 40px;
            background-color: #8D6E63;
            clip-path: polygon(0 100%, 50% 0, 100% 100%);
            z-index: 3;
        }
        
        .merchant-ship {
            position: absolute;
            bottom: 30px;
            left: 20%;
            width: 120px;
            height: 40px;
            z-index: 5;
        }
        
        .ship-body {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 25px;
            background-color: #5D4037;
            border-radius: 10px 30px 0 0;
        }
        
        .ship-sail {
            position: absolute;
            bottom: 25px;
            left: 40px;
            width: 40px;
            height: 60px;
            background-color: #F5F5F5;
            clip-path: polygon(0 0, 100% 20%, 100% 100%, 0% 100%);
        }
        
        .mountain {
            position: absolute;
            bottom: 60px;
            right: 10%;
            width: 150px;
            height: 100px;
            background: linear-gradient(to top, #558B2F, #7CB342);
            clip-path: polygon(0 100%, 30% 30%, 50% 60%, 70% 20%, 100% 100%);
            z-index: 2;
            opacity: 0.9;
        }
        
        @keyframes fall-rotate {
            0% { transform: translateY(-10%) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100%) translateX(30px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes rain-fall {
            0% { transform: translateY(-10%) translateX(0); opacity: 0; }
            10% { opacity: 0.7; }
            100% { transform: translateY(110%) translateX(-15px); opacity: 0; }
        }
        
        @keyframes leaf-fall {
            0% { transform: translateY(-10%) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110%) translateX(50px) rotate(180deg); opacity: 0; }
        }
        
        @keyframes snow-fall {
            0% { transform: translateY(-10%) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(110%) translateX(25px) rotate(360deg); opacity: 0; }
        }
        
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
            background-color: rgba(140, 191, 119, 0.15);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .modal-container.active {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
        }
        
        .modal-content {
            background-color: var(--paper-light);
            color: var(--ink);
            padding: 1.5rem;
            border-radius: 1.2rem;
            box-shadow: 0 8px 25px rgba(140, 191, 119, 0.2);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid rgba(140, 191, 119, 0.2);
            animation: modal-appear 0.3s ease;
            margin: 1rem;
        }
        
        @keyframes modal-appear {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .event-header {
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 3.75rem;
            min-height: 3rem;
            border-bottom: 1px solid rgba(140, 191, 119, 0.15);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
        }
        
        .event-icon-wrapper {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: rgba(140, 191, 119, 0.1);
            border: 1px solid rgba(140, 191, 119, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(140, 191, 119, 0.1);
        }
        
        .event-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .choice-option {
            padding: 1.25rem;
            border-radius: 0.75rem;
            transition-property: all;
            transition-duration: 300ms;
            text-align: center;
            position: relative;
            overflow: hidden;
            background: linear-gradient(145deg, rgba(230, 245, 225, 0.95) 0%, rgba(248, 255, 245, 0.9) 100%);
            border: 1px solid rgba(140, 191, 119, 0.3);
            transform-origin: center;
            box-shadow: 0 2px 8px rgba(140, 191, 119, 0.15);
            backdrop-filter: blur(5px);
            font-size: 1.05rem;
            line-height: 1.5;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            color: #1e3423; /* 深绿色文字，增加对比度 */
            font-weight: 500;
        }
        
        .choice-option:hover {
            box-shadow: 0 5px 15px rgba(140, 191, 119, 0.25);
            transform: translateY(-3px);
            border-color: var(--primary);
        }
        
        .message-item {
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            border-left-width: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-left-color: var(--primary);
            animation: slide-in 0.3s ease;
        }
        
        .choice-option.poetic-choice {
            background: linear-gradient(145deg, #f2f9ec 0%, #e9f5e0 100%);
            border-color: rgba(140, 191, 119, 0.3);
            color: #143218; /* 更深的绿色，增加对比度 */
            font-weight: 600;
        }
        
        .choice-option.poetic-choice:hover {
            box-shadow: 0 5px 15px rgba(140, 191, 119, 0.3);
            background: linear-gradient(145deg, #e8f7e2 0%, #dff0d5 100%);
        }
        
        @keyframes slide-in {
            0% { transform: translateX(-10px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        .tutorial-container {
            position: fixed;
            z-index: 50;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
            background-color: var(--paper-light);
            border: 1px solid var(--primary-light);
            max-width: 380px;
            animation: fade-slide-up 0.5s ease;
            transition: all 0.3s ease-in-out;
        }
        
        .tutorial-container::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--paper-light);
            transform: rotate(45deg);
            z-index: -1;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .tutorial-container.position-top::after {
            bottom: -10px;
            left: 25px;
        }
        
        .tutorial-container.position-right::after {
            left: -10px;
            top: 25px;
        }
        
        .tutorial-container.position-bottom::after {
            top: -10px;
            left: 25px;
        }
        
        .tutorial-container.position-left::after {
            right: -10px;
            top: 25px;
        }
        
        .tutorial-highlight {
            position: relative;
            z-index: 45;
            animation: pulse-highlight 2s infinite;
            box-shadow: 0 0 0 4px rgba(140, 191, 119, 0.7);
            border-radius: inherit;
        }

        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(140, 191, 119, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(140, 191, 119, 0); }
            100% { box-shadow: 0 0 0 0 rgba(140, 191, 119, 0); }
        }
        
        @keyframes fade-slide-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .ending-stat {
            text-align: center;
            padding: 0 1rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--ink-light);
        }
        
        .fade-in {
            animation: fadeIn 0.7s ease-out;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .bounce-in {
            animation: bounceIn 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- 通知容器 -->
    <div class="notification-container">
        <!-- 通知會自動填充到這裡 -->
    </div>
    
    <div id="game-container" class="max-w-5xl mx-auto p-4 flex-grow">
        <!-- 開始畫面 -->
        <div id="start-screen" class="fade-in min-h-screen flex flex-col justify-center">
            <div class="text-center relative z-10 py-4 px-4">
                <!-- 標題與詩句並排顯示 -->
                <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-5">
                    <!-- 標題區域 -->
                    <div class="md:w-1/2 mb-4 md:mb-0">
                        <h1 class="text-4xl md:text-5xl font-bold title-font text-primary-dark dark:text-primary-light">
                            長干行旅
                        </h1>
                        <p class="text-lg mt-2 text-gray-700 dark:text-gray-300">基於李白《長干行》的互動角色扮演游戲</p>
                        
                        <div class="flex items-center justify-center mt-3">
                            <div class="h-0.5 w-12 bg-gradient-to-r from-transparent to-primary-light opacity-70"></div>
                            <div class="mx-2 text-primary">●</div>
                            <div class="h-0.5 w-12 bg-gradient-to-l from-transparent to-primary-light opacity-70"></div>
                        </div>
                    </div>
                    
                    <!-- 詩句展示 -->
                    <div class="md:w-1/2">
                        <div class="poem-fragment p-3">
                            <p class="text-base leading-relaxed">妾髮初覆額，折花門前劇。郎騎竹馬來，繞床弄青梅。<br>同居長干里，兩小無嫌猜。</p>
                        </div>
                        <div class="text-center text-xs text-gray-600 dark:text-gray-400 italic">
                            — 節選自李白《長干行》
                        </div>
                    </div>
                </div>
                
                <!-- 角色選擇區域 -->
                <h2 class="text-xl md:text-2xl font-bold mb-2 title-font">選擇你的角色</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-4">從兩個視角體驗唐代生活與情感</p>
                
                <div class="grid md:grid-cols-2 gap-4 max-w-4xl mx-auto mb-6">
                    <!-- 角色卡片 - 長干少婦 (精簡版) -->
                    <div id="wife-card" class="character-card p-4">
                        <div class="flex items-center border-b border-rose-200 dark:border-rose-900/50 pb-2 mb-2">
                            <h3 class="text-lg font-bold title-font text-rose-700 dark:text-rose-400">長干少婦</h3>
                            <div class="h-1 w-8 bg-gradient-to-r from-rose-400 to-rose-300 rounded-full ml-auto"></div>
                        </div>
                        
                        <p class="text-sm mb-2">在長干里等待丈夫歸來，經營家庭生活，細數光陰之逝。</p>
                        
                        <div class="bg-gradient-to-r from-rose-50/80 to-transparent dark:from-rose-900/20 dark:to-transparent p-2 rounded-lg">
                            <div class="flex items-center mb-1">
                                <h4 class="text-xs font-medium text-rose-700 dark:text-rose-400">遊戲要素：</h4>
                            </div>
                            <ul class="text-left text-xs space-y-1 pl-4 list-disc">
                                <li>管理家庭資源與日常生活</li>
                                <li>撰寫詩信傳達思念之情</li>
                                <li>應對季節變化與生活挑戰</li>
                            </ul>
                        </div>
                        
                        <div class="mt-2 pt-2 border-t border-rose-200/30 dark:border-rose-900/30 text-xs text-center text-rose-700 dark:text-rose-400 italic">
                            「十六君遠行，瞿塘灩澦堆...」
                        </div>
                    </div>
                    
                    <!-- 角色卡片 - 三巴商人 (精簡版) -->
                    <div id="husband-card" class="character-card p-4">
                        <div class="flex items-center border-b border-blue-200 dark:border-blue-900/50 pb-2 mb-2">
                            <h3 class="text-lg font-bold title-font text-blue-700 dark:text-blue-400">三巴商人</h3>
                            <div class="h-1 w-8 bg-gradient-to-r from-blue-400 to-blue-300 rounded-full ml-auto"></div>
                        </div>
                        
                        <p class="text-sm mb-2">航行於長江，往返三巴地區經商，為家庭謀取財富，思念遠方家人。</p>
                        
                        <div class="bg-gradient-to-r from-blue-50/80 to-transparent dark:from-blue-900/20 dark:to-transparent p-2 rounded-lg">
                            <div class="flex items-center mb-1">
                                <h4 class="text-xs font-medium text-blue-700 dark:text-blue-400">遊戲要素：</h4>
                            </div>
                            <ul class="text-left text-xs space-y-1 pl-4 list-disc">
                                <li>駕駛商船躲避險灘與風浪</li>
                                <li>在各地區交易物資增加財富</li>
                                <li>平衡商旅與思念家人的情感</li>
                            </ul>
                        </div>
                        
                        <div class="mt-2 pt-2 border-t border-blue-200/30 dark:border-blue-900/30 text-xs text-center text-blue-700 dark:text-blue-400 italic">
                            「早晚下三巴，預將書報家...」
                        </div>
                    </div>
                </div>
                
                <!-- 開始按鈕 -->
                <div>
                    <button id="start-game" class="btn btn-primary text-base px-8 py-3 rounded-xl mx-auto" disabled="">
                        <span>開始游戲</span>
                    </button>
                    <p id="select-prompt" class="mt-3 text-xs text-gray-500 dark:text-gray-400">請選擇一個角色以開始游戲</p>
                </div>
            </div>
        </div>
        
        <!-- 游戲主畫面 -->
        <div id="game-screen" class="hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- 左側信息面板 -->
                <div class="md:col-span-1">
                    <!-- 角色與情感面板 -->
                    <div class="paper-bg p-5 mb-4">
                        <div id="player-info" class="mb-4">
                            <h2 id="player-name" class="text-xl font-bold mb-1 title-font player-name"></h2>
                            <p id="player-description" class="text-sm mb-4 text-gray-600 dark:text-gray-400 character-desc"></p>
                            
                            <div id="emotion-meter" class="mb-1">
                                <h3 class="text-sm font-bold mb-2 flex items-center">
                                    <span class="mr-2">❤</span>情感羈絆
                                </h3>
                                <div class="relative h-5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div id="emotion-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-pink-500 to-rose-500 rounded-full transition-all duration-500" style="width: 50%"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1 text-gray-500 dark:text-gray-400">
                                    <span>疏離</span>
                                    <span>思念</span>
                                    <span>深愛</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 季節顯示 -->
                        <div id="season-display" class="relative">
                            <div class="flex items-center justify-between mb-2">
                                <h3 id="year-display" class="text-sm font-bold"></h3>
                                <div id="year-progress" class="flex items-center">
                                    <!-- 將動態生成年度進度點 -->
                                </div>
                            </div>
                            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded-full relative">
                                <div id="season-progress" class="h-3 bg-gradient-to-r from-indigo-400 to-indigo-600 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-1 text-gray-500 dark:text-gray-400">
                                <span id="season-text" class="font-medium">春 • 二月</span>
                                <div class="flex items-center">
                                    <span id="age-display" class="mr-2">16歲</span>
                                    <span id="round-text">1/36</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 資源面板 -->
                    <div class="paper-bg p-5 mb-4">
                        <h3 class="text-sm font-bold mb-3 flex items-center">
                            <span class="mr-2">🧰</span>資源
                        </h3>
                        <div id="resources-list" class="space-y-1">
                            <!-- 動態填充 -->
                        </div>
                    </div>
                    
                    <!-- 詩句收集面板 -->
                    <div class="paper-bg p-5">
                        <h3 class="text-sm font-bold mb-3 flex items-center">
                            <span class="mr-2">📜</span>已收集詩句
                            <span class="ml-auto text-xs font-normal text-gray-500 dark:text-gray-400"><span id="poems-count">0</span>/15</span>
                        </h3>
                        <div id="poem-fragments" class="text-sm">
                            <!-- 動態填充 -->
                        </div>
                    </div>
                </div>
                
                <!-- 中央游戲區域 -->
                <div class="md:col-span-2">
                    <!-- 游戲場景 -->
                    <div class="mb-2">
                        <div id="game-scene" class="scene-bg scene-spring">
                            <!-- 動態生成場景元素和事件 -->
                        </div>
                    </div>
                    
                    <!-- 動作區域 -->
                    <div class="paper-bg p-4 mb-4">
                        <h3 class="text-base font-bold mb-3 flex items-center title-font justify-between">
                            <span class="flex items-center"><span class="mr-2">⚡</span>可執行動作</span>
                            <div class="flex items-center justify-end gap-4 text-xs">
                                <div class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full mr-1" style="background: linear-gradient(145deg, #2A6547 0%, #1A4733 100%)"></span>
                                    <span>務實行動</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="inline-block w-3 h-3 rounded-full mr-1" style="background: linear-gradient(145deg, #7D4E57 0%, #5A3940 100%)"></span>
                                    <span>詩意行動</span>
                                </div>
                            </div>
                        </h3>
                        <div id="action-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                            <!-- 動態填充 -->
                        </div>
                    </div>
                    
                    <!-- 消息日誌 -->
                    <div class="paper-bg p-4 relative">
                        <h3 class="text-sm font-bold mb-2 flex items-center">
                            <span class="mr-2">📝</span>事件記錄
                        </h3>
                        <div id="messages" class="space-y-2 overflow-y-auto message-scrollable">
                            <!-- 動態填充 -->
                        </div>
                        <button id="view-history" title="查看完整歷史記錄" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-8 h-8 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 事件選擇模態窗 -->
        <div id="event-modal" class="modal-container">
            <div class="modal-content">
                <!-- 關閉按鈕 -->
                <button id="close-event-modal" class="absolute right-4 top-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <!-- 事件圖標和標題 -->
                <div class="event-header mb-5">
                    <div class="event-icon-wrapper">
                        <div id="event-icon" class="event-icon">📜</div>
                    </div>
                    <h2 id="event-title" class="text-xl font-bold title-font mb-2"></h2>
                </div>
                
                <!-- 事件描述 -->
                <div class="mb-5 pb-4 border-b border-gray-200 dark:border-gray-700">
                    <p id="event-description" class="text-gray-900 dark:text-gray-100 font-medium"></p>
                </div>
                
                <!-- 選項區域 -->
                <div id="choices-container">
                    <h3 class="text-md font-medium mb-3 title-font">你的選擇：</h3>
                    <div id="event-options" class="mb-5 grid grid-cols-1 gap-4">
                        <!-- 動態生成選項 -->
                    </div>
                </div>
                
                <!-- 詩句解釋 -->
                <div id="event-note" class="hidden bg-amber-50/30 dark:bg-amber-900/20 p-5 rounded-xl">
                    <!-- 詩句解釋 -->
                </div>
            </div>
        </div>
        
        <!-- 結束畫面 -->
        <div id="end-screen" class="modal-container">
            <div class="modal-content max-w-3xl">
                <!-- 標題區域 -->
                <div class="mb-6">
                    <h2 id="end-title" class="text-3xl font-bold mb-3 text-center title-font"></h2>
                    <div class="w-24 h-0.5 mx-auto bg-gradient-to-r from-transparent via-primary to-transparent opacity-60"></div>
                </div>
                
                <!-- 結局描述 -->
                <div class="mb-6">
                    <p id="end-description" class="mb-4 text-left leading-relaxed text-lg"></p>
                </div>
                
                <!-- 詩句展示區 -->
                <div class="mb-6 bg-amber-50/50 dark:bg-amber-900/20 p-5 rounded-xl">
                    <h3 class="text-lg font-bold mb-3 title-font flex items-center">
                        <span class="mr-2">📜</span>《長干行》詩句
                    </h3>
                    <div id="all-poems" class="text-center leading-relaxed"></div>
                </div>
                
                <!-- 結果摘要 -->
                <div class="mb-6 bg-violet-50/50 dark:bg-violet-900/20 p-4 rounded-lg text-center">
                    <div id="ending-stats" class="flex justify-center space-x-8">
                        <div class="ending-stat">
                            <div class="stat-value" id="poems-collected">0/15</div>
                            <div class="stat-label">詩句</div>
                        </div>
                        <div class="ending-stat">
                            <div class="stat-value" id="emotion-final">0%</div>
                            <div class="stat-label">情感</div>
                        </div>
                    </div>
                </div>
                
                <!-- 按鈕區域 -->
                <div class="flex justify-center space-x-4">
                    <button id="restart-game" class="btn btn-primary flex items-center">
                        <span class="mr-2">🔄</span>
                        <span>重新開始</span>
                    </button>
                    <button id="switch-character" class="btn btn-secondary flex items-center">
                        <span class="mr-2">👤</span>
                        <span>切換角色</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 教學提示 -->
        <div id="tutorial" class="tutorial-container hidden">
            <h3 class="text-lg font-bold mb-2 title-font">游戲指南</h3>
            <p id="tutorial-text" class="text-base mb-3"></p>
            <div class="flex justify-end">
                <button id="tutorial-next" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg text-sm hover:from-indigo-600 hover:to-indigo-700 transition-all">下一步</button>
            </div>
        </div>
        
        <!-- 歷史記錄模態窗 -->
        <div id="history-modal" class="modal-container">
            <div class="modal-content max-w-2xl">
                <!-- 關閉按鈕 -->
                <button id="close-history-modal" class="absolute right-4 top-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <h2 class="text-xl font-bold mb-4 title-font">事件歷史記錄</h2>
                
                <div id="history-messages" class="max-h-[60vh] overflow-y-auto space-y-3 mb-4">
                    <!-- 動態填充 -->
                </div>
                
                <button id="close-history" class="btn btn-secondary w-full">關閉</button>
            </div>
        </div>
    </div>
    
    <script>
        // 檢測暗色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // 通知系統類
        class NotificationSystem {
            constructor() {
                this.container = document.querySelector('.notification-container');
                this.notifications = [];
                this.counter = 0;
            }
            
            // 顯示通知
            show(title, message, type = 'default', duration = 5000) {
                // 創建一個唯一ID
                const id = `notification-${this.counter++}`;
                
                // 創建通知元素
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = id;
                
                // 選擇圖標
                let icon = '📢';
                if (type === 'poem') icon = '📜';
                if (type === 'ending') icon = '🏆';
                if (type === 'hint') icon = '💡';
                
                // 添加內容
                notification.innerHTML = `
                    <div class="notification-icon">${icon}</div>
                    <div class="notification-close">✕</div>
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                    <div class="notification-progress"></div>
                `;
                
                // 添加到容器
                this.container.appendChild(notification);
                
                // 存儲通知
                this.notifications.push({
                    id,
                    element: notification,
                    timer: null
                });
                
                // 動畫顯示
                setTimeout(() => {
                    notification.classList.add('show');
                    
                    // 設置進度條動畫
                    const progress = notification.querySelector('.notification-progress');
                    progress.style.animation = `progress ${duration/1000}s linear forwards`;
                    progress.style.transformOrigin = 'left';
                    progress.style.transform = 'scaleX(1)';
                    
                    // 關閉按鈕事件
                    const closeBtn = notification.querySelector('.notification-close');
                    closeBtn.addEventListener('click', () => {
                        this.close(id);
                    });
                    
                    // 自動關閉計時器
                    const timer = setTimeout(() => {
                        this.close(id);
                    }, duration);
                    
                    // 更新計時器
                    const notif = this.notifications.find(n => n.id === id);
                    if (notif) {
                        notif.timer = timer;
                    }
                }, 100);
                
                return id;
            }
            
            // 關閉通知
            close(id) {
                const index = this.notifications.findIndex(n => n.id === id);
                if (index !== -1) {
                    const notification = this.notifications[index];
                    
                    // 清除計時器
                    if (notification.timer) {
                        clearTimeout(notification.timer);
                    }
                    
                    // 動畫隱藏
                    notification.element.classList.add('hide');
                    notification.element.classList.remove('show');
                    
                    // 移除元素
                    setTimeout(() => {
                        if (notification.element.parentNode) {
                            notification.element.parentNode.removeChild(notification.element);
                        }
                        
                        // 從數組中移除
                        this.notifications.splice(index, 1);
                    }, 500);
                }
            }
            
            // 清除所有通知
            clearAll() {
                [...this.notifications].forEach(notification => {
                    this.close(notification.id);
                });
            }
        }
        
        // 游戲狀態
        let gameState = {
            characterType: "",
            character: null,
            resources: {},
            emotion: 50,
            collectedPoems: [],
            currentSeason: 0, // 0-春，1-夏，2-秋，3-冬
            round: 1,
            maxRound: 36, // 總回合數設為36回合（三年）
            events: [],
            messages: [],
            lastAction: "",
            
            // 唐朝開元年間（723-725年）
            currentYear: 723, // 開元十一年
            startYear: 723,
            currentMonth: 2, // 從二月開始（農曆）
            currentDay: 15, // 假設從望日（十五）開始
            wifeAge: 16,
            husbandAge: 17,
            
            // 年份進度（1-3年）
            yearProgress: 1,
            
            // 日記記錄
            journalEntries: [],
            
            // 事件歷史記錄
            eventHistory: {
                recentEvents: [],
                eventCounts: {},
                lastRoundEvents: []
            },
            
            // 獲取年號顯示
            getYearDisplay: function() {
                const yearNum = this.currentYear - 712;
                return `開元${convertToChinese(yearNum)}年`;
            }
        };

        const gameData = {
            // 角色數據
            characters: {
                wife: {
                    name: "長干少婦",
                    description: "在長干里的家中等待丈夫歸來，持家理政，寄情於詩。",
                    startResources: {
                        rice: 60,  // 糧食 - 基本生存資源
                        silk: 35,  // 絲綢 - 可以出售換取銀兩
                        silver: 30, // 銀兩 - 通用交換資源

                    },
                    actions: [
                        // 基礎應急行動 - 無論資源多少都能執行
                        {
                            id: "coarse-meal",
                            name: "粗食度日",
                            desc: "食用粗糧野菜充飢",
                            icon: "🌿",
                            type: "practical",
                            effect: { resources: { rice: 8 }, emotion: -5 },
                            resourceDesc: { produce: ["米糧 8"] },
                            emergency: true,
                            description: "無糧之時，以粗食野菜度日，雖不甚美味，卻可暫且充飢。每日咀嚼粗糙之食，心中愁緒漸增。"
                        },
                        
                        // 務實動作（4種）- 主要獲取物質資源
                        { 
                            id: "manage-home", 
                            name: "持家理務", 
                            desc: "整理家居，打理內務", 
                            icon: "🧹", 
                            type: "practical", 
                            effect: { resources: { rice: -3, silk: 10 }, emotion: 3, eventChance: 5 },
                            resourceDesc: { consume: ["米糧 3"], produce: ["絲綢 10"] },
                            description: "晨起理家，灑掃庭除，備膳烹飪，縫補衣物，纖手蒸蒸不得休。雖勞碌一日，家中井然有序，內心安定。"
                        },
                        { 
                            id: "market", 
                            name: "採買家需", 
                            desc: "至市井採購食材雜物", 
                            icon: "🛒", 
                            type: "practical", 
                            effect: { resources: { silver: -20, rice: 40 }, emotion: 2, eventChance: 6 },
                            resourceDesc: { consume: ["銀兩 20"], produce: ["米糧 40"] },
                            description: "提籃攜袖，至長干市肆選購粳米細鹽、菜蔬肉食，與鄰婦交談家常。行色匆匆間，難免聞得市井風聲。"
                        },
                        { 
                            id: "weaving", 
                            name: "機杼紡績", 
                            desc: "操縵機杼，精心織造絲綢", 
                            icon: "🧵", 
                            type: "practical", 
                            effect: { resources: { rice: -8, silk: 30 }, emotion: 4, eventChance: 8 },
                            resourceDesc: { consume: ["米糧 8"], produce: ["絲綢 30"] },
                            description: "日出機杼動，紡績不輟。養蠶取絲，春時良務。一針一線寄相思，青蠶吐絲結思緒。手指染上繭絲粗糙，不覺勞累。"
                        },
                        { 
                            id: "sell-textiles", 
                            name: "市集賣物", 
                            desc: "將精製絹緞賣予商賈", 
                            icon: "💰", 
                            type: "practical", 
                            effect: { resources: { silk: -25, silver: 45 }, emotion: 5, eventChance: 10 },
                            resourceDesc: { consume: ["絲綢 25"], produce: ["銀兩 45"] },
                            description: "攜精心織就的絹帛與刺繡錦緞至市集，與商賈討價還價，售予達官貴人，換取豐厚銀兩。街市行人如織，訊息往來頻繁。"
                        },
                        
                        // 詩意動作（5種）- 提高情感，獲取詩句
                        { 
                            id: "write-poem", 
                            name: "吟詩寄思", 
                            desc: "揮毫詠詩，傾吐思緒", 
                            icon: "✍️", 
                            type: "poetic", 
                            effect: { resources: { silver: -5, rice: -2 }, emotion: 18, eventChance: 25 },
                            resourceDesc: { consume: ["銀兩 5", "米糧 2"] },
                            description: "窗前明月光，獨坐案前，以詩言情，書就相思之句，寄托離愁別緒。磨墨展紙，心思遙遠，兀自凝思，不覺已是深夜。"
                        },
                        { 
                            id: "pray", 
                            name: "燒香禮佛", 
                            desc: "於佛前祈願，願君安康", 
                            icon: "🙏", 
                            type: "poetic", 
                            effect: { resources: { silver: -8, rice: -5 }, emotion: 20, eventChance: 22 },
                            resourceDesc: { consume: ["銀兩 8", "米糧 5"] },
                            description: "焚香禮佛，跪於蒲團，虔誠祈願，盼丈夫平安歸來，早日夫妻團圓。燒香成本雖高，但求得片刻心靈寧靜，誠為無價。"
                        },
                        { 
                            id: "garden-poetry", 
                            name: "折花門前", 
                            desc: "如詩中「折花門前劇」", 
                            icon: "🌸", 
                            type: "poetic", 
                            effect: { resources: { rice: -5, silver: -2 }, emotion: 16, eventChance: 28 },
                            resourceDesc: { consume: ["米糧 5", "銀兩 2"] },
                            description: "庭前折花，手觸花瓣，思致悠然，回憶童年與郎君青梅竹馬之時光。整日沉浸於昔日追憶中，家務雖停滯，心緒卻澄澈如水。"
                        },
                        { 
                            id: "moon-gazing", 
                            name: "月下憶君", 
                            desc: "仰望明月，寄情千里", 
                            icon: "🌙", 
                            type: "poetic", 
                            effect: { resources: { rice: -3 }, emotion: 22, eventChance: 30 },
                            resourceDesc: { consume: ["米糧 3"] },
                            description: "憑闌獨立，仰望圓月，遙想遠方丈夫是否也在此刻觀月思鄉，明月千里，共照相思。明月之下，徹夜難眠，次日精神恍惚。"
                        },
                        { 
                            id: "mirror-gazing", 
                            name: "梳妝自憐", 
                            desc: "對鏡梳妝，自憐紅顏", 
                            icon: "🪞", 
                            type: "poetic", 
                            effect: { resources: { silver: -6, silk: -3 }, emotion: 15, eventChance: 22 },
                            resourceDesc: { consume: ["銀兩 6", "絲綢 3"] },
                            description: "對鏡理鬢，撫觸青絲，感歎「坐愁紅顏老」，不禁潸然淚下，思念遠方良人。消耗上等脂粉，及精美絲巾，唯為盼君歸日容顏依舊。"
                        }
                    ]
                },
                husband: {
                    name: "三巴商人",
                    description: "航行於長江，往返三巴地區經商，思念家中妻子。",
                    startResources: {
                        goods: 50,  // 貨物 - 主要交易資源
                        silver: 67, // 銀兩 - 通用交換資源
                        food: 45,   // 口糧 - 基本生存資源
                    },
                    actions: [
                        // 基礎應急行動 - 無論資源多少都能執行
                        {
                            id: "fishing",
                            name: "江邊垂釣",
                            desc: "垂釣江魚充饑",
                            icon: "🐟",
                            type: "practical",
                            effect: { resources: { food: 10 }, emotion: -5 },
                            resourceDesc: { produce: ["口糧 10"] },
                            emergency: true,
                            description: "山窮水盡之際，於江畔垂釣捕魚，充饑果腹。天寒日暮，魚兒難尋，時有所獲但收穫甚微，身心俱疲。"
                        },
                        
                        // 務實動作（4種）- 主要獲取物質資源
                        { 
                            id: "navigate", 
                            name: "掌舵撐篙", 
                            desc: "駕舟避險，順流而行", 
                            icon: "⛵", 
                            type: "practical", 
                            effect: { resources: { food: -8, goods: 10 }, emotion: 2, eventChance: 5 },
                            resourceDesc: { consume: ["口糧 8"], produce: ["貨物 10"] },
                            description: "長江水道險象叢生，謹慎掌舵，避開灩澦險灘，尋找安全水路，順流抵達商埠。長日疲勞，但眼見貨物安全，亦有一絲慰藉。"
                        },
                        { 
                            id: "trade", 
                            name: "三巴交易", 
                            desc: "於巴郡市集交易貨物", 
                            icon: "💰", 
                            type: "practical", 
                            effect: { resources: { goods: -30, silver: 60 }, emotion: 3, eventChance: 8 },
                            resourceDesc: { consume: ["貨物 30"], produce: ["銀兩 60"] },
                            description: "於三巴市肆擺攤叫賣，周旋於討價還價之間，將帶來的貨物換成銀兩。商旅之道險象環生，一晝一夜不得合眼，方換得此番厚利。"
                        },
                        { 
                            id: "scout-waters", 
                            name: "探尋水脈", 
                            desc: "勘察前路水情", 
                            icon: "🔭", 
                            type: "practical", 
                            effect: { resources: { food: -6, silver: -5, goods: 12 }, emotion: 4, eventChance: 15 },
                            resourceDesc: { consume: ["口糧 6", "銀兩 5"], produce: ["貨物 12"] },
                            description: "登高眺望前路水勢，詢問過往船家水情，繪制水路圖，避開風險險灘，安全前行。費時費力，但探知安全水道，乃商旅首要。"
                        },
                        { 
                            id: "purchase-supplies", 
                            name: "採購物資", 
                            desc: "購買航行所需物資和貨物", 
                            icon: "🛒", 
                            type: "practical", 
                            effect: { resources: { silver: -30, food: 25, goods: 25 }, emotion: 3, eventChance: 5 },
                            resourceDesc: { consume: ["銀兩 30"], produce: ["口糧 25", "貨物 25"] },
                            description: "在集市採購乾糧、醃菜、米面等耐存食物，並尋訪各地名特產物，巴蜀絲綢、荊楚竹器、吳地錦緞，以作商貿之需。貨比三家，精挑細選，耗時費力但收穫頗豐。"
                        },
                        
                        // 詩意動作（5種）- 提高情感，獲取詩句
                        { 
                            id: "write-letter", 
                            name: "寄書報家", 
                            desc: "如詩中「預將書報家」", 
                            icon: "📝", 
                            type: "poetic", 
                            effect: { resources: { silver: -6, food: -2 }, emotion: 18, eventChance: 28 },
                            resourceDesc: { consume: ["銀兩 6", "口糧 2"] },
                            description: "「早晚下三巴，預將書報家」，執筆寫信，告知歸期與近況，寄托思念之情。整夜挑燈，一筆一劃皆是相思淚，直至天明方寫罷，尋適宜商旅捎回。"
                        },
                        { 
                            id: "rest", 
                            name: "客舍思鄉", 
                            desc: "夜宿客棧，思念家鄉", 
                            icon: "🛌", 
                            type: "poetic", 
                            effect: { resources: { food: -6, silver: -5 }, emotion: 15, eventChance: 20 },
                            resourceDesc: { consume: ["口糧 6", "銀兩 5"] },
                            description: "夜臥客舍，床榻冰冷，聽雨聲滴滴答答，思念溫暖家鄉，魂夢縈繞長干舊宅。臥聽更聲輾轉，不知今夕何夕，但明日又是勞累一日。"
                        },
                        { 
                            id: "listen-music", 
                            name: "聽曲思鄉", 
                            desc: "茶肆酒樓，聽曲思鄉", 
                            icon: "🎵", 
                            type: "poetic", 
                            effect: { resources: { silver: -12, food: -3 }, emotion: 16, eventChance: 22 },
                            resourceDesc: { consume: ["銀兩 12", "口糧 3"] },
                            description: "酒樓茶肆聽伎樂歌舞，鄉音鄉曲引動思鄉淚，執盞遙祝家中紅顏安好。醉眠一醒，銀錢消耗頗多，但心靈得到片刻安慰，亦是值得。"
                        },
                        { 
                            id: "prepare-gifts", 
                            name: "備置歸禮", 
                            desc: "精選珍品作為歸家之禮", 
                            icon: "🎁", 
                            type: "poetic", 
                            effect: { resources: { silver: -28, goods: -8 }, emotion: 20, eventChance: 25 },
                            resourceDesc: { consume: ["銀兩 28", "貨物 8"] },
                            description: "精挑細選異域珍奇之物，閃爍髮簪、精美羅裙，作為歸家之後送妻子的禮物。耗費甚巨，但想到她收到禮物時驚喜的神情，一切皆值得。"
                        },
                        { 
                            id: "river-gazing", 
                            name: "江畔憑欄", 
                            desc: "江畔憑欄，觀山川流水", 
                            icon: "🏞️", 
                            type: "poetic", 
                            effect: { resources: { food: -4 }, emotion: 18, eventChance: 30 },
                            resourceDesc: { consume: ["口糧 4"] },
                            description: "船舟停泊，憑欄眺望遠山疊翠，江水滔滔，思緒如水流逝，思念如山凝重。一日漫長注望，不為謀利只為慰藉心靈，讓思念有寄託之所。"
                        }
                    ]
                }
            },
            
            // 詩句片段
            poemFragments: [
                { id: "p1", text: "妾髮初覆額，折花門前劇。", note: "描述少女時的天真無邪，頭髮剛好覆蓋額頭，在家門前折花玩耍。" },
                { id: "p2", text: "郎騎竹馬來，繞床弄青梅。", note: "「青梅竹馬」成語的來源，描述兩小無猜的童年玩伴。" },
                { id: "p3", text: "同居長干里，兩小無嫌猜。", note: "「兩小無嫌猜」成語的來源，描述純真的童年情誼。" },
                { id: "p4", text: "十四為君婦，羞顏未嘗開。", note: "描述少女十四歲嫁為人婦時的羞澀。" },
                { id: "p5", text: "低頭向暗壁，千喚不一回。", note: "初為人婦時的害羞，面對丈夫的呼喚也不敢回應。" },
                { id: "p6", text: "十五始展眉，願同塵與灰。", note: "表達婚後逐漸適應，願與丈夫共度一生的心願。" },
                { id: "p7", text: "常存抱柱信，豈上望夫台。", note: "表達對感情的忠貞，「抱柱信」出自莊子盜跖篇，形容對愛情的堅貞。" },
                { id: "p8", text: "十六君遠行，瞿塘灩澦堆。", note: "描述丈夫外出經商時所要經過的危險水域——瞿塘峽的灩澦堆。" },
                { id: "p9", text: "五月不可觸，猿聲天上哀。", note: "五月水漲，行船危險，猿猴哀鳴聲傳到天上，形容擔憂與思念。" },
                { id: "p10", text: "門前遲行跡，一一生綠苔。", note: "形容時間流逝，門前曾走過的足跡都長滿了青苔。" },
                { id: "p11", text: "苔深不能掃，落葉秋風早。", note: "青苔太深難以清掃，秋風吹落樹葉，暗示光陰流逝。" },
                { id: "p12", text: "八月蝴蝶來，雙飛西園草。", note: "秋天蝴蝶雙雙飛舞，對比自己的孤獨。" },
                { id: "p13", text: "感此傷妾心，坐愁紅顏老。", note: "觸景生情，擔憂青春流逝，丈夫尚未歸來。" },
                { id: "p14", text: "早晚下三巴，預將書報家。", note: "希望丈夫從三巴（今四川一帶）返回時提前告知。" },
                { id: "p15", text: "相迎不道遠，直至長風沙。", note: "表達願意不辭辛勞前往遠處迎接丈夫歸來的心意。" }
            ],
            
            // 文化知識點
            culturalNotes: [
                "《長干行》是樂府古題，源自長江下游一帶民歌，內容多描寫船家生活。",
                "長干，是古地名，在建康（今南京）南方五里處，是商人聚集的地方。",
                "「青梅竹馬」成語源自本詩「郎騎竹馬來，繞床弄青梅」，形容兒時玩伴。",
                "「兩小無猜」成語源自本詩「同居長干里，兩小無嫌猜」，形容純真友誼。",
                "古代女子十四、十五歲嫁人是常見現象，符合「女子十四而笄」的傳統。",
                "三巴指巴東、巴西、巴郡，在今四川一帶，是古代重要的商貿地區。",
                "瞿塘峽是長江三峽之一，有著名的灩澦堆險灘，是古代商船的危險區域。",
                "望夫台是中國各地常見的地名，傳說是古代婦女盼望丈夫歸來時登高遠望之處。",
                "「抱柱信」典故出自《莊子·盜跖》，講述尾生與女子相約於橋下，洪水來臨仍不離去，抱橋柱而死的故事。",
                "古代女性的服飾與社會地位息息相關，嫁作人婦後服飾會有顯著變化。",
                "唐朝開元年間(713-741)是中國古代最繁榮的時期之一，商業貿易極為發達。",
                "長江為古代主要水上交通要道，商船沿江而上，運送貨物到達各大城市。",
                "古代商人地位雖不及士農工，但富有的商人往往能獲得較高的社會認可。",
                "唐代婦女比起其他朝代有更多社交自由，可參與各種文化活動。"
            ],
            
            // 季節相關
            seasons: ["春", "夏", "秋", "冬"],
            
            // 事件數據
            events: [
                // 核心詩句事件 - 與《長干行》詩句直接相關的事件
                {
                    id: "wife-hair-first-cover-forehead",
                    title: "青絲初覆額",
                    description: "梳洗時，你凝視鏡中的容顏。青絲及肩，恰好覆蓋額頭。忽然回想起少女時光，那時髮尚短，額頭尚露，無憂無慮地在門前嬉戲。如今已為人婦，容顏雖未改，心境卻已然不同。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 1, // 明確限制為第一年
                    choices: [
                        { 
                            text: "輕撫髮際，思及兒時戲樂", 
                            effect: {
                                emotion: 10,
                                poemFragment: "p1",
                                message: "「妾髮初覆額，折花門前劇」—你撫摸著及肩的青絲，想起童年時摘花嬉戲的日子，那時頭髮還短，額頭還露，無憂無慮。"
                            }
                        },
                        { 
                            text: "執梳凝思，髮隨心動憶往昔", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 6,
                                message: "輕執象牙梳，一縷一縷梳理青絲。發絲柔滑如昔，而心早已不同。每一下梳理，都似在撫平時光留下的痕跡，卻撫不平心中的思念。"
                            }
                        },
                        { 
                            text: "撫鏡長嘆，青絲依舊人漸老", 
                            effect: {
                                emotion: 8,
                                message: "凝視鏡中青絲，與當年無異，卻已不再是當年的自己。指尖觸碰髮絲，思緒縈繞心頭。年華似水流逝，唯有思念永恆。"
                            }
                        }
                    ]
                },
                
                // 移除詩句事件 - 妻子角色
                {
                    id: "sort_old_belongings",
                    title: "整理舊物",
                    description: "翻找舊物時，你發現一疊積滿灰塵的家書和詩箋。這些紙上的字跡已經模糊，勾起了許多往日回憶。你猶豫著該如何處理這些物品。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 2, // 第二年才出現，增加詩句移除的策略性
                    choices: [
                        { 
                            text: "珍藏保留，封存記憶", 
                            effect: {
                                emotion: 5,
                                message: "你小心地將這些信箋整理好，放入木匣珍藏。這些都是思念的見證，捨不得丟棄。"
                            }
                        },
                        { 
                            text: "焚燒書信，放下過往", 
                            effect: {
                                removePoemFragment: 1, // 隨機移除1首詩句
                                resources: { silver: 10, rice: 5 }, // 增加其他資源作為補償
                                emotion: -5,
                                message: "你將那些舊書信點燃，看著火焰吞噬紙張。隨著煙霧消散，心中的一些牽掛似乎也淡去了。雖然失去了寶貴的記憶，但也騰出了空間和精力專注當下。"
                            }
                        },
                        { 
                            text: "贈予鄰里，傳承故事", 
                            effect: {
                                resources: { silver: 15 },
                                message: "你將一些不太私密的詩箋贈予好友，分享你的故事。他們聽得入神，還為你帶來了一些生活所需。"
                            }
                        }
                    ]
                },
                {
                    id: "flood_damage",
                    title: "水患侵襲",
                    description: "連日暴雨，長干里不幸遭受水患。幸好人無恙，但家中物品多有損傷，包括那些珍藏的書信詩箋。",
                    forCharacter: "wife",
                    season: [1], // 夏季，雨水多
                    year: 2, // 第二年
                    choices: [
                        { 
                            text: "盡力搶救每一份書信", 
                            effect: {
                                resources: { rice: -10, silver: -5 }, // 消耗資源
                                emotion: 8,
                                message: "你廢寢忘食地晾曬每一張濕透的紙片，用盡各種方法修復受損的字跡。雖然耗費了不少資源，但保住了這些寶貴的記憶。"
                            }
                        },
                        { 
                            text: "取捨保留，割捨受損嚴重的物品", 
                            effect: {
                                removePoemFragment: 2, // 移除2首詩句
                                resources: { silk: 15 }, // 大幅增加絲綢資源
                                message: "你忍痛割捨了那些已經損壞嚴重的書信。藉著整理家園的機會，你將精力放在織造上，為未來做準備。那些逝去的記憶，或許只能留在心中了。"
                            }
                        }
                    ]
                },
                
                // 移除詩句事件 - 丈夫角色
                {
                    id: "merchant_robbery",
                    title: "商旅劫難",
                    description: "行經峽谷險段，一群山賊突然攔路打劫。船上貨物與隨身物品恐難保全。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 2, // 第二年
                    choices: [
                        { 
                            text: "誓死保衛家書與詩作", 
                            effect: {
                                resources: { goods: -20, silver: -15 }, // 大量損失貨物和銀兩
                                emotion: 12,
                                message: "你寧可丟棄貨物，也要保住那些承載著情感的詩箋家書。山賊劫走了大量貨物，但那些無價的情感記憶得以保全。"
                            }
                        },
                        { 
                            text: "割捨情物，保住貨財", 
                            effect: {
                                removePoemFragment: "p7", // 特定移除抱柱信詩句
                                resources: { goods: 15, silver: 25 }, // 獲得更多資源
                                emotion: -10,
                                message: "你忍痛將那些詩箋交出，以此換取貨物安全。山賊翻看那些紙片片刻，便隨手丟棄於山澗。看著那些寄託情感的文字隨風散去，你心如刀割，卻也明白這是生存所需的取捨。"
                            }
                        },
                        { 
                            text: "智取山賊，損失最小化", 
                            effect: {
                                resources: { silver: -10, food: -5 },
                                message: "你機智周旋，以少量財物打發山賊。雖有小損，卻保全了大局。"
                            }
                        }
                    ]
                },
                {
                    id: "market_gambling",
                    title: "市集賭局",
                    description: "在三巴市集，你遇到一群商人正在進行賭局。他們邀請你參與，並表示可以用任何值錢的東西做賭注，包括珍貴的信物和詩作。",
                    forCharacter: "husband",
                    season: [0, 2], // 春、秋季節
                    year: 2, // 第二年到第三年
                    choices: [
                        { 
                            text: "拒絕賭局，保持清醒", 
                            effect: {
                                emotion: 5,
                                message: "你婉拒邀請，目睹其他商人的輸贏起伏。賭局終究是虛妄，無法替代真正的經營與情感。"
                            }
                        },
                        { 
                            text: "小賭怡情，以書信做賭注", 
                            effect: {
                                removePoemFragment: 1, // 隨機移除1首詩句
                                resources: { silver: 40 }, // 獲得大量銀兩
                                emotion: -5,
                                message: "手氣不佳，你輸掉了隨身攜帶的一封珍貴家書。看著它被勝者得意地收走，你懊悔不已。然而這次教訓也為你贏來了更謹慎的商業頭腦。"
                            }
                        },
                        { 
                            text: "孤注一擲，豪賭一場", 
                            effect: {
                                resources: { goods: -30, food: -10 },
                                emotion: -8,
                                message: "情緒激動之下，你下了重注。幸好手氣尚可，未至輸光，但這次冒險足以讓你警醒：商途險象環生，豈能貪一時之利。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-fifteen-years-old",
                    title: "十五始展眉",
                    description: "今日無事，你整理木箱時，發現嫁妝中的一方小巾。這是你十五歲那年親手繡製的，繡工尚稚嫩，但飽含心意。那年你剛適應了婚後生活，對丈夫也不再像初嫁時那般害羞。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 2, // 修改為第二年出現
                    choices: [
                        { 
                            text: "撫摸繡帕，憶起初展眉時的情愫", 
                            effect: {
                                emotion: 10,
                                poemFragment: "p6",
                                message: "「十五始展眉，願同塵與灰」—你撫摸著繡帕，想起剛過門時的羞澀，及後來與丈夫之間漸漸滋生的感情。那時你許下誓言，願與他共度一生，如同塵土與灰燼般不可分離。"
                            }
                        },
                        { 
                            text: "想起嫁後低頭不語的羞怯時光", 
                            effect: {
                                emotion: 6,
                                message: "你手持繡帕，思緒回到初嫁時光。那時你羞於面對丈夫，常常低頭不語，即使被呼喚千次也不敢回應。如今想來，這青澀的記憶讓你臉頰微熱。"
                            }
                        },
                        { 
                            text: "閉眼追憶，如見昔日青梅竹馬", 
                            effect: {
                                resources: { silk: 5 },
                                emotion: 4,
                                message: "你閉上眼睛，握著繡帕，思緒飄回更遠的童年。彼時你們還是兩小無猜的玩伴，他騎著竹馬來訪，你們嬉戲追逐，不知憂愁為何物。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-stormy-night",
                    title: "夜雨驚雷",
                    description: "連日暴雨，江水洶湧。今晚雷聲大作，你的商船停泊在一處小港灣，艱難抵擋著狂風驟雨。這般天氣，長干里的妻子想必也在擔憂你的安危。",
                    forCharacter: "husband",
                    season: [1, 2], // 夏、秋季節
                    year: 2, // 修改為第二年出現
                    relatedActions: ["navigate", "scout-waters"],
                    choices: [
                        { 
                            text: "燈下執筆，記險途艱辛與家中思念", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 12,
                                poemFragment: "p8",
                                message: "「十六君遠行，瞿塘灩澦堆」—你在船艙中燈下寫信，記錄這次經歷的驚險河段，尤其是瞿塘峽灩澦堆的危險。你不敢告訴妻子全部真相，只能輕描淡寫，免得她擔心。"
                            }
                        },
                        { 
                            text: "披蓑出船，憑欄眺望風雨中的江山", 
                            effect: {
                                resources: { food: -5 },
                                emotion: 8,
                                message: "你披蓑冒雨，立於船頭，任憑雨打風吹。面對洶湧江水與閃電交織的天地，你感受到自然的磅礴與人的渺小。這場風雨過後，你更加珍視平安與歸家的心願。"
                            }
                        },
                        { 
                            text: "聽雨撫琴，以旋律寄托心中鄉愁", 
                            effect: {
                                resources: { silver: -2 },
                                emotion: 10,
                                message: "風雨聲中，你取出隨行攜帶的小琴，彈奏一曲《思鄉引》。琴音與雨聲交織，似訴說著對家的思念。同行的商人聽罷，多是沉默落淚，各自思索家中佳人。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-waiting-at-gate",
                    title: "門前守望",
                    description: "今天是丈夫離家後的第三個月。你站在院門前，眺望遠方，盼望著他歸來的身影。門前石階的一角已經長出了些許青苔，如同你心中漸漸累積的相思之情。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 2, // 修改為第二年出現
                    choices: [
                        { 
                            text: "佇立門前，遙望遠方歸路", 
                            effect: {
                                emotion: 8,
                                message: "你在門前來回踱步，想象著丈夫歸來時的場景。不知要等多久，你才能再見到他的身影。"
                            }
                        },
                        { 
                            text: "心中默念信念，堅守等待之心", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p7",
                                message: "「常存抱柱信，豈上望夫台」—你暗自下定決心，無論等待多久，你都會堅守這份感情，不離不棄。你不願如尾生抱柱等待，卻願意懷抱堅貞之心，靜候丈夫歸來，不去登那訴說離別傷感的望夫台。"
                            }
                        },
                        { 
                            text: "遙望高處山峰，思量遠方之人", 
                            effect: {
                                emotion: 6,
                                message: "你的目光投向遠方的山峰，想像著丈夫也許正翻山越嶺，行走在歸途之上。高山流水，千里相隔，唯有思念無法阻擋。"
                            }
                        }
                    ]
                },

                // 四季特殊事件 - 第一年
                {
                    id: "wife-spring-planting",
                    title: "春種幽蘭",
                    description: "院中初暖，花木冒出新芽。你在角落一處閒地挖出一小塊園圃，計劃種些花草。鄰家老嫗贈你幾株幽蘭，說道:「此花暗香疏影，最能象徵思念之情，適合婦人栽種。」",
                    forCharacter: "wife",
                    season: [0], // 春季
                    year: 1, // 僅第一年
                    choices: [
                        { 
                            text: "種下幽蘭，題詩寄情", 
                            effect: {
                                resources: { rice: -3 },
                                emotion: 10,
                                message: "你將幽蘭種在庭角，日日澆灌。每當清晨露重，花上晶瑩點點，宛如思念凝成的淚珠。你時常對蘭低語，仿佛在與遠方的丈夫交談。"
                            },
                            poetic: true
                        },
                        { 
                            text: "種些蔬菜，以備不時之需", 
                            effect: {
                                resources: { rice: 15, silver: -2 },
                                emotion: 3,
                                message: "你婉拒了幽蘭，改種菜蔬。每日見其生長，既充實了生活，也增添了家中糧食。實用雖不及詩情畫意，但總能溫飽渡日。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-summer-storm",
                    title: "江上風暴",
                    description: "盛夏午後，烏雲密布，一場大雨即將來臨。遠處已傳來隆隆雷聲，江面上的船隻紛紛靠岸避難。你需要迅速做出決定，是繼續航行尋找更好的停泊處，還是立即停船避難。",
                    forCharacter: "husband",
                    season: [1], // 夏季
                    year: 1, // 僅第一年
                    choices: [
                        { 
                            text: "冒險尋找更安全的港灣", 
                            effect: {
                                resources: { food: -8, goods: -5, silver: 20 },
                                emotion: -5,
                                message: "你頂著風雨前行，船身被巨浪顛簸得幾乎傾覆。幸運的是，你找到了一處僻靜港灣安全停泊，但船上一些貨物已被雨水浸濕，只得低價售出。"
                            },
                            poetic: false
                        },
                        { 
                            text: "就地停泊，望雨賦詩", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 10,
                                message: "你將船繫於岸邊柳樹，躲入船艙。窗外電閃雷鳴，暴雨敲打船板如萬馬奔騰。你在燈下寫下一首《江行雨夜》，寄托對平安的感恩與對家的思念。"
                            },
                            poetic: true
                        }
                    ]
                },
                {
                    id: "wife-autumn-weaving",
                    title: "夜織寒衣",
                    description: "秋風漸緊，夜涼如水。想到丈夫在外，不知是否有足夠冬衣，你心中焦慮。夜深人靜，你點起油燈，取出上好的布料，準備織一件厚實的冬衣，寄往三巴。",
                    forCharacter: "wife",
                    season: [2], // 秋季
                    year: 1, // 僅第一年
                    choices: [
                        { 
                            text: "月下縫紉，一線相思", 
                            effect: {
                                resources: { silk: -15, rice: -5 },
                                emotion: 15,
                                message: "你整夜不眠，一針一線皆是牽掛。月明燈暗時，你偷偷將一縷青絲縫入衣襟，願它能帶去你的溫暖與思念。天明時，衣已成，你立刻託人帶往三巴。"
                            }
                        },
                        { 
                            text: "扶窗遙望，思緒織入布料", 
                            effect: {
                                resources: { silk: -10, silver: -5 },
                                emotion: 10,
                                message: "每一針每一線，都傾注著你對遠方之人的思念。時而停下來望向窗外的月光，仿佛能看到他的身影。這件寒衣雖不及你對他的思念厚重，但願能為他擋住三巴的風寒。"
                            }
                        },
                        { 
                            text: "尋覓絲線，準備精緻暖物", 
                            effect: {
                                resources: { silver: -20 },
                                emotion: 8,
                                message: "你在市集精心挑選了品質上乘的絲線與布料，又請裁縫幫忙設計款式。雖非親手織造，但你在每一處細節上都傾注了心思，願這件寒衣能帶去你的溫暖與關懷。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-winter-inn",
                    title: "風雪客棧",
                    description: "隆冬時節，一場大雪讓你滯留在山間小鎮。客棧內，旅人們圍坐火爐，暢談見聞。你獨坐窗前，看著紛飛大雪，想起千里之外的家。此時，有位老者在為客人們講述古老的愛情故事。",
                    forCharacter: "husband",
                    season: [3], // 冬季
                    year: 1, // 僅第一年
                    choices: [
                        { 
                            text: "加入圍爐，與眾分享自己的故事", 
                            effect: {
                                resources: { silver: -5, food: -2 },
                                emotion: 12,
                                message: "你向眾人講述了與妻子青梅竹馬的情誼，以及離家經商的不易。滿座皆動容，有人拍案叫絕，有人默默落淚。這一晚，你不再感到孤獨，心中的思念卻更加濃烈。"
                            },
                            poetic: true
                        },
                        { 
                            text: "獨自飲酒，默默思念家人", 
                            effect: {
                                resources: { silver: -8 },
                                emotion: 8,
                                message: "你獨自飲酒，心中思緒萬千。借著酒意，你寫下了一首詩，雖筆拙文粗，卻盡抒胸臆。窗外雪勢漸小，你期盼來年春暖花開時，能夠踏上歸家之路。"
                            },
                            poetic: true
                        }
                    ]
                },
                
                // 年終回顧事件
                {
                    id: "year-one-summary-wife",
                    title: "開元十一年歲末",
                    description: "開元十一年已至尾聲，丈夫離家已近一年。冬雪覆蓋了長干里，萬物沉寂，唯獨思念之情愈發濃烈。歲末之際，你坐在窗前，回顧這一年的點點滴滴。",
                    forCharacter: "wife",
                    season: [3], // 冬季
                    year: 1, // 僅第一年歲末
                    isSpecial: true,
                    choices: [
                        { 
                            text: "整理一年來的家書，記錄思念", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 12,
                                message: "你將丈夫寄來的書信仔細整理，反復閱讀。透過字句，你仿佛能感受到他的思念與牽掛。你提筆寫下自己的心情，記錄這平淡卻情深的一年。"
                            },
                            poetic: true
                        },
                        { 
                            text: "製作一件新衣，期盼明年團聚", 
                            effect: {
                                resources: { silk: -10, silver: -5 },
                                emotion: 10,
                                message: "你選了上好的絲綢，精心裁剪縫製一件新衣，希望來年丈夫歸來時能夠穿上。針線穿梭間，你祈願來年能夠夫妻團聚。"
                            },
                            poetic: true
                        },
                        { 
                            text: "計算家中積蓄，規劃來年生活", 
                            effect: {
                                resources: { silver: 10 },
                                emotion: 5,
                                message: "你仔細清點了家中積蓄，規劃來年的生活開支。你發現有些少許盈餘，心中稍安。來年無論丈夫是否能歸，你都有足夠的準備面對。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "year-one-summary-husband",
                    title: "開元十一年歲末",
                    description: "開元十一年已至尾聲，你離家已近一年。在外經商，雖有所獲，但思鄉之情愈發強烈。此刻你停泊在小鎮碼頭，冬雪紛飛，不禁想起千里之外的長干里家中。",
                    forCharacter: "husband",
                    season: [3], // 冬季
                    year: 1, // 僅第一年歲末
                    isSpecial: true,
                    choices: [
                        { 
                            text: "寫一封詳盡的家書，記錄一年見聞", 
                            effect: {
                                resources: { letters: 1, silver: -3 },
                                emotion: 12,
                                message: "你花了整整一夜時間，詳細記錄下這一年的所見所聞、經商得失，以及對家人的思念。將信交予商隊帶回長干里，希望能讓妻子分享你的經歷和牽掛。"
                            },
                            poetic: true
                        },
                        { 
                            text: "尋找價值連城的珍品作為禮物", 
                            effect: {
                                resources: { silver: -30, goods: -10 },
                                emotion: 10,
                                message: "你在此地市集精心挑選了幾件珍貴物品，打算來年歸家時帶給妻子。雖然花費不菲，但想到她收到禮物時驚喜的表情，你覺得一切都值得。"
                            },
                            poetic: true
                        },
                        { 
                            text: "與同鄉商人舉杯共飲，訴說鄉愁", 
                            effect: {
                                resources: { silver: -8, food: -4 },
                                emotion: 8,
                                message: "你找到幾位同樣離家經商的同鄉，一同飲酒談心。在酒意和談笑間，鄉愁似乎沒那麼濃烈，但當夜深人靜，思念又湧上心頭。"
                            },
                            poetic: false
                        }
                    ]
                },
                // 妻子角色事件
                {
                    id: "wife-dangerous-rapids",
                    title: "險灘傳聞",
                    description: "市集上遇見一位風塵僕僕的漕船老艄公，眼神滄桑，手上皮膚粗糙龜裂。閒談間你問及三巴水路，老者神色凝重：「瞿塘峽那灩澦堆險灘，暗流湍急，礁石如刀。近來水勢兇猛，已有三艘沙船覆沉。我這身上的傷疤，就是去年在那鬼門關前走了一遭留下的。」聽聞此言，你心頭一緊，手中的籃子差點落地。",
                    forCharacter: "wife",
                    season: [1, 3], // 夏季和冬季
                    year: 2, // 第二年
                    relatedActions: ["market", "pray", "write-poem", "moon-gazing"],
                    choices: [
                        { 
                            text: "向老艄公細詢江中險情與船隻通行", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 12,
                                poemFragment: "p8",
                                message: "「十六君遠行，瞿塘灩澦堆」—你請老艄公詳述那灩澦堆的險象。他取來木碗倒水，用手攪出漩渦，展示險灘如何吞噬船隻。「船身在急流中如稻草，轉瞬便沉。」你心如刀絞，悄悄握緊衣角，想著當年十六歲的夫君離家時的年少模樣，如今在那樣兇險的水域中航行，可還好？"
                            }
                        },
                        { 
                            text: "請求老艄公代為尋訪丈夫下落", 
                            effect: {
                                resources: { silver: -15, silk: -5 },
                                emotion: 8,
                                message: "你急切地從布袋中取出一枚玉佩：「這是我夫君隨身之物，若公見到此人，請告知妻子平安，盼他早日歸來。」老艄公收下玉佩與你的厚禮，拍胸承諾：「老漢走遍長江上下，定當留意打聽。」你忐忑不安地目送他離去，不知這番託付是否有用。"
                            }
                        },
                        { 
                            text: "深夜獨坐窗前，寫下憂思詩句", 
                            effect: {
                                resources: { rice: -3 },
                                emotion: 10,
                                message: "夜闌人靜，你點燃一盞油燈，在窗前提筆寫下：「江水滔滔去，君舟何處停。峽中萬險阻，妾心憂且驚。」詩成淚落，濕了半張宣紙。一夜無眠，耳邊彷彿能聽到江水奔騰與船板吱呀的聲響。"
                            }
                        },
                        { 
                            text: "到觀音閣祈福，祝願夫君平安", 
                            effect: {
                                resources: { silver: -8 },
                                emotion: 5,
                                message: "你買來香燭紙錢，清晨時分趕到城南觀音閣。跪在蒲團上，你虔誠禱告：「慈悲觀音，保佑夫君平安渡過險灘，早日歸家。」廟祝見你誠心，贈你一枚護身符：「縴夫都說此符能保水路平安，你且收好，來日夫君歸家時贈予。」"
                            }
                        }
                    ]
                },
                {
                    id: "wife-spring-rising-water",
                    title: "暮春水候",
                    description: "暮春時節，長干碼頭熱鬧非凡。船戶們搶在五月汛期前忙著裝卸貨物，一位須發皆白的老篙工被圍在中央，講述著往年水情。「到了夏曆五月，長江水漲如牛，不少客商為趕路硬闖險灘，結果船毀人亡。最可怖的是那些猿猴，彷彿預知災禍，總在事發前嚎叫不止。」船戶們聽得心驚肉跳，紛紛表示要避開這段時間。",
                    forCharacter: "wife",
                    season: [0], // 春季
                    year: 2, // 第二年
                    relatedActions: ["market", "weaving"],
                    choices: [
                        { 
                            text: "聆聽老篙工講述猿啼與水患的關聯", 
                            effect: {
                                emotion: 10,
                                poemFragment: "p9",
                                message: "「五月不可觸，猿聲天上哀」—老篙工眼神深邃，娓娓道來：「那猿聲哀切，傳得老遠，像是從天上傳下來的警示。凡聞此聲，必有船隻遇險。」他說這些年過江遇險的商旅不計其數，而那些闖入五月險灘的，鮮有生還者。聽完故事，你心緒不寧，想著丈夫是否也會遇到這樣的險情。"
                            }
                        },
                        { 
                            text: "詢問航船時節與安全渡口資訊", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 8,
                                message: "你向船戶們打聽行船的最佳時節和安全渡口。他們告訴你，上半年以三月最為平穩，下半年則是九月。絕對要避開的是五月汛期，即使是經驗豐富的水手也不敢輕易冒險。你暗暗記下這些信息，心想若有一日丈夫回信，定要叮囑他避開險期。"
                            }
                        },
                        { 
                            text: "取暗記薄筆錄水文知識以備不時之需", 
                            effect: {
                                resources: { silk: 5 },
                                emotion: 6,
                                message: "你從懷中取出隨身攜帶的記事薄，仔細記錄下船戶們討論的各種水文知識——何時水漲，何處險灘，猿鳴預兆。這些看似無用的信息，或許有朝一日能派上用場。船戶們見你如此重視，還特意送了你一匹細絹，說是回蜀地時帶來的特產。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-butterfly",
                    title: "蝶舞秋園",
                    description: "八月初秋，西園草叢中一對蝴蝶雙雙飛舞。彼此緊依，翩然起舞，互相追逐。這和諧美好的景象與你獨自一人的身影形成鮮明對比，一種難以言說的感傷悄然而生。",
                    forCharacter: "wife",
                    season: [2], // 秋
                    year: 3, // 第三年
                    choices: [
                        { 
                            text: "靜賞雙蝶翩飛，嘆獨自無人相伴", 
                            effect: {
                                emotion: 10,
                                poemFragment: "p12",
                                message: "「八月蝴蝶來，雙飛西園草」—看著這對蝴蝶相伴而飛，你不禁想到自己與丈夫的分離。蝶兒成雙，而你卻獨自守望，這對比更讓你思念遠方的丈夫。"
                            }
                        },
                        { 
                            text: "感傷時光流逝，紅顏易老青春難留", 
                            effect: {
                                resources: { letters: 1 },
                                poemFragment: "p13",
                                message: "「感此傷妾心，坐愁紅顏老」—望著蝴蝶短暫的美麗生命，你撫摸著自己的青絲，不禁憂傷：歲月無情，容顏易老，丈夫遠行，何時團聚？年華虛度，徒留相思。"
                            }
                        },
                        { 
                            text: "遙想蝶的前世，是否曾經相識相知", 
                            effect: {
                                resources: { silk: 3 },
                                emotion: 5,
                                message: "古人云：「蝴蝶為梁祝托身」，看著這雙雙對對的蝶影，你不禁想起梁山伯與祝英台的傳說。他們生前不得相守，死後化蝶雙飛。這份堅貞的愛情，讓你不禁凝神遐想，思緒飄向遠方的丈夫。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-fidelity-fame",
                    title: "貞節名揚",
                    description: "開元十三年初，長干里已傳遍你堅守等待丈夫的故事。今日，一位路過的官員聽聞此事，特意前來拜訪。他代表縣令，欲為你立貞節牌坊，表彰你的堅貞品德。「雖夫君音訊渺茫，閣下仍堅守三年，貞烈可嘉。」",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 3, // 明確限制為第三年
                    relatedActions: ["write-poem", "pray", "garden-poetry", "moon-gazing", "mirror-gazing"],
                    choices: [
                        { 
                            text: "婉拒牌坊，表達堅信丈夫必歸", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p7",
                                message: "「常存抱柱信，豈上望夫台」—你向官員表達謝意但婉言拒絕：「妾身不過盡婦道本分，所持不過夫妻本心。妾深信夫君必歸，何須彰顯於世。」官員見你心意真誠，讚歎不已，尊重你的決定離去。"
                            }
                        },
                        { 
                            text: "謝絕官員，不願引人關注", 
                            effect: {
                                emotion: 8,
                                message: "你堅決謝絕了官員的好意：「小女子只盼夫君平安歸來，不願惹人耳目。」官員雖有些失望，但仍表示理解，並留下一些禮物以示敬意。"
                            }
                        },
                        { 
                            text: "接受表彰，為家族增光", 
                            effect: {
                                resources: { silver: 15, silk: 10 },
                                emotion: -5,
                                message: "你考慮再三，接受了官員的好意。牌坊雖彰顯了你的貞節，卻也宣告了丈夫音訊全無的事實。縣令賞賜了不少銀絹，但每當抬頭看見門前的牌坊，心中總是五味雜陳。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-childhood",
                    title: "童年回憶",
                    description: "春日院子裡，孩童嬉戲。一個小男孩騎著竹馬來回奔跑，另一個小女孩手持青梅在追逐。他們的笑聲讓你回想起自己的童年時光——那些在長干里無憂無慮的日子。",
                    forCharacter: "wife",
                    season: [0], // 春季
                    year: 1, // 明確限制為第一年
                    relatedActions: ["teach-children", "garden-poetry"],
                    choices: [
                        { 
                            text: "微笑觀望他們追逐嬉戲，回憶竹馬青梅之樂", 
                            effect: {
                                resources: { rice: -2 },
                                emotion: 8,
                                poemFragment: "p2",
                                message: "看著孩子們圍著床榻追逐，你想起昔日郎君騎著竹馬，你手持青梅，在院中玩耍的情景。「郎騎竹馬來，繞床弄青梅」，這便是你們童年的寫照。"
                            },
                            poetic: true
                        },
                        { 
                            text: "給孩子們講述長干里的風土人情", 
                            effect: {
                                emotion: 5,
                                poemFragment: "p3",
                                message: "「同居長干里，兩小無嫌猜」—你講述著與丈夫一同在長干里成長的故事，那時你們年幼無猜，如今卻天各一方。孩子們聽得入神。"
                            },
                            poetic: true
                        },
                        {
                            text: "送給他們一些糕點，讓他們安靜下來",
                            effect: {
                                resources: { rice: -5 },
                                emotion: 2,
                                message: "你將糕點分給孩子們，他們安靜地享用，不再打擾你的思緒。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "wife-wedding-memory",
                    title: "少女嫁期",
                    description: "隔壁家女兒剛滿十四歲，今日出嫁。她羞怯地低頭坐在喜轎前，臉抹胭脂卻掩不住忐忑。老嫗們在旁指點叮嚀，你站在人群外，不由想起自己當年的出嫁時光。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 1, // 第一年
                    choices: [
                        { 
                            text: "贈送絲帕，憶起當年羞顏未嘗開的心緒", 
                            effect: {
                                resources: { silver: -3, silk: -2 },
                                emotion: 5,
                                poemFragment: "p4",
                                message: "你以絲帕為禮，輕聲道：「十四為君婦，羞顏未嘗開」。這句話引起周圍婦人們的共鳴，她們紛紛點頭，回憶起自己的嫁娶時光。"
                            },
                            poetic: true
                        },
                        { 
                            text: "站在一旁，默想當年面對夫君呼喚時的忐忑", 
                            effect: {
                                emotion: 6,
                                poemFragment: "p5",
                                message: "看著少女低眉不語的模樣，你彷彿看到當年的自己，「低頭向暗壁，千喚不一回」。初為人婦時的羞澀與畏懼，如今想來已是遙遠的記憶。"
                            },
                            poetic: true
                        },
                        { 
                            text: "送上祝福與嫁妝，給予實用建議", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 2,
                                message: "你贈送了一些實用的嫁妝物品，並給予新嫁娘一些關於持家之道的建議。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "wife-awaiting-news",
                    title: "盼信苦候",
                    description: "街坊鄰居傳來消息，說有一支商隊即將從三巴返回。你心神不寧，日日盼望在城門附近等候，希望能打聽到丈夫的消息。每當看到遠方揚起的塵土，你的心就不禁加速跳動，可一次次的期待換來一次次的失望。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 2,
                    choices: [
                        { 
                            text: "守候城門，詢問歸來的商旅", 
                            effect: {
                                emotion: 8,
                                health: -3,
                                poemFragment: "p14",
                                message: "「早晚下三巴，預將書報家」—連續多日，你在城門附近等候歸來的商旅。終於，一位從三巴歸來的老者告訴你，他曾在巴郡見過你丈夫，說他生意有成，身體安好，時常提起家中的妻子，承諾早晚會歸來，並託人帶信回家。這消息如同甘霖滋潤了你乾渴的心田。"
                            }
                        },
                        { 
                            text: "托人帶口信到三巴", 
                            effect: {
                                resources: { silver: -10 },
                                message: "你找到一位即將前往三巴的可靠商人，付給他一筆銀兩，請他幫忙尋找你的丈夫並帶口信。「請告訴他，家中一切安好，妻子日日盼他平安歸來。」雖不知這消息何時能傳到，但至少你做了能做的事情。"
                            }
                        },
                        { 
                            text: "與其他商家妻子交流消息", 
                            effect: {
                                resources: { silk: 2 },
                                emotion: 5,
                                message: "你找到其他幾位同樣有丈夫在外經商的婦人，與她們一起交流各自得到的消息。彼此的分享和支持讓你感到些許慰藉。一位婦人的丈夫剛從巴郡回來，雖然沒有直接見過你的丈夫，但提到巴郡一帶商貿興盛，這讓你對丈夫的處境多了幾分安心。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-long-journey",
                    title: "千里相迎",
                    description: "市集上遇見一位自稱來自三巴的商人，他道：「似乎見過與你描述相符的人，說是生意已近尾聲，或許不久會啟程歸返。」這模糊不清的消息讓你心神不寧：若是真的，是該在家中靜候，還是冒險踏上千里之途，迎他歸來？",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: [2, 3], // 第二或第三年
                    choices: [
                        { 
                            text: "決心踏上千里之途相迎", 
                            effect: {
                                emotion: 15,
                                health: -10,
                                poemFragment: "p15",
                                message: "「相迎不道遠，直至長風沙」—你收拾簡單行囊，決定踏上這條遙遠的歸途。不論前路多麼遙遠險阻，你都不畏懼。這一路風塵僕僕，歷經風吹日曬，心中不斷自問：他是否真的啟程？我們是否能在長路上相逢？縱使只是渺茫希望，也值得這一程跋涉。"
                            }
                        },
                        { 
                            text: "在家靜候，備下相迎之宴", 
                            effect: {
                                resources: { silver: -15, silk: -3 },
                                emotion: 10,
                                message: "你決定在家中靜候，為那可能的歸期做準備。打掃庭院，縫製新衣，採買食材，一切都是為了那或許到來的重逢之日。每日黃昏，你都會佇立門前遠望，心想：今日可是歸期？明日又是希望。"
                            }
                        },
                        { 
                            text: "尋求親友陪伴守候驛站", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 8,
                                message: "你找到幾位親近的友人和家人，請他們與你一同在較近的驛站等候。雖不確定消息真假，但有了親友的陪伴，漫長的等待不再孤單。你們輪流守候，每當有商旅經過，你都會上前詢問三巴的消息，期盼有朝一日，那熟悉的身影會出現在遠方的道路上。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-footprints",
                    title: "歲月青苔",
                    description: "午後陽光斜照，你踏出家門，發現石階上那些熟悉的足跡漸漸長滿了青苔。你蹲下身，輕撫那些蒼翠，回想起丈夫離家時的身影。這些足跡，有些也許是他留下的......",
                    forCharacter: "wife",
                    season: [1, 2], // 夏、秋
                    year: 3, // 第三年
                    choices: [
                        { 
                            text: "伸手輕撫石階上的青苔痕跡", 
                            effect: {
                                resources: { rice: -5 },
                                emotion: 8,
                                poemFragment: "p10",
                                message: "「門前遲行跡，一一生綠苔」—你輕輕刷去石階上的青苔，彷彿在挽留流逝的時光。每一處足印都可能是丈夫留下的痕跡，你不忍它們就此消失於歲月中。"
                            }
                        },
                        { 
                            text: "看著深重的青苔，感懷秋風落葉", 
                            effect: {
                                emotion: 7,
                                poemFragment: "p11",
                                message: "「苔深不能掃，落葉秋風早」—你任由青苔生長，就如同無法阻擋秋風帶來的落葉。時光流逝，你能做的只是靜待歲月更迭，期盼團聚之日。"
                            }
                        },
                        { 
                            text: "凝望庭院，思念如青苔蔓延不止", 
                            effect: {
                                resources: { rice: -3 },
                                emotion: 4,
                                message: "你佇立門前，視線從青苔延伸至整個庭院。這一方天地靜靜地等待著，如同你心中的思念，生長、蔓延，無法止息。院中的一草一木都承載著對他的記憶，時光雖逝，情感卻更加深厚。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-butterfly",
                    title: "蝶舞秋園",
                    description: "八月初秋，西園草叢中一對蝴蝶雙雙飛舞。彼此緊依，翩然起舞，互相追逐。這和諧美好的景象與你獨自一人的身影形成鮮明對比，一種難以言說的感傷悄然而生。",
                    forCharacter: "wife",
                    season: [2], // 秋
                    year: 3, // 第三年
                    choices: [
                        { 
                            text: "靜賞雙蝶翩飛，嘆獨自無人相伴", 
                            effect: {
                                emotion: 10,
                                poemFragment: "p12",
                                message: "「八月蝴蝶來，雙飛西園草」—看著這對蝴蝶相伴而飛，你不禁想到自己與丈夫的分離。蝶兒成雙，而你卻獨自守望，這對比更讓你思念遠方的丈夫。"
                            }
                        },
                        { 
                            text: "感傷時光流逝，紅顏易老青春難留", 
                            effect: {
                                resources: { letters: 1 },
                                poemFragment: "p13",
                                message: "「感此傷妾心，坐愁紅顏老」—望著蝴蝶短暫的美麗生命，你撫摸著自己的青絲，不禁憂傷：歲月無情，容顏易老，丈夫遠行，何時團聚？年華虛度，徒留相思。"
                            }
                        },
                        { 
                            text: "遙想蝶的前世，是否曾經相識相知", 
                            effect: {
                                resources: { silk: 3 },
                                emotion: 5,
                                message: "古人云：「蝴蝶為梁祝托身」，看著這雙雙對對的蝶影，你不禁想起梁山伯與祝英台的傳說。他們生前不得相守，死後化蝶雙飛。這份堅貞的愛情，讓你不禁凝神遐想，思緒飄向遠方的丈夫。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-market",
                    title: "三巴商信",
                    description: "市集中，你偶遇一位剛從三巴返回的商人，他表示似乎在那邊見過與你描述相符的人。你的心跳加速，急切地想了解更多關於丈夫的消息。商人看著你期盼的眼神，似乎有話要說。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 3, // 修改為第三年
                    choices: [
                        { 
                            text: "提筆寫信，盼知早晚歸期", 
                            effect: {
                                resources: { silver: -3, letters: 1 },
                                emotion: 8,
                                poemFragment: "p14",
                                message: "你交給商人一封信和幾枚銀幣，商人點頭：「我明白。『早晚下三巴，預將書報家』，我會帶給他，請他提前告知歸期，好讓你有所準備。」"
                            }
                        },
                        { 
                            text: "表達願意跋山涉水相迎之意", 
                            effect: {
                                resources: { silver: -10 },
                                emotion: 12,
                                poemFragment: "p15",
                                message: "「相迎不道遠，直至長風沙」—你誠摯地告訴商人，自己願意不辭辛勞，哪怕是一路長風黃沙，也要親自前往迎接久別的丈夫。商人被你的情深意重所感動。"
                            }
                        },
                        { 
                            text: "眺望遠方，思緒隨風飄向三巴", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 6,
                                message: "聽完商人的描述，你的思緒飄向遠方。你站在集市邊緣，望著通往三巴的路，想像著丈夫在彼處的生活。這份貼近感讓你心中湧起一絲暖意，卻也更添幾分思念。"
                            }
                        }
                    ]
                },
                
                // 丈夫角色事件
                {
                    id: "husband-night-gazing",
                    title: "江畔月色",
                    description: "夜晚停泊江畔，明月高懸，照亮了整個江面。你靜坐船頭，思緒萬千。此時的長干里，妻子是否也在仰望這同一輪明月？",
                    forCharacter: "husband",
                    season: [0, 2, 3], // 春、秋、冬
                    choices: [
                        { 
                            text: "揮毫落筆，寄信述說堅貞之心", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 12,
                                poemFragment: "p7",
                                message: "「常存抱柱信，豈上望夫台」—你在信中表達對妻子堅貞的信任與自己對家的思念。如尾生抱柱，不離不棄，你堅信她不會如傳說中的婦人登上望夫台，而是安心等待你歸來。"
                            }
                        },
                        { 
                            text: "對月長嘆，心遙相望千里", 
                            effect: {
                                emotion: 8,
                                message: "你舉杯對月，遙想長干里的妻子是否也在此刻仰望同一輪明月。這般默契，似乎拉近了彼此的距離，心中的思念卻更加濃烈。"
                            }
                        },
                        { 
                            text: "把酒言歡，與商旅分享鄉愁", 
                            effect: {
                                resources: { silver: -5, food: -2 },
                                emotion: 5,
                                message: "酒過三巡，你與同行商人談起家鄉的風土人情，彼此都感到一絲慰藉。月光下，杯盞交錯，共話思鄉之情。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-rapids",
                    title: "險灘急流",
                    description: "前方就是瞿塘峽的灩澦堆險灘，水流湍急如奔馬，激浪拍岸，聲震如雷。多少商船曾在此處傾覆，船毀人亡。面對這凶險水道，你需慎重決斷。",
                    forCharacter: "husband",
                    season: [1], // 夏
                    year: 2, // 修改為第二年
                    choices: [
                        { 
                            text: "緩舟以行，臨危謹慎觀水勢", 
                            effect: {
                                resources: { food: -10 },
                                poemFragment: "p8",
                                message: "「十六君遠行，瞿塘灩澦堆」—你花費了更多時間，細心觀察水勢，選擇最安全的航道緩緩前行。雖耗時良久，卻平安通過了這險灘險灘，不禁心懷感慨，寫下了此行經歷。"
                            }
                        },
                        { 
                            text: "借水之力，順流直下破險阻", 
                            effect: {
                                resources: { goods: -20, silver: 15 },
                                emotion: -5,
                                message: "你選擇借助急流之力，直衝而下。船身劇烈晃動，幾番驚險，終得通過，但舟身擦傷，貨物有損。這般冒險，雖得時間，卻也心有餘悸。"
                            }
                        },
                        { 
                            text: "聆聽猿鳴，觀天象以定行止", 
                            effect: {
                                emotion: 6,
                                message: "你暫時停船，聆聽遠處猿猴哀鳴，觀察天象風向。當地舟子說，猿聲哀切時水勢尤險。你決定暫候水勢平緩，心中不免思及家鄉，遙想妻子安好。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-monkey",
                    title: "猿猴哀鳴",
                    description: "五月的峽谷中，水勢漸漲，急流奔湧。岸邊猿猴群聚，發出哀鳴聲響徹雲霄。當地舟子說，每到此時水險人稀，猿聲似在為不測水性的商旅悲嘆。這淒厲啼聲，勾起你對家鄉的萬般思緒。",
                    forCharacter: "husband",
                    season: [1], // 夏
                    year: 2, // 第二年
                    choices: [
                        { 
                            text: "聆猿哀鳴，執筆寄家書", 
                            effect: {
                                resources: { letters: 2 },
                                emotion: 10,
                                poemFragment: "p9",
                                message: "「五月不可觸，猿聲天上哀」—猿聲如泣如訴，引發你對家的萬般思念。停舟岸邊，你提筆給妻子寫了一封情真意切的信，講述這驚心動魄的五月水勢與猿猴哀鳴，字裡行間盡是相思之苦。"
                            }
                        },
                        { 
                            text: "月照猿啼處，舟行思故鄉", 
                            effect: {
                                emotion: 8,
                                message: "你在船頭靜聽猿啼，這聲聲哀鳴彷彿是你思念的迴響。月光下，你望向遠方，想著千里之外的家鄉與妻子，心中思念如潮水般湧來，卻只能寄情於這蒼茫夜色。"
                            }
                        },
                        { 
                            text: "撐篙避險灘，專心應水勢", 
                            effect: {
                                resources: { silver: 10, goods: 5 },
                                emotion: -5,
                                message: "你強迫自己不去聽那哀鳴，專注於掌舵避險。峽谷水道險象環生，稍有不慎便是滅頂之災。心中雖有思念，卻不能為情所困，唯有平安歸去才是正理。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-trade",
                    title: "三巴市集",
                    description: "三巴市集熙攘喧囂，商賈雲集。各地珍奇異寶、錦緞絲絨琳瑯滿目，討價還價聲此起彼伏。你辛苦搬運的貨物已經售出大半，獲利頗豐。此時你停下腳步，思索著接下來的行程。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 3, // 第三年
                    choices: [
                        { 
                            text: "深入商海，續尋豐厚利潤良機", 
                            effect: {
                                resources: { goods: -40, silver: 60 },
                                message: "你決定多逗留些時日，探尋更多商機。你與幾位商賈熟客深入交談，成功促成幾筆大交易，利潤頗豐。商場如戰場，每一次成功都讓你更加篤定，成為一代商賈的雄心。"
                            }
                        },
                        { 
                            text: "託商旅送信，預將書報家", 
                            effect: {
                                resources: { silver: -10 },
                                emotion: 10,
                                poemFragment: "p14",
                                message: "「早晚下三巴，預將書報家」—你寫好家書，託北上商旅送回。你仔細寫下自己的歸期，以及這段時間的見聞，希望妻子能夠提前得知，不必再日夜盼望，空憑臆想。"
                            }
                        },
                        { 
                            text: "風聲鶴唳間，靜觀時局變化", 
                            effect: {
                                resources: { goods: -10, silver: 15 },
                                emotion: 5,
                                message: "商場如戰場，你聽聞今年西域動蕩，商旅多有損失。你決定暫且觀望，只做小額交易，保存實力。這份謹慎讓你避開了一場風波，雖未大賺，卻也未曾虧損。在這紛亂的商場中，明哲保身有時勝過冒進。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-return-plan",
                    title: "歸途思緒",
                    description: "商旅行程已近尾聲，你即將踏上歸程。途中遇見一位同鄉人，他詢問你打算走哪條路回到長干里。這看似簡單的一問，卻讓你陷入深思：究竟是選擇艱險捷徑早日歸家，還是繞行安全大道帶些珍品？",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 3, // 第三年
                    choices: [
                        { 
                            text: "取道險徑，星夜兼程趕返家門", 
                            effect: {
                                resources: { food: -15 },
                                emotion: 15,
                                message: "你選擇了一條少有人走的山道，崎嶇難行但可節省近半月時間。翻山越嶺，風餐露宿，每一步都承載著對家的思念。你告訴自己，這些艱辛都值得，只為早日見到妻子的笑顏。"
                            }
                        },
                        { 
                            text: "心隨風沙長，不畏遠路迢迢", 
                            effect: {
                                resources: { silver: -18 },
                                emotion: 12,
                                poemFragment: "p15",
                                message: "「相迎不道遠，直至長風沙」—你選擇了安全的大道，雖路途遙遠，但沿途可以尋找珍奇之物帶回家中。你告訴同鄉，若有一日妻子來迎，定不辭千里跋涉之苦，只為與她相見。"
                            }
                        },
                        { 
                            text: "尋覓商隊同行，互保平安返鄉", 
                            effect: {
                                resources: { silver: -10, food: -8 },
                                emotion: 8,
                                message: "你打算與即將北上的商隊同行，雖比獨行慢些，但安全有保障。同行的還有幾位久居他鄉的遊子，大家訴說著思鄉之情，彼此間多了幾分理解與慰藉。夜晚露營時，你常仰望星空，思念家鄉的妻子。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-memory",
                    title: "童年回憶",
                    description: "在三巴城郊的青石小路旁，幾個當地孩童正在嬉戲玩鬧。其中一個小男孩跨坐在手工製作的竹馬上，笑聲清脆響亮。另一個小女孩手持柳枝，追逐著同伴。這熟悉的場景驀然勾起你心底深處的記憶——彼時長干里，你與妻子青梅竹馬的純真歲月。",
                    forCharacter: "husband",
                    season: [0, 3], // 春、冬
                    year: 1, // 明確限制為第一年
                    choices: [
                        { 
                            text: "駐足觀望，尋覓童年身影", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p3",
                                message: "「同居長干里，兩小無嫌猜」—你佇立路邊，目光追隨著孩童們的身影，恍惚間彷彿看到了當年的自己與她，一同在長干里嬉戲的情景。那時的你們天真無邪，不知愁緒為何物，亦不曾想過日後會天各一方。這份純真的記憶，讓你的臉上不自覺地浮現出微笑。"
                            }
                        },
                        { 
                            text: "親手製作一把精緻竹馬相贈", 
                            effect: {
                                resources: { silver: -8 },
                                emotion: 10,
                                message: "你向當地工匠購買了幾根竹子和麻繩，憑著記憶親手製作了一把精緻的竹馬。孩童們看著你熟練的手法，驚嘆連連。完成後，你將竹馬贈予那個小男孩，看著他欣喜若狂的模樣，你彷彿看到了當年的自己，騎著父親製作的竹馬，到妻子家門前炫耀的情景。"
                            }
                        },
                        { 
                            text: "與孩童攀談，講述長干里的故事", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 8,
                                message: "你向孩童們講述了遙遠東方長干里的風土人情，以及你與妻子兒時的趣事。孩童們圍著你，聽得入神，不時發出驚嘆。其中一個小女孩好奇地問：「叔叔，你什麼時候回家呀？」這個單純的問題讓你一時語塞，眼眶微熱。「快了，待叔叔把事情辦完，就回家了。」"
                            }
                        }
                    ]
                },
                {
                    id: "husband-letter",
                    title: "家書抵萬金",
                    description: "商隊送來了一封從長干里寄來的家書，是妻子親筆所寫。你迫不及待地展開書信，紙上還殘留著淡淡的梅花香。字裡行間傾訴著她的日常、思念與等待，最後寫道：「十五始展眉，願同塵與灰」，那是她剛適應婚後生活時常說的話，意在表達與你共度一生的心願。讀罷，一股暖流湧上心頭。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 所有季節
                    choices: [
                        { 
                            text: "細讀再三，思緒紛飛至結髮初期", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p6",
                                message: "「十五始展眉，願同塵與灰」—你反覆閱讀著這句話，思緒回到了新婚之時。當時年少的她逐漸適應了婚後生活，開始對你展顏微笑，立下相伴終生的誓言。這份真摯的情感與承諾，讓你在異鄉倍感溫暖與力量，也更加堅定了早日歸家的決心。"
                            }
                        },
                        { 
                            text: "妥善收藏，執筆回信詳述近況", 
                            effect: {
                                resources: { letters: 1, silver: -3 },
                                emotion: 12,
                                message: "你小心地收好妻子的信，取出新紙和上好的墨，細細描述這段時間的經歷、見聞與思念。你特意畫了一幅簡單的江山圖，讓她能夠想像你所見的風景。最後，你鄭重承諾，三巴之行完成後必定盡快歸家，不再讓她獨守空閨。"
                            }
                        },
                        { 
                            text: "將信貼身收藏，加緊處理商務", 
                            effect: {
                                resources: { goods: 15 },
                                emotion: 8,
                                message: "你將家信折好，放入貼身的荷包中，心想若能加快完成在外的事務，便能早日歸家與她團聚。這個想法讓你幹勁十足，當日便談成了一筆不小的生意。然而夜深人靜時，想起書信中那句「願同塵與灰」，眼眶仍不禁濕潤。"
                            }
                        }
                    ]
                },

                // 隱藏結局特殊事件 - 梅樹月影
                {
                    id: "plum_tree_moonlight",
                    title: "梅樹月影",
                    description: "開元十三年冬，長干巷月夜。\n\n院中老梅今年格外繁盛，月光下如堆積白雪。夜深人靜，你獨坐庭院，執筆記下心事，記錄這些年的等待與思念。\n\n月影婆娑，清風微起，院中梅香沁人心脾。恍惚間，你抬頭望見月色照在半開的梅花上，竟凝成一位身穿素衣的男子身影。你不覺怔住，那身影似真似幻，仿若可以穿透時光。",
                    forCharacter: "wife",
                    season: [3], // 冬季
                    year: 3, // 第三年
                    isRare: true,
                    choices: [
                        { 
                            text: "凝神靜氣，細述心事", 
                            effect: {
                                specialChoice: "plum_tree_encounter",
                                emotion: 15,
                                message: "你不覺心神寧靜，向著那月影傾訴了這三年來的思念與等待。一字一句，皆是肺腑之言。傾訴完畢，你才恍然驚覺自己何以對著月影說話。倒是心中輕鬆許多，彷彿這些年積壓的心事有了安放之處。次日，你發現院中有一枝梅花落在你昨夜寫的心事簿上，花瓣依然鮮活如初。"
                            }
                        },
                        { 
                            text: "點燃一盞花燈，寄托思念", 
                            effect: {
                                emotion: 10,
                                message: "你取出紙燈，點燃蠟燭，在燈上寫下對丈夫的思念。燈火映照梅花，那奇異身影隨風搖曳，忽明忽暗。你將燈籠輕輕放入小池中，讓它順水漂去，彷彿能將你的思念帶向遠方。蠟燭燃盡時，院中忽然飄落幾片梅花，輕輕落在你的肩頭。"
                            }
                        },
                        { 
                            text: "掩門安睡，視為倦眼所致", 
                            effect: {
                                emotion: 5,
                                message: "你搖頭一笑，認為是夜深目倦，看花眼了。收拾心事簿，準備回房安寢。回頭再望時，月影依舊，梅花如常，哪有什麼人影。關門前一瞬，一陣清風拂過，幾片梅花隨風飄入屋內，落在你枕邊。你淺笑將花瓣收好，不知為何心中一片安寧。"
                            }
                        }
                    ]
                },
                
                // 隱藏結局特殊事件 - 江船夜話
                {
                    id: "riverboat_night_talk",
                    title: "江船夜話",
                    description: "開元十三年秋，江上夜泊。\n\n今夜泊船江心，四周一片靜謐。皓月當空，江水輕漾，舟行至此，已是歸途。三年商途，不知妻子可好，心中思緒萬千。\n\n隔船似有誦詩聲傳來，一首接一首，皆是思鄉遊子之作。聲音清越，穿透夜色，引人共鳴。你不禁被吸引，想要一探究竟。",
                    forCharacter: "husband",
                    season: [2], // 秋季
                    year: 3, // 第三年
                    isRare: true,
                    choices: [
                        { 
                            text: "泛舟尋聲，與詩客夜談", 
                            effect: {
                                specialChoice: "riverboat_dialogue",
                                emotion: 15,
                                message: "你駕小舟尋聲而去，只見一艘小舟泊於江心，船上一人獨坐，對月飲酒。你主動搭話，與其促膝長談，論及商途見聞、思鄉之情。對方聽你講述長干里的妻子，和那些青梅竹馬的往事，頻頻點頭，似有所感。夜深辭別時，他贈你一壺酒，說是「他日相逢，再當共飲」。返回船上，你發現那壺酒香氣獨特，啜飲一口，心中竟浮現出家鄉景象，無比真切。"
                            }
                        },
                        { 
                            text: "隔江共詠，吟詩相和", 
                            effect: {
                                emotion: 10,
                                message: "你站在船頭，回應對方詩句，以表共鳴。一來一往，吟詠良久，竟忘了時間。對方詩才極佳，每句都直抵人心。當你吟出「早晚下三巴，預將書報家」時，對方沉默片刻，忽然高聲讚道：「絕句！此乃絕句！」隨後又吟出數句，皆與你思念家鄉之情相合。江風微起，浪聲漸大，對方詩聲漸遠，終至聽不真切。"
                            }
                        },
                        { 
                            text: "靜聽詩聲，獨酌思鄉", 
                            effect: {
                                emotion: 5,
                                message: "你獨自倚欄而立，遙聽詩聲，自斟自飲。那聲音彷彿有某種魔力，讓你夜闌人靜間憶起了與妻子相識、相知、相別的點點滴滴。不知不覺，已是淚濕衣襟。待到詩聲漸歇，你方才恍然回神。遙望對方船隻，已是燈火熄滅。江上明月如水，映照著你滿腹思鄉之情。"
                            }
                        }
                    ]
                },
                // 稀有事件和特殊事件
                {
                    id: "wife-dream-of-husband",
                    title: "夢中相會",
                    description: "夜深人靜，你沉入夢鄉。夢中，你與丈夫重聚，他對你訴說著旅途的艱辛與見聞。夢境如此真實，以至於醒來時，你的枕邊還留有淚痕。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3],
                    isRare: true,
                    choices: [
                        {
                            text: "將夢境如詩般記錄，珍藏心底",
                            effect: {
                                emotion: 15,
                                message: "你詳細記下夢中的每一個細節，字字句句都寫滿了對丈夫的思念。這本日記成為你心靈的慰藉，在孤獨時翻閱。"
                            }
                        },
                        {
                            text: "思索夢中之語，尋其中預兆",
                            effect: {
                                resources: { silver: -8 },
                                emotion: 10,
                                message: "占夢師傅聽完你的描述，微笑著說：「這是吉夢，說明你們心有靈犀，不久將會團聚。」這個解釋給了你無盡的希望。"
                            }
                        },
                        {
                            text: "於窗前靜坐，讓思緒隨風飄散",
                            effect: {
                                emotion: 5,
                                message: "雖然夢境帶給你短暫的慰藉，但你明白現實與夢想的區別。帶著一絲甜蜜的回憶，你投入到日常的忙碌中。"
                            }
                        }
                    ]
                },
                {
                    id: "husband-meeting-scholar",
                    title: "遇見詩人",
                    description: "在江邊的一家酒樓，你遇見一位落魄的詩人。他正獨自對酌，眼中流露出對家鄉的思念。那份情感與你如此相似，讓你忍不住上前攀談。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3],
                    isRare: true,
                    choices: [
                        {
                            text: "請詩人揮毫題詩，寄予長干妻子",
                            effect: {
                                resources: { silver: -15 },
                                emotion: 15,
                                message: "詩人執筆揮毫，寫下「君問歸期未有期，巴山夜雨漲秋池」的絕句。你決定將這首詩連同自己的家書一起寄回，表達對妻子的思念。"
                            }
                        },
                        {
                            text: "把盞共酌，以酒話語傾訴鄉愁",
                            effect: {
                                resources: { food: -5, letters: 1 },
                                emotion: 12,
                                message: "你與詩人對飲暢談，講述商旅途中的見聞與思家之情。詩人深受感動，贈你一卷親筆詩作，你決定將其收藏，日後帶回家與妻子分享。"
                            }
                        },
                        {
                            text: "邀詩人結伴同行，詩酒相伴度長路",
                            effect: {
                                resources: { silver: -10, food: -8 },
                                emotion: 8,
                                message: "詩人欣然接受了你的邀請。旅途中，他的詩詞與見解為枯燥的旅程增添了不少趣味，也讓你對故鄉的思念有了新的表達方式。"
                            }
                        }
                    ]
                },
                {
                    id: "wife-autumn-moon",
                    title: "中秋明月",
                    description: "中秋之夜，月色如水。家家戶戶都在賞月團聚，唯獨你的庭院顯得空曠寂寥。你獨自準備了月餅和時令水果，對著明月舉杯，彷彿與遠方的丈夫隔空共飲。",
                    forCharacter: "wife",
                    season: [2],
                    relatedActions: ["moon-gazing"],
                    isSpecial: true,
                    choices: [
                        {
                            text: "對月輕歌，寄情於詩",
                            effect: {
                                emotion: 12,
                                message: "你吟誦著李白的「舉頭望明月，低頭思故鄉」，思緒飄向遠方的丈夫。月光下，你的歌聲清澈悠揚，傳遞著無盡的思念。"
                            },
                            poetic: true
                        },
                        {
                            text: "邀請鄰里寡婦同賞明月，互相慰藉",
                            effect: {
                                resources: { rice: -8, silver: -5 },
                                emotion: 7,
                                message: "你邀請了幾位同樣守候丈夫的婦人共度中秋。你們分享月餅、交換心事，在這特殊的夜晚不再感到孤單。"
                            },
                            poetic: true
                        },
                        {
                            text: "靜默祈願，祝福遠方的丈夫平安歸來",
                            effect: {
                                emotion: 8,
                                message: "你雙手合十，在明月下虔誠祈禱，願丈夫一切安好，早日歸家。這份寧靜的儀式給了你莫大的慰藉。"
                            },
                            poetic: false
                        }
                    ]
                },

                // 第二年特色事件 - 開元十二年特色事件
                // 妻子事件
                {
                    id: "wife-aging-mirror",
                    title: "鏡中容顏",
                    description: "開元十二年春，距離丈夫離家已經一年多。今日整理妝奩，你無意中發現了成婚時使用的銅鏡。拭去灰塵，鏡中的容顏讓你怔住——眼角已爬上了細紋，昔日的青春似乎正悄然流逝。",
                    forCharacter: "wife",
                    season: [0, 1], // 春夏季節
                    year: 2, // 只在第二年出現
                    choices: [
                        { 
                            text: "梳妝打扮，保持美麗以待夫君歸來", 
                            effect: {
                                resources: { silver: -5, silk: -3 },
                                emotion: 10,
                                message: "你細心地梳理青絲，塗抹胭脂，仿佛丈夫就在身旁。縱使容顏易老，你依然願意為了那個遠方的他保持最美的一面。"
                            },
                            poetic: true
                        },
                        { 
                            text: "撫鏡長嘆，寫下心中的憂思", 
                            effect: {
                                emotion: 8,
                                poemFragment: "p13",
                                message: "「感此傷妾心，坐愁紅顏老」—你輕撫眼角的細紋，歲月如刀，在容顏上留下痕跡，卻割不斷心中的思念。你提筆寫下心中的惆悵，祈願良人早日歸來。"
                            },
                            poetic: true
                        },
                        { 
                            text: "收起舊物，專注於家務和生計", 
                            effect: {
                                resources: { rice: 8 },
                                emotion: 3,
                                message: "你將銅鏡重新收好，轉而專注於家務和生計。美麗與否已不重要，生活還要繼續，家園需要你的維護。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "wife-neighbor-rumor",
                    title: "坊間傳言",
                    description: "市集採買時，你無意間聽到鄰居們的議論。「那家的郎君出去兩年了，怕是不會回來了吧？」「聽說三巴那邊有不少商人納了外室呢。」這些話語如同針刺，讓你心中不安。",
                    forCharacter: "wife",
                    season: [1, 2], // 夏秋季節
                    year: 2, // 只在第二年出現
                    choices: [
                        { 
                            text: "堅信丈夫的忠誠，不為流言所動", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p7",
                                message: "「常存抱柱信，豈上望夫台」—你心中堅信丈夫的忠誠，如同尾生抱柱，絕不為外界流言所動搖。這份堅定讓那些閒言碎語無法撼動你的心。"
                            },
                            poetic: true
                        },
                        { 
                            text: "主動詢問商旅，打探丈夫的消息", 
                            effect: {
                                resources: { silver: -8 },
                                emotion: 5,
                                message: "你找到一位剛從三巴回來的商人，付錢請他打探丈夫的消息。商人告訴你，曾見過你丈夫在那邊做生意，看起來很是忙碌，但安好無恙。這讓你稍感安心。"
                            },
                            poetic: false
                        },
                        { 
                            text: "視而不見，以家務排解憂愁", 
                            effect: {
                                resources: { silk: 10 },
                                emotion: -3,
                                message: "你強忍著淚水，裝作沒有聽見那些閒言碎語，回家後用繁重的家務排解內心的不安與憂愁。雖然手中的活計做得很好，但心中的疑慮始終揮之不去。"
                            },
                            poetic: false
                        }
                    ]
                },

                // 丈夫事件
                {
                    id: "husband-business-opportunity",
                    title: "商機與抉擇",
                    description: "開元十二年夏，你在三巴已經經商一年有餘。今日，當地一位有勢力的富商提出合作邀請，若接受，可能意味著更大的利潤，但也意味著必須再延遲一年才能返鄉。",
                    forCharacter: "husband",
                    season: [1, 2], // 夏秋季節
                    year: 2, // 只在第二年出現
                    choices: [
                        { 
                            text: "放棄商機，準備早日返鄉", 
                            effect: {
                                resources: { silver: -15 },
                                emotion: 15,
                                message: "你婉拒了富商的邀請，表示家中妻子盼歸已久，不願再延遲歸期。雖然錯失了一筆大生意，但想到能夠早日與妻子團聚，你心中充滿了喜悅。"
                            },
                            poetic: true
                        },
                        { 
                            text: "接受合作，但寫信告知妻子", 
                            effect: {
                                resources: { silver: 30, letters: 1 },
                                emotion: 5,
                                poemFragment: "p14",
                                message: "「早晚下三巴，預將書報家」—你決定接受富商的合作，但同時寫了一封詳盡的家書，解釋自己的決定和延遲歸期的理由，並承諾一旦事成便立即返家。"
                            },
                            poetic: true
                        },
                        { 
                            text: "暫時不做決定，靜觀其變", 
                            effect: {
                                resources: { goods: 10 },
                                emotion: -3,
                                message: "你向富商表示需要時間考慮，暫時不做決定。一邊繼續經營自己的生意，一邊觀察這位富商的為人。這種猶豫不決的態度，讓你在生意和家庭之間感到愈發煎熬。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-hometown-merchant",
                    title: "故鄉商旅",
                    description: "在三巴集市上，你偶遇一位來自長干里的商人。閒談間得知，他剛從家鄉出發不久。言談間，他提到曾見過你的妻子在市集上賣絲綢，看上去氣色尚好，但眼中流露出思念之情。",
                    forCharacter: "husband",
                    season: [0, 3], // 春冬季節
                    year: 2, // 只在第二年出現
                    choices: [
                        { 
                            text: "詳細詢問家鄉及妻子的情況", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 12,
                                message: "你熱情款待這位鄉親，詳細詢問著家鄉的變化和妻子的近況。他的每一句描述都讓你仿佛看到了千里之外的畫面，思鄉之情愈發強烈。"
                            },
                            poetic: true
                        },
                        { 
                            text: "託他帶一封家書和禮物回去", 
                            effect: {
                                resources: { silver: -15, goods: -5, letters: 1 },
                                emotion: 10,
                                poemFragment: "p15",
                                message: "「相迎不道遠，直至長風沙」—你精心挑選了幾件珍貴的禮物和一封深情的家書，託商人帶回給妻子。信中你傾訴了對她的思念，以及無論路途多遠，你終將踏上歸途的決心。"
                            },
                            poetic: true
                        },
                        { 
                            text: "保持距離，專注於自己的生意", 
                            effect: {
                                resources: { goods: 8, silver: 10 },
                                emotion: -5,
                                message: "你沒有太多表露情感，只是簡單地詢問了幾句，便轉回到生意上來。儘管內心思念翻騰，但你選擇了壓抑，認為當務之急是努力做好生意，為將來的歸家做準備。"
                            },
                            poetic: false
                        }
                    ]
                },

                // 第二年特殊節日事件（共用）
                {
                    id: "second-year-qingming",
                    title: "清明時節",
                    description: "開元十二年的清明，春雨綿綿。這是你們分離後的第二個清明節，也是思念最濃的時刻。在這緬懷先人的日子裡，對生離的思念更顯深重。",
                    forCharacter: "wife",
                    season: [0], // 春季
                    year: 2, // 只在第二年出現
                    isSpecial: true,
                    choices: [
                        { 
                            text: "製作紙鴉，寄託思念", 
                            effect: {
                                resources: { silk: -3 },
                                emotion: 15,
                                message: "你依照古老習俗，折疊紙鴉，寫上思念之語，在雨中放飛。願它能穿越千山萬水，將你的牽掛傳遞給遠方的他。"
                            },
                            poetic: true
                        },
                        { 
                            text: "打掃祖先墳墓，順便整理門前落葉", 
                            effect: {
                                resources: { rice: -5 },
                                emotion: 8,
                                poemFragment: "p11",
                                message: "「苔深不能掃，落葉秋風早」—你清掃著祖先的墳塋，見青苔厚重，難以徹底清除，恰如你心中的思念，時間越久，越難消磨。"
                            },
                            poetic: true
                        },
                        { 
                            text: "與鄰居同行，互相慰藉", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 5,
                                message: "你與幾位鄰里同行祭祖，在共同的活動中分散了些許思念之情。彼此的支持與理解，讓這個多愁善感的日子不至於過於孤獨。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "second-year-qingming-husband",
                    title: "清明時節",
                    description: "開元十二年的清明，春雨綿綿。這是你們分離後的第二個清明節，也是思念最濃的時刻。客居他鄉，無法掃墓祭祖，更增添了一份離愁別緒。",
                    forCharacter: "husband",
                    season: [0], // 春季
                    year: 2, // 只在第二年出現
                    isSpecial: true,
                    choices: [
                        { 
                            text: "尋一處高地，遙祭故鄉祖先", 
                            effect: {
                                resources: { food: -5 },
                                emotion: 15,
                                message: "你攀登至附近的高地，面向故鄉方向，設簡單供品，遙祭祖先。天地為證，雖遠在他鄉，孝心不減，思念不減。"
                            },
                            poetic: true
                        },
                        { 
                            text: "撰寫家書，寄托思念", 
                            effect: {
                                resources: { letters: 1, silver: -3 },
                                emotion: 12,
                                poemFragment: "p9",
                                message: "「五月不可觸，猿聲天上哀」—你執筆寫下對家鄉的思念，對妻子的牽掛。清明時節雨紛紛，你感受到了與大自然同樣的悲涼之情。"
                            },
                            poetic: true
                        },
                        { 
                            text: "與同鄉人聚會，舉杯言歡", 
                            effect: {
                                resources: { silver: -10, food: -5 },
                                emotion: 5,
                                message: "你找到幾位同鄉人，一同舉杯，緬懷故鄉，慰藉離愁。酒過三巡，愁緒暫解，但思鄉之情卻在酒後更加濃烈。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                // 第三年特色事件 - 開元十三年特色事件
                // 妻子事件
                {
                    id: "wife-wait-no-more",
                    title: "等待何時了",
                    description: "開元十三年春，距離丈夫遠行已過三載。今日一名鄰里婦人來訪，婉轉勸你不要再等，說道：「三年未歸，音信漸少，恐怕...」她欲言又止，但你明白她的意思。",
                    forCharacter: "wife",
                    season: [0], // 春季
                    year: 3, // 只在第三年出現
                    choices: [
                        { 
                            text: "擲地有聲，表達等待決心", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p7",
                                message: "「常存抱柱信，豈上望夫台」—你斬釘截鐵地告訴她，無論等多久，你都不會放棄等待。你的堅定讓她感動落淚，再無勸你改變主意的話語。"
                            },
                            poetic: true
                        },
                        { 
                            text: "獨自流淚，但依然堅守", 
                            effect: {
                                emotion: 10,
                                message: "你微笑送走婦人，關上門後卻淚如雨下。心中確有疑慮，卻仍不願放棄希望。你擦乾眼淚，拿起針線，繼續等待那或許永遠不會回來的人。"
                            },
                            poetic: true
                        },
                        { 
                            text: "心生動搖，考慮另謀生路", 
                            effect: {
                                resources: { silver: 15 },
                                emotion: -10,
                                message: "你沉默良久，心中第一次認真思索未來該如何生活。次日你到集市擺攤賣絲，有意留心四周，試圖尋找一條不再等待的新路。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "wife-dream-of-return",
                    title: "歸來之夢",
                    description: "開元十三年秋，一夜沉睡間，你夢見丈夫乘船歸來，風塵僕僕卻滿面笑容。夢中他說：「本想給你驚喜，沒想到你早已知曉。」醒來時你淚濕枕巾，分不清是夢境還是預感。",
                    forCharacter: "wife",
                    season: [2], // 秋季
                    year: 3, // 只在第三年出現
                    choices: [
                        { 
                            text: "相信這是歸期將近的徵兆", 
                            effect: {
                                resources: { rice: -10, silk: -10 },
                                emotion: 20,
                                message: "你將夢境視為吉兆，開始收拾家中，準備迎接可能歸來的丈夫。你取出珍藏的好米釀酒，織好的新衣掛出，日日盼望著那個身影出現在巷口。"
                            },
                            poetic: true
                        },
                        { 
                            text: "寫信詢問丈夫近況", 
                            effect: {
                                resources: { silver: -5, letters: 1 },
                                emotion: 12,
                                message: "你找來紙筆，寫了一封懇切的家書，詢問丈夫何時歸來。這一次，你直抒胸臆，不再隱藏思念之苦與盼歸之急，希望能得到明確的回應。"
                            },
                            poetic: true
                        },
                        { 
                            text: "視為普通夢境，不予理會", 
                            effect: {
                                emotion: -5,
                                message: "你不願被虛無的夢境牽動情緒，強迫自己不再多想。這些年你經歷了太多失望，不敢再為了一個夢而高興，只怕再次失落更加痛苦。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                // 丈夫事件
                {
                    id: "husband-crossroad-decision",
                    title: "人生岔路",
                    description: "開元十三年夏，三年未歸，你在三巴已有一番事業。今日，當地一位富商提出長期合作，甚至願將女兒許配於你。這意味著你可能要永居此地，不再返回長干里。",
                    forCharacter: "husband",
                    season: [1], // 夏季
                    year: 3, // 只在第三年出現
                    choices: [
                        { 
                            text: "回絕提議，準備返鄉團聚", 
                            effect: {
                                resources: { silver: -20 },
                                emotion: 25,
                                message: "你毫不猶豫地婉拒了富商的好意，表明心中有妻，必當歸返。富商雖不悅，但也欽佩你的癡情。你開始收拾行囊，準備結束在外三年的生活，踏上歸途。"
                            },
                            poetic: true
                        },
                        { 
                            text: "猶豫不決，提出需時考慮", 
                            effect: {
                                resources: { silver: 30, goods: 20 },
                                emotion: -10,
                                message: "你沒有立即回應，而是請求一些時間考慮。富商欣然同意，還送來一批貨物表示誠意。你徹夜難眠，在事業與家庭間拉扯不定，苦苦思索該如何抉擇。"
                            },
                            poetic: false
                        },
                        { 
                            text: "寫信告知妻子真實情況，尋求理解", 
                            effect: {
                                resources: { letters: 1, silver: -5 },
                                emotion: 8,
                                message: "你決定以誠待人，寫信將實情告知妻子。信中你既表達了對她的思念，也坦言了在外發展的機會。你希望她能理解你的難處，給你一些建議。"
                            },
                            poetic: true
                        }
                    ]
                },
                {
                    id: "husband-prepare-return",
                    title: "歸途準備",
                    description: "開元十三年冬，漫長的三巴之行即將結束。你開始打點行裝，盤算著回家的路途與時間。雖已積攢不少財富，但你心中最珍貴的仍是長干里那個日夜等待的人。",
                    forCharacter: "husband",
                    season: [3], // 冬季
                    year: 3, // 只在第三年出現
                    choices: [
                        { 
                            text: "挑選珍貴禮物，彌補三年分離", 
                            effect: {
                                resources: { silver: -30, goods: -20 },
                                emotion: 15,
                                message: "你在市集精心挑選了各種珍奇之物，希望能彌補這三年的虧欠。玉簪、錦緞、南珠、瓷器...每一件都寄託著你對妻子的愧疚與思念。"
                            },
                            poetic: true
                        },
                        { 
                            text: "日夜兼程，爭取早日團圓", 
                            effect: {
                                resources: { food: -15 },
                                emotion: 20,
                                poemFragment: "p15",
                                message: "「相迎不道遠，直至長風沙」—你決定日夜兼程，只帶必要的行囊，以最快的速度趕回長干里。無論風餐露宿，無論千山萬水，你只想早日見到思念三年的妻子。"
                            },
                            poetic: true
                        },
                        { 
                            text: "仔細整理貨物，確保利益最大化", 
                            effect: {
                                resources: { silver: 50, goods: -30 },
                                emotion: -5,
                                message: "你將這三年積累的貨物仔細分類，尋找能夠賣出最好價格的買家。雖然這延後了你的歸期，但你認為帶回更多財富才能給妻子更好的生活。"
                            },
                            poetic: false
                        }
                    ]
                },

                // 第三年特殊節日事件
                {
                    id: "third-year-dragonboat",
                    title: "端午時節",
                    description: "開元十三年五月初五，端午節至。家家戶戶掛艾草、懸菖蒲，划龍舟、食粽子。你獨自在家，準備著節日的食物，窗外歡聲笑語，與你形單影隻形成鮮明對比。",
                    forCharacter: "wife",
                    season: [1], // 夏季
                    year: 3, // 只在第三年出現
                    isSpecial: true,
                    choices: [
                        { 
                            text: "包一份特別的粽子，祈願丈夫歸來", 
                            effect: {
                                resources: { rice: -10 },
                                emotion: 15,
                                message: "你精心包了一個特大的粽子，用紅線纏繞，插上五彩絲線。相傳此法可保平安，助遠方之人歸家。你將它懸掛在門楣，寄託思念與祈願。"
                            },
                            poetic: true
                        },
                        { 
                            text: "前往江邊看龍舟競渡，尋找慰藉", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 8,
                                message: "你走到長江邊，融入觀看龍舟競渡的人群中。激烈的比賽暫時分散了你的注意力，但每當看到歡聚的家庭，心中的孤獨感便愈發強烈。"
                            },
                            poetic: true
                        },
                        { 
                            text: "閉門謝客，獨自度過節日", 
                            effect: {
                                resources: { silk: 15 },
                                emotion: -8,
                                message: "你不願面對節日的熱鬧與歡樂，關上門專心織布，試圖用勞作麻痹自己。在這個團圓的日子裡，獨處反而讓你感到一絲平靜。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                // 丈夫（三巴商人）新增事件
                {
                    id: "husband-hair-memory",
                    title: "髮影懷思",
                    description: "晨起梳洗，水中倒影讓你想起妻子梳髮的模樣。記憶中她的青絲剛好覆額，那時的她尚且年少，在門前折花嬉戲。這畫面如此鮮活，讓你不禁輕撫水面，卻只激起一圈漣漪。",
                    forCharacter: "husband",
                    season: [0], // 春季
                    year: 1, // 第一年
                    relatedActions: ["write-letter", "rest"],
                    choices: [
                        { 
                            text: "記錄這份回憶，寫入家書", 
                            effect: {
                                resources: { letters: 1, silver: -2 },
                                emotion: 10,
                                poemFragment: "p1",
                                message: "「妾髮初覆額，折花門前劇」--你在信中描述了對妻子年少時的回憶，那時她的青絲剛好覆蓋額頭，在家門前嬉戲的模樣歷歷在目，如今思之，倍加思念。"
                            },
                            poetic: true
                        },
                        { 
                            text: "尋找薄紙，描繪妻子容顏", 
                            effect: {
                                resources: { silver: -4 },
                                emotion: 8,
                                message: "你不善繪畫，卻執意在紙上勾勒妻子的眉眼。線條雖拙，卻滿是思念。完成後你將它夾在隨身的書頁間，作為心靈的慰藉。"
                            },
                            poetic: true
                        },
                        { 
                            text: "沉默收拾，繼續行程", 
                            effect: {
                                resources: { goods: 5 },
                                emotion: 3,
                                message: "你將這份回憶深藏心底，收拾好行裝繼續上路。專注於眼前的商務，或許是早日歸家的最佳途徑。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-bamboo-horse",
                    title: "竹馬舊夢",
                    description: "客棧中，鄰床一個小男孩騎著木製竹馬玩耍。這景象觸動了你沉睡已久的記憶----兒時的你也曾這般，騎著竹馬到她家門前，她手持青梅與你追逐玩鬧。彼時的天真無邪，如今只存於夢中。",
                    forCharacter: "husband",
                    season: [3], // 冬季
                    year: 1, // 第一年
                    relatedActions: ["rest", "listen-music"],
                    choices: [
                        { 
                            text: "向小男孩講述你兒時的竹馬往事", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p2",
                                message: "「郎騎竹馬來，繞床弄青梅」--你對小男孩講述童年時與妻子嬉戲的故事，那時你騎著竹馬，她手持青梅，兩小無猜地在院落中追逐玩耍。講述中，彷彿又回到了那段純真的歲月。"
                            },
                            poetic: true
                        },
                        { 
                            text: "為小男孩製作一個更好的竹馬", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 8,
                                message: "你買來竹子，憑著記憶為小男孩製作了一個精巧的竹馬。小男孩驚喜萬分，而你在製作過程中，彷彿看到了當年的自己，內心充滿溫暖的懷念。"
                            },
                            poetic: true
                        },
                        { 
                            text: "送給小男孩一塊糕點", 
                            effect: {
                                resources: { silver: -2, food: -1 },
                                emotion: 5,
                                message: "你從行囊中取出一塊糕點送給小男孩，看著他開心的笑容，思緒卻飄回了自己的童年時光。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-hometown-memory",
                    title: "故里追憶",
                    description: "今晨，你在市集遇見一位同鄉商人，口音熟悉，讓你一下想起長干里的種種。閒談中，他提到：「近來長干里修了新橋，就在你與夫人當年常玩耍的那條小河上。」這一句，勾起了沉睡多年的兒時記憶——你與她在長干里無憂無慮的日子，彼此信任，純真無邪。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 所有季節
                    year: 1, // 第一年
                    choices: [
                        { 
                            text: "與同鄉細話長干舊事，暢敘兒時回憶", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p3",
                                message: "「同居長干里，兩小無嫌猜」——你與同鄉整整聊了一個下午，回憶起在長干里的點點滴滴，尤其是與她青梅竹馬的日子。那時兩小無猜，純真懵懂，如何能料到日後會結為夫妻，又會天各一方？同鄉見你神色感傷，拍拍你肩膀：「兄弟，長干的桃花又開了，想必她也在盼你歸去。」"
                            },
                            poetic: true
                        },
                        { 
                            text: "詢問家鄉近況，打聽妻子消息", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 8,
                                message: "你急切地詢問家鄉的一切——春雨如何，桃花可盛，長干市肆可還熱鬧？尤其關心妻子的消息。同鄉知道的不多，只說看到她在集市賣絲，氣色尚好，但眼神中有掩不住的思念。聽罷，你心中五味雜陳，既欣慰她平安，又心疼她獨自支撐家計。"
                            },
                            poetic: true
                        },
                        { 
                            text: "託同鄉帶一些土產和銀兩回去", 
                            effect: {
                                resources: { silver: -10, goods: -5 },
                                emotion: 5,
                                message: "你精選了一些三巴特產和銀兩，請同鄉帶回長干交給妻子。雖然物輕情意重，但總好過音訊全無。同鄉拍著胸脯保證一定送到，還笑言：「若見她淚眼婆娑，我定如實告訴她，你在他鄉也是夜不能寐，朝思暮想啊！」"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-wedding-memory",
                    title: "初婚迎親",
                    description: "路過一戶人家，正值新婚迎親之日。新娘年僅十四，羞怯地坐在轎中，不敢抬頭。這情景讓你回想起當年迎娶妻子的場景，她那時也是這般羞澀，眼波流轉卻不敢相望。",
                    forCharacter: "husband",
                    season: [0], // 春季
                    year: 1, // 第一年
                    choices: [
                        { 
                            text: "駐足觀望，回憶當年迎親", 
                            effect: {
                                resources: { silver: -2 },
                                emotion: 10,
                                poemFragment: "p4",
                                message: "「十四為君婦，羞顏未嘗開」--你佇立路旁，思緒漸遠。記憶中，十四歲的她身著嫁衣，羞澀動人。你買了幾枚紅棗給新人，祝福他們如你與妻子般恩愛長久。"
                            },
                            poetic: true
                        },
                        { 
                            text: "向新郎贈言，傳授夫妻之道", 
                            effect: {
                                emotion: 7,
                                message: "你向新郎傳授與新婚妻子相處之道，告訴他耐心與體貼的重要。說話間，自己當年的懵懂與成長歷歷在目，心中湧起一陣酸甜回憶。"
                            },
                            poetic: true
                        },
                        { 
                            text: "買些喜糖，獻上祝福", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 5,
                                message: "你購買了一些喜糖送給這對新人，獻上真摯的祝福。看著他們幸福的模樣，你更加堅定了早日歸家的決心。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-shy-bride",
                    title: "新婦難語",
                    description: "你在客棧偶遇一對新婚夫婦，新婦被問話時總是低頭不語，丈夫呼喚十次也不應一聲。那靦腆的神態與當年的妻子如出一轍，令你思緒萬千，寫了一封家書表達思念。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 全年
                    year: 1, // 第一年
                    choices: [
                        { 
                            text: "寫下思念，託商旅帶回家鄉", 
                            effect: {
                                resources: { letters: 1, silver: -3 },
                                emotion: 12,
                                poemFragment: "p5",
                                message: "「低頭向暗壁，千喚不一回」--你提筆寫信，回憶妻子初嫁時的嬌羞，每每喚她，她總是低頭不應。雖是難為情，卻也是一種純真的美。如今思之，倍感溫馨。"
                            },
                            poetic: true
                        },
                        { 
                            text: "贈送一枚玉簪，寄托思念", 
                            effect: {
                                resources: { silver: -15, goods: -5 },
                                emotion: 10,
                                message: "你從行囊中取出為妻子準備的一枚玉簪，贈給這位新娘。願她與丈夫情深意長，也借此寄托對妻子的深深思念。"
                            },
                            poetic: true
                        },
                        { 
                            text: "與丈夫閒談，分享婚後心得", 
                            effect: {
                                resources: { food: -2 },
                                emotion: 4,
                                message: "你與那新婚丈夫分享了一些婚後相處之道，告訴他女子嬌羞需要時間適應。這番交談讓你想起了自己的妻子，不禁淡淡一笑。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-handkerchief-memory",
                    title: "年華信物",
                    description: "整理行囊時，你發現妻子十五歲那年送你的信物，一塊繡有鴛鴦的手帕。那時她已熟悉婚後生活，對你展顏微笑，誓言願與你如塵與灰般相伴一生。撫摸著手帕，仿佛她就在眼前。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 全年
                    year: 1, // 第一年
                    choices: [
                        { 
                            text: "細細撫摸手帕，思念妻子", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p6",
                                message: "「十五始展眉，願同塵與灰」--你輕撫手帕上的鴛鴦圖案，回想起妻子十五歲時，終於適應了婚後生活，開始對你展顏微笑，立下相伴終生的誓言。這份真摯的感情，讓你的思念更加深切。"
                            },
                            poetic: true
                        },
                        { 
                            text: "戴在胸前，貼近心口", 
                            effect: {
                                resources: { silver: -2 },
                                emotion: 10,
                                message: "你將手帕折好，放入貼身的小布袋，戴在胸前。如此一來，她的心意便時刻陪伴著你，給你帶來安慰與力量。"
                            },
                            poetic: true
                        },
                        { 
                            text: "仔細包好手帕，珍藏起來", 
                            effect: {
                                resources: { goods: 5 },
                                emotion: 6,
                                message: "你將手帕仔細摺疊，放入一個小木盒中珍藏。這是你與妻子感情的見證，也是支持你在外經商的動力。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-moss-footprints",
                    title: "苔痕思緒",
                    description: "一場大雨過後，路旁石階上長滿青苔。一位老者嘆道：「我家門前也是這般，踐踏的足跡漸漸被綠苔覆蓋，一去不返的歲月啊。」這話讓你想起家中妻子是否也在門前徘徊，期盼著你的歸來。",
                    forCharacter: "husband",
                    season: [0, 1], // 春、夏
                    year: 2, // 第二年
                    choices: [
                        { 
                            text: "詢問老者更多關於時光流逝的感悟", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 10,
                                poemFragment: "p10",
                                message: "「門前遲行跡，一一生綠苔」--聽完老者的話，你心中一震。你想像妻子日日盼望你歸來的情景，踏出的足跡漸漸長滿青苔，歲月在不知不覺中流逝。這份思念，讓你決心早日返鄉。"
                            },
                            poetic: true
                        },
                        { 
                            text: "在空白紙上寫下「門前青苔」四字", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 8,
                                message: "你取出紙筆，寫下「門前青苔」四字。筆鋒鏗鏘有力，卻暗含思鄉之情。你決定在下一封家書中，表達自己對時光流逝的感慨與歸家的決心。"
                            },
                            poetic: true
                        },
                        { 
                            text: "向老者請教三巴的商道", 
                            effect: {
                                resources: { goods: 5, silver: -2 },
                                emotion: 3,
                                message: "你與老者攀談起三巴的商業之道，獲得了不少實用的建議。雖然對商途有益，但心底仍隱約泛起對家的思念。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-autumn-letter",
                    title: "秋意濃時",
                    description: "秋風掃落葉，你停船江邊，看著滿地枯黃。收到一封家書，妻子寫道家中院落的青苔已深不能掃，落葉滿庭。讀罷，你望向漫天飛舞的落葉，彷彿看到了她獨自清掃庭院的身影。",
                    forCharacter: "husband",
                    season: [2], // 秋
                    year: 2, // 第二年
                    choices: [
                        { 
                            text: "執筆回信，訴說思念與歉疚", 
                            effect: {
                                resources: { letters: 1, silver: -2 },
                                emotion: 12,
                                poemFragment: "p11",
                                message: "「苔深不能掃，落葉秋風早」--你在回信中寫道，思念如青苔難以清除，時光如落葉被秋風捲去。你承諾會早日歸家，不再讓她獨自面對歲月的流逝。"
                            },
                            poetic: true
                        },
                        { 
                            text: "收集一片楓葉，夾在回信中", 
                            effect: {
                                resources: { letters: 1, silver: -4 },
                                emotion: 10,
                                message: "你精心挑選了一片色澤如火的楓葉，壓平後夾在回信中。這是你對她心意的象徵，也是對時光易逝的感慨。"
                            },
                            poetic: true
                        },
                        { 
                            text: "收好家信，加快處理商務", 
                            effect: {
                                resources: { goods: -10, silver: 15 },
                                emotion: 5,
                                message: "你將家書珍藏，決心加快商務進程，爭取早日完成交易返鄉。雖然手中忙碌，但心中的思念卻愈發強烈。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-butterfly-dance",
                    title: "蝶舞驚心",
                    description: "八月的一個清晨，兩隻蝴蝶在船頭花叢中翩翩起舞。這美麗景象卻讓你心中一痛----家中庭院西邊草叢，想必也有蝴蝶飛舞，妻子是否也駐足觀看？是獨自欣賞，還是思念成疾？",
                    forCharacter: "husband",
                    season: [2], // 秋（八月）
                    year: 3, // 修改為第三年
                    choices: [
                        { 
                            text: "靜觀蝶舞，思緒萬千", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p12",
                                message: "「八月蝴蝶來，雙飛西園草」--看著蝴蝶雙雙對對，你不禁想像妻子在家中庭院也看到相似的景象，她是否也如你般獨自觀賞，心中充滿對伴侶的思念？這份共鳴讓你的思緒飄向遠方的她。"
                            },
                            poetic: true
                        },
                        { 
                            text: "畫下蝶舞，寄回家鄉", 
                            effect: {
                                resources: { silver: -3, letters: 1 },
                                emotion: 9,
                                message: "你不擅長繪畫，卻嘗試將眼前的蝶舞景象畫下，附在家書中。雖然線條粗糙，但你希望妻子能透過這幅畫，感受到你心中的思念，以及對她的牽掛。"
                            },
                            poetic: true
                        },
                        { 
                            text: "收集幾隻蝴蝶，製成標本帶回", 
                            effect: {
                                resources: { goods: 3, silver: -2 },
                                emotion: 4,
                                message: "你小心地捕捉了幾隻美麗的蝴蝶，打算製成標本帶回給妻子。雖然美麗，卻總缺少那份生動的靈氣，如同凝固的思念，美麗卻不及真實相聚。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "husband-mirror-reflection",
                    title: "鏡中歲月",
                    description: "偶遇一位賣鏡的商人。試照之際，你驚覺自己已添了幾分風霜。思及妻子，她那如花容顏是否也被歲月偷去了些許光彩？你立刻購下一面上好的銅鏡，準備帶回贈予她，但轉念一想，或許也是提醒她容顏漸老的無情證物。",
                    forCharacter: "husband",
                    season: [0, 1, 2, 3], // 全年
                    year: 3, // 第三年
                    choices: [
                        { 
                            text: "凝視鏡中自己，體會時光無情", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p13",
                                message: "「感此傷妾心，坐愁紅顏老」--望著鏡中漸增的皺紋，你想到妻子或許也在鏡前嘆息，擔憂青春易逝，容顏變老。這份共同的歲月痕跡，讓你更加思念她，也決心早日歸家，不再讓時間虛度。"
                            },
                            poetic: true
                        },
                        { 
                            text: "作詩一首，感嘆歲月流逝", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 12,
                                message: "你揮毫寫下「鏡中容顏今已改，不見當年少年郎。願得早歸長干里，共看明月憶華堂。」詩雖拙劣，但盡顯思念之情與歸家之意。"
                            },
                            poetic: true
                        },
                        { 
                            text: "買下銅鏡，作為禮物帶回", 
                            effect: {
                                resources: { silver: -15, goods: 5 },
                                emotion: 6,
                                message: "你最終決定購買這面精美的銅鏡，希望能作為禮物帶給妻子。無論容顏如何變化，你對她的情感從未改變，這也是你想要傳達的心意。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                // 妻子新增詩句解鎖事件
                {
                    id: "wife-longgan-boat",
                    title: "長干篷船憶",
                    description: "清晨，窗外傳來船工整齊的號子聲。你走到門前，看見一艘漕船停靠在長干碼頭。船工們肩扛麻繩，拉纖前行，喊著古老的號子：「嗨喲——嗨喲——」。恍惚間，你仿佛看見幼時的自己站在碼頭邊，身著素衣，手持折下的小花，在船埠邊嬉戲。那時的長干里，到處是漕運的繁忙與活力。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 所有季節
                    year: [1, 2, 3], // 所有年份均可觸發
                    relatedActions: ["write-poem", "pray", "garden-poetry", "moon-gazing", "mirror-gazing", "manage-home", "market", "weaving", "sell-textiles"],
                    choices: [
                        { 
                            text: "駐足船埠，遙望童年時光", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p1",
                                message: "「妾髮初覆額，折花門前劇」——你佇立岸邊，看著船工們忙碌的身影，想起幼時在這碼頭嬉戲的日子。那時髮剛覆額，常在門前折花玩耍，無憂無慮。如今世事變遷，卻只能在碼頭獨自回憶那逝去的時光。"
                            },
                            poetic: true
                        },
                        { 
                            text: "與老船工交談，詢問三巴水路消息", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 6,
                                message: "你向老船工打聽三巴的消息。老者捋著鬍鬚慢慢道來：「三巴水路崎嶇難行，今年水勢尤其洶湧。」聽聞此言，你不禁為遠方的丈夫擔憂，卻也多了些許遙遠的連繫。"
                            },
                            poetic: false
                        },
                        {
                            text: "摘一朵野花，置於鬢間，遙寄相思",
                            effect: {
                                emotion: 8,
                                message: "你在岸邊摘下一朵小花，輕輕插在髮間。這個小小的動作，恰如童年的你在碼頭邊折花嬉戲。花香沁人心脾，思緒飄向遠方的丈夫，不知他是否也能聞到家鄉的花香。"
                            },
                            poetic: true
                        }
                    ]
                },
                
                {
                    id: "wife-dock-children",
                    title: "碼頭歸船",
                    description: "夏日的碼頭熱鬧非凡，一艘商船剛剛靠岸，船上的貨物正被搬運到岸上。碼頭邊幾個船戶的孩子拿著竹篙當作馬匹騎著，嬉戲追逐。其中一個男孩手持青梅，投向另一個躲在床榻模樣貨物後的女孩。這熟悉的情景，讓你想起了那些遙遠的童年時光。",
                    forCharacter: "wife",
                    season: [1], // 夏季
                    year: 1, // 第一年
                    relatedActions: ["market", "garden-poetry"],
                    choices: [
                        { 
                            text: "微笑觀望他們追逐嬉戲，回憶竹馬青梅之樂", 
                            effect: {
                                resources: { rice: -2 },
                                emotion: 10,
                                poemFragment: "p2",
                                message: "「郎騎竹馬來，繞床弄青梅」——看著孩子們的嬉戲，你的思緒飄回童年。那時他騎著竹馬來訪，你們在床榻旁追逐，嬉戲弄青梅。如今身在何處，可還記得這兩小無猜的時光？長干碼頭的船來船往，而你的等待仍在繼續。"
                            },
                            poetic: true
                        },
                        { 
                            text: "詢問商船水手，打探三巴消息", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 4,
                                message: "你向剛靠岸的水手打聽三巴消息。他告訴你今年水路順暢，商船往來頻繁。這讓你既歡喜又擔憂——商路通暢，為何丈夫仍未歸來？或許是生意太好，難以抽身吧。"
                            },
                            poetic: false
                        },
                        {
                            text: "送給孩子們一些糕點，分享童年趣事",
                            effect: {
                                resources: { rice: -5, silver: -2 },
                                emotion: 6,
                                message: "你買了些糕點分給碼頭上嬉戲的孩子們，與他們分享自己小時候在長干里的趣事。孩子們聽得入神，你在講述中也重溫了那段青梅竹馬的純真歲月。"
                            },
                            poetic: true
                        }
                    ]
                },
                
                {
                    id: "wife-longgan-neighbors",
                    title: "長干鄰里",
                    description: "街角遇見一位滿頭白髮的老婆婆，她瞇著眼仔細打量你：「可是張家的小姑娘？我記得你小時候總和隔壁那家的小子一起玩耍，沒想到你們竟成了夫妻。」老人的話語勾起你對童年時光的回憶，那時你們確實形影不離，純真無邪。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 全年都可能觸發
                    year: 1, // 第一年
                    relatedActions: ["manage-home", "market"], // 與家務和市集活動關聯
                    choices: [
                        { 
                            text: "細述童年往事，回憶同住長干的純真歲月", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p3",
                                message: "「同居長干里，兩小無嫌猜」——你向老婆婆講述了小時候與他一起在長干里玩耍的往事。那時你們兩小無猜，肆意奔跑在長干的街巷，分享每一個歡笑與秘密。老人慈祥地點頭，「那樣的情誼難得，難怪你們最終成了夫妻。」"
                            },
                            poetic: true
                        },
                        { 
                            text: "詢問老人是否有丈夫的消息", 
                            effect: {
                                resources: { silver: -3 },
                                emotion: 6,
                                message: "你禮貌地詢問老人是否聽聞三巴商船的消息。老人搖頭嘆息：「老婆子我已多年未出遠門，對這些消息知之甚少。不過，商路向來多變，切莫過分擔憂。」雖未得到確切消息，但這份關心讓你心中稍安。"
                            },
                            poetic: false
                        },
                        { 
                            text: "贈送些許糕點，感謝老人的關心", 
                            effect: {
                                resources: { rice: -5 },
                                emotion: 5,
                                message: "你從籃中取出剛買的糕點贈予老人，以表謝意。老人喜出望外，連聲道謝：「好孩子，你從小就心地善良。你那郎君也是個好的，定會平安歸來。」這簡單的祝福給你帶來一絲慰藉。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                {
                    id: "wife-wedding-memory",
                    title: "少女嫁期",
                    description: "隔壁家女兒剛滿十四歲，今日出嫁。你站在人群外，看著喜轎前羞怯的少女低頭垂目，臉抹胭脂卻掩不住忐忑。老嫗們在旁指點叮嚀，場景引起你對自己當年出嫁時光的回憶——恰似這般年紀，恰似這般心緒。",
                    forCharacter: "wife",
                    season: [0, 1, 2, 3], // 全年都可能觸發
                    year: 1, // 第一年
                    relatedActions: ["manage-home", "market"], // 與家務和市集活動關聯
                    choices: [
                        { 
                            text: "贈送絲帕，憶起當年羞顏未嘗開的心緒", 
                            effect: {
                                resources: { silver: -3, silk: -2 },
                                emotion: 10,
                                poemFragment: "p4",
                                message: "「十四為君婦，羞顏未嘗開」——你以絲帕為禮，輕聲道出此語。這句話引起周圍婦人們的共鳴，她們紛紛點頭，回憶起自己的嫁娶時光。你想起初嫁時的羞澀，每每見到夫君，都是低頭垂目，不敢直視。多年過去，思及此事，竟仍覺臉頰微熱。"
                            },
                            poetic: true
                        },
                        { 
                            text: "站在一旁，靜靜觀望婚禮儀式", 
                            effect: {
                                emotion: 6,
                                message: "你站在人群外，靜靜看著婚禮儀式。花轎、禮樂、哭嫁聲，一切都如你當年一般。看著新嫁娘的嬌羞模樣，不禁想起當年的自己，怕是比她還要羞怯三分。歲月匆匆，恍若隔世。"
                            },
                            poetic: true
                        },
                        { 
                            text: "送上祝福與嫁妝，給予實用建議", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 3,
                                message: "你贈送了一些實用的嫁妝物品，並附上一封短箋，列出初為人婦時需留心之事。婚禮結束後，少女的母親拉著你的手致謝：「多虧有妳這樣的好鄰居，我家姑娘總算少擔些心。」你笑著搖頭，道一句「女兒家出嫁，本就不易」。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                {
                    id: "wife-quiet-chamber",
                    title: "閨房思緒",
                    description: "冬日的暮色漸濃，閨房內爐火溫暖。你獨坐窗前，凝視著對面的暗壁，上面映著燭影搖曳。思緒飄回初嫁時光，那時年少的你總是羞於面對丈夫的呼喚，低頭不語，躲避他的目光。如今他遠在三巴，你卻開始懷念那段羞澀甜蜜的時光。",
                    forCharacter: "wife",
                    season: [1, 3], // 夏季和冬季
                    year: [1, 2], // 第一年或第二年
                    relatedActions: ["moon-gazing", "mirror-gazing"], // 與凝思活動關聯
                    choices: [
                        { 
                            text: "撫摸牆壁，回想初嫁時的害羞與沉默", 
                            effect: {
                                emotion: 12,
                                poemFragment: "p5",
                                message: "「低頭向暗壁，千喚不一回」——你輕觸冰涼的牆面，思緒沉入回憶。那時丈夫呼喚你，你總是低頭面向牆壁，羞得不敢應答。即使他呼喚千遍，你也難得回應一次。如今想來，那時的自己是多麼害羞，多麼青澀，卻又是多麼幸福。"
                            },
                            poetic: true
                        },
                        { 
                            text: "執筆題詩，記錄相思與等待", 
                            effect: {
                                resources: { silver: -4 },
                                emotion: 8,
                                message: "你取出筆墨，在紙上寫下對丈夫的思念。回想起當初的靦腆，你不禁莞爾一笑。如今你多麼希望能聽到他的聲音，哪怕只是喚你一次。筆尖沾淚，字字皆是相思。"
                            },
                            poetic: true
                        },
                        { 
                            text: "整理閨閣，收拾思緒", 
                            effect: {
                                resources: { silk: 6 },
                                emotion: 4,
                                message: "你振作精神，開始整理閨房。拂去窗櫺上的灰塵，收拾床帷，重新鋪設席枕。物品一一歸位，心緒卻難以安放。整理過程中，發現了幾匹尚可出售的絲綢，或可貼補家用。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                {
                    id: "wife-embroidery",
                    title: "繡襦思憶",
                    description: "春日午後，陽光正好。你在窗前的繡架前坐下，開始繡製一件衣物。針線穿梭間，思緒回到十五歲那年，嫁入夫家後，漸漸適應了婚後生活，開始對丈夫展顏微笑，立下相守一生的誓言。「十五始展眉」，那是心扉初開的時刻，從羞怯到坦然，那份情感的轉變，如今回想起來，倍感珍貴。",
                    forCharacter: "wife",
                    season: [0, 2], // 春季和秋季
                    year: 1, // 第一年
                    relatedActions: ["weaving", "sell-textiles", "write-poem", "pray", "garden-poetry", "moon-gazing", "mirror-gazing", "manage-home", "market"], // 包含所有詩意行動和相關務實行動
                    choices: [
                        { 
                            text: "繡上「願同塵與灰」字樣，寓意矢志不渝", 
                            effect: {
                                resources: { silk: -8 },
                                emotion: 15,
                                poemFragment: "p6",
                                message: "「十五始展眉，願同塵與灰」——針線在布面上游走，你小心翼翼地繡上這句話，每一針都飽含心意。當年立下的誓言，願與他如同塵與灰般不可分離，共度此生。雖然如今他遠在他鄉，但這份承諾依然深埋心底，從未改變。繡成後，你將衣物貼身收好，仿佛這樣就能與他心意相通。"
                            },
                            poetic: true
                        },
                        { 
                            text: "繡上並蒂蓮花，寄托相思之情", 
                            effect: {
                                resources: { silk: -5 },
                                emotion: 10,
                                message: "你在衣物上繡上一對並蒂蓮花，象徵夫妻情深，同心同德。花瓣的輪廓隨著針線漸漸成形，每一筆都傾注了你的思念。十五歲時的誓言「願同塵與灰」雖未出口，卻蘊含在這朵連理蓮中。繡畢，你撫摸著繡好的花朵，彷彿能觸碰到他溫暖的手。"
                            },
                            poetic: true
                        },
                        { 
                            text: "專注於繡工，務求精細入微", 
                            effect: {
                                resources: { silk: -3, silver: 12 },
                                emotion: 6,
                                message: "你專心致志於繡工技藝，一絲不苟地將每一針都做到極致。雖然思緒偶爾飄向往事，但手上的活計絲毫不受影響。這件精美的繡品完成後，不僅是一件實用的衣物，更因其精湛的工藝而頗具價值，足可換取不少銀兩，貼補家用。"
                            },
                            poetic: false
                        }
                    ]
                },
                
                // 妻子（長干少婦）新增事件
                {
                    id: "wife-dangerous-rapids",
                    title: "險灘傳聞",
                    description: "市集上遇見一位風塵僕僕的老商人。談及丈夫可能的去處，老者面色一沉：「去三巴必經瞿塘峽，那灩澦堆險灘吞沒了多少年輕性命啊。」聽聞此言，你心如刀絞，夜不能寐。",
                    forCharacter: "wife",
                    season: [0, 1], // 春、夏
                    year: 2, // 修改為第二年
                    choices: [
                        { 
                            text: "向老商人詳細詢問峽中情形", 
                            effect: {
                                resources: { silver: -5 },
                                emotion: 12,
                                poemFragment: "p8",
                                message: "「十六君遠行，瞿塘灩澦堆」--「十六君遠行，瞿塘灩澦堆」--老商人描述了瞿塘峽灩澦堆的險惡，船隻如稻草般被洶湧的江水捲入漩渦。你聽得心驚肉跳，明白丈夫每日面對的危險，淚水默默滑落。"
                            },
                            poetic: true
                        },
                        { 
                            text: "請商人帶一封平安符給丈夫", 
                            effect: {
                                resources: { silver: -8, silk: -5 },
                                emotion: 10,
                                message: "你連夜縫製了一個精緻的平安符，內藏絲線及髮絲，拜託商人若見到你丈夫，定要轉交。商人見你如此情深，鄭重應允，定當盡力。"
                            },
                            poetic: true
                        },
                        { 
                            text: "點燃香燭，祈求丈夫平安", 
                            effect: {
                                resources: { silk: -2, rice: -3 },
                                emotion: 8,
                                message: "你在佛前點燃香燭，虔誠地祈禱丈夫能夠躲過危險，平安歸來。雖無法親臨相助，但這份心意或能成為他的護身符。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "wife-may-water-rising",
                    title: "五月水漲",
                    description: "五月時節，一支商隊經過長干里。隊中一位老者談起三峽水情：「五月水漲，險象環生，峽中猿猴哀鳴，聲傳雲霄，彷彿為遇難者哭泣。」你聽後驚懼不已，日日在佛前祈禱丈夫平安。",
                    forCharacter: "wife",
                    season: [1], // 夏（五月）
                    year: 2, // 第二年
                    choices: [
                        { 
                            text: "詢問更多關於猿猴哀鳴的傳聞", 
                            effect: {
                                emotion: 10,
                                poemFragment: "p9",
                                message: "「五月不可觸，猿聲天上哀」--老者描述五月水漲時，峽谷中猿猴的哀鳴聲可傳到天上，彷彿在為那些遭遇不測的商旅哭泣。這讓你更加擔憂丈夫的安危，夜不能寐。"
                            },
                            poetic: true
                        },
                        { 
                            text: "夜臥難眠，作詩寄情", 
                            effect: {
                                resources: { letters: 1 },
                                emotion: 8,
                                message: "「五月江水漲，猿聲震山林。君在三峽外，可聞妾悲吟？」你將此詩寫在信紙上，卻無從寄出，只能將它壓在枕下，希望夢中能與丈夫相會。"
                            },
                            poetic: true
                        },
                        { 
                            text: "請教避險之法，寄信告知丈夫", 
                            effect: {
                                resources: { silver: -10, letters: 1 },
                                emotion: 5,
                                message: "你向老者請教三峽通行的安全之法，並寫信告知丈夫。雖不知信能否及時送達，但總希望能為他的安全多盡一份力。"
                            },
                            poetic: false
                        }
                    ]
                },
                {
                    id: "third-year-dragonboat-husband",
                    title: "端午時節",
                    description: "開元十三年五月初五，端午至。三巴水域舉行盛大龍舟競渡，人聲鼎沸，熱鬧非凡。你站在岸邊，看著船上的競渡者奮力划槳，思緒卻飄向千里之外的家鄉。",
                    forCharacter: "husband",
                    season: [1], // 夏季
                    year: 3, // 只在第三年出現
                    isSpecial: true,
                    choices: [
                        { 
                            text: "尋找商隊，託人送粽葉與香囊回家", 
                            effect: {
                                resources: { silver: -15 },
                                emotion: 18,
                                message: "你買來精美的粽葉、五彩絲線和香囊，託即將北上的商隊帶回給妻子。雖無法親自送達，但願這份端午心意能讓她感受到你的牽掛。"
                            },
                            poetic: true
                        },
                        { 
                            text: "參加龍舟競渡，以體力消磨思鄉之情", 
                            effect: {
                                resources: { food: -10 },
                                emotion: 5,
                                message: "你加入了一支臨時組建的龍舟隊伍，奮力划槳競渡。激烈的比賽確實讓你暫時忘卻了思鄉之愁，但比賽結束後，四肢的疲憊卻襯得心靈更加空虛。"
                            },
                            poetic: false
                        },
                        { 
                            text: "與同鄉聚會，分享思念與鄉愁", 
                            effect: {
                                resources: { silver: -8, food: -5 },
                                emotion: 12,
                                message: "你約上幾位同是異鄉人的朋友，一同飲酒食粽，談論家鄉的風俗與親人。在共同的思鄉情緒中，彼此的鄉愁似乎得到了一絲慰藉。"
                            },
                            poetic: true
                        }
                    ]
                },
                {
                    id: "third-year-moonFestival",
                    title: "花好月圓夜",
                    description: "開元十三年八月十五，又一個中秋佳節。三年前的今日，你們剛剛分別；三年後的今夜，明月依舊，人事已非。你在庭院擺上月餅和水果，獨自對月而飲。",
                    forCharacter: "wife",
                    season: [2], // 秋季
                    year: 3, // 只在第三年出現
                    isSpecial: true,
                    choices: [
                        { 
                            text: "明月撫窗影，仰首寄情思", 
                            effect: {
                                emotion: 15,
                                poemFragment: "p10",
                                message: "「門前遲行跡，一一生綠苔」—你仰望明月，想起當年送别丈夫時的情景，如今門前的足跡早已被青苔覆蓋，唯有這輪明月依舊照耀著彼此。淚水悄然滑落，卻仍心存希望。"
                            }
                        },
                        { 
                            text: "團圓佳節孤燈照，邀鄰共話舒離愁", 
                            effect: {
                                resources: { rice: -12, silver: -8 },
                                emotion: 10,
                                message: "你邀請了幾位同樣守候丈夫的婦人共度中秋。在這團圓的夜晚，你們相互鼓勵，分享等待的酸甜苦辣。縱然孤獨，彼此的陪伴讓心靈不再寒冷。"
                            }
                        },
                        { 
                            text: "歲月流轉不停息，整理舊物撫心痛", 
                            effect: {
                                resources: { silver: 10 },
                                emotion: -10,
                                message: "三年杳無音訊，你開始接受丈夫可能不會歸來的現實。你決定整理他的衣物和物品，有些堪用的可以變賣。每一件物品都承載著記憶，讓你淚流不止，卻也漸漸釋懷。"
                            }
                        }
                    ]
                },
                {
                    id: "third-year-moonFestival-husband",
                    title: "他鄉明月夜",
                    description: "開元十三年八月十五，又是一年中秋。你買了一壺好酒，登上三巴城外的高丘，獨自對月而飲。三年前的今日，你初到此地；三年後的今夜，你即將離開。明月高懸，彷彿是家鄉的召喚。",
                    forCharacter: "husband",
                    season: [2], // 秋季
                    year: 3, // 只在第三年出現
                    isSpecial: true,
                    choices: [
                        { 
                            text: "遙祝家人安好，許下團圓誓言", 
                            effect: {
                                resources: { food: -5 },
                                emotion: 18,
                                message: "你舉杯對月，默默祝願家人安康。今夜過後，你將收拾行裝，無論風雨兼程，也要趕在明年春暖花開時返回長干里，不再讓妻子獨守空閨。"
                            },
                            poetic: true
                        },
                        { 
                            text: "即刻寫一封家書，表達思念與歸期", 
                            effect: {
                                resources: { silver: -8, letters: 1 },
                                emotion: 15,
                                message: "月光下，你提筆疾書，將這三年來的思念與愧疚傾訴紙上。你明確告知妻子，商務已近尾聲，你將在冬去春來之際返家。次日一早，你託最快的信使將書信送往長干。"
                            },
                            poetic: true
                        },
                        { 
                            text: "與當地朋友同飲，尋求歡樂", 
                            effect: {
                                resources: { silver: -15, food: -5 },
                                emotion: -5,
                                message: "你約上幾位在三巴結識的朋友，一同賞月飲酒。觥籌交錯間，你努力融入歡樂氣氛，試圖壓抑那揮之不去的鄉愁。酒過三巡，思緒漸亂，不知今夕何夕。"
                            },
                            poetic: false
                        }
                    ]
                }
            ]
        };
        
        // DOM 元素
        const startScreen = document.getElementById("start-screen");
        const gameScreen = document.getElementById("game-screen");
        const wifeCard = document.getElementById("wife-card");
        const husbandCard = document.getElementById("husband-card");
        const startGameBtn = document.getElementById("start-game");
        const playerName = document.getElementById("player-name");
        const playerDescription = document.getElementById("player-description");
        const resourcesList = document.getElementById("resources-list");
        const poemFragments = document.getElementById("poem-fragments");
        const poemsCount = document.getElementById("poems-count");
        const gameScene = document.getElementById("game-scene");
        const actionButtons = document.getElementById("action-buttons");
        const messages = document.getElementById("messages");
        const seasonText = document.getElementById("season-text");
        const roundText = document.getElementById("round-text");
        const seasonProgress = document.getElementById("season-progress");
        const emotionBar = document.getElementById("emotion-bar");
        const endScreen = document.getElementById("end-screen");
        const endTitle = document.getElementById("end-title");
        const endDescription = document.getElementById("end-description");
        const allPoems = document.getElementById("all-poems");
        const restartGame = document.getElementById("restart-game");
        const switchCharacter = document.getElementById("switch-character");
        const tutorial = document.getElementById("tutorial");
        const tutorialText = document.getElementById("tutorial-text");
        const tutorialNext = document.getElementById("tutorial-next");
        
        // 事件模態窗
        const eventModal = document.getElementById("event-modal");
        const eventTitle = document.getElementById("event-title");
        const eventDescription = document.getElementById("event-description");
        const eventOptions = document.getElementById("event-options");
        const eventNote = document.getElementById("event-note");
        
        // 初始化遊戲事件處理器
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化歷史記錄視圖
            initHistoryView();
            // 綁定角色選擇事件
            wifeCard.addEventListener("click", function() {
                wifeCard.classList.add("selected");
                husbandCard.classList.remove("selected");
                startGameBtn.disabled = false;
                gameState.characterType = "wife";
                document.getElementById("select-prompt").style.opacity = "0";
            });
            
            husbandCard.addEventListener("click", function() {
                husbandCard.classList.add("selected");
                wifeCard.classList.remove("selected");
                startGameBtn.disabled = false;
                gameState.characterType = "husband";
                document.getElementById("select-prompt").style.opacity = "0";
            });
            
            // 綁定開始遊戲按鈕
            startGameBtn.addEventListener("click", function() {
                if (!gameState.characterType) {
                    document.getElementById("select-prompt").style.opacity = "1";
                    return;
                }
                
                startScreen.classList.add("hidden");
                gameScreen.classList.remove("hidden");
                
                initGame(gameState.characterType);
            });
            
            // 綁定事件模態窗關閉按鈕
            document.getElementById("close-event-modal").addEventListener("click", function() {
                eventModal.classList.remove("active");
            });
            
            // 綁定重新開始和切換角色按鈕
            restartGame.addEventListener("click", function() {
                endScreen.classList.remove("active");
                setTimeout(() => {
                    endScreen.classList.add("hidden");
                    initGame(gameState.characterType);
                }, 300);
            });
            
            switchCharacter.addEventListener("click", function() {
                endScreen.classList.remove("active");
                setTimeout(() => {
                    endScreen.classList.add("hidden");
                    gameScreen.classList.add("hidden");
                    startScreen.classList.remove("hidden");
                    
                    wifeCard.classList.remove("selected");
                    husbandCard.classList.remove("selected");
                    startGameBtn.disabled = true;
                }, 300);
            });
            
            // 完全重寫教學處理函數，確保其工作正常
            const globalHandleTutorialNext = function() {
                console.log("按鈕被點擊，當前步驟: " + tutorialStep);
                
                // 清除先前的高亮
                clearHighlight();
                
                // 增加步驟計數
                tutorialStep++;
                console.log("教學進度: 步驟 " + tutorialStep + "/" + tutorialSteps.length);
                
                if (tutorialStep < tutorialSteps.length) {
                    // 更新教學內容
                    tutorialText.textContent = tutorialSteps[tutorialStep];
                    
                    // 高亮新步驟相關元素
                    highlightCurrentStep();
                } else {
                    // 完成所有步驟後隱藏教學
                    console.log("教學完成，隱藏教學窗口");
                    tutorial.classList.add("hidden");
                }
            };
            
            // 先移除所有可能的事件監聽器
            const newTutorialNext = tutorialNext.cloneNode(true);
            tutorialNext.parentNode.replaceChild(newTutorialNext, tutorialNext);
            
            // 獲取新按鈕並正確綁定事件
            document.getElementById("tutorial-next").addEventListener("click", globalHandleTutorialNext);
        });
        
        // 初始化歷史記錄視圖
        function initHistoryView() {
            // 綁定查看更多按鈕
            const viewHistoryBtn = document.getElementById("view-history");
            const historyModal = document.getElementById("history-modal");
            const closeHistoryModal = document.getElementById("close-history-modal");
            const closeHistoryBtn = document.getElementById("close-history");
            
            if (viewHistoryBtn) {
                viewHistoryBtn.addEventListener("click", showHistoryModal);
            }
            
            if (closeHistoryModal) {
                closeHistoryModal.addEventListener("click", closeHistoryView);
            }
            
            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener("click", closeHistoryView);
            }
        }
        
        // 顯示歷史記錄窗口
        function showHistoryModal() {
            const historyModal = document.getElementById("history-modal");
            const historyMessages = document.getElementById("history-messages");
            
            // 清空歷史消息容器
            historyMessages.innerHTML = "";
            
            // 填充所有歷史消息
            const allMessages = [...gameState.messages];
            
            allMessages.forEach(msgData => {
                const message = document.createElement("div");
                message.className = "message-item mb-3";
                
                // 詩句收集特殊樣式
                let messageText = typeof msgData === 'string' ? msgData : msgData.text;
                let messageDate = typeof msgData === 'string' ? "" : msgData.date;
                let season = typeof msgData === 'string' ? gameState.currentSeason : msgData.season;
                
                // 檢查是否獲得詩句
                const isPoem = messageText.includes('「') && messageText.includes('」--');
                
                if (isPoem) {
                    message.classList.add("border-l-4", "border-amber-300", "bg-amber-50/30", "dark:bg-amber-900/20", "py-3", "px-3", "rounded-r");
                }
                
                // 為季節變化使用不同樣式
                if (messageText.includes('，時光流轉，又是一季。')) {
                    message.classList.add("border-l-4", "border-primary-light", "px-3");
                }
                
                // 創建日期元素
                const dateSpan = document.createElement("span");
                dateSpan.className = "text-xs font-medium block mb-1";
                
                // 為不同季節使用不同顏色
                if (season === 0) dateSpan.classList.add("text-green-600", "dark:text-green-400");
                if (season === 1) dateSpan.classList.add("text-amber-600", "dark:text-amber-400");
                if (season === 2) dateSpan.classList.add("text-red-600", "dark:text-red-400");
                if (season === 3) dateSpan.classList.add("text-blue-600", "dark:text-blue-400");
                
                dateSpan.textContent = messageDate || "";
                
                // 添加到消息中
                message.appendChild(dateSpan);
                
                // 如果是詩句收集事件，添加特殊標記
                if (isPoem) {
                    const poemBadge = document.createElement("div");
                    poemBadge.className = "inline-block px-2 py-1 bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-100 rounded text-xs font-semibold mb-2";
                    poemBadge.innerHTML = "📜 獲得詩句";
                    message.appendChild(poemBadge);
                    
                    // 提取並高亮詩句
                    const contentContainer = document.createElement("div");
                    const poemMatch = messageText.match(/「([^」]+)」/);
                    
                    if (poemMatch && poemMatch[1]) {
                        const poem = poemMatch[1];
                        const beforePoem = messageText.split(`「${poem}」`)[0];
                        const afterPoem = messageText.split(`「${poem}」--`)[1] || "";
                        
                        // 添加詩句之前的文字
                        if (beforePoem) {
                            const beforeSpan = document.createElement("span");
                            beforeSpan.textContent = beforePoem;
                            contentContainer.appendChild(beforeSpan);
                        }
                        
                        // 添加高亮詩句
                        const poemSpan = document.createElement("div");
                        poemSpan.className = "font-bold text-amber-700 dark:text-amber-300 my-2 border-t border-b border-amber-200 dark:border-amber-800 py-2";
                        poemSpan.textContent = `「${poem}」`;
                        contentContainer.appendChild(poemSpan);
                        
                        // 添加詩句之後的文字
                        if (afterPoem) {
                            const afterSpan = document.createElement("span");
                            afterSpan.textContent = `--${afterPoem}`;
                            contentContainer.appendChild(afterSpan);
                        }
                        
                        message.appendChild(contentContainer);
                    } else {
                        // 如果無法解析詩句，直接顯示原文
                        const contentSpan = document.createElement("span");
                        contentSpan.textContent = messageText;
                        message.appendChild(contentSpan);
                    }
                } else {
                    // 非詩句事件，直接顯示內容
                    const contentSpan = document.createElement("span");
                    contentSpan.textContent = messageText;
                    message.appendChild(contentSpan);
                }
                
                historyMessages.appendChild(message);
            });
            
            // 顯示模態窗
            historyModal.classList.add("active");
        }
        
        // 顯示歷史記錄窗口
        function showHistoryModal() {
            const historyModal = document.getElementById("history-modal");
            const historyMessages = document.getElementById("history-messages");
            
            // 清空歷史消息容器
            historyMessages.innerHTML = "";
            
            // 填充所有歷史消息
            const allMessages = [...gameState.messages];
            
            allMessages.forEach(msgData => {
                const message = document.createElement("div");
                message.className = "message-item mb-3";
                
                // 獲取消息文本、日期和季節
                let messageText = typeof msgData === 'string' ? msgData : msgData.text;
                let messageDate = typeof msgData === 'string' ? "" : msgData.date;
                let season = typeof msgData === 'string' ? gameState.currentSeason : msgData.season;
                
                // 檢查是否獲得詩句 - 直接使用isPoem標記
                const isPoem = typeof msgData === 'string' ? false : msgData.isPoem;
                
                if (isPoem) {
                    message.classList.add("border-l-4", "border-amber-300", "bg-amber-50/30", "dark:bg-amber-900/20", "py-3", "px-3", "rounded-r");
                }
                
                // 為季節變化使用不同樣式
                if (messageText.includes('，時光流轉，又是一季。')) {
                    message.classList.add("border-l-4", "border-primary-light");
                }
                
                // 創建日期和詩句標籤容器
                const headerDiv = document.createElement("div");
                headerDiv.className = "flex items-center mb-1";
                
                // 創建日期元素
                const dateSpan = document.createElement("span");
                dateSpan.className = "text-xs font-medium";
                
                // 為不同季節使用不同顏色
                if (season === 0) dateSpan.classList.add("text-green-600", "dark:text-green-400");
                if (season === 1) dateSpan.classList.add("text-amber-600", "dark:text-amber-400");
                if (season === 2) dateSpan.classList.add("text-red-600", "dark:text-red-400");
                if (season === 3) dateSpan.classList.add("text-blue-600", "dark:text-blue-400");
                
                dateSpan.textContent = messageDate || "";
                headerDiv.appendChild(dateSpan);
                
                // 如果是詩句收集事件，在時間後面添加詩句標籤
                if (isPoem) {
                    const poemBadge = document.createElement("div");
                    poemBadge.className = "inline-block px-2 py-0.5 bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-100 rounded text-xs font-semibold ml-2";
                    poemBadge.innerHTML = "📜 獲得詩句";
                    headerDiv.appendChild(poemBadge);
                }
                
                // 添加日期和標籤容器到消息中
                message.appendChild(headerDiv);
                
                // 顯示消息內容（無論是否為詩句事件）
                const contentSpan = document.createElement("span");
                contentSpan.textContent = messageText;
                message.appendChild(contentSpan);
                
                historyMessages.appendChild(message);
            });
            
            // 顯示模態窗
            historyModal.classList.add("active");
        }
        
        // 關閉歷史記錄視圖
        function closeHistoryView() {
            const historyModal = document.getElementById("history-modal");
            historyModal.classList.remove("active");
        }
        
        // 創建全局通知系統實例
        const notificationSystem = new NotificationSystem();
        
        // 初始化遊戲
        function initGame(characterType) {
            // 重置遊戲狀態
            gameState.characterType = characterType;
            gameState.character = gameData.characters[characterType];
            gameState.resources = {...gameState.character.startResources};
            gameState.emotion = 50;
            gameState.collectedPoems = [];
            gameState.currentSeason = 0;
            gameState.round = 1;
            gameState.maxRound = 36; // 確保回合數限制為36
            gameState.events = [];
            gameState.messages = [];
            gameState.lastAction = "";
            gameState.journalEntries = [];
            gameState.currentYear = 723; // 與gameState初始化一致
            gameState.currentMonth = 2;
            gameState.currentDay = 15;
            
            // 重置角色年齡
            gameState.wifeAge = 16;
            gameState.husbandAge = 17;
            gameState.yearProgress = 1; // 確保年進度也重置
            
            // 重置事件歷史記錄
            gameState.eventHistory = {
                recentEvents: [],
                eventCounts: {},
                lastRoundEvents: []
            };
            
            // 預初始化事件計數
            gameData.events.forEach(event => {
                gameState.eventHistory.eventCounts[event.id] = 0;
            });
            
            // 設置初始日記
            const seasonNames = ["春", "夏", "秋", "冬"];
            const currentAge = characterType === "wife" ? gameState.wifeAge : gameState.husbandAge;
            const chineseYear = `開元元年`;
            
            if (characterType === "wife") {
                gameState.journalEntries.push({
                    time: `${chineseYear} ${seasonNames[0]}`,
                    age: currentAge,
                    content: "妾今十六，郎君遠赴三巴經商。春日漸暖，長干里桃李爭艷，卻無人共賞。日日盼歸，夜夜思君。"
                });
            } else {
                gameState.journalEntries.push({
                    time: `${chineseYear} ${seasonNames[0]}`,
                    age: currentAge, 
                    content: "今春起程，離家赴三巴經商。商旅之路遙遙，行舟至今已經一月有餘。夜來風急，舟中冷寂，唯有思鄉心切。"
                });
            }
            
            // 更新界面
            updateCharacterInfo();
            updateResources();
            updatePoemFragments();
            updateGameScene();
            updateActions();
            updateSeasonIndicator();
            
            // 添加初始消息
            const startMsg = `開元元年(公元713年) ${seasonNames[0]}，${gameState.character.name}【${currentAge}歲】`;
            addMessage(startMsg);
            addMessage(`游戲開始！你正在扮演${gameState.character.name}。`);
            
            // 顯示教學提示
            showTutorial();
            
            // 生成初始事件
            generateEvents();
        }
        
        // 更新角色信息
        function updateCharacterInfo() {
            playerName.textContent = gameState.character.name;
            playerDescription.textContent = gameState.character.description;
            
            // 更新情感值
            emotionBar.style.width = `${gameState.emotion}%`;
        }
        
        // 資源映射表
        const resourceMappings = {
            rice: { name: "糧食", icon: "🌾" },
            silk: { name: "絲綢", icon: "🧵" },
            silver: { name: "銀兩", icon: "💰" },
            goods: { name: "貨物", icon: "📦" },
            food: { name: "口糧", icon: "🍚" }
        };
        
        // 更新資源
        function updateResources() {
            resourcesList.innerHTML = "";
            
            for (const [resource, amount] of Object.entries(gameState.resources)) {
                const mapping = resourceMappings[resource] || { 
                    name: resource, 
                    icon: "📊" 
                };
                
                const item = document.createElement("div");
                item.className = "resource-item";
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="resource-icon">${mapping.icon}</span>
                        <span class="resource-name">${mapping.name}</span>
                    </div>
                    <div class="resource-value">${amount}</div>
                `;
                
                resourcesList.appendChild(item);
            }
        }
        
        // 更新詩句收集
        function updatePoemFragments() {
            // 儲存已收集的詩句
            const collectedSet = new Set(gameState.collectedPoems);
            
            // 更新計數
            poemsCount.textContent = collectedSet.size;
            
            // 清空容器
            poemFragments.innerHTML = "";
            
            // 添加標題
            const header = document.createElement('div');
            header.innerHTML = `
                <div class="text-center font-bold text-lg mb-2">《長干行》</div>
                <div class="text-center text-sm text-gray-600 dark:text-gray-400 mb-4">唐·李白</div>
            `;
            poemFragments.appendChild(header);
            
            // 顯示每一行詩句
            for (const poem of gameData.poemFragments) {
                const isCollected = collectedSet.has(poem.id);
                
                const fragmentElement = document.createElement('div');
                
                if (isCollected) {
                    fragmentElement.className = "poem-fragment mb-3 cursor-pointer";
                    fragmentElement.textContent = poem.text;
                    fragmentElement.title = poem.note;
                    
                    // 設置事件監聽器
                    fragmentElement.addEventListener("click", () => {
                        showPoemNote(poem);
                    });
                } else {
                    fragmentElement.className = "poem-fragment-locked mb-3";
                    const placeholderText = Array.from(poem.text)
                        .map(char => /[，。\s]/.test(char) ? char : '□')
                        .join('');
                    fragmentElement.textContent = placeholderText;
                    fragmentElement.title = "尚未收集此詩句";
                }
                
                poemFragments.appendChild(fragmentElement);
            }
            
            // 沒有收集任何詩句時的提示
            if (collectedSet.size === 0) {
                const hintText = document.createElement('p');
                hintText.className = "text-center text-sm text-gray-500 dark:text-gray-400 mt-3 italic";
                hintText.textContent = "提示：通過選擇具有詩意的選項來收集詩句";
                poemFragments.appendChild(hintText);
            }
            
            // 進度顯示
            const progressSection = document.createElement('div');
            const progressPercentage = (collectedSet.size / gameData.poemFragments.length) * 100;
            
            progressSection.innerHTML = `
                <div class="mt-4 mb-2">
                    <div class="h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-amber-400 to-amber-600 rounded-full transition-all duration-500" 
                             style="width: ${progressPercentage}%"></div>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-500 dark:text-gray-400">
                    收集進度: ${collectedSet.size}/${gameData.poemFragments.length}
                </div>
            `;
            
            poemFragments.appendChild(progressSection);
        }
        
        // 顯示詩句註解
        function showPoemNote(poem) {
            eventModal.classList.add("active");
            
            // 隱藏選項容器，顯示詩句區域
            document.getElementById("choices-container").style.display = "none";
            
            // 設置事件標題
            const eventIcon = document.getElementById("event-icon");
            eventIcon.textContent = "📜";
            eventTitle.textContent = "詩句解釋";
            eventDescription.textContent = "";
            
            // 顯示詩句和解釋
            eventNote.classList.remove("hidden");
            eventNote.innerHTML = `
                <h4 class="font-bold mb-3 text-center text-lg">「${poem.text}」</h4>
                <div class="border-t border-b border-amber-200 dark:border-amber-800 py-3 my-3">
                    <p class="mb-1 leading-relaxed">${poem.note}</p>
                </div>
                <button id="close-poem-note" class="btn btn-secondary w-full mt-3">關閉</button>
            `;
            
            // 註冊關閉按鈕事件
            const closeBtn = document.getElementById("close-poem-note");
            closeBtn.addEventListener("click", () => {
                eventModal.classList.remove("active");
            });
        }
        
        // 場景位置配置
        const scenePositions = {
            wife: [
                { top: 15, left: 25 }, { top: 48, left: 70 }, { top: 55, left: 22 },
                { top: 30, left: 75 }, { top: 38, left: 40 }, { top: 22, left: 55 }
            ],
            husband: [
                { top: 28, left: 30 }, { top: 20, left: 68 }, { top: 45, left: 75 },
                { top: 40, left: 20 }, { top: 35, left: 50 }, { top: 15, left: 42 }
            ]
        };
        
        // 生成遊戲事件
        function generateEvents() {
            // 初始化事件歷史記錄
            if (!gameState.eventHistory) {
                gameState.eventHistory = {
                    recentEvents: [],
                    eventCounts: {},
                    lastRoundEvents: []
                };
            }
            
            // 更新事件追蹤
            gameState.events = [];
            
            // 保留最近事件歷史
            const maxHistoryLength = 6;
            gameState.eventHistory.recentEvents.push(...gameState.eventHistory.lastRoundEvents);
            
            // 限制歷史記錄長度
            if (gameState.eventHistory.recentEvents.length > maxHistoryLength) {
                gameState.eventHistory.recentEvents = gameState.eventHistory.recentEvents.slice(-maxHistoryLength);
            }
            
            gameState.eventHistory.lastRoundEvents = [];
            
            // 獲取已收集的詩句ID，用於過濾事件
            const collectedPoemIds = new Set(gameState.collectedPoems);
            const currentSeason = gameState.currentSeason;
            const characterType = gameState.characterType;
            const lastAction = gameState.lastAction;
            const currentRound = gameState.round;
            
            // 输出游戏状态以便调试
            console.log(`当前年份进度: ${gameState.yearProgress}, 当前季节: ${currentSeason}, 回合: ${currentRound}`);
            
            // 篩選可能事件
            const possibleEvents = gameData.events.filter(event => {
                // 基本條件：匹配角色類型和季節
                if (event.forCharacter !== characterType || !event.season.includes(currentSeason)) {
                    return false;
                }
                
                // 年份篩選：如果事件指定了年份，確保匹配當前年份
                if (event.year && event.year !== gameState.yearProgress) {
                    // 调试输出不符合年份要求的事件
                    console.log(`事件 ${event.id} 被年份限制过滤掉: 事件年份=${event.year}, 当前年份=${gameState.yearProgress}`);
                    return false;
                }
                
                // 年份范圍篩選：如果事件指定了年份范圍，確保當前年份在范圍內
                if (event.yearRange && (gameState.yearProgress < event.yearRange[0] || 
                    gameState.yearProgress > event.yearRange[1])) {
                    return false;
                }
                
                // 檢查是否包含已收集的詩句
                for (const choice of event.choices) {
                    if (choice.effect && choice.effect.poemFragment && 
                        collectedPoemIds.has(choice.effect.poemFragment)) {
                        // 调试输出被过滤的已收集诗句
                        console.log(`事件 ${event.id} 被过滤掉，因为诗句 ${choice.effect.poemFragment} 已被收集`);
                        return false;
                    }
                }
                
                // 避免最近出現的事件再次出現
                if (gameState.eventHistory.recentEvents.includes(event.id)) {
                    return false;
                }
                
                return true;
            });
            
            // 调试输出可能的事件
            console.log("可能出现的事件:", possibleEvents.map(e => `${e.id} (年份:${e.year || '未指定'})`).join(', '));
            
            if (possibleEvents.length === 0) {
                return;
            }
            
            // 獲取上一個執行的動作的詳細信息
            let lastActionObj = null;
            if (lastAction) {
                lastActionObj = gameState.character.actions.find(a => a.id === lastAction);
            }
            
            // 計算每個事件的權重
            const weightedEvents = possibleEvents.map(event => {
                const count = gameState.eventHistory.eventCounts[event.id] || 0;
                let weight = 10 - count * 2;
                
                // 確認事件是否解鎖詩句
                const unlocksPoemFragment = event.choices && event.choices.some(choice => 
                    choice.effect && choice.effect.poemFragment);
                
                // 確認事件是否可能移除詩句
                const canRemovePoemFragment = event.choices && event.choices.some(choice => 
                    choice.effect && choice.effect.removePoemFragment);
                
                // 根據事件類型和相關動作增加權重
                if (lastAction && event.relatedActions && event.relatedActions.includes(lastAction)) {
                    weight += 4;
                    
                    // 檢查上一個動作是否為詩意動作，對解鎖詩句的事件給予額外加權
                    if (lastActionObj && unlocksPoemFragment) {
                        // 詩意動作有更高概率觸發解鎖詩句的事件
                        if (lastActionObj.type === "poetic") {
                            weight += 12; // 增加詩意動作觸發詩句機率
                            console.log(`詩意動作 ${lastAction} 增加詩句事件 ${event.id} 權重+12`);
                        } 
                        // 務實動作有極低概率觸發解鎖詩句的事件
                        else if (lastActionObj.type === "practical") {
                            weight -= 6; // 大幅降低務實動作觸發詩句機率
                            console.log(`務實動作 ${lastAction} 減少詩句事件 ${event.id} 權重-6`);
                        }
                    }
                }
                
                // 使用動作中定義的eventChance屬性來進一步調整權重
                if (lastActionObj && lastActionObj.effect && lastActionObj.effect.eventChance) {
                    // 詩意動作的eventChance值更高，進一步增加觸發詩句事件機率
                    const eventChanceBonus = lastActionObj.effect.eventChance / 10;
                    weight += eventChanceBonus;
                    console.log(`根據動作 ${lastAction} 的eventChance增加權重+${eventChanceBonus}`);
                }
                
                // 特殊事件類型權重調整
                if (event.isRare) {
                    weight = Math.random() < 0.1 ? 20 : 0;
                }
                
                if (event.isSpecial) {
                    weight += 3;
                }
                
                // 移除詩句事件的特殊權重調整
                if (canRemovePoemFragment) {
                    // 獲取當前收集的詩句數量
                    const poemCount = gameState.collectedPoems.length;
                    
                    // 如果詩句數量過少，大幅降低移除詩句事件的權重
                    if (poemCount < 3) {
                        weight -= 8;
                        console.log(`詩句數量(${poemCount})過少，降低移除詩句事件 ${event.id} 權重-8`);
                    } 
                    // 詩句數量適中時，適當降低權重
                    else if (poemCount < 6) {
                        weight -= 4;
                        console.log(`詩句數量(${poemCount})較少，降低移除詩句事件 ${event.id} 權重-4`);
                    }
                    // 詩句數量充足時，提高權重
                    else if (poemCount >= 8) {
                        weight += 3;
                        console.log(`詩句數量(${poemCount})充足，提高移除詩句事件 ${event.id} 權重+3`);
                    }
                    
                    // 確保移除詩句事件不會連續出現
                    const lastFewEvents = [...gameState.eventHistory.lastRoundEvents, ...gameState.eventHistory.recentEvents.slice(0, 2)];
                    const hadRecentRemoveEvent = lastFewEvents.some(id => {
                        const prevEvent = gameData.events.find(e => e.id === id);
                        return prevEvent && prevEvent.choices && prevEvent.choices.some(c => 
                            c.effect && c.effect.removePoemFragment);
                    });
                    
                    if (hadRecentRemoveEvent) {
                        weight -= 10; // 大幅降低連續出現的可能性
                        console.log(`最近已有移除詩句事件，降低事件 ${event.id} 權重-10`);
                    }
                    
                    // 第一年不出現移除詩句事件
                    if (gameState.yearProgress === 1) {
                        weight = 0;
                        console.log(`第一年不出現移除詩句事件，事件 ${event.id} 權重設為0`);
                    }
                }
                
                return { event, weight: Math.max(0, weight) };
            }).filter(item => item.weight > 0);
            
            // 選擇事件 - 修改为每次只生成1个事件
            const selectedEvents = [];
            const maxEvents = 1; // 修改为始终只选择1个事件
            
            for (let i = 0; i < maxEvents; i++) {
                // 計算總權重
                const totalWeight = weightedEvents.reduce((sum, item) => sum + item.weight, 0);
                
                if (totalWeight <= 0) break;
                
                // 隨機選擇一個事件
                let randomWeight = Math.random() * totalWeight;
                let runningWeight = 0;
                let selectedIndex = -1;
                
                for (let j = 0; j < weightedEvents.length; j++) {
                    runningWeight += weightedEvents[j].weight;
                    if (randomWeight <= runningWeight) {
                        selectedIndex = j;
                        break;
                    }
                }
                
                // 如果沒有選擇任何事件（罕見情況），選擇第一個
                if (selectedIndex === -1 && weightedEvents.length > 0) {
                    selectedIndex = 0;
                }
                
                if (selectedIndex >= 0) {
                    const selectedEvent = weightedEvents[selectedIndex].event;
                    selectedEvents.push(selectedEvent);
                    
                    // 调试输出选中的事件
                    console.log(`选中事件: ${selectedEvent.id}, 年份限制: ${selectedEvent.year || '无'}`);
                    
                    // 更新事件歷史記錄
                    gameState.eventHistory.lastRoundEvents.push(selectedEvent.id);
                    gameState.eventHistory.eventCounts[selectedEvent.id] = 
                        (gameState.eventHistory.eventCounts[selectedEvent.id] || 0) + 1;
                    
                    // 從可選事件中移除已選事件
                    weightedEvents.splice(selectedIndex, 1);
                }
            }
            
            // 將選中的事件添加到游戲狀態
            gameState.events = selectedEvents;
            
            // 更新场景
            updateGameScene();
        }
        
        // 更新遊戲場景
        function updateGameScene() {
            // 設置季節相關背景
            const seasonClassMap = ["spring", "summer", "autumn", "winter"];
            const currentSeason = gameState.currentSeason;
            const seasonClass = seasonClassMap[currentSeason];
            
            // 清空場景
            gameScene.innerHTML = "";
            
            // 設置角色特定場景
            const characterType = gameState.characterType;
            gameScene.className = `scene-bg scene-${seasonClass} scene-${characterType}`;
            
            // 添加季節標記
            const seasonMarker = document.createElement("div");
            seasonMarker.className = `season-marker ${seasonClass}`;
            seasonMarker.textContent = gameData.seasons[currentSeason];
            gameScene.appendChild(seasonMarker);
            
            // 添加日期顯示
            const lunarMonth = convertToChinese(gameState.currentMonth) + "月";
            const lunarDay = getLunarDayName(gameState.currentDay);
            
            const dateDisplay = document.createElement("div");
            dateDisplay.className = "date-display";
            dateDisplay.textContent = `${lunarMonth}${lunarDay}`;
            gameScene.appendChild(dateDisplay);
            
            // 添加天氣粒子效果容器
            const weatherContainer = document.createElement("div");
            weatherContainer.className = "weather-container";
            gameScene.appendChild(weatherContainer);
            
            // 添加角色特定場景元素
            if (characterType === "wife") {
                // 為妻子視角添加長干里的地面
                const ground = document.createElement("div");
                ground.className = "ground-wife";
                gameScene.appendChild(ground);
                
                // 添加季節特色地面元素
                addSeasonGroundElements(currentSeason, gameScene);
                
                // 添加房屋
                const house = document.createElement("div");
                house.className = "house";
                
                const houseWall = document.createElement("div");
                houseWall.className = "house-wall";
                house.appendChild(houseWall);
                
                const houseRoof = document.createElement("div");
                houseRoof.className = "house-roof";
                house.appendChild(houseRoof);
                
                const houseDoor = document.createElement("div");
                houseDoor.className = "house-door";
                house.appendChild(houseDoor);
                
                const houseWindowLeft = document.createElement("div");
                houseWindowLeft.className = "house-window";
                house.appendChild(houseWindowLeft);
                
                const houseWindowRight = document.createElement("div");
                houseWindowRight.className = "house-window right";
                house.appendChild(houseWindowRight);
                
                gameScene.appendChild(house);
                
                // 添加生活場景元素
                addLifeElements(currentSeason, gameScene, characterType);
                
                // 添加青梅樹
                const plumTree = document.createElement("div");
                plumTree.className = "plum-tree";
                
                const treeTrunk = document.createElement("div");
                treeTrunk.className = "tree-trunk";
                plumTree.appendChild(treeTrunk);
                
                const treeBranches = document.createElement("div");
                treeBranches.className = "tree-branches";
                plumTree.appendChild(treeBranches);
                
                gameScene.appendChild(plumTree);
                
                // 添加青梅果實 (春天和夏天)
                if (currentSeason === 0 || currentSeason === 1) {
                    for (let i = 0; i < 12; i++) {
                        const plumFruit = document.createElement("div");
                        plumFruit.className = "plum-fruit";
                        plumFruit.style.right = `${170 + Math.random() * 80}px`;
                        plumFruit.style.bottom = `${140 + Math.random() * 50}px`;
                        gameScene.appendChild(plumFruit);
                    }
                }
                
                // 添加太陽
                const sun = document.createElement("div");
                sun.className = "sun";
                gameScene.appendChild(sun);
                
                // 添加流動的雲朵
                const cloudCount = 3;
                const cloudTypes = ['small', 'medium', 'large'];
                
                for (let i = 0; i < cloudCount; i++) {
                    const cloud = document.createElement("div");
                    cloud.className = `cloud ${cloudTypes[i % cloudTypes.length]}`;
                    
                    // 設置雲的位置和動畫延遲
                    cloud.style.top = `${20 + Math.random() * 50}px`;
                    cloud.style.animationDelay = `${Math.random() * 15}s`;
                    
                    gameScene.appendChild(cloud);
                }
            
            } else if (characterType === "husband") {
                // 為丈夫視角添加江水
                const water = document.createElement("div");
                water.className = "water-husband";
                gameScene.appendChild(water);
                
                // 添加季節特色水面元素
                addSeasonWaterElements(currentSeason, gameScene);
                
                // 添加三巴山景
                const mountains = document.createElement("div");
                mountains.className = "mountains";
                
                const leftMountain = document.createElement("div");
                leftMountain.className = "mountain left";
                mountains.appendChild(leftMountain);
                
                const rightMountain = document.createElement("div");
                rightMountain.className = "mountain right";
                mountains.appendChild(rightMountain);
                
                gameScene.appendChild(mountains);
                
                // 添加商船
                const boat = document.createElement("div");
                boat.className = "merchant-boat";
                
                const boatBody = document.createElement("div");
                boatBody.className = "boat-body";
                boat.appendChild(boatBody);
                
                const boatCabin = document.createElement("div");
                boatCabin.className = "boat-cabin";
                boat.appendChild(boatCabin);
                
                const boatSail = document.createElement("div");
                boatSail.className = "boat-sail";
                boat.appendChild(boatSail);
                
                gameScene.appendChild(boat);
                
                // 添加船上貨物和其他生活元素
                addLifeElements(currentSeason, gameScene, characterType);
            }
            
            // 添加所有事件標記
            gameState.events.forEach((event, index) => {
                // 決定事件標記的類型
                let markerClass = "event-marker";
                
                // 特殊事件類型
                if (event.isRare) {
                    markerClass += " rare-event-marker";
                } else if (event.isSpecial) {
                    markerClass += " special-event-marker";
                }
                
                // 創建事件標記
                const marker = document.createElement("div");
                marker.className = markerClass;
                marker.dataset.eventId = event.id;
                
                // 選擇位置
                const positions = scenePositions[gameState.characterType] || [];
                const pos = positions[index % positions.length];
                if (pos) {
                    marker.style.top = `${pos.top}%`;
                    marker.style.left = `${pos.left}%`;
                }
                
                // 添加事件標題
                const title = document.createElement("div");
                title.className = "event-title";
                
                let titleText = event.title;
                if (event.isRare) {
                    titleText += " ✧";
                } else if (event.isSpecial) {
                    titleText += " ☆";
                }
                
                title.textContent = titleText;
                marker.appendChild(title);
                
                // 添加點擊事件
                marker.addEventListener("click", () => {
                    showEventModal(event.id);
                });
                
                gameScene.appendChild(marker);
            });
            
            // 生成天氣效果
            generateWeatherEffects(weatherContainer, currentSeason);
        }
        
        // 添加季節特色地面元素
        function addSeasonGroundElements(season, container) {
            switch(season) {
                case 0: // 春季 - 添加草叢和小花
                    for (let i = 0; i < 15; i++) {
                        const grass = document.createElement("div");
                        grass.className = "grass";
                        grass.style.left = `${10 + Math.random() * 80}%`;
                        grass.style.height = `${12 + Math.random() * 8}px`;
                        grass.style.animationDelay = `${Math.random() * 3}s`;
                        container.appendChild(grass);
                        
                        // 隨機添加一些小花
                        if (Math.random() > 0.7) {
                            const flower = document.createElement("div");
                            flower.className = "spring-flower";
                            flower.style.bottom = `${50 + Math.random() * 10}px`; // 提高小花的位置
                            flower.style.left = grass.style.left;
                            container.appendChild(flower);
                        }
                    }
                    break;
                    
                case 2: // 秋季 - 添加落葉
                    for (let i = 0; i < 6; i++) {
                        const leaf = document.createElement("div");
                        leaf.className = "fallen-leaf";
                        leaf.style.bottom = `${40 + Math.random() * 3}px`; // 修正為與地面高度一致，略微上浮1-3px
                        leaf.style.left = `${Math.random() * 100}%`;
                        leaf.style.transform = `rotate(${Math.random() * 360}deg)`;
                        container.appendChild(leaf);
                    }
                    break;
                    
                case 3: // 冬季 - 添加薄雪覆蓋
                    for (let i = 0; i < 4; i++) {
                        const snowPile = document.createElement("div");
                        snowPile.className = "snow-pile";
                        snowPile.style.left = `${Math.random() * 90}%`;
                        snowPile.style.width = `${20 + Math.random() * 50}px`;
                        // 修正霜雪位置，確保雪堆不會懸空
                        snowPile.style.bottom = "40px"; // 與地面高度一致
                        container.appendChild(snowPile);
                    }
                    break;
            }
        }
        
        // 添加季節特色水面元素
        function addSeasonWaterElements(season, container) {
            switch(season) {
                case 0: // 春季 - 添加水中倒影和飛鳥
                    for (let i = 0; i < 2; i++) {
                        const reflection = document.createElement("div");
                        reflection.className = "life-element";
                        reflection.style.bottom = `${10 + Math.random() * 30}px`;
                        reflection.style.left = `${30 + Math.random() * 50}%`;
                        reflection.style.width = `${30 + Math.random() * 20}px`;
                        reflection.style.height = `${2 + Math.random() * 3}px`;
                        reflection.style.backgroundColor = "rgba(255, 255, 255, 0.4)";
                        reflection.style.borderRadius = "50%";
                        container.appendChild(reflection);
                    }
                    break;
                    
                case 1: // 夏季 - 添加水花
                    for (let i = 0; i < 3; i++) {
                        const splash = document.createElement("div");
                        splash.className = "life-element";
                        splash.style.bottom = `${20 + Math.random() * 40}px`;
                        splash.style.left = `${Math.random() * 90}%`;
                        splash.style.width = "8px";
                        splash.style.height = "8px";
                        splash.style.backgroundColor = "rgba(255, 255, 255, 0.7)";
                        splash.style.borderRadius = "50%";
                        container.appendChild(splash);
                    }
                    break;
                    
                case 3: // 冬季 - 添加冰塊
                    for (let i = 0; i < 4; i++) {
                        const ice = document.createElement("div");
                        ice.className = "life-element";
                        ice.style.bottom = `${30 + Math.random() * 50}px`;
                        ice.style.left = `${Math.random() * 80}%`;
                        ice.style.width = `${15 + Math.random() * 25}px`;
                        ice.style.height = `${Math.random() * 5 + 3}px`;
                        ice.style.backgroundColor = "rgba(220, 240, 255, 0.6)";
                        ice.style.borderRadius = "4px";
                        container.appendChild(ice);
                    }
                    break;
            }
        }
        
        // 添加生活場景元素
        function addLifeElements(season, container, characterType) {
            if (characterType === "wife") {
                // 添加晾曬的衣物 (春季和夏季)
                if (season === 0 || season === 1) {
                    // 添加晾衣竿（木杆）- 底部已調整至40px與地面齊平
                    const clothesPost1 = document.createElement("div");
                    clothesPost1.className = "life-element";
                    clothesPost1.style.bottom = "40px";
                    clothesPost1.style.left = "40px";
                    clothesPost1.style.width = "6px";
                    clothesPost1.style.height = "50px";
                    clothesPost1.style.backgroundColor = "#8D6E63";
                    clothesPost1.style.zIndex = "3";
                    container.appendChild(clothesPost1);
                    
                    const clothesPost2 = document.createElement("div");
                    clothesPost2.className = "life-element";
                    clothesPost2.style.bottom = "40px";
                    clothesPost2.style.left = "120px";
                    clothesPost2.style.width = "6px";
                    clothesPost2.style.height = "50px";
                    clothesPost2.style.backgroundColor = "#8D6E63";
                    clothesPost2.style.zIndex = "3";
                    container.appendChild(clothesPost2);
                    
                    const clothesLine = document.createElement("div");
                    clothesLine.className = "clothes-line";
                    clothesLine.style.bottom = "83px"; // 調整晾衣繩高度為83px(原來75px)
                    clothesLine.style.left = "43px";
                    clothesLine.style.width = "80px";
                    container.appendChild(clothesLine);
                    
                    for (let i = 0; i < 3; i++) {
                        const cloth = document.createElement("div");
                        cloth.className = "hanging-cloth";
                        cloth.style.bottom = "63px"; // 相應調整衣服高度(原來55px)
                        cloth.style.left = `${50 + i * 25}px`;
                        
                        // 季節特色顏色
                        const colors = season === 0 ? 
                            ["#E0F2F1", "#E8F5E9", "#F1F8E9"] : 
                            ["#FFECB3", "#FFCCBC", "#FFE0B2"];
                        cloth.style.backgroundColor = colors[i % colors.length];
                        
                        container.appendChild(cloth);
                    }
                }
                
                // 添加籠中鳥 (秋季和冬季)
                if (season === 2 || season === 3) {
                    const birdCage = document.createElement("div");
                    birdCage.className = "bird-cage";
                    birdCage.style.top = "110px";
                    birdCage.style.right = "30px";
                    
                    // 籠中的小鳥
                    const bird = document.createElement("div");
                    bird.style.position = "absolute";
                    bird.style.width = "10px";
                    bird.style.height = "10px";
                    bird.style.borderRadius = "50% 50% 30% 30%";
                    bird.style.backgroundColor = season === 2 ? "#F57C00" : "#78909C";
                    bird.style.left = "50%";
                    bird.style.bottom = "10px";
                    bird.style.transform = "translateX(-50%)";
                    
                    birdCage.appendChild(bird);
                    container.appendChild(birdCage);
                }
                
            } else if (characterType === "husband") {
                // 添加船上貨物
                const cargoCount = 2 + Math.floor(Math.random() * 3);
                for (let i = 0; i < cargoCount; i++) {
                    const cargo = document.createElement("div");
                    cargo.className = "cargo-box";
                    cargo.style.bottom = "30px"; 
                    cargo.style.left = `${40 + i * 25}px`;
                    
                    // 季節特色貨物顏色
                    const colors = [
                        ["#A5D6A7", "#81C784", "#66BB6A"], // 春
                        ["#FFB74D", "#FFA726", "#FF9800"], // 夏
                        ["#A1887F", "#8D6E63", "#795548"], // 秋
                        ["#90A4AE", "#78909C", "#607D8B"]  // 冬
                    ];
                    cargo.style.backgroundColor = colors[season][i % 3];
                    cargo.style.height = `${10 + Math.random() * 10}px`;
                    
                    container.appendChild(cargo);
                }
                
                // 夏季和秋季添加捕撈網
                if (season === 1 || season === 2) {
                    const fishNet = document.createElement("div");
                    fishNet.className = "life-element";
                    fishNet.style.width = "15px";
                    fishNet.style.height = "30px";
                    fishNet.style.border = "1px solid #D7CCC8";
                    fishNet.style.borderRadius = "0 0 40% 40%";
                    fishNet.style.borderTop = "none";
                    fishNet.style.bottom = "30px";
                    fishNet.style.left = "15px";
                    
                    // 添加網線
                    for (let i = 0; i < 2; i++) {
                        const netLine = document.createElement("div");
                        netLine.style.position = "absolute";
                        netLine.style.top = `${i * 10 + 5}px`;
                        netLine.style.width = "100%";
                        netLine.style.height = "1px";
                        netLine.style.backgroundColor = "#D7CCC8";
                        fishNet.appendChild(netLine);
                    }
                    
                    container.appendChild(fishNet);
                }
            }
        }
        
        // 生成天氣效果
        function generateWeatherEffects(container, season) {
            // 清空容器
            container.innerHTML = "";
            
            // 基於容器大小計算粒子數量
            const containerWidth = container.clientWidth || 300;
            const containerHeight = container.clientHeight || 200;
            const particleCount = Math.min(30, Math.floor((containerWidth * containerHeight) / 6000));
            
            // 根據季節生成不同的天氣效果
            switch(season) {
                case 0: // 春 - 花瓣
                    for (let i = 0; i < particleCount; i++) {
                        const petal = document.createElement("div");
                        petal.className = "weather-particle";
                        
                        // 隨機位置和大小
                        const left = Math.random() * 100;
                        const size = 8 + Math.random() * 7;
                        const delay = Math.random() * 10;
                        const duration = 8 + Math.random() * 7;
                        
                        // 設置樣式
                        petal.style.cssText = `
                            top: -10%;
                            left: ${left}%;
                            width: ${size}px;
                            height: ${size}px;
                            background-color: #ffccd5;
                            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
                            animation: fall-rotate ${duration}s linear infinite ${delay}s;
                        `;
                        
                        container.appendChild(petal);
                    }
                    break;
                    
                case 1: // 夏 - 雨滴
                    for (let i = 0; i < particleCount * 3; i++) {
                        const raindrop = document.createElement("div");
                        raindrop.className = "weather-particle";
                        
                        // 隨機位置和大小
                        const left = Math.random() * 100;
                        const speed = 0.5 + Math.random() * 0.8;
                        const delay = Math.random() * 1;
                        
                        // 設置樣式
                        raindrop.style.cssText = `
                            top: -10%;
                            left: ${left}%;
                            width: 2px;
                            height: 15px;
                            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.6));
                            animation: rain-fall ${speed}s linear infinite ${delay}s;
                        `;
                        
                        container.appendChild(raindrop);
                    }
                    break;
                    
                case 2: // 秋 - 落葉
                    for (let i = 0; i < particleCount; i++) {
                        const leaf = document.createElement("div");
                        leaf.className = "weather-particle";
                        
                        // 隨機位置和大小
                        const left = Math.random() * 100;
                        const size = 10 + Math.random() * 5;
                        const delay = Math.random() * 10;
                        const duration = 10 + Math.random() * 5;
                        
                        // 隨機顏色
                        const colors = ['#e2725b', '#e28743', '#e2c458'];
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        // 設置樣式
                        leaf.style.cssText = `
                            top: -10%;
                            left: ${left}%;
                            width: ${size}px;
                            height: ${size}px;
                            background-color: ${color};
                            clip-path: polygon(50% 0%, 75% 25%, 100% 50%, 75% 75%, 50% 100%, 25% 75%, 0% 50%, 25% 25%);
                            animation: leaf-fall ${duration}s ease-in-out infinite ${delay}s;
                        `;
                        
                        container.appendChild(leaf);
                    }
                    break;
                    
                case 3: // 冬 - 雪花
                    for (let i = 0; i < particleCount * 2; i++) {
                        const snowflake = document.createElement("div");
                        snowflake.className = "weather-particle";
                        
                        // 隨機位置和大小
                        const left = Math.random() * 100;
                        const size = 4 + Math.random() * 4;
                        const delay = Math.random() * 10;
                        const duration = 12 + Math.random() * 8;
                        
                        // 設置樣式
                        snowflake.style.cssText = `
                            top: -10%;
                            left: ${left}%;
                            width: ${size}px;
                            height: ${size}px;
                            background-color: rgba(255, 255, 255, 0.8);
                            border-radius: 50%;
                            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
                            animation: snow-fall ${duration}s linear infinite ${delay}s;
                        `;
                        
                        container.appendChild(snowflake);
                    }
                    break;
            }
        }
        
        // 更新動作按鈕
        function updateActions() {
            actionButtons.innerHTML = "";
            
            // 不需要單獨的圖例 DIV，在後續的標題行中添加圖例
            
            // 檢查必要資源
            const riceOrFood = gameState.resources.rice || gameState.resources.food || 0;
            const silver = gameState.resources.silver || 0;
            const basicNeedsStatus = {
                food: riceOrFood < 10 ? 'critical' : riceOrFood < 20 ? 'warning' : 'good',
                money: silver < 5 ? 'critical' : silver < 15 ? 'warning' : 'good'
            };
            
            // 資源不足警告
            if (basicNeedsStatus.food === 'critical' || basicNeedsStatus.money === 'critical') {
                const warningDiv = document.createElement("div");
                warningDiv.className = "col-span-full bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-xs p-1 rounded-sm mb-2";
                let warningText = "⚠️ 生存危機：";
                if (basicNeedsStatus.food === 'critical') {
                    warningText += ` ${gameState.characterType === "wife" ? "糧食" : "口糧"}危急！`;
                }
                if (basicNeedsStatus.money === 'critical') {
                    warningText += ` 銀兩耗盡！`;
                }
                warningDiv.textContent = warningText;
                actionButtons.appendChild(warningDiv);
            }
            
            // 混合所有動作按鈕（不再分類）
            // 使用Grid布局直接展示所有按鈕
            const allActions = gameState.character.actions;
            
            // 按類型排序，務實動作在前，詩意動作在後
            allActions.sort((a, b) => {
                if (a.type === b.type) return 0;
                return a.type === "practical" ? -1 : 1;
            });
            
            // 添加所有動作按鈕
            allActions.forEach(action => {
                const button = createActionButton(action, basicNeedsStatus);
                actionButtons.appendChild(button);
            });
        }
        
        // 創建動作按鈕
        function createActionButton(action, basicNeedsStatus) {
            const button = document.createElement("button");
            button.className = `action-btn ${action.type}`;
            button.id = `action-${action.id}`;
            button.dataset.actionId = action.id;
            
            // 檢查資源是否足夠
            let insufficientResources = false;
            
            if (action.effect && action.effect.resources) {
                for (const [resource, amount] of Object.entries(action.effect.resources)) {
                    if (amount < 0) {
                        const currentAmount = gameState.resources[resource] || 0;
                        if (currentAmount + amount < 0) {
                            insufficientResources = true;
                            break;
                        }
                    }
                }
            }
            
            // 基本生存危機時禁用詩意動作
            const isBasicNeedCritical = (basicNeedsStatus.food === 'critical' || basicNeedsStatus.money === 'critical');
            const isDisabled = insufficientResources || (isBasicNeedCritical && action.type === "poetic");
            
            // 創建按鈕內容 - 更精簡的佈局
            let resourcesHTML = '<div class="flex flex-wrap justify-center gap-1 mt-1 text-xs">';
            
            if (action.effect && action.effect.resources) {
                for (const [resource, amount] of Object.entries(action.effect.resources)) {
                    if (amount === 0) continue;
                    
                    const resourceMapping = resourceMappings[resource] || { name: resource, icon: "📊" };
                    const iconClass = amount < 0 ? "text-red-300" : "text-green-300";
                    const sign = amount < 0 ? "-" : "+";
                    const absAmount = Math.abs(amount);
                    
                    resourcesHTML += `
                        <div class="py-0.5 ${iconClass} font-bold">
                            <span>${resourceMapping.icon}${sign}${absAmount}</span>
                        </div>
                    `;
                }
            }
            
            resourcesHTML += '</div>';
            
            button.innerHTML = `
                <div class="flex flex-col items-center justify-between h-full">
                    <div class="text-xl mb-0.5">${action.icon || '⚡'}</div>
                    <div class="font-bold text-xs">${action.name}</div>
                    ${resourcesHTML}
                </div>
            `;
            
            // 如果資源不足，添加禁用樣式
            if (isDisabled) {
                button.classList.add("opacity-50");
                button.disabled = true;
            } else {
                button.addEventListener("click", () => performAction(action.id));
            }
            
            return button;
        }
        
        // 執行動作
        function performAction(actionId) {
            const action = gameState.character.actions.find(a => a.id === actionId);
            if (!action) return;
            
            // 先檢查游戲是否已經結束，如果已經達到最大回合，就不執行任何動作
            if (gameState.round >= gameState.maxRound) {
                console.log("游戲已達最大回合，無法執行更多動作");
                // 強制觸發結束
                checkGameEnd();
                return;
            }
            
            // 記錄上一次執行的動作
            gameState.lastAction = actionId;
            
            // 顯示資源變化
            if (action.effect.resources) {
                Object.entries(action.effect.resources).forEach(([resource, amount]) => {
                    if (Math.abs(amount) > 0 && gameState.resources[resource] !== undefined) {
                        // 找到資源項目
                        const resourceItems = document.querySelectorAll('.resource-item');
                        let resourceElement = null;
                        
                        resourceItems.forEach(item => {
                            const resourceName = item.querySelector('.resource-name');
                            if (resourceName && resourceName.textContent === resourceMappings[resource].name) {
                                resourceElement = item;
                            }
                        });
                        
                        if (resourceElement) {
                            // 創建資源變化指示器
                            const indicator = document.createElement("div");
                            indicator.className = `resource-change-indicator ${amount > 0 ? 'increase' : 'decrease'}`;
                            indicator.textContent = amount > 0 ? `+${amount}` : `${amount}`;
                            resourceElement.appendChild(indicator);
                            
                            // 動畫結束後移除
                            setTimeout(() => {
                                if (indicator && indicator.parentNode) {
                                    indicator.parentNode.removeChild(indicator);
                                }
                            }, 2000);
                        }
                    }
                });
            }
            
            // 應用資源和情感變化
            if (action.effect.resources) {
                for (const [resource, amount] of Object.entries(action.effect.resources)) {
                    if (gameState.resources[resource] !== undefined) {
                        gameState.resources[resource] += amount;
                        
                        // 確保資源不會低於 0
                        if (gameState.resources[resource] < 0) {
                            gameState.resources[resource] = 0;
                        }
                        
                        // 為應急行動（不消耗資源的基礎行動）添加小額隨機效果以增加變化性
                        if (action.emergency && amount > 0) {
                            // 添加 -1 到 +2 的隨機值
                            const randomBonus = Math.floor(Math.random() * 4) - 1;
                            gameState.resources[resource] += randomBonus;
                        }
                    }
                }
            }
            
            if (action.effect.emotion) {
                // 應用基本情感變化
                gameState.emotion += action.effect.emotion;
                
                // 基於當前資源狀況調整情感值
                // 當基本生存資源低時，情感下降更快；當資源豐富時，情感提升更容易
                const riceOrFood = gameState.resources.rice || gameState.resources.food || 0;
                const emotionModifier = riceOrFood < 10 ? -2 : (riceOrFood > 40 ? 2 : 0);
                gameState.emotion += emotionModifier;
                
                // 確保情感值在 0-100 範圍內
                if (gameState.emotion < 0) gameState.emotion = 0;
                if (gameState.emotion > 100) gameState.emotion = 100;
            }
            
            // 添加動作消息 - 根據角色身份和動作類型生成優美古風的描述
            let actionMsg;
            const isWife = gameState.characterType === "wife";
            
            // 為每個動作ID定制優美的描述
            const actionDescriptions = {
                // 妻子的務實動作
                "manage-home": isWife ? "晨起整理閨閣，庭院焚香，諸事井然。" : "",
                "market": isWife ? "攜竹籃入市，精挑細選家中所需，與坊間婦人閒話家常。" : "",
                "weaving": isWife ? "於織機前凝神專注，梭影穿梭，彩線成錦，盼織得美服贈君歸來。" : "",
                "visit-neighbors": isWife ? "拜訪鄰里，攜茶點相贈，閒話家常，打探商旅動向。" : "",
                "sell-textiles": isWife ? "攜織物前往集市，與坊間商賈討價還價，換得銀兩貼補家用。" : "",
                
                // 妻子的詩意動作
                "write-poem": isWife ? "於窗前揮毫潑墨，字字皆是對遠方伊人的思念。" : "",
                "pray": isWife ? "於佛前燃香祝禱，祈願良人平安歸來，夫妻團圓。" : "",
                "garden-poetry": isWife ? "於庭院中尋芳摘葉，每一朵花開都讓思念更深一分。" : "",
                "moon-gazing": isWife ? "月上柳梢，憑欄遠望，明月千里，共照良人可安好？" : "",
                "teach-children": isWife ? "聚鄰里幼童於庭前，授以詩書，傳承古賢智慧。" : "",
                
                // 丈夫的務實動作
                "navigate": !isWife ? "把舵揚帆，駕舟沿江而行，躲避驚濤駭浪。" : "",
                "trade": !isWife ? "攜貨物穿梭於市井之間，與商賈討價還價，謀求厚利。" : "",
                "scout": !isWife ? "登高望遠，探察水路情況，尋覓安全通道。" : "",
                "repair-boat": !isWife ? "仔細檢查船隻，補漏修篙，確保一路無虞。" : "",
                "visit-officials": !isWife ? "攜禮品拜訪當地官吏，談笑風生，以求順利通關。" : "",
                
                // 丈夫的詩意動作
                "write-letter": !isWife ? "就著船頭燈火，提筆寄書家中，傾訴離愁別緒。" : "",
                "rest": !isWife ? "歇息客棧，枕上思量家中妻子，一夜難眠。" : "",
                "network": !isWife ? "與同路商旅把盞論交，互通行商秘訣，結下深厚情誼。" : "",
                "buy-gifts": !isWife ? "於市集尋找珍奇之物，欲攜回饋贈家人，聊表相思之情。" : "",
                "observe-scenery": !isWife ? "登高望遠，山川入目，思念化作千般情愫盈於胸臆。" : ""
            };
            
            // 獲取自定義描述，如果沒有則用備用描述
            const customDescription = actionDescriptions[action.id];
            
            if (customDescription) {
                actionMsg = customDescription;
            } else if (action.type === "practical") {
                // 通用務實動作備用描述
                actionMsg = isWife ? 
                    `持家有道，${action.desc}，靜待君歸。` : 
                    `商旅途中，${action.desc}，思念家鄉。`;
            } else {
                // 通用詩意動作備用描述
                actionMsg = isWife ? 
                    `獨坐閨中，${action.desc}，寄情詩句，盼望夫君早日歸來。` : 
                    `客居他鄉，${action.desc}，遙想家中妻子，思緒萬千。`;
            }
            
            addMessage(actionMsg);
            
            // 推進回合
            advanceRound();
            
            // 更新界面
            updateResources();
            updateCharacterInfo();
            updateGameScene();
            updateActions();
            updateSeasonIndicator();
            
            // 檢查游戲結束條件，現在手動處理返回值
            const shouldEndGame = checkGameEnd();
            if (shouldEndGame) {
                console.log("游戲檢測到應該結束，禁用所有動作");
                // 禁用所有動作按鈕
                const allButtons = document.querySelectorAll('.action-btn');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add("opacity-50");
                });
            }
        }
        
        // 顯示事件模態窗
        function showEventModal(eventId) {
            // 找到事件
            const event = gameState.events.find(e => e.id === eventId);
            if (!event) return;
            
            // 顯示選項區域，隱藏詩句區域
            document.getElementById("choices-container").style.display = "block";
            eventNote.classList.add("hidden");
            
            // 設置標題和描述
            eventTitle.textContent = event.title;
            eventDescription.textContent = event.description;
            
            // 決定事件圖標
            let iconEmoji = "📜";
            if (event.isRare) {
                iconEmoji = "✨";
            } else if (event.isSpecial) {
                iconEmoji = "🎭";
            } else if (event.id.includes("butterfly")) {
                iconEmoji = "🦋";
            } else if (event.id.includes("footprints")) {
                iconEmoji = "👣";
            } else if (event.id.includes("wedding")) {
                iconEmoji = "💍";
            } else if (event.id.includes("moon")) {
                iconEmoji = "🌙";
            } else if (event.id.includes("market")) {
                iconEmoji = "🛒";
            } else if (event.id.includes("childhood")) {
                iconEmoji = "👶";
            }
            
            // 設置圖標
            const eventIcon = document.getElementById("event-icon");
            eventIcon.textContent = iconEmoji;
            
            // 生成選項按鈕
            eventOptions.innerHTML = "";
            
            // 檢查事件是否有選項
            if (!event.choices || event.choices.length === 0) {
                // 添加一個默認選項
                event.choices = [{
                    text: "繼續",
                    effect: {
                        message: "你繼續你的旅程。"
                    }
                }];
            }
            
            // 使用單欄布局
            eventOptions.className = "mb-5 grid grid-cols-1 gap-4";
            
            // 創建選項的副本，這樣不會修改原始數據
            const shuffledChoices = [...event.choices];
            
            // 使用 Fisher-Yates 洗牌算法對選項進行隨機排序
            for (let i = shuffledChoices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledChoices[i], shuffledChoices[j]] = [shuffledChoices[j], shuffledChoices[i]];
            }
            
            // 創建映射以追蹤原始索引
            const indexMap = shuffledChoices.map(choice => event.choices.indexOf(choice));
            
            // 生成隨機排序後的選項按鈕
            shuffledChoices.forEach((choice, shuffledIndex) => {
                const option = document.createElement("button");
                const originalIndex = indexMap[shuffledIndex]; // 獲取原始索引
                
                // 確保選項有完整的結構
                if (!choice.effect) choice.effect = {};
                
                // 統一所有選項的基本樣式，不再區分詩意/非詩意選項的外觀
                option.className = "choice-option";
                
                // 統一字體粗細，使用相同的粗細值
                option.style.fontWeight = "500";
                
                option.innerHTML = `<span class="block">${choice.text}</span>`;
                
                // 設置點擊事件，使用原始索引
                option.addEventListener("click", () => {
                    makeChoice(eventId, originalIndex);
                });
                
                eventOptions.appendChild(option);
            });
            
            // 顯示模態窗
            eventModal.classList.add("active");
        }
        
        // 玩家選擇
        function makeChoice(eventId, choiceIndex) {
            const eventIndex = gameState.events.findIndex(e => e.id === eventId);
            if (eventIndex === -1) return;
            
            const event = gameState.events[eventIndex];
            const choice = event.choices[choiceIndex];
            
            // 應用效果
            if (choice.effect.resources) {
                for (const [resource, amount] of Object.entries(choice.effect.resources)) {
                    if (gameState.resources[resource] !== undefined) {
                        gameState.resources[resource] += amount;
                        if (gameState.resources[resource] < 0) gameState.resources[resource] = 0;
                    }
                }
            }
            
            if (choice.effect.emotion) {
                gameState.emotion += choice.effect.emotion;
                if (gameState.emotion < 0) gameState.emotion = 0;
                if (gameState.emotion > 100) gameState.emotion = 100;
            }
            
            // 檢查是否有特殊選擇需要記錄
            if (choice.effect.specialChoice) {
                // 確保特殊選擇數組已初始化
                if (!gameState.specialChoices) {
                    gameState.specialChoices = [];
                }
                // 記錄特殊選擇
                if (!gameState.specialChoices.includes(choice.effect.specialChoice)) {
                    gameState.specialChoices.push(choice.effect.specialChoice);
                    console.log(`特殊選擇已記錄: ${choice.effect.specialChoice}`);
                }
            }
            
            // 處理移除詩句的效果
            let removedPoemInfo = null;
            if (choice.effect.removePoemFragment) {
                console.log("處理移除詩句效果:", choice.effect.removePoemFragment);
                
                // 如果是字符串，表示移除特定詩句
                if (typeof choice.effect.removePoemFragment === 'string') {
                    const poemId = choice.effect.removePoemFragment;
                    const index = gameState.collectedPoems.indexOf(poemId);
                    
                    if (index > -1) {
                        // 找到對應詩句信息用於顯示
                        const poem = gameData.poemFragments.find(p => p.id === poemId);
                        if (poem) {
                            removedPoemInfo = {
                                type: 'specific',
                                text: poem.text,
                                id: poemId
                            };
                        }
                        
                        // 移除詩句
                        gameState.collectedPoems.splice(index, 1);
                        console.log(`已移除指定詩句: ${poemId}`);
                    }
                } 
                // 如果是數字，表示隨機移除指定數量的詩句
                else if (typeof choice.effect.removePoemFragment === 'number') {
                    const count = Math.min(choice.effect.removePoemFragment, gameState.collectedPoems.length);
                    const removedPoems = [];
                    
                    for (let i = 0; i < count; i++) {
                        if (gameState.collectedPoems.length > 0) {
                            const randomIndex = Math.floor(Math.random() * gameState.collectedPoems.length);
                            const removedId = gameState.collectedPoems[randomIndex];
                            const poem = gameData.poemFragments.find(p => p.id === removedId);
                            
                            if (poem) {
                                removedPoems.push({
                                    id: removedId,
                                    text: poem.text
                                });
                            }
                            
                            gameState.collectedPoems.splice(randomIndex, 1);
                        }
                    }
                    
                    if (removedPoems.length > 0) {
                        removedPoemInfo = {
                            type: 'random',
                            count: removedPoems.length,
                            poems: removedPoems
                        };
                        console.log(`已隨機移除 ${removedPoems.length} 首詩句:`, removedPoems);
                    }
                }
                
                // 更新詩句顯示
                updatePoemFragments();
            }
            
            // 獲取選擇的結果信息
            let resultMessage = choice.effect.message || "";
            
            // 添加消息到游戲記錄
            if (resultMessage) {
                // 檢查是否是詩句事件，如果是則設置isPoemEvent=true
                const isPoemEvent = choice.effect.poemFragment ? true : false;
                
                // 對於移除詩句事件，添加額外提示
                if (removedPoemInfo) {
                    // 創建一個特殊的詩句移除消息
                    let lossMessage = "";
                    
                    if (removedPoemInfo.type === 'specific') {
                        lossMessage = `【失去詩句】「${removedPoemInfo.text}」`;
                    } else if (removedPoemInfo.type === 'random') {
                        const lostTexts = removedPoemInfo.poems.map(p => `「${p.text}」`).join('、');
                        lossMessage = `【失去詩句】${lostTexts}`;
                    }
                    
                    // 添加原始消息和詩句失去消息
                    addMessage(resultMessage, isPoemEvent);
                    addMessage(lossMessage, false, true); // 第三個參數表示這是詩句移除消息
                } else {
                    // 一般消息
                    addMessage(resultMessage, isPoemEvent);
                }
            }
            
            // 更新狀態
            updateResources();
            updateCharacterInfo();
            
            // 檢查是否獲得詩句
            let poemCollected = false;
            if (choice.effect.poemFragment && !gameState.collectedPoems.includes(choice.effect.poemFragment)) {
                gameState.collectedPoems.push(choice.effect.poemFragment);
                updatePoemFragments();
                poemCollected = true;
                
                // 顯示詩句註釋和選擇結果
                const poem = gameData.poemFragments.find(p => p.id === choice.effect.poemFragment);
                if (poem) {
                    // 隱藏選項容器
                    document.getElementById("choices-container").style.display = "none";
                    
                    // 修改標題以顯示收集詩句
                    const eventIcon = document.getElementById("event-icon");
                    eventIcon.textContent = "📜";
                    eventTitle.textContent = "收集詩句";
                    eventDescription.textContent = "你獲得了一句珍貴的詩句！";
                    
                    // 顯示詩句和選擇結果
                    eventNote.classList.remove("hidden");
                    eventNote.innerHTML = `
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg mb-4 shadow-inner">
                            <p class="text-green-700 dark:text-green-200 leading-relaxed">${resultMessage}</p>
                        </div>
                        <div class="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg shadow-inner bounce-in">
                            <div class="flex items-center mb-3">
                                <div class="bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-100 px-2 py-0.5 rounded text-xs font-semibold mr-2">新詩句</div>
                                <div class="flex-1 h-0.5 bg-amber-200 dark:bg-amber-700 opacity-30"></div>
                            </div>
                            <h4 class="font-bold mb-3 text-center text-lg text-amber-800 dark:text-amber-200">「${poem.text}」</h4>
                            <div class="border-t border-b border-amber-200 dark:border-amber-800 py-3 my-3">
                                <p class="mb-1 leading-relaxed">${poem.note}</p>
                            </div>
                        </div>
                        <button id="close-event" class="btn btn-secondary w-full mt-5">繼續旅程</button>
                    `;
                    
                    // 設置關閉按鈕
                    const closeBtn = document.getElementById("close-event");
                    if (closeBtn) {
                        closeBtn.addEventListener("click", () => {
                            eventModal.classList.remove("active");
                            finishEvent(eventIndex);
                        });
                    }
                }
            } else {
                // 如果沒有收集詩句，顯示選擇結果並提供繼續按鈕
                // 隱藏選項容器
                document.getElementById("choices-container").style.display = "none";
                
                // 顯示選擇結果
                eventNote.classList.remove("hidden");
                
                // 創建基本的結果顯示
                let resultHTML = `
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg shadow-inner">
                        <h4 class="font-bold mb-2 text-center">你的選擇結果</h4>
                        <p class="leading-relaxed">${resultMessage}</p>
                    </div>
                `;
                
                // 添加詩句移除的視覺反饋
                if (removedPoemInfo) {
                    let poemLossHtml = `
                    <div class="mt-4 bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border-l-4 border-red-500 shadow-md bounce-in">
                        <div class="flex items-center mb-3">
                            <div class="bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-100 px-2 py-0.5 rounded text-xs font-semibold flex items-center mr-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                失去詩句
                            </div>
                            <div class="flex-1 h-0.5 bg-red-200 dark:bg-red-700 opacity-30"></div>
                        </div>`;
                    
                    if (removedPoemInfo.type === 'specific') {
                        poemLossHtml += `
                            <div class="border-b border-red-200 dark:border-red-700 pb-3 mb-3">
                                <p class="text-red-600 dark:text-red-300 font-medium">失去了珍貴的詩句：</p>
                            </div>
                            <div class="bg-white/50 dark:bg-black/20 p-3 rounded border border-red-200 dark:border-red-800">
                                <p class="text-red-800 dark:text-red-200 text-center font-medium">「${removedPoemInfo.text}」</p>
                            </div>`;
                    } else if (removedPoemInfo.type === 'random') {
                        poemLossHtml += `
                            <div class="border-b border-red-200 dark:border-red-700 pb-3 mb-3">
                                <p class="text-red-600 dark:text-red-300 font-medium">失去了 ${removedPoemInfo.count} 首珍貴的詩句：</p>
                            </div>
                            <div class="bg-white/50 dark:bg-black/20 p-3 rounded border border-red-200 dark:border-red-800 space-y-2">`;
                        
                        removedPoemInfo.poems.forEach(poem => {
                            poemLossHtml += `<p class="text-red-800 dark:text-red-200 text-center font-medium">「${poem.text}」</p>`;
                        });
                        
                        poemLossHtml += `</div>`;
                    }
                    
                    poemLossHtml += `</div>`;
                    resultHTML += poemLossHtml;
                }
                
                // 添加繼續按鈕
                resultHTML += `<button id="close-result" class="btn btn-secondary w-full mt-5">繼續旅程</button>`;
                
                eventNote.innerHTML = resultHTML;
                
                // 設置關閉按鈕
                const closeBtn = document.getElementById("close-result");
                if (closeBtn) {
                    closeBtn.addEventListener("click", () => {
                        eventModal.classList.remove("active");
                        finishEvent(eventIndex);
                    });
                }
            }
        }
        
        // 完成事件處理
        function finishEvent(eventIndex) {
            // 移除已處理的事件
            gameState.events.splice(eventIndex, 1);
            updateGameScene();
            
            // 再次確保詩句收集區域已更新
            updatePoemFragments();
            
            // 檢查游戲結束條件
            checkGameEnd();
        }
        
        // 每回合檢查情境提示
function checkContextualTips() {
    if (!gameState.seenTips) {
        gameState.seenTips = [];
    }
    
    for (const tip of contextualTips) {
        if (tip.condition(gameState) && !gameState.seenTips.includes(tip.id)) {
            // 處理動態內容替換
            let message = tip.message;
            
            // 替換模板變量
            if (tip.id === "final_year") {
                const poemCount = gameState.collectedPoems.length;
                message = message.replace("{poemCount}", poemCount);
            }
            
            // 顯示提示通知
            notificationSystem.show(
                "遊戲提示", 
                message, 
                tip.type, 
                8000
            );
            
            // 標記已顯示
            gameState.seenTips.push(tip.id);
            
            // 每次只顯示一個提示，避免提示過多
            break;
        }
    }
}

// 推進回合
function advanceRound() {
    gameState.round++;
    
    // 明確記錄回合進度
    console.log(`【回合進度】進入第 ${gameState.round}/${gameState.maxRound} 回合`);
    
    // 最大回合的主動檢查 - 如果達到最大回合，直接終止遊戲
    if (gameState.round >= gameState.maxRound) {
        console.log(`【最終回合】達到遊戲最大回合數 ${gameState.maxRound}，立即強制結束遊戲`);
        // 強制回合數等於最大值
        gameState.round = gameState.maxRound;
        
        // 直接調用強制結束，跳過其他流程
        directEndGame();
        
        // 提前返回，不執行後續邏輯
        return;
    }
    
    // 更新月份和日期 (每回合過一個月)
    gameState.currentMonth++;
    
    if (gameState.currentMonth > 12) {
        gameState.currentMonth = 1;
        gameState.currentYear++;
        gameState.yearProgress++;
        
        // 觸發年關事件
        if (gameState.yearProgress <= 3) {
            triggerYearEndEvent();
        }
    }
    
    // 重置天數為每月初一
    gameState.currentDay = 1;
    
    // 每3回合切換一個季節（每季3個月）
    if (gameState.round % 3 === 1 && gameState.round > 1) {
        gameState.currentSeason = (gameState.currentSeason + 1) % 4;
        
        // 添加季節變化消息
        const seasonNames = gameData.seasons;
        const yearDisplay = gameState.getYearDisplay();
        addSeasonChangeMessage(seasonNames[gameState.currentSeason], yearDisplay);
    }
    
    // 檢查情境提示
    checkContextualTips();
    
    // 生成新事件
    generateEvents();
    
    // 更新UI
    updateSeasonIndicator();
    updateGameScene();
    
    // 再次檢查回合進度（冗余檢查）
    // 這保證了即使前面的檢查失敗，這裡也會捕獲
    if (gameState.round >= gameState.maxRound) {
        console.log(`【冗余檢查】當前回合 ${gameState.round} >= 最大回合 ${gameState.maxRound}，觸發強制結束`);
        directEndGame();
    }
}

// 新增直接結束遊戲的函數，不依賴任何檢查，直接顯示結局
function directEndGame() {
    try {
        console.log("【直接結束】開始執行無條件強制結束流程");
        
        // 強制設置游戲狀態
        gameState.shouldEndGame = true;
        gameState.endGameTriggered = true;
        gameState.round = gameState.maxRound; // 確保回合數正確
        
        // 禁用所有動作按鈕
        const allButtons = document.querySelectorAll('.action-btn');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.classList.add("opacity-50");
        });
        
        // 關閉所有模態窗（除了結局窗口外）
        const modalWindows = document.querySelectorAll('.modal-container:not(#end-screen)');
        modalWindows.forEach(modal => {
            modal.classList.remove("active");
        });
        
        // 關閉教學視窗
        if (document.getElementById("tutorial")) {
            document.getElementById("tutorial").classList.add("hidden");
        }
        
        // 直接評估結局並顯示
        console.log("【直接結束】評估結局內容");
        const endingInfo = evaluateEnding();
        
        // 獲取結局窗口元素
        const endScreen = document.getElementById("end-screen");
        const endTitle = document.getElementById("end-title");
        const endDescription = document.getElementById("end-description");
        
        if (!endScreen || !endTitle || !endDescription) {
            console.error("【錯誤】結局窗口元素不存在，嘗試重新獲取或創建");
            throw new Error("找不到結局窗口元素");
        }
        
        // 設置結局標題
        endTitle.textContent = endingInfo.title;
        
        // 清空描述容器並準備應用打字機效果
        endDescription.innerHTML = '';
        
        // 將描述文本分割成段落
        const paragraphs = endingInfo.description.split('\n\n').filter(para => para.trim() !== '');
        
        // 創建一個用於存儲段落元素的數組
        const paraElements = [];
        
        // 為每個段落創建一個p元素
        paragraphs.forEach(() => {
            const p = document.createElement('p');
            p.className = 'mb-3';
            endDescription.appendChild(p);
            paraElements.push(p);
        });
        
        // 逐段應用打字機效果
        function typeNextParagraph(index = 0) {
            if (index >= paragraphs.length) return;
            
            const para = paragraphs[index];
            const paraElement = paraElements[index];
            
            // 一個段落結束後再開始下一個段落
            typewriterEffect(paraElement, para, 90, () => {
                setTimeout(() => {
                    typeNextParagraph(index + 1);
                }, 1000); // 增加段落間停頓時間到1秒
            });
        }
        
        // 開始打字效果
        typeNextParagraph();
        
        // 顯示詩句收集情況
        const allPoems = document.getElementById("all-poems");
        if (allPoems) {
            if (gameState.collectedPoems.length === 0) {
                allPoems.innerHTML = "<p class='italic text-gray-500'>你沒有收集到任何詩句。</p>";
            } else {
                // 按順序排列詩句
                const sortedPoemIds = [...gameState.collectedPoems].sort((a, b) => {
                    const numA = parseInt(a.replace('p', ''));
                    const numB = parseInt(b.replace('p', ''));
                    return numA - numB;
                });
                
                const fragments = [];
                sortedPoemIds.forEach(id => {
                    const poem = gameData.poemFragments.find(p => p.id === id);
                    if (poem) fragments.push(poem.text);
                });
                
                allPoems.innerHTML = `<p class="text-center leading-loose">${fragments.join("<br>")}</p>`;
            }
        }
        
        // 設置統計數據
        if (document.getElementById("poems-collected")) {
            document.getElementById("poems-collected").textContent = `${gameState.collectedPoems.length}/15`;
        }
        if (document.getElementById("emotion-final")) {
            document.getElementById("emotion-final").textContent = `${gameState.emotion}%`;
        }
        
        // 確保結局視窗可見 - 使用強制顯示方法
        endScreen.style.opacity = "1";
        endScreen.style.visibility = "visible";
        endScreen.style.display = "flex";
        endScreen.style.zIndex = "10000";
        endScreen.classList.add("active");
        
        console.log("【直接結束】結局窗口已顯示");
        
        // 重新綁定結局按鈕事件
        rebindEndingButtons();
        
        // 添加超級保險 - 300毫秒後再次確認結局窗口顯示並重新綁定按鈕
        setTimeout(() => {
            if (!endScreen.classList.contains("active")) {
                console.log("【保險機制】結局窗口未正確顯示，嘗試再次激活");
                endScreen.classList.add("active");
                endScreen.style.display = "flex";
                endScreen.style.zIndex = "10000";
                
                // 再次嘗試綁定按鈕
                rebindEndingButtons();
            }
        }, 300);
        
    } catch (error) {
        console.error("【嚴重錯誤】直接結束流程失敗:", error);
        
        // 終極緊急方案 - 嘗試直接操作DOM創建簡易結局
        try {
            console.log("【緊急方案】嘗試創建簡易結局窗口");
            
            // 獲取或創建結局窗口
            let endScreen = document.getElementById("end-screen");
            if (!endScreen) {
                endScreen = document.createElement("div");
                endScreen.id = "end-screen";
                endScreen.className = "modal-container";
                document.body.appendChild(endScreen);
            }
            
            // 簡化結局內容
            endScreen.innerHTML = `
                <div class="modal-content max-w-lg">
                    <h2 class="text-3xl font-bold mb-3 text-center">遊戲結束</h2>
                    <div class="mb-6">
                        <p class="text-lg">你完成了長干行旅的旅程。</p>
                    </div>
                    <div class="flex justify-center">
                        <button id="emergency-restart" class="btn btn-primary mr-2">
                            <span>重新開始</span>
                        </button>
                        <button id="emergency-reload" class="btn btn-secondary">
                            <span>重載頁面</span>
                        </button>
                    </div>
                </div>
            `;
            
            // 強制顯示
            endScreen.style.display = "flex";
            endScreen.style.opacity = "1";
            endScreen.style.visibility = "visible";
            endScreen.style.zIndex = "10000";
            
            // 直接綁定事件
            setTimeout(() => {
                document.getElementById("emergency-restart")?.addEventListener("click", function() {
                    endScreen.classList.remove("active");
                    setTimeout(() => {
                        endScreen.classList.add("hidden");
                        initGame(gameState.characterType);
                    }, 300);
                });
                
                document.getElementById("emergency-reload")?.addEventListener("click", function() {
                    location.reload();
                });
            }, 100);
            
            console.log("【緊急方案】簡易結局窗口已創建");
        } catch (finalError) {
            console.error("【致命錯誤】所有嘗試都失敗:", finalError);
            // 最後的手段 - 使用alert顯示結局
            alert("遊戲結束！\n你已完成長干行旅的旅程。\n請刷新頁面重新開始遊戲。");
        }
    }
}

// 新增函數：重新綁定結局按鈕事件
function rebindEndingButtons() {
    console.log("【重新綁定】開始重新綁定結局按鈕事件");
    
    try {
        // 獲取按鈕元素
        const restartGame = document.getElementById("restart-game");
        const switchCharacter = document.getElementById("switch-character");
        const endScreen = document.getElementById("end-screen");
        
        if (!restartGame || !switchCharacter || !endScreen) {
            console.error("【錯誤】找不到結局按鈕元素");
            return;
        }
        
        // 清除可能存在的舊事件監聽器
        const newRestartGame = restartGame.cloneNode(true);
        const newSwitchCharacter = switchCharacter.cloneNode(true);
        
        restartGame.parentNode.replaceChild(newRestartGame, restartGame);
        switchCharacter.parentNode.replaceChild(newSwitchCharacter, switchCharacter);
        
        // 重新綁定重新開始按鈕
        newRestartGame.addEventListener("click", function() {
            console.log("【按鈕】重新開始按鈕被點擊");
            endScreen.classList.remove("active");
            setTimeout(() => {
                endScreen.style.display = "none";
                endScreen.style.visibility = "hidden";
                initGame(gameState.characterType);
            }, 300);
        });
        
        // 重新綁定切換角色按鈕
        newSwitchCharacter.addEventListener("click", function() {
            console.log("【按鈕】切換角色按鈕被點擊");
            endScreen.classList.remove("active");
            setTimeout(() => {
                endScreen.style.display = "none";
                endScreen.style.visibility = "hidden";
                gameScreen.classList.add("hidden");
                startScreen.classList.remove("hidden");
                
                wifeCard.classList.remove("selected");
                husbandCard.classList.remove("selected");
                startGameBtn.disabled = true;
                document.getElementById("select-prompt").style.opacity = "1";
            }, 300);
        });
        
        console.log("【重新綁定】結局按鈕事件綁定完成");
    } catch (error) {
        console.error("【錯誤】重新綁定結局按鈕事件失敗:", error);
    }
}
        
        // 添加季節變化消息與通知
        function addSeasonChangeMessage(seasonName, yearDisplay) {
            const message = `${yearDisplay}${seasonName}季，時光流轉，又是一季。`;
            addMessage(message);
            
            // 添加季節變換通知
            // 季節變換通知已移除
        }
        
        // 觸發年終事件
        function triggerYearEndEvent() {
            // 應用年關資源消耗
            const yearEndCost = 0.15 + (gameState.yearProgress - 2) * 0.05; // 15%/20%/25%
            applyYearEndResourceCost(yearEndCost);
            
            // 添加年份過渡信息
            const finishedYear = gameState.currentYear - 1;
            const yearNum = finishedYear - 712;
            const yearText = yearNum === 1 ? 
                `開元元年` : 
                `開元${convertToChinese(yearNum)}年`;
                
            addMessage(`${yearText}已過，歲月如梭，又是一年。`);
            
            // 當進入第三年時提供特殊提示
            if (gameState.yearProgress === 3) {
                // 根據詩句收集情況提供不同提示
                const poemCount = gameState.collectedPoems.length;
                
                let message, type;
                if (poemCount >= 10) {
                    message = `最後一年開始！你已收集了${poemCount}首詩句，有望獲得圓滿結局。某些特殊事件可能隱藏著通往隱藏結局的線索...`;
                    type = "success";
                } else if (poemCount >= 6) {
                    message = `最後一年開始！你已收集了${poemCount}首詩句，繼續努力收集更多，追求更好的結局！`;
                    type = "info";
                } else {
                    message = `最後一年開始！你只收集了${poemCount}首詩句，結局可能不盡人意。抓緊時間執行詩意動作，提高詩句收集機會！`;
                    type = "warning";
                }
                
                notificationSystem.show("最後階段", message, type, 15000);
            }
            
            // 年終特殊事件 - 僅針對前兩年
            if (gameState.yearProgress <= 3) {
                showYearEndEvent();
            }
        }
        
        // 應用年關資源消耗
        function applyYearEndResourceCost(percentage) {
            const message = [];
            
            // 對基礎資源應用年關消耗
            if (gameState.characterType === "wife") {
                // 妻子消耗糧食和絲綢
                const riceCost = Math.floor(gameState.resources.rice * percentage);
                const silkCost = Math.floor(gameState.resources.silk * percentage);
                
                if (riceCost > 0) {
                    gameState.resources.rice -= riceCost;
                    message.push(`糧食消耗 ${riceCost}`);
                }
                
                if (silkCost > 0) {
                    gameState.resources.silk -= silkCost;
                    message.push(`絲綢消耗 ${silkCost}`);
                }
            } else {
                // 丈夫消耗口糧和貨物
                const foodCost = Math.floor(gameState.resources.food * percentage);
                const goodsCost = Math.floor(gameState.resources.goods * percentage);
                
                if (foodCost > 0) {
                    gameState.resources.food -= foodCost;
                    message.push(`口糧消耗 ${foodCost}`);
                }
                
                if (goodsCost > 0) {
                    gameState.resources.goods -= goodsCost;
                    message.push(`貨物損耗 ${goodsCost}`);
                }
            }
            
            // 添加年關消息
            if (message.length > 0) {
                const costDesc = message.join("，");
                addMessage(`歲末年關，${costDesc}。新的一年又將開始，願來年萬事安康。`);
            }
            
            // 更新資源顯示
            updateResources();
        }
        
        // 顯示年終特殊事件
        function showYearEndEvent() {
            const yearProgress = gameState.yearProgress - 1; // 剛結束的年份
            const character = gameState.characterType;
            
            let eventTitle, eventDesc, eventChoices;
            
            if (character === "wife") {
                if (yearProgress === 1) {
                    eventTitle = "開元十一年歲末";
                    eventDesc = "一年已過，青燈獨守，不知遠方的他可安好？窗外飄起了雪花，又是一年將盡時。";
                } else if (yearProgress === 2) {
                    eventTitle = "開元十二年歲末";
                    eventDesc = "兩年過去，偶爾有信傳來，卻依然不見歸期。每逢歲末，思念似乎格外濃烈。";
                }
            } else {
                if (yearProgress === 1) {
                    eventTitle = "開元十一年歲末";
                    eventDesc = "在外一年，生意雖有起伏，但思念家鄉卻日漸加深。異鄉的冬夜格外寒冷。";
                } else if (yearProgress === 2) {
                    eventTitle = "開元十二年歲末";
                    eventDesc = "兩年客居他鄉，歲月在你臉上留下風霜。每逢年關，不禁想起長干里的家，和等待的妻子。";
                }
            }
            
            // 構建年終事件
            const yearEndEvent = {
                id: `year-end-${yearProgress}`,
                title: eventTitle,
                description: eventDesc,
                forCharacter: character,
                choices: [
                    { 
                        text: "寫一封家書，傾訴一年的思念", 
                        effect: {
                            resources: { silver: -2 },
                            emotion: 15,
                            message: "你執筆寫下一年來的思念與經歷，希望這封信能傳達你的情感。"
                        }
                    },
                    { 
                        text: "默默收藏思念，祈願來年團圓", 
                        effect: {
                            emotion: 10,
                            message: "你靜靜地望著窗外的雪景，默念著祝福與思念，祈願來年能夠團聚。"
                        }
                    }
                ]
            };
            
            // 手動觸發年終事件
            showEventModal(yearEndEvent.id, yearEndEvent);
        }
        
        // 更新季節指示器
        function updateSeasonIndicator() {
            const seasonNames = ["春", "夏", "秋", "冬"];
            const currentAge = gameState.characterType === "wife" ? gameState.wifeAge : gameState.husbandAge;
            const year = gameState.currentYear;
            const yearNum = year - 712;
            
            // 轉換為中文年號
            const chineseYear = yearNum === 1 ? 
                `開元元年` : 
                `開元${convertToChinese(yearNum)}年`;
            
            // 計算年齡增長（每年增長1歲）
            const ageIncrease = gameState.yearProgress - 1; // yearProgress從1開始，所以第一年不增長
            const displayAge = currentAge + ageIncrease;
            
            // 計算當前回合在當前年的第幾個回合（1-12）
            const roundInYear = ((gameState.round - 1) % 12) + 1;
            const yearText = `${chineseYear}`;
            
            // 更精確的季節顯示
            const seasonText = document.getElementById("season-text");
            const yearDisplay = document.getElementById("year-display");
            const ageDisplay = document.getElementById("age-display");
            
            if (yearDisplay) yearDisplay.textContent = yearText;
            if (ageDisplay) ageDisplay.textContent = `${displayAge}歲`;
            seasonText.textContent = `${seasonNames[gameState.currentSeason]} • ${convertToChinese(gameState.currentMonth)}月`;
            roundText.textContent = `${gameState.round}/${gameState.maxRound}`;
            
            // 更新年進度顯示
            const yearProgressElem = document.getElementById("year-progress");
            if (yearProgressElem) {
                const yearNum = (gameState.yearProgress <= 3) ? gameState.yearProgress : 3;
                yearProgressElem.innerHTML = '';
                
                for (let i = 1; i <= 3; i++) {
                    const dot = document.createElement("div");
                    dot.className = `h-2 w-2 rounded-full mx-1 ${i <= yearNum ? 'bg-primary-light' : 'bg-gray-300 dark:bg-gray-700'}`;
                    yearProgressElem.appendChild(dot);
                }
            }
            
            // 更新進度條
            const progress = (gameState.round / gameState.maxRound) * 100;
            seasonProgress.style.width = `${progress}%`;
            
            // 更新季節顏色
            const seasonColors = ["spring", "summer", "autumn", "winter"];
            const seasonColorClass = seasonColors[gameState.currentSeason];
            
            // 移除所有季節類
            seasonText.classList.remove("spring", "summer", "autumn", "winter");
            // 添加當前季節類
            seasonText.classList.add(seasonColorClass);
            
            // 根據年份添加歲月痕跡
            if (gameState.yearProgress >= 2) {
                document.getElementById("player-info").classList.add("second-year");
            }
            if (gameState.yearProgress >= 3) {
                document.getElementById("player-info").classList.add("third-year");
            }
        }
        
        // 檢查游戲結束條件
        function checkGameEnd() {
            // 檢查是否達到最大回合
            if (gameState.round >= gameState.maxRound) {
                // 確保回合不會超過最大值
                gameState.round = gameState.maxRound;
                
                // 防止多次觸發
                if (gameState.endGameTriggered) {
                    return true;
                }
                
                // 強制設置多個標記，確保游戲結束
                gameState.shouldEndGame = true;
                gameState.endGameTriggered = true;
                
                // 立即顯示結局窗口，強制處理
                forceShowEnding();
                
                return true;
            }
            return false;
        }
        
        // 強制顯示結局窗口，確保在任何情況下都能正常結束遊戲
        function forceShowEnding() {
            console.log("【強制結束】開始執行強制結束程序");
            
            try {
                // 強制禁用所有動作按鈕
                console.log("【強制結束】禁用所有動作按鈕");
                const allButtons = document.querySelectorAll('.action-btn');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add("opacity-50");
                });
                
                // 強制關閉所有可能的視窗
                console.log("【強制結束】關閉所有視窗");
                
                // 關閉教學視窗
                const tutorialElement = document.getElementById("tutorial");
                if (tutorialElement) {
                    tutorialElement.classList.add("hidden");
                    console.log("【強制結束】教學視窗已關閉");
                }
                
                // 關閉事件視窗
                const eventModalElement = document.getElementById("event-modal");
                if (eventModalElement) {
                    eventModalElement.classList.remove("active");
                    console.log("【強制結束】事件視窗已關閉");
                }
                
                // 關閉歷史記錄視窗
                const historyModalElement = document.getElementById("history-modal");
                if (historyModalElement) {
                    historyModalElement.classList.remove("active");
                    console.log("【強制結束】歷史記錄視窗已關閉");
                }
                
                // 確保結局視窗是可見的
                console.log("【強制結束】準備顯示結局視窗");
                
                // 使用延遲確保DOM有時間更新
                setTimeout(() => {
                    console.log("【強制結束】直接顯示結局視窗");
                    try {
                        // 直接使用評估結局函數
                        const endingInfo = evaluateEnding();
                        console.log("【強制結束】結局評估完成:", endingInfo.title);
                        
                        // 取得結局元素
                        const endScreen = document.getElementById("end-screen");
                        const endTitle = document.getElementById("end-title");
                        const endDescription = document.getElementById("end-description");
                        
                        if (!endScreen || !endTitle || !endDescription) {
                            console.error("【錯誤】結局視窗元素不存在");
                            return;
                        }
                        
                        // 直接設置結局標題和描述
                        endTitle.textContent = endingInfo.title;
                        endDescription.textContent = endingInfo.description;
                        
                        // 顯示其他結局信息（簡化處理）
                        const allPoems = document.getElementById("all-poems");
                        if (allPoems) {
                            const poemCount = gameState.collectedPoems.length;
                            if (poemCount === 0) {
                                allPoems.innerHTML = "<p class='italic text-gray-500'>你沒有收集到任何詩句。</p>";
                            } else {
                                allPoems.innerHTML = "<p>已收集詩句</p>";
                            }
                        }
                        
                        // 設置計數器
                        document.getElementById("poems-collected").textContent = `${gameState.collectedPoems.length}/15`;
                        document.getElementById("emotion-final").textContent = `${gameState.emotion}%`;
                        
                        // 確保視窗可見
                        endScreen.classList.add("active");
                        console.log("【強制結束】結局視窗已顯示");
                        
                        // 確保視窗在最上層
                        endScreen.style.zIndex = "10000";
                    } catch (error) {
                        console.error("【錯誤】顯示結局時發生錯誤:", error);
                        
                        // 意外情況下的恢復方案 - 非常簡化的結局顯示
                        try {
                            const endScreen = document.getElementById("end-screen");
                            const endTitle = document.getElementById("end-title");
                            const endDescription = document.getElementById("end-description");
                            
                            if (endScreen && endTitle && endDescription) {
                                endTitle.textContent = "遊戲結束";
                                endDescription.textContent = "你完成了三年旅程。感謝遊玩！";
                                endScreen.classList.add("active");
                                endScreen.style.zIndex = "10000";
                                console.log("【恢復】使用備用結局顯示");
                            }
                        } catch (finalError) {
                            console.error("【致命錯誤】備用結局也無法顯示:", finalError);
                        }
                    }
                }, 300);
            } catch (error) {
                console.error("【嚴重錯誤】強制結束程序失敗:", error);
            }
        }
        
        // ===== 新的结局系统 - 完整版 =====

// 结局类型定义
const ENDING_TYPES = {
    HIDDEN: "hidden",       // 隐藏结局
    PERFECT: "perfect",     // 圆满结局
    GOOD_1: "good_1",       // 一般结局1
    GOOD_2: "good_2",       // 一般结局2 
    SAD_1: "sad_1",         // 遗憾结局1
    SAD_2: "sad_2",         // 遗憾结局2
    SAD_3: "sad_3"          // 遗憾结局3
};

// 结局分类
const ENDING_CATEGORIES = {
    PERFECT: [ENDING_TYPES.PERFECT, ENDING_TYPES.HIDDEN],
    GOOD: [ENDING_TYPES.GOOD_1, ENDING_TYPES.GOOD_2],
    SAD: [ENDING_TYPES.SAD_1, ENDING_TYPES.SAD_2, ENDING_TYPES.SAD_3]
};

// 特殊選擇記錄初始化
if (!gameState.specialChoices) {
    gameState.specialChoices = [];
}

// 結局數據結構 - 已填充隱藏結局
const endingData = {
    // 隱藏結局
    [ENDING_TYPES.HIDDEN]: {
        wife: {
            title: "詩魂入夢",
            description: "開元十三年冬，長干里月白風清。\n\n三年守望，朱顏漸老。今夜，你依舊獨坐窗前，對月揮毫。不經意間，筆下竟流出一闋似曾相識的新句：「十六君遠行，音書兩渺茫。明月照積雪，青燈伴孤床」。\n\n這文字彷彿有神助，字字皆是心聲。恍惚間，窗外一道清光落入房中，凝成一位風姿俊朗的白衣仙客，自稱「太白」。\n\n「夫人的相思之苦，感天動地。」白衣客笑道，「你的故事，我已記下，將以《長干行》為名，傳諸後世。」\n\n驚夢初醒，天已破曉。窗邊詩箋空白如初，然《長干行》十五句皆已銘刻於心。倚窗遠望，恰見一紙鶴乘風飛向天際，遠處似有笛聲悠揚，唐風古韻中，一位白衣謫仙漸行漸遠，飄然欲仙去。\n\n從此，你的等待雖未得圓滿，卻因詩仙李白之手，化為千古絕唱。世人讀《長干行》，皆為你的癡情所動——這相思，終不曾枉然。"
        },
        husband: {
            title: "乘槎歸鄉",
            description: "開元十三年秋，巴峽猿啼。\n\n一場秋雨過後，你獨坐江邊酒肆，遙望天際。酒至半酣，忽有一白衣俠客落座，自斟自飲，詩興大發：「蜀道難，難於上青天...」\n\n「先生可是李翰林？」你驚問。白衣人笑而不答，但問：「君思歸否？」\n\n你道出三年離鄉、思念妻子卻因商途未竟而不敢歸返的心事。李白大笑：「君之故事，正合吾意。容吾為君寫就，名曰《長干行》。」\n\n席間，李白贈你一葫蘆酒：「此乃仙家瓊漿，飲之可乘槎歸海，一夜可抵千里」。你將信將疑，卻因思鄉心切，一飲而盡。\n\n醉臥江邊，恍惚中只覺星河倒掛，自己乘著一葉扁舟，沿著銀河飛馳。再醒時，竟已漂至長干里岸邊。晨光熹微中，遠處傳來熟悉的梳妝聲。\n\n三年商途，如一場幻夢。而這奇遇，與那不期而遇的謫仙人，成為你與妻子向子孫後代講述的神奇故事，世代相傳。"
        }
    },
    // 其他結局暫時為空，將根據提供的內容填充
    [ENDING_TYPES.PERFECT]: {
        wife: { 
            title: "花繞曲欄柳滿池，相思不負終團圓", 
            description: "開元十三年冬，長干里雪未落盡。\n\n一封遲來的家書送到門前，言道丈夫已啟程回返。你佇立窗前，青絲間不覺已添幾許白髮，卻掩不住眼中的期盼。\n\n十月初七，雪後初晴。你整理庭院時，遠處傳來行人的腳步聲。抬頭望去，一個風塵僕僕的身影站在巷口，滿眼都是久別重逢的驚喜。\n\n彼時青梅竹馬，今朝兩鬢微霜。隔著長街，四目相對，恍若隔世。曾經的少年郎已變得堅毅滄桑，而你的傾慕目光依然如舊。\n\n門前的青苔見證了你的等待，而這一刻，也終於見證了你的歡顏。" 
        },
        husband: { 
            title: "三載他鄉一夢還", 
            description: "開元十三年冬，巴蜀霜重。\n\n清晨整理行囊，將這三年的收穫與思念一同打包。告別三巴商賈，你踏上了歸程。那曾經年少輕狂的離別誓言，如今化作歸家的決心。\n\n歸舟逆流而上，櫓聲驚起兩岸鴉鳴。山間猿聲哀切，彷彿在提醒著「早晚下三巴，預將書報家」的承諾。你取出妻子的信物，在掌心摩挲，熟悉的觸感讓千里之外的家更加清晰。\n\n踏入長干里的那一刻，天色將暗。遠處，一盞燈火在風中搖曳，如同那個守候的人，不曾熄滅希望。\n\n三年風塵，換得此刻相見。千萬水路，不及家門一步近。" 
        }
    },
    [ENDING_TYPES.GOOD_1]: {
        wife: { 
            title: "春風又綠長干岸", 
            description: "開元十三年春，桃花初綻。\n\n入春以來，你日日整理庭院，彷彿隨時會有故人歸來。三年前信中寫道「早晚下三巴」，卻不知何為早，何為晚。\n\n今日市集得知，商船將至。你心神不寧，料理家務時頻頻望向門外。鄰家孩童打鬧嬉戲，恰似當年你們「同居長干里，兩小無嫌猜」的時光。\n\n天色漸暗，你點燃一盞燈火，懸於門前。不知今夜能否照亮他歸家的路，但這份期盼，會如這燈火般持續燃燒。\n\n明年桃花開時，或許就是重逢之日。" 
        },
        husband: { 
            title: "瀟湘夜雨歸舟遲", 
            description: "開元十三年秋，江水東流。\n\n商船靠岸，你站在船頭眺望長江方向。陰雲密布，風聲鶴唳，預示著一場風暴將至。行商三年，盈虧參半，未能如願帶著富足回鄉。\n\n當地舟子勸你：「水漲船高，等風平浪靜再啟程。」你跌坐船頭，思緒萬千。帳簿上的虧空，猶如心中的愧疚，難以填平。執筆寫信，卻一遍遍擦去開頭的文字。\n\n「君問歸期未有期，巴山夜雨漲秋池。」燈下讀著妻子寄來的舊信，紙上字跡已被翻閱得模糊，如同那漸行漸遠的承諾。\n\n明年春水漲時，或許財源與歸途都能順遂。" 
        }
    },
    [ENDING_TYPES.GOOD_2]: {
        wife: { 
            title: "青燈殘夢話錦年", 
            description: "開元十三年秋，西風漸起。\n\n織機前的影子被搖曳的燭光拉長，絲線穿梭間，你眼前浮現出離別時的場景。三年過去，當年十六的青衣少女已變得沉穩內斂。\n\n黃昏時分，你憑欄望向遠方，想象他航行在三巴水域的模樣。那些被你一遍遍折疊的家書，記錄著彼此漸行漸遠的心緒。\n\n「水流無盡歸何處，鴻雁傳書幾時至。」你提筆寫下這句話，卻不知何時能送達。明月升起，你獨坐庭院，靜聽時光緩緩流淌的聲音。\n\n也許來年，也許再等一年。" 
        },
        husband: { 
            title: "猿啼月冷巴東峽", 
            description: "開元十三年夏，峽中水漲。\n\n「五月不可觸，猿聲天上哀。」老船工的警告在耳邊迴響。站在瞿塘峽口，你望著灩澦堆洶湧的險灘，不禁心生怯意。半月來，三艘商船覆沉於此，人財俱失。\n\n今夜投宿峽口客棧，與同行商賈把盞。燭影搖曳間，你從懷中取出那封未寄出的家書。字字皆是思念，卻終因「早晚下三巴」的承諾難以兌現而遲遲未發。\n\n夜深人靜，猿啼聲聲，似是山鬼相召。你獨坐窗前，思緒飄向千里之外的長干里。她可還在門前守望？髮端可有霜絲？\n\n待秋水退去，待來年春暖，你必將踏上歸途。" 
        }
    },
    [ENDING_TYPES.SAD_1]: {
        wife: { 
            title: "青絲暮雪", 
            description: "開元十三年冬，北風蕭瑟。\n\n晨起梳妝，驚見青絲中一縷銀白，恍如昨日的髮初覆額少女已漸行漸遠。昔日的青梅竹馬不知何處，唯有窗前那株當年共植的梅樹，依舊年年花開花落，不言不語。\n\n門前的苔痕愈發墨綠深重，如同歲月在你眉間刻下的細紋。偶爾路過的商旅帶來三巴遙遠的傳聞，卻早已不提他的名字。樓頭望月，青瓷映雪，恍惚間仿佛看到少時的容顏，彈指已是天涯陌路。\n\n『感此傷妾心，坐愁紅顏老』--這詩句已不再是紙上的墨跡，而是心頭揮之不去的哀愁。鏡中人已不復當年，而心中的等待，終將與青苔一同，沉寂無聲。" 
        },
        husband: { 
            title: "歸舟難繫", 
            description: "開元十三年秋，巴蜀紅葉漫山。\n\n正值商旺時節，你的商行已在三巴立足，門庭若市。每到月圓之夜，你獨坐江畔，舉盞對月，想起千里之外的長干里，和那個青梅竹馬的妻子。年少時的誓言，如同江上的濃霧，隨風散去。\n\n長江日日東流，你也在商海中漸行漸遠。當地富商張家有意結親，時常邀你赴宴。他女兒溫婉嫻靜，舉手投足間，卻總讓你恍惚看到家鄉那個折花門前的少女身影。\n\n一封家書半年未回，案頭的書箋上寫了刪，刪了寫，終是不知如何說起。風雨漂泊，鄉音漸遠，歸期無期。當靜夜驚醒，發覺記不清她的容顏時，你便知道，有些距離，不只是千山萬水，更是歲月無情。\n\n水流雲在，人事已非。或許，這便是命中注定--離家越遠，歸途越難，直至回不去的地方，才明白日日盼歸的心情。" 
        }
    },
    [ENDING_TYPES.SAD_2]: {
        wife: { 
            title: "長門怨", 
            description: "開元十三年寒冬，長干里落雪無聲。\n\n日暮黃昏，你掃去門前新積的雪，露出下面深深的青苔，那是歲月留下的無聲見證。三年來，旬朔望日必定在此佇立，風雨無阻，直至路人都記住了你的身影。\n\n『那是癡心人哪，』鄰里低語，『三年了，還在等那遠行的商人。』\n\n夜闌人靜，你獨坐燈下，重讀那寥寥幾封家書。紙上字跡已被淚水模糊，卻仍能觸動心弦。窗外明月如水，照著滿庭霜雪，一如當年照著兩人初識時的長干巷陌。你撫觸窗欞，輕聲嘆道：『門前遲行跡，一一生綠苔』。\n\n縱使青絲漸染霜華，縱使歸期遙遙無期，這份等待早已融入血脈。若不見君歸，寧可守此青燈孤影，生生世世，不悔此生。" 
        },
        husband: { 
            title: "水殤別離", 
            description: "開元十三年夏，五月驚濤。\n\n巴東峽口，雨連日不止，長江水漲如牛。老船工勸阻再三：『五月不可觸，猿聲天上哀。』然而思鄉心切，三年未歸，你已難耐鄉愁，執意起航。\n\n瞿塘峽中，驚濤拍岸，山洪爆發。船身劇烈晃動，眾人驚呼，貨物傾覆入江。猿猴哀鳴，似在悲嘆逝去的生命。剎那間，巨浪吞沒了脆弱的商船。\n\n你掙扎著抓住一截桅桿，隨波漂流。冰冷的江水灌入肺腑，眼前漸暗，意識模糊間，腦海中浮現長干里的景象--那個在門前遲遲等待的妻子，依然如當年般站在那裡，手執花枝，微笑回眸。\n\n『早晚下三巴，預將書報家』--這句詩如今只能隨江水東流，再不能傳達。水流湍急處，你的力氣漸失，手中緊握的最後一封家書墨跡漸散。萬千思緒匯入滔滔江水，而她，終將等不到你的歸來。" 
        }
    },
    [ENDING_TYPES.SAD_3]: {
        wife: { 
            title: "淚盡燈枯", 
            description: "開元十三年春，物候更新，人事已非。\n\n米缸見底，囊中羞澀，連年耕織的雙手已滿是繭痕。青燈獨守，夜漸深，油漸盡，如同逐漸熄滅的希望。\n\n今日，里中王媒再度登門，身後跟著鄰縣陳家長子--十里八鄉聞名的良善之人。『那商人三年未歸，音信漸少，』王媒低聲道，『一個女子風燭殘年，終非長久。陳家家底殷實，膝下猶虛，正好...』\n\n長干里桃花盛開，恰如十四年前你們相識時一般。你獨立庭前，望向長江方向，記憶中的少年仿佛就在轉角，踏著青石板，騎著竹馬而來。然而風拂花落，只剩滿庭香消玉殞。\n\n淚眼朦朧中，你緩緩取下髮簪，將一段年華鄭重收起。明日，便是回門之日，從此長干里再無少時那個癡心女子，唯有青苔依舊，無聲訴說一段往事。" 
        },
        husband: { 
            title: "塵緣重結", 
            description: "開元十三年冬，三巴雪霽。\n\n經年累月，你已在三巴落地生根。商號門庭若市，富甲一方。然而每逢夜闌人靜，偶爾還會想起長干里的那個身影，那個曾與你青梅竹馬，十四為君婦的妻子。\n\n今日，巴郡刺史府上設宴，刺史有意將女兒許配。席間，那溫婉女子低眉淺笑，一舉一動間，竟與長干里的她有幾分神似。月下獨酌，思緒萬千。\n\n案頭是半年未動的薄箋，本欲寫下家書，卻不知從何說起。三年漂泊，你已不是當年那個意氣風發的少年；長干里的她，想必也已不再守候。年華流轉，緣分更替，人生幾何，歲月催人。\n\n明日便是訂親之日，從此，長干行旅將成隔世前塵。你取出珍藏多年的青梅竹馬信物，鄭重埋入庭院一角，就像埋葬一段無法再續的青春記憶。" 
        }
    }
};

// 結局條件判斷輔助函數
function hasCollectedPoems(collectedPoemIds, requiredPoemIds) {
    return requiredPoemIds.every(id => collectedPoemIds.includes(id));
}

// 檢查特殊選擇
function hasSpecialChoice(gameState, specialChoiceId) {
    return gameState.specialChoices && gameState.specialChoices.includes(specialChoiceId);
}

// 結局條件定義 - 主要基於詩句數量的簡化版本
const endingConditions = {
    [ENDING_TYPES.HIDDEN]: function(gameState) {
        // 隱藏結局 - 需要大量詩句(13+)，並且做出特殊選擇
        const poemCount = gameState.collectedPoems.length;
        const specialChoiceId = gameState.characterType === "wife" ? 
                                "plum_tree_encounter" : "riverboat_dialogue";
        const madeSpecialChoice = hasSpecialChoice(gameState, specialChoiceId);
        
        return poemCount >= 13 && madeSpecialChoice;
    },
    
    [ENDING_TYPES.PERFECT]: function(gameState) {
        // 圓滿結局 - 收集大量詩句(11+)
        const poemCount = gameState.collectedPoems.length;
        return poemCount >= 11 && !endingConditions[ENDING_TYPES.HIDDEN](gameState);
    },
    
    [ENDING_TYPES.GOOD_1]: function(gameState) {
        // 一般結局1 - 收集較多詩句(8-10)
        const poemCount = gameState.collectedPoems.length;
        return poemCount >= 8 && poemCount <= 10 && 
               !endingConditions[ENDING_TYPES.HIDDEN](gameState);
    },
    
    [ENDING_TYPES.GOOD_2]: function(gameState) {
        // 一般結局2 - 收集中等詩句(6-7)
        const poemCount = gameState.collectedPoems.length;
        return poemCount >= 6 && poemCount <= 7 && 
               !endingConditions[ENDING_TYPES.HIDDEN](gameState);
    },
    
    [ENDING_TYPES.SAD_1]: function(gameState) {
        // 遺憾結局1 - 收集少量詩句(4-5)
        const poemCount = gameState.collectedPoems.length;
        return poemCount >= 4 && poemCount <= 5;
    },
    
    [ENDING_TYPES.SAD_2]: function(gameState) {
        // 遺憾結局2 - 收集極少詩句(2-3)
        const poemCount = gameState.collectedPoems.length;
        return poemCount >= 2 && poemCount <= 3;
    },
    
    [ENDING_TYPES.SAD_3]: function(gameState) {
        // 遺憾結局3 - 幾乎沒有收集詩句(0-1)
        const poemCount = gameState.collectedPoems.length;
        return poemCount <= 1;
    }
};

// 結局評估函數
function evaluateEnding() {
    // 按優先順序檢查每種結局條件
    for (const endingType of Object.values(ENDING_TYPES)) {
        if (endingConditions[endingType](gameState)) {
            // 獲取對應角色的結局內容
            const characterType = gameState.characterType;
            const ending = endingData[endingType][characterType];
            const isGoodEnding = ENDING_CATEGORIES.PERFECT.includes(endingType) || 
                                ENDING_CATEGORIES.GOOD.includes(endingType);
            
            console.log(`達成結局: ${endingType}`); // 調試信息
            
            return {
                title: ending.title,
                description: ending.description,
                endingType: endingType,
                isGoodEnding: isGoodEnding
            };
        }
    }
    
    // 保險機制 - 若所有條件判定出錯，返回基本結局
    console.log("未達成任何特定結局，返回默認結局"); // 調試信息
    const safeEnding = endingData[ENDING_TYPES.SAD_3][gameState.characterType];
    return {
        title: safeEnding.title,
        description: safeEnding.description,
        endingType: ENDING_TYPES.SAD_3,
        isGoodEnding: false
    };
}

// 觸發遊戲結束流程
function triggerGameEnding() {
    console.log("觸發游戲結束...");
    
    // 1. 首先強制關閉所有可能的干擾窗口
    // 關閉教學窗口
    const tutorialElement = document.getElementById("tutorial");
    if (tutorialElement && !tutorialElement.classList.contains("hidden")) {
        console.log("強制關閉教學窗口");
        tutorialElement.classList.add("hidden");
    }
    
    // 關閉任何事件模態窗
    const eventModalElement = document.getElementById("event-modal");
    if (eventModalElement && eventModalElement.classList.contains("active")) {
        console.log("強制關閉事件模態窗");
        eventModalElement.classList.remove("active");
    }
    
    // 關閉歷史記錄窗口
    const historyModalElement = document.getElementById("history-modal");
    if (historyModalElement && historyModalElement.classList.contains("active")) {
        console.log("強制關閉歷史記錄窗口");
        historyModalElement.classList.remove("active");
    }
    
    // 2. 確保游戲結束標記已設置
    gameState.shouldEndGame = true;
    console.log("已確保游戲結束標記設置");
    
    // 3. 使用延遲確保DOM完全準備好
    console.log("準備評估結局並顯示結局窗口...");
    setTimeout(function() {
        try {
            // 使用評估函數獲取結局信息
            const endingInfo = evaluateEnding();
            
            // 獲取結局標題和描述
            const title = endingInfo.title;
            const description = endingInfo.description;
            
            console.log(`已確定結局: "${title}"`);
            
            // 調用結束游戲函數
            endGame(title, description, endingInfo.isGoodEnding);
        } catch (error) {
            console.error("顯示結局時發生錯誤:", error);
            // 錯誤恢復 - 使用基本結局
            const fallbackEnding = endingData[ENDING_TYPES.SAD_3][gameState.characterType];
            endGame(fallbackEnding.title, fallbackEnding.description, false);
        }
    }, 100);
}
        
        // 初始化全局已發現結局記錄
        let discoveredEndings = [];
        
        // 打字機效果函數 - 增強版
        function typewriterEffect(element, text, speed = 30, onComplete = null) {
            let i = 0;
            element.textContent = '';
            
            // 增加了標點符號的停頓效果
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    
                    // 遇到標點符號時停頓時間更長
                    let pause = speed;
                    const punctuation = "，。！？.,:;!?";
                    if (i < text.length && punctuation.includes(text.charAt(i-1))) {
                        pause = speed * 5; // 標點處停頓更長
                    }
                    
                    setTimeout(type, pause);
                } else if (onComplete) {
                    onComplete();
                }
            }
            
            type();
        }
        
        // 添加詩句收集提示功能
        function addPoemCollectionTips(poemFragmentId) {
            // 檢查是否獲得詩句
            if (poemFragmentId && !gameState.collectedPoems.includes(poemFragmentId)) {
                // 如果這是第一首詩句，顯示教學提示
                if (gameState.collectedPoems.length === 0) {
                    notificationSystem.show(
                        "詩句收集",
                        "恭喜！你收集到了第一首詩句。詩句是通過選擇特定事件選項和執行詩意動作獲得的。收集的詩句越多，結局越圓滿！",
                        "poem",
                        12000
                    );
                }
                // 當收集到一定數量詩句時提供額外提示
                else if (gameState.collectedPoems.length === 4) {
                    notificationSystem.show(
                        "詩句策略",
                        "已收集5首詩句！提示：某些詩句需要特定條件觸發，如特定季節或年份。持續嘗試不同動作和選項！",
                        "hint",
                        12000
                    );
                }
                // 當收集10首詩句時
                else if (gameState.collectedPoems.length === 9) {
                    notificationSystem.show(
                        "進階提示",
                        "你已收集10首詩句！特定詩句組合會影響結局類型。尤其注意表達堅貞不渝、等待相思的詩句，它們對達成圓滿結局至關重要。",
                        "hint",
                        15000
                    );
                }
            }
        }
        
        // 添加資源危機提示功能
        function checkResourceCrisis() {
            // 確保提示記錄陣列存在
            if (!gameState.seenTips) {
                gameState.seenTips = [];
            }
            
            // 獲取當前資源
            const riceOrFood = gameState.resources.rice || gameState.resources.food || 0;
            const silver = gameState.resources.silver || 0;
            
            // 首次資源危機警告
            if (riceOrFood < 15 && !gameState.seenTips.includes("resource_warning")) {
                notificationSystem.show(
                    "資源警告",
                    "注意：你的糧食/口糧不足！執行務實動作(綠色按鈕)來補充資源，避免陷入困境。",
                    "warning",
                    10000
                );
                // 標記已顯示
                gameState.seenTips.push("resource_warning");
            }
            
            // 首次銀兩短缺警告
            if (silver < 10 && !gameState.seenTips.includes("silver_warning")) {
                notificationSystem.show(
                    "銀兩短缺",
                    "警告：你的銀兩即將耗盡！銀兩是購買物資的必需品，考慮執行可獲取銀兩的動作。",
                    "warning",
                    10000
                );
                gameState.seenTips.push("silver_warning");
            }
            
            // 極度危機警告（兩種資源都極低）
            if (riceOrFood < 5 && silver < 5 && !gameState.seenTips.includes("critical_warning")) {
                notificationSystem.show(
                    "危急警告",
                    "生存危機！你的糧食與銀兩均已幾近耗盡。立即執行能獲取資源的務實動作，否則可能導致遺憾結局！",
                    "warning",
                    15000
                );
                gameState.seenTips.push("critical_warning");
            }
        }
        
        // 情境提示系統
        const contextualTips = [
            {
                id: "first_resource_low",
                condition: function(gameState) {
                    const riceOrFood = gameState.resources.rice || gameState.resources.food || 0;
                    return riceOrFood < 15 && !gameState.seenTips.includes("first_resource_low");
                },
                message: "⚠️ 注意：你的糧食/口糧即將耗盡！考慮執行務實動作（綠色按鈕）來補充資源，避免陷入困境。",
                type: "warning"
            },
            {
                id: "first_poem_collected",
                condition: function(gameState) {
                    return gameState.collectedPoems.length === 1 && !gameState.seenTips.includes("first_poem_collected");
                },
                message: "🎉 恭喜獲得第一首詩句！詩句是通往圓滿結局的關鍵。詩意動作（紫色按鈕）和特定事件選擇更容易獲得詩句。",
                type: "success"
            },
            {
                id: "year_two_begins",
                condition: function(gameState) {
                    return gameState.yearProgress === 2 && gameState.currentSeason === 0 && !gameState.seenTips.includes("year_two_begins");
                },
                message: "📅 第二年已經開始！隨著時間推移，某些特殊事件可能會出現。注意平衡資源與詩句收集，為最終結局做準備。",
                type: "info"
            },
            {
                id: "poem_strategy",
                condition: function(gameState) {
                    return gameState.round >= 10 && gameState.collectedPoems.length < 4 && !gameState.seenTips.includes("poem_strategy");
                },
                message: "💡 提示：你的詩句收集進度較慢。嘗試更多詩意動作（紫色按鈕），並在事件中選擇與思念、等待相關的選項。",
                type: "hint"
            },
            {
                id: "final_year",
                condition: function(gameState) {
                    return gameState.yearProgress === 3 && gameState.currentSeason === 0 && !gameState.seenTips.includes("final_year");
                },
                // 直接使用字符串，在checkContextualTips函數中處理動態內容
                message: "⏳ 最後一年開始了！你已經收集了 {poemCount}/15 首詩句。合理安排剩餘回合，為圓滿結局努力！",
                type: "info"
            },
            {
                id: "hidden_ending_hint",
                condition: function(gameState) {
                    return gameState.yearProgress === 3 && gameState.collectedPoems.length >= 10 && gameState.currentSeason >= 2 && !gameState.seenTips.includes("hidden_ending_hint");
                },
                message: "✨ 傳言在月夜梅樹下或江上船頭會有奇遇...這或許是通往不尋常結局的線索。",
                type: "poem"
            }
        ];
        
        // 游戲結束
        let currentEndingIsGood = false;
        
        function endGame(title, description, isGoodEnding = false) {
            // 記錄結局類型
            currentEndingIsGood = isGoodEnding;
            
            // 獲取結局信息
            const endingInfo = evaluateEnding();
            const endingType = endingInfo.endingType;
            
            // 檢查是否是新發現的結局
            if (!discoveredEndings.includes(endingType)) {
                discoveredEndings.push(endingType);
            }
            
            // 設置結局標題
            endTitle.textContent = title;
            
            // 清空描述容器
            endDescription.innerHTML = '';
            
            // 將描述文本分割成段落
            const paragraphs = description.split('\n\n').filter(para => para.trim() !== '');
            
            // 創建一個用於存儲段落元素的數組
            const paraElements = [];
            
            // 為每個段落創建一個p元素
            paragraphs.forEach(() => {
                const p = document.createElement('p');
                p.className = 'mb-3';
                endDescription.appendChild(p);
                paraElements.push(p);
            });
            
            // 逐段應用打字機效果
            function typeNextParagraph(index = 0) {
                if (index >= paragraphs.length) {
                    // 所有段落都完成後，顯示詩句和統計數據
                    showEndingStats();
                    return;
                }
                
                const para = paragraphs[index];
                const paraElement = paraElements[index];
                
                // 一個段落結束後再開始下一個段落
                typewriterEffect(paraElement, para, 60, () => {
                    setTimeout(() => {
                        typeNextParagraph(index + 1);
                    }, 1000); // 段落間較長停頓，給玩家閱讀時間
                });
            }
            
            // 開始打字效果
            typeNextParagraph();
            
            // 展示剩餘的結局數據和統計
            function showEndingStats() {
                // 將收集的詩句按順序排列
                const poemCount = gameState.collectedPoems.length;
                
                // 顯示收集的詩句
                allPoems.innerHTML = "";
                
                if (poemCount === 0) {
                    allPoems.innerHTML = "<p class='italic text-gray-500 dark:text-gray-400'>你沒有收集到任何詩句。</p>";
                } else {
                    // 按原詩順序排列
                    const sortedPoemIds = gameState.collectedPoems.sort((a, b) => {
                        const numA = parseInt(a.replace('p', ''));
                        const numB = parseInt(b.replace('p', ''));
                        return numA - numB;
                    });
                    
                    const fragments = [];
                    sortedPoemIds.forEach(id => {
                        const poem = gameData.poemFragments.find(p => p.id === id);
                        if (poem) fragments.push(poem.text);
                    });
                    
                    allPoems.innerHTML = `<p class="text-center leading-loose">${fragments.join("<br>")}</p>`;
                }
                
                // 設置結束統計
                document.getElementById("poems-collected").textContent = `${poemCount}/15`;
                document.getElementById("emotion-final").textContent = `${gameState.emotion}%`;
                
                // 添加結局發現計數器
                const endingStatsDiv = document.getElementById("ending-stats");
                
                // 移除舊的結局計數器和提示（如果存在）
                const oldCounter = document.getElementById("ending-counter");
                if (oldCounter) oldCounter.remove();
                
                const oldHint = document.getElementById("ending-hint");
                if (oldHint) oldHint.remove();
                
                // 添加新的結局計數器
                const endingCounter = document.createElement("div");
                endingCounter.id = "ending-counter";
                endingCounter.className = "text-center text-sm mt-4 text-gray-600 dark:text-gray-300";
                endingCounter.innerHTML = `
                    <div class="inline-block px-3 py-1 bg-violet-100 dark:bg-violet-900/40 rounded-full shadow-sm">
                        <span class="font-semibold text-violet-800 dark:text-violet-200">已發現 ${discoveredEndings.length}/7 種結局</span>
                    </div>
                `;
                endingStatsDiv.appendChild(endingCounter);
                
                // 增加一個明確的提示
                const endingHint = document.createElement("div");
                endingHint.id = "ending-hint";
                endingHint.className = "text-center text-xs mt-2 italic text-gray-500 dark:text-gray-400";
                endingHint.textContent = "提示：嘗試不同的詩句收集策略和選擇來探索其他結局！";
                endingStatsDiv.appendChild(endingHint);
            }
            
            // 顯示結束畫面
            endScreen.classList.add("active");
        }
        
        // 添加調整消息區域高度的函數
        function adjustMessageAreaHeight() {
            const messagesArea = document.getElementById('messages');
            const poemFragments = document.getElementById('poem-fragments');
            
            // 如果任一元素不存在，直接返回
            if (!messagesArea || !poemFragments) return;
            
            // 獲取詩句窗口的底部位置
            const poemRect = poemFragments.getBoundingClientRect();
            const messagesRect = messagesArea.parentElement.getBoundingClientRect();
            
            // 計算消息區域可用的最大高度（考慮一些padding和邊距）
            const availableHeight = Math.max(
                poemRect.bottom - messagesRect.top - 80, // 80px作為底部margin
                180 // 最小高度
            );
            
            // 設置消息區域的高度
            messagesArea.style.maxHeight = `${availableHeight}px`;
            
            // 更新歷史按鈕可見性
            updateHistoryButtonVisibility();
        }

        // 更新歷史按鈕可見性
        function updateHistoryButtonVisibility() {
            const messagesArea = document.getElementById('messages');
            const viewHistoryBtn = document.getElementById('view-history');
            
            if (!messagesArea || !viewHistoryBtn) return;
            
            // 檢查是否有滾動條
            const hasOverflow = messagesArea.scrollHeight > messagesArea.clientHeight;
            
            // 顯示或隱藏按鈕
            viewHistoryBtn.style.display = hasOverflow ? 'flex' : 'none';
        }
        
        // 添加消息
        function addMessage(text, isPoemEvent = false) {
            // 獲取當前日期信息
            const yearNum = gameState.currentYear - 712;
            const chineseYear = yearNum === 1 ? 
                `開元元年` : 
                `開元${convertToChinese(yearNum)}年`;
            
            const month = gameState.currentMonth;
            const day = gameState.currentDay;
            const lunarMonth = `${convertToChinese(month)}月`;
            const lunarDay = getLunarDayName(day);
            const seasonIndex = gameState.currentSeason;
            const seasonName = gameData.seasons[seasonIndex];
            
            // 創建日期顯示
            const dateDisplay = `${chineseYear} ${lunarMonth}${lunarDay} ${seasonName}`;
            
            // 創建消息元素
            const message = document.createElement("div");
            message.className = "message-item";
            
            // 接受顯式的isPoemEvent參數，而不是檢查文本內容
            
            // 為詩句收集使用不同的樣式
            if (isPoemEvent) {
                message.classList.add("border-l-4", "border-amber-300", "bg-amber-50/30", "dark:bg-amber-900/20", "py-3", "px-3", "rounded-r");
            }
            
            // 為季節變化使用不同樣式
            if (text.includes('，時光流轉，又是一季。')) {
                message.classList.add("border-l-4", "border-primary-light");
            }
            
            // 創建日期和詩句標籤容器
            const headerDiv = document.createElement("div");
            headerDiv.className = "flex items-center mb-1";
            
            // 創建日期元素
            const dateSpan = document.createElement("span");
            dateSpan.className = "text-xs font-medium";
            
            // 為不同季節使用不同顏色
            if (seasonIndex === 0) dateSpan.classList.add("text-green-600", "dark:text-green-400");
            if (seasonIndex === 1) dateSpan.classList.add("text-amber-600", "dark:text-amber-400");
            if (seasonIndex === 2) dateSpan.classList.add("text-red-600", "dark:text-red-400");
            if (seasonIndex === 3) dateSpan.classList.add("text-blue-600", "dark:text-blue-400");
            
            dateSpan.textContent = dateDisplay;
            headerDiv.appendChild(dateSpan);
            
            // 如果是詩句事件，在時間後面添加詩句標籤
            if (isPoemEvent) {
                const poemBadge = document.createElement("div");
                poemBadge.className = "inline-block px-2 py-0.5 bg-amber-100 dark:bg-amber-800 text-amber-800 dark:text-amber-100 rounded text-xs font-semibold ml-2";
                poemBadge.innerHTML = "📜 獲得詩句";
                headerDiv.appendChild(poemBadge);
            }
            
            // 創建內容
            const contentSpan = document.createElement("span");
            contentSpan.textContent = text;
            
            // 添加到消息中
            message.appendChild(headerDiv);
            message.appendChild(contentSpan);
            
            // 新消息添加到最上方
            if (messages.firstChild) {
                messages.insertBefore(message, messages.firstChild);
            } else {
                messages.appendChild(message);
            }
            
            // 不再限制顯示的消息數量，而是讓滾動條處理溢出
            
            // 保存到游戲狀態
            gameState.messages.unshift({
                date: dateDisplay,
                text: text,
                season: seasonIndex,
                isPoem: isPoemEvent  // 使用明確的isPoemEvent參數
            });
            
            // 對於詩句事件，輸出到控制台以進行調試
            if (isPoemEvent) {
                console.log("詩句事件已標記:", text);
            }
            
            // 記錄重要消息到日記
            if (text.length > 10 && !text.includes("游戲開始")) {
                const currentAge = gameState.characterType === "wife" ? 
                    gameState.wifeAge + Math.floor((gameState.round - 1) / 4) : 
                    gameState.husbandAge + Math.floor((gameState.round - 1) / 4);
                    
                gameState.journalEntries.push({
                    time: `${chineseYear} ${lunarMonth}${lunarDay}`,
                    age: currentAge,
                    content: text,
                    isPoem: isPoemEvent  // 使用明確的isPoemEvent參數
                });
            }
            
            // 調整消息區域高度
            adjustMessageAreaHeight();
        }
        
        // 教學提示
        let tutorialStep = 0;
        const tutorialSteps = [
            "歡迎來到《長干行旅》！這是基於李白《長干行》詩歌的角色扮演游戲。你將體驗詩中描述的情感故事，收集詩句，追求圓滿或隱藏結局。",
            "游戲時長為三年（36回合），你需要管理資源、應對季節變化和各種事件。時間寶貴，請謹慎規劃每個行動。",
            "左側面板顯示你的情感值、資源和收集的詩句。情感值會影響詩句獲取機會和最終結局品質，請設法維持在較高水平。",
            "中央是游戲場景，閃爍的圖標是事件，點擊它們可以觸發互動。選擇不同選項會產生不同結果，與詩意相關的選項更容易獲得詩句。",
            "底部的動作按鈕讓你執行各種行動。綠色是務實動作（獲取資源），紫色是詩意動作（更容易獲得詩句但消耗資源）。每執行一次動作消耗一個回合。",
            "資源管理很重要！糧食/口糧和銀兩是生存必需品。資源耗盡會限制你的選擇，導致遺憾結局。請確保務實動作和詩意動作的平衡。",
            "詩句收集影響遊戲走向。不同數量和類型的詩句會引導向不同結局！遊戲中共有15句詩可收集，你可以追求收集全部，也可以有選擇性地收集，體驗多樣化的結局。",
            "開始你的長干之旅吧！圓滿結局並非唯一目標，每種結局都有獨特的故事。嘗試不同的詩句組合、不同的選擇，發現屬於你的《長干行》故事。"
        ];
        
        function showTutorial() {
            // 重置教學步驟
            tutorialStep = 0;
            
            // 初始化已見提示集合
            if (!gameState.seenTips) {
                gameState.seenTips = [];
            }
            
            console.log("初始化教學系統，總共有 " + tutorialSteps.length + " 個步驟");
            
            // 設置教學窗口位置 - 初始位置為右下角
            tutorial.style.bottom = "1.5rem";
            tutorial.style.right = "1.5rem";
            tutorial.style.left = "auto";
            tutorial.style.top = "auto";
            
            // 清除之前的位置類別
            tutorial.classList.remove("position-top", "position-right", "position-bottom", "position-left");
            // 默認為底部位置
            tutorial.classList.add("position-bottom");
            
            // 顯示教學窗口
            tutorial.classList.remove("hidden");
            tutorialText.textContent = tutorialSteps[0];
            
            // 高亮當前步驟相關元素
            highlightCurrentStep();
            
            // 移除先前的點擊事件監聽器
            tutorialNext.removeEventListener("click", handleTutorialNextClick);
            
            // 定義並添加新的事件監聽器
            function handleTutorialNextClick() {
                // 清除先前的高亮
                clearHighlight();
                
                // 增加步驟計數
                tutorialStep++;
                console.log("教學進度: 步驟 " + tutorialStep + "/" + tutorialSteps.length);
                
                if (tutorialStep < tutorialSteps.length) {
                    // 更新教學內容
                    tutorialText.textContent = tutorialSteps[tutorialStep];
                    
                    // 高亮新步驟相關元素
                    highlightCurrentStep();
                    
                    // 根據步驟調整教學窗口位置
                    positionTutorialWindow();
                } else {
                    // 完成所有步驟後隱藏教學
                    console.log("教學完成，隱藏教學窗口");
                    tutorial.classList.add("hidden");
                }
            }
            
            // 添加新的事件監聽器
            tutorialNext.addEventListener("click", handleTutorialNextClick);
            
            // 初始調整位置
            positionTutorialWindow();
        }
        
        // 處理當前步驟的高亮
        function highlightCurrentStep() {
            // 確保每個步驟都有對應的選擇器（即使是null）
            const targetSelectors = [
                null,                    // 第1步不高亮任何元素
                null,                    // 第2步不高亮任何元素
                ".paper-bg:first-child", // 第3步高亮左側面板
                "#game-scene",           // 第4步高亮游戲場景
                "#action-buttons",       // 第5步高亮動作按鈕
                null,                    // 第6步不高亮任何元素
                "#poem-fragments",       // 第7步高亮詩句收集區
                null                     // 第8步不高亮任何元素
            ];
            
            console.log("嘗試高亮步驟 " + tutorialStep + " 的元素");
            
            // 檢查索引是否在範圍內
            if (tutorialStep >= 0 && tutorialStep < targetSelectors.length) {
                const selector = targetSelectors[tutorialStep];
                if (selector) {
                    console.log("高亮元素: " + selector);
                    highlightElement(selector);
                } else {
                    console.log("此步驟沒有需要高亮的元素");
                }
            } else {
                console.log("步驟索引超出範圍: " + tutorialStep);
            }
            
            // 調整教學窗口位置
            positionTutorialWindow();
        }
        
        // 根據當前步驟動態調整教學窗口位置
        function positionTutorialWindow() {
            // 清除所有位置類別
            tutorial.classList.remove("position-top", "position-right", "position-bottom", "position-left");
            
            // 根據步驟設置位置
            switch(tutorialStep) {
                case 0: // 歡迎介紹
                    // 中央偏右
                    tutorial.style.top = "50%";
                    tutorial.style.left = "50%";
                    tutorial.style.right = "auto";
                    tutorial.style.bottom = "auto";
                    tutorial.style.transform = "translate(-30%, -50%)";
                    tutorial.classList.add("position-left");
                    break;
                    
                case 1: // 遊戲時長
                    // 右上角
                    tutorial.style.top = "10%";
                    tutorial.style.right = "1.5rem";
                    tutorial.style.left = "auto";
                    tutorial.style.bottom = "auto";
                    tutorial.style.transform = "none";
                    tutorial.classList.add("position-left");
                    break;
                    
                case 2: // 左側面板
                    // 左側中央
                    tutorial.style.top = "30%";
                    tutorial.style.left = "25%";
                    tutorial.style.right = "auto";
                    tutorial.style.bottom = "auto";
                    tutorial.style.transform = "translateX(-50%)";
                    tutorial.classList.add("position-right");
                    break;
                    
                case 3: // 遊戲場景
                    // 中央偏上
                    tutorial.style.top = "25%";
                    tutorial.style.left = "60%";
                    tutorial.style.right = "auto";
                    tutorial.style.bottom = "auto";
                    tutorial.style.transform = "translateX(-50%)";
                    tutorial.classList.add("position-bottom");
                    break;
                    
                case 4: // 動作按鈕
                    // 下方中央
                    tutorial.style.bottom = "1.5rem";
                    tutorial.style.left = "50%";
                    tutorial.style.right = "auto";
                    tutorial.style.top = "auto";
                    tutorial.style.transform = "translateX(-50%)";
                    tutorial.classList.add("position-top");
                    break;
                    
                case 5: // 資源管理
                    // 左下角
                    tutorial.style.bottom = "1.5rem";
                    tutorial.style.left = "25%";
                    tutorial.style.right = "auto";
                    tutorial.style.top = "auto";
                    tutorial.style.transform = "translateX(-50%)";
                    tutorial.classList.add("position-top");
                    break;
                    
                case 6: // 詩句收集
                    // 左側下方
                    tutorial.style.bottom = "30%";
                    tutorial.style.left = "25%";
                    tutorial.style.right = "auto";
                    tutorial.style.top = "auto";
                    tutorial.style.transform = "translateX(-50%)";
                    tutorial.classList.add("position-right");
                    break;
                    
                case 7: // 結束提示
                default:
                    // 右下角
                    tutorial.style.bottom = "1.5rem";
                    tutorial.style.right = "1.5rem";
                    tutorial.style.left = "auto";
                    tutorial.style.top = "auto";
                    tutorial.style.transform = "none";
                    tutorial.classList.add("position-bottom");
                    break;
            }
        }

        function highlightElement(selector) {
            try {
                const element = document.querySelector(selector);
                if (!element) {
                    console.log("未找到元素: " + selector);
                    return;
                }
                
                // 添加高亮效果
                element.classList.add("tutorial-highlight");
                
                // 滾動到元素位置
                element.scrollIntoView({ behavior: "smooth", block: "center" });
                console.log("成功高亮元素: " + selector);
            } catch (error) {
                console.error("高亮元素時發生錯誤:", error);
            }
        }

        function clearHighlight() {
            // 移除所有高亮效果
            document.querySelectorAll(".tutorial-highlight").forEach(el => {
                el.classList.remove("tutorial-highlight");
            });
            console.log("已清除所有高亮效果");
        }
        
        // 工具函數 - 將數字轉為中文
        function convertToChinese(num) {
            const chineseNums = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九', '十'];
            
            if (num < 11) return chineseNums[num];
            
            if (num < 20) return '十' + (num > 10 ? chineseNums[num - 10] : '');
            
            if (num < 100) {
                const tens = Math.floor(num / 10);
                const ones = num % 10;
                return chineseNums[tens] + '十' + (ones > 0 ? chineseNums[ones] : '');
            }
            
            return num.toString();
        }
        
        // 獲取農曆日名稱
        function getLunarDayName(day) {
            const dayNames = [
                "初一", "初二", "初三", "初四", "初五", "初六", "初七", "初八", "初九", "初十",
                "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十",
                "廿一", "廿二", "廿三", "廿四", "廿五", "廿六", "廿七", "廿八", "廿九", "三十"
            ];
            return dayNames[day - 1] || "初一";
        }
    </script>















</body></html>