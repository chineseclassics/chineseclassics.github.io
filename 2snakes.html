<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›™è›‡å¤§æˆ° - Snake Clash</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ»¾å‹•æ¢ */
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 100vh;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            position: relative; /* æ–°å¢ï¼šç”¨æ–¼å®šä½å´é‚Šç©å®¶ä¿¡æ¯ */
        }

        /* éŠæˆ²æ¨™é¡Œæ¨£å¼ */
        .game-title {
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-title h1 {
            color: white;
            font-size: 36px;
            margin: 0;
            font-weight: 900;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        .game-title h2 {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            margin: 5px 0 0 0;
            font-weight: 400;
            letter-spacing: 2px;
            opacity: 0.8;
        }

        @keyframes titleGlow {
            0% {
                filter: brightness(1) drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
            }
            100% {
                filter: brightness(1.2) drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));
            }
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            width: min(800px, 90vw);
            margin-bottom: 15px;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        /* å´é‚Šç©å®¶ä¿¡æ¯ */
        .side-player-info {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15);
            padding: 25px 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 150px;
            z-index: 100;
        }

        .side-player-info.left {
            left: 20px;
            border-left: 8px solid #4CAF50;
        }

        .side-player-info.right {
            right: 20px;
            border-right: 8px solid #FF5722;
        }

        .player-name {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .level-display-large {
            font-size: 48px;
            font-weight: 900;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            color: #FFD700;
        }

        .controls-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }

        .special-effects {
            margin-top: 15px;
            font-size: 11px;
        }

        .effect-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 10px;
        }

        .effect-timer {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
        }

        .player-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .player1 { border-left: 5px solid #4CAF50; }
        .player2 { border-left: 5px solid #FF5722; }

        .level-display {
            font-size: 20px;
            margin: 3px 0;
        }

        .controls {
            font-size: 12px;
            opacity: 0.8;
        }

        #gameCanvas {
            border: 3px solid white;
            border-radius: 8px;
            background: #2c3e50;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.3);
            max-width: min(800px, 90vw);
            max-height: min(600px, 60vh);
        }

        .game-controls {
            margin-top: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .start-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .pause-btn {
            background: linear-gradient(45deg, #ff9800, #e68900);
        }

        .reset-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .mute-btn {
            background: linear-gradient(45deg, #9c27b0, #7b1fa2);
            padding: 10px 15px;
            font-size: 20px;
            min-width: 50px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(118, 75, 162, 0.8), rgba(102, 126, 234, 0.8));
            backdrop-filter: blur(15px);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            font-size: 24px;
            display: none;
            z-index: 1000;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .winner-text {
            font-size: 36px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: 12px;
            margin-top: 12px;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
            max-width: min(800px, 90vw);
        }

        .instructions h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .instructions p {
            margin: 6px 0;
            font-size: 12px;
            line-height: 1.4;
        }

        .food-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .food-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            margin: 2px 0;
        }

        .difficulty-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-weight: bold;
        }

        .difficulty-btn {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            font-size: 13px;
        }

        .difficulty-btn.active {
            background: white;
            color: #764ba2;
        }

        .difficulty-btn.active:hover, .difficulty-btn:disabled {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .difficulty-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* è‡ªå®šç¾©æç¤ºæ¡†æ¨£å¼ */
        .difficulty-btn {
            position: relative;
        }

        .difficulty-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            white-space: nowrap;
            max-width: 280px;
            white-space: normal;
            width: max-content;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: tooltipFadeIn 0.3s ease-out;
        }

        .difficulty-btn:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0, 0, 0, 0.9);
            z-index: 1001;
            animation: tooltipFadeIn 0.3s ease-out;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* å±å¹•éœ‡å‹•æ•ˆæœ */
        .screen-shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* éŸ³æ•ˆå¯è¦–åŒ–æ•ˆæœ */
        .sound-effect {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            animation: soundEffectFade 1s ease-out forwards;
        }

        @keyframes soundEffectFade {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px) scale(1.2);
            }
        }

        /* ç‰¹æ®Šé“å…·é–ƒçˆæ•ˆæœ */
        .special-item {
            animation: specialGlow 2s ease-in-out infinite alternate;
        }

        @keyframes specialGlow {
            0% {
                box-shadow: 0 0 5px currentColor;
            }
            100% {
                box-shadow: 0 0 15px currentColor, 0 0 25px currentColor;
            }
        }

        /* ç‰¹æ®Šèƒ½åŠ›è¦–è¦ºæ•ˆæœ */
        .speed-boost {
            animation: speedEffect 0.5s ease-in-out infinite alternate;
        }

        .ghost-mode {
            animation: ghostEffect 1s ease-in-out infinite alternate;
        }

        @keyframes speedEffect {
            0% { filter: hue-rotate(0deg) brightness(1); }
            100% { filter: hue-rotate(60deg) brightness(1.2); }
        }

        @keyframes ghostEffect {
            0% { opacity: 0.7; filter: blur(0px); }
            100% { opacity: 0.9; filter: blur(1px); }
        }
        /* ç§»å‹•ç«¯æç¤ºç•Œé¢ */
        .mobile-notice {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .mobile-content {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            color: white;
            padding: 20px 0;
        }

        .mobile-title {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mobile-subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        .game-preview {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .preview-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        .game-features {
            text-align: left;
            margin: 25px 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .feature-icon {
            font-size: 20px;
            margin-right: 12px;
            min-width: 30px;
        }

        .desktop-notice {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .desktop-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .desktop-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .desktop-text {
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .food-showcase {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }

        .food-showcase-item {
            text-align: center;
            padding: 10px 5px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .food-showcase-emoji {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .food-showcase-text {
            font-size: 10px;
            line-height: 1.2;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* ç§»å‹•ç«¯éš±è—æ¡Œé¢ç‰ˆéŠæˆ² */
        @media (max-width: 768px) {
            .mobile-notice {
                display: block;
            }
            .game-container {
                display: none;
            }
        }
    </style>
  </head>
<body>
    <!-- ç§»å‹•ç«¯æç¤ºç•Œé¢ -->
    <div class="mobile-notice">
        <div class="mobile-content">
            <div class="mobile-title">é›™è›‡å¤§æˆ°</div>
            <div class="mobile-subtitle">Snake Clash - å²ä¸Šæœ€åˆºæ¿€çš„é›™äººè›‡é¡å°æˆ°éŠæˆ²ï¼</div>
            
            <div class="game-preview">
                <div class="preview-icon">ğŸâš”ï¸ğŸ</div>
                <h3 style="margin: 15px 0; font-size: 20px;">æ¥µè‡´å°æˆ°é«”é©—</h3>
                <p style="font-size: 14px; line-height: 1.5; opacity: 0.9;">
                    å…©æ¢è›‡åœ¨åŒä¸€å€‹æˆ°å ´ä¸Šå±•é–‹ç”Ÿæ­»è¼ƒé‡ï¼åƒé£Ÿç‰©å‡ç´šï¼Œä½¿ç”¨ç‰¹æ®Šé“å…·ï¼Œ
                    é‹ç”¨ç­–ç•¥å’ŒæŠ€å·§æ“Šæ•—å°æ‰‹ã€‚èª°èƒ½æˆç‚ºæœ€çµ‚çš„è›‡ç‹ï¼Ÿ
                </p>
            </div>

            <div class="game-features">
                <div class="feature-item">
                    <span class="feature-icon">ğŸ®</span>
                    <span>é›™äººå³æ™‚å°æˆ°ï¼Œæ”¯æŒåŒå±ç«¶æŠ€</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">âš¡</span>
                    <span>å¤šç¨®ç‰¹æ®Šé“å…·ï¼šç¥é€Ÿç¬¦ã€å¹½éˆè—¥æ°´ã€é™·é˜±é“å…·</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ†</span>
                    <span>ç­–ç•¥æ€§ç©æ³•ï¼šé ­éƒ¨ç¢°æ’ã€èº«é«”èåˆã€ç‰†å£ç©¿è¶Š</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ¯</span>
                    <span>ä¸‰ç¨®é›£åº¦è¨­å®šï¼Œé©åˆä¸åŒæ°´å¹³ç©å®¶</span>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">ğŸ”Š</span>
                    <span>è±å¯ŒéŸ³æ•ˆç³»çµ±ï¼Œæ²‰æµ¸å¼éŠæˆ²é«”é©—</span>
                </div>
            </div>

            <div class="food-showcase">
                <div class="food-showcase-item">
                    <div class="food-showcase-emoji">ğŸŸ¡</div>
                    <div class="food-showcase-text">æ™®é€šé£Ÿç‰©<br/>+1ç´š</div>
                </div>
                <div class="food-showcase-item">
                    <div class="food-showcase-emoji">ğŸ’</div>
                    <div class="food-showcase-text">é‘½çŸ³é£Ÿç‰©<br/>+3ç´š</div>
                </div>
                <div class="food-showcase-item">
                    <div class="food-showcase-emoji">âš¡</div>
                    <div class="food-showcase-text">ç¥é€Ÿç¬¦<br/>é›™å€é€Ÿåº¦</div>
                </div>
                <div class="food-showcase-item">
                    <div class="food-showcase-emoji">ğŸ‘»</div>
                    <div class="food-showcase-text">å¹½éˆè—¥æ°´<br/>ç©¿ç‰†æ¨¡å¼</div>
                </div>
            </div>

            <div class="desktop-notice">
                <div class="desktop-icon">ğŸ’»</div>
                <div class="desktop-title">éœ€è¦æ¡Œé¢ç‰ˆé«”é©—</div>
                <div class="desktop-text">
                    ç”±æ–¼éŠæˆ²éœ€è¦éµç›¤æ“ä½œï¼ˆWASD + æ–¹å‘éµï¼‰ï¼Œç›®å‰ä¸æ”¯æŒç§»å‹•è¨­å‚™éŠç©ã€‚<br/><br/>
                    <strong>ğŸ“±â¡ï¸ğŸ’» è«‹åœ¨é›»è…¦ä¸Šæ‰“é–‹æ­¤é é¢ï¼Œé«”é©—å®Œæ•´çš„é›™äººå°æˆ°æ¨‚è¶£ï¼</strong><br/><br/>
                    æ”¯æŒæ‰€æœ‰ç¾ä»£ç€è¦½å™¨ï¼Œç„¡éœ€ä¸‹è¼‰å®‰è£ï¼Œé–‹å•Ÿå³ç©ï¼
                </div>
            </div>

            <div style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px;">
                <h4 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ¯ éŠæˆ²ç‰¹è‰²</h4>
                <p style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.9;">
                    â€¢ å‰µæ–°çš„ç¢°æ’æ©Ÿåˆ¶ï¼šé ­éƒ¨ç›¸æ’æ¯”ç­‰ç´šï¼Œèº«é«”ç›¸æ’æœƒèåˆå‡ç´š<br/>
                    â€¢ è±å¯Œçš„ç‰¹æ®Šé“å…·ç³»çµ±ï¼Œæ¯å±€éƒ½æœ‰ä¸åŒçš„æˆ°è¡“é«”é©—<br/>
                    â€¢ ç²¾ç¾çš„è¦–è¦ºæ•ˆæœå’ŒéŸ³æ•ˆï¼Œå¸¶ä¾†æ²‰æµ¸å¼éŠæˆ²æ„Ÿå—<br/>
                    â€¢ æ”¯æŒæš«åœã€é‡ç½®å’ŒéŸ³æ•ˆé–‹é—œç­‰è²¼å¿ƒåŠŸèƒ½
                </p>
            </div>

            <div style="margin-top: 20px; font-size: 12px; opacity: 0.7;">
                ğŸŒŸ ç«‹å³åœ¨é›»è…¦ä¸Šé«”é©—é€™æ¬¾ä»¤äººä¸Šç™®çš„é›™äººå°æˆ°éŠæˆ²ï¼
            </div>
        </div>
    </div>
    <div class="game-container">
        <!-- å·¦å´ç©å®¶ä¿¡æ¯ -->
        <div class="side-player-info left">
            <div class="player-name">ğŸ ç©å®¶1</div>
            <div class="level-display-large" id="player1Level">3</div>
            <div class="controls-info">WASDæ§åˆ¶</div>
            <div class="special-effects" id="player1Effects"></div>
        </div>

        <!-- å³å´ç©å®¶ä¿¡æ¯ -->
        <div class="side-player-info right">
            <div class="player-name">ğŸ ç©å®¶2</div>
            <div class="level-display-large" id="player2Level">3</div>
            <div class="controls-info">æ–¹å‘éµæ§åˆ¶</div>
            <div class="special-effects" id="player2Effects"></div>
        </div>

        <!-- éŠæˆ²æ¨™é¡Œ -->
        <div class="game-title">
            <h1>é›™è›‡å¤§æˆ°</h1>
            <h2>Snake Clash</h2>
        </div>

        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div class="game-controls">
            <div class="difficulty-selector">
                <span>é›£åº¦:</span>
                <button class="difficulty-btn" onclick="setDifficulty('Hard', this)" data-tooltip="ğŸ”¥ å›°é›£æ¨¡å¼ï¼šç§»å‹•é€Ÿåº¦æœ€å¿«ï¼Œæ’ç‰†æ‰£1ç´šï¼Œè€ƒé©—åæ‡‰é€Ÿåº¦å’Œæ“ä½œæŠ€å·§">å›°é›£</button>
                <button class="difficulty-btn active" onclick="setDifficulty('Normal', this)" data-tooltip="âš–ï¸ æ­£å¸¸æ¨¡å¼ï¼šç§»å‹•é€Ÿåº¦é©ä¸­ï¼Œæ’ç‰†æ‰£1ç´šï¼Œå¹³è¡¡çš„éŠæˆ²é«”é©—">æ­£å¸¸</button>
                <button class="difficulty-btn" onclick="setDifficulty('Easy', this)" data-tooltip="ğŸˆ å®¹æ˜“æ¨¡å¼ï¼šç§»å‹•é€Ÿåº¦è¼ƒæ…¢ï¼Œæ’ç‰†å¯ç©¿è¶Šä¸æ‰£åˆ†ï¼Œé©åˆæ–°æ‰‹ç·´ç¿’">å®¹æ˜“</button>
            </div>
            <button class="start-btn" onclick="startGame()">ğŸ® é–‹å§‹éŠæˆ²</button>
            <button class="pause-btn" onclick="togglePause()">â¸ï¸ æš«åœ</button>
            <button class="reset-btn" onclick="resetGame()">ğŸ”„ é‡æ–°é–‹å§‹</button>
            <button class="mute-btn" id="mute-btn" onclick="toggleMute()">ğŸ”Š</button>
        </div>

        <div class="instructions">
            <h3>ğŸ¯ éŠæˆ²è¦å‰‡</h3>
            <div class="food-legend">
                <div class="food-item">ğŸŸ¡ æ™®é€šé£Ÿç‰© (+1ç´š)</div>
                <div class="food-item">ğŸ”´ å¤§é£Ÿç‰© (+2ç´š)</div>
                <div class="food-item">ğŸ’ é‘½çŸ³é£Ÿç‰© (+3ç´š)</div>
                <div class="food-item">ğŸ… é»ƒé‡‘æœ (+5ç´š)</div>
                <div class="food-item">âš¡ ç¥é€Ÿç¬¦ (é›™å€é€Ÿåº¦5ç§’)</div>
                <div class="food-item">ğŸ‘» å¹½éˆè—¥æ°´ (ç©¿ç‰†5ç§’)</div>
                <div class="food-item">ğŸ–Œï¸ ç•«ç­† (ç”Ÿæˆå‡é£Ÿç‰©é™·é˜±)</div>
                <div class="food-item">ğŸ’© å¤§ä¾¿ç‚¸å½ˆ (ç”Ÿæˆ3å€‹é™·é˜±)</div>
            </div>
            <p>ğŸ’¥ é ­éƒ¨ç›¸æ’ï¼šç­‰ç´šé«˜è€…å‹å‡º | ğŸ¤ èº«é«”ç›¸æ’ï¼šç­‰ç´šç›¸åŠ å¹³åˆ† | ğŸš§ æ’ç‰†æ¸›1ç´š</p>
            <p>ğŸ”Š éŠæˆ²åŒ…å«éŸ³æ•ˆï¼Œé»æ“ŠéŸ³é‡éµé–‹é—œ</p>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="winner-text" id="winnerText"></div>
        <button class="reset-btn" onclick="resetGame()" style="margin-top: 20px;">å†ä¾†ä¸€å±€</button>
    </div>

    <script>
        // --- éŸ³æ•ˆç®¡ç†å™¨ ---
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.sounds = new Map();
                this.loadingPromises = new Map();
                this.isMuted = localStorage.getItem('snakeMuted') === 'true';

                this.soundsToLoad = {
                    'eat': 'https://chineseclassics.github.io/files/audio/cilong/eat.mp3',
                    'success': 'https://chineseclassics.github.io/files/audio/cilong/success.mp3',
                    'combo': 'https://chineseclassics.github.io/files/audio/cilong/combo.mp3',
                    'powerup': 'https://chineseclassics.github.io/files/audio/cilong/powerup.mp3',
                    'debuff': 'https://chineseclassics.github.io/files/audio/cilong/debuff.mp3',
                    'gameover': 'https://chineseclassics.github.io/files/audio/cilong/gameover.mp3',
                    'click': 'https://chineseclassics.github.io/files/audio/cilong/click.mp3'
                };

                this.updateMuteButton();
            }

            initAudioContext() {
                if (this.audioContext) return;
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("AudioContext created on demand.");
                    this.preloadAllSounds();
                } catch (e) {
                    console.error("Could not create or resume AudioContext.", e);
                }
            }

            loadSound(key) {
                if (this.loadingPromises.has(key)) {
                    return this.loadingPromises.get(key);
                }
                
                if (this.sounds.has(key)) {
                    return Promise.resolve(this.sounds.get(key));
                }

                if (!this.soundsToLoad[key]) {
                    return Promise.reject(new Error(`Sound key "${key}" not found.`));
                }

                const promise = fetch(this.soundsToLoad[key])
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} for ${key}`);
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => this.audioContext.decodeAudioData(arrayBuffer))
                    .then(audioBuffer => {
                        this.sounds.set(key, audioBuffer);
                        this.loadingPromises.delete(key);
                        return audioBuffer;
                    }).catch(error => {
                        console.error(`éŸ³é »åŠ è¼‰å¤±æ•—: ${key}`, error);
                        this.loadingPromises.delete(key);
                        throw { key: key, error: error };
                    });
                
                this.loadingPromises.set(key, promise);
                return promise;
            }

            preloadAllSounds() {
                if (!this.audioContext) return;
                console.log("Preloading all sounds...");
                
                const promises = [];
                for (const key in this.soundsToLoad) {
                    promises.push(this.loadSound(key));
                }

                Promise.all(promises)
                    .then(() => {
                        console.log('æ‰€æœ‰éŸ³æ•ˆåŠ è¼‰æˆåŠŸï¼');
                    })
                    .catch((error) => {
                        console.warn('éƒ¨åˆ†éŸ³æ•ˆåŠ è¼‰å¤±æ•—ï¼ŒéŠæˆ²å°‡æ­£å¸¸é‹è¡Œã€‚', error);
                    });
            }

            async play(key, options = {}) {
                if (this.isMuted) return;

                if (!this.audioContext) {
                    this.initAudioContext();
                }
                
                if (!this.audioContext) {
                    console.warn("AudioContext could not be initialized, skipping play.");
                    return;
                }

                if (this.audioContext.state === 'suspended') {
                    await this.audioContext.resume();
                }

                try {
                    const buffer = await this.loadSound(key);
                    const source = this.audioContext.createBufferSource();
                    source.buffer = buffer;

                    const gainNode = this.audioContext.createGain();
                    gainNode.gain.value = options.volume || 0.6;

                    if (options.pitch) {
                        source.playbackRate.value = options.pitch;
                    }

                    source.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    source.start(0);
                } catch (error) {
                    console.warn(`Could not play sound: ${key}`, error);
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                localStorage.setItem('snakeMuted', this.isMuted);
                this.updateMuteButton();
                if (!this.isMuted) {
                    this.play('click');
                }
            }

            updateMuteButton() {
                const muteBtn = document.getElementById('mute-btn');
                if (muteBtn) {
                    muteBtn.textContent = this.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
                }
            }
        }

        // --- éŸ³æ•ˆå¯è¦–åŒ– ---
        function showSoundEffect(text, x, y) {
            const effect = document.createElement('div');
            effect.className = 'sound-effect';
            effect.textContent = text;
            effect.style.left = x + 'px';
            effect.style.top = y + 'px';
            document.body.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 1000);
        }

        // éŠæˆ²é‚è¼¯
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        
        // åˆå§‹åŒ–éŸ³æ•ˆç®¡ç†å™¨
        const audioManager = new AudioManager();

        let gameRunning = false;
        let gamePaused = false;
        let gameLoop;
        let gameDifficulty = 'Normal'; // æ–°å¢é›£åº¦ç­‰ç´šè®Šé‡

        // è›‡çš„åˆå§‹è¨­ç½®
        let snake1 = {
            body: [{x: 100, y: 100}, {x: 80, y: 100}, {x: 60, y: 100}],
            direction: {x: 1, y: 0},
            nextDirection: {x: 1, y: 0}, // é è¨­ä¸‹ä¸€å€‹æ–¹å‘
            level: 3,
            color: '#4CAF50',
            speedBoost: 0, // ç¥é€Ÿç¬¦å‰©é¤˜æ™‚é–“
            ghostMode: 0   // å¹½éˆæ¨¡å¼å‰©é¤˜æ™‚é–“
        };

        let snake2 = {
            body: [{x: 700, y: 500}, {x: 720, y: 500}, {x: 740, y: 500}],
            direction: {x: -1, y: 0},
            nextDirection: {x: -1, y: 0}, // é è¨­ä¸‹ä¸€å€‹æ–¹å‘
            level: 3,
            color: '#FF5722',
            speedBoost: 0, // ç¥é€Ÿç¬¦å‰©é¤˜æ™‚é–“
            ghostMode: 0   // å¹½éˆæ¨¡å¼å‰©é¤˜æ™‚é–“
        };

        let foods = [];
        const maxFoods = 15;
        let fakeFood = null; // å‡é£Ÿç‰©
        let poops = []; // å¤§ä¾¿é™·é˜±

        // é£Ÿç‰©é¡å‹
        const foodTypes = [
            { emoji: 'ğŸŸ¡', value: 1, probability: 0.60, color: '#FFD700', type: 'normal' },
            { emoji: 'ğŸ”´', value: 2, probability: 0.22, color: '#FF4444', type: 'normal' },
            { emoji: 'ğŸ’', value: 3, probability: 0.06, color: '#00FFFF', type: 'normal' },
            { emoji: 'ğŸ…', value: 5, probability: 0.012, color: '#FFD700', type: 'golden' },
            { emoji: 'âš¡', value: 0, probability: 0.008, color: '#4169E1', type: 'speed' },
            { emoji: 'ğŸ‘»', value: 0, probability: 0.004, color: '#F0F8FF', type: 'ghost' },
            { emoji: 'ğŸ–Œï¸', value: 0, probability: 0.006, color: '#8B4513', type: 'brush' },
            { emoji: 'ğŸ’©', value: 0, probability: 0.004, color: '#8B4513', type: 'poop' }
        ];

        function setDifficulty(level, btnElement) {
            if (gameRunning) return; // éŠæˆ²é€²è¡Œä¸­ä¸èƒ½æ›´æ”¹é›£åº¦
            gameDifficulty = level;

            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            
            audioManager.play('click');
        }

        // éµç›¤æ§åˆ¶ - å³æ™‚éŸ¿æ‡‰ç‰ˆæœ¬ï¼Œé˜»æ­¢é é¢æ»¾å‹•
        const keys = {};
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            
            // é˜»æ­¢éŠæˆ²æ§åˆ¶éµçš„é»˜èªè¡Œç‚ºï¼ˆé˜²æ­¢é é¢æ»¾å‹•ï¼‰
            if (['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key)) {
                e.preventDefault();
            }
            
            keys[key] = true;
            // ç«‹å³è™•ç†è¼¸å…¥ï¼Œä¸ç­‰å¾…éŠæˆ²å¾ªç’°
            if (gameRunning && !gamePaused) {
                handleInput();
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            
            // é˜»æ­¢éŠæˆ²æ§åˆ¶éµçš„é»˜èªè¡Œç‚º
            if (['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key)) {
                e.preventDefault();
            }
            
            keys[key] = false;
        });

        function handleInput() {
            // ç©å®¶1 (WASD) - ç«‹å³éŸ¿æ‡‰ï¼Œä¸ç­‰å¾…éŠæˆ²å¾ªç’°
            if (keys['w'] && snake1.direction.y === 0) {
                snake1.nextDirection = {x: 0, y: -1};
                audioManager.play('click', { volume: 0.2 });
            }
            if (keys['s'] && snake1.direction.y === 0) {
                snake1.nextDirection = {x: 0, y: 1};
                audioManager.play('click', { volume: 0.2 });
            }
            if (keys['a'] && snake1.direction.x === 0) {
                snake1.nextDirection = {x: -1, y: 0};
                audioManager.play('click', { volume: 0.2 });
            }
            if (keys['d'] && snake1.direction.x === 0) {
                snake1.nextDirection = {x: 1, y: 0};
                audioManager.play('click', { volume: 0.2 });
            }

            // ç©å®¶2 (æ–¹å‘éµ) - ç«‹å³éŸ¿æ‡‰ï¼Œä¸ç­‰å¾…éŠæˆ²å¾ªç’°
            if (keys['arrowup'] && snake2.direction.y === 0) {
                snake2.nextDirection = {x: 0, y: -1};
                audioManager.play('click', { volume: 0.2 });
            }
            if (keys['arrowdown'] && snake2.direction.y === 0) {
                snake2.nextDirection = {x: 0, y: 1};
                audioManager.play('click', { volume: 0.2 });
            }
            if (keys['arrowleft'] && snake2.direction.x === 0) {
                snake2.nextDirection = {x: -1, y: 0};
                audioManager.play('click', { volume: 0.2 });
            }
            if (keys['arrowright'] && snake2.direction.x === 0) {
                snake2.nextDirection = {x: 1, y: 0};
                audioManager.play('click', { volume: 0.2 });
            }
        }

        function generateFood() {
            while (foods.length < maxFoods) {
                const x = Math.floor(Math.random() * (canvas.width / gridSize)) * gridSize;
                const y = Math.floor(Math.random() * (canvas.height / gridSize)) * gridSize;

                // ç¢ºä¿é£Ÿç‰©ä¸åœ¨è›‡èº«ä¸Š
                if (!isPositionOccupied(x, y)) {
                    const rand = Math.random();
                    let foodType = foodTypes[0]; // é»˜èªæ™®é€šé£Ÿç‰©

                    let cumulative = 0;
                    for (const type of foodTypes) {
                        cumulative += type.probability;
                        if (rand <= cumulative) {
                            foodType = type;
                            break;
                        }
                    }

                    foods.push({
                        x: x,
                        y: y,
                        type: foodType
                    });
                }
            }
        }

        function isPositionOccupied(x, y) {
            return snake1.body.some(segment => segment.x === x && segment.y === y) ||
                   snake2.body.some(segment => segment.x === x && segment.y === y) ||
                   foods.some(food => food.x === x && food.y === y) ||
                   (fakeFood && fakeFood.x === x && fakeFood.y === y) ||
                   poops.some(poop => poop.x === x && poop.y === y);
        }

        // å‰µå»ºå‡é£Ÿç‰©
        function createFakeFood(creatorSnake) {
            if (fakeFood) return; // å·²ç¶“å­˜åœ¨å‡é£Ÿç‰©

            // åœ¨éš¨æ©Ÿä½ç½®ç”Ÿæˆå‡é£Ÿç‰©
            let x, y;
            do {
                x = Math.floor(Math.random() * (canvas.width / gridSize)) * gridSize;
                y = Math.floor(Math.random() * (canvas.height / gridSize)) * gridSize;
            } while (isPositionOccupied(x, y) || 
                     (Math.abs(x - creatorSnake.body[0].x) < 100 && Math.abs(y - creatorSnake.body[0].y) < 100));

            fakeFood = {
                x: x,
                y: y,
                creator: creatorSnake,
                timer: 300, // 30ç§’å¾Œæ¶ˆå¤±
                type: foodTypes[Math.floor(Math.random() * 4)] // å½è£æˆæ™®é€šé£Ÿç‰©
            };
        }

        // å‰µå»ºå¤§ä¾¿é™·é˜±
        function createPoopTraps(creatorSnake) {
            const newPoops = [];
            for (let i = 0; i < 3; i++) {
                let x, y;
                let attempts = 0;
                do {
                    x = Math.floor(Math.random() * (canvas.width / gridSize)) * gridSize;
                    y = Math.floor(Math.random() * (canvas.height / gridSize)) * gridSize;
                    attempts++;
                } while (isPositionOccupied(x, y) && attempts < 50);

                if (attempts < 50) {
                    newPoops.push({
                        x: x,
                        y: y,
                        creator: creatorSnake,
                        timer: 200 // 20ç§’å¾Œæ¶ˆå¤±
                    });
                }
            }
            poops = poops.concat(newPoops);
        }

        function moveSnake(snake) {
            // æ‡‰ç”¨é è¨­çš„æ–¹å‘è®ŠåŒ–ï¼Œå¯¦ç¾å³æ™‚éŸ¿æ‡‰
            snake.direction = snake.nextDirection;
            
            const head = {...snake.body[0]};
            head.x += snake.direction.x * gridSize;
            head.y += snake.direction.y * gridSize;

            // æª¢æŸ¥é‚Šç•Œç¢°æ’ï¼ˆå¹½éˆæ¨¡å¼å¯ç©¿ç‰†ï¼‰
            if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height) {
                if (snake.ghostMode > 0) {
                    // å¹½éˆæ¨¡å¼ï¼šå¾å¦ä¸€é‚Šç©¿å‡ºï¼Œä¸æ‰£åˆ†
                    if (head.x < 0) head.x = canvas.width - gridSize;
                    if (head.x >= canvas.width) head.x = 0;
                    if (head.y < 0) head.y = canvas.height - gridSize;
                    if (head.y >= canvas.height) head.y = 0;
                    audioManager.play('click', { pitch: 1.8, volume: 0.3 });
                    showSoundEffect('ç©¿ç‰†ï¼', head.x, head.y - 20);
                } else if (gameDifficulty === 'Easy') {
                    // å¾å¦ä¸€é‚Šé‘½å‡ºä¾†ï¼Œä¸æ‰£åˆ†
                    if (head.x < 0) head.x = canvas.width - gridSize;
                    if (head.x >= canvas.width) head.x = 0;
                    if (head.y < 0) head.y = canvas.height - gridSize;
                    if (head.y >= canvas.height) head.y = 0;
                    audioManager.play('click', { pitch: 1.5, volume: 0.4 });
                } else { // 'Normal' or other difficulties
                    snake.level = Math.max(1, snake.level - 1);
                    audioManager.play('debuff', { volume: 0.5 });
                    showSoundEffect('æ’ç‰† -1', head.x, head.y);
                    triggerScreenShake(); // è§¸ç™¼å±å¹•éœ‡å‹•
                    
                    // é‡æ–°å®šä½åˆ°å®‰å…¨ä½ç½®
                    if (head.x < 0) head.x = canvas.width - gridSize;
                    if (head.x >= canvas.width) head.x = 0;
                    if (head.y < 0) head.y = canvas.height - gridSize;
                    if (head.y >= canvas.height) head.y = 0;
                }
            }

            snake.body.unshift(head);

            // æª¢æŸ¥æ˜¯å¦åƒåˆ°å‡é£Ÿç‰©
            if (fakeFood && fakeFood.x === head.x && fakeFood.y === head.y) {
                if (fakeFood.creator !== snake) {
                    // å°æ–¹è¸©åˆ°å‡é£Ÿç‰©ï¼Œé™ç´š
                    snake.level = Math.max(1, snake.level - 1);
                    audioManager.play('debuff', { volume: 0.8 });
                    showSoundEffect('ä¸­è¨ˆ -1', head.x, head.y - 20);
                    triggerScreenShake();
                } else {
                    // å‰µé€ è€…åƒåˆ°è‡ªå·±çš„å‡é£Ÿç‰©ï¼Œæ²’æœ‰æ•ˆæœ
                    audioManager.play('click', { volume: 0.3 });
                    showSoundEffect('è‡ªå·±çš„é™·é˜±', head.x - 20, head.y - 20);
                }
                fakeFood = null; // ç§»é™¤å‡é£Ÿç‰©
            }

            // æª¢æŸ¥æ˜¯å¦è¸©åˆ°å¤§ä¾¿
            const poopIndex = poops.findIndex(poop => poop.x === head.x && poop.y === head.y);
            if (poopIndex !== -1) {
                const poop = poops[poopIndex];
                if (poop.creator !== snake) {
                    // å°æ–¹è¸©åˆ°å¤§ä¾¿ï¼Œé™2ç´š
                    snake.level = Math.max(1, snake.level - 2);
                    audioManager.play('debuff', { volume: 1.0, pitch: 0.7 });
                    showSoundEffect('è¸©å± -2', head.x, head.y - 20);
                    triggerScreenShake();
                } else {
                    // å‰µé€ è€…è¸©åˆ°è‡ªå·±çš„å¤§ä¾¿ï¼Œæ²’æœ‰æ•ˆæœ
                    audioManager.play('click', { volume: 0.3, pitch: 0.8 });
                    showSoundEffect('è‡ªå·±çš„å±', head.x - 20, head.y - 20);
                }
                poops.splice(poopIndex, 1); // ç§»é™¤å¤§ä¾¿
            }

            // æª¢æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            const foodIndex = foods.findIndex(food => food.x === head.x && food.y === head.y);
            if (foodIndex !== -1) {
                const food = foods[foodIndex];
                foods.splice(foodIndex, 1);
                
                // æ ¹æ“šé£Ÿç‰©é¡å‹è™•ç†ä¸åŒæ•ˆæœ
                switch (food.type.type) {
                    case 'normal':
                        snake.level += food.type.value;
                        if (food.type.value === 1) {
                            audioManager.play('eat', { volume: 0.8 });
                            showSoundEffect('+1', head.x, head.y - 20);
                        } else if (food.type.value === 2) {
                            audioManager.play('success', { volume: 0.8 });
                            showSoundEffect('+2', head.x, head.y - 20);
                        } else if (food.type.value === 3) {
                            audioManager.play('powerup', { volume: 0.9 });
                            showSoundEffect('+3', head.x, head.y - 20);
                        }
                        // æ·»åŠ èº«é«”ç¯€æ®µ
                        for (let i = 0; i < food.type.value; i++) {
                            snake.body.push({...snake.body[snake.body.length - 1]});
                        }
                        break;
                    
                    case 'golden':
                        snake.level += food.type.value;
                        audioManager.play('powerup', { volume: 1.0, pitch: 1.2 });
                        showSoundEffect('é»ƒé‡‘æœ +5!', head.x - 20, head.y - 30);
                        // æ·»åŠ èº«é«”ç¯€æ®µ
                        for (let i = 0; i < food.type.value; i++) {
                            snake.body.push({...snake.body[snake.body.length - 1]});
                        }
                        break;
                    
                    case 'speed':
                        snake.speedBoost = 50; // 5ç§’ï¼ˆä»¥éŠæˆ²å¹€è¨ˆç®—ï¼‰
                        audioManager.play('combo', { volume: 0.9, pitch: 1.5 });
                        showSoundEffect('ç¥é€Ÿç¬¦ï¼', head.x - 20, head.y - 30);
                        break;
                    
                    case 'ghost':
                        snake.ghostMode = 50; // 5ç§’ï¼ˆä»¥éŠæˆ²å¹€è¨ˆç®—ï¼‰
                        audioManager.play('powerup', { volume: 0.9, pitch: 0.8 });
                        showSoundEffect('å¹½éˆæ¨¡å¼ï¼', head.x - 25, head.y - 30);
                        break;
                    
                    case 'brush':
                        createFakeFood(snake);
                        audioManager.play('combo', { volume: 0.8, pitch: 1.3 });
                        showSoundEffect('ç•«ç­†é™·é˜±ï¼', head.x - 25, head.y - 30);
                        break;
                    
                    case 'poop':
                        createPoopTraps(snake);
                        audioManager.play('debuff', { volume: 0.8, pitch: 0.6 });
                        showSoundEffect('å¤§ä¾¿ç‚¸å½ˆï¼', head.x - 25, head.y - 30);
                        break;
                }
            } else {
                // ç¶­æŒè›‡çš„é•·åº¦ç­‰æ–¼ç­‰ç´š
                while (snake.body.length > snake.level) {
                    snake.body.pop();
                }
            }
        }

        function checkCollisions() {
            const head1 = snake1.body[0];
            const head2 = snake2.body[0];

            // æª¢æŸ¥é ­éƒ¨ç›¸æ’ï¼ˆå¹½éˆæ¨¡å¼ç„¡æ•ˆæœï¼‰
            if (head1.x === head2.x && head1.y === head2.y) {
                if (snake1.ghostMode > 0 || snake2.ghostMode > 0) {
                    audioManager.play('click', { pitch: 2.0, volume: 0.4 });
                    showSoundEffect('ç©¿é€ï¼', head1.x, head1.y - 30);
                    return false;
                }
                
                if (snake1.level > snake2.level) {
                    audioManager.play('success', { volume: 1.0 });
                    endGame("ğŸŸ¢ ç¶ è›‡å‹åˆ©ï¼");
                } else if (snake2.level > snake1.level) {
                    audioManager.play('success', { volume: 1.0 });
                    endGame("ğŸ”´ ç´…è›‡å‹åˆ©ï¼");
                } else {
                    audioManager.play('gameover', { volume: 1.0 });
                    endGame("ğŸ’¥ å¹³æ‰‹ï¼åŒæ­¸æ–¼ç›¡ï¼");
                }
                return true;
            }

            // æª¢æŸ¥è›‡1é ­éƒ¨æ’åˆ°è›‡2èº«é«”ï¼ˆå¹½éˆæ¨¡å¼å¯ç©¿é€ï¼‰
            if (snake1.ghostMode === 0) {
                for (let i = 1; i < snake2.body.length; i++) {
                    if (head1.x === snake2.body[i].x && head1.y === snake2.body[i].y) {
                        const totalLevel = snake1.level + snake2.level;
                        const newLevel1 = Math.ceil(totalLevel / 2);
                        const newLevel2 = Math.floor(totalLevel / 2);
                        
                        audioManager.play('combo', { volume: 0.8 });
                        showSoundEffect(`åˆé«”å‡ç´šï¼`, head1.x - 20, head1.y - 30);
                        
                        snake1.level = newLevel1;
                        snake2.level = newLevel2;
                        adjustSnakeLength(snake1);
                        adjustSnakeLength(snake2);
                        return false;
                    }
                }
            }

            // æª¢æŸ¥è›‡2é ­éƒ¨æ’åˆ°è›‡1èº«é«”ï¼ˆå¹½éˆæ¨¡å¼å¯ç©¿é€ï¼‰
            if (snake2.ghostMode === 0) {
                for (let i = 1; i < snake1.body.length; i++) {
                    if (head2.x === snake1.body[i].x && head2.y === snake1.body[i].y) {
                        const totalLevel = snake1.level + snake2.level;
                        const newLevel1 = Math.ceil(totalLevel / 2);
                        const newLevel2 = Math.floor(totalLevel / 2);
                        
                        audioManager.play('combo', { volume: 0.8 });
                        showSoundEffect(`åˆé«”å‡ç´šï¼`, head2.x - 20, head2.y - 30);
                        
                        snake1.level = newLevel1;
                        snake2.level = newLevel2;
                        adjustSnakeLength(snake1);
                        adjustSnakeLength(snake2);
                        return false;
                    }
                }
            }

            // æª¢æŸ¥è‡ªæ’ï¼ˆå¹½éˆæ¨¡å¼å¯ç©¿é€ï¼‰
            if (snake1.ghostMode === 0) {
                for (let i = 1; i < snake1.body.length; i++) {
                    if (head1.x === snake1.body[i].x && head1.y === snake1.body[i].y) {
                        snake1.level = Math.max(1, snake1.level - 1);
                        audioManager.play('debuff', { volume: 0.6 });
                        showSoundEffect('è‡ªæ’ -1', head1.x, head1.y - 20);
                        adjustSnakeLength(snake1);
                    }
                }
            }

            if (snake2.ghostMode === 0) {
                for (let i = 1; i < snake2.body.length; i++) {
                    if (head2.x === snake2.body[i].x && head2.y === snake2.body[i].y) {
                        snake2.level = Math.max(1, snake2.level - 1);
                        audioManager.play('debuff', { volume: 0.6 });
                        showSoundEffect('è‡ªæ’ -1', head2.x, head2.y - 20);
                        adjustSnakeLength(snake2);
                    }
                }
            }

            return false;
        }

        function adjustSnakeLength(snake) {
            while (snake.body.length > snake.level) {
                snake.body.pop();
            }
            while (snake.body.length < snake.level) {
                snake.body.push({...snake.body[snake.body.length - 1]});
            }
        }

        function draw() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½é£Ÿç‰©
            foods.forEach(food => {
                // ç‰¹æ®Šé“å…·é–ƒçˆæ•ˆæœ
                if (food.type.type !== 'normal') {
                    const time = Date.now() * 0.005;
                    const alpha = 0.7 + 0.3 * Math.sin(time);
                    const glowSize = 2 + Math.sin(time) * 2;
                    
                    // å¤–åœå…‰æšˆ
                    ctx.fillStyle = food.type.color + '40';
                    ctx.fillRect(food.x - glowSize, food.y - glowSize, gridSize + glowSize * 2, gridSize + glowSize * 2);
                }
                
                ctx.fillStyle = food.type.color;
                ctx.fillRect(food.x + 2, food.y + 2, gridSize - 4, gridSize - 4);
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(food.type.emoji, food.x + gridSize/2, food.y + gridSize/2);
            });

            // ç¹ªè£½å‡é£Ÿç‰©
            if (fakeFood) {
                // å‡é£Ÿç‰©æœ‰å¾®å¦™çš„é–ƒçˆæ•ˆæœä¾†æš—ç¤ºå®ƒæ˜¯é™·é˜±
                const time = Date.now() * 0.008;
                const alpha = 0.8 + 0.2 * Math.sin(time);
                const glowSize = 1 + Math.sin(time) * 1;
                
                // ç•¥å¾®ä¸åŒçš„å…‰æšˆï¼ˆç¨å¾®æš—ä¸€äº›ï¼‰
                ctx.fillStyle = fakeFood.type.color + '30';
                ctx.fillRect(fakeFood.x - glowSize, fakeFood.y - glowSize, gridSize + glowSize * 2, gridSize + glowSize * 2);
                
                ctx.fillStyle = fakeFood.type.color;
                ctx.fillRect(fakeFood.x + 2, fakeFood.y + 2, gridSize - 4, gridSize - 4);
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(fakeFood.type.emoji, fakeFood.x + gridSize/2, fakeFood.y + gridSize/2);
            }

            // ç¹ªè£½å¤§ä¾¿é™·é˜±
            poops.forEach(poop => {
                // å¤§ä¾¿æœ‰æ£•è‰²èƒŒæ™¯å’Œæƒ¡è‡­æ•ˆæœ
                const time = Date.now() * 0.003;
                const stinkSize = 3 + Math.sin(time) * 1;
                
                // æƒ¡è‡­æ•ˆæœ
                ctx.fillStyle = '#8B4513' + '20';
                ctx.fillRect(poop.x - stinkSize, poop.y - stinkSize, gridSize + stinkSize * 2, gridSize + stinkSize * 2);
                
                ctx.fillStyle = '#654321';
                ctx.fillRect(poop.x + 2, poop.y + 2, gridSize - 4, gridSize - 4);
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ’©', poop.x + gridSize/2, poop.y + gridSize/2);
            });

            // ç¹ªè£½è›‡
            drawSnake(snake1);
            drawSnake(snake2);

            // æ›´æ–°ç­‰ç´šé¡¯ç¤º
            document.getElementById('player1Level').textContent = snake1.level;
            document.getElementById('player2Level').textContent = snake2.level;
            
            // æ›´æ–°ç‰¹æ®Šæ•ˆæœé¡¯ç¤º
            updateSpecialEffectsDisplay();
        }

        function drawSnake(snake) {
            snake.body.forEach((segment, index) => {
                const opacity = index === 0 ? 1 : 0.8 - (index / snake.body.length) * 0.3;
                const size = index === 0 ? gridSize - 2 : gridSize - 4;
                const offset = index === 0 ? 1 : 2;

                // ç‰¹æ®Šæ•ˆæœè™•ç†
                let finalColor = snake.color;
                let extraEffects = false;
                
                if (snake.speedBoost > 0) {
                    // ç¥é€Ÿç¬¦æ•ˆæœï¼šé¡è‰²è®ŠåŒ–å’Œå…‰æšˆ
                    const time = Date.now() * 0.01;
                    const colorShift = Math.sin(time) * 0.3;
                    finalColor = `hsl(${snake === snake1 ? 120 + colorShift * 60 : 15 + colorShift * 60}, 70%, 50%)`;
                    extraEffects = true;
                }
                
                if (snake.ghostMode > 0) {
                    // å¹½éˆæ•ˆæœï¼šåŠé€æ˜å’Œé–ƒçˆ
                    const ghostOpacity = 0.5 + 0.3 * Math.sin(Date.now() * 0.015);
                    opacity *= ghostOpacity;
                    extraEffects = true;
                }

                // ç¹ªè£½åŸºç¤ç™¼å…‰æ•ˆæœï¼ˆæ‰€æœ‰è›‡èº«éƒ½æœ‰ï¼‰
                const baseGlowSize = index === 0 ? 3 : 2;
                const baseGlowOpacity = index === 0 ? '60' : '40';
                ctx.fillStyle = finalColor + baseGlowOpacity;
                ctx.fillRect(segment.x + offset - baseGlowSize, segment.y + offset - baseGlowSize, 
                           size + baseGlowSize * 2, size + baseGlowSize * 2);

                // ç¹ªè£½é›™å±¤å…‰æšˆæ•ˆæœï¼ˆè›‡é ­æ›´æ˜é¡¯ï¼‰
                if (index === 0) {
                    const innerGlowSize = 1;
                    ctx.fillStyle = finalColor + '80';
                    ctx.fillRect(segment.x + offset - innerGlowSize, segment.y + offset - innerGlowSize, 
                               size + innerGlowSize * 2, size + innerGlowSize * 2);
                }

                // ç‰¹æ®Šæ•ˆæœé¡å¤–å…‰æšˆ
                if (extraEffects) {
                    const specialGlowSize = index === 0 ? 5 : 3;
                    const specialGlowOpacity = index === 0 ? '50' : '30';
                    ctx.fillStyle = finalColor + specialGlowOpacity;
                    ctx.fillRect(segment.x + offset - specialGlowSize, segment.y + offset - specialGlowSize, 
                               size + specialGlowSize * 2, size + specialGlowSize * 2);
                }

                // ç¹ªè£½è›‡èº«ä¸»é«”
                ctx.fillStyle = finalColor + Math.floor(opacity * 255).toString(16).padStart(2, '0');
                ctx.fillRect(segment.x + offset, segment.y + offset, size, size);

                // æ·»åŠ é«˜å…‰æ•ˆæœè®“è›‡èº«æ›´ç«‹é«”
                const highlightOpacity = Math.floor((opacity * 0.3) * 255).toString(16).padStart(2, '0');
                ctx.fillStyle = '#FFFFFF' + highlightOpacity;
                ctx.fillRect(segment.x + offset, segment.y + offset, Math.floor(size * 0.4), Math.floor(size * 0.4));

                if (index === 0) {
                    // ç¹ªè£½çœ¼ç› - æ ¹æ“šæ–¹å‘èª¿æ•´
                    ctx.fillStyle = snake.ghostMode > 0 ? 'rgba(255,255,255,0.8)' : 'white';
                    
                    const eyeSize = 3;
                    const pupilSize = 1;
                    const eyeOffset1 = { x: 6, y: 6 };
                    const eyeOffset2 = { x: 11, y: 6 };
                    
                    // æ ¹æ“šæ–¹å‘èª¿æ•´çœ¼ç›ä½ç½®
                    if (snake.direction.x === 1) { // Right
                        eyeOffset1.x = 11; eyeOffset1.y = 6;
                        eyeOffset2.x = 11; eyeOffset2.y = 11;
                    } else if (snake.direction.x === -1) { // Left
                        eyeOffset1.x = 6; eyeOffset1.y = 6;
                        eyeOffset2.x = 6; eyeOffset2.y = 11;
                    } else if (snake.direction.y === 1) { // Down
                        eyeOffset1.x = 6; eyeOffset1.y = 11;
                        eyeOffset2.x = 11; eyeOffset2.y = 11;
                    } else if (snake.direction.y === -1) { // Up
                        // Default is fine
                    }

                    ctx.fillRect(segment.x + eyeOffset1.x, segment.y + eyeOffset1.y, eyeSize, eyeSize);
                    ctx.fillRect(segment.x + eyeOffset2.x, segment.y + eyeOffset2.y, eyeSize, eyeSize);

                    ctx.fillStyle = snake.ghostMode > 0 ? 'rgba(0,0,0,0.8)' : 'black';
                    ctx.fillRect(segment.x + eyeOffset1.x + 1, segment.y + eyeOffset1.y + 1, pupilSize, pupilSize);
                    ctx.fillRect(segment.x + eyeOffset2.x + 1, segment.y + eyeOffset2.y + 1, pupilSize, pupilSize);
                    
                    // çœ¼ç›é«˜å…‰
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    ctx.fillRect(segment.x + eyeOffset1.x, segment.y + eyeOffset1.y, pupilSize, pupilSize);
                    ctx.fillRect(segment.x + eyeOffset2.x, segment.y + eyeOffset2.y, pupilSize, pupilSize);
                }
            });
        }

        // æ›´æ–°ç‰¹æ®Šæ•ˆæœé¡¯ç¤º
        function updateSpecialEffectsDisplay() {
            // æ›´æ–°ç©å®¶1ç‰¹æ®Šæ•ˆæœ
            const player1Effects = document.getElementById('player1Effects');
            let effects1 = '';
            if (snake1.speedBoost > 0) {
                effects1 += `<div class="effect-item">âš¡ ç¥é€Ÿç¬¦ <span class="effect-timer">${Math.ceil(snake1.speedBoost/10)}s</span></div>`;
            }
            if (snake1.ghostMode > 0) {
                effects1 += `<div class="effect-item">ğŸ‘» å¹½éˆæ¨¡å¼ <span class="effect-timer">${Math.ceil(snake1.ghostMode/10)}s</span></div>`;
            }
            player1Effects.innerHTML = effects1;
            
            // æ›´æ–°ç©å®¶2ç‰¹æ®Šæ•ˆæœ
            const player2Effects = document.getElementById('player2Effects');
            let effects2 = '';
            if (snake2.speedBoost > 0) {
                effects2 += `<div class="effect-item">âš¡ ç¥é€Ÿç¬¦ <span class="effect-timer">${Math.ceil(snake2.speedBoost/10)}s</span></div>`;
            }
            if (snake2.ghostMode > 0) {
                effects2 += `<div class="effect-item">ğŸ‘» å¹½éˆæ¨¡å¼ <span class="effect-timer">${Math.ceil(snake2.ghostMode/10)}s</span></div>`;
            }
            player2Effects.innerHTML = effects2;
        }

        function gameUpdate() {
            if (!gameRunning || gamePaused) return;

            // æ›´æ–°ç‰¹æ®Šèƒ½åŠ›è¨ˆæ™‚å™¨
            if (snake1.speedBoost > 0) snake1.speedBoost--;
            if (snake1.ghostMode > 0) snake1.ghostMode--;
            if (snake2.speedBoost > 0) snake2.speedBoost--;
            if (snake2.ghostMode > 0) snake2.ghostMode--;

            // æ›´æ–°å‡é£Ÿç‰©è¨ˆæ™‚å™¨
            if (fakeFood) {
                fakeFood.timer--;
                if (fakeFood.timer <= 0) {
                    fakeFood = null;
                }
            }

            // æ›´æ–°å¤§ä¾¿è¨ˆæ™‚å™¨
            poops = poops.filter(poop => {
                poop.timer--;
                return poop.timer > 0;
            });

            handleInput();
            
            // ç¥é€Ÿç¬¦æ•ˆæœï¼šé›™å€ç§»å‹•
            moveSnake(snake1);
            if (snake1.speedBoost > 0) moveSnake(snake1); // å†ç§»å‹•ä¸€æ¬¡
            
            moveSnake(snake2);
            if (snake2.speedBoost > 0) moveSnake(snake2); // å†ç§»å‹•ä¸€æ¬¡

            if (checkCollisions()) return;

            generateFood();
            draw();
        }

        function startGame() {
            if (!gameRunning) {
                gameRunning = true;
                gamePaused = false; // ç¢ºä¿ä¸æ˜¯æš«åœç‹€æ…‹
                document.querySelectorAll('.difficulty-btn').forEach(btn => btn.disabled = true);
                audioManager.play('powerup', { volume: 0.8 });
                
                // éŠæˆ²é–‹å§‹å€’è¨ˆæ™‚
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    draw(); // é‡ç¹ªä»¥æ¸…é™¤ä¸Šä¸€å¹€
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.font = 'bold 100px Arial';
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    if (countdown > 0) {
                        ctx.fillText(countdown, canvas.width / 2, canvas.height / 2);
                        audioManager.play('click', { pitch: 1.0 + (3 - countdown) * 0.2 });
                        countdown--;
                    } else {
                        clearInterval(countdownInterval);
                        ctx.fillText('GO!', canvas.width / 2, canvas.height / 2);
                        audioManager.play('success');
                        
                        setTimeout(() => {
                             // æ ¹æ“šé›£åº¦è¨­ç½®é€Ÿåº¦
                            const speedMap = { 'Easy': 180, 'Normal': 120, 'Hard': 80 };
                            const gameSpeed = speedMap[gameDifficulty] || 120;
                            gameLoop = setInterval(gameUpdate, gameSpeed);
                        }, 500); // "GO!" é¡¯ç¤ºåŠç§’å¾Œæ­£å¼é–‹å§‹
                    }
                }, 1000);
            }
        }

        function togglePause() {
            if (!gameRunning) return; // éŠæˆ²æœªé–‹å§‹æ™‚ä¸èƒ½æš«åœ
            gamePaused = !gamePaused;
            audioManager.play('click');
            document.querySelector('.pause-btn').textContent = gamePaused ? 'â–¶ï¸ ç¹¼çºŒ' : 'â¸ï¸ æš«åœ';
        }

        function resetGame() {
            gameRunning = false;
            gamePaused = false;
            clearInterval(gameLoop);
            audioManager.play('click');
            
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.disabled = false);

            // é‡ç½®è›‡
            snake1 = {
                body: [{x: 100, y: 100}, {x: 80, y: 100}, {x: 60, y: 100}],
                direction: {x: 1, y: 0},
                nextDirection: {x: 1, y: 0},
                level: 3,
                color: '#4CAF50',
                speedBoost: 0,
                ghostMode: 0
            };

            snake2 = {
                body: [{x: 700, y: 500}, {x: 720, y: 500}, {x: 740, y: 500}],
                direction: {x: -1, y: 0},
                nextDirection: {x: -1, y: 0},
                level: 3,
                color: '#FF5722',
                speedBoost: 0,
                ghostMode: 0
            };

            foods = [];
            fakeFood = null; // é‡ç½®å‡é£Ÿç‰©
            poops = []; // é‡ç½®å¤§ä¾¿é™·é˜±
            document.getElementById('gameOver').style.display = 'none';
            document.querySelector('.pause-btn').textContent = 'â¸ï¸ æš«åœ';
            
            generateFood();
            draw();
        }

        function endGame(message) {
            gameRunning = false;
            clearInterval(gameLoop);
            audioManager.play('gameover', { volume: 1.0 });
            document.getElementById('winnerText').textContent = message;
            document.getElementById('gameOver').style.display = 'block';
        }

        function toggleMute() {
            audioManager.toggleMute();
        }

        // è§¸ç™¼å±å¹•éœ‡å‹•
        function triggerScreenShake() {
            const gameContainer = document.querySelector('.game-container');
            gameContainer.classList.add('screen-shake');
            setTimeout(() => {
                gameContainer.classList.remove('screen-shake');
            }, 400);
        }

        // èª¿æ•´Canvaså°ºå¯¸ä»¥é©æ‡‰å±å¹•
        function adjustCanvasSize() {
            const canvas = document.getElementById('gameCanvas');
            const maxWidth = Math.min(800, window.innerWidth * 0.9);
            const maxHeight = Math.min(600, window.innerHeight * 0.6);
            
            // ä¿æŒç¸±æ©«æ¯”
            const aspectRatio = 800 / 600;
            let newWidth = maxWidth;
            let newHeight = newWidth / aspectRatio;
            
            if (newHeight > maxHeight) {
                newHeight = maxHeight;
                newWidth = newHeight * aspectRatio;
            }
            
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
        }

        // åˆå§‹åŒ–éŠæˆ²
        document.addEventListener('DOMContentLoaded', () => {
            adjustCanvasSize();
            resetGame();
            
            // ç›£è½çª—å£å¤§å°è®ŠåŒ–
            window.addEventListener('resize', adjustCanvasSize);
            
            // ç”¨æˆ¶é¦–æ¬¡äº¤äº’æ™‚åˆå§‹åŒ–éŸ³é »
            document.addEventListener('click', () => {
                audioManager.initAudioContext();
            }, { once: true });
            
            document.addEventListener('keydown', () => {
                audioManager.initAudioContext();
            }, { once: true });
        });
    </script>
</body>
</html>
